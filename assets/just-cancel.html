<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Just Cancel — Find and cancel unwanted subscriptions</title>
  <meta name="description"
    content="A local-first, privacy-focused tool to scan your bank statements and identify recurring subscriptions you no longer need." />
  <meta property="og:title" content="Just Cancel — Stop paying for what you don't use" />
  <meta property="og:description"
    content="Scan your bank statements safely and locally to find and cancel unwanted subscriptions." />
  <meta name="keywords"
    content="cancel subscriptions, subscription manager, financial health, saving money, bank statement scanner" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #FAFAFA;
      color: #1A1A1A;
      -webkit-font-smoothing: antialiased;
    }

    #just-cancel-root {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    @media print {
      .no-print {
        display: none !important;
      }

      body {
        background: white;
      }
    }
  </style>
</head>

<body>
  <div id="just-cancel-root"></div>
  <!-- 
      Load script via import() to avoid HTML parser issues with inline code
    -->






















































































  
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgIGZvciAobGV0IGtleSBvZiBfX2dldE93blByb3BOYW1lcyhmcm9tKSkKICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzsKfTsKdmFyIF9fdG9FU00gPSAobW9kLCBpc05vZGVNb2RlLCB0YXJnZXQpID0+ICh0YXJnZXQgPSBtb2QgIT0gbnVsbCA/IF9fY3JlYXRlKF9fZ2V0UHJvdG9PZihtb2QpKSA6IHt9LCBfX2NvcHlQcm9wcygKICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAvLyBjb21wYXRpYmxlIHRyYW5zZm9ybSAoaS5lLiAiX19lc01vZHVsZSIgaGFzIG5vdCBiZWVuIHNldCksIHRoZW4gc2V0CiAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogIG1vZAopKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFZlcnNpb24gPSAiMTguMy4xIjsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSB7CiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSB7CiAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgIGlzQmF0Y2hpbmdMZWdhY3k6IGZhbHNlLAogICAgICAgICAgZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZSA9IGZ1bmN0aW9uKHN0YWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gIiI7CiAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gY3VycmVudEV4dHJhU3RhY2tGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICBpZiAoaW1wbCkgewogICAgICAgICAgICAgIHN0YWNrICs9IGltcGwoKSB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLAogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMihmb3JtYXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoIndhcm4iLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0LCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdCArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50ID0ge307CiAgICAgICAgZnVuY3Rpb24gd2Fybk5vb3AocHVibGljSW5zdGFuY2UsIGNhbGxlck5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9jb25zdHJ1Y3RvciA9IHB1YmxpY0luc3RhbmNlLmNvbnN0cnVjdG9yOwogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IF9jb25zdHJ1Y3RvciAmJiAoX2NvbnN0cnVjdG9yLmRpc3BsYXlOYW1lIHx8IF9jb25zdHJ1Y3Rvci5uYW1lKSB8fCAiUmVhY3RDbGFzcyI7CiAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gY29tcG9uZW50TmFtZSArICIuIiArIGNhbGxlck5hbWU7CiAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXJyb3IoIkNhbid0IGNhbGwgJXMgb24gYSBjb21wb25lbnQgdGhhdCBpcyBub3QgeWV0IG1vdW50ZWQuIFRoaXMgaXMgYSBuby1vcCwgYnV0IGl0IG1pZ2h0IGluZGljYXRlIGEgYnVnIGluIHlvdXIgYXBwbGljYXRpb24uIEluc3RlYWQsIGFzc2lnbiB0byBgdGhpcy5zdGF0ZWAgZGlyZWN0bHkgb3IgZGVmaW5lIGEgYHN0YXRlID0ge307YCBjbGFzcyBwcm9wZXJ0eSB3aXRoIHRoZSBkZXNpcmVkIHN0YXRlIGluIHRoZSAlcyBjb21wb25lbnQuIiwgY2FsbGVyTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudFt3YXJuaW5nS2V5XSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdE5vb3BVcGRhdGVRdWV1ZSA9IHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQ2hlY2tzIHdoZXRoZXIgb3Igbm90IHRoaXMgY29tcG9zaXRlIGNvbXBvbmVudCBpcyBtb3VudGVkLgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2Ugd2Ugd2FudCB0byB0ZXN0LgogICAgICAgICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBtb3VudGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgKiBAcHJvdGVjdGVkCiAgICAgICAgICAgKiBAZmluYWwKICAgICAgICAgICAqLwogICAgICAgICAgaXNNb3VudGVkOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBGb3JjZXMgYW4gdXBkYXRlLiBUaGlzIHNob3VsZCBvbmx5IGJlIGludm9rZWQgd2hlbiBpdCBpcyBrbm93biB3aXRoCiAgICAgICAgICAgKiBjZXJ0YWludHkgdGhhdCB3ZSBhcmUgKipub3QqKiBpbiBhIERPTSB0cmFuc2FjdGlvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBZb3UgbWF5IHdhbnQgdG8gY2FsbCB0aGlzIHdoZW4geW91IGtub3cgdGhhdCBzb21lIGRlZXBlciBhc3BlY3Qgb2YgdGhlCiAgICAgICAgICAgKiBjb21wb25lbnQncyBzdGF0ZSBoYXMgY2hhbmdlZCBidXQgYHNldFN0YXRlYCB3YXMgbm90IGNhbGxlZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGlzIHdpbGwgbm90IGludm9rZSBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCwgYnV0IGl0IHdpbGwgaW52b2tlCiAgICAgICAgICAgKiBgY29tcG9uZW50V2lsbFVwZGF0ZWAgYW5kIGBjb21wb25lbnREaWRVcGRhdGVgLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVGb3JjZVVwZGF0ZTogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFJlcGxhY2VzIGFsbCBvZiB0aGUgc3RhdGUuIEFsd2F5cyB1c2UgdGhpcyBvciBgc2V0U3RhdGVgIHRvIG11dGF0ZSBzdGF0ZS4KICAgICAgICAgICAqIFlvdSBzaG91bGQgdHJlYXQgYHRoaXMuc3RhdGVgIGFzIGltbXV0YWJsZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGVyZSBpcyBubyBndWFyYW50ZWUgdGhhdCBgdGhpcy5zdGF0ZWAgd2lsbCBiZSBpbW1lZGlhdGVseSB1cGRhdGVkLCBzbwogICAgICAgICAgICogYWNjZXNzaW5nIGB0aGlzLnN0YXRlYCBhZnRlciBjYWxsaW5nIHRoaXMgbWV0aG9kIG1heSByZXR1cm4gdGhlIG9sZCB2YWx1ZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb21wbGV0ZVN0YXRlIE5leHQgc3RhdGUuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBjYWxsZXJOYW1lIG5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UsIGNvbXBsZXRlU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBTZXRzIGEgc3Vic2V0IG9mIHRoZSBzdGF0ZS4gVGhpcyBvbmx5IGV4aXN0cyBiZWNhdXNlIF9wZW5kaW5nU3RhdGUgaXMKICAgICAgICAgICAqIGludGVybmFsLiBUaGlzIHByb3ZpZGVzIGEgbWVyZ2luZyBzdHJhdGVneSB0aGF0IGlzIG5vdCBhdmFpbGFibGUgdG8gZGVlcAogICAgICAgICAgICogcHJvcGVydGllcyB3aGljaCBpcyBjb25mdXNpbmcuIFRPRE86IEV4cG9zZSBwZW5kaW5nU3RhdGUgb3IgZG9uJ3QgdXNlIGl0CiAgICAgICAgICAgKiBkdXJpbmcgdGhlIG1lcmdlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHBhcnRpYWxTdGF0ZSBOZXh0IHBhcnRpYWwgc3RhdGUgdG8gYmUgbWVyZ2VkIHdpdGggc3RhdGUuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBOYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVTZXRTdGF0ZTogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJzZXRTdGF0ZSIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIGFzc2lnbiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGVtcHR5T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eU9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIENvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50ID0ge307CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uKHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAiZnVuY3Rpb24iICYmIHBhcnRpYWxTdGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0U3RhdGUoLi4uKTogdGFrZXMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcyB0byB1cGRhdGUgb3IgYSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFuIG9iamVjdCBvZiBzdGF0ZSB2YXJpYWJsZXMuIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKHRoaXMsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5mb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZUZvcmNlVXBkYXRlKHRoaXMsIGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBkZXByZWNhdGVkQVBJcyA9IHsKICAgICAgICAgICAgaXNNb3VudGVkOiBbImlzTW91bnRlZCIsICJJbnN0ZWFkLCBtYWtlIHN1cmUgdG8gY2xlYW4gdXAgc3Vic2NyaXB0aW9ucyBhbmQgcGVuZGluZyByZXF1ZXN0cyBpbiBjb21wb25lbnRXaWxsVW5tb3VudCB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4iXSwKICAgICAgICAgICAgcmVwbGFjZVN0YXRlOiBbInJlcGxhY2VTdGF0ZSIsICJSZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIHNldFN0YXRlIGluc3RlYWQgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzLzMyMzYpLiJdCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyA9IGZ1bmN0aW9uKG1ldGhvZE5hbWUsIGluZm8yKSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb21wb25lbnQucHJvdG90eXBlLCBtZXRob2ROYW1lLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdhcm4yKCIlcyguLi4pIGlzIGRlcHJlY2F0ZWQgaW4gcGxhaW4gSmF2YVNjcmlwdCBSZWFjdCBjbGFzc2VzLiAlcyIsIGluZm8yWzBdLCBpbmZvMlsxXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgZm9yICh2YXIgZm5OYW1lIGluIGRlcHJlY2F0ZWRBUElzKSB7CiAgICAgICAgICAgIGlmIChkZXByZWNhdGVkQVBJcy5oYXNPd25Qcm9wZXJ0eShmbk5hbWUpKSB7CiAgICAgICAgICAgICAgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nKGZuTmFtZSwgZGVwcmVjYXRlZEFQSXNbZm5OYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50RHVtbXkoKSB7CiAgICAgICAgfQogICAgICAgIENvbXBvbmVudER1bW15LnByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgZnVuY3Rpb24gUHVyZUNvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1cmVDb21wb25lbnRQcm90b3R5cGUgPSBQdXJlQ29tcG9uZW50LnByb3RvdHlwZSA9IG5ldyBDb21wb25lbnREdW1teSgpOwogICAgICAgIHB1cmVDb21wb25lbnRQcm90b3R5cGUuY29uc3RydWN0b3IgPSBQdXJlQ29tcG9uZW50OwogICAgICAgIGFzc2lnbihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBPYmplY3Quc2VhbChyZWZPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5KGEpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duLCBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biwgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYGtleWAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ0tleSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nUmVmLmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcucmVmID09PSAic3RyaW5nIiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ICYmIGNvbmZpZy5fX3NlbGYgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IGNvbmZpZy5fX3NlbGYpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBUaGlzIGNhc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uLiBXZSBhc2sgeW91IHRvIG1hbnVhbGx5IGZpeCB0aGlzIGNhc2UgYnkgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGNvbXBvbmVudE5hbWUsIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc291cmNlIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQzKHR5cGUsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgIHZhciBzZWxmID0gbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBudWxsOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZiA9IGNvbmZpZy5fX3NlbGYgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zZWxmOwogICAgICAgICAgICBzb3VyY2UgPSBjb25maWcuX19zb3VyY2UgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zb3VyY2U7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGNoaWxkQXJyYXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gdHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoa2V5IHx8IHJlZikgewogICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgIlVua25vd24iIDogdHlwZTsKICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVmKSB7CiAgICAgICAgICAgICAgICBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lQW5kUmVwbGFjZUtleShvbGRFbGVtZW50LCBuZXdLZXkpIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gUmVhY3RFbGVtZW50KG9sZEVsZW1lbnQudHlwZSwgbmV3S2V5LCBvbGRFbGVtZW50LnJlZiwgb2xkRWxlbWVudC5fc2VsZiwgb2xkRWxlbWVudC5fc291cmNlLCBvbGRFbGVtZW50Ll9vd25lciwgb2xkRWxlbWVudC5wcm9wcyk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50KGVsZW1lbnQsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8IGVsZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LmNsb25lRWxlbWVudCguLi4pOiBUaGUgYXJndW1lbnQgbXVzdCBiZSBhIFJlYWN0IGVsZW1lbnQsIGJ1dCB5b3UgcGFzc2VkICIgKyBlbGVtZW50ICsgIi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbih7fSwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICB2YXIgc2VsZiA9IGVsZW1lbnQuX3NlbGY7CiAgICAgICAgICB2YXIgc291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIuY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlICYmIGVsZW1lbnQudHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBkZWZhdWx0UHJvcHMgPSBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbmZpZ1twcm9wTmFtZV0gPT09IHZvaWQgMCAmJiBkZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudChlbGVtZW50LnR5cGUsIGtleSwgcmVmLCBzZWxmLCBzb3VyY2UsIG93bmVyLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50KG9iamVjdCkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiICYmIG9iamVjdCAhPT0gbnVsbCAmJiBvYmplY3QuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRTsKICAgICAgICB9CiAgICAgICAgdmFyIFNFUEFSQVRPUiA9ICIuIjsKICAgICAgICB2YXIgU1VCU0VQQVJBVE9SID0gIjoiOwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZTIoa2V5KSB7CiAgICAgICAgICB2YXIgZXNjYXBlUmVnZXggPSAvWz06XS9nOwogICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICI9IjogIj0wIiwKICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVzY2FwZWRTdHJpbmcgPSBrZXkucmVwbGFjZShlc2NhcGVSZWdleCwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIGVzY2FwZXJMb29rdXBbbWF0Y2hdOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gIiQiICsgZXNjYXBlZFN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXggPSAvXC8rL2c7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEtleShlbGVtZW50LCBpbmRleCkgewogICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAib2JqZWN0IiAmJiBlbGVtZW50ICE9PSBudWxsICYmIGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlc2NhcGUyKCIiICsgZWxlbWVudC5rZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZGV4LnRvU3RyaW5nKDM2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwSW50b0FycmF5KGNoaWxkcmVuLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmFtZVNvRmFyLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgY2hpbGRyZW47CiAgICAgICAgICBpZiAodHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIGNoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnZva2VDYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7CiAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkcmVuLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGludm9rZUNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfY2hpbGQgPSBjaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG1hcHBlZENoaWxkID0gY2FsbGJhY2soX2NoaWxkKTsKICAgICAgICAgICAgdmFyIGNoaWxkS2V5ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiArIGdldEVsZW1lbnRLZXkoX2NoaWxkLCAwKSA6IG5hbWVTb0ZhcjsKICAgICAgICAgICAgaWYgKGlzQXJyYXkobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgdmFyIGVzY2FwZWRDaGlsZEtleSA9ICIiOwogICAgICAgICAgICAgIGlmIChjaGlsZEtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlc2NhcGVkQ2hpbGRLZXkgPSBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoY2hpbGRLZXkpICsgIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXBJbnRvQXJyYXkobWFwcGVkQ2hpbGQsIGFycmF5LCBlc2NhcGVkQ2hpbGRLZXksICIiLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXBwZWRDaGlsZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1hcHBlZENoaWxkLmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkID0gY2xvbmVBbmRSZXBsYWNlS2V5KAogICAgICAgICAgICAgICAgICBtYXBwZWRDaGlsZCwKICAgICAgICAgICAgICAgICAgLy8gS2VlcCBib3RoIHRoZSAobWFwcGVkKSBhbmQgb2xkIGtleXMgaWYgdGhleSBkaWZmZXIsIGp1c3QgYXMKICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2VBbGxDaGlsZHJlbiB1c2VkIHRvIGRvIGZvciBvYmplY3RzIGFzIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgIGVzY2FwZWRQcmVmaXggKyAvLyAkRmxvd0ZpeE1lIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFJlYWN0LlBvcnRhbCBkb2Vzbid0IGhhdmUgYSBrZXkKICAgICAgICAgICAgICAgICAgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpID8gKAogICAgICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgZXhpc3RpbmcgZWxlbWVudCdzIGtleSBjYW4gYmUgYSBudW1iZXIKICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaW50ZXJuYWwvc2FmZS1zdHJpbmctY29lcmNpb24KICAgICAgICAgICAgICAgICAgICBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoIiIgKyBtYXBwZWRDaGlsZC5rZXkpICsgIi8iCiAgICAgICAgICAgICAgICAgICkgOiAiIikgKyBjaGlsZEtleQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJyYXkucHVzaChtYXBwZWRDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICB2YXIgbmV4dE5hbWU7CiAgICAgICAgICB2YXIgc3VidHJlZUNvdW50ID0gMDsKICAgICAgICAgIHZhciBuZXh0TmFtZVByZWZpeCA9IG5hbWVTb0ZhciA9PT0gIiIgPyBTRVBBUkFUT1IgOiBuYW1lU29GYXIgKyBTVUJTRVBBUkFUT1I7CiAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGkpOwogICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmFibGVDaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuID09PSBpdGVyYWJsZUNoaWxkcmVuLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNYXBzKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjIoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGl0ZXJhYmxlQ2hpbGRyZW4pOwogICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgIHZhciBpaSA9IDA7CiAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgY2hpbGQgPSBzdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGlpKyspOwogICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuU3RyaW5nID0gU3RyaW5nKGNoaWxkcmVuKTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZHJlblN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNoaWxkcmVuKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRyZW5TdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1YnRyZWVDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIHJlc3VsdCwgIiIsICIiLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGNoaWxkLCBjb3VudCsrKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY291bnRDaGlsZHJlbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIG4gPSAwOwogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBuKys7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JFYWNoQ2hpbGRyZW4oY2hpbGRyZW4sIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCkgewogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3JFYWNoRnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZm9yRWFjaENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0b0FycmF5KGNoaWxkcmVuKSB7CiAgICAgICAgICByZXR1cm4gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbmx5Q2hpbGQoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnQoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuQ2hpbGRyZW4ub25seSBleHBlY3RlZCB0byByZWNlaXZlIGEgc2luZ2xlIFJlYWN0IGVsZW1lbnQgY2hpbGQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbnRleHQoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgLy8gQXMgYSB3b3JrYXJvdW5kIHRvIHN1cHBvcnQgbXVsdGlwbGUgY29uY3VycmVudCByZW5kZXJlcnMsIHdlIGNhdGVnb3JpemUKICAgICAgICAgICAgLy8gc29tZSByZW5kZXJlcnMgYXMgcHJpbWFyeSBhbmQgb3RoZXJzIGFzIHNlY29uZGFyeS4gV2Ugb25seSBleHBlY3QKICAgICAgICAgICAgLy8gdGhlcmUgdG8gYmUgdHdvIGNvbmN1cnJlbnQgcmVuZGVyZXJzIGF0IG1vc3Q6IFJlYWN0IE5hdGl2ZSAocHJpbWFyeSkgYW5kCiAgICAgICAgICAgIC8vIEZhYnJpYyAoc2Vjb25kYXJ5KTsgUmVhY3QgRE9NIChwcmltYXJ5KSBhbmQgUmVhY3QgQVJUIChzZWNvbmRhcnkpLgogICAgICAgICAgICAvLyBTZWNvbmRhcnkgcmVuZGVyZXJzIHN0b3JlIHRoZWlyIGNvbnRleHQgdmFsdWVzIG9uIHNlcGFyYXRlIGZpZWxkcy4KICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICBfY3VycmVudFZhbHVlMjogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICAvLyBVc2VkIHRvIHRyYWNrIGhvdyBtYW55IGNvbmN1cnJlbnQgcmVuZGVyZXJzIHRoaXMgY29udGV4dCBjdXJyZW50bHkKICAgICAgICAgICAgLy8gc3VwcG9ydHMgd2l0aGluIGluIGEgc2luZ2xlIHJlbmRlcmVyLiBTdWNoIGFzIHBhcmFsbGVsIHNlcnZlciByZW5kZXJpbmcuCiAgICAgICAgICAgIF90aHJlYWRDb3VudDogMCwKICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGNpcmN1bGFyCiAgICAgICAgICAgIFByb3ZpZGVyOiBudWxsLAogICAgICAgICAgICBDb25zdW1lcjogbnVsbCwKICAgICAgICAgICAgLy8gQWRkIHRoZXNlIHRvIHVzZSBzYW1lIGhpZGRlbiBjbGFzcyBpbiBWTSBhcyBTZXJ2ZXJDb250ZXh0CiAgICAgICAgICAgIF9kZWZhdWx0VmFsdWU6IG51bGwsCiAgICAgICAgICAgIF9nbG9iYWxOYW1lOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgY29udGV4dC5Qcm92aWRlciA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BST1ZJREVSX1RZUEUsCiAgICAgICAgICAgIF9jb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgQ29uc3VtZXIgPSB7CiAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDb25zdW1lciwgewogICAgICAgICAgICAgIFByb3ZpZGVyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQuQ29uc3VtZXIuUHJvdmlkZXI+IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LlByb3ZpZGVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LlByb3ZpZGVyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX1Byb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSBfUHJvdmlkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfY3VycmVudFZhbHVlOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZSkgewogICAgICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBfY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlMiA9IF9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX3RocmVhZENvdW50OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfdGhyZWFkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fdGhyZWFkQ291bnQgPSBfdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBDb25zdW1lcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycykgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLkNvbnN1bWVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Db25zdW1lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5kaXNwbGF5TmFtZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuMigiU2V0dGluZyBgZGlzcGxheU5hbWVgIG9uIENvbnRleHQuQ29uc3VtZXIgaGFzIG5vIGVmZmVjdC4gWW91IHNob3VsZCBzZXQgaXQgZGlyZWN0bHkgb24gdGhlIGNvbnRleHQgd2l0aCBDb250ZXh0LmRpc3BsYXlOYW1lID0gJyVzJy4iLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29udGV4dC5Db25zdW1lciA9IENvbnN1bWVyOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSBudWxsOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIyID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgIH0KICAgICAgICB2YXIgVW5pbml0aWFsaXplZCA9IC0xOwogICAgICAgIHZhciBQZW5kaW5nID0gMDsKICAgICAgICB2YXIgUmVzb2x2ZWQgPSAxOwogICAgICAgIHZhciBSZWplY3RlZCA9IDI7CiAgICAgICAgZnVuY3Rpb24gbGF6eUluaXRpYWxpemVyKHBheWxvYWQpIHsKICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgdmFyIGN0b3IgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IGN0b3IoKTsKICAgICAgICAgICAgdGhlbmFibGUudGhlbihmdW5jdGlvbihtb2R1bGVPYmplY3QyKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUGVuZGluZyB8fCBwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fc3RhdHVzID0gUmVzb2x2ZWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fcmVzdWx0ID0gbW9kdWxlT2JqZWN0MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVqZWN0ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3N0YXR1cyA9IFJlamVjdGVkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3Jlc3VsdCA9IGVycm9yMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBwYXlsb2FkOwogICAgICAgICAgICAgIHBlbmRpbmcuX3N0YXR1cyA9IFBlbmRpbmc7CiAgICAgICAgICAgICAgcGVuZGluZy5fcmVzdWx0ID0gdGhlbmFibGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFJlc29sdmVkKSB7CiAgICAgICAgICAgIHZhciBtb2R1bGVPYmplY3QgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobW9kdWxlT2JqZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSlcblxuRGlkIHlvdSBhY2NpZGVudGFsbHkgcHV0IGN1cmx5IGJyYWNlcyBhcm91bmQgdGhlIGltcG9ydD8iLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCEoImRlZmF1bHQiIGluIG1vZHVsZU9iamVjdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSkiLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kdWxlT2JqZWN0LmRlZmF1bHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhenkoY3RvcikgewogICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgIC8vIFdlIHVzZSB0aGVzZSBmaWVsZHMgdG8gc3RvcmUgdGhlIHJlc3VsdC4KICAgICAgICAgICAgX3N0YXR1czogVW5pbml0aWFsaXplZCwKICAgICAgICAgICAgX3Jlc3VsdDogY3RvcgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBsYXp5VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0xBWllfVFlQRSwKICAgICAgICAgICAgX3BheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgIF9pbml0OiBsYXp5SW5pdGlhbGl6ZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGxhenlUeXBlLCB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3RGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5sYXp5KC4uLik6IEl0IGlzIG5vdCBzdXBwb3J0ZWQgdG8gYXNzaWduIGBkZWZhdWx0UHJvcHNgIHRvIGEgbGF6eSBjb21wb25lbnQgaW1wb3J0LiBFaXRoZXIgc3BlY2lmeSB0aGVtIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgZGVmaW5lZCwgb3IgY3JlYXRlIGEgd3JhcHBpbmcgY29tcG9uZW50IGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gbmV3RGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJkZWZhdWx0UHJvcHMiLCB7CiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHByb3BUeXBlczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb3BUeXBlczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld1Byb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgcHJvcFR5cGVzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIHByb3BUeXBlcyA9IG5ld1Byb3BUeXBlczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAicHJvcFR5cGVzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXp5VHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yd2FyZFJlZjMocmVuZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCAmJiByZW5kZXIuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSkgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCByZWNlaXZlZCBhIGBtZW1vYCBjb21wb25lbnQuIEluc3RlYWQgb2YgZm9yd2FyZFJlZihtZW1vKC4uLikpLCB1c2UgbWVtbyhmb3J3YXJkUmVmKC4uLikpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgd2FzIGdpdmVuICVzLiIsIHJlbmRlciA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiByZW5kZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgYWNjZXB0IGV4YWN0bHkgdHdvIHBhcmFtZXRlcnM6IHByb3BzIGFuZCByZWYuICVzIiwgcmVuZGVyLmxlbmd0aCA9PT0gMSA/ICJEaWQgeW91IGZvcmdldCB0byB1c2UgdGhlIHJlZiBwYXJhbWV0ZXI/IiA6ICJBbnkgYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSB1bmRlZmluZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChyZW5kZXIuZGVmYXVsdFByb3BzICE9IG51bGwgfHwgcmVuZGVyLnByb3BUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFLAogICAgICAgICAgICByZW5kZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghcmVuZGVyLm5hbWUgJiYgIXJlbmRlci5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICByZW5kZXIuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gVGhpcyBuZWVkcyB0byBpbmNsdWRlIGFsbCBwb3NzaWJsZSBtb2R1bGUgcmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICAvLyB0eXBlcyBzdXBwb3J0ZWQgYnkgYW55IEZsaWdodCBjb25maWd1cmF0aW9uIGFueXdoZXJlIHNpbmNlCiAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAvLyB3aXRoLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFIHx8IHR5cGUuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lbW8odHlwZSwgY29tcGFyZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSkgewogICAgICAgICAgICAgIGVycm9yKCJtZW1vOiBUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIGNvbXBvbmVudC4gSW5zdGVhZCByZWNlaXZlZDogJXMiLCB0eXBlID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9NRU1PX1RZUEUsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGNvbXBhcmU6IGNvbXBhcmUgPT09IHZvaWQgMCA/IG51bGwgOiBjb21wYXJlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXR5cGUubmFtZSAmJiAhdHlwZS5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICB0eXBlLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlRGlzcGF0Y2hlcigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlQ29udGV4dChDb250ZXh0KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb250ZXh0Ll9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgcmVhbENvbnRleHQgPSBDb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICAgIGlmIChyZWFsQ29udGV4dC5Db25zdW1lciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LkNvbnN1bWVyKSBpcyBub3Qgc3VwcG9ydGVkLCBtYXkgY2F1c2UgYnVncywgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFsQ29udGV4dC5Qcm92aWRlciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LlByb3ZpZGVyKSBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDb250ZXh0KENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTdGF0ZTIoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZjIoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRWZmZWN0MihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZU1lbW8yKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VUcmFuc2l0aW9uKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJZCgpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUlkKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgfQogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHguc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudDIpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQyLnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhcyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB5b3VyIGNvZGUgYXQgIiArIGZpbGVOYW1lICsgIjoiICsgbGluZU51bWJlciArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhlbGVtZW50UHJvcHMpIHsKICAgICAgICAgIGlmIChlbGVtZW50UHJvcHMgIT09IG51bGwgJiYgZWxlbWVudFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKGVsZW1lbnRQcm9wcy5fX3NvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpIHsKICAgICAgICAgIHZhciBpbmZvMiA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgaWYgKCFpbmZvMikgewogICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5hbWUpIHsKICAgICAgICAgICAgICBpbmZvMiA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5mbzI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQobm9kZSkpIHsKICAgICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IG5vZGUuZW50cmllcykgewogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoc3RlcC52YWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSk7CiAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICBpbmZvMiArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhwcm9wcyk7CiAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgaW5mbzIgKz0gc291cmNlSW5mbzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbmZvMiArPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdHlwZVN0cmluZzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkodHlwZSkpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgaW5mbzIgPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5jcmVhdGVFbGVtZW50OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbzIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGFyZ3VtZW50c1tpXSwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbih0eXBlKSB7CiAgICAgICAgICB2YXIgdmFsaWRhdGVkRmFjdG9yeSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbi5iaW5kKG51bGwsIHR5cGUpOwogICAgICAgICAgdmFsaWRhdGVkRmFjdG9yeS50eXBlID0gdHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gdHJ1ZTsKICAgICAgICAgICAgICB3YXJuMigiUmVhY3QuY3JlYXRlRmFjdG9yeSgpIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBDb25zaWRlciB1c2luZyBKU1ggb3IgdXNlIFJlYWN0LmNyZWF0ZUVsZW1lbnQoKSBkaXJlY3RseSBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh2YWxpZGF0ZWRGYWN0b3J5LCAidHlwZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgd2FybjIoIkZhY3RvcnkudHlwZSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdGhlIGNsYXNzIGRpcmVjdGx5IGJlZm9yZSBwYXNzaW5nIGl0IHRvIGNyZWF0ZUZhY3RvcnkuIik7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgInR5cGUiLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiB0eXBlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsaWRhdGVkRmFjdG9yeTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50V2l0aFZhbGlkYXRpb24oZWxlbWVudCwgcHJvcHMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IGNsb25lRWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCBuZXdFbGVtZW50LnR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMobmV3RWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzY29wZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSBmYWxzZTsKICAgICAgICB2YXIgZW5xdWV1ZVRhc2tJbXBsID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVGFzayh0YXNrKSB7CiAgICAgICAgICBpZiAoZW5xdWV1ZVRhc2tJbXBsID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIHJlcXVpcmVTdHJpbmcgPSAoInJlcXVpcmUiICsgTWF0aC5yYW5kb20oKSkuc2xpY2UoMCwgNyk7CiAgICAgICAgICAgICAgdmFyIG5vZGVSZXF1aXJlID0gbW9kdWxlICYmIG1vZHVsZVtyZXF1aXJlU3RyaW5nXTsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBub2RlUmVxdWlyZS5jYWxsKG1vZHVsZSwgInRpbWVycyIpLnNldEltbWVkaWF0ZTsKICAgICAgICAgICAgfSBjYXRjaCAoX2VycikgewogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3QgaGF2ZSBhIE1lc3NhZ2VDaGFubmVsIGltcGxlbWVudGF0aW9uLCBzbyBlbnF1ZXVpbmcgdGFza3MgdmlhIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pIHdpbGwgZmFpbC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUgYXQgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3VlcyBpZiB5b3UgZW5jb3VudGVyIHRoaXMgd2FybmluZy4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh2b2lkIDApOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnF1ZXVlVGFza0ltcGwodGFzayk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RTY29wZURlcHRoID0gMDsKICAgICAgICB2YXIgZGlkV2Fybk5vQXdhaXRBY3QgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBhY3QoY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByZXZBY3RTY29wZURlcHRoID0gYWN0U2NvcGVEZXB0aDsKICAgICAgICAgICAgYWN0U2NvcGVEZXB0aCsrOwogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldklzQmF0Y2hpbmdMZWdhY3kgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSB0cnVlOwogICAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgaWYgKCFwcmV2SXNCYXRjaGluZ0xlZ2FjeSAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHByZXZJc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgICAgIHZhciB3YXNBd2FpdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgIHdhc0F3YWl0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGVuYWJsZVJlc3VsdC50aGVuKGZ1bmN0aW9uKHJldHVyblZhbHVlMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZTIsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5Ob0F3YWl0QWN0ICYmIHR5cGVvZiBQcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghd2FzQXdhaXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2Fybk5vQXdhaXRBY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBjYWxsZWQgYWN0KGFzeW5jICgpID0+IC4uLikgd2l0aG91dCBhd2FpdC4gVGhpcyBjb3VsZCBsZWFkIHRvIHVuZXhwZWN0ZWQgdGVzdGluZyBiZWhhdmlvdXIsIGludGVybGVhdmluZyBtdWx0aXBsZSBhY3QgY2FsbHMgYW5kIG1peGluZyB0aGVpciBzY29wZXMuIFlvdSBzaG91bGQgLSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKTsiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhlbmFibGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0gcmVzdWx0OwogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIF9xdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoX3F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUoX3F1ZXVlKTsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF90aGVuYWJsZTIgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmV2QWN0U2NvcGVEZXB0aCAhPT0gYWN0U2NvcGVEZXB0aCAtIDEpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHNlZW0gdG8gaGF2ZSBvdmVybGFwcGluZyBhY3QoKSBjYWxscywgdGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBCZSBzdXJlIHRvIGF3YWl0IHByZXZpb3VzIGFjdCgpIGNhbGxzIGJlZm9yZSBtYWtpbmcgYSBuZXcgb25lLiAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3RTY29wZURlcHRoID0gcHJldkFjdFNjb3BlRGVwdGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlVGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmx1c2hBY3RRdWV1ZShxdWV1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmx1c2hpbmcpIHsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcXVldWUgPSBxdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUVsZW1lbnQkMSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY2xvbmVFbGVtZW50JDEgPSBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgQ2hpbGRyZW4gPSB7CiAgICAgICAgICBtYXA6IG1hcENoaWxkcmVuLAogICAgICAgICAgZm9yRWFjaDogZm9yRWFjaENoaWxkcmVuLAogICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICB0b0FycmF5LAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW47CiAgICAgICAgZXhwb3J0cy5Db21wb25lbnQgPSBDb21wb25lbnQ7CiAgICAgICAgZXhwb3J0cy5GcmFnbWVudCA9IFJFQUNUX0ZSQUdNRU5UX1RZUEU7CiAgICAgICAgZXhwb3J0cy5Qcm9maWxlciA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgZXhwb3J0cy5QdXJlQ29tcG9uZW50ID0gUHVyZUNvbXBvbmVudDsKICAgICAgICBleHBvcnRzLlN0cmljdE1vZGUgPSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOwogICAgICAgIGV4cG9ydHMuU3VzcGVuc2UgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgIGV4cG9ydHMuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBSZWFjdFNoYXJlZEludGVybmFsczsKICAgICAgICBleHBvcnRzLmFjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLmNsb25lRWxlbWVudCA9IGNsb25lRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlQ29udGV4dCA9IGNyZWF0ZUNvbnRleHQ7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3Rvcnk7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVSZWYgPSBjcmVhdGVSZWY7CiAgICAgICAgZXhwb3J0cy5mb3J3YXJkUmVmID0gZm9yd2FyZFJlZjM7CiAgICAgICAgZXhwb3J0cy5pc1ZhbGlkRWxlbWVudCA9IGlzVmFsaWRFbGVtZW50OwogICAgICAgIGV4cG9ydHMubGF6eSA9IGxhenk7CiAgICAgICAgZXhwb3J0cy5tZW1vID0gbWVtbzsKICAgICAgICBleHBvcnRzLnN0YXJ0VHJhbnNpdGlvbiA9IHN0YXJ0VHJhbnNpdGlvbjsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2FjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLnVzZUNhbGxiYWNrID0gdXNlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDsKICAgICAgICBleHBvcnRzLnVzZURlYnVnVmFsdWUgPSB1c2VEZWJ1Z1ZhbHVlOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QyOwogICAgICAgIGV4cG9ydHMudXNlSWQgPSB1c2VJZDsKICAgICAgICBleHBvcnRzLnVzZUltcGVyYXRpdmVIYW5kbGUgPSB1c2VJbXBlcmF0aXZlSGFuZGxlOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTWVtbyA9IHVzZU1lbW8yOwogICAgICAgIGV4cG9ydHMudXNlUmVkdWNlciA9IHVzZVJlZHVjZXI7CiAgICAgICAgZXhwb3J0cy51c2VSZWYgPSB1c2VSZWYyOwogICAgICAgIGV4cG9ydHMudXNlU3RhdGUgPSB1c2VTdGF0ZTI7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlOwogICAgICAgIGV4cG9ydHMudXNlVHJhbnNpdGlvbiA9IHVzZVRyYW5zaXRpb247CiAgICAgICAgZXhwb3J0cy52ZXJzaW9uID0gUmVhY3RWZXJzaW9uOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9zY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9zY2hlZHVsZXJfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY2hlZHVsZXJEZWJ1Z2dpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlUHJvZmlsaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGZyYW1lWWllbGRNcyA9IDU7CiAgICAgICAgZnVuY3Rpb24gcHVzaChoZWFwLCBub2RlKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBoZWFwLmxlbmd0aDsKICAgICAgICAgIGhlYXAucHVzaChub2RlKTsKICAgICAgICAgIHNpZnRVcChoZWFwLCBub2RlLCBpbmRleCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlZWsoaGVhcCkgewogICAgICAgICAgcmV0dXJuIGhlYXAubGVuZ3RoID09PSAwID8gbnVsbCA6IGhlYXBbMF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChoZWFwKSB7CiAgICAgICAgICBpZiAoaGVhcC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3QgPSBoZWFwWzBdOwogICAgICAgICAgdmFyIGxhc3QgPSBoZWFwLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QgIT09IGZpcnN0KSB7CiAgICAgICAgICAgIGhlYXBbMF0gPSBsYXN0OwogICAgICAgICAgICBzaWZ0RG93bihoZWFwLCBsYXN0LCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdFVwKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4IC0gMSA+Pj4gMTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShwYXJlbnQsIG5vZGUpID4gMCkgewogICAgICAgICAgICAgIGhlYXBbcGFyZW50SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHBhcmVudDsKICAgICAgICAgICAgICBpbmRleCA9IHBhcmVudEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0RG93bihoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgdmFyIGhhbGZMZW5ndGggPSBsZW5ndGggPj4+IDE7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBoYWxmTGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0SW5kZXggPSAoaW5kZXggKyAxKSAqIDIgLSAxOwogICAgICAgICAgICB2YXIgbGVmdCA9IGhlYXBbbGVmdEluZGV4XTsKICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBoZWFwW3JpZ2h0SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShsZWZ0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBsZWZ0OwogICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbGVmdEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICAgICAgICAgIHZhciBkaWZmID0gYS5zb3J0SW5kZXggLSBiLnNvcnRJbmRleDsKICAgICAgICAgIHJldHVybiBkaWZmICE9PSAwID8gZGlmZiA6IGEuaWQgLSBiLmlkOwogICAgICAgIH0KICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSAxOwogICAgICAgIHZhciBVc2VyQmxvY2tpbmdQcmlvcml0eSA9IDI7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSA0OwogICAgICAgIHZhciBJZGxlUHJpb3JpdHkgPSA1OwogICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrLCBtcykgewogICAgICAgIH0KICAgICAgICB2YXIgaGFzUGVyZm9ybWFuY2VOb3cgPSB0eXBlb2YgcGVyZm9ybWFuY2UgPT09ICJvYmplY3QiICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgaWYgKGhhc1BlcmZvcm1hbmNlTm93KSB7CiAgICAgICAgICB2YXIgbG9jYWxQZXJmb3JtYW5jZSA9IHBlcmZvcm1hbmNlOwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2FsUGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgbG9jYWxEYXRlID0gRGF0ZTsKICAgICAgICAgIHZhciBpbml0aWFsVGltZSA9IGxvY2FsRGF0ZS5ub3coKTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUubm93KCkgLSBpbml0aWFsVGltZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBtYXhTaWduZWQzMUJpdEludCA9IDEwNzM3NDE4MjM7CiAgICAgICAgdmFyIElNTUVESUFURV9QUklPUklUWV9USU1FT1VUID0gLTE7CiAgICAgICAgdmFyIFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVCA9IDI1MDsKICAgICAgICB2YXIgTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQgPSA1ZTM7CiAgICAgICAgdmFyIExPV19QUklPUklUWV9USU1FT1VUID0gMWU0OwogICAgICAgIHZhciBJRExFX1BSSU9SSVRZX1RJTUVPVVQgPSBtYXhTaWduZWQzMUJpdEludDsKICAgICAgICB2YXIgdGFza1F1ZXVlID0gW107CiAgICAgICAgdmFyIHRpbWVyUXVldWUgPSBbXTsKICAgICAgICB2YXIgdGFza0lkQ291bnRlciA9IDE7CiAgICAgICAgdmFyIGN1cnJlbnRUYXNrID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsU2V0VGltZW91dCA9IHR5cGVvZiBzZXRUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gc2V0VGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsQ2xlYXJUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsU2V0SW1tZWRpYXRlID0gdHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gInVuZGVmaW5lZCIgPyBzZXRJbW1lZGlhdGUgOiBudWxsOwogICAgICAgIHZhciBpc0lucHV0UGVuZGluZyA9IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nICE9PSB2b2lkIDAgJiYgbmF2aWdhdG9yLnNjaGVkdWxpbmcuaXNJbnB1dFBlbmRpbmcgIT09IHZvaWQgMCA/IG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nLmJpbmQobmF2aWdhdG9yLnNjaGVkdWxpbmcpIDogbnVsbDsKICAgICAgICBmdW5jdGlvbiBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgdGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgd2hpbGUgKHRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0aW1lci5jYWxsYmFjayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aW1lci5zdGFydFRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICBwb3AodGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgdGltZXIuc29ydEluZGV4ID0gdGltZXIuZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIHRpbWVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lb3V0KGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaWYgKHBlZWsodGFza1F1ZXVlKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgIGlmIChmaXJzdFRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgZmlyc3RUaW1lci5zdGFydFRpbWUgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoV29yayhoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxpbmcpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGFzayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgICAgICBtYXJrVGFza0Vycm9yZWQoY3VycmVudFRhc2ssIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgY3VycmVudFRhc2suaXNRdWV1ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGluaXRpYWxUaW1lMjsKICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrKHRhc2tRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRhc2sgIT09IG51bGwgJiYgIWVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZykgewogICAgICAgICAgICBpZiAoY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPiBjdXJyZW50VGltZSAmJiAoIWhhc1RpbWVSZW1haW5pbmcgfHwgc2hvdWxkWWllbGRUb0hvc3QoKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjdXJyZW50VGFzay5jYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRUYXNrLnByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgY29udGludWF0aW9uQ2FsbGJhY2sgPSBjYWxsYmFjayhkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0KTsKICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBjb250aW51YXRpb25DYWxsYmFjazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrKHRhc2tRdWV1ZSkpIHsKICAgICAgICAgICAgICAgICAgcG9wKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gcGVlayh0YXNrUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eShwcmlvcml0eUxldmVsLCBldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHZhciBwcmlvcml0eUxldmVsOwogICAgICAgICAgc3dpdGNoIChjdXJyZW50UHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfd3JhcENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgIHZhciBzdGFydFRpbWUyOwogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAib2JqZWN0IiAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiICYmIGRlbGF5ID4gMCkgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZSArIGRlbGF5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElETEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gTE9XX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGltZW91dCA9IE5PUk1BTF9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gc3RhcnRUaW1lMiArIHRpbWVvdXQ7CiAgICAgICAgICB2YXIgbmV3VGFzayA9IHsKICAgICAgICAgICAgaWQ6IHRhc2tJZENvdW50ZXIrKywKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lMiwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgIHNvcnRJbmRleDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gc3RhcnRUaW1lMjsKICAgICAgICAgICAgcHVzaCh0aW1lclF1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKHBlZWsodGFza1F1ZXVlKSA9PT0gbnVsbCAmJiBuZXdUYXNrID09PSBwZWVrKHRpbWVyUXVldWUpKSB7CiAgICAgICAgICAgICAgaWYgKGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQpIHsKICAgICAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgc3RhcnRUaW1lMiAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIG5ld1Rhc2spOwogICAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkICYmICFpc1BlcmZvcm1pbmdXb3JrKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ld1Rhc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uKCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbigpIHsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlKCkgewogICAgICAgICAgcmV0dXJuIHBlZWsodGFza1F1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sodGFzaykgewogICAgICAgICAgdGFzay5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB2YXIgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIHZhciBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgIHZhciBzdGFydFRpbWUgPSAtMTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRZaWVsZFRvSG9zdCgpIHsKICAgICAgICAgIHZhciB0aW1lRWxhcHNlZCA9IGV4cG9ydHMudW5zdGFibGVfbm93KCkgLSBzdGFydFRpbWU7CiAgICAgICAgICBpZiAodGltZUVsYXBzZWQgPCBmcmFtZUludGVydmFsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UGFpbnQoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlRnJhbWVSYXRlKGZwcykgewogICAgICAgICAgaWYgKGZwcyA8IDAgfHwgZnBzID4gMTI1KSB7CiAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oImZvcmNlRnJhbWVSYXRlIHRha2VzIGEgcG9zaXRpdmUgaW50IGJldHdlZW4gMCBhbmQgMTI1LCBmb3JjaW5nIGZyYW1lIHJhdGVzIGhpZ2hlciB0aGFuIDEyNSBmcHMgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZnBzID4gMCkgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gTWF0aC5mbG9vcigxZTMgLyBmcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNjaGVkdWxlZEhvc3RDYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICBzdGFydFRpbWUgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgdmFyIGhhc1RpbWVSZW1haW5pbmcgPSB0cnVlOwogICAgICAgICAgICB2YXIgaGFzTW9yZVdvcmsgPSB0cnVlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGhhc01vcmVXb3JrID0gc2NoZWR1bGVkSG9zdENhbGxiYWNrKGhhc1RpbWVSZW1haW5pbmcsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAoaGFzTW9yZVdvcmspIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICBpZiAodHlwZW9mIGxvY2FsU2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldEltbWVkaWF0ZShwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICB2YXIgcG9ydCA9IGNoYW5uZWwucG9ydDI7CiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvcnQucG9zdE1lc3NhZ2UobnVsbCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldFRpbWVvdXQocGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0Q2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgaWYgKCFpc01lc3NhZ2VMb29wUnVubmluZykgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0VGltZW91dChjYWxsYmFjaywgbXMpIHsKICAgICAgICAgIHRhc2tUaW1lb3V0SUQgPSBsb2NhbFNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGV4cG9ydHMudW5zdGFibGVfbm93KCkpOwogICAgICAgICAgfSwgbXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxIb3N0VGltZW91dCgpIHsKICAgICAgICAgIGxvY2FsQ2xlYXJUaW1lb3V0KHRhc2tUaW1lb3V0SUQpOwogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zdGFibGVfcmVxdWVzdFBhaW50ID0gcmVxdWVzdFBhaW50OwogICAgICAgIHZhciB1bnN0YWJsZV9Qcm9maWxpbmcgPSBudWxsOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSWRsZVByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0xvd1ByaW9yaXR5ID0gTG93UHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfUHJvZmlsaW5nID0gdW5zdGFibGVfUHJvZmlsaW5nOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NhbmNlbENhbGxiYWNrID0gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZm9yY2VGcmFtZVJhdGUgPSBmb3JjZUZyYW1lUmF0ZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsID0gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZSA9IHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfbmV4dCA9IHVuc3RhYmxlX25leHQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9wYXVzZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVxdWVzdFBhaW50ID0gdW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcnVuV2l0aFByaW9yaXR5ID0gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayA9IHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zaG91bGRZaWVsZCA9IHNob3VsZFlpZWxkVG9Ib3N0OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfd3JhcENhbGxiYWNrID0gdW5zdGFibGVfd3JhcENhbGxiYWNrOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcwp2YXIgcmVxdWlyZV9zY2hlZHVsZXIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QtZG9tL2Nqcy9yZWFjdC1kb20uZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZG9tX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3QzID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0My5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKICAgICAgICB2YXIgc3VwcHJlc3NXYXJuaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2V0U3VwcHJlc3NXYXJuaW5nKG5ld1N1cHByZXNzV2FybmluZykgewogICAgICAgICAgewogICAgICAgICAgICBzdXBwcmVzc1dhcm5pbmcgPSBuZXdTdXBwcmVzc1dhcm5pbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm4yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoIndhcm4iLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdCwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0KTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIEZ1bmN0aW9uQ29tcG9uZW50ID0gMDsKICAgICAgICB2YXIgQ2xhc3NDb21wb25lbnQgPSAxOwogICAgICAgIHZhciBJbmRldGVybWluYXRlQ29tcG9uZW50ID0gMjsKICAgICAgICB2YXIgSG9zdFJvb3QgPSAzOwogICAgICAgIHZhciBIb3N0UG9ydGFsID0gNDsKICAgICAgICB2YXIgSG9zdENvbXBvbmVudCA9IDU7CiAgICAgICAgdmFyIEhvc3RUZXh0ID0gNjsKICAgICAgICB2YXIgRnJhZ21lbnQyID0gNzsKICAgICAgICB2YXIgTW9kZSA9IDg7CiAgICAgICAgdmFyIENvbnRleHRDb25zdW1lciA9IDk7CiAgICAgICAgdmFyIENvbnRleHRQcm92aWRlciA9IDEwOwogICAgICAgIHZhciBGb3J3YXJkUmVmID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00gPSAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgYXR0cmlidXRlIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBhdHRyaWJ1dGVOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIHByb3AgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBDU1MgcHJvcGVydHkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIEhUTUwgbWFya3VwIHVzZXMgYSB2YWx1ZSBvZiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJGb3JtIGZpZWxkIHZhbHVlcyAodmFsdWUsIGNoZWNrZWQsIGRlZmF1bHRWYWx1ZSwgb3IgZGVmYXVsdENoZWNrZWQgcHJvcHMpIG11c3QgYmUgc3RyaW5ncywgbm90ICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVTRVJWRUQgPSAwOwogICAgICAgIHZhciBTVFJJTkcgPSAxOwogICAgICAgIHZhciBCT09MRUFOSVNIX1NUUklORyA9IDI7CiAgICAgICAgdmFyIEJPT0xFQU4gPSAzOwogICAgICAgIHZhciBPVkVSTE9BREVEX0JPT0xFQU4gPSA0OwogICAgICAgIHZhciBOVU1FUklDID0gNTsKICAgICAgICB2YXIgUE9TSVRJVkVfTlVNRVJJQyA9IDY7CiAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgPSAiOkEtWl9hLXpcXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9DSEFSID0gQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJcXC0uMC05XFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICAgICAgdmFyIFZBTElEX0FUVFJJQlVURV9OQU1FX1JFR0VYID0gbmV3IFJlZ0V4cCgiXlsiICsgQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgdmFyIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGlzQXR0cmlidXRlTmFtZVNhZmUoYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWC50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lOiBgJXNgIiwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUubGVuZ3RoID4gMiAmJiAobmFtZVswXSA9PT0gIm8iIHx8IG5hbWVbMF0gPT09ICJPIikgJiYgKG5hbWVbMV0gPT09ICJuIiB8fCBuYW1lWzFdID09PSAiTiIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICBjYXNlICJzeW1ib2wiOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlICJib29sZWFuIjogewogICAgICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIXByb3BlcnR5SW5mby5hY2NlcHRzQm9vbGVhbnM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBwcmVmaXgyID0gbmFtZS50b0xvd2VyQ2FzZSgpLnNsaWNlKDAsIDUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeDIgIT09ICJkYXRhLSIgJiYgcHJlZml4MiAhPT0gImFyaWEtIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgc3dpdGNoIChwcm9wZXJ0eUluZm8udHlwZSkgewogICAgICAgICAgICAgIGNhc2UgQk9PTEVBTjoKICAgICAgICAgICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSBPVkVSTE9BREVEX0JPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICAgIGNhc2UgTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSk7CiAgICAgICAgICAgICAgY2FzZSBQT1NJVElWRV9OVU1FUklDOgogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA8IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHJvcGVydHlJbmZvKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KG5hbWUpID8gcHJvcGVydGllc1tuYW1lXSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFByb3BlcnR5SW5mb1JlY29yZChuYW1lLCB0eXBlLCBtdXN0VXNlUHJvcGVydHksIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSwgc2FuaXRpemVVUkwyLCByZW1vdmVFbXB0eVN0cmluZykgewogICAgICAgICAgdGhpcy5hY2NlcHRzQm9vbGVhbnMgPSB0eXBlID09PSBCT09MRUFOSVNIX1NUUklORyB8fCB0eXBlID09PSBCT09MRUFOIHx8IHR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTjsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IGF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIHRoaXMubXVzdFVzZVByb3BlcnR5ID0gbXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgdGhpcy5wcm9wZXJ0eU5hbWUgPSBuYW1lOwogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuc2FuaXRpemVVUkwgPSBzYW5pdGl6ZVVSTDI7CiAgICAgICAgICB0aGlzLnJlbW92ZUVtcHR5U3RyaW5nID0gcmVtb3ZlRW1wdHlTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJlc2VydmVkUHJvcHMgPSBbCiAgICAgICAgICAiY2hpbGRyZW4iLAogICAgICAgICAgImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIC8vIFRPRE86IFRoaXMgcHJldmVudHMgdGhlIGFzc2lnbm1lbnQgb2YgZGVmYXVsdFZhbHVlIHRvIHJlZ3VsYXIKICAgICAgICAgIC8vIGVsZW1lbnRzIChub3QganVzdCBpbnB1dHMpLiBOb3cgdGhhdCBSZWFjdERPTUlucHV0IGFzc2lnbnMgdG8gdGhlCiAgICAgICAgICAvLyBkZWZhdWx0VmFsdWUgcHJvcGVydHkgLS0gZG8gd2UgbmVlZCB0aGlzPwogICAgICAgICAgImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICAiZGVmYXVsdENoZWNrZWQiLAogICAgICAgICAgImlubmVySFRNTCIsCiAgICAgICAgICAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciLAogICAgICAgICAgInN0eWxlIgogICAgICAgIF07CiAgICAgICAgcmVzZXJ2ZWRQcm9wcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBSRVNFUlZFRCwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgW1siYWNjZXB0Q2hhcnNldCIsICJhY2NlcHQtY2hhcnNldCJdLCBbImNsYXNzTmFtZSIsICJjbGFzcyJdLCBbImh0bWxGb3IiLCAiZm9yIl0sIFsiaHR0cEVxdWl2IiwgImh0dHAtZXF1aXYiXV0uZm9yRWFjaChmdW5jdGlvbihfcmVmKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IF9yZWZbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmWzFdOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJjb250ZW50RWRpdGFibGUiLCAiZHJhZ2dhYmxlIiwgInNwZWxsQ2hlY2siLCAidmFsdWUiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbImF1dG9SZXZlcnNlIiwgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLCAiZm9jdXNhYmxlIiwgInByZXNlcnZlQWxwaGEiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICAiYXN5bmMiLAogICAgICAgICAgLy8gTm90ZTogdGhlcmUgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCBwcmV2ZW50cyBpdCBmcm9tIGJlaW5nIHdyaXR0ZW4gdG8gdGhlIERPTQogICAgICAgICAgLy8gb24gdGhlIGNsaWVudCBzaWRlIGJlY2F1c2UgdGhlIGJyb3dzZXJzIGFyZSBpbmNvbnNpc3RlbnQuIEluc3RlYWQgd2UgY2FsbCBmb2N1cygpLgogICAgICAgICAgImF1dG9Gb2N1cyIsCiAgICAgICAgICAiYXV0b1BsYXkiLAogICAgICAgICAgImNvbnRyb2xzIiwKICAgICAgICAgICJkZWZhdWx0IiwKICAgICAgICAgICJkZWZlciIsCiAgICAgICAgICAiZGlzYWJsZWQiLAogICAgICAgICAgImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgICJkaXNhYmxlUmVtb3RlUGxheWJhY2siLAogICAgICAgICAgImZvcm1Ob1ZhbGlkYXRlIiwKICAgICAgICAgICJoaWRkZW4iLAogICAgICAgICAgImxvb3AiLAogICAgICAgICAgIm5vTW9kdWxlIiwKICAgICAgICAgICJub1ZhbGlkYXRlIiwKICAgICAgICAgICJvcGVuIiwKICAgICAgICAgICJwbGF5c0lubGluZSIsCiAgICAgICAgICAicmVhZE9ubHkiLAogICAgICAgICAgInJlcXVpcmVkIiwKICAgICAgICAgICJyZXZlcnNlZCIsCiAgICAgICAgICAic2NvcGVkIiwKICAgICAgICAgICJzZWFtbGVzcyIsCiAgICAgICAgICAvLyBNaWNyb2RhdGEKICAgICAgICAgICJpdGVtU2NvcGUiCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjaGVja2VkIiwKICAgICAgICAgIC8vIE5vdGU6IGBvcHRpb24uc2VsZWN0ZWRgIGlzIG5vdCB1cGRhdGVkIGlmIGBzZWxlY3QubXVsdGlwbGVgIGlzCiAgICAgICAgICAvLyBkaXNhYmxlZCB3aXRoIGByZW1vdmVBdHRyaWJ1dGVgLiBXZSBoYXZlIHNwZWNpYWwgbG9naWMgZm9yIGhhbmRsaW5nIHRoaXMuCiAgICAgICAgICAibXVsdGlwbGUiLAogICAgICAgICAgIm11dGVkIiwKICAgICAgICAgICJzZWxlY3RlZCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2FwdHVyZSIsCiAgICAgICAgICAiZG93bmxvYWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE9WRVJMT0FERURfQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNvbHMiLAogICAgICAgICAgInJvd3MiLAogICAgICAgICAgInNpemUiLAogICAgICAgICAgInNwYW4iCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFBPU0lUSVZFX05VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsicm93U3BhbiIsICJzdGFydCJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE5VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIENBTUVMSVpFID0gL1tcLVw6XShbYS16XSkvZzsKICAgICAgICB2YXIgY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW5bMV0udG9VcHBlckNhc2UoKTsKICAgICAgICB9OwogICAgICAgIFsKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IiwKICAgICAgICAgICJhbGlnbm1lbnQtYmFzZWxpbmUiLAogICAgICAgICAgImFyYWJpYy1mb3JtIiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCIsCiAgICAgICAgICAiY2FwLWhlaWdodCIsCiAgICAgICAgICAiY2xpcC1wYXRoIiwKICAgICAgICAgICJjbGlwLXJ1bGUiLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItcHJvZmlsZSIsCiAgICAgICAgICAiY29sb3ItcmVuZGVyaW5nIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSIsCiAgICAgICAgICAiZW5hYmxlLWJhY2tncm91bmQiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1ydWxlIiwKICAgICAgICAgICJmbG9vZC1jb2xvciIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSIsCiAgICAgICAgICAiZm9udC1mYW1pbHkiLAogICAgICAgICAgImZvbnQtc2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplLWFkanVzdCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIiwKICAgICAgICAgICJmb250LXN0eWxlIiwKICAgICAgICAgICJmb250LXZhcmlhbnQiLAogICAgICAgICAgImZvbnQtd2VpZ2h0IiwKICAgICAgICAgICJnbHlwaC1uYW1lIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi1ob3Jpem9udGFsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiLAogICAgICAgICAgImhvcml6LW9yaWdpbi14IiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciIsCiAgICAgICAgICAibWFya2VyLWVuZCIsCiAgICAgICAgICAibWFya2VyLW1pZCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICJwYWludC1vcmRlciIsCiAgICAgICAgICAicGFub3NlLTEiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IiwKICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciLAogICAgICAgICAgInN0b3AtY29sb3IiLAogICAgICAgICAgInN0b3Atb3BhY2l0eSIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS13aWR0aCIsCiAgICAgICAgICAidGV4dC1hbmNob3IiLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIiwKICAgICAgICAgICJ1bmljb2RlLXJhbmdlIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iLAogICAgICAgICAgInYtYWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1oYW5naW5nIiwKICAgICAgICAgICJ2LWlkZW9ncmFwaGljIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCIsCiAgICAgICAgICAidmVydC1hZHYteSIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teSIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiLAogICAgICAgICAgInhtbG5zOnhsaW5rIiwKICAgICAgICAgICJ4LWhlaWdodCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhsaW5rOmFjdHVhdGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiLAogICAgICAgICAgInhsaW5rOnJvbGUiLAogICAgICAgICAgInhsaW5rOnNob3ciLAogICAgICAgICAgInhsaW5rOnRpdGxlIiwKICAgICAgICAgICJ4bGluazp0eXBlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhtbDpiYXNlIiwKICAgICAgICAgICJ4bWw6bGFuZyIsCiAgICAgICAgICAieG1sOnNwYWNlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZSIsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInRhYkluZGV4IiwgImNyb3NzT3JpZ2luIl0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciB4bGlua0hyZWYgPSAieGxpbmtIcmVmIjsKICAgICAgICBwcm9wZXJ0aWVzW3hsaW5rSHJlZl0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgInhsaW5rSHJlZiIsCiAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgInhsaW5rOmhyZWYiLAogICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgWyJzcmMiLCAiaHJlZiIsICJhY3Rpb24iLCAiZm9ybUFjdGlvbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGlzSmF2YVNjcmlwdFByb3RvY29sID0gL15bXHUwMDAwLVx1MDAxRiBdKmpbXHJcblx0XSphW1xyXG5cdF0qdltcclxuXHRdKmFbXHJcblx0XSpzW1xyXG5cdF0qY1tcclxuXHRdKnJbXHJcblx0XSppW1xyXG5cdF0qcFtcclxuXHRdKnRbXHJcblx0XSpcOi9pOwogICAgICAgIHZhciBkaWRXYXJuID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2FuaXRpemVVUkwodXJsKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybiAmJiBpc0phdmFTY3JpcHRQcm90b2NvbC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICBkaWRXYXJuID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiQSBmdXR1cmUgdmVyc2lvbiBvZiBSZWFjdCB3aWxsIGJsb2NrIGphdmFzY3JpcHQ6IFVSTHMgYXMgYSBzZWN1cml0eSBwcmVjYXV0aW9uLiBVc2UgZXZlbnQgaGFuZGxlcnMgaW5zdGVhZCBpZiB5b3UgY2FuLiBJZiB5b3UgbmVlZCB0byBnZW5lcmF0ZSB1bnNhZmUgSFRNTCB0cnkgdXNpbmcgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgaW5zdGVhZC4gUmVhY3Qgd2FzIHBhc3NlZCAlcy4iLCBKU09OLnN0cmluZ2lmeSh1cmwpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZVtwcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTCgiIiArIGV4cGVjdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZTsKICAgICAgICAgICAgICB2YXIgc3RyaW5nVmFsdWUgPSBudWxsOwogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJpbmdWYWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlID09PSBudWxsID8gZXhwZWN0ZWQgOiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZ1ZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUobm9kZSwgbmFtZSwgZXhwZWN0ZWQsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNBdHRyaWJ1dGVOYW1lU2FmZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW5vZGUuaGFzQXR0cmlidXRlKG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCB2YWx1ZSwgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICBpZiAoc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyB8fCBwcm9wZXJ0eUluZm8gPT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUsICIiICsgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbXVzdFVzZVByb3BlcnR5ID0gcHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIGlmIChtdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdHlwZSA9PT0gQk9PTEVBTiA/IGZhbHNlIDogIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWU7CiAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gQk9PTEVBTiB8fCBfdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOICYmIHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTChhdHRyaWJ1dGVWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlTlMoYXR0cmlidXRlTmFtZXNwYWNlLCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geC5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoY3Rvciwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgb3duZXIgPSBmaWJlci5fZGVidWdPd25lciA/IGZpYmVyLl9kZWJ1Z093bmVyLnR5cGUgOiBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGZpYmVyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIkxhenkiKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUucmVuZGVyKTsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGluZm8yID0gIiI7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaW5mbzIgKz0gZGVzY3JpYmVGaWJlcihub2RlKTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gaW5mbzI7CiAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeC5tZXNzYWdlICsgIlxuIiArIHguc3RhY2s7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUkMShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lIHx8IChmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lJDEodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJDYWNoZSI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUkMShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICBjYXNlIERlaHlkcmF0ZWRGcmFnbWVudDoKICAgICAgICAgICAgICByZXR1cm4gIkRlaHlkcmF0ZWRGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDI6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudCA9IG51bGw7CiAgICAgICAgdmFyIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG93bmVyID0gY3VycmVudC5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKGN1cnJlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEN1cnJlbnRGaWJlcigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudCA9IGZpYmVyOwogICAgICAgICAgICBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXIoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1JlbmRlcmluZyhyZW5kZXJpbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSByZW5kZXJpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VG9TdHJpbmdWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBoYXNSZWFkT25seVZhbHVlID0gewogICAgICAgICAgYnV0dG9uOiB0cnVlLAogICAgICAgICAgY2hlY2tib3g6IHRydWUsCiAgICAgICAgICBpbWFnZTogdHJ1ZSwKICAgICAgICAgIGhpZGRlbjogdHJ1ZSwKICAgICAgICAgIHJhZGlvOiB0cnVlLAogICAgICAgICAgcmVzZXQ6IHRydWUsCiAgICAgICAgICBzdWJtaXQ6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHModGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoaGFzUmVhZE9ubHlWYWx1ZVtwcm9wcy50eXBlXSB8fCBwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5vbklucHV0IHx8IHByb3BzLnJlYWRPbmx5IHx8IHByb3BzLmRpc2FibGVkIHx8IHByb3BzLnZhbHVlID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGB2YWx1ZWAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRWYWx1ZWAuIE90aGVyd2lzZSwgc2V0IGVpdGhlciBgb25DaGFuZ2VgIG9yIGByZWFkT25seWAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEocHJvcHMub25DaGFuZ2UgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMuY2hlY2tlZCA9PSBudWxsKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcHJvdmlkZWQgYSBgY2hlY2tlZGAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRDaGVja2VkYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NoZWNrYWJsZShlbGVtKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW0udHlwZTsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAodHlwZSA9PT0gImNoZWNrYm94IiB8fCB0eXBlID09PSAicmFkaW8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhY2tlcihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5fdmFsdWVUcmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIG5vZGUuX3ZhbHVlVHJhY2tlciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gIiI7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ2hlY2thYmxlKG5vZGUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS5jaGVja2VkID8gInRydWUiIDogImZhbHNlIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2tWYWx1ZU9uTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWVGaWVsZCA9IGlzQ2hlY2thYmxlKG5vZGUpID8gImNoZWNrZWQiIDogInZhbHVlIjsKICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihub2RlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgdmFsdWVGaWVsZCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbihub2RlW3ZhbHVlRmllbGRdKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSAiIiArIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICBpZiAobm9kZS5oYXNPd25Qcm9wZXJ0eSh2YWx1ZUZpZWxkKSB8fCB0eXBlb2YgZGVzY3JpcHRvciA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0b3IuZ2V0ICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBkZXNjcmlwdG9yLnNldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0MiA9IGRlc2NyaXB0b3IuZ2V0LCBzZXQyID0gZGVzY3JpcHRvci5zZXQ7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldDIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgICAgc2V0Mi5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjcmlwdG9yLmVudW1lcmFibGUKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIHRyYWNrZXIgPSB7CiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wVHJhY2tpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRldGFjaFRyYWNrZXIobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdHJhY2tlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2sobm9kZSkgewogICAgICAgICAgaWYgKGdldFRyYWNrZXIobm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gdHJhY2tWYWx1ZU9uTm9kZShub2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVmFsdWVJZkNoYW5nZWQobm9kZSkgewogICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFja2VyID0gZ2V0VHJhY2tlcihub2RlKTsKICAgICAgICAgIGlmICghdHJhY2tlcikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0VmFsdWUgPSB0cmFja2VyLmdldFZhbHVlKCk7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gZ2V0VmFsdWVGcm9tTm9kZShub2RlKTsKICAgICAgICAgIGlmIChuZXh0VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICB0cmFja2VyLnNldFZhbHVlKG5leHRWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50KGRvYykgewogICAgICAgICAgZG9jID0gZG9jIHx8ICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiID8gZG9jdW1lbnQgOiB2b2lkIDApOwogICAgICAgICAgaWYgKHR5cGVvZiBkb2MgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGRvYy5hY3RpdmVFbGVtZW50IHx8IGRvYy5ib2R5OwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZG9jLmJvZHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0NvbnRyb2xsZWQocHJvcHMpIHsKICAgICAgICAgIHZhciB1c2VzQ2hlY2tlZCA9IHByb3BzLnR5cGUgPT09ICJjaGVja2JveCIgfHwgcHJvcHMudHlwZSA9PT0gInJhZGlvIjsKICAgICAgICAgIHJldHVybiB1c2VzQ2hlY2tlZCA/IHByb3BzLmNoZWNrZWQgIT0gbnVsbCA6IHByb3BzLnZhbHVlICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGNoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzLkNoaWxkcmVuLmZvckVhY2gocHJvcHMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBjaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZENoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCBpbmZlciB0aGUgb3B0aW9uIHZhbHVlIG9mIGNvbXBsZXggY2hpbGRyZW4uIFBhc3MgYSBgdmFsdWVgIHByb3Agb3IgdXNlIGEgcGxhaW4gc3RyaW5nIGFzIGNoaWxkcmVuIHRvIDxvcHRpb24+LiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRJbm5lckhUTUwpIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRJbm5lckhUTUwgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUGFzcyBhIGB2YWx1ZWAgcHJvcCBpZiB5b3Ugc2V0IGRhbmdlcm91c2x5SW5uZXJIVE1MIHNvIFJlYWN0IGtub3dzIHdoaWNoIHZhbHVlIHNob3VsZCBiZSBzZWxlY3RlZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLnNlbGVjdGVkICE9IG51bGwgJiYgIWRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVzZSB0aGUgYGRlZmF1bHRWYWx1ZWAgb3IgYHZhbHVlYCBwcm9wcyBvbiA8c2VsZWN0PiBpbnN0ZWFkIG9mIHNldHRpbmcgYHNlbGVjdGVkYCBvbiA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICBkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgidmFsdWUiLCB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlKSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgICAgdmFyIG93bmVyTmFtZSA9IGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCk7CiAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlUHJvcE5hbWVzID0gWyJ2YWx1ZSIsICJkZWZhdWx0VmFsdWUiXTsKICAgICAgICBmdW5jdGlvbiBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJzZWxlY3QiLCBwcm9wcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVQcm9wTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcHJvcE5hbWUgPSB2YWx1ZVByb3BOYW1lc1tpXTsKICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcHJvcE5hbWVJc0FycmF5ID0gaXNBcnJheShwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zKG5vZGUsIG11bHRpcGxlLCBwcm9wVmFsdWUsIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgdmFyIG9wdGlvbnMyID0gbm9kZS5vcHRpb25zOwogICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlcyA9IHByb3BWYWx1ZTsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkVmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWxlY3RlZFZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVbIiQiICsgc2VsZWN0ZWRWYWx1ZXNbaV1dID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgb3B0aW9uczIubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0ZWRWYWx1ZS5oYXNPd25Qcm9wZXJ0eSgiJCIgKyBvcHRpb25zMltfaV0udmFsdWUpOwogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaV0uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zMltfaV0uc2VsZWN0ZWQgPSBzZWxlY3RlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkICYmIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3NlbGVjdGVkVmFsdWUgPSB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BWYWx1ZSkpOwogICAgICAgICAgICB2YXIgZGVmYXVsdFNlbGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgb3B0aW9uczIubGVuZ3RoOyBfaTIrKykgewogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaTJdLnZhbHVlID09PSBfc2VsZWN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2kyXS5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2V0RGVmYXVsdFNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uZGVmYXVsdFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCA9PT0gbnVsbCAmJiAhb3B0aW9uczJbX2kyXS5kaXNhYmxlZCkgewogICAgICAgICAgICAgICAgZGVmYXVsdFNlbGVjdGVkID0gb3B0aW9uczJbX2kyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZC5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0V3JhcHBlclN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tTZWxlY3RQcm9wVHlwZXMocHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlID0gewogICAgICAgICAgICB3YXNNdWx0aXBsZTogISFwcm9wcy5tdWx0aXBsZQogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9PSB2b2lkIDAgJiYgcHJvcHMuZGVmYXVsdFZhbHVlICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSQxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlNlbGVjdCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBzZWxlY3QgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgbm9kZS5tdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5kZWZhdWx0VmFsdWUsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0VXBkYXRlV3JhcHBlcihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHdhc011bHRpcGxlID0gbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlOwogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfSBlbHNlIGlmICh3YXNNdWx0aXBsZSAhPT0gISFwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5tdWx0aXBsZSA/IFtdIDogIiIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbERlZmF1bHRWYWwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UHJvcHMkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIGRvZXMgbm90IG1ha2Ugc2Vuc2Ugb24gPHRleHRhcmVhPi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBob3N0UHJvcHMgPSBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIjx0ZXh0YXJlYT4gY2FuIG9ubHkgaGF2ZSBhdCBtb3N0IG9uZSBjaGlsZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IGNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gY2hpbGRyZW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZSA9IHsKICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKGluaXRpYWxWYWx1ZSkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICBpZiAobmV3VmFsdWUgIT09IG5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsICYmIG5vZGUuZGVmYXVsdFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gbm9kZS50ZXh0Q29udGVudDsKICAgICAgICAgIGlmICh0ZXh0Q29udGVudCA9PT0gbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICBpZiAodGV4dENvbnRlbnQgIT09ICIiICYmIHRleHRDb250ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IHRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIEhUTUxfTkFNRVNQQUNFID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiOwogICAgICAgIHZhciBNQVRIX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MIjsKICAgICAgICB2YXIgU1ZHX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJzdmciOgogICAgICAgICAgICAgIHJldHVybiBTVkdfTkFNRVNQQUNFOwogICAgICAgICAgICBjYXNlICJtYXRoIjoKICAgICAgICAgICAgICByZXR1cm4gTUFUSF9OQU1FU1BBQ0U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnROYW1lc3BhY2UsIHR5cGUpIHsKICAgICAgICAgIGlmIChwYXJlbnROYW1lc3BhY2UgPT0gbnVsbCB8fCBwYXJlbnROYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09PSBTVkdfTkFNRVNQQUNFICYmIHR5cGUgPT09ICJmb3JlaWduT2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gSFRNTF9OQU1FU1BBQ0U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFyZW50TmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbiA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgTVNBcHAgIT09ICJ1bmRlZmluZWQiICYmIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihhcmcwLCBhcmcxLCBhcmcyLCBhcmczKSB7CiAgICAgICAgICAgICAgTVNBcHAuZXhlY1Vuc2FmZUxvY2FsRnVuY3Rpb24oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuYyhhcmcwLCBhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHJldXNhYmxlU1ZHQ29udGFpbmVyOwogICAgICAgIHZhciBzZXRJbm5lckhUTUwgPSBjcmVhdGVNaWNyb3NvZnRVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKG5vZGUsIGh0bWwpIHsKICAgICAgICAgIGlmIChub2RlLm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRSkgewogICAgICAgICAgICBpZiAoISgiaW5uZXJIVE1MIiBpbiBub2RlKSkgewogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyID0gcmV1c2FibGVTVkdDb250YWluZXIgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgcmV1c2FibGVTVkdDb250YWluZXIuaW5uZXJIVE1MID0gIjxzdmc+IiArIGh0bWwudmFsdWVPZigpLnRvU3RyaW5nKCkgKyAiPC9zdmc+IjsKICAgICAgICAgICAgICB2YXIgc3ZnTm9kZSA9IHJldXNhYmxlU1ZHQ29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVDaGlsZChub2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAoc3ZnTm9kZS5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHN2Z05vZGUuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIH0pOwogICAgICAgIHZhciBFTEVNRU5UX05PREUgPSAxOwogICAgICAgIHZhciBURVhUX05PREUgPSAzOwogICAgICAgIHZhciBDT01NRU5UX05PREUgPSA4OwogICAgICAgIHZhciBET0NVTUVOVF9OT0RFID0gOTsKICAgICAgICB2YXIgRE9DVU1FTlRfRlJBR01FTlRfTk9ERSA9IDExOwogICAgICAgIHZhciBzZXRUZXh0Q29udGVudCA9IGZ1bmN0aW9uKG5vZGUsIHRleHQpIHsKICAgICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAmJiBmaXJzdENoaWxkID09PSBub2RlLmxhc3RDaGlsZCAmJiBmaXJzdENoaWxkLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICB9OwogICAgICAgIHZhciBzaG9ydGhhbmRUb0xvbmdoYW5kID0gewogICAgICAgICAgYW5pbWF0aW9uOiBbImFuaW1hdGlvbkRlbGF5IiwgImFuaW1hdGlvbkRpcmVjdGlvbiIsICJhbmltYXRpb25EdXJhdGlvbiIsICJhbmltYXRpb25GaWxsTW9kZSIsICJhbmltYXRpb25JdGVyYXRpb25Db3VudCIsICJhbmltYXRpb25OYW1lIiwgImFuaW1hdGlvblBsYXlTdGF0ZSIsICJhbmltYXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgYmFja2dyb3VuZDogWyJiYWNrZ3JvdW5kQXR0YWNobWVudCIsICJiYWNrZ3JvdW5kQ2xpcCIsICJiYWNrZ3JvdW5kQ29sb3IiLCAiYmFja2dyb3VuZEltYWdlIiwgImJhY2tncm91bmRPcmlnaW4iLCAiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIiwgImJhY2tncm91bmRSZXBlYXQiLCAiYmFja2dyb3VuZFNpemUiXSwKICAgICAgICAgIGJhY2tncm91bmRQb3NpdGlvbjogWyJiYWNrZ3JvdW5kUG9zaXRpb25YIiwgImJhY2tncm91bmRQb3NpdGlvblkiXSwKICAgICAgICAgIGJvcmRlcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiLCAiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJSaWdodFN0eWxlIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wQ29sb3IiLCAiYm9yZGVyVG9wU3R5bGUiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckJsb2NrRW5kOiBbImJvcmRlckJsb2NrRW5kQ29sb3IiLCAiYm9yZGVyQmxvY2tFbmRTdHlsZSIsICJib3JkZXJCbG9ja0VuZFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja1N0YXJ0OiBbImJvcmRlckJsb2NrU3RhcnRDb2xvciIsICJib3JkZXJCbG9ja1N0YXJ0U3R5bGUiLCAiYm9yZGVyQmxvY2tTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCb3R0b206IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckNvbG9yOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclRvcENvbG9yIl0sCiAgICAgICAgICBib3JkZXJJbWFnZTogWyJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZUVuZDogWyJib3JkZXJJbmxpbmVFbmRDb2xvciIsICJib3JkZXJJbmxpbmVFbmRTdHlsZSIsICJib3JkZXJJbmxpbmVFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVySW5saW5lU3RhcnQ6IFsiYm9yZGVySW5saW5lU3RhcnRDb2xvciIsICJib3JkZXJJbmxpbmVTdGFydFN0eWxlIiwgImJvcmRlcklubGluZVN0YXJ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlckxlZnQ6IFsiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlclJhZGl1czogWyJib3JkZXJCb3R0b21MZWZ0UmFkaXVzIiwgImJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzIiwgImJvcmRlclRvcExlZnRSYWRpdXMiLCAiYm9yZGVyVG9wUmlnaHRSYWRpdXMiXSwKICAgICAgICAgIGJvcmRlclJpZ2h0OiBbImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJTdHlsZTogWyJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJUb3BTdHlsZSJdLAogICAgICAgICAgYm9yZGVyVG9wOiBbImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJXaWR0aDogWyJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRXaWR0aCIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgY29sdW1uUnVsZTogWyJjb2x1bW5SdWxlQ29sb3IiLCAiY29sdW1uUnVsZVN0eWxlIiwgImNvbHVtblJ1bGVXaWR0aCJdLAogICAgICAgICAgY29sdW1uczogWyJjb2x1bW5Db3VudCIsICJjb2x1bW5XaWR0aCJdLAogICAgICAgICAgZmxleDogWyJmbGV4QmFzaXMiLCAiZmxleEdyb3ciLCAiZmxleFNocmluayJdLAogICAgICAgICAgZmxleEZsb3c6IFsiZmxleERpcmVjdGlvbiIsICJmbGV4V3JhcCJdLAogICAgICAgICAgZm9udDogWyJmb250RmFtaWx5IiwgImZvbnRGZWF0dXJlU2V0dGluZ3MiLCAiZm9udEtlcm5pbmciLCAiZm9udExhbmd1YWdlT3ZlcnJpZGUiLCAiZm9udFNpemUiLCAiZm9udFNpemVBZGp1c3QiLCAiZm9udFN0cmV0Y2giLCAiZm9udFN0eWxlIiwgImZvbnRWYXJpYW50IiwgImZvbnRWYXJpYW50QWx0ZXJuYXRlcyIsICJmb250VmFyaWFudENhcHMiLCAiZm9udFZhcmlhbnRFYXN0QXNpYW4iLCAiZm9udFZhcmlhbnRMaWdhdHVyZXMiLCAiZm9udFZhcmlhbnROdW1lcmljIiwgImZvbnRWYXJpYW50UG9zaXRpb24iLCAiZm9udFdlaWdodCIsICJsaW5lSGVpZ2h0Il0sCiAgICAgICAgICBmb250VmFyaWFudDogWyJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIl0sCiAgICAgICAgICBnYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZDogWyJncmlkQXV0b0NvbHVtbnMiLCAiZ3JpZEF1dG9GbG93IiwgImdyaWRBdXRvUm93cyIsICJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGdyaWRBcmVhOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0IiwgImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uR2FwOiBbImNvbHVtbkdhcCJdLAogICAgICAgICAgZ3JpZEdhcDogWyJjb2x1bW5HYXAiLCAicm93R2FwIl0sCiAgICAgICAgICBncmlkUm93OiBbImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkUm93R2FwOiBbInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFRlbXBsYXRlOiBbImdyaWRUZW1wbGF0ZUFyZWFzIiwgImdyaWRUZW1wbGF0ZUNvbHVtbnMiLCAiZ3JpZFRlbXBsYXRlUm93cyJdLAogICAgICAgICAgbGlzdFN0eWxlOiBbImxpc3RTdHlsZUltYWdlIiwgImxpc3RTdHlsZVBvc2l0aW9uIiwgImxpc3RTdHlsZVR5cGUiXSwKICAgICAgICAgIG1hcmdpbjogWyJtYXJnaW5Cb3R0b20iLCAibWFyZ2luTGVmdCIsICJtYXJnaW5SaWdodCIsICJtYXJnaW5Ub3AiXSwKICAgICAgICAgIG1hcmtlcjogWyJtYXJrZXJFbmQiLCAibWFya2VyTWlkIiwgIm1hcmtlclN0YXJ0Il0sCiAgICAgICAgICBtYXNrOiBbIm1hc2tDbGlwIiwgIm1hc2tDb21wb3NpdGUiLCAibWFza0ltYWdlIiwgIm1hc2tNb2RlIiwgIm1hc2tPcmlnaW4iLCAibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIiwgIm1hc2tSZXBlYXQiLCAibWFza1NpemUiXSwKICAgICAgICAgIG1hc2tQb3NpdGlvbjogWyJtYXNrUG9zaXRpb25YIiwgIm1hc2tQb3NpdGlvblkiXSwKICAgICAgICAgIG91dGxpbmU6IFsib3V0bGluZUNvbG9yIiwgIm91dGxpbmVTdHlsZSIsICJvdXRsaW5lV2lkdGgiXSwKICAgICAgICAgIG92ZXJmbG93OiBbIm92ZXJmbG93WCIsICJvdmVyZmxvd1kiXSwKICAgICAgICAgIHBhZGRpbmc6IFsicGFkZGluZ0JvdHRvbSIsICJwYWRkaW5nTGVmdCIsICJwYWRkaW5nUmlnaHQiLCAicGFkZGluZ1RvcCJdLAogICAgICAgICAgcGxhY2VDb250ZW50OiBbImFsaWduQ29udGVudCIsICJqdXN0aWZ5Q29udGVudCJdLAogICAgICAgICAgcGxhY2VJdGVtczogWyJhbGlnbkl0ZW1zIiwgImp1c3RpZnlJdGVtcyJdLAogICAgICAgICAgcGxhY2VTZWxmOiBbImFsaWduU2VsZiIsICJqdXN0aWZ5U2VsZiJdLAogICAgICAgICAgdGV4dERlY29yYXRpb246IFsidGV4dERlY29yYXRpb25Db2xvciIsICJ0ZXh0RGVjb3JhdGlvbkxpbmUiLCAidGV4dERlY29yYXRpb25TdHlsZSJdLAogICAgICAgICAgdGV4dEVtcGhhc2lzOiBbInRleHRFbXBoYXNpc0NvbG9yIiwgInRleHRFbXBoYXNpc1N0eWxlIl0sCiAgICAgICAgICB0cmFuc2l0aW9uOiBbInRyYW5zaXRpb25EZWxheSIsICJ0cmFuc2l0aW9uRHVyYXRpb24iLCAidHJhbnNpdGlvblByb3BlcnR5IiwgInRyYW5zaXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgd29yZFdyYXA6IFsib3ZlcmZsb3dXcmFwIl0KICAgICAgICB9OwogICAgICAgIHZhciBpc1VuaXRsZXNzTnVtYmVyID0gewogICAgICAgICAgYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQ6IHRydWUsCiAgICAgICAgICBhc3BlY3RSYXRpbzogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlT3V0c2V0OiB0cnVlLAogICAgICAgICAgYm9yZGVySW1hZ2VTbGljZTogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlV2lkdGg6IHRydWUsCiAgICAgICAgICBib3hGbGV4OiB0cnVlLAogICAgICAgICAgYm94RmxleEdyb3VwOiB0cnVlLAogICAgICAgICAgYm94T3JkaW5hbEdyb3VwOiB0cnVlLAogICAgICAgICAgY29sdW1uQ291bnQ6IHRydWUsCiAgICAgICAgICBjb2x1bW5zOiB0cnVlLAogICAgICAgICAgZmxleDogdHJ1ZSwKICAgICAgICAgIGZsZXhHcm93OiB0cnVlLAogICAgICAgICAgZmxleFBvc2l0aXZlOiB0cnVlLAogICAgICAgICAgZmxleFNocmluazogdHJ1ZSwKICAgICAgICAgIGZsZXhOZWdhdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhPcmRlcjogdHJ1ZSwKICAgICAgICAgIGdyaWRBcmVhOiB0cnVlLAogICAgICAgICAgZ3JpZFJvdzogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dFbmQ6IHRydWUsCiAgICAgICAgICBncmlkUm93U3BhbjogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dTdGFydDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uRW5kOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblNwYW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uU3RhcnQ6IHRydWUsCiAgICAgICAgICBmb250V2VpZ2h0OiB0cnVlLAogICAgICAgICAgbGluZUNsYW1wOiB0cnVlLAogICAgICAgICAgbGluZUhlaWdodDogdHJ1ZSwKICAgICAgICAgIG9wYWNpdHk6IHRydWUsCiAgICAgICAgICBvcmRlcjogdHJ1ZSwKICAgICAgICAgIG9ycGhhbnM6IHRydWUsCiAgICAgICAgICB0YWJTaXplOiB0cnVlLAogICAgICAgICAgd2lkb3dzOiB0cnVlLAogICAgICAgICAgekluZGV4OiB0cnVlLAogICAgICAgICAgem9vbTogdHJ1ZSwKICAgICAgICAgIC8vIFNWRy1yZWxhdGVkIHByb3BlcnRpZXMKICAgICAgICAgIGZpbGxPcGFjaXR5OiB0cnVlLAogICAgICAgICAgZmxvb2RPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3RvcE9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNob2Zmc2V0OiB0cnVlLAogICAgICAgICAgc3Ryb2tlTWl0ZXJsaW1pdDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VXaWR0aDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcHJlZml4S2V5KHByZWZpeDIsIGtleSkgewogICAgICAgICAgcmV0dXJuIHByZWZpeDIgKyBrZXkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc3Vic3RyaW5nKDEpOwogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ZXMgPSBbIldlYmtpdCIsICJtcyIsICJNb3oiLCAiTyJdOwogICAgICAgIE9iamVjdC5rZXlzKGlzVW5pdGxlc3NOdW1iZXIpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgcHJlZml4ZXMuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbih7CiAgICAgICAgICBtZW51aXRlbTogdHJ1ZQogICAgICAgIH0sIG9taXR0ZWRDbG9zZVRhZ3MpOwogICAgICAgIHZhciBIVE1MID0gIl9faHRtbCI7CiAgICAgICAgZnVuY3Rpb24gYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKSB7CiAgICAgICAgICBpZiAoIXByb3BzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2b2lkRWxlbWVudFRhZ3NbdGFnXSkgewogICAgICAgICAgICBpZiAocHJvcHMuY2hpbGRyZW4gIT0gbnVsbCB8fCBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRhZyArICIgaXMgYSB2b2lkIGVsZW1lbnQgdGFnIGFuZCBtdXN0IG5laXRoZXIgaGF2ZSBgY2hpbGRyZW5gIG5vciB1c2UgYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IHNldCBvbmUgb2YgYGNoaWxkcmVuYCBvciBgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09ICJvYmplY3QiIHx8ICEoSFRNTCBpbiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTGAgbXVzdCBiZSBpbiB0aGUgZm9ybSBge19faHRtbDogLi4ufWAuIFBsZWFzZSB2aXNpdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGFuZ2Vyb3VzbHktc2V0LWlubmVyLWh0bWwgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFwcm9wcy5zdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmcgJiYgcHJvcHMuY29udGVudEVkaXRhYmxlICYmIHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgYGNvbnRlbnRFZGl0YWJsZWAgYW5kIGNvbnRhaW5zIGBjaGlsZHJlbmAgbWFuYWdlZCBieSBSZWFjdC4gSXQgaXMgbm93IHlvdXIgcmVzcG9uc2liaWxpdHkgdG8gZ3VhcmFudGVlIHRoYXQgbm9uZSBvZiB0aG9zZSBub2RlcyBhcmUgdW5leHBlY3RlZGx5IG1vZGlmaWVkIG9yIGR1cGxpY2F0ZWQuIFRoaXMgaXMgcHJvYmFibHkgbm90IGludGVudGlvbmFsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcHMuc3R5bGUgIT0gbnVsbCAmJiB0eXBlb2YgcHJvcHMuc3R5bGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBzdHlsZWAgcHJvcCBleHBlY3RzIGEgbWFwcGluZyBmcm9tIHN0eWxlIHByb3BlcnRpZXMgdG8gdmFsdWVzLCBub3QgYSBzdHJpbmcuIEZvciBleGFtcGxlLCBzdHlsZT17e21hcmdpblJpZ2h0OiBzcGFjaW5nICsgJ2VtJ319IHdoZW4gdXNpbmcgSlNYLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0N1c3RvbUNvbXBvbmVudCh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgaWYgKHRhZ05hbWUuaW5kZXhPZigiLSIpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnTmFtZSkgewogICAgICAgICAgICBjYXNlICJhbm5vdGF0aW9uLXhtbCI6CiAgICAgICAgICAgIGNhc2UgImNvbG9yLXByb2ZpbGUiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2Utc3JjIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXVyaSI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1mb3JtYXQiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtbmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm1pc3NpbmctZ2x5cGgiOgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBvc3NpYmxlU3RhbmRhcmROYW1lcyA9IHsKICAgICAgICAgIC8vIEhUTUwKICAgICAgICAgIGFjY2VwdDogImFjY2VwdCIsCiAgICAgICAgICBhY2NlcHRjaGFyc2V0OiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICAiYWNjZXB0LWNoYXJzZXQiOiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICBhY2Nlc3NrZXk6ICJhY2Nlc3NLZXkiLAogICAgICAgICAgYWN0aW9uOiAiYWN0aW9uIiwKICAgICAgICAgIGFsbG93ZnVsbHNjcmVlbjogImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICBhbHQ6ICJhbHQiLAogICAgICAgICAgYXM6ICJhcyIsCiAgICAgICAgICBhc3luYzogImFzeW5jIiwKICAgICAgICAgIGF1dG9jYXBpdGFsaXplOiAiYXV0b0NhcGl0YWxpemUiLAogICAgICAgICAgYXV0b2NvbXBsZXRlOiAiYXV0b0NvbXBsZXRlIiwKICAgICAgICAgIGF1dG9jb3JyZWN0OiAiYXV0b0NvcnJlY3QiLAogICAgICAgICAgYXV0b2ZvY3VzOiAiYXV0b0ZvY3VzIiwKICAgICAgICAgIGF1dG9wbGF5OiAiYXV0b1BsYXkiLAogICAgICAgICAgYXV0b3NhdmU6ICJhdXRvU2F2ZSIsCiAgICAgICAgICBjYXB0dXJlOiAiY2FwdHVyZSIsCiAgICAgICAgICBjZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKICAgICAgICAgIGNlbGxzcGFjaW5nOiAiY2VsbFNwYWNpbmciLAogICAgICAgICAgY2hhbGxlbmdlOiAiY2hhbGxlbmdlIiwKICAgICAgICAgIGNoYXJzZXQ6ICJjaGFyU2V0IiwKICAgICAgICAgIGNoZWNrZWQ6ICJjaGVja2VkIiwKICAgICAgICAgIGNoaWxkcmVuOiAiY2hpbGRyZW4iLAogICAgICAgICAgY2l0ZTogImNpdGUiLAogICAgICAgICAgY2xhc3M6ICJjbGFzc05hbWUiLAogICAgICAgICAgY2xhc3NpZDogImNsYXNzSUQiLAogICAgICAgICAgY2xhc3NuYW1lOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNvbHM6ICJjb2xzIiwKICAgICAgICAgIGNvbHNwYW46ICJjb2xTcGFuIiwKICAgICAgICAgIGNvbnRlbnQ6ICJjb250ZW50IiwKICAgICAgICAgIGNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIsCiAgICAgICAgICBjb250ZXh0bWVudTogImNvbnRleHRNZW51IiwKICAgICAgICAgIGNvbnRyb2xzOiAiY29udHJvbHMiLAogICAgICAgICAgY29udHJvbHNsaXN0OiAiY29udHJvbHNMaXN0IiwKICAgICAgICAgIGNvb3JkczogImNvb3JkcyIsCiAgICAgICAgICBjcm9zc29yaWdpbjogImNyb3NzT3JpZ2luIiwKICAgICAgICAgIGRhbmdlcm91c2x5c2V0aW5uZXJodG1sOiAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLAogICAgICAgICAgZGF0YTogImRhdGEiLAogICAgICAgICAgZGF0ZXRpbWU6ICJkYXRlVGltZSIsCiAgICAgICAgICBkZWZhdWx0OiAiZGVmYXVsdCIsCiAgICAgICAgICBkZWZhdWx0Y2hlY2tlZDogImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgIGRlZmF1bHR2YWx1ZTogImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICBkZWZlcjogImRlZmVyIiwKICAgICAgICAgIGRpcjogImRpciIsCiAgICAgICAgICBkaXNhYmxlZDogImRpc2FibGVkIiwKICAgICAgICAgIGRpc2FibGVwaWN0dXJlaW5waWN0dXJlOiAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgZGlzYWJsZXJlbW90ZXBsYXliYWNrOiAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgIGRvd25sb2FkOiAiZG93bmxvYWQiLAogICAgICAgICAgZHJhZ2dhYmxlOiAiZHJhZ2dhYmxlIiwKICAgICAgICAgIGVuY3R5cGU6ICJlbmNUeXBlIiwKICAgICAgICAgIGVudGVya2V5aGludDogImVudGVyS2V5SGludCIsCiAgICAgICAgICBmb3I6ICJodG1sRm9yIiwKICAgICAgICAgIGZvcm06ICJmb3JtIiwKICAgICAgICAgIGZvcm1tZXRob2Q6ICJmb3JtTWV0aG9kIiwKICAgICAgICAgIGZvcm1hY3Rpb246ICJmb3JtQWN0aW9uIiwKICAgICAgICAgIGZvcm1lbmN0eXBlOiAiZm9ybUVuY1R5cGUiLAogICAgICAgICAgZm9ybW5vdmFsaWRhdGU6ICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICBmb3JtdGFyZ2V0OiAiZm9ybVRhcmdldCIsCiAgICAgICAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgICAgICAgIGhlYWRlcnM6ICJoZWFkZXJzIiwKICAgICAgICAgIGhlaWdodDogImhlaWdodCIsCiAgICAgICAgICBoaWRkZW46ICJoaWRkZW4iLAogICAgICAgICAgaGlnaDogImhpZ2giLAogICAgICAgICAgaHJlZjogImhyZWYiLAogICAgICAgICAgaHJlZmxhbmc6ICJocmVmTGFuZyIsCiAgICAgICAgICBodG1sZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBodHRwZXF1aXY6ICJodHRwRXF1aXYiLAogICAgICAgICAgImh0dHAtZXF1aXYiOiAiaHR0cEVxdWl2IiwKICAgICAgICAgIGljb246ICJpY29uIiwKICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgaW1hZ2VzaXplczogImltYWdlU2l6ZXMiLAogICAgICAgICAgaW1hZ2VzcmNzZXQ6ICJpbWFnZVNyY1NldCIsCiAgICAgICAgICBpbm5lcmh0bWw6ICJpbm5lckhUTUwiLAogICAgICAgICAgaW5wdXRtb2RlOiAiaW5wdXRNb2RlIiwKICAgICAgICAgIGludGVncml0eTogImludGVncml0eSIsCiAgICAgICAgICBpczogImlzIiwKICAgICAgICAgIGl0ZW1pZDogIml0ZW1JRCIsCiAgICAgICAgICBpdGVtcHJvcDogIml0ZW1Qcm9wIiwKICAgICAgICAgIGl0ZW1yZWY6ICJpdGVtUmVmIiwKICAgICAgICAgIGl0ZW1zY29wZTogIml0ZW1TY29wZSIsCiAgICAgICAgICBpdGVtdHlwZTogIml0ZW1UeXBlIiwKICAgICAgICAgIGtleXBhcmFtczogImtleVBhcmFtcyIsCiAgICAgICAgICBrZXl0eXBlOiAia2V5VHlwZSIsCiAgICAgICAgICBraW5kOiAia2luZCIsCiAgICAgICAgICBsYWJlbDogImxhYmVsIiwKICAgICAgICAgIGxhbmc6ICJsYW5nIiwKICAgICAgICAgIGxpc3Q6ICJsaXN0IiwKICAgICAgICAgIGxvb3A6ICJsb29wIiwKICAgICAgICAgIGxvdzogImxvdyIsCiAgICAgICAgICBtYW5pZmVzdDogIm1hbmlmZXN0IiwKICAgICAgICAgIG1hcmdpbndpZHRoOiAibWFyZ2luV2lkdGgiLAogICAgICAgICAgbWFyZ2luaGVpZ2h0OiAibWFyZ2luSGVpZ2h0IiwKICAgICAgICAgIG1heDogIm1heCIsCiAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgbWVkaWE6ICJtZWRpYSIsCiAgICAgICAgICBtZWRpYWdyb3VwOiAibWVkaWFHcm91cCIsCiAgICAgICAgICBtZXRob2Q6ICJtZXRob2QiLAogICAgICAgICAgbWluOiAibWluIiwKICAgICAgICAgIG1pbmxlbmd0aDogIm1pbkxlbmd0aCIsCiAgICAgICAgICBtdWx0aXBsZTogIm11bHRpcGxlIiwKICAgICAgICAgIG11dGVkOiAibXV0ZWQiLAogICAgICAgICAgbmFtZTogIm5hbWUiLAogICAgICAgICAgbm9tb2R1bGU6ICJub01vZHVsZSIsCiAgICAgICAgICBub25jZTogIm5vbmNlIiwKICAgICAgICAgIG5vdmFsaWRhdGU6ICJub1ZhbGlkYXRlIiwKICAgICAgICAgIG9wZW46ICJvcGVuIiwKICAgICAgICAgIG9wdGltdW06ICJvcHRpbXVtIiwKICAgICAgICAgIHBhdHRlcm46ICJwYXR0ZXJuIiwKICAgICAgICAgIHBsYWNlaG9sZGVyOiAicGxhY2Vob2xkZXIiLAogICAgICAgICAgcGxheXNpbmxpbmU6ICJwbGF5c0lubGluZSIsCiAgICAgICAgICBwb3N0ZXI6ICJwb3N0ZXIiLAogICAgICAgICAgcHJlbG9hZDogInByZWxvYWQiLAogICAgICAgICAgcHJvZmlsZTogInByb2ZpbGUiLAogICAgICAgICAgcmFkaW9ncm91cDogInJhZGlvR3JvdXAiLAogICAgICAgICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAgICAgICByZWZlcnJlcnBvbGljeTogInJlZmVycmVyUG9saWN5IiwKICAgICAgICAgIHJlbDogInJlbCIsCiAgICAgICAgICByZXF1aXJlZDogInJlcXVpcmVkIiwKICAgICAgICAgIHJldmVyc2VkOiAicmV2ZXJzZWQiLAogICAgICAgICAgcm9sZTogInJvbGUiLAogICAgICAgICAgcm93czogInJvd3MiLAogICAgICAgICAgcm93c3BhbjogInJvd1NwYW4iLAogICAgICAgICAgc2FuZGJveDogInNhbmRib3giLAogICAgICAgICAgc2NvcGU6ICJzY29wZSIsCiAgICAgICAgICBzY29wZWQ6ICJzY29wZWQiLAogICAgICAgICAgc2Nyb2xsaW5nOiAic2Nyb2xsaW5nIiwKICAgICAgICAgIHNlYW1sZXNzOiAic2VhbWxlc3MiLAogICAgICAgICAgc2VsZWN0ZWQ6ICJzZWxlY3RlZCIsCiAgICAgICAgICBzaGFwZTogInNoYXBlIiwKICAgICAgICAgIHNpemU6ICJzaXplIiwKICAgICAgICAgIHNpemVzOiAic2l6ZXMiLAogICAgICAgICAgc3BhbjogInNwYW4iLAogICAgICAgICAgc3BlbGxjaGVjazogInNwZWxsQ2hlY2siLAogICAgICAgICAgc3JjOiAic3JjIiwKICAgICAgICAgIHNyY2RvYzogInNyY0RvYyIsCiAgICAgICAgICBzcmNsYW5nOiAic3JjTGFuZyIsCiAgICAgICAgICBzcmNzZXQ6ICJzcmNTZXQiLAogICAgICAgICAgc3RhcnQ6ICJzdGFydCIsCiAgICAgICAgICBzdGVwOiAic3RlcCIsCiAgICAgICAgICBzdHlsZTogInN0eWxlIiwKICAgICAgICAgIHN1bW1hcnk6ICJzdW1tYXJ5IiwKICAgICAgICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgICAgICAgdGFyZ2V0OiAidGFyZ2V0IiwKICAgICAgICAgIHRpdGxlOiAidGl0bGUiLAogICAgICAgICAgdHlwZTogInR5cGUiLAogICAgICAgICAgdXNlbWFwOiAidXNlTWFwIiwKICAgICAgICAgIHZhbHVlOiAidmFsdWUiLAogICAgICAgICAgd2lkdGg6ICJ3aWR0aCIsCiAgICAgICAgICB3bW9kZTogIndtb2RlIiwKICAgICAgICAgIHdyYXA6ICJ3cmFwIiwKICAgICAgICAgIC8vIFNWRwogICAgICAgICAgYWJvdXQ6ICJhYm91dCIsCiAgICAgICAgICBhY2NlbnRoZWlnaHQ6ICJhY2NlbnRIZWlnaHQiLAogICAgICAgICAgImFjY2VudC1oZWlnaHQiOiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgIGFjY3VtdWxhdGU6ICJhY2N1bXVsYXRlIiwKICAgICAgICAgIGFkZGl0aXZlOiAiYWRkaXRpdmUiLAogICAgICAgICAgYWxpZ25tZW50YmFzZWxpbmU6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIjogImFsaWdubWVudEJhc2VsaW5lIiwKICAgICAgICAgIGFsbG93cmVvcmRlcjogImFsbG93UmVvcmRlciIsCiAgICAgICAgICBhbHBoYWJldGljOiAiYWxwaGFiZXRpYyIsCiAgICAgICAgICBhbXBsaXR1ZGU6ICJhbXBsaXR1ZGUiLAogICAgICAgICAgYXJhYmljZm9ybTogImFyYWJpY0Zvcm0iLAogICAgICAgICAgImFyYWJpYy1mb3JtIjogImFyYWJpY0Zvcm0iLAogICAgICAgICAgYXNjZW50OiAiYXNjZW50IiwKICAgICAgICAgIGF0dHJpYnV0ZW5hbWU6ICJhdHRyaWJ1dGVOYW1lIiwKICAgICAgICAgIGF0dHJpYnV0ZXR5cGU6ICJhdHRyaWJ1dGVUeXBlIiwKICAgICAgICAgIGF1dG9yZXZlcnNlOiAiYXV0b1JldmVyc2UiLAogICAgICAgICAgYXppbXV0aDogImF6aW11dGgiLAogICAgICAgICAgYmFzZWZyZXF1ZW5jeTogImJhc2VGcmVxdWVuY3kiLAogICAgICAgICAgYmFzZWxpbmVzaGlmdDogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgImJhc2VsaW5lLXNoaWZ0IjogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgYmFzZXByb2ZpbGU6ICJiYXNlUHJvZmlsZSIsCiAgICAgICAgICBiYm94OiAiYmJveCIsCiAgICAgICAgICBiZWdpbjogImJlZ2luIiwKICAgICAgICAgIGJpYXM6ICJiaWFzIiwKICAgICAgICAgIGJ5OiAiYnkiLAogICAgICAgICAgY2FsY21vZGU6ICJjYWxjTW9kZSIsCiAgICAgICAgICBjYXBoZWlnaHQ6ICJjYXBIZWlnaHQiLAogICAgICAgICAgImNhcC1oZWlnaHQiOiAiY2FwSGVpZ2h0IiwKICAgICAgICAgIGNsaXA6ICJjbGlwIiwKICAgICAgICAgIGNsaXBwYXRoOiAiY2xpcFBhdGgiLAogICAgICAgICAgImNsaXAtcGF0aCI6ICJjbGlwUGF0aCIsCiAgICAgICAgICBjbGlwcGF0aHVuaXRzOiAiY2xpcFBhdGhVbml0cyIsCiAgICAgICAgICBjbGlwcnVsZTogImNsaXBSdWxlIiwKICAgICAgICAgICJjbGlwLXJ1bGUiOiAiY2xpcFJ1bGUiLAogICAgICAgICAgY29sb3I6ICJjb2xvciIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb246ICJjb2xvckludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgIGNvbG9yaW50ZXJwb2xhdGlvbmZpbHRlcnM6ICJjb2xvckludGVycG9sYXRpb25GaWx0ZXJzIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICBjb2xvcnByb2ZpbGU6ICJjb2xvclByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgIGNvbG9ycmVuZGVyaW5nOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyI6ICJjb2xvclJlbmRlcmluZyIsCiAgICAgICAgICBjb250ZW50c2NyaXB0dHlwZTogImNvbnRlbnRTY3JpcHRUeXBlIiwKICAgICAgICAgIGNvbnRlbnRzdHlsZXR5cGU6ICJjb250ZW50U3R5bGVUeXBlIiwKICAgICAgICAgIGN1cnNvcjogImN1cnNvciIsCiAgICAgICAgICBjeDogImN4IiwKICAgICAgICAgIGN5OiAiY3kiLAogICAgICAgICAgZDogImQiLAogICAgICAgICAgZGF0YXR5cGU6ICJkYXRhdHlwZSIsCiAgICAgICAgICBkZWNlbGVyYXRlOiAiZGVjZWxlcmF0ZSIsCiAgICAgICAgICBkZXNjZW50OiAiZGVzY2VudCIsCiAgICAgICAgICBkaWZmdXNlY29uc3RhbnQ6ICJkaWZmdXNlQ29uc3RhbnQiLAogICAgICAgICAgZGlyZWN0aW9uOiAiZGlyZWN0aW9uIiwKICAgICAgICAgIGRpc3BsYXk6ICJkaXNwbGF5IiwKICAgICAgICAgIGRpdmlzb3I6ICJkaXZpc29yIiwKICAgICAgICAgIGRvbWluYW50YmFzZWxpbmU6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSI6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgIGR1cjogImR1ciIsCiAgICAgICAgICBkeDogImR4IiwKICAgICAgICAgIGR5OiAiZHkiLAogICAgICAgICAgZWRnZW1vZGU6ICJlZGdlTW9kZSIsCiAgICAgICAgICBlbGV2YXRpb246ICJlbGV2YXRpb24iLAogICAgICAgICAgZW5hYmxlYmFja2dyb3VuZDogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIjogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgZW5kOiAiZW5kIiwKICAgICAgICAgIGV4cG9uZW50OiAiZXhwb25lbnQiLAogICAgICAgICAgZXh0ZXJuYWxyZXNvdXJjZXNyZXF1aXJlZDogImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICAgICAgICAgZmlsbDogImZpbGwiLAogICAgICAgICAgZmlsbG9wYWNpdHk6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1vcGFjaXR5IjogImZpbGxPcGFjaXR5IiwKICAgICAgICAgIGZpbGxydWxlOiAiZmlsbFJ1bGUiLAogICAgICAgICAgImZpbGwtcnVsZSI6ICJmaWxsUnVsZSIsCiAgICAgICAgICBmaWx0ZXI6ICJmaWx0ZXIiLAogICAgICAgICAgZmlsdGVycmVzOiAiZmlsdGVyUmVzIiwKICAgICAgICAgIGZpbHRlcnVuaXRzOiAiZmlsdGVyVW5pdHMiLAogICAgICAgICAgZmxvb2RvcGFjaXR5OiAiZmxvb2RPcGFjaXR5IiwKICAgICAgICAgICJmbG9vZC1vcGFjaXR5IjogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICBmbG9vZGNvbG9yOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICBmb2N1c2FibGU6ICJmb2N1c2FibGUiLAogICAgICAgICAgZm9udGZhbWlseTogImZvbnRGYW1pbHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IjogImZvbnRGYW1pbHkiLAogICAgICAgICAgZm9udHNpemU6ICJmb250U2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplIjogImZvbnRTaXplIiwKICAgICAgICAgIGZvbnRzaXplYWRqdXN0OiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiOiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgZm9udHN0cmV0Y2g6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIjogImZvbnRTdHJldGNoIiwKICAgICAgICAgIGZvbnRzdHlsZTogImZvbnRTdHlsZSIsCiAgICAgICAgICAiZm9udC1zdHlsZSI6ICJmb250U3R5bGUiLAogICAgICAgICAgZm9udHZhcmlhbnQ6ICJmb250VmFyaWFudCIsCiAgICAgICAgICAiZm9udC12YXJpYW50IjogImZvbnRWYXJpYW50IiwKICAgICAgICAgIGZvbnR3ZWlnaHQ6ICJmb250V2VpZ2h0IiwKICAgICAgICAgICJmb250LXdlaWdodCI6ICJmb250V2VpZ2h0IiwKICAgICAgICAgIGZvcm1hdDogImZvcm1hdCIsCiAgICAgICAgICBmcm9tOiAiZnJvbSIsCiAgICAgICAgICBmeDogImZ4IiwKICAgICAgICAgIGZ5OiAiZnkiLAogICAgICAgICAgZzE6ICJnMSIsCiAgICAgICAgICBnMjogImcyIiwKICAgICAgICAgIGdseXBobmFtZTogImdseXBoTmFtZSIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSI6ICJnbHlwaE5hbWUiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbmhvcml6b250YWw6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCI6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICBnbHlwaG9yaWVudGF0aW9udmVydGljYWw6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLXZlcnRpY2FsIjogImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgICAgICAgICBnbHlwaHJlZjogImdseXBoUmVmIiwKICAgICAgICAgIGdyYWRpZW50dHJhbnNmb3JtOiAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICAgICAgICAgZ3JhZGllbnR1bml0czogImdyYWRpZW50VW5pdHMiLAogICAgICAgICAgaGFuZ2luZzogImhhbmdpbmciLAogICAgICAgICAgaG9yaXphZHZ4OiAiaG9yaXpBZHZYIiwKICAgICAgICAgICJob3Jpei1hZHYteCI6ICJob3JpekFkdlgiLAogICAgICAgICAgaG9yaXpvcmlnaW54OiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCI6ICJob3Jpek9yaWdpblgiLAogICAgICAgICAgaWRlb2dyYXBoaWM6ICJpZGVvZ3JhcGhpYyIsCiAgICAgICAgICBpbWFnZXJlbmRlcmluZzogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciOiAiaW1hZ2VSZW5kZXJpbmciLAogICAgICAgICAgaW4yOiAiaW4yIiwKICAgICAgICAgIGluOiAiaW4iLAogICAgICAgICAgaW5saXN0OiAiaW5saXN0IiwKICAgICAgICAgIGludGVyY2VwdDogImludGVyY2VwdCIsCiAgICAgICAgICBrMTogImsxIiwKICAgICAgICAgIGsyOiAiazIiLAogICAgICAgICAgazM6ICJrMyIsCiAgICAgICAgICBrNDogIms0IiwKICAgICAgICAgIGs6ICJrIiwKICAgICAgICAgIGtlcm5lbG1hdHJpeDogImtlcm5lbE1hdHJpeCIsCiAgICAgICAgICBrZXJuZWx1bml0bGVuZ3RoOiAia2VybmVsVW5pdExlbmd0aCIsCiAgICAgICAgICBrZXJuaW5nOiAia2VybmluZyIsCiAgICAgICAgICBrZXlwb2ludHM6ICJrZXlQb2ludHMiLAogICAgICAgICAga2V5c3BsaW5lczogImtleVNwbGluZXMiLAogICAgICAgICAga2V5dGltZXM6ICJrZXlUaW1lcyIsCiAgICAgICAgICBsZW5ndGhhZGp1c3Q6ICJsZW5ndGhBZGp1c3QiLAogICAgICAgICAgbGV0dGVyc3BhY2luZzogImxldHRlclNwYWNpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIjogImxldHRlclNwYWNpbmciLAogICAgICAgICAgbGlnaHRpbmdjb2xvcjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgImxpZ2h0aW5nLWNvbG9yIjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgbGltaXRpbmdjb25lYW5nbGU6ICJsaW1pdGluZ0NvbmVBbmdsZSIsCiAgICAgICAgICBsb2NhbDogImxvY2FsIiwKICAgICAgICAgIG1hcmtlcmVuZDogIm1hcmtlckVuZCIsCiAgICAgICAgICAibWFya2VyLWVuZCI6ICJtYXJrZXJFbmQiLAogICAgICAgICAgbWFya2VyaGVpZ2h0OiAibWFya2VySGVpZ2h0IiwKICAgICAgICAgIG1hcmtlcm1pZDogIm1hcmtlck1pZCIsCiAgICAgICAgICAibWFya2VyLW1pZCI6ICJtYXJrZXJNaWQiLAogICAgICAgICAgbWFya2Vyc3RhcnQ6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IjogIm1hcmtlclN0YXJ0IiwKICAgICAgICAgIG1hcmtlcnVuaXRzOiAibWFya2VyVW5pdHMiLAogICAgICAgICAgbWFya2Vyd2lkdGg6ICJtYXJrZXJXaWR0aCIsCiAgICAgICAgICBtYXNrOiAibWFzayIsCiAgICAgICAgICBtYXNrY29udGVudHVuaXRzOiAibWFza0NvbnRlbnRVbml0cyIsCiAgICAgICAgICBtYXNrdW5pdHM6ICJtYXNrVW5pdHMiLAogICAgICAgICAgbWF0aGVtYXRpY2FsOiAibWF0aGVtYXRpY2FsIiwKICAgICAgICAgIG1vZGU6ICJtb2RlIiwKICAgICAgICAgIG51bW9jdGF2ZXM6ICJudW1PY3RhdmVzIiwKICAgICAgICAgIG9mZnNldDogIm9mZnNldCIsCiAgICAgICAgICBvcGFjaXR5OiAib3BhY2l0eSIsCiAgICAgICAgICBvcGVyYXRvcjogIm9wZXJhdG9yIiwKICAgICAgICAgIG9yZGVyOiAib3JkZXIiLAogICAgICAgICAgb3JpZW50OiAib3JpZW50IiwKICAgICAgICAgIG9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iLAogICAgICAgICAgb3JpZ2luOiAib3JpZ2luIiwKICAgICAgICAgIG92ZXJmbG93OiAib3ZlcmZsb3ciLAogICAgICAgICAgb3ZlcmxpbmVwb3NpdGlvbjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXBvc2l0aW9uIjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgb3ZlcmxpbmV0aGlja25lc3M6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIjogIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHBhaW50b3JkZXI6ICJwYWludE9yZGVyIiwKICAgICAgICAgICJwYWludC1vcmRlciI6ICJwYWludE9yZGVyIiwKICAgICAgICAgIHBhbm9zZTE6ICJwYW5vc2UxIiwKICAgICAgICAgICJwYW5vc2UtMSI6ICJwYW5vc2UxIiwKICAgICAgICAgIHBhdGhsZW5ndGg6ICJwYXRoTGVuZ3RoIiwKICAgICAgICAgIHBhdHRlcm5jb250ZW50dW5pdHM6ICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAgICAgICAgIHBhdHRlcm50cmFuc2Zvcm06ICJwYXR0ZXJuVHJhbnNmb3JtIiwKICAgICAgICAgIHBhdHRlcm51bml0czogInBhdHRlcm5Vbml0cyIsCiAgICAgICAgICBwb2ludGVyZXZlbnRzOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICAicG9pbnRlci1ldmVudHMiOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICBwb2ludHM6ICJwb2ludHMiLAogICAgICAgICAgcG9pbnRzYXR4OiAicG9pbnRzQXRYIiwKICAgICAgICAgIHBvaW50c2F0eTogInBvaW50c0F0WSIsCiAgICAgICAgICBwb2ludHNhdHo6ICJwb2ludHNBdFoiLAogICAgICAgICAgcHJlZml4OiAicHJlZml4IiwKICAgICAgICAgIHByZXNlcnZlYWxwaGE6ICJwcmVzZXJ2ZUFscGhhIiwKICAgICAgICAgIHByZXNlcnZlYXNwZWN0cmF0aW86ICJwcmVzZXJ2ZUFzcGVjdFJhdGlvIiwKICAgICAgICAgIHByaW1pdGl2ZXVuaXRzOiAicHJpbWl0aXZlVW5pdHMiLAogICAgICAgICAgcHJvcGVydHk6ICJwcm9wZXJ0eSIsCiAgICAgICAgICByOiAiciIsCiAgICAgICAgICByYWRpdXM6ICJyYWRpdXMiLAogICAgICAgICAgcmVmeDogInJlZlgiLAogICAgICAgICAgcmVmeTogInJlZlkiLAogICAgICAgICAgcmVuZGVyaW5naW50ZW50OiAicmVuZGVyaW5nSW50ZW50IiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IjogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICByZXBlYXRjb3VudDogInJlcGVhdENvdW50IiwKICAgICAgICAgIHJlcGVhdGR1cjogInJlcGVhdER1ciIsCiAgICAgICAgICByZXF1aXJlZGV4dGVuc2lvbnM6ICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICAgICAgICAgcmVxdWlyZWRmZWF0dXJlczogInJlcXVpcmVkRmVhdHVyZXMiLAogICAgICAgICAgcmVzb3VyY2U6ICJyZXNvdXJjZSIsCiAgICAgICAgICByZXN0YXJ0OiAicmVzdGFydCIsCiAgICAgICAgICByZXN1bHQ6ICJyZXN1bHQiLAogICAgICAgICAgcmVzdWx0czogInJlc3VsdHMiLAogICAgICAgICAgcm90YXRlOiAicm90YXRlIiwKICAgICAgICAgIHJ4OiAicngiLAogICAgICAgICAgcnk6ICJyeSIsCiAgICAgICAgICBzY2FsZTogInNjYWxlIiwKICAgICAgICAgIHNlY3VyaXR5OiAic2VjdXJpdHkiLAogICAgICAgICAgc2VlZDogInNlZWQiLAogICAgICAgICAgc2hhcGVyZW5kZXJpbmc6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIjogInNoYXBlUmVuZGVyaW5nIiwKICAgICAgICAgIHNsb3BlOiAic2xvcGUiLAogICAgICAgICAgc3BhY2luZzogInNwYWNpbmciLAogICAgICAgICAgc3BlY3VsYXJjb25zdGFudDogInNwZWN1bGFyQ29uc3RhbnQiLAogICAgICAgICAgc3BlY3VsYXJleHBvbmVudDogInNwZWN1bGFyRXhwb25lbnQiLAogICAgICAgICAgc3BlZWQ6ICJzcGVlZCIsCiAgICAgICAgICBzcHJlYWRtZXRob2Q6ICJzcHJlYWRNZXRob2QiLAogICAgICAgICAgc3RhcnRvZmZzZXQ6ICJzdGFydE9mZnNldCIsCiAgICAgICAgICBzdGRkZXZpYXRpb246ICJzdGREZXZpYXRpb24iLAogICAgICAgICAgc3RlbWg6ICJzdGVtaCIsCiAgICAgICAgICBzdGVtdjogInN0ZW12IiwKICAgICAgICAgIHN0aXRjaHRpbGVzOiAic3RpdGNoVGlsZXMiLAogICAgICAgICAgc3RvcGNvbG9yOiAic3RvcENvbG9yIiwKICAgICAgICAgICJzdG9wLWNvbG9yIjogInN0b3BDb2xvciIsCiAgICAgICAgICBzdG9wb3BhY2l0eTogInN0b3BPcGFjaXR5IiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiOiAic3RvcE9wYWNpdHkiLAogICAgICAgICAgc3RyaWtldGhyb3VnaHBvc2l0aW9uOiAic3RyaWtldGhyb3VnaFBvc2l0aW9uIiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXBvc2l0aW9uIjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICBzdHJpa2V0aHJvdWdodGhpY2tuZXNzOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICBzdHJpbmc6ICJzdHJpbmciLAogICAgICAgICAgc3Ryb2tlOiAic3Ryb2tlIiwKICAgICAgICAgIHN0cm9rZWRhc2hhcnJheTogInN0cm9rZURhc2hhcnJheSIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hhcnJheSI6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgc3Ryb2tlZGFzaG9mZnNldDogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IjogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgc3Ryb2tlbGluZWNhcDogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lY2FwIjogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgc3Ryb2tlbGluZWpvaW46ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIjogInN0cm9rZUxpbmVqb2luIiwKICAgICAgICAgIHN0cm9rZW1pdGVybGltaXQ6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCI6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgIHN0cm9rZXdpZHRoOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgInN0cm9rZS13aWR0aCI6ICJzdHJva2VXaWR0aCIsCiAgICAgICAgICBzdHJva2VvcGFjaXR5OiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiOiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICBzdXBwcmVzc2NvbnRlbnRlZGl0YWJsZXdhcm5pbmc6ICJzdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmciLAogICAgICAgICAgc3VwcHJlc3NoeWRyYXRpb253YXJuaW5nOiAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgIHN1cmZhY2VzY2FsZTogInN1cmZhY2VTY2FsZSIsCiAgICAgICAgICBzeXN0ZW1sYW5ndWFnZTogInN5c3RlbUxhbmd1YWdlIiwKICAgICAgICAgIHRhYmxldmFsdWVzOiAidGFibGVWYWx1ZXMiLAogICAgICAgICAgdGFyZ2V0eDogInRhcmdldFgiLAogICAgICAgICAgdGFyZ2V0eTogInRhcmdldFkiLAogICAgICAgICAgdGV4dGFuY2hvcjogInRleHRBbmNob3IiLAogICAgICAgICAgInRleHQtYW5jaG9yIjogInRleHRBbmNob3IiLAogICAgICAgICAgdGV4dGRlY29yYXRpb246ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1kZWNvcmF0aW9uIjogInRleHREZWNvcmF0aW9uIiwKICAgICAgICAgIHRleHRsZW5ndGg6ICJ0ZXh0TGVuZ3RoIiwKICAgICAgICAgIHRleHRyZW5kZXJpbmc6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgICJ0ZXh0LXJlbmRlcmluZyI6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgIHRvOiAidG8iLAogICAgICAgICAgdHJhbnNmb3JtOiAidHJhbnNmb3JtIiwKICAgICAgICAgIHR5cGVvZjogInR5cGVvZiIsCiAgICAgICAgICB1MTogInUxIiwKICAgICAgICAgIHUyOiAidTIiLAogICAgICAgICAgdW5kZXJsaW5lcG9zaXRpb246ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXBvc2l0aW9uIjogInVuZGVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIHVuZGVybGluZXRoaWNrbmVzczogInVuZGVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyI6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgdW5pY29kZTogInVuaWNvZGUiLAogICAgICAgICAgdW5pY29kZWJpZGk6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIjogInVuaWNvZGVCaWRpIiwKICAgICAgICAgIHVuaWNvZGVyYW5nZTogInVuaWNvZGVSYW5nZSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSI6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgdW5pdHNwZXJlbTogInVuaXRzUGVyRW0iLAogICAgICAgICAgInVuaXRzLXBlci1lbSI6ICJ1bml0c1BlckVtIiwKICAgICAgICAgIHVuc2VsZWN0YWJsZTogInVuc2VsZWN0YWJsZSIsCiAgICAgICAgICB2YWxwaGFiZXRpYzogInZBbHBoYWJldGljIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiOiAidkFscGhhYmV0aWMiLAogICAgICAgICAgdmFsdWVzOiAidmFsdWVzIiwKICAgICAgICAgIHZlY3RvcmVmZmVjdDogInZlY3RvckVmZmVjdCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCI6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgdmVyc2lvbjogInZlcnNpb24iLAogICAgICAgICAgdmVydGFkdnk6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICAidmVydC1hZHYteSI6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueDogInZlcnRPcmlnaW5YIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi14IjogInZlcnRPcmlnaW5YIiwKICAgICAgICAgIHZlcnRvcmlnaW55OiAidmVydE9yaWdpblkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiOiAidmVydE9yaWdpblkiLAogICAgICAgICAgdmhhbmdpbmc6ICJ2SGFuZ2luZyIsCiAgICAgICAgICAidi1oYW5naW5nIjogInZIYW5naW5nIiwKICAgICAgICAgIHZpZGVvZ3JhcGhpYzogInZJZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyI6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgdmlld2JveDogInZpZXdCb3giLAogICAgICAgICAgdmlld3RhcmdldDogInZpZXdUYXJnZXQiLAogICAgICAgICAgdmlzaWJpbGl0eTogInZpc2liaWxpdHkiLAogICAgICAgICAgdm1hdGhlbWF0aWNhbDogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgInYtbWF0aGVtYXRpY2FsIjogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgdm9jYWI6ICJ2b2NhYiIsCiAgICAgICAgICB3aWR0aHM6ICJ3aWR0aHMiLAogICAgICAgICAgd29yZHNwYWNpbmc6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIjogIndvcmRTcGFjaW5nIiwKICAgICAgICAgIHdyaXRpbmdtb2RlOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgIndyaXRpbmctbW9kZSI6ICJ3cml0aW5nTW9kZSIsCiAgICAgICAgICB4MTogIngxIiwKICAgICAgICAgIHgyOiAieDIiLAogICAgICAgICAgeDogIngiLAogICAgICAgICAgeGNoYW5uZWxzZWxlY3RvcjogInhDaGFubmVsU2VsZWN0b3IiLAogICAgICAgICAgeGhlaWdodDogInhIZWlnaHQiLAogICAgICAgICAgIngtaGVpZ2h0IjogInhIZWlnaHQiLAogICAgICAgICAgeGxpbmthY3R1YXRlOiAieGxpbmtBY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphY3R1YXRlIjogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICB4bGlua2FyY3JvbGU6ICJ4bGlua0FyY3JvbGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgIHhsaW5raHJlZjogInhsaW5rSHJlZiIsCiAgICAgICAgICAieGxpbms6aHJlZiI6ICJ4bGlua0hyZWYiLAogICAgICAgICAgeGxpbmtyb2xlOiAieGxpbmtSb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIjogInhsaW5rUm9sZSIsCiAgICAgICAgICB4bGlua3Nob3c6ICJ4bGlua1Nob3ciLAogICAgICAgICAgInhsaW5rOnNob3ciOiAieGxpbmtTaG93IiwKICAgICAgICAgIHhsaW5rdGl0bGU6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgICJ4bGluazp0aXRsZSI6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgIHhsaW5rdHlwZTogInhsaW5rVHlwZSIsCiAgICAgICAgICAieGxpbms6dHlwZSI6ICJ4bGlua1R5cGUiLAogICAgICAgICAgeG1sYmFzZTogInhtbEJhc2UiLAogICAgICAgICAgInhtbDpiYXNlIjogInhtbEJhc2UiLAogICAgICAgICAgeG1sbGFuZzogInhtbExhbmciLAogICAgICAgICAgInhtbDpsYW5nIjogInhtbExhbmciLAogICAgICAgICAgeG1sbnM6ICJ4bWxucyIsCiAgICAgICAgICAieG1sOnNwYWNlIjogInhtbFNwYWNlIiwKICAgICAgICAgIHhtbG5zeGxpbms6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgICJ4bWxuczp4bGluayI6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgIHhtbHNwYWNlOiAieG1sU3BhY2UiLAogICAgICAgICAgeTE6ICJ5MSIsCiAgICAgICAgICB5MjogInkyIiwKICAgICAgICAgIHk6ICJ5IiwKICAgICAgICAgIHljaGFubmVsc2VsZWN0b3I6ICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHo6ICJ6IiwKICAgICAgICAgIHpvb21hbmRwYW46ICJ6b29tQW5kUGFuIgogICAgICAgIH07CiAgICAgICAgdmFyIGFyaWFQcm9wZXJ0aWVzID0gewogICAgICAgICAgImFyaWEtY3VycmVudCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtZGVzY3JpcHRpb24iOiAwLAogICAgICAgICAgImFyaWEtZGV0YWlscyI6IDAsCiAgICAgICAgICAiYXJpYS1kaXNhYmxlZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaGlkZGVuIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1pbnZhbGlkIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1rZXlzaG9ydGN1dHMiOiAwLAogICAgICAgICAgImFyaWEtbGFiZWwiOiAwLAogICAgICAgICAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgIC8vIFdpZGdldCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1hdXRvY29tcGxldGUiOiAwLAogICAgICAgICAgImFyaWEtY2hlY2tlZCI6IDAsCiAgICAgICAgICAiYXJpYS1leHBhbmRlZCI6IDAsCiAgICAgICAgICAiYXJpYS1oYXNwb3B1cCI6IDAsCiAgICAgICAgICAiYXJpYS1sZXZlbCI6IDAsCiAgICAgICAgICAiYXJpYS1tb2RhbCI6IDAsCiAgICAgICAgICAiYXJpYS1tdWx0aWxpbmUiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlzZWxlY3RhYmxlIjogMCwKICAgICAgICAgICJhcmlhLW9yaWVudGF0aW9uIjogMCwKICAgICAgICAgICJhcmlhLXBsYWNlaG9sZGVyIjogMCwKICAgICAgICAgICJhcmlhLXByZXNzZWQiOiAwLAogICAgICAgICAgImFyaWEtcmVhZG9ubHkiOiAwLAogICAgICAgICAgImFyaWEtcmVxdWlyZWQiOiAwLAogICAgICAgICAgImFyaWEtc2VsZWN0ZWQiOiAwLAogICAgICAgICAgImFyaWEtc29ydCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1heCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1pbiI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW5vdyI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZXRleHQiOiAwLAogICAgICAgICAgLy8gTGl2ZSBSZWdpb24gQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXRvbWljIjogMCwKICAgICAgICAgICJhcmlhLWJ1c3kiOiAwLAogICAgICAgICAgImFyaWEtbGl2ZSI6IDAsCiAgICAgICAgICAiYXJpYS1yZWxldmFudCI6IDAsCiAgICAgICAgICAvLyBEcmFnLWFuZC1Ecm9wIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWRyb3BlZmZlY3QiOiAwLAogICAgICAgICAgImFyaWEtZ3JhYmJlZCI6IDAsCiAgICAgICAgICAvLyBSZWxhdGlvbnNoaXAgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYWN0aXZlZGVzY2VuZGFudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xjb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xzcGFuIjogMCwKICAgICAgICAgICJhcmlhLWNvbnRyb2xzIjogMCwKICAgICAgICAgICJhcmlhLWRlc2NyaWJlZGJ5IjogMCwKICAgICAgICAgICJhcmlhLWVycm9ybWVzc2FnZSI6IDAsCiAgICAgICAgICAiYXJpYS1mbG93dG8iOiAwLAogICAgICAgICAgImFyaWEtbGFiZWxsZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1vd25zIjogMCwKICAgICAgICAgICJhcmlhLXBvc2luc2V0IjogMCwKICAgICAgICAgICJhcmlhLXJvd2NvdW50IjogMCwKICAgICAgICAgICJhcmlhLXJvd2luZGV4IjogMCwKICAgICAgICAgICJhcmlhLXJvd3NwYW4iOiAwLAogICAgICAgICAgImFyaWEtc2V0c2l6ZSI6IDAKICAgICAgICB9OwogICAgICAgIHZhciB3YXJuZWRQcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJBUklBID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgdmFyIHJBUklBQ2FtZWwgPSBuZXcgUmVnRXhwKCJeKGFyaWEpW0EtWl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0eSh0YWdOYW1lLCBuYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMsIG5hbWUpICYmIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUFDYW1lbC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGFyaWFOYW1lID0gImFyaWEtIiArIG5hbWUuc2xpY2UoNCkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICB2YXIgY29ycmVjdE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShhcmlhTmFtZSkgPyBhcmlhTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3ROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIEFSSUEgYXR0cmlidXRlcyBmb2xsb3cgdGhlIHBhdHRlcm4gYXJpYS0qIGFuZCBtdXN0IGJlIGxvd2VyY2FzZS4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuYW1lICE9PSBjb3JyZWN0TmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgY29ycmVjdE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGFyaWFQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IGxvd2VyQ2FzZWROYW1lIDogbnVsbDsKICAgICAgICAgICAgICBpZiAoc3RhbmRhcmROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gc3RhbmRhcmROYW1lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVW5rbm93biBBUklBIGF0dHJpYnV0ZSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW52YWxpZFByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSh0eXBlLCBrZXkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaW52YWxpZFByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gaW52YWxpZFByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmIChpbnZhbGlkUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhcmlhIHByb3BzICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JbnZhbGlkQVJJQVByb3BzKHR5cGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZU51bGwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZSAhPT0gImlucHV0IiAmJiB0eXBlICE9PSAidGV4dGFyZWEiICYmIHR5cGUgIT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcyAhPSBudWxsICYmIHByb3BzLnZhbHVlID09PSBudWxsICYmICFkaWRXYXJuVmFsdWVOdWxsKSB7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlTnVsbCA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiICYmIHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiYHZhbHVlYCBwcm9wIG9uIGAlc2Agc2hvdWxkIG5vdCBiZSBudWxsLiBDb25zaWRlciB1c2luZyBhbiBlbXB0eSBhcnJheSB3aGVuIGBtdWx0aXBsZWAgaXMgc2V0IHRvIGB0cnVlYCB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgc3RyaW5nIHRvIGNsZWFyIHRoZSBjb21wb25lbnQgb3IgYHVuZGVmaW5lZGAgZm9yIHVuY29udHJvbGxlZCBjb21wb25lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyQxID0ge307CiAgICAgICAgICB2YXIgRVZFTlRfTkFNRV9SRUdFWCA9IC9eb24uLzsKICAgICAgICAgIHZhciBJTlZBTElEX0VWRU5UX05BTUVfUkVHRVggPSAvXm9uW15BLVpdLzsKICAgICAgICAgIHZhciByQVJJQSQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICB2YXIgckFSSUFDYW1lbCQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24odGFnTmFtZSwgbmFtZSwgdmFsdWUsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwod2FybmVkUHJvcGVydGllcyQxLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gIm9uZm9jdXNpbiIgfHwgbG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3Vzb3V0IikgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCB1c2VzIG9uRm9jdXMgYW5kIG9uQmx1ciBpbnN0ZWFkIG9mIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dC4gQWxsIFJlYWN0IGV2ZW50cyBhcmUgbm9ybWFsaXplZCB0byBidWJibGUsIHNvIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dCBhcmUgbm90IG5lZWRlZC9zdXBwb3J0ZWQgYnkgUmVhY3QuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnRSZWdpc3RyeSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyID0gZXZlbnRSZWdpc3RyeS5yZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLCBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMiA9IGV2ZW50UmVnaXN0cnkucG9zc2libGVSZWdpc3RyYXRpb25OYW1lczsKICAgICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llczIuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyW2xvd2VyQ2FzZWROYW1lXSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBJdCB3aWxsIGJlIGlnbm9yZWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIGlmIChJTlZBTElEX0VWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBSZWFjdCBldmVudHMgdXNlIHRoZSBjYW1lbENhc2UgbmFtaW5nIGNvbnZlbnRpb24sIGZvciBleGFtcGxlIGBvbkNsaWNrYC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUEkMS50ZXN0KG5hbWUpIHx8IHJBUklBQ2FtZWwkMS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiaW5uZXJodG1sIikgewogICAgICAgICAgICAgIGVycm9yKCJEaXJlY3RseSBzZXR0aW5nIHByb3BlcnR5IGBpbm5lckhUTUxgIGlzIG5vdCBwZXJtaXR0ZWQuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBsb29rdXAgZG9jdW1lbnRhdGlvbiBvbiBgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiYXJpYSIpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGBhcmlhYCBhdHRyaWJ1dGUgaXMgcmVzZXJ2ZWQgZm9yIGZ1dHVyZSB1c2UgaW4gUmVhY3QuIFBhc3MgaW5kaXZpZHVhbCBgYXJpYS1gIGF0dHJpYnV0ZXMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlzIiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYSBgJXNgIGZvciBhIHN0cmluZyBhdHRyaWJ1dGUgYGlzYC4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgdHlwZW9mIHZhbHVlKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiICYmIGlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBOYU4gZm9yIHRoZSBgJXNgIGF0dHJpYnV0ZS4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgbmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgICB2YXIgaXNSZXNlcnZlZCA9IHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICAgIGlmIChwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgRE9NIHByb3BlcnR5IGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1Jlc2VydmVkICYmIG5hbWUgIT09IGxvd2VyQ2FzZWROYW1lKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGRvZXMgbm90IHJlY29nbml6ZSB0aGUgYCVzYCBwcm9wIG9uIGEgRE9NIGVsZW1lbnQuIElmIHlvdSBpbnRlbnRpb25hbGx5IHdhbnQgaXQgdG8gYXBwZWFyIGluIHRoZSBET00gYXMgYSBjdXN0b20gYXR0cmlidXRlLCBzcGVsbCBpdCBhcyBsb3dlcmNhc2UgYCVzYCBpbnN0ZWFkLiBJZiB5b3UgYWNjaWRlbnRhbGx5IHBhc3NlZCBpdCBmcm9tIGEgcGFyZW50IGNvbXBvbmVudCwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBlbGVtZW50LiIsIG5hbWUsIGxvd2VyQ2FzZWROYW1lKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiAmJiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LlxuXG5JZiB5b3UgdXNlZCB0byBjb25kaXRpb25hbGx5IG9taXQgaXQgd2l0aCAlcz17Y29uZGl0aW9uICYmIHZhbHVlfSwgcGFzcyAlcz17Y29uZGl0aW9uID8gdmFsdWUgOiB1bmRlZmluZWR9IGluc3RlYWQuJywgdmFsdWUsIG5hbWUsIG5hbWUsIHZhbHVlLCBuYW1lLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNSZXNlcnZlZCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHZhbHVlID09PSAiZmFsc2UiIHx8IHZhbHVlID09PSAidHJ1ZSIpICYmIHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCB0aGUgc3RyaW5nIGAlc2AgZm9yIHRoZSBib29sZWFuIGF0dHJpYnV0ZSBgJXNgLiAlcyBEaWQgeW91IG1lYW4gJXM9eyVzfT8iLCB2YWx1ZSwgbmFtZSwgdmFsdWUgPT09ICJmYWxzZSIgPyAiVGhlIGJyb3dzZXIgd2lsbCBpbnRlcnByZXQgaXQgYXMgYSB0cnV0aHkgdmFsdWUuIiA6ICdBbHRob3VnaCB0aGlzIHdvcmtzLCBpdCB3aWxsIG5vdCB3b3JrIGFzIGV4cGVjdGVkIGlmIHlvdSBwYXNzIHRoZSBzdHJpbmcgImZhbHNlIi4nLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVW5rbm93blByb3BlcnRpZXMgPSBmdW5jdGlvbih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5rbm93blByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSQxKHR5cGUsIGtleSwgcHJvcHNba2V5XSwgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICB1bmtub3duUHJvcHMucHVzaChrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdW5rbm93blByb3BTdHJpbmcgPSB1bmtub3duUHJvcHMubWFwKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gImAiICsgcHJvcCArICJgIjsKICAgICAgICAgICAgfSkuam9pbigiLCAiKTsKICAgICAgICAgICAgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZSBmb3IgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSBpdCBmcm9tIHRoZSBlbGVtZW50LCBvciBwYXNzIGEgc3RyaW5nIG9yIG51bWJlciB2YWx1ZSB0byBrZWVwIGl0IGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodW5rbm93blByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZXMgZm9yIHByb3BzICVzIG9uIDwlcz4gdGFnLiBFaXRoZXIgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCB0aGVtIGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5Vbmtub3duUHJvcGVydGllcyh0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgfQogICAgICAgIHZhciBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSA9IDE7CiAgICAgICAgdmFyIElTX05PTl9ERUxFR0FURUQgPSAxIDw8IDE7CiAgICAgICAgdmFyIElTX0NBUFRVUkVfUEhBU0UgPSAxIDw8IDI7CiAgICAgICAgdmFyIFNIT1VMRF9OT1RfUFJPQ0VTU19QT0xZRklMTF9FVkVOVF9QTFVHSU5TID0gSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgfCBJU19OT05fREVMRUdBVEVEIHwgSVNfQ0FQVFVSRV9QSEFTRTsKICAgICAgICB2YXIgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gZXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVwbGF5aW5nRXZlbnQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50UmVwbGF5aW5nRXZlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgY3VycmVudGx5IHJlcGxheWluZyBldmVudCB0byBub3QgYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgcmV0dXJuIGV2ZW50ID09PSBjdXJyZW50UmVwbGF5aW5nRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbmF0aXZlRXZlbnQudGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LnNyY0VsZW1lbnQgfHwgd2luZG93OwogICAgICAgICAgaWYgKHRhcmdldC5jb3JyZXNwb25kaW5nVXNlRWxlbWVudCkgewogICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGFyZ2V0Lm5vZGVUeXBlID09PSBURVhUX05PREUgPyB0YXJnZXQucGFyZW50Tm9kZSA6IHRhcmdldDsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc3RvcmVJbXBsID0gbnVsbDsKICAgICAgICB2YXIgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0KTsKICAgICAgICAgIGlmICghaW50ZXJuYWxJbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHJlc3RvcmVJbXBsICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0UmVzdG9yZUltcGxlbWVudGF0aW9uKCkgbmVlZHMgdG8gYmUgY2FsbGVkIHRvIGhhbmRsZSBhIHRhcmdldCBmb3IgY29udHJvbGxlZCBldmVudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gaW50ZXJuYWxJbnN0YW5jZS5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAoc3RhdGVOb2RlKSB7CiAgICAgICAgICAgIHZhciBfcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICAgIHJlc3RvcmVJbXBsKGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlLCBpbnRlcm5hbEluc3RhbmNlLnR5cGUsIF9wcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihpbXBsKSB7CiAgICAgICAgICByZXN0b3JlSW1wbCA9IGltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KSB7CiAgICAgICAgICBpZiAocmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICBpZiAocmVzdG9yZVF1ZXVlKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlLnB1c2godGFyZ2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN0b3JlUXVldWUgPSBbdGFyZ2V0XTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdG9yZVRhcmdldCA9IHRhcmdldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbmVlZHNTdGF0ZVJlc3RvcmUoKSB7CiAgICAgICAgICByZXR1cm4gcmVzdG9yZVRhcmdldCAhPT0gbnVsbCB8fCByZXN0b3JlUXVldWUgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCkgewogICAgICAgICAgaWYgKCFyZXN0b3JlVGFyZ2V0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXQgPSByZXN0b3JlVGFyZ2V0OwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldHMgPSByZXN0b3JlUXVldWU7CiAgICAgICAgICByZXN0b3JlVGFyZ2V0ID0gbnVsbDsKICAgICAgICAgIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpOwogICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldHMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZWRUYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQocXVldWVkVGFyZ2V0c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJhdGNoZWRVcGRhdGVzSW1wbCA9IGZ1bmN0aW9uKGZuLCBib29ra2VlcGluZykgewogICAgICAgICAgcmV0dXJuIGZuKGJvb2trZWVwaW5nKTsKICAgICAgICB9OwogICAgICAgIHZhciBmbHVzaFN5bmNJbXBsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmaW5pc2hFdmVudEhhbmRsZXIoKSB7CiAgICAgICAgICB2YXIgY29udHJvbGxlZENvbXBvbmVudHNIYXZlUGVuZGluZ1VwZGF0ZXMgPSBuZWVkc1N0YXRlUmVzdG9yZSgpOwogICAgICAgICAgaWYgKGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0ltcGwoKTsKICAgICAgICAgICAgcmVzdG9yZVN0YXRlSWZOZWVkZWQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGEsIGIpIHsKICAgICAgICAgIGlmIChpc0luc2lkZUV2ZW50SGFuZGxlcikgewogICAgICAgICAgICByZXR1cm4gZm4oYSwgYik7CiAgICAgICAgICB9CiAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gYmF0Y2hlZFVwZGF0ZXNJbXBsKGZuLCBhLCBiKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgICAgIGZpbmlzaEV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKF9iYXRjaGVkVXBkYXRlc0ltcGwsIF9kaXNjcmV0ZVVwZGF0ZXNJbXBsLCBfZmx1c2hTeW5jSW1wbCkgewogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXNJbXBsID0gX2JhdGNoZWRVcGRhdGVzSW1wbDsKICAgICAgICAgIGZsdXNoU3luY0ltcGwgPSBfZmx1c2hTeW5jSW1wbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbnRlcmFjdGl2ZSh0YWcpIHsKICAgICAgICAgIHJldHVybiB0YWcgPT09ICJidXR0b24iIHx8IHRhZyA9PT0gImlucHV0IiB8fCB0YWcgPT09ICJzZWxlY3QiIHx8IHRhZyA9PT0gInRleHRhcmVhIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUHJldmVudE1vdXNlRXZlbnQobmFtZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICBjYXNlICJvbkNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25DbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbkRvdWJsZUNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93biI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VEb3duQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZU1vdmVDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VFbnRlciI6CiAgICAgICAgICAgICAgcmV0dXJuICEhKHByb3BzLmRpc2FibGVkICYmIGlzSW50ZXJhY3RpdmUodHlwZSkpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXIoaW5zdCwgcmVnaXN0cmF0aW9uTmFtZSkgewogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGluc3Quc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUoc3RhdGVOb2RlKTsKICAgICAgICAgIGlmIChwcm9wcyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lciA9IHByb3BzW3JlZ2lzdHJhdGlvbk5hbWVdOwogICAgICAgICAgaWYgKHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGluc3QudHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGxpc3RlbmVyICYmIHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGAiICsgcmVnaXN0cmF0aW9uTmFtZSArICJgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCIgKyB0eXBlb2YgbGlzdGVuZXIgKyAiYCB0eXBlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3B0aW9ucywgInBhc3NpdmUiLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kOwogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRpc3BhdGNoRXZlbnQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZha2VOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicmVhY3QiKTsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCA9IGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0RldihuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBkb2N1bWVudGAgZ2xvYmFsIHdhcyBkZWZpbmVkIHdoZW4gUmVhY3Qgd2FzIGluaXRpYWxpemVkLCBidXQgaXMgbm90IGRlZmluZWQgYW55bW9yZS4gVGhpcyBjYW4gaGFwcGVuIGluIGEgdGVzdCBlbnZpcm9ubWVudCBpZiBhIGNvbXBvbmVudCBzY2hlZHVsZXMgYW4gdXBkYXRlIGZyb20gYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrLCBidXQgdGhlIHRlc3QgaGFzIGFscmVhZHkgZmluaXNoZWQgcnVubmluZy4gVG8gc29sdmUgdGhpcywgeW91IGNhbiBlaXRoZXIgdW5tb3VudCB0aGUgY29tcG9uZW50IGF0IHRoZSBlbmQgb2YgeW91ciB0ZXN0IChhbmQgZW5zdXJlIHRoYXQgYW55IGFzeW5jaHJvbm91cyBvcGVyYXRpb25zIGdldCBjYW5jZWxlZCBpbiBgY29tcG9uZW50V2lsbFVubW91bnRgKSwgb3IgeW91IGNhbiBjaGFuZ2UgdGhlIHRlc3QgaXRzZWxmIHRvIGJlIGFzeW5jaHJvbm91cy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudCIpOwogICAgICAgICAgICAgIHZhciBkaWRDYWxsID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgd2luZG93RXZlbnQgPSB3aW5kb3cuZXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50RGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iod2luZG93LCAiZXZlbnQiKTsKICAgICAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpIHsKICAgICAgICAgICAgICAgIGZha2VOb2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0VHlwZSwgY2FsbENhbGxiYWNrMiwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuZXZlbnQgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgiZXZlbnQiKSkgewogICAgICAgICAgICAgICAgICB3aW5kb3cuZXZlbnQgPSB3aW5kb3dFdmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZ1bmNBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKICAgICAgICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2syKCkgewogICAgICAgICAgICAgICAgZGlkQ2FsbCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICAgICAgICBkaWRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgIHZhciBkaWRTZXRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBpc0Nyb3NzT3JpZ2luRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVXaW5kb3dFcnJvcihldmVudCkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gZXZlbnQuZXJyb3I7CiAgICAgICAgICAgICAgICBkaWRTZXRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IyID09PSBudWxsICYmIGV2ZW50LmNvbG5vID09PSAwICYmIGV2ZW50LmxpbmVubyA9PT0gMCkgewogICAgICAgICAgICAgICAgICBpc0Nyb3NzT3JpZ2luRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIHR5cGVvZiBlcnJvcjIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChpbm5lcikgewogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXZ0VHlwZSA9ICJyZWFjdC0iICsgKG5hbWUgPyBuYW1lIDogImludm9rZWd1YXJkZWRjYWxsYmFjayIpOwogICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBmYWtlTm9kZS5hZGRFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICBldnQuaW5pdEV2ZW50KGV2dFR5cGUsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgZmFrZU5vZGUuZGlzcGF0Y2hFdmVudChldnQpOwogICAgICAgICAgICAgIGlmICh3aW5kb3dFdmVudERlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csICJldmVudCIsIHdpbmRvd0V2ZW50RGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaWRDYWxsICYmIGRpZEVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFNldEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcihgQW4gZXJyb3Igd2FzIHRocm93biBpbnNpZGUgb25lIG9mIHlvdXIgY29tcG9uZW50cywgYnV0IFJlYWN0IGRvZXNuJ3Qga25vdyB3aGF0IGl0IHdhcy4gVGhpcyBpcyBsaWtlbHkgZHVlIHRvIGJyb3dzZXIgZmxha2luZXNzLiBSZWFjdCBkb2VzIGl0cyBiZXN0IHRvIHByZXNlcnZlIHRoZSAiUGF1c2Ugb24gZXhjZXB0aW9ucyIgYmVoYXZpb3Igb2YgdGhlIERldlRvb2xzLCB3aGljaCByZXF1aXJlcyBzb21lIERFVi1tb2RlIG9ubHkgdHJpY2tzLiBJdCdzIHBvc3NpYmxlIHRoYXQgdGhlc2UgZG9uJ3Qgd29yayBpbiB5b3VyIGJyb3dzZXIuIFRyeSB0cmlnZ2VyaW5nIHRoZSBlcnJvciBpbiBwcm9kdWN0aW9uIG1vZGUsIG9yIHN3aXRjaGluZyB0byBhIG1vZGVybiBicm93c2VyLiBJZiB5b3Ugc3VzcGVjdCB0aGF0IHRoaXMgaXMgYWN0dWFsbHkgYW4gaXNzdWUgd2l0aCBSZWFjdCwgcGxlYXNlIGZpbGUgYW4gaXNzdWUuYCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3Jvc3NPcmlnaW5FcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIkEgY3Jvc3Mtb3JpZ2luIGVycm9yIHdhcyB0aHJvd24uIFJlYWN0IGRvZXNuJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIGFjdHVhbCBlcnJvciBvYmplY3QgaW4gZGV2ZWxvcG1lbnQuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY3Jvc3NvcmlnaW4tZXJyb3IgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgaGFuZGxlV2luZG93RXJyb3IpOwogICAgICAgICAgICAgIGlmICghZGlkQ2FsbCkgewogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIHJldHVybiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxID0gaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbDsKICAgICAgICB2YXIgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICB2YXIgcmVwb3J0ZXIgPSB7CiAgICAgICAgICBvbkVycm9yOiBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgICAgICBjYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFjayhuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxLmFwcGx5KHJlcG9ydGVyLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tBbmRDYXRjaEZpcnN0RXJyb3IobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGVycm9yMiA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgaWYgKCFoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIHJldGhyb3dFcnJvciA9IGVycm9yMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRocm93Q2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICBpZiAoaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSByZXRocm93RXJyb3I7CiAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgICAgICByZXRocm93RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc0NhdWdodEVycm9yKCkgewogICAgICAgICAgcmV0dXJuIGhhc0Vycm9yOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjYXVnaHRFcnJvcjsKICAgICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gZXJyb3IyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjbGVhckNhdWdodEVycm9yIHdhcyBjYWxsZWQgYnV0IG5vIGVycm9yIHdhcyBjYXB0dXJlZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhcyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgICBrZXkuX3JlYWN0SW50ZXJuYWxzID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBOb0ZsYWdzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBQZXJmb3JtZWRXb3JrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQbGFjZW1lbnQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBVcGRhdGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBDaGlsZERlbGV0aW9uID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgQ29udGVudFJlc2V0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMgogICAgICAgICk7CiAgICAgICAgdmFyIENhbGxiYWNrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBEaWRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmNlQ2xpZW50UmVuZGVyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAqLwogICAgICAgICAgMjU2CiAgICAgICAgKTsKICAgICAgICB2YXIgUmVmID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBTbmFwc2hvdCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwNDgKICAgICAgICApOwogICAgICAgIHZhciBIeWRyYXRpbmcgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBWaXNpYmlsaXR5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBTdG9yZUNvbnNpc3RlbmN5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Mzg0CiAgICAgICAgKTsKICAgICAgICB2YXIgTGlmZWN5Y2xlRWZmZWN0TWFzayA9IFBhc3NpdmUgfCBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmIHwgSHlkcmF0aW5nIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgTGF5b3V0TWFzayA9IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgUGFzc2l2ZU1hc2sgPSBQYXNzaXZlIHwgQ2hpbGREZWxldGlvbjsKICAgICAgICB2YXIgU3RhdGljTWFzayA9IExheW91dFN0YXRpYyB8IFBhc3NpdmVTdGF0aWMgfCBSZWZTdGF0aWM7CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGZpYmVyOwogICAgICAgICAgaWYgKCFmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgdmFyIG5leHROb2RlID0gbm9kZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIG5vZGUgPSBuZXh0Tm9kZTsKICAgICAgICAgICAgICBpZiAoKG5vZGUuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIG5lYXJlc3RNb3VudGVkID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5leHROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5leHROb2RlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnJldHVybikgewogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICByZXR1cm4gbmVhcmVzdE1vdW50ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250YWluZXJGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RSb290ID8gZmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gOiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZpYmVyTW91bnRlZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpID09PSBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNNb3VudGVkKGNvbXBvbmVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgICBpZiAob3duZXIgIT09IG51bGwgJiYgb3duZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gb3duZXJGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKCFpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgaXNNb3VudGVkIGluc2lkZSBpdHMgcmVuZGVyKCkgZnVuY3Rpb24uIHJlbmRlcigpIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiBJdCBzaG91bGQgbmV2ZXIgYWNjZXNzIHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHN0YWxlIGRhdGEgZnJvbSB0aGUgcHJldmlvdXMgcmVuZGVyLCBzdWNoIGFzIHJlZnMuIE1vdmUgdGhpcyBsb2dpYyB0byBjb21wb25lbnREaWRNb3VudCBhbmQgY29tcG9uZW50RGlkVXBkYXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lckZpYmVyKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW5zdGFuY2UuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFob29rLnN1cHBvcnRzRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbih7fSwgaW50ZXJuYWxzLCB7CiAgICAgICAgICAgICAgICBnZXRMYW5lTGFiZWxNYXAsCiAgICAgICAgICAgICAgICBpbmplY3RQcm9maWxpbmdIb29rcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlbmRlcmVySUQgPSBob29rLmluamVjdChpbnRlcm5hbHMpOwogICAgICAgICAgICBpbmplY3RlZEhvb2sgPSBob29rOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcy4iLCBlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaG9vay5jaGVja0RDRSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25TY2hlZHVsZVJvb3Qocm9vdDMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFJvb3Qocm9vdDMsIGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IChyb290My5jdXJyZW50LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIpIHsKICAgICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBzY2hlZHVsZXJQcmlvcml0eSwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIHZvaWQgMCwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Qb3N0Q29tbWl0Um9vdChyb290MykgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFVubW91bnQoZmliZXIpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudChyZW5kZXJlcklELCBmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKG5ld0lzU3RyaWN0TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHVuc3RhYmxlX3lpZWxkVmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB1bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZShuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIHNldFN1cHByZXNzV2FybmluZyhuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlKHJlbmRlcmVySUQsIG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdFByb2ZpbGluZ0hvb2tzKHByb2ZpbGluZ0hvb2tzKSB7CiAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gcHJvZmlsaW5nSG9va3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVMYWJlbE1hcCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaW5kZXgyID0gMDsgaW5kZXgyIDwgVG90YWxMYW5lczsgaW5kZXgyKyspIHsKICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBnZXRMYWJlbEZvckxhbmUobGFuZSk7CiAgICAgICAgICAgICAgbWFwLnNldChsYW5lLCBsYWJlbCk7CiAgICAgICAgICAgICAgbGFuZSAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZmliZXIsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlcllpZWxkZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJZaWVsZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZChsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29uY3VycmVudE1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQcm9maWxlTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdExlZ2FjeU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgU3RyaWN0RWZmZWN0c01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgY2x6MzIgPSBNYXRoLmNsejMyID8gTWF0aC5jbHozMiA6IGNsejMyRmFsbGJhY2s7CiAgICAgICAgdmFyIGxvZyA9IE1hdGgubG9nOwogICAgICAgIHZhciBMTjIgPSBNYXRoLkxOMjsKICAgICAgICBmdW5jdGlvbiBjbHozMkZhbGxiYWNrKHgpIHsKICAgICAgICAgIHZhciBhc1VpbnQgPSB4ID4+PiAwOwogICAgICAgICAgaWYgKGFzVWludCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gMzI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMzEgLSAobG9nKGFzVWludCkgLyBMTjIgfCAwKSB8IDA7CiAgICAgICAgfQogICAgICAgIHZhciBUb3RhbExhbmVzID0gMzE7CiAgICAgICAgdmFyIE5vTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgTm9MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgU3luY0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdExhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MTk0MjQwCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTggPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4MTkyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEwID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMxMDcyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjYyMTQ0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTI0Mjg4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEzMDAyMzQyNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4Mzg4NjA4CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmU0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY3MTA4ODY0CiAgICAgICAgKTsKICAgICAgICB2YXIgU29tZVJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgdmFyIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAqLwogICAgICAgICAgMTM0MjE3NzI4CiAgICAgICAgKTsKICAgICAgICB2YXIgTm9uSWRsZUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjg0MzU0NTUKICAgICAgICApOwogICAgICAgIHZhciBJZGxlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NgogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTM2ODcwOTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgT2Zmc2NyZWVuTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDczNzQxODI0CiAgICAgICAgKTsKICAgICAgICBmdW5jdGlvbiBnZXRMYWJlbEZvckxhbmUobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobGFuZSAmIFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJTeW5jIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91c0h5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJbnB1dENvbnRpbnVvdXMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdEh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHRIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdExhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb25IeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFuc2l0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFJldHJ5TGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlJldHJ5IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlNlbGVjdGl2ZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBPZmZzY3JlZW5MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJPZmZzY3JlZW4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb1RpbWVzdGFtcCA9IC0xOwogICAgICAgIHZhciBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgdmFyIG5leHRSZXRyeUxhbmUgPSBSZXRyeUxhbmUxOwogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKGxhbmVzKSB7CiAgICAgICAgICBzd2l0Y2ggKGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRMYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBsYW5lcyAmIFRyYW5zaXRpb25MYW5lczsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgUmV0cnlMYW5lczsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSWRsZUxhbmU7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiU2hvdWxkIGhhdmUgZm91bmQgbWF0Y2hpbmcgbGFuZXMuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBsYW5lczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dExhbmVzKHJvb3QzLCB3aXBMYW5lcykgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChwZW5kaW5nTGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgbm9uSWRsZVBlbmRpbmdMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIE5vbklkbGVMYW5lczsKICAgICAgICAgIGlmIChub25JZGxlUGVuZGluZ0xhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBub25JZGxlVW5ibG9ja2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICBpZiAobm9uSWRsZVVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbm9uSWRsZVBpbmdlZExhbmVzID0gbm9uSWRsZVBlbmRpbmdMYW5lcyAmIHBpbmdlZExhbmVzOwogICAgICAgICAgICAgIGlmIChub25JZGxlUGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKG5vbklkbGVQaW5nZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5ibG9ja2VkTGFuZXMgPSBwZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmICh1bmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAocGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0TGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod2lwTGFuZXMgIT09IE5vTGFuZXMgJiYgd2lwTGFuZXMgIT09IG5leHRMYW5lcyAmJiAvLyBJZiB3ZSBhbHJlYWR5IHN1c3BlbmRlZCB3aXRoIGEgZGVsYXksIHRoZW4gaW50ZXJydXB0aW5nIGlzIGZpbmUuIERvbid0CiAgICAgICAgICAvLyBib3RoZXIgd2FpdGluZyB1bnRpbCB0aGUgcm9vdCBpcyBjb21wbGV0ZS4KICAgICAgICAgICh3aXBMYW5lcyAmIHN1c3BlbmRlZExhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgbmV4dExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKG5leHRMYW5lcyk7CiAgICAgICAgICAgIHZhciB3aXBMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZSh3aXBMYW5lcyk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBUZXN0cyB3aGV0aGVyIHRoZSBuZXh0IGxhbmUgaXMgZXF1YWwgb3IgbG93ZXIgcHJpb3JpdHkgdGhhbiB0aGUgd2lwCiAgICAgICAgICAgICAgLy8gb25lLiBUaGlzIHdvcmtzIGJlY2F1c2UgdGhlIGJpdHMgZGVjcmVhc2UgaW4gcHJpb3JpdHkgYXMgeW91IGdvIGxlZnQuCiAgICAgICAgICAgICAgbmV4dExhbmUgPj0gd2lwTGFuZSB8fCAvLyBEZWZhdWx0IHByaW9yaXR5IHVwZGF0ZXMgc2hvdWxkIG5vdCBpbnRlcnJ1cHQgdHJhbnNpdGlvbiB1cGRhdGVzLiBUaGUKICAgICAgICAgICAgICAvLyBvbmx5IGRpZmZlcmVuY2UgYmV0d2VlbiBkZWZhdWx0IHVwZGF0ZXMgYW5kIHRyYW5zaXRpb24gdXBkYXRlcyBpcyB0aGF0CiAgICAgICAgICAgICAgLy8gZGVmYXVsdCB1cGRhdGVzIGRvIG5vdCBzdXBwb3J0IHJlZnJlc2ggdHJhbnNpdGlvbnMuCiAgICAgICAgICAgICAgbmV4dExhbmUgPT09IERlZmF1bHRMYW5lICYmICh3aXBMYW5lICYgVHJhbnNpdGlvbkxhbmVzKSAhPT0gTm9MYW5lcwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICByZXR1cm4gd2lwTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgobmV4dExhbmVzICYgSW5wdXRDb250aW51b3VzTGFuZSkgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dExhbmVzIHw9IHBlbmRpbmdMYW5lcyAmIERlZmF1bHRMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICBpZiAoZW50YW5nbGVkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBuZXh0TGFuZXMgJiBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICAgIG5leHRMYW5lcyB8PSBlbnRhbmdsZW1lbnRzW2luZGV4Ml07CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0TGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vc3RSZWNlbnRFdmVudFRpbWUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICB2YXIgbW9zdFJlY2VudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBldmVudFRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChldmVudFRpbWUgPiBtb3N0UmVjZW50RXZlbnRUaW1lKSB7CiAgICAgICAgICAgICAgbW9zdFJlY2VudEV2ZW50VGltZSA9IGV2ZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHN3aXRjaCAobGFuZSkgewogICAgICAgICAgICBjYXNlIFN5bmNMYW5lOgogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyAyNTA7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyA1ZTM7CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMToKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNDoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhcnZlZExhbmVzQXNFeHBpcmVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lc1tpbmRleDJdOwogICAgICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgICAgaWYgKChsYW5lICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzIHx8IChsYW5lICYgcGluZ2VkTGFuZXMpICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGlyYXRpb25UaW1lIDw9IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzIHw9IGxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290MykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKSB7CiAgICAgICAgICB2YXIgZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5PZmZzY3JlZW5MYW5lOwogICAgICAgICAgaWYgKGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIE9mZnNjcmVlbkxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNTeW5jTGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNMYW5lKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNOb25JZGxlV29yayhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIE5vbklkbGVMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVJldHJpZXMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBSZXRyeUxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKGxhbmVzKSB7CiAgICAgICAgICB2YXIgVXJnZW50TGFuZXMgPSBTeW5jTGFuZSB8IElucHV0Q29udGludW91c0xhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBVcmdlbnRMYW5lcykgPT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIFN5bmNEZWZhdWx0TGFuZXMgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRIeWRyYXRpb25MYW5lIHwgRGVmYXVsdExhbmU7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0RlZmF1bHRMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgcm9vdDMuZXhwaXJlZExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUcmFuc2l0aW9uTGFuZShsYW5lKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0VHJhbnNpdGlvbkxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRSZXRyeUxhbmUoKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IG5leHRSZXRyeUxhbmU7CiAgICAgICAgICBuZXh0UmV0cnlMYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0UmV0cnlMYW5lICYgUmV0cnlMYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGxhbmVzICYgLWxhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gMzEgLSBjbHozMihsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0luZGV4KGxhbmUpIHsKICAgICAgICAgIHJldHVybiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1NvbWVMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiAoYSAmIGIpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1N1YnNldE9mTGFuZXMoc2V0Miwgc3Vic2V0KSB7CiAgICAgICAgICByZXR1cm4gKHNldDIgJiBzdWJzZXQpID09PSBzdWJzZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lcmdlTGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgfCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVMYW5lcyhzZXQyLCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiBzZXQyICYgfnN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0TGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgJiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lVG9MYW5lcyhsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyUHJpb3JpdHlMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSBOb0xhbmUgJiYgYSA8IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTGFuZU1hcChpbml0aWFsKSB7CiAgICAgICAgICB2YXIgbGFuZU1hcCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBUb3RhbExhbmVzOyBpKyspIHsKICAgICAgICAgICAgbGFuZU1hcC5wdXNoKGluaXRpYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmVNYXA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290VXBkYXRlZChyb290MywgdXBkYXRlTGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgfD0gdXBkYXRlTGFuZTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBJZGxlTGFuZSkgewogICAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleCh1cGRhdGVMYW5lKTsKICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IGV2ZW50VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyB8PSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzICY9IH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzIHw9IHJvb3QzLnN1c3BlbmRlZExhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKSB7CiAgICAgICAgICB2YXIgbm9Mb25nZXJQZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXMgJiB+cmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLm11dGFibGVSZWFkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5lbnRhbmdsZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBub0xvbmdlclBlbmRpbmdMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gPSBOb0xhbmVzOwogICAgICAgICAgICBldmVudFRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBlbnRhbmdsZWRMYW5lcykgewogICAgICAgICAgdmFyIHJvb3RFbnRhbmdsZWRMYW5lcyA9IHJvb3QzLmVudGFuZ2xlZExhbmVzIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdEVudGFuZ2xlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIElzIHRoaXMgb25lIG9mIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgbGFuZSAmIGVudGFuZ2xlZExhbmVzIHwgLy8gSXMgdGhpcyBsYW5lIHRyYW5zaXRpdmVseSBlbnRhbmdsZWQgd2l0aCB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSAmIGVudGFuZ2xlZExhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcmVuZGVyTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBsYW5lOwogICAgICAgICAgc3dpdGNoIChyZW5kZXJMYW5lKSB7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICBsYW5lID0gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICBsYW5lID0gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgbGFuZSA9IFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYW5lID0gTm9MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChsYW5lICYgKHJvb3QzLnN1c3BlbmRlZExhbmVzIHwgcmVuZGVyTGFuZXMyKSkgIT09IE5vTGFuZSkgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICB1cGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKCFpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHJvb3QzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXA7CiAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgIW1lbW9pemVkVXBkYXRlcnMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyYW5zaXRpb25zRm9yTGFuZXMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRGlzY3JldGVFdmVudFByaW9yaXR5ID0gU3luY0xhbmU7CiAgICAgICAgdmFyIENvbnRpbnVvdXNFdmVudFByaW9yaXR5ID0gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICB2YXIgRGVmYXVsdEV2ZW50UHJpb3JpdHkgPSBEZWZhdWx0TGFuZTsKICAgICAgICB2YXIgSWRsZUV2ZW50UHJpb3JpdHkgPSBJZGxlTGFuZTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShuZXdQcmlvcml0eSkgewogICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gbmV3UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bldpdGhQcmlvcml0eShwcmlvcml0eSwgZm4pIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJpb3JpdHk7CiAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJldmlvdXNQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAhPT0gMCAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb3dlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgPT09IDAgfHwgYSA+IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lc1RvRXZlbnRQcmlvcml0eShsYW5lcykgewogICAgICAgICAgdmFyIGxhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKTsKICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSwgbGFuZSkpIHsKICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5jbHVkZXNOb25JZGxlV29yayhsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpIHsKICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSByb290My5jdXJyZW50Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gY3VycmVudFN0YXRlLmlzRGVoeWRyYXRlZDsKICAgICAgICB9CiAgICAgICAgdmFyIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uID0gZm47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcikgewogICAgICAgICAgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihmbikgewogICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5JDE7CiAgICAgICAgZnVuY3Rpb24gc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGZuKSB7CiAgICAgICAgICBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHk7CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgdmFyIHF1ZXVlZERpc2NyZXRlRXZlbnRzID0gW107CiAgICAgICAgdmFyIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgdmFyIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkUG9pbnRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMgPSBbXTsKICAgICAgICB2YXIgZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzID0gWwogICAgICAgICAgIm1vdXNlZG93biIsCiAgICAgICAgICAibW91c2V1cCIsCiAgICAgICAgICAidG91Y2hjYW5jZWwiLAogICAgICAgICAgInRvdWNoZW5kIiwKICAgICAgICAgICJ0b3VjaHN0YXJ0IiwKICAgICAgICAgICJhdXhjbGljayIsCiAgICAgICAgICAiZGJsY2xpY2siLAogICAgICAgICAgInBvaW50ZXJjYW5jZWwiLAogICAgICAgICAgInBvaW50ZXJkb3duIiwKICAgICAgICAgICJwb2ludGVydXAiLAogICAgICAgICAgImRyYWdlbmQiLAogICAgICAgICAgImRyYWdzdGFydCIsCiAgICAgICAgICAiZHJvcCIsCiAgICAgICAgICAiY29tcG9zaXRpb25lbmQiLAogICAgICAgICAgImNvbXBvc2l0aW9uc3RhcnQiLAogICAgICAgICAgImtleWRvd24iLAogICAgICAgICAgImtleXByZXNzIiwKICAgICAgICAgICJrZXl1cCIsCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgInRleHRJbnB1dCIsCiAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGNhbWVsQ2FzZQogICAgICAgICAgImNvcHkiLAogICAgICAgICAgImN1dCIsCiAgICAgICAgICAicGFzdGUiLAogICAgICAgICAgImNsaWNrIiwKICAgICAgICAgICJjaGFuZ2UiLAogICAgICAgICAgImNvbnRleHRtZW51IiwKICAgICAgICAgICJyZXNldCIsCiAgICAgICAgICAic3VibWl0IgogICAgICAgIF07CiAgICAgICAgZnVuY3Rpb24gaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGV2ZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIGRpc2NyZXRlUmVwbGF5YWJsZUV2ZW50cy5pbmRleE9mKGV2ZW50VHlwZSkgPiAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBibG9ja2VkT24sCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSwKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncywKICAgICAgICAgICAgbmF0aXZlRXZlbnQsCiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnM6IFt0YXJnZXRDb250YWluZXJdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOiB7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5kZWxldGUocG9pbnRlcklkKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZGVsZXRlKF9wb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoZXhpc3RpbmdRdWV1ZWRFdmVudCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChleGlzdGluZ1F1ZXVlZEV2ZW50ID09PSBudWxsIHx8IGV4aXN0aW5nUXVldWVkRXZlbnQubmF0aXZlRXZlbnQgIT09IG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IGNyZWF0ZVF1ZXVlZFJlcGxheWFibGVFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMiA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoX2ZpYmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oX2ZpYmVyMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBxdWV1ZWRFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGV4aXN0aW5nUXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncyB8PSBldmVudFN5c3RlbUZsYWdzOwogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBleGlzdGluZ1F1ZXVlZEV2ZW50LnRhcmdldENvbnRhaW5lcnM7CiAgICAgICAgICBpZiAodGFyZ2V0Q29udGFpbmVyICE9PSBudWxsICYmIHRhcmdldENvbnRhaW5lcnMuaW5kZXhPZih0YXJnZXRDb250YWluZXIpID09PSAtMSkgewogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnB1c2godGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGlzdGluZ1F1ZXVlZEV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjogewogICAgICAgICAgICAgIHZhciBmb2N1c0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZEZvY3VzLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBmb2N1c0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIGRyYWdFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZERyYWcsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGRyYWdFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjogewogICAgICAgICAgICAgIHZhciBtb3VzZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZE1vdXNlLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBtb3VzZUV2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IHBvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlcnMuc2V0KHBvaW50ZXJJZCwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVycy5nZXQocG9pbnRlcklkKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBwb2ludGVyRXZlbnQpKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkMiA9IF9wb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5zZXQoX3BvaW50ZXJJZDIsIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkUG9pbnRlckNhcHR1cmVzLmdldChfcG9pbnRlcklkMikgfHwgbnVsbCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgX3BvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocXVldWVkVGFyZ2V0LnRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHF1ZXVlZFRhcmdldC5wcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgdXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSgpOwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHsKICAgICAgICAgICAgYmxvY2tlZE9uOiBudWxsLAogICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIHByaW9yaXR5OiB1cGRhdGVQcmlvcml0eQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KHVwZGF0ZVByaW9yaXR5LCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbaV0ucHJpb3JpdHkpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zcGxpY2UoaSwgMCwgcXVldWVkVGFyZ2V0KTsKICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJzID0gcXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIHdoaWxlICh0YXJnZXRDb250YWluZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcnNbMF07CiAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChxdWV1ZWRFdmVudC5kb21FdmVudE5hbWUsIHF1ZXVlZEV2ZW50LmV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgcXVldWVkRXZlbnQubmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHF1ZXVlZEV2ZW50Lm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50Q2xvbmUgPSBuZXcgbmF0aXZlRXZlbnQuY29uc3RydWN0b3IobmF0aXZlRXZlbnQudHlwZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgICAgc2V0UmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnRDbG9uZSk7CiAgICAgICAgICAgICAgICBuYXRpdmVFdmVudC50YXJnZXQuZGlzcGF0Y2hFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIHJlc2V0UmVwbGF5aW5nRXZlbnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlcjMgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKG5leHRCbG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVycy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcChxdWV1ZWRFdmVudCwga2V5LCBtYXApIHsKICAgICAgICAgIGlmIChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSkgewogICAgICAgICAgICBtYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcGxheVVuYmxvY2tlZEV2ZW50cygpIHsKICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICAgIGlmIChxdWV1ZWRGb2N1cyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEZvY3VzKSkgewogICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRHJhZyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZERyYWcpKSB7CiAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkTW91c2UpKSB7CiAgICAgICAgICAgIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2goYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudCwgdW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0KSB7CiAgICAgICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IHRydWU7CiAgICAgICAgICAgICAgU2NoZWR1bGVyLnVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2soU2NoZWR1bGVyLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5LCByZXBsYXlVbmJsb2NrZWRFdmVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldHJ5SWZCbG9ja2VkT24odW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRGlzY3JldGVFdmVudHNbMF0sIHVuYmxvY2tlZCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcXVldWVkRXZlbnQgPSBxdWV1ZWREaXNjcmV0ZUV2ZW50c1tpXTsKICAgICAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEZvY3VzLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERyYWcsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZE1vdXNlLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVuYmxvY2sgPSBmdW5jdGlvbihxdWV1ZWRFdmVudDIpIHsKICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudDIsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9OwogICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKHVuYmxvY2spOwogICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tfaV07CiAgICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBuZXh0RXhwbGljaXRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbMF07CiAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KG5leHRFeHBsaWNpdFRhcmdldCk7CiAgICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zaGlmdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgX2VuYWJsZWQgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIHNldEVuYWJsZWQoZW5hYmxlZCkgewogICAgICAgICAgX2VuYWJsZWQgPSAhIWVuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRW5hYmxlZCgpIHsKICAgICAgICAgIHJldHVybiBfZW5hYmxlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpIHsKICAgICAgICAgIHZhciBldmVudFByaW9yaXR5ID0gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpOwogICAgICAgICAgdmFyIGxpc3RlbmVyV3JhcHBlcjsKICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaERpc2NyZXRlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcldyYXBwZXIuYmluZChudWxsLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRGlzY3JldGVFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShDb250aW51b3VzRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmICghX2VuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRXaXRoRW5hYmxlQ2FwdHVyZVBoYXNlU2VsZWN0aXZlSHlkcmF0aW9uV2l0aG91dERpc2NyZXRlRXZlbnRSZXBsYXkoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgYmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgaWYgKGJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSAmJiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICB3aGlsZSAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCByZXR1cm5fdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IGJsb2NrZWRPbikgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJsb2NrZWRPbiA9IG5leHRCbG9ja2VkT247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCBudWxsLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gdGFyZ2V0SW5zdCkgewogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiY2xvc2UiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImludmFsaWQiOgogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgICAgY2FzZSAicGxheSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZG93biI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgIGNhc2UgInJhdGVjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJyZXNldCI6CiAgICAgICAgICAgIGNhc2UgInJlc2l6ZSI6CiAgICAgICAgICAgIGNhc2UgInNlZWtlZCI6CiAgICAgICAgICAgIGNhc2UgInN1Ym1pdCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hlbmQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaHN0YXJ0IjoKICAgICAgICAgICAgY2FzZSAidm9sdW1lY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAiY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25zdGFydCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb251cGRhdGUiOgogICAgICAgICAgICBjYXNlICJiZWZvcmVibHVyIjoKICAgICAgICAgICAgY2FzZSAiYWZ0ZXJibHVyIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlaW5wdXQiOgogICAgICAgICAgICBjYXNlICJibHVyIjoKICAgICAgICAgICAgY2FzZSAiZnVsbHNjcmVlbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImZvY3VzIjoKICAgICAgICAgICAgY2FzZSAiaGFzaGNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInBvcHN0YXRlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0c3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgIGNhc2UgInRvZ2dsZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgY2FzZSAibW91c2VlbnRlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbGVhdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZW50ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybGVhdmUiOgogICAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgY2FzZSAibWVzc2FnZSI6IHsKICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHkgPSBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCgpOwogICAgICAgICAgICAgIHN3aXRjaCAoc2NoZWR1bGVyUHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lciwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgewogICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIsIHBhc3NpdmUpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIHsKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIHZhciByb290MiA9IG51bGw7CiAgICAgICAgdmFyIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgcm9vdDIgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IGdldFRleHQoKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICAgIHJvb3QyID0gbnVsbDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICAgICAgaWYgKGZhbGxiYWNrVGV4dCkgewogICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgICAgdmFyIHN0YXJ0VmFsdWUgPSBzdGFydFRleHQ7CiAgICAgICAgICB2YXIgc3RhcnRMZW5ndGggPSBzdGFydFZhbHVlLmxlbmd0aDsKICAgICAgICAgIHZhciBlbmQ7CiAgICAgICAgICB2YXIgZW5kVmFsdWUgPSBnZXRUZXh0KCk7CiAgICAgICAgICB2YXIgZW5kTGVuZ3RoID0gZW5kVmFsdWUubGVuZ3RoOwogICAgICAgICAgZm9yIChzdGFydCA9IDA7IHN0YXJ0IDwgc3RhcnRMZW5ndGg7IHN0YXJ0KyspIHsKICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRdICE9PSBlbmRWYWx1ZVtzdGFydF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG1pbkVuZCA9IHN0YXJ0TGVuZ3RoIC0gc3RhcnQ7CiAgICAgICAgICBmb3IgKGVuZCA9IDE7IGVuZCA8PSBtaW5FbmQ7IGVuZCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0TGVuZ3RoIC0gZW5kXSAhPT0gZW5kVmFsdWVbZW5kTGVuZ3RoIC0gZW5kXSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2xpY2VUYWlsID0gZW5kID4gMSA/IDEgLSBlbmQgOiB2b2lkIDA7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBlbmRWYWx1ZS5zbGljZShzdGFydCwgc2xpY2VUYWlsKTsKICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRleHQoKSB7CiAgICAgICAgICBpZiAoInZhbHVlIiBpbiByb290MikgewogICAgICAgICAgICByZXR1cm4gcm9vdDIudmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcm9vdDIudGV4dENvbnRlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBjaGFyQ29kZTsKICAgICAgICAgIHZhciBrZXlDb2RlID0gbmF0aXZlRXZlbnQua2V5Q29kZTsKICAgICAgICAgIGlmICgiY2hhckNvZGUiIGluIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gbmF0aXZlRXZlbnQuY2hhckNvZGU7CiAgICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMCAmJiBrZXlDb2RlID09PSAxMykgewogICAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0ga2V5Q29kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMTApIHsKICAgICAgICAgICAgY2hhckNvZGUgPSAxMzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA+PSAzMiB8fCBjaGFyQ29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlKCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZSgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlU3ludGhldGljRXZlbnQoSW50ZXJmYWNlKSB7CiAgICAgICAgICBmdW5jdGlvbiBTeW50aGV0aWNCYXNlRXZlbnQocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMuX3JlYWN0TmFtZSA9IHJlYWN0TmFtZTsKICAgICAgICAgICAgdGhpcy5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHJlYWN0RXZlbnRUeXBlOwogICAgICAgICAgICB0aGlzLm5hdGl2ZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9wcm9wTmFtZSBpbiBJbnRlcmZhY2UpIHsKICAgICAgICAgICAgICBpZiAoIUludGVyZmFjZS5oYXNPd25Qcm9wZXJ0eShfcHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZSA9IEludGVyZmFjZVtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIGlmIChub3JtYWxpemUpIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5vcm1hbGl6ZShuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5hdGl2ZUV2ZW50W19wcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJldmVudGVkID0gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCAhPSBudWxsID8gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCA6IG5hdGl2ZUV2ZW50LnJldHVyblZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgYXNzaWduKFN5bnRoZXRpY0Jhc2VFdmVudC5wcm90b3R5cGUsIHsKICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgaWYgKCFldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5jYW5jZWxCdWJibGUgIT09ICJ1bmtub3duIikgewogICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogV2UgcmVsZWFzZSBhbGwgZGlzcGF0Y2hlZCBgU3ludGhldGljRXZlbnRgcyBhZnRlciBlYWNoIGV2ZW50IGxvb3AsIGFkZGluZwogICAgICAgICAgICAgKiB0aGVtIGJhY2sgaW50byB0aGUgcG9vbC4gVGhpcyBhbGxvd3MgYSB3YXkgdG8gaG9sZCBvbnRvIGEgcmVmZXJlbmNlIHRoYXQKICAgICAgICAgICAgICogd29uJ3QgYmUgYWRkZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcGVyc2lzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDaGVja3MgaWYgdGhpcyBldmVudCBzaG91bGQgYmUgcmVsZWFzZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgc2hvdWxkIG5vdCBiZSByZWxlYXNlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNQZXJzaXN0ZW50OiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gU3ludGhldGljQmFzZUV2ZW50OwogICAgICAgIH0KICAgICAgICB2YXIgRXZlbnRJbnRlcmZhY2UgPSB7CiAgICAgICAgICBldmVudFBoYXNlOiAwLAogICAgICAgICAgYnViYmxlczogMCwKICAgICAgICAgIGNhbmNlbGFibGU6IDAsCiAgICAgICAgICB0aW1lU3RhbXA6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBldmVudC50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiAwLAogICAgICAgICAgaXNUcnVzdGVkOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgU3ludGhldGljRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFVJRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB2aWV3OiAwLAogICAgICAgICAgZGV0YWlsOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1VJRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChVSUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WDsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICB2YXIgbGFzdE1vdXNlRXZlbnQ7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW1vdmUiKSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IGV2ZW50LnNjcmVlblggLSBsYXN0TW91c2VFdmVudC5zY3JlZW5YOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gMDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTW91c2VFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgc2NyZWVuWDogMCwKICAgICAgICAgIHNjcmVlblk6IDAsCiAgICAgICAgICBjbGllbnRYOiAwLAogICAgICAgICAgY2xpZW50WTogMCwKICAgICAgICAgIHBhZ2VYOiAwLAogICAgICAgICAgcGFnZVk6IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgYnV0dG9uOiAwLAogICAgICAgICAgYnV0dG9uczogMCwKICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC5yZWxhdGVkVGFyZ2V0ID09PSB2b2lkIDApIHJldHVybiBldmVudC5mcm9tRWxlbWVudCA9PT0gZXZlbnQuc3JjRWxlbWVudCA/IGV2ZW50LnRvRWxlbWVudCA6IGV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICByZXR1cm4gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRYIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpOwogICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRZIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY01vdXNlRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChNb3VzZUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRHJhZ0V2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkYXRhVHJhbnNmZXI6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljRHJhZ0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRHJhZ0V2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRm9jdXNFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNGb2N1c0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRm9jdXNFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgYW5pbWF0aW9uTmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNBbmltYXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBjbGlwYm9hcmREYXRhOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImNsaXBib2FyZERhdGEiIGluIGV2ZW50ID8gZXZlbnQuY2xpcGJvYXJkRGF0YSA6IHdpbmRvdy5jbGlwYm9hcmREYXRhOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNDbGlwYm9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENsaXBib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGE6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBTeW50aGV0aWNJbnB1dEV2ZW50ID0gU3ludGhldGljQ29tcG9zaXRpb25FdmVudDsKICAgICAgICB2YXIgbm9ybWFsaXplS2V5ID0gewogICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgIFNwYWNlYmFyOiAiICIsCiAgICAgICAgICBMZWZ0OiAiQXJyb3dMZWZ0IiwKICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICBSaWdodDogIkFycm93UmlnaHQiLAogICAgICAgICAgRG93bjogIkFycm93RG93biIsCiAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgV2luOiAiT1MiLAogICAgICAgICAgTWVudTogIkNvbnRleHRNZW51IiwKICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBTY3JvbGw6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgIE1velByaW50YWJsZUtleTogIlVuaWRlbnRpZmllZCIKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2xhdGVUb0tleSA9IHsKICAgICAgICAgICI4IjogIkJhY2tzcGFjZSIsCiAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgIjEyIjogIkNsZWFyIiwKICAgICAgICAgICIxMyI6ICJFbnRlciIsCiAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgIjE3IjogIkNvbnRyb2wiLAogICAgICAgICAgIjE4IjogIkFsdCIsCiAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgIjIwIjogIkNhcHNMb2NrIiwKICAgICAgICAgICIyNyI6ICJFc2NhcGUiLAogICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgIjMzIjogIlBhZ2VVcCIsCiAgICAgICAgICAiMzQiOiAiUGFnZURvd24iLAogICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAiMzYiOiAiSG9tZSIsCiAgICAgICAgICAiMzciOiAiQXJyb3dMZWZ0IiwKICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICIzOSI6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgICI0MCI6ICJBcnJvd0Rvd24iLAogICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAiNDYiOiAiRGVsZXRlIiwKICAgICAgICAgICIxMTIiOiAiRjEiLAogICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAiMTE0IjogIkYzIiwKICAgICAgICAgICIxMTUiOiAiRjQiLAogICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAiMTE3IjogIkY2IiwKICAgICAgICAgICIxMTgiOiAiRjciLAogICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAiMTIwIjogIkY5IiwKICAgICAgICAgICIxMjEiOiAiRjEwIiwKICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICIxMjMiOiAiRjEyIiwKICAgICAgICAgICIxNDQiOiAiTnVtTG9jayIsCiAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgIjIyNCI6ICJNZXRhIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5rZXkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5vcm1hbGl6ZUtleVtuYXRpdmVFdmVudC5rZXldIHx8IG5hdGl2ZUV2ZW50LmtleTsKICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5ZG93biIgfHwgbmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBtb2RpZmllcktleVRvUHJvcCA9IHsKICAgICAgICAgIEFsdDogImFsdEtleSIsCiAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICBNZXRhOiAibWV0YUtleSIsCiAgICAgICAgICBTaGlmdDogInNoaWZ0S2V5IgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW9kaWZpZXJTdGF0ZUdldHRlcihrZXlBcmcpIHsKICAgICAgICAgIHZhciBzeW50aGV0aWNFdmVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKGtleUFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5UHJvcCA9IG1vZGlmaWVyS2V5VG9Qcm9wW2tleUFyZ107CiAgICAgICAgICByZXR1cm4ga2V5UHJvcCA/ICEhbmF0aXZlRXZlbnRba2V5UHJvcF0gOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRNb2RpZmllclN0YXRlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbW9kaWZpZXJTdGF0ZUdldHRlcjsKICAgICAgICB9CiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGtleTogZ2V0RXZlbnRLZXksCiAgICAgICAgICBjb2RlOiAwLAogICAgICAgICAgbG9jYXRpb246IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgcmVwZWF0OiAwLAogICAgICAgICAgbG9jYWxlOiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgLy8gTGVnYWN5IEludGVyZmFjZQogICAgICAgICAgY2hhckNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIGtleUNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5ZG93biIgfHwgZXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIHdoaWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljS2V5Ym9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEtleWJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBQb2ludGVyRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHBvaW50ZXJJZDogMCwKICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgcHJlc3N1cmU6IDAsCiAgICAgICAgICB0YW5nZW50aWFsUHJlc3N1cmU6IDAsCiAgICAgICAgICB0aWx0WDogMCwKICAgICAgICAgIHRpbHRZOiAwLAogICAgICAgICAgdHdpc3Q6IDAsCiAgICAgICAgICBwb2ludGVyVHlwZTogMCwKICAgICAgICAgIGlzUHJpbWFyeTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNQb2ludGVyRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChQb2ludGVyRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBUb3VjaEV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB0b3VjaGVzOiAwLAogICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgIGNoYW5nZWRUb3VjaGVzOiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUb3VjaEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVG91Y2hFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHByb3BlcnR5TmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChUcmFuc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBXaGVlbEV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkZWx0YVg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFYIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWCA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVhgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAocmlnaHQgaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWCIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVggOiAwCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImRlbHRhWSIgaW4gZXZlbnQgPyBldmVudC5kZWx0YVkgOiAoCiAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFZYCBmb3IgV2Via2l0IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVkgOiAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YWAgZm9yIElFPDkgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgICAid2hlZWxEZWx0YSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YSA6IDAKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFaOiAwLAogICAgICAgICAgLy8gQnJvd3NlcnMgd2l0aG91dCAiZGVsdGFNb2RlIiBpcyByZXBvcnRpbmcgaW4gcmF3IHdoZWVsIGRlbHRhIHdoZXJlIG9uZQogICAgICAgICAgLy8gbm90Y2ggb24gdGhlIHNjcm9sbCBpcyBhbHdheXMgKy8tIDEyMCwgcm91Z2hseSBlcXVpdmFsZW50IHRvIHBpeGVscy4KICAgICAgICAgIC8vIEEgZ29vZCBhcHByb3hpbWF0aW9uIG9mIERPTV9ERUxUQV9MSU5FICgxKSBpcyA1JSBvZiB2aWV3cG9ydCBzaXplIG9yCiAgICAgICAgICAvLyB+NDAgcGl4ZWxzLCBmb3IgRE9NX0RFTFRBX1NDUkVFTiAoMikgaXQgaXMgODcuNSUgb2Ygdmlld3BvcnQgc2l6ZS4KICAgICAgICAgIGRlbHRhTW9kZTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNXaGVlbEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoV2hlZWxFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEVORF9LRVlDT0RFUyA9IFs5LCAxMywgMjcsIDMyXTsKICAgICAgICB2YXIgU1RBUlRfS0VZQ09ERSA9IDIyOTsKICAgICAgICB2YXIgY2FuVXNlQ29tcG9zaXRpb25FdmVudCA9IGNhblVzZURPTSAmJiAiQ29tcG9zaXRpb25FdmVudCIgaW4gd2luZG93OwogICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgIGlmIChjYW5Vc2VET00gJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQpIHsKICAgICAgICAgIGRvY3VtZW50TW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNhblVzZVRleHRJbnB1dEV2ZW50ID0gY2FuVXNlRE9NICYmICJUZXh0RXZlbnQiIGluIHdpbmRvdyAmJiAhZG9jdW1lbnRNb2RlOwogICAgICAgIHZhciB1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSA9IGNhblVzZURPTSAmJiAoIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgfHwgZG9jdW1lbnRNb2RlICYmIGRvY3VtZW50TW9kZSA+IDggJiYgZG9jdW1lbnRNb2RlIDw9IDExKTsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgIHZhciBTUEFDRUJBUl9DSEFSID0gU3RyaW5nLmZyb21DaGFyQ29kZShTUEFDRUJBUl9DT0RFKTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uRW5kIiwgWyJjb21wb3NpdGlvbmVuZCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblN0YXJ0IiwgWyJjb21wb3NpdGlvbnN0YXJ0IiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NwYWNlS2V5cHJlc3MgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIChuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50LmFsdEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5KSAmJiAvLyBjdHJsS2V5ICYmIGFsdEtleSBpcyBlcXVpdmFsZW50IHRvIEFsdEdyLCBhbmQgaXMgbm90IGEgY29tbWFuZC4KICAgICAgICAgICEobmF0aXZlRXZlbnQuY3RybEtleSAmJiBuYXRpdmVFdmVudC5hbHRLZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25VcGRhdGUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICByZXR1cm4gRU5EX0tFWUNPREVTLmluZGV4T2YobmF0aXZlRXZlbnQua2V5Q29kZSkgIT09IC0xOwogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQua2V5Q29kZSAhPT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gbmF0aXZlRXZlbnQuZGV0YWlsOwogICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgcmV0dXJuIGRldGFpbC5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgfQogICAgICAgIHZhciBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlOwogICAgICAgICAgdmFyIGZhbGxiYWNrRGF0YTsKICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGlmICghaXNDb21wb3NpbmcgJiYgZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvblN0YXJ0IikgewogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrRGF0YSA9IGdldERhdGEoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljQ29tcG9zaXRpb25FdmVudChldmVudFR5cGUsIGRvbUV2ZW50TmFtZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0RhdGEpIHsKICAgICAgICAgICAgICBldmVudC5kYXRhID0gZmFsbGJhY2tEYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjdXN0b21EYXRhID0gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1c3RvbURhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICB2YXIgd2hpY2ggPSBuYXRpdmVFdmVudC53aGljaDsKICAgICAgICAgICAgICBpZiAod2hpY2ggIT09IFNQQUNFQkFSX0NPREUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoYXNTcGFjZUtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjb21wb3NpdGlvbmVuZCIgfHwgIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgJiYgaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoIWlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmNoYXIgJiYgbmF0aXZlRXZlbnQuY2hhci5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXRpdmVFdmVudC53aGljaCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShuYXRpdmVFdmVudC53aGljaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSA/IG51bGwgOiBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGNoYXJzOwogICAgICAgICAgaWYgKGNhblVzZVRleHRJbnB1dEV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFjaGFycykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgIm9uQmVmb3JlSW5wdXQiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC5kYXRhID0gY2hhcnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgIGNvbG9yOiB0cnVlLAogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgImRhdGV0aW1lLWxvY2FsIjogdHJ1ZSwKICAgICAgICAgIGVtYWlsOiB0cnVlLAogICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgc2VhcmNoOiB0cnVlLAogICAgICAgICAgdGVsOiB0cnVlLAogICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRydWUsCiAgICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpc1RleHRJbnB1dEVsZW1lbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewogICAgICAgICAgICByZXR1cm4gISFzdXBwb3J0ZWRJbnB1dFR5cGVzW2VsZW0udHlwZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICBpZiAoIWNhblVzZURPTSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnROYW1lID0gIm9uIiArIGV2ZW50TmFtZVN1ZmZpeDsKICAgICAgICAgIHZhciBpc1N1cHBvcnRlZCA9IGV2ZW50TmFtZSBpbiBkb2N1bWVudDsKICAgICAgICAgIGlmICghaXNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoZXZlbnROYW1lLCAicmV0dXJuOyIpOwogICAgICAgICAgICBpc1N1cHBvcnRlZCA9IHR5cGVvZiBlbGVtZW50W2V2ZW50TmFtZV0gPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXNTdXBwb3J0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDEoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ2hhbmdlIiwgWyJjaGFuZ2UiLCAiY2xpY2siLCAiZm9jdXNpbiIsICJmb2N1c291dCIsICJpbnB1dCIsICJrZXlkb3duIiwgImtleXVwIiwgInNlbGVjdGlvbmNoYW5nZSJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGluc3QsIG5hdGl2ZUV2ZW50LCB0YXJnZXQpIHsKICAgICAgICAgIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoaW5zdCwgIm9uQ2hhbmdlIik7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvbkNoYW5nZSIsICJjaGFuZ2UiLCBudWxsLCBuYXRpdmVFdmVudCwgdGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFVzZUNoYW5nZUV2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lID09PSAic2VsZWN0IiB8fCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJmaWxlIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoUXVldWUgPSBbXTsKICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBhY3RpdmVFbGVtZW50SW5zdCwgbmF0aXZlRXZlbnQsIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSk7CiAgICAgICAgICBiYXRjaGVkVXBkYXRlcyhydW5FdmVudEluQmF0Y2gsIGRpc3BhdGNoUXVldWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBydW5FdmVudEluQmF0Y2goZGlzcGF0Y2hRdWV1ZSkgewogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgMCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCk7CiAgICAgICAgICBpZiAodXBkYXRlVmFsdWVJZkNoYW5nZWQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgaWYgKGNhblVzZURPTSkgewogICAgICAgICAgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gaXNFdmVudFN1cHBvcnRlZCgiaW5wdXQiKSAmJiAoIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPiA5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgYWN0aXZlRWxlbWVudCA9IHRhcmdldDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuYXR0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCkgewogICAgICAgICAgaWYgKCFhY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuZGV0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlUHJvcGVydHlDaGFuZ2UobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5wcm9wZXJ0eU5hbWUgIT09ICJ2YWx1ZSIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldEluc3RJZlZhbHVlQ2hhbmdlZChhY3RpdmVFbGVtZW50SW5zdCkpIHsKICAgICAgICAgICAgbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3VzaW4iKSB7CiAgICAgICAgICAgIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCk7CiAgICAgICAgICAgIHN0YXJ0V2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSh0YXJnZXQsIHRhcmdldEluc3QpOwogICAgICAgICAgfSBlbHNlIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJzZWxlY3Rpb25jaGFuZ2UiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleXVwIiB8fCBkb21FdmVudE5hbWUgPT09ICJrZXlkb3duIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2xpY2tFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gImNoZWNrYm94IiB8fCBlbGVtLnR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2xpY2tFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjbGljayIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0T3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJpbnB1dCIgfHwgZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVDb250cm9sbGVkSW5wdXRCbHVyKG5vZGUpIHsKICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZTsKICAgICAgICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmNvbnRyb2xsZWQgfHwgbm9kZS50eXBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCAibnVtYmVyIiwgbm9kZS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgdmFyIGdldFRhcmdldEluc3RGdW5jLCBoYW5kbGVFdmVudEZ1bmM7CiAgICAgICAgICBpZiAoc2hvdWxkVXNlQ2hhbmdlRXZlbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBpZiAoaXNJbnB1dEV2ZW50U3VwcG9ydGVkKSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMgPSBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkVXNlQ2xpY2tFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldFRhcmdldEluc3RGdW5jKSB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gZ2V0VGFyZ2V0SW5zdEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYW5kbGVFdmVudEZ1bmMpIHsKICAgICAgICAgICAgaGFuZGxlRXZlbnRGdW5jKGRvbUV2ZW50TmFtZSwgdGFyZ2V0Tm9kZSwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNvdXQiKSB7CiAgICAgICAgICAgIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIodGFyZ2V0Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDIoKSB7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvbk1vdXNlRW50ZXIiLCBbIm1vdXNlb3V0IiwgIm1vdXNlb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VMZWF2ZSIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Qb2ludGVyRW50ZXIiLCBbInBvaW50ZXJvdXQiLCAicG9pbnRlcm92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJMZWF2ZSIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBpc092ZXJFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3ZlciIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiOwogICAgICAgICAgdmFyIGlzT3V0RXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCI7CiAgICAgICAgICBpZiAoaXNPdmVyRXZlbnQgJiYgIWlzUmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIHZhciByZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgaWYgKHJlbGF0ZWQpIHsKICAgICAgICAgICAgICBpZiAoZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocmVsYXRlZCkgfHwgaXNDb250YWluZXJNYXJrZWRBc1Jvb3QocmVsYXRlZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNPdXRFdmVudCAmJiAhaXNPdmVyRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdpbjsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudFRhcmdldC53aW5kb3cgPT09IG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHdpbiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGRvYyA9IG5hdGl2ZUV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChkb2MpIHsKICAgICAgICAgICAgICB3aW4gPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aW4gPSB3aW5kb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tOwogICAgICAgICAgdmFyIHRvOwogICAgICAgICAgaWYgKGlzT3V0RXZlbnQpIHsKICAgICAgICAgICAgdmFyIF9yZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC50b0VsZW1lbnQ7CiAgICAgICAgICAgIGZyb20gPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0byA9IF9yZWxhdGVkID8gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoX3JlbGF0ZWQpIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0byk7CiAgICAgICAgICAgICAgaWYgKHRvICE9PSBuZWFyZXN0TW91bnRlZCB8fCB0by50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgdG8udGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgdG8gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbSA9IG51bGw7CiAgICAgICAgICAgIHRvID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcm9tID09PSB0bykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgIHZhciBsZWF2ZUV2ZW50VHlwZSA9ICJvbk1vdXNlTGVhdmUiOwogICAgICAgICAgdmFyIGVudGVyRXZlbnRUeXBlID0gIm9uTW91c2VFbnRlciI7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlUHJlZml4ID0gIm1vdXNlIjsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciIpIHsKICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICBsZWF2ZUV2ZW50VHlwZSA9ICJvblBvaW50ZXJMZWF2ZSI7CiAgICAgICAgICAgIGVudGVyRXZlbnRUeXBlID0gIm9uUG9pbnRlckVudGVyIjsKICAgICAgICAgICAgZXZlbnRUeXBlUHJlZml4ID0gInBvaW50ZXIiOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb21Ob2RlID0gZnJvbSA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZShmcm9tKTsKICAgICAgICAgIHZhciB0b05vZGUgPSB0byA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZSh0byk7CiAgICAgICAgICB2YXIgbGVhdmUgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGxlYXZlRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAibGVhdmUiLCBmcm9tLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgbGVhdmUudGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICBsZWF2ZS5yZWxhdGVkVGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVUYXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG5hdGl2ZVRhcmdldEluc3QgPT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bywgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZW50ZXJFdmVudC50YXJnZXQgPSB0b05vZGU7CiAgICAgICAgICAgIGVudGVyRXZlbnQucmVsYXRlZFRhcmdldCA9IGZyb21Ob2RlOwogICAgICAgICAgICBlbnRlciA9IGVudGVyRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlLCBlbnRlciwgZnJvbSwgdG8pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpcyh4LCB5KSB7CiAgICAgICAgICByZXR1cm4geCA9PT0geSAmJiAoeCAhPT0gMCB8fCAxIC8geCA9PT0gMSAvIHkpIHx8IHggIT09IHggJiYgeSAhPT0geTsKICAgICAgICB9CiAgICAgICAgdmFyIG9iamVjdElzID0gdHlwZW9mIE9iamVjdC5pcyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5pcyA6IGlzOwogICAgICAgIGZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgICAgICAgICBpZiAob2JqZWN0SXMob2JqQSwgb2JqQikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIG9iakEgIT09ICJvYmplY3QiIHx8IG9iakEgPT09IG51bGwgfHwgdHlwZW9mIG9iakIgIT09ICJvYmplY3QiIHx8IG9iakIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICAgICAgICAgIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50S2V5ID0ga2V5c0FbaV07CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBjdXJyZW50S2V5KSB8fCAhb2JqZWN0SXMob2JqQVtjdXJyZW50S2V5XSwgb2JqQltjdXJyZW50S2V5XSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMZWFmTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTaWJsaW5nTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQocm9vdDMsIG9mZnNldCkgewogICAgICAgICAgdmFyIG5vZGUgPSBnZXRMZWFmTm9kZShyb290Myk7CiAgICAgICAgICB2YXIgbm9kZVN0YXJ0ID0gMDsKICAgICAgICAgIHZhciBub2RlRW5kID0gMDsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBub2RlRW5kID0gbm9kZVN0YXJ0ICsgbm9kZS50ZXh0Q29udGVudC5sZW5ndGg7CiAgICAgICAgICAgICAgaWYgKG5vZGVTdGFydCA8PSBvZmZzZXQgJiYgbm9kZUVuZCA+PSBvZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIG5vZGUsCiAgICAgICAgICAgICAgICAgIG9mZnNldDogb2Zmc2V0IC0gbm9kZVN0YXJ0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlU3RhcnQgPSBub2RlRW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBnZXRMZWFmTm9kZShnZXRTaWJsaW5nTm9kZShub2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE9mZnNldHMob3V0ZXJOb2RlKSB7CiAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IG91dGVyTm9kZS5vd25lckRvY3VtZW50OwogICAgICAgICAgdmFyIHdpbiA9IG93bmVyRG9jdW1lbnQgJiYgb3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbiAmJiB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbiB8fCBzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhbmNob3JOb2RlID0gc2VsZWN0aW9uLmFuY2hvck5vZGUsIGFuY2hvck9mZnNldCA9IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsIGZvY3VzTm9kZSA9IHNlbGVjdGlvbi5mb2N1c05vZGUsIGZvY3VzT2Zmc2V0ID0gc2VsZWN0aW9uLmZvY3VzT2Zmc2V0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5jaG9yTm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgZm9jdXNOb2RlLm5vZGVUeXBlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRNb2Rlcm5PZmZzZXRzRnJvbVBvaW50cyhvdXRlck5vZGUsIGFuY2hvck5vZGUsIGFuY2hvck9mZnNldCwgZm9jdXNOb2RlLCBmb2N1c09mZnNldCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBzdGFydCA9IC0xOwogICAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluQW5jaG9yID0gMDsKICAgICAgICAgIHZhciBpbmRleFdpdGhpbkZvY3VzID0gMDsKICAgICAgICAgIHZhciBub2RlID0gb3V0ZXJOb2RlOwogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBudWxsOwogICAgICAgICAgb3V0ZXI6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBuZXh0ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gYW5jaG9yTm9kZSAmJiAoYW5jaG9yT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbGVuZ3RoICsgYW5jaG9yT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZm9jdXNOb2RlICYmIChmb2N1c09mZnNldCA9PT0gMCB8fCBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpKSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGggKyBmb2N1c09mZnNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgICAgbGVuZ3RoICs9IG5vZGUubm9kZVZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChuZXh0ID0gbm9kZS5maXJzdENoaWxkKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG91dGVyTm9kZSkgewogICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBhbmNob3JOb2RlICYmICsraW5kZXhXaXRoaW5BbmNob3IgPT09IGFuY2hvck9mZnNldCkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBmb2N1c05vZGUgJiYgKytpbmRleFdpdGhpbkZvY3VzID09PSBmb2N1c09mZnNldCkgewogICAgICAgICAgICAgICAgZW5kID0gbGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLm5leHRTaWJsaW5nKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xIHx8IGVuZCA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgZW5kCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRPZmZzZXRzKG5vZGUsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBkb2MgPSBub2RlLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gZG9jICYmIGRvYy5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICBpZiAoIXdpbi5nZXRTZWxlY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIHZhciBsZW5ndGggPSBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgIHZhciBzdGFydCA9IE1hdGgubWluKG9mZnNldHMuc3RhcnQsIGxlbmd0aCk7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQgPT09IHZvaWQgMCA/IHN0YXJ0IDogTWF0aC5taW4ob2Zmc2V0cy5lbmQsIGxlbmd0aCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbi5leHRlbmQgJiYgc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgdmFyIHRlbXAgPSBlbmQ7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgICBzdGFydCA9IHRlbXA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIHN0YXJ0KTsKICAgICAgICAgIHZhciBlbmRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIGVuZCk7CiAgICAgICAgICBpZiAoc3RhcnRNYXJrZXIgJiYgZW5kTWFya2VyKSB7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMSAmJiBzZWxlY3Rpb24uYW5jaG9yTm9kZSA9PT0gc3RhcnRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uYW5jaG9yT2Zmc2V0ID09PSBzdGFydE1hcmtlci5vZmZzZXQgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZSA9PT0gZW5kTWFya2VyLm5vZGUgJiYgc2VsZWN0aW9uLmZvY3VzT2Zmc2V0ID09PSBlbmRNYXJrZXIub2Zmc2V0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByYW5nZSA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICByYW5nZS5zZXRTdGFydChzdGFydE1hcmtlci5ub2RlLCBzdGFydE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgICAgICAgIGlmIChzdGFydCA+IGVuZCkgewogICAgICAgICAgICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZSk7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmV4dGVuZChlbmRNYXJrZXIubm9kZSwgZW5kTWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUpIHsKICAgICAgICAgIGlmICghb3V0ZXJOb2RlIHx8ICFpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUgPT09IGlubmVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShvdXRlck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShpbm5lck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCJjb250YWlucyIgaW4gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBvdXRlck5vZGUuY29udGFpbnMoaW5uZXJOb2RlKTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiAhIShvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24oaW5uZXJOb2RlKSAmIDE2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbkRvY3VtZW50KG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUub3duZXJEb2N1bWVudCAmJiBjb250YWluc05vZGUobm9kZS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgbm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbkZyYW1lKGlmcmFtZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBpZnJhbWUuY29udGVudFdpbmRvdy5sb2NhdGlvbi5ocmVmID09PSAic3RyaW5nIjsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnREZWVwKCkgewogICAgICAgICAgdmFyIHdpbiA9IHdpbmRvdzsKICAgICAgICAgIHZhciBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCgpOwogICAgICAgICAgd2hpbGUgKGVsZW1lbnQgaW5zdGFuY2VvZiB3aW4uSFRNTElGcmFtZUVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGlzU2FtZU9yaWdpbkZyYW1lKGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgd2luID0gZWxlbWVudC5jb250ZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KHdpbi5kb2N1bWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0gJiYgZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgKG5vZGVOYW1lID09PSAiaW5wdXQiICYmIChlbGVtLnR5cGUgPT09ICJ0ZXh0IiB8fCBlbGVtLnR5cGUgPT09ICJzZWFyY2giIHx8IGVsZW0udHlwZSA9PT0gInRlbCIgfHwgZWxlbS50eXBlID09PSAidXJsIiB8fCBlbGVtLnR5cGUgPT09ICJwYXNzd29yZCIpIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiIHx8IGVsZW0uY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb25JbmZvcm1hdGlvbigpIHsKICAgICAgICAgIHZhciBmb2N1c2VkRWxlbSA9IGdldEFjdGl2ZUVsZW1lbnREZWVwKCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBmb2N1c2VkRWxlbSwKICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2U6IGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhmb2N1c2VkRWxlbSkgPyBnZXRTZWxlY3Rpb24oZm9jdXNlZEVsZW0pIDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVNlbGVjdGlvbihwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uKSB7CiAgICAgICAgICB2YXIgY3VyRm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgdmFyIHByaW9yRm9jdXNlZEVsZW0gPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLmZvY3VzZWRFbGVtOwogICAgICAgICAgdmFyIHByaW9yU2VsZWN0aW9uUmFuZ2UgPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLnNlbGVjdGlvblJhbmdlOwogICAgICAgICAgaWYgKGN1ckZvY3VzZWRFbGVtICE9PSBwcmlvckZvY3VzZWRFbGVtICYmIGlzSW5Eb2N1bWVudChwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICBpZiAocHJpb3JTZWxlY3Rpb25SYW5nZSAhPT0gbnVsbCAmJiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgICBzZXRTZWxlY3Rpb24ocHJpb3JGb2N1c2VkRWxlbSwgcHJpb3JTZWxlY3Rpb25SYW5nZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9ycyA9IFtdOwogICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSBwcmlvckZvY3VzZWRFbGVtOwogICAgICAgICAgICB3aGlsZSAoYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgZWxlbWVudDogYW5jZXN0b3IsCiAgICAgICAgICAgICAgICAgIGxlZnQ6IGFuY2VzdG9yLnNjcm9sbExlZnQsCiAgICAgICAgICAgICAgICAgIHRvcDogYW5jZXN0b3Iuc2Nyb2xsVG9wCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmlvckZvY3VzZWRFbGVtLmZvY3VzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW5jZXN0b3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGluZm8yID0gYW5jZXN0b3JzW2ldOwogICAgICAgICAgICAgIGluZm8yLmVsZW1lbnQuc2Nyb2xsTGVmdCA9IGluZm8yLmxlZnQ7CiAgICAgICAgICAgICAgaW5mbzIuZWxlbWVudC5zY3JvbGxUb3AgPSBpbmZvMi50b3A7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uKGlucHV0KSB7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uOwogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gewogICAgICAgICAgICAgIHN0YXJ0OiBpbnB1dC5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBlbmQ6IGlucHV0LnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gZ2V0T2Zmc2V0cyhpbnB1dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2VsZWN0aW9uIHx8IHsKICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgIGVuZDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uKGlucHV0LCBvZmZzZXRzKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSBvZmZzZXRzLnN0YXJ0OwogICAgICAgICAgdmFyIGVuZCA9IG9mZnNldHMuZW5kOwogICAgICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uRW5kID0gTWF0aC5taW4oZW5kLCBpbnB1dC52YWx1ZS5sZW5ndGgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0T2Zmc2V0cyhpbnB1dCwgb2Zmc2V0cyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBjYW5Vc2VET00gJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uU2VsZWN0IiwgWyJmb2N1c291dCIsICJjb250ZXh0bWVudSIsICJkcmFnZW5kIiwgImZvY3VzaW4iLCAia2V5ZG93biIsICJrZXl1cCIsICJtb3VzZWRvd24iLCAibW91c2V1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbiQxKG5vZGUpIHsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGFuY2hvck5vZGU6IHNlbGVjdGlvbi5hbmNob3JOb2RlLAogICAgICAgICAgICAgIGFuY2hvck9mZnNldDogc2VsZWN0aW9uLmFuY2hvck9mZnNldCwKICAgICAgICAgICAgICBmb2N1c05vZGU6IHNlbGVjdGlvbi5mb2N1c05vZGUsCiAgICAgICAgICAgICAgZm9jdXNPZmZzZXQ6IHNlbGVjdGlvbi5mb2N1c09mZnNldAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldERvY3VtZW50KGV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG1vdXNlRG93biB8fCBhY3RpdmVFbGVtZW50JDEgPT0gbnVsbCB8fCBhY3RpdmVFbGVtZW50JDEgIT09IGdldEFjdGl2ZUVsZW1lbnQoZG9jKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbiQxKGFjdGl2ZUVsZW1lbnQkMSk7CiAgICAgICAgICBpZiAoIWxhc3RTZWxlY3Rpb24gfHwgIXNoYWxsb3dFcXVhbChsYXN0U2VsZWN0aW9uLCBjdXJyZW50U2VsZWN0aW9uKSkgewogICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyhhY3RpdmVFbGVtZW50SW5zdCQxLCAib25TZWxlY3QiKTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvblNlbGVjdCIsICJzZWxlY3QiLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGFjdGl2ZUVsZW1lbnQkMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSB0YXJnZXRJbnN0ID8gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KSA6IHdpbmRvdzsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIGlmIChpc1RleHRJbnB1dEVsZW1lbnQodGFyZ2V0Tm9kZSkgfHwgdGFyZ2V0Tm9kZS5jb250ZW50RWRpdGFibGUgPT09ICJ0cnVlIikgewogICAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gdGFyZ2V0Tm9kZTsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gbnVsbDsKICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICAgIGlmIChza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYWtlUHJlZml4TWFwKHN0eWxlUHJvcCwgZXZlbnROYW1lKSB7CiAgICAgICAgICB2YXIgcHJlZml4ZXMyID0ge307CiAgICAgICAgICBwcmVmaXhlczJbc3R5bGVQcm9wLnRvTG93ZXJDYXNlKCldID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBwcmVmaXhlczJbIldlYmtpdCIgKyBzdHlsZVByb3BdID0gIndlYmtpdCIgKyBldmVudE5hbWU7CiAgICAgICAgICBwcmVmaXhlczJbIk1veiIgKyBzdHlsZVByb3BdID0gIm1veiIgKyBldmVudE5hbWU7CiAgICAgICAgICByZXR1cm4gcHJlZml4ZXMyOwogICAgICAgIH0KICAgICAgICB2YXIgdmVuZG9yUHJlZml4ZXMgPSB7CiAgICAgICAgICBhbmltYXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25FbmQiKSwKICAgICAgICAgIGFuaW1hdGlvbml0ZXJhdGlvbjogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvbkl0ZXJhdGlvbiIpLAogICAgICAgICAgYW5pbWF0aW9uc3RhcnQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25TdGFydCIpLAogICAgICAgICAgdHJhbnNpdGlvbmVuZDogbWFrZVByZWZpeE1hcCgiVHJhbnNpdGlvbiIsICJUcmFuc2l0aW9uRW5kIikKICAgICAgICB9OwogICAgICAgIHZhciBwcmVmaXhlZEV2ZW50TmFtZXMgPSB7fTsKICAgICAgICB2YXIgc3R5bGUgPSB7fTsKICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlOwogICAgICAgICAgaWYgKCEoIkFuaW1hdGlvbkV2ZW50IiBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25lbmQuYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uaXRlcmF0aW9uLmFuaW1hdGlvbjsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbnN0YXJ0LmFuaW1hdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKCJUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLnRyYW5zaXRpb25lbmQudHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoZXZlbnROYW1lKSB7CiAgICAgICAgICBpZiAocHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdOwogICAgICAgICAgfSBlbHNlIGlmICghdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZWZpeE1hcCA9IHZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV07CiAgICAgICAgICBmb3IgKHZhciBzdHlsZVByb3AgaW4gcHJlZml4TWFwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXhNYXAuaGFzT3duUHJvcGVydHkoc3R5bGVQcm9wKSAmJiBzdHlsZVByb3AgaW4gc3R5bGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0gPSBwcmVmaXhNYXBbc3R5bGVQcm9wXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTsKICAgICAgICB9CiAgICAgICAgdmFyIEFOSU1BVElPTl9FTkQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uZW5kIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9JVEVSQVRJT04gPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uaXRlcmF0aW9uIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9TVEFSVCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25zdGFydCIpOwogICAgICAgIHZhciBUUkFOU0lUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJ0cmFuc2l0aW9uZW5kIik7CiAgICAgICAgdmFyIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB2YXIgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMgPSBbImFib3J0IiwgImF1eENsaWNrIiwgImNhbmNlbCIsICJjYW5QbGF5IiwgImNhblBsYXlUaHJvdWdoIiwgImNsaWNrIiwgImNsb3NlIiwgImNvbnRleHRNZW51IiwgImNvcHkiLCAiY3V0IiwgImRyYWciLCAiZHJhZ0VuZCIsICJkcmFnRW50ZXIiLCAiZHJhZ0V4aXQiLCAiZHJhZ0xlYXZlIiwgImRyYWdPdmVyIiwgImRyYWdTdGFydCIsICJkcm9wIiwgImR1cmF0aW9uQ2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImdvdFBvaW50ZXJDYXB0dXJlIiwgImlucHV0IiwgImludmFsaWQiLCAia2V5RG93biIsICJrZXlQcmVzcyIsICJrZXlVcCIsICJsb2FkIiwgImxvYWRlZERhdGEiLCAibG9hZGVkTWV0YWRhdGEiLCAibG9hZFN0YXJ0IiwgImxvc3RQb2ludGVyQ2FwdHVyZSIsICJtb3VzZURvd24iLCAibW91c2VNb3ZlIiwgIm1vdXNlT3V0IiwgIm1vdXNlT3ZlciIsICJtb3VzZVVwIiwgInBhc3RlIiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwb2ludGVyQ2FuY2VsIiwgInBvaW50ZXJEb3duIiwgInBvaW50ZXJNb3ZlIiwgInBvaW50ZXJPdXQiLCAicG9pbnRlck92ZXIiLCAicG9pbnRlclVwIiwgInByb2dyZXNzIiwgInJhdGVDaGFuZ2UiLCAicmVzZXQiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VibWl0IiwgInN1c3BlbmQiLCAidGltZVVwZGF0ZSIsICJ0b3VjaENhbmNlbCIsICJ0b3VjaEVuZCIsICJ0b3VjaFN0YXJ0IiwgInZvbHVtZUNoYW5nZSIsICJzY3JvbGwiLCAidG9nZ2xlIiwgInRvdWNoTW92ZSIsICJ3YWl0aW5nIiwgIndoZWVsIl07CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSkgewogICAgICAgICAgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuc2V0KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWFjdE5hbWUsIFtkb21FdmVudE5hbWVdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudHMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBzaW1wbGVFdmVudFBsdWdpbkV2ZW50c1tpXTsKICAgICAgICAgICAgdmFyIGRvbUV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2YXIgY2FwaXRhbGl6ZWRFdmVudCA9IGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZXZlbnROYW1lLnNsaWNlKDEpOwogICAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgIm9uIiArIGNhcGl0YWxpemVkRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fRU5ELCAib25BbmltYXRpb25FbmQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX0lURVJBVElPTiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9TVEFSVCwgIm9uQW5pbWF0aW9uU3RhcnQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImRibGNsaWNrIiwgIm9uRG91YmxlQ2xpY2siKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3VzaW4iLCAib25Gb2N1cyIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNvdXQiLCAib25CbHVyIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KFRSQU5TSVRJT05fRU5ELCAib25UcmFuc2l0aW9uRW5kIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgcmVhY3ROYW1lID0gdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuZ2V0KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICBpZiAocmVhY3ROYW1lID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0V2ZW50OwogICAgICAgICAgdmFyIHJlYWN0RXZlbnRUeXBlID0gZG9tRXZlbnROYW1lOwogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIGlmIChnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNLZXlib2FyZEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJmb2N1cyI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImJsdXIiOwogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuYnV0dG9uID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0RyYWdFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RvdWNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0VORDoKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fSVRFUkFUSU9OOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9TVEFSVDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNBbmltYXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUUkFOU0lUSU9OX0VORDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVUlFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1doZWVsRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljQ2xpcGJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY2N1bXVsYXRlVGFyZ2V0T25seSA9ICFpbkNhcHR1cmVQaGFzZSAmJiAvLyBUT0RPOiBpZGVhbGx5LCB3ZSdkIGV2ZW50dWFsbHkgYWRkIGFsbCBldmVudHMgZnJvbQogICAgICAgICAgICAvLyBub25EZWxlZ2F0ZWRFdmVudHMgbGlzdCBpbiBET01QbHVnaW5FdmVudFN5c3RlbS4KICAgICAgICAgICAgLy8gVGhlbiB3ZSBjYW4gcmVtb3ZlIHRoaXMgc3BlY2lhbCBsaXN0LgogICAgICAgICAgICAvLyBUaGlzIGlzIGEgYnJlYWtpbmcgY2hhbmdlIHRoYXQgY2FuIHdhaXQgdW50aWwgUmVhY3QgMTguCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSA9PT0gInNjcm9sbCI7CiAgICAgICAgICAgIHZhciBfbGlzdGVuZXJzID0gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnQudHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5KTsKICAgICAgICAgICAgaWYgKF9saXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBfZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50OiBfZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IF9saXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50cygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDIoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQxKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzKCk7CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB2YXIgc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucyA9IChldmVudFN5c3RlbUZsYWdzICYgU0hPVUxEX05PVF9QUk9DRVNTX1BPTFlGSUxMX0VWRU5UX1BMVUdJTlMpID09PSAwOwogICAgICAgICAgaWYgKHNob3VsZFByb2Nlc3NQb2x5ZmlsbFBsdWdpbnMpIHsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBtZWRpYUV2ZW50VHlwZXMgPSBbImFib3J0IiwgImNhbnBsYXkiLCAiY2FucGxheXRocm91Z2giLCAiZHVyYXRpb25jaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAibG9hZGVkZGF0YSIsICJsb2FkZWRtZXRhZGF0YSIsICJsb2Fkc3RhcnQiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInByb2dyZXNzIiwgInJhdGVjaGFuZ2UiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VzcGVuZCIsICJ0aW1ldXBkYXRlIiwgInZvbHVtZWNoYW5nZSIsICJ3YWl0aW5nIl07CiAgICAgICAgdmFyIG5vbkRlbGVnYXRlZEV2ZW50cyA9IG5ldyBTZXQoWyJjYW5jZWwiLCAiY2xvc2UiLCAiaW52YWxpZCIsICJsb2FkIiwgInNjcm9sbCIsICJ0b2dnbGUiXS5jb25jYXQobWVkaWFFdmVudFR5cGVzKSk7CiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lciwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0OwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyLCB2b2lkIDAsIGV2ZW50KTsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZUl0ZW1zSW5PcmRlcihldmVudCwgZGlzcGF0Y2hMaXN0ZW5lcnMsIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNJbnN0YW5jZTsKICAgICAgICAgIGlmIChpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICB2YXIgX2Rpc3BhdGNoTGlzdGVuZXJzJGkgPSBkaXNwYXRjaExpc3RlbmVyc1tpXSwgaW5zdGFuY2UgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5pbnN0YW5jZSwgY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmN1cnJlbnRUYXJnZXQsIGxpc3RlbmVyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBwcmV2aW91c0luc3RhbmNlICYmIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lciwgY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgX2xpc3RlbmVyLCBfY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IF9pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaFF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGxpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgpIGNhbGwgZm9yICIlcyIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0S2V5ID0gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgIGlmICghbGlzdGVuZXJTZXQuaGFzKGxpc3RlbmVyU2V0S2V5KSkgewogICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBsaXN0ZW5lclNldC5hZGQobGlzdGVuZXJTZXRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgdGFyZ2V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCkgY2FsbCBmb3IgIiVzIiBpbiB0aGUgYnViYmxlIHBoYXNlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRTeXN0ZW1GbGFncyA9IDA7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ZW5pbmdNYXJrZXIgPSAiX3JlYWN0TGlzdGVuaW5nIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZmFsc2UsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCB0cnVlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIGZhbHNlLCBvd25lckRvY3VtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIGlzRGVmZXJyZWRMaXN0ZW5lckZvckxlZ2FjeUZCU3VwcG9ydCkgewogICAgICAgICAgdmFyIGxpc3RlbmVyID0gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgdmFyIGlzUGFzc2l2ZUxpc3RlbmVyID0gdm9pZCAwOwogICAgICAgICAgaWYgKHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJ0b3VjaHN0YXJ0IiB8fCBkb21FdmVudE5hbWUgPT09ICJ0b3VjaG1vdmUiIHx8IGRvbUV2ZW50TmFtZSA9PT0gIndoZWVsIikgewogICAgICAgICAgICAgIGlzUGFzc2l2ZUxpc3RlbmVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgdmFyIHVuc3Vic2NyaWJlTGlzdGVuZXI7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBpZiAoaXNQYXNzaXZlTGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBncmFuZENvbnRhaW5lciA9PT0gdGFyZ2V0Q29udGFpbmVyIHx8IGdyYW5kQ29udGFpbmVyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgJiYgZ3JhbmRDb250YWluZXIucGFyZW50Tm9kZSA9PT0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgYW5jZXN0b3JJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGlmICgoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFKSA9PT0gMCAmJiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX05PTl9ERUxFR0FURUQpID09PSAwKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJOb2RlID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICBtYWluTG9vcDogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBub2RlVGFnID0gbm9kZS50YWc7CiAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFJvb3QgfHwgbm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihjb250YWluZXIyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kTm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChncmFuZE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZFRhZyA9IGdyYW5kTm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRUYWcgPT09IEhvc3RSb290IHx8IGdyYW5kVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZENvbnRhaW5lciA9IGdyYW5kTm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZ3JhbmROb2RlID0gZ3JhbmROb2RlLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvbnRhaW5lcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUYWcgPSBwYXJlbnROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHBhcmVudFRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBhbmNlc3Rvckluc3QgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWUgbWFpbkxvb3A7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcjIgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hFdmVudHNGb3JQbHVnaW5zKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIGFuY2VzdG9ySW5zdCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgbGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICBsaXN0ZW5lciwKICAgICAgICAgICAgY3VycmVudFRhcmdldAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUsIG5hdGl2ZUV2ZW50VHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5LCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICE9PSBudWxsID8gcmVhY3ROYW1lICsgIkNhcHR1cmUiIDogbnVsbDsKICAgICAgICAgIHZhciByZWFjdEV2ZW50TmFtZSA9IGluQ2FwdHVyZVBoYXNlID8gY2FwdHVyZU5hbWUgOiByZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHZhciBsYXN0SG9zdENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMi5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTIudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RIb3N0Q29tcG9uZW50ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChyZWFjdEV2ZW50TmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0RXZlbnROYW1lKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGxpc3RlbmVyLCBsYXN0SG9zdENvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWNjdW11bGF0ZVRhcmdldE9ubHkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgKyAiQ2FwdHVyZSI7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMyA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UzLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMy50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJ1YmJsZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50KGluc3QpIHsKICAgICAgICAgIGlmIChpbnN0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZG8gewogICAgICAgICAgICBpbnN0ID0gaW5zdC5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlIChpbnN0ICYmIGluc3QudGFnICE9PSBIb3N0Q29tcG9uZW50KTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGluc3RBLCBpbnN0QikgewogICAgICAgICAgdmFyIG5vZGVBID0gaW5zdEE7CiAgICAgICAgICB2YXIgbm9kZUIgPSBpbnN0QjsKICAgICAgICAgIHZhciBkZXB0aEEgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEEgPSBub2RlQTsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgICBkZXB0aEErKzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZXB0aEIgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEIgPSBub2RlQjsgdGVtcEI7IHRlbXBCID0gZ2V0UGFyZW50KHRlbXBCKSkgewogICAgICAgICAgICBkZXB0aEIrKzsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEEgLSBkZXB0aEIgPiAwKSB7CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgZGVwdGhBLS07CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZGVwdGhCIC0gZGVwdGhBID4gMCkgewogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICAgIGRlcHRoQi0tOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoID0gZGVwdGhBOwogICAgICAgICAgd2hpbGUgKGRlcHRoLS0pIHsKICAgICAgICAgICAgaWYgKG5vZGVBID09PSBub2RlQiB8fCBub2RlQiAhPT0gbnVsbCAmJiBub2RlQSA9PT0gbm9kZUIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVBOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZXZlbnQsIHRhcmdldCwgY29tbW9uLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBldmVudC5fcmVhY3ROYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0OwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBpbnN0YW5jZSwgYWx0ZXJuYXRlID0gX2luc3RhbmNlNC5hbHRlcm5hdGUsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTQuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2U0LnRhZzsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUgPT09IGNvbW1vbikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBidWJibGVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGVudGVyRXZlbnQsIGZyb20sIHRvKSB7CiAgICAgICAgICB2YXIgY29tbW9uID0gZnJvbSAmJiB0byA/IGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGZyb20sIHRvKSA6IG51bGw7CiAgICAgICAgICBpZiAoZnJvbSAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20sIGNvbW1vbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRvICE9PSBudWxsICYmIGVudGVyRXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBlbnRlckV2ZW50LCB0bywgY29tbW9uLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lICsgIl9fIiArIChjYXB0dXJlID8gImNhcHR1cmUiIDogImJ1YmJsZSIpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgPSAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiOwogICAgICAgIHZhciBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgPSAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIjsKICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgQVVUT0ZPQ1VTID0gImF1dG9Gb2N1cyI7CiAgICAgICAgdmFyIENISUxEUkVOID0gImNoaWxkcmVuIjsKICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgIHZhciBIVE1MJDEgPSAiX19odG1sIjsKICAgICAgICB2YXIgd2FybmVkVW5rbm93blRhZ3M7CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgdmFyIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZTsKICAgICAgICB2YXIgd2FybkZvckV4dHJhQXR0cmlidXRlczsKICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgIHZhciBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nOwogICAgICAgIHZhciBub3JtYWxpemVIVE1MOwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzID0gewogICAgICAgICAgICAvLyBUaGVyZSBhcmUgd29ya2luZyBwb2x5ZmlsbHMgZm9yIDxkaWFsb2c+LiBMZXQgcGVvcGxlIHVzZSBpdC4KICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAvLyBFbGVjdHJvbiBzaGlwcyBhIGN1c3RvbSA8d2Vidmlldz4gdGFnIHRvIGRpc3BsYXkgZXh0ZXJuYWwgd2ViIGNvbnRlbnQgaW4KICAgICAgICAgICAgLy8gYW4gaXNvbGF0ZWQgZnJhbWUgYW5kIHByb2Nlc3MuCiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAvLyBpcyBvZnRlbiB1c2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgogICAgICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvd2Vidmlldy10YWcKICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQgPSBmdW5jdGlvbih0eXBlLCBwcm9wcykgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCB7CiAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00gJiYgIWRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKHByb3BOYW1lLCBzZXJ2ZXJWYWx1ZSwgY2xpZW50VmFsdWUpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VmFsdWUgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VmFsdWUpOwogICAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKHNlcnZlclZhbHVlKTsKICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9PT0gbm9ybWFsaXplZENsaWVudFZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIlByb3AgYCVzYCBkaWQgbm90IG1hdGNoLiBTZXJ2ZXI6ICVzIENsaWVudDogJXMiLCBwcm9wTmFtZSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZFNlcnZlclZhbHVlKSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZENsaWVudFZhbHVlKSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckV4dHJhQXR0cmlidXRlcyA9IGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWVzKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXJyb3IoIkV4dHJhIGF0dHJpYnV0ZXMgZnJvbSB0aGUgc2VydmVyOiAlcyIsIG5hbWVzKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihyZWdpc3RyYXRpb25OYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICBpZiAobGlzdGVuZXIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYGZhbHNlYC5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCVzYCB0eXBlLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHR5cGVvZiBsaXN0ZW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBub3JtYWxpemVIVE1MID0gZnVuY3Rpb24ocGFyZW50LCBodG1sKSB7CiAgICAgICAgICAgIHZhciB0ZXN0RWxlbWVudCA9IHBhcmVudC5uYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFID8gcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChwYXJlbnQudGFnTmFtZSkgOiBwYXJlbnQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50TlMocGFyZW50Lm5hbWVzcGFjZVVSSSwgcGFyZW50LnRhZ05hbWUpOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICByZXR1cm4gdGVzdEVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCA9IC9cclxuPy9nOwogICAgICAgIHZhciBOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVggPSAvXHUwMDAwfFx1RkZGRC9nOwogICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShtYXJrdXApIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tIdG1sU3RyaW5nQ29lcmNpb24obWFya3VwKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXJrdXBTdHJpbmcgPSB0eXBlb2YgbWFya3VwID09PSAic3RyaW5nIiA/IG1hcmt1cCA6ICIiICsgbWFya3VwOwogICAgICAgICAgcmV0dXJuIG1hcmt1cFN0cmluZy5yZXBsYWNlKE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCwgIlxuIikucmVwbGFjZShOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVgsICIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHNlcnZlclRleHQsIGNsaWVudFRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShjbGllbnRUZXh0KTsKICAgICAgICAgIHZhciBub3JtYWxpemVkU2VydmVyVGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJUZXh0KTsKICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVGV4dCA9PT0gbm9ybWFsaXplZENsaWVudFRleHQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCdUZXh0IGNvbnRlbnQgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAiJXMiIENsaWVudDogIiVzIicsIG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0LCBub3JtYWxpemVkQ2xpZW50VGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSAmJiBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGV4dCBjb250ZW50IGRvZXMgbm90IG1hdGNoIHNlcnZlci1yZW5kZXJlZCBIVE1MLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQobm9kZSkgewogICAgICAgICAgbm9kZS5vbmNsaWNrID0gbm9vcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgbmV4dFByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFRleHRDb250ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVwZGF0ZVBheWxvYWQubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgdmFyIHByb3BLZXkgPSB1cGRhdGVQYXlsb2FkW2ldOwogICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBwcm9wVmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50Myh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQsIHBhcmVudE5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgdmFyIGRvbUVsZW1lbnQ7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlVVJJID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgbmFtZXNwYWNlVVJJID0gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgdHlwZSAhPT0gdHlwZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiPCVzIC8+IGlzIHVzaW5nIGluY29ycmVjdCBjYXNpbmcuIFVzZSBQYXNjYWxDYXNlIGZvciBSZWFjdCBjb21wb25lbnRzLCBvciBsb3dlcmNhc2UgZm9yIEhUTUwgZWxlbWVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlID09PSAic2NyaXB0IikgewogICAgICAgICAgICAgIHZhciBkaXYgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAiPHNjcmlwdD48XC9zY3JpcHQ+IjsKICAgICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGRpdi5maXJzdENoaWxkOwogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBkaXYucmVtb3ZlQ2hpbGQoZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSwgewogICAgICAgICAgICAgICAgaXM6IHByb3BzLmlzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlKTsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gZG9tRWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICBub2RlLm11bHRpcGxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuc2l6ZSkgewogICAgICAgICAgICAgICAgICBub2RlLnNpemUgPSBwcm9wcy5zaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZVVSSSwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9tRWxlbWVudCkgPT09ICJbb2JqZWN0IEhUTUxVbmtub3duRWxlbWVudF0iICYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFVua25vd25UYWdzLCB0eXBlKSkgewogICAgICAgICAgICAgICAgd2FybmVkVW5rbm93blRhZ3NbdHlwZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSB0YWcgPCVzPiBpcyB1bnJlY29nbml6ZWQgaW4gdGhpcyBicm93c2VyLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgUmVhY3QgY29tcG9uZW50LCBzdGFydCBpdHMgbmFtZSB3aXRoIGFuIHVwcGVyY2FzZSBsZXR0ZXIuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUodGV4dCwgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ2aWRlbyI6CiAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lZGlhRXZlbnRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudChtZWRpYUV2ZW50VHlwZXNbaV0sIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcyk7CiAgICAgICAgICBzZXRJbml0aWFsRE9NUHJvcGVydGllcyh0YWcsIGRvbUVsZW1lbnQsIHJvb3RDb250YWluZXJFbGVtZW50LCBwcm9wcywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIGZhbHNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMyhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgbGFzdFJhd1Byb3BzLCBuZXh0UmF3UHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgdmFyIGxhc3RQcm9wczsKICAgICAgICAgIHZhciBuZXh0UHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGxhc3RSYXdQcm9wczsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBuZXh0UmF3UHJvcHM7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXN0UHJvcHMub25DbGljayAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbmV4dFByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBuZXh0UHJvcHMpOwogICAgICAgICAgdmFyIHByb3BLZXk7CiAgICAgICAgICB2YXIgc3R5bGVOYW1lOwogICAgICAgICAgdmFyIHN0eWxlVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbGFzdFByb3BzKSB7CiAgICAgICAgICAgIGlmIChuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgIWxhc3RQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBsYXN0UHJvcHNbcHJvcEtleV0gPT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHZhciBsYXN0U3R5bGUgPSBsYXN0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFN0eWxlKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdFN0eWxlLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCB8fCBwcm9wS2V5ID09PSBDSElMRFJFTikgOwogICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IG5leHRQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgdmFyIGxhc3RQcm9wID0gbGFzdFByb3BzICE9IG51bGwgPyBsYXN0UHJvcHNbcHJvcEtleV0gOiB2b2lkIDA7CiAgICAgICAgICAgIGlmICghbmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8IG5leHRQcm9wID09PSBsYXN0UHJvcCB8fCBuZXh0UHJvcCA9PSBudWxsICYmIGxhc3RQcm9wID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYXN0UHJvcCkgewogICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkgJiYgKCFuZXh0UHJvcCB8fCAhbmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gIiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmIGxhc3RQcm9wW3N0eWxlTmFtZV0gIT09IG5leHRQcm9wW3N0eWxlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gbmV4dFByb3Bbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZC5wdXNoKHByb3BLZXksIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSBuZXh0UHJvcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIGxhc3RIdG1sID0gbGFzdFByb3AgPyBsYXN0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdEh0bWwgIT09IG5leHRIdG1sKSB7CiAgICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkICYmIGxhc3RQcm9wICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0UHJvcHNbU1RZTEVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2goU1RZTEUsIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzKSB7CiAgICAgICAgICBpZiAodGFnID09PSAiaW5wdXQiICYmIG5leHRSYXdQcm9wcy50eXBlID09PSAicmFkaW8iICYmIG5leHRSYXdQcm9wcy5uYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlQ2hlY2tlZChkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlcihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcG9zdFVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcHJvcE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKCFwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV0gfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJFbGVtZW50LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWc7CiAgICAgICAgICB2YXIgZXh0cmFBdHRyaWJ1dGVOYW1lczsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2FuY2VsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2xvc2UiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNvdXJjZSI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGRvbUVsZW1lbnQuYXR0cmlidXRlczsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGF0dHJpYnV0ZXMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVzW19pXS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlICJ2YWx1ZSI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY2hlY2tlZCI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0ZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuYWRkKGF0dHJpYnV0ZXNbX2ldLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiByYXdQcm9wcykgewogICAgICAgICAgICBpZiAoIXJhd1Byb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gcmF3UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09ICIiICsgbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgIiIgKyBuZXh0UHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFdhcm5EZXYgJiYgdHJ1ZSAmJiAvLyBDb252aW5jZSBGbG93IHdlJ3ZlIGNhbGN1bGF0ZWQgaXQgKGl0J3MgREVWLW9ubHkgaW4gdGhpcyBtZXRob2QuKQogICAgICAgICAgICB0eXBlb2YgaXNDdXN0b21Db21wb25lbnRUYWcgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgIHZhciBzZXJ2ZXJWYWx1ZSA9IHZvaWQgMDsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gaXNDdXN0b21Db21wb25lbnRUYWcgJiYgZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCA/IG51bGwgOiBnZXRQcm9wZXJ0eUluZm8ocHJvcEtleSk7CiAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSA9PT0gdHJ1ZSkgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyB8fCAvLyBDb250cm9sbGVkIGF0dHJpYnV0ZXMgYXJlIG5vdCB2YWxpZGF0ZWQKICAgICAgICAgICAgICAvLyBUT0RPOiBPbmx5IGlnbm9yZSB0aGVtIG9uIGNvbnRyb2xsZWQgdGFncy4KICAgICAgICAgICAgICBwcm9wS2V5ID09PSAidmFsdWUiIHx8IHByb3BLZXkgPT09ICJjaGVja2VkIiB8fCBwcm9wS2V5ID09PSAic2VsZWN0ZWQiKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICAgIHZhciBzZXJ2ZXJIVE1MID0gZG9tRWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWRIVE1MID0gbm9ybWFsaXplSFRNTChkb21FbGVtZW50LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZEhUTUwgIT09IHNlcnZlckhUTUwpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVySFRNTCwgZXhwZWN0ZWRIVE1MKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkpOwogICAgICAgICAgICAgICAgaWYgKGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkU3R5bGUgPSBjcmVhdGVEYW5nZXJvdXNTdHJpbmdGb3JTdHlsZXMobmV4dFByb3ApOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGRvbUVsZW1lbnQuZ2V0QXR0cmlidXRlKCJzdHlsZSIpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRTdHlsZSAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIGV4cGVjdGVkU3R5bGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiAhZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCkgewogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSkgewogICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzaG91bGRJZ25vcmVBdHRyaWJ1dGUocHJvcEtleSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgJiYgIXNob3VsZFJlbW92ZUF0dHJpYnV0ZShwcm9wS2V5LCBuZXh0UHJvcCwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgICAgIHZhciBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIG93bk5hbWVzcGFjZSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0YWcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChvd25OYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbnVsbCAmJiBzdGFuZGFyZE5hbWUgIT09IHByb3BLZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBkb250V2FybkN1c3RvbUVsZW1lbnQgPSBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0OwogICAgICAgICAgICAgICAgaWYgKCFkb250V2FybkN1c3RvbUVsZW1lbnQgJiYgbmV4dFByb3AgIT09IHNlcnZlclZhbHVlICYmICFpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSAtIFNob3VsZCBiZSBpbmZlcnJlZCBhcyBub3QgdW5kZWZpbmVkLgogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5zaXplID4gMCAmJiByYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMoZXh0cmFBdHRyaWJ1dGVOYW1lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlcihkb21FbGVtZW50LCByYXdQcm9wcywgdHJ1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByYXdQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0Tm9kZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIGlzRGlmZmVyZW50ID0gdGV4dE5vZGUubm9kZVZhbHVlICE9PSB0ZXh0OwogICAgICAgICAgcmV0dXJuIGlzRGlmZmVyZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgPCVzPiBpbiA8JXM+LiIsIGNoaWxkLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgY2hpbGQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gdGhlIHRleHQgbm9kZSAiJXMiIGluIDwlcz4uJywgY2hpbGQubm9kZVZhbHVlLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Tm9kZSwgdGFnLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIDwlcz4gaW4gPCVzPi4iLCB0YWcsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnROb2RlLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0ZXh0ID09PSAiIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcignRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIHRleHQgbm9kZSBmb3IgIiVzIiBpbiA8JXM+LicsIHRleHQsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMyhkb21FbGVtZW50LCB0YWcsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQyKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHZhciB1cGRhdGVkQW5jZXN0b3JJbmZvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgc3BlY2lhbFRhZ3MgPSBbImFkZHJlc3MiLCAiYXBwbGV0IiwgImFyZWEiLCAiYXJ0aWNsZSIsICJhc2lkZSIsICJiYXNlIiwgImJhc2Vmb250IiwgImJnc291bmQiLCAiYmxvY2txdW90ZSIsICJib2R5IiwgImJyIiwgImJ1dHRvbiIsICJjYXB0aW9uIiwgImNlbnRlciIsICJjb2wiLCAiY29sZ3JvdXAiLCAiZGQiLCAiZGV0YWlscyIsICJkaXIiLCAiZGl2IiwgImRsIiwgImR0IiwgImVtYmVkIiwgImZpZWxkc2V0IiwgImZpZ2NhcHRpb24iLCAiZmlndXJlIiwgImZvb3RlciIsICJmb3JtIiwgImZyYW1lIiwgImZyYW1lc2V0IiwgImgxIiwgImgyIiwgImgzIiwgImg0IiwgImg1IiwgImg2IiwgImhlYWQiLCAiaGVhZGVyIiwgImhncm91cCIsICJociIsICJodG1sIiwgImlmcmFtZSIsICJpbWciLCAiaW5wdXQiLCAiaXNpbmRleCIsICJsaSIsICJsaW5rIiwgImxpc3RpbmciLCAibWFpbiIsICJtYXJxdWVlIiwgIm1lbnUiLCAibWVudWl0ZW0iLCAibWV0YSIsICJuYXYiLCAibm9lbWJlZCIsICJub2ZyYW1lcyIsICJub3NjcmlwdCIsICJvYmplY3QiLCAib2wiLCAicCIsICJwYXJhbSIsICJwbGFpbnRleHQiLCAicHJlIiwgInNjcmlwdCIsICJzZWN0aW9uIiwgInNlbGVjdCIsICJzb3VyY2UiLCAic3R5bGUiLCAic3VtbWFyeSIsICJ0YWJsZSIsICJ0Ym9keSIsICJ0ZCIsICJ0ZW1wbGF0ZSIsICJ0ZXh0YXJlYSIsICJ0Zm9vdCIsICJ0aCIsICJ0aGVhZCIsICJ0aXRsZSIsICJ0ciIsICJ0cmFjayIsICJ1bCIsICJ3YnIiLCAieG1wIl07CiAgICAgICAgICB2YXIgaW5TY29wZVRhZ3MgPSBbCiAgICAgICAgICAgICJhcHBsZXQiLAogICAgICAgICAgICAiY2FwdGlvbiIsCiAgICAgICAgICAgICJodG1sIiwKICAgICAgICAgICAgInRhYmxlIiwKICAgICAgICAgICAgInRkIiwKICAgICAgICAgICAgInRoIiwKICAgICAgICAgICAgIm1hcnF1ZWUiLAogICAgICAgICAgICAib2JqZWN0IiwKICAgICAgICAgICAgInRlbXBsYXRlIiwKICAgICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc3ludGF4Lmh0bWwjaHRtbC1pbnRlZ3JhdGlvbi1wb2ludAogICAgICAgICAgICAvLyBUT0RPOiBEaXN0aW5ndWlzaCBieSBuYW1lc3BhY2UgaGVyZSAtLSBmb3IgPHRpdGxlPiwgaW5jbHVkaW5nIGl0IGhlcmUKICAgICAgICAgICAgLy8gZXJycyBvbiB0aGUgc2lkZSBvZiBmZXdlciB3YXJuaW5ncwogICAgICAgICAgICAiZm9yZWlnbk9iamVjdCIsCiAgICAgICAgICAgICJkZXNjIiwKICAgICAgICAgICAgInRpdGxlIgogICAgICAgICAgXTsKICAgICAgICAgIHZhciBidXR0b25TY29wZVRhZ3MgPSBpblNjb3BlVGFncy5jb25jYXQoWyJidXR0b24iXSk7CiAgICAgICAgICB2YXIgaW1wbGllZEVuZFRhZ3MgPSBbImRkIiwgImR0IiwgImxpIiwgIm9wdGlvbiIsICJvcHRncm91cCIsICJwIiwgInJwIiwgInJ0Il07CiAgICAgICAgICB2YXIgZW1wdHlBbmNlc3RvckluZm8gPSB7CiAgICAgICAgICAgIGN1cnJlbnQ6IG51bGwsCiAgICAgICAgICAgIGZvcm1UYWc6IG51bGwsCiAgICAgICAgICAgIGFUYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBidXR0b25UYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBub2JyVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgcFRhZ0luQnV0dG9uU2NvcGU6IG51bGwsCiAgICAgICAgICAgIGxpc3RJdGVtVGFnQXV0b2Nsb3Npbmc6IG51bGwsCiAgICAgICAgICAgIGRsSXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKG9sZEluZm8sIHRhZykgewogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gYXNzaWduKHt9LCBvbGRJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGluZm8yID0gewogICAgICAgICAgICAgIHRhZwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoaW5TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJ1dHRvblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lhbFRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSAmJiB0YWcgIT09ICJhZGRyZXNzIiAmJiB0YWcgIT09ICJkaXYiICYmIHRhZyAhPT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmN1cnJlbnQgPSBpbmZvMjsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gImZvcm0iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmZvcm1UYWcgPSBpbmZvMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBpbmZvMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYnV0dG9uIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gIm5vYnIiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImxpIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImRkIiB8fCB0YWcgPT09ICJkdCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvMjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpc1RhZ1ZhbGlkV2l0aFBhcmVudCA9IGZ1bmN0aW9uKHRhZywgcGFyZW50VGFnKSB7CiAgICAgICAgICAgIHN3aXRjaCAocGFyZW50VGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIm9wdGdyb3VwIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0Z3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0aCIgfHwgdGFnID09PSAidGQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0ciIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjb2wiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0YWJsZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiY2FwdGlvbiIgfHwgdGFnID09PSAiY29sZ3JvdXAiIHx8IHRhZyA9PT0gInRib2R5IiB8fCB0YWcgPT09ICJ0Zm9vdCIgfHwgdGFnID09PSAidGhlYWQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJiYXNlIiB8fCB0YWcgPT09ICJiYXNlZm9udCIgfHwgdGFnID09PSAiYmdzb3VuZCIgfHwgdGFnID09PSAibGluayIgfHwgdGFnID09PSAibWV0YSIgfHwgdGFnID09PSAidGl0bGUiIHx8IHRhZyA9PT0gIm5vc2NyaXB0IiB8fCB0YWcgPT09ICJub2ZyYW1lcyIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImhlYWQiIHx8IHRhZyA9PT0gImJvZHkiIHx8IHRhZyA9PT0gImZyYW1lc2V0IjsKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiZnJhbWUiOwogICAgICAgICAgICAgIGNhc2UgIiNkb2N1bWVudCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaHRtbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgIT09ICJoMSIgJiYgcGFyZW50VGFnICE9PSAiaDIiICYmIHBhcmVudFRhZyAhPT0gImgzIiAmJiBwYXJlbnRUYWcgIT09ICJoNCIgJiYgcGFyZW50VGFnICE9PSAiaDUiICYmIHBhcmVudFRhZyAhPT0gImg2IjsKICAgICAgICAgICAgICBjYXNlICJycCI6CiAgICAgICAgICAgICAgY2FzZSAicnQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGltcGxpZWRFbmRUYWdzLmluZGV4T2YocGFyZW50VGFnKSA9PT0gLTE7CiAgICAgICAgICAgICAgY2FzZSAiYm9keSI6CiAgICAgICAgICAgICAgY2FzZSAiY2FwdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAiY29sIjoKICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZyYW1lIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICBjYXNlICJ0aCI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgPT0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEludmFsaWRBbmNlc3RvckZvclRhZyA9IGZ1bmN0aW9uKHRhZywgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiYWRkcmVzcyI6CiAgICAgICAgICAgICAgY2FzZSAiYXJ0aWNsZSI6CiAgICAgICAgICAgICAgY2FzZSAiYXNpZGUiOgogICAgICAgICAgICAgIGNhc2UgImJsb2NrcXVvdGUiOgogICAgICAgICAgICAgIGNhc2UgImNlbnRlciI6CiAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBjYXNlICJkaXIiOgogICAgICAgICAgICAgIGNhc2UgImRpdiI6CiAgICAgICAgICAgICAgY2FzZSAiZGwiOgogICAgICAgICAgICAgIGNhc2UgImZpZWxkc2V0IjoKICAgICAgICAgICAgICBjYXNlICJmaWdjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJmaWd1cmUiOgogICAgICAgICAgICAgIGNhc2UgImZvb3RlciI6CiAgICAgICAgICAgICAgY2FzZSAiaGVhZGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZ3JvdXAiOgogICAgICAgICAgICAgIGNhc2UgIm1haW4iOgogICAgICAgICAgICAgIGNhc2UgIm1lbnUiOgogICAgICAgICAgICAgIGNhc2UgIm5hdiI6CiAgICAgICAgICAgICAgY2FzZSAib2wiOgogICAgICAgICAgICAgIGNhc2UgInAiOgogICAgICAgICAgICAgIGNhc2UgInNlY3Rpb24iOgogICAgICAgICAgICAgIGNhc2UgInN1bW1hcnkiOgogICAgICAgICAgICAgIGNhc2UgInVsIjoKICAgICAgICAgICAgICBjYXNlICJwcmUiOgogICAgICAgICAgICAgIGNhc2UgImxpc3RpbmciOgogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICBjYXNlICJociI6CiAgICAgICAgICAgICAgY2FzZSAieG1wIjoKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiZm9ybSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmZvcm1UYWcgfHwgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImxpIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJkZCI6CiAgICAgICAgICAgICAgY2FzZSAiZHQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImEiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZTsKICAgICAgICAgICAgICBjYXNlICJub2JyIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRpZFdhcm4kMSA9IHt9OwogICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oY2hpbGRUYWcsIGNoaWxkVGV4dCwgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIGFuY2VzdG9ySW5mbyA9IGFuY2VzdG9ySW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbzsKICAgICAgICAgICAgdmFyIHBhcmVudEluZm8gPSBhbmNlc3RvckluZm8uY3VycmVudDsKICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudEluZm8gJiYgcGFyZW50SW5mby50YWc7CiAgICAgICAgICAgIGlmIChjaGlsZFRleHQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZFRhZyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nOiB3aGVuIGNoaWxkVGV4dCBpcyBwYXNzZWQsIGNoaWxkVGFnIHNob3VsZCBiZSBudWxsIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkVGFnID0gIiN0ZXh0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW52YWxpZFBhcmVudCA9IGlzVGFnVmFsaWRXaXRoUGFyZW50KGNoaWxkVGFnLCBwYXJlbnRUYWcpID8gbnVsbCA6IHBhcmVudEluZm87CiAgICAgICAgICAgIHZhciBpbnZhbGlkQW5jZXN0b3IgPSBpbnZhbGlkUGFyZW50ID8gbnVsbCA6IGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcoY2hpbGRUYWcsIGFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50T3JBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgfHwgaW52YWxpZEFuY2VzdG9yOwogICAgICAgICAgICBpZiAoIWludmFsaWRQYXJlbnRPckFuY2VzdG9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvclRhZyA9IGludmFsaWRQYXJlbnRPckFuY2VzdG9yLnRhZzsKICAgICAgICAgICAgdmFyIHdhcm5LZXkgPSAhIWludmFsaWRQYXJlbnQgKyAifCIgKyBjaGlsZFRhZyArICJ8IiArIGFuY2VzdG9yVGFnOwogICAgICAgICAgICBpZiAoZGlkV2FybiQxW3dhcm5LZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm4kMVt3YXJuS2V5XSA9IHRydWU7CiAgICAgICAgICAgIHZhciB0YWdEaXNwbGF5TmFtZSA9IGNoaWxkVGFnOwogICAgICAgICAgICB2YXIgd2hpdGVzcGFjZUluZm8gPSAiIjsKICAgICAgICAgICAgaWYgKGNoaWxkVGFnID09PSAiI3RleHQiKSB7CiAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdChjaGlsZFRleHQpKSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJUZXh0IG5vZGVzIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiV2hpdGVzcGFjZSB0ZXh0IG5vZGVzIjsKICAgICAgICAgICAgICAgIHdoaXRlc3BhY2VJbmZvID0gIiBNYWtlIHN1cmUgeW91IGRvbid0IGhhdmUgYW55IGV4dHJhIHdoaXRlc3BhY2UgYmV0d2VlbiB0YWdzIG9uIGVhY2ggbGluZSBvZiB5b3VyIHNvdXJjZSBjb2RlLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIjwiICsgY2hpbGRUYWcgKyAiPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGludmFsaWRQYXJlbnQpIHsKICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICBpZiAoYW5jZXN0b3JUYWcgPT09ICJ0YWJsZSIgJiYgY2hpbGRUYWcgPT09ICJ0ciIpIHsKICAgICAgICAgICAgICAgIGluZm8yICs9ICIgQWRkIGEgPHRib2R5PiwgPHRoZWFkPiBvciA8dGZvb3Q+IHRvIHlvdXIgY29kZSB0byBtYXRjaCB0aGUgRE9NIHRyZWUgZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGNoaWxkIG9mIDwlcz4uJXMlcyIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZywgd2hpdGVzcGFjZUluZm8sIGluZm8yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBkZXNjZW5kYW50IG9mIDwlcz4uIiwgdGFnRGlzcGxheU5hbWUsIGFuY2VzdG9yVGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDEgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgU1VTUEVOU0VfU1RBUlRfREFUQSA9ICIkIjsKICAgICAgICB2YXIgU1VTUEVOU0VfRU5EX0RBVEEgPSAiLyQiOwogICAgICAgIHZhciBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgPSAiJD8iOwogICAgICAgIHZhciBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBID0gIiQhIjsKICAgICAgICB2YXIgU1RZTEUkMSA9ICJzdHlsZSI7CiAgICAgICAgdmFyIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgIHZhciBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250ZXh0KHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlOwogICAgICAgICAgdmFyIG5vZGVUeXBlID0gcm9vdENvbnRhaW5lckluc3RhbmNlLm5vZGVUeXBlOwogICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICBjYXNlIERPQ1VNRU5UX05PREU6CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfRlJBR01FTlRfTk9ERTogewogICAgICAgICAgICAgIHR5cGUgPSBub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/ICIjZG9jdW1lbnQiIDogIiNmcmFnbWVudCI7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcm9vdENvbnRhaW5lckluc3RhbmNlLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSByb290MyA/IHJvb3QzLm5hbWVzcGFjZVVSSSA6IGdldENoaWxkTmFtZXNwYWNlKG51bGwsICIiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSBub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckluc3RhbmNlLnBhcmVudE5vZGUgOiByb290Q29udGFpbmVySW5zdGFuY2U7CiAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IGNvbnRhaW5lcjIubmFtZXNwYWNlVVJJIHx8IG51bGw7CiAgICAgICAgICAgICAgdHlwZSA9IGNvbnRhaW5lcjIudGFnTmFtZTsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShvd25OYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB2YWxpZGF0ZWRUYWcgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKG51bGwsIHZhbGlkYXRlZFRhZyk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZEhvc3RDb250ZXh0KHBhcmVudEhvc3RDb250ZXh0LCB0eXBlLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudEhvc3RDb250ZXh0RGV2ID0gcGFyZW50SG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnRIb3N0Q29udGV4dERldi5uYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhwYXJlbnRIb3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUZvckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gaXNFbmFibGVkKCk7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCk7CiAgICAgICAgICB2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgc2V0RW5hYmxlZChmYWxzZSk7CiAgICAgICAgICByZXR1cm4gYWN0aXZlSW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0QWZ0ZXJDb21taXQoY29udGFpbmVySW5mbykgewogICAgICAgICAgcmVzdG9yZVNlbGVjdGlvbihzZWxlY3Rpb25JbmZvcm1hdGlvbik7CiAgICAgICAgICBzZXRFbmFibGVkKGV2ZW50c0VuYWJsZWQpOwogICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKHR5cGUsIG51bGwsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgc3RyaW5nID0gIiIgKyBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgb3duQW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCBzdHJpbmcsIG93bkFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRvbUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50Myh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBwYXJlbnROYW1lc3BhY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXR1cm4gISFwcm9wcy5hdXRvRm9jdXM7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiAhPT0gdHlwZW9mIG9sZFByb3BzLmNoaWxkcmVuICYmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlID09PSAidGV4dGFyZWEiIHx8IHR5cGUgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgdGV4dCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0Tm9kZSk7CiAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCkgewogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgIGlmIChjdXJyZW50RXZlbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRQcmlvcml0eShjdXJyZW50RXZlbnQudHlwZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIGNhbmNlbFRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBub1RpbWVvdXQgPSAtMTsKICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgIHZhciBzY2hlZHVsZU1pY3JvdGFzayA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gImZ1bmN0aW9uIiA/IHF1ZXVlTWljcm90YXNrIDogdHlwZW9mIGxvY2FsUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGxvY2FsUHJvbWlzZS5yZXNvbHZlKG51bGwpLnRoZW4oY2FsbGJhY2spLmNhdGNoKGhhbmRsZUVycm9ySW5OZXh0VGljayk7CiAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvckluTmV4dFRpY2soZXJyb3IyKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZSwgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuYXV0b0ZvY3VzKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAiaW1nIjogewogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuc3JjID0gbmV3UHJvcHMuc3JjOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWN0Um9vdENvbnRhaW5lciA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIGlmICgocmVhY3RSb290Q29udGFpbmVyID09PSBudWxsIHx8IHJlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwKSAmJiBwYXJlbnROb2RlLm9uY2xpY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQocGFyZW50Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUoY29udGFpbmVyMiwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbmV4dE5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMi5wYXJlbnROb2RlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZTIgPSBpbnN0YW5jZS5zdHlsZTsKICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUyLnNldFByb3BlcnR5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGUyLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlKSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZUluc3RhbmNlKGluc3RhbmNlLCBwcm9wcykgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZVByb3AgPSBwcm9wc1tTVFlMRSQxXTsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gc3R5bGVQcm9wICE9PSB2b2lkIDAgJiYgc3R5bGVQcm9wICE9PSBudWxsICYmIHN0eWxlUHJvcC5oYXNPd25Qcm9wZXJ0eSgiZGlzcGxheSIpID8gc3R5bGVQcm9wLmRpc3BsYXkgOiBudWxsOwogICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi50ZXh0Q29udGVudCA9ICIiOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUudG9Mb3dlckNhc2UoKSAhPT0gaW5zdGFuY2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShpbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQgPT09ICIiIHx8IGluc3RhbmNlLm5vZGVUeXBlICE9PSBURVhUX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBkYXRhc2V0ID0gaW5zdGFuY2UubmV4dFNpYmxpbmcgJiYgaW5zdGFuY2UubmV4dFNpYmxpbmcuZGF0YXNldDsKICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgICAgZGlnZXN0ID0gZGF0YXNldC5kZ3N0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGRhdGFzZXQubXNnOwogICAgICAgICAgICAgIHN0YWNrID0gZGF0YXNldC5zdGNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICBkaWdlc3QsCiAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoaW5zdGFuY2UsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RSZXRyeSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZShub2RlKSB7CiAgICAgICAgICBmb3IgKDsgbm9kZSAhPSBudWxsOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZURhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShpbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudENvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBpbnN0YW5jZSk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGluc3RhbmNlLCBwcm9wcyk7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHRJbnN0YW5jZSk7CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRUZXh0KHRleHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZS5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldEluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50VHlwZSAhPT0gImhlYWQiICYmIHBhcmVudFR5cGUgIT09ICJib2R5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICBpZiAocGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgaHlkcmF0aW9uLiBUaGUgc2VydmVyIEhUTUwgd2FzIHJlcGxhY2VkIHdpdGggY2xpZW50IGNvbnRlbnQgaW4gPCVzPi4iLCBwYXJlbnRDb250YWluZXIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVQb3J0YWxNb3VudChwb3J0YWxJbnN0YW5jZSkgewogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZG9tS2V5ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsUHJvcHNLZXkgPSAiX19yZWFjdFByb3BzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXkgPSAiX19yZWFjdENvbnRhaW5lciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleSA9ICJfX3JlYWN0TGlzdGVuZXJzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5ID0gIl9fcmVhY3RIYW5kbGVzJCIgKyByYW5kb21LZXk7CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxQcm9wc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSA9IGhvc3RJbnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29udGFpbmVyQXNSb290KGhvc3RSb290LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gaG9zdFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVubWFya0NvbnRhaW5lckFzUm9vdChub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250YWluZXJNYXJrZWRBc1Jvb3Qobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0Tm9kZSkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSB0YXJnZXROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBwYXJlbnROb2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldIHx8IHBhcmVudE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHRhcmdldEluc3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0LmNoaWxkICE9PSBudWxsIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgIHdoaWxlIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRTdXNwZW5zZUluc3QgPSBzdXNwZW5zZUluc3RhbmNlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFN1c3BlbnNlSW5zdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgaW5zdCA9IG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gfHwgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQgfHwgaW5zdC50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZ2V0Tm9kZUZyb21JbnN0YW5jZTogSW52YWxpZCBhcmd1bWVudC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZVtpbnRlcm5hbFByb3BzS2V5XSB8fCBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsUHJvcHNLZXldID0gcHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGlmIChlbGVtZW50TGlzdGVuZXJTZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRMaXN0ZW5lclNldDsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMyID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXMyKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgdmFyIGZpYmVyU3RhY2s7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJyZW50OiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgRmliZXIgcG9wcGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlU3RhY2tbaW5kZXhdOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleC0tOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBjdXJzb3IuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQ7CiAgICAgICAgewogICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBlbXB0eUNvbnRleHRPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgfQogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB2YXIgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihmYWxzZSk7CiAgICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyICYmIGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBtYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPSB1bm1hc2tlZENvbnRleHQ7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gdHlwZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICghY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICBjb250ZXh0W2tleV0gPSB1bm1hc2tlZENvbnRleHRba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDb250ZXh0Q2hhbmdlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250ZXh0UHJvdmlkZXIodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICByZXR1cm4gY2hpbGRDb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY2hpbGRDb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjb250ZXh0IGZvdW5kIG9uIHN0YWNrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHR5cGUsIHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0ID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgaWYgKCEoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcykpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKSArICcuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJyArIGNvbnRleHRLZXkgKyAnIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcGFyZW50Q29udGV4dCwgY2hpbGRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgfHwgZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICBwcmV2aW91c0NvbnRleHQgPSBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBkaWRDaGFuZ2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gaGF2ZSBhbiBpbnN0YW5jZSBieSB0aGlzIHBvaW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRDaGFuZ2UpIHsKICAgICAgICAgICAgICB2YXIgbWVyZ2VkQ29udGV4dCA9IHByb2Nlc3NDaGlsZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBwcmV2aW91c0NvbnRleHQpOwogICAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gbWVyZ2VkQ29udGV4dDsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZXJnZWRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGaWJlck1vdW50ZWQoZmliZXIpIHx8IGZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHN1YnRyZWUgcGFyZW50IHRvIGJlIGEgbW91bnRlZCBjbGFzcyBjb21wb25lbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5jb250ZXh0OwogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gbm9kZS50eXBlOwogICAgICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChub2RlICE9PSBudWxsKTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGb3VuZCB1bmV4cGVjdGVkIGRldGFjaGVkIHN1YnRyZWUgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTGVnYWN5Um9vdCA9IDA7CiAgICAgICAgdmFyIENvbmN1cnJlbnRSb290ID0gMTsKICAgICAgICB2YXIgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICB2YXIgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaWYgKHN5bmNRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBzeW5jUXVldWUgPSBbY2FsbGJhY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3luY1F1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gdHJ1ZTsKICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpIHsKICAgICAgICAgIGlmIChpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MpIHsKICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrcygpIHsKICAgICAgICAgIGlmICghaXNGbHVzaGluZ1N5bmNRdWV1ZSAmJiBzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IHRydWU7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzVXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgaXNTeW5jID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBzeW5jUXVldWU7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2soaXNTeW5jKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgaWYgKHN5bmNRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3luY1F1ZXVlID0gc3luY1F1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayhJbW1lZGlhdGVQcmlvcml0eSwgZmx1c2hTeW5jQ2FsbGJhY2tzKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlUHJpb3JpdHkpOwogICAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBmb3JrU3RhY2sgPSBbXTsKICAgICAgICB2YXIgZm9ya1N0YWNrSW5kZXggPSAwOwogICAgICAgIHZhciB0cmVlRm9ya1Byb3ZpZGVyID0gbnVsbDsKICAgICAgICB2YXIgdHJlZUZvcmtDb3VudCA9IDA7CiAgICAgICAgdmFyIGlkU3RhY2sgPSBbXTsKICAgICAgICB2YXIgaWRTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUNvbnRleHRQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0SWQgPSAxOwogICAgICAgIHZhciB0cmVlQ29udGV4dE92ZXJmbG93ID0gIiI7CiAgICAgICAgZnVuY3Rpb24gaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgcmV0dXJuICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JrZWQpICE9PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGb3Jrc0F0TGV2ZWwod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiB0cmVlRm9ya0NvdW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmVlSWQoKSB7CiAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGlkID0gaWRXaXRoTGVhZGluZ0JpdCAmIH5nZXRMZWFkaW5nQml0KGlkV2l0aExlYWRpbmdCaXQpOwogICAgICAgICAgcmV0dXJuIGlkLnRvU3RyaW5nKDMyKSArIG92ZXJmbG93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCB0b3RhbENoaWxkcmVuKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleCsrXSA9IHRyZWVGb3JrQ291bnQ7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya1Byb3ZpZGVyOwogICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHRyZWVGb3JrQ291bnQgPSB0b3RhbENoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbiwgaW5kZXgyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRQcm92aWRlcjsKICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgYmFzZUlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGJhc2VPdmVyZmxvdyA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICB2YXIgYmFzZUxlbmd0aCA9IGdldEJpdExlbmd0aChiYXNlSWRXaXRoTGVhZGluZ0JpdCkgLSAxOwogICAgICAgICAgdmFyIGJhc2VJZCA9IGJhc2VJZFdpdGhMZWFkaW5nQml0ICYgfigxIDw8IGJhc2VMZW5ndGgpOwogICAgICAgICAgdmFyIHNsb3QgPSBpbmRleDIgKyAxOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIGJhc2VMZW5ndGg7CiAgICAgICAgICBpZiAobGVuZ3RoID4gMzApIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mT3ZlcmZsb3dCaXRzID0gYmFzZUxlbmd0aCAtIGJhc2VMZW5ndGggJSA1OwogICAgICAgICAgICB2YXIgbmV3T3ZlcmZsb3dCaXRzID0gKDEgPDwgbnVtYmVyT2ZPdmVyZmxvd0JpdHMpIC0gMTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93ID0gKGJhc2VJZCAmIG5ld092ZXJmbG93Qml0cykudG9TdHJpbmcoMzIpOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUlkID0gYmFzZUlkID4+IG51bWJlck9mT3ZlcmZsb3dCaXRzOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUxlbmd0aCA9IGJhc2VMZW5ndGggLSBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciByZXN0T2ZOZXdCaXRzID0gc2xvdCA8PCByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgaWQgPSByZXN0T2ZOZXdCaXRzIHwgcmVzdE9mQmFzZUlkOwogICAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSBuZXdPdmVyZmxvdyArIGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgcmVzdE9mTGVuZ3RoIHwgaWQ7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBvdmVyZmxvdzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXdCaXRzID0gc2xvdCA8PCBiYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgX2lkID0gbmV3Qml0cyB8IGJhc2VJZDsKICAgICAgICAgICAgdmFyIF9vdmVyZmxvdyA9IGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgbGVuZ3RoIHwgX2lkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gX292ZXJmbG93OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gMTsKICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IDA7CiAgICAgICAgICAgIHB1c2hUcmVlRm9yayh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcywgc2xvdEluZGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Qml0TGVuZ3RoKG51bWJlcikgewogICAgICAgICAgcmV0dXJuIDMyIC0gY2x6MzIobnVtYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZGluZ0JpdChpZCkgewogICAgICAgICAgcmV0dXJuIDEgPDwgZ2V0Qml0TGVuZ3RoKGlkKSAtIDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHRQcm92aWRlciAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiB0cmVlQ29udGV4dElkLAogICAgICAgICAgICAgIG92ZXJmbG93OiB0cmVlQ29udGV4dE92ZXJmbG93CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuZGVkQ29udGV4dCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dElkID0gc3VzcGVuZGVkQ29udGV4dC5pZDsKICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBzdXNwZW5kZWRDb250ZXh0Lm92ZXJmbG93OwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmTm90SHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gYmUgaHlkcmF0aW5nLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgIHZhciBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB2YXIgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB2YXIgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuSWZIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGluZykgewogICAgICAgICAgICAgIGVycm9yKCJXZSBzaG91bGQgbm90IGJlIGh5ZHJhdGluZyBoZXJlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhIGJ1Zy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIsIHN1c3BlbnNlSW5zdGFuY2UsIHRyZWVDb250ZXh0KSB7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dChmaWJlciwgdHJlZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnR5cGUsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yREVWKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIF9wcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfcGFyZW50SW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKSBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wczIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3RleHQyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjYW5IeWRyYXRlSW5zdGFuY2UobmV4dEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHRleHRJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIHRyZWVDb250ZXh0OiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICByZXRyeUxhbmU6IE9mZnNjcmVlbkxhbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFN0YXRlID0gc3VzcGVuc2VTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBmaWJlci5jaGlsZCA9IGRlaHlkcmF0ZWRGcmFnbWVudDsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmIChmaWJlci5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSHlkcmF0aW9uIGZhaWxlZCBiZWNhdXNlIHRoZSBpbml0aWFsIFVJIGRvZXMgbm90IG1hdGNoIHdoYXQgd2FzIHJlbmRlcmVkIG9uIHRoZSBzZXJ2ZXIuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgcHJldkh5ZHJhdGlvblBhcmVudEZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlIHx8ICF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciwgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoZmliZXIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRXYXJuSWZNaXNtYXRjaERldiA9ICFkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCBmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBmaWJlciwgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlMgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHBhcmVudC50YWcgIT09IEhvc3RSb290ICYmIHBhcmVudC50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBIb3N0Um9vdCAmJiAoZmliZXIudGFnICE9PSBIb3N0Q29tcG9uZW50IHx8IHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKGZpYmVyLnR5cGUpICYmICFzaG91bGRTZXRUZXh0Q29udGVudChmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcikgewogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoaHlkcmF0aW9uRXJyb3JzKTsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgTm9UcmFuc2l0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMS50cmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICByZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIHJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBmaW5kU3RyaWN0Um9vdCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBtYXliZVN0cmljdFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heWJlU3RyaWN0Um9vdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQyKSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBzZXQyLmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheS5zb3J0KCkuam9pbigiLCAiKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczMgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjIoImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjIoImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczUgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4yKCJjb21wb25lbnRXaWxsVXBkYXRlIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxVcGRhdGUgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBzdHJpY3RSb290ID0gZmluZFN0cmljdFJvb3QoZmliZXIpOwogICAgICAgICAgICBpZiAoc3RyaWN0Um9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgIGlmIChmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsIHx8IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzRm9yUm9vdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5zZXQoc3RyaWN0Um9vdCwgd2FybmluZ3NGb3JSb290KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZm9yRWFjaChmdW5jdGlvbihmaWJlckFycmF5LCBzdHJpY3RSb290KSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaXJzdEZpYmVyID0gZmliZXJBcnJheVswXTsKICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGZpYmVyQXJyYXkuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKHVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpcnN0RmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkxlZ2FjeSBjb250ZXh0IEFQSSBoYXMgYmVlbiBkZXRlY3RlZCB3aXRoaW4gYSBzdHJpY3QtbW9kZSB0cmVlLlxuXG5UaGUgb2xkIEFQSSB3aWxsIGJlIHN1cHBvcnRlZCBpbiBhbGwgMTYueCByZWxlYXNlcywgYnV0IGFwcGxpY2F0aW9ucyB1c2luZyBpdCBzaG91bGQgbWlncmF0ZSB0byB0aGUgbmV3IHZlcnNpb24uXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlc1xuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5kaXNjYXJkUGVuZGluZ1dhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZzsKICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgIHZhciB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZC5fc3RvcmUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdCBDb21wb25lbnQgaW4gd2FybkZvck1pc3NpbmdLZXkgc2hvdWxkIGhhdmUgYSBfc3RvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZWFjdENsYXNzKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLnByb3RvdHlwZSAmJiB0eXBlLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgbWl4ZWRSZWYgPSBlbGVtZW50LnJlZjsKICAgICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChyZXR1cm5GaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSB8fCB3YXJuQWJvdXRTdHJpbmdSZWZzKSAmJiAvLyBXZSB3YXJuIGluIFJlYWN0RWxlbWVudC5qcyBpZiBvd25lciBhbmQgc2VsZiBhcmUgZXF1YWwgZm9yIHN0cmluZyByZWZzCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSB0aGVzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24KICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fc2VsZiAmJiBlbGVtZW50Ll9vd25lci5zdGF0ZU5vZGUgIT09IGVsZW1lbnQuX3NlbGYpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzIgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgJiYgLy8gV2lsbCBhbHJlYWR5IHdhcm4gd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcyIKICAgICAgICAgICAgICAhKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIWlzUmVhY3RDbGFzcyhlbGVtZW50LnR5cGUpKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoc29tZVN0cmluZ1JlZikgYnV0IG5vIG93bmVyIHdhcyBzZXQiCiAgICAgICAgICAgICAgZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0OwogICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICAgIGlmIChvd25lckZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdCA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBvd25lciBmb3Igc3RyaW5nIHJlZiAiICsgbWl4ZWRSZWYgKyAiLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRJbnN0ID0gaW5zdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50Mi5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDIucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQyLnJlZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IHJlc29sdmVkSW5zdC5yZWZzOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWZzW3N0cmluZ1JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaXhlZFJlZiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVmIHRvIGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nLCBhbiBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlUmVmKCksIG9yIG51bGwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoIiArIG1peGVkUmVmICsgIikgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBmdW5jdGlvbiBjb21wb25lbnRcbjIuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgY29tcG9uZW50IHRoYXQgd2FzIG5vdCBjcmVhdGVkIGluc2lkZSBhIGNvbXBvbmVudCdzIHJlbmRlciBtZXRob2RcbjMuIFlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBsb2FkZWRcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVmcy1tdXN0LWhhdmUtb3duZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZFN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRTdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9ucyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQuIFRoaXMgbWF5IGhhcHBlbiBpZiB5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5KGxhenlUeXBlKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlUeXBlLl9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5VHlwZS5faW5pdDsKICAgICAgICAgIHJldHVybiBpbml0KHBheWxvYWQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDaGlsZFJlY29uY2lsZXIoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZFRvRGVsZXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NoaWxkLmtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmluZGV4LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZCA9IGV4aXN0aW5nQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUZpYmVyKGZpYmVyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgICAgY2xvbmUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gRm9ya2VkOwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gbmV3RmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50Mi5pbmRleDsKICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPCBsYXN0UGxhY2VkSW5kZXgpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50MiwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50MiwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY3VycmVudDIsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY3VycmVudDIudHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDIsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50MiwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDIsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLnRhZyAhPT0gSG9zdFBvcnRhbCB8fCBjdXJyZW50Mi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudDIuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQyLCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50MiwgZnJhZ21lbnQsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLnRhZyAhPT0gRnJhZ21lbnQyKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmcmFnbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50MiwgZnJhZ21lbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCgiIiArIG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDIgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkMyA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgICBfY3JlYXRlZDMucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBvbGRGaWJlciAhPT0gbnVsbCA/IG9sZEZpYmVyLmtleSA6IG51bGw7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgb2xkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBtYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBtYXRjaGVkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMiwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIzID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjMsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiIHx8IGNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5KGNoaWxkLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBjaGlsZC5rZXk7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChrbm93bktleXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWtub3duS2V5cy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvcigiRW5jb3VudGVyZWQgdHdvIGNoaWxkcmVuIHdpdGggdGhlIHNhbWUga2V5LCBgJXNgLiBLZXlzIHNob3VsZCBiZSB1bmlxdWUgc28gdGhhdCBjb21wb25lbnRzIG1haW50YWluIHRoZWlyIGlkZW50aXR5IGFjcm9zcyB1cGRhdGVzLiBOb24tdW5pcXVlIGtleXMgbWF5IGNhdXNlIGNoaWxkcmVuIHRvIGJlIGR1cGxpY2F0ZWQgYW5kL29yIG9taXR0ZWQgXHUyMDE0IHRoZSBiZWhhdmlvciBpcyB1bnN1cHBvcnRlZCBhbmQgY291bGQgY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24uIiwga2V5KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBjaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBjaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZEtleShpbml0KHBheWxvYWQpLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBrbm93bktleXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGRyZW4sIGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIga25vd25LZXlzID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXdDaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIG9sZEZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBsYXN0UGxhY2VkSW5kZXggPSAwOwogICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgdmFyIG5leHRPbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3SWR4ID09PSBuZXdDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXIyID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjIua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyMi5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczIgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBvYmplY3QgaXMgbm90IGFuIGl0ZXJhYmxlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAvLyAkRmxvd0ZpeE1lIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IHRvU3RyaW5nVGFnCiAgICAgICAgICAgICAgbmV3Q2hpbGRyZW5JdGVyYWJsZVtTeW1ib2wudG9TdHJpbmdUYWddID09PSAiR2VuZXJhdG9yIikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZW5lcmF0b3JzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVc2luZyBHZW5lcmF0b3JzIGFzIGNoaWxkcmVuIGlzIHVuc3VwcG9ydGVkIGFuZCB3aWxsIGxpa2VseSB5aWVsZCB1bmV4cGVjdGVkIHJlc3VsdHMgYmVjYXVzZSBlbnVtZXJhdGluZyBhIGdlbmVyYXRvciBtdXRhdGVzIGl0LiBZb3UgbWF5IGNvbnZlcnQgaXQgdG8gYW4gYXJyYXkgd2l0aCBgQXJyYXkuZnJvbSgpYCBvciB0aGUgYFsuLi5zcHJlYWRdYCBvcGVyYXRvciBiZWZvcmUgcmVuZGVyaW5nLiBLZWVwIGluIG1pbmQgeW91IG1pZ2h0IG5lZWQgdG8gcG9seWZpbGwgdGhlc2UgZmVhdHVyZXMgZm9yIG9sZGVyIGJyb3dzZXJzLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbkl0ZXJhYmxlLmVudHJpZXMgPT09IGl0ZXJhdG9yRm4pIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgICAgaWYgKF9uZXdDaGlsZHJlbikgewogICAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpOwogICAgICAgICAgICAgICAgZm9yICg7ICFfc3RlcC5kb25lOyBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gX3N0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBpdGVyYWJsZSBvYmplY3QgcHJvdmlkZWQgbm8gaXRlcmF0b3IuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgZm9yICg7IG9sZEZpYmVyICE9PSBudWxsICYmICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RlcC5kb25lKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIzID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIzLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczMgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzMyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjQgPSB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyNCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyNC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXI0LmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyNCwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZDIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzNCA9IG5ld0lkeDsKICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudEZpcnN0Q2hpbGQgIT09IG51bGwgJiYgY3VycmVudEZpcnN0Q2hpbGQudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50Rmlyc3RDaGlsZCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQodGV4dENvbnRlbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gRnJhZ21lbnQyKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzLmNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgICAgIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhjaGlsZCwgZWxlbWVudCkgfHwgLy8gTGF6eSB0eXBlcyBzaG91bGQgcmVjb25jaWxlIHRoZWlyIHJlc29sdmVkIHR5cGUuCiAgICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgICAgIC8vIGl0IGRvZXNuJ3QgcmVzdXNwZW5kLiBTbyB3ZSBjYW4ndCBsZXQgdGhlIGNhbGwgYmVsb3cgc3VzcGVuZC4KICAgICAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY2hpbGQudHlwZSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2V4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGNoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2V4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChlbGVtZW50LnByb3BzLmNoaWxkcmVuLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcywgZWxlbWVudC5rZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkNCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIF9jcmVhdGVkNC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkNDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgcG9ydGFsLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gcG9ydGFsLmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gSG9zdFBvcnRhbCAmJiBjaGlsZC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA9PT0gcG9ydGFsLmNvbnRhaW5lckluZm8gJiYgY2hpbGQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uID09PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50ID0gdHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCAmJiBuZXdDaGlsZC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFICYmIG5ld0NoaWxkLmtleSA9PT0gbnVsbDsKICAgICAgICAgICAgaWYgKGlzVW5rZXllZFRvcExldmVsRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczIocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuQXJyYXkocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkl0ZXJhdG9yKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsICIiICsgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkRmliZXJzMjsKICAgICAgICB9CiAgICAgICAgdmFyIHJlY29uY2lsZUNoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKHRydWUpOwogICAgICAgIHZhciBtb3VudENoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKGZhbHNlKTsKICAgICAgICBmdW5jdGlvbiBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgIT09IGN1cnJlbnQyLmNoaWxkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVzdW1pbmcgd29yayBub3QgeWV0IGltcGxlbWVudGVkLiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudENoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZC5zaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnRDaGlsZC5zaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnNpYmxpbmcgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIGN1cnJlbnRDaGlsZC5wZW5kaW5nUHJvcHMpOwogICAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9CiAgICAgICAgICBuZXdDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRXb3JrSW5Qcm9ncmVzcyhjaGlsZCwgbGFuZXMpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZUN1cnNvciA9IGNyZWF0ZUN1cnNvcihudWxsKTsKICAgICAgICB2YXIgcmVuZGVyZXJTaWdpbDsKICAgICAgICB7CiAgICAgICAgICByZW5kZXJlclNpZ2lsID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hQcm92aWRlcihwcm92aWRlckZpYmVyLCBjb250ZXh0LCBuZXh0VmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcHVzaCh2YWx1ZUN1cnNvciwgY29udGV4dC5fY3VycmVudFZhbHVlLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gbmV4dFZhbHVlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gdm9pZCAwICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gbnVsbCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHJlbmRlcmVyU2lnaWwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJEZXRlY3RlZCBtdWx0aXBsZSByZW5kZXJlcnMgY29uY3VycmVudGx5IHJlbmRlcmluZyB0aGUgc2FtZSBjb250ZXh0IHByb3ZpZGVyLiBUaGlzIGlzIGN1cnJlbnRseSB1bnN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gcmVuZGVyZXJTaWdpbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BQcm92aWRlcihjb250ZXh0LCBwcm92aWRlckZpYmVyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gdmFsdWVDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHBvcCh2YWx1ZUN1cnNvciwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChwYXJlbnQsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHBhcmVudDsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBub2RlLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhub2RlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhbHRlcm5hdGUgIT09IG51bGwgJiYgIWlzU3Vic2V0T2ZMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobm9kZSAhPT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByb3BhZ2F0aW9uIHJvb3Qgd2hlbiBzY2hlZHVsaW5nIGNvbnRleHQgd29yay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgZmliZXIucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXh0RmliZXIgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBsaXN0ID0gZmliZXIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICBpZiAobGlzdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIHZhciBkZXBlbmRlbmN5ID0gbGlzdC5maXJzdENvbnRleHQ7CiAgICAgICAgICAgICAgd2hpbGUgKGRlcGVuZGVuY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChkZXBlbmRlbmN5LmNvbnRleHQgPT09IGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgc2hhcmVkUXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKGZpYmVyLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgbGlzdC5sYW5lcyA9IG1lcmdlTGFuZXMobGlzdC5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXBlbmRlbmN5ID0gZGVwZW5kZW5jeS5uZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnR5cGUgPT09IHdvcmtJblByb2dyZXNzMi50eXBlID8gbnVsbCA6IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpYmVyLnRhZyA9PT0gRGVoeWRyYXRlZEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudFN1c3BlbnNlID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBqdXN0IGNhbWUgZnJvbSBhIHBhcmVudCBzbyB3ZSBtdXN0IGhhdmUgaGFkIGEgcGFyZW50LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZS5sYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50U3VzcGVuc2UubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9hbHRlcm5hdGUgPSBwYXJlbnRTdXNwZW5zZS5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKF9hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9hbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKF9hbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50U3VzcGVuc2UsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgd2hpbGUgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5leHRGaWJlciA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBuZXh0RmliZXIuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gc2libGluZzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IG5leHRGaWJlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB2YXIgZGVwZW5kZW5jaWVzID0gd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llczsKICAgICAgICAgIGlmIChkZXBlbmRlbmNpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBmaXJzdENvbnRleHQgPSBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIGlmIChmaXJzdENvbnRleHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKGRlcGVuZGVuY2llcy5sYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYWRDb250ZXh0KGNvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYpIHsKICAgICAgICAgICAgICBlcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgIGlmIChsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPT09IGNvbnRleHQpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY29udGV4dEl0ZW0gPSB7CiAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICBtZW1vaXplZFZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChsYXN0Q29udGV4dERlcGVuZGVuY3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGNvbnRleHRJdGVtOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyLmRlcGVuZGVuY2llcyA9IHsKICAgICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjb250ZXh0SXRlbQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbGFzdENvbnRleHREZXBlbmRlbmN5Lm5leHQgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgY29uY3VycmVudFF1ZXVlcyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcyA9IFtxdWV1ZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzLnB1c2gocXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25jdXJyZW50UXVldWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gY29uY3VycmVudFF1ZXVlc1tpXTsKICAgICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkVXBkYXRlID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIGZpcnN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIHZhciBsYXN0UGVuZGluZ1VwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAobGFzdFBlbmRpbmdVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0UGVuZGluZ1VwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIGxhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBmaXJzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlQW5kRWFnZXJseUJhaWxvdXQoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSkgewogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVuc2FmZV9tYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdCA9IG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290OwogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KHNvdXJjZUZpYmVyLCBsYW5lKSB7CiAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoc291cmNlRmliZXIubGFuZXMsIGxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlID09PSBudWxsICYmIChzb3VyY2VGaWJlci5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IHNvdXJjZUZpYmVyOwogICAgICAgICAgdmFyIHBhcmVudCA9IHNvdXJjZUZpYmVyLnJldHVybjsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcGFyZW50LmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudC5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgYWx0ZXJuYXRlID0gcGFyZW50LmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKChwYXJlbnQuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHZhciByb290MyA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFVwZGF0ZVN0YXRlID0gMDsKICAgICAgICB2YXIgUmVwbGFjZVN0YXRlID0gMTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGUgPSAyOwogICAgICAgIHZhciBDYXB0dXJlVXBkYXRlID0gMzsKICAgICAgICB2YXIgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZTsKICAgICAgICB2YXIgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemVVcGRhdGVRdWV1ZShmaWJlcikgewogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBiYXNlU3RhdGU6IGZpYmVyLm1lbW9pemVkU3RhdGUsCiAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIHNoYXJlZDogewogICAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWZmZWN0czogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY2xvbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGV2ZW50VGltZSwKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgdGFnOiBVcGRhdGVTdGF0ZSwKICAgICAgICAgICAgcGF5bG9hZDogbnVsbCwKICAgICAgICAgICAgY2FsbGJhY2s6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID09PSBzaGFyZWRRdWV1ZSAmJiAhZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSkgewogICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgKHNldFN0YXRlLCByZXBsYWNlU3RhdGUsIG9yIGZvcmNlVXBkYXRlKSB3YXMgc2NoZWR1bGVkIGZyb20gaW5zaWRlIGFuIHVwZGF0ZSBmdW5jdGlvbi4gVXBkYXRlIGZ1bmN0aW9ucyBzaG91bGQgYmUgcHVyZSwgd2l0aCB6ZXJvIHNpZGUtZWZmZWN0cy4gQ29uc2lkZXIgdXNpbmcgY29tcG9uZW50RGlkVXBkYXRlIG9yIGEgY2FsbGJhY2suIik7CiAgICAgICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoKSkgewogICAgICAgICAgICB2YXIgcGVuZGluZyA9IHNoYXJlZFF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgIHJldHVybiB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHNoYXJlZFF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBzaGFyZWRRdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgc2hhcmVkUXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGNhcHR1cmVkVXBkYXRlKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICB2YXIgbmV3Rmlyc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdMYXN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChmaXJzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZS5ldmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlLmxhbmUsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbmV3Rmlyc3QsCiAgICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbmV3TGFzdCwKICAgICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMsIGluc3RhbmNlKSB7CiAgICAgICAgICBzd2l0Y2ggKHVwZGF0ZS50YWcpIHsKICAgICAgICAgICAgY2FzZSBSZXBsYWNlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dFN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGF5bG9hZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENhcHR1cmVVcGRhdGU6IHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBVcGRhdGVTdGF0ZTogewogICAgICAgICAgICAgIHZhciBfcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRm9yY2VVcGRhdGU6IHsKICAgICAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgcHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHZhciBjdXJyZW50TGFzdEJhc2VVcGRhdGUgPSBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSAhPT0gbGFzdEJhc2VVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IHF1ZXVlLmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdGaXJzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3TGFzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlRXZlbnRUaW1lID0gdXBkYXRlLmV2ZW50VGltZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lczIsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBuZXdTdGF0ZSwgcHJvcHMsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHVwZGF0ZS5jYWxsYmFjazsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiAvLyBJZiB0aGUgdXBkYXRlIHdhcyBhbHJlYWR5IGNvbW1pdHRlZCwgd2Ugc2hvdWxkIG5vdCBxdWV1ZSBpdHMKICAgICAgICAgICAgICAgIC8vIGNhbGxiYWNrIGFnYWluLgogICAgICAgICAgICAgICAgdXBkYXRlLmxhbmUgIT09IE5vTGFuZSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3RzID0gcXVldWUuZWZmZWN0czsKICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZS5lZmZlY3RzID0gW3VwZGF0ZV07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cy5wdXNoKHVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIF9sYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgICAgICAgdmFyIF9maXJzdFBlbmRpbmdVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBudWxsOwogICAgICAgICAgICAgICAgICB1cGRhdGUgPSBfZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gbmV3Rmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuc2hhcmVkLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5ld0xhbmVzID0gbWVyZ2VMYW5lcyhuZXdMYW5lcywgaW50ZXJsZWF2ZWQubGFuZSk7CiAgICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKG5ld0xhbmVzKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbmV3TGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYXJndW1lbnQgcGFzc2VkIGFzIGNhbGxiYWNrLiBFeHBlY3RlZCBhIGZ1bmN0aW9uLiBJbnN0ZWFkICIgKyAoInJlY2VpdmVkOiAiICsgY2FsbGJhY2spKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrLmNhbGwoY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCkgewogICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHsKICAgICAgICAgIHJldHVybiBoYXNGb3JjZVVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFF1ZXVlLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIGVmZmVjdHMgPSBmaW5pc2hlZFF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICBmaW5pc2hlZFF1ZXVlLmVmZmVjdHMgPSBudWxsOwogICAgICAgICAgaWYgKGVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGVmZmVjdHNbaV07CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZWZmZWN0LmNhbGxiYWNrOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZWZmZWN0LmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTk9fQ09OVEVYVCA9IHt9OwogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IkMSA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgY29udGV4dEZpYmVyU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVkQ29udGV4dChjKSB7CiAgICAgICAgICBpZiAoYyA9PT0gTk9fQ09OVEVYVCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRhaW5lcigpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gcm9vdEluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRhaW5lcihmaWJlciwgbmV4dFJvb3RJbnN0YW5jZSkgewogICAgICAgICAgcHVzaChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIE5PX0NPTlRFWFQsIGZpYmVyKTsKICAgICAgICAgIHZhciBuZXh0Um9vdENvbnRleHQgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIG5leHRSb290Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGFpbmVyKGZpYmVyKSB7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgcG9wKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RDb250ZXh0KCkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBnZXRDaGlsZEhvc3RDb250ZXh0KGNvbnRleHQsIGZpYmVyLnR5cGUpOwogICAgICAgICAgaWYgKGNvbnRleHQgPT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgaWYgKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBEZWZhdWx0U3VzcGVuc2VDb250ZXh0ID0gMDsKICAgICAgICB2YXIgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgPSAxOwogICAgICAgIHZhciBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQgPSAxOwogICAgICAgIHZhciBGb3JjZVN1c3BlbnNlRmFsbGJhY2sgPSAyOwogICAgICAgIHZhciBzdXNwZW5zZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKERlZmF1bHRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgIGZ1bmN0aW9uIGhhc1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBmbGFnKSB7CiAgICAgICAgICByZXR1cm4gKHBhcmVudENvbnRleHQgJiBmbGFnKSAhPT0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzaGFsbG93Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayB8IHNoYWxsb3dDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIHN1YnRyZWVDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCB8IHN1YnRyZWVDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3VzcGVuc2VDb250ZXh0KGZpYmVyLCBuZXdDb250ZXh0KSB7CiAgICAgICAgICBwdXNoKHN1c3BlbnNlU3RhY2tDdXJzb3IsIG5ld0NvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wU3VzcGVuc2VDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICBwb3Aoc3VzcGVuc2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDYXB0dXJlU3VzcGVuc2Uod29ya0luUHJvZ3Jlc3MyLCBoYXNJbnZpc2libGVQYXJlbnQpIHsKICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXh0U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kRmlyc3RTdXNwZW5kZWQocm93KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJvdzsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoZGVoeWRyYXRlZCA9PT0gbnVsbCB8fCBpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKGRlaHlkcmF0ZWQpIHx8IGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGRlaHlkcmF0ZWQpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50ICYmIC8vIHJldmVhbE9yZGVyIHVuZGVmaW5lZCBjYW4ndCBiZSB0cnVzdGVkIGJlY2F1c2UgaXQgZG9uJ3QKICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB3aGV0aGVyIGl0IHN1c3BlbmRlZCBvciBub3QuCiAgICAgICAgICAgIG5vZGUubWVtb2l6ZWRQcm9wcy5yZXZlYWxPcmRlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmQgPSAobm9kZS5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcm93KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gcm93KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEhhc0VmZmVjdCA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5zZXJ0aW9uID0gKAogICAgICAgICAgLyogICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgTGF5b3V0ID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlJDEgPSAoCiAgICAgICAgICAvKiAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NTb3VyY2VzID0gW107CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzc1ZlcnNpb25zKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzc1NvdXJjZXNbaV07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtdXRhYmxlU291cmNlLl93b3JrSW5Qcm9ncmVzc1ZlcnNpb25QcmltYXJ5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTXV0YWJsZVNvdXJjZUZvckh5ZHJhdGlvbihyb290MywgbXV0YWJsZVNvdXJjZSkgewogICAgICAgICAgdmFyIGdldFZlcnNpb24gPSBtdXRhYmxlU291cmNlLl9nZXRWZXJzaW9uOwogICAgICAgICAgdmFyIHZlcnNpb24yID0gZ2V0VmVyc2lvbihtdXRhYmxlU291cmNlLl9zb3VyY2UpOwogICAgICAgICAgaWYgKHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb24yXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEucHVzaChtdXRhYmxlU291cmNlLCB2ZXJzaW9uMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3Q7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBnbG9iYWxDbGllbnRJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBSRV9SRU5ERVJfTElNSVQgPSAyNTsKICAgICAgICB2YXIgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgIHZhciBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50SG9va1R5cGVzRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9va05hbWUgPSBjdXJyZW50SG9va05hbWVJbkRldjsKICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IFtob29rTmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzRGV2LnB1c2goaG9va05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldisrOwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXZbaG9va1R5cGVzVXBkYXRlSW5kZXhEZXZdICE9PSBob29rTmFtZSkgewogICAgICAgICAgICAgICAgd2Fybk9uSG9va01pc21hdGNoSW5EZXYoaG9va05hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkZXBzICE9PSB2b2lkIDAgJiYgZGVwcyAhPT0gbnVsbCAmJiAhaXNBcnJheShkZXBzKSkgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IHRoYXQgaXMgbm90IGFuIGFycmF5IChpbnN0ZWFkLCByZWNlaXZlZCBgJXNgKS4gV2hlbiBzcGVjaWZpZWQsIHRoZSBmaW5hbCBhcmd1bWVudCBtdXN0IGJlIGFuIGFycmF5LiIsIGN1cnJlbnRIb29rTmFtZUluRGV2LCB0eXBlb2YgZGVwcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uSG9va01pc21hdGNoSW5EZXYoY3VycmVudEhvb2tOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxKTsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFibGUgPSAiIjsKICAgICAgICAgICAgICAgIHZhciBzZWNvbmRDb2x1bW5TdGFydCA9IDMwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gaG9va1R5cGVzVXBkYXRlSW5kZXhEZXY7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgb2xkSG9va05hbWUgPSBob29rVHlwZXNEZXZbaV07CiAgICAgICAgICAgICAgICAgIHZhciBuZXdIb29rTmFtZSA9IGkgPT09IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID8gY3VycmVudEhvb2tOYW1lIDogb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHZhciByb3cgPSBpICsgMSArICIuICIgKyBvbGRIb29rTmFtZTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdy5sZW5ndGggPCBzZWNvbmRDb2x1bW5TdGFydCkgewogICAgICAgICAgICAgICAgICAgIHJvdyArPSAiICI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm93ICs9IG5ld0hvb2tOYW1lICsgIlxuIjsKICAgICAgICAgICAgICAgICAgdGFibGUgKz0gcm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGhhcyBkZXRlY3RlZCBhIGNoYW5nZSBpbiB0aGUgb3JkZXIgb2YgSG9va3MgY2FsbGVkIGJ5ICVzLiBUaGlzIHdpbGwgbGVhZCB0byBidWdzIGFuZCBlcnJvcnMgaWYgbm90IGZpeGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgcmVhZCB0aGUgUnVsZXMgb2YgSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ydWxlcy1vZi1ob29rc1xuXG4gICBQcmV2aW91cyByZW5kZXIgICAgICAgICAgICBOZXh0IHJlbmRlclxuICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4lcyAgIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXlxuIiwgY29tcG9uZW50TmFtZSwgdGFibGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd0ludmFsaWRIb29rRXJyb3IoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJldkRlcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IGR1cmluZyB0aGlzIHJlbmRlciwgYnV0IG5vdCBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4gRXZlbiB0aG91Z2ggdGhlIGZpbmFsIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBpdHMgdHlwZSBjYW5ub3QgY2hhbmdlIGJldHdlZW4gcmVuZGVycy4iLCBjdXJyZW50SG9va05hbWVJbkRldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmV4dERlcHMubGVuZ3RoICE9PSBwcmV2RGVwcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGZpbmFsIGFyZ3VtZW50IHBhc3NlZCB0byAlcyBjaGFuZ2VkIHNpemUgYmV0d2VlbiByZW5kZXJzLiBUaGUgb3JkZXIgYW5kIHNpemUgb2YgdGhpcyBhcnJheSBtdXN0IHJlbWFpbiBjb25zdGFudC5cblxuUHJldmlvdXM6ICVzXG5JbmNvbWluZzogJXMiLCBjdXJyZW50SG9va05hbWVJbkRldiwgIlsiICsgcHJldkRlcHMuam9pbigiLCAiKSArICJdIiwgIlsiICsgbmV4dERlcHMuam9pbigiLCAiKSArICJdIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJldkRlcHMubGVuZ3RoICYmIGkgPCBuZXh0RGVwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAob2JqZWN0SXMobmV4dERlcHNbaV0sIHByZXZEZXBzW2ldKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgc2Vjb25kQXJnLCBuZXh0UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHJlbmRlckxhbmVzID0gbmV4dFJlbmRlckxhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5fZGVidWdIb29rVHlwZXMgOiBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuID0gQ29tcG9uZW50KHByb3BzLCBzZWNvbmRBcmcpOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcykgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZSZVJlbmRlcnMgPSAwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgICAgIGlmIChudW1iZXJPZlJlUmVuZGVycyA+PSBSRV9SRU5ERVJfTElNSVQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG9vIG1hbnkgcmUtcmVuZGVycy4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgcmVuZGVycyB0byBwcmV2ZW50IGFuIGluZmluaXRlIGxvb3AuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bWJlck9mUmVSZW5kZXJzICs9IDE7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgICAgfSB3aGlsZSAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzKTsKICAgICAgICAgIH0KICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gaG9va1R5cGVzRGV2OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFJlbmRlclRvb0Zld0hvb2tzID0gY3VycmVudEhvb2sgIT09IG51bGwgJiYgY3VycmVudEhvb2submV4dCAhPT0gbnVsbDsKICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgKGN1cnJlbnQyLmZsYWdzICYgU3RhdGljTWFzaykgIT09ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTdGF0aWNNYXNrKSAmJiAvLyBEaXNhYmxlIHRoaXMgd2FybmluZyBpbiBsZWdhY3kgbW9kZSwgYmVjYXVzZSBsZWdhY3kgU3VzcGVuc2UgaXMgd2VpcmQKICAgICAgICAgICAgLy8gYW5kIGNyZWF0ZXMgZmFsc2UgcG9zaXRpdmVzLiBUbyBtYWtlIHRoaXMgd29yayBpbiBsZWdhY3kgbW9kZSwgd2UnZAogICAgICAgICAgICAvLyBuZWVkIHRvIG1hcmsgZmliZXJzIHRoYXQgY29tbWl0IGluIGFuIGluY29tcGxldGUgc3RhdGUsIHNvbWVob3cuIEZvcgogICAgICAgICAgICAvLyBub3cgSSdsbCBkaXNhYmxlIHRoZSB3YXJuaW5nIHRoYXQgbW9zdCBvZiB0aGUgYnVncyB0aGF0IHdvdWxkIHRyaWdnZXIKICAgICAgICAgICAgLy8gaXQgYXJlIGVpdGhlciBleGNsdXNpdmUgdG8gY29uY3VycmVudCBtb2RlIG9yIGV4aXN0IGluIGJvdGguCiAgICAgICAgICAgIChjdXJyZW50Mi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgUmVhY3QgZXJyb3I6IEV4cGVjdGVkIHN0YXRpYyBmbGFnIHdhcyBtaXNzaW5nLiBQbGVhc2Ugbm90aWZ5IHRoZSBSZWFjdCB0ZWFtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBpZiAoZGlkUmVuZGVyVG9vRmV3SG9va3MpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZW5kZXJlZCBmZXdlciBob29rcyB0aGFuIGV4cGVjdGVkLiBUaGlzIG1heSBiZSBjYXVzZWQgYnkgYW4gYWNjaWRlbnRhbCBlYXJseSByZXR1cm4gc3RhdGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RpZFJlbmRlcklkSG9vaygpIHsKICAgICAgICAgIHZhciBkaWRSZW5kZXJJZEhvb2sgPSBsb2NhbElkQ291bnRlciAhPT0gMDsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgIHJldHVybiBkaWRSZW5kZXJJZEhvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhaWxvdXRIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH4oTW91bnRQYXNzaXZlRGV2IHwgTW91bnRMYXlvdXREZXYgfCBQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudDIubGFuZXMgPSByZW1vdmVMYW5lcyhjdXJyZW50Mi5sYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhvb2tzQWZ0ZXJUaHJvdygpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBob29rID0gaG9vay5uZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHsKICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVN0YXRlOiBudWxsLAogICAgICAgICAgICBiYXNlUXVldWU6IG51bGwsCiAgICAgICAgICAgIHF1ZXVlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBob29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQgPSBob29rOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBjdXJyZW50SG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV4dFdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG5leHRDdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgbW9yZSBob29rcyB0aGFuIGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgICB2YXIgbmV3SG9vayA9IHsKICAgICAgICAgICAgICBtZW1vaXplZFN0YXRlOiBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudEhvb2suYmFzZVN0YXRlLAogICAgICAgICAgICAgIGJhc2VRdWV1ZTogY3VycmVudEhvb2suYmFzZVF1ZXVlLAogICAgICAgICAgICAgIHF1ZXVlOiBjdXJyZW50SG9vay5xdWV1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXdIb29rOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gbmV3SG9vazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGxhc3RFZmZlY3Q6IG51bGwsCiAgICAgICAgICAgIHN0b3JlczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFzaWNTdGF0ZVJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIgPyBhY3Rpb24oc3RhdGUpIDogYWN0aW9uOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIGluaXRpYWxTdGF0ZTsKICAgICAgICAgIGlmIChpbml0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlID0gaW5pdChpbml0aWFsQXJnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXRpYWxBcmc7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBob29rLmJhc2VTdGF0ZSA9IGluaXRpYWxTdGF0ZTsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICBkaXNwYXRjaDogbnVsbCwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkUmVkdWNlcjogcmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZQogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hSZWR1Y2VyQWN0aW9uLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgYmFzZVF1ZXVlID0gY3VycmVudDIuYmFzZVF1ZXVlOwogICAgICAgICAgdmFyIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgYmFzZUZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmdGaXJzdCA9IHBlbmRpbmdRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIGJhc2VRdWV1ZS5uZXh0ID0gcGVuZGluZ0ZpcnN0OwogICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZS5uZXh0ID0gYmFzZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIuYmFzZVF1ZXVlICE9PSBiYXNlUXVldWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBlcnJvcjogRXhwZWN0ZWQgd29yay1pbi1wcm9ncmVzcyBxdWV1ZSB0byBiZSBhIGNsb25lLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50Mi5iYXNlUXVldWUgPSBiYXNlUXVldWUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJhc2VRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3QgPSBiYXNlUXVldWUubmV4dDsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY3VycmVudDIuYmFzZVN0YXRlOwogICAgICAgICAgICB2YXIgbmV3QmFzZVN0YXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUxhc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHJlbmRlckxhbmVzLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbmV3QmFzZVF1ZXVlTGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBfY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlLmhhc0VhZ2VyU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSB1cGRhdGUuZWFnZXJTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHJlZHVjZXIobmV3U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwgJiYgdXBkYXRlICE9PSBmaXJzdCk7CiAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gbmV3QmFzZVF1ZXVlRmlyc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3QmFzZVN0YXRlOwogICAgICAgICAgICBob29rLmJhc2VRdWV1ZSA9IG5ld0Jhc2VRdWV1ZUxhc3Q7CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZExhbmUgPSBpbnRlcmxlYXZlZC5sYW5lOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGludGVybGVhdmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIGludGVybGVhdmVkID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaDsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICB2YXIgbGFzdFJlbmRlclBoYXNlVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChsYXN0UmVuZGVyUGhhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgIHZhciBmaXJzdFJlbmRlclBoYXNlVXBkYXRlID0gbGFzdFJlbmRlclBoYXNlVXBkYXRlLm5leHQ7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUpOwogICAgICAgICAgICBpZiAoIW9iamVjdElzKG5ld1N0YXRlLCBob29rLm1lbW9pemVkU3RhdGUpKSB7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtuZXdTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudE11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90OwogICAgICAgICAgdmFyIGlzSHlkcmF0aW5nMiA9IGdldElzSHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcyKSB7CiAgICAgICAgICAgIGlmIChnZXRTZXJ2ZXJTbmFwc2hvdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIGdldFNlcnZlclNuYXBzaG90LCB3aGljaCBpcyByZXF1aXJlZCBmb3Igc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFdpbGwgcmV2ZXJ0IHRvIGNsaWVudCByZW5kZXJpbmcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gZ2V0U2VydmVyU25hcHNob3QoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0U25hcHNob3QgIT09IGdldFNlcnZlclNuYXBzaG90KCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U2VydmVyU25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBhIHdvcmstaW4tcHJvZ3Jlc3Mgcm9vdC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpbnN0ID0gewogICAgICAgICAgICB2YWx1ZTogbmV4dFNuYXBzaG90LAogICAgICAgICAgICBnZXRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBpbnN0OwogICAgICAgICAgbW91bnRFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgIHZhciBjYWNoZWRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldlNuYXBzaG90ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHNuYXBzaG90Q2hhbmdlZCA9ICFvYmplY3RJcyhwcmV2U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICBpZiAoc25hcHNob3RDaGFuZ2VkKSB7CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gaG9vay5xdWV1ZTsKICAgICAgICAgIHVwZGF0ZUVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgIGlmIChpbnN0LmdldFNuYXBzaG90ICE9PSBnZXRTbmFwc2hvdCB8fCBzbmFwc2hvdENoYW5nZWQgfHwgLy8gQ2hlY2sgaWYgdGhlIHN1c2JjcmliZSBmdW5jdGlvbiBjaGFuZ2VkLiBXZSBjYW4gc2F2ZSBzb21lIG1lbW9yeSBieQogICAgICAgICAgLy8gY2hlY2tpbmcgd2hldGhlciB3ZSBzY2hlZHVsZWQgYSBzdWJzY3JpcHRpb24gZWZmZWN0IGFib3ZlLgogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzSG9vay5tZW1vaXplZFN0YXRlLnRhZyAmIEhhc0VmZmVjdCkgewogICAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgcmVuZGVyZWRTbmFwc2hvdCkgewogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICAgIHZhciBjaGVjayA9IHsKICAgICAgICAgICAgZ2V0U25hcHNob3QsCiAgICAgICAgICAgIHZhbHVlOiByZW5kZXJlZFNuYXBzaG90CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHN0b3JlcyA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlczsKICAgICAgICAgICAgaWYgKHN0b3JlcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RvcmVzLnB1c2goY2hlY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0b3JlSW5zdGFuY2UoZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpIHsKICAgICAgICAgIGluc3QudmFsdWUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICBpbnN0LmdldFNuYXBzaG90ID0gZ2V0U25hcHNob3Q7CiAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdWJzY3JpYmVUb1N0b3JlKGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHZhciBoYW5kbGVTdG9yZUNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlKGhhbmRsZVN0b3JlQ2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgICB2YXIgbGF0ZXN0R2V0U25hcHNob3QgPSBpbnN0LmdldFNuYXBzaG90OwogICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGluc3QudmFsdWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbGF0ZXN0R2V0U25hcHNob3QoKTsKICAgICAgICAgICAgcmV0dXJuICFvYmplY3RJcyhwcmV2VmFsdWUsIG5leHRWYWx1ZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcikgewogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5pdGlhbFN0YXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXRpYWxTdGF0ZSgpOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGU7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IGJhc2ljU3RhdGVSZWR1Y2VyLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRTdGF0ZTogaW5pdGlhbFN0YXRlCiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFNldFN0YXRlLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEVmZmVjdCh0YWcsIGNyZWF0ZSwgZGVzdHJveSwgZGVwcykgewogICAgICAgICAgdmFyIGVmZmVjdCA9IHsKICAgICAgICAgICAgdGFnLAogICAgICAgICAgICBjcmVhdGUsCiAgICAgICAgICAgIGRlc3Ryb3ksCiAgICAgICAgICAgIGRlcHMsCiAgICAgICAgICAgIC8vIENpcmN1bGFyCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgIGxhc3RFZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgICBlZmZlY3QubmV4dCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlZmZlY3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50UmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX3JlZjIgPSB7CiAgICAgICAgICAgICAgY3VycmVudDogaW5pdGlhbFZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IF9yZWYyOwogICAgICAgICAgICByZXR1cm4gX3JlZjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICByZXR1cm4gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgdm9pZCAwLCBuZXh0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBkZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2RWZmZWN0ID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgZGVzdHJveSA9IHByZXZFZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldkVmZmVjdC5kZXBzOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChNb3VudFBhc3NpdmVEZXYgfCBQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChQYXNzaXZlLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0KGNyZWF0ZSwgcmVmKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgcmVmQ2FsbGJhY2sgPSByZWY7CiAgICAgICAgICAgIHZhciBfaW5zdCA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZDYWxsYmFjayhfaW5zdCk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVmICE9PSBudWxsICYmIHJlZiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciByZWZPYmplY3QgPSByZWY7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXJlZk9iamVjdC5oYXNPd25Qcm9wZXJ0eSgiY3VycmVudCIpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIGZpcnN0IGFyZ3VtZW50IHRvIGVpdGhlciBiZSBhIHJlZiBjYWxsYmFjayBvciBSZWFjdC5jcmVhdGVSZWYoKSBvYmplY3QuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsICJhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMocmVmT2JqZWN0KS5qb2luKCIsICIpICsgIn0iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0MiA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IF9pbnN0MjsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJlZk9iamVjdC5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3JlYXRlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBzZWNvbmQgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBoYW5kbGUuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNyZWF0ZSAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUgOiAibnVsbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0LmJpbmQobnVsbCwgY3JlYXRlLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICB9CiAgICAgICAgdmFyIHVwZGF0ZURlYnVnVmFsdWUgPSBtb3VudERlYnVnVmFsdWU7CiAgICAgICAgZnVuY3Rpb24gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtuZXh0VmFsdWUsIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBuZXh0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW8obmV4dENyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldlN0YXRlWzFdOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHJlc29sdmVkQ3VycmVudEhvb2sgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSByZXNvbHZlZEN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIHNob3VsZERlZmVyVmFsdWUgPSAhaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMocmVuZGVyTGFuZXMpOwogICAgICAgICAgaWYgKHNob3VsZERlZmVyVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyh2YWx1ZSwgcHJldlZhbHVlKSkgewogICAgICAgICAgICAgIHZhciBkZWZlcnJlZExhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGRlZmVycmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJldlZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVN0YXRlKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzZXRQZW5kaW5nLCBjYWxsYmFjaywgb3B0aW9uczIpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoaGlnaGVyRXZlbnRQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5LCBDb250aW51b3VzRXZlbnRQcmlvcml0eSkpOwogICAgICAgICAgc2V0UGVuZGluZyh0cnVlKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0UGVuZGluZyhmYWxzZSk7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX21vdW50U3RhdGUgPSBtb3VudFN0YXRlKGZhbHNlKSwgaXNQZW5kaW5nID0gX21vdW50U3RhdGVbMF0sIHNldFBlbmRpbmcgPSBfbW91bnRTdGF0ZVsxXTsKICAgICAgICAgIHZhciBzdGFydCA9IHN0YXJ0VHJhbnNpdGlvbi5iaW5kKG51bGwsIHNldFBlbmRpbmcpOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gc3RhcnQ7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3JlcmVuZGVyU3RhdGUgPSByZXJlbmRlclN0YXRlKCksIGlzUGVuZGluZyA9IF9yZXJlbmRlclN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIHZhciBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSByb290My5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdmFyIGlkOwogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgIHZhciBsb2NhbElkID0gbG9jYWxJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWYgKGxvY2FsSWQgPiAwKSB7CiAgICAgICAgICAgICAgaWQgKz0gIkgiICsgbG9jYWxJZC50b1N0cmluZygzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgKz0gIjoiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGdsb2JhbENsaWVudElkID0gZ2xvYmFsQ2xpZW50SWRDb3VudGVyKys7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJyIiArIGdsb2JhbENsaWVudElkLnRvU3RyaW5nKDMyKSArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGlkOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaWQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoUmVkdWNlckFjdGlvbihmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hTZXRTdGF0ZShmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoZmliZXIubGFuZXMgPT09IE5vTGFuZXMgJiYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCBhbHRlcm5hdGUubGFuZXMgPT09IE5vTGFuZXMpKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RSZW5kZXJlZFJlZHVjZXIgPSBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyOwogICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcXVldWUubGFzdFJlbmRlcmVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBlYWdlclN0YXRlID0gbGFzdFJlbmRlcmVkUmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmVhZ2VyU3RhdGUgPSBlYWdlclN0YXRlOwogICAgICAgICAgICAgICAgICBpZiAob2JqZWN0SXMoZWFnZXJTdGF0ZSwgY3VycmVudFN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICByZXR1cm4gZmliZXIgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgdmFyIHBlbmRpbmcgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSkgewogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBxdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENvbnRleHRPbmx5RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIHJlYWRDb250ZXh0LAogICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUNvbnRleHQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZHVjZXI6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlYnVnVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgfTsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybkludmFsaWRDb250ZXh0QWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkludmFsaWRIb29rQWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbm93JDEgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBjb21taXRUaW1lID0gMDsKICAgICAgICB2YXIgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlSXNOZXN0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzeW5jTmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gbmVzdGVkVXBkYXRlU2NoZWR1bGVkOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tbWl0VGltZSgpIHsKICAgICAgICAgIHJldHVybiBjb21taXRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRDb21taXRUaW1lKCkgewogICAgICAgICAgY29tbWl0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UHJvZmlsZXJUaW1lcihmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgaWYgKGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA8IDApIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZmliZXIsIG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgIGlmIChwcm9maWxlclN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwcm9maWxlclN0YXJ0VGltZTsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgICAgZmliZXIuc2VsZkJhc2VEdXJhdGlvbiA9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAobGF5b3V0RWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIGxheW91dEVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHBhc3NpdmVFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydExheW91dEVmZmVjdFRpbWVyKCkgewogICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXJBY3R1YWxEdXJhdGlvbihmaWJlcikgewogICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIGJhc2VQcm9wcykgewogICAgICAgICAgaWYgKENvbXBvbmVudCAmJiBDb21wb25lbnQuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbih7fSwgYmFzZVByb3BzKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2VQcm9wczsKICAgICAgICB9CiAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suaGFzKGtleSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suYWRkKGtleSk7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZSwgcGFydGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9wcm9jZXNzQ2hpbGRDb250ZXh0IGlzIG5vdCBhdmFpbGFibGUgaW4gUmVhY3QgMTYrLiBUaGlzIGxpa2VseSBtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgYSBSZWFjdCAxNSB0cmVlIGluc2lkZSBhIFJlYWN0IDE2IHRyZWUgdXNpbmcgdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIsIHdoaWNoIGlzbid0IHN1cHBvcnRlZC4gVHJ5IHRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoIHRvIFJlYWN0RE9NLmNyZWF0ZVBvcnRhbCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmZyZWV6ZShmYWtlSW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVtb2l6ZWRTdGF0ZSA9IHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCA/IHByZXZTdGF0ZSA6IGFzc2lnbih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5sYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjbGFzc0NvbXBvbmVudFVwZGF0ZXIgPSB7CiAgICAgICAgICBpc01vdW50ZWQsCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldChpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gUmVwbGFjZVN0YXRlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihpbnN0LCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzLnNob3VsZENvbXBvbmVudFVwZGF0ZSgpOiBSZXR1cm5lZCB1bmRlZmluZWQgaW5zdGVhZCBvZiBhIGJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbChvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgdmFyIHJlbmRlclByZXNlbnQgPSBpbnN0YW5jZS5yZW5kZXI7CiAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiB0eXBlb2YgY3Rvci5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IGRpZCB5b3UgYWNjaWRlbnRhbGx5IHJldHVybiBhbiBvYmplY3QgZnJvbSB0aGUgY29uc3RydWN0b3I/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgJiYgIWluc3RhbmNlLmdldEluaXRpYWxTdGF0ZS5pc1JlYWN0Q2xhc3NBcHByb3ZlZCAmJiAhaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0SW5pdGlhbFN0YXRlIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldERlZmF1bHRQcm9wcyAmJiAhaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgZGVmYXVsdFByb3BzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BUeXBlcykgewogICAgICAgICAgICAgIGVycm9yKCJwcm9wVHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgcHJvcFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdG9yLmNoaWxkQ29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNoaWxkQ29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSBpbnN0ZWFkXG5cbi5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgd2l0aCBzdGF0aWMgY29udGV4dFR5cGUgaW5zdGVhZC5cblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlICYmIGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWNsYXJlcyBib3RoIGNvbnRleHRUeXBlcyBhbmQgY29udGV4dFR5cGUgc3RhdGljIHByb3BlcnRpZXMuIFRoZSBsZWdhY3kgY29udGV4dFR5cGVzIHByb3BlcnR5IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRTaG91bGRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRTaG91bGRVcGRhdGUoKS4gRGlkIHlvdSBtZWFuIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpPyBUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ICYmIHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkuIHNob3VsZENvbXBvbmVudFVwZGF0ZSBzaG91bGQgbm90IGJlIHVzZWQgd2hlbiBleHRlbmRpbmcgUmVhY3QuUHVyZUNvbXBvbmVudC4gUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJBIHB1cmUgY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkVW5tb3VudCgpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFVubW91bnQoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFJlY2VpdmVQcm9wcygpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBJZiB5b3UgbWVhbnQgdG8gdXBkYXRlIHRoZSBzdGF0ZSBpbiByZXNwb25zZSB0byBjaGFuZ2luZyBwcm9wcywgdXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgcnVuIHNpZGUtZWZmZWN0cyBvciBtdXRhdGlvbnMgYWZ0ZXIgUmVhY3QgaGFzIHVwZGF0ZWQgdGhlIFVJLCB1c2UgY29tcG9uZW50RGlkVXBkYXRlKCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTXV0YXRlZFByb3BzID0gaW5zdGFuY2UucHJvcHMgIT09IG5ld1Byb3BzOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IHZvaWQgMCAmJiBoYXNNdXRhdGVkUHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICFkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgc2hvdWxkIGJlIHVzZWQgd2l0aCBjb21wb25lbnREaWRVcGRhdGUoKS4gVGhpcyBjb21wb25lbnQgZGVmaW5lcyBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIG9ubHkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBpcyBkZWZpbmVkIGFzIGEgc3RhdGljIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGFuIGluc3RhbmNlIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChfc3RhdGUgJiYgKHR5cGVvZiBfc3RhdGUgIT09ICJvYmplY3QiIHx8IGlzQXJyYXkoX3N0YXRlKSkpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuc3RhdGU6IG11c3QgYmUgc2V0IHRvIGFuIG9iamVjdCBvciBudWxsIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldENoaWxkQ29udGV4dCgpOiBjaGlsZENvbnRleHRUeXBlcyBtdXN0IGJlIGRlZmluZWQgaW4gb3JkZXIgdG8gdXNlIGdldENoaWxkQ29udGV4dCgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICBpbnN0YW5jZS51cGRhdGVyID0gY2xhc3NDb21wb25lbnRVcGRhdGVyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgc2V0KGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgewogICAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEluc3RhbmNlID0gZmFrZUludGVybmFsSW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBwcm9wcykgewogICAgICAgICAgdmFyIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoImNvbnRleHRUeXBlIiBpbiBjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSAoCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBudWxsIGZvciBjb25kaXRpb25hbCBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgY29udGV4dFR5cGUgPT09IG51bGwgfHwgY29udGV4dFR5cGUgIT09IHZvaWQgMCAmJiBjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFICYmIGNvbnRleHRUeXBlLl9jb250ZXh0ID09PSB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCAmJiAhZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9ICIiOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHRUeXBlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byB1bmRlZmluZWQuIFRoaXMgY2FuIGJlIGNhdXNlZCBieSBhIHR5cG8gb3IgYnkgbWl4aW5nIHVwIG5hbWVkIGFuZCBkZWZhdWx0IGltcG9ydHMuIFRoaXMgY2FuIGFsc28gaGFwcGVuIGR1ZSB0byBhIGNpcmN1bGFyIGRlcGVuZGVuY3ksIHNvIHRyeSBtb3ZpbmcgdGhlIGNyZWF0ZUNvbnRleHQoKSBjYWxsIHRvIGEgc2VwYXJhdGUgZmlsZS4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dFR5cGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYSAiICsgdHlwZW9mIGNvbnRleHRUeXBlICsgIi4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Qcm92aWRlciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLl9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuQ29uc3VtZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY29udGV4dFR5cGUpLmpvaW4oIiwgIikgKyAifS4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlZmluZXMgYW4gaW52YWxpZCBjb250ZXh0VHlwZS4gY29udGV4dFR5cGUgc2hvdWxkIHBvaW50IHRvIHRoZSBDb250ZXh0IG9iamVjdCByZXR1cm5lZCBieSBSZWFjdC5jcmVhdGVDb250ZXh0KCkuJXMiLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIsIGFkZGVuZHVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IGN0b3IuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGNvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgICAgY29udGV4dCA9IGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgOiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGUgIT09IG51bGwgJiYgaW5zdGFuY2Uuc3RhdGUgIT09IHZvaWQgMCA/IGluc3RhbmNlLnN0YXRlIDogbnVsbDsKICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBzdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCJgJXNgIHVzZXMgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYnV0IGl0cyBpbml0aWFsIHN0YXRlIGlzICVzLiBUaGlzIGlzIG5vdCByZWNvbW1lbmRlZC4gSW5zdGVhZCwgZGVmaW5lIHRoZSBpbml0aWFsIHN0YXRlIGJ5IGFzc2lnbmluZyBhbiBvYmplY3QgdG8gYHRoaXMuc3RhdGVgIGluIHRoZSBjb25zdHJ1Y3RvciBvZiBgJXNgLiBUaGlzIGVuc3VyZXMgdGhhdCBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBhcmd1bWVudHMgaGF2ZSBhIGNvbnNpc3RlbnQgc2hhcGUuIiwgY29tcG9uZW50TmFtZSwgaW5zdGFuY2Uuc3RhdGUgPT09IG51bGwgPyAibnVsbCIgOiAidW5kZWZpbmVkIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbE1vdW50TmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxVcGRhdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gImNvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJjb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICB2YXIgbmV3QXBpTmFtZSA9IHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiA/ICJnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSIgOiAiZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuaGFzKF9jb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmFkZChfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbnNhZmUgbGVnYWN5IGxpZmVjeWNsZXMgd2lsbCBub3QgYmUgY2FsbGVkIGZvciBjb21wb25lbnRzIHVzaW5nIG5ldyBjb21wb25lbnQgQVBJcy5cblxuJXMgdXNlcyAlcyBidXQgYWxzbyBjb250YWlucyB0aGUgZm9sbG93aW5nIGxlZ2FjeSBsaWZlY3ljbGVzOiVzJXMlc1xuXG5UaGUgYWJvdmUgbGlmZWN5Y2xlcyBzaG91bGQgYmUgcmVtb3ZlZC4gTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTpcbmh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMiLCBfY29tcG9uZW50TmFtZSwgbmV3QXBpTmFtZSwgZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsTW91bnROYW1lIDogIiIsIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lIDogIiIsIGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxVcGRhdGVOYW1lIDogIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzTGVnYWN5Q29udGV4dENvbnN1bWVyKSB7CiAgICAgICAgICAgIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU3RhdGUgIT09IGluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbE1vdW50KCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IG9sZFN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5yZWZzID0ge307CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBJdCBpcyBub3QgcmVjb21tZW5kZWQgdG8gYXNzaWduIHByb3BzIGRpcmVjdGx5IHRvIHN0YXRlIGJlY2F1c2UgdXBkYXRlcyB0byBwcm9wcyB3b24ndCBiZSByZWZsZWN0ZWQgaW4gc3RhdGUuIEluIG1vc3QgY2FzZXMsIGl0IGlzIGJldHRlciB0byB1c2UgcHJvcHMgZGlyZWN0bHkuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3Mod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MyID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3MyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID8gdW5yZXNvbHZlZE9sZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyh3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50Mi5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB8fCAvLyBUT0RPOiBJbiBzb21lIGNhc2VzLCB3ZSdsbCBlbmQgdXAgY2hlY2tpbmcgaWYgY29udGV4dCBoYXMgY2hhbmdlZCB0d2ljZSwKICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgIC8vIGJ1dCBJJ20gbG9hdGggdG8gcmVmYWN0b3IgdGhpcyBmdW5jdGlvbi4gVGhpcyBvbmx5IGhhcHBlbnMgZm9yIG1lbW9pemVkCiAgICAgICAgICAvLyBjb21wb25lbnRzIHNvIGl0J3Mgbm90IHRoYXQgY29tbW9uLgogICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDIubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgc3RhY2s6IGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChzb3VyY2UpLAogICAgICAgICAgICBkaWdlc3Q6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWUodmFsdWUsIGRpZ2VzdCwgc3RhY2spIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICBkaWdlc3Q6IGRpZ2VzdCAhPSBudWxsID8gZGlnZXN0IDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2dDYXB0dXJlZEVycm9yKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGxvZ0Vycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiI7CiAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU1lc3NhZ2U7CiAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuVmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Vycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiUmVhY3Qgd2lsbCB0cnkgdG8gcmVjcmVhdGUgdGhpcyBjb21wb25lbnQgdHJlZSBmcm9tIHNjcmF0Y2ggIiArICgidXNpbmcgdGhlIGVycm9yIGJvdW5kYXJ5IHlvdSBwcm92aWRlZCwgIiArIGVycm9yQm91bmRhcnlOYW1lICsgIi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oY29tYmluZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCQxID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG9uVW5jYXVnaHRFcnJvcihlcnJvcjIpOwogICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPSBmaWJlci50eXBlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvcjsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IkMSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IkMTIsIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUoZmliZXIubGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogRXJyb3IgYm91bmRhcmllcyBzaG91bGQgaW1wbGVtZW50IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpLiBJbiB0aGF0IG1ldGhvZCwgcmV0dXJuIGEgc3RhdGUgdXBkYXRlIHRvIGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBvciBmYWxsYmFjayBVSS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwJDEoKTsKICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICBpZiAodGhyZWFkSURzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgdGhyZWFkSURzLmFkZChsYW5lcyk7CiAgICAgICAgICAgIHZhciBwaW5nID0gcGluZ1N1c3BlbmRlZFJvb3QuYmluZChudWxsLCByb290Mywgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZS50aGVuKHBpbmcsIHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlID0gdXBkYXRlUXVldWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgdmFyIHRhZyA9IHNvdXJjZUZpYmVyLnRhZzsKICAgICAgICAgIGlmICgoc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmICh0YWcgPT09IEZ1bmN0aW9uQ29tcG9uZW50IHx8IHRhZyA9PT0gRm9yd2FyZFJlZiB8fCB0YWcgPT09IFNpbXBsZU1lbW9Db21wb25lbnQpKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gY3VycmVudFNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gY3VycmVudFNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gY3VycmVudFNvdXJjZS5sYW5lczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgJiYgc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgaWYgKChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSA9PT0gcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2U7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgJj0gfihMaWZlY3ljbGVFZmZlY3RNYXNrIHwgSW5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlRmliZXIgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZUZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnRhZyA9IEluY29tcGxldGVDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlVXBkYXRlKHNvdXJjZUZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmxhbmVzID0gcm9vdFJlbmRlckxhbmVzOwogICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93RXhjZXB0aW9uKHJvb3QzLCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHZhbHVlLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHZhbHVlOwogICAgICAgICAgICByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU3luY0xhbmUocm9vdFJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHVuY2F1Z2h0U3VzcGVuc2VFcnJvciA9IG5ldyBFcnJvcigiQSBjb21wb25lbnQgc3VzcGVuZGVkIHdoaWxlIHJlc3BvbmRpbmcgdG8gc3luY2hyb25vdXMgaW5wdXQuIFRoaXMgd2lsbCBjYXVzZSB0aGUgVUkgdG8gYmUgcmVwbGFjZWQgd2l0aCBhIGxvYWRpbmcgaW5kaWNhdG9yLiBUbyBmaXgsIHVwZGF0ZXMgdGhhdCBzdXNwZW5kIHNob3VsZCBiZSB3cmFwcGVkIHdpdGggc3RhcnRUcmFuc2l0aW9uLiIpOwogICAgICAgICAgICAgIHZhbHVlID0gdW5jYXVnaHRTdXNwZW5zZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIHZhciBfc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICBpZiAoX3N1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICgoX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShfc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IoY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICByZW5kZXJEaWRFcnJvcih2YWx1ZSk7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfZXJyb3JJbmZvLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MgJiYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgdmFyIF9sYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIF91cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgZXJyb3JJbmZvLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF91cGRhdGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAod29ya0luUHJvZ3Jlc3MyICE9PSBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuZGVkQ2FjaGUoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEJhZENsYXNzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXI7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXIgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDIuY2hpbGQsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IENvbXBvbmVudC5yZW5kZXI7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpICYmIENvbXBvbmVudC5jb21wYXJlID09PSBudWxsICYmIC8vIFNpbXBsZU1lbW9Db21wb25lbnQgY29kZXBhdGggZG9lc24ndCByZXNvbHZlIG91dGVyIHByb3BzIGVpdGhlci4KICAgICAgICAgICAgQ29tcG9uZW50LmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gU2ltcGxlTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVzb2x2ZWRUeXBlLCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gbWVtbyBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKENvbXBvbmVudC50eXBlLCBudWxsLCBuZXh0UHJvcHMsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBfaW5uZXJQcm9wVHlwZXMgPSBfdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChfaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgIF9pbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoX3R5cGUpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnRDaGlsZC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgY29tcGFyZSA9IENvbXBvbmVudC5jb21wYXJlOwogICAgICAgICAgICBjb21wYXJlID0gY29tcGFyZSAhPT0gbnVsbCA/IGNvbXBhcmUgOiBzaGFsbG93RXF1YWw7CiAgICAgICAgICAgIGlmIChjb21wYXJlKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50Mi5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgbmV4dFByb3BzKTsKICAgICAgICAgIG5ld0NoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIG91dGVyTWVtb1R5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgaWYgKG91dGVyTWVtb1R5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBvdXRlck1lbW9UeXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgKFNpbXBsZU1lbW9Db21wb25lbnQgaGFzIG5vIGRlZmF1bHRQcm9wcykKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG91dGVyTWVtb1R5cGUpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQyLnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZiAmJiAvLyBQcmV2ZW50IGJhaWxvdXQgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQuCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID09PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBuZXh0UHJvcHMgPSBwcmV2UHJvcHM7CiAgICAgICAgICAgICAgaWYgKCFjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50MiwgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGN1cnJlbnQyLmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFN0YXRlIDogbnVsbDsKICAgICAgICAgIGlmIChuZXh0UHJvcHMubW9kZSA9PT0gImhpZGRlbiIgfHwgZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIE9mZnNjcmVlbkxhbmUpKSB7CiAgICAgICAgICAgICAgdmFyIHNwYXduZWRDYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXh0QmFzZUxhbmVzOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2QmFzZUxhbmVzID0gcHJldlN0YXRlLmJhc2VMYW5lczsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZCYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IG5leHRCYXNlTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IHNwYXduZWRDYWNoZVBvb2wsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgbmV4dEJhc2VMYW5lcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUyID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTI7CiAgICAgICAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lczIgPSBwcmV2U3RhdGUgIT09IG51bGwgPyBwcmV2U3RhdGUuYmFzZUxhbmVzIDogcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHN1YnRyZWVSZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3N1YnRyZWVSZW5kZXJMYW5lczsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZTdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgX3N1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvZmlsZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsICYmIHJlZiAhPT0gbnVsbCB8fCBjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi5yZWYgIT09IHJlZikgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZlN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hvdWxkRXJyb3Iod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIGNhc2UgZmFsc2U6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciB0ZW1wSW5zdGFuY2UgPSBuZXcgY3Rvcih3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcywgX2luc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGVtcEluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICAgICAgX2luc3RhbmNlLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKF9pbnN0YW5jZSwgc3RhdGUsIG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgdHJ1ZTogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gbmV3IEVycm9yKCJTaW11bGF0ZWQgZXJyb3IgY29taW5nIGZyb20gRGV2VG9vbHMiKTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgd29ya0luUHJvZ3Jlc3MyKSwgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGU7CiAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgJiYgaW5zdC5wcm9wcyAhPT0gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSXQgbG9va3MgbGlrZSAlcyBpcyByZWFzc2lnbmluZyBpdHMgb3duIGB0aGlzLnByb3BzYCB3aGlsZSByZW5kZXJpbmcuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgY2FuIGxlYWQgdG8gY29uZnVzaW5nIGJ1Z3MuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJhIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRVbml0T2ZXb3JrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGRpZENhcHR1cmVFcnJvciA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlICYmICFkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgaWYgKGRpZENhcHR1cmVFcnJvciAmJiB0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAocm9vdDMucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLnBlbmRpbmdDb250ZXh0LCByb290My5wZW5kaW5nQ29udGV4dCAhPT0gcm9vdDMuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QzLmNvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRleHQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBjdXJyZW50IGZpYmVyLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcHJldkNoaWxkcmVuID0gcHJldlN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV4dFByb3BzLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGlmIChwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgIHZhciBvdmVycmlkZVN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IG5leHRDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGNhY2hlOiBuZXh0U3RhdGUuY2FjaGUsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbmV4dFN0YXRlLnBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXMsCiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG5leHRTdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcuIEJlY2F1c2UgdGhlIGVycm9yIGhhcHBlbmVkIG91dHNpZGUgb2YgYSBTdXNwZW5zZSBib3VuZGFyeSwgdGhlIGVudGlyZSByb290IHdpbGwgc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0Q2hpbGRyZW4gIT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHZhciBfcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhpcyByb290IHJlY2VpdmVkIGFuIGVhcmx5IHVwZGF0ZSwgYmVmb3JlIGFueXRoaW5nIHdhcyBhYmxlIGh5ZHJhdGUuIFN3aXRjaGVkIHRoZSBlbnRpcmUgcm9vdCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgX3JlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgIHZhciBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzICYgflBsYWNlbWVudCB8IEh5ZHJhdGluZzsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIGlmIChuZXh0Q2hpbGRyZW4gPT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBudWxsOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBpc0RpcmVjdFRleHRDaGlsZCA9IHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIG5leHRQcm9wcyk7CiAgICAgICAgICBpZiAoaXNEaXJlY3RUZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAocHJldlByb3BzICE9PSBudWxsICYmIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByZXZQcm9wcykpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENvbnRlbnRSZXNldDsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZWYoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExhenlDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IGVsZW1lbnRUeXBlOwogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgdmFyIENvbXBvbmVudCA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFRhZyA9IHdvcmtJblByb2dyZXNzMi50YWcgPSByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpOwogICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgc3dpdGNoIChyZXNvbHZlZFRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRm9yd2FyZFJlZihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkUHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlTWVtb0NvbXBvbmVudCgKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICBDb21wb25lbnQsCiAgICAgICAgICAgICAgICByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudC50eXBlLCByZXNvbHZlZFByb3BzKSwKICAgICAgICAgICAgICAgIC8vIFRoZSBpbm5lciB0eXBlIGNhbiBoYXZlIGRlZmF1bHRzIHRvbwogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoaW50ID0gIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQgIT09IG51bGwgJiYgdHlwZW9mIENvbXBvbmVudCA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICBoaW50ID0gIiBEaWQgeW91IHdyYXAgYSBjb21wb25lbnQgaW4gUmVhY3QubGF6eSgpIG1vcmUgdGhhbiBvbmNlPyI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQuIFJlY2VpdmVkIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvOiAiICsgQ29tcG9uZW50ICsgIi4gIiArICgiTGF6eSBlbGVtZW50IHR5cGUgbXVzdCByZXNvbHZlIHRvIGEgY2xhc3Mgb3IgZnVuY3Rpb24uIiArIGhpbnQpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgdHlwZW9mIENvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gaGF2ZSBhIHJlbmRlciBtZXRob2QsIGJ1dCBkb2Vzbid0IGV4dGVuZCBSZWFjdC5Db21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IHRvIGNhdXNlIGVycm9ycy4gQ2hhbmdlICVzIHRvIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIFJ1biB0aGVzZSBjaGVja3MgaW4gcHJvZHVjdGlvbiBvbmx5IGlmIHRoZSBmbGFnIGlzIG9mZi4KICAgICAgICAgICAgLy8gRXZlbnR1YWxseSB3ZSdsbCBkZWxldGUgdGhpcyBicmFuY2ggYWx0b2dldGhlci4KICAgICAgICAgICAgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDAKICAgICAgICAgICkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMiA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gdmFsdWUuc3RhdGUgIT09IG51bGwgJiYgdmFsdWUuc3RhdGUgIT09IHZvaWQgMCA/IHZhbHVlLnN0YXRlIDogbnVsbDsKICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHZhbHVlKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IEZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4obnVsbCwgd29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQpIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogY2hpbGRDb250ZXh0VHlwZXMgY2Fubm90IGJlIGRlZmluZWQgb24gYSBmdW5jdGlvbiBjb21wb25lbnQuIiwgQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvMiArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBvd25lck5hbWUgfHwgIiI7CiAgICAgICAgICAgICAgdmFyIGRlYnVnU291cmNlID0gd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICBpZiAoZGVidWdTb3VyY2UpIHsKICAgICAgICAgICAgICAgIHdhcm5pbmdLZXkgPSBkZWJ1Z1NvdXJjZS5maWxlTmFtZSArICI6IiArIGRlYnVnU291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMuIEF0dGVtcHRzIHRvIGFjY2VzcyB0aGlzIHJlZiB3aWxsIGZhaWwuIERpZCB5b3UgbWVhbiB0byB1c2UgUmVhY3QuZm9yd2FyZFJlZigpPyVzIiwgaW5mbzIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdW5jdGlvbiBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTMgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIiwgX2NvbXBvbmVudE5hbWUzKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWU0ID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBjb250ZXh0VHlwZS4iLCBfY29tcG9uZW50TmFtZTQpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgU1VTUEVOREVEX01BUktFUiA9IHsKICAgICAgICAgIGRlaHlkcmF0ZWQ6IG51bGwsCiAgICAgICAgICB0cmVlQ29udGV4dDogbnVsbCwKICAgICAgICAgIHJldHJ5TGFuZTogTm9MYW5lCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgY2FjaGVQb29sOiBnZXRTdXNwZW5kZWRDYWNoZSgpLAogICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IG1lcmdlTGFuZXMocHJldk9mZnNjcmVlblN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKSwKICAgICAgICAgICAgY2FjaGVQb29sLAogICAgICAgICAgICB0cmFuc2l0aW9uczogcHJldk9mZnNjcmVlblN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiByZW1vdmVMYW5lcyhjdXJyZW50Mi5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkU3VzcGVuZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvd0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChkaWRTdXNwZW5kIHx8IHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50MikpIHsKICAgICAgICAgICAgc2hvd0ZhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5EaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBkZWh5ZHJhdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmYWxsYmFja0ZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZGVoeWRyYXRlZCA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChfZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIF9kZWh5ZHJhdGVkLCBwcmV2U3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgX25leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuLCBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdGF0ZSA9IGN1cnJlbnQyLmNoaWxkLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5tZW1vaXplZFN0YXRlID0gcHJldk9mZnNjcmVlblN0YXRlID09PSBudWxsID8gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgOiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLmNoaWxkTGFuZXMgPSBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50MiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4yID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzID0gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4yLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gX3ByaW1hcnlDaGlsZEZyYWdtZW50MzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKG9mZnNjcmVlblByb3BzLCBtb2RlLCBOb0xhbmVzLCBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IFtjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50XTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBJbiBsZWdhY3kgbW9kZSwgd2UgY29tbWl0IHRoZSBwcmltYXJ5IHRyZWUgYXMgaWYgaXQgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgIC8vIGNvbXBsZXRlZCwgZXZlbiB0aG91Z2ggaXQncyBpbiBhbiBpbmNvbnNpc3RlbnQgc3RhdGUuCiAgICAgICAgICAgIChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gTWFrZSBzdXJlIHdlJ3JlIG9uIHRoZSBzZWNvbmQgcGFzcywgaS5lLiB0aGUgcHJpbWFyeSBjaGlsZCBmcmFnbWVudCB3YXMKICAgICAgICAgICAgLy8gYWxyZWFkeSBjbG9uZWQuIEluIGxlZ2FjeSBtb2RlLCB0aGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXNuJ3QgdHJ1ZSBpcwogICAgICAgICAgICAvLyB3aGVuIERldlRvb2xzIGZvcmNlcyB1cyB0byBkaXNwbGF5IGEgZmFsbGJhY2s7IHdlIHNraXAgdGhlIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAvLyBwYXNzIGVudGlyZWx5IGFuZCBnbyBzdHJhaWdodCB0byByZW5kZXJpbmcgdGhlIGZhbGxiYWNrLiAoSW4gQ29uY3VycmVudAogICAgICAgICAgICAvLyBNb2RlLCBTdXNwZW5zZUxpc3QgY2FuIGFsc28gdHJpZ2dlciB0aGlzIHNjZW5hcmlvLCBidXQgdGhpcyBpcyBhIGxlZ2FjeS0KICAgICAgICAgICAgLy8gb25seSBjb2RlcGF0aC4pCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50CiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgcHJpbWFyeUNoaWxkUHJvcHMpOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50LCBmYWxsYmFja0NoaWxkcmVuKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyTW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIGZpYmVyTW9kZSk7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgZmliZXJNb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaHlkcmF0ZSBTdXNwZW5zZSBpbiBsZWdhY3kgbW9kZS4gU3dpdGNoIGZyb20gUmVhY3RET00uaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIpIHRvIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikucmVuZGVyKGVsZW1lbnQpIG9yIHJlbW92ZSB0aGUgU3VzcGVuc2UgY29tcG9uZW50cyBmcm9tIHRoZSBzZXJ2ZXIgcmVuZGVyZWQgY29tcG9uZW50cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhTeW5jTGFuZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKERlZmF1bHRIeWRyYXRpb25MYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCFkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgIHdhcm5JZkh5ZHJhdGluZygpOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoCiAgICAgICAgICAgICAgICBjdXJyZW50MiwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgICAgIC8vIFRPRE86IFdoZW4gd2UgZGVsZXRlIGxlZ2FjeSBtb2RlLCB3ZSBzaG91bGQgbWFrZSB0aGlzIGVycm9yIGFyZ3VtZW50CiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCDigJQgZXZlcnkgY29uY3VycmVudCBtb2RlIHBhdGggdGhhdCBjYXVzZXMgaHlkcmF0aW9uIHRvCiAgICAgICAgICAgICAgICAvLyBkZS1vcHQgdG8gY2xpZW50IHJlbmRlcmluZyBzaG91bGQgaGF2ZSBhbiBlcnJvciBtZXNzYWdlLgogICAgICAgICAgICAgICAgbnVsbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIF9nZXRTdXNwZW5zZUluc3RhbmNlRiA9IGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5kaWdlc3Q7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICBzdGFjayA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5zdGFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICBpZiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIlRoZSBzZXJ2ZXIgY291bGQgbm90IGZpbmlzaCB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LCBsaWtlbHkgZHVlIHRvIGFuIGVycm9yIGR1cmluZyBzZXJ2ZXIgcmVuZGVyaW5nLiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUoZXJyb3IyLCBkaWdlc3QsIHN0YWNrKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBjYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzQ29udGV4dENoYW5nZWQyID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIGN1cnJlbnQyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICBpZiAoZGlkUmVjZWl2ZVVwZGF0ZSB8fCBoYXNDb250ZXh0Q2hhbmdlZDIpIHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lID0gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBOb0xhbmUgJiYgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lOwogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShjdXJyZW50MiwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudDIsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhpcyBTdXNwZW5zZSBib3VuZGFyeSByZWNlaXZlZCBhbiB1cGRhdGUgYmVmb3JlIGl0IGZpbmlzaGVkIGh5ZHJhdGluZy4gVGhpcyBjYXVzZWQgdGhlIGJvdW5kYXJ5IHRvIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiBUaGUgdXN1YWwgd2F5IHRvIGZpeCB0aGlzIGlzIHRvIHdyYXAgdGhlIG9yaWdpbmFsIHVwZGF0ZSBpbiBzdGFydFRyYW5zaXRpb24uIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeS5iaW5kKG51bGwsIGN1cnJlbnQyKTsKICAgICAgICAgICAgICByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShzdXNwZW5zZUluc3RhbmNlLCByZXRyeSk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZS50cmVlQ29udGV4dCk7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZTIgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZyB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50NCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIoZmliZXIsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGZpcnN0Q2hpbGQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaXJzdENoaWxkOwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZExhc3RDb250ZW50Um93KGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciByb3cgPSBmaXJzdENoaWxkOwogICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdyA9IHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICByb3cgPSByb3cuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXN0Q29udGVudFJvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmV2ZWFsT3JkZXIgIT09IHZvaWQgMCAmJiByZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJ0b2dldGhlciIgJiYgIWRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXZlYWxPcmRlciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBVc2UgbG93ZXJjYXNlICIlcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZCI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBSZWFjdCB1c2VzIHRoZSAtcyBzdWZmaXggaW4gdGhlIHNwZWxsaW5nLiBVc2UgIiVzcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignJXMgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0pIHsKICAgICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09ICJjb2xsYXBzZWQiICYmIHRhaWxNb2RlICE9PSAiaGlkZGVuIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgdGFpbCBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gImNvbGxhcHNlZCIgb3IgImhpZGRlbiI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJzxTdXNwZW5zZUxpc3QgdGFpbD0iJXMiIC8+IGlzIG9ubHkgdmFsaWQgaWYgcmV2ZWFsT3JkZXIgaXMgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIi4gRGlkIHlvdSBtZWFuIHRvIHNwZWNpZnkgcmV2ZWFsT3JkZXI9ImZvcndhcmRzIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRTbG90LCBpbmRleDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQW5BcnJheSA9IGlzQXJyYXkoY2hpbGRTbG90KTsKICAgICAgICAgICAgdmFyIGlzSXRlcmFibGUgPSAhaXNBbkFycmF5ICYmIHR5cGVvZiBnZXRJdGVyYXRvckZuKGNoaWxkU2xvdCkgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgZXJyb3IoIkEgbmVzdGVkICVzIHdhcyBwYXNzZWQgdG8gcm93ICMlcyBpbiA8U3VzcGVuc2VMaXN0IC8+LiBXcmFwIGl0IGluIGFuIGFkZGl0aW9uYWwgU3VzcGVuc2VMaXN0IHRvIGNvbmZpZ3VyZSBpdHMgcmV2ZWFsT3JkZXI6IDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPiAuLi4gPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+eyVzfTwvU3VzcGVuc2VMaXN0PiAuLi4gPC9TdXNwZW5zZUxpc3Q+IiwgdHlwZSwgaW5kZXgyLCB0eXBlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKGNoaWxkcmVuLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4gIT09IHZvaWQgMCAmJiBjaGlsZHJlbiAhPT0gbnVsbCAmJiBjaGlsZHJlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkcmVuW2ldLCBpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbkl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuSXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBfaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKHN0ZXAudmFsdWUsIF9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBfaSsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0Egc2luZ2xlIHJvdyB3YXMgcGFzc2VkIHRvIGEgPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0iJXMiIC8+LiBUaGlzIGlzIG5vdCB1c2VmdWwgc2luY2UgaXQgbmVlZHMgbXVsdGlwbGUgcm93cy4gRGlkIHlvdSBtZWFuIHRvIHBhc3MgbXVsdGlwbGUgY2hpbGRyZW4gb3IgYW4gYXJyYXk/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUod29ya0luUHJvZ3Jlc3MyLCBpc0JhY2t3YXJkcywgdGFpbCwgbGFzdENvbnRlbnRSb3csIHRhaWxNb2RlKSB7CiAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHsKICAgICAgICAgICAgICBpc0JhY2t3YXJkcywKICAgICAgICAgICAgICByZW5kZXJpbmc6IG51bGwsCiAgICAgICAgICAgICAgcmVuZGVyaW5nU3RhcnRUaW1lOiAwLAogICAgICAgICAgICAgIGxhc3Q6IGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmlzQmFja3dhcmRzID0gaXNCYWNrd2FyZHM7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IDA7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSBsYXN0Q29udGVudFJvdzsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWxNb2RlID0gdGFpbE1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJldmVhbE9yZGVyID0gbmV4dFByb3BzLnJldmVhbE9yZGVyOwogICAgICAgICAgdmFyIHRhaWxNb2RlID0gbmV4dFByb3BzLnRhaWw7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4obmV3Q2hpbGRyZW4sIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG91bGRGb3JjZUZhbGxiYWNrID0gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgIGlmIChzaG91bGRGb3JjZUZhbGxiYWNrKSB7CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gY3VycmVudDIgIT09IG51bGwgJiYgKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBmaW5kTGFzdENvbnRlbnRSb3cod29ya0luUHJvZ3Jlc3MyLmNoaWxkKTsKICAgICAgICAgICAgICAgIHZhciB0YWlsOwogICAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZW50Um93ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0YWlsID0gbGFzdENvbnRlbnRSb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgX3RhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcm93OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIHJvdy5zaWJsaW5nID0gX3RhaWw7CiAgICAgICAgICAgICAgICAgIF90YWlsID0gcm93OwogICAgICAgICAgICAgICAgICByb3cgPSBuZXh0Um93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIF90YWlsLAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjogewogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyB0YWlsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdm9pZCAwCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHByb3ZpZGVyVHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIGNvbnRleHQgPSBwcm92aWRlclR5cGUuX2NvbnRleHQ7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBuZXdQcm9wcy52YWx1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoInZhbHVlIiBpbiBuZXdQcm9wcykpIHsKICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGB2YWx1ZWAgcHJvcCBpcyByZXF1aXJlZCBmb3IgdGhlIGA8Q29udGV4dC5Qcm92aWRlcj5gLiBEaWQgeW91IG1pc3NwZWxsIGl0IG9yIGZvcmdldCB0byBwYXNzIGl0PyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvdmlkZXJQcm9wVHlwZXMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChwcm92aWRlclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3ZpZGVyUHJvcFR5cGVzLCBuZXdQcm9wcywgInByb3AiLCAiQ29udGV4dC5Qcm92aWRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IG9sZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhvbGRWYWx1ZSwgbmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUHJvcHMuY2hpbGRyZW4gPT09IG5ld1Byb3BzLmNoaWxkcmVuICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dC5fY29udGV4dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IGNvbnRleHQuQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQ+IGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZW5kZXIyID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuZGVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbnRleHQgY29uc3VtZXIgd2FzIHJlbmRlcmVkIHdpdGggbXVsdGlwbGUgY2hpbGRyZW4sIG9yIGEgY2hpbGQgdGhhdCBpc24ndCBhIGZ1bmN0aW9uLiBBIGNvbnRleHQgY29uc3VtZXIgZXhwZWN0cyBhIHNpbmdsZSBjaGlsZCB0aGF0IGlzIGEgZnVuY3Rpb24uIElmIHlvdSBkaWQgcGFzcyBhIGZ1bmN0aW9uLCBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gdHJhaWxpbmcgb3IgbGVhZGluZyB3aGl0ZXNwYWNlIGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5ld0NoaWxkcmVuID0gcmVuZGVyMihuZXdWYWx1ZSk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpIHsKICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudDIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMpOwogICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW91bnRGaWJlcihjdXJyZW50Miwgb2xkV29ya0luUHJvZ3Jlc3MsIG5ld1dvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc3dhcCB0aGUgcm9vdCBmaWJlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBvbGRXb3JrSW5Qcm9ncmVzcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5pbmRleCA9IG9sZFdvcmtJblByb2dyZXNzLmluZGV4OwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nID0gb2xkV29ya0luUHJvZ3Jlc3Muc2libGluZzsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmV0dXJuID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZWYgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgICAgICAgIGlmIChvbGRXb3JrSW5Qcm9ncmVzcyA9PT0gcmV0dXJuRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5jaGlsZCA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBwcmV2U2libGluZyA9IHJldHVybkZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBwYXJlbnQgdG8gaGF2ZSBhIGNoaWxkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAocHJldlNpYmxpbmcuc2libGluZyAhPT0gb2xkV29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgIHByZXZTaWJsaW5nID0gcHJldlNpYmxpbmcuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByZXZpb3VzIHNpYmxpbmcuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZTaWJsaW5nLnNpYmxpbmcgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2N1cnJlbnQyXTsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHVwZGF0ZUxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZSh1cGRhdGVMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjogewogICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGhhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZExhbmVzID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lczsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgcHJpbWFyeUNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IChjdXJyZW50Mi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciBfaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuX2RlYnVnTmVlZHNSZW1vdW50ICYmIGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbW91bnRGaWJlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5rZXksIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciB8fCBudWxsLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgd29ya0luUHJvZ3Jlc3MyLmxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IGhhc0NvbnRleHRDaGFuZ2VkKCkgfHwgLy8gRm9yY2UgYSByZS1yZW5kZXIgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQ6CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlICE9PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ICYmIC8vIElmIHRoaXMgaXMgdGhlIHNlY29uZCBwYXNzIG9mIGFuIGVycm9yIG9yIHN1c3BlbnNlIGJvdW5kYXJ5LCB0aGVyZQogICAgICAgICAgICAgIC8vIG1heSBub3QgYmUgd29yayBzY2hlZHVsZWQgb24gYGN1cnJlbnRgLCBzbyB3ZSBjaGVjayBmb3IgdGhpcyBmbGFnLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY3VycmVudDIuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IHdvcmtJblByb2dyZXNzMi5pbmRleDsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IGdldEZvcmtzQXRMZXZlbCgpOwogICAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExhenlDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gQ29tcG9uZW50ID8gdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIHVucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50ID8gX3VucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoX0NvbXBvbmVudCwgX3VucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQsIF9yZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IHR5cGUgPyBfdW5yZXNvbHZlZFByb3BzMiA6IHJlc29sdmVEZWZhdWx0UHJvcHModHlwZSwgX3VucmVzb2x2ZWRQcm9wczIpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIF9yZXNvbHZlZFByb3BzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZyYWdtZW50MjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVByb2ZpbGVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0UHJvdmlkZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNvbnRleHRDb25zdW1lcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3R5cGUyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhfdHlwZTIsIF91bnJlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBfdHlwZTIucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgX3Jlc29sdmVkUHJvcHMzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShfdHlwZTIpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF90eXBlMiwgX3Jlc29sdmVkUHJvcHMzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wcyhfQ29tcG9uZW50MiwgX3VucmVzb2x2ZWRQcm9wczQpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluY29tcGxldGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBfQ29tcG9uZW50MiwgX3Jlc29sdmVkUHJvcHM0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXBwZW5kQWxsQ2hpbGRyZW47CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb250YWluZXI7CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb21wb25lbnQkMTsKICAgICAgICB2YXIgdXBkYXRlSG9zdFRleHQkMTsKICAgICAgICB7CiAgICAgICAgICBhcHBlbmRBbGxDaGlsZHJlbiA9IGZ1bmN0aW9uKHBhcmVudCwgd29ya0luUHJvZ3Jlc3MyLCBuZWVkc1Zpc2liaWxpdHlUb2dnbGUsIGlzSGlkZGVuKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lciA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50JDEgPSBmdW5jdGlvbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gcHJlcGFyZVVwZGF0ZShpbnN0YW5jZSwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdFRleHQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgICAgaWYgKG9sZFRleHQgIT09IG5ld1RleHQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlclN0YXRlLnRhaWxNb2RlKSB7CiAgICAgICAgICAgIGNhc2UgImhpZGRlbiI6IHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBsYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlICh0YWlsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHRhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYXN0VGFpbE5vZGUgPSB0YWlsTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhaWxOb2RlID0gdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhc3RUYWlsTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgIHZhciBfdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBfbGFzdFRhaWxOb2RlID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoX3RhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoX3RhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlID0gX3RhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3RhaWxOb2RlID0gX3RhaWxOb2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChfbGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1JlbmRlcmVkQVRhaWxGYWxsYmFjayAmJiByZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2xhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYnViYmxlUHJvcGVydGllcyhjb21wbGV0ZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZGlkQmFpbG91dCA9IGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlICE9PSBudWxsICYmIGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlLmNoaWxkID09PSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoIWRpZEJhaWxvdXQpIHsKICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIHRyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoY2hpbGQubGFuZXMsIGNoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHRyZWVCYXNlRHVyYXRpb24gKz0gY2hpbGQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IHRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQubGFuZXMsIF9jaGlsZC5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBfY2hpbGQucmV0dXJuID0gY29tcGxldGVkV29yazsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIF90cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHZhciBfY2hpbGQyID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQyLmxhbmVzLCBfY2hpbGQyLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMi5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfdHJlZUJhc2VEdXJhdGlvbiArPSBfY2hpbGQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICBfY2hpbGQyID0gX2NoaWxkMi5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24gPSBfdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkMyA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkMy5sYW5lcywgX2NoaWxkMy5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgX2NoaWxkMy5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkMyA9IF9jaGlsZDMuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yay5zdWJ0cmVlRmxhZ3MgfD0gc3VidHJlZUZsYWdzOwogICAgICAgICAgfQogICAgICAgICAgY29tcGxldGVkV29yay5jaGlsZExhbmVzID0gbmV3Q2hpbGRMYW5lczsKICAgICAgICAgIHJldHVybiBkaWRCYWlsb3V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSkgewogICAgICAgICAgaWYgKGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSAmJiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgd2FybklmVW5oeWRyYXRlZFRhaWxOb2Rlcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlciB8IEluY29tcGxldGUgfCBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCAmJiBuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIXdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkEgZGVoeWRyYXRlZCBzdXNwZW5zZSBjb21wb25lbnQgd2FzIGNvbXBsZXRlZCB3aXRob3V0IGEgaHlkcmF0ZWQgbm9kZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaXNUaW1lZE91dFN1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2lzVGltZWRPdXRTdXNwZW5zZSA9IG5leHRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKF9pc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChfcHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IF9wcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcG9wVHJlZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQyOgogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyUm9vdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGlmIChmaWJlclJvb3QucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5jb250ZXh0ID0gZmliZXJSb290LnBlbmRpbmdDb250ZXh0OwogICAgICAgICAgICAgICAgZmliZXJSb290LnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgaWYgKHdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBjbGllbnQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgIXByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQgfHwgLy8gQ2hlY2sgaWYgd2UgcmV2ZXJ0ZWQgdG8gY2xpZW50IHJlbmRlcmluZyAoZS5nLiBkdWUgdG8gYW4gZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpICE9PSBOb0ZsYWdzCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgICAgICAgICB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCQxKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLnJlZiAhPT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFuZXdQcm9wcykgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4oaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMiwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBpZiAoZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oaW5zdGFuY2UsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IG5ld1Byb3BzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VGV4dCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICAgIHZhciBfY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICAgIHZhciBfd2FzSHlkcmF0ZWQyID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGggPSBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dERpZFRpbWVvdXQgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIHByZXZEaWRUaW1lb3V0ID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQgIT09IHByZXZEaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5GaWJlcjIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5GaWJlcjIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCA9IGN1cnJlbnQyID09PSBudWxsICYmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy51bnN0YWJsZV9hdm9pZFRoaXNGYWxsYmFjayAhPT0gdHJ1ZSB8fCAhZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCB8fCBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZXBhcmVQb3J0YWxNb3VudCh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoX0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRBbHJlYWR5ID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZFRhaWwgPSByZW5kZXJTdGF0ZS5yZW5kZXJpbmc7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkVGFpbCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgY2Fubm90QmVTdXNwZW5kZWQgPSByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSAmJiAoY3VycmVudDIgPT09IG51bGwgfHwgKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpOwogICAgICAgICAgICAgICAgICBpZiAoIWNhbm5vdEJlU3VzcGVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGhlbmFibGVzID0gc3VzcGVuZGVkLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VGhlbmFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbmV3VGhlbmFibGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjaykpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsICYmIG5vdygpID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IFNvbWVSZXRyeUxhbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJlbmRlcmVkVGFpbCk7CiAgICAgICAgICAgICAgICAgIGlmIChfc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfbmV3VGhlbmFibGVzID0gX3N1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX25ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gX25ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLnRhaWwgPT09IG51bGwgJiYgcmVuZGVyU3RhdGUudGFpbE1vZGUgPT09ICJoaWRkZW4iICYmICFyZW5kZXJlZFRhaWwuYWx0ZXJuYXRlICYmICFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHRpbWUgaXQgdG9vayB0byByZW5kZXIgbGFzdCByb3cgaXMgZ3JlYXRlciB0aGFuIHRoZSByZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAvLyB0aW1lIHdlIGhhdmUgdG8gcmVuZGVyLiBTbyByZW5kZXJpbmcgb25lIG1vcmUgcm93IHdvdWxkIGxpa2VseQogICAgICAgICAgICAgICAgICAgIC8vIGV4Y2VlZCBpdC4KICAgICAgICAgICAgICAgICAgICBub3coKSAqIDIgLSByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgJiYgcmVuZGVyTGFuZXMyICE9PSBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyZWRUYWlsLnNpYmxpbmcgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSByZW5kZXJTdGF0ZS5sYXN0OwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLnNpYmxpbmcgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBuZXh0OwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG5leHQuc2libGluZzsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IG5vdygpOwogICAgICAgICAgICAgICAgbmV4dC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgdmFyIG5leHRJc0hpZGRlbiA9IF9uZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgcHJldklzSGlkZGVuID0gX3ByZXZTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2SXNIaWRkZW4gIT09IG5leHRJc0hpZGRlbiAmJiAvLyBMZWdhY3lIaWRkZW4gZG9lc24ndCBkbyBhbnkgaGlkaW5nIOKAlCBpdCBvbmx5IHByZS1yZW5kZXJzLgogICAgICAgICAgICAgICAgIWVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFuZXh0SXNIaWRkZW4gfHwgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoc3VidHJlZVJlbmRlckxhbmVzLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyAmIChQbGFjZW1lbnQgfCBVcGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIHZhciBfZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKChfZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSAhPT0gTm9GbGFncyAmJiAoX2ZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IF9mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRocmV3IGluIG5ld2x5IG1vdW50ZWQgZGVoeWRyYXRlZCBjb21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9mbGFnczIgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKF9mbGFnczIgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MyICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwb3BQcm92aWRlcihjb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQyLCBpbnRlcnJ1cHRlZFdvcmssIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcG9wVHJlZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgIHN3aXRjaCAoaW50ZXJydXB0ZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgaWYgKGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGludGVycnVwdGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgUG9zc2libHlXZWFrU2V0ID0gdHlwZW9mIFdlYWtTZXQgPT09ICJmdW5jdGlvbiIgPyBXZWFrU2V0IDogU2V0OwogICAgICAgIHZhciBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlcG9ydFVuY2F1Z2h0RXJyb3JJbkRFVihlcnJvcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNhbGxDb21wb25lbnRXaWxsVW5tb3VudFdpdGhUaW1lciA9IGZ1bmN0aW9uKGN1cnJlbnQyLCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCwgY3VycmVudDIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIoY3VycmVudDIsIGluc3RhbmNlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5QXR0YWNoUmVmKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoY3VycmVudDIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciByZWYgPSBjdXJyZW50Mi5yZWY7CiAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyAmJiBjdXJyZW50Mi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxEZXN0cm95KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IHByZXBhcmVGb3JDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpOwogICAgICAgICAgdmFyIHNob3VsZEZpcmUgPSBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXI7CiAgICAgICAgICBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRmlyZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2JlZ2luKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgQmVmb3JlTXV0YXRpb25NYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoKGZsYWdzICYgU25hcHNob3QpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHNuYXBzaG90ID0gaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IHByZXZQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlkV2FyblNldCA9IGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5TZXQuYWRkKGZpbmlzaGVkV29yay50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpOiBBIHNuYXBzaG90IHZhbHVlIChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUgPSBzbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChmbGFncywgZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjcmVhdGUgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZSgpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCAmJiB0eXBlb2YgZGVzdHJveSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQgbnVsbC4gSWYgeW91ciBlZmZlY3QgZG9lcyBub3QgcmVxdWlyZSBjbGVhbiB1cCwgcmV0dXJuIHVuZGVmaW5lZCAob3Igbm90aGluZykuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZXN0cm95LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQ6ICIgKyBkZXN0cm95OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgbXVzdCBub3QgcmV0dXJuIGFueXRoaW5nIGJlc2lkZXMgYSBmdW5jdGlvbiwgd2hpY2ggaXMgdXNlZCBmb3IgY2xlYW4tdXAuJXMiLCBob29rTmFtZSwgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLmlkLCBvblBvc3RDb21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUub25Qb3N0Q29tbWl0OwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGUgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUG9zdENvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUG9zdENvbW1pdChpZCwgcGhhc2UsIHBhc3NpdmVFZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIoZmluaXNoZWRSb290LCBjdXJyZW50MiwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzKGZpbmlzaGVkV29yay50eXBlLCBjdXJyZW50Mi5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZFVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSwgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSwgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIHVwZGF0ZSBxdWV1ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgdXBkYXRlUXVldWUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgX3VwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKF91cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLmNoaWxkLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgICAgICBfaW5zdGFuY2UgPSBnZXRQdWJsaWNJbnN0YW5jZShmaW5pc2hlZFdvcmsuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgICAgICBfaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBfdXBkYXRlUXVldWUsIF9pbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlMiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgJiYgZmluaXNoZWRXb3JrLmZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICBjb21taXRNb3VudChfaW5zdGFuY2UyLCB0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIF9maW5pc2hlZFdvcmskbWVtb2l6ZTIgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcywgb25Db21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUyLm9uQ29tbWl0LCBvblJlbmRlciA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25SZW5kZXI7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgIHZhciBjb21taXRUaW1lMiA9IGdldENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICAgICAgdmFyIHBoYXNlID0gY3VycmVudDIgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgb25SZW5kZXIoZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMuaWQsIHBoYXNlLCBmaW5pc2hlZFdvcmsuYWN0dWFsRHVyYXRpb24sIGZpbmlzaGVkV29yay50cmVlQmFzZUR1cmF0aW9uLCBmaW5pc2hlZFdvcmsuYWN0dWFsU3RhcnRUaW1lLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25Db21taXQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIG9uQ29tbWl0KGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZWZmZWN0RHVyYXRpb24sIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaW5pc2hlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QzLmVmZmVjdER1cmF0aW9uICs9IGVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uICs9IGVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgY29tbWl0U3VzcGVuc2VIeWRyYXRpb25DYWxsYmFja3MoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBUcmFjaW5nTWFya2VyQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFJlZikgewogICAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihub2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KG5vZGUsIG5vZGUucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgc2FmZWx5QXR0YWNoUmVmKG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihmaW5pc2hlZFdvcmssIGlzSGlkZGVuKSB7CiAgICAgICAgICB2YXIgaG9zdFN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVJbnN0YW5jZShub2RlLnN0YXRlTm9kZSwgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzLCBub2RlLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgobm9kZS50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gTGVnYWN5SGlkZGVuQ29tcG9uZW50KSAmJiBub2RlLm1lbW9pemVkU3RhdGUgIT09IG51bGwgJiYgbm9kZSAhPT0gZmluaXNoZWRXb3JrKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciByZWYgPSBmaW5pc2hlZFdvcmsucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBpbnN0YW5jZVRvVXNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgcmV0VmFsOwogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXRWYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmV0dXJuIHZhbHVlIGZyb20gYSBjYWxsYmFjayByZWYgaW4gJXMuIEEgY2FsbGJhY2sgcmVmIHNob3VsZCBub3QgcmV0dXJuIGEgZnVuY3Rpb24uIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFyZWYuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZWYgb2JqZWN0IHByb3ZpZGVkIGZvciAlcy4gVXNlIGVpdGhlciBhIHJlZi1zZXR0ZXIgZnVuY3Rpb24gb3IgUmVhY3QuY3JlYXRlUmVmKCkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBpbnN0YW5jZVRvVXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyTXV0YXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5yZXR1cm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGFsdGVybmF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRldGFjaERlbGV0ZWRJbnN0YW5jZShob3N0SW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UGFyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0hvc3RQYXJlbnQocGFyZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgZmliZXIudGFnID09PSBIb3N0Um9vdCB8fCBmaWJlci50YWcgPT09IEhvc3RQb3J0YWw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RTaWJsaW5nKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgc2libGluZ3M6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGUucmV0dXJuKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBub2RlLnRhZyAhPT0gSG9zdFRleHQgJiYgbm9kZS50YWcgIT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGQgPT09IG51bGwgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEobm9kZS5mbGFncyAmIFBsYWNlbWVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChwYXJlbnQpOwogICAgICAgICAgICAgICAgcGFyZW50RmliZXIuZmxhZ3MgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJlZm9yZSA9IGdldEhvc3RTaWJsaW5nKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKGZpbmlzaGVkV29yaywgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHZhciBfcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgdmFyIF9iZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIoZmluaXNoZWRXb3JrLCBfYmVmb3JlLCBfcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob3N0IHBhcmVudCBmaWJlci4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZShwYXJlbnQsIHN0YXRlTm9kZSwgYmVmb3JlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGNoaWxkLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIHdoaWxlIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGQocGFyZW50LCBzdGF0ZU5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFBvcnRhbCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICB2YXIgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCByZXR1cm5GaWJlciwgZGVsZXRlZEZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgZmluZFBhcmVudDogd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50LnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0UGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRldGFjaEZpYmVyTXV0YXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIHBhcmVudCkgewogICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBjaGlsZCk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgb25Db21taXRVbm1vdW50KGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICBzd2l0Y2ggKGRlbGV0ZWRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2SG9zdFBhcmVudCA9IGhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBwcmV2SG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5RnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIF9wcmV2SG9zdFBhcmVudElzQ29udGFpbmVyID0gaG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBfcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGRlbGV0ZWRGaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgX2VmZmVjdCA9IGVmZmVjdCwgZGVzdHJveSA9IF9lZmZlY3QuZGVzdHJveSwgdGFnID0gX2VmZmVjdC50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGFnICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgodGFnICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWxldGVkRmliZXIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICBkZWxldGVkRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IGRlbGV0ZWRGaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlQ2FsbGJhY2soZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VIeWRyYXRpb25DYWxsYmFja3MoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG5ld1N0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gcHJldlN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgd2FrZWFibGVzID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB2YXIgcmV0cnlDYWNoZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChyZXRyeUNhY2hlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPSBuZXcgUG9zc2libHlXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FrZWFibGVzLmZvckVhY2goZnVuY3Rpb24od2FrZWFibGUpIHsKICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXNvbHZlUmV0cnlXYWtlYWJsZS5iaW5kKG51bGwsIGZpbmlzaGVkV29yaywgd2FrZWFibGUpOwogICAgICAgICAgICAgIGlmICghcmV0cnlDYWNoZS5oYXMod2FrZWFibGUpKSB7CiAgICAgICAgICAgICAgICByZXRyeUNhY2hlLmFkZCh3YWtlYWJsZSk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpblByb2dyZXNzTGFuZXMgIT09IG51bGwgJiYgaW5Qcm9ncmVzc1Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMoaW5Qcm9ncmVzc1Jvb3QsIGluUHJvZ3Jlc3NMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJFeHBlY3RlZCBmaW5pc2hlZCByb290IGFuZCBsYW5lcyB0byBiZSBzZXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YWtlYWJsZS50aGVuKHJldHJ5LCByZXRyeSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290Myk7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIHBhcmVudEZpYmVyLCBsYW5lcykgewogICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHBhcmVudEZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGRlbGV0aW9uc1tpXTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjaGlsZFRvRGVsZXRlLCBwYXJlbnRGaWJlciwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RGVidWdGaWJlciA9IGdldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgaWYgKHBhcmVudEZpYmVyLnN1YnRyZWVGbGFncyAmIE11dGF0aW9uTWFzaykgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRGaWJlci5jaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNoaWxkKTsKICAgICAgICAgICAgICBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGNoaWxkLCByb290Myk7CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldkRlYnVnRmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaywgcm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQyLCBjdXJyZW50Mi5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDIsIGN1cnJlbnQyLnJldHVybik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXNldFRleHRDb250ZW50KGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAoX2luc3RhbmNlNCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFByb3BzIDogbmV3UHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaW5pc2hlZFdvcmsudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGUoX2luc3RhbmNlNCwgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBzaG91bGQgaGF2ZSBhIHRleHQgbm9kZSBpbml0aWFsaXplZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIG9sZFRleHQgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBuZXdUZXh0OwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdFRleHRVcGRhdGUodGV4dEluc3RhbmNlLCBvbGRUZXh0LCBuZXdUZXh0KTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZSb290U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmV2Um9vdFN0YXRlLmlzRGVoeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0SHlkcmF0ZWRDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkZpYmVyID0gZmluaXNoZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIGlmIChvZmZzY3JlZW5GaWJlci5mbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5JbnN0YW5jZSA9IG9mZnNjcmVlbkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IG9mZnNjcmVlbkZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBuZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIG9mZnNjcmVlbkluc3RhbmNlLmlzSGlkZGVuID0gaXNIaWRkZW47CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZSAhPT0gbnVsbCAmJiBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKCF3YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdFN1c3BlbnNlQ2FsbGJhY2soZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfd2FzSGlkZGVuID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZW1vdmUgdGhpcyBkZWFkIGZsYWcKICAgICAgICAgICAgICAgIGZpbmlzaGVkV29yay5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgX3dhc0hpZGRlbjsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuSW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIF9uZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIF9pc0hpZGRlbiA9IF9uZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5Cb3VuZGFyeSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5JbnN0YW5jZS5pc0hpZGRlbiA9IF9pc0hpZGRlbjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKF9pc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgIGlmICghX3dhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaWYgKChvZmZzY3JlZW5Cb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG9mZnNjcmVlbkJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuQ2hpbGQgPSBvZmZzY3JlZW5Cb3VuZGFyeS5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG9mZnNjcmVlbkNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG9mZnNjcmVlbkNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4ob2Zmc2NyZWVuQ2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihvZmZzY3JlZW5Cb3VuZGFyeSwgX2lzSGlkZGVuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBmbGFncyA9IGZpbmlzaGVkV29yay5mbGFnczsKICAgICAgICAgIGlmIChmbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluaXNoZWRXb3JrLmZsYWdzICY9IH5QbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmxhZ3MgJiBIeWRyYXRpbmcpIHsKICAgICAgICAgICAgZmluaXNoZWRXb3JrLmZsYWdzICY9IH5IeWRyYXRpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IChzdWJ0cmVlUm9vdC5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgJiYgaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gZmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gaXNIaWRkZW4gfHwgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgIGlmIChuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICB2YXIgd2FzSGlkZGVuID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gd2FzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gbmV3T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuICYmICFwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICAgIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBmaXJzdENoaWxkOwogICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbigKICAgICAgICAgICAgICAgICAgICBjaGlsZCwKICAgICAgICAgICAgICAgICAgICAvLyBOZXcgcm9vdDsgYnViYmxlIGJhY2sgdXAgdG8gaGVyZSBhbmQgc3RvcC4KICAgICAgICAgICAgICAgICAgICByb290MywKICAgICAgICAgICAgICAgICAgICBjb21taXR0ZWRMYW5lcwogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MgJiYgZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihyb290MywgY3VycmVudDIsIGZpYmVyLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKHJvb3QzLCBmaWJlciwgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzKGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2JlZ2luKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKG5leHRFZmZlY3QuZmxhZ3MgJiBDaGlsZERlbGV0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBmaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpYmVyVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlclRvRGVsZXRlOwogICAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGZpYmVyVG9EZWxldGUsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkQ2hpbGQgPSBwcmV2aW91c0ZpYmVyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0ZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkU2libGluZyA9IGRldGFjaGVkQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZCA9IGRldGFjaGVkU2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRldGFjaGVkQ2hpbGQgIT09IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGRlbGV0ZWRTdWJ0cmVlUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRJbnNpZGVEZWxldGVkVHJlZU9uRmliZXIoZmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfY29tcGxldGUoZGVsZXRlZFN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhmaWJlcik7CiAgICAgICAgICAgICAgaWYgKGZpYmVyID09PSBkZWxldGVkU3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSByZXR1cm5GaWJlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRJbnNpZGVEZWxldGVkVHJlZU9uRmliZXIoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHN3aXRjaCAoY3VycmVudDIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihjdXJyZW50Mik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUxheW91dEVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENPTVBPTkVOVF9UWVBFID0gMDsKICAgICAgICB2YXIgSEFTX1BTRVVET19DTEFTU19UWVBFID0gMTsKICAgICAgICB2YXIgUk9MRV9UWVBFID0gMjsKICAgICAgICB2YXIgVEVTVF9OQU1FX1RZUEUgPSAzOwogICAgICAgIHZhciBURVhUX1RZUEUgPSA0OwogICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5mb3IpIHsKICAgICAgICAgIHZhciBzeW1ib2xGb3IgPSBTeW1ib2wuZm9yOwogICAgICAgICAgQ09NUE9ORU5UX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLmNvbXBvbmVudCIpOwogICAgICAgICAgSEFTX1BTRVVET19DTEFTU19UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5oYXNfcHNldWRvX2NsYXNzIik7CiAgICAgICAgICBST0xFX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnJvbGUiKTsKICAgICAgICAgIFRFU1RfTkFNRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXN0X2lkIik7CiAgICAgICAgICBURVhUX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnRleHQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbW1pdEhvb2tzID0gW107CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290JDEoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbW1pdEhvb2tzLmZvckVhY2goZnVuY3Rpb24oY29tbWl0SG9vaykgewogICAgICAgICAgICAgIHJldHVybiBjb21taXRIb29rKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICBmdW5jdGlvbiBpc0xlZ2FjeUFjdEVudmlyb25tZW50KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgPSAoCiAgICAgICAgICAgICAgLy8gJEZsb3dFeHBlY3RlZEVycm9yIOKAkyBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgZ2xvYmFsCiAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIGplc3RJc0RlZmluZWQgPSB0eXBlb2YgamVzdCAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIHJldHVybiBqZXN0SXNEZWZpbmVkICYmIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAhPT0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGN1cnJlbnQgdGVzdGluZyBlbnZpcm9ubWVudCBpcyBub3QgY29uZmlndXJlZCB0byBzdXBwb3J0IGFjdCguLi4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNlaWwyID0gTWF0aC5jZWlsOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRPd25lciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZywgUmVhY3RDdXJyZW50QWN0UXVldWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEJhdGNoZWRDb250ZXh0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFJlbmRlckNvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFJvb3RJblByb2dyZXNzID0gMDsKICAgICAgICB2YXIgUm9vdEZhdGFsRXJyb3JlZCA9IDE7CiAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZCA9IDM7CiAgICAgICAgdmFyIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgPSA0OwogICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICB2YXIgUm9vdERpZE5vdENvbXBsZXRlID0gNjsKICAgICAgICB2YXIgZXhlY3V0aW9uQ29udGV4dCA9IE5vQ29udGV4dDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOb0xhbmVzKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gMDsKICAgICAgICB2YXIgRkFMTEJBQ0tfVEhST1RUTEVfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICB2YXIgUkVOREVSX1RJTUVPVVRfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lID0gbm93KCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgdmFyIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICB2YXIgTkVTVEVEX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgIHZhciByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub3coKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3coKTsKICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcikgewogICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbikgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TGFuZSA9IGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCk7CiAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UmV0cnlMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2xhaW1OZXh0UmV0cnlMYW5lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICBlcnJvcigidXNlSW5zZXJ0aW9uRWZmZWN0IG11c3Qgbm90IHNjaGVkdWxlIHVwZGF0ZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9MYW5lcyAmJiByb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKGxhbmUgPT09IFN5bmNMYW5lICYmIGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIFRyZWF0IGBhY3RgIGFzIGlmIGl0J3MgaW5zaWRlIGBiYXRjaGVkVXBkYXRlc2AsIGV2ZW4gaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSByb290My5jdXJyZW50OwogICAgICAgICAgY3VycmVudDIubGFuZXMgPSBsYW5lOwogICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBvdXRkYXRlZCBkZWZlclJlbmRlclBoYXNlVXBkYXRlVG9OZXh0QmF0Y2ggZXhwZXJpbWVudC4gV2UKICAgICAgICAgICAgLy8gZGVjaWRlZCBub3QgdG8gZW5hYmxlIGl0LgogICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPSByb290My5jYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9PT0gbmV3Q2FsbGJhY2tQcmlvcml0eSAmJiAvLyBTcGVjaWFsIGNhc2UgcmVsYXRlZCB0byBgYWN0YC4gSWYgdGhlIGN1cnJlbnRseSBzY2hlZHVsZWQgdGFzayBpcyBhCiAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgIC8vIG9uIHRoZSBgYWN0YCBxdWV1ZS4KICAgICAgICAgICEoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsICYmIGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlID09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ICE9PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNjaGVkdWxlZCBjYWxsYmFjayB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2skMShleGlzdGluZ0NhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgICAgaWYgKG5ld0NhbGxiYWNrUHJpb3JpdHkgPT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2socGVyZm9ybVN5bmNXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQucHVzaChmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICBzd2l0Y2ggKGxhbmVzVG9FdmVudFByaW9yaXR5KG5leHRMYW5lcykpIHsKICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gbmV3Q2FsbGJhY2tQcmlvcml0eTsKICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290KHJvb3QzLCBkaWRUaW1lb3V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICBpZiAoZGlkRmx1c2hQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICBpZiAocm9vdDMuY2FsbGJhY2tOb2RlICE9PSBvcmlnaW5hbENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFRpbWVTbGljZSA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpICYmICFpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWRpZFRpbWVvdXQ7CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHNob3VsZFRpbWVTbGljZSA/IHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgOiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbGFuZXMgPSBlcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZW5kZXJXYXNDb25jdXJyZW50ID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJXYXNDb25jdXJyZW50ICYmICFpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSkgewogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgICAgIGlmIChfZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgX2Vycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgX2ZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgPT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3QuYmluZChudWxsLCByb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgdmFyIGVycm9yc0Zyb21GaXJzdEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzOwogICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgcm9vdFdvcmtJblByb2dyZXNzLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ID0gd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgaWYgKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGl0U3RhdHVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9ycykgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMucHVzaC5hcHBseSh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgZXJyb3JzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICBjYXNlIFJvb3RJblByb2dyZXNzOgogICAgICAgICAgICBjYXNlIFJvb3RGYXRhbEVycm9yZWQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RFcnJvcmVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgJiYgLy8gZG8gbm90IGRlbGF5IGlmIHdlJ3JlIGluc2lkZSBhbiBhY3QoKSBzY29wZQogICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1zVW50aWxUaW1lb3V0ID0gZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSArIEZBTExCQUNLX1RIUk9UVExFX01TIC0gbm93KCk7CiAgICAgICAgICAgICAgICBpZiAobXNVbnRpbFRpbWVvdXQgPiAxMCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dExhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhzdXNwZW5kZWRMYW5lcywgbGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk6IHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZU1zID0gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93KCkgLSBldmVudFRpbWVNczsKICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgaWYgKF9tc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIF9tc1VudGlsVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcm9vdCBleGl0IHN0YXR1cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IG5vZGUudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgaWYgKGNoZWNrcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoZWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0U25hcHNob3QgPSBjaGVjay5nZXRTbmFwc2hvdDsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRWYWx1ZSA9IGNoZWNrLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKGdldFNuYXBzaG90KCksIHJlbmRlcmVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyk7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3luY05lc3RlZFVwZGF0ZUZsYWcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgbm90IGFscmVhZHkgYmUgd29ya2luZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5pc2hlZFdvcmsgPSByb290My5jdXJyZW50LmFsdGVybmF0ZTsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbWVyZ2VMYW5lcyhsYW5lcywgU3luY0xhbmUpKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMkMShmbiwgYSkgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQmF0Y2hlZENvbnRleHQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZm4oYSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzY3JldGVVcGRhdGVzKGZuLCBhLCBiLCBjLCBkKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHJldHVybiBmbihhLCBiLCBjLCBkKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jKGZuKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwgJiYgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMudGFnID09PSBMZWdhY3lSb290ICYmIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5UmVuZGVyaW5nKCkgewogICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFJlbmRlckxhbmVzKGZpYmVyLCBsYW5lcykgewogICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhzdWJ0cmVlUmVuZGVyTGFuZXMsIGxhbmVzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUmVuZGVyTGFuZXMoZmliZXIpIHsKICAgICAgICAgIHN1YnRyZWVSZW5kZXJMYW5lcyA9IHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gcm9vdDMudGltZW91dEhhbmRsZTsKICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgICAgY2FuY2VsVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJydXB0ZWRXb3JrID0gd29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gaW50ZXJydXB0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDIsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICB2YXIgcm9vdFdvcmtJblByb2dyZXNzID0gY3JlYXRlV29ya0luUHJvZ3Jlc3Mocm9vdDMuY3VycmVudCwgbnVsbCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgICBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yKHJvb3QzLCB0aHJvd25WYWx1ZSkgewogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgICAgICByZXNldEhvb2tzQWZ0ZXJUaHJvdygpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoZXJyb3JlZFdvcmsgPT09IG51bGwgfHwgZXJyb3JlZFdvcmsucmV0dXJuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEZhdGFsRXJyb3JlZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZXJyb3JlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGVycm9yZWRXb3JrLCB0cnVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgICAgIGlmICh0aHJvd25WYWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdGhyb3duVmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB0aHJvd25WYWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGVycm9yZWRXb3JrLCB3YWtlYWJsZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudEVycm9yZWQoZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93RXhjZXB0aW9uKHJvb3QzLCBlcnJvcmVkV29yay5yZXR1cm4sIGVycm9yZWRXb3JrLCB0aHJvd25WYWx1ZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGNvbXBsZXRlVW5pdE9mV29yayhlcnJvcmVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKHlldEFub3RoZXJUaHJvd25WYWx1ZSkgewogICAgICAgICAgICAgIHRocm93blZhbHVlID0geWV0QW5vdGhlclRocm93blZhbHVlOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyA9PT0gZXJyb3JlZFdvcmsgJiYgZXJyb3JlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gZXJyb3JlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBlcnJvcmVkV29yazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQ7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChwcmV2RGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BEaXNwYXRjaGVyKHByZXZEaXNwYXRjaGVyKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKSB7CiAgICAgICAgICBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gbm93KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobGFuZSkgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gbWVyZ2VMYW5lcyhsYW5lLCB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290U3VzcGVuZGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSBudWxsICYmIChpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcykgfHwgaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcykpKSB7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEod29ya0luUHJvZ3Jlc3NSb290LCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgIT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RFcnJvcmVkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckhhc05vdFN1c3BlbmRlZFlldCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BTeW5jKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCBhbiBpbmNvbXBsZXRlIHJvb3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wU3luYygpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSByb290MyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BDb25jdXJyZW50KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCAmJiAhc2hvdWxkWWllbGQoKSkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHVuaXRPZldvcmspOwogICAgICAgICAgdmFyIG5leHQ7CiAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIHVuaXRPZldvcmsubWVtb2l6ZWRQcm9wcyA9IHVuaXRPZldvcmsucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjb21wbGV0ZWRXb3JrID0gdW5pdE9mV29yazsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gY29tcGxldGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGNvbXBsZXRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0ID0gdW53aW5kV29yayhjdXJyZW50MiwgY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKF9uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gX25leHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RGlkTm90Q29tcGxldGU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHNpYmxpbmdGaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yayA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICB9IHdoaWxlIChjb21wbGV0ZWRXb3JrICE9PSBudWxsKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCByZW5kZXJQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0gd2hpbGUgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKTsKICAgICAgICAgIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3QzLmZpbmlzaGVkTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicm9vdC5maW5pc2hlZExhbmVzIHNob3VsZCBub3QgYmUgZW1wdHkgZHVyaW5nIGEgY29tbWl0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gcm9vdDMuY3VycmVudCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgdGhlIHNhbWUgdHJlZSBhcyBiZWZvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyB8fCAoZmluaXNoZWRXb3JrLmZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IHRyYW5zaXRpb25zOwogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1YnRyZWVIYXNFZmZlY3RzID0gKGZpbmlzaGVkV29yay5zdWJ0cmVlRmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoc3VidHJlZUhhc0VmZmVjdHMgfHwgcm9vdEhhc0VmZmVjdCkgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVjb3JkQ29tbWl0VGltZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxdWVzdFBhaW50KCk7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICBpZiAocm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBsYW5lczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcm9vdERpZEhhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihyb290My5jdXJyZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCByZW5kZXJQcmlvcml0eUxldmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcm9vdDMubWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY292ZXJhYmxlRXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSByZWNvdmVyYWJsZUVycm9yc1tpXTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgIHZhciBkaWdlc3QgPSByZWNvdmVyYWJsZUVycm9yLmRpZ2VzdDsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IocmVjb3ZlcmFibGVFcnJvci52YWx1ZSwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICBkaWdlc3QKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzLCBTeW5jTGFuZSkgJiYgcm9vdDMudGFnICE9PSBMZWdhY3lSb290KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gcm9vdFdpdGhOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gcm9vdDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdHkgPSBsb3dlckV2ZW50UHJpb3JpdHkoRGVmYXVsdEV2ZW50UHJpb3JpdHksIHJlbmRlclByaW9yaXR5KTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICByZXR1cm4gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMucHVzaChmaWJlcik7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFuc2l0aW9ucyA9IHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnM7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXM7CiAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZsdXNoIHBhc3NpdmUgZWZmZWN0cyB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCByb290My5jdXJyZW50LCBsYW5lcywgdHJhbnNpdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvZmlsZXJFZmZlY3RzID0gcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHM7CiAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlciA9IHByb2ZpbGVyRWZmZWN0c1tpXTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKHJvb3QzLCBfZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSByb290My5jdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtpbnN0YW5jZV0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKCFoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuY2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qocm9vdEZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IyKSB7CiAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IyLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKHJvb3RGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3Ioc291cmNlRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVwb3J0VW5jYXVnaHRFcnJvckluREVWKGVycm9yJDEpOwogICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qoc291cmNlRmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIgPSBuZWFyZXN0TW91bnRlZEFuY2VzdG9yOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3QoZmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogQXR0ZW1wdGVkIHRvIGNhcHR1cmUgYSBjb21taXQgcGhhc2UgZXJyb3IgaW5zaWRlIGEgZGV0YWNoZWQgdHJlZS4gVGhpcyBpbmRpY2F0ZXMgYSBidWcgaW4gUmVhY3QuIExpa2VseSBjYXVzZXMgaW5jbHVkZSBkZWxldGluZyB0aGUgc2FtZSBmaWJlciBtb3JlIHRoYW4gb25jZSwgY29tbWl0dGluZyBhbiBhbHJlYWR5LWZpbmlzaGVkIHRyZWUsIG9yIGFuIGluY29uc2lzdGVudCByZXR1cm4gcG9pbnRlci5cblxuRXJyb3IgbWVzc2FnZTpcblxuJXMiLCBlcnJvciQxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGluZ1N1c3BlbmRlZFJvb3Qocm9vdDMsIHdha2VhYmxlLCBwaW5nZWRMYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5IHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgJiYgaW5jbHVkZXNPbmx5UmV0cmllcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcykgJiYgbm93KCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHJlcXVlc3RSZXRyeUxhbmUoYm91bmRhcnlGaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShib3VuZGFyeUZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZXRyeUNhY2hlOwogICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpuZCh0aW1lRWxhcHNlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWVFbGFwc2VkIDwgMTIwID8gMTIwIDogdGltZUVsYXBzZWQgPCA0ODAgPyA0ODAgOiB0aW1lRWxhcHNlZCA8IDEwODAgPyAxMDgwIDogdGltZUVsYXBzZWQgPCAxOTIwID8gMTkyMCA6IHRpbWVFbGFwc2VkIDwgM2UzID8gM2UzIDogdGltZUVsYXBzZWQgPCA0MzIwID8gNDMyMCA6IGNlaWwyKHRpbWVFbGFwc2VkIC8gMTk2MCkgKiAxOTYwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0Zvck5lc3RlZFVwZGF0ZXMoKSB7CiAgICAgICAgICBpZiAobmVzdGVkVXBkYXRlQ291bnQgPiBORVNURURfVVBEQVRFX0xJTUlUKSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNYXhpbXVtIHVwZGF0ZSBkZXB0aCBleGNlZWRlZC4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSBjb21wb25lbnQgcmVwZWF0ZWRseSBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgY29tcG9uZW50V2lsbFVwZGF0ZSBvciBjb21wb25lbnREaWRVcGRhdGUuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIG5lc3RlZCB1cGRhdGVzIHRvIHByZXZlbnQgaW5maW5pdGUgbG9vcHMuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPiBORVNURURfUEFTU0lWRV9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICAgIGVycm9yKCJNYXhpbXVtIHVwZGF0ZSBkZXB0aCBleGNlZWRlZC4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSBjb21wb25lbnQgY2FsbHMgc2V0U3RhdGUgaW5zaWRlIHVzZUVmZmVjdCwgYnV0IHVzZUVmZmVjdCBlaXRoZXIgZG9lc24ndCBoYXZlIGEgZGVwZW5kZW5jeSBhcnJheSwgb3Igb25lIG9mIHRoZSBkZXBlbmRlbmNpZXMgY2hhbmdlcyBvbiBldmVyeSByZW5kZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hSZW5kZXJQaGFzZVN0cmljdE1vZGVXYXJuaW5nc0luREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nKCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihmaWJlciwgaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgaWYgKGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudFBhc3NpdmVEZXYsIGludm9rZVBhc3NpdmVFZmZlY3RVbm1vdW50SW5ERVYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRMYXlvdXREZXYsIGludm9rZUxheW91dEVmZmVjdE1vdW50SW5ERVYpOwogICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUVmZmVjdHNJbkRldihmaXJzdENoaWxkLCBmaWJlckZsYWdzLCBpbnZva2VFZmZlY3RGbikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgc3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeVN1YnRyZWVGbGFnID0gY3VycmVudDIuc3VidHJlZUZsYWdzICYgZmliZXJGbGFnczsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IHN1YnRyZWVSb290ICYmIGN1cnJlbnQyLmNoaWxkICE9PSBudWxsICYmIHByaW1hcnlTdWJ0cmVlRmxhZyAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgY3VycmVudDIgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKChjdXJyZW50Mi5mbGFncyAmIGZpYmVyRmxhZ3MpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIGludm9rZUVmZmVjdEZuKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Mi5zaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQyID0gY3VycmVudDIuc2libGluZzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQyID0gc3VidHJlZVJvb3QgPSBjdXJyZW50Mi5yZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGFnID0gZmliZXIudGFnOwogICAgICAgICAgICBpZiAodGFnICE9PSBJbmRldGVybWluYXRlQ29tcG9uZW50ICYmIHRhZyAhPT0gSG9zdFJvb3QgJiYgdGFnICE9PSBDbGFzc0NvbXBvbmVudCAmJiB0YWcgIT09IEZ1bmN0aW9uQ29tcG9uZW50ICYmIHRhZyAhPT0gRm9yd2FyZFJlZiAmJiB0YWcgIT09IE1lbW9Db21wb25lbnQgJiYgdGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlJlYWN0Q29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtjb21wb25lbnROYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbid0IHBlcmZvcm0gYSBSZWFjdCBzdGF0ZSB1cGRhdGUgb24gYSBjb21wb25lbnQgdGhhdCBoYXNuJ3QgbW91bnRlZCB5ZXQuIFRoaXMgaW5kaWNhdGVzIHRoYXQgeW91IGhhdmUgYSBzaWRlLWVmZmVjdCBpbiB5b3VyIHJlbmRlciBmdW5jdGlvbiB0aGF0IGFzeW5jaHJvbm91c2x5IGxhdGVyIGNhbGxzIHRyaWVzIHRvIHVwZGF0ZSB0aGUgY29tcG9uZW50LiBNb3ZlIHRoaXMgd29yayB0byB1c2VFZmZlY3QgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJlZ2luV29yayQxOwogICAgICAgIHsKICAgICAgICAgIHZhciBkdW1teUZpYmVyID0gbnVsbDsKICAgICAgICAgIGJlZ2luV29yayQxID0gZnVuY3Rpb24oY3VycmVudDIsIHVuaXRPZldvcmssIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSA9IGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKGR1bW15RmliZXIsIHVuaXRPZldvcmspOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBiZWdpbldvcmsoY3VycmVudDIsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgfSBjYXRjaCAob3JpZ2luYWxFcnJvcikgewogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgfHwgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgb3JpZ2luYWxFcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgcmVzZXRIb29rc0FmdGVyVGhyb3coKTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDIsIHVuaXRPZldvcmspOwogICAgICAgICAgICAgIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHVuaXRPZldvcmssIG9yaWdpbmFsV29ya0luUHJvZ3Jlc3NDb3B5KTsKICAgICAgICAgICAgICBpZiAodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGJlZ2luV29yaywgbnVsbCwgY3VycmVudDIsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICAgICAgdmFyIHJlcGxheUVycm9yID0gY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXBsYXlFcnJvciA9PT0gIm9iamVjdCIgJiYgcmVwbGF5RXJyb3IgIT09IG51bGwgJiYgcmVwbGF5RXJyb3IuX3N1cHByZXNzTG9nZ2luZyAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiAhb3JpZ2luYWxFcnJvci5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQ7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmICFnZXRJc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlSW5ERVYoKSkgewogICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJpbmdDb21wb25lbnROYW1lID0gd29ya0luUHJvZ3Jlc3MgJiYgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzcykgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICB2YXIgZGVkdXBlS2V5ID0gcmVuZGVyaW5nQ29tcG9uZW50TmFtZTsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQuaGFzKGRlZHVwZUtleSkpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQuYWRkKGRlZHVwZUtleSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNldFN0YXRlQ29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IHVwZGF0ZSBhIGNvbXBvbmVudCAoYCVzYCkgd2hpbGUgcmVuZGVyaW5nIGEgZGlmZmVyZW50IGNvbXBvbmVudCAoYCVzYCkuIFRvIGxvY2F0ZSB0aGUgYmFkIHNldFN0YXRlKCkgY2FsbCBpbnNpZGUgYCVzYCwgZm9sbG93IHRoZSBzdGFjayB0cmFjZSBhcyBkZXNjcmliZWQgaW4gaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NldHN0YXRlLWluLXJlbmRlciIsIHNldFN0YXRlQ29tcG9uZW50TmFtZSwgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSwgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IHVwZGF0ZSBkdXJpbmcgYW4gZXhpc3Rpbmcgc3RhdGUgdHJhbnNpdGlvbiAoc3VjaCBhcyB3aXRoaW4gYHJlbmRlcmApLiBSZW5kZXIgbWV0aG9kcyBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZS4iKTsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmZvckVhY2goZnVuY3Rpb24oc2NoZWR1bGluZ0ZpYmVyKSB7CiAgICAgICAgICAgICAgICBhZGRGaWJlclRvTGFuZXNNYXAocm9vdDMsIHNjaGVkdWxpbmdGaWJlciwgbGFuZXMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmYWtlQWN0Q2FsbGJhY2tOb2RlID0ge307CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFjayQxKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudDsKICAgICAgICAgICAgaWYgKGFjdFF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWN0UXVldWUucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgICAgcmV0dXJuIGZha2VBY3RDYWxsYmFja05vZGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlQ2FsbGJhY2socHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbmNlbENhbGxiYWNrJDEoY2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2tOb2RlID09PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjYW5jZWxDYWxsYmFjayhjYWxsYmFja05vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgIGlmICghaXNDb25jdXJyZW50QWN0RW52aXJvbm1lbnQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWlzTGVnYWN5QWN0RW52aXJvbm1lbnQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXhlY3V0aW9uQ29udGV4dCAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IEZ1bmN0aW9uQ29tcG9uZW50ICYmIGZpYmVyLnRhZyAhPT0gRm9yd2FyZFJlZiAmJiBmaWJlci50YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgdG8gJXMgaW5zaWRlIGEgdGVzdCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IGNhdXNlcyBSZWFjdCBzdGF0ZSB1cGRhdGVzIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpcmUgZXZlbnRzIHRoYXQgdXBkYXRlIHN0YXRlICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdXNwZW5zZVJlc29sdXRpb25Ob3RXcmFwcGVkV2l0aEFjdERFVihyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgc3VzcGVuZGVkIHJlc291cmNlIGZpbmlzaGVkIGxvYWRpbmcgaW5zaWRlIGEgdGVzdCwgYnV0IHRoZSBldmVudCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IHJlc29sdmVzIHN1c3BlbmRlZCBkYXRhIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpbmlzaCBsb2FkaW5nIHN1c3BlbmRlZCBkYXRhICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoaXNSdW5uaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGlzUnVubmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlc29sdmVGYW1pbHkgPSBudWxsOwogICAgICAgIHZhciBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICB2YXIgc2V0UmVmcmVzaEhhbmRsZXIgPSBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc29sdmVGYW1pbHkgPSBoYW5kbGVyOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KHR5cGUpOwogICAgICAgICAgICBpZiAoZmFtaWx5ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAodHlwZSAhPT0gbnVsbCAmJiB0eXBlICE9PSB2b2lkIDAgJiYgdHlwZW9mIHR5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlbmRlciA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgICBpZiAodHlwZS5yZW5kZXIgIT09IGN1cnJlbnRSZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHN5bnRoZXRpY1R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUsCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyOiBjdXJyZW50UmVuZGVyCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlLmRpc3BsYXlOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBzeW50aGV0aWNUeXBlLmRpc3BsYXlOYW1lID0gdHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gc3ludGhldGljVHlwZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoZmliZXIsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZUeXBlID0gZmliZXIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHZhciBuZXh0VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgdmFyIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gZmFsc2U7CiAgICAgICAgICAgIHZhciAkJHR5cGVvZk5leHRUeXBlID0gdHlwZW9mIG5leHRUeXBlID09PSAib2JqZWN0IiAmJiBuZXh0VHlwZSAhPT0gbnVsbCA/IG5leHRUeXBlLiQkdHlwZW9mIDogbnVsbDsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRUeXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRUeXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6IHsKICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTUVNT19UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc0NvbXBhcmVGYW1pbGllcykgewogICAgICAgICAgICAgIHZhciBwcmV2RmFtaWx5ID0gcmVzb2x2ZUZhbWlseShwcmV2VHlwZSk7CiAgICAgICAgICAgICAgaWYgKHByZXZGYW1pbHkgIT09IHZvaWQgMCAmJiBwcmV2RmFtaWx5ID09PSByZXNvbHZlRmFtaWx5KG5leHRUeXBlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBXZWFrU2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmFpbGVkQm91bmRhcmllcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhaWxlZEJvdW5kYXJpZXMuYWRkKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlUmVmcmVzaCA9IGZ1bmN0aW9uKHJvb3QzLCB1cGRhdGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0YWxlRmFtaWxpZXMgPSB1cGRhdGUuc3RhbGVGYW1pbGllcywgdXBkYXRlZEZhbWlsaWVzID0gdXBkYXRlLnVwZGF0ZWRGYW1pbGllczsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBzY2hlZHVsZVJvb3QgPSBmdW5jdGlvbihyb290MywgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocm9vdDMuY29udGV4dCAhPT0gZW1wdHlDb250ZXh0T2JqZWN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihlbGVtZW50LCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShmaWJlciwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGUsIGNoaWxkID0gZmliZXIuY2hpbGQsIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nLCB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICB2YXIgY2FuZGlkYXRlVHlwZSA9IG51bGw7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlc29sdmVGYW1pbHkgdG8gYmUgc2V0IGR1cmluZyBob3QgcmVsb2FkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZWVkc1JlbmRlciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkoY2FuZGlkYXRlVHlwZSk7CiAgICAgICAgICAgICAgaWYgKGZhbWlseSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhbGVGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1cGRhdGVkRmFtaWxpZXMuaGFzKGZhbWlseSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBmaWJlci5fZGVidWdOZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQgfHwgbmVlZHNSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3QgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAoX3Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihfcm9vdCwgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCAmJiAhbmVlZHNSZW1vdW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShjaGlsZCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoc2libGluZywgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIGZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHR5cGVzID0gbmV3IFNldChmYW1pbGllcy5tYXAoZnVuY3Rpb24oZmFtaWx5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIHJldHVybiBob3N0SW5zdGFuY2VzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGZpYmVyLCB0eXBlcywgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGlkTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZXMuaGFzKGNhbmRpZGF0ZVR5cGUpKSB7CiAgICAgICAgICAgICAgICBkaWRNYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRNYXRjaCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGNoaWxkLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHNpYmxpbmcsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmaW5kQ2hpbGRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICBpZiAoZm91bmRIb3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byByZWFjaCByb290IGZpcnN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIGZvdW5kSG9zdEluc3RhbmNlcyA9IHRydWU7CiAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kSG9zdEluc3RhbmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc0JhZE1hcFBvbHlmaWxsOwogICAgICAgIHsKICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gZmFsc2U7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbm9uRXh0ZW5zaWJsZU9iamVjdCA9IE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh7fSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbbm9uRXh0ZW5zaWJsZU9iamVjdCwgbnVsbF1dKTsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW25vbkV4dGVuc2libGVPYmplY3RdKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFzQmFkTWFwUG9seWZpbGwgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgIHRoaXMuZWxlbWVudFR5cGUgPSBudWxsOwogICAgICAgICAgdGhpcy50eXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMucmV0dXJuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2hpbGQgPSBudWxsOwogICAgICAgICAgdGhpcy5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgdGhpcy5yZWYgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICB0aGlzLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgdGhpcy51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB0aGlzLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgdGhpcy5tb2RlID0gbW9kZTsKICAgICAgICAgIHRoaXMuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgdGhpcy5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnNlbGZCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnRyZWVCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZGVidWdTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdOZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fZGVidWdIb29rVHlwZXMgPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc0JhZE1hcFBvbHlmaWxsICYmIHR5cGVvZiBPYmplY3QucHJldmVudEV4dGVuc2lvbnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBPYmplY3QucHJldmVudEV4dGVuc2lvbnModGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUZpYmVyID0gZnVuY3Rpb24odGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2ltcGxlRnVuY3Rpb25Db21wb25lbnQodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iICYmICFzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSAmJiB0eXBlLmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpID8gQ2xhc3NDb21wb25lbnQgOiBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoQ29tcG9uZW50ICE9PSB2b2lkIDAgJiYgQ29tcG9uZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciAkJHR5cGVvZiA9IENvbXBvbmVudC4kJHR5cGVvZjsKICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIEZvcndhcmRSZWY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUpIHsKICAgICAgICAgICAgICByZXR1cm4gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSBjdXJyZW50Mi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiA9IGNyZWF0ZUZpYmVyKGN1cnJlbnQyLnRhZywgcGVuZGluZ1Byb3BzLCBjdXJyZW50Mi5rZXksIGN1cnJlbnQyLm1vZGUpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPSBjdXJyZW50Mi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50Mi50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3VycmVudDIuc3RhdGVOb2RlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZSA9IGN1cnJlbnQyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgPSBjdXJyZW50Mi5fZGVidWdPd25lcjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gY3VycmVudDIuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBjdXJyZW50MjsKICAgICAgICAgICAgY3VycmVudDIuYWx0ZXJuYXRlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50Mi50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gY3VycmVudDIuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50Mi5jaGlsZExhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnREZXBlbmRlbmNpZXMgPSBjdXJyZW50Mi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICBmaXJzdENvbnRleHQ6IGN1cnJlbnREZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNpYmxpbmcgPSBjdXJyZW50Mi5zaWJsaW5nOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmluZGV4ID0gY3VycmVudDIuaW5kZXg7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucmVmID0gY3VycmVudDIucmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnQyLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IGN1cnJlbnQyLl9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcoY3VycmVudDIudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcoY3VycmVudDIudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQyLnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0V29ya0luUHJvZ3Jlc3Mod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSBTdGF0aWNNYXNrIHwgUGxhY2VtZW50OwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IGN1cnJlbnQyLmNoaWxkTGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQyLmxhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDIudHlwZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnREZXBlbmRlbmNpZXMgPSBjdXJyZW50Mi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBjdXJyZW50RGVwZW5kZW5jaWVzID09PSBudWxsID8gbnVsbCA6IHsKICAgICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgICBmaXJzdENvbnRleHQ6IGN1cnJlbnREZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnQyLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gPSBjdXJyZW50Mi50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVIb3N0Um9vdEZpYmVyKHRhZywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlKSB7CiAgICAgICAgICB2YXIgbW9kZTsKICAgICAgICAgIGlmICh0YWcgPT09IENvbmN1cnJlbnRSb290KSB7CiAgICAgICAgICAgIG1vZGUgPSBDb25jdXJyZW50TW9kZTsKICAgICAgICAgICAgaWYgKGlzU3RyaWN0TW9kZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0TGVnYWN5TW9kZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbW9kZSA9IE5vTW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICBtb2RlIHw9IFByb2ZpbGVNb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyKEhvc3RSb290LCBudWxsLCBudWxsLCBtb2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBmaWJlclRhZyA9IEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRUeXBlID0gdHlwZTsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpZiAoc2hvdWxkQ29uc3RydWN0JDEodHlwZSkpIHsKICAgICAgICAgICAgICBmaWJlclRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcocmVzb2x2ZWRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGZpYmVyVGFnID0gSG9zdENvbXBvbmVudDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdldFRhZzogc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KHBlbmRpbmdQcm9wcy5jaGlsZHJlbiwgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgICAgZmliZXJUYWcgPSBNb2RlOwogICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RFZmZlY3RzTW9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZShwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlTGlzdChwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfT0ZGU0NSRUVOX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TQ09QRV9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ0FDSEVfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1RSQUNJTkdfTUFSS0VSX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9ERUJVR19UUkFDSU5HX01PREVfVFlQRToKICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IENvbnRleHRDb25zdW1lcjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IEZvcndhcmRSZWY7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IExhenlDb21wb25lbnQ7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpbmZvMiArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBvd25lciA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGluZm8yICs9ICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgdHlwZSBpcyBpbnZhbGlkOiBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgIiArICgiYnV0IGdvdDogIiArICh0eXBlID09IG51bGwgPyB0eXBlIDogdHlwZW9mIHR5cGUpICsgIi4iICsgaW5mbzIpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKGZpYmVyVGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IHR5cGU7CiAgICAgICAgICBmaWJlci50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBvd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIG93bmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IGVsZW1lbnQucHJvcHM7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEZyYWdtZW50MiwgZWxlbWVudHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1Byb2ZpbGVyIG11c3Qgc3BlY2lmeSBhbiAiaWQiIG9mIHR5cGUgYHN0cmluZ2AgYXMgYSBwcm9wLiBSZWNlaXZlZCB0aGUgdHlwZSBgJXNgIGluc3RlYWQuJywgdHlwZW9mIHBlbmRpbmdQcm9wcy5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFByb2ZpbGVyLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSB8IFByb2ZpbGVNb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgICBlZmZlY3REdXJhdGlvbjogMCwKICAgICAgICAgICAgICBwYXNzaXZlRWZmZWN0RHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VMaXN0Q29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKE9mZnNjcmVlbkNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9PRkZTQ1JFRU5fVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkSW5zdGFuY2UgPSB7CiAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHByaW1hcnlDaGlsZEluc3RhbmNlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UZXh0KGNvbnRlbnQsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0VGV4dCwgY29udGVudCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9ICJERUxFVEVEIjsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KGRlaHlkcmF0ZWROb2RlKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihEZWh5ZHJhdGVkRnJhZ21lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBkZWh5ZHJhdGVkTm9kZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RQb3J0YWwsIHBlbmRpbmdQcm9wcywgcG9ydGFsLmtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICBjb250YWluZXJJbmZvOiBwb3J0YWwuY29udGFpbmVySW5mbywKICAgICAgICAgICAgcGVuZGluZ0NoaWxkcmVuOiBudWxsLAogICAgICAgICAgICAvLyBVc2VkIGJ5IHBlcnNpc3RlbnQgdXBkYXRlcwogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogcG9ydGFsLmltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgaWYgKHRhcmdldCA9PT0gbnVsbCkgewogICAgICAgICAgICB0YXJnZXQgPSBjcmVhdGVGaWJlcihJbmRldGVybWluYXRlQ29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0LnRhZyA9IHNvdXJjZS50YWc7CiAgICAgICAgICB0YXJnZXQua2V5ID0gc291cmNlLmtleTsKICAgICAgICAgIHRhcmdldC5lbGVtZW50VHlwZSA9IHNvdXJjZS5lbGVtZW50VHlwZTsKICAgICAgICAgIHRhcmdldC50eXBlID0gc291cmNlLnR5cGU7CiAgICAgICAgICB0YXJnZXQuc3RhdGVOb2RlID0gc291cmNlLnN0YXRlTm9kZTsKICAgICAgICAgIHRhcmdldC5yZXR1cm4gPSBzb3VyY2UucmV0dXJuOwogICAgICAgICAgdGFyZ2V0LmNoaWxkID0gc291cmNlLmNoaWxkOwogICAgICAgICAgdGFyZ2V0LnNpYmxpbmcgPSBzb3VyY2Uuc2libGluZzsKICAgICAgICAgIHRhcmdldC5pbmRleCA9IHNvdXJjZS5pbmRleDsKICAgICAgICAgIHRhcmdldC5yZWYgPSBzb3VyY2UucmVmOwogICAgICAgICAgdGFyZ2V0LnBlbmRpbmdQcm9wcyA9IHNvdXJjZS5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRQcm9wcyA9IHNvdXJjZS5tZW1vaXplZFByb3BzOwogICAgICAgICAgdGFyZ2V0LnVwZGF0ZVF1ZXVlID0gc291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkU3RhdGUgPSBzb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHRhcmdldC5kZXBlbmRlbmNpZXMgPSBzb3VyY2UuZGVwZW5kZW5jaWVzOwogICAgICAgICAgdGFyZ2V0Lm1vZGUgPSBzb3VyY2UubW9kZTsKICAgICAgICAgIHRhcmdldC5mbGFncyA9IHNvdXJjZS5mbGFnczsKICAgICAgICAgIHRhcmdldC5zdWJ0cmVlRmxhZ3MgPSBzb3VyY2Uuc3VidHJlZUZsYWdzOwogICAgICAgICAgdGFyZ2V0LmRlbGV0aW9ucyA9IHNvdXJjZS5kZWxldGlvbnM7CiAgICAgICAgICB0YXJnZXQubGFuZXMgPSBzb3VyY2UubGFuZXM7CiAgICAgICAgICB0YXJnZXQuY2hpbGRMYW5lcyA9IHNvdXJjZS5jaGlsZExhbmVzOwogICAgICAgICAgdGFyZ2V0LmFsdGVybmF0ZSA9IHNvdXJjZS5hbHRlcm5hdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxEdXJhdGlvbiA9IHNvdXJjZS5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbFN0YXJ0VGltZSA9IHNvdXJjZS5hY3R1YWxTdGFydFRpbWU7CiAgICAgICAgICAgIHRhcmdldC5zZWxmQmFzZUR1cmF0aW9uID0gc291cmNlLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC50cmVlQmFzZUR1cmF0aW9uID0gc291cmNlLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQuX2RlYnVnU291cmNlID0gc291cmNlLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHRhcmdldC5fZGVidWdPd25lciA9IHNvdXJjZS5fZGVidWdPd25lcjsKICAgICAgICAgIHRhcmdldC5fZGVidWdOZWVkc1JlbW91bnQgPSBzb3VyY2UuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z0hvb2tUeXBlcyA9IHNvdXJjZS5fZGVidWdIb29rVHlwZXM7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lckluZm8gPSBjb250YWluZXJJbmZvOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgdGhpcy5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGluZ0NhY2hlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHRoaXMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHRoaXMuZXZlbnRUaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmV4cGlyYXRpb25UaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9UaW1lc3RhbXApOwogICAgICAgICAgdGhpcy5wZW5kaW5nTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZXhwaXJlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMubXV0YWJsZVJlYWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlbWVudHMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5pZGVudGlmaWVyUHJlZml4ID0gaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHRoaXMub25SZWNvdmVyYWJsZUVycm9yID0gb25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm1lbW9pemVkVXBkYXRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHRoaXMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgVG90YWxMYW5lczsgX2krKykgewogICAgICAgICAgICAgIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAucHVzaCgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgQ29uY3VycmVudFJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZVJvb3QoKSIgOiAiY3JlYXRlUm9vdCgpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTGVnYWN5Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlKCkiIDogInJlbmRlcigpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciByb290MyA9IG5ldyBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB2YXIgdW5pbml0aWFsaXplZEZpYmVyID0gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSk7CiAgICAgICAgICByb290My5jdXJyZW50ID0gdW5pbml0aWFsaXplZEZpYmVyOwogICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IHJvb3QzOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2luaXRpYWxTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBoeWRyYXRlMiwKICAgICAgICAgICAgICBjYWNoZTogbnVsbCwKICAgICAgICAgICAgICAvLyBub3QgZW5hYmxlZCB5ZXQKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbCwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5tZW1vaXplZFN0YXRlID0gX2luaXRpYWxTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh1bmluaXRpYWxpemVkRmliZXIpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsKGNoaWxkcmVuLCBjb250YWluZXJJbmZvLCBpbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihrZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3cgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IFBvcnRhbAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUE9SVEFMX1RZUEUsCiAgICAgICAgICAgIGtleToga2V5ID09IG51bGwgPyBudWxsIDogIiIgKyBrZXksCiAgICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgICBjb250YWluZXJJbmZvLAogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgaWYgKCFwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldChwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgQ29tcG9uZW50LCBwYXJlbnRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnQsIG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGNvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhjb21wb25lbnQpLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgYXBwZWFycyB0byBub3QgYmUgYSBSZWFjdENvbXBvbmVudC4gS2V5czogIiArIGtleXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhvc3RGaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGhvc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggaXMgaW5zaWRlIFN0cmljdE1vZGUuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggcmVuZGVycyBTdHJpY3RNb2RlIGNoaWxkcmVuLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldmlvdXNGaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaW5pdGlhbENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgY2FsbGJhY2ssIGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gdHJ1ZTsKICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgcm9vdDMuY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKG51bGwpOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gcm9vdDMuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwgPyBjYWxsYmFjayA6IG51bGw7CiAgICAgICAgICBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyMiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBvblNjaGVkdWxlUm9vdChjb250YWluZXIyLCBlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50JDEgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50JDEpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb250YWluZXIyLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wZW5kaW5nQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiBjdXJyZW50ICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyB0cmlnZ2VyaW5nIG5lc3RlZCBjb21wb25lbnQgdXBkYXRlcyBmcm9tIHJlbmRlciBpcyBub3QgYWxsb3dlZC4gSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIG5lc3RlZCB1cGRhdGVzIGluIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50KSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgfTsKICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQkMSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgY3VycmVudCQxLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNSb290SW5zdGFuY2UoY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGNvbnRhaW5lckZpYmVyID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgaWYgKCFjb250YWluZXJGaWJlci5jaGlsZCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoY29udGFpbmVyRmliZXIuY2hpbGQudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgIHZhciBsYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290Myk7CiAgICAgICAgICAgICAgICBmbHVzaFJvb3Qocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByb290NCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgaWYgKHJvb3Q0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290NCwgZmliZXIsIFN5bmNMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBTeW5jTGFuZTsKICAgICAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCAmJiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBoaWdoZXJQcmlvcml0eUxhbmUoc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUpIHsKICAgICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoYWx0ZXJuYXRlLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHMoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkRXJyb3JJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRXJyb3IoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRFcnJvckltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkU3VzcGVuZEltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU3VzcGVuZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZFN1c3BlbmRJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wcyA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBzY2hlZHVsZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIHNldEVycm9ySGFuZGxlciA9IG51bGw7CiAgICAgICAgdmFyIHNldFN1c3BlbnNlSGFuZGxlciA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlSW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24oe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBwYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5KHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShrZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aERlbGV0ZUltcGwob2JqW2tleV0sIHBhdGgsIGluZGV4MiArIDEpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGUgPSBmdW5jdGlvbihvYmosIHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoRGVsZXRlSW1wbChvYmosIHBhdGgsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZUltcGwgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgsIGluZGV4MikgewogICAgICAgICAgICB2YXIgb2xkS2V5ID0gb2xkUGF0aFtpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gb2xkUGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbmV3S2V5ID0gbmV3UGF0aFtpbmRleDJdOwogICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICBpZiAoaXNBcnJheSh1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uob2xkS2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlZFtvbGRLZXldID0gY29weVdpdGhSZW5hbWVJbXBsKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBudW1iZXIgb3Igc3RyaW5nIGlzIGZpbmUgaGVyZQogICAgICAgICAgICAgICAgb2JqW29sZEtleV0sCiAgICAgICAgICAgICAgICBvbGRQYXRoLAogICAgICAgICAgICAgICAgbmV3UGF0aCwKICAgICAgICAgICAgICAgIGluZGV4MiArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZSA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBpZiAob2xkUGF0aC5sZW5ndGggIT09IG5ld1BhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgd2FybjIoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyBvZiB0aGUgc2FtZSBsZW5ndGgiKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdQYXRoLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG9sZFBhdGhbaV0gIT09IG5ld1BhdGhbaV0pIHsKICAgICAgICAgICAgICAgICAgd2FybjIoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyB0byBiZSB0aGUgc2FtZSBleGNlcHQgZm9yIHRoZSBkZWVwZXN0IGtleSIpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFJlbmFtZUltcGwob2JqLCBvbGRQYXRoLCBuZXdQYXRoLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXRJbXBsID0gZnVuY3Rpb24ob2JqLCBwYXRoLCBpbmRleDIsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpbmRleDIgPj0gcGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IHBhdGhbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbih7fSwgb2JqKTsKICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhTZXRJbXBsKG9ialtrZXldLCBwYXRoLCBpbmRleDIgKyAxLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFNldCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoU2V0SW1wbChvYmosIHBhdGgsIDAsIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEhvb2sgPSBmdW5jdGlvbihmaWJlciwgaWQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb29rMiA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50SG9vazIgIT09IG51bGwgJiYgaWQgPiAwKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2syID0gY3VycmVudEhvb2syLm5leHQ7CiAgICAgICAgICAgICAgaWQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY3VycmVudEhvb2syOwogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhTZXQoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aERlbGV0ZShob29rLm1lbW9pemVkU3RhdGUsIHBhdGgpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhSZW5hbWUoaG9vay5tZW1vaXplZFN0YXRlLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24oe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzID0gZnVuY3Rpb24oZmliZXIsIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoU2V0KGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoRGVsZXRlKGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoID0gZnVuY3Rpb24oZmliZXIsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhSZW5hbWUoZmliZXIubWVtb2l6ZWRQcm9wcywgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2NoZWR1bGVVcGRhdGUgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNldEVycm9ySGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZEVycm9ySW1wbCkgewogICAgICAgICAgICBzaG91bGRFcnJvckltcGwgPSBuZXdTaG91bGRFcnJvckltcGw7CiAgICAgICAgICB9OwogICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyID0gZnVuY3Rpb24obmV3U2hvdWxkU3VzcGVuZEltcGwpIHsKICAgICAgICAgICAgc2hvdWxkU3VzcGVuZEltcGwgPSBuZXdTaG91bGRTdXNwZW5kSW1wbDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbXB0eUZpbmRGaWJlckJ5SG9zdEluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyRm9yRGV2VG9vbHMoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0SW50b0RldlRvb2xzKGRldlRvb2xzQ29uZmlnKSB7CiAgICAgICAgICB2YXIgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgPSBkZXZUb29sc0NvbmZpZy5maW5kRmliZXJCeUhvc3RJbnN0YW5jZTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICByZXR1cm4gaW5qZWN0SW50ZXJuYWxzKHsKICAgICAgICAgICAgYnVuZGxlVHlwZTogZGV2VG9vbHNDb25maWcuYnVuZGxlVHlwZSwKICAgICAgICAgICAgdmVyc2lvbjogZGV2VG9vbHNDb25maWcudmVyc2lvbiwKICAgICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogZGV2VG9vbHNDb25maWcucmVuZGVyZXJQYWNrYWdlTmFtZSwKICAgICAgICAgICAgcmVuZGVyZXJDb25maWc6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyQ29uZmlnLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHMsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCwKICAgICAgICAgICAgc2V0RXJyb3JIYW5kbGVyLAogICAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIsCiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlLAogICAgICAgICAgICBjdXJyZW50RGlzcGF0Y2hlclJlZjogUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIsCiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyLAogICAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgfHwgZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZSwKICAgICAgICAgICAgLy8gUmVhY3QgUmVmcmVzaAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUmVmcmVzaCwKICAgICAgICAgICAgc2NoZWR1bGVSb290LAogICAgICAgICAgICBzZXRSZWZyZXNoSGFuZGxlciwKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBhcHBlbmQgb3duZXIgc3RhY2tzIHRvIGVycm9yIG1lc3NhZ2VzIGluIERFViBtb2RlLgogICAgICAgICAgICBnZXRDdXJyZW50RmliZXI6IGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzLAogICAgICAgICAgICAvLyBFbmFibGVzIERldlRvb2xzIHRvIGRldGVjdCByZWNvbmNpbGVyIHZlcnNpb24gcmF0aGVyIHRoYW4gcmVuZGVyZXIgdmVyc2lvbgogICAgICAgICAgICAvLyB3aGljaCBtYXkgbm90IG1hdGNoIGZvciB0aGlyZCBwYXJ0eSByZW5kZXJlcnMuCiAgICAgICAgICAgIHJlY29uY2lsZXJWZXJzaW9uOiBSZWFjdFZlcnNpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvciA9IHR5cGVvZiByZXBvcnRFcnJvciA9PT0gImZ1bmN0aW9uIiA/ICgKICAgICAgICAgIC8vIEluIG1vZGVybiBicm93c2VycywgcmVwb3J0RXJyb3Igd2lsbCBkaXNwYXRjaCBhbiBlcnJvciBldmVudCwKICAgICAgICAgIC8vIGVtdWxhdGluZyBhbiB1bmNhdWdodCBKYXZhU2NyaXB0IGVycm9yLgogICAgICAgICAgcmVwb3J0RXJyb3IKICAgICAgICApIDogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBSZWFjdERPTVJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUucmVuZGVyID0gUmVhY3RET01Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVwZGF0ZSBhbiB1bm1vdW50ZWQgcm9vdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IGRvZXMgbm90IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZENvbnRhaW5lcihhcmd1bWVudHNbMV0pKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBjb250YWluZXIgdG8gdGhlIHNlY29uZCBhcmd1bWVudCBvZiByb290LnJlbmRlciguLi4pLiBZb3UgZG9uJ3QgbmVlZCB0byBwYXNzIGl0IGFnYWluIHNpbmNlIHlvdSBhbHJlYWR5IHBhc3NlZCBpdCB0byBjcmVhdGUgdGhlIHJvb3QuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIHNlY29uZCBhcmd1bWVudCB0byByb290LnJlbmRlciguLi4pIGJ1dCBpdCBvbmx5IGFjY2VwdHMgb25lIGFyZ3VtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhyb290My5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlLnBhcmVudE5vZGUgIT09IGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoZSByb290IGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIHJvb3QudW5tb3VudCgpIHRvIGVtcHR5IGEgcm9vdCdzIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbiwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgIH07CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bm1vdW50ID0gUmVhY3RET01Sb290LnByb3RvdHlwZS51bm1vdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnQoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCBhIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkF0dGVtcHRlZCB0byBzeW5jaHJvbm91c2x5IHVubW91bnQgYSByb290IHdoaWxlIFJlYWN0IHdhcyBhbHJlYWR5IHJlbmRlcmluZy4gUmVhY3QgY2Fubm90IGZpbmlzaCB1bm1vdW50aW5nIHRoZSByb290IHVudGlsIHRoZSBjdXJyZW50IHJlbmRlciBoYXMgY29tcGxldGVkLCB3aGljaCBtYXkgbGVhZCB0byBhIHJhY2UgY29uZGl0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKG51bGwsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjcmVhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpOwogICAgICAgICAgdmFyIGlzU3RyaWN0TW9kZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gbnVsbDsKICAgICAgICAgIGlmIChvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczIuaHlkcmF0ZSkgewogICAgICAgICAgICAgICAgd2FybjIoImh5ZHJhdGUgdGhyb3VnaCBjcmVhdGVSb290IGlzIGRlcHJlY2F0ZWQuIFVzZSBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uczIgPT09ICJvYmplY3QiICYmIG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBKU1ggZWxlbWVudCB0byBjcmVhdGVSb290LiBZb3UgcHJvYmFibHkgbWVhbnQgdG8gY2FsbCByb290LnJlbmRlciBpbnN0ZWFkLiBFeGFtcGxlIHVzYWdlOlxuXG4gIGxldCByb290ID0gY3JlYXRlUm9vdChkb21Db250YWluZXIpO1xuICByb290LnJlbmRlcig8QXBwIC8+KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyYW5zaXRpb25DYWxsYmFja3MgPSBvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVDb250YWluZXIoY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIG51bGwsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTVJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5zdGFibGVfc2NoZWR1bGVIeWRyYXRpb24gPSBzY2hlZHVsZUh5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoeWRyYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoIk11c3QgcHJvdmlkZSBpbml0aWFsIGNoaWxkcmVuIGFzIHNlY29uZCBhcmd1bWVudCB0byBoeWRyYXRlUm9vdC4gRXhhbXBsZSB1c2FnZTogaHlkcmF0ZVJvb3QoZG9tQ29udGFpbmVyLCA8QXBwIC8+KSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIgIT0gbnVsbCA/IG9wdGlvbnMyIDogbnVsbDsKICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlcyA9IG9wdGlvbnMyICE9IG51bGwgJiYgb3B0aW9uczIuaHlkcmF0ZWRTb3VyY2VzIHx8IG51bGw7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhjb250YWluZXIyKTsKICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG11dGFibGVTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSBtdXRhYmxlU291cmNlc1tpXTsKICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gcGFzc2VkIHRvIGNyZWF0ZVJvb3QoKSBiZWZvcmUuIEluc3RlYWQsIGNhbGwgcm9vdC5yZW5kZXIoKSBvbiB0aGUgZXhpc3Rpbmcgcm9vdCBpbnN0ZWFkIGlmIHlvdSB3YW50IHRvIHVwZGF0ZSBpdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgdG9wTGV2ZWxVcGRhdGVXYXJuaW5nczsKICAgICAgICB7CiAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzID0gZnVuY3Rpb24oY29udGFpbmVyMikgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyICYmIGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGlzIGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUgdG8gZW1wdHkgYSBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKHJvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCkpOwogICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQgJiYgIWlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKCFjb250YWluZXIyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcE9uUmVjb3ZlcmFibGVFcnJvcigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgaWYgKGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcigKICAgICAgICAgICAgICBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoKTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3RTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIyLmxhc3RDaGlsZCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKF9yb290KTsKICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3QoX3Jvb3QuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhfcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIF9yb290OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgdHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4sIGNvbnRhaW5lcjIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyhjb250YWluZXIyKTsKICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjaywgInJlbmRlciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIHZhciByb290MzsKICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgIHJvb3QzID0gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGZvcmNlSHlkcmF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluZERPTU5vZGUoY29tcG9uZW50T3JFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZERPTU5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoImZpbmRET01Ob2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lciQzLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyOwogICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50Lm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5oeWRyYXRlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIGh5ZHJhdGVSb290KGNvbnRhaW5lciwgZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcihlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00ucmVuZGVyIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBjcmVhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlcigpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnJlbmRlcihlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCA9PSBudWxsIHx8ICFoYXMocGFyZW50Q29tcG9uZW50KSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBhcmVudENvbXBvbmVudCBtdXN0IGJlIGEgdmFsaWQgUmVhY3QgQ29tcG9uZW50Iik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gU3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSS4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QudW5tb3VudCgpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QgPSByb290RWwgJiYgIWdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKTsKICAgICAgICAgICAgICBpZiAocmVuZGVyZWRCeURpZmZlcmVudFJlYWN0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBhbm90aGVyIGNvcHkgb2YgUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBudWxsLCBjb250YWluZXIyLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBudWxsOwogICAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9yb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEoX3Jvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKF9yb290RWwpKTsKICAgICAgICAgICAgICB2YXIgaXNDb250YWluZXJSZWFjdFJvb3QgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyLnBhcmVudE5vZGUpICYmICEhY29udGFpbmVyMi5wYXJlbnROb2RlLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBSZWFjdCBhbmQgaXMgbm90IGEgdG9wLWxldmVsIGNvbnRhaW5lci4gJXMiLCBpc0NvbnRhaW5lclJlYWN0Um9vdCA/ICJZb3UgbWF5IGhhdmUgYWNjaWRlbnRhbGx5IHBhc3NlZCBpbiBhIFJlYWN0IHJvb3Qgbm9kZSBpbnN0ZWFkIG9mIGl0cyBjb250YWluZXIuIiA6ICJJbnN0ZWFkLCBoYXZlIHRoZSBwYXJlbnQgY29tcG9uZW50IHVwZGF0ZSBpdHMgc3RhdGUgYW5kIHJlcmVuZGVyIGluIG9yZGVyIHRvIHJlbW92ZSB0aGlzIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMSk7CiAgICAgICAgc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocnVuV2l0aFByaW9yaXR5KTsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIE1hcCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIE1hcCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBNYXAucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIE1hcC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0ICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgU2V0IGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIFNldC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5jbGVhciAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkZXBlbmRzIG9uIE1hcCBhbmQgU2V0IGJ1aWx0LWluIHR5cGVzLiBNYWtlIHN1cmUgdGhhdCB5b3UgbG9hZCBhIHBvbHlmaWxsIGluIG9sZGVyIGJyb3dzZXJzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtcG9seWZpbGxzIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihyZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMpOwogICAgICAgIHNldEJhdGNoaW5nSW1wbGVtZW50YXRpb24oYmF0Y2hlZFVwZGF0ZXMkMSwgZGlzY3JldGVVcGRhdGVzLCBmbHVzaFN5bmMpOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbCQxKGNoaWxkcmVuLCBjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVQb3J0YWwoY2hpbGRyZW4sIGNvbnRhaW5lcjIsIG51bGwsIGtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIEludGVybmFscyA9IHsKICAgICAgICAgIHVzaW5nQ2xpZW50RW50cnlQb2ludDogZmFsc2UsCiAgICAgICAgICAvLyBLZWVwIGluIHN5bmMgd2l0aCBSZWFjdFRlc3RVdGlscy5qcy4KICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgZm9yIGJldHRlciBtaW5pZmljYXRpb24uCiAgICAgICAgICBFdmVudHM6IFtnZXRJbnN0YW5jZUZyb21Ob2RlLCBnZXROb2RlRnJvbUluc3RhbmNlLCBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlLCBlbnF1ZXVlU3RhdGVSZXN0b3JlLCByZXN0b3JlU3RhdGVJZk5lZWRlZCwgYmF0Y2hlZFVwZGF0ZXMkMV0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QkMShjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBjcmVhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QkMShjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGh5ZHJhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMkMShmbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiZmx1c2hTeW5jIHdhcyBjYWxsZWQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiBSZWFjdCBjYW5ub3QgZmx1c2ggd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4gQ29uc2lkZXIgbW92aW5nIHRoaXMgY2FsbCB0byBhIHNjaGVkdWxlciB0YXNrIG9yIG1pY3JvIHRhc2suIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbHVzaFN5bmMoZm4pOwogICAgICAgIH0KICAgICAgICB2YXIgZm91bmREZXZUb29scyA9IGluamVjdEludG9EZXZUb29scyh7CiAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUsCiAgICAgICAgICBidW5kbGVUeXBlOiAxLAogICAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogInJlYWN0LWRvbSIKICAgICAgICB9KTsKICAgICAgICB7CiAgICAgICAgICBpZiAoIWZvdW5kRGV2VG9vbHMgJiYgY2FuVXNlRE9NICYmIHdpbmRvdy50b3AgPT09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpID4gLTEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJFZGdlIikgPT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpIHsKICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgaWYgKC9eKGh0dHBzP3xmaWxlKTokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCIlY0Rvd25sb2FkIHRoZSBSZWFjdCBEZXZUb29scyBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIiArIChwcm90b2NvbCA9PT0gImZpbGU6IiA/ICJcbllvdSBtaWdodCBuZWVkIHRvIHVzZSBhIGxvY2FsIEhUVFAgc2VydmVyIChpbnN0ZWFkIG9mIGZpbGU6Ly8pOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMtZmFxIiA6ICIiKSwgImZvbnQtd2VpZ2h0OmJvbGQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IEludGVybmFsczsKICAgICAgICBleHBvcnRzLmNyZWF0ZVBvcnRhbCA9IGNyZWF0ZVBvcnRhbCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLmZpbmRET01Ob2RlID0gZmluZERPTU5vZGU7CiAgICAgICAgZXhwb3J0cy5mbHVzaFN5bmMgPSBmbHVzaFN5bmMkMTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBoeWRyYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9iYXRjaGVkVXBkYXRlcyA9IGJhdGNoZWRVcGRhdGVzJDE7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciA9IHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMKdmFyIHJlcXVpcmVfcmVhY3RfZG9tID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGNoZWNrRENFKCk7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMKdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2xpZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgbSA9IHJlcXVpcmVfcmVhY3RfZG9tKCk7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gbS5jcmVhdGVSb290OwogICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gbS5oeWRyYXRlUm9vdDsKICAgIH0gZWxzZSB7CiAgICAgIGkgPSBtLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBmdW5jdGlvbihjLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5jcmVhdGVSb290KGMsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGZ1bmN0aW9uKGMsIGgsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmh5ZHJhdGVSb290KGMsIGgsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHZhciBpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIFJlYWN0MyA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gUmVhY3QzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0LCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdCArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24gPSBPYmplY3QuYXNzaWduOwogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4LnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhcyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bjsKICAgICAgICB2YXIgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd247CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gc2VsZikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSksIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqc3hERVYodHlwZSwgY29uZmlnLCBtYXliZUtleSwgc291cmNlLCBzZWxmKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgICAgaWYgKG1heWJlS2V5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1heWJlS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBtYXliZUtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbzIgPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKCFpbmZvMikgewogICAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvMiA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWVsZW1lbnQuX3N0b3JlIHx8IGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCB8fCBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvID0gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKTsKICAgICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgICB2YXIgY2hpbGRPd25lciA9ICIiOwogICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50Ll9vd25lciAmJiBlbGVtZW50Ll9vd25lciAhPT0gUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgY2hpbGRPd25lciA9ICIgSXQgd2FzIHBhc3NlZCBhIGNoaWxkIGZyb20gIiArIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShlbGVtZW50Ll9vd25lci50eXBlKSArICIuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpOwogICAgICAgICAgICBlcnJvcignRWFjaCBjaGlsZCBpbiBhIGxpc3Qgc2hvdWxkIGhhdmUgYSB1bmlxdWUgImtleSIgcHJvcC4lcyVzIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicsIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8sIGNoaWxkT3duZXIpOwogICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUNoaWxkS2V5cyhub2RlLCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoY2hpbGQsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkRWxlbWVudChub2RlKSkgewogICAgICAgICAgICAgIGlmIChub2RlLl9zdG9yZSkgewogICAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZSkgewogICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRLZXlTcHJlYWQgPSB7fTsKICAgICAgICBmdW5jdGlvbiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBpc1N0YXRpY0NoaWxkcmVuLCBzb3VyY2UsIHNlbGYpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgaW5mbzIgKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvMiArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmZvMiArPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHR5cGVTdHJpbmc7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAibnVsbCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgICAgaW5mbzIgPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9IHR5cGVvZiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganN4REVWKHR5cGUsIHByb3BzLCBrZXksIHNvdXJjZSwgc2VsZik7CiAgICAgICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsaWRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlmIChpc1N0YXRpY0NoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuW2ldLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiBTdGF0aWMgY2hpbGRyZW4gc2hvdWxkIGFsd2F5cyBiZSBhbiBhcnJheS4gWW91IGFyZSBsaWtlbHkgZXhwbGljaXRseSBjYWxsaW5nIFJlYWN0LmpzeHMgb3IgUmVhY3QuanN4REVWLiBVc2UgdGhlIEJhYmVsIHRyYW5zZm9ybSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhjaGlsZHJlbiwgdHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChwcm9wcywgImtleSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcHMpLmZpbHRlcihmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBrICE9PSAia2V5IjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIGJlZm9yZUV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAie2tleTogc29tZUtleSwgIiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie2tleTogc29tZUtleX0iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhZnRlckV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAieyIgKyBrZXlzLmpvaW4oIjogLi4uLCAiKSArICI6IC4uLn0iIDogInt9IjsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0EgcHJvcHMgb2JqZWN0IGNvbnRhaW5pbmcgYSAia2V5IiBwcm9wIGlzIGJlaW5nIHNwcmVhZCBpbnRvIEpTWDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyB7Li4ucHJvcHN9IC8+XG5SZWFjdCBrZXlzIG11c3QgYmUgcGFzc2VkIGRpcmVjdGx5IHRvIEpTWCB3aXRob3V0IHVzaW5nIHNwcmVhZDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyBrZXk9e3NvbWVLZXl9IHsuLi5wcm9wc30gLz4nLCBiZWZvcmVFeGFtcGxlLCBjb21wb25lbnROYW1lLCBhZnRlckV4YW1wbGUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljKHR5cGUsIHByb3BzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBqc3hXaXRoVmFsaWRhdGlvbkR5bmFtaWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIganN4MyA9IGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYzsKICAgICAgICB2YXIganN4czMgPSBqc3hXaXRoVmFsaWRhdGlvblN0YXRpYzsKICAgICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgICBleHBvcnRzLmpzeCA9IGpzeDM7CiAgICAgICAgZXhwb3J0cy5qc3hzID0ganN4czM7CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcwp2YXIgcmVxdWlyZV9qc3hfcnVudGltZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvanN4LXJ1bnRpbWUuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9qc3hfcnVudGltZV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9yZWFjdDQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfY2xpZW50ID0gX190b0VTTShyZXF1aXJlX2NsaWVudCgpLCAxKTsKCi8vIHNyYy9KdXN0Q2FuY2VsLnRzeAp2YXIgaW1wb3J0X3JlYWN0MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vc2hhcmVkL3NyYy91dGlscy5qcwp2YXIgdG9LZWJhYkNhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgIiQxLSQyIikudG9Mb3dlckNhc2UoKTsKdmFyIHRvQ2FtZWxDYXNlID0gKHN0cmluZykgPT4gc3RyaW5nLnJlcGxhY2UoCiAgL14oW0EtWl0pfFtccy1fXSsoXHcpL2csCiAgKG1hdGNoLCBwMSwgcDIpID0+IHAyID8gcDIudG9VcHBlckNhc2UoKSA6IHAxLnRvTG93ZXJDYXNlKCkKKTsKdmFyIHRvUGFzY2FsQ2FzZSA9IChzdHJpbmcpID0+IHsKICBjb25zdCBjYW1lbENhc2UgPSB0b0NhbWVsQ2FzZShzdHJpbmcpOwogIHJldHVybiBjYW1lbENhc2UuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjYW1lbENhc2Uuc2xpY2UoMSk7Cn07CnZhciBtZXJnZUNsYXNzZXMgPSAoLi4uY2xhc3NlcykgPT4gY2xhc3Nlcy5maWx0ZXIoKGNsYXNzTmFtZSwgaW5kZXgsIGFycmF5KSA9PiB7CiAgcmV0dXJuIEJvb2xlYW4oY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUudHJpbSgpICE9PSAiIiAmJiBhcnJheS5pbmRleE9mKGNsYXNzTmFtZSkgPT09IGluZGV4Owp9KS5qb2luKCIgIikudHJpbSgpOwp2YXIgaGFzQTExeVByb3AgPSAocHJvcHMpID0+IHsKICBmb3IgKGNvbnN0IHByb3AgaW4gcHJvcHMpIHsKICAgIGlmIChwcm9wLnN0YXJ0c1dpdGgoImFyaWEtIikgfHwgcHJvcCA9PT0gInJvbGUiIHx8IHByb3AgPT09ICJ0aXRsZSIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzCnZhciBpbXBvcnRfcmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzCnZhciBkZWZhdWx0QXR0cmlidXRlcyA9IHsKICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwKICB3aWR0aDogMjQsCiAgaGVpZ2h0OiAyNCwKICB2aWV3Qm94OiAiMCAwIDI0IDI0IiwKICBmaWxsOiAibm9uZSIsCiAgc3Ryb2tlOiAiY3VycmVudENvbG9yIiwKICBzdHJva2VXaWR0aDogMiwKICBzdHJva2VMaW5lY2FwOiAicm91bmQiLAogIHN0cm9rZUxpbmVqb2luOiAicm91bmQiCn07CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanMKdmFyIEljb24gPSAoMCwgaW1wb3J0X3JlYWN0LmZvcndhcmRSZWYpKAogICh7CiAgICBjb2xvciA9ICJjdXJyZW50Q29sb3IiLAogICAgc2l6ZSA9IDI0LAogICAgc3Ryb2tlV2lkdGggPSAyLAogICAgYWJzb2x1dGVTdHJva2VXaWR0aCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgY2hpbGRyZW4sCiAgICBpY29uTm9kZSwKICAgIC4uLnJlc3QKICB9LCByZWYpID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkoCiAgICAic3ZnIiwKICAgIHsKICAgICAgcmVmLAogICAgICAuLi5kZWZhdWx0QXR0cmlidXRlcywKICAgICAgd2lkdGg6IHNpemUsCiAgICAgIGhlaWdodDogc2l6ZSwKICAgICAgc3Ryb2tlOiBjb2xvciwKICAgICAgc3Ryb2tlV2lkdGg6IGFic29sdXRlU3Ryb2tlV2lkdGggPyBOdW1iZXIoc3Ryb2tlV2lkdGgpICogMjQgLyBOdW1iZXIoc2l6ZSkgOiBzdHJva2VXaWR0aCwKICAgICAgY2xhc3NOYW1lOiBtZXJnZUNsYXNzZXMoImx1Y2lkZSIsIGNsYXNzTmFtZSksCiAgICAgIC4uLiFjaGlsZHJlbiAmJiAhaGFzQTExeVByb3AocmVzdCkgJiYgeyAiYXJpYS1oaWRkZW4iOiAidHJ1ZSIgfSwKICAgICAgLi4ucmVzdAogICAgfSwKICAgIFsKICAgICAgLi4uaWNvbk5vZGUubWFwKChbdGFnLCBhdHRyc10pID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkodGFnLCBhdHRycykpLAogICAgICAuLi5BcnJheS5pc0FycmF5KGNoaWxkcmVuKSA/IGNoaWxkcmVuIDogW2NoaWxkcmVuXQogICAgXQogICkKKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgY3JlYXRlTHVjaWRlSWNvbiA9IChpY29uTmFtZSwgaWNvbk5vZGUpID0+IHsKICBjb25zdCBDb21wb25lbnQgPSAoMCwgaW1wb3J0X3JlYWN0Mi5mb3J3YXJkUmVmKSgKICAgICh7IGNsYXNzTmFtZSwgLi4ucHJvcHMgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0Mi5jcmVhdGVFbGVtZW50KShJY29uLCB7CiAgICAgIHJlZiwKICAgICAgaWNvbk5vZGUsCiAgICAgIGNsYXNzTmFtZTogbWVyZ2VDbGFzc2VzKAogICAgICAgIGBsdWNpZGUtJHt0b0tlYmFiQ2FzZSh0b1Bhc2NhbENhc2UoaWNvbk5hbWUpKX1gLAogICAgICAgIGBsdWNpZGUtJHtpY29uTmFtZX1gLAogICAgICAgIGNsYXNzTmFtZQogICAgICApLAogICAgICAuLi5wcm9wcwogICAgfSkKICApOwogIENvbXBvbmVudC5kaXNwbGF5TmFtZSA9IHRvUGFzY2FsQ2FzZShpY29uTmFtZSk7CiAgcmV0dXJuIENvbXBvbmVudDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctcmlnaHQuanMKdmFyIF9faWNvbk5vZGUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIm0xMiA1IDcgNy03IDciLCBrZXk6ICJ4cXV6NGMiIH1dCl07CnZhciBBcnJvd1JpZ2h0ID0gY3JlYXRlTHVjaWRlSWNvbigiYXJyb3ctcmlnaHQiLCBfX2ljb25Ob2RlKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanMKdmFyIF9faWNvbk5vZGUyID0gW1sicGF0aCIsIHsgZDogIk0yMCA2IDkgMTdsLTUtNSIsIGtleTogIjFnbWYyYyIgfV1dOwp2YXIgQ2hlY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJjaGVjayIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZG9sbGFyLXNpZ24uanMKdmFyIF9faWNvbk5vZGUzID0gWwogIFsibGluZSIsIHsgeDE6ICIxMiIsIHgyOiAiMTIiLCB5MTogIjIiLCB5MjogIjIyIiwga2V5OiAiN2VxeXFoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTcgNUg5LjVhMy41IDMuNSAwIDAgMCAwIDdoNWEzLjUgMy41IDAgMCAxIDAgN0g2Iiwga2V5OiAiMWIwcDRzIiB9XQpdOwp2YXIgRG9sbGFyU2lnbiA9IGNyZWF0ZUx1Y2lkZUljb24oImRvbGxhci1zaWduIiwgX19pY29uTm9kZTMpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9maWxlLXRleHQuanMKdmFyIF9faWNvbk5vZGU0ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDIyYTIgMiAwIDAgMS0yLTJWNGEyIDIgMCAwIDEgMi0yaDhhMi40IDIuNCAwIDAgMSAxLjcwNC43MDZsMy41ODggMy41ODhBMi40IDIuNCAwIDAgMSAyMCA4djEyYTIgMiAwIDAgMS0yIDJ6IiwKICAgICAga2V5OiAiMW9lZmo2IgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTE0IDJ2NWExIDEgMCAwIDAgMSAxaDUiLCBrZXk6ICJ3ZnNncnoiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMCA5SDgiLCBrZXk6ICJiMW1ybHIiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNiAxM0g4Iiwga2V5OiAidDRlMDAyIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTYgMTdIOCIsIGtleTogInoxdWgzYSIgfV0KXTsKdmFyIEZpbGVUZXh0ID0gY3JlYXRlTHVjaWRlSWNvbigiZmlsZS10ZXh0IiwgX19pY29uTm9kZTQpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wZW4tbGluZS5qcwp2YXIgX19pY29uTm9kZTUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEzIDIxaDgiLCBrZXk6ICIxanNuNWkiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMS4xNzQgNi44MTJhMSAxIDAgMCAwLTMuOTg2LTMuOTg3TDMuODQyIDE2LjE3NGEyIDIgMCAwIDAtLjUuODNsLTEuMzIxIDQuMzUyYS41LjUgMCAwIDAgLjYyMy42MjJsNC4zNTMtMS4zMmEyIDIgMCAwIDAgLjgzLS40OTd6IiwKICAgICAga2V5OiAiMWE4dXN1IgogICAgfQogIF0KXTsKdmFyIFBlbkxpbmUgPSBjcmVhdGVMdWNpZGVJY29uKCJwZW4tbGluZSIsIF9faWNvbk5vZGU1KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGx1cy5qcwp2YXIgX19pY29uTm9kZTYgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiA1djE0Iiwga2V5OiAiczY5OWxlIiB9XQpdOwp2YXIgUGx1cyA9IGNyZWF0ZUx1Y2lkZUljb24oInBsdXMiLCBfX2ljb25Ob2RlNik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlZnJlc2gtY3cuanMKdmFyIF9faWNvbk5vZGU3ID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDEyYTkgOSAwIDAgMSA5LTkgOS43NSA5Ljc1IDAgMCAxIDYuNzQgMi43NEwyMSA4Iiwga2V5OiAidjloNXZjIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMjEgM3Y1aC01Iiwga2V5OiAiMXE3dG8wIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMjEgMTJhOSA5IDAgMCAxLTkgOSA5Ljc1IDkuNzUgMCAwIDEtNi43NC0yLjc0TDMgMTYiLCBrZXk6ICIzdWlmbDMiIH1dLAogIFsicGF0aCIsIHsgZDogIk04IDE2SDN2NSIsIGtleTogIjFjdjY3OCIgfV0KXTsKdmFyIFJlZnJlc2hDdyA9IGNyZWF0ZUx1Y2lkZUljb24oInJlZnJlc2gtY3ciLCBfX2ljb25Ob2RlNyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JvdGF0ZS1jY3cuanMKdmFyIF9faWNvbk5vZGU4ID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDEyYTkgOSAwIDEgMCA5LTkgOS43NSA5Ljc1IDAgMCAwLTYuNzQgMi43NEwzIDgiLCBrZXk6ICIxMzU3ZTMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0zIDN2NWg1Iiwga2V5OiAiMXhocThhIiB9XQpdOwp2YXIgUm90YXRlQ2N3ID0gY3JlYXRlTHVjaWRlSWNvbigicm90YXRlLWNjdyIsIF9faWNvbk5vZGU4KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2hpZWxkLmpzCnZhciBfX2ljb25Ob2RlOSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMjAgMTNjMCA1LTMuNSA3LjUtNy42NiA4Ljk1YTEgMSAwIDAgMS0uNjctLjAxQzcuNSAyMC41IDQgMTggNCAxM1Y2YTEgMSAwIDAgMSAxLTFjMiAwIDQuNS0xLjIgNi4yNC0yLjcyYTEuMTcgMS4xNyAwIDAgMSAxLjUyIDBDMTQuNTEgMy44MSAxNyA1IDE5IDVhMSAxIDAgMCAxIDEgMXoiLAogICAgICBrZXk6ICJvZWw0MXkiCiAgICB9CiAgXQpdOwp2YXIgU2hpZWxkID0gY3JlYXRlTHVjaWRlSWNvbigic2hpZWxkIiwgX19pY29uTm9kZTkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmFzaC0yLmpzCnZhciBfX2ljb25Ob2RlMTAgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDExdjYiLCBrZXk6ICJuY28wb20iIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAxMXY2Iiwga2V5OiAib3V0djF1IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTkgNnYxNGEyIDIgMCAwIDEtMiAySDdhMiAyIDAgMCAxLTItMlY2Iiwga2V5OiAibWl5dHJjIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMyA2aDE4Iiwga2V5OiAiZDB3bTBqIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOCA2VjRhMiAyIDAgMCAxIDItMmg0YTIgMiAwIDAgMSAyIDJ2MiIsIGtleTogImU3OTFqaSIgfV0KXTsKdmFyIFRyYXNoMiA9IGNyZWF0ZUx1Y2lkZUljb24oInRyYXNoLTIiLCBfX2ljb25Ob2RlMTApOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy91cGxvYWQuanMKdmFyIF9faWNvbk5vZGUxMSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTIgM3YxMiIsIGtleTogIjF4MGo1cyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTE3IDgtNS01LTUgNSIsIGtleTogIjdxOTdyOCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIxIDE1djRhMiAyIDAgMCAxLTIgMkg1YTIgMiAwIDAgMS0yLTJ2LTQiLCBrZXk6ICJpaDduM2giIH1dCl07CnZhciBVcGxvYWQgPSBjcmVhdGVMdWNpZGVJY29uKCJ1cGxvYWQiLCBfX2ljb25Ob2RlMTEpOwoKLy8gbm9kZV9tb2R1bGVzL3BkZmpzLWRpc3QvYnVpbGQvcGRmLm1qcwp2YXIgX193ZWJwYWNrX3JlcXVpcmVfXyA9IHt9OwooKCkgPT4gewogIF9fd2VicGFja19yZXF1aXJlX18uZCA9IChleHBvcnRzLCBkZWZpbml0aW9uKSA9PiB7CiAgICBmb3IgKHZhciBrZXkgaW4gZGVmaW5pdGlvbikgewogICAgICBpZiAoX193ZWJwYWNrX3JlcXVpcmVfXy5vKGRlZmluaXRpb24sIGtleSkgJiYgIV9fd2VicGFja19yZXF1aXJlX18ubyhleHBvcnRzLCBrZXkpKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIGtleSwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGRlZmluaXRpb25ba2V5XSB9KTsKICAgICAgfQogICAgfQogIH07Cn0pKCk7CigoKSA9PiB7CiAgX193ZWJwYWNrX3JlcXVpcmVfXy5vID0gKG9iaiwgcHJvcCkgPT4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7Cn0pKCk7CnZhciBpc05vZGVKUyA9IHR5cGVvZiBwcm9jZXNzID09PSAib2JqZWN0IiAmJiBwcm9jZXNzICsgIiIgPT09ICJbb2JqZWN0IHByb2Nlc3NdIiAmJiAhcHJvY2Vzcy52ZXJzaW9ucy5udyAmJiAhKHByb2Nlc3MudmVyc2lvbnMuZWxlY3Ryb24gJiYgcHJvY2Vzcy50eXBlICYmIHByb2Nlc3MudHlwZSAhPT0gImJyb3dzZXIiKTsKdmFyIEZPTlRfSURFTlRJVFlfTUFUUklYID0gWzFlLTMsIDAsIDAsIDFlLTMsIDAsIDBdOwp2YXIgTElORV9GQUNUT1IgPSAxLjM1Owp2YXIgTElORV9ERVNDRU5UX0ZBQ1RPUiA9IDAuMzU7CnZhciBCQVNFTElORV9GQUNUT1IgPSBMSU5FX0RFU0NFTlRfRkFDVE9SIC8gTElORV9GQUNUT1I7CnZhciBSZW5kZXJpbmdJbnRlbnRGbGFnID0gewogIEFOWTogMSwKICBESVNQTEFZOiAyLAogIFBSSU5UOiA0LAogIFNBVkU6IDgsCiAgQU5OT1RBVElPTlNfRk9STVM6IDE2LAogIEFOTk9UQVRJT05TX1NUT1JBR0U6IDMyLAogIEFOTk9UQVRJT05TX0RJU0FCTEU6IDY0LAogIElTX0VESVRJTkc6IDEyOCwKICBPUExJU1Q6IDI1Ngp9Owp2YXIgQW5ub3RhdGlvbk1vZGUgPSB7CiAgRElTQUJMRTogMCwKICBFTkFCTEU6IDEsCiAgRU5BQkxFX0ZPUk1TOiAyLAogIEVOQUJMRV9TVE9SQUdFOiAzCn07CnZhciBBbm5vdGF0aW9uRWRpdG9yUHJlZml4ID0gInBkZmpzX2ludGVybmFsX2VkaXRvcl8iOwp2YXIgQW5ub3RhdGlvbkVkaXRvclR5cGUgPSB7CiAgRElTQUJMRTogLTEsCiAgTk9ORTogMCwKICBGUkVFVEVYVDogMywKICBISUdITElHSFQ6IDksCiAgU1RBTVA6IDEzLAogIElOSzogMTUsCiAgUE9QVVA6IDE2LAogIFNJR05BVFVSRTogMTAxLAogIENPTU1FTlQ6IDEwMgp9Owp2YXIgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUgPSB7CiAgUkVTSVpFOiAxLAogIENSRUFURTogMiwKICBGUkVFVEVYVF9TSVpFOiAxMSwKICBGUkVFVEVYVF9DT0xPUjogMTIsCiAgRlJFRVRFWFRfT1BBQ0lUWTogMTMsCiAgSU5LX0NPTE9SOiAyMSwKICBJTktfVEhJQ0tORVNTOiAyMiwKICBJTktfT1BBQ0lUWTogMjMsCiAgSElHSExJR0hUX0NPTE9SOiAzMSwKICBISUdITElHSFRfVEhJQ0tORVNTOiAzMiwKICBISUdITElHSFRfRlJFRTogMzMsCiAgSElHSExJR0hUX1NIT1dfQUxMOiAzNCwKICBEUkFXX1NURVA6IDQxCn07CnZhciBQZXJtaXNzaW9uRmxhZyA9IHsKICBQUklOVDogNCwKICBNT0RJRllfQ09OVEVOVFM6IDgsCiAgQ09QWTogMTYsCiAgTU9ESUZZX0FOTk9UQVRJT05TOiAzMiwKICBGSUxMX0lOVEVSQUNUSVZFX0ZPUk1TOiAyNTYsCiAgQ09QWV9GT1JfQUNDRVNTSUJJTElUWTogNTEyLAogIEFTU0VNQkxFOiAxMDI0LAogIFBSSU5UX0hJR0hfUVVBTElUWTogMjA0OAp9Owp2YXIgTWVzaEZpZ3VyZVR5cGUgPSB7CiAgVFJJQU5HTEVTOiAxLAogIExBVFRJQ0U6IDIsCiAgUEFUQ0g6IDMKfTsKdmFyIFRleHRSZW5kZXJpbmdNb2RlID0gewogIEZJTEw6IDAsCiAgU1RST0tFOiAxLAogIEZJTExfU1RST0tFOiAyLAogIElOVklTSUJMRTogMywKICBGSUxMX0FERF9UT19QQVRIOiA0LAogIFNUUk9LRV9BRERfVE9fUEFUSDogNSwKICBGSUxMX1NUUk9LRV9BRERfVE9fUEFUSDogNiwKICBBRERfVE9fUEFUSDogNywKICBGSUxMX1NUUk9LRV9NQVNLOiAzLAogIEFERF9UT19QQVRIX0ZMQUc6IDQKfTsKdmFyIHV0aWxfSW1hZ2VLaW5kID0gewogIEdSQVlTQ0FMRV8xQlBQOiAxLAogIFJHQl8yNEJQUDogMiwKICBSR0JBXzMyQlBQOiAzCn07CnZhciBBbm5vdGF0aW9uVHlwZSA9IHsKICBURVhUOiAxLAogIExJTks6IDIsCiAgRlJFRVRFWFQ6IDMsCiAgTElORTogNCwKICBTUVVBUkU6IDUsCiAgQ0lSQ0xFOiA2LAogIFBPTFlHT046IDcsCiAgUE9MWUxJTkU6IDgsCiAgSElHSExJR0hUOiA5LAogIFVOREVSTElORTogMTAsCiAgU1FVSUdHTFk6IDExLAogIFNUUklLRU9VVDogMTIsCiAgU1RBTVA6IDEzLAogIENBUkVUOiAxNCwKICBJTks6IDE1LAogIFBPUFVQOiAxNiwKICBGSUxFQVRUQUNITUVOVDogMTcsCiAgU09VTkQ6IDE4LAogIE1PVklFOiAxOSwKICBXSURHRVQ6IDIwLAogIFNDUkVFTjogMjEsCiAgUFJJTlRFUk1BUks6IDIyLAogIFRSQVBORVQ6IDIzLAogIFdBVEVSTUFSSzogMjQsCiAgVEhSRUVEOiAyNSwKICBSRURBQ1Q6IDI2Cn07CnZhciBBbm5vdGF0aW9uQm9yZGVyU3R5bGVUeXBlID0gewogIFNPTElEOiAxLAogIERBU0hFRDogMiwKICBCRVZFTEVEOiAzLAogIElOU0VUOiA0LAogIFVOREVSTElORTogNQp9Owp2YXIgVmVyYm9zaXR5TGV2ZWwgPSB7CiAgRVJST1JTOiAwLAogIFdBUk5JTkdTOiAxLAogIElORk9TOiA1Cn07CnZhciBPUFMgPSB7CiAgZGVwZW5kZW5jeTogMSwKICBzZXRMaW5lV2lkdGg6IDIsCiAgc2V0TGluZUNhcDogMywKICBzZXRMaW5lSm9pbjogNCwKICBzZXRNaXRlckxpbWl0OiA1LAogIHNldERhc2g6IDYsCiAgc2V0UmVuZGVyaW5nSW50ZW50OiA3LAogIHNldEZsYXRuZXNzOiA4LAogIHNldEdTdGF0ZTogOSwKICBzYXZlOiAxMCwKICByZXN0b3JlOiAxMSwKICB0cmFuc2Zvcm06IDEyLAogIG1vdmVUbzogMTMsCiAgbGluZVRvOiAxNCwKICBjdXJ2ZVRvOiAxNSwKICBjdXJ2ZVRvMjogMTYsCiAgY3VydmVUbzM6IDE3LAogIGNsb3NlUGF0aDogMTgsCiAgcmVjdGFuZ2xlOiAxOSwKICBzdHJva2U6IDIwLAogIGNsb3NlU3Ryb2tlOiAyMSwKICBmaWxsOiAyMiwKICBlb0ZpbGw6IDIzLAogIGZpbGxTdHJva2U6IDI0LAogIGVvRmlsbFN0cm9rZTogMjUsCiAgY2xvc2VGaWxsU3Ryb2tlOiAyNiwKICBjbG9zZUVPRmlsbFN0cm9rZTogMjcsCiAgZW5kUGF0aDogMjgsCiAgY2xpcDogMjksCiAgZW9DbGlwOiAzMCwKICBiZWdpblRleHQ6IDMxLAogIGVuZFRleHQ6IDMyLAogIHNldENoYXJTcGFjaW5nOiAzMywKICBzZXRXb3JkU3BhY2luZzogMzQsCiAgc2V0SFNjYWxlOiAzNSwKICBzZXRMZWFkaW5nOiAzNiwKICBzZXRGb250OiAzNywKICBzZXRUZXh0UmVuZGVyaW5nTW9kZTogMzgsCiAgc2V0VGV4dFJpc2U6IDM5LAogIG1vdmVUZXh0OiA0MCwKICBzZXRMZWFkaW5nTW92ZVRleHQ6IDQxLAogIHNldFRleHRNYXRyaXg6IDQyLAogIG5leHRMaW5lOiA0MywKICBzaG93VGV4dDogNDQsCiAgc2hvd1NwYWNlZFRleHQ6IDQ1LAogIG5leHRMaW5lU2hvd1RleHQ6IDQ2LAogIG5leHRMaW5lU2V0U3BhY2luZ1Nob3dUZXh0OiA0NywKICBzZXRDaGFyV2lkdGg6IDQ4LAogIHNldENoYXJXaWR0aEFuZEJvdW5kczogNDksCiAgc2V0U3Ryb2tlQ29sb3JTcGFjZTogNTAsCiAgc2V0RmlsbENvbG9yU3BhY2U6IDUxLAogIHNldFN0cm9rZUNvbG9yOiA1MiwKICBzZXRTdHJva2VDb2xvck46IDUzLAogIHNldEZpbGxDb2xvcjogNTQsCiAgc2V0RmlsbENvbG9yTjogNTUsCiAgc2V0U3Ryb2tlR3JheTogNTYsCiAgc2V0RmlsbEdyYXk6IDU3LAogIHNldFN0cm9rZVJHQkNvbG9yOiA1OCwKICBzZXRGaWxsUkdCQ29sb3I6IDU5LAogIHNldFN0cm9rZUNNWUtDb2xvcjogNjAsCiAgc2V0RmlsbENNWUtDb2xvcjogNjEsCiAgc2hhZGluZ0ZpbGw6IDYyLAogIGJlZ2luSW5saW5lSW1hZ2U6IDYzLAogIGJlZ2luSW1hZ2VEYXRhOiA2NCwKICBlbmRJbmxpbmVJbWFnZTogNjUsCiAgcGFpbnRYT2JqZWN0OiA2NiwKICBtYXJrUG9pbnQ6IDY3LAogIG1hcmtQb2ludFByb3BzOiA2OCwKICBiZWdpbk1hcmtlZENvbnRlbnQ6IDY5LAogIGJlZ2luTWFya2VkQ29udGVudFByb3BzOiA3MCwKICBlbmRNYXJrZWRDb250ZW50OiA3MSwKICBiZWdpbkNvbXBhdDogNzIsCiAgZW5kQ29tcGF0OiA3MywKICBwYWludEZvcm1YT2JqZWN0QmVnaW46IDc0LAogIHBhaW50Rm9ybVhPYmplY3RFbmQ6IDc1LAogIGJlZ2luR3JvdXA6IDc2LAogIGVuZEdyb3VwOiA3NywKICBiZWdpbkFubm90YXRpb246IDgwLAogIGVuZEFubm90YXRpb246IDgxLAogIHBhaW50SW1hZ2VNYXNrWE9iamVjdDogODMsCiAgcGFpbnRJbWFnZU1hc2tYT2JqZWN0R3JvdXA6IDg0LAogIHBhaW50SW1hZ2VYT2JqZWN0OiA4NSwKICBwYWludElubGluZUltYWdlWE9iamVjdDogODYsCiAgcGFpbnRJbmxpbmVJbWFnZVhPYmplY3RHcm91cDogODcsCiAgcGFpbnRJbWFnZVhPYmplY3RSZXBlYXQ6IDg4LAogIHBhaW50SW1hZ2VNYXNrWE9iamVjdFJlcGVhdDogODksCiAgcGFpbnRTb2xpZENvbG9ySW1hZ2VNYXNrOiA5MCwKICBjb25zdHJ1Y3RQYXRoOiA5MSwKICBzZXRTdHJva2VUcmFuc3BhcmVudDogOTIsCiAgc2V0RmlsbFRyYW5zcGFyZW50OiA5MywKICByYXdGaWxsUGF0aDogOTQKfTsKdmFyIERyYXdPUFMgPSB7CiAgbW92ZVRvOiAwLAogIGxpbmVUbzogMSwKICBjdXJ2ZVRvOiAyLAogIHF1YWRyYXRpY0N1cnZlVG86IDMsCiAgY2xvc2VQYXRoOiA0Cn07CnZhciBQYXNzd29yZFJlc3BvbnNlcyA9IHsKICBORUVEX1BBU1NXT1JEOiAxLAogIElOQ09SUkVDVF9QQVNTV09SRDogMgp9Owp2YXIgdmVyYm9zaXR5ID0gVmVyYm9zaXR5TGV2ZWwuV0FSTklOR1M7CmZ1bmN0aW9uIHNldFZlcmJvc2l0eUxldmVsKGxldmVsKSB7CiAgaWYgKE51bWJlci5pc0ludGVnZXIobGV2ZWwpKSB7CiAgICB2ZXJib3NpdHkgPSBsZXZlbDsKICB9Cn0KZnVuY3Rpb24gZ2V0VmVyYm9zaXR5TGV2ZWwoKSB7CiAgcmV0dXJuIHZlcmJvc2l0eTsKfQpmdW5jdGlvbiBpbmZvKG1zZykgewogIGlmICh2ZXJib3NpdHkgPj0gVmVyYm9zaXR5TGV2ZWwuSU5GT1MpIHsKICAgIGNvbnNvbGUuaW5mbyhgSW5mbzogJHttc2d9YCk7CiAgfQp9CmZ1bmN0aW9uIHdhcm4obXNnKSB7CiAgaWYgKHZlcmJvc2l0eSA+PSBWZXJib3NpdHlMZXZlbC5XQVJOSU5HUykgewogICAgY29uc29sZS53YXJuKGBXYXJuaW5nOiAke21zZ31gKTsKICB9Cn0KZnVuY3Rpb24gdW5yZWFjaGFibGUobXNnKSB7CiAgdGhyb3cgbmV3IEVycm9yKG1zZyk7Cn0KZnVuY3Rpb24gYXNzZXJ0KGNvbmQsIG1zZykgewogIGlmICghY29uZCkgewogICAgdW5yZWFjaGFibGUobXNnKTsKICB9Cn0KZnVuY3Rpb24gX2lzVmFsaWRQcm90b2NvbCh1cmwpIHsKICBzd2l0Y2ggKHVybD8ucHJvdG9jb2wpIHsKICAgIGNhc2UgImh0dHA6IjoKICAgIGNhc2UgImh0dHBzOiI6CiAgICBjYXNlICJmdHA6IjoKICAgIGNhc2UgIm1haWx0bzoiOgogICAgY2FzZSAidGVsOiI6CiAgICAgIHJldHVybiB0cnVlOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBjcmVhdGVWYWxpZEFic29sdXRlVXJsKHVybCwgYmFzZVVybCA9IG51bGwsIG9wdGlvbnMgPSBudWxsKSB7CiAgaWYgKCF1cmwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAob3B0aW9ucyAmJiB0eXBlb2YgdXJsID09PSAic3RyaW5nIikgewogICAgaWYgKG9wdGlvbnMuYWRkRGVmYXVsdFByb3RvY29sICYmIHVybC5zdGFydHNXaXRoKCJ3d3cuIikpIHsKICAgICAgY29uc3QgZG90cyA9IHVybC5tYXRjaCgvXC4vZyk7CiAgICAgIGlmIChkb3RzPy5sZW5ndGggPj0gMikgewogICAgICAgIHVybCA9IGBodHRwOi8vJHt1cmx9YDsKICAgICAgfQogICAgfQogICAgaWYgKG9wdGlvbnMudHJ5Q29udmVydEVuY29kaW5nKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdXJsID0gc3RyaW5nVG9VVEY4U3RyaW5nKHVybCk7CiAgICAgIH0gY2F0Y2ggewogICAgICB9CiAgICB9CiAgfQogIGNvbnN0IGFic29sdXRlVXJsID0gYmFzZVVybCA/IFVSTC5wYXJzZSh1cmwsIGJhc2VVcmwpIDogVVJMLnBhcnNlKHVybCk7CiAgcmV0dXJuIF9pc1ZhbGlkUHJvdG9jb2woYWJzb2x1dGVVcmwpID8gYWJzb2x1dGVVcmwgOiBudWxsOwp9CmZ1bmN0aW9uIHVwZGF0ZVVybEhhc2godXJsLCBoYXNoLCBhbGxvd1JlbCA9IGZhbHNlKSB7CiAgY29uc3QgcmVzID0gVVJMLnBhcnNlKHVybCk7CiAgaWYgKHJlcykgewogICAgcmVzLmhhc2ggPSBoYXNoOwogICAgcmV0dXJuIHJlcy5ocmVmOwogIH0KICBpZiAoYWxsb3dSZWwgJiYgY3JlYXRlVmFsaWRBYnNvbHV0ZVVybCh1cmwsICJodHRwOi8vZXhhbXBsZS5jb20iKSkgewogICAgcmV0dXJuIHVybC5zcGxpdCgiIyIsIDEpWzBdICsgYCR7aGFzaCA/IGAjJHtoYXNofWAgOiAiIn1gOwogIH0KICByZXR1cm4gIiI7Cn0KZnVuY3Rpb24gc2hhZG93KG9iaiwgcHJvcCwgdmFsdWUsIG5vblNlcmlhbGl6YWJsZSA9IGZhbHNlKSB7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgcHJvcCwgewogICAgdmFsdWUsCiAgICBlbnVtZXJhYmxlOiAhbm9uU2VyaWFsaXphYmxlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgd3JpdGFibGU6IGZhbHNlCiAgfSk7CiAgcmV0dXJuIHZhbHVlOwp9CnZhciBCYXNlRXhjZXB0aW9uID0gZnVuY3Rpb24gQmFzZUV4Y2VwdGlvbkNsb3N1cmUoKSB7CiAgZnVuY3Rpb24gQmFzZUV4Y2VwdGlvbjIobWVzc2FnZSwgbmFtZSkgewogICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgfQogIEJhc2VFeGNlcHRpb24yLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwogIEJhc2VFeGNlcHRpb24yLmNvbnN0cnVjdG9yID0gQmFzZUV4Y2VwdGlvbjI7CiAgcmV0dXJuIEJhc2VFeGNlcHRpb24yOwp9KCk7CnZhciBQYXNzd29yZEV4Y2VwdGlvbiA9IGNsYXNzIGV4dGVuZHMgQmFzZUV4Y2VwdGlvbiB7CiAgY29uc3RydWN0b3IobXNnLCBjb2RlKSB7CiAgICBzdXBlcihtc2csICJQYXNzd29yZEV4Y2VwdGlvbiIpOwogICAgdGhpcy5jb2RlID0gY29kZTsKICB9Cn07CnZhciBVbmtub3duRXJyb3JFeGNlcHRpb24gPSBjbGFzcyBleHRlbmRzIEJhc2VFeGNlcHRpb24gewogIGNvbnN0cnVjdG9yKG1zZywgZGV0YWlscykgewogICAgc3VwZXIobXNnLCAiVW5rbm93bkVycm9yRXhjZXB0aW9uIik7CiAgICB0aGlzLmRldGFpbHMgPSBkZXRhaWxzOwogIH0KfTsKdmFyIEludmFsaWRQREZFeGNlcHRpb24gPSBjbGFzcyBleHRlbmRzIEJhc2VFeGNlcHRpb24gewogIGNvbnN0cnVjdG9yKG1zZykgewogICAgc3VwZXIobXNnLCAiSW52YWxpZFBERkV4Y2VwdGlvbiIpOwogIH0KfTsKdmFyIFJlc3BvbnNlRXhjZXB0aW9uID0gY2xhc3MgZXh0ZW5kcyBCYXNlRXhjZXB0aW9uIHsKICBjb25zdHJ1Y3Rvcihtc2csIHN0YXR1cywgbWlzc2luZykgewogICAgc3VwZXIobXNnLCAiUmVzcG9uc2VFeGNlcHRpb24iKTsKICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgdGhpcy5taXNzaW5nID0gbWlzc2luZzsKICB9Cn07CnZhciBGb3JtYXRFcnJvciA9IGNsYXNzIGV4dGVuZHMgQmFzZUV4Y2VwdGlvbiB7CiAgY29uc3RydWN0b3IobXNnKSB7CiAgICBzdXBlcihtc2csICJGb3JtYXRFcnJvciIpOwogIH0KfTsKdmFyIEFib3J0RXhjZXB0aW9uID0gY2xhc3MgZXh0ZW5kcyBCYXNlRXhjZXB0aW9uIHsKICBjb25zdHJ1Y3Rvcihtc2cpIHsKICAgIHN1cGVyKG1zZywgIkFib3J0RXhjZXB0aW9uIik7CiAgfQp9OwpmdW5jdGlvbiBieXRlc1RvU3RyaW5nKGJ5dGVzKSB7CiAgaWYgKHR5cGVvZiBieXRlcyAhPT0gIm9iamVjdCIgfHwgYnl0ZXM/Lmxlbmd0aCA9PT0gdm9pZCAwKSB7CiAgICB1bnJlYWNoYWJsZSgiSW52YWxpZCBhcmd1bWVudCBmb3IgYnl0ZXNUb1N0cmluZyIpOwogIH0KICBjb25zdCBsZW5ndGggPSBieXRlcy5sZW5ndGg7CiAgY29uc3QgTUFYX0FSR1VNRU5UX0NPVU5UID0gODE5MjsKICBpZiAobGVuZ3RoIDwgTUFYX0FSR1VNRU5UX0NPVU5UKSB7CiAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBieXRlcyk7CiAgfQogIGNvbnN0IHN0ckJ1ZiA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IE1BWF9BUkdVTUVOVF9DT1VOVCkgewogICAgY29uc3QgY2h1bmtFbmQgPSBNYXRoLm1pbihpICsgTUFYX0FSR1VNRU5UX0NPVU5ULCBsZW5ndGgpOwogICAgY29uc3QgY2h1bmsgPSBieXRlcy5zdWJhcnJheShpLCBjaHVua0VuZCk7CiAgICBzdHJCdWYucHVzaChTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGNodW5rKSk7CiAgfQogIHJldHVybiBzdHJCdWYuam9pbigiIik7Cn0KZnVuY3Rpb24gc3RyaW5nVG9CeXRlcyhzdHIpIHsKICBpZiAodHlwZW9mIHN0ciAhPT0gInN0cmluZyIpIHsKICAgIHVucmVhY2hhYmxlKCJJbnZhbGlkIGFyZ3VtZW50IGZvciBzdHJpbmdUb0J5dGVzIik7CiAgfQogIGNvbnN0IGxlbmd0aCA9IHN0ci5sZW5ndGg7CiAgY29uc3QgYnl0ZXMgPSBuZXcgVWludDhBcnJheShsZW5ndGgpOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgIGJ5dGVzW2ldID0gc3RyLmNoYXJDb2RlQXQoaSkgJiAyNTU7CiAgfQogIHJldHVybiBieXRlczsKfQpmdW5jdGlvbiBzdHJpbmczMih2YWx1ZSkgewogIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKHZhbHVlID4+IDI0ICYgMjU1LCB2YWx1ZSA+PiAxNiAmIDI1NSwgdmFsdWUgPj4gOCAmIDI1NSwgdmFsdWUgJiAyNTUpOwp9CmZ1bmN0aW9uIGlzTGl0dGxlRW5kaWFuKCkgewogIGNvbnN0IGJ1ZmZlcjggPSBuZXcgVWludDhBcnJheSg0KTsKICBidWZmZXI4WzBdID0gMTsKICBjb25zdCB2aWV3MzIgPSBuZXcgVWludDMyQXJyYXkoYnVmZmVyOC5idWZmZXIsIDAsIDEpOwogIHJldHVybiB2aWV3MzJbMF0gPT09IDE7Cn0KZnVuY3Rpb24gaXNFdmFsU3VwcG9ydGVkKCkgewogIHRyeSB7CiAgICBuZXcgRnVuY3Rpb24oIiIpOwogICAgcmV0dXJuIHRydWU7CiAgfSBjYXRjaCB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9CnZhciB1dGlsX0ZlYXR1cmVUZXN0ID0gY2xhc3MgewogIHN0YXRpYyBnZXQgaXNMaXR0bGVFbmRpYW4oKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc0xpdHRsZUVuZGlhbiIsIGlzTGl0dGxlRW5kaWFuKCkpOwogIH0KICBzdGF0aWMgZ2V0IGlzRXZhbFN1cHBvcnRlZCgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzRXZhbFN1cHBvcnRlZCIsIGlzRXZhbFN1cHBvcnRlZCgpKTsKICB9CiAgc3RhdGljIGdldCBpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRlZCgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzT2Zmc2NyZWVuQ2FudmFzU3VwcG9ydGVkIiwgdHlwZW9mIE9mZnNjcmVlbkNhbnZhcyAhPT0gInVuZGVmaW5lZCIpOwogIH0KICBzdGF0aWMgZ2V0IGlzSW1hZ2VEZWNvZGVyU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaXNJbWFnZURlY29kZXJTdXBwb3J0ZWQiLCB0eXBlb2YgSW1hZ2VEZWNvZGVyICE9PSAidW5kZWZpbmVkIik7CiAgfQogIHN0YXRpYyBnZXQgaXNGbG9hdDE2QXJyYXlTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc0Zsb2F0MTZBcnJheVN1cHBvcnRlZCIsIHR5cGVvZiBGbG9hdDE2QXJyYXkgIT09ICJ1bmRlZmluZWQiKTsKICB9CiAgc3RhdGljIGdldCBpc1Nhbml0aXplclN1cHBvcnRlZCgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzU2FuaXRpemVyU3VwcG9ydGVkIiwgdHlwZW9mIFNhbml0aXplciAhPT0gInVuZGVmaW5lZCIpOwogIH0KICBzdGF0aWMgZ2V0IHBsYXRmb3JtKCkgewogICAgY29uc3QgewogICAgICBwbGF0Zm9ybSwKICAgICAgdXNlckFnZW50CiAgICB9ID0gbmF2aWdhdG9yOwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAicGxhdGZvcm0iLCB7CiAgICAgIGlzQW5kcm9pZDogdXNlckFnZW50LmluY2x1ZGVzKCJBbmRyb2lkIiksCiAgICAgIGlzTGludXg6IHBsYXRmb3JtLmluY2x1ZGVzKCJMaW51eCIpLAogICAgICBpc01hYzogcGxhdGZvcm0uaW5jbHVkZXMoIk1hYyIpLAogICAgICBpc1dpbmRvd3M6IHBsYXRmb3JtLmluY2x1ZGVzKCJXaW4iKSwKICAgICAgaXNGaXJlZm94OiB1c2VyQWdlbnQuaW5jbHVkZXMoIkZpcmVmb3giKQogICAgfSk7CiAgfQogIHN0YXRpYyBnZXQgaXNDU1NSb3VuZFN1cHBvcnRlZCgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzQ1NTUm91bmRTdXBwb3J0ZWQiLCBnbG9iYWxUaGlzLkNTUz8uc3VwcG9ydHM/Ligid2lkdGg6IHJvdW5kKDEuNXB4LCAxcHgpIikpOwogIH0KfTsKdmFyIGhleE51bWJlcnMgPSBBcnJheS5mcm9tKEFycmF5KDI1Nikua2V5cygpLCAobikgPT4gbi50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKSk7CnZhciBVdGlsID0gY2xhc3MgewogIHN0YXRpYyBtYWtlSGV4Q29sb3IociwgZywgYikgewogICAgcmV0dXJuIGAjJHtoZXhOdW1iZXJzW3JdfSR7aGV4TnVtYmVyc1tnXX0ke2hleE51bWJlcnNbYl19YDsKICB9CiAgc3RhdGljIGRvbU1hdHJpeFRvVHJhbnNmb3JtKGRtKSB7CiAgICByZXR1cm4gW2RtLmEsIGRtLmIsIGRtLmMsIGRtLmQsIGRtLmUsIGRtLmZdOwogIH0KICBzdGF0aWMgc2NhbGVNaW5NYXgodHJhbnNmb3JtLCBtaW5NYXgpIHsKICAgIGxldCB0ZW1wOwogICAgaWYgKHRyYW5zZm9ybVswXSkgewogICAgICBpZiAodHJhbnNmb3JtWzBdIDwgMCkgewogICAgICAgIHRlbXAgPSBtaW5NYXhbMF07CiAgICAgICAgbWluTWF4WzBdID0gbWluTWF4WzJdOwogICAgICAgIG1pbk1heFsyXSA9IHRlbXA7CiAgICAgIH0KICAgICAgbWluTWF4WzBdICo9IHRyYW5zZm9ybVswXTsKICAgICAgbWluTWF4WzJdICo9IHRyYW5zZm9ybVswXTsKICAgICAgaWYgKHRyYW5zZm9ybVszXSA8IDApIHsKICAgICAgICB0ZW1wID0gbWluTWF4WzFdOwogICAgICAgIG1pbk1heFsxXSA9IG1pbk1heFszXTsKICAgICAgICBtaW5NYXhbM10gPSB0ZW1wOwogICAgICB9CiAgICAgIG1pbk1heFsxXSAqPSB0cmFuc2Zvcm1bM107CiAgICAgIG1pbk1heFszXSAqPSB0cmFuc2Zvcm1bM107CiAgICB9IGVsc2UgewogICAgICB0ZW1wID0gbWluTWF4WzBdOwogICAgICBtaW5NYXhbMF0gPSBtaW5NYXhbMV07CiAgICAgIG1pbk1heFsxXSA9IHRlbXA7CiAgICAgIHRlbXAgPSBtaW5NYXhbMl07CiAgICAgIG1pbk1heFsyXSA9IG1pbk1heFszXTsKICAgICAgbWluTWF4WzNdID0gdGVtcDsKICAgICAgaWYgKHRyYW5zZm9ybVsxXSA8IDApIHsKICAgICAgICB0ZW1wID0gbWluTWF4WzFdOwogICAgICAgIG1pbk1heFsxXSA9IG1pbk1heFszXTsKICAgICAgICBtaW5NYXhbM10gPSB0ZW1wOwogICAgICB9CiAgICAgIG1pbk1heFsxXSAqPSB0cmFuc2Zvcm1bMV07CiAgICAgIG1pbk1heFszXSAqPSB0cmFuc2Zvcm1bMV07CiAgICAgIGlmICh0cmFuc2Zvcm1bMl0gPCAwKSB7CiAgICAgICAgdGVtcCA9IG1pbk1heFswXTsKICAgICAgICBtaW5NYXhbMF0gPSBtaW5NYXhbMl07CiAgICAgICAgbWluTWF4WzJdID0gdGVtcDsKICAgICAgfQogICAgICBtaW5NYXhbMF0gKj0gdHJhbnNmb3JtWzJdOwogICAgICBtaW5NYXhbMl0gKj0gdHJhbnNmb3JtWzJdOwogICAgfQogICAgbWluTWF4WzBdICs9IHRyYW5zZm9ybVs0XTsKICAgIG1pbk1heFsxXSArPSB0cmFuc2Zvcm1bNV07CiAgICBtaW5NYXhbMl0gKz0gdHJhbnNmb3JtWzRdOwogICAgbWluTWF4WzNdICs9IHRyYW5zZm9ybVs1XTsKICB9CiAgc3RhdGljIHRyYW5zZm9ybShtMSwgbTIpIHsKICAgIHJldHVybiBbbTFbMF0gKiBtMlswXSArIG0xWzJdICogbTJbMV0sIG0xWzFdICogbTJbMF0gKyBtMVszXSAqIG0yWzFdLCBtMVswXSAqIG0yWzJdICsgbTFbMl0gKiBtMlszXSwgbTFbMV0gKiBtMlsyXSArIG0xWzNdICogbTJbM10sIG0xWzBdICogbTJbNF0gKyBtMVsyXSAqIG0yWzVdICsgbTFbNF0sIG0xWzFdICogbTJbNF0gKyBtMVszXSAqIG0yWzVdICsgbTFbNV1dOwogIH0KICBzdGF0aWMgbXVsdGlwbHlCeURPTU1hdHJpeChtLCBtZCkgewogICAgcmV0dXJuIFttWzBdICogbWQuYSArIG1bMl0gKiBtZC5iLCBtWzFdICogbWQuYSArIG1bM10gKiBtZC5iLCBtWzBdICogbWQuYyArIG1bMl0gKiBtZC5kLCBtWzFdICogbWQuYyArIG1bM10gKiBtZC5kLCBtWzBdICogbWQuZSArIG1bMl0gKiBtZC5mICsgbVs0XSwgbVsxXSAqIG1kLmUgKyBtWzNdICogbWQuZiArIG1bNV1dOwogIH0KICBzdGF0aWMgYXBwbHlUcmFuc2Zvcm0ocCwgbSwgcG9zID0gMCkgewogICAgY29uc3QgcDAgPSBwW3Bvc107CiAgICBjb25zdCBwMSA9IHBbcG9zICsgMV07CiAgICBwW3Bvc10gPSBwMCAqIG1bMF0gKyBwMSAqIG1bMl0gKyBtWzRdOwogICAgcFtwb3MgKyAxXSA9IHAwICogbVsxXSArIHAxICogbVszXSArIG1bNV07CiAgfQogIHN0YXRpYyBhcHBseVRyYW5zZm9ybVRvQmV6aWVyKHAsIHRyYW5zZm9ybSwgcG9zID0gMCkgewogICAgY29uc3QgbTAgPSB0cmFuc2Zvcm1bMF07CiAgICBjb25zdCBtMSA9IHRyYW5zZm9ybVsxXTsKICAgIGNvbnN0IG0yID0gdHJhbnNmb3JtWzJdOwogICAgY29uc3QgbTMgPSB0cmFuc2Zvcm1bM107CiAgICBjb25zdCBtNCA9IHRyYW5zZm9ybVs0XTsKICAgIGNvbnN0IG01ID0gdHJhbnNmb3JtWzVdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpICs9IDIpIHsKICAgICAgY29uc3QgcEkgPSBwW3BvcyArIGldOwogICAgICBjb25zdCBwSTEgPSBwW3BvcyArIGkgKyAxXTsKICAgICAgcFtwb3MgKyBpXSA9IHBJICogbTAgKyBwSTEgKiBtMiArIG00OwogICAgICBwW3BvcyArIGkgKyAxXSA9IHBJICogbTEgKyBwSTEgKiBtMyArIG01OwogICAgfQogIH0KICBzdGF0aWMgYXBwbHlJbnZlcnNlVHJhbnNmb3JtKHAsIG0pIHsKICAgIGNvbnN0IHAwID0gcFswXTsKICAgIGNvbnN0IHAxID0gcFsxXTsKICAgIGNvbnN0IGQgPSBtWzBdICogbVszXSAtIG1bMV0gKiBtWzJdOwogICAgcFswXSA9IChwMCAqIG1bM10gLSBwMSAqIG1bMl0gKyBtWzJdICogbVs1XSAtIG1bNF0gKiBtWzNdKSAvIGQ7CiAgICBwWzFdID0gKC1wMCAqIG1bMV0gKyBwMSAqIG1bMF0gKyBtWzRdICogbVsxXSAtIG1bNV0gKiBtWzBdKSAvIGQ7CiAgfQogIHN0YXRpYyBheGlhbEFsaWduZWRCb3VuZGluZ0JveChyZWN0LCB0cmFuc2Zvcm0sIG91dHB1dCkgewogICAgY29uc3QgbTAgPSB0cmFuc2Zvcm1bMF07CiAgICBjb25zdCBtMSA9IHRyYW5zZm9ybVsxXTsKICAgIGNvbnN0IG0yID0gdHJhbnNmb3JtWzJdOwogICAgY29uc3QgbTMgPSB0cmFuc2Zvcm1bM107CiAgICBjb25zdCBtNCA9IHRyYW5zZm9ybVs0XTsKICAgIGNvbnN0IG01ID0gdHJhbnNmb3JtWzVdOwogICAgY29uc3QgcjAgPSByZWN0WzBdOwogICAgY29uc3QgcjEgPSByZWN0WzFdOwogICAgY29uc3QgcjIgPSByZWN0WzJdOwogICAgY29uc3QgcjMgPSByZWN0WzNdOwogICAgbGV0IGEwID0gbTAgKiByMCArIG00OwogICAgbGV0IGEyID0gYTA7CiAgICBsZXQgYTEgPSBtMCAqIHIyICsgbTQ7CiAgICBsZXQgYTMgPSBhMTsKICAgIGxldCBiMCA9IG0zICogcjEgKyBtNTsKICAgIGxldCBiMiA9IGIwOwogICAgbGV0IGIxID0gbTMgKiByMyArIG01OwogICAgbGV0IGIzID0gYjE7CiAgICBpZiAobTEgIT09IDAgfHwgbTIgIT09IDApIHsKICAgICAgY29uc3QgbTFyMCA9IG0xICogcjA7CiAgICAgIGNvbnN0IG0xcjIgPSBtMSAqIHIyOwogICAgICBjb25zdCBtMnIxID0gbTIgKiByMTsKICAgICAgY29uc3QgbTJyMyA9IG0yICogcjM7CiAgICAgIGEwICs9IG0ycjE7CiAgICAgIGEzICs9IG0ycjE7CiAgICAgIGExICs9IG0ycjM7CiAgICAgIGEyICs9IG0ycjM7CiAgICAgIGIwICs9IG0xcjA7CiAgICAgIGIzICs9IG0xcjA7CiAgICAgIGIxICs9IG0xcjI7CiAgICAgIGIyICs9IG0xcjI7CiAgICB9CiAgICBvdXRwdXRbMF0gPSBNYXRoLm1pbihvdXRwdXRbMF0sIGEwLCBhMSwgYTIsIGEzKTsKICAgIG91dHB1dFsxXSA9IE1hdGgubWluKG91dHB1dFsxXSwgYjAsIGIxLCBiMiwgYjMpOwogICAgb3V0cHV0WzJdID0gTWF0aC5tYXgob3V0cHV0WzJdLCBhMCwgYTEsIGEyLCBhMyk7CiAgICBvdXRwdXRbM10gPSBNYXRoLm1heChvdXRwdXRbM10sIGIwLCBiMSwgYjIsIGIzKTsKICB9CiAgc3RhdGljIGludmVyc2VUcmFuc2Zvcm0obSkgewogICAgY29uc3QgZCA9IG1bMF0gKiBtWzNdIC0gbVsxXSAqIG1bMl07CiAgICByZXR1cm4gW21bM10gLyBkLCAtbVsxXSAvIGQsIC1tWzJdIC8gZCwgbVswXSAvIGQsIChtWzJdICogbVs1XSAtIG1bNF0gKiBtWzNdKSAvIGQsIChtWzRdICogbVsxXSAtIG1bNV0gKiBtWzBdKSAvIGRdOwogIH0KICBzdGF0aWMgc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUobWF0cml4LCBvdXRwdXQpIHsKICAgIGNvbnN0IG0wID0gbWF0cml4WzBdOwogICAgY29uc3QgbTEgPSBtYXRyaXhbMV07CiAgICBjb25zdCBtMiA9IG1hdHJpeFsyXTsKICAgIGNvbnN0IG0zID0gbWF0cml4WzNdOwogICAgY29uc3QgYSA9IG0wICoqIDIgKyBtMSAqKiAyOwogICAgY29uc3QgYiA9IG0wICogbTIgKyBtMSAqIG0zOwogICAgY29uc3QgYyA9IG0yICoqIDIgKyBtMyAqKiAyOwogICAgY29uc3QgZmlyc3QgPSAoYSArIGMpIC8gMjsKICAgIGNvbnN0IHNlY29uZCA9IE1hdGguc3FydChmaXJzdCAqKiAyIC0gKGEgKiBjIC0gYiAqKiAyKSk7CiAgICBvdXRwdXRbMF0gPSBNYXRoLnNxcnQoZmlyc3QgKyBzZWNvbmQgfHwgMSk7CiAgICBvdXRwdXRbMV0gPSBNYXRoLnNxcnQoZmlyc3QgLSBzZWNvbmQgfHwgMSk7CiAgfQogIHN0YXRpYyBub3JtYWxpemVSZWN0KHJlY3QpIHsKICAgIGNvbnN0IHIgPSByZWN0LnNsaWNlKDApOwogICAgaWYgKHJlY3RbMF0gPiByZWN0WzJdKSB7CiAgICAgIHJbMF0gPSByZWN0WzJdOwogICAgICByWzJdID0gcmVjdFswXTsKICAgIH0KICAgIGlmIChyZWN0WzFdID4gcmVjdFszXSkgewogICAgICByWzFdID0gcmVjdFszXTsKICAgICAgclszXSA9IHJlY3RbMV07CiAgICB9CiAgICByZXR1cm4gcjsKICB9CiAgc3RhdGljIGludGVyc2VjdChyZWN0MSwgcmVjdDIpIHsKICAgIGNvbnN0IHhMb3cgPSBNYXRoLm1heChNYXRoLm1pbihyZWN0MVswXSwgcmVjdDFbMl0pLCBNYXRoLm1pbihyZWN0MlswXSwgcmVjdDJbMl0pKTsKICAgIGNvbnN0IHhIaWdoID0gTWF0aC5taW4oTWF0aC5tYXgocmVjdDFbMF0sIHJlY3QxWzJdKSwgTWF0aC5tYXgocmVjdDJbMF0sIHJlY3QyWzJdKSk7CiAgICBpZiAoeExvdyA+IHhIaWdoKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgeUxvdyA9IE1hdGgubWF4KE1hdGgubWluKHJlY3QxWzFdLCByZWN0MVszXSksIE1hdGgubWluKHJlY3QyWzFdLCByZWN0MlszXSkpOwogICAgY29uc3QgeUhpZ2ggPSBNYXRoLm1pbihNYXRoLm1heChyZWN0MVsxXSwgcmVjdDFbM10pLCBNYXRoLm1heChyZWN0MlsxXSwgcmVjdDJbM10pKTsKICAgIGlmICh5TG93ID4geUhpZ2gpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gW3hMb3csIHlMb3csIHhIaWdoLCB5SGlnaF07CiAgfQogIHN0YXRpYyBwb2ludEJvdW5kaW5nQm94KHgsIHksIG1pbk1heCkgewogICAgbWluTWF4WzBdID0gTWF0aC5taW4obWluTWF4WzBdLCB4KTsKICAgIG1pbk1heFsxXSA9IE1hdGgubWluKG1pbk1heFsxXSwgeSk7CiAgICBtaW5NYXhbMl0gPSBNYXRoLm1heChtaW5NYXhbMl0sIHgpOwogICAgbWluTWF4WzNdID0gTWF0aC5tYXgobWluTWF4WzNdLCB5KTsKICB9CiAgc3RhdGljIHJlY3RCb3VuZGluZ0JveCh4MCwgeTAsIHgxLCB5MSwgbWluTWF4KSB7CiAgICBtaW5NYXhbMF0gPSBNYXRoLm1pbihtaW5NYXhbMF0sIHgwLCB4MSk7CiAgICBtaW5NYXhbMV0gPSBNYXRoLm1pbihtaW5NYXhbMV0sIHkwLCB5MSk7CiAgICBtaW5NYXhbMl0gPSBNYXRoLm1heChtaW5NYXhbMl0sIHgwLCB4MSk7CiAgICBtaW5NYXhbM10gPSBNYXRoLm1heChtaW5NYXhbM10sIHkwLCB5MSk7CiAgfQogIHN0YXRpYyAjZ2V0RXh0cmVtdW1PbkN1cnZlKHgwLCB4MSwgeDIsIHgzLCB5MCwgeTEsIHkyLCB5MywgdCwgbWluTWF4KSB7CiAgICBpZiAodCA8PSAwIHx8IHQgPj0gMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBtdCA9IDEgLSB0OwogICAgY29uc3QgdHQgPSB0ICogdDsKICAgIGNvbnN0IHR0dCA9IHR0ICogdDsKICAgIGNvbnN0IHggPSBtdCAqIChtdCAqIChtdCAqIHgwICsgMyAqIHQgKiB4MSkgKyAzICogdHQgKiB4MikgKyB0dHQgKiB4MzsKICAgIGNvbnN0IHkgPSBtdCAqIChtdCAqIChtdCAqIHkwICsgMyAqIHQgKiB5MSkgKyAzICogdHQgKiB5MikgKyB0dHQgKiB5MzsKICAgIG1pbk1heFswXSA9IE1hdGgubWluKG1pbk1heFswXSwgeCk7CiAgICBtaW5NYXhbMV0gPSBNYXRoLm1pbihtaW5NYXhbMV0sIHkpOwogICAgbWluTWF4WzJdID0gTWF0aC5tYXgobWluTWF4WzJdLCB4KTsKICAgIG1pbk1heFszXSA9IE1hdGgubWF4KG1pbk1heFszXSwgeSk7CiAgfQogIHN0YXRpYyAjZ2V0RXh0cmVtdW0oeDAsIHgxLCB4MiwgeDMsIHkwLCB5MSwgeTIsIHkzLCBhLCBiLCBjLCBtaW5NYXgpIHsKICAgIGlmIChNYXRoLmFicyhhKSA8IDFlLTEyKSB7CiAgICAgIGlmIChNYXRoLmFicyhiKSA+PSAxZS0xMikgewogICAgICAgIHRoaXMuI2dldEV4dHJlbXVtT25DdXJ2ZSh4MCwgeDEsIHgyLCB4MywgeTAsIHkxLCB5MiwgeTMsIC1jIC8gYiwgbWluTWF4KTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBkZWx0YSA9IGIgKiogMiAtIDQgKiBjICogYTsKICAgIGlmIChkZWx0YSA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc3FydERlbHRhID0gTWF0aC5zcXJ0KGRlbHRhKTsKICAgIGNvbnN0IGEyID0gMiAqIGE7CiAgICB0aGlzLiNnZXRFeHRyZW11bU9uQ3VydmUoeDAsIHgxLCB4MiwgeDMsIHkwLCB5MSwgeTIsIHkzLCAoLWIgKyBzcXJ0RGVsdGEpIC8gYTIsIG1pbk1heCk7CiAgICB0aGlzLiNnZXRFeHRyZW11bU9uQ3VydmUoeDAsIHgxLCB4MiwgeDMsIHkwLCB5MSwgeTIsIHkzLCAoLWIgLSBzcXJ0RGVsdGEpIC8gYTIsIG1pbk1heCk7CiAgfQogIHN0YXRpYyBiZXppZXJCb3VuZGluZ0JveCh4MCwgeTAsIHgxLCB5MSwgeDIsIHkyLCB4MywgeTMsIG1pbk1heCkgewogICAgbWluTWF4WzBdID0gTWF0aC5taW4obWluTWF4WzBdLCB4MCwgeDMpOwogICAgbWluTWF4WzFdID0gTWF0aC5taW4obWluTWF4WzFdLCB5MCwgeTMpOwogICAgbWluTWF4WzJdID0gTWF0aC5tYXgobWluTWF4WzJdLCB4MCwgeDMpOwogICAgbWluTWF4WzNdID0gTWF0aC5tYXgobWluTWF4WzNdLCB5MCwgeTMpOwogICAgdGhpcy4jZ2V0RXh0cmVtdW0oeDAsIHgxLCB4MiwgeDMsIHkwLCB5MSwgeTIsIHkzLCAzICogKC14MCArIDMgKiAoeDEgLSB4MikgKyB4MyksIDYgKiAoeDAgLSAyICogeDEgKyB4MiksIDMgKiAoeDEgLSB4MCksIG1pbk1heCk7CiAgICB0aGlzLiNnZXRFeHRyZW11bSh4MCwgeDEsIHgyLCB4MywgeTAsIHkxLCB5MiwgeTMsIDMgKiAoLXkwICsgMyAqICh5MSAtIHkyKSArIHkzKSwgNiAqICh5MCAtIDIgKiB5MSArIHkyKSwgMyAqICh5MSAtIHkwKSwgbWluTWF4KTsKICB9Cn07CmZ1bmN0aW9uIHN0cmluZ1RvVVRGOFN0cmluZyhzdHIpIHsKICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KGVzY2FwZShzdHIpKTsKfQp2YXIgTm9ybWFsaXplUmVnZXggPSBudWxsOwp2YXIgTm9ybWFsaXphdGlvbk1hcCA9IG51bGw7CmZ1bmN0aW9uIG5vcm1hbGl6ZVVuaWNvZGUoc3RyKSB7CiAgaWYgKCFOb3JtYWxpemVSZWdleCkgewogICAgTm9ybWFsaXplUmVnZXggPSAvKFtcdTAwYTBcdTAwYjVcdTAzN2VcdTBlYjNcdTIwMDAtXHUyMDBhXHUyMDJmXHUyMTI2XHVmYjAwLVx1ZmIwNFx1ZmIwNlx1ZmIyMC1cdWZiMzZcdWZiMzgtXHVmYjNjXHVmYjNlXHVmYjQwLVx1ZmI0MVx1ZmI0My1cdWZiNDRcdWZiNDYtXHVmYmExXHVmYmE0LVx1ZmJhOVx1ZmJhZS1cdWZiYjFcdWZiZDMtXHVmYmRjXHVmYmRlLVx1ZmJlN1x1ZmJlYS1cdWZiZjhcdWZiZmMtXHVmYmZkXHVmYzAwLVx1ZmM1ZFx1ZmM2NC1cdWZjZjFcdWZjZjUtXHVmZDNkXHVmZDg4XHVmZGY0XHVmZGZhLVx1ZmRmYlx1ZmU3MVx1ZmU3N1x1ZmU3OVx1ZmU3Ylx1ZmU3ZF0rKXwoXHVmYjA1KykvZ3U7CiAgICBOb3JtYWxpemF0aW9uTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoW1siXHVGQjA1IiwgIlx1MDE3RnQiXV0pOwogIH0KICByZXR1cm4gc3RyLnJlcGxhY2VBbGwoTm9ybWFsaXplUmVnZXgsIChfLCBwMSwgcDIpID0+IHAxID8gcDEubm9ybWFsaXplKCJORktDIikgOiBOb3JtYWxpemF0aW9uTWFwLmdldChwMikpOwp9CmZ1bmN0aW9uIGdldFV1aWQoKSB7CiAgaWYgKHR5cGVvZiBjcnlwdG8ucmFuZG9tVVVJRCA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGNyeXB0by5yYW5kb21VVUlEKCk7CiAgfQogIGNvbnN0IGJ1ZiA9IG5ldyBVaW50OEFycmF5KDMyKTsKICBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKGJ1Zik7CiAgcmV0dXJuIGJ5dGVzVG9TdHJpbmcoYnVmKTsKfQp2YXIgQW5ub3RhdGlvblByZWZpeCA9ICJwZGZqc19pbnRlcm5hbF9pZF8iOwpmdW5jdGlvbiBfaXNWYWxpZEV4cGxpY2l0RGVzdCh2YWxpZFJlZiwgdmFsaWROYW1lLCBkZXN0KSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGRlc3QpIHx8IGRlc3QubGVuZ3RoIDwgMikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCBbcGFnZSwgem9vbSwgLi4uYXJnc10gPSBkZXN0OwogIGlmICghdmFsaWRSZWYocGFnZSkgJiYgIU51bWJlci5pc0ludGVnZXIocGFnZSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKCF2YWxpZE5hbWUoem9vbSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3QgYXJnc0xlbiA9IGFyZ3MubGVuZ3RoOwogIGxldCBhbGxvd051bGwgPSB0cnVlOwogIHN3aXRjaCAoem9vbS5uYW1lKSB7CiAgICBjYXNlICJYWVoiOgogICAgICBpZiAoYXJnc0xlbiA8IDIgfHwgYXJnc0xlbiA+IDMpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgYnJlYWs7CiAgICBjYXNlICJGaXQiOgogICAgY2FzZSAiRml0QiI6CiAgICAgIHJldHVybiBhcmdzTGVuID09PSAwOwogICAgY2FzZSAiRml0SCI6CiAgICBjYXNlICJGaXRCSCI6CiAgICBjYXNlICJGaXRWIjoKICAgIGNhc2UgIkZpdEJWIjoKICAgICAgaWYgKGFyZ3NMZW4gPiAxKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGJyZWFrOwogICAgY2FzZSAiRml0UiI6CiAgICAgIGlmIChhcmdzTGVuICE9PSA0KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGFsbG93TnVsbCA9IGZhbHNlOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBmYWxzZTsKICB9CiAgZm9yIChjb25zdCBhcmcgb2YgYXJncykgewogICAgaWYgKHR5cGVvZiBhcmcgPT09ICJudW1iZXIiIHx8IGFsbG93TnVsbCAmJiBhcmcgPT09IG51bGwpIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIE1hdGhDbGFtcCh2LCBtaW4sIG1heCkgewogIHJldHVybiBNYXRoLm1pbihNYXRoLm1heCh2LCBtaW4pLCBtYXgpOwp9CmZ1bmN0aW9uIHRvQmFzZTY0VXRpbChhcnIpIHsKICBpZiAoVWludDhBcnJheS5wcm90b3R5cGUudG9CYXNlNjQpIHsKICAgIHJldHVybiBhcnIudG9CYXNlNjQoKTsKICB9CiAgcmV0dXJuIGJ0b2EoYnl0ZXNUb1N0cmluZyhhcnIpKTsKfQpmdW5jdGlvbiBmcm9tQmFzZTY0VXRpbChzdHIpIHsKICBpZiAoVWludDhBcnJheS5mcm9tQmFzZTY0KSB7CiAgICByZXR1cm4gVWludDhBcnJheS5mcm9tQmFzZTY0KHN0cik7CiAgfQogIHJldHVybiBzdHJpbmdUb0J5dGVzKGF0b2Ioc3RyKSk7Cn0KaWYgKHR5cGVvZiBQcm9taXNlLnRyeSAhPT0gImZ1bmN0aW9uIikgewogIFByb21pc2UudHJ5ID0gZnVuY3Rpb24oZm4sIC4uLmFyZ3MpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICByZXNvbHZlKGZuKC4uLmFyZ3MpKTsKICAgIH0pOwogIH07Cn0KaWYgKHR5cGVvZiBNYXRoLnN1bVByZWNpc2UgIT09ICJmdW5jdGlvbiIpIHsKICBNYXRoLnN1bVByZWNpc2UgPSBmdW5jdGlvbihudW1iZXJzKSB7CiAgICByZXR1cm4gbnVtYmVycy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKTsKICB9Owp9CnZhciBYZmFUZXh0ID0gY2xhc3MgX1hmYVRleHQgewogIHN0YXRpYyB0ZXh0Q29udGVudCh4ZmEpIHsKICAgIGNvbnN0IGl0ZW1zID0gW107CiAgICBjb25zdCBvdXRwdXQgPSB7CiAgICAgIGl0ZW1zLAogICAgICBzdHlsZXM6IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpCiAgICB9OwogICAgZnVuY3Rpb24gd2Fsayhub2RlKSB7CiAgICAgIGlmICghbm9kZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBsZXQgc3RyID0gbnVsbDsKICAgICAgY29uc3QgbmFtZSA9IG5vZGUubmFtZTsKICAgICAgaWYgKG5hbWUgPT09ICIjdGV4dCIpIHsKICAgICAgICBzdHIgPSBub2RlLnZhbHVlOwogICAgICB9IGVsc2UgaWYgKCFfWGZhVGV4dC5zaG91bGRCdWlsZFRleHQobmFtZSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAobm9kZT8uYXR0cmlidXRlcz8udGV4dENvbnRlbnQpIHsKICAgICAgICBzdHIgPSBub2RlLmF0dHJpYnV0ZXMudGV4dENvbnRlbnQ7CiAgICAgIH0gZWxzZSBpZiAobm9kZS52YWx1ZSkgewogICAgICAgIHN0ciA9IG5vZGUudmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHN0ciAhPT0gbnVsbCkgewogICAgICAgIGl0ZW1zLnB1c2goewogICAgICAgICAgc3RyCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGZvciAoY29uc3QgY2hpbGQgb2Ygbm9kZS5jaGlsZHJlbikgewogICAgICAgIHdhbGsoY2hpbGQpOwogICAgICB9CiAgICB9CiAgICB3YWxrKHhmYSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0KICBzdGF0aWMgc2hvdWxkQnVpbGRUZXh0KG5hbWUpIHsKICAgIHJldHVybiAhKG5hbWUgPT09ICJ0ZXh0YXJlYSIgfHwgbmFtZSA9PT0gImlucHV0IiB8fCBuYW1lID09PSAib3B0aW9uIiB8fCBuYW1lID09PSAic2VsZWN0Iik7CiAgfQp9Owp2YXIgWGZhTGF5ZXIgPSBjbGFzcyB7CiAgc3RhdGljIHNldHVwU3RvcmFnZShodG1sLCBpZCwgZWxlbWVudCwgc3RvcmFnZSwgaW50ZW50KSB7CiAgICBjb25zdCBzdG9yZWREYXRhID0gc3RvcmFnZS5nZXRWYWx1ZShpZCwgewogICAgICB2YWx1ZTogbnVsbAogICAgfSk7CiAgICBzd2l0Y2ggKGVsZW1lbnQubmFtZSkgewogICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgaWYgKHN0b3JlZERhdGEudmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgIGh0bWwudGV4dENvbnRlbnQgPSBzdG9yZWREYXRhLnZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoaW50ZW50ID09PSAicHJpbnQiKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaHRtbC5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsIChldmVudCkgPT4gewogICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICB2YWx1ZTogZXZlbnQudGFyZ2V0LnZhbHVlCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgIGlmIChlbGVtZW50LmF0dHJpYnV0ZXMudHlwZSA9PT0gInJhZGlvIiB8fCBlbGVtZW50LmF0dHJpYnV0ZXMudHlwZSA9PT0gImNoZWNrYm94IikgewogICAgICAgICAgaWYgKHN0b3JlZERhdGEudmFsdWUgPT09IGVsZW1lbnQuYXR0cmlidXRlcy54ZmFPbikgewogICAgICAgICAgICBodG1sLnNldEF0dHJpYnV0ZSgiY2hlY2tlZCIsIHRydWUpOwogICAgICAgICAgfSBlbHNlIGlmIChzdG9yZWREYXRhLnZhbHVlID09PSBlbGVtZW50LmF0dHJpYnV0ZXMueGZhT2ZmKSB7CiAgICAgICAgICAgIGh0bWwucmVtb3ZlQXR0cmlidXRlKCJjaGVja2VkIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW50ZW50ID09PSAicHJpbnQiKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaHRtbC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICAgIHZhbHVlOiBldmVudC50YXJnZXQuY2hlY2tlZCA/IGV2ZW50LnRhcmdldC5nZXRBdHRyaWJ1dGUoInhmYU9uIikgOiBldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCJ4ZmFPZmYiKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoc3RvcmVkRGF0YS52YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBodG1sLnNldEF0dHJpYnV0ZSgidmFsdWUiLCBzdG9yZWREYXRhLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbnRlbnQgPT09ICJwcmludCIpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBodG1sLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogZXZlbnQudGFyZ2V0LnZhbHVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgIGlmIChzdG9yZWREYXRhLnZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICBodG1sLnNldEF0dHJpYnV0ZSgidmFsdWUiLCBzdG9yZWREYXRhLnZhbHVlKTsKICAgICAgICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIGVsZW1lbnQuY2hpbGRyZW4pIHsKICAgICAgICAgICAgaWYgKG9wdGlvbi5hdHRyaWJ1dGVzLnZhbHVlID09PSBzdG9yZWREYXRhLnZhbHVlKSB7CiAgICAgICAgICAgICAgb3B0aW9uLmF0dHJpYnV0ZXMuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbi5hdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KCJzZWxlY3RlZCIpKSB7CiAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbi5hdHRyaWJ1dGVzLnNlbGVjdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGh0bWwuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCAoZXZlbnQpID0+IHsKICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBldmVudC50YXJnZXQub3B0aW9uczsKICAgICAgICAgIGNvbnN0IHZhbHVlID0gb3B0aW9ucy5zZWxlY3RlZEluZGV4ID09PSAtMSA/ICIiIDogb3B0aW9uc1tvcHRpb25zLnNlbGVjdGVkSW5kZXhdLnZhbHVlOwogICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICB2YWx1ZQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHN0YXRpYyBzZXRBdHRyaWJ1dGVzKHsKICAgIGh0bWwsCiAgICBlbGVtZW50LAogICAgc3RvcmFnZSA9IG51bGwsCiAgICBpbnRlbnQsCiAgICBsaW5rU2VydmljZQogIH0pIHsKICAgIGNvbnN0IHsKICAgICAgYXR0cmlidXRlcwogICAgfSA9IGVsZW1lbnQ7CiAgICBjb25zdCBpc0hUTUxBbmNob3JFbGVtZW50ID0gaHRtbCBpbnN0YW5jZW9mIEhUTUxBbmNob3JFbGVtZW50OwogICAgaWYgKGF0dHJpYnV0ZXMudHlwZSA9PT0gInJhZGlvIikgewogICAgICBhdHRyaWJ1dGVzLm5hbWUgPSBgJHthdHRyaWJ1dGVzLm5hbWV9LSR7aW50ZW50fWA7CiAgICB9CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhhdHRyaWJ1dGVzKSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHZvaWQgMCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCkgewogICAgICAgICAgICBodG1sLnNldEF0dHJpYnV0ZShrZXksIHZhbHVlLmpvaW4oIiAiKSk7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJkYXRhSWQiOgogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiaWQiOgogICAgICAgICAgaHRtbC5zZXRBdHRyaWJ1dGUoImRhdGEtZWxlbWVudC1pZCIsIHZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgIE9iamVjdC5hc3NpZ24oaHRtbC5zdHlsZSwgdmFsdWUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAidGV4dENvbnRlbnQiOgogICAgICAgICAgaHRtbC50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmICghaXNIVE1MQW5jaG9yRWxlbWVudCB8fCBrZXkgIT09ICJocmVmIiAmJiBrZXkgIT09ICJuZXdXaW5kb3ciKSB7CiAgICAgICAgICAgIGh0bWwuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoaXNIVE1MQW5jaG9yRWxlbWVudCkgewogICAgICBsaW5rU2VydmljZS5hZGRMaW5rQXR0cmlidXRlcyhodG1sLCBhdHRyaWJ1dGVzLmhyZWYsIGF0dHJpYnV0ZXMubmV3V2luZG93KTsKICAgIH0KICAgIGlmIChzdG9yYWdlICYmIGF0dHJpYnV0ZXMuZGF0YUlkKSB7CiAgICAgIHRoaXMuc2V0dXBTdG9yYWdlKGh0bWwsIGF0dHJpYnV0ZXMuZGF0YUlkLCBlbGVtZW50LCBzdG9yYWdlKTsKICAgIH0KICB9CiAgc3RhdGljIHJlbmRlcihwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBzdG9yYWdlID0gcGFyYW1ldGVycy5hbm5vdGF0aW9uU3RvcmFnZTsKICAgIGNvbnN0IGxpbmtTZXJ2aWNlID0gcGFyYW1ldGVycy5saW5rU2VydmljZTsKICAgIGNvbnN0IHJvb3QyID0gcGFyYW1ldGVycy54ZmFIdG1sOwogICAgY29uc3QgaW50ZW50ID0gcGFyYW1ldGVycy5pbnRlbnQgfHwgImRpc3BsYXkiOwogICAgY29uc3Qgcm9vdEh0bWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHJvb3QyLm5hbWUpOwogICAgaWYgKHJvb3QyLmF0dHJpYnV0ZXMpIHsKICAgICAgdGhpcy5zZXRBdHRyaWJ1dGVzKHsKICAgICAgICBodG1sOiByb290SHRtbCwKICAgICAgICBlbGVtZW50OiByb290MiwKICAgICAgICBpbnRlbnQsCiAgICAgICAgbGlua1NlcnZpY2UKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBpc05vdEZvclJpY2hUZXh0ID0gaW50ZW50ICE9PSAicmljaFRleHQiOwogICAgY29uc3Qgcm9vdERpdiA9IHBhcmFtZXRlcnMuZGl2OwogICAgcm9vdERpdi5hcHBlbmQocm9vdEh0bWwpOwogICAgaWYgKHBhcmFtZXRlcnMudmlld3BvcnQpIHsKICAgICAgY29uc3QgdHJhbnNmb3JtID0gYG1hdHJpeCgke3BhcmFtZXRlcnMudmlld3BvcnQudHJhbnNmb3JtLmpvaW4oIiwiKX0pYDsKICAgICAgcm9vdERpdi5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICB9CiAgICBpZiAoaXNOb3RGb3JSaWNoVGV4dCkgewogICAgICByb290RGl2LnNldEF0dHJpYnV0ZSgiY2xhc3MiLCAieGZhTGF5ZXIgeGZhRm9udCIpOwogICAgfQogICAgY29uc3QgdGV4dERpdnMgPSBbXTsKICAgIGlmIChyb290Mi5jaGlsZHJlbi5sZW5ndGggPT09IDApIHsKICAgICAgaWYgKHJvb3QyLnZhbHVlKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHJvb3QyLnZhbHVlKTsKICAgICAgICByb290SHRtbC5hcHBlbmQobm9kZSk7CiAgICAgICAgaWYgKGlzTm90Rm9yUmljaFRleHQgJiYgWGZhVGV4dC5zaG91bGRCdWlsZFRleHQocm9vdDIubmFtZSkpIHsKICAgICAgICAgIHRleHREaXZzLnB1c2gobm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgdGV4dERpdnMKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHN0YWNrID0gW1tyb290MiwgLTEsIHJvb3RIdG1sXV07CiAgICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgICBjb25zdCBbcGFyZW50LCBpLCBodG1sXSA9IHN0YWNrLmF0KC0xKTsKICAgICAgaWYgKGkgKyAxID09PSBwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgc3RhY2sucG9wKCk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgY2hpbGQgPSBwYXJlbnQuY2hpbGRyZW5bKytzdGFjay5hdCgtMSlbMV1dOwogICAgICBpZiAoY2hpbGQgPT09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCB7CiAgICAgICAgbmFtZQogICAgICB9ID0gY2hpbGQ7CiAgICAgIGlmIChuYW1lID09PSAiI3RleHQiKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNoaWxkLnZhbHVlKTsKICAgICAgICB0ZXh0RGl2cy5wdXNoKG5vZGUpOwogICAgICAgIGh0bWwuYXBwZW5kKG5vZGUpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGNoaWxkSHRtbCA9IGNoaWxkPy5hdHRyaWJ1dGVzPy54bWxucyA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhjaGlsZC5hdHRyaWJ1dGVzLnhtbG5zLCBuYW1lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobmFtZSk7CiAgICAgIGh0bWwuYXBwZW5kKGNoaWxkSHRtbCk7CiAgICAgIGlmIChjaGlsZC5hdHRyaWJ1dGVzKSB7CiAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGVzKHsKICAgICAgICAgIGh0bWw6IGNoaWxkSHRtbCwKICAgICAgICAgIGVsZW1lbnQ6IGNoaWxkLAogICAgICAgICAgc3RvcmFnZSwKICAgICAgICAgIGludGVudCwKICAgICAgICAgIGxpbmtTZXJ2aWNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGNoaWxkLmNoaWxkcmVuPy5sZW5ndGggPiAwKSB7CiAgICAgICAgc3RhY2sucHVzaChbY2hpbGQsIC0xLCBjaGlsZEh0bWxdKTsKICAgICAgfSBlbHNlIGlmIChjaGlsZC52YWx1ZSkgewogICAgICAgIGNvbnN0IG5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjaGlsZC52YWx1ZSk7CiAgICAgICAgaWYgKGlzTm90Rm9yUmljaFRleHQgJiYgWGZhVGV4dC5zaG91bGRCdWlsZFRleHQobmFtZSkpIHsKICAgICAgICAgIHRleHREaXZzLnB1c2gobm9kZSk7CiAgICAgICAgfQogICAgICAgIGNoaWxkSHRtbC5hcHBlbmQobm9kZSk7CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgZWwgb2Ygcm9vdERpdi5xdWVyeVNlbGVjdG9yQWxsKCIueGZhTm9uSW50ZXJhY3RpdmUgaW5wdXQsIC54ZmFOb25JbnRlcmFjdGl2ZSB0ZXh0YXJlYSIpKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZSgicmVhZE9ubHkiLCB0cnVlKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHRleHREaXZzCiAgICB9OwogIH0KICBzdGF0aWMgdXBkYXRlKHBhcmFtZXRlcnMpIHsKICAgIGNvbnN0IHRyYW5zZm9ybSA9IGBtYXRyaXgoJHtwYXJhbWV0ZXJzLnZpZXdwb3J0LnRyYW5zZm9ybS5qb2luKCIsIil9KWA7CiAgICBwYXJhbWV0ZXJzLmRpdi5zdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07CiAgICBwYXJhbWV0ZXJzLmRpdi5oaWRkZW4gPSBmYWxzZTsKICB9Cn07CnZhciBTVkdfTlMgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwp2YXIgUGl4ZWxzUGVySW5jaCA9IGNsYXNzIHsKICBzdGF0aWMgQ1NTID0gOTY7CiAgc3RhdGljIFBERiA9IDcyOwogIHN0YXRpYyBQREZfVE9fQ1NTX1VOSVRTID0gdGhpcy5DU1MgLyB0aGlzLlBERjsKfTsKYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKHVybCwgdHlwZSA9ICJ0ZXh0IikgewogIGlmIChpc1ZhbGlkRmV0Y2hVcmwodXJsLCBkb2N1bWVudC5iYXNlVVJJKSkgewogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpOwogICAgaWYgKCFyZXNwb25zZS5vaykgewogICAgICB0aHJvdyBuZXcgRXJyb3IocmVzcG9uc2Uuc3RhdHVzVGV4dCk7CiAgICB9CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAiYXJyYXlidWZmZXIiOgogICAgICAgIHJldHVybiByZXNwb25zZS5hcnJheUJ1ZmZlcigpOwogICAgICBjYXNlICJibG9iIjoKICAgICAgICByZXR1cm4gcmVzcG9uc2UuYmxvYigpOwogICAgICBjYXNlICJqc29uIjoKICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpOwogICAgfQogICAgcmV0dXJuIHJlc3BvbnNlLnRleHQoKTsKICB9CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIHJlcXVlc3Qub3BlbigiR0VUIiwgdXJsLCB0cnVlKTsKICAgIHJlcXVlc3QucmVzcG9uc2VUeXBlID0gdHlwZTsKICAgIHJlcXVlc3Qub25yZWFkeXN0YXRlY2hhbmdlID0gKCkgPT4gewogICAgICBpZiAocmVxdWVzdC5yZWFkeVN0YXRlICE9PSBYTUxIdHRwUmVxdWVzdC5ET05FKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChyZXF1ZXN0LnN0YXR1cyA9PT0gMjAwIHx8IHJlcXVlc3Quc3RhdHVzID09PSAwKSB7CiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICBjYXNlICJhcnJheWJ1ZmZlciI6CiAgICAgICAgICBjYXNlICJibG9iIjoKICAgICAgICAgIGNhc2UgImpzb24iOgogICAgICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzcG9uc2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJlc29sdmUocmVxdWVzdC5yZXNwb25zZVRleHQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICByZWplY3QobmV3IEVycm9yKHJlcXVlc3Quc3RhdHVzVGV4dCkpOwogICAgfTsKICAgIHJlcXVlc3Quc2VuZChudWxsKTsKICB9KTsKfQp2YXIgUGFnZVZpZXdwb3J0ID0gY2xhc3MgX1BhZ2VWaWV3cG9ydCB7CiAgY29uc3RydWN0b3IoewogICAgdmlld0JveCwKICAgIHVzZXJVbml0LAogICAgc2NhbGUsCiAgICByb3RhdGlvbiwKICAgIG9mZnNldFggPSAwLAogICAgb2Zmc2V0WSA9IDAsCiAgICBkb250RmxpcCA9IGZhbHNlCiAgfSkgewogICAgdGhpcy52aWV3Qm94ID0gdmlld0JveDsKICAgIHRoaXMudXNlclVuaXQgPSB1c2VyVW5pdDsKICAgIHRoaXMuc2NhbGUgPSBzY2FsZTsKICAgIHRoaXMucm90YXRpb24gPSByb3RhdGlvbjsKICAgIHRoaXMub2Zmc2V0WCA9IG9mZnNldFg7CiAgICB0aGlzLm9mZnNldFkgPSBvZmZzZXRZOwogICAgc2NhbGUgKj0gdXNlclVuaXQ7CiAgICBjb25zdCBjZW50ZXJYID0gKHZpZXdCb3hbMl0gKyB2aWV3Qm94WzBdKSAvIDI7CiAgICBjb25zdCBjZW50ZXJZID0gKHZpZXdCb3hbM10gKyB2aWV3Qm94WzFdKSAvIDI7CiAgICBsZXQgcm90YXRlQSwgcm90YXRlQiwgcm90YXRlQywgcm90YXRlRDsKICAgIHJvdGF0aW9uICU9IDM2MDsKICAgIGlmIChyb3RhdGlvbiA8IDApIHsKICAgICAgcm90YXRpb24gKz0gMzYwOwogICAgfQogICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICBjYXNlIDE4MDoKICAgICAgICByb3RhdGVBID0gLTE7CiAgICAgICAgcm90YXRlQiA9IDA7CiAgICAgICAgcm90YXRlQyA9IDA7CiAgICAgICAgcm90YXRlRCA9IDE7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgcm90YXRlQSA9IDA7CiAgICAgICAgcm90YXRlQiA9IDE7CiAgICAgICAgcm90YXRlQyA9IDE7CiAgICAgICAgcm90YXRlRCA9IDA7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJvdGF0ZUEgPSAwOwogICAgICAgIHJvdGF0ZUIgPSAtMTsKICAgICAgICByb3RhdGVDID0gLTE7CiAgICAgICAgcm90YXRlRCA9IDA7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMDoKICAgICAgICByb3RhdGVBID0gMTsKICAgICAgICByb3RhdGVCID0gMDsKICAgICAgICByb3RhdGVDID0gMDsKICAgICAgICByb3RhdGVEID0gLTE7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQYWdlVmlld3BvcnQ6IEludmFsaWQgcm90YXRpb24sIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA5MCBkZWdyZWVzLiIpOwogICAgfQogICAgaWYgKGRvbnRGbGlwKSB7CiAgICAgIHJvdGF0ZUMgPSAtcm90YXRlQzsKICAgICAgcm90YXRlRCA9IC1yb3RhdGVEOwogICAgfQogICAgbGV0IG9mZnNldENhbnZhc1gsIG9mZnNldENhbnZhc1k7CiAgICBsZXQgd2lkdGgsIGhlaWdodDsKICAgIGlmIChyb3RhdGVBID09PSAwKSB7CiAgICAgIG9mZnNldENhbnZhc1ggPSBNYXRoLmFicyhjZW50ZXJZIC0gdmlld0JveFsxXSkgKiBzY2FsZSArIG9mZnNldFg7CiAgICAgIG9mZnNldENhbnZhc1kgPSBNYXRoLmFicyhjZW50ZXJYIC0gdmlld0JveFswXSkgKiBzY2FsZSArIG9mZnNldFk7CiAgICAgIHdpZHRoID0gKHZpZXdCb3hbM10gLSB2aWV3Qm94WzFdKSAqIHNjYWxlOwogICAgICBoZWlnaHQgPSAodmlld0JveFsyXSAtIHZpZXdCb3hbMF0pICogc2NhbGU7CiAgICB9IGVsc2UgewogICAgICBvZmZzZXRDYW52YXNYID0gTWF0aC5hYnMoY2VudGVyWCAtIHZpZXdCb3hbMF0pICogc2NhbGUgKyBvZmZzZXRYOwogICAgICBvZmZzZXRDYW52YXNZID0gTWF0aC5hYnMoY2VudGVyWSAtIHZpZXdCb3hbMV0pICogc2NhbGUgKyBvZmZzZXRZOwogICAgICB3aWR0aCA9ICh2aWV3Qm94WzJdIC0gdmlld0JveFswXSkgKiBzY2FsZTsKICAgICAgaGVpZ2h0ID0gKHZpZXdCb3hbM10gLSB2aWV3Qm94WzFdKSAqIHNjYWxlOwogICAgfQogICAgdGhpcy50cmFuc2Zvcm0gPSBbcm90YXRlQSAqIHNjYWxlLCByb3RhdGVCICogc2NhbGUsIHJvdGF0ZUMgKiBzY2FsZSwgcm90YXRlRCAqIHNjYWxlLCBvZmZzZXRDYW52YXNYIC0gcm90YXRlQSAqIHNjYWxlICogY2VudGVyWCAtIHJvdGF0ZUMgKiBzY2FsZSAqIGNlbnRlclksIG9mZnNldENhbnZhc1kgLSByb3RhdGVCICogc2NhbGUgKiBjZW50ZXJYIC0gcm90YXRlRCAqIHNjYWxlICogY2VudGVyWV07CiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKICB9CiAgZ2V0IHJhd0RpbXMoKSB7CiAgICBjb25zdCBkaW1zID0gdGhpcy52aWV3Qm94OwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAicmF3RGltcyIsIHsKICAgICAgcGFnZVdpZHRoOiBkaW1zWzJdIC0gZGltc1swXSwKICAgICAgcGFnZUhlaWdodDogZGltc1szXSAtIGRpbXNbMV0sCiAgICAgIHBhZ2VYOiBkaW1zWzBdLAogICAgICBwYWdlWTogZGltc1sxXQogICAgfSk7CiAgfQogIGNsb25lKHsKICAgIHNjYWxlID0gdGhpcy5zY2FsZSwKICAgIHJvdGF0aW9uID0gdGhpcy5yb3RhdGlvbiwKICAgIG9mZnNldFggPSB0aGlzLm9mZnNldFgsCiAgICBvZmZzZXRZID0gdGhpcy5vZmZzZXRZLAogICAgZG9udEZsaXAgPSBmYWxzZQogIH0gPSB7fSkgewogICAgcmV0dXJuIG5ldyBfUGFnZVZpZXdwb3J0KHsKICAgICAgdmlld0JveDogdGhpcy52aWV3Qm94LnNsaWNlKCksCiAgICAgIHVzZXJVbml0OiB0aGlzLnVzZXJVbml0LAogICAgICBzY2FsZSwKICAgICAgcm90YXRpb24sCiAgICAgIG9mZnNldFgsCiAgICAgIG9mZnNldFksCiAgICAgIGRvbnRGbGlwCiAgICB9KTsKICB9CiAgY29udmVydFRvVmlld3BvcnRQb2ludCh4LCB5KSB7CiAgICBjb25zdCBwID0gW3gsIHldOwogICAgVXRpbC5hcHBseVRyYW5zZm9ybShwLCB0aGlzLnRyYW5zZm9ybSk7CiAgICByZXR1cm4gcDsKICB9CiAgY29udmVydFRvVmlld3BvcnRSZWN0YW5nbGUocmVjdCkgewogICAgY29uc3QgdG9wTGVmdCA9IFtyZWN0WzBdLCByZWN0WzFdXTsKICAgIFV0aWwuYXBwbHlUcmFuc2Zvcm0odG9wTGVmdCwgdGhpcy50cmFuc2Zvcm0pOwogICAgY29uc3QgYm90dG9tUmlnaHQgPSBbcmVjdFsyXSwgcmVjdFszXV07CiAgICBVdGlsLmFwcGx5VHJhbnNmb3JtKGJvdHRvbVJpZ2h0LCB0aGlzLnRyYW5zZm9ybSk7CiAgICByZXR1cm4gW3RvcExlZnRbMF0sIHRvcExlZnRbMV0sIGJvdHRvbVJpZ2h0WzBdLCBib3R0b21SaWdodFsxXV07CiAgfQogIGNvbnZlcnRUb1BkZlBvaW50KHgsIHkpIHsKICAgIGNvbnN0IHAgPSBbeCwgeV07CiAgICBVdGlsLmFwcGx5SW52ZXJzZVRyYW5zZm9ybShwLCB0aGlzLnRyYW5zZm9ybSk7CiAgICByZXR1cm4gcDsKICB9Cn07CnZhciBSZW5kZXJpbmdDYW5jZWxsZWRFeGNlcHRpb24gPSBjbGFzcyBleHRlbmRzIEJhc2VFeGNlcHRpb24gewogIGNvbnN0cnVjdG9yKG1zZywgZXh0cmFEZWxheSA9IDApIHsKICAgIHN1cGVyKG1zZywgIlJlbmRlcmluZ0NhbmNlbGxlZEV4Y2VwdGlvbiIpOwogICAgdGhpcy5leHRyYURlbGF5ID0gZXh0cmFEZWxheTsKICB9Cn07CmZ1bmN0aW9uIGlzRGF0YVNjaGVtZSh1cmwpIHsKICBjb25zdCBpaSA9IHVybC5sZW5ndGg7CiAgbGV0IGkgPSAwOwogIHdoaWxlIChpIDwgaWkgJiYgdXJsW2ldLnRyaW0oKSA9PT0gIiIpIHsKICAgIGkrKzsKICB9CiAgcmV0dXJuIHVybC5zdWJzdHJpbmcoaSwgaSArIDUpLnRvTG93ZXJDYXNlKCkgPT09ICJkYXRhOiI7Cn0KZnVuY3Rpb24gaXNQZGZGaWxlKGZpbGVuYW1lKSB7CiAgcmV0dXJuIHR5cGVvZiBmaWxlbmFtZSA9PT0gInN0cmluZyIgJiYgL1wucGRmJC9pLnRlc3QoZmlsZW5hbWUpOwp9CmZ1bmN0aW9uIGdldEZpbGVuYW1lRnJvbVVybCh1cmwpIHsKICBbdXJsXSA9IHVybC5zcGxpdCgvWyM/XS8sIDEpOwogIHJldHVybiB1cmwuc3Vic3RyaW5nKHVybC5sYXN0SW5kZXhPZigiLyIpICsgMSk7Cn0KZnVuY3Rpb24gZ2V0UGRmRmlsZW5hbWVGcm9tVXJsKHVybCwgZGVmYXVsdEZpbGVuYW1lID0gImRvY3VtZW50LnBkZiIpIHsKICBpZiAodHlwZW9mIHVybCAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBkZWZhdWx0RmlsZW5hbWU7CiAgfQogIGlmIChpc0RhdGFTY2hlbWUodXJsKSkgewogICAgd2FybignZ2V0UGRmRmlsZW5hbWVGcm9tVXJsOiBpZ25vcmUgImRhdGE6Ii1VUkwgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuJyk7CiAgICByZXR1cm4gZGVmYXVsdEZpbGVuYW1lOwogIH0KICBjb25zdCBnZXRVUkwgPSAodXJsU3RyaW5nKSA9PiB7CiAgICB0cnkgewogICAgICByZXR1cm4gbmV3IFVSTCh1cmxTdHJpbmcpOwogICAgfSBjYXRjaCB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwoZGVjb2RlVVJJQ29tcG9uZW50KHVybFN0cmluZykpOwogICAgICB9IGNhdGNoIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG5ldyBVUkwodXJsU3RyaW5nLCAiaHR0cHM6Ly9mb28uYmFyIik7CiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gbmV3IFVSTChkZWNvZGVVUklDb21wb25lbnQodXJsU3RyaW5nKSwgImh0dHBzOi8vZm9vLmJhciIpOwogICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgY29uc3QgbmV3VVJMID0gZ2V0VVJMKHVybCk7CiAgaWYgKCFuZXdVUkwpIHsKICAgIHJldHVybiBkZWZhdWx0RmlsZW5hbWU7CiAgfQogIGNvbnN0IGRlY29kZSA9IChuYW1lKSA9PiB7CiAgICB0cnkgewogICAgICBsZXQgZGVjb2RlZCA9IGRlY29kZVVSSUNvbXBvbmVudChuYW1lKTsKICAgICAgaWYgKGRlY29kZWQuaW5jbHVkZXMoIi8iKSkgewogICAgICAgIGRlY29kZWQgPSBkZWNvZGVkLnNwbGl0KCIvIikuYXQoLTEpOwogICAgICAgIGlmIChkZWNvZGVkLnRlc3QoL15cLnBkZiQvaSkpIHsKICAgICAgICAgIHJldHVybiBkZWNvZGVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgfQogICAgICByZXR1cm4gZGVjb2RlZDsKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9OwogIGNvbnN0IHBkZlJlZ2V4ID0gL1wucGRmJC9pOwogIGNvbnN0IGZpbGVuYW1lID0gbmV3VVJMLnBhdGhuYW1lLnNwbGl0KCIvIikuYXQoLTEpOwogIGlmIChwZGZSZWdleC50ZXN0KGZpbGVuYW1lKSkgewogICAgcmV0dXJuIGRlY29kZShmaWxlbmFtZSk7CiAgfQogIGlmIChuZXdVUkwuc2VhcmNoUGFyYW1zLnNpemUgPiAwKSB7CiAgICBjb25zdCB2YWx1ZXMgPSBBcnJheS5mcm9tKG5ld1VSTC5zZWFyY2hQYXJhbXMudmFsdWVzKCkpLnJldmVyc2UoKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmIChwZGZSZWdleC50ZXN0KHZhbHVlKSkgewogICAgICAgIHJldHVybiBkZWNvZGUodmFsdWUpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBrZXlzID0gQXJyYXkuZnJvbShuZXdVUkwuc2VhcmNoUGFyYW1zLmtleXMoKSkucmV2ZXJzZSgpOwogICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICBpZiAocGRmUmVnZXgudGVzdChrZXkpKSB7CiAgICAgICAgcmV0dXJuIGRlY29kZShrZXkpOwogICAgICB9CiAgICB9CiAgfQogIGlmIChuZXdVUkwuaGFzaCkgewogICAgY29uc3QgcmVGaWxlbmFtZSA9IC9bXi8/Iz1dK1wucGRmXGIoPyEuKlwucGRmXGIpL2k7CiAgICBjb25zdCBoYXNoRmlsZW5hbWUgPSByZUZpbGVuYW1lLmV4ZWMobmV3VVJMLmhhc2gpOwogICAgaWYgKGhhc2hGaWxlbmFtZSkgewogICAgICByZXR1cm4gZGVjb2RlKGhhc2hGaWxlbmFtZVswXSk7CiAgICB9CiAgfQogIHJldHVybiBkZWZhdWx0RmlsZW5hbWU7Cn0KdmFyIFN0YXRUaW1lciA9IGNsYXNzIHsKICBzdGFydGVkID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdGltZXMgPSBbXTsKICB0aW1lKG5hbWUpIHsKICAgIGlmIChuYW1lIGluIHRoaXMuc3RhcnRlZCkgewogICAgICB3YXJuKGBUaW1lciBpcyBhbHJlYWR5IHJ1bm5pbmcgZm9yICR7bmFtZX1gKTsKICAgIH0KICAgIHRoaXMuc3RhcnRlZFtuYW1lXSA9IERhdGUubm93KCk7CiAgfQogIHRpbWVFbmQobmFtZSkgewogICAgaWYgKCEobmFtZSBpbiB0aGlzLnN0YXJ0ZWQpKSB7CiAgICAgIHdhcm4oYFRpbWVyIGhhcyBub3QgYmVlbiBzdGFydGVkIGZvciAke25hbWV9YCk7CiAgICB9CiAgICB0aGlzLnRpbWVzLnB1c2goewogICAgICBuYW1lLAogICAgICBzdGFydDogdGhpcy5zdGFydGVkW25hbWVdLAogICAgICBlbmQ6IERhdGUubm93KCkKICAgIH0pOwogICAgZGVsZXRlIHRoaXMuc3RhcnRlZFtuYW1lXTsKICB9CiAgdG9TdHJpbmcoKSB7CiAgICBjb25zdCBvdXRCdWYgPSBbXTsKICAgIGxldCBsb25nZXN0ID0gMDsKICAgIGZvciAoY29uc3QgewogICAgICBuYW1lCiAgICB9IG9mIHRoaXMudGltZXMpIHsKICAgICAgbG9uZ2VzdCA9IE1hdGgubWF4KG5hbWUubGVuZ3RoLCBsb25nZXN0KTsKICAgIH0KICAgIGZvciAoY29uc3QgewogICAgICBuYW1lLAogICAgICBzdGFydCwKICAgICAgZW5kCiAgICB9IG9mIHRoaXMudGltZXMpIHsKICAgICAgb3V0QnVmLnB1c2goYCR7bmFtZS5wYWRFbmQobG9uZ2VzdCl9ICR7ZW5kIC0gc3RhcnR9bXMKYCk7CiAgICB9CiAgICByZXR1cm4gb3V0QnVmLmpvaW4oIiIpOwogIH0KfTsKZnVuY3Rpb24gaXNWYWxpZEZldGNoVXJsKHVybCwgYmFzZVVybCkgewogIGNvbnN0IHJlcyA9IGJhc2VVcmwgPyBVUkwucGFyc2UodXJsLCBiYXNlVXJsKSA6IFVSTC5wYXJzZSh1cmwpOwogIHJldHVybiByZXM/LnByb3RvY29sID09PSAiaHR0cDoiIHx8IHJlcz8ucHJvdG9jb2wgPT09ICJodHRwczoiOwp9CmZ1bmN0aW9uIG5vQ29udGV4dE1lbnUoZSkgewogIGUucHJldmVudERlZmF1bHQoKTsKfQpmdW5jdGlvbiBzdG9wRXZlbnQoZSkgewogIGUucHJldmVudERlZmF1bHQoKTsKICBlLnN0b3BQcm9wYWdhdGlvbigpOwp9CmZ1bmN0aW9uIGRlcHJlY2F0ZWQoZGV0YWlscykgewogIGNvbnNvbGUubG9nKCJEZXByZWNhdGVkIEFQSSB1c2FnZTogIiArIGRldGFpbHMpOwp9CnZhciBQREZEYXRlU3RyaW5nID0gY2xhc3MgewogIHN0YXRpYyAjcmVnZXg7CiAgc3RhdGljIHRvRGF0ZU9iamVjdChpbnB1dCkgewogICAgaWYgKGlucHV0IGluc3RhbmNlb2YgRGF0ZSkgewogICAgICByZXR1cm4gaW5wdXQ7CiAgICB9CiAgICBpZiAoIWlucHV0IHx8IHR5cGVvZiBpbnB1dCAhPT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB0aGlzLiNyZWdleCB8fD0gbmV3IFJlZ0V4cCgiXkQ6KFxcZHs0fSkoXFxkezJ9KT8oXFxkezJ9KT8oXFxkezJ9KT8oXFxkezJ9KT8oXFxkezJ9KT8oW1p8K3wtXSk/KFxcZHsyfSk/Jz8oXFxkezJ9KT8nPyIpOwogICAgY29uc3QgbWF0Y2hlcyA9IHRoaXMuI3JlZ2V4LmV4ZWMoaW5wdXQpOwogICAgaWYgKCFtYXRjaGVzKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgeWVhciA9IHBhcnNlSW50KG1hdGNoZXNbMV0sIDEwKTsKICAgIGxldCBtb250aCA9IHBhcnNlSW50KG1hdGNoZXNbMl0sIDEwKTsKICAgIG1vbnRoID0gbW9udGggPj0gMSAmJiBtb250aCA8PSAxMiA/IG1vbnRoIC0gMSA6IDA7CiAgICBsZXQgZGF5ID0gcGFyc2VJbnQobWF0Y2hlc1szXSwgMTApOwogICAgZGF5ID0gZGF5ID49IDEgJiYgZGF5IDw9IDMxID8gZGF5IDogMTsKICAgIGxldCBob3VyID0gcGFyc2VJbnQobWF0Y2hlc1s0XSwgMTApOwogICAgaG91ciA9IGhvdXIgPj0gMCAmJiBob3VyIDw9IDIzID8gaG91ciA6IDA7CiAgICBsZXQgbWludXRlID0gcGFyc2VJbnQobWF0Y2hlc1s1XSwgMTApOwogICAgbWludXRlID0gbWludXRlID49IDAgJiYgbWludXRlIDw9IDU5ID8gbWludXRlIDogMDsKICAgIGxldCBzZWNvbmQgPSBwYXJzZUludChtYXRjaGVzWzZdLCAxMCk7CiAgICBzZWNvbmQgPSBzZWNvbmQgPj0gMCAmJiBzZWNvbmQgPD0gNTkgPyBzZWNvbmQgOiAwOwogICAgY29uc3QgdW5pdmVyc2FsVGltZVJlbGF0aW9uID0gbWF0Y2hlc1s3XSB8fCAiWiI7CiAgICBsZXQgb2Zmc2V0SG91ciA9IHBhcnNlSW50KG1hdGNoZXNbOF0sIDEwKTsKICAgIG9mZnNldEhvdXIgPSBvZmZzZXRIb3VyID49IDAgJiYgb2Zmc2V0SG91ciA8PSAyMyA/IG9mZnNldEhvdXIgOiAwOwogICAgbGV0IG9mZnNldE1pbnV0ZSA9IHBhcnNlSW50KG1hdGNoZXNbOV0sIDEwKSB8fCAwOwogICAgb2Zmc2V0TWludXRlID0gb2Zmc2V0TWludXRlID49IDAgJiYgb2Zmc2V0TWludXRlIDw9IDU5ID8gb2Zmc2V0TWludXRlIDogMDsKICAgIGlmICh1bml2ZXJzYWxUaW1lUmVsYXRpb24gPT09ICItIikgewogICAgICBob3VyICs9IG9mZnNldEhvdXI7CiAgICAgIG1pbnV0ZSArPSBvZmZzZXRNaW51dGU7CiAgICB9IGVsc2UgaWYgKHVuaXZlcnNhbFRpbWVSZWxhdGlvbiA9PT0gIisiKSB7CiAgICAgIGhvdXIgLT0gb2Zmc2V0SG91cjsKICAgICAgbWludXRlIC09IG9mZnNldE1pbnV0ZTsKICAgIH0KICAgIHJldHVybiBuZXcgRGF0ZShEYXRlLlVUQyh5ZWFyLCBtb250aCwgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZCkpOwogIH0KfTsKZnVuY3Rpb24gZ2V0WGZhUGFnZVZpZXdwb3J0KHhmYVBhZ2UsIHsKICBzY2FsZSA9IDEsCiAgcm90YXRpb24gPSAwCn0pIHsKICBjb25zdCB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSB4ZmFQYWdlLmF0dHJpYnV0ZXMuc3R5bGU7CiAgY29uc3Qgdmlld0JveCA9IFswLCAwLCBwYXJzZUludCh3aWR0aCksIHBhcnNlSW50KGhlaWdodCldOwogIHJldHVybiBuZXcgUGFnZVZpZXdwb3J0KHsKICAgIHZpZXdCb3gsCiAgICB1c2VyVW5pdDogMSwKICAgIHNjYWxlLAogICAgcm90YXRpb24KICB9KTsKfQpmdW5jdGlvbiBnZXRSR0IoY29sb3IpIHsKICBpZiAoY29sb3Iuc3RhcnRzV2l0aCgiIyIpKSB7CiAgICBjb25zdCBjb2xvclJHQiA9IHBhcnNlSW50KGNvbG9yLnNsaWNlKDEpLCAxNik7CiAgICByZXR1cm4gWyhjb2xvclJHQiAmIDE2NzExNjgwKSA+PiAxNiwgKGNvbG9yUkdCICYgNjUyODApID4+IDgsIGNvbG9yUkdCICYgMjU1XTsKICB9CiAgaWYgKGNvbG9yLnN0YXJ0c1dpdGgoInJnYigiKSkgewogICAgcmV0dXJuIGNvbG9yLnNsaWNlKDQsIC0xKS5zcGxpdCgiLCIpLm1hcCgoeCkgPT4gcGFyc2VJbnQoeCkpOwogIH0KICBpZiAoY29sb3Iuc3RhcnRzV2l0aCgicmdiYSgiKSkgewogICAgcmV0dXJuIGNvbG9yLnNsaWNlKDUsIC0xKS5zcGxpdCgiLCIpLm1hcCgoeCkgPT4gcGFyc2VJbnQoeCkpLnNsaWNlKDAsIDMpOwogIH0KICB3YXJuKGBOb3QgYSB2YWxpZCBjb2xvciBmb3JtYXQ6ICIke2NvbG9yfSJgKTsKICByZXR1cm4gWzAsIDAsIDBdOwp9CmZ1bmN0aW9uIGdldENvbG9yVmFsdWVzKGNvbG9ycykgewogIGNvbnN0IHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgc3Bhbi5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgc3Bhbi5zdHlsZS5jb2xvclNjaGVtZSA9ICJvbmx5IGxpZ2h0IjsKICBkb2N1bWVudC5ib2R5LmFwcGVuZChzcGFuKTsKICBmb3IgKGNvbnN0IG5hbWUgb2YgY29sb3JzLmtleXMoKSkgewogICAgc3Bhbi5zdHlsZS5jb2xvciA9IG5hbWU7CiAgICBjb25zdCBjb21wdXRlZENvbG9yID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoc3BhbikuY29sb3I7CiAgICBjb2xvcnMuc2V0KG5hbWUsIGdldFJHQihjb21wdXRlZENvbG9yKSk7CiAgfQogIHNwYW4ucmVtb3ZlKCk7Cn0KZnVuY3Rpb24gZ2V0Q3VycmVudFRyYW5zZm9ybShjdHgpIHsKICBjb25zdCB7CiAgICBhLAogICAgYiwKICAgIGMsCiAgICBkLAogICAgZSwKICAgIGYKICB9ID0gY3R4LmdldFRyYW5zZm9ybSgpOwogIHJldHVybiBbYSwgYiwgYywgZCwgZSwgZl07Cn0KZnVuY3Rpb24gZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoY3R4KSB7CiAgY29uc3QgewogICAgYSwKICAgIGIsCiAgICBjLAogICAgZCwKICAgIGUsCiAgICBmCiAgfSA9IGN0eC5nZXRUcmFuc2Zvcm0oKS5pbnZlcnRTZWxmKCk7CiAgcmV0dXJuIFthLCBiLCBjLCBkLCBlLCBmXTsKfQpmdW5jdGlvbiBzZXRMYXllckRpbWVuc2lvbnMoZGl2LCB2aWV3cG9ydCwgbXVzdEZsaXAgPSBmYWxzZSwgbXVzdFJvdGF0ZSA9IHRydWUpIHsKICBpZiAodmlld3BvcnQgaW5zdGFuY2VvZiBQYWdlVmlld3BvcnQpIHsKICAgIGNvbnN0IHsKICAgICAgcGFnZVdpZHRoLAogICAgICBwYWdlSGVpZ2h0CiAgICB9ID0gdmlld3BvcnQucmF3RGltczsKICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSBkaXY7CiAgICBjb25zdCB1c2VSb3VuZCA9IHV0aWxfRmVhdHVyZVRlc3QuaXNDU1NSb3VuZFN1cHBvcnRlZDsKICAgIGNvbnN0IHcgPSBgdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSAqICR7cGFnZVdpZHRofXB4YCwgaCA9IGB2YXIoLS10b3RhbC1zY2FsZS1mYWN0b3IpICogJHtwYWdlSGVpZ2h0fXB4YDsKICAgIGNvbnN0IHdpZHRoU3RyID0gdXNlUm91bmQgPyBgcm91bmQoZG93biwgJHt3fSwgdmFyKC0tc2NhbGUtcm91bmQteCkpYCA6IGBjYWxjKCR7d30pYCwgaGVpZ2h0U3RyID0gdXNlUm91bmQgPyBgcm91bmQoZG93biwgJHtofSwgdmFyKC0tc2NhbGUtcm91bmQteSkpYCA6IGBjYWxjKCR7aH0pYDsKICAgIGlmICghbXVzdEZsaXAgfHwgdmlld3BvcnQucm90YXRpb24gJSAxODAgPT09IDApIHsKICAgICAgc3R5bGUud2lkdGggPSB3aWR0aFN0cjsKICAgICAgc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0U3RyOwogICAgfSBlbHNlIHsKICAgICAgc3R5bGUud2lkdGggPSBoZWlnaHRTdHI7CiAgICAgIHN0eWxlLmhlaWdodCA9IHdpZHRoU3RyOwogICAgfQogIH0KICBpZiAobXVzdFJvdGF0ZSkgewogICAgZGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1tYWluLXJvdGF0aW9uIiwgdmlld3BvcnQucm90YXRpb24pOwogIH0KfQp2YXIgT3V0cHV0U2NhbGUgPSBjbGFzcyBfT3V0cHV0U2NhbGUgewogIGNvbnN0cnVjdG9yKCkgewogICAgY29uc3QgewogICAgICBwaXhlbFJhdGlvCiAgICB9ID0gX091dHB1dFNjYWxlOwogICAgdGhpcy5zeCA9IHBpeGVsUmF0aW87CiAgICB0aGlzLnN5ID0gcGl4ZWxSYXRpbzsKICB9CiAgZ2V0IHNjYWxlZCgpIHsKICAgIHJldHVybiB0aGlzLnN4ICE9PSAxIHx8IHRoaXMuc3kgIT09IDE7CiAgfQogIGdldCBzeW1tZXRyaWMoKSB7CiAgICByZXR1cm4gdGhpcy5zeCA9PT0gdGhpcy5zeTsKICB9CiAgbGltaXRDYW52YXMod2lkdGgsIGhlaWdodCwgbWF4UGl4ZWxzLCBtYXhEaW0sIGNhcEFyZWFGYWN0b3IgPSAtMSkgewogICAgbGV0IG1heEFyZWFTY2FsZSA9IEluZmluaXR5LCBtYXhXaWR0aFNjYWxlID0gSW5maW5pdHksIG1heEhlaWdodFNjYWxlID0gSW5maW5pdHk7CiAgICBtYXhQaXhlbHMgPSBfT3V0cHV0U2NhbGUuY2FwUGl4ZWxzKG1heFBpeGVscywgY2FwQXJlYUZhY3Rvcik7CiAgICBpZiAobWF4UGl4ZWxzID4gMCkgewogICAgICBtYXhBcmVhU2NhbGUgPSBNYXRoLnNxcnQobWF4UGl4ZWxzIC8gKHdpZHRoICogaGVpZ2h0KSk7CiAgICB9CiAgICBpZiAobWF4RGltICE9PSAtMSkgewogICAgICBtYXhXaWR0aFNjYWxlID0gbWF4RGltIC8gd2lkdGg7CiAgICAgIG1heEhlaWdodFNjYWxlID0gbWF4RGltIC8gaGVpZ2h0OwogICAgfQogICAgY29uc3QgbWF4U2NhbGUgPSBNYXRoLm1pbihtYXhBcmVhU2NhbGUsIG1heFdpZHRoU2NhbGUsIG1heEhlaWdodFNjYWxlKTsKICAgIGlmICh0aGlzLnN4ID4gbWF4U2NhbGUgfHwgdGhpcy5zeSA+IG1heFNjYWxlKSB7CiAgICAgIHRoaXMuc3ggPSBtYXhTY2FsZTsKICAgICAgdGhpcy5zeSA9IG1heFNjYWxlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgc3RhdGljIGdldCBwaXhlbFJhdGlvKCkgewogICAgcmV0dXJuIGdsb2JhbFRoaXMuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxOwogIH0KICBzdGF0aWMgY2FwUGl4ZWxzKG1heFBpeGVscywgY2FwQXJlYUZhY3RvcikgewogICAgaWYgKGNhcEFyZWFGYWN0b3IgPj0gMCkgewogICAgICBjb25zdCB3aW5QaXhlbHMgPSBNYXRoLmNlaWwod2luZG93LnNjcmVlbi5hdmFpbFdpZHRoICogd2luZG93LnNjcmVlbi5hdmFpbEhlaWdodCAqIHRoaXMucGl4ZWxSYXRpbyAqKiAyICogKDEgKyBjYXBBcmVhRmFjdG9yIC8gMTAwKSk7CiAgICAgIHJldHVybiBtYXhQaXhlbHMgPiAwID8gTWF0aC5taW4obWF4UGl4ZWxzLCB3aW5QaXhlbHMpIDogd2luUGl4ZWxzOwogICAgfQogICAgcmV0dXJuIG1heFBpeGVsczsKICB9Cn07CnZhciBTdXBwb3J0ZWRJbWFnZU1pbWVUeXBlcyA9IFsiaW1hZ2UvYXBuZyIsICJpbWFnZS9hdmlmIiwgImltYWdlL2JtcCIsICJpbWFnZS9naWYiLCAiaW1hZ2UvanBlZyIsICJpbWFnZS9wbmciLCAiaW1hZ2Uvc3ZnK3htbCIsICJpbWFnZS93ZWJwIiwgImltYWdlL3gtaWNvbiJdOwp2YXIgQ29sb3JTY2hlbWUgPSBjbGFzcyB7CiAgc3RhdGljIGdldCBpc0RhcmtNb2RlKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaXNEYXJrTW9kZSIsICEhd2luZG93Py5tYXRjaE1lZGlhPy4oIihwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykiKS5tYXRjaGVzKTsKICB9Cn07CnZhciBDU1NDb25zdGFudHMgPSBjbGFzcyB7CiAgc3RhdGljIGdldCBjb21tZW50Rm9yZWdyb3VuZENvbG9yKCkgewogICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgiY29tbWVudCIsICJzaWRlYmFyIik7CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gZWxlbWVudDsKICAgIHN0eWxlLndpZHRoID0gc3R5bGUuaGVpZ2h0ID0gIjAiOwogICAgc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIHN0eWxlLmNvbG9yID0gInZhcigtLWNvbW1lbnQtZmctY29sb3IpIjsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kKGVsZW1lbnQpOwogICAgY29uc3QgewogICAgICBjb2xvcgogICAgfSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQpOwogICAgZWxlbWVudC5yZW1vdmUoKTsKICAgIHJldHVybiBzaGFkb3codGhpcywgImNvbW1lbnRGb3JlZ3JvdW5kQ29sb3IiLCBnZXRSR0IoY29sb3IpKTsKICB9Cn07CmZ1bmN0aW9uIGFwcGx5T3BhY2l0eShyLCBnLCBiLCBvcGFjaXR5KSB7CiAgb3BhY2l0eSA9IE1hdGgubWluKE1hdGgubWF4KG9wYWNpdHkgPz8gMSwgMCksIDEpOwogIGNvbnN0IHdoaXRlID0gMjU1ICogKDEgLSBvcGFjaXR5KTsKICByID0gTWF0aC5yb3VuZChyICogb3BhY2l0eSArIHdoaXRlKTsKICBnID0gTWF0aC5yb3VuZChnICogb3BhY2l0eSArIHdoaXRlKTsKICBiID0gTWF0aC5yb3VuZChiICogb3BhY2l0eSArIHdoaXRlKTsKICByZXR1cm4gW3IsIGcsIGJdOwp9CmZ1bmN0aW9uIFJHQlRvSFNMKHJnYiwgb3V0cHV0KSB7CiAgY29uc3QgciA9IHJnYlswXSAvIDI1NTsKICBjb25zdCBnID0gcmdiWzFdIC8gMjU1OwogIGNvbnN0IGIgPSByZ2JbMl0gLyAyNTU7CiAgY29uc3QgbWF4ID0gTWF0aC5tYXgociwgZywgYik7CiAgY29uc3QgbWluID0gTWF0aC5taW4ociwgZywgYik7CiAgY29uc3QgbCA9IChtYXggKyBtaW4pIC8gMjsKICBpZiAobWF4ID09PSBtaW4pIHsKICAgIG91dHB1dFswXSA9IG91dHB1dFsxXSA9IDA7CiAgfSBlbHNlIHsKICAgIGNvbnN0IGQgPSBtYXggLSBtaW47CiAgICBvdXRwdXRbMV0gPSBsIDwgMC41ID8gZCAvIChtYXggKyBtaW4pIDogZCAvICgyIC0gbWF4IC0gbWluKTsKICAgIHN3aXRjaCAobWF4KSB7CiAgICAgIGNhc2UgcjoKICAgICAgICBvdXRwdXRbMF0gPSAoKGcgLSBiKSAvIGQgKyAoZyA8IGIgPyA2IDogMCkpICogNjA7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgZzoKICAgICAgICBvdXRwdXRbMF0gPSAoKGIgLSByKSAvIGQgKyAyKSAqIDYwOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIGI6CiAgICAgICAgb3V0cHV0WzBdID0gKChyIC0gZykgLyBkICsgNCkgKiA2MDsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgb3V0cHV0WzJdID0gbDsKfQpmdW5jdGlvbiBIU0xUb1JHQihoc2wsIG91dHB1dCkgewogIGNvbnN0IGggPSBoc2xbMF07CiAgY29uc3QgcyA9IGhzbFsxXTsKICBjb25zdCBsID0gaHNsWzJdOwogIGNvbnN0IGMgPSAoMSAtIE1hdGguYWJzKDIgKiBsIC0gMSkpICogczsKICBjb25zdCB4ID0gYyAqICgxIC0gTWF0aC5hYnMoaCAvIDYwICUgMiAtIDEpKTsKICBjb25zdCBtID0gbCAtIGMgLyAyOwogIHN3aXRjaCAoTWF0aC5mbG9vcihoIC8gNjApKSB7CiAgICBjYXNlIDA6CiAgICAgIG91dHB1dFswXSA9IGMgKyBtOwogICAgICBvdXRwdXRbMV0gPSB4ICsgbTsKICAgICAgb3V0cHV0WzJdID0gbTsKICAgICAgYnJlYWs7CiAgICBjYXNlIDE6CiAgICAgIG91dHB1dFswXSA9IHggKyBtOwogICAgICBvdXRwdXRbMV0gPSBjICsgbTsKICAgICAgb3V0cHV0WzJdID0gbTsKICAgICAgYnJlYWs7CiAgICBjYXNlIDI6CiAgICAgIG91dHB1dFswXSA9IG07CiAgICAgIG91dHB1dFsxXSA9IGMgKyBtOwogICAgICBvdXRwdXRbMl0gPSB4ICsgbTsKICAgICAgYnJlYWs7CiAgICBjYXNlIDM6CiAgICAgIG91dHB1dFswXSA9IG07CiAgICAgIG91dHB1dFsxXSA9IHggKyBtOwogICAgICBvdXRwdXRbMl0gPSBjICsgbTsKICAgICAgYnJlYWs7CiAgICBjYXNlIDQ6CiAgICAgIG91dHB1dFswXSA9IHggKyBtOwogICAgICBvdXRwdXRbMV0gPSBtOwogICAgICBvdXRwdXRbMl0gPSBjICsgbTsKICAgICAgYnJlYWs7CiAgICBjYXNlIDU6CiAgICBjYXNlIDY6CiAgICAgIG91dHB1dFswXSA9IGMgKyBtOwogICAgICBvdXRwdXRbMV0gPSBtOwogICAgICBvdXRwdXRbMl0gPSB4ICsgbTsKICAgICAgYnJlYWs7CiAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVMdW1pbmFuY2UoeCkgewogIHJldHVybiB4IDw9IDAuMDM5MjggPyB4IC8gMTIuOTIgOiAoKHggKyAwLjA1NSkgLyAxLjA1NSkgKiogMi40Owp9CmZ1bmN0aW9uIGNvbnRyYXN0UmF0aW8oaHNsMSwgaHNsMiwgb3V0cHV0KSB7CiAgSFNMVG9SR0IoaHNsMSwgb3V0cHV0KTsKICBvdXRwdXQubWFwKGNvbXB1dGVMdW1pbmFuY2UpOwogIGNvbnN0IGx1bTEgPSAwLjIxMjYgKiBvdXRwdXRbMF0gKyAwLjcxNTIgKiBvdXRwdXRbMV0gKyAwLjA3MjIgKiBvdXRwdXRbMl07CiAgSFNMVG9SR0IoaHNsMiwgb3V0cHV0KTsKICBvdXRwdXQubWFwKGNvbXB1dGVMdW1pbmFuY2UpOwogIGNvbnN0IGx1bTIgPSAwLjIxMjYgKiBvdXRwdXRbMF0gKyAwLjcxNTIgKiBvdXRwdXRbMV0gKyAwLjA3MjIgKiBvdXRwdXRbMl07CiAgcmV0dXJuIGx1bTEgPiBsdW0yID8gKGx1bTEgKyAwLjA1KSAvIChsdW0yICsgMC4wNSkgOiAobHVtMiArIDAuMDUpIC8gKGx1bTEgKyAwLjA1KTsKfQp2YXIgY29udHJhc3RDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CmZ1bmN0aW9uIGZpbmRDb250cmFzdENvbG9yKGJhc2VDb2xvciwgZml4ZWRDb2xvcikgewogIGNvbnN0IGtleSA9IGJhc2VDb2xvclswXSArIGJhc2VDb2xvclsxXSAqIDI1NiArIGJhc2VDb2xvclsyXSAqIDY1NTM2ICsgZml4ZWRDb2xvclswXSAqIDE2Nzc3MjE2ICsgZml4ZWRDb2xvclsxXSAqIDQyOTQ5NjcyOTYgKyBmaXhlZENvbG9yWzJdICogMTA5OTUxMTYyNzc3NjsKICBsZXQgY2FjaGVkVmFsdWUgPSBjb250cmFzdENhY2hlLmdldChrZXkpOwogIGlmIChjYWNoZWRWYWx1ZSkgewogICAgcmV0dXJuIGNhY2hlZFZhbHVlOwogIH0KICBjb25zdCBhcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoOSk7CiAgY29uc3Qgb3V0cHV0ID0gYXJyYXkuc3ViYXJyYXkoMCwgMyk7CiAgY29uc3QgYmFzZUhTTCA9IGFycmF5LnN1YmFycmF5KDMsIDYpOwogIFJHQlRvSFNMKGJhc2VDb2xvciwgYmFzZUhTTCk7CiAgY29uc3QgZml4ZWRIU0wgPSBhcnJheS5zdWJhcnJheSg2LCA5KTsKICBSR0JUb0hTTChmaXhlZENvbG9yLCBmaXhlZEhTTCk7CiAgY29uc3QgaXNGaXhlZENvbG9yRGFyayA9IGZpeGVkSFNMWzJdIDwgMC41OwogIGNvbnN0IG1pbkNvbnRyYXN0ID0gaXNGaXhlZENvbG9yRGFyayA/IDEyIDogNC41OwogIGJhc2VIU0xbMl0gPSBpc0ZpeGVkQ29sb3JEYXJrID8gTWF0aC5zcXJ0KGJhc2VIU0xbMl0pIDogMSAtIE1hdGguc3FydCgxIC0gYmFzZUhTTFsyXSk7CiAgaWYgKGNvbnRyYXN0UmF0aW8oYmFzZUhTTCwgZml4ZWRIU0wsIG91dHB1dCkgPCBtaW5Db250cmFzdCkgewogICAgbGV0IHN0YXJ0LCBlbmQ7CiAgICBpZiAoaXNGaXhlZENvbG9yRGFyaykgewogICAgICBzdGFydCA9IGJhc2VIU0xbMl07CiAgICAgIGVuZCA9IDE7CiAgICB9IGVsc2UgewogICAgICBzdGFydCA9IDA7CiAgICAgIGVuZCA9IGJhc2VIU0xbMl07CiAgICB9CiAgICBjb25zdCBQUkVDSVNJT04gPSA1ZS0zOwogICAgd2hpbGUgKGVuZCAtIHN0YXJ0ID4gUFJFQ0lTSU9OKSB7CiAgICAgIGNvbnN0IG1pZCA9IGJhc2VIU0xbMl0gPSAoc3RhcnQgKyBlbmQpIC8gMjsKICAgICAgaWYgKGlzRml4ZWRDb2xvckRhcmsgPT09IGNvbnRyYXN0UmF0aW8oYmFzZUhTTCwgZml4ZWRIU0wsIG91dHB1dCkgPCBtaW5Db250cmFzdCkgewogICAgICAgIHN0YXJ0ID0gbWlkOwogICAgICB9IGVsc2UgewogICAgICAgIGVuZCA9IG1pZDsKICAgICAgfQogICAgfQogICAgYmFzZUhTTFsyXSA9IGlzRml4ZWRDb2xvckRhcmsgPyBlbmQgOiBzdGFydDsKICB9CiAgSFNMVG9SR0IoYmFzZUhTTCwgb3V0cHV0KTsKICBjYWNoZWRWYWx1ZSA9IFV0aWwubWFrZUhleENvbG9yKE1hdGgucm91bmQob3V0cHV0WzBdICogMjU1KSwgTWF0aC5yb3VuZChvdXRwdXRbMV0gKiAyNTUpLCBNYXRoLnJvdW5kKG91dHB1dFsyXSAqIDI1NSkpOwogIGNvbnRyYXN0Q2FjaGUuc2V0KGtleSwgY2FjaGVkVmFsdWUpOwogIHJldHVybiBjYWNoZWRWYWx1ZTsKfQpmdW5jdGlvbiByZW5kZXJSaWNoVGV4dCh7CiAgaHRtbCwKICBkaXIsCiAgY2xhc3NOYW1lCn0sIGNvbnRhaW5lcjIpIHsKICBjb25zdCBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICBpZiAodHlwZW9mIGh0bWwgPT09ICJzdHJpbmciKSB7CiAgICBjb25zdCBwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwogICAgcC5kaXIgPSBkaXIgfHwgImF1dG8iOwogICAgY29uc3QgbGluZXMgPSBodG1sLnNwbGl0KC8oPzpcclxuP3xcbikvKTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGxpbmVzLmxlbmd0aDsgaSA8IGlpOyArK2kpIHsKICAgICAgY29uc3QgbGluZSA9IGxpbmVzW2ldOwogICAgICBwLmFwcGVuZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShsaW5lKSk7CiAgICAgIGlmIChpIDwgaWkgLSAxKSB7CiAgICAgICAgcC5hcHBlbmQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnIiKSk7CiAgICAgIH0KICAgIH0KICAgIGZyYWdtZW50LmFwcGVuZChwKTsKICB9IGVsc2UgewogICAgWGZhTGF5ZXIucmVuZGVyKHsKICAgICAgeGZhSHRtbDogaHRtbCwKICAgICAgZGl2OiBmcmFnbWVudCwKICAgICAgaW50ZW50OiAicmljaFRleHQiCiAgICB9KTsKICB9CiAgZnJhZ21lbnQuZmlyc3RFbGVtZW50Q2hpbGQuY2xhc3NMaXN0LmFkZCgicmljaFRleHQiLCBjbGFzc05hbWUpOwogIGNvbnRhaW5lcjIuYXBwZW5kKGZyYWdtZW50KTsKfQpmdW5jdGlvbiBtYWtlUGF0aEZyb21EcmF3T1BTKGRhdGEpIHsKICBjb25zdCBwYXRoID0gbmV3IFBhdGgyRCgpOwogIGlmICghZGF0YSkgewogICAgcmV0dXJuIHBhdGg7CiAgfQogIGZvciAobGV0IGkgPSAwLCBpaSA9IGRhdGEubGVuZ3RoOyBpIDwgaWk7ICkgewogICAgc3dpdGNoIChkYXRhW2krK10pIHsKICAgICAgY2FzZSBEcmF3T1BTLm1vdmVUbzoKICAgICAgICBwYXRoLm1vdmVUbyhkYXRhW2krK10sIGRhdGFbaSsrXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgRHJhd09QUy5saW5lVG86CiAgICAgICAgcGF0aC5saW5lVG8oZGF0YVtpKytdLCBkYXRhW2krK10pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIERyYXdPUFMuY3VydmVUbzoKICAgICAgICBwYXRoLmJlemllckN1cnZlVG8oZGF0YVtpKytdLCBkYXRhW2krK10sIGRhdGFbaSsrXSwgZGF0YVtpKytdLCBkYXRhW2krK10sIGRhdGFbaSsrXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgRHJhd09QUy5xdWFkcmF0aWNDdXJ2ZVRvOgogICAgICAgIHBhdGgucXVhZHJhdGljQ3VydmVUbyhkYXRhW2krK10sIGRhdGFbaSsrXSwgZGF0YVtpKytdLCBkYXRhW2krK10pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIERyYXdPUFMuY2xvc2VQYXRoOgogICAgICAgIHBhdGguY2xvc2VQYXRoKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgd2FybihgVW5yZWNvZ25pemVkIGRyYXdpbmcgcGF0aCBvcGVyYXRvcjogJHtkYXRhW2kgLSAxXX1gKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIHBhdGg7Cn0KdmFyIEVkaXRvclRvb2xiYXIgPSBjbGFzcyBfRWRpdG9yVG9vbGJhciB7CiAgI3Rvb2xiYXIgPSBudWxsOwogICNjb2xvclBpY2tlciA9IG51bGw7CiAgI2VkaXRvcjsKICAjYnV0dG9ucyA9IG51bGw7CiAgI2FsdFRleHQgPSBudWxsOwogICNjb21tZW50ID0gbnVsbDsKICAjY29tbWVudEJ1dHRvbkRpdmlkZXIgPSBudWxsOwogICNzaWduYXR1cmVEZXNjcmlwdGlvbkJ1dHRvbiA9IG51bGw7CiAgc3RhdGljICNsMTBuUmVtb3ZlID0gbnVsbDsKICBjb25zdHJ1Y3RvcihlZGl0b3IpIHsKICAgIHRoaXMuI2VkaXRvciA9IGVkaXRvcjsKICAgIF9FZGl0b3JUb29sYmFyLiNsMTBuUmVtb3ZlIHx8PSBPYmplY3QuZnJlZXplKHsKICAgICAgZnJlZXRleHQ6ICJwZGZqcy1lZGl0b3ItcmVtb3ZlLWZyZWV0ZXh0LWJ1dHRvbiIsCiAgICAgIGhpZ2hsaWdodDogInBkZmpzLWVkaXRvci1yZW1vdmUtaGlnaGxpZ2h0LWJ1dHRvbiIsCiAgICAgIGluazogInBkZmpzLWVkaXRvci1yZW1vdmUtaW5rLWJ1dHRvbiIsCiAgICAgIHN0YW1wOiAicGRmanMtZWRpdG9yLXJlbW92ZS1zdGFtcC1idXR0b24iLAogICAgICBzaWduYXR1cmU6ICJwZGZqcy1lZGl0b3ItcmVtb3ZlLXNpZ25hdHVyZS1idXR0b24iCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3QgZWRpdFRvb2xiYXIgPSB0aGlzLiN0b29sYmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBlZGl0VG9vbGJhci5jbGFzc0xpc3QuYWRkKCJlZGl0VG9vbGJhciIsICJoaWRkZW4iKTsKICAgIGVkaXRUb29sYmFyLnNldEF0dHJpYnV0ZSgicm9sZSIsICJ0b29sYmFyIik7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5fc2lnbmFsOwogICAgaWYgKHNpZ25hbCBpbnN0YW5jZW9mIEFib3J0U2lnbmFsICYmICFzaWduYWwuYWJvcnRlZCkgewogICAgICBlZGl0VG9vbGJhci5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIG5vQ29udGV4dE1lbnUsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGVkaXRUb29sYmFyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgX0VkaXRvclRvb2xiYXIuI3BvaW50ZXJEb3duLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgYnV0dG9ucyA9IHRoaXMuI2J1dHRvbnMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGJ1dHRvbnMuY2xhc3NOYW1lID0gImJ1dHRvbnMiOwogICAgZWRpdFRvb2xiYXIuYXBwZW5kKGJ1dHRvbnMpOwogICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLiNlZGl0b3IudG9vbGJhclBvc2l0aW9uOwogICAgaWYgKHBvc2l0aW9uKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBzdHlsZQogICAgICB9ID0gZWRpdFRvb2xiYXI7CiAgICAgIGNvbnN0IHggPSB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5kaXJlY3Rpb24gPT09ICJsdHIiID8gMSAtIHBvc2l0aW9uWzBdIDogcG9zaXRpb25bMF07CiAgICAgIHN0eWxlLmluc2V0SW5saW5lRW5kID0gYCR7MTAwICogeH0lYDsKICAgICAgc3R5bGUudG9wID0gYGNhbGMoJHsxMDAgKiBwb3NpdGlvblsxXX0lICsgdmFyKC0tZWRpdG9yLXRvb2xiYXItdmVydC1vZmZzZXQpKWA7CiAgICB9CiAgICByZXR1cm4gZWRpdFRvb2xiYXI7CiAgfQogIGdldCBkaXYoKSB7CiAgICByZXR1cm4gdGhpcy4jdG9vbGJhcjsKICB9CiAgc3RhdGljICNwb2ludGVyRG93bihlKSB7CiAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogIH0KICAjZm9jdXNJbihlKSB7CiAgICB0aGlzLiNlZGl0b3IuX2ZvY3VzRXZlbnRzQWxsb3dlZCA9IGZhbHNlOwogICAgc3RvcEV2ZW50KGUpOwogIH0KICAjZm9jdXNPdXQoZSkgewogICAgdGhpcy4jZWRpdG9yLl9mb2N1c0V2ZW50c0FsbG93ZWQgPSB0cnVlOwogICAgc3RvcEV2ZW50KGUpOwogIH0KICAjYWRkTGlzdGVuZXJzVG9FbGVtZW50KGVsZW1lbnQpIHsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI2VkaXRvci5fdWlNYW5hZ2VyLl9zaWduYWw7CiAgICBpZiAoIShzaWduYWwgaW5zdGFuY2VvZiBBYm9ydFNpZ25hbCkgfHwgc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJmb2N1c2luIiwgdGhpcy4jZm9jdXNJbi5iaW5kKHRoaXMpLCB7CiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImZvY3Vzb3V0IiwgdGhpcy4jZm9jdXNPdXQuYmluZCh0aGlzKSwgewogICAgICBjYXB0dXJlOiB0cnVlLAogICAgICBzaWduYWwKICAgIH0pOwogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIG5vQ29udGV4dE1lbnUsIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHJldHVybiB0cnVlOwogIH0KICBoaWRlKCkgewogICAgdGhpcy4jdG9vbGJhci5jbGFzc0xpc3QuYWRkKCJoaWRkZW4iKTsKICAgIHRoaXMuI2NvbG9yUGlja2VyPy5oaWRlRHJvcGRvd24oKTsKICB9CiAgc2hvdygpIHsKICAgIHRoaXMuI3Rvb2xiYXIuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CiAgICB0aGlzLiNhbHRUZXh0Py5zaG93bigpOwogICAgdGhpcy4jY29tbWVudD8uc2hvd24oKTsKICB9CiAgYWRkRGVsZXRlQnV0dG9uKCkgewogICAgY29uc3QgewogICAgICBlZGl0b3JUeXBlLAogICAgICBfdWlNYW5hZ2VyCiAgICB9ID0gdGhpcy4jZWRpdG9yOwogICAgY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBidXR0b24uY2xhc3NMaXN0LmFkZCgiYmFzaWMiLCAiZGVsZXRlQnV0dG9uIik7CiAgICBidXR0b24udGFiSW5kZXggPSAwOwogICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0VkaXRvclRvb2xiYXIuI2wxMG5SZW1vdmVbZWRpdG9yVHlwZV0pOwogICAgaWYgKHRoaXMuI2FkZExpc3RlbmVyc1RvRWxlbWVudChidXR0b24pKSB7CiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChlKSA9PiB7CiAgICAgICAgX3VpTWFuYWdlci5kZWxldGUoKTsKICAgICAgfSwgewogICAgICAgIHNpZ25hbDogX3VpTWFuYWdlci5fc2lnbmFsCiAgICAgIH0pOwogICAgfQogICAgdGhpcy4jYnV0dG9ucy5hcHBlbmQoYnV0dG9uKTsKICB9CiAgZ2V0ICNkaXZpZGVyKCkgewogICAgY29uc3QgZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2aWRlci5jbGFzc05hbWUgPSAiZGl2aWRlciI7CiAgICByZXR1cm4gZGl2aWRlcjsKICB9CiAgYXN5bmMgYWRkQWx0VGV4dChhbHRUZXh0KSB7CiAgICBjb25zdCBidXR0b24gPSBhd2FpdCBhbHRUZXh0LnJlbmRlcigpOwogICAgdGhpcy4jYWRkTGlzdGVuZXJzVG9FbGVtZW50KGJ1dHRvbik7CiAgICB0aGlzLiNidXR0b25zLmFwcGVuZChidXR0b24sIHRoaXMuI2RpdmlkZXIpOwogICAgdGhpcy4jYWx0VGV4dCA9IGFsdFRleHQ7CiAgfQogIGFkZENvbW1lbnQoY29tbWVudCwgYmVmb3JlRWxlbWVudCA9IG51bGwpIHsKICAgIGlmICh0aGlzLiNjb21tZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGJ1dHRvbiA9IGNvbW1lbnQucmVuZGVyRm9yVG9vbGJhcigpOwogICAgaWYgKCFidXR0b24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jYWRkTGlzdGVuZXJzVG9FbGVtZW50KGJ1dHRvbik7CiAgICBjb25zdCBkaXZpZGVyID0gdGhpcy4jY29tbWVudEJ1dHRvbkRpdmlkZXIgPSB0aGlzLiNkaXZpZGVyOwogICAgaWYgKCFiZWZvcmVFbGVtZW50KSB7CiAgICAgIHRoaXMuI2J1dHRvbnMuYXBwZW5kKGJ1dHRvbiwgZGl2aWRlcik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNidXR0b25zLmluc2VydEJlZm9yZShidXR0b24sIGJlZm9yZUVsZW1lbnQpOwogICAgICB0aGlzLiNidXR0b25zLmluc2VydEJlZm9yZShkaXZpZGVyLCBiZWZvcmVFbGVtZW50KTsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnQgPSBjb21tZW50OwogICAgY29tbWVudC50b29sYmFyID0gdGhpczsKICB9CiAgYWRkQ29sb3JQaWNrZXIoY29sb3JQaWNrZXIpIHsKICAgIGlmICh0aGlzLiNjb2xvclBpY2tlcikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNjb2xvclBpY2tlciA9IGNvbG9yUGlja2VyOwogICAgY29uc3QgYnV0dG9uID0gY29sb3JQaWNrZXIucmVuZGVyQnV0dG9uKCk7CiAgICB0aGlzLiNhZGRMaXN0ZW5lcnNUb0VsZW1lbnQoYnV0dG9uKTsKICAgIHRoaXMuI2J1dHRvbnMuYXBwZW5kKGJ1dHRvbiwgdGhpcy4jZGl2aWRlcik7CiAgfQogIGFzeW5jIGFkZEVkaXRTaWduYXR1cmVCdXR0b24oc2lnbmF0dXJlTWFuYWdlcikgewogICAgY29uc3QgYnV0dG9uID0gdGhpcy4jc2lnbmF0dXJlRGVzY3JpcHRpb25CdXR0b24gPSBhd2FpdCBzaWduYXR1cmVNYW5hZ2VyLnJlbmRlckVkaXRCdXR0b24odGhpcy4jZWRpdG9yKTsKICAgIHRoaXMuI2FkZExpc3RlbmVyc1RvRWxlbWVudChidXR0b24pOwogICAgdGhpcy4jYnV0dG9ucy5hcHBlbmQoYnV0dG9uLCB0aGlzLiNkaXZpZGVyKTsKICB9CiAgcmVtb3ZlQnV0dG9uKG5hbWUpIHsKICAgIHN3aXRjaCAobmFtZSkgewogICAgICBjYXNlICJjb21tZW50IjoKICAgICAgICB0aGlzLiNjb21tZW50Py5yZW1vdmVUb29sYmFyQ29tbWVudEJ1dHRvbigpOwogICAgICAgIHRoaXMuI2NvbW1lbnQgPSBudWxsOwogICAgICAgIHRoaXMuI2NvbW1lbnRCdXR0b25EaXZpZGVyPy5yZW1vdmUoKTsKICAgICAgICB0aGlzLiNjb21tZW50QnV0dG9uRGl2aWRlciA9IG51bGw7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIGFzeW5jIGFkZEJ1dHRvbihuYW1lLCB0b29sKSB7CiAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgY2FzZSAiY29sb3JQaWNrZXIiOgogICAgICAgIGlmICh0b29sKSB7CiAgICAgICAgICB0aGlzLmFkZENvbG9yUGlja2VyKHRvb2wpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiYWx0VGV4dCI6CiAgICAgICAgaWYgKHRvb2wpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuYWRkQWx0VGV4dCh0b29sKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImVkaXRTaWduYXR1cmUiOgogICAgICAgIGlmICh0b29sKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLmFkZEVkaXRTaWduYXR1cmVCdXR0b24odG9vbCk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJkZWxldGUiOgogICAgICAgIHRoaXMuYWRkRGVsZXRlQnV0dG9uKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImNvbW1lbnQiOgogICAgICAgIGlmICh0b29sKSB7CiAgICAgICAgICB0aGlzLmFkZENvbW1lbnQodG9vbCk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgfQogIH0KICBhc3luYyBhZGRCdXR0b25CZWZvcmUobmFtZSwgdG9vbCwgYmVmb3JlU2VsZWN0b3IpIHsKICAgIGlmICghdG9vbCAmJiBuYW1lID09PSAiY29tbWVudCIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgYmVmb3JlRWxlbWVudCA9IHRoaXMuI2J1dHRvbnMucXVlcnlTZWxlY3RvcihiZWZvcmVTZWxlY3Rvcik7CiAgICBpZiAoIWJlZm9yZUVsZW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKG5hbWUgPT09ICJjb21tZW50IikgewogICAgICB0aGlzLmFkZENvbW1lbnQodG9vbCwgYmVmb3JlRWxlbWVudCk7CiAgICB9CiAgfQogIHVwZGF0ZUVkaXRTaWduYXR1cmVCdXR0b24oZGVzY3JpcHRpb24pIHsKICAgIGlmICh0aGlzLiNzaWduYXR1cmVEZXNjcmlwdGlvbkJ1dHRvbikgewogICAgICB0aGlzLiNzaWduYXR1cmVEZXNjcmlwdGlvbkJ1dHRvbi50aXRsZSA9IGRlc2NyaXB0aW9uOwogICAgfQogIH0KICByZW1vdmUoKSB7CiAgICB0aGlzLiN0b29sYmFyLnJlbW92ZSgpOwogICAgdGhpcy4jY29sb3JQaWNrZXI/LmRlc3Ryb3koKTsKICAgIHRoaXMuI2NvbG9yUGlja2VyID0gbnVsbDsKICB9Cn07CnZhciBGbG9hdGluZ1Rvb2xiYXIgPSBjbGFzcyB7CiAgI2J1dHRvbnMgPSBudWxsOwogICN0b29sYmFyID0gbnVsbDsKICAjdWlNYW5hZ2VyOwogIGNvbnN0cnVjdG9yKHVpTWFuYWdlcikgewogICAgdGhpcy4jdWlNYW5hZ2VyID0gdWlNYW5hZ2VyOwogIH0KICAjcmVuZGVyKCkgewogICAgY29uc3QgZWRpdFRvb2xiYXIgPSB0aGlzLiN0b29sYmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBlZGl0VG9vbGJhci5jbGFzc05hbWUgPSAiZWRpdFRvb2xiYXIiOwogICAgZWRpdFRvb2xiYXIuc2V0QXR0cmlidXRlKCJyb2xlIiwgInRvb2xiYXIiKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI3VpTWFuYWdlci5fc2lnbmFsOwogICAgaWYgKHNpZ25hbCBpbnN0YW5jZW9mIEFib3J0U2lnbmFsICYmICFzaWduYWwuYWJvcnRlZCkgewogICAgICBlZGl0VG9vbGJhci5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIG5vQ29udGV4dE1lbnUsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBidXR0b25zID0gdGhpcy4jYnV0dG9ucyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgYnV0dG9ucy5jbGFzc05hbWUgPSAiYnV0dG9ucyI7CiAgICBlZGl0VG9vbGJhci5hcHBlbmQoYnV0dG9ucyk7CiAgICBpZiAodGhpcy4jdWlNYW5hZ2VyLmhhc0NvbW1lbnRNYW5hZ2VyKCkpIHsKICAgICAgdGhpcy4jbWFrZUJ1dHRvbigiY29tbWVudEJ1dHRvbiIsIGBwZGZqcy1jb21tZW50LWZsb2F0aW5nLWJ1dHRvbmAsICJwZGZqcy1jb21tZW50LWZsb2F0aW5nLWJ1dHRvbi1sYWJlbCIsICgpID0+IHsKICAgICAgICB0aGlzLiN1aU1hbmFnZXIuY29tbWVudFNlbGVjdGlvbigiZmxvYXRpbmdfYnV0dG9uIik7CiAgICAgIH0pOwogICAgfQogICAgdGhpcy4jbWFrZUJ1dHRvbigiaGlnaGxpZ2h0QnV0dG9uIiwgYHBkZmpzLWhpZ2hsaWdodC1mbG9hdGluZy1idXR0b24xYCwgInBkZmpzLWhpZ2hsaWdodC1mbG9hdGluZy1idXR0b24tbGFiZWwiLCAoKSA9PiB7CiAgICAgIHRoaXMuI3VpTWFuYWdlci5oaWdobGlnaHRTZWxlY3Rpb24oImZsb2F0aW5nX2J1dHRvbiIpOwogICAgfSk7CiAgICByZXR1cm4gZWRpdFRvb2xiYXI7CiAgfQogICNnZXRMYXN0UG9pbnQoYm94ZXMsIGlzTFRSKSB7CiAgICBsZXQgbGFzdFkgPSAwOwogICAgbGV0IGxhc3RYID0gMDsKICAgIGZvciAoY29uc3QgYm94IG9mIGJveGVzKSB7CiAgICAgIGNvbnN0IHkgPSBib3gueSArIGJveC5oZWlnaHQ7CiAgICAgIGlmICh5IDwgbGFzdFkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCB4ID0gYm94LnggKyAoaXNMVFIgPyBib3gud2lkdGggOiAwKTsKICAgICAgaWYgKHkgPiBsYXN0WSkgewogICAgICAgIGxhc3RYID0geDsKICAgICAgICBsYXN0WSA9IHk7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGlzTFRSKSB7CiAgICAgICAgaWYgKHggPiBsYXN0WCkgewogICAgICAgICAgbGFzdFggPSB4OwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh4IDwgbGFzdFgpIHsKICAgICAgICBsYXN0WCA9IHg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBbaXNMVFIgPyAxIC0gbGFzdFggOiBsYXN0WCwgbGFzdFldOwogIH0KICBzaG93KHBhcmVudCwgYm94ZXMsIGlzTFRSKSB7CiAgICBjb25zdCBbeCwgeV0gPSB0aGlzLiNnZXRMYXN0UG9pbnQoYm94ZXMsIGlzTFRSKTsKICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSB0aGlzLiN0b29sYmFyIHx8PSB0aGlzLiNyZW5kZXIoKTsKICAgIHBhcmVudC5hcHBlbmQodGhpcy4jdG9vbGJhcik7CiAgICBzdHlsZS5pbnNldElubGluZUVuZCA9IGAkezEwMCAqIHh9JWA7CiAgICBzdHlsZS50b3AgPSBgY2FsYygkezEwMCAqIHl9JSArIHZhcigtLWVkaXRvci10b29sYmFyLXZlcnQtb2Zmc2V0KSlgOwogIH0KICBoaWRlKCkgewogICAgdGhpcy4jdG9vbGJhci5yZW1vdmUoKTsKICB9CiAgI21ha2VCdXR0b24oYnV0dG9uQ2xhc3MsIGwxMG5JZCwgbGFiZWxMMTBuSWQsIGNsaWNrSGFuZGxlcikgewogICAgY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBidXR0b24uY2xhc3NMaXN0LmFkZCgiYmFzaWMiLCBidXR0b25DbGFzcyk7CiAgICBidXR0b24udGFiSW5kZXggPSAwOwogICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgbDEwbklkKTsKICAgIGNvbnN0IHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICBidXR0b24uYXBwZW5kKHNwYW4pOwogICAgc3Bhbi5jbGFzc05hbWUgPSAidmlzdWFsbHlIaWRkZW4iOwogICAgc3Bhbi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIGxhYmVsTDEwbklkKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI3VpTWFuYWdlci5fc2lnbmFsOwogICAgaWYgKHNpZ25hbCBpbnN0YW5jZW9mIEFib3J0U2lnbmFsICYmICFzaWduYWwuYWJvcnRlZCkgewogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBjbGlja0hhbmRsZXIsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLiNidXR0b25zLmFwcGVuZChidXR0b24pOwogIH0KfTsKZnVuY3Rpb24gYmluZEV2ZW50cyhvYmosIGVsZW1lbnQsIG5hbWVzKSB7CiAgZm9yIChjb25zdCBuYW1lIG9mIG5hbWVzKSB7CiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgb2JqW25hbWVdLmJpbmQob2JqKSk7CiAgfQp9CnZhciBDdXJyZW50UG9pbnRlcnMgPSBjbGFzcyBfQ3VycmVudFBvaW50ZXJzIHsKICBzdGF0aWMgI3BvaW50ZXJJZCA9IE5hTjsKICBzdGF0aWMgI3BvaW50ZXJJZHMgPSBudWxsOwogIHN0YXRpYyAjbW92ZVRpbWVzdGFtcCA9IE5hTjsKICBzdGF0aWMgI3BvaW50ZXJUeXBlID0gbnVsbDsKICBzdGF0aWMgaW5pdGlhbGl6ZUFuZEFkZFBvaW50ZXJJZChwb2ludGVySWQpIHsKICAgIChfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVySWRzIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKS5hZGQocG9pbnRlcklkKTsKICB9CiAgc3RhdGljIHNldFBvaW50ZXIocG9pbnRlclR5cGUsIHBvaW50ZXJJZCkgewogICAgX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlcklkIHx8PSBwb2ludGVySWQ7CiAgICBfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVyVHlwZSA/Pz0gcG9pbnRlclR5cGU7CiAgfQogIHN0YXRpYyBzZXRUaW1lU3RhbXAodGltZVN0YW1wKSB7CiAgICBfQ3VycmVudFBvaW50ZXJzLiNtb3ZlVGltZXN0YW1wID0gdGltZVN0YW1wOwogIH0KICBzdGF0aWMgaXNTYW1lUG9pbnRlcklkKHBvaW50ZXJJZCkgewogICAgcmV0dXJuIF9DdXJyZW50UG9pbnRlcnMuI3BvaW50ZXJJZCA9PT0gcG9pbnRlcklkOwogIH0KICBzdGF0aWMgaXNTYW1lUG9pbnRlcklkT3JSZW1vdmUocG9pbnRlcklkKSB7CiAgICBpZiAoX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlcklkID09PSBwb2ludGVySWQpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVySWRzPy5kZWxldGUocG9pbnRlcklkKTsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgc3RhdGljIGlzU2FtZVBvaW50ZXJUeXBlKHBvaW50ZXJUeXBlKSB7CiAgICByZXR1cm4gX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlclR5cGUgPT09IHBvaW50ZXJUeXBlOwogIH0KICBzdGF0aWMgaXNJbml0aWFsaXplZEFuZERpZmZlcmVudFBvaW50ZXJUeXBlKHBvaW50ZXJUeXBlKSB7CiAgICByZXR1cm4gX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlclR5cGUgIT09IG51bGwgJiYgIV9DdXJyZW50UG9pbnRlcnMuaXNTYW1lUG9pbnRlclR5cGUocG9pbnRlclR5cGUpOwogIH0KICBzdGF0aWMgaXNTYW1lVGltZVN0YW1wKHRpbWVTdGFtcCkgewogICAgcmV0dXJuIF9DdXJyZW50UG9pbnRlcnMuI21vdmVUaW1lc3RhbXAgPT09IHRpbWVTdGFtcDsKICB9CiAgc3RhdGljIGlzVXNpbmdNdWx0aXBsZVBvaW50ZXJzKCkgewogICAgcmV0dXJuIF9DdXJyZW50UG9pbnRlcnMuI3BvaW50ZXJJZHM/LnNpemUgPj0gMTsKICB9CiAgc3RhdGljIGNsZWFyUG9pbnRlclR5cGUoKSB7CiAgICBfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVyVHlwZSA9IG51bGw7CiAgfQogIHN0YXRpYyBjbGVhclBvaW50ZXJJZHMoKSB7CiAgICBfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVySWQgPSBOYU47CiAgICBfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVySWRzID0gbnVsbDsKICB9CiAgc3RhdGljIGNsZWFyVGltZVN0YW1wKCkgewogICAgX0N1cnJlbnRQb2ludGVycy4jbW92ZVRpbWVzdGFtcCA9IE5hTjsKICB9Cn07CnZhciBJZE1hbmFnZXIgPSBjbGFzcyB7CiAgI2lkID0gMDsKICBnZXQgaWQoKSB7CiAgICByZXR1cm4gYCR7QW5ub3RhdGlvbkVkaXRvclByZWZpeH0ke3RoaXMuI2lkKyt9YDsKICB9Cn07CnZhciBJbWFnZU1hbmFnZXIgPSBjbGFzcyBfSW1hZ2VNYW5hZ2VyIHsKICAjYmFzZUlkID0gZ2V0VXVpZCgpOwogICNpZCA9IDA7CiAgI2NhY2hlID0gbnVsbDsKICBzdGF0aWMgZ2V0IF9pc1NWR0ZpdHRpbmdDYW52YXMoKSB7CiAgICBjb25zdCBzdmcgPSBgZGF0YTppbWFnZS9zdmcreG1sO2NoYXJzZXQ9VVRGLTgsPHN2ZyB2aWV3Qm94PSIwIDAgMSAxIiB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIHN0eWxlPSJmaWxsOnJlZDsiLz48L3N2Zz5gOwogICAgY29uc3QgY2FudmFzID0gbmV3IE9mZnNjcmVlbkNhbnZhcygxLCAzKTsKICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsKICAgICAgd2lsbFJlYWRGcmVxdWVudGx5OiB0cnVlCiAgICB9KTsKICAgIGNvbnN0IGltYWdlID0gbmV3IEltYWdlKCk7CiAgICBpbWFnZS5zcmMgPSBzdmc7CiAgICBjb25zdCBwcm9taXNlID0gaW1hZ2UuZGVjb2RlKCkudGhlbigoKSA9PiB7CiAgICAgIGN0eC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDAsIDEsIDEsIDAsIDAsIDEsIDMpOwogICAgICByZXR1cm4gbmV3IFVpbnQzMkFycmF5KGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgMSwgMSkuZGF0YS5idWZmZXIpWzBdID09PSAwOwogICAgfSk7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfaXNTVkdGaXR0aW5nQ2FudmFzIiwgcHJvbWlzZSk7CiAgfQogIGFzeW5jICNnZXQoa2V5LCByYXdEYXRhKSB7CiAgICB0aGlzLiNjYWNoZSB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGxldCBkYXRhID0gdGhpcy4jY2FjaGUuZ2V0KGtleSk7CiAgICBpZiAoZGF0YSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmIChkYXRhPy5iaXRtYXApIHsKICAgICAgZGF0YS5yZWZDb3VudGVyICs9IDE7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQogICAgdHJ5IHsKICAgICAgZGF0YSB8fD0gewogICAgICAgIGJpdG1hcDogbnVsbCwKICAgICAgICBpZDogYGltYWdlXyR7dGhpcy4jYmFzZUlkfV8ke3RoaXMuI2lkKyt9YCwKICAgICAgICByZWZDb3VudGVyOiAwLAogICAgICAgIGlzU3ZnOiBmYWxzZQogICAgICB9OwogICAgICBsZXQgaW1hZ2U7CiAgICAgIGlmICh0eXBlb2YgcmF3RGF0YSA9PT0gInN0cmluZyIpIHsKICAgICAgICBkYXRhLnVybCA9IHJhd0RhdGE7CiAgICAgICAgaW1hZ2UgPSBhd2FpdCBmZXRjaERhdGEocmF3RGF0YSwgImJsb2IiKTsKICAgICAgfSBlbHNlIGlmIChyYXdEYXRhIGluc3RhbmNlb2YgRmlsZSkgewogICAgICAgIGltYWdlID0gZGF0YS5maWxlID0gcmF3RGF0YTsKICAgICAgfSBlbHNlIGlmIChyYXdEYXRhIGluc3RhbmNlb2YgQmxvYikgewogICAgICAgIGltYWdlID0gcmF3RGF0YTsKICAgICAgfQogICAgICBpZiAoaW1hZ2UudHlwZSA9PT0gImltYWdlL3N2Zyt4bWwiKSB7CiAgICAgICAgY29uc3QgbXVzdFJlbW92ZUFzcGVjdFJhdGlvUHJvbWlzZSA9IF9JbWFnZU1hbmFnZXIuX2lzU1ZHRml0dGluZ0NhbnZhczsKICAgICAgICBjb25zdCBmaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICBjb25zdCBpbWFnZUVsZW1lbnQgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBjb25zdCBpbWFnZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICBpbWFnZUVsZW1lbnQub25sb2FkID0gKCkgPT4gewogICAgICAgICAgICBkYXRhLmJpdG1hcCA9IGltYWdlRWxlbWVudDsKICAgICAgICAgICAgZGF0YS5pc1N2ZyA9IHRydWU7CiAgICAgICAgICAgIHJlc29sdmUoKTsKICAgICAgICAgIH07CiAgICAgICAgICBmaWxlUmVhZGVyLm9ubG9hZCA9IGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgdXJsID0gZGF0YS5zdmdVcmwgPSBmaWxlUmVhZGVyLnJlc3VsdDsKICAgICAgICAgICAgaW1hZ2VFbGVtZW50LnNyYyA9IGF3YWl0IG11c3RSZW1vdmVBc3BlY3RSYXRpb1Byb21pc2UgPyBgJHt1cmx9I3N2Z1ZpZXcocHJlc2VydmVBc3BlY3RSYXRpbyhub25lKSlgIDogdXJsOwogICAgICAgICAgfTsKICAgICAgICAgIGltYWdlRWxlbWVudC5vbmVycm9yID0gZmlsZVJlYWRlci5vbmVycm9yID0gcmVqZWN0OwogICAgICAgIH0pOwogICAgICAgIGZpbGVSZWFkZXIucmVhZEFzRGF0YVVSTChpbWFnZSk7CiAgICAgICAgYXdhaXQgaW1hZ2VQcm9taXNlOwogICAgICB9IGVsc2UgewogICAgICAgIGRhdGEuYml0bWFwID0gYXdhaXQgY3JlYXRlSW1hZ2VCaXRtYXAoaW1hZ2UpOwogICAgICB9CiAgICAgIGRhdGEucmVmQ291bnRlciA9IDE7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHdhcm4oZSk7CiAgICAgIGRhdGEgPSBudWxsOwogICAgfQogICAgdGhpcy4jY2FjaGUuc2V0KGtleSwgZGF0YSk7CiAgICBpZiAoZGF0YSkgewogICAgICB0aGlzLiNjYWNoZS5zZXQoZGF0YS5pZCwgZGF0YSk7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgYXN5bmMgZ2V0RnJvbUZpbGUoZmlsZSkgewogICAgY29uc3QgewogICAgICBsYXN0TW9kaWZpZWQsCiAgICAgIG5hbWUsCiAgICAgIHNpemUsCiAgICAgIHR5cGUKICAgIH0gPSBmaWxlOwogICAgcmV0dXJuIHRoaXMuI2dldChgJHtsYXN0TW9kaWZpZWR9XyR7bmFtZX1fJHtzaXplfV8ke3R5cGV9YCwgZmlsZSk7CiAgfQogIGFzeW5jIGdldEZyb21VcmwodXJsKSB7CiAgICByZXR1cm4gdGhpcy4jZ2V0KHVybCwgdXJsKTsKICB9CiAgYXN5bmMgZ2V0RnJvbUJsb2IoaWQsIGJsb2JQcm9taXNlKSB7CiAgICBjb25zdCBibG9iID0gYXdhaXQgYmxvYlByb21pc2U7CiAgICByZXR1cm4gdGhpcy4jZ2V0KGlkLCBibG9iKTsKICB9CiAgYXN5bmMgZ2V0RnJvbUlkKGlkKSB7CiAgICB0aGlzLiNjYWNoZSB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLiNjYWNoZS5nZXQoaWQpOwogICAgaWYgKCFkYXRhKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKGRhdGEuYml0bWFwKSB7CiAgICAgIGRhdGEucmVmQ291bnRlciArPSAxOwogICAgICByZXR1cm4gZGF0YTsKICAgIH0KICAgIGlmIChkYXRhLmZpbGUpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0RnJvbUZpbGUoZGF0YS5maWxlKTsKICAgIH0KICAgIGlmIChkYXRhLmJsb2JQcm9taXNlKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBibG9iUHJvbWlzZQogICAgICB9ID0gZGF0YTsKICAgICAgZGVsZXRlIGRhdGEuYmxvYlByb21pc2U7CiAgICAgIHJldHVybiB0aGlzLmdldEZyb21CbG9iKGRhdGEuaWQsIGJsb2JQcm9taXNlKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmdldEZyb21VcmwoZGF0YS51cmwpOwogIH0KICBnZXRGcm9tQ2FudmFzKGlkLCBjYW52YXMpIHsKICAgIHRoaXMuI2NhY2hlIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgbGV0IGRhdGEgPSB0aGlzLiNjYWNoZS5nZXQoaWQpOwogICAgaWYgKGRhdGE/LmJpdG1hcCkgewogICAgICBkYXRhLnJlZkNvdW50ZXIgKz0gMTsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CiAgICBjb25zdCBvZmZzY3JlZW4gPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICBjb25zdCBjdHggPSBvZmZzY3JlZW4uZ2V0Q29udGV4dCgiMmQiKTsKICAgIGN0eC5kcmF3SW1hZ2UoY2FudmFzLCAwLCAwKTsKICAgIGRhdGEgPSB7CiAgICAgIGJpdG1hcDogb2Zmc2NyZWVuLnRyYW5zZmVyVG9JbWFnZUJpdG1hcCgpLAogICAgICBpZDogYGltYWdlXyR7dGhpcy4jYmFzZUlkfV8ke3RoaXMuI2lkKyt9YCwKICAgICAgcmVmQ291bnRlcjogMSwKICAgICAgaXNTdmc6IGZhbHNlCiAgICB9OwogICAgdGhpcy4jY2FjaGUuc2V0KGlkLCBkYXRhKTsKICAgIHRoaXMuI2NhY2hlLnNldChkYXRhLmlkLCBkYXRhKTsKICAgIHJldHVybiBkYXRhOwogIH0KICBnZXRTdmdVcmwoaWQpIHsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLiNjYWNoZS5nZXQoaWQpOwogICAgaWYgKCFkYXRhPy5pc1N2ZykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiBkYXRhLnN2Z1VybDsKICB9CiAgZGVsZXRlSWQoaWQpIHsKICAgIHRoaXMuI2NhY2hlIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgZGF0YSA9IHRoaXMuI2NhY2hlLmdldChpZCk7CiAgICBpZiAoIWRhdGEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZGF0YS5yZWZDb3VudGVyIC09IDE7CiAgICBpZiAoZGF0YS5yZWZDb3VudGVyICE9PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgYml0bWFwCiAgICB9ID0gZGF0YTsKICAgIGlmICghZGF0YS51cmwgJiYgIWRhdGEuZmlsZSkgewogICAgICBjb25zdCBjYW52YXMgPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKGJpdG1hcC53aWR0aCwgYml0bWFwLmhlaWdodCk7CiAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCJiaXRtYXByZW5kZXJlciIpOwogICAgICBjdHgudHJhbnNmZXJGcm9tSW1hZ2VCaXRtYXAoYml0bWFwKTsKICAgICAgZGF0YS5ibG9iUHJvbWlzZSA9IGNhbnZhcy5jb252ZXJ0VG9CbG9iKCk7CiAgICB9CiAgICBiaXRtYXAuY2xvc2U/LigpOwogICAgZGF0YS5iaXRtYXAgPSBudWxsOwogIH0KICBpc1ZhbGlkSWQoaWQpIHsKICAgIHJldHVybiBpZC5zdGFydHNXaXRoKGBpbWFnZV8ke3RoaXMuI2Jhc2VJZH1fYCk7CiAgfQp9Owp2YXIgQ29tbWFuZE1hbmFnZXIgPSBjbGFzcyB7CiAgI2NvbW1hbmRzID0gW107CiAgI2xvY2tlZCA9IGZhbHNlOwogICNtYXhTaXplOwogICNwb3NpdGlvbiA9IC0xOwogIGNvbnN0cnVjdG9yKG1heFNpemUgPSAxMjgpIHsKICAgIHRoaXMuI21heFNpemUgPSBtYXhTaXplOwogIH0KICBhZGQoewogICAgY21kLAogICAgdW5kbywKICAgIHBvc3QsCiAgICBtdXN0RXhlYywKICAgIHR5cGUgPSBOYU4sCiAgICBvdmVyd3JpdGVJZlNhbWVUeXBlID0gZmFsc2UsCiAgICBrZWVwVW5kbyA9IGZhbHNlCiAgfSkgewogICAgaWYgKG11c3RFeGVjKSB7CiAgICAgIGNtZCgpOwogICAgfQogICAgaWYgKHRoaXMuI2xvY2tlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBzYXZlID0gewogICAgICBjbWQsCiAgICAgIHVuZG8sCiAgICAgIHBvc3QsCiAgICAgIHR5cGUKICAgIH07CiAgICBpZiAodGhpcy4jcG9zaXRpb24gPT09IC0xKSB7CiAgICAgIGlmICh0aGlzLiNjb21tYW5kcy5sZW5ndGggPiAwKSB7CiAgICAgICAgdGhpcy4jY29tbWFuZHMubGVuZ3RoID0gMDsKICAgICAgfQogICAgICB0aGlzLiNwb3NpdGlvbiA9IDA7CiAgICAgIHRoaXMuI2NvbW1hbmRzLnB1c2goc2F2ZSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChvdmVyd3JpdGVJZlNhbWVUeXBlICYmIHRoaXMuI2NvbW1hbmRzW3RoaXMuI3Bvc2l0aW9uXS50eXBlID09PSB0eXBlKSB7CiAgICAgIGlmIChrZWVwVW5kbykgewogICAgICAgIHNhdmUudW5kbyA9IHRoaXMuI2NvbW1hbmRzW3RoaXMuI3Bvc2l0aW9uXS51bmRvOwogICAgICB9CiAgICAgIHRoaXMuI2NvbW1hbmRzW3RoaXMuI3Bvc2l0aW9uXSA9IHNhdmU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IG5leHQgPSB0aGlzLiNwb3NpdGlvbiArIDE7CiAgICBpZiAobmV4dCA9PT0gdGhpcy4jbWF4U2l6ZSkgewogICAgICB0aGlzLiNjb21tYW5kcy5zcGxpY2UoMCwgMSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNwb3NpdGlvbiA9IG5leHQ7CiAgICAgIGlmIChuZXh0IDwgdGhpcy4jY29tbWFuZHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy4jY29tbWFuZHMuc3BsaWNlKG5leHQpOwogICAgICB9CiAgICB9CiAgICB0aGlzLiNjb21tYW5kcy5wdXNoKHNhdmUpOwogIH0KICB1bmRvKCkgewogICAgaWYgKHRoaXMuI3Bvc2l0aW9uID09PSAtMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNsb2NrZWQgPSB0cnVlOwogICAgY29uc3QgewogICAgICB1bmRvLAogICAgICBwb3N0CiAgICB9ID0gdGhpcy4jY29tbWFuZHNbdGhpcy4jcG9zaXRpb25dOwogICAgdW5kbygpOwogICAgcG9zdD8uKCk7CiAgICB0aGlzLiNsb2NrZWQgPSBmYWxzZTsKICAgIHRoaXMuI3Bvc2l0aW9uIC09IDE7CiAgfQogIHJlZG8oKSB7CiAgICBpZiAodGhpcy4jcG9zaXRpb24gPCB0aGlzLiNjb21tYW5kcy5sZW5ndGggLSAxKSB7CiAgICAgIHRoaXMuI3Bvc2l0aW9uICs9IDE7CiAgICAgIHRoaXMuI2xvY2tlZCA9IHRydWU7CiAgICAgIGNvbnN0IHsKICAgICAgICBjbWQsCiAgICAgICAgcG9zdAogICAgICB9ID0gdGhpcy4jY29tbWFuZHNbdGhpcy4jcG9zaXRpb25dOwogICAgICBjbWQoKTsKICAgICAgcG9zdD8uKCk7CiAgICAgIHRoaXMuI2xvY2tlZCA9IGZhbHNlOwogICAgfQogIH0KICBoYXNTb21ldGhpbmdUb1VuZG8oKSB7CiAgICByZXR1cm4gdGhpcy4jcG9zaXRpb24gIT09IC0xOwogIH0KICBoYXNTb21ldGhpbmdUb1JlZG8oKSB7CiAgICByZXR1cm4gdGhpcy4jcG9zaXRpb24gPCB0aGlzLiNjb21tYW5kcy5sZW5ndGggLSAxOwogIH0KICBjbGVhblR5cGUodHlwZSkgewogICAgaWYgKHRoaXMuI3Bvc2l0aW9uID09PSAtMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGxldCBpID0gdGhpcy4jcG9zaXRpb247IGkgPj0gMDsgaS0tKSB7CiAgICAgIGlmICh0aGlzLiNjb21tYW5kc1tpXS50eXBlICE9PSB0eXBlKSB7CiAgICAgICAgdGhpcy4jY29tbWFuZHMuc3BsaWNlKGkgKyAxLCB0aGlzLiNwb3NpdGlvbiAtIGkpOwogICAgICAgIHRoaXMuI3Bvc2l0aW9uID0gaTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2NvbW1hbmRzLmxlbmd0aCA9IDA7CiAgICB0aGlzLiNwb3NpdGlvbiA9IC0xOwogIH0KICBkZXN0cm95KCkgewogICAgdGhpcy4jY29tbWFuZHMgPSBudWxsOwogIH0KfTsKdmFyIEtleWJvYXJkTWFuYWdlciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihjYWxsYmFja3MpIHsKICAgIHRoaXMuYnVmZmVyID0gW107CiAgICB0aGlzLmNhbGxiYWNrcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLmFsbEtleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3QgewogICAgICBpc01hYwogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICBmb3IgKGNvbnN0IFtrZXlzLCBjYWxsYmFjaywgb3B0aW9ucyA9IHt9XSBvZiBjYWxsYmFja3MpIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykgewogICAgICAgIGNvbnN0IGlzTWFjS2V5ID0ga2V5LnN0YXJ0c1dpdGgoIm1hYysiKTsKICAgICAgICBpZiAoaXNNYWMgJiYgaXNNYWNLZXkpIHsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLnNldChrZXkuc2xpY2UoNCksIHsKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIG9wdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5hbGxLZXlzLmFkZChrZXkuc3BsaXQoIisiKS5hdCgtMSkpOwogICAgICAgIH0gZWxzZSBpZiAoIWlzTWFjICYmICFpc01hY0tleSkgewogICAgICAgICAgdGhpcy5jYWxsYmFja3Muc2V0KGtleSwgewogICAgICAgICAgICBjYWxsYmFjaywKICAgICAgICAgICAgb3B0aW9ucwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmFsbEtleXMuYWRkKGtleS5zcGxpdCgiKyIpLmF0KC0xKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogICNzZXJpYWxpemUoZXZlbnQpIHsKICAgIGlmIChldmVudC5hbHRLZXkpIHsKICAgICAgdGhpcy5idWZmZXIucHVzaCgiYWx0Iik7CiAgICB9CiAgICBpZiAoZXZlbnQuY3RybEtleSkgewogICAgICB0aGlzLmJ1ZmZlci5wdXNoKCJjdHJsIik7CiAgICB9CiAgICBpZiAoZXZlbnQubWV0YUtleSkgewogICAgICB0aGlzLmJ1ZmZlci5wdXNoKCJtZXRhIik7CiAgICB9CiAgICBpZiAoZXZlbnQuc2hpZnRLZXkpIHsKICAgICAgdGhpcy5idWZmZXIucHVzaCgic2hpZnQiKTsKICAgIH0KICAgIHRoaXMuYnVmZmVyLnB1c2goZXZlbnQua2V5KTsKICAgIGNvbnN0IHN0ciA9IHRoaXMuYnVmZmVyLmpvaW4oIisiKTsKICAgIHRoaXMuYnVmZmVyLmxlbmd0aCA9IDA7CiAgICByZXR1cm4gc3RyOwogIH0KICBleGVjKHNlbGYsIGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuYWxsS2V5cy5oYXMoZXZlbnQua2V5KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpbmZvMiA9IHRoaXMuY2FsbGJhY2tzLmdldCh0aGlzLiNzZXJpYWxpemUoZXZlbnQpKTsKICAgIGlmICghaW5mbzIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBjYWxsYmFjaywKICAgICAgb3B0aW9uczogewogICAgICAgIGJ1YmJsZXMgPSBmYWxzZSwKICAgICAgICBhcmdzID0gW10sCiAgICAgICAgY2hlY2tlciA9IG51bGwKICAgICAgfQogICAgfSA9IGluZm8yOwogICAgaWYgKGNoZWNrZXIgJiYgIWNoZWNrZXIoc2VsZiwgZXZlbnQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNhbGxiYWNrLmJpbmQoc2VsZiwgLi4uYXJncywgZXZlbnQpKCk7CiAgICBpZiAoIWJ1YmJsZXMpIHsKICAgICAgc3RvcEV2ZW50KGV2ZW50KTsKICAgIH0KICB9Cn07CnZhciBDb2xvck1hbmFnZXIgPSBjbGFzcyBfQ29sb3JNYW5hZ2VyIHsKICBzdGF0aWMgX2NvbG9yc01hcHBpbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbWyJDYW52YXNUZXh0IiwgWzAsIDAsIDBdXSwgWyJDYW52YXMiLCBbMjU1LCAyNTUsIDI1NV1dXSk7CiAgZ2V0IF9jb2xvcnMoKSB7CiAgICBjb25zdCBjb2xvcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbWyJDYW52YXNUZXh0IiwgbnVsbF0sIFsiQ2FudmFzIiwgbnVsbF1dKTsKICAgIGdldENvbG9yVmFsdWVzKGNvbG9ycyk7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfY29sb3JzIiwgY29sb3JzKTsKICB9CiAgY29udmVydChjb2xvcikgewogICAgY29uc3QgcmdiID0gZ2V0UkdCKGNvbG9yKTsKICAgIGlmICghd2luZG93Lm1hdGNoTWVkaWEoIihmb3JjZWQtY29sb3JzOiBhY3RpdmUpIikubWF0Y2hlcykgewogICAgICByZXR1cm4gcmdiOwogICAgfQogICAgZm9yIChjb25zdCBbbmFtZSwgUkdCXSBvZiB0aGlzLl9jb2xvcnMpIHsKICAgICAgaWYgKFJHQi5ldmVyeSgoeCwgaSkgPT4geCA9PT0gcmdiW2ldKSkgewogICAgICAgIHJldHVybiBfQ29sb3JNYW5hZ2VyLl9jb2xvcnNNYXBwaW5nLmdldChuYW1lKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJnYjsKICB9CiAgZ2V0SGV4Q29kZShuYW1lKSB7CiAgICBjb25zdCByZ2IgPSB0aGlzLl9jb2xvcnMuZ2V0KG5hbWUpOwogICAgaWYgKCFyZ2IpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgICByZXR1cm4gVXRpbC5tYWtlSGV4Q29sb3IoLi4ucmdiKTsKICB9Cn07CnZhciBBbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyID0gY2xhc3MgX0Fubm90YXRpb25FZGl0b3JVSU1hbmFnZXIgewogICNhYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgI2FjdGl2ZUVkaXRvciA9IG51bGw7CiAgI2FsbEVkaXRhYmxlQW5ub3RhdGlvbnMgPSBudWxsOwogICNhbGxFZGl0b3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjYWxsTGF5ZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjYWx0VGV4dE1hbmFnZXIgPSBudWxsOwogICNhbm5vdGF0aW9uU3RvcmFnZSA9IG51bGw7CiAgI2NoYW5nZWRFeGlzdGluZ0Fubm90YXRpb25zID0gbnVsbDsKICAjY29tbWFuZE1hbmFnZXIgPSBuZXcgQ29tbWFuZE1hbmFnZXIoKTsKICAjY29tbWVudE1hbmFnZXIgPSBudWxsOwogICNjb3B5UGFzdGVBQyA9IG51bGw7CiAgI2N1cnJlbnREcmF3aW5nU2Vzc2lvbiA9IG51bGw7CiAgI2N1cnJlbnRQYWdlSW5kZXggPSAwOwogICNkZWxldGVkQW5ub3RhdGlvbnNFbGVtZW50SWRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAjZHJhZ2dpbmdFZGl0b3JzID0gbnVsbDsKICAjZWRpdG9yVHlwZXMgPSBudWxsOwogICNlZGl0b3JzVG9SZXNjYWxlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICBfZWRpdG9yVW5kb0JhciA9IG51bGw7CiAgI2VuYWJsZUhpZ2hsaWdodEZsb2F0aW5nQnV0dG9uID0gZmFsc2U7CiAgI2VuYWJsZVVwZGF0ZWRBZGRJbWFnZSA9IGZhbHNlOwogICNlbmFibGVOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlID0gZmFsc2U7CiAgI2ZpbHRlckZhY3RvcnkgPSBudWxsOwogICNmb2N1c01haW5Db250YWluZXJUaW1lb3V0SWQgPSBudWxsOwogICNmb2N1c01hbmFnZXJBQyA9IG51bGw7CiAgI2hpZ2hsaWdodENvbG9ycyA9IG51bGw7CiAgI2hpZ2hsaWdodFdoZW5TaGlmdFVwID0gZmFsc2U7CiAgI2Zsb2F0aW5nVG9vbGJhciA9IG51bGw7CiAgI2lkTWFuYWdlciA9IG5ldyBJZE1hbmFnZXIoKTsKICAjaXNFbmFibGVkID0gZmFsc2U7CiAgI2lzUG9pbnRlckRvd24gPSBmYWxzZTsKICAjaXNXYWl0aW5nID0gZmFsc2U7CiAgI2tleWJvYXJkTWFuYWdlckFDID0gbnVsbDsKICAjbGFzdEFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICNtYWluSGlnaGxpZ2h0Q29sb3JQaWNrZXIgPSBudWxsOwogICNtaXNzaW5nQ2FudmFzZXMgPSBudWxsOwogICNtbE1hbmFnZXIgPSBudWxsOwogICNtb2RlID0gQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORTsKICAjc2VsZWN0ZWRFZGl0b3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAjc2VsZWN0ZWRUZXh0Tm9kZSA9IG51bGw7CiAgI3NpZ25hdHVyZU1hbmFnZXIgPSBudWxsOwogICNwYWdlQ29sb3JzID0gbnVsbDsKICAjc2hvd0FsbFN0YXRlcyA9IG51bGw7CiAgI3BkZkRvY3VtZW50ID0gbnVsbDsKICAjcHJldmlvdXNTdGF0ZXMgPSB7CiAgICBpc0VkaXRpbmc6IGZhbHNlLAogICAgaXNFbXB0eTogdHJ1ZSwKICAgIGhhc1NvbWV0aGluZ1RvVW5kbzogZmFsc2UsCiAgICBoYXNTb21ldGhpbmdUb1JlZG86IGZhbHNlLAogICAgaGFzU2VsZWN0ZWRFZGl0b3I6IGZhbHNlLAogICAgaGFzU2VsZWN0ZWRUZXh0OiBmYWxzZQogIH07CiAgI3RyYW5zbGF0aW9uID0gWzAsIDBdOwogICN0cmFuc2xhdGlvblRpbWVvdXRJZCA9IG51bGw7CiAgI2NvbnRhaW5lciA9IG51bGw7CiAgI3ZpZXdlciA9IG51bGw7CiAgI3ZpZXdlckFsZXJ0ID0gbnVsbDsKICAjdXBkYXRlTW9kZUNhcGFiaWxpdHkgPSBudWxsOwogIHN0YXRpYyBUUkFOU0xBVEVfU01BTEwgPSAxOwogIHN0YXRpYyBUUkFOU0xBVEVfQklHID0gMTA7CiAgc3RhdGljIGdldCBfa2V5Ym9hcmRNYW5hZ2VyKCkgewogICAgY29uc3QgcHJvdG8gPSBfQW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlci5wcm90b3R5cGU7CiAgICBjb25zdCBhcnJvd0NoZWNrZXIgPSAoc2VsZikgPT4gc2VsZi4jY29udGFpbmVyLmNvbnRhaW5zKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQudGFnTmFtZSAhPT0gIkJVVFRPTiIgJiYgc2VsZi5oYXNTb21ldGhpbmdUb0NvbnRyb2woKTsKICAgIGNvbnN0IHRleHRJbnB1dENoZWNrZXIgPSAoX3NlbGYsIHsKICAgICAgdGFyZ2V0OiBlbAogICAgfSkgPT4gewogICAgICBpZiAoZWwgaW5zdGFuY2VvZiBIVE1MSW5wdXRFbGVtZW50KSB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgdHlwZQogICAgICAgIH0gPSBlbDsKICAgICAgICByZXR1cm4gdHlwZSAhPT0gInRleHQiICYmIHR5cGUgIT09ICJudW1iZXIiOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIGNvbnN0IHNtYWxsID0gdGhpcy5UUkFOU0xBVEVfU01BTEw7CiAgICBjb25zdCBiaWcgPSB0aGlzLlRSQU5TTEFURV9CSUc7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfa2V5Ym9hcmRNYW5hZ2VyIiwgbmV3IEtleWJvYXJkTWFuYWdlcihbW1siY3RybCthIiwgIm1hYyttZXRhK2EiXSwgcHJvdG8uc2VsZWN0QWxsLCB7CiAgICAgIGNoZWNrZXI6IHRleHRJbnB1dENoZWNrZXIKICAgIH1dLCBbWyJjdHJsK3oiLCAibWFjK21ldGEreiJdLCBwcm90by51bmRvLCB7CiAgICAgIGNoZWNrZXI6IHRleHRJbnB1dENoZWNrZXIKICAgIH1dLCBbWyJjdHJsK3kiLCAiY3RybCtzaGlmdCt6IiwgIm1hYyttZXRhK3NoaWZ0K3oiLCAiY3RybCtzaGlmdCtaIiwgIm1hYyttZXRhK3NoaWZ0K1oiXSwgcHJvdG8ucmVkbywgewogICAgICBjaGVja2VyOiB0ZXh0SW5wdXRDaGVja2VyCiAgICB9XSwgW1siQmFja3NwYWNlIiwgImFsdCtCYWNrc3BhY2UiLCAiY3RybCtCYWNrc3BhY2UiLCAic2hpZnQrQmFja3NwYWNlIiwgIm1hYytCYWNrc3BhY2UiLCAibWFjK2FsdCtCYWNrc3BhY2UiLCAibWFjK2N0cmwrQmFja3NwYWNlIiwgIkRlbGV0ZSIsICJjdHJsK0RlbGV0ZSIsICJzaGlmdCtEZWxldGUiLCAibWFjK0RlbGV0ZSJdLCBwcm90by5kZWxldGUsIHsKICAgICAgY2hlY2tlcjogdGV4dElucHV0Q2hlY2tlcgogICAgfV0sIFtbIkVudGVyIiwgIm1hYytFbnRlciJdLCBwcm90by5hZGROZXdFZGl0b3JGcm9tS2V5Ym9hcmQsIHsKICAgICAgY2hlY2tlcjogKHNlbGYsIHsKICAgICAgICB0YXJnZXQ6IGVsCiAgICAgIH0pID0+ICEoZWwgaW5zdGFuY2VvZiBIVE1MQnV0dG9uRWxlbWVudCkgJiYgc2VsZi4jY29udGFpbmVyLmNvbnRhaW5zKGVsKSAmJiAhc2VsZi5pc0VudGVySGFuZGxlZAogICAgfV0sIFtbIiAiLCAibWFjKyAiXSwgcHJvdG8uYWRkTmV3RWRpdG9yRnJvbUtleWJvYXJkLCB7CiAgICAgIGNoZWNrZXI6IChzZWxmLCB7CiAgICAgICAgdGFyZ2V0OiBlbAogICAgICB9KSA9PiAhKGVsIGluc3RhbmNlb2YgSFRNTEJ1dHRvbkVsZW1lbnQpICYmIHNlbGYuI2NvbnRhaW5lci5jb250YWlucyhkb2N1bWVudC5hY3RpdmVFbGVtZW50KQogICAgfV0sIFtbIkVzY2FwZSIsICJtYWMrRXNjYXBlIl0sIHByb3RvLnVuc2VsZWN0QWxsXSwgW1siQXJyb3dMZWZ0IiwgIm1hYytBcnJvd0xlZnQiXSwgcHJvdG8udHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzLCB7CiAgICAgIGFyZ3M6IFstc21hbGwsIDBdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJjdHJsK0Fycm93TGVmdCIsICJtYWMrc2hpZnQrQXJyb3dMZWZ0Il0sIHByb3RvLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycywgewogICAgICBhcmdzOiBbLWJpZywgMF0sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbIkFycm93UmlnaHQiLCAibWFjK0Fycm93UmlnaHQiXSwgcHJvdG8udHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzLCB7CiAgICAgIGFyZ3M6IFtzbWFsbCwgMF0sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbImN0cmwrQXJyb3dSaWdodCIsICJtYWMrc2hpZnQrQXJyb3dSaWdodCJdLCBwcm90by50cmFuc2xhdGVTZWxlY3RlZEVkaXRvcnMsIHsKICAgICAgYXJnczogW2JpZywgMF0sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbIkFycm93VXAiLCAibWFjK0Fycm93VXAiXSwgcHJvdG8udHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzLCB7CiAgICAgIGFyZ3M6IFswLCAtc21hbGxdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJjdHJsK0Fycm93VXAiLCAibWFjK3NoaWZ0K0Fycm93VXAiXSwgcHJvdG8udHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzLCB7CiAgICAgIGFyZ3M6IFswLCAtYmlnXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siQXJyb3dEb3duIiwgIm1hYytBcnJvd0Rvd24iXSwgcHJvdG8udHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzLCB7CiAgICAgIGFyZ3M6IFswLCBzbWFsbF0sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbImN0cmwrQXJyb3dEb3duIiwgIm1hYytzaGlmdCtBcnJvd0Rvd24iXSwgcHJvdG8udHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzLCB7CiAgICAgIGFyZ3M6IFswLCBiaWddLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dXSkpOwogIH0KICBjb25zdHJ1Y3Rvcihjb250YWluZXIyLCB2aWV3ZXIsIHZpZXdlckFsZXJ0LCBhbHRUZXh0TWFuYWdlciwgY29tbWVudE1hbmFnZXIsIHNpZ25hdHVyZU1hbmFnZXIsIGV2ZW50QnVzLCBwZGZEb2N1bWVudCwgcGFnZUNvbG9ycywgaGlnaGxpZ2h0Q29sb3JzLCBlbmFibGVIaWdobGlnaHRGbG9hdGluZ0J1dHRvbiwgZW5hYmxlVXBkYXRlZEFkZEltYWdlLCBlbmFibGVOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlLCBtbE1hbmFnZXIsIGVkaXRvclVuZG9CYXIsIHN1cHBvcnRzUGluY2hUb1pvb20pIHsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuX3NpZ25hbCA9IHRoaXMuI2Fib3J0Q29udHJvbGxlci5zaWduYWw7CiAgICB0aGlzLiNjb250YWluZXIgPSBjb250YWluZXIyOwogICAgdGhpcy4jdmlld2VyID0gdmlld2VyOwogICAgdGhpcy4jdmlld2VyQWxlcnQgPSB2aWV3ZXJBbGVydDsKICAgIHRoaXMuI2FsdFRleHRNYW5hZ2VyID0gYWx0VGV4dE1hbmFnZXI7CiAgICB0aGlzLiNjb21tZW50TWFuYWdlciA9IGNvbW1lbnRNYW5hZ2VyOwogICAgdGhpcy4jc2lnbmF0dXJlTWFuYWdlciA9IHNpZ25hdHVyZU1hbmFnZXI7CiAgICB0aGlzLiNwZGZEb2N1bWVudCA9IHBkZkRvY3VtZW50OwogICAgdGhpcy5fZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIGV2ZW50QnVzLl9vbigiZWRpdGluZ2FjdGlvbiIsIHRoaXMub25FZGl0aW5nQWN0aW9uLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGV2ZW50QnVzLl9vbigicGFnZWNoYW5naW5nIiwgdGhpcy5vblBhZ2VDaGFuZ2luZy5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBldmVudEJ1cy5fb24oInNjYWxlY2hhbmdpbmciLCB0aGlzLm9uU2NhbGVDaGFuZ2luZy5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBldmVudEJ1cy5fb24oInJvdGF0aW9uY2hhbmdpbmciLCB0aGlzLm9uUm90YXRpb25DaGFuZ2luZy5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBldmVudEJ1cy5fb24oInNldHByZWZlcmVuY2UiLCB0aGlzLm9uU2V0UHJlZmVyZW5jZS5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBldmVudEJ1cy5fb24oInN3aXRjaGFubm90YXRpb25lZGl0b3JwYXJhbXMiLCAoZXZ0KSA9PiB0aGlzLnVwZGF0ZVBhcmFtcyhldnQudHlwZSwgZXZ0LnZhbHVlKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgKCkgPT4gewogICAgICB0aGlzLiNpc1BvaW50ZXJEb3duID0gdHJ1ZTsKICAgIH0sIHsKICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVydXAiLCAoKSA9PiB7CiAgICAgIHRoaXMuI2lzUG9pbnRlckRvd24gPSBmYWxzZTsKICAgIH0sIHsKICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuI2FkZFNlbGVjdGlvbkxpc3RlbmVyKCk7CiAgICB0aGlzLiNhZGREcmFnQW5kRHJvcExpc3RlbmVycygpOwogICAgdGhpcy4jYWRkS2V5Ym9hcmRNYW5hZ2VyKCk7CiAgICB0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZSA9IHBkZkRvY3VtZW50LmFubm90YXRpb25TdG9yYWdlOwogICAgdGhpcy4jZmlsdGVyRmFjdG9yeSA9IHBkZkRvY3VtZW50LmZpbHRlckZhY3Rvcnk7CiAgICB0aGlzLiNwYWdlQ29sb3JzID0gcGFnZUNvbG9yczsKICAgIHRoaXMuI2hpZ2hsaWdodENvbG9ycyA9IGhpZ2hsaWdodENvbG9ycyB8fCBudWxsOwogICAgdGhpcy4jZW5hYmxlSGlnaGxpZ2h0RmxvYXRpbmdCdXR0b24gPSBlbmFibGVIaWdobGlnaHRGbG9hdGluZ0J1dHRvbjsKICAgIHRoaXMuI2VuYWJsZVVwZGF0ZWRBZGRJbWFnZSA9IGVuYWJsZVVwZGF0ZWRBZGRJbWFnZTsKICAgIHRoaXMuI2VuYWJsZU5ld0FsdFRleHRXaGVuQWRkaW5nSW1hZ2UgPSBlbmFibGVOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlOwogICAgdGhpcy4jbWxNYW5hZ2VyID0gbWxNYW5hZ2VyIHx8IG51bGw7CiAgICB0aGlzLnZpZXdQYXJhbWV0ZXJzID0gewogICAgICByZWFsU2NhbGU6IFBpeGVsc1BlckluY2guUERGX1RPX0NTU19VTklUUywKICAgICAgcm90YXRpb246IDAKICAgIH07CiAgICB0aGlzLmlzU2hpZnRLZXlEb3duID0gZmFsc2U7CiAgICB0aGlzLl9lZGl0b3JVbmRvQmFyID0gZWRpdG9yVW5kb0JhciB8fCBudWxsOwogICAgdGhpcy5fc3VwcG9ydHNQaW5jaFRvWm9vbSA9IHN1cHBvcnRzUGluY2hUb1pvb20gIT09IGZhbHNlOwogICAgY29tbWVudE1hbmFnZXI/LnNldFNpZGViYXJVaU1hbmFnZXIodGhpcyk7CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLiN1cGRhdGVNb2RlQ2FwYWJpbGl0eT8ucmVzb2x2ZSgpOwogICAgdGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHkgPSBudWxsOwogICAgdGhpcy4jYWJvcnRDb250cm9sbGVyPy5hYm9ydCgpOwogICAgdGhpcy4jYWJvcnRDb250cm9sbGVyID0gbnVsbDsKICAgIHRoaXMuX3NpZ25hbCA9IG51bGw7CiAgICBmb3IgKGNvbnN0IGxheWVyIG9mIHRoaXMuI2FsbExheWVycy52YWx1ZXMoKSkgewogICAgICBsYXllci5kZXN0cm95KCk7CiAgICB9CiAgICB0aGlzLiNhbGxMYXllcnMuY2xlYXIoKTsKICAgIHRoaXMuI2FsbEVkaXRvcnMuY2xlYXIoKTsKICAgIHRoaXMuI2VkaXRvcnNUb1Jlc2NhbGUuY2xlYXIoKTsKICAgIHRoaXMuI21pc3NpbmdDYW52YXNlcz8uY2xlYXIoKTsKICAgIHRoaXMuI2FjdGl2ZUVkaXRvciA9IG51bGw7CiAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuY2xlYXIoKTsKICAgIHRoaXMuI2NvbW1hbmRNYW5hZ2VyLmRlc3Ryb3koKTsKICAgIHRoaXMuI2FsdFRleHRNYW5hZ2VyPy5kZXN0cm95KCk7CiAgICB0aGlzLiNjb21tZW50TWFuYWdlcj8uZGVzdHJveSgpOwogICAgdGhpcy4jc2lnbmF0dXJlTWFuYWdlcj8uZGVzdHJveSgpOwogICAgdGhpcy4jZmxvYXRpbmdUb29sYmFyPy5oaWRlKCk7CiAgICB0aGlzLiNmbG9hdGluZ1Rvb2xiYXIgPSBudWxsOwogICAgdGhpcy4jbWFpbkhpZ2hsaWdodENvbG9yUGlja2VyPy5kZXN0cm95KCk7CiAgICB0aGlzLiNtYWluSGlnaGxpZ2h0Q29sb3JQaWNrZXIgPSBudWxsOwogICAgdGhpcy4jYWxsRWRpdGFibGVBbm5vdGF0aW9ucyA9IG51bGw7CiAgICBpZiAodGhpcy4jZm9jdXNNYWluQ29udGFpbmVyVGltZW91dElkKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLiNmb2N1c01haW5Db250YWluZXJUaW1lb3V0SWQpOwogICAgICB0aGlzLiNmb2N1c01haW5Db250YWluZXJUaW1lb3V0SWQgPSBudWxsOwogICAgfQogICAgaWYgKHRoaXMuI3RyYW5zbGF0aW9uVGltZW91dElkKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLiN0cmFuc2xhdGlvblRpbWVvdXRJZCk7CiAgICAgIHRoaXMuI3RyYW5zbGF0aW9uVGltZW91dElkID0gbnVsbDsKICAgIH0KICAgIHRoaXMuX2VkaXRvclVuZG9CYXI/LmRlc3Ryb3koKTsKICAgIHRoaXMuI3BkZkRvY3VtZW50ID0gbnVsbDsKICB9CiAgY29tYmluZWRTaWduYWwoYWMpIHsKICAgIHJldHVybiBBYm9ydFNpZ25hbC5hbnkoW3RoaXMuX3NpZ25hbCwgYWMuc2lnbmFsXSk7CiAgfQogIGdldCBtbE1hbmFnZXIoKSB7CiAgICByZXR1cm4gdGhpcy4jbWxNYW5hZ2VyOwogIH0KICBnZXQgdXNlTmV3QWx0VGV4dEZsb3coKSB7CiAgICByZXR1cm4gdGhpcy4jZW5hYmxlVXBkYXRlZEFkZEltYWdlOwogIH0KICBnZXQgdXNlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZSgpIHsKICAgIHJldHVybiB0aGlzLiNlbmFibGVOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlOwogIH0KICBnZXQgaGNtRmlsdGVyKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaGNtRmlsdGVyIiwgdGhpcy4jcGFnZUNvbG9ycyA/IHRoaXMuI2ZpbHRlckZhY3RvcnkuYWRkSENNRmlsdGVyKHRoaXMuI3BhZ2VDb2xvcnMuZm9yZWdyb3VuZCwgdGhpcy4jcGFnZUNvbG9ycy5iYWNrZ3JvdW5kKSA6ICJub25lIik7CiAgfQogIGdldCBkaXJlY3Rpb24oKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJkaXJlY3Rpb24iLCBnZXRDb21wdXRlZFN0eWxlKHRoaXMuI2NvbnRhaW5lcikuZGlyZWN0aW9uKTsKICB9CiAgZ2V0IF9oaWdobGlnaHRDb2xvcnMoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfaGlnaGxpZ2h0Q29sb3JzIiwgdGhpcy4jaGlnaGxpZ2h0Q29sb3JzID8gbmV3IE1hcCh0aGlzLiNoaWdobGlnaHRDb2xvcnMuc3BsaXQoIiwiKS5tYXAoKHBhaXIpID0+IHsKICAgICAgcGFpciA9IHBhaXIuc3BsaXQoIj0iKS5tYXAoKHgpID0+IHgudHJpbSgpKTsKICAgICAgcGFpclsxXSA9IHBhaXJbMV0udG9VcHBlckNhc2UoKTsKICAgICAgcmV0dXJuIHBhaXI7CiAgICB9KSkgOiBudWxsKTsKICB9CiAgZ2V0IGhpZ2hsaWdodENvbG9ycygpIHsKICAgIGNvbnN0IHsKICAgICAgX2hpZ2hsaWdodENvbG9ycwogICAgfSA9IHRoaXM7CiAgICBpZiAoIV9oaWdobGlnaHRDb2xvcnMpIHsKICAgICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaGlnaGxpZ2h0Q29sb3JzIiwgbnVsbCk7CiAgICB9CiAgICBjb25zdCBtYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgaGFzSENNID0gISF0aGlzLiNwYWdlQ29sb3JzOwogICAgZm9yIChjb25zdCBbbmFtZSwgY29sb3JdIG9mIF9oaWdobGlnaHRDb2xvcnMpIHsKICAgICAgY29uc3QgaXNOYW1lRm9ySENNID0gbmFtZS5lbmRzV2l0aCgiX0hDTSIpOwogICAgICBpZiAoaGFzSENNICYmIGlzTmFtZUZvckhDTSkgewogICAgICAgIG1hcC5zZXQobmFtZS5yZXBsYWNlKCJfSENNIiwgIiIpLCBjb2xvcik7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKCFoYXNIQ00gJiYgIWlzTmFtZUZvckhDTSkgewogICAgICAgIG1hcC5zZXQobmFtZSwgY29sb3IpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJoaWdobGlnaHRDb2xvcnMiLCBtYXApOwogIH0KICBnZXQgaGlnaGxpZ2h0Q29sb3JOYW1lcygpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImhpZ2hsaWdodENvbG9yTmFtZXMiLCB0aGlzLmhpZ2hsaWdodENvbG9ycyA/IG5ldyBNYXAoQXJyYXkuZnJvbSh0aGlzLmhpZ2hsaWdodENvbG9ycywgKGUpID0+IGUucmV2ZXJzZSgpKSkgOiBudWxsKTsKICB9CiAgZ2V0Tm9uSENNQ29sb3IoY29sb3IpIHsKICAgIGlmICghdGhpcy5faGlnaGxpZ2h0Q29sb3JzKSB7CiAgICAgIHJldHVybiBjb2xvcjsKICAgIH0KICAgIGNvbnN0IGNvbG9yTmFtZSA9IHRoaXMuaGlnaGxpZ2h0Q29sb3JOYW1lcy5nZXQoY29sb3IpOwogICAgcmV0dXJuIHRoaXMuX2hpZ2hsaWdodENvbG9ycy5nZXQoY29sb3JOYW1lKSB8fCBjb2xvcjsKICB9CiAgZ2V0Tm9uSENNQ29sb3JOYW1lKGNvbG9yKSB7CiAgICByZXR1cm4gdGhpcy5oaWdobGlnaHRDb2xvck5hbWVzLmdldChjb2xvcikgfHwgY29sb3I7CiAgfQogIHNldEN1cnJlbnREcmF3aW5nU2Vzc2lvbihsYXllcikgewogICAgaWYgKGxheWVyKSB7CiAgICAgIHRoaXMudW5zZWxlY3RBbGwoKTsKICAgICAgdGhpcy5kaXNhYmxlVXNlclNlbGVjdCh0cnVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZGlzYWJsZVVzZXJTZWxlY3QoZmFsc2UpOwogICAgfQogICAgdGhpcy4jY3VycmVudERyYXdpbmdTZXNzaW9uID0gbGF5ZXI7CiAgfQogIHNldE1haW5IaWdobGlnaHRDb2xvclBpY2tlcihjb2xvclBpY2tlcikgewogICAgdGhpcy4jbWFpbkhpZ2hsaWdodENvbG9yUGlja2VyID0gY29sb3JQaWNrZXI7CiAgfQogIGVkaXRBbHRUZXh0KGVkaXRvciwgZmlyc3RUaW1lID0gZmFsc2UpIHsKICAgIHRoaXMuI2FsdFRleHRNYW5hZ2VyPy5lZGl0QWx0VGV4dCh0aGlzLCBlZGl0b3IsIGZpcnN0VGltZSk7CiAgfQogIGhhc0NvbW1lbnRNYW5hZ2VyKCkgewogICAgcmV0dXJuICEhdGhpcy4jY29tbWVudE1hbmFnZXI7CiAgfQogIGVkaXRDb21tZW50KGVkaXRvciwgcG9zWCwgcG9zWSwgb3B0aW9ucykgewogICAgdGhpcy4jY29tbWVudE1hbmFnZXI/LnNob3dEaWFsb2codGhpcywgZWRpdG9yLCBwb3NYLCBwb3NZLCBvcHRpb25zKTsKICB9CiAgc2VsZWN0Q29tbWVudChwYWdlSW5kZXgsIHVpZCkgewogICAgY29uc3QgbGF5ZXIgPSB0aGlzLiNhbGxMYXllcnMuZ2V0KHBhZ2VJbmRleCk7CiAgICBjb25zdCBlZGl0b3IgPSBsYXllcj8uZ2V0RWRpdG9yQnlVSUQodWlkKTsKICAgIGVkaXRvcj8udG9nZ2xlQ29tbWVudCh0cnVlLCB0cnVlKTsKICB9CiAgdXBkYXRlQ29tbWVudChlZGl0b3IpIHsKICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy51cGRhdGVDb21tZW50KGVkaXRvci5nZXREYXRhKCkpOwogIH0KICB1cGRhdGVQb3B1cENvbG9yKGVkaXRvcikgewogICAgdGhpcy4jY29tbWVudE1hbmFnZXI/LnVwZGF0ZVBvcHVwQ29sb3IoZWRpdG9yKTsKICB9CiAgcmVtb3ZlQ29tbWVudChlZGl0b3IpIHsKICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy5yZW1vdmVDb21tZW50cyhbZWRpdG9yLnVpZF0pOwogIH0KICB0b2dnbGVDb21tZW50KGVkaXRvciwgaXNTZWxlY3RlZCwgdmlzaWJpbGl0eSA9IHZvaWQgMCkgewogICAgdGhpcy4jY29tbWVudE1hbmFnZXI/LnRvZ2dsZUNvbW1lbnRQb3B1cChlZGl0b3IsIGlzU2VsZWN0ZWQsIHZpc2liaWxpdHkpOwogIH0KICBtYWtlQ29tbWVudENvbG9yKGNvbG9yLCBvcGFjaXR5KSB7CiAgICByZXR1cm4gY29sb3IgJiYgdGhpcy4jY29tbWVudE1hbmFnZXI/Lm1ha2VDb21tZW50Q29sb3IoY29sb3IsIG9wYWNpdHkpIHx8IG51bGw7CiAgfQogIGdldENvbW1lbnREaWFsb2dFbGVtZW50KCkgewogICAgcmV0dXJuIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy5kaWFsb2dFbGVtZW50IHx8IG51bGw7CiAgfQogIGFzeW5jIHdhaXRGb3JFZGl0b3JzUmVuZGVyZWQocGFnZU51bWJlcikgewogICAgaWYgKHRoaXMuI2FsbExheWVycy5oYXMocGFnZU51bWJlciAtIDEpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgcmVzb2x2ZSwKICAgICAgcHJvbWlzZQogICAgfSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgY29uc3Qgb25FZGl0b3JzUmVuZGVyZWQgPSAoZXZ0KSA9PiB7CiAgICAgIGlmIChldnQucGFnZU51bWJlciA9PT0gcGFnZU51bWJlcikgewogICAgICAgIHRoaXMuX2V2ZW50QnVzLl9vZmYoImVkaXRvcnNyZW5kZXJlZCIsIG9uRWRpdG9yc1JlbmRlcmVkKTsKICAgICAgICByZXNvbHZlKCk7CiAgICAgIH0KICAgIH07CiAgICB0aGlzLl9ldmVudEJ1cy5vbigiZWRpdG9yc3JlbmRlcmVkIiwgb25FZGl0b3JzUmVuZGVyZWQpOwogICAgYXdhaXQgcHJvbWlzZTsKICB9CiAgZ2V0U2lnbmF0dXJlKGVkaXRvcikgewogICAgdGhpcy4jc2lnbmF0dXJlTWFuYWdlcj8uZ2V0U2lnbmF0dXJlKHsKICAgICAgdWlNYW5hZ2VyOiB0aGlzLAogICAgICBlZGl0b3IKICAgIH0pOwogIH0KICBnZXQgc2lnbmF0dXJlTWFuYWdlcigpIHsKICAgIHJldHVybiB0aGlzLiNzaWduYXR1cmVNYW5hZ2VyOwogIH0KICBzd2l0Y2hUb01vZGUobW9kZSwgY2FsbGJhY2spIHsKICAgIHRoaXMuX2V2ZW50QnVzLm9uKCJhbm5vdGF0aW9uZWRpdG9ybW9kZWNoYW5nZWQiLCBjYWxsYmFjaywgewogICAgICBvbmNlOiB0cnVlLAogICAgICBzaWduYWw6IHRoaXMuX3NpZ25hbAogICAgfSk7CiAgICB0aGlzLl9ldmVudEJ1cy5kaXNwYXRjaCgic2hvd2Fubm90YXRpb25lZGl0b3J1aSIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICBtb2RlCiAgICB9KTsKICB9CiAgc2V0UHJlZmVyZW5jZShuYW1lLCB2YWx1ZSkgewogICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goInNldHByZWZlcmVuY2UiLCB7CiAgICAgIHNvdXJjZTogdGhpcywKICAgICAgbmFtZSwKICAgICAgdmFsdWUKICAgIH0pOwogIH0KICBvblNldFByZWZlcmVuY2UoewogICAgbmFtZSwKICAgIHZhbHVlCiAgfSkgewogICAgc3dpdGNoIChuYW1lKSB7CiAgICAgIGNhc2UgImVuYWJsZU5ld0FsdFRleHRXaGVuQWRkaW5nSW1hZ2UiOgogICAgICAgIHRoaXMuI2VuYWJsZU5ld0FsdFRleHRXaGVuQWRkaW5nSW1hZ2UgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgb25QYWdlQ2hhbmdpbmcoewogICAgcGFnZU51bWJlcgogIH0pIHsKICAgIHRoaXMuI2N1cnJlbnRQYWdlSW5kZXggPSBwYWdlTnVtYmVyIC0gMTsKICB9CiAgZm9jdXNNYWluQ29udGFpbmVyKCkgewogICAgdGhpcy4jY29udGFpbmVyLmZvY3VzKCk7CiAgfQogIGZpbmRQYXJlbnQoeCwgeSkgewogICAgZm9yIChjb25zdCBsYXllciBvZiB0aGlzLiNhbGxMYXllcnMudmFsdWVzKCkpIHsKICAgICAgY29uc3QgewogICAgICAgIHg6IGxheWVyWCwKICAgICAgICB5OiBsYXllclksCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0CiAgICAgIH0gPSBsYXllci5kaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGlmICh4ID49IGxheWVyWCAmJiB4IDw9IGxheWVyWCArIHdpZHRoICYmIHkgPj0gbGF5ZXJZICYmIHkgPD0gbGF5ZXJZICsgaGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIGxheWVyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZGlzYWJsZVVzZXJTZWxlY3QodmFsdWUgPSBmYWxzZSkgewogICAgdGhpcy4jdmlld2VyLmNsYXNzTGlzdC50b2dnbGUoIm5vVXNlclNlbGVjdCIsIHZhbHVlKTsKICB9CiAgYWRkU2hvdWxkUmVzY2FsZShlZGl0b3IpIHsKICAgIHRoaXMuI2VkaXRvcnNUb1Jlc2NhbGUuYWRkKGVkaXRvcik7CiAgfQogIHJlbW92ZVNob3VsZFJlc2NhbGUoZWRpdG9yKSB7CiAgICB0aGlzLiNlZGl0b3JzVG9SZXNjYWxlLmRlbGV0ZShlZGl0b3IpOwogIH0KICBvblNjYWxlQ2hhbmdpbmcoewogICAgc2NhbGUKICB9KSB7CiAgICB0aGlzLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICB0aGlzLnZpZXdQYXJhbWV0ZXJzLnJlYWxTY2FsZSA9IHNjYWxlICogUGl4ZWxzUGVySW5jaC5QREZfVE9fQ1NTX1VOSVRTOwogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jZWRpdG9yc1RvUmVzY2FsZSkgewogICAgICBlZGl0b3Iub25TY2FsZUNoYW5naW5nKCk7CiAgICB9CiAgICB0aGlzLiNjdXJyZW50RHJhd2luZ1Nlc3Npb24/Lm9uU2NhbGVDaGFuZ2luZygpOwogIH0KICBvblJvdGF0aW9uQ2hhbmdpbmcoewogICAgcGFnZXNSb3RhdGlvbgogIH0pIHsKICAgIHRoaXMuY29tbWl0T3JSZW1vdmUoKTsKICAgIHRoaXMudmlld1BhcmFtZXRlcnMucm90YXRpb24gPSBwYWdlc1JvdGF0aW9uOwogIH0KICAjZ2V0QW5jaG9yRWxlbWVudEZvclNlbGVjdGlvbih7CiAgICBhbmNob3JOb2RlCiAgfSkgewogICAgcmV0dXJuIGFuY2hvck5vZGUubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFID8gYW5jaG9yTm9kZS5wYXJlbnRFbGVtZW50IDogYW5jaG9yTm9kZTsKICB9CiAgI2dldExheWVyRm9yVGV4dExheWVyKHRleHRMYXllcikgewogICAgY29uc3QgewogICAgICBjdXJyZW50TGF5ZXIKICAgIH0gPSB0aGlzOwogICAgaWYgKGN1cnJlbnRMYXllci5oYXNUZXh0TGF5ZXIodGV4dExheWVyKSkgewogICAgICByZXR1cm4gY3VycmVudExheWVyOwogICAgfQogICAgZm9yIChjb25zdCBsYXllciBvZiB0aGlzLiNhbGxMYXllcnMudmFsdWVzKCkpIHsKICAgICAgaWYgKGxheWVyLmhhc1RleHRMYXllcih0ZXh0TGF5ZXIpKSB7CiAgICAgICAgcmV0dXJuIGxheWVyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaGlnaGxpZ2h0U2VsZWN0aW9uKG1ldGhvZE9mQ3JlYXRpb24gPSAiIiwgY29tbWVudCA9IGZhbHNlKSB7CiAgICBjb25zdCBzZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTsKICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5pc0NvbGxhcHNlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGFuY2hvck5vZGUsCiAgICAgIGFuY2hvck9mZnNldCwKICAgICAgZm9jdXNOb2RlLAogICAgICBmb2N1c09mZnNldAogICAgfSA9IHNlbGVjdGlvbjsKICAgIGNvbnN0IHRleHQgPSBzZWxlY3Rpb24udG9TdHJpbmcoKTsKICAgIGNvbnN0IGFuY2hvckVsZW1lbnQgPSB0aGlzLiNnZXRBbmNob3JFbGVtZW50Rm9yU2VsZWN0aW9uKHNlbGVjdGlvbik7CiAgICBjb25zdCB0ZXh0TGF5ZXIgPSBhbmNob3JFbGVtZW50LmNsb3Nlc3QoIi50ZXh0TGF5ZXIiKTsKICAgIGNvbnN0IGJveGVzID0gdGhpcy5nZXRTZWxlY3Rpb25Cb3hlcyh0ZXh0TGF5ZXIpOwogICAgaWYgKCFib3hlcykgewogICAgICByZXR1cm47CiAgICB9CiAgICBzZWxlY3Rpb24uZW1wdHkoKTsKICAgIGNvbnN0IGxheWVyID0gdGhpcy4jZ2V0TGF5ZXJGb3JUZXh0TGF5ZXIodGV4dExheWVyKTsKICAgIGNvbnN0IGlzTm9uZU1vZGUgPSB0aGlzLiNtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5OT05FOwogICAgY29uc3QgY2FsbGJhY2sgPSAoKSA9PiB7CiAgICAgIGNvbnN0IGVkaXRvciA9IGxheWVyPy5jcmVhdGVBbmRBZGROZXdFZGl0b3IoewogICAgICAgIHg6IDAsCiAgICAgICAgeTogMAogICAgICB9LCBmYWxzZSwgewogICAgICAgIG1ldGhvZE9mQ3JlYXRpb24sCiAgICAgICAgYm94ZXMsCiAgICAgICAgYW5jaG9yTm9kZSwKICAgICAgICBhbmNob3JPZmZzZXQsCiAgICAgICAgZm9jdXNOb2RlLAogICAgICAgIGZvY3VzT2Zmc2V0LAogICAgICAgIHRleHQKICAgICAgfSk7CiAgICAgIGlmIChpc05vbmVNb2RlKSB7CiAgICAgICAgdGhpcy5zaG93QWxsRWRpdG9ycygiaGlnaGxpZ2h0IiwgdHJ1ZSwgdHJ1ZSk7CiAgICAgIH0KICAgICAgaWYgKGNvbW1lbnQpIHsKICAgICAgICBlZGl0b3I/LmVkaXRDb21tZW50KCk7CiAgICAgIH0KICAgIH07CiAgICBpZiAoaXNOb25lTW9kZSkgewogICAgICB0aGlzLnN3aXRjaFRvTW9kZShBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQsIGNhbGxiYWNrKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2FsbGJhY2soKTsKICB9CiAgY29tbWVudFNlbGVjdGlvbihtZXRob2RPZkNyZWF0aW9uID0gIiIpIHsKICAgIHRoaXMuaGlnaGxpZ2h0U2VsZWN0aW9uKG1ldGhvZE9mQ3JlYXRpb24sIHRydWUpOwogIH0KICAjZGlzcGxheUZsb2F0aW5nVG9vbGJhcigpIHsKICAgIGNvbnN0IHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpOwogICAgaWYgKCFzZWxlY3Rpb24gfHwgc2VsZWN0aW9uLmlzQ29sbGFwc2VkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGFuY2hvckVsZW1lbnQgPSB0aGlzLiNnZXRBbmNob3JFbGVtZW50Rm9yU2VsZWN0aW9uKHNlbGVjdGlvbik7CiAgICBjb25zdCB0ZXh0TGF5ZXIgPSBhbmNob3JFbGVtZW50LmNsb3Nlc3QoIi50ZXh0TGF5ZXIiKTsKICAgIGNvbnN0IGJveGVzID0gdGhpcy5nZXRTZWxlY3Rpb25Cb3hlcyh0ZXh0TGF5ZXIpOwogICAgaWYgKCFib3hlcykgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNmbG9hdGluZ1Rvb2xiYXIgfHw9IG5ldyBGbG9hdGluZ1Rvb2xiYXIodGhpcyk7CiAgICB0aGlzLiNmbG9hdGluZ1Rvb2xiYXIuc2hvdyh0ZXh0TGF5ZXIsIGJveGVzLCB0aGlzLmRpcmVjdGlvbiA9PT0gImx0ciIpOwogIH0KICBnZXRBbmRSZW1vdmVEYXRhRnJvbUFubm90YXRpb25TdG9yYWdlKGFubm90YXRpb25JZCkgewogICAgaWYgKCF0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IGtleSA9IGAke0Fubm90YXRpb25FZGl0b3JQcmVmaXh9JHthbm5vdGF0aW9uSWR9YDsKICAgIGNvbnN0IHN0b3JlZFZhbHVlID0gdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UuZ2V0UmF3VmFsdWUoa2V5KTsKICAgIGlmIChzdG9yZWRWYWx1ZSkgewogICAgICB0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZS5yZW1vdmUoa2V5KTsKICAgIH0KICAgIHJldHVybiBzdG9yZWRWYWx1ZTsKICB9CiAgYWRkVG9Bbm5vdGF0aW9uU3RvcmFnZShlZGl0b3IpIHsKICAgIGlmICghZWRpdG9yLmlzRW1wdHkoKSAmJiB0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZSAmJiAhdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UuaGFzKGVkaXRvci5pZCkpIHsKICAgICAgdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2Uuc2V0VmFsdWUoZWRpdG9yLmlkLCBlZGl0b3IpOwogICAgfQogIH0KICBhMTF5QWxlcnQobWVzc2FnZUlkLCBhcmdzID0gbnVsbCkgewogICAgY29uc3Qgdmlld2VyQWxlcnQgPSB0aGlzLiN2aWV3ZXJBbGVydDsKICAgIGlmICghdmlld2VyQWxlcnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmlld2VyQWxlcnQuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCBtZXNzYWdlSWQpOwogICAgaWYgKGFyZ3MpIHsKICAgICAgdmlld2VyQWxlcnQuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4tYXJncyIsIEpTT04uc3RyaW5naWZ5KGFyZ3MpKTsKICAgIH0gZWxzZSB7CiAgICAgIHZpZXdlckFsZXJ0LnJlbW92ZUF0dHJpYnV0ZSgiZGF0YS1sMTBuLWFyZ3MiKTsKICAgIH0KICB9CiAgI3NlbGVjdGlvbkNoYW5nZSgpIHsKICAgIGNvbnN0IHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpOwogICAgaWYgKCFzZWxlY3Rpb24gfHwgc2VsZWN0aW9uLmlzQ29sbGFwc2VkKSB7CiAgICAgIGlmICh0aGlzLiNzZWxlY3RlZFRleHROb2RlKSB7CiAgICAgICAgdGhpcy4jZmxvYXRpbmdUb29sYmFyPy5oaWRlKCk7CiAgICAgICAgdGhpcy4jc2VsZWN0ZWRUZXh0Tm9kZSA9IG51bGw7CiAgICAgICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICAgICAgaGFzU2VsZWN0ZWRUZXh0OiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgYW5jaG9yTm9kZQogICAgfSA9IHNlbGVjdGlvbjsKICAgIGlmIChhbmNob3JOb2RlID09PSB0aGlzLiNzZWxlY3RlZFRleHROb2RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGFuY2hvckVsZW1lbnQgPSB0aGlzLiNnZXRBbmNob3JFbGVtZW50Rm9yU2VsZWN0aW9uKHNlbGVjdGlvbik7CiAgICBjb25zdCB0ZXh0TGF5ZXIgPSBhbmNob3JFbGVtZW50LmNsb3Nlc3QoIi50ZXh0TGF5ZXIiKTsKICAgIGlmICghdGV4dExheWVyKSB7CiAgICAgIGlmICh0aGlzLiNzZWxlY3RlZFRleHROb2RlKSB7CiAgICAgICAgdGhpcy4jZmxvYXRpbmdUb29sYmFyPy5oaWRlKCk7CiAgICAgICAgdGhpcy4jc2VsZWN0ZWRUZXh0Tm9kZSA9IG51bGw7CiAgICAgICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICAgICAgaGFzU2VsZWN0ZWRUZXh0OiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2Zsb2F0aW5nVG9vbGJhcj8uaGlkZSgpOwogICAgdGhpcy4jc2VsZWN0ZWRUZXh0Tm9kZSA9IGFuY2hvck5vZGU7CiAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgIGhhc1NlbGVjdGVkVGV4dDogdHJ1ZQogICAgfSk7CiAgICBpZiAodGhpcy4jbW9kZSAhPT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hUICYmIHRoaXMuI21vZGUgIT09IEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI21vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLkhJR0hMSUdIVCkgewogICAgICB0aGlzLnNob3dBbGxFZGl0b3JzKCJoaWdobGlnaHQiLCB0cnVlLCB0cnVlKTsKICAgIH0KICAgIHRoaXMuI2hpZ2hsaWdodFdoZW5TaGlmdFVwID0gdGhpcy5pc1NoaWZ0S2V5RG93bjsKICAgIGlmICghdGhpcy5pc1NoaWZ0S2V5RG93bikgewogICAgICBjb25zdCBhY3RpdmVMYXllciA9IHRoaXMuI21vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLkhJR0hMSUdIVCA/IHRoaXMuI2dldExheWVyRm9yVGV4dExheWVyKHRleHRMYXllcikgOiBudWxsOwogICAgICBhY3RpdmVMYXllcj8udG9nZ2xlRHJhd2luZygpOwogICAgICBpZiAodGhpcy4jaXNQb2ludGVyRG93bikgewogICAgICAgIGNvbnN0IGFjID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuY29tYmluZWRTaWduYWwoYWMpOwogICAgICAgIGNvbnN0IHBvaW50ZXJ1cCA9IChlKSA9PiB7CiAgICAgICAgICBpZiAoZS50eXBlID09PSAicG9pbnRlcnVwIiAmJiBlLmJ1dHRvbiAhPT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBhYy5hYm9ydCgpOwogICAgICAgICAgYWN0aXZlTGF5ZXI/LnRvZ2dsZURyYXdpbmcodHJ1ZSk7CiAgICAgICAgICBpZiAoZS50eXBlID09PSAicG9pbnRlcnVwIikgewogICAgICAgICAgICB0aGlzLiNvblNlbGVjdEVuZCgibWFpbl90b29sYmFyIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgcG9pbnRlcnVwLCB7CiAgICAgICAgICBzaWduYWwKICAgICAgICB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIHBvaW50ZXJ1cCwgewogICAgICAgICAgc2lnbmFsCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWN0aXZlTGF5ZXI/LnRvZ2dsZURyYXdpbmcodHJ1ZSk7CiAgICAgICAgdGhpcy4jb25TZWxlY3RFbmQoIm1haW5fdG9vbGJhciIpOwogICAgICB9CiAgICB9CiAgfQogICNvblNlbGVjdEVuZChtZXRob2RPZkNyZWF0aW9uID0gIiIpIHsKICAgIGlmICh0aGlzLiNtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQpIHsKICAgICAgdGhpcy5oaWdobGlnaHRTZWxlY3Rpb24obWV0aG9kT2ZDcmVhdGlvbik7CiAgICB9IGVsc2UgaWYgKHRoaXMuI2VuYWJsZUhpZ2hsaWdodEZsb2F0aW5nQnV0dG9uKSB7CiAgICAgIHRoaXMuI2Rpc3BsYXlGbG9hdGluZ1Rvb2xiYXIoKTsKICAgIH0KICB9CiAgI2FkZFNlbGVjdGlvbkxpc3RlbmVyKCkgewogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigic2VsZWN0aW9uY2hhbmdlIiwgdGhpcy4jc2VsZWN0aW9uQ2hhbmdlLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsOiB0aGlzLl9zaWduYWwKICAgIH0pOwogIH0KICAjYWRkRm9jdXNNYW5hZ2VyKCkgewogICAgaWYgKHRoaXMuI2ZvY3VzTWFuYWdlckFDKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2ZvY3VzTWFuYWdlckFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5jb21iaW5lZFNpZ25hbCh0aGlzLiNmb2N1c01hbmFnZXJBQyk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXMiLCB0aGlzLmZvY3VzLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgdGhpcy5ibHVyLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICB9CiAgI3JlbW92ZUZvY3VzTWFuYWdlcigpIHsKICAgIHRoaXMuI2ZvY3VzTWFuYWdlckFDPy5hYm9ydCgpOwogICAgdGhpcy4jZm9jdXNNYW5hZ2VyQUMgPSBudWxsOwogIH0KICBibHVyKCkgewogICAgdGhpcy5pc1NoaWZ0S2V5RG93biA9IGZhbHNlOwogICAgaWYgKHRoaXMuI2hpZ2hsaWdodFdoZW5TaGlmdFVwKSB7CiAgICAgIHRoaXMuI2hpZ2hsaWdodFdoZW5TaGlmdFVwID0gZmFsc2U7CiAgICAgIHRoaXMuI29uU2VsZWN0RW5kKCJtYWluX3Rvb2xiYXIiKTsKICAgIH0KICAgIGlmICghdGhpcy5oYXNTZWxlY3Rpb24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBhY3RpdmVFbGVtZW50CiAgICB9ID0gZG9jdW1lbnQ7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgICAgaWYgKGVkaXRvci5kaXYuY29udGFpbnMoYWN0aXZlRWxlbWVudCkpIHsKICAgICAgICB0aGlzLiNsYXN0QWN0aXZlRWxlbWVudCA9IFtlZGl0b3IsIGFjdGl2ZUVsZW1lbnRdOwogICAgICAgIGVkaXRvci5fZm9jdXNFdmVudHNBbGxvd2VkID0gZmFsc2U7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9CiAgZm9jdXMoKSB7CiAgICBpZiAoIXRoaXMuI2xhc3RBY3RpdmVFbGVtZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IFtsYXN0RWRpdG9yLCBsYXN0QWN0aXZlRWxlbWVudF0gPSB0aGlzLiNsYXN0QWN0aXZlRWxlbWVudDsKICAgIHRoaXMuI2xhc3RBY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgIGxhc3RBY3RpdmVFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImZvY3VzaW4iLCAoKSA9PiB7CiAgICAgIGxhc3RFZGl0b3IuX2ZvY3VzRXZlbnRzQWxsb3dlZCA9IHRydWU7CiAgICB9LCB7CiAgICAgIG9uY2U6IHRydWUsCiAgICAgIHNpZ25hbDogdGhpcy5fc2lnbmFsCiAgICB9KTsKICAgIGxhc3RBY3RpdmVFbGVtZW50LmZvY3VzKCk7CiAgfQogICNhZGRLZXlib2FyZE1hbmFnZXIoKSB7CiAgICBpZiAodGhpcy4ja2V5Ym9hcmRNYW5hZ2VyQUMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4ja2V5Ym9hcmRNYW5hZ2VyQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLmNvbWJpbmVkU2lnbmFsKHRoaXMuI2tleWJvYXJkTWFuYWdlckFDKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5rZXlkb3duLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJrZXl1cCIsIHRoaXMua2V5dXAuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogIH0KICAjcmVtb3ZlS2V5Ym9hcmRNYW5hZ2VyKCkgewogICAgdGhpcy4ja2V5Ym9hcmRNYW5hZ2VyQUM/LmFib3J0KCk7CiAgICB0aGlzLiNrZXlib2FyZE1hbmFnZXJBQyA9IG51bGw7CiAgfQogICNhZGRDb3B5UGFzdGVMaXN0ZW5lcnMoKSB7CiAgICBpZiAodGhpcy4jY29weVBhc3RlQUMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29weVBhc3RlQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLmNvbWJpbmVkU2lnbmFsKHRoaXMuI2NvcHlQYXN0ZUFDKTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNvcHkiLCB0aGlzLmNvcHkuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY3V0IiwgdGhpcy5jdXQuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicGFzdGUiLCB0aGlzLnBhc3RlLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICB9CiAgI3JlbW92ZUNvcHlQYXN0ZUxpc3RlbmVycygpIHsKICAgIHRoaXMuI2NvcHlQYXN0ZUFDPy5hYm9ydCgpOwogICAgdGhpcy4jY29weVBhc3RlQUMgPSBudWxsOwogIH0KICAjYWRkRHJhZ0FuZERyb3BMaXN0ZW5lcnMoKSB7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLl9zaWduYWw7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJkcmFnb3ZlciIsIHRoaXMuZHJhZ092ZXIuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZHJvcCIsIHRoaXMuZHJvcC5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgfQogIGFkZEVkaXRMaXN0ZW5lcnMoKSB7CiAgICB0aGlzLiNhZGRLZXlib2FyZE1hbmFnZXIoKTsKICAgIHRoaXMuc2V0RWRpdGluZ1N0YXRlKHRydWUpOwogIH0KICByZW1vdmVFZGl0TGlzdGVuZXJzKCkgewogICAgdGhpcy4jcmVtb3ZlS2V5Ym9hcmRNYW5hZ2VyKCk7CiAgICB0aGlzLnNldEVkaXRpbmdTdGF0ZShmYWxzZSk7CiAgfQogIGRyYWdPdmVyKGV2ZW50KSB7CiAgICBmb3IgKGNvbnN0IHsKICAgICAgdHlwZQogICAgfSBvZiBldmVudC5kYXRhVHJhbnNmZXIuaXRlbXMpIHsKICAgICAgZm9yIChjb25zdCBlZGl0b3JUeXBlIG9mIHRoaXMuI2VkaXRvclR5cGVzKSB7CiAgICAgICAgaWYgKGVkaXRvclR5cGUuaXNIYW5kbGluZ01pbWVGb3JQYXN0aW5nKHR5cGUpKSB7CiAgICAgICAgICBldmVudC5kYXRhVHJhbnNmZXIuZHJvcEVmZmVjdCA9ICJjb3B5IjsKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGRyb3AoZXZlbnQpIHsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBldmVudC5kYXRhVHJhbnNmZXIuaXRlbXMpIHsKICAgICAgZm9yIChjb25zdCBlZGl0b3JUeXBlIG9mIHRoaXMuI2VkaXRvclR5cGVzKSB7CiAgICAgICAgaWYgKGVkaXRvclR5cGUuaXNIYW5kbGluZ01pbWVGb3JQYXN0aW5nKGl0ZW0udHlwZSkpIHsKICAgICAgICAgIGVkaXRvclR5cGUucGFzdGUoaXRlbSwgdGhpcy5jdXJyZW50TGF5ZXIpOwogICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgY29weShldmVudCkgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuI2FjdGl2ZUVkaXRvcj8uY29tbWl0T3JSZW1vdmUoKTsKICAgIGlmICghdGhpcy5oYXNTZWxlY3Rpb24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgZWRpdG9ycyA9IFtdOwogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzKSB7CiAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBlZGl0b3Iuc2VyaWFsaXplKHRydWUpOwogICAgICBpZiAoc2VyaWFsaXplZCkgewogICAgICAgIGVkaXRvcnMucHVzaChzZXJpYWxpemVkKTsKICAgICAgfQogICAgfQogICAgaWYgKGVkaXRvcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGV2ZW50LmNsaXBib2FyZERhdGEuc2V0RGF0YSgiYXBwbGljYXRpb24vcGRmanMiLCBKU09OLnN0cmluZ2lmeShlZGl0b3JzKSk7CiAgfQogIGN1dChldmVudCkgewogICAgdGhpcy5jb3B5KGV2ZW50KTsKICAgIHRoaXMuZGVsZXRlKCk7CiAgfQogIGFzeW5jIHBhc3RlKGV2ZW50KSB7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgY29uc3QgewogICAgICBjbGlwYm9hcmREYXRhCiAgICB9ID0gZXZlbnQ7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgY2xpcGJvYXJkRGF0YS5pdGVtcykgewogICAgICBmb3IgKGNvbnN0IGVkaXRvclR5cGUgb2YgdGhpcy4jZWRpdG9yVHlwZXMpIHsKICAgICAgICBpZiAoZWRpdG9yVHlwZS5pc0hhbmRsaW5nTWltZUZvclBhc3RpbmcoaXRlbS50eXBlKSkgewogICAgICAgICAgZWRpdG9yVHlwZS5wYXN0ZShpdGVtLCB0aGlzLmN1cnJlbnRMYXllcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBsZXQgZGF0YSA9IGNsaXBib2FyZERhdGEuZ2V0RGF0YSgiYXBwbGljYXRpb24vcGRmanMiKTsKICAgIGlmICghZGF0YSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0cnkgewogICAgICBkYXRhID0gSlNPTi5wYXJzZShkYXRhKTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIHdhcm4oYHBhc3RlOiAiJHtleC5tZXNzYWdlfSIuYCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghQXJyYXkuaXNBcnJheShkYXRhKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnVuc2VsZWN0QWxsKCk7CiAgICBjb25zdCBsYXllciA9IHRoaXMuY3VycmVudExheWVyOwogICAgdHJ5IHsKICAgICAgY29uc3QgbmV3RWRpdG9ycyA9IFtdOwogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBkYXRhKSB7CiAgICAgICAgY29uc3QgZGVzZXJpYWxpemVkRWRpdG9yID0gYXdhaXQgbGF5ZXIuZGVzZXJpYWxpemUoZWRpdG9yKTsKICAgICAgICBpZiAoIWRlc2VyaWFsaXplZEVkaXRvcikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBuZXdFZGl0b3JzLnB1c2goZGVzZXJpYWxpemVkRWRpdG9yKTsKICAgICAgfQogICAgICBjb25zdCBjbWQgPSAoKSA9PiB7CiAgICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgbmV3RWRpdG9ycykgewogICAgICAgICAgdGhpcy4jYWRkRWRpdG9yVG9MYXllcihlZGl0b3IpOwogICAgICAgIH0KICAgICAgICB0aGlzLiNzZWxlY3RFZGl0b3JzKG5ld0VkaXRvcnMpOwogICAgICB9OwogICAgICBjb25zdCB1bmRvID0gKCkgPT4gewogICAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIG5ld0VkaXRvcnMpIHsKICAgICAgICAgIGVkaXRvci5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICAgIGNtZCwKICAgICAgICB1bmRvLAogICAgICAgIG11c3RFeGVjOiB0cnVlCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgd2FybihgcGFzdGU6ICIke2V4Lm1lc3NhZ2V9Ii5gKTsKICAgIH0KICB9CiAga2V5ZG93bihldmVudCkgewogICAgaWYgKCF0aGlzLmlzU2hpZnRLZXlEb3duICYmIGV2ZW50LmtleSA9PT0gIlNoaWZ0IikgewogICAgICB0aGlzLmlzU2hpZnRLZXlEb3duID0gdHJ1ZTsKICAgIH0KICAgIGlmICh0aGlzLiNtb2RlICE9PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5OT05FICYmICF0aGlzLmlzRWRpdG9ySGFuZGxpbmdLZXlib2FyZCkgewogICAgICBfQW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlci5fa2V5Ym9hcmRNYW5hZ2VyLmV4ZWModGhpcywgZXZlbnQpOwogICAgfQogIH0KICBrZXl1cChldmVudCkgewogICAgaWYgKHRoaXMuaXNTaGlmdEtleURvd24gJiYgZXZlbnQua2V5ID09PSAiU2hpZnQiKSB7CiAgICAgIHRoaXMuaXNTaGlmdEtleURvd24gPSBmYWxzZTsKICAgICAgaWYgKHRoaXMuI2hpZ2hsaWdodFdoZW5TaGlmdFVwKSB7CiAgICAgICAgdGhpcy4jaGlnaGxpZ2h0V2hlblNoaWZ0VXAgPSBmYWxzZTsKICAgICAgICB0aGlzLiNvblNlbGVjdEVuZCgibWFpbl90b29sYmFyIik7CiAgICAgIH0KICAgIH0KICB9CiAgb25FZGl0aW5nQWN0aW9uKHsKICAgIG5hbWUKICB9KSB7CiAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgY2FzZSAidW5kbyI6CiAgICAgIGNhc2UgInJlZG8iOgogICAgICBjYXNlICJkZWxldGUiOgogICAgICBjYXNlICJzZWxlY3RBbGwiOgogICAgICAgIHRoaXNbbmFtZV0oKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiaGlnaGxpZ2h0U2VsZWN0aW9uIjoKICAgICAgICB0aGlzLmhpZ2hsaWdodFNlbGVjdGlvbigiY29udGV4dF9tZW51Iik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImNvbW1lbnRTZWxlY3Rpb24iOgogICAgICAgIHRoaXMuY29tbWVudFNlbGVjdGlvbigiY29udGV4dF9tZW51Iik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogICNkaXNwYXRjaFVwZGF0ZVN0YXRlcyhkZXRhaWxzKSB7CiAgICBjb25zdCBoYXNDaGFuZ2VkID0gT2JqZWN0LmVudHJpZXMoZGV0YWlscykuc29tZSgoW2tleSwgdmFsdWVdKSA9PiB0aGlzLiNwcmV2aW91c1N0YXRlc1trZXldICE9PSB2YWx1ZSk7CiAgICBpZiAoaGFzQ2hhbmdlZCkgewogICAgICB0aGlzLl9ldmVudEJ1cy5kaXNwYXRjaCgiYW5ub3RhdGlvbmVkaXRvcnN0YXRlc2NoYW5nZWQiLCB7CiAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgIGRldGFpbHM6IE9iamVjdC5hc3NpZ24odGhpcy4jcHJldmlvdXNTdGF0ZXMsIGRldGFpbHMpCiAgICAgIH0pOwogICAgICBpZiAodGhpcy4jbW9kZSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hUICYmIGRldGFpbHMuaGFzU2VsZWN0ZWRFZGl0b3IgPT09IGZhbHNlKSB7CiAgICAgICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVVSShbW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9GUkVFLCB0cnVlXV0pOwogICAgICB9CiAgICB9CiAgfQogICNkaXNwYXRjaFVwZGF0ZVVJKGRldGFpbHMpIHsKICAgIHRoaXMuX2V2ZW50QnVzLmRpc3BhdGNoKCJhbm5vdGF0aW9uZWRpdG9ycGFyYW1zY2hhbmdlZCIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICBkZXRhaWxzCiAgICB9KTsKICB9CiAgc2V0RWRpdGluZ1N0YXRlKGlzRWRpdGluZykgewogICAgaWYgKGlzRWRpdGluZykgewogICAgICB0aGlzLiNhZGRGb2N1c01hbmFnZXIoKTsKICAgICAgdGhpcy4jYWRkQ29weVBhc3RlTGlzdGVuZXJzKCk7CiAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgICBpc0VkaXRpbmc6IHRoaXMuI21vZGUgIT09IEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkUsCiAgICAgICAgaXNFbXB0eTogdGhpcy4jaXNFbXB0eSgpLAogICAgICAgIGhhc1NvbWV0aGluZ1RvVW5kbzogdGhpcy4jY29tbWFuZE1hbmFnZXIuaGFzU29tZXRoaW5nVG9VbmRvKCksCiAgICAgICAgaGFzU29tZXRoaW5nVG9SZWRvOiB0aGlzLiNjb21tYW5kTWFuYWdlci5oYXNTb21ldGhpbmdUb1JlZG8oKSwKICAgICAgICBoYXNTZWxlY3RlZEVkaXRvcjogZmFsc2UKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNyZW1vdmVGb2N1c01hbmFnZXIoKTsKICAgICAgdGhpcy4jcmVtb3ZlQ29weVBhc3RlTGlzdGVuZXJzKCk7CiAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgICBpc0VkaXRpbmc6IGZhbHNlCiAgICAgIH0pOwogICAgICB0aGlzLmRpc2FibGVVc2VyU2VsZWN0KGZhbHNlKTsKICAgIH0KICB9CiAgcmVnaXN0ZXJFZGl0b3JUeXBlcyh0eXBlcykgewogICAgaWYgKHRoaXMuI2VkaXRvclR5cGVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2VkaXRvclR5cGVzID0gdHlwZXM7CiAgICBmb3IgKGNvbnN0IGVkaXRvclR5cGUgb2YgdGhpcy4jZWRpdG9yVHlwZXMpIHsKICAgICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVVSShlZGl0b3JUeXBlLmRlZmF1bHRQcm9wZXJ0aWVzVG9VcGRhdGUpOwogICAgfQogIH0KICBnZXRJZCgpIHsKICAgIHJldHVybiB0aGlzLiNpZE1hbmFnZXIuaWQ7CiAgfQogIGdldCBjdXJyZW50TGF5ZXIoKSB7CiAgICByZXR1cm4gdGhpcy4jYWxsTGF5ZXJzLmdldCh0aGlzLiNjdXJyZW50UGFnZUluZGV4KTsKICB9CiAgZ2V0TGF5ZXIocGFnZUluZGV4KSB7CiAgICByZXR1cm4gdGhpcy4jYWxsTGF5ZXJzLmdldChwYWdlSW5kZXgpOwogIH0KICBnZXQgY3VycmVudFBhZ2VJbmRleCgpIHsKICAgIHJldHVybiB0aGlzLiNjdXJyZW50UGFnZUluZGV4OwogIH0KICBhZGRMYXllcihsYXllcikgewogICAgdGhpcy4jYWxsTGF5ZXJzLnNldChsYXllci5wYWdlSW5kZXgsIGxheWVyKTsKICAgIGlmICh0aGlzLiNpc0VuYWJsZWQpIHsKICAgICAgbGF5ZXIuZW5hYmxlKCk7CiAgICB9IGVsc2UgewogICAgICBsYXllci5kaXNhYmxlKCk7CiAgICB9CiAgfQogIHJlbW92ZUxheWVyKGxheWVyKSB7CiAgICB0aGlzLiNhbGxMYXllcnMuZGVsZXRlKGxheWVyLnBhZ2VJbmRleCk7CiAgfQogIGFzeW5jIHVwZGF0ZU1vZGUobW9kZSwgZWRpdElkID0gbnVsbCwgaXNGcm9tVXNlciA9IGZhbHNlLCBpc0Zyb21LZXlib2FyZCA9IGZhbHNlLCBtdXN0RW50ZXJJbkVkaXRNb2RlID0gZmFsc2UsIGVkaXRDb21tZW50ID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLiNtb2RlID09PSBtb2RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiN1cGRhdGVNb2RlQ2FwYWJpbGl0eSkgewogICAgICBhd2FpdCB0aGlzLiN1cGRhdGVNb2RlQ2FwYWJpbGl0eS5wcm9taXNlOwogICAgICBpZiAoIXRoaXMuI3VwZGF0ZU1vZGVDYXBhYmlsaXR5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICB0aGlzLiN1cGRhdGVNb2RlQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy4jY3VycmVudERyYXdpbmdTZXNzaW9uPy5jb21taXRPclJlbW92ZSgpOwogICAgaWYgKHRoaXMuI21vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLlBPUFVQKSB7CiAgICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy5oaWRlU2lkZWJhcigpOwogICAgfQogICAgdGhpcy4jY29tbWVudE1hbmFnZXI/LmRlc3Ryb3lQb3B1cCgpOwogICAgdGhpcy4jbW9kZSA9IG1vZGU7CiAgICBpZiAobW9kZSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORSkgewogICAgICB0aGlzLnNldEVkaXRpbmdTdGF0ZShmYWxzZSk7CiAgICAgIHRoaXMuI2Rpc2FibGVBbGwoKTsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9ycy52YWx1ZXMoKSkgewogICAgICAgIGVkaXRvci5oaWRlU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKTsKICAgICAgfQogICAgICB0aGlzLl9lZGl0b3JVbmRvQmFyPy5oaWRlKCk7CiAgICAgIHRoaXMudG9nZ2xlQ29tbWVudChudWxsKTsKICAgICAgdGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgIGVkaXRvci5hZGRTdGFuZGFsb25lQ29tbWVudEJ1dHRvbigpOwogICAgfQogICAgaWYgKG1vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLlNJR05BVFVSRSkgewogICAgICBhd2FpdCB0aGlzLiNzaWduYXR1cmVNYW5hZ2VyPy5sb2FkU2lnbmF0dXJlcygpOwogICAgfQogICAgaWYgKGlzRnJvbVVzZXIpIHsKICAgICAgQ3VycmVudFBvaW50ZXJzLmNsZWFyUG9pbnRlclR5cGUoKTsKICAgIH0KICAgIHRoaXMuc2V0RWRpdGluZ1N0YXRlKHRydWUpOwogICAgYXdhaXQgdGhpcy4jZW5hYmxlQWxsKCk7CiAgICB0aGlzLnVuc2VsZWN0QWxsKCk7CiAgICBmb3IgKGNvbnN0IGxheWVyIG9mIHRoaXMuI2FsbExheWVycy52YWx1ZXMoKSkgewogICAgICBsYXllci51cGRhdGVNb2RlKG1vZGUpOwogICAgfQogICAgaWYgKG1vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLlBPUFVQKSB7CiAgICAgIHRoaXMuI2FsbEVkaXRhYmxlQW5ub3RhdGlvbnMgfHw9IGF3YWl0IHRoaXMuI3BkZkRvY3VtZW50LmdldEFubm90YXRpb25zQnlUeXBlKG5ldyBTZXQodGhpcy4jZWRpdG9yVHlwZXMubWFwKChlZGl0b3JDbGFzcykgPT4gZWRpdG9yQ2xhc3MuX2VkaXRvclR5cGUpKSk7CiAgICAgIGNvbnN0IGVsZW1lbnRJZHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICBjb25zdCBhbGxDb21tZW50cyA9IFtdOwogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgYW5ub3RhdGlvbkVsZW1lbnRJZCwKICAgICAgICAgIGhhc0NvbW1lbnQsCiAgICAgICAgICBkZWxldGVkCiAgICAgICAgfSA9IGVkaXRvcjsKICAgICAgICBpZiAoYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICAgICAgZWxlbWVudElkcy5hZGQoYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNDb21tZW50ICYmICFkZWxldGVkKSB7CiAgICAgICAgICBhbGxDb21tZW50cy5wdXNoKGVkaXRvci5nZXREYXRhKCkpOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKGNvbnN0IGFubm90YXRpb24gb2YgdGhpcy4jYWxsRWRpdGFibGVBbm5vdGF0aW9ucykgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGlkLAogICAgICAgICAgcG9wdXBSZWYsCiAgICAgICAgICBjb250ZW50c09iagogICAgICAgIH0gPSBhbm5vdGF0aW9uOwogICAgICAgIGlmIChwb3B1cFJlZiAmJiBjb250ZW50c09iaj8uc3RyICYmICFlbGVtZW50SWRzLmhhcyhpZCkgJiYgIXRoaXMuI2RlbGV0ZWRBbm5vdGF0aW9uc0VsZW1lbnRJZHMuaGFzKGlkKSkgewogICAgICAgICAgYWxsQ29tbWVudHMucHVzaChhbm5vdGF0aW9uKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy4jY29tbWVudE1hbmFnZXI/LnNob3dTaWRlYmFyKGFsbENvbW1lbnRzKTsKICAgIH0KICAgIGlmICghZWRpdElkKSB7CiAgICAgIGlmIChpc0Zyb21LZXlib2FyZCkgewogICAgICAgIHRoaXMuYWRkTmV3RWRpdG9yRnJvbUtleWJvYXJkKCk7CiAgICAgIH0KICAgICAgdGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgIGlmIChlZGl0b3IudWlkID09PSBlZGl0SWQpIHsKICAgICAgICB0aGlzLnNldFNlbGVjdGVkKGVkaXRvcik7CiAgICAgICAgaWYgKGVkaXRDb21tZW50KSB7CiAgICAgICAgICBlZGl0b3IuZWRpdENvbW1lbnQoKTsKICAgICAgICB9IGVsc2UgaWYgKG11c3RFbnRlckluRWRpdE1vZGUpIHsKICAgICAgICAgIGVkaXRvci5lbnRlckluRWRpdE1vZGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWRpdG9yLmZvY3VzKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGVkaXRvci51bnNlbGVjdCgpOwogICAgICB9CiAgICB9CiAgICB0aGlzLiN1cGRhdGVNb2RlQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgfQogIGFkZE5ld0VkaXRvckZyb21LZXlib2FyZCgpIHsKICAgIGlmICh0aGlzLmN1cnJlbnRMYXllci5jYW5DcmVhdGVOZXdFbXB0eUVkaXRvcigpKSB7CiAgICAgIHRoaXMuY3VycmVudExheWVyLmFkZE5ld0VkaXRvcigpOwogICAgfQogIH0KICB1cGRhdGVUb29sYmFyKG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLm1vZGUgPT09IHRoaXMuI21vZGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goInN3aXRjaGFubm90YXRpb25lZGl0b3Jtb2RlIiwgewogICAgICBzb3VyY2U6IHRoaXMsCiAgICAgIC4uLm9wdGlvbnMKICAgIH0pOwogIH0KICB1cGRhdGVQYXJhbXModHlwZSwgdmFsdWUpIHsKICAgIGlmICghdGhpcy4jZWRpdG9yVHlwZXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuQ1JFQVRFOgogICAgICAgIHRoaXMuY3VycmVudExheWVyLmFkZE5ld0VkaXRvcih2YWx1ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICBjYXNlIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9TSE9XX0FMTDoKICAgICAgICB0aGlzLl9ldmVudEJ1cy5kaXNwYXRjaCgicmVwb3J0dGVsZW1ldHJ5IiwgewogICAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgICAgZGV0YWlsczogewogICAgICAgICAgICB0eXBlOiAiZWRpdGluZyIsCiAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICB0eXBlOiAiaGlnaGxpZ2h0IiwKICAgICAgICAgICAgICBhY3Rpb246ICJ0b2dnbGVfdmlzaWJpbGl0eSIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgICh0aGlzLiNzaG93QWxsU3RhdGVzIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKS5zZXQodHlwZSwgdmFsdWUpOwogICAgICAgIHRoaXMuc2hvd0FsbEVkaXRvcnMoImhpZ2hsaWdodCIsIHZhbHVlKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGlmICh0aGlzLmhhc1NlbGVjdGlvbikgewogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgICAgICBlZGl0b3IudXBkYXRlUGFyYW1zKHR5cGUsIHZhbHVlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBlZGl0b3JUeXBlIG9mIHRoaXMuI2VkaXRvclR5cGVzKSB7CiAgICAgICAgZWRpdG9yVHlwZS51cGRhdGVEZWZhdWx0UGFyYW1zKHR5cGUsIHZhbHVlKTsKICAgICAgfQogICAgfQogIH0KICBzaG93QWxsRWRpdG9ycyh0eXBlLCB2aXNpYmxlLCB1cGRhdGVCdXR0b24gPSBmYWxzZSkgewogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9ycy52YWx1ZXMoKSkgewogICAgICBpZiAoZWRpdG9yLmVkaXRvclR5cGUgPT09IHR5cGUpIHsKICAgICAgICBlZGl0b3Iuc2hvdyh2aXNpYmxlKTsKICAgICAgfQogICAgfQogICAgY29uc3Qgc3RhdGUgPSB0aGlzLiNzaG93QWxsU3RhdGVzPy5nZXQoQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX1NIT1dfQUxMKSA/PyB0cnVlOwogICAgaWYgKHN0YXRlICE9PSB2aXNpYmxlKSB7CiAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlVUkoW1tBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfU0hPV19BTEwsIHZpc2libGVdXSk7CiAgICB9CiAgfQogIGVuYWJsZVdhaXRpbmcobXVzdFdhaXQgPSBmYWxzZSkgewogICAgaWYgKHRoaXMuI2lzV2FpdGluZyA9PT0gbXVzdFdhaXQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jaXNXYWl0aW5nID0gbXVzdFdhaXQ7CiAgICBmb3IgKGNvbnN0IGxheWVyIG9mIHRoaXMuI2FsbExheWVycy52YWx1ZXMoKSkgewogICAgICBpZiAobXVzdFdhaXQpIHsKICAgICAgICBsYXllci5kaXNhYmxlQ2xpY2soKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsYXllci5lbmFibGVDbGljaygpOwogICAgICB9CiAgICAgIGxheWVyLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJ3YWl0aW5nIiwgbXVzdFdhaXQpOwogICAgfQogIH0KICBhc3luYyAjZW5hYmxlQWxsKCkgewogICAgaWYgKCF0aGlzLiNpc0VuYWJsZWQpIHsKICAgICAgdGhpcy4jaXNFbmFibGVkID0gdHJ1ZTsKICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXTsKICAgICAgZm9yIChjb25zdCBsYXllciBvZiB0aGlzLiNhbGxMYXllcnMudmFsdWVzKCkpIHsKICAgICAgICBwcm9taXNlcy5wdXNoKGxheWVyLmVuYWJsZSgpKTsKICAgICAgfQogICAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2FsbEVkaXRvcnMudmFsdWVzKCkpIHsKICAgICAgICBlZGl0b3IuZW5hYmxlKCk7CiAgICAgIH0KICAgIH0KICB9CiAgI2Rpc2FibGVBbGwoKSB7CiAgICB0aGlzLnVuc2VsZWN0QWxsKCk7CiAgICBpZiAodGhpcy4jaXNFbmFibGVkKSB7CiAgICAgIHRoaXMuI2lzRW5hYmxlZCA9IGZhbHNlOwogICAgICBmb3IgKGNvbnN0IGxheWVyIG9mIHRoaXMuI2FsbExheWVycy52YWx1ZXMoKSkgewogICAgICAgIGxheWVyLmRpc2FibGUoKTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgICAgZWRpdG9yLmRpc2FibGUoKTsKICAgICAgfQogICAgfQogIH0KICAqZ2V0RWRpdG9ycyhwYWdlSW5kZXgpIHsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2FsbEVkaXRvcnMudmFsdWVzKCkpIHsKICAgICAgaWYgKGVkaXRvci5wYWdlSW5kZXggPT09IHBhZ2VJbmRleCkgewogICAgICAgIHlpZWxkIGVkaXRvcjsKICAgICAgfQogICAgfQogIH0KICBnZXRFZGl0b3IoaWQpIHsKICAgIHJldHVybiB0aGlzLiNhbGxFZGl0b3JzLmdldChpZCk7CiAgfQogIGFkZEVkaXRvcihlZGl0b3IpIHsKICAgIHRoaXMuI2FsbEVkaXRvcnMuc2V0KGVkaXRvci5pZCwgZWRpdG9yKTsKICB9CiAgcmVtb3ZlRWRpdG9yKGVkaXRvcikgewogICAgaWYgKGVkaXRvci5kaXYuY29udGFpbnMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkpIHsKICAgICAgaWYgKHRoaXMuI2ZvY3VzTWFpbkNvbnRhaW5lclRpbWVvdXRJZCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLiNmb2N1c01haW5Db250YWluZXJUaW1lb3V0SWQpOwogICAgICB9CiAgICAgIHRoaXMuI2ZvY3VzTWFpbkNvbnRhaW5lclRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuZm9jdXNNYWluQ29udGFpbmVyKCk7CiAgICAgICAgdGhpcy4jZm9jdXNNYWluQ29udGFpbmVyVGltZW91dElkID0gbnVsbDsKICAgICAgfSwgMCk7CiAgICB9CiAgICB0aGlzLiNhbGxFZGl0b3JzLmRlbGV0ZShlZGl0b3IuaWQpOwogICAgaWYgKGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIHRoaXMuI21pc3NpbmdDYW52YXNlcz8uZGVsZXRlKGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKTsKICAgIH0KICAgIHRoaXMudW5zZWxlY3QoZWRpdG9yKTsKICAgIGlmICghZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQgfHwgIXRoaXMuI2RlbGV0ZWRBbm5vdGF0aW9uc0VsZW1lbnRJZHMuaGFzKGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKSkgewogICAgICB0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZT8ucmVtb3ZlKGVkaXRvci5pZCk7CiAgICB9CiAgfQogIGFkZERlbGV0ZWRBbm5vdGF0aW9uRWxlbWVudChlZGl0b3IpIHsKICAgIHRoaXMuI2RlbGV0ZWRBbm5vdGF0aW9uc0VsZW1lbnRJZHMuYWRkKGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKTsKICAgIHRoaXMuYWRkQ2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbihlZGl0b3IpOwogICAgZWRpdG9yLmRlbGV0ZWQgPSB0cnVlOwogIH0KICBpc0RlbGV0ZWRBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICByZXR1cm4gdGhpcy4jZGVsZXRlZEFubm90YXRpb25zRWxlbWVudElkcy5oYXMoYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgfQogIHJlbW92ZURlbGV0ZWRBbm5vdGF0aW9uRWxlbWVudChlZGl0b3IpIHsKICAgIHRoaXMuI2RlbGV0ZWRBbm5vdGF0aW9uc0VsZW1lbnRJZHMuZGVsZXRlKGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKTsKICAgIHRoaXMucmVtb3ZlQ2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbihlZGl0b3IpOwogICAgZWRpdG9yLmRlbGV0ZWQgPSBmYWxzZTsKICB9CiAgI2FkZEVkaXRvclRvTGF5ZXIoZWRpdG9yKSB7CiAgICBjb25zdCBsYXllciA9IHRoaXMuI2FsbExheWVycy5nZXQoZWRpdG9yLnBhZ2VJbmRleCk7CiAgICBpZiAobGF5ZXIpIHsKICAgICAgbGF5ZXIuYWRkT3JSZWJ1aWxkKGVkaXRvcik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmFkZEVkaXRvcihlZGl0b3IpOwogICAgICB0aGlzLmFkZFRvQW5ub3RhdGlvblN0b3JhZ2UoZWRpdG9yKTsKICAgIH0KICB9CiAgc2V0QWN0aXZlRWRpdG9yKGVkaXRvcikgewogICAgaWYgKHRoaXMuI2FjdGl2ZUVkaXRvciA9PT0gZWRpdG9yKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FjdGl2ZUVkaXRvciA9IGVkaXRvcjsKICAgIGlmIChlZGl0b3IpIHsKICAgICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVVSShlZGl0b3IucHJvcGVydGllc1RvVXBkYXRlKTsKICAgIH0KICB9CiAgZ2V0ICNsYXN0U2VsZWN0ZWRFZGl0b3IoKSB7CiAgICBsZXQgZWQgPSBudWxsOwogICAgZm9yIChlZCBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgIH0KICAgIHJldHVybiBlZDsKICB9CiAgdXBkYXRlVUkoZWRpdG9yKSB7CiAgICBpZiAodGhpcy4jbGFzdFNlbGVjdGVkRWRpdG9yID09PSBlZGl0b3IpIHsKICAgICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVVSShlZGl0b3IucHJvcGVydGllc1RvVXBkYXRlKTsKICAgIH0KICB9CiAgdXBkYXRlVUlGb3JEZWZhdWx0UHJvcGVydGllcyhlZGl0b3JUeXBlKSB7CiAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVVJKGVkaXRvclR5cGUuZGVmYXVsdFByb3BlcnRpZXNUb1VwZGF0ZSk7CiAgfQogIHRvZ2dsZVNlbGVjdGVkKGVkaXRvcikgewogICAgaWYgKHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5oYXMoZWRpdG9yKSkgewogICAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuZGVsZXRlKGVkaXRvcik7CiAgICAgIGVkaXRvci51bnNlbGVjdCgpOwogICAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgICAgaGFzU2VsZWN0ZWRFZGl0b3I6IHRoaXMuaGFzU2VsZWN0aW9uCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuYWRkKGVkaXRvcik7CiAgICBlZGl0b3Iuc2VsZWN0KCk7CiAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVVJKGVkaXRvci5wcm9wZXJ0aWVzVG9VcGRhdGUpOwogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICBoYXNTZWxlY3RlZEVkaXRvcjogdHJ1ZQogICAgfSk7CiAgfQogIHNldFNlbGVjdGVkKGVkaXRvcikgewogICAgdGhpcy51cGRhdGVUb29sYmFyKHsKICAgICAgbW9kZTogZWRpdG9yLm1vZGUsCiAgICAgIGVkaXRJZDogZWRpdG9yLnVpZAogICAgfSk7CiAgICB0aGlzLiNjdXJyZW50RHJhd2luZ1Nlc3Npb24/LmNvbW1pdE9yUmVtb3ZlKCk7CiAgICBmb3IgKGNvbnN0IGVkIG9mIHRoaXMuI3NlbGVjdGVkRWRpdG9ycykgewogICAgICBpZiAoZWQgIT09IGVkaXRvcikgewogICAgICAgIGVkLnVuc2VsZWN0KCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5jbGVhcigpOwogICAgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzLmFkZChlZGl0b3IpOwogICAgZWRpdG9yLnNlbGVjdCgpOwogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVVSShlZGl0b3IucHJvcGVydGllc1RvVXBkYXRlKTsKICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgaGFzU2VsZWN0ZWRFZGl0b3I6IHRydWUKICAgIH0pOwogIH0KICBpc1NlbGVjdGVkKGVkaXRvcikgewogICAgcmV0dXJuIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5oYXMoZWRpdG9yKTsKICB9CiAgZ2V0IGZpcnN0U2VsZWN0ZWRFZGl0b3IoKSB7CiAgICByZXR1cm4gdGhpcy4jc2VsZWN0ZWRFZGl0b3JzLnZhbHVlcygpLm5leHQoKS52YWx1ZTsKICB9CiAgdW5zZWxlY3QoZWRpdG9yKSB7CiAgICBlZGl0b3IudW5zZWxlY3QoKTsKICAgIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5kZWxldGUoZWRpdG9yKTsKICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgaGFzU2VsZWN0ZWRFZGl0b3I6IHRoaXMuaGFzU2VsZWN0aW9uCiAgICB9KTsKICB9CiAgZ2V0IGhhc1NlbGVjdGlvbigpIHsKICAgIHJldHVybiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuc2l6ZSAhPT0gMDsKICB9CiAgZ2V0IGlzRW50ZXJIYW5kbGVkKCkgewogICAgcmV0dXJuIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5zaXplID09PSAxICYmIHRoaXMuZmlyc3RTZWxlY3RlZEVkaXRvci5pc0VudGVySGFuZGxlZDsKICB9CiAgdW5kbygpIHsKICAgIHRoaXMuI2NvbW1hbmRNYW5hZ2VyLnVuZG8oKTsKICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgaGFzU29tZXRoaW5nVG9VbmRvOiB0aGlzLiNjb21tYW5kTWFuYWdlci5oYXNTb21ldGhpbmdUb1VuZG8oKSwKICAgICAgaGFzU29tZXRoaW5nVG9SZWRvOiB0cnVlLAogICAgICBpc0VtcHR5OiB0aGlzLiNpc0VtcHR5KCkKICAgIH0pOwogICAgdGhpcy5fZWRpdG9yVW5kb0Jhcj8uaGlkZSgpOwogIH0KICByZWRvKCkgewogICAgdGhpcy4jY29tbWFuZE1hbmFnZXIucmVkbygpOwogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICBoYXNTb21ldGhpbmdUb1VuZG86IHRydWUsCiAgICAgIGhhc1NvbWV0aGluZ1RvUmVkbzogdGhpcy4jY29tbWFuZE1hbmFnZXIuaGFzU29tZXRoaW5nVG9SZWRvKCksCiAgICAgIGlzRW1wdHk6IHRoaXMuI2lzRW1wdHkoKQogICAgfSk7CiAgfQogIGFkZENvbW1hbmRzKHBhcmFtcykgewogICAgdGhpcy4jY29tbWFuZE1hbmFnZXIuYWRkKHBhcmFtcyk7CiAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgIGhhc1NvbWV0aGluZ1RvVW5kbzogdHJ1ZSwKICAgICAgaGFzU29tZXRoaW5nVG9SZWRvOiBmYWxzZSwKICAgICAgaXNFbXB0eTogdGhpcy4jaXNFbXB0eSgpCiAgICB9KTsKICB9CiAgY2xlYW5VbmRvU3RhY2sodHlwZSkgewogICAgdGhpcy4jY29tbWFuZE1hbmFnZXIuY2xlYW5UeXBlKHR5cGUpOwogIH0KICAjaXNFbXB0eSgpIHsKICAgIGlmICh0aGlzLiNhbGxFZGl0b3JzLnNpemUgPT09IDApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAodGhpcy4jYWxsRWRpdG9ycy5zaXplID09PSAxKSB7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2FsbEVkaXRvcnMudmFsdWVzKCkpIHsKICAgICAgICByZXR1cm4gZWRpdG9yLmlzRW1wdHkoKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBkZWxldGUoKSB7CiAgICB0aGlzLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICBjb25zdCBkcmF3aW5nRWRpdG9yID0gdGhpcy5jdXJyZW50TGF5ZXI/LmVuZERyYXdpbmdTZXNzaW9uKHRydWUpOwogICAgaWYgKCF0aGlzLmhhc1NlbGVjdGlvbiAmJiAhZHJhd2luZ0VkaXRvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBlZGl0b3JzID0gZHJhd2luZ0VkaXRvciA/IFtkcmF3aW5nRWRpdG9yXSA6IFsuLi50aGlzLiNzZWxlY3RlZEVkaXRvcnNdOwogICAgY29uc3QgY21kID0gKCkgPT4gewogICAgICB0aGlzLl9lZGl0b3JVbmRvQmFyPy5zaG93KHVuZG8sIGVkaXRvcnMubGVuZ3RoID09PSAxID8gZWRpdG9yc1swXS5lZGl0b3JUeXBlIDogZWRpdG9ycy5sZW5ndGgpOwogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBlZGl0b3JzKSB7CiAgICAgICAgZWRpdG9yLnJlbW92ZSgpOwogICAgICB9CiAgICB9OwogICAgY29uc3QgdW5kbyA9ICgpID0+IHsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgZWRpdG9ycykgewogICAgICAgIHRoaXMuI2FkZEVkaXRvclRvTGF5ZXIoZWRpdG9yKTsKICAgICAgfQogICAgfTsKICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICBjbWQsCiAgICAgIHVuZG8sCiAgICAgIG11c3RFeGVjOiB0cnVlCiAgICB9KTsKICB9CiAgY29tbWl0T3JSZW1vdmUoKSB7CiAgICB0aGlzLiNhY3RpdmVFZGl0b3I/LmNvbW1pdE9yUmVtb3ZlKCk7CiAgfQogIGhhc1NvbWV0aGluZ1RvQ29udHJvbCgpIHsKICAgIHJldHVybiB0aGlzLiNhY3RpdmVFZGl0b3IgfHwgdGhpcy5oYXNTZWxlY3Rpb247CiAgfQogICNzZWxlY3RFZGl0b3JzKGVkaXRvcnMpIHsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI3NlbGVjdGVkRWRpdG9ycykgewogICAgICBlZGl0b3IudW5zZWxlY3QoKTsKICAgIH0KICAgIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5jbGVhcigpOwogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgZWRpdG9ycykgewogICAgICBpZiAoZWRpdG9yLmlzRW1wdHkoKSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5hZGQoZWRpdG9yKTsKICAgICAgZWRpdG9yLnNlbGVjdCgpOwogICAgfQogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICBoYXNTZWxlY3RlZEVkaXRvcjogdGhpcy5oYXNTZWxlY3Rpb24KICAgIH0pOwogIH0KICBzZWxlY3RBbGwoKSB7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgICAgZWRpdG9yLmNvbW1pdCgpOwogICAgfQogICAgdGhpcy4jc2VsZWN0RWRpdG9ycyh0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKTsKICB9CiAgdW5zZWxlY3RBbGwoKSB7CiAgICBpZiAodGhpcy4jYWN0aXZlRWRpdG9yKSB7CiAgICAgIHRoaXMuI2FjdGl2ZUVkaXRvci5jb21taXRPclJlbW92ZSgpOwogICAgICBpZiAodGhpcy4jbW9kZSAhPT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuI2N1cnJlbnREcmF3aW5nU2Vzc2lvbj8uY29tbWl0T3JSZW1vdmUoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuaGFzU2VsZWN0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI3NlbGVjdGVkRWRpdG9ycykgewogICAgICBlZGl0b3IudW5zZWxlY3QoKTsKICAgIH0KICAgIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5jbGVhcigpOwogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICBoYXNTZWxlY3RlZEVkaXRvcjogZmFsc2UKICAgIH0pOwogIH0KICB0cmFuc2xhdGVTZWxlY3RlZEVkaXRvcnMoeCwgeSwgbm9Db21taXQgPSBmYWxzZSkgewogICAgaWYgKCFub0NvbW1pdCkgewogICAgICB0aGlzLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICB9CiAgICBpZiAoIXRoaXMuaGFzU2VsZWN0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3RyYW5zbGF0aW9uWzBdICs9IHg7CiAgICB0aGlzLiN0cmFuc2xhdGlvblsxXSArPSB5OwogICAgY29uc3QgW3RvdGFsWCwgdG90YWxZXSA9IHRoaXMuI3RyYW5zbGF0aW9uOwogICAgY29uc3QgZWRpdG9ycyA9IFsuLi50aGlzLiNzZWxlY3RlZEVkaXRvcnNdOwogICAgY29uc3QgVElNRV9UT19XQUlUID0gMWUzOwogICAgaWYgKHRoaXMuI3RyYW5zbGF0aW9uVGltZW91dElkKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLiN0cmFuc2xhdGlvblRpbWVvdXRJZCk7CiAgICB9CiAgICB0aGlzLiN0cmFuc2xhdGlvblRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aGlzLiN0cmFuc2xhdGlvblRpbWVvdXRJZCA9IG51bGw7CiAgICAgIHRoaXMuI3RyYW5zbGF0aW9uWzBdID0gdGhpcy4jdHJhbnNsYXRpb25bMV0gPSAwOwogICAgICB0aGlzLmFkZENvbW1hbmRzKHsKICAgICAgICBjbWQ6ICgpID0+IHsKICAgICAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGVkaXRvcnMpIHsKICAgICAgICAgICAgaWYgKHRoaXMuI2FsbEVkaXRvcnMuaGFzKGVkaXRvci5pZCkpIHsKICAgICAgICAgICAgICBlZGl0b3IudHJhbnNsYXRlSW5QYWdlKHRvdGFsWCwgdG90YWxZKTsKICAgICAgICAgICAgICBlZGl0b3IudHJhbnNsYXRpb25Eb25lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVuZG86ICgpID0+IHsKICAgICAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGVkaXRvcnMpIHsKICAgICAgICAgICAgaWYgKHRoaXMuI2FsbEVkaXRvcnMuaGFzKGVkaXRvci5pZCkpIHsKICAgICAgICAgICAgICBlZGl0b3IudHJhbnNsYXRlSW5QYWdlKC10b3RhbFgsIC10b3RhbFkpOwogICAgICAgICAgICAgIGVkaXRvci50cmFuc2xhdGlvbkRvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbXVzdEV4ZWM6IGZhbHNlCiAgICAgIH0pOwogICAgfSwgVElNRV9UT19XQUlUKTsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGVkaXRvcnMpIHsKICAgICAgZWRpdG9yLnRyYW5zbGF0ZUluUGFnZSh4LCB5KTsKICAgICAgZWRpdG9yLnRyYW5zbGF0aW9uRG9uZSgpOwogICAgfQogIH0KICBzZXRVcERyYWdTZXNzaW9uKCkgewogICAgaWYgKCF0aGlzLmhhc1NlbGVjdGlvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmRpc2FibGVVc2VyU2VsZWN0KHRydWUpOwogICAgdGhpcy4jZHJhZ2dpbmdFZGl0b3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI3NlbGVjdGVkRWRpdG9ycykgewogICAgICB0aGlzLiNkcmFnZ2luZ0VkaXRvcnMuc2V0KGVkaXRvciwgewogICAgICAgIHNhdmVkWDogZWRpdG9yLngsCiAgICAgICAgc2F2ZWRZOiBlZGl0b3IueSwKICAgICAgICBzYXZlZFBhZ2VJbmRleDogZWRpdG9yLnBhZ2VJbmRleCwKICAgICAgICBuZXdYOiAwLAogICAgICAgIG5ld1k6IDAsCiAgICAgICAgbmV3UGFnZUluZGV4OiAtMQogICAgICB9KTsKICAgIH0KICB9CiAgZW5kRHJhZ1Nlc3Npb24oKSB7CiAgICBpZiAoIXRoaXMuI2RyYWdnaW5nRWRpdG9ycykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLmRpc2FibGVVc2VyU2VsZWN0KGZhbHNlKTsKICAgIGNvbnN0IG1hcCA9IHRoaXMuI2RyYWdnaW5nRWRpdG9yczsKICAgIHRoaXMuI2RyYWdnaW5nRWRpdG9ycyA9IG51bGw7CiAgICBsZXQgbXVzdEJlQWRkZWRJblVuZG9TdGFjayA9IGZhbHNlOwogICAgZm9yIChjb25zdCBbewogICAgICB4LAogICAgICB5LAogICAgICBwYWdlSW5kZXgKICAgIH0sIHZhbHVlXSBvZiBtYXApIHsKICAgICAgdmFsdWUubmV3WCA9IHg7CiAgICAgIHZhbHVlLm5ld1kgPSB5OwogICAgICB2YWx1ZS5uZXdQYWdlSW5kZXggPSBwYWdlSW5kZXg7CiAgICAgIG11c3RCZUFkZGVkSW5VbmRvU3RhY2sgfHw9IHggIT09IHZhbHVlLnNhdmVkWCB8fCB5ICE9PSB2YWx1ZS5zYXZlZFkgfHwgcGFnZUluZGV4ICE9PSB2YWx1ZS5zYXZlZFBhZ2VJbmRleDsKICAgIH0KICAgIGlmICghbXVzdEJlQWRkZWRJblVuZG9TdGFjaykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCBtb3ZlID0gKGVkaXRvciwgeCwgeSwgcGFnZUluZGV4KSA9PiB7CiAgICAgIGlmICh0aGlzLiNhbGxFZGl0b3JzLmhhcyhlZGl0b3IuaWQpKSB7CiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy4jYWxsTGF5ZXJzLmdldChwYWdlSW5kZXgpOwogICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgIGVkaXRvci5fc2V0UGFyZW50QW5kUG9zaXRpb24ocGFyZW50LCB4LCB5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZWRpdG9yLnBhZ2VJbmRleCA9IHBhZ2VJbmRleDsKICAgICAgICAgIGVkaXRvci54ID0geDsKICAgICAgICAgIGVkaXRvci55ID0geTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB0aGlzLmFkZENvbW1hbmRzKHsKICAgICAgY21kOiAoKSA9PiB7CiAgICAgICAgZm9yIChjb25zdCBbZWRpdG9yLCB7CiAgICAgICAgICBuZXdYLAogICAgICAgICAgbmV3WSwKICAgICAgICAgIG5ld1BhZ2VJbmRleAogICAgICAgIH1dIG9mIG1hcCkgewogICAgICAgICAgbW92ZShlZGl0b3IsIG5ld1gsIG5ld1ksIG5ld1BhZ2VJbmRleCk7CiAgICAgICAgfQogICAgICB9LAogICAgICB1bmRvOiAoKSA9PiB7CiAgICAgICAgZm9yIChjb25zdCBbZWRpdG9yLCB7CiAgICAgICAgICBzYXZlZFgsCiAgICAgICAgICBzYXZlZFksCiAgICAgICAgICBzYXZlZFBhZ2VJbmRleAogICAgICAgIH1dIG9mIG1hcCkgewogICAgICAgICAgbW92ZShlZGl0b3IsIHNhdmVkWCwgc2F2ZWRZLCBzYXZlZFBhZ2VJbmRleCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBtdXN0RXhlYzogdHJ1ZQogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZHJhZ1NlbGVjdGVkRWRpdG9ycyh0eCwgdHkpIHsKICAgIGlmICghdGhpcy4jZHJhZ2dpbmdFZGl0b3JzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2RyYWdnaW5nRWRpdG9ycy5rZXlzKCkpIHsKICAgICAgZWRpdG9yLmRyYWcodHgsIHR5KTsKICAgIH0KICB9CiAgcmVidWlsZChlZGl0b3IpIHsKICAgIGlmIChlZGl0b3IucGFyZW50ID09PSBudWxsKSB7CiAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZ2V0TGF5ZXIoZWRpdG9yLnBhZ2VJbmRleCk7CiAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICBwYXJlbnQuY2hhbmdlUGFyZW50KGVkaXRvcik7CiAgICAgICAgcGFyZW50LmFkZE9yUmVidWlsZChlZGl0b3IpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWRkRWRpdG9yKGVkaXRvcik7CiAgICAgICAgdGhpcy5hZGRUb0Fubm90YXRpb25TdG9yYWdlKGVkaXRvcik7CiAgICAgICAgZWRpdG9yLnJlYnVpbGQoKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWRpdG9yLnBhcmVudC5hZGRPclJlYnVpbGQoZWRpdG9yKTsKICAgIH0KICB9CiAgZ2V0IGlzRWRpdG9ySGFuZGxpbmdLZXlib2FyZCgpIHsKICAgIHJldHVybiB0aGlzLmdldEFjdGl2ZSgpPy5zaG91bGRHZXRLZXlib2FyZEV2ZW50cygpIHx8IHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5zaXplID09PSAxICYmIHRoaXMuZmlyc3RTZWxlY3RlZEVkaXRvci5zaG91bGRHZXRLZXlib2FyZEV2ZW50cygpOwogIH0KICBpc0FjdGl2ZShlZGl0b3IpIHsKICAgIHJldHVybiB0aGlzLiNhY3RpdmVFZGl0b3IgPT09IGVkaXRvcjsKICB9CiAgZ2V0QWN0aXZlKCkgewogICAgcmV0dXJuIHRoaXMuI2FjdGl2ZUVkaXRvcjsKICB9CiAgZ2V0TW9kZSgpIHsKICAgIHJldHVybiB0aGlzLiNtb2RlOwogIH0KICBpc0VkaXRpbmdNb2RlKCkgewogICAgcmV0dXJuIHRoaXMuI21vZGUgIT09IEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkU7CiAgfQogIGdldCBpbWFnZU1hbmFnZXIoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpbWFnZU1hbmFnZXIiLCBuZXcgSW1hZ2VNYW5hZ2VyKCkpOwogIH0KICBnZXRTZWxlY3Rpb25Cb3hlcyh0ZXh0TGF5ZXIpIHsKICAgIGlmICghdGV4dExheWVyKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBzZWxlY3Rpb24ucmFuZ2VDb3VudDsgaSA8IGlpOyBpKyspIHsKICAgICAgaWYgKCF0ZXh0TGF5ZXIuY29udGFpbnMoc2VsZWN0aW9uLmdldFJhbmdlQXQoaSkuY29tbW9uQW5jZXN0b3JDb250YWluZXIpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHsKICAgICAgeDogbGF5ZXJYLAogICAgICB5OiBsYXllclksCiAgICAgIHdpZHRoOiBwYXJlbnRXaWR0aCwKICAgICAgaGVpZ2h0OiBwYXJlbnRIZWlnaHQKICAgIH0gPSB0ZXh0TGF5ZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBsZXQgcm90YXRvcjsKICAgIHN3aXRjaCAodGV4dExheWVyLmdldEF0dHJpYnV0ZSgiZGF0YS1tYWluLXJvdGF0aW9uIikpIHsKICAgICAgY2FzZSAiOTAiOgogICAgICAgIHJvdGF0b3IgPSAoeCwgeSwgdywgaCkgPT4gKHsKICAgICAgICAgIHg6ICh5IC0gbGF5ZXJZKSAvIHBhcmVudEhlaWdodCwKICAgICAgICAgIHk6IDEgLSAoeCArIHcgLSBsYXllclgpIC8gcGFyZW50V2lkdGgsCiAgICAgICAgICB3aWR0aDogaCAvIHBhcmVudEhlaWdodCwKICAgICAgICAgIGhlaWdodDogdyAvIHBhcmVudFdpZHRoCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIjE4MCI6CiAgICAgICAgcm90YXRvciA9ICh4LCB5LCB3LCBoKSA9PiAoewogICAgICAgICAgeDogMSAtICh4ICsgdyAtIGxheWVyWCkgLyBwYXJlbnRXaWR0aCwKICAgICAgICAgIHk6IDEgLSAoeSArIGggLSBsYXllclkpIC8gcGFyZW50SGVpZ2h0LAogICAgICAgICAgd2lkdGg6IHcgLyBwYXJlbnRXaWR0aCwKICAgICAgICAgIGhlaWdodDogaCAvIHBhcmVudEhlaWdodAogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICIyNzAiOgogICAgICAgIHJvdGF0b3IgPSAoeCwgeSwgdywgaCkgPT4gKHsKICAgICAgICAgIHg6IDEgLSAoeSArIGggLSBsYXllclkpIC8gcGFyZW50SGVpZ2h0LAogICAgICAgICAgeTogKHggLSBsYXllclgpIC8gcGFyZW50V2lkdGgsCiAgICAgICAgICB3aWR0aDogaCAvIHBhcmVudEhlaWdodCwKICAgICAgICAgIGhlaWdodDogdyAvIHBhcmVudFdpZHRoCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcm90YXRvciA9ICh4LCB5LCB3LCBoKSA9PiAoewogICAgICAgICAgeDogKHggLSBsYXllclgpIC8gcGFyZW50V2lkdGgsCiAgICAgICAgICB5OiAoeSAtIGxheWVyWSkgLyBwYXJlbnRIZWlnaHQsCiAgICAgICAgICB3aWR0aDogdyAvIHBhcmVudFdpZHRoLAogICAgICAgICAgaGVpZ2h0OiBoIC8gcGFyZW50SGVpZ2h0CiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBjb25zdCBib3hlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gc2VsZWN0aW9uLnJhbmdlQ291bnQ7IGkgPCBpaTsgaSsrKSB7CiAgICAgIGNvbnN0IHJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoaSk7CiAgICAgIGlmIChyYW5nZS5jb2xsYXBzZWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IHsKICAgICAgICB4LAogICAgICAgIHksCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0CiAgICAgIH0gb2YgcmFuZ2UuZ2V0Q2xpZW50UmVjdHMoKSkgewogICAgICAgIGlmICh3aWR0aCA9PT0gMCB8fCBoZWlnaHQgPT09IDApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBib3hlcy5wdXNoKHJvdGF0b3IoeCwgeSwgd2lkdGgsIGhlaWdodCkpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYm94ZXMubGVuZ3RoID09PSAwID8gbnVsbCA6IGJveGVzOwogIH0KICBhZGRDaGFuZ2VkRXhpc3RpbmdBbm5vdGF0aW9uKHsKICAgIGFubm90YXRpb25FbGVtZW50SWQsCiAgICBpZAogIH0pIHsKICAgICh0aGlzLiNjaGFuZ2VkRXhpc3RpbmdBbm5vdGF0aW9ucyB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSkuc2V0KGFubm90YXRpb25FbGVtZW50SWQsIGlkKTsKICB9CiAgcmVtb3ZlQ2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbih7CiAgICBhbm5vdGF0aW9uRWxlbWVudElkCiAgfSkgewogICAgdGhpcy4jY2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbnM/LmRlbGV0ZShhbm5vdGF0aW9uRWxlbWVudElkKTsKICB9CiAgcmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbikgewogICAgY29uc3QgZWRpdG9ySWQgPSB0aGlzLiNjaGFuZ2VkRXhpc3RpbmdBbm5vdGF0aW9ucz8uZ2V0KGFubm90YXRpb24uZGF0YS5pZCk7CiAgICBpZiAoIWVkaXRvcklkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuI2Fubm90YXRpb25TdG9yYWdlLmdldFJhd1ZhbHVlKGVkaXRvcklkKTsKICAgIGlmICghZWRpdG9yKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiNtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5OT05FICYmICFlZGl0b3IuaGFzQmVlbk1vZGlmaWVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGVkaXRvci5yZW5kZXJBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKTsKICB9CiAgc2V0TWlzc2luZ0NhbnZhcyhhbm5vdGF0aW9uSWQsIGFubm90YXRpb25FbGVtZW50SWQsIGNhbnZhcykgewogICAgY29uc3QgZWRpdG9yID0gdGhpcy4jbWlzc2luZ0NhbnZhc2VzPy5nZXQoYW5ub3RhdGlvbklkKTsKICAgIGlmICghZWRpdG9yKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGVkaXRvci5zZXRDYW52YXMoYW5ub3RhdGlvbkVsZW1lbnRJZCwgY2FudmFzKTsKICAgIHRoaXMuI21pc3NpbmdDYW52YXNlcy5kZWxldGUoYW5ub3RhdGlvbklkKTsKICB9CiAgYWRkTWlzc2luZ0NhbnZhcyhhbm5vdGF0aW9uSWQsIGVkaXRvcikgewogICAgKHRoaXMuI21pc3NpbmdDYW52YXNlcyB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSkuc2V0KGFubm90YXRpb25JZCwgZWRpdG9yKTsKICB9Cn07CnZhciBBbHRUZXh0ID0gY2xhc3MgX0FsdFRleHQgewogICNhbHRUZXh0ID0gbnVsbDsKICAjYWx0VGV4dERlY29yYXRpdmUgPSBmYWxzZTsKICAjYWx0VGV4dEJ1dHRvbiA9IG51bGw7CiAgI2FsdFRleHRCdXR0b25MYWJlbCA9IG51bGw7CiAgI2FsdFRleHRUb29sdGlwID0gbnVsbDsKICAjYWx0VGV4dFRvb2x0aXBUaW1lb3V0ID0gbnVsbDsKICAjYWx0VGV4dFdhc0Zyb21LZXlCb2FyZCA9IGZhbHNlOwogICNiYWRnZSA9IG51bGw7CiAgI2VkaXRvciA9IG51bGw7CiAgI2d1ZXNzZWRUZXh0ID0gbnVsbDsKICAjdGV4dFdpdGhEaXNjbGFpbWVyID0gbnVsbDsKICAjdXNlTmV3QWx0VGV4dEZsb3cgPSBmYWxzZTsKICBzdGF0aWMgI2wxMG5OZXdCdXR0b24gPSBudWxsOwogIHN0YXRpYyBfbDEwbiA9IG51bGw7CiAgY29uc3RydWN0b3IoZWRpdG9yKSB7CiAgICB0aGlzLiNlZGl0b3IgPSBlZGl0b3I7CiAgICB0aGlzLiN1c2VOZXdBbHRUZXh0RmxvdyA9IGVkaXRvci5fdWlNYW5hZ2VyLnVzZU5ld0FsdFRleHRGbG93OwogICAgX0FsdFRleHQuI2wxMG5OZXdCdXR0b24gfHw9IE9iamVjdC5mcmVlemUoewogICAgICBhZGRlZDogInBkZmpzLWVkaXRvci1uZXctYWx0LXRleHQtYWRkZWQtYnV0dG9uIiwKICAgICAgImFkZGVkLWxhYmVsIjogInBkZmpzLWVkaXRvci1uZXctYWx0LXRleHQtYWRkZWQtYnV0dG9uLWxhYmVsIiwKICAgICAgbWlzc2luZzogInBkZmpzLWVkaXRvci1uZXctYWx0LXRleHQtbWlzc2luZy1idXR0b24iLAogICAgICAibWlzc2luZy1sYWJlbCI6ICJwZGZqcy1lZGl0b3ItbmV3LWFsdC10ZXh0LW1pc3NpbmctYnV0dG9uLWxhYmVsIiwKICAgICAgcmV2aWV3OiAicGRmanMtZWRpdG9yLW5ldy1hbHQtdGV4dC10by1yZXZpZXctYnV0dG9uIiwKICAgICAgInJldmlldy1sYWJlbCI6ICJwZGZqcy1lZGl0b3ItbmV3LWFsdC10ZXh0LXRvLXJldmlldy1idXR0b24tbGFiZWwiCiAgICB9KTsKICB9CiAgc3RhdGljIGluaXRpYWxpemUobDEwbikgewogICAgX0FsdFRleHQuX2wxMG4gPz89IGwxMG47CiAgfQogIGFzeW5jIHJlbmRlcigpIHsKICAgIGNvbnN0IGFsdFRleHQgPSB0aGlzLiNhbHRUZXh0QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBhbHRUZXh0LmNsYXNzTmFtZSA9ICJhbHRUZXh0IjsKICAgIGFsdFRleHQudGFiSW5kZXggPSAiMCI7CiAgICBjb25zdCBsYWJlbCA9IHRoaXMuI2FsdFRleHRCdXR0b25MYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIGFsdFRleHQuYXBwZW5kKGxhYmVsKTsKICAgIGlmICh0aGlzLiN1c2VOZXdBbHRUZXh0RmxvdykgewogICAgICBhbHRUZXh0LmNsYXNzTGlzdC5hZGQoIm5ldyIpOwogICAgICBhbHRUZXh0LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0FsdFRleHQuI2wxMG5OZXdCdXR0b24ubWlzc2luZyk7CiAgICAgIGxhYmVsLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0FsdFRleHQuI2wxMG5OZXdCdXR0b25bIm1pc3NpbmctbGFiZWwiXSk7CiAgICB9IGVsc2UgewogICAgICBhbHRUZXh0LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLWVkaXRvci1hbHQtdGV4dC1idXR0b24iKTsKICAgICAgbGFiZWwuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCAicGRmanMtZWRpdG9yLWFsdC10ZXh0LWJ1dHRvbi1sYWJlbCIpOwogICAgfQogICAgY29uc3Qgc2lnbmFsID0gdGhpcy4jZWRpdG9yLl91aU1hbmFnZXIuX3NpZ25hbDsKICAgIGFsdFRleHQuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBhbHRUZXh0LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgKGV2ZW50KSA9PiBldmVudC5zdG9wUHJvcGFnYXRpb24oKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgY29uc3Qgb25DbGljayA9IChldmVudCkgPT4gewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5lZGl0QWx0VGV4dCh0aGlzLiNlZGl0b3IpOwogICAgICBpZiAodGhpcy4jdXNlTmV3QWx0VGV4dEZsb3cpIHsKICAgICAgICB0aGlzLiNlZGl0b3IuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgICAgICBhY3Rpb246ICJwZGZqcy5pbWFnZS5hbHRfdGV4dC5pbWFnZV9zdGF0dXNfbGFiZWxfY2xpY2tlZCIsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGxhYmVsOiB0aGlzLiNsYWJlbAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogICAgYWx0VGV4dC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIG9uQ2xpY2ssIHsKICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGFsdFRleHQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIChldmVudCkgPT4gewogICAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSBhbHRUZXh0ICYmIGV2ZW50LmtleSA9PT0gIkVudGVyIikgewogICAgICAgIHRoaXMuI2FsdFRleHRXYXNGcm9tS2V5Qm9hcmQgPSB0cnVlOwogICAgICAgIG9uQ2xpY2soZXZlbnQpOwogICAgICB9CiAgICB9LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBhd2FpdCB0aGlzLiNzZXRTdGF0ZSgpOwogICAgcmV0dXJuIGFsdFRleHQ7CiAgfQogIGdldCAjbGFiZWwoKSB7CiAgICByZXR1cm4gdGhpcy4jYWx0VGV4dCAmJiAiYWRkZWQiIHx8IHRoaXMuI2FsdFRleHQgPT09IG51bGwgJiYgdGhpcy5ndWVzc2VkVGV4dCAmJiAicmV2aWV3IiB8fCAibWlzc2luZyI7CiAgfQogIGZpbmlzaCgpIHsKICAgIGlmICghdGhpcy4jYWx0VGV4dEJ1dHRvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNhbHRUZXh0QnV0dG9uLmZvY3VzKHsKICAgICAgZm9jdXNWaXNpYmxlOiB0aGlzLiNhbHRUZXh0V2FzRnJvbUtleUJvYXJkCiAgICB9KTsKICAgIHRoaXMuI2FsdFRleHRXYXNGcm9tS2V5Qm9hcmQgPSBmYWxzZTsKICB9CiAgaXNFbXB0eSgpIHsKICAgIGlmICh0aGlzLiN1c2VOZXdBbHRUZXh0RmxvdykgewogICAgICByZXR1cm4gdGhpcy4jYWx0VGV4dCA9PT0gbnVsbDsKICAgIH0KICAgIHJldHVybiAhdGhpcy4jYWx0VGV4dCAmJiAhdGhpcy4jYWx0VGV4dERlY29yYXRpdmU7CiAgfQogIGhhc0RhdGEoKSB7CiAgICBpZiAodGhpcy4jdXNlTmV3QWx0VGV4dEZsb3cpIHsKICAgICAgcmV0dXJuIHRoaXMuI2FsdFRleHQgIT09IG51bGwgfHwgISF0aGlzLiNndWVzc2VkVGV4dDsKICAgIH0KICAgIHJldHVybiB0aGlzLmlzRW1wdHkoKTsKICB9CiAgZ2V0IGd1ZXNzZWRUZXh0KCkgewogICAgcmV0dXJuIHRoaXMuI2d1ZXNzZWRUZXh0OwogIH0KICBhc3luYyBzZXRHdWVzc2VkVGV4dChndWVzc2VkVGV4dCkgewogICAgaWYgKHRoaXMuI2FsdFRleHQgIT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jZ3Vlc3NlZFRleHQgPSBndWVzc2VkVGV4dDsKICAgIHRoaXMuI3RleHRXaXRoRGlzY2xhaW1lciA9IGF3YWl0IF9BbHRUZXh0Ll9sMTBuLmdldCgicGRmanMtZWRpdG9yLW5ldy1hbHQtdGV4dC1nZW5lcmF0ZWQtYWx0LXRleHQtd2l0aC1kaXNjbGFpbWVyIiwgewogICAgICBnZW5lcmF0ZWRBbHRUZXh0OiBndWVzc2VkVGV4dAogICAgfSk7CiAgICB0aGlzLiNzZXRTdGF0ZSgpOwogIH0KICB0b2dnbGVBbHRUZXh0QmFkZ2UodmlzaWJpbGl0eSA9IGZhbHNlKSB7CiAgICBpZiAoIXRoaXMuI3VzZU5ld0FsdFRleHRGbG93IHx8IHRoaXMuI2FsdFRleHQpIHsKICAgICAgdGhpcy4jYmFkZ2U/LnJlbW92ZSgpOwogICAgICB0aGlzLiNiYWRnZSA9IG51bGw7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy4jYmFkZ2UpIHsKICAgICAgY29uc3QgYmFkZ2UgPSB0aGlzLiNiYWRnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBiYWRnZS5jbGFzc05hbWUgPSAibm9BbHRUZXh0QmFkZ2UiOwogICAgICB0aGlzLiNlZGl0b3IuZGl2LmFwcGVuZChiYWRnZSk7CiAgICB9CiAgICB0aGlzLiNiYWRnZS5jbGFzc0xpc3QudG9nZ2xlKCJoaWRkZW4iLCAhdmlzaWJpbGl0eSk7CiAgfQogIHNlcmlhbGl6ZShpc0ZvckNvcHlpbmcpIHsKICAgIGxldCBhbHRUZXh0ID0gdGhpcy4jYWx0VGV4dDsKICAgIGlmICghaXNGb3JDb3B5aW5nICYmIHRoaXMuI2d1ZXNzZWRUZXh0ID09PSBhbHRUZXh0KSB7CiAgICAgIGFsdFRleHQgPSB0aGlzLiN0ZXh0V2l0aERpc2NsYWltZXI7CiAgICB9CiAgICByZXR1cm4gewogICAgICBhbHRUZXh0LAogICAgICBkZWNvcmF0aXZlOiB0aGlzLiNhbHRUZXh0RGVjb3JhdGl2ZSwKICAgICAgZ3Vlc3NlZFRleHQ6IHRoaXMuI2d1ZXNzZWRUZXh0LAogICAgICB0ZXh0V2l0aERpc2NsYWltZXI6IHRoaXMuI3RleHRXaXRoRGlzY2xhaW1lcgogICAgfTsKICB9CiAgZ2V0IGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBhbHRUZXh0OiB0aGlzLiNhbHRUZXh0LAogICAgICBkZWNvcmF0aXZlOiB0aGlzLiNhbHRUZXh0RGVjb3JhdGl2ZQogICAgfTsKICB9CiAgc2V0IGRhdGEoewogICAgYWx0VGV4dCwKICAgIGRlY29yYXRpdmUsCiAgICBndWVzc2VkVGV4dCwKICAgIHRleHRXaXRoRGlzY2xhaW1lciwKICAgIGNhbmNlbCA9IGZhbHNlCiAgfSkgewogICAgaWYgKGd1ZXNzZWRUZXh0KSB7CiAgICAgIHRoaXMuI2d1ZXNzZWRUZXh0ID0gZ3Vlc3NlZFRleHQ7CiAgICAgIHRoaXMuI3RleHRXaXRoRGlzY2xhaW1lciA9IHRleHRXaXRoRGlzY2xhaW1lcjsKICAgIH0KICAgIGlmICh0aGlzLiNhbHRUZXh0ID09PSBhbHRUZXh0ICYmIHRoaXMuI2FsdFRleHREZWNvcmF0aXZlID09PSBkZWNvcmF0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghY2FuY2VsKSB7CiAgICAgIHRoaXMuI2FsdFRleHQgPSBhbHRUZXh0OwogICAgICB0aGlzLiNhbHRUZXh0RGVjb3JhdGl2ZSA9IGRlY29yYXRpdmU7CiAgICB9CiAgICB0aGlzLiNzZXRTdGF0ZSgpOwogIH0KICB0b2dnbGUoZW5hYmxlZCA9IGZhbHNlKSB7CiAgICBpZiAoIXRoaXMuI2FsdFRleHRCdXR0b24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFlbmFibGVkICYmIHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy4jYWx0VGV4dFRvb2x0aXBUaW1lb3V0KTsKICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXBUaW1lb3V0ID0gbnVsbDsKICAgIH0KICAgIHRoaXMuI2FsdFRleHRCdXR0b24uZGlzYWJsZWQgPSAhZW5hYmxlZDsKICB9CiAgc2hvd24oKSB7CiAgICB0aGlzLiNlZGl0b3IuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgIGFjdGlvbjogInBkZmpzLmltYWdlLmFsdF90ZXh0LmltYWdlX3N0YXR1c19sYWJlbF9kaXNwbGF5ZWQiLAogICAgICBkYXRhOiB7CiAgICAgICAgbGFiZWw6IHRoaXMuI2xhYmVsCiAgICAgIH0KICAgIH0pOwogIH0KICBkZXN0cm95KCkgewogICAgdGhpcy4jYWx0VGV4dEJ1dHRvbj8ucmVtb3ZlKCk7CiAgICB0aGlzLiNhbHRUZXh0QnV0dG9uID0gbnVsbDsKICAgIHRoaXMuI2FsdFRleHRCdXR0b25MYWJlbCA9IG51bGw7CiAgICB0aGlzLiNhbHRUZXh0VG9vbHRpcCA9IG51bGw7CiAgICB0aGlzLiNiYWRnZT8ucmVtb3ZlKCk7CiAgICB0aGlzLiNiYWRnZSA9IG51bGw7CiAgfQogIGFzeW5jICNzZXRTdGF0ZSgpIHsKICAgIGNvbnN0IGJ1dHRvbiA9IHRoaXMuI2FsdFRleHRCdXR0b247CiAgICBpZiAoIWJ1dHRvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jdXNlTmV3QWx0VGV4dEZsb3cpIHsKICAgICAgYnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoImRvbmUiLCAhIXRoaXMuI2FsdFRleHQpOwogICAgICBidXR0b24uc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCBfQWx0VGV4dC4jbDEwbk5ld0J1dHRvblt0aGlzLiNsYWJlbF0pOwogICAgICB0aGlzLiNhbHRUZXh0QnV0dG9uTGFiZWw/LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0FsdFRleHQuI2wxMG5OZXdCdXR0b25bYCR7dGhpcy4jbGFiZWx9LWxhYmVsYF0pOwogICAgICBpZiAoIXRoaXMuI2FsdFRleHQpIHsKICAgICAgICB0aGlzLiNhbHRUZXh0VG9vbHRpcD8ucmVtb3ZlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoIXRoaXMuI2FsdFRleHQgJiYgIXRoaXMuI2FsdFRleHREZWNvcmF0aXZlKSB7CiAgICAgICAgYnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoImRvbmUiKTsKICAgICAgICB0aGlzLiNhbHRUZXh0VG9vbHRpcD8ucmVtb3ZlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGJ1dHRvbi5jbGFzc0xpc3QuYWRkKCJkb25lIik7CiAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1lZGl0b3ItYWx0LXRleHQtZWRpdC1idXR0b24iKTsKICAgIH0KICAgIGxldCB0b29sdGlwID0gdGhpcy4jYWx0VGV4dFRvb2x0aXA7CiAgICBpZiAoIXRvb2x0aXApIHsKICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXAgPSB0b29sdGlwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICB0b29sdGlwLmNsYXNzTmFtZSA9ICJ0b29sdGlwIjsKICAgICAgdG9vbHRpcC5zZXRBdHRyaWJ1dGUoInJvbGUiLCAidG9vbHRpcCIpOwogICAgICB0b29sdGlwLmlkID0gYGFsdC10ZXh0LXRvb2x0aXAtJHt0aGlzLiNlZGl0b3IuaWR9YDsKICAgICAgY29uc3QgREVMQVlfVE9fU0hPV19UT09MVElQID0gMTAwOwogICAgICBjb25zdCBzaWduYWwgPSB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5fc2lnbmFsOwogICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCAoKSA9PiB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCk7CiAgICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXBUaW1lb3V0ID0gbnVsbDsKICAgICAgfSwgewogICAgICAgIG9uY2U6IHRydWUKICAgICAgfSk7CiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWVudGVyIiwgKCkgPT4gewogICAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXBUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwLmNsYXNzTGlzdC5hZGQoInNob3ciKTsKICAgICAgICAgIHRoaXMuI2VkaXRvci5fcmVwb3J0VGVsZW1ldHJ5KHsKICAgICAgICAgICAgYWN0aW9uOiAiYWx0X3RleHRfdG9vbHRpcCIKICAgICAgICAgIH0pOwogICAgICAgIH0sIERFTEFZX1RPX1NIT1dfVE9PTFRJUCk7CiAgICAgIH0sIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWxlYXZlIiwgKCkgPT4gewogICAgICAgIGlmICh0aGlzLiNhbHRUZXh0VG9vbHRpcFRpbWVvdXQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLiNhbHRUZXh0VG9vbHRpcFRpbWVvdXQpOwogICAgICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXBUaW1lb3V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXA/LmNsYXNzTGlzdC5yZW1vdmUoInNob3ciKTsKICAgICAgfSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLiNhbHRUZXh0RGVjb3JhdGl2ZSkgewogICAgICB0b29sdGlwLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLWVkaXRvci1hbHQtdGV4dC1kZWNvcmF0aXZlLXRvb2x0aXAiKTsKICAgIH0gZWxzZSB7CiAgICAgIHRvb2x0aXAucmVtb3ZlQXR0cmlidXRlKCJkYXRhLWwxMG4taWQiKTsKICAgICAgdG9vbHRpcC50ZXh0Q29udGVudCA9IHRoaXMuI2FsdFRleHQ7CiAgICB9CiAgICBpZiAoIXRvb2x0aXAucGFyZW50Tm9kZSkgewogICAgICBidXR0b24uYXBwZW5kKHRvb2x0aXApOwogICAgfQogICAgY29uc3QgZWxlbWVudCA9IHRoaXMuI2VkaXRvci5nZXRFbGVtZW50Rm9yQWx0VGV4dCgpOwogICAgZWxlbWVudD8uc2V0QXR0cmlidXRlKCJhcmlhLWRlc2NyaWJlZGJ5IiwgdG9vbHRpcC5pZCk7CiAgfQp9Owp2YXIgQ29tbWVudCA9IGNsYXNzIHsKICAjY29tbWVudFN0YW5kYWxvbmVCdXR0b24gPSBudWxsOwogICNjb21tZW50VG9vbGJhckJ1dHRvbiA9IG51bGw7CiAgI2NvbW1lbnRXYXNGcm9tS2V5Qm9hcmQgPSBmYWxzZTsKICAjZWRpdG9yID0gbnVsbDsKICAjaW5pdGlhbFRleHQgPSBudWxsOwogICNyaWNoVGV4dCA9IG51bGw7CiAgI3RleHQgPSBudWxsOwogICNkYXRlID0gbnVsbDsKICAjZGVsZXRlZCA9IGZhbHNlOwogICNwb3B1cFBvc2l0aW9uID0gbnVsbDsKICBjb25zdHJ1Y3RvcihlZGl0b3IpIHsKICAgIHRoaXMuI2VkaXRvciA9IGVkaXRvcjsKICB9CiAgcmVuZGVyRm9yVG9vbGJhcigpIHsKICAgIGNvbnN0IGJ1dHRvbiA9IHRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBidXR0b24uY2xhc3NOYW1lID0gImNvbW1lbnQiOwogICAgcmV0dXJuIHRoaXMuI3JlbmRlcihidXR0b24sIGZhbHNlKTsKICB9CiAgcmVuZGVyRm9yU3RhbmRhbG9uZSgpIHsKICAgIGNvbnN0IGJ1dHRvbiA9IHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICBidXR0b24uY2xhc3NOYW1lID0gImFubm90YXRpb25Db21tZW50QnV0dG9uIjsKICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy4jZWRpdG9yLmNvbW1lbnRCdXR0b25Qb3NpdGlvbjsKICAgIGlmIChwb3NpdGlvbikgewogICAgICBjb25zdCB7CiAgICAgICAgc3R5bGUKICAgICAgfSA9IGJ1dHRvbjsKICAgICAgc3R5bGUuaW5zZXRJbmxpbmVFbmQgPSBgY2FsYygkezEwMCAqICh0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5kaXJlY3Rpb24gPT09ICJsdHIiID8gMSAtIHBvc2l0aW9uWzBdIDogcG9zaXRpb25bMF0pfSUgLSB2YXIoLS1jb21tZW50LWJ1dHRvbi1kaW0pKWA7CiAgICAgIHN0eWxlLnRvcCA9IGBjYWxjKCR7MTAwICogcG9zaXRpb25bMV19JSAtIHZhcigtLWNvbW1lbnQtYnV0dG9uLWRpbSkpYDsKICAgICAgY29uc3QgY29sb3IgPSB0aGlzLiNlZGl0b3IuY29tbWVudEJ1dHRvbkNvbG9yOwogICAgICBpZiAoY29sb3IpIHsKICAgICAgICBzdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuI3JlbmRlcihidXR0b24sIHRydWUpOwogIH0KICBmb2N1c0J1dHRvbigpIHsKICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAodGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24gPz8gdGhpcy4jY29tbWVudFRvb2xiYXJCdXR0b24pPy5mb2N1cygpOwogICAgfSwgMCk7CiAgfQogIG9uVXBkYXRlZENvbG9yKCkgewogICAgaWYgKCF0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjb2xvciA9IHRoaXMuI2VkaXRvci5jb21tZW50QnV0dG9uQ29sb3I7CiAgICBpZiAoY29sb3IpIHsKICAgICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3I7CiAgICB9CiAgICB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci51cGRhdGVQb3B1cENvbG9yKHRoaXMuI2VkaXRvcik7CiAgfQogIGdldCBjb21tZW50QnV0dG9uV2lkdGgoKSB7CiAgICByZXR1cm4gKHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uPy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCA/PyAwKSAvIHRoaXMuI2VkaXRvci5wYXJlbnQuYm91bmRpbmdDbGllbnRSZWN0LndpZHRoOwogIH0KICBnZXQgY29tbWVudFBvcHVwUG9zaXRpb25JbkxheWVyKCkgewogICAgaWYgKHRoaXMuI3BvcHVwUG9zaXRpb24pIHsKICAgICAgcmV0dXJuIHRoaXMuI3BvcHVwUG9zaXRpb247CiAgICB9CiAgICBpZiAoIXRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgewogICAgICB4LAogICAgICB5LAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIGNvbnN0IHsKICAgICAgeDogcGFyZW50WCwKICAgICAgeTogcGFyZW50WSwKICAgICAgd2lkdGg6IHBhcmVudFdpZHRoLAogICAgICBoZWlnaHQ6IHBhcmVudEhlaWdodAogICAgfSA9IHRoaXMuI2VkaXRvci5wYXJlbnQuYm91bmRpbmdDbGllbnRSZWN0OwogICAgcmV0dXJuIFsoeCAtIHBhcmVudFgpIC8gcGFyZW50V2lkdGgsICh5ICsgaGVpZ2h0IC0gcGFyZW50WSkgLyBwYXJlbnRIZWlnaHRdOwogIH0KICBzZXQgY29tbWVudFBvcHVwUG9zaXRpb25JbkxheWVyKHBvcykgewogICAgdGhpcy4jcG9wdXBQb3NpdGlvbiA9IHBvczsKICB9CiAgaGFzRGVmYXVsdFBvcHVwUG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy4jcG9wdXBQb3NpdGlvbiA9PT0gbnVsbDsKICB9CiAgcmVtb3ZlU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKSB7CiAgICB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbj8ucmVtb3ZlKCk7CiAgICB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbiA9IG51bGw7CiAgfQogIHJlbW92ZVRvb2xiYXJDb21tZW50QnV0dG9uKCkgewogICAgdGhpcy4jY29tbWVudFRvb2xiYXJCdXR0b24/LnJlbW92ZSgpOwogICAgdGhpcy4jY29tbWVudFRvb2xiYXJCdXR0b24gPSBudWxsOwogIH0KICBzZXRDb21tZW50QnV0dG9uU3RhdGVzKHsKICAgIHNlbGVjdGVkLAogICAgaGFzUG9wdXAKICB9KSB7CiAgICBpZiAoIXRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uLmNsYXNzTGlzdC50b2dnbGUoInNlbGVjdGVkIiwgc2VsZWN0ZWQpOwogICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24uYXJpYUV4cGFuZGVkID0gaGFzUG9wdXA7CiAgfQogICNyZW5kZXIoY29tbWVudCwgaXNTdGFuZGFsb25lKSB7CiAgICBpZiAoIXRoaXMuI2VkaXRvci5fdWlNYW5hZ2VyLmhhc0NvbW1lbnRNYW5hZ2VyKCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb21tZW50LnRhYkluZGV4ID0gIjAiOwogICAgY29tbWVudC5hcmlhSGFzUG9wdXAgPSAiZGlhbG9nIjsKICAgIGlmIChpc1N0YW5kYWxvbmUpIHsKICAgICAgY29tbWVudC5hcmlhQ29udHJvbHMgPSAiY29tbWVudFBvcHVwIjsKICAgICAgY29tbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1zaG93LWNvbW1lbnQtYnV0dG9uIik7CiAgICB9IGVsc2UgewogICAgICBjb21tZW50LmFyaWFDb250cm9sc0VsZW1lbnRzID0gW3RoaXMuI2VkaXRvci5fdWlNYW5hZ2VyLmdldENvbW1lbnREaWFsb2dFbGVtZW50KCldOwogICAgICBjb21tZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLWVkaXRvci1hZGQtY29tbWVudC1idXR0b24iKTsKICAgIH0KICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI2VkaXRvci5fdWlNYW5hZ2VyLl9zaWduYWw7CiAgICBpZiAoIShzaWduYWwgaW5zdGFuY2VvZiBBYm9ydFNpZ25hbCkgfHwgc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgcmV0dXJuIGNvbW1lbnQ7CiAgICB9CiAgICBjb21tZW50LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51Iiwgbm9Db250ZXh0TWVudSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgaWYgKGlzU3RhbmRhbG9uZSkgewogICAgICBjb21tZW50LmFkZEV2ZW50TGlzdGVuZXIoImZvY3VzaW4iLCAoZSkgPT4gewogICAgICAgIHRoaXMuI2VkaXRvci5fZm9jdXNFdmVudHNBbGxvd2VkID0gZmFsc2U7CiAgICAgICAgc3RvcEV2ZW50KGUpOwogICAgICB9LCB7CiAgICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGNvbW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXNvdXQiLCAoZSkgPT4gewogICAgICAgIHRoaXMuI2VkaXRvci5fZm9jdXNFdmVudHNBbGxvd2VkID0gdHJ1ZTsKICAgICAgICBzdG9wRXZlbnQoZSk7CiAgICAgIH0sIHsKICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgIH0KICAgIGNvbW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmRvd24iLCAoZXZlbnQpID0+IGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBjb25zdCBvbkNsaWNrID0gKGV2ZW50KSA9PiB7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIGlmIChjb21tZW50ID09PSB0aGlzLiNjb21tZW50VG9vbGJhckJ1dHRvbikgewogICAgICAgIHRoaXMuZWRpdCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuI2VkaXRvci50b2dnbGVDb21tZW50KHRydWUpOwogICAgICB9CiAgICB9OwogICAgY29tbWVudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIG9uQ2xpY2ssIHsKICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGNvbW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIChldmVudCkgPT4gewogICAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSBjb21tZW50ICYmIGV2ZW50LmtleSA9PT0gIkVudGVyIikgewogICAgICAgIHRoaXMuI2NvbW1lbnRXYXNGcm9tS2V5Qm9hcmQgPSB0cnVlOwogICAgICAgIG9uQ2xpY2soZXZlbnQpOwogICAgICB9CiAgICB9LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBjb21tZW50LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJlbnRlciIsICgpID0+IHsKICAgICAgdGhpcy4jZWRpdG9yLnRvZ2dsZUNvbW1lbnQoZmFsc2UsIHRydWUpOwogICAgfSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgY29tbWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybGVhdmUiLCAoKSA9PiB7CiAgICAgIHRoaXMuI2VkaXRvci50b2dnbGVDb21tZW50KGZhbHNlLCBmYWxzZSk7CiAgICB9LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICByZXR1cm4gY29tbWVudDsKICB9CiAgZWRpdChvcHRpb25zKSB7CiAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMuY29tbWVudFBvcHVwUG9zaXRpb25JbkxheWVyOwogICAgbGV0IHBvc1gsIHBvc1k7CiAgICBpZiAocG9zaXRpb24pIHsKICAgICAgW3Bvc1gsIHBvc1ldID0gcG9zaXRpb247CiAgICB9IGVsc2UgewogICAgICBbcG9zWCwgcG9zWV0gPSB0aGlzLiNlZGl0b3IuY29tbWVudEJ1dHRvblBvc2l0aW9uOwogICAgICBjb25zdCB7CiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIHgsCiAgICAgICAgeQogICAgICB9ID0gdGhpcy4jZWRpdG9yOwogICAgICBwb3NYID0geCArIHBvc1ggKiB3aWR0aDsKICAgICAgcG9zWSA9IHkgKyBwb3NZICogaGVpZ2h0OwogICAgfQogICAgY29uc3QgcGFyZW50RGltZW5zaW9ucyA9IHRoaXMuI2VkaXRvci5wYXJlbnQuYm91bmRpbmdDbGllbnRSZWN0OwogICAgY29uc3QgewogICAgICB4OiBwYXJlbnRYLAogICAgICB5OiBwYXJlbnRZLAogICAgICB3aWR0aDogcGFyZW50V2lkdGgsCiAgICAgIGhlaWdodDogcGFyZW50SGVpZ2h0CiAgICB9ID0gcGFyZW50RGltZW5zaW9uczsKICAgIHRoaXMuI2VkaXRvci5fdWlNYW5hZ2VyLmVkaXRDb21tZW50KHRoaXMuI2VkaXRvciwgcGFyZW50WCArIHBvc1ggKiBwYXJlbnRXaWR0aCwgcGFyZW50WSArIHBvc1kgKiBwYXJlbnRIZWlnaHQsIHsKICAgICAgLi4ub3B0aW9ucywKICAgICAgcGFyZW50RGltZW5zaW9ucwogICAgfSk7CiAgfQogIGZpbmlzaCgpIHsKICAgIGlmICghdGhpcy4jY29tbWVudFRvb2xiYXJCdXR0b24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29tbWVudFRvb2xiYXJCdXR0b24uZm9jdXMoewogICAgICBmb2N1c1Zpc2libGU6IHRoaXMuI2NvbW1lbnRXYXNGcm9tS2V5Qm9hcmQKICAgIH0pOwogICAgdGhpcy4jY29tbWVudFdhc0Zyb21LZXlCb2FyZCA9IGZhbHNlOwogIH0KICBpc0RlbGV0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy4jZGVsZXRlZCB8fCB0aGlzLiN0ZXh0ID09PSAiIjsKICB9CiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLiN0ZXh0ID09PSBudWxsOwogIH0KICBoYXNCZWVuRWRpdGVkKCkgewogICAgcmV0dXJuIHRoaXMuaXNEZWxldGVkKCkgfHwgdGhpcy4jdGV4dCAhPT0gdGhpcy4jaW5pdGlhbFRleHQ7CiAgfQogIHNlcmlhbGl6ZSgpIHsKICAgIHJldHVybiB0aGlzLmRhdGE7CiAgfQogIGdldCBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgdGV4dDogdGhpcy4jdGV4dCwKICAgICAgcmljaFRleHQ6IHRoaXMuI3JpY2hUZXh0LAogICAgICBkYXRlOiB0aGlzLiNkYXRlLAogICAgICBkZWxldGVkOiB0aGlzLmlzRGVsZXRlZCgpCiAgICB9OwogIH0KICBzZXQgZGF0YSh0ZXh0KSB7CiAgICBpZiAodGV4dCAhPT0gdGhpcy4jdGV4dCkgewogICAgICB0aGlzLiNyaWNoVGV4dCA9IG51bGw7CiAgICB9CiAgICBpZiAodGV4dCA9PT0gbnVsbCkgewogICAgICB0aGlzLiN0ZXh0ID0gIiI7CiAgICAgIHRoaXMuI2RlbGV0ZWQgPSB0cnVlOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiN0ZXh0ID0gdGV4dDsKICAgIHRoaXMuI2RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICAgIHRoaXMuI2RlbGV0ZWQgPSBmYWxzZTsKICB9CiAgc2V0SW5pdGlhbFRleHQodGV4dCwgcmljaFRleHQgPSBudWxsKSB7CiAgICB0aGlzLiNpbml0aWFsVGV4dCA9IHRleHQ7CiAgICB0aGlzLmRhdGEgPSB0ZXh0OwogICAgdGhpcy4jZGF0ZSA9IG51bGw7CiAgICB0aGlzLiNyaWNoVGV4dCA9IHJpY2hUZXh0OwogIH0KICBzaG93bigpIHsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uPy5yZW1vdmUoKTsKICAgIHRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uID0gbnVsbDsKICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uPy5yZW1vdmUoKTsKICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uID0gbnVsbDsKICAgIHRoaXMuI3RleHQgPSAiIjsKICAgIHRoaXMuI3JpY2hUZXh0ID0gbnVsbDsKICAgIHRoaXMuI2RhdGUgPSBudWxsOwogICAgdGhpcy4jZWRpdG9yID0gbnVsbDsKICAgIHRoaXMuI2NvbW1lbnRXYXNGcm9tS2V5Qm9hcmQgPSBmYWxzZTsKICAgIHRoaXMuI2RlbGV0ZWQgPSBmYWxzZTsKICB9Cn07CnZhciBUb3VjaE1hbmFnZXIgPSBjbGFzcyBfVG91Y2hNYW5hZ2VyIHsKICAjY29udGFpbmVyOwogICNpc1BpbmNoaW5nID0gZmFsc2U7CiAgI2lzUGluY2hpbmdTdG9wcGVkID0gbnVsbDsKICAjaXNQaW5jaGluZ0Rpc2FibGVkOwogICNvblBpbmNoU3RhcnQ7CiAgI29uUGluY2hpbmc7CiAgI29uUGluY2hFbmQ7CiAgI3BvaW50ZXJEb3duQUMgPSBudWxsOwogICNzaWduYWw7CiAgI3RvdWNoSW5mbyA9IG51bGw7CiAgI3RvdWNoTWFuYWdlckFDOwogICN0b3VjaE1vdmVBQyA9IG51bGw7CiAgY29uc3RydWN0b3IoewogICAgY29udGFpbmVyOiBjb250YWluZXIyLAogICAgaXNQaW5jaGluZ0Rpc2FibGVkID0gbnVsbCwKICAgIGlzUGluY2hpbmdTdG9wcGVkID0gbnVsbCwKICAgIG9uUGluY2hTdGFydCA9IG51bGwsCiAgICBvblBpbmNoaW5nID0gbnVsbCwKICAgIG9uUGluY2hFbmQgPSBudWxsLAogICAgc2lnbmFsCiAgfSkgewogICAgdGhpcy4jY29udGFpbmVyID0gY29udGFpbmVyMjsKICAgIHRoaXMuI2lzUGluY2hpbmdTdG9wcGVkID0gaXNQaW5jaGluZ1N0b3BwZWQ7CiAgICB0aGlzLiNpc1BpbmNoaW5nRGlzYWJsZWQgPSBpc1BpbmNoaW5nRGlzYWJsZWQ7CiAgICB0aGlzLiNvblBpbmNoU3RhcnQgPSBvblBpbmNoU3RhcnQ7CiAgICB0aGlzLiNvblBpbmNoaW5nID0gb25QaW5jaGluZzsKICAgIHRoaXMuI29uUGluY2hFbmQgPSBvblBpbmNoRW5kOwogICAgdGhpcy4jdG91Y2hNYW5hZ2VyQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICB0aGlzLiNzaWduYWwgPSBBYm9ydFNpZ25hbC5hbnkoW3NpZ25hbCwgdGhpcy4jdG91Y2hNYW5hZ2VyQUMuc2lnbmFsXSk7CiAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInRvdWNoc3RhcnQiLCB0aGlzLiNvblRvdWNoU3RhcnQuYmluZCh0aGlzKSwgewogICAgICBwYXNzaXZlOiBmYWxzZSwKICAgICAgc2lnbmFsOiB0aGlzLiNzaWduYWwKICAgIH0pOwogIH0KICBnZXQgTUlOX1RPVUNIX0RJU1RBTkNFX1RPX1BJTkNIKCkgewogICAgcmV0dXJuIDM1IC8gT3V0cHV0U2NhbGUucGl4ZWxSYXRpbzsKICB9CiAgI29uVG91Y2hTdGFydChldnQpIHsKICAgIGlmICh0aGlzLiNpc1BpbmNoaW5nRGlzYWJsZWQ/LigpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChldnQudG91Y2hlcy5sZW5ndGggPT09IDEpIHsKICAgICAgaWYgKHRoaXMuI3BvaW50ZXJEb3duQUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgcG9pbnRlckRvd25BQyA9IHRoaXMuI3BvaW50ZXJEb3duQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgIGNvbnN0IHNpZ25hbCA9IEFib3J0U2lnbmFsLmFueShbdGhpcy4jc2lnbmFsLCBwb2ludGVyRG93bkFDLnNpZ25hbF0pOwogICAgICBjb25zdCBjb250YWluZXIyID0gdGhpcy4jY29udGFpbmVyOwogICAgICBjb25zdCBvcHRzID0gewogICAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgICAgc2lnbmFsLAogICAgICAgIHBhc3NpdmU6IGZhbHNlCiAgICAgIH07CiAgICAgIGNvbnN0IGNhbmNlbFBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBpZiAoZS5wb2ludGVyVHlwZSA9PT0gInRvdWNoIikgewogICAgICAgICAgdGhpcy4jcG9pbnRlckRvd25BQz8uYWJvcnQoKTsKICAgICAgICAgIHRoaXMuI3BvaW50ZXJEb3duQUMgPSBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIChlKSA9PiB7CiAgICAgICAgaWYgKGUucG9pbnRlclR5cGUgPT09ICJ0b3VjaCIpIHsKICAgICAgICAgIHN0b3BFdmVudChlKTsKICAgICAgICAgIGNhbmNlbFBvaW50ZXJEb3duKGUpOwogICAgICAgIH0KICAgICAgfSwgb3B0cyk7CiAgICAgIGNvbnRhaW5lcjIuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgY2FuY2VsUG9pbnRlckRvd24sIG9wdHMpOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJjYW5jZWwiLCBjYW5jZWxQb2ludGVyRG93biwgb3B0cyk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy4jdG91Y2hNb3ZlQUMpIHsKICAgICAgdGhpcy4jdG91Y2hNb3ZlQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgIGNvbnN0IHNpZ25hbCA9IEFib3J0U2lnbmFsLmFueShbdGhpcy4jc2lnbmFsLCB0aGlzLiN0b3VjaE1vdmVBQy5zaWduYWxdKTsKICAgICAgY29uc3QgY29udGFpbmVyMiA9IHRoaXMuI2NvbnRhaW5lcjsKICAgICAgY29uc3Qgb3B0ID0gewogICAgICAgIHNpZ25hbCwKICAgICAgICBjYXB0dXJlOiBmYWxzZSwKICAgICAgICBwYXNzaXZlOiBmYWxzZQogICAgICB9OwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInRvdWNobW92ZSIsIHRoaXMuI29uVG91Y2hNb3ZlLmJpbmQodGhpcyksIG9wdCk7CiAgICAgIGNvbnN0IG9uVG91Y2hFbmQgPSB0aGlzLiNvblRvdWNoRW5kLmJpbmQodGhpcyk7CiAgICAgIGNvbnRhaW5lcjIuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hlbmQiLCBvblRvdWNoRW5kLCBvcHQpOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInRvdWNoY2FuY2VsIiwgb25Ub3VjaEVuZCwgb3B0KTsKICAgICAgb3B0LmNhcHR1cmUgPSB0cnVlOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgc3RvcEV2ZW50LCBvcHQpOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJtb3ZlIiwgc3RvcEV2ZW50LCBvcHQpOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJjYW5jZWwiLCBzdG9wRXZlbnQsIG9wdCk7CiAgICAgIGNvbnRhaW5lcjIuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgc3RvcEV2ZW50LCBvcHQpOwogICAgICB0aGlzLiNvblBpbmNoU3RhcnQ/LigpOwogICAgfQogICAgc3RvcEV2ZW50KGV2dCk7CiAgICBpZiAoZXZ0LnRvdWNoZXMubGVuZ3RoICE9PSAyIHx8IHRoaXMuI2lzUGluY2hpbmdTdG9wcGVkPy4oKSkgewogICAgICB0aGlzLiN0b3VjaEluZm8gPSBudWxsOwogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgW3RvdWNoMCwgdG91Y2gxXSA9IGV2dC50b3VjaGVzOwogICAgaWYgKHRvdWNoMC5pZGVudGlmaWVyID4gdG91Y2gxLmlkZW50aWZpZXIpIHsKICAgICAgW3RvdWNoMCwgdG91Y2gxXSA9IFt0b3VjaDEsIHRvdWNoMF07CiAgICB9CiAgICB0aGlzLiN0b3VjaEluZm8gPSB7CiAgICAgIHRvdWNoMFg6IHRvdWNoMC5zY3JlZW5YLAogICAgICB0b3VjaDBZOiB0b3VjaDAuc2NyZWVuWSwKICAgICAgdG91Y2gxWDogdG91Y2gxLnNjcmVlblgsCiAgICAgIHRvdWNoMVk6IHRvdWNoMS5zY3JlZW5ZCiAgICB9OwogIH0KICAjb25Ub3VjaE1vdmUoZXZ0KSB7CiAgICBpZiAoIXRoaXMuI3RvdWNoSW5mbyB8fCBldnQudG91Y2hlcy5sZW5ndGggIT09IDIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3RvcEV2ZW50KGV2dCk7CiAgICBsZXQgW3RvdWNoMCwgdG91Y2gxXSA9IGV2dC50b3VjaGVzOwogICAgaWYgKHRvdWNoMC5pZGVudGlmaWVyID4gdG91Y2gxLmlkZW50aWZpZXIpIHsKICAgICAgW3RvdWNoMCwgdG91Y2gxXSA9IFt0b3VjaDEsIHRvdWNoMF07CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHNjcmVlblg6IHNjcmVlbjBYLAogICAgICBzY3JlZW5ZOiBzY3JlZW4wWQogICAgfSA9IHRvdWNoMDsKICAgIGNvbnN0IHsKICAgICAgc2NyZWVuWDogc2NyZWVuMVgsCiAgICAgIHNjcmVlblk6IHNjcmVlbjFZCiAgICB9ID0gdG91Y2gxOwogICAgY29uc3QgdG91Y2hJbmZvID0gdGhpcy4jdG91Y2hJbmZvOwogICAgY29uc3QgewogICAgICB0b3VjaDBYOiBwVG91Y2gwWCwKICAgICAgdG91Y2gwWTogcFRvdWNoMFksCiAgICAgIHRvdWNoMVg6IHBUb3VjaDFYLAogICAgICB0b3VjaDFZOiBwVG91Y2gxWQogICAgfSA9IHRvdWNoSW5mbzsKICAgIGNvbnN0IHByZXZHYXBYID0gcFRvdWNoMVggLSBwVG91Y2gwWDsKICAgIGNvbnN0IHByZXZHYXBZID0gcFRvdWNoMVkgLSBwVG91Y2gwWTsKICAgIGNvbnN0IGN1cnJHYXBYID0gc2NyZWVuMVggLSBzY3JlZW4wWDsKICAgIGNvbnN0IGN1cnJHYXBZID0gc2NyZWVuMVkgLSBzY3JlZW4wWTsKICAgIGNvbnN0IGRpc3RhbmNlID0gTWF0aC5oeXBvdChjdXJyR2FwWCwgY3VyckdhcFkpIHx8IDE7CiAgICBjb25zdCBwRGlzdGFuY2UgPSBNYXRoLmh5cG90KHByZXZHYXBYLCBwcmV2R2FwWSkgfHwgMTsKICAgIGlmICghdGhpcy4jaXNQaW5jaGluZyAmJiBNYXRoLmFicyhwRGlzdGFuY2UgLSBkaXN0YW5jZSkgPD0gX1RvdWNoTWFuYWdlci5NSU5fVE9VQ0hfRElTVEFOQ0VfVE9fUElOQ0gpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdG91Y2hJbmZvLnRvdWNoMFggPSBzY3JlZW4wWDsKICAgIHRvdWNoSW5mby50b3VjaDBZID0gc2NyZWVuMFk7CiAgICB0b3VjaEluZm8udG91Y2gxWCA9IHNjcmVlbjFYOwogICAgdG91Y2hJbmZvLnRvdWNoMVkgPSBzY3JlZW4xWTsKICAgIGlmICghdGhpcy4jaXNQaW5jaGluZykgewogICAgICB0aGlzLiNpc1BpbmNoaW5nID0gdHJ1ZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgb3JpZ2luID0gWyhzY3JlZW4wWCArIHNjcmVlbjFYKSAvIDIsIChzY3JlZW4wWSArIHNjcmVlbjFZKSAvIDJdOwogICAgdGhpcy4jb25QaW5jaGluZz8uKG9yaWdpbiwgcERpc3RhbmNlLCBkaXN0YW5jZSk7CiAgfQogICNvblRvdWNoRW5kKGV2dCkgewogICAgaWYgKGV2dC50b3VjaGVzLmxlbmd0aCA+PSAyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiN0b3VjaE1vdmVBQykgewogICAgICB0aGlzLiN0b3VjaE1vdmVBQy5hYm9ydCgpOwogICAgICB0aGlzLiN0b3VjaE1vdmVBQyA9IG51bGw7CiAgICAgIHRoaXMuI29uUGluY2hFbmQ/LigpOwogICAgfQogICAgaWYgKCF0aGlzLiN0b3VjaEluZm8pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3RvcEV2ZW50KGV2dCk7CiAgICB0aGlzLiN0b3VjaEluZm8gPSBudWxsOwogICAgdGhpcy4jaXNQaW5jaGluZyA9IGZhbHNlOwogIH0KICBkZXN0cm95KCkgewogICAgdGhpcy4jdG91Y2hNYW5hZ2VyQUM/LmFib3J0KCk7CiAgICB0aGlzLiN0b3VjaE1hbmFnZXJBQyA9IG51bGw7CiAgICB0aGlzLiNwb2ludGVyRG93bkFDPy5hYm9ydCgpOwogICAgdGhpcy4jcG9pbnRlckRvd25BQyA9IG51bGw7CiAgfQp9Owp2YXIgQW5ub3RhdGlvbkVkaXRvciA9IGNsYXNzIF9Bbm5vdGF0aW9uRWRpdG9yIHsKICAjYWNjZXNzaWJpbGl0eURhdGEgPSBudWxsOwogICNhbGxSZXNpemVyRGl2cyA9IG51bGw7CiAgI2FsdFRleHQgPSBudWxsOwogICNjb21tZW50ID0gbnVsbDsKICAjY29tbWVudFN0YW5kYWxvbmVCdXR0b24gPSBudWxsOwogICNkaXNhYmxlZCA9IGZhbHNlOwogICNkcmFnUG9pbnRlcklkID0gbnVsbDsKICAjZHJhZ1BvaW50ZXJUeXBlID0gIiI7CiAgI3Jlc2l6ZXJzRGl2ID0gbnVsbDsKICAjbGFzdFBvaW50ZXJDb29yZHMgPSBudWxsOwogICNzYXZlZERpbWVuc2lvbnMgPSBudWxsOwogICNmYWtlQW5ub3RhdGlvbiA9IG51bGw7CiAgI2ZvY3VzQUMgPSBudWxsOwogICNmb2N1c2VkUmVzaXplck5hbWUgPSAiIjsKICAjaGFzQmVlbkNsaWNrZWQgPSBmYWxzZTsKICAjaW5pdGlhbFJlY3QgPSBudWxsOwogICNpc0VkaXRpbmcgPSBmYWxzZTsKICAjaXNJbkVkaXRNb2RlID0gZmFsc2U7CiAgI2lzUmVzaXplckVuYWJsZWRGb3JLZXlib2FyZCA9IGZhbHNlOwogICNtb3ZlSW5ET01UaW1lb3V0ID0gbnVsbDsKICAjcHJldkRyYWdYID0gMDsKICAjcHJldkRyYWdZID0gMDsKICAjdGVsZW1ldHJ5VGltZW91dHMgPSBudWxsOwogICN0b3VjaE1hbmFnZXIgPSBudWxsOwogIGlzU2VsZWN0ZWQgPSBmYWxzZTsKICBfaXNDb3B5ID0gZmFsc2U7CiAgX2VkaXRUb29sYmFyID0gbnVsbDsKICBfaW5pdGlhbE9wdGlvbnMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICBfaW5pdGlhbERhdGEgPSBudWxsOwogIF9pc1Zpc2libGUgPSB0cnVlOwogIF91aU1hbmFnZXIgPSBudWxsOwogIF9mb2N1c0V2ZW50c0FsbG93ZWQgPSB0cnVlOwogIHN0YXRpYyBfbDEwbiA9IG51bGw7CiAgc3RhdGljIF9sMTBuUmVzaXplciA9IG51bGw7CiAgI2lzRHJhZ2dhYmxlID0gZmFsc2U7CiAgI3pJbmRleCA9IF9Bbm5vdGF0aW9uRWRpdG9yLl96SW5kZXgrKzsKICBzdGF0aWMgX2JvcmRlckxpbmVXaWR0aCA9IC0xOwogIHN0YXRpYyBfY29sb3JNYW5hZ2VyID0gbmV3IENvbG9yTWFuYWdlcigpOwogIHN0YXRpYyBfekluZGV4ID0gMTsKICBzdGF0aWMgX3RlbGVtZXRyeVRpbWVvdXQgPSAxZTM7CiAgc3RhdGljIGdldCBfcmVzaXplcktleWJvYXJkTWFuYWdlcigpIHsKICAgIGNvbnN0IHJlc2l6ZSA9IF9Bbm5vdGF0aW9uRWRpdG9yLnByb3RvdHlwZS5fcmVzaXplV2l0aEtleWJvYXJkOwogICAgY29uc3Qgc21hbGwgPSBBbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyLlRSQU5TTEFURV9TTUFMTDsKICAgIGNvbnN0IGJpZyA9IEFubm90YXRpb25FZGl0b3JVSU1hbmFnZXIuVFJBTlNMQVRFX0JJRzsKICAgIHJldHVybiBzaGFkb3codGhpcywgIl9yZXNpemVyS2V5Ym9hcmRNYW5hZ2VyIiwgbmV3IEtleWJvYXJkTWFuYWdlcihbW1siQXJyb3dMZWZ0IiwgIm1hYytBcnJvd0xlZnQiXSwgcmVzaXplLCB7CiAgICAgIGFyZ3M6IFstc21hbGwsIDBdCiAgICB9XSwgW1siY3RybCtBcnJvd0xlZnQiLCAibWFjK3NoaWZ0K0Fycm93TGVmdCJdLCByZXNpemUsIHsKICAgICAgYXJnczogWy1iaWcsIDBdCiAgICB9XSwgW1siQXJyb3dSaWdodCIsICJtYWMrQXJyb3dSaWdodCJdLCByZXNpemUsIHsKICAgICAgYXJnczogW3NtYWxsLCAwXQogICAgfV0sIFtbImN0cmwrQXJyb3dSaWdodCIsICJtYWMrc2hpZnQrQXJyb3dSaWdodCJdLCByZXNpemUsIHsKICAgICAgYXJnczogW2JpZywgMF0KICAgIH1dLCBbWyJBcnJvd1VwIiwgIm1hYytBcnJvd1VwIl0sIHJlc2l6ZSwgewogICAgICBhcmdzOiBbMCwgLXNtYWxsXQogICAgfV0sIFtbImN0cmwrQXJyb3dVcCIsICJtYWMrc2hpZnQrQXJyb3dVcCJdLCByZXNpemUsIHsKICAgICAgYXJnczogWzAsIC1iaWddCiAgICB9XSwgW1siQXJyb3dEb3duIiwgIm1hYytBcnJvd0Rvd24iXSwgcmVzaXplLCB7CiAgICAgIGFyZ3M6IFswLCBzbWFsbF0KICAgIH1dLCBbWyJjdHJsK0Fycm93RG93biIsICJtYWMrc2hpZnQrQXJyb3dEb3duIl0sIHJlc2l6ZSwgewogICAgICBhcmdzOiBbMCwgYmlnXQogICAgfV0sIFtbIkVzY2FwZSIsICJtYWMrRXNjYXBlIl0sIF9Bbm5vdGF0aW9uRWRpdG9yLnByb3RvdHlwZS5fc3RvcFJlc2l6aW5nV2l0aEtleWJvYXJkXV0pKTsKICB9CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgdGhpcy5wYXJlbnQgPSBwYXJhbWV0ZXJzLnBhcmVudDsKICAgIHRoaXMuaWQgPSBwYXJhbWV0ZXJzLmlkOwogICAgdGhpcy53aWR0aCA9IHRoaXMuaGVpZ2h0ID0gbnVsbDsKICAgIHRoaXMucGFnZUluZGV4ID0gcGFyYW1ldGVycy5wYXJlbnQucGFnZUluZGV4OwogICAgdGhpcy5uYW1lID0gcGFyYW1ldGVycy5uYW1lOwogICAgdGhpcy5kaXYgPSBudWxsOwogICAgdGhpcy5fdWlNYW5hZ2VyID0gcGFyYW1ldGVycy51aU1hbmFnZXI7CiAgICB0aGlzLmFubm90YXRpb25FbGVtZW50SWQgPSBudWxsOwogICAgdGhpcy5fd2lsbEtlZXBBc3BlY3RSYXRpbyA9IGZhbHNlOwogICAgdGhpcy5faW5pdGlhbE9wdGlvbnMuaXNDZW50ZXJlZCA9IHBhcmFtZXRlcnMuaXNDZW50ZXJlZDsKICAgIHRoaXMuX3N0cnVjdFRyZWVQYXJlbnRJZCA9IG51bGw7CiAgICB0aGlzLmFubm90YXRpb25FbGVtZW50SWQgPSBwYXJhbWV0ZXJzLmFubm90YXRpb25FbGVtZW50SWQgfHwgbnVsbDsKICAgIHRoaXMuY3JlYXRpb25EYXRlID0gcGFyYW1ldGVycy5jcmVhdGlvbkRhdGUgfHwgLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CiAgICB0aGlzLm1vZGlmaWNhdGlvbkRhdGUgPSBwYXJhbWV0ZXJzLm1vZGlmaWNhdGlvbkRhdGUgfHwgbnVsbDsKICAgIHRoaXMuY2FuQWRkQ29tbWVudCA9IHRydWU7CiAgICBjb25zdCB7CiAgICAgIHJvdGF0aW9uLAogICAgICByYXdEaW1zOiB7CiAgICAgICAgcGFnZVdpZHRoLAogICAgICAgIHBhZ2VIZWlnaHQsCiAgICAgICAgcGFnZVgsCiAgICAgICAgcGFnZVkKICAgICAgfQogICAgfSA9IHRoaXMucGFyZW50LnZpZXdwb3J0OwogICAgdGhpcy5yb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgdGhpcy5wYWdlUm90YXRpb24gPSAoMzYwICsgcm90YXRpb24gLSB0aGlzLl91aU1hbmFnZXIudmlld1BhcmFtZXRlcnMucm90YXRpb24pICUgMzYwOwogICAgdGhpcy5wYWdlRGltZW5zaW9ucyA9IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdOwogICAgdGhpcy5wYWdlVHJhbnNsYXRpb24gPSBbcGFnZVgsIHBhZ2VZXTsKICAgIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgIHRoaXMueCA9IHBhcmFtZXRlcnMueCAvIHdpZHRoOwogICAgdGhpcy55ID0gcGFyYW1ldGVycy55IC8gaGVpZ2h0OwogICAgdGhpcy5pc0F0dGFjaGVkVG9ET00gPSBmYWxzZTsKICAgIHRoaXMuZGVsZXRlZCA9IGZhbHNlOwogIH0KICBnZXQgZWRpdG9yVHlwZSgpIHsKICAgIHJldHVybiBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3IuX3R5cGU7CiAgfQogIGdldCBtb2RlKCkgewogICAgcmV0dXJuIE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKS5jb25zdHJ1Y3Rvci5fZWRpdG9yVHlwZTsKICB9CiAgc3RhdGljIGdldCBpc0RyYXdlcigpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgc3RhdGljIGdldCBfZGVmYXVsdExpbmVDb2xvcigpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgIl9kZWZhdWx0TGluZUNvbG9yIiwgdGhpcy5fY29sb3JNYW5hZ2VyLmdldEhleENvZGUoIkNhbnZhc1RleHQiKSk7CiAgfQogIHN0YXRpYyBkZWxldGVBbm5vdGF0aW9uRWxlbWVudChlZGl0b3IpIHsKICAgIGNvbnN0IGZha2VFZGl0b3IgPSBuZXcgRmFrZUVkaXRvcih7CiAgICAgIGlkOiBlZGl0b3IucGFyZW50LmdldE5leHRJZCgpLAogICAgICBwYXJlbnQ6IGVkaXRvci5wYXJlbnQsCiAgICAgIHVpTWFuYWdlcjogZWRpdG9yLl91aU1hbmFnZXIKICAgIH0pOwogICAgZmFrZUVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkID0gZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQ7CiAgICBmYWtlRWRpdG9yLmRlbGV0ZWQgPSB0cnVlOwogICAgZmFrZUVkaXRvci5fdWlNYW5hZ2VyLmFkZFRvQW5ub3RhdGlvblN0b3JhZ2UoZmFrZUVkaXRvcik7CiAgfQogIHN0YXRpYyBpbml0aWFsaXplKGwxMG4sIF91aU1hbmFnZXIpIHsKICAgIF9Bbm5vdGF0aW9uRWRpdG9yLl9sMTBuID8/PSBsMTBuOwogICAgX0Fubm90YXRpb25FZGl0b3IuX2wxMG5SZXNpemVyIHx8PSBPYmplY3QuZnJlZXplKHsKICAgICAgdG9wTGVmdDogInBkZmpzLWVkaXRvci1yZXNpemVyLXRvcC1sZWZ0IiwKICAgICAgdG9wTWlkZGxlOiAicGRmanMtZWRpdG9yLXJlc2l6ZXItdG9wLW1pZGRsZSIsCiAgICAgIHRvcFJpZ2h0OiAicGRmanMtZWRpdG9yLXJlc2l6ZXItdG9wLXJpZ2h0IiwKICAgICAgbWlkZGxlUmlnaHQ6ICJwZGZqcy1lZGl0b3ItcmVzaXplci1taWRkbGUtcmlnaHQiLAogICAgICBib3R0b21SaWdodDogInBkZmpzLWVkaXRvci1yZXNpemVyLWJvdHRvbS1yaWdodCIsCiAgICAgIGJvdHRvbU1pZGRsZTogInBkZmpzLWVkaXRvci1yZXNpemVyLWJvdHRvbS1taWRkbGUiLAogICAgICBib3R0b21MZWZ0OiAicGRmanMtZWRpdG9yLXJlc2l6ZXItYm90dG9tLWxlZnQiLAogICAgICBtaWRkbGVMZWZ0OiAicGRmanMtZWRpdG9yLXJlc2l6ZXItbWlkZGxlLWxlZnQiCiAgICB9KTsKICAgIGlmIChfQW5ub3RhdGlvbkVkaXRvci5fYm9yZGVyTGluZVdpZHRoICE9PSAtMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBzdHlsZSA9IGdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTsKICAgIF9Bbm5vdGF0aW9uRWRpdG9yLl9ib3JkZXJMaW5lV2lkdGggPSBwYXJzZUZsb2F0KHN0eWxlLmdldFByb3BlcnR5VmFsdWUoIi0tb3V0bGluZS13aWR0aCIpKSB8fCAwOwogIH0KICBzdGF0aWMgdXBkYXRlRGVmYXVsdFBhcmFtcyhfdHlwZSwgX3ZhbHVlKSB7CiAgfQogIHN0YXRpYyBnZXQgZGVmYXVsdFByb3BlcnRpZXNUb1VwZGF0ZSgpIHsKICAgIHJldHVybiBbXTsKICB9CiAgc3RhdGljIGlzSGFuZGxpbmdNaW1lRm9yUGFzdGluZyhtaW1lKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHN0YXRpYyBwYXN0ZShpdGVtLCBwYXJlbnQpIHsKICAgIHVucmVhY2hhYmxlKCJOb3QgaW1wbGVtZW50ZWQiKTsKICB9CiAgZ2V0IHByb3BlcnRpZXNUb1VwZGF0ZSgpIHsKICAgIHJldHVybiBbXTsKICB9CiAgZ2V0IF9pc0RyYWdnYWJsZSgpIHsKICAgIHJldHVybiB0aGlzLiNpc0RyYWdnYWJsZTsKICB9CiAgc2V0IF9pc0RyYWdnYWJsZSh2YWx1ZSkgewogICAgdGhpcy4jaXNEcmFnZ2FibGUgPSB2YWx1ZTsKICAgIHRoaXMuZGl2Py5jbGFzc0xpc3QudG9nZ2xlKCJkcmFnZ2FibGUiLCB2YWx1ZSk7CiAgfQogIGdldCB1aWQoKSB7CiAgICByZXR1cm4gdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkIHx8IHRoaXMuaWQ7CiAgfQogIGdldCBpc0VudGVySGFuZGxlZCgpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBjZW50ZXIoKSB7CiAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFnZURpbWVuc2lvbnM7CiAgICBzd2l0Y2ggKHRoaXMucGFyZW50Um90YXRpb24pIHsKICAgICAgY2FzZSA5MDoKICAgICAgICB0aGlzLnggLT0gdGhpcy5oZWlnaHQgKiBwYWdlSGVpZ2h0IC8gKHBhZ2VXaWR0aCAqIDIpOwogICAgICAgIHRoaXMueSArPSB0aGlzLndpZHRoICogcGFnZVdpZHRoIC8gKHBhZ2VIZWlnaHQgKiAyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxODA6CiAgICAgICAgdGhpcy54ICs9IHRoaXMud2lkdGggLyAyOwogICAgICAgIHRoaXMueSArPSB0aGlzLmhlaWdodCAvIDI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHRoaXMueCArPSB0aGlzLmhlaWdodCAqIHBhZ2VIZWlnaHQgLyAocGFnZVdpZHRoICogMik7CiAgICAgICAgdGhpcy55IC09IHRoaXMud2lkdGggKiBwYWdlV2lkdGggLyAocGFnZUhlaWdodCAqIDIpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMueCAtPSB0aGlzLndpZHRoIC8gMjsKICAgICAgICB0aGlzLnkgLT0gdGhpcy5oZWlnaHQgLyAyOwogICAgICAgIGJyZWFrOwogICAgfQogICAgdGhpcy5maXhBbmRTZXRQb3NpdGlvbigpOwogIH0KICBhZGRDb21tYW5kcyhwYXJhbXMpIHsKICAgIHRoaXMuX3VpTWFuYWdlci5hZGRDb21tYW5kcyhwYXJhbXMpOwogIH0KICBnZXQgY3VycmVudExheWVyKCkgewogICAgcmV0dXJuIHRoaXMuX3VpTWFuYWdlci5jdXJyZW50TGF5ZXI7CiAgfQogIHNldEluQmFja2dyb3VuZCgpIHsKICAgIHRoaXMuZGl2LnN0eWxlLnpJbmRleCA9IDA7CiAgfQogIHNldEluRm9yZWdyb3VuZCgpIHsKICAgIHRoaXMuZGl2LnN0eWxlLnpJbmRleCA9IHRoaXMuI3pJbmRleDsKICB9CiAgc2V0UGFyZW50KHBhcmVudCkgewogICAgaWYgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICB0aGlzLnBhZ2VJbmRleCA9IHBhcmVudC5wYWdlSW5kZXg7CiAgICAgIHRoaXMucGFnZURpbWVuc2lvbnMgPSBwYXJlbnQucGFnZURpbWVuc2lvbnM7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNzdG9wUmVzaXppbmcoKTsKICAgICAgdGhpcy4jZmFrZUFubm90YXRpb24/LnJlbW92ZSgpOwogICAgICB0aGlzLiNmYWtlQW5ub3RhdGlvbiA9IG51bGw7CiAgICB9CiAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICB9CiAgZm9jdXNpbihldmVudCkgewogICAgaWYgKCF0aGlzLl9mb2N1c0V2ZW50c0FsbG93ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLiNoYXNCZWVuQ2xpY2tlZCkgewogICAgICB0aGlzLnBhcmVudC5zZXRTZWxlY3RlZCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuI2hhc0JlZW5DbGlja2VkID0gZmFsc2U7CiAgICB9CiAgfQogIGZvY3Vzb3V0KGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuX2ZvY3VzRXZlbnRzQWxsb3dlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHRhcmdldCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICBpZiAodGFyZ2V0Py5jbG9zZXN0KGAjJHt0aGlzLmlkfWApKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICBpZiAoIXRoaXMucGFyZW50Py5pc011bHRpcGxlU2VsZWN0aW9uKSB7CiAgICAgIHRoaXMuY29tbWl0T3JSZW1vdmUoKTsKICAgIH0KICB9CiAgY29tbWl0T3JSZW1vdmUoKSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpIHsKICAgICAgdGhpcy5yZW1vdmUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuY29tbWl0KCk7CiAgICB9CiAgfQogIGNvbW1pdCgpIHsKICAgIGlmICghdGhpcy5pc0luRWRpdE1vZGUoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmFkZFRvQW5ub3RhdGlvblN0b3JhZ2UoKTsKICB9CiAgYWRkVG9Bbm5vdGF0aW9uU3RvcmFnZSgpIHsKICAgIHRoaXMuX3VpTWFuYWdlci5hZGRUb0Fubm90YXRpb25TdG9yYWdlKHRoaXMpOwogIH0KICBzZXRBdCh4LCB5LCB0eCwgdHkpIHsKICAgIGNvbnN0IFt3aWR0aCwgaGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgIFt0eCwgdHldID0gdGhpcy5zY3JlZW5Ub1BhZ2VUcmFuc2xhdGlvbih0eCwgdHkpOwogICAgdGhpcy54ID0gKHggKyB0eCkgLyB3aWR0aDsKICAgIHRoaXMueSA9ICh5ICsgdHkpIC8gaGVpZ2h0OwogICAgdGhpcy5maXhBbmRTZXRQb3NpdGlvbigpOwogIH0KICBfbW92ZUFmdGVyUGFzdGUoYmFzZVgsIGJhc2VZKSB7CiAgICBjb25zdCBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICB0aGlzLnNldEF0KGJhc2VYICogcGFyZW50V2lkdGgsIGJhc2VZICogcGFyZW50SGVpZ2h0LCB0aGlzLndpZHRoICogcGFyZW50V2lkdGgsIHRoaXMuaGVpZ2h0ICogcGFyZW50SGVpZ2h0KTsKICAgIHRoaXMuX29uVHJhbnNsYXRlZCgpOwogIH0KICAjdHJhbnNsYXRlKFt3aWR0aCwgaGVpZ2h0XSwgeCwgeSkgewogICAgW3gsIHldID0gdGhpcy5zY3JlZW5Ub1BhZ2VUcmFuc2xhdGlvbih4LCB5KTsKICAgIHRoaXMueCArPSB4IC8gd2lkdGg7CiAgICB0aGlzLnkgKz0geSAvIGhlaWdodDsKICAgIHRoaXMuX29uVHJhbnNsYXRpbmcodGhpcy54LCB0aGlzLnkpOwogICAgdGhpcy5maXhBbmRTZXRQb3NpdGlvbigpOwogIH0KICB0cmFuc2xhdGUoeCwgeSkgewogICAgdGhpcy4jdHJhbnNsYXRlKHRoaXMucGFyZW50RGltZW5zaW9ucywgeCwgeSk7CiAgfQogIHRyYW5zbGF0ZUluUGFnZSh4LCB5KSB7CiAgICB0aGlzLiNpbml0aWFsUmVjdCB8fD0gW3RoaXMueCwgdGhpcy55LCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodF07CiAgICB0aGlzLiN0cmFuc2xhdGUodGhpcy5wYWdlRGltZW5zaW9ucywgeCwgeSk7CiAgICB0aGlzLmRpdi5zY3JvbGxJbnRvVmlldyh7CiAgICAgIGJsb2NrOiAibmVhcmVzdCIKICAgIH0pOwogIH0KICB0cmFuc2xhdGlvbkRvbmUoKSB7CiAgICB0aGlzLl9vblRyYW5zbGF0ZWQodGhpcy54LCB0aGlzLnkpOwogIH0KICBkcmFnKHR4LCB0eSkgewogICAgdGhpcy4jaW5pdGlhbFJlY3QgfHw9IFt0aGlzLngsIHRoaXMueSwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHRdOwogICAgY29uc3QgewogICAgICBkaXYsCiAgICAgIHBhcmVudERpbWVuc2lvbnM6IFtwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0XQogICAgfSA9IHRoaXM7CiAgICB0aGlzLnggKz0gdHggLyBwYXJlbnRXaWR0aDsKICAgIHRoaXMueSArPSB0eSAvIHBhcmVudEhlaWdodDsKICAgIGlmICh0aGlzLnBhcmVudCAmJiAodGhpcy54IDwgMCB8fCB0aGlzLnggPiAxIHx8IHRoaXMueSA8IDAgfHwgdGhpcy55ID4gMSkpIHsKICAgICAgY29uc3QgewogICAgICAgIHg6IHgyLAogICAgICAgIHk6IHkyCiAgICAgIH0gPSB0aGlzLmRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgaWYgKHRoaXMucGFyZW50LmZpbmROZXdQYXJlbnQodGhpcywgeDIsIHkyKSkgewogICAgICAgIHRoaXMueCAtPSBNYXRoLmZsb29yKHRoaXMueCk7CiAgICAgICAgdGhpcy55IC09IE1hdGguZmxvb3IodGhpcy55KTsKICAgICAgfQogICAgfQogICAgbGV0IHsKICAgICAgeCwKICAgICAgeQogICAgfSA9IHRoaXM7CiAgICBjb25zdCBbYngsIGJ5XSA9IHRoaXMuZ2V0QmFzZVRyYW5zbGF0aW9uKCk7CiAgICB4ICs9IGJ4OwogICAgeSArPSBieTsKICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSBkaXY7CiAgICBzdHlsZS5sZWZ0ID0gYCR7KDEwMCAqIHgpLnRvRml4ZWQoMil9JWA7CiAgICBzdHlsZS50b3AgPSBgJHsoMTAwICogeSkudG9GaXhlZCgyKX0lYDsKICAgIHRoaXMuX29uVHJhbnNsYXRpbmcoeCwgeSk7CiAgICBkaXYuc2Nyb2xsSW50b1ZpZXcoewogICAgICBibG9jazogIm5lYXJlc3QiCiAgICB9KTsKICB9CiAgX29uVHJhbnNsYXRpbmcoeCwgeSkgewogIH0KICBfb25UcmFuc2xhdGVkKHgsIHkpIHsKICB9CiAgZ2V0IF9oYXNCZWVuTW92ZWQoKSB7CiAgICByZXR1cm4gISF0aGlzLiNpbml0aWFsUmVjdCAmJiAodGhpcy4jaW5pdGlhbFJlY3RbMF0gIT09IHRoaXMueCB8fCB0aGlzLiNpbml0aWFsUmVjdFsxXSAhPT0gdGhpcy55KTsKICB9CiAgZ2V0IF9oYXNCZWVuUmVzaXplZCgpIHsKICAgIHJldHVybiAhIXRoaXMuI2luaXRpYWxSZWN0ICYmICh0aGlzLiNpbml0aWFsUmVjdFsyXSAhPT0gdGhpcy53aWR0aCB8fCB0aGlzLiNpbml0aWFsUmVjdFszXSAhPT0gdGhpcy5oZWlnaHQpOwogIH0KICBnZXRCYXNlVHJhbnNsYXRpb24oKSB7CiAgICBjb25zdCBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICBjb25zdCB7CiAgICAgIF9ib3JkZXJMaW5lV2lkdGgKICAgIH0gPSBfQW5ub3RhdGlvbkVkaXRvcjsKICAgIGNvbnN0IHggPSBfYm9yZGVyTGluZVdpZHRoIC8gcGFyZW50V2lkdGg7CiAgICBjb25zdCB5ID0gX2JvcmRlckxpbmVXaWR0aCAvIHBhcmVudEhlaWdodDsKICAgIHN3aXRjaCAodGhpcy5yb3RhdGlvbikgewogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbLXgsIHldOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXR1cm4gW3gsIHldOwogICAgICBjYXNlIDI3MDoKICAgICAgICByZXR1cm4gW3gsIC15XTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gWy14LCAteV07CiAgICB9CiAgfQogIGdldCBfbXVzdEZpeFBvc2l0aW9uKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGZpeEFuZFNldFBvc2l0aW9uKHJvdGF0aW9uID0gdGhpcy5yb3RhdGlvbikgewogICAgY29uc3QgewogICAgICBkaXY6IHsKICAgICAgICBzdHlsZQogICAgICB9LAogICAgICBwYWdlRGltZW5zaW9uczogW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0KICAgIH0gPSB0aGlzOwogICAgbGV0IHsKICAgICAgeCwKICAgICAgeSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXM7CiAgICB3aWR0aCAqPSBwYWdlV2lkdGg7CiAgICBoZWlnaHQgKj0gcGFnZUhlaWdodDsKICAgIHggKj0gcGFnZVdpZHRoOwogICAgeSAqPSBwYWdlSGVpZ2h0OwogICAgaWYgKHRoaXMuX211c3RGaXhQb3NpdGlvbikgewogICAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgICAgY2FzZSAwOgogICAgICAgICAgeCA9IE1hdGhDbGFtcCh4LCAwLCBwYWdlV2lkdGggLSB3aWR0aCk7CiAgICAgICAgICB5ID0gTWF0aENsYW1wKHksIDAsIHBhZ2VIZWlnaHQgLSBoZWlnaHQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA5MDoKICAgICAgICAgIHggPSBNYXRoQ2xhbXAoeCwgMCwgcGFnZVdpZHRoIC0gaGVpZ2h0KTsKICAgICAgICAgIHkgPSBNYXRoQ2xhbXAoeSwgd2lkdGgsIHBhZ2VIZWlnaHQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAxODA6CiAgICAgICAgICB4ID0gTWF0aENsYW1wKHgsIHdpZHRoLCBwYWdlV2lkdGgpOwogICAgICAgICAgeSA9IE1hdGhDbGFtcCh5LCBoZWlnaHQsIHBhZ2VIZWlnaHQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAyNzA6CiAgICAgICAgICB4ID0gTWF0aENsYW1wKHgsIGhlaWdodCwgcGFnZVdpZHRoKTsKICAgICAgICAgIHkgPSBNYXRoQ2xhbXAoeSwgMCwgcGFnZUhlaWdodCAtIHdpZHRoKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLnggPSB4IC89IHBhZ2VXaWR0aDsKICAgIHRoaXMueSA9IHkgLz0gcGFnZUhlaWdodDsKICAgIGNvbnN0IFtieCwgYnldID0gdGhpcy5nZXRCYXNlVHJhbnNsYXRpb24oKTsKICAgIHggKz0gYng7CiAgICB5ICs9IGJ5OwogICAgc3R5bGUubGVmdCA9IGAkeygxMDAgKiB4KS50b0ZpeGVkKDIpfSVgOwogICAgc3R5bGUudG9wID0gYCR7KDEwMCAqIHkpLnRvRml4ZWQoMil9JWA7CiAgICB0aGlzLm1vdmVJbkRPTSgpOwogIH0KICBzdGF0aWMgI3JvdGF0ZVBvaW50KHgsIHksIGFuZ2xlKSB7CiAgICBzd2l0Y2ggKGFuZ2xlKSB7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgcmV0dXJuIFt5LCAteF07CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiBbLXgsIC15XTsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmV0dXJuIFsteSwgeF07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIFt4LCB5XTsKICAgIH0KICB9CiAgc2NyZWVuVG9QYWdlVHJhbnNsYXRpb24oeCwgeSkgewogICAgcmV0dXJuIF9Bbm5vdGF0aW9uRWRpdG9yLiNyb3RhdGVQb2ludCh4LCB5LCB0aGlzLnBhcmVudFJvdGF0aW9uKTsKICB9CiAgcGFnZVRyYW5zbGF0aW9uVG9TY3JlZW4oeCwgeSkgewogICAgcmV0dXJuIF9Bbm5vdGF0aW9uRWRpdG9yLiNyb3RhdGVQb2ludCh4LCB5LCAzNjAgLSB0aGlzLnBhcmVudFJvdGF0aW9uKTsKICB9CiAgI2dldFJvdGF0aW9uTWF0cml4KHJvdGF0aW9uKSB7CiAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgIGNhc2UgOTA6IHsKICAgICAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFnZURpbWVuc2lvbnM7CiAgICAgICAgcmV0dXJuIFswLCAtcGFnZVdpZHRoIC8gcGFnZUhlaWdodCwgcGFnZUhlaWdodCAvIHBhZ2VXaWR0aCwgMF07CiAgICAgIH0KICAgICAgY2FzZSAxODA6CiAgICAgICAgcmV0dXJuIFstMSwgMCwgMCwgLTFdOwogICAgICBjYXNlIDI3MDogewogICAgICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgICAgICByZXR1cm4gWzAsIHBhZ2VXaWR0aCAvIHBhZ2VIZWlnaHQsIC1wYWdlSGVpZ2h0IC8gcGFnZVdpZHRoLCAwXTsKICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbMSwgMCwgMCwgMV07CiAgICB9CiAgfQogIGdldCBwYXJlbnRTY2FsZSgpIHsKICAgIHJldHVybiB0aGlzLl91aU1hbmFnZXIudmlld1BhcmFtZXRlcnMucmVhbFNjYWxlOwogIH0KICBnZXQgcGFyZW50Um90YXRpb24oKSB7CiAgICByZXR1cm4gKHRoaXMuX3VpTWFuYWdlci52aWV3UGFyYW1ldGVycy5yb3RhdGlvbiArIHRoaXMucGFnZVJvdGF0aW9uKSAlIDM2MDsKICB9CiAgZ2V0IHBhcmVudERpbWVuc2lvbnMoKSB7CiAgICBjb25zdCB7CiAgICAgIHBhcmVudFNjYWxlLAogICAgICBwYWdlRGltZW5zaW9uczogW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0KICAgIH0gPSB0aGlzOwogICAgcmV0dXJuIFtwYWdlV2lkdGggKiBwYXJlbnRTY2FsZSwgcGFnZUhlaWdodCAqIHBhcmVudFNjYWxlXTsKICB9CiAgc2V0RGltcygpIHsKICAgIGNvbnN0IHsKICAgICAgZGl2OiB7CiAgICAgICAgc3R5bGUKICAgICAgfSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXM7CiAgICBzdHlsZS53aWR0aCA9IGAkeygxMDAgKiB3aWR0aCkudG9GaXhlZCgyKX0lYDsKICAgIHN0eWxlLmhlaWdodCA9IGAkeygxMDAgKiBoZWlnaHQpLnRvRml4ZWQoMil9JWA7CiAgfQogIGdldEluaXRpYWxUcmFuc2xhdGlvbigpIHsKICAgIHJldHVybiBbMCwgMF07CiAgfQogICNjcmVhdGVSZXNpemVycygpIHsKICAgIGlmICh0aGlzLiNyZXNpemVyc0RpdikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNyZXNpemVyc0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy4jcmVzaXplcnNEaXYuY2xhc3NMaXN0LmFkZCgicmVzaXplcnMiKTsKICAgIGNvbnN0IGNsYXNzZXMgPSB0aGlzLl93aWxsS2VlcEFzcGVjdFJhdGlvID8gWyJ0b3BMZWZ0IiwgInRvcFJpZ2h0IiwgImJvdHRvbVJpZ2h0IiwgImJvdHRvbUxlZnQiXSA6IFsidG9wTGVmdCIsICJ0b3BNaWRkbGUiLCAidG9wUmlnaHQiLCAibWlkZGxlUmlnaHQiLCAiYm90dG9tUmlnaHQiLCAiYm90dG9tTWlkZGxlIiwgImJvdHRvbUxlZnQiLCAibWlkZGxlTGVmdCJdOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5fdWlNYW5hZ2VyLl9zaWduYWw7CiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgY2xhc3NlcykgewogICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgdGhpcy4jcmVzaXplcnNEaXYuYXBwZW5kKGRpdik7CiAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCJyZXNpemVyIiwgbmFtZSk7CiAgICAgIGRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtcmVzaXplci1uYW1lIiwgbmFtZSk7CiAgICAgIGRpdi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHRoaXMuI3Jlc2l6ZXJQb2ludGVyZG93bi5iaW5kKHRoaXMsIG5hbWUpLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBkaXYudGFiSW5kZXggPSAtMTsKICAgIH0KICAgIHRoaXMuZGl2LnByZXBlbmQodGhpcy4jcmVzaXplcnNEaXYpOwogIH0KICAjcmVzaXplclBvaW50ZXJkb3duKG5hbWUsIGV2ZW50KSB7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgY29uc3QgewogICAgICBpc01hYwogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICBpZiAoZXZlbnQuYnV0dG9uICE9PSAwIHx8IGV2ZW50LmN0cmxLZXkgJiYgaXNNYWMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jYWx0VGV4dD8udG9nZ2xlKGZhbHNlKTsKICAgIGNvbnN0IHNhdmVkRHJhZ2dhYmxlID0gdGhpcy5faXNEcmFnZ2FibGU7CiAgICB0aGlzLl9pc0RyYWdnYWJsZSA9IGZhbHNlOwogICAgdGhpcy4jbGFzdFBvaW50ZXJDb29yZHMgPSBbZXZlbnQuc2NyZWVuWCwgZXZlbnQuc2NyZWVuWV07CiAgICBjb25zdCBhYyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuX3VpTWFuYWdlci5jb21iaW5lZFNpZ25hbChhYyk7CiAgICB0aGlzLnBhcmVudC50b2dnbGVQb2ludGVyRXZlbnRzKGZhbHNlKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybW92ZSIsIHRoaXMuI3Jlc2l6ZXJQb2ludGVybW92ZS5iaW5kKHRoaXMsIG5hbWUpLCB7CiAgICAgIHBhc3NpdmU6IHRydWUsCiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2htb3ZlIiwgc3RvcEV2ZW50LCB7CiAgICAgIHBhc3NpdmU6IGZhbHNlLAogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51Iiwgbm9Db250ZXh0TWVudSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgdGhpcy4jc2F2ZWREaW1lbnNpb25zID0gewogICAgICBzYXZlZFg6IHRoaXMueCwKICAgICAgc2F2ZWRZOiB0aGlzLnksCiAgICAgIHNhdmVkV2lkdGg6IHRoaXMud2lkdGgsCiAgICAgIHNhdmVkSGVpZ2h0OiB0aGlzLmhlaWdodAogICAgfTsKICAgIGNvbnN0IHNhdmVkUGFyZW50Q3Vyc29yID0gdGhpcy5wYXJlbnQuZGl2LnN0eWxlLmN1cnNvcjsKICAgIGNvbnN0IHNhdmVkQ3Vyc29yID0gdGhpcy5kaXYuc3R5bGUuY3Vyc29yOwogICAgdGhpcy5kaXYuc3R5bGUuY3Vyc29yID0gdGhpcy5wYXJlbnQuZGl2LnN0eWxlLmN1cnNvciA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGV2ZW50LnRhcmdldCkuY3Vyc29yOwogICAgY29uc3QgcG9pbnRlclVwQ2FsbGJhY2sgPSAoKSA9PiB7CiAgICAgIGFjLmFib3J0KCk7CiAgICAgIHRoaXMucGFyZW50LnRvZ2dsZVBvaW50ZXJFdmVudHModHJ1ZSk7CiAgICAgIHRoaXMuI2FsdFRleHQ/LnRvZ2dsZSh0cnVlKTsKICAgICAgdGhpcy5faXNEcmFnZ2FibGUgPSBzYXZlZERyYWdnYWJsZTsKICAgICAgdGhpcy5wYXJlbnQuZGl2LnN0eWxlLmN1cnNvciA9IHNhdmVkUGFyZW50Q3Vyc29yOwogICAgICB0aGlzLmRpdi5zdHlsZS5jdXJzb3IgPSBzYXZlZEN1cnNvcjsKICAgICAgdGhpcy4jYWRkUmVzaXplVG9VbmRvU3RhY2soKTsKICAgIH07CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgcG9pbnRlclVwQ2FsbGJhY2ssIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgcG9pbnRlclVwQ2FsbGJhY2ssIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICB9CiAgI3Jlc2l6ZSh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy5zZXREaW1zKCk7CiAgICB0aGlzLmZpeEFuZFNldFBvc2l0aW9uKCk7CiAgICB0aGlzLl9vblJlc2l6ZWQoKTsKICB9CiAgX29uUmVzaXplZCgpIHsKICB9CiAgI2FkZFJlc2l6ZVRvVW5kb1N0YWNrKCkgewogICAgaWYgKCF0aGlzLiNzYXZlZERpbWVuc2lvbnMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBzYXZlZFgsCiAgICAgIHNhdmVkWSwKICAgICAgc2F2ZWRXaWR0aCwKICAgICAgc2F2ZWRIZWlnaHQKICAgIH0gPSB0aGlzLiNzYXZlZERpbWVuc2lvbnM7CiAgICB0aGlzLiNzYXZlZERpbWVuc2lvbnMgPSBudWxsOwogICAgY29uc3QgbmV3WCA9IHRoaXMueDsKICAgIGNvbnN0IG5ld1kgPSB0aGlzLnk7CiAgICBjb25zdCBuZXdXaWR0aCA9IHRoaXMud2lkdGg7CiAgICBjb25zdCBuZXdIZWlnaHQgPSB0aGlzLmhlaWdodDsKICAgIGlmIChuZXdYID09PSBzYXZlZFggJiYgbmV3WSA9PT0gc2F2ZWRZICYmIG5ld1dpZHRoID09PSBzYXZlZFdpZHRoICYmIG5ld0hlaWdodCA9PT0gc2F2ZWRIZWlnaHQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZDogdGhpcy4jcmVzaXplLmJpbmQodGhpcywgbmV3WCwgbmV3WSwgbmV3V2lkdGgsIG5ld0hlaWdodCksCiAgICAgIHVuZG86IHRoaXMuI3Jlc2l6ZS5iaW5kKHRoaXMsIHNhdmVkWCwgc2F2ZWRZLCBzYXZlZFdpZHRoLCBzYXZlZEhlaWdodCksCiAgICAgIG11c3RFeGVjOiB0cnVlCiAgICB9KTsKICB9CiAgc3RhdGljIF9yb3VuZCh4KSB7CiAgICByZXR1cm4gTWF0aC5yb3VuZCh4ICogMWU0KSAvIDFlNDsKICB9CiAgI3Jlc2l6ZXJQb2ludGVybW92ZShuYW1lLCBldmVudCkgewogICAgY29uc3QgW3BhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdID0gdGhpcy5wYXJlbnREaW1lbnNpb25zOwogICAgY29uc3Qgc2F2ZWRYID0gdGhpcy54OwogICAgY29uc3Qgc2F2ZWRZID0gdGhpcy55OwogICAgY29uc3Qgc2F2ZWRXaWR0aCA9IHRoaXMud2lkdGg7CiAgICBjb25zdCBzYXZlZEhlaWdodCA9IHRoaXMuaGVpZ2h0OwogICAgY29uc3QgbWluV2lkdGggPSBfQW5ub3RhdGlvbkVkaXRvci5NSU5fU0laRSAvIHBhcmVudFdpZHRoOwogICAgY29uc3QgbWluSGVpZ2h0ID0gX0Fubm90YXRpb25FZGl0b3IuTUlOX1NJWkUgLyBwYXJlbnRIZWlnaHQ7CiAgICBjb25zdCByb3RhdGlvbk1hdHJpeCA9IHRoaXMuI2dldFJvdGF0aW9uTWF0cml4KHRoaXMucm90YXRpb24pOwogICAgY29uc3QgdHJhbnNmID0gKHgsIHkpID0+IFtyb3RhdGlvbk1hdHJpeFswXSAqIHggKyByb3RhdGlvbk1hdHJpeFsyXSAqIHksIHJvdGF0aW9uTWF0cml4WzFdICogeCArIHJvdGF0aW9uTWF0cml4WzNdICogeV07CiAgICBjb25zdCBpbnZSb3RhdGlvbk1hdHJpeCA9IHRoaXMuI2dldFJvdGF0aW9uTWF0cml4KDM2MCAtIHRoaXMucm90YXRpb24pOwogICAgY29uc3QgaW52VHJhbnNmID0gKHgsIHkpID0+IFtpbnZSb3RhdGlvbk1hdHJpeFswXSAqIHggKyBpbnZSb3RhdGlvbk1hdHJpeFsyXSAqIHksIGludlJvdGF0aW9uTWF0cml4WzFdICogeCArIGludlJvdGF0aW9uTWF0cml4WzNdICogeV07CiAgICBsZXQgZ2V0UG9pbnQ7CiAgICBsZXQgZ2V0T3Bwb3NpdGU7CiAgICBsZXQgaXNEaWFnb25hbCA9IGZhbHNlOwogICAgbGV0IGlzSG9yaXpvbnRhbCA9IGZhbHNlOwogICAgc3dpdGNoIChuYW1lKSB7CiAgICAgIGNhc2UgInRvcExlZnQiOgogICAgICAgIGlzRGlhZ29uYWwgPSB0cnVlOwogICAgICAgIGdldFBvaW50ID0gKHcsIGgpID0+IFswLCAwXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbdywgaF07CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgInRvcE1pZGRsZSI6CiAgICAgICAgZ2V0UG9pbnQgPSAodywgaCkgPT4gW3cgLyAyLCAwXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbdyAvIDIsIGhdOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ0b3BSaWdodCI6CiAgICAgICAgaXNEaWFnb25hbCA9IHRydWU7CiAgICAgICAgZ2V0UG9pbnQgPSAodywgaCkgPT4gW3csIDBdOwogICAgICAgIGdldE9wcG9zaXRlID0gKHcsIGgpID0+IFswLCBoXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAibWlkZGxlUmlnaHQiOgogICAgICAgIGlzSG9yaXpvbnRhbCA9IHRydWU7CiAgICAgICAgZ2V0UG9pbnQgPSAodywgaCkgPT4gW3csIGggLyAyXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbMCwgaCAvIDJdOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJib3R0b21SaWdodCI6CiAgICAgICAgaXNEaWFnb25hbCA9IHRydWU7CiAgICAgICAgZ2V0UG9pbnQgPSAodywgaCkgPT4gW3csIGhdOwogICAgICAgIGdldE9wcG9zaXRlID0gKHcsIGgpID0+IFswLCAwXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiYm90dG9tTWlkZGxlIjoKICAgICAgICBnZXRQb2ludCA9ICh3LCBoKSA9PiBbdyAvIDIsIGhdOwogICAgICAgIGdldE9wcG9zaXRlID0gKHcsIGgpID0+IFt3IC8gMiwgMF07CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImJvdHRvbUxlZnQiOgogICAgICAgIGlzRGlhZ29uYWwgPSB0cnVlOwogICAgICAgIGdldFBvaW50ID0gKHcsIGgpID0+IFswLCBoXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbdywgMF07CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIm1pZGRsZUxlZnQiOgogICAgICAgIGlzSG9yaXpvbnRhbCA9IHRydWU7CiAgICAgICAgZ2V0UG9pbnQgPSAodywgaCkgPT4gWzAsIGggLyAyXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbdywgaCAvIDJdOwogICAgICAgIGJyZWFrOwogICAgfQogICAgY29uc3QgcG9pbnQgPSBnZXRQb2ludChzYXZlZFdpZHRoLCBzYXZlZEhlaWdodCk7CiAgICBjb25zdCBvcHBvc2l0ZVBvaW50ID0gZ2V0T3Bwb3NpdGUoc2F2ZWRXaWR0aCwgc2F2ZWRIZWlnaHQpOwogICAgbGV0IHRyYW5zZk9wcG9zaXRlUG9pbnQgPSB0cmFuc2YoLi4ub3Bwb3NpdGVQb2ludCk7CiAgICBjb25zdCBvcHBvc2l0ZVggPSBfQW5ub3RhdGlvbkVkaXRvci5fcm91bmQoc2F2ZWRYICsgdHJhbnNmT3Bwb3NpdGVQb2ludFswXSk7CiAgICBjb25zdCBvcHBvc2l0ZVkgPSBfQW5ub3RhdGlvbkVkaXRvci5fcm91bmQoc2F2ZWRZICsgdHJhbnNmT3Bwb3NpdGVQb2ludFsxXSk7CiAgICBsZXQgcmF0aW9YID0gMTsKICAgIGxldCByYXRpb1kgPSAxOwogICAgbGV0IGRlbHRhWCwgZGVsdGFZOwogICAgaWYgKCFldmVudC5mcm9tS2V5Ym9hcmQpIHsKICAgICAgY29uc3QgewogICAgICAgIHNjcmVlblgsCiAgICAgICAgc2NyZWVuWQogICAgICB9ID0gZXZlbnQ7CiAgICAgIGNvbnN0IFtsYXN0U2NyZWVuWCwgbGFzdFNjcmVlblldID0gdGhpcy4jbGFzdFBvaW50ZXJDb29yZHM7CiAgICAgIFtkZWx0YVgsIGRlbHRhWV0gPSB0aGlzLnNjcmVlblRvUGFnZVRyYW5zbGF0aW9uKHNjcmVlblggLSBsYXN0U2NyZWVuWCwgc2NyZWVuWSAtIGxhc3RTY3JlZW5ZKTsKICAgICAgdGhpcy4jbGFzdFBvaW50ZXJDb29yZHNbMF0gPSBzY3JlZW5YOwogICAgICB0aGlzLiNsYXN0UG9pbnRlckNvb3Jkc1sxXSA9IHNjcmVlblk7CiAgICB9IGVsc2UgewogICAgICAoewogICAgICAgIGRlbHRhWCwKICAgICAgICBkZWx0YVkKICAgICAgfSA9IGV2ZW50KTsKICAgIH0KICAgIFtkZWx0YVgsIGRlbHRhWV0gPSBpbnZUcmFuc2YoZGVsdGFYIC8gcGFyZW50V2lkdGgsIGRlbHRhWSAvIHBhcmVudEhlaWdodCk7CiAgICBpZiAoaXNEaWFnb25hbCkgewogICAgICBjb25zdCBvbGREaWFnID0gTWF0aC5oeXBvdChzYXZlZFdpZHRoLCBzYXZlZEhlaWdodCk7CiAgICAgIHJhdGlvWCA9IHJhdGlvWSA9IE1hdGgubWF4KE1hdGgubWluKE1hdGguaHlwb3Qob3Bwb3NpdGVQb2ludFswXSAtIHBvaW50WzBdIC0gZGVsdGFYLCBvcHBvc2l0ZVBvaW50WzFdIC0gcG9pbnRbMV0gLSBkZWx0YVkpIC8gb2xkRGlhZywgMSAvIHNhdmVkV2lkdGgsIDEgLyBzYXZlZEhlaWdodCksIG1pbldpZHRoIC8gc2F2ZWRXaWR0aCwgbWluSGVpZ2h0IC8gc2F2ZWRIZWlnaHQpOwogICAgfSBlbHNlIGlmIChpc0hvcml6b250YWwpIHsKICAgICAgcmF0aW9YID0gTWF0aENsYW1wKE1hdGguYWJzKG9wcG9zaXRlUG9pbnRbMF0gLSBwb2ludFswXSAtIGRlbHRhWCksIG1pbldpZHRoLCAxKSAvIHNhdmVkV2lkdGg7CiAgICB9IGVsc2UgewogICAgICByYXRpb1kgPSBNYXRoQ2xhbXAoTWF0aC5hYnMob3Bwb3NpdGVQb2ludFsxXSAtIHBvaW50WzFdIC0gZGVsdGFZKSwgbWluSGVpZ2h0LCAxKSAvIHNhdmVkSGVpZ2h0OwogICAgfQogICAgY29uc3QgbmV3V2lkdGggPSBfQW5ub3RhdGlvbkVkaXRvci5fcm91bmQoc2F2ZWRXaWR0aCAqIHJhdGlvWCk7CiAgICBjb25zdCBuZXdIZWlnaHQgPSBfQW5ub3RhdGlvbkVkaXRvci5fcm91bmQoc2F2ZWRIZWlnaHQgKiByYXRpb1kpOwogICAgdHJhbnNmT3Bwb3NpdGVQb2ludCA9IHRyYW5zZiguLi5nZXRPcHBvc2l0ZShuZXdXaWR0aCwgbmV3SGVpZ2h0KSk7CiAgICBjb25zdCBuZXdYID0gb3Bwb3NpdGVYIC0gdHJhbnNmT3Bwb3NpdGVQb2ludFswXTsKICAgIGNvbnN0IG5ld1kgPSBvcHBvc2l0ZVkgLSB0cmFuc2ZPcHBvc2l0ZVBvaW50WzFdOwogICAgdGhpcy4jaW5pdGlhbFJlY3QgfHw9IFt0aGlzLngsIHRoaXMueSwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHRdOwogICAgdGhpcy53aWR0aCA9IG5ld1dpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBuZXdIZWlnaHQ7CiAgICB0aGlzLnggPSBuZXdYOwogICAgdGhpcy55ID0gbmV3WTsKICAgIHRoaXMuc2V0RGltcygpOwogICAgdGhpcy5maXhBbmRTZXRQb3NpdGlvbigpOwogICAgdGhpcy5fb25SZXNpemluZygpOwogIH0KICBfb25SZXNpemluZygpIHsKICB9CiAgYWx0VGV4dEZpbmlzaCgpIHsKICAgIHRoaXMuI2FsdFRleHQ/LmZpbmlzaCgpOwogIH0KICBnZXQgdG9vbGJhckJ1dHRvbnMoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgYXN5bmMgYWRkRWRpdFRvb2xiYXIoKSB7CiAgICBpZiAodGhpcy5fZWRpdFRvb2xiYXIgfHwgdGhpcy4jaXNJbkVkaXRNb2RlKSB7CiAgICAgIHJldHVybiB0aGlzLl9lZGl0VG9vbGJhcjsKICAgIH0KICAgIHRoaXMuX2VkaXRUb29sYmFyID0gbmV3IEVkaXRvclRvb2xiYXIodGhpcyk7CiAgICB0aGlzLmRpdi5hcHBlbmQodGhpcy5fZWRpdFRvb2xiYXIucmVuZGVyKCkpOwogICAgY29uc3QgewogICAgICB0b29sYmFyQnV0dG9ucwogICAgfSA9IHRoaXM7CiAgICBpZiAodG9vbGJhckJ1dHRvbnMpIHsKICAgICAgZm9yIChjb25zdCBbbmFtZSwgdG9vbF0gb2YgdG9vbGJhckJ1dHRvbnMpIHsKICAgICAgICBhd2FpdCB0aGlzLl9lZGl0VG9vbGJhci5hZGRCdXR0b24obmFtZSwgdG9vbCk7CiAgICAgIH0KICAgIH0KICAgIGlmICghdGhpcy5oYXNDb21tZW50KSB7CiAgICAgIHRoaXMuX2VkaXRUb29sYmFyLmFkZEJ1dHRvbigiY29tbWVudCIsIHRoaXMuYWRkQ29tbWVudEJ1dHRvbigpKTsKICAgIH0KICAgIHRoaXMuX2VkaXRUb29sYmFyLmFkZEJ1dHRvbigiZGVsZXRlIik7CiAgICByZXR1cm4gdGhpcy5fZWRpdFRvb2xiYXI7CiAgfQogIGFkZENvbW1lbnRCdXR0b25JblRvb2xiYXIoKSB7CiAgICB0aGlzLl9lZGl0VG9vbGJhcj8uYWRkQnV0dG9uQmVmb3JlKCJjb21tZW50IiwgdGhpcy5hZGRDb21tZW50QnV0dG9uKCksICIuZGVsZXRlQnV0dG9uIik7CiAgfQogIHJlbW92ZUNvbW1lbnRCdXR0b25Gcm9tVG9vbGJhcigpIHsKICAgIHRoaXMuX2VkaXRUb29sYmFyPy5yZW1vdmVCdXR0b24oImNvbW1lbnQiKTsKICB9CiAgcmVtb3ZlRWRpdFRvb2xiYXIoKSB7CiAgICB0aGlzLl9lZGl0VG9vbGJhcj8ucmVtb3ZlKCk7CiAgICB0aGlzLl9lZGl0VG9vbGJhciA9IG51bGw7CiAgICB0aGlzLiNhbHRUZXh0Py5kZXN0cm95KCk7CiAgfQogIGFkZENvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICBjb25zdCBlZGl0VG9vbGJhckRpdiA9IHRoaXMuX2VkaXRUb29sYmFyPy5kaXY7CiAgICBpZiAoZWRpdFRvb2xiYXJEaXYpIHsKICAgICAgZWRpdFRvb2xiYXJEaXYuYmVmb3JlKGNvbnRhaW5lcjIpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5kaXYuYXBwZW5kKGNvbnRhaW5lcjIpOwogICAgfQogIH0KICBnZXRDbGllbnREaW1lbnNpb25zKCkgewogICAgcmV0dXJuIHRoaXMuZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIH0KICBjcmVhdGVBbHRUZXh0KCkgewogICAgaWYgKCF0aGlzLiNhbHRUZXh0KSB7CiAgICAgIEFsdFRleHQuaW5pdGlhbGl6ZShfQW5ub3RhdGlvbkVkaXRvci5fbDEwbik7CiAgICAgIHRoaXMuI2FsdFRleHQgPSBuZXcgQWx0VGV4dCh0aGlzKTsKICAgICAgaWYgKHRoaXMuI2FjY2Vzc2liaWxpdHlEYXRhKSB7CiAgICAgICAgdGhpcy4jYWx0VGV4dC5kYXRhID0gdGhpcy4jYWNjZXNzaWJpbGl0eURhdGE7CiAgICAgICAgdGhpcy4jYWNjZXNzaWJpbGl0eURhdGEgPSBudWxsOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy4jYWx0VGV4dDsKICB9CiAgZ2V0IGFsdFRleHREYXRhKCkgewogICAgcmV0dXJuIHRoaXMuI2FsdFRleHQ/LmRhdGE7CiAgfQogIHNldCBhbHRUZXh0RGF0YShkYXRhKSB7CiAgICBpZiAoIXRoaXMuI2FsdFRleHQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jYWx0VGV4dC5kYXRhID0gZGF0YTsKICB9CiAgZ2V0IGd1ZXNzZWRBbHRUZXh0KCkgewogICAgcmV0dXJuIHRoaXMuI2FsdFRleHQ/Lmd1ZXNzZWRUZXh0OwogIH0KICBhc3luYyBzZXRHdWVzc2VkQWx0VGV4dCh0ZXh0KSB7CiAgICBhd2FpdCB0aGlzLiNhbHRUZXh0Py5zZXRHdWVzc2VkVGV4dCh0ZXh0KTsKICB9CiAgc2VyaWFsaXplQWx0VGV4dChpc0ZvckNvcHlpbmcpIHsKICAgIHJldHVybiB0aGlzLiNhbHRUZXh0Py5zZXJpYWxpemUoaXNGb3JDb3B5aW5nKTsKICB9CiAgaGFzQWx0VGV4dCgpIHsKICAgIHJldHVybiAhIXRoaXMuI2FsdFRleHQgJiYgIXRoaXMuI2FsdFRleHQuaXNFbXB0eSgpOwogIH0KICBoYXNBbHRUZXh0RGF0YSgpIHsKICAgIHJldHVybiB0aGlzLiNhbHRUZXh0Py5oYXNEYXRhKCkgPz8gZmFsc2U7CiAgfQogIGZvY3VzQ29tbWVudEJ1dHRvbigpIHsKICAgIHRoaXMuI2NvbW1lbnQ/LmZvY3VzQnV0dG9uKCk7CiAgfQogIGFkZENvbW1lbnRCdXR0b24oKSB7CiAgICByZXR1cm4gdGhpcy5jYW5BZGRDb21tZW50ID8gdGhpcy4jY29tbWVudCB8fD0gbmV3IENvbW1lbnQodGhpcykgOiBudWxsOwogIH0KICBhZGRTdGFuZGFsb25lQ29tbWVudEJ1dHRvbigpIHsKICAgIGlmICghdGhpcy5fdWlNYW5hZ2VyLmhhc0NvbW1lbnRNYW5hZ2VyKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uKSB7CiAgICAgIGlmICh0aGlzLl91aU1hbmFnZXIuaXNFZGl0aW5nTW9kZSgpKSB7CiAgICAgICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLmhhc0NvbW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24gPSB0aGlzLiNjb21tZW50LnJlbmRlckZvclN0YW5kYWxvbmUoKTsKICAgIHRoaXMuZGl2LmFwcGVuZCh0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbik7CiAgfQogIHJlbW92ZVN0YW5kYWxvbmVDb21tZW50QnV0dG9uKCkgewogICAgdGhpcy4jY29tbWVudC5yZW1vdmVTdGFuZGFsb25lQ29tbWVudEJ1dHRvbigpOwogICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24gPSBudWxsOwogIH0KICBoaWRlU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKSB7CiAgICB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbj8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7CiAgfQogIGdldCBjb21tZW50KCkgewogICAgY29uc3QgewogICAgICBkYXRhOiB7CiAgICAgICAgcmljaFRleHQsCiAgICAgICAgdGV4dCwKICAgICAgICBkYXRlLAogICAgICAgIGRlbGV0ZWQKICAgICAgfQogICAgfSA9IHRoaXMuI2NvbW1lbnQ7CiAgICByZXR1cm4gewogICAgICB0ZXh0LAogICAgICByaWNoVGV4dCwKICAgICAgZGF0ZSwKICAgICAgZGVsZXRlZCwKICAgICAgY29sb3I6IHRoaXMuZ2V0Tm9uSENNQ29sb3IoKSwKICAgICAgb3BhY2l0eTogdGhpcy5vcGFjaXR5ID8/IDEKICAgIH07CiAgfQogIHNldCBjb21tZW50KHRleHQpIHsKICAgIHRoaXMuI2NvbW1lbnQgfHw9IG5ldyBDb21tZW50KHRoaXMpOwogICAgdGhpcy4jY29tbWVudC5kYXRhID0gdGV4dDsKICAgIGlmICh0aGlzLmhhc0NvbW1lbnQpIHsKICAgICAgdGhpcy5yZW1vdmVDb21tZW50QnV0dG9uRnJvbVRvb2xiYXIoKTsKICAgICAgdGhpcy5hZGRTdGFuZGFsb25lQ29tbWVudEJ1dHRvbigpOwogICAgICB0aGlzLl91aU1hbmFnZXIudXBkYXRlQ29tbWVudCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuYWRkQ29tbWVudEJ1dHRvbkluVG9vbGJhcigpOwogICAgICB0aGlzLnJlbW92ZVN0YW5kYWxvbmVDb21tZW50QnV0dG9uKCk7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5yZW1vdmVDb21tZW50KHRoaXMpOwogICAgfQogIH0KICBzZXRDb21tZW50RGF0YSh7CiAgICBjb21tZW50LAogICAgcG9wdXBSZWYsCiAgICByaWNoVGV4dAogIH0pIHsKICAgIGlmICghcG9wdXBSZWYpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29tbWVudCB8fD0gbmV3IENvbW1lbnQodGhpcyk7CiAgICB0aGlzLiNjb21tZW50LnNldEluaXRpYWxUZXh0KGNvbW1lbnQsIHJpY2hUZXh0KTsKICAgIGlmICghdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHN0b3JlZERhdGEgPSB0aGlzLl91aU1hbmFnZXIuZ2V0QW5kUmVtb3ZlRGF0YUZyb21Bbm5vdGF0aW9uU3RvcmFnZSh0aGlzLmFubm90YXRpb25FbGVtZW50SWQpOwogICAgaWYgKHN0b3JlZERhdGEpIHsKICAgICAgdGhpcy51cGRhdGVGcm9tQW5ub3RhdGlvbkxheWVyKHN0b3JlZERhdGEpOwogICAgfQogIH0KICBnZXQgaGFzRWRpdGVkQ29tbWVudCgpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50Py5oYXNCZWVuRWRpdGVkKCk7CiAgfQogIGdldCBoYXNEZWxldGVkQ29tbWVudCgpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50Py5pc0RlbGV0ZWQoKTsKICB9CiAgZ2V0IGhhc0NvbW1lbnQoKSB7CiAgICByZXR1cm4gISF0aGlzLiNjb21tZW50ICYmICF0aGlzLiNjb21tZW50LmlzRW1wdHkoKSAmJiAhdGhpcy4jY29tbWVudC5pc0RlbGV0ZWQoKTsKICB9CiAgYXN5bmMgZWRpdENvbW1lbnQob3B0aW9ucykgewogICAgdGhpcy4jY29tbWVudCB8fD0gbmV3IENvbW1lbnQodGhpcyk7CiAgICB0aGlzLiNjb21tZW50LmVkaXQob3B0aW9ucyk7CiAgfQogIHRvZ2dsZUNvbW1lbnQoaXNTZWxlY3RlZCwgdmlzaWJpbGl0eSA9IHZvaWQgMCkgewogICAgaWYgKHRoaXMuaGFzQ29tbWVudCkgewogICAgICB0aGlzLl91aU1hbmFnZXIudG9nZ2xlQ29tbWVudCh0aGlzLCBpc1NlbGVjdGVkLCB2aXNpYmlsaXR5KTsKICAgIH0KICB9CiAgc2V0U2VsZWN0ZWRDb21tZW50QnV0dG9uKHNlbGVjdGVkKSB7CiAgICB0aGlzLiNjb21tZW50LnNldFNlbGVjdGVkQnV0dG9uKHNlbGVjdGVkKTsKICB9CiAgYWRkQ29tbWVudChzZXJpYWxpemVkKSB7CiAgICBpZiAodGhpcy5oYXNFZGl0ZWRDb21tZW50KSB7CiAgICAgIGNvbnN0IERFRkFVTFRfUE9QVVBfV0lEVEggPSAxODA7CiAgICAgIGNvbnN0IERFRkFVTFRfUE9QVVBfSEVJR0hUID0gMTAwOwogICAgICBjb25zdCBbLCAsICwgdHJZXSA9IHNlcmlhbGl6ZWQucmVjdDsKICAgICAgY29uc3QgW3BhZ2VXaWR0aF0gPSB0aGlzLnBhZ2VEaW1lbnNpb25zOwogICAgICBjb25zdCBbcGFnZVhdID0gdGhpcy5wYWdlVHJhbnNsYXRpb247CiAgICAgIGNvbnN0IGJsWCA9IHBhZ2VYICsgcGFnZVdpZHRoICsgMTsKICAgICAgY29uc3QgYmxZID0gdHJZIC0gREVGQVVMVF9QT1BVUF9IRUlHSFQ7CiAgICAgIGNvbnN0IHRyWCA9IGJsWCArIERFRkFVTFRfUE9QVVBfV0lEVEg7CiAgICAgIHNlcmlhbGl6ZWQucG9wdXAgPSB7CiAgICAgICAgY29udGVudHM6IHRoaXMuY29tbWVudC50ZXh0LAogICAgICAgIGRlbGV0ZWQ6IHRoaXMuY29tbWVudC5kZWxldGVkLAogICAgICAgIHJlY3Q6IFtibFgsIGJsWSwgdHJYLCB0clldCiAgICAgIH07CiAgICB9CiAgfQogIHVwZGF0ZUZyb21Bbm5vdGF0aW9uTGF5ZXIoewogICAgcG9wdXA6IHsKICAgICAgY29udGVudHMsCiAgICAgIGRlbGV0ZWQKICAgIH0KICB9KSB7CiAgICB0aGlzLiNjb21tZW50LmRhdGEgPSBkZWxldGVkID8gbnVsbCA6IGNvbnRlbnRzOwogIH0KICBnZXQgcGFyZW50Qm91bmRpbmdDbGllbnRSZWN0KCkgewogICAgcmV0dXJuIHRoaXMucGFyZW50LmJvdW5kaW5nQ2xpZW50UmVjdDsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3QgZGl2ID0gdGhpcy5kaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtZWRpdG9yLXJvdGF0aW9uIiwgKDM2MCAtIHRoaXMucm90YXRpb24pICUgMzYwKTsKICAgIGRpdi5jbGFzc05hbWUgPSB0aGlzLm5hbWU7CiAgICBkaXYuc2V0QXR0cmlidXRlKCJpZCIsIHRoaXMuaWQpOwogICAgZGl2LnRhYkluZGV4ID0gdGhpcy4jZGlzYWJsZWQgPyAtMSA6IDA7CiAgICBkaXYuc2V0QXR0cmlidXRlKCJyb2xlIiwgImFwcGxpY2F0aW9uIik7CiAgICBpZiAodGhpcy5kZWZhdWx0TDEwbklkKSB7CiAgICAgIGRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIHRoaXMuZGVmYXVsdEwxMG5JZCk7CiAgICB9CiAgICBpZiAoIXRoaXMuX2lzVmlzaWJsZSkgewogICAgICBkaXYuY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7CiAgICB9CiAgICB0aGlzLnNldEluRm9yZWdyb3VuZCgpOwogICAgdGhpcy4jYWRkRm9jdXNMaXN0ZW5lcnMoKTsKICAgIGNvbnN0IFtwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgIGlmICh0aGlzLnBhcmVudFJvdGF0aW9uICUgMTgwICE9PSAwKSB7CiAgICAgIGRpdi5zdHlsZS5tYXhXaWR0aCA9IGAkeygxMDAgKiBwYXJlbnRIZWlnaHQgLyBwYXJlbnRXaWR0aCkudG9GaXhlZCgyKX0lYDsKICAgICAgZGl2LnN0eWxlLm1heEhlaWdodCA9IGAkeygxMDAgKiBwYXJlbnRXaWR0aCAvIHBhcmVudEhlaWdodCkudG9GaXhlZCgyKX0lYDsKICAgIH0KICAgIGNvbnN0IFt0eCwgdHldID0gdGhpcy5nZXRJbml0aWFsVHJhbnNsYXRpb24oKTsKICAgIHRoaXMudHJhbnNsYXRlKHR4LCB0eSk7CiAgICBiaW5kRXZlbnRzKHRoaXMsIGRpdiwgWyJrZXlkb3duIiwgInBvaW50ZXJkb3duIiwgImRibGNsaWNrIl0pOwogICAgaWYgKHRoaXMuaXNSZXNpemFibGUgJiYgdGhpcy5fdWlNYW5hZ2VyLl9zdXBwb3J0c1BpbmNoVG9ab29tKSB7CiAgICAgIHRoaXMuI3RvdWNoTWFuYWdlciB8fD0gbmV3IFRvdWNoTWFuYWdlcih7CiAgICAgICAgY29udGFpbmVyOiBkaXYsCiAgICAgICAgaXNQaW5jaGluZ0Rpc2FibGVkOiAoKSA9PiAhdGhpcy5pc1NlbGVjdGVkLAogICAgICAgIG9uUGluY2hTdGFydDogdGhpcy4jdG91Y2hQaW5jaFN0YXJ0Q2FsbGJhY2suYmluZCh0aGlzKSwKICAgICAgICBvblBpbmNoaW5nOiB0aGlzLiN0b3VjaFBpbmNoQ2FsbGJhY2suYmluZCh0aGlzKSwKICAgICAgICBvblBpbmNoRW5kOiB0aGlzLiN0b3VjaFBpbmNoRW5kQ2FsbGJhY2suYmluZCh0aGlzKSwKICAgICAgICBzaWduYWw6IHRoaXMuX3VpTWFuYWdlci5fc2lnbmFsCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5hZGRTdGFuZGFsb25lQ29tbWVudEJ1dHRvbigpOwogICAgdGhpcy5fdWlNYW5hZ2VyLl9lZGl0b3JVbmRvQmFyPy5oaWRlKCk7CiAgICByZXR1cm4gZGl2OwogIH0KICAjdG91Y2hQaW5jaFN0YXJ0Q2FsbGJhY2soKSB7CiAgICB0aGlzLiNzYXZlZERpbWVuc2lvbnMgPSB7CiAgICAgIHNhdmVkWDogdGhpcy54LAogICAgICBzYXZlZFk6IHRoaXMueSwKICAgICAgc2F2ZWRXaWR0aDogdGhpcy53aWR0aCwKICAgICAgc2F2ZWRIZWlnaHQ6IHRoaXMuaGVpZ2h0CiAgICB9OwogICAgdGhpcy4jYWx0VGV4dD8udG9nZ2xlKGZhbHNlKTsKICAgIHRoaXMucGFyZW50LnRvZ2dsZVBvaW50ZXJFdmVudHMoZmFsc2UpOwogIH0KICAjdG91Y2hQaW5jaENhbGxiYWNrKF9vcmlnaW4sIHByZXZEaXN0YW5jZSwgZGlzdGFuY2UpIHsKICAgIGNvbnN0IHNsb3dEb3duRmFjdG9yID0gMC43OwogICAgbGV0IGZhY3RvciA9IHNsb3dEb3duRmFjdG9yICogKGRpc3RhbmNlIC8gcHJldkRpc3RhbmNlKSArIDEgLSBzbG93RG93bkZhY3RvcjsKICAgIGlmIChmYWN0b3IgPT09IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSB0aGlzLiNnZXRSb3RhdGlvbk1hdHJpeCh0aGlzLnJvdGF0aW9uKTsKICAgIGNvbnN0IHRyYW5zZiA9ICh4LCB5KSA9PiBbcm90YXRpb25NYXRyaXhbMF0gKiB4ICsgcm90YXRpb25NYXRyaXhbMl0gKiB5LCByb3RhdGlvbk1hdHJpeFsxXSAqIHggKyByb3RhdGlvbk1hdHJpeFszXSAqIHldOwogICAgY29uc3QgW3BhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdID0gdGhpcy5wYXJlbnREaW1lbnNpb25zOwogICAgY29uc3Qgc2F2ZWRYID0gdGhpcy54OwogICAgY29uc3Qgc2F2ZWRZID0gdGhpcy55OwogICAgY29uc3Qgc2F2ZWRXaWR0aCA9IHRoaXMud2lkdGg7CiAgICBjb25zdCBzYXZlZEhlaWdodCA9IHRoaXMuaGVpZ2h0OwogICAgY29uc3QgbWluV2lkdGggPSBfQW5ub3RhdGlvbkVkaXRvci5NSU5fU0laRSAvIHBhcmVudFdpZHRoOwogICAgY29uc3QgbWluSGVpZ2h0ID0gX0Fubm90YXRpb25FZGl0b3IuTUlOX1NJWkUgLyBwYXJlbnRIZWlnaHQ7CiAgICBmYWN0b3IgPSBNYXRoLm1heChNYXRoLm1pbihmYWN0b3IsIDEgLyBzYXZlZFdpZHRoLCAxIC8gc2F2ZWRIZWlnaHQpLCBtaW5XaWR0aCAvIHNhdmVkV2lkdGgsIG1pbkhlaWdodCAvIHNhdmVkSGVpZ2h0KTsKICAgIGNvbnN0IG5ld1dpZHRoID0gX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKHNhdmVkV2lkdGggKiBmYWN0b3IpOwogICAgY29uc3QgbmV3SGVpZ2h0ID0gX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKHNhdmVkSGVpZ2h0ICogZmFjdG9yKTsKICAgIGlmIChuZXdXaWR0aCA9PT0gc2F2ZWRXaWR0aCAmJiBuZXdIZWlnaHQgPT09IHNhdmVkSGVpZ2h0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2luaXRpYWxSZWN0IHx8PSBbc2F2ZWRYLCBzYXZlZFksIHNhdmVkV2lkdGgsIHNhdmVkSGVpZ2h0XTsKICAgIGNvbnN0IHRyYW5zZkNlbnRlclBvaW50ID0gdHJhbnNmKHNhdmVkV2lkdGggLyAyLCBzYXZlZEhlaWdodCAvIDIpOwogICAgY29uc3QgY2VudGVyWCA9IF9Bbm5vdGF0aW9uRWRpdG9yLl9yb3VuZChzYXZlZFggKyB0cmFuc2ZDZW50ZXJQb2ludFswXSk7CiAgICBjb25zdCBjZW50ZXJZID0gX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKHNhdmVkWSArIHRyYW5zZkNlbnRlclBvaW50WzFdKTsKICAgIGNvbnN0IG5ld1RyYW5zZkNlbnRlclBvaW50ID0gdHJhbnNmKG5ld1dpZHRoIC8gMiwgbmV3SGVpZ2h0IC8gMik7CiAgICB0aGlzLnggPSBjZW50ZXJYIC0gbmV3VHJhbnNmQ2VudGVyUG9pbnRbMF07CiAgICB0aGlzLnkgPSBjZW50ZXJZIC0gbmV3VHJhbnNmQ2VudGVyUG9pbnRbMV07CiAgICB0aGlzLndpZHRoID0gbmV3V2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IG5ld0hlaWdodDsKICAgIHRoaXMuc2V0RGltcygpOwogICAgdGhpcy5maXhBbmRTZXRQb3NpdGlvbigpOwogICAgdGhpcy5fb25SZXNpemluZygpOwogIH0KICAjdG91Y2hQaW5jaEVuZENhbGxiYWNrKCkgewogICAgdGhpcy4jYWx0VGV4dD8udG9nZ2xlKHRydWUpOwogICAgdGhpcy5wYXJlbnQudG9nZ2xlUG9pbnRlckV2ZW50cyh0cnVlKTsKICAgIHRoaXMuI2FkZFJlc2l6ZVRvVW5kb1N0YWNrKCk7CiAgfQogIHBvaW50ZXJkb3duKGV2ZW50KSB7CiAgICBjb25zdCB7CiAgICAgIGlzTWFjCiAgICB9ID0gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybTsKICAgIGlmIChldmVudC5idXR0b24gIT09IDAgfHwgZXZlbnQuY3RybEtleSAmJiBpc01hYykgewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNoYXNCZWVuQ2xpY2tlZCA9IHRydWU7CiAgICBpZiAodGhpcy5faXNEcmFnZ2FibGUpIHsKICAgICAgdGhpcy4jc2V0VXBEcmFnU2Vzc2lvbihldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3NlbGVjdE9uUG9pbnRlckV2ZW50KGV2ZW50KTsKICB9CiAgI3NlbGVjdE9uUG9pbnRlckV2ZW50KGV2ZW50KSB7CiAgICBjb25zdCB7CiAgICAgIGlzTWFjCiAgICB9ID0gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybTsKICAgIGlmIChldmVudC5jdHJsS2V5ICYmICFpc01hYyB8fCBldmVudC5zaGlmdEtleSB8fCBldmVudC5tZXRhS2V5ICYmIGlzTWFjKSB7CiAgICAgIHRoaXMucGFyZW50LnRvZ2dsZVNlbGVjdGVkKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wYXJlbnQuc2V0U2VsZWN0ZWQodGhpcyk7CiAgICB9CiAgfQogICNzZXRVcERyYWdTZXNzaW9uKGV2ZW50KSB7CiAgICBjb25zdCB7CiAgICAgIGlzU2VsZWN0ZWQKICAgIH0gPSB0aGlzOwogICAgdGhpcy5fdWlNYW5hZ2VyLnNldFVwRHJhZ1Nlc3Npb24oKTsKICAgIGxldCBoYXNEcmFnZ2luZ1N0YXJ0ZWQgPSBmYWxzZTsKICAgIGNvbnN0IGFjID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5fdWlNYW5hZ2VyLmNvbWJpbmVkU2lnbmFsKGFjKTsKICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHBhc3NpdmU6IGZhbHNlLAogICAgICBzaWduYWwKICAgIH07CiAgICBjb25zdCBjYW5jZWxEcmFnID0gKGUpID0+IHsKICAgICAgYWMuYWJvcnQoKTsKICAgICAgdGhpcy4jZHJhZ1BvaW50ZXJJZCA9IG51bGw7CiAgICAgIHRoaXMuI2hhc0JlZW5DbGlja2VkID0gZmFsc2U7CiAgICAgIGlmICghdGhpcy5fdWlNYW5hZ2VyLmVuZERyYWdTZXNzaW9uKCkpIHsKICAgICAgICB0aGlzLiNzZWxlY3RPblBvaW50ZXJFdmVudChlKTsKICAgICAgfQogICAgICBpZiAoaGFzRHJhZ2dpbmdTdGFydGVkKSB7CiAgICAgICAgdGhpcy5fb25TdG9wRHJhZ2dpbmcoKTsKICAgICAgfQogICAgfTsKICAgIGlmIChpc1NlbGVjdGVkKSB7CiAgICAgIHRoaXMuI3ByZXZEcmFnWCA9IGV2ZW50LmNsaWVudFg7CiAgICAgIHRoaXMuI3ByZXZEcmFnWSA9IGV2ZW50LmNsaWVudFk7CiAgICAgIHRoaXMuI2RyYWdQb2ludGVySWQgPSBldmVudC5wb2ludGVySWQ7CiAgICAgIHRoaXMuI2RyYWdQb2ludGVyVHlwZSA9IGV2ZW50LnBvaW50ZXJUeXBlOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcm1vdmUiLCAoZSkgPT4gewogICAgICAgIGlmICghaGFzRHJhZ2dpbmdTdGFydGVkKSB7CiAgICAgICAgICBoYXNEcmFnZ2luZ1N0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgdGhpcy5fdWlNYW5hZ2VyLnRvZ2dsZUNvbW1lbnQodGhpcywgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgdGhpcy5fb25TdGFydERyYWdnaW5nKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGNsaWVudFg6IHgsCiAgICAgICAgICBjbGllbnRZOiB5LAogICAgICAgICAgcG9pbnRlcklkCiAgICAgICAgfSA9IGU7CiAgICAgICAgaWYgKHBvaW50ZXJJZCAhPT0gdGhpcy4jZHJhZ1BvaW50ZXJJZCkgewogICAgICAgICAgc3RvcEV2ZW50KGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBbdHgsIHR5XSA9IHRoaXMuc2NyZWVuVG9QYWdlVHJhbnNsYXRpb24oeCAtIHRoaXMuI3ByZXZEcmFnWCwgeSAtIHRoaXMuI3ByZXZEcmFnWSk7CiAgICAgICAgdGhpcy4jcHJldkRyYWdYID0geDsKICAgICAgICB0aGlzLiNwcmV2RHJhZ1kgPSB5OwogICAgICAgIHRoaXMuX3VpTWFuYWdlci5kcmFnU2VsZWN0ZWRFZGl0b3JzKHR4LCB0eSk7CiAgICAgIH0sIG9wdHMpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2htb3ZlIiwgc3RvcEV2ZW50LCBvcHRzKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgKGUpID0+IHsKICAgICAgICBpZiAoZS5wb2ludGVyVHlwZSA9PT0gdGhpcy4jZHJhZ1BvaW50ZXJUeXBlKSB7CiAgICAgICAgICBpZiAodGhpcy4jdG91Y2hNYW5hZ2VyIHx8IGUuaXNQcmltYXJ5KSB7CiAgICAgICAgICAgIGNhbmNlbERyYWcoZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0b3BFdmVudChlKTsKICAgICAgfSwgb3B0cyk7CiAgICB9CiAgICBjb25zdCBwb2ludGVyVXBDYWxsYmFjayA9IChlKSA9PiB7CiAgICAgIGlmICghdGhpcy4jZHJhZ1BvaW50ZXJJZCB8fCB0aGlzLiNkcmFnUG9pbnRlcklkID09PSBlLnBvaW50ZXJJZCkgewogICAgICAgIGNhbmNlbERyYWcoZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHN0b3BFdmVudChlKTsKICAgIH07CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgcG9pbnRlclVwQ2FsbGJhY2ssIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgcG9pbnRlclVwQ2FsbGJhY2ssIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICB9CiAgX29uU3RhcnREcmFnZ2luZygpIHsKICB9CiAgX29uU3RvcERyYWdnaW5nKCkgewogIH0KICBtb3ZlSW5ET00oKSB7CiAgICBpZiAodGhpcy4jbW92ZUluRE9NVGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy4jbW92ZUluRE9NVGltZW91dCk7CiAgICB9CiAgICB0aGlzLiNtb3ZlSW5ET01UaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRoaXMuI21vdmVJbkRPTVRpbWVvdXQgPSBudWxsOwogICAgICB0aGlzLnBhcmVudD8ubW92ZUVkaXRvckluRE9NKHRoaXMpOwogICAgfSwgMCk7CiAgfQogIF9zZXRQYXJlbnRBbmRQb3NpdGlvbihwYXJlbnQsIHgsIHkpIHsKICAgIHBhcmVudC5jaGFuZ2VQYXJlbnQodGhpcyk7CiAgICB0aGlzLnggPSB4OwogICAgdGhpcy55ID0geTsKICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICAgIHRoaXMuX29uVHJhbnNsYXRlZCgpOwogIH0KICBnZXRSZWN0KHR4LCB0eSwgcm90YXRpb24gPSB0aGlzLnJvdGF0aW9uKSB7CiAgICBjb25zdCBzY2FsZSA9IHRoaXMucGFyZW50U2NhbGU7CiAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFnZURpbWVuc2lvbnM7CiAgICBjb25zdCBbcGFnZVgsIHBhZ2VZXSA9IHRoaXMucGFnZVRyYW5zbGF0aW9uOwogICAgY29uc3Qgc2hpZnRYID0gdHggLyBzY2FsZTsKICAgIGNvbnN0IHNoaWZ0WSA9IHR5IC8gc2NhbGU7CiAgICBjb25zdCB4ID0gdGhpcy54ICogcGFnZVdpZHRoOwogICAgY29uc3QgeSA9IHRoaXMueSAqIHBhZ2VIZWlnaHQ7CiAgICBjb25zdCB3aWR0aCA9IHRoaXMud2lkdGggKiBwYWdlV2lkdGg7CiAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmhlaWdodCAqIHBhZ2VIZWlnaHQ7CiAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gW3ggKyBzaGlmdFggKyBwYWdlWCwgcGFnZUhlaWdodCAtIHkgLSBzaGlmdFkgLSBoZWlnaHQgKyBwYWdlWSwgeCArIHNoaWZ0WCArIHdpZHRoICsgcGFnZVgsIHBhZ2VIZWlnaHQgLSB5IC0gc2hpZnRZICsgcGFnZVldOwogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbeCArIHNoaWZ0WSArIHBhZ2VYLCBwYWdlSGVpZ2h0IC0geSArIHNoaWZ0WCArIHBhZ2VZLCB4ICsgc2hpZnRZICsgaGVpZ2h0ICsgcGFnZVgsIHBhZ2VIZWlnaHQgLSB5ICsgc2hpZnRYICsgd2lkdGggKyBwYWdlWV07CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiBbeCAtIHNoaWZ0WCAtIHdpZHRoICsgcGFnZVgsIHBhZ2VIZWlnaHQgLSB5ICsgc2hpZnRZICsgcGFnZVksIHggLSBzaGlmdFggKyBwYWdlWCwgcGFnZUhlaWdodCAtIHkgKyBzaGlmdFkgKyBoZWlnaHQgKyBwYWdlWV07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiBbeCAtIHNoaWZ0WSAtIGhlaWdodCArIHBhZ2VYLCBwYWdlSGVpZ2h0IC0geSAtIHNoaWZ0WCAtIHdpZHRoICsgcGFnZVksIHggLSBzaGlmdFkgKyBwYWdlWCwgcGFnZUhlaWdodCAtIHkgLSBzaGlmdFggKyBwYWdlWV07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdGF0aW9uIik7CiAgICB9CiAgfQogIGdldFJlY3RJbkN1cnJlbnRDb29yZHMocmVjdCwgcGFnZUhlaWdodCkgewogICAgY29uc3QgW3gxLCB5MSwgeDIsIHkyXSA9IHJlY3Q7CiAgICBjb25zdCB3aWR0aCA9IHgyIC0geDE7CiAgICBjb25zdCBoZWlnaHQgPSB5MiAtIHkxOwogICAgc3dpdGNoICh0aGlzLnJvdGF0aW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXR1cm4gW3gxLCBwYWdlSGVpZ2h0IC0geTIsIHdpZHRoLCBoZWlnaHRdOwogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbeDEsIHBhZ2VIZWlnaHQgLSB5MSwgaGVpZ2h0LCB3aWR0aF07CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiBbeDIsIHBhZ2VIZWlnaHQgLSB5MSwgd2lkdGgsIGhlaWdodF07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiBbeDIsIHBhZ2VIZWlnaHQgLSB5MiwgaGVpZ2h0LCB3aWR0aF07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdGF0aW9uIik7CiAgICB9CiAgfQogIGdldFBERlJlY3QoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRSZWN0KDAsIDApOwogIH0KICBnZXROb25IQ01Db2xvcigpIHsKICAgIHJldHVybiB0aGlzLmNvbG9yICYmIF9Bbm5vdGF0aW9uRWRpdG9yLl9jb2xvck1hbmFnZXIuY29udmVydCh0aGlzLl91aU1hbmFnZXIuZ2V0Tm9uSENNQ29sb3IodGhpcy5jb2xvcikpOwogIH0KICBvblVwZGF0ZWRDb2xvcigpIHsKICAgIHRoaXMuI2NvbW1lbnQ/Lm9uVXBkYXRlZENvbG9yKCk7CiAgfQogIGdldERhdGEoKSB7CiAgICBjb25zdCB7CiAgICAgIGNvbW1lbnQ6IHsKICAgICAgICB0ZXh0OiBzdHIsCiAgICAgICAgY29sb3IsCiAgICAgICAgZGF0ZSwKICAgICAgICBvcGFjaXR5LAogICAgICAgIGRlbGV0ZWQsCiAgICAgICAgcmljaFRleHQKICAgICAgfSwKICAgICAgdWlkOiBpZCwKICAgICAgcGFnZUluZGV4LAogICAgICBjcmVhdGlvbkRhdGUsCiAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgIH0gPSB0aGlzOwogICAgcmV0dXJuIHsKICAgICAgaWQsCiAgICAgIHBhZ2VJbmRleCwKICAgICAgcmVjdDogdGhpcy5nZXRQREZSZWN0KCksCiAgICAgIHJpY2hUZXh0LAogICAgICBjb250ZW50c09iajogewogICAgICAgIHN0cgogICAgICB9LAogICAgICBjcmVhdGlvbkRhdGUsCiAgICAgIG1vZGlmaWNhdGlvbkRhdGU6IGRhdGUgfHwgbW9kaWZpY2F0aW9uRGF0ZSwKICAgICAgcG9wdXBSZWY6ICFkZWxldGVkLAogICAgICBjb2xvciwKICAgICAgb3BhY2l0eQogICAgfTsKICB9CiAgb25jZUFkZGVkKGZvY3VzKSB7CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGVuYWJsZUVkaXRNb2RlKCkgewogICAgaWYgKHRoaXMuaXNJbkVkaXRNb2RlKCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5wYXJlbnQuc2V0RWRpdGluZ1N0YXRlKGZhbHNlKTsKICAgIHRoaXMuI2lzSW5FZGl0TW9kZSA9IHRydWU7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZGlzYWJsZUVkaXRNb2RlKCkgewogICAgaWYgKCF0aGlzLmlzSW5FZGl0TW9kZSgpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRoaXMucGFyZW50LnNldEVkaXRpbmdTdGF0ZSh0cnVlKTsKICAgIHRoaXMuI2lzSW5FZGl0TW9kZSA9IGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGlzSW5FZGl0TW9kZSgpIHsKICAgIHJldHVybiB0aGlzLiNpc0luRWRpdE1vZGU7CiAgfQogIHNob3VsZEdldEtleWJvYXJkRXZlbnRzKCkgewogICAgcmV0dXJuIHRoaXMuI2lzUmVzaXplckVuYWJsZWRGb3JLZXlib2FyZDsKICB9CiAgbmVlZHNUb0JlUmVidWlsdCgpIHsKICAgIHJldHVybiB0aGlzLmRpdiAmJiAhdGhpcy5pc0F0dGFjaGVkVG9ET007CiAgfQogIGdldCBpc09uU2NyZWVuKCkgewogICAgY29uc3QgewogICAgICB0b3AsCiAgICAgIGxlZnQsCiAgICAgIGJvdHRvbSwKICAgICAgcmlnaHQKICAgIH0gPSB0aGlzLmdldENsaWVudERpbWVuc2lvbnMoKTsKICAgIGNvbnN0IHsKICAgICAgaW5uZXJIZWlnaHQsCiAgICAgIGlubmVyV2lkdGgKICAgIH0gPSB3aW5kb3c7CiAgICByZXR1cm4gbGVmdCA8IGlubmVyV2lkdGggJiYgcmlnaHQgPiAwICYmIHRvcCA8IGlubmVySGVpZ2h0ICYmIGJvdHRvbSA+IDA7CiAgfQogICNhZGRGb2N1c0xpc3RlbmVycygpIHsKICAgIGlmICh0aGlzLiNmb2N1c0FDIHx8ICF0aGlzLmRpdikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNmb2N1c0FDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5fdWlNYW5hZ2VyLmNvbWJpbmVkU2lnbmFsKHRoaXMuI2ZvY3VzQUMpOwogICAgdGhpcy5kaXYuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXNpbiIsIHRoaXMuZm9jdXNpbi5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0aGlzLmRpdi5hZGRFdmVudExpc3RlbmVyKCJmb2N1c291dCIsIHRoaXMuZm9jdXNvdXQuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogIH0KICByZWJ1aWxkKCkgewogICAgdGhpcy4jYWRkRm9jdXNMaXN0ZW5lcnMoKTsKICB9CiAgcm90YXRlKF9hbmdsZSkgewogIH0KICByZXNpemUoKSB7CiAgfQogIHNlcmlhbGl6ZURlbGV0ZWQoKSB7CiAgICByZXR1cm4gewogICAgICBpZDogdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkLAogICAgICBkZWxldGVkOiB0cnVlLAogICAgICBwYWdlSW5kZXg6IHRoaXMucGFnZUluZGV4LAogICAgICBwb3B1cFJlZjogdGhpcy5faW5pdGlhbERhdGE/LnBvcHVwUmVmIHx8ICIiCiAgICB9OwogIH0KICBzZXJpYWxpemUoaXNGb3JDb3B5aW5nID0gZmFsc2UsIGNvbnRleHQgPSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICBhbm5vdGF0aW9uVHlwZTogdGhpcy5tb2RlLAogICAgICBwYWdlSW5kZXg6IHRoaXMucGFnZUluZGV4LAogICAgICByZWN0OiB0aGlzLmdldFBERlJlY3QoKSwKICAgICAgcm90YXRpb246IHRoaXMucm90YXRpb24sCiAgICAgIHN0cnVjdFRyZWVQYXJlbnRJZDogdGhpcy5fc3RydWN0VHJlZVBhcmVudElkLAogICAgICBwb3B1cFJlZjogdGhpcy5faW5pdGlhbERhdGE/LnBvcHVwUmVmIHx8ICIiCiAgICB9OwogIH0KICBzdGF0aWMgYXN5bmMgZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpIHsKICAgIGNvbnN0IGVkaXRvciA9IG5ldyB0aGlzLnByb3RvdHlwZS5jb25zdHJ1Y3Rvcih7CiAgICAgIHBhcmVudCwKICAgICAgaWQ6IHBhcmVudC5nZXROZXh0SWQoKSwKICAgICAgdWlNYW5hZ2VyLAogICAgICBhbm5vdGF0aW9uRWxlbWVudElkOiBkYXRhLmFubm90YXRpb25FbGVtZW50SWQsCiAgICAgIGNyZWF0aW9uRGF0ZTogZGF0YS5jcmVhdGlvbkRhdGUsCiAgICAgIG1vZGlmaWNhdGlvbkRhdGU6IGRhdGEubW9kaWZpY2F0aW9uRGF0ZQogICAgfSk7CiAgICBlZGl0b3Iucm90YXRpb24gPSBkYXRhLnJvdGF0aW9uOwogICAgZWRpdG9yLiNhY2Nlc3NpYmlsaXR5RGF0YSA9IGRhdGEuYWNjZXNzaWJpbGl0eURhdGE7CiAgICBlZGl0b3IuX2lzQ29weSA9IGRhdGEuaXNDb3B5IHx8IGZhbHNlOwogICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSBlZGl0b3IucGFnZURpbWVuc2lvbnM7CiAgICBjb25zdCBbeCwgeSwgd2lkdGgsIGhlaWdodF0gPSBlZGl0b3IuZ2V0UmVjdEluQ3VycmVudENvb3JkcyhkYXRhLnJlY3QsIHBhZ2VIZWlnaHQpOwogICAgZWRpdG9yLnggPSB4IC8gcGFnZVdpZHRoOwogICAgZWRpdG9yLnkgPSB5IC8gcGFnZUhlaWdodDsKICAgIGVkaXRvci53aWR0aCA9IHdpZHRoIC8gcGFnZVdpZHRoOwogICAgZWRpdG9yLmhlaWdodCA9IGhlaWdodCAvIHBhZ2VIZWlnaHQ7CiAgICByZXR1cm4gZWRpdG9yOwogIH0KICBnZXQgaGFzQmVlbk1vZGlmaWVkKCkgewogICAgcmV0dXJuICEhdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkICYmICh0aGlzLmRlbGV0ZWQgfHwgdGhpcy5zZXJpYWxpemUoKSAhPT0gbnVsbCk7CiAgfQogIHJlbW92ZSgpIHsKICAgIHRoaXMuI2ZvY3VzQUM/LmFib3J0KCk7CiAgICB0aGlzLiNmb2N1c0FDID0gbnVsbDsKICAgIGlmICghdGhpcy5pc0VtcHR5KCkpIHsKICAgICAgdGhpcy5jb21taXQoKTsKICAgIH0KICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICB0aGlzLnBhcmVudC5yZW1vdmUodGhpcyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl91aU1hbmFnZXIucmVtb3ZlRWRpdG9yKHRoaXMpOwogICAgfQogICAgdGhpcy5oaWRlQ29tbWVudFBvcHVwKCk7CiAgICBpZiAodGhpcy4jbW92ZUluRE9NVGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy4jbW92ZUluRE9NVGltZW91dCk7CiAgICAgIHRoaXMuI21vdmVJbkRPTVRpbWVvdXQgPSBudWxsOwogICAgfQogICAgdGhpcy4jc3RvcFJlc2l6aW5nKCk7CiAgICB0aGlzLnJlbW92ZUVkaXRUb29sYmFyKCk7CiAgICBpZiAodGhpcy4jdGVsZW1ldHJ5VGltZW91dHMpIHsKICAgICAgZm9yIChjb25zdCB0aW1lb3V0IG9mIHRoaXMuI3RlbGVtZXRyeVRpbWVvdXRzLnZhbHVlcygpKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICB9CiAgICAgIHRoaXMuI3RlbGVtZXRyeVRpbWVvdXRzID0gbnVsbDsKICAgIH0KICAgIHRoaXMucGFyZW50ID0gbnVsbDsKICAgIHRoaXMuI3RvdWNoTWFuYWdlcj8uZGVzdHJveSgpOwogICAgdGhpcy4jdG91Y2hNYW5hZ2VyID0gbnVsbDsKICAgIHRoaXMuI2Zha2VBbm5vdGF0aW9uPy5yZW1vdmUoKTsKICAgIHRoaXMuI2Zha2VBbm5vdGF0aW9uID0gbnVsbDsKICB9CiAgZ2V0IGlzUmVzaXphYmxlKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBtYWtlUmVzaXphYmxlKCkgewogICAgaWYgKHRoaXMuaXNSZXNpemFibGUpIHsKICAgICAgdGhpcy4jY3JlYXRlUmVzaXplcnMoKTsKICAgICAgdGhpcy4jcmVzaXplcnNEaXYuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CiAgICB9CiAgfQogIGdldCB0b29sYmFyUG9zaXRpb24oKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZ2V0IGNvbW1lbnRCdXR0b25Qb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl91aU1hbmFnZXIuZGlyZWN0aW9uID09PSAibHRyIiA/IFsxLCAwXSA6IFswLCAwXTsKICB9CiAgZ2V0IGNvbW1lbnRCdXR0b25Qb3NpdGlvbkluUGFnZSgpIHsKICAgIGNvbnN0IHsKICAgICAgY29tbWVudEJ1dHRvblBvc2l0aW9uOiBbcG9zWCwgcG9zWV0KICAgIH0gPSB0aGlzOwogICAgY29uc3QgW2JsWCwgYmxZLCB0clgsIHRyWV0gPSB0aGlzLmdldFBERlJlY3QoKTsKICAgIHJldHVybiBbX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKGJsWCArICh0clggLSBibFgpICogcG9zWCksIF9Bbm5vdGF0aW9uRWRpdG9yLl9yb3VuZChibFkgKyAodHJZIC0gYmxZKSAqICgxIC0gcG9zWSkpXTsKICB9CiAgZ2V0IGNvbW1lbnRCdXR0b25Db2xvcigpIHsKICAgIHJldHVybiB0aGlzLl91aU1hbmFnZXIubWFrZUNvbW1lbnRDb2xvcih0aGlzLmdldE5vbkhDTUNvbG9yKCksIHRoaXMub3BhY2l0eSk7CiAgfQogIGdldCBjb21tZW50UG9wdXBQb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50LmNvbW1lbnRQb3B1cFBvc2l0aW9uSW5MYXllcjsKICB9CiAgc2V0IGNvbW1lbnRQb3B1cFBvc2l0aW9uKHBvcykgewogICAgdGhpcy4jY29tbWVudC5jb21tZW50UG9wdXBQb3NpdGlvbkluTGF5ZXIgPSBwb3M7CiAgfQogIGhhc0RlZmF1bHRQb3B1cFBvc2l0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuI2NvbW1lbnQuaGFzRGVmYXVsdFBvcHVwUG9zaXRpb24oKTsKICB9CiAgZ2V0IGNvbW1lbnRCdXR0b25XaWR0aCgpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50LmNvbW1lbnRCdXR0b25XaWR0aDsKICB9CiAgZ2V0IGVsZW1lbnRCZWZvcmVQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLmRpdjsKICB9CiAgc2V0Q29tbWVudEJ1dHRvblN0YXRlcyhvcHRpb25zKSB7CiAgICB0aGlzLiNjb21tZW50Py5zZXRDb21tZW50QnV0dG9uU3RhdGVzKG9wdGlvbnMpOwogIH0KICBrZXlkb3duKGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuaXNSZXNpemFibGUgfHwgZXZlbnQudGFyZ2V0ICE9PSB0aGlzLmRpdiB8fCBldmVudC5rZXkgIT09ICJFbnRlciIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fdWlNYW5hZ2VyLnNldFNlbGVjdGVkKHRoaXMpOwogICAgdGhpcy4jc2F2ZWREaW1lbnNpb25zID0gewogICAgICBzYXZlZFg6IHRoaXMueCwKICAgICAgc2F2ZWRZOiB0aGlzLnksCiAgICAgIHNhdmVkV2lkdGg6IHRoaXMud2lkdGgsCiAgICAgIHNhdmVkSGVpZ2h0OiB0aGlzLmhlaWdodAogICAgfTsKICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy4jcmVzaXplcnNEaXYuY2hpbGRyZW47CiAgICBpZiAoIXRoaXMuI2FsbFJlc2l6ZXJEaXZzKSB7CiAgICAgIHRoaXMuI2FsbFJlc2l6ZXJEaXZzID0gQXJyYXkuZnJvbShjaGlsZHJlbik7CiAgICAgIGNvbnN0IGJvdW5kUmVzaXplcktleWRvd24gPSB0aGlzLiNyZXNpemVyS2V5ZG93bi5iaW5kKHRoaXMpOwogICAgICBjb25zdCBib3VuZFJlc2l6ZXJCbHVyID0gdGhpcy4jcmVzaXplckJsdXIuYmluZCh0aGlzKTsKICAgICAgY29uc3Qgc2lnbmFsID0gdGhpcy5fdWlNYW5hZ2VyLl9zaWduYWw7CiAgICAgIGZvciAoY29uc3QgZGl2IG9mIHRoaXMuI2FsbFJlc2l6ZXJEaXZzKSB7CiAgICAgICAgY29uc3QgbmFtZSA9IGRpdi5nZXRBdHRyaWJ1dGUoImRhdGEtcmVzaXplci1uYW1lIik7CiAgICAgICAgZGl2LnNldEF0dHJpYnV0ZSgicm9sZSIsICJzcGluYnV0dG9uIik7CiAgICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCBib3VuZFJlc2l6ZXJLZXlkb3duLCB7CiAgICAgICAgICBzaWduYWwKICAgICAgICB9KTsKICAgICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIGJvdW5kUmVzaXplckJsdXIsIHsKICAgICAgICAgIHNpZ25hbAogICAgICAgIH0pOwogICAgICAgIGRpdi5hZGRFdmVudExpc3RlbmVyKCJmb2N1cyIsIHRoaXMuI3Jlc2l6ZXJGb2N1cy5iaW5kKHRoaXMsIG5hbWUpLCB7CiAgICAgICAgICBzaWduYWwKICAgICAgICB9KTsKICAgICAgICBkaXYuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCBfQW5ub3RhdGlvbkVkaXRvci5fbDEwblJlc2l6ZXJbbmFtZV0pOwogICAgICB9CiAgICB9CiAgICBjb25zdCBmaXJzdCA9IHRoaXMuI2FsbFJlc2l6ZXJEaXZzWzBdOwogICAgbGV0IGZpcnN0UG9zaXRpb24gPSAwOwogICAgZm9yIChjb25zdCBkaXYgb2YgY2hpbGRyZW4pIHsKICAgICAgaWYgKGRpdiA9PT0gZmlyc3QpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBmaXJzdFBvc2l0aW9uKys7CiAgICB9CiAgICBjb25zdCBuZXh0Rmlyc3RQb3NpdGlvbiA9ICgzNjAgLSB0aGlzLnJvdGF0aW9uICsgdGhpcy5wYXJlbnRSb3RhdGlvbikgJSAzNjAgLyA5MCAqICh0aGlzLiNhbGxSZXNpemVyRGl2cy5sZW5ndGggLyA0KTsKICAgIGlmIChuZXh0Rmlyc3RQb3NpdGlvbiAhPT0gZmlyc3RQb3NpdGlvbikgewogICAgICBpZiAobmV4dEZpcnN0UG9zaXRpb24gPCBmaXJzdFBvc2l0aW9uKSB7CiAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IGZpcnN0UG9zaXRpb24gLSBuZXh0Rmlyc3RQb3NpdGlvbjsgaTIrKykgewogICAgICAgICAgdGhpcy4jcmVzaXplcnNEaXYuYXBwZW5kKHRoaXMuI3Jlc2l6ZXJzRGl2LmZpcnN0RWxlbWVudENoaWxkKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobmV4dEZpcnN0UG9zaXRpb24gPiBmaXJzdFBvc2l0aW9uKSB7CiAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG5leHRGaXJzdFBvc2l0aW9uIC0gZmlyc3RQb3NpdGlvbjsgaTIrKykgewogICAgICAgICAgdGhpcy4jcmVzaXplcnNEaXYuZmlyc3RFbGVtZW50Q2hpbGQuYmVmb3JlKHRoaXMuI3Jlc2l6ZXJzRGl2Lmxhc3RFbGVtZW50Q2hpbGQpOwogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgaSA9IDA7CiAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgY2hpbGRyZW4pIHsKICAgICAgICBjb25zdCBkaXYgPSB0aGlzLiNhbGxSZXNpemVyRGl2c1tpKytdOwogICAgICAgIGNvbnN0IG5hbWUgPSBkaXYuZ2V0QXR0cmlidXRlKCJkYXRhLXJlc2l6ZXItbmFtZSIpOwogICAgICAgIGNoaWxkLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0Fubm90YXRpb25FZGl0b3IuX2wxMG5SZXNpemVyW25hbWVdKTsKICAgICAgfQogICAgfQogICAgdGhpcy4jc2V0UmVzaXplclRhYkluZGV4KDApOwogICAgdGhpcy4jaXNSZXNpemVyRW5hYmxlZEZvcktleWJvYXJkID0gdHJ1ZTsKICAgIHRoaXMuI3Jlc2l6ZXJzRGl2LmZpcnN0RWxlbWVudENoaWxkLmZvY3VzKHsKICAgICAgZm9jdXNWaXNpYmxlOiB0cnVlCiAgICB9KTsKICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICB9CiAgI3Jlc2l6ZXJLZXlkb3duKGV2ZW50KSB7CiAgICBfQW5ub3RhdGlvbkVkaXRvci5fcmVzaXplcktleWJvYXJkTWFuYWdlci5leGVjKHRoaXMsIGV2ZW50KTsKICB9CiAgI3Jlc2l6ZXJCbHVyKGV2ZW50KSB7CiAgICBpZiAodGhpcy4jaXNSZXNpemVyRW5hYmxlZEZvcktleWJvYXJkICYmIGV2ZW50LnJlbGF0ZWRUYXJnZXQ/LnBhcmVudE5vZGUgIT09IHRoaXMuI3Jlc2l6ZXJzRGl2KSB7CiAgICAgIHRoaXMuI3N0b3BSZXNpemluZygpOwogICAgfQogIH0KICAjcmVzaXplckZvY3VzKG5hbWUpIHsKICAgIHRoaXMuI2ZvY3VzZWRSZXNpemVyTmFtZSA9IHRoaXMuI2lzUmVzaXplckVuYWJsZWRGb3JLZXlib2FyZCA/IG5hbWUgOiAiIjsKICB9CiAgI3NldFJlc2l6ZXJUYWJJbmRleCh2YWx1ZSkgewogICAgaWYgKCF0aGlzLiNhbGxSZXNpemVyRGl2cykgewogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGNvbnN0IGRpdiBvZiB0aGlzLiNhbGxSZXNpemVyRGl2cykgewogICAgICBkaXYudGFiSW5kZXggPSB2YWx1ZTsKICAgIH0KICB9CiAgX3Jlc2l6ZVdpdGhLZXlib2FyZCh4LCB5KSB7CiAgICBpZiAoIXRoaXMuI2lzUmVzaXplckVuYWJsZWRGb3JLZXlib2FyZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNyZXNpemVyUG9pbnRlcm1vdmUodGhpcy4jZm9jdXNlZFJlc2l6ZXJOYW1lLCB7CiAgICAgIGRlbHRhWDogeCwKICAgICAgZGVsdGFZOiB5LAogICAgICBmcm9tS2V5Ym9hcmQ6IHRydWUKICAgIH0pOwogIH0KICAjc3RvcFJlc2l6aW5nKCkgewogICAgdGhpcy4jaXNSZXNpemVyRW5hYmxlZEZvcktleWJvYXJkID0gZmFsc2U7CiAgICB0aGlzLiNzZXRSZXNpemVyVGFiSW5kZXgoLTEpOwogICAgdGhpcy4jYWRkUmVzaXplVG9VbmRvU3RhY2soKTsKICB9CiAgX3N0b3BSZXNpemluZ1dpdGhLZXlib2FyZCgpIHsKICAgIHRoaXMuI3N0b3BSZXNpemluZygpOwogICAgdGhpcy5kaXYuZm9jdXMoKTsKICB9CiAgc2VsZWN0KCkgewogICAgaWYgKHRoaXMuaXNTZWxlY3RlZCAmJiB0aGlzLl9lZGl0VG9vbGJhcikgewogICAgICB0aGlzLl9lZGl0VG9vbGJhci5zaG93KCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuaXNTZWxlY3RlZCA9IHRydWU7CiAgICB0aGlzLm1ha2VSZXNpemFibGUoKTsKICAgIHRoaXMuZGl2Py5jbGFzc0xpc3QuYWRkKCJzZWxlY3RlZEVkaXRvciIpOwogICAgaWYgKCF0aGlzLl9lZGl0VG9vbGJhcikgewogICAgICB0aGlzLmFkZEVkaXRUb29sYmFyKCkudGhlbigoKSA9PiB7CiAgICAgICAgaWYgKHRoaXMuZGl2Py5jbGFzc0xpc3QuY29udGFpbnMoInNlbGVjdGVkRWRpdG9yIikpIHsKICAgICAgICAgIHRoaXMuX2VkaXRUb29sYmFyPy5zaG93KCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fZWRpdFRvb2xiYXI/LnNob3coKTsKICAgIHRoaXMuI2FsdFRleHQ/LnRvZ2dsZUFsdFRleHRCYWRnZShmYWxzZSk7CiAgfQogIGZvY3VzKCkgewogICAgaWYgKHRoaXMuZGl2ICYmICF0aGlzLmRpdi5jb250YWlucyhkb2N1bWVudC5hY3RpdmVFbGVtZW50KSkgewogICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZGl2Py5mb2N1cyh7CiAgICAgICAgcHJldmVudFNjcm9sbDogdHJ1ZQogICAgICB9KSwgMCk7CiAgICB9CiAgfQogIHVuc2VsZWN0KCkgewogICAgaWYgKCF0aGlzLmlzU2VsZWN0ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5pc1NlbGVjdGVkID0gZmFsc2U7CiAgICB0aGlzLiNyZXNpemVyc0Rpdj8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7CiAgICB0aGlzLmRpdj8uY2xhc3NMaXN0LnJlbW92ZSgic2VsZWN0ZWRFZGl0b3IiKTsKICAgIGlmICh0aGlzLmRpdj8uY29udGFpbnMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLmN1cnJlbnRMYXllci5kaXYuZm9jdXMoewogICAgICAgIHByZXZlbnRTY3JvbGw6IHRydWUKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLl9lZGl0VG9vbGJhcj8uaGlkZSgpOwogICAgdGhpcy4jYWx0VGV4dD8udG9nZ2xlQWx0VGV4dEJhZGdlKHRydWUpOwogICAgdGhpcy5oaWRlQ29tbWVudFBvcHVwKCk7CiAgfQogIGhpZGVDb21tZW50UG9wdXAoKSB7CiAgICBpZiAodGhpcy5oYXNDb21tZW50KSB7CiAgICAgIHRoaXMuX3VpTWFuYWdlci50b2dnbGVDb21tZW50KG51bGwpOwogICAgfQogIH0KICB1cGRhdGVQYXJhbXModHlwZSwgdmFsdWUpIHsKICB9CiAgZGlzYWJsZUVkaXRpbmcoKSB7CiAgfQogIGVuYWJsZUVkaXRpbmcoKSB7CiAgfQogIGdldCBjYW5DaGFuZ2VDb250ZW50KCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBlbnRlckluRWRpdE1vZGUoKSB7CiAgICBpZiAoIXRoaXMuY2FuQ2hhbmdlQ29udGVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmVuYWJsZUVkaXRNb2RlKCk7CiAgICB0aGlzLmRpdi5mb2N1cygpOwogIH0KICBkYmxjbGljayhldmVudCkgewogICAgaWYgKGV2ZW50LnRhcmdldC5ub2RlTmFtZSA9PT0gIkJVVFRPTiIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5lbnRlckluRWRpdE1vZGUoKTsKICAgIHRoaXMucGFyZW50LnVwZGF0ZVRvb2xiYXIoewogICAgICBtb2RlOiB0aGlzLmNvbnN0cnVjdG9yLl9lZGl0b3JUeXBlLAogICAgICBlZGl0SWQ6IHRoaXMudWlkCiAgICB9KTsKICB9CiAgZ2V0RWxlbWVudEZvckFsdFRleHQoKSB7CiAgICByZXR1cm4gdGhpcy5kaXY7CiAgfQogIGdldCBjb250ZW50RGl2KCkgewogICAgcmV0dXJuIHRoaXMuZGl2OwogIH0KICBnZXQgaXNFZGl0aW5nKCkgewogICAgcmV0dXJuIHRoaXMuI2lzRWRpdGluZzsKICB9CiAgc2V0IGlzRWRpdGluZyh2YWx1ZSkgewogICAgdGhpcy4jaXNFZGl0aW5nID0gdmFsdWU7CiAgICBpZiAoIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh2YWx1ZSkgewogICAgICB0aGlzLnBhcmVudC5zZXRTZWxlY3RlZCh0aGlzKTsKICAgICAgdGhpcy5wYXJlbnQuc2V0QWN0aXZlRWRpdG9yKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wYXJlbnQuc2V0QWN0aXZlRWRpdG9yKG51bGwpOwogICAgfQogIH0KICBzdGF0aWMgZ2V0IE1JTl9TSVpFKCkgewogICAgcmV0dXJuIDE2OwogIH0KICBzdGF0aWMgY2FuQ3JlYXRlTmV3RW1wdHlFZGl0b3IoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZ2V0IHRlbGVtZXRyeUluaXRpYWxEYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgYWN0aW9uOiAiYWRkZWQiCiAgICB9OwogIH0KICBnZXQgdGVsZW1ldHJ5RmluYWxEYXRhKCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIF9yZXBvcnRUZWxlbWV0cnkoZGF0YSwgbXVzdFdhaXQgPSBmYWxzZSkgewogICAgaWYgKG11c3RXYWl0KSB7CiAgICAgIHRoaXMuI3RlbGVtZXRyeVRpbWVvdXRzIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBjb25zdCB7CiAgICAgICAgYWN0aW9uCiAgICAgIH0gPSBkYXRhOwogICAgICBsZXQgdGltZW91dCA9IHRoaXMuI3RlbGVtZXRyeVRpbWVvdXRzLmdldChhY3Rpb24pOwogICAgICBpZiAodGltZW91dCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgfQogICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdGhpcy5fcmVwb3J0VGVsZW1ldHJ5KGRhdGEpOwogICAgICAgIHRoaXMuI3RlbGVtZXRyeVRpbWVvdXRzLmRlbGV0ZShhY3Rpb24pOwogICAgICAgIGlmICh0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cy5zaXplID09PSAwKSB7CiAgICAgICAgICB0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cyA9IG51bGw7CiAgICAgICAgfQogICAgICB9LCBfQW5ub3RhdGlvbkVkaXRvci5fdGVsZW1ldHJ5VGltZW91dCk7CiAgICAgIHRoaXMuI3RlbGVtZXRyeVRpbWVvdXRzLnNldChhY3Rpb24sIHRpbWVvdXQpOwogICAgICByZXR1cm47CiAgICB9CiAgICBkYXRhLnR5cGUgfHw9IHRoaXMuZWRpdG9yVHlwZTsKICAgIHRoaXMuX3VpTWFuYWdlci5fZXZlbnRCdXMuZGlzcGF0Y2goInJlcG9ydHRlbGVtZXRyeSIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICBkZXRhaWxzOiB7CiAgICAgICAgdHlwZTogImVkaXRpbmciLAogICAgICAgIGRhdGEKICAgICAgfQogICAgfSk7CiAgfQogIHNob3codmlzaWJsZSA9IHRoaXMuX2lzVmlzaWJsZSkgewogICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgiaGlkZGVuIiwgIXZpc2libGUpOwogICAgdGhpcy5faXNWaXNpYmxlID0gdmlzaWJsZTsKICB9CiAgZW5hYmxlKCkgewogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHRoaXMuZGl2LnRhYkluZGV4ID0gMDsKICAgIH0KICAgIHRoaXMuI2Rpc2FibGVkID0gZmFsc2U7CiAgfQogIGRpc2FibGUoKSB7CiAgICBpZiAodGhpcy5kaXYpIHsKICAgICAgdGhpcy5kaXYudGFiSW5kZXggPSAtMTsKICAgIH0KICAgIHRoaXMuI2Rpc2FibGVkID0gdHJ1ZTsKICB9CiAgdXBkYXRlRmFrZUFubm90YXRpb25FbGVtZW50KGFubm90YXRpb25MYXllcikgewogICAgaWYgKCF0aGlzLiNmYWtlQW5ub3RhdGlvbiAmJiAhdGhpcy5kZWxldGVkKSB7CiAgICAgIHRoaXMuI2Zha2VBbm5vdGF0aW9uID0gYW5ub3RhdGlvbkxheWVyLmFkZEZha2VBbm5vdGF0aW9uKHRoaXMpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIHRoaXMuI2Zha2VBbm5vdGF0aW9uLnJlbW92ZSgpOwogICAgICB0aGlzLiNmYWtlQW5ub3RhdGlvbiA9IG51bGw7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLmhhc0VkaXRlZENvbW1lbnQgfHwgdGhpcy5faGFzQmVlbk1vdmVkIHx8IHRoaXMuX2hhc0JlZW5SZXNpemVkKSB7CiAgICAgIHRoaXMuI2Zha2VBbm5vdGF0aW9uLnVwZGF0ZUVkaXRlZCh7CiAgICAgICAgcmVjdDogdGhpcy5nZXRQREZSZWN0KCksCiAgICAgICAgcG9wdXA6IHRoaXMuY29tbWVudAogICAgICB9KTsKICAgIH0KICB9CiAgcmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbikgewogICAgaWYgKHRoaXMuZGVsZXRlZCkgewogICAgICBhbm5vdGF0aW9uLmhpZGUoKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBsZXQgY29udGVudCA9IGFubm90YXRpb24uY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoIi5hbm5vdGF0aW9uQ29udGVudCIpOwogICAgaWYgKCFjb250ZW50KSB7CiAgICAgIGNvbnRlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY29udGVudC5jbGFzc0xpc3QuYWRkKCJhbm5vdGF0aW9uQ29udGVudCIsIHRoaXMuZWRpdG9yVHlwZSk7CiAgICAgIGFubm90YXRpb24uY29udGFpbmVyLnByZXBlbmQoY29udGVudCk7CiAgICB9IGVsc2UgaWYgKGNvbnRlbnQubm9kZU5hbWUgPT09ICJDQU5WQVMiKSB7CiAgICAgIGNvbnN0IGNhbnZhcyA9IGNvbnRlbnQ7CiAgICAgIGNvbnRlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY29udGVudC5jbGFzc0xpc3QuYWRkKCJhbm5vdGF0aW9uQ29udGVudCIsIHRoaXMuZWRpdG9yVHlwZSk7CiAgICAgIGNhbnZhcy5iZWZvcmUoY29udGVudCk7CiAgICB9CiAgICByZXR1cm4gY29udGVudDsKICB9CiAgcmVzZXRBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKSB7CiAgICBjb25zdCB7CiAgICAgIGZpcnN0RWxlbWVudENoaWxkCiAgICB9ID0gYW5ub3RhdGlvbi5jb250YWluZXI7CiAgICBpZiAoZmlyc3RFbGVtZW50Q2hpbGQ/Lm5vZGVOYW1lID09PSAiRElWIiAmJiBmaXJzdEVsZW1lbnRDaGlsZC5jbGFzc0xpc3QuY29udGFpbnMoImFubm90YXRpb25Db250ZW50IikpIHsKICAgICAgZmlyc3RFbGVtZW50Q2hpbGQucmVtb3ZlKCk7CiAgICB9CiAgfQp9Owp2YXIgRmFrZUVkaXRvciA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVkaXRvciB7CiAgY29uc3RydWN0b3IocGFyYW1zKSB7CiAgICBzdXBlcihwYXJhbXMpOwogICAgdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkID0gcGFyYW1zLmFubm90YXRpb25FbGVtZW50SWQ7CiAgICB0aGlzLmRlbGV0ZWQgPSB0cnVlOwogIH0KICBzZXJpYWxpemUoKSB7CiAgICByZXR1cm4gdGhpcy5zZXJpYWxpemVEZWxldGVkKCk7CiAgfQp9Owp2YXIgU0VFRCA9IDMyODUzNzc1MjA7CnZhciBNQVNLX0hJR0ggPSA0Mjk0OTAxNzYwOwp2YXIgTUFTS19MT1cgPSA2NTUzNTsKdmFyIE11cm11ckhhc2gzXzY0ID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHNlZWQpIHsKICAgIHRoaXMuaDEgPSBzZWVkID8gc2VlZCAmIDQyOTQ5NjcyOTUgOiBTRUVEOwogICAgdGhpcy5oMiA9IHNlZWQgPyBzZWVkICYgNDI5NDk2NzI5NSA6IFNFRUQ7CiAgfQogIHVwZGF0ZShpbnB1dCkgewogICAgbGV0IGRhdGEsIGxlbmd0aDsKICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICJzdHJpbmciKSB7CiAgICAgIGRhdGEgPSBuZXcgVWludDhBcnJheShpbnB1dC5sZW5ndGggKiAyKTsKICAgICAgbGVuZ3RoID0gMDsKICAgICAgZm9yIChsZXQgaSA9IDAsIGlpID0gaW5wdXQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGNvbnN0IGNvZGUgPSBpbnB1dC5jaGFyQ29kZUF0KGkpOwogICAgICAgIGlmIChjb2RlIDw9IDI1NSkgewogICAgICAgICAgZGF0YVtsZW5ndGgrK10gPSBjb2RlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkYXRhW2xlbmd0aCsrXSA9IGNvZGUgPj4+IDg7CiAgICAgICAgICBkYXRhW2xlbmd0aCsrXSA9IGNvZGUgJiAyNTU7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhpbnB1dCkpIHsKICAgICAgZGF0YSA9IGlucHV0LnNsaWNlKCk7CiAgICAgIGxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBkYXRhIGZvcm1hdCwgbXVzdCBiZSBhIHN0cmluZyBvciBUeXBlZEFycmF5LiIpOwogICAgfQogICAgY29uc3QgYmxvY2tDb3VudHMgPSBsZW5ndGggPj4gMjsKICAgIGNvbnN0IHRhaWxMZW5ndGggPSBsZW5ndGggLSBibG9ja0NvdW50cyAqIDQ7CiAgICBjb25zdCBkYXRhVWludDMyID0gbmV3IFVpbnQzMkFycmF5KGRhdGEuYnVmZmVyLCAwLCBibG9ja0NvdW50cyk7CiAgICBsZXQgazEgPSAwLCBrMiA9IDA7CiAgICBsZXQgaDEgPSB0aGlzLmgxLCBoMiA9IHRoaXMuaDI7CiAgICBjb25zdCBDMSA9IDM0MzI5MTgzNTMsIEMyID0gNDYxODQ1OTA3OwogICAgY29uc3QgQzFfTE9XID0gQzEgJiBNQVNLX0xPVywgQzJfTE9XID0gQzIgJiBNQVNLX0xPVzsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tDb3VudHM7IGkrKykgewogICAgICBpZiAoaSAmIDEpIHsKICAgICAgICBrMSA9IGRhdGFVaW50MzJbaV07CiAgICAgICAgazEgPSBrMSAqIEMxICYgTUFTS19ISUdIIHwgazEgKiBDMV9MT1cgJiBNQVNLX0xPVzsKICAgICAgICBrMSA9IGsxIDw8IDE1IHwgazEgPj4+IDE3OwogICAgICAgIGsxID0gazEgKiBDMiAmIE1BU0tfSElHSCB8IGsxICogQzJfTE9XICYgTUFTS19MT1c7CiAgICAgICAgaDEgXj0gazE7CiAgICAgICAgaDEgPSBoMSA8PCAxMyB8IGgxID4+PiAxOTsKICAgICAgICBoMSA9IGgxICogNSArIDM4NjQyOTIxOTY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgazIgPSBkYXRhVWludDMyW2ldOwogICAgICAgIGsyID0gazIgKiBDMSAmIE1BU0tfSElHSCB8IGsyICogQzFfTE9XICYgTUFTS19MT1c7CiAgICAgICAgazIgPSBrMiA8PCAxNSB8IGsyID4+PiAxNzsKICAgICAgICBrMiA9IGsyICogQzIgJiBNQVNLX0hJR0ggfCBrMiAqIEMyX0xPVyAmIE1BU0tfTE9XOwogICAgICAgIGgyIF49IGsyOwogICAgICAgIGgyID0gaDIgPDwgMTMgfCBoMiA+Pj4gMTk7CiAgICAgICAgaDIgPSBoMiAqIDUgKyAzODY0MjkyMTk2OwogICAgICB9CiAgICB9CiAgICBrMSA9IDA7CiAgICBzd2l0Y2ggKHRhaWxMZW5ndGgpIHsKICAgICAgY2FzZSAzOgogICAgICAgIGsxIF49IGRhdGFbYmxvY2tDb3VudHMgKiA0ICsgMl0gPDwgMTY7CiAgICAgIGNhc2UgMjoKICAgICAgICBrMSBePSBkYXRhW2Jsb2NrQ291bnRzICogNCArIDFdIDw8IDg7CiAgICAgIGNhc2UgMToKICAgICAgICBrMSBePSBkYXRhW2Jsb2NrQ291bnRzICogNF07CiAgICAgICAgazEgPSBrMSAqIEMxICYgTUFTS19ISUdIIHwgazEgKiBDMV9MT1cgJiBNQVNLX0xPVzsKICAgICAgICBrMSA9IGsxIDw8IDE1IHwgazEgPj4+IDE3OwogICAgICAgIGsxID0gazEgKiBDMiAmIE1BU0tfSElHSCB8IGsxICogQzJfTE9XICYgTUFTS19MT1c7CiAgICAgICAgaWYgKGJsb2NrQ291bnRzICYgMSkgewogICAgICAgICAgaDEgXj0gazE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGgyIF49IGsxOwogICAgICAgIH0KICAgIH0KICAgIHRoaXMuaDEgPSBoMTsKICAgIHRoaXMuaDIgPSBoMjsKICB9CiAgaGV4ZGlnZXN0KCkgewogICAgbGV0IGgxID0gdGhpcy5oMSwgaDIgPSB0aGlzLmgyOwogICAgaDEgXj0gaDIgPj4+IDE7CiAgICBoMSA9IGgxICogMzk4MTgwNjc5NyAmIE1BU0tfSElHSCB8IGgxICogMzYwNDUgJiBNQVNLX0xPVzsKICAgIGgyID0gaDIgKiA0MjgzNTQzNTExICYgTUFTS19ISUdIIHwgKChoMiA8PCAxNiB8IGgxID4+PiAxNikgKiAyOTUwMTYzNzk3ICYgTUFTS19ISUdIKSA+Pj4gMTY7CiAgICBoMSBePSBoMiA+Pj4gMTsKICAgIGgxID0gaDEgKiA0NDQ5ODQ0MDMgJiBNQVNLX0hJR0ggfCBoMSAqIDYwNDk5ICYgTUFTS19MT1c7CiAgICBoMiA9IGgyICogMzMwMTg4MjM2NiAmIE1BU0tfSElHSCB8ICgoaDIgPDwgMTYgfCBoMSA+Pj4gMTYpICogMzEyMDQzNzg5MyAmIE1BU0tfSElHSCkgPj4+IDE2OwogICAgaDEgXj0gaDIgPj4+IDE7CiAgICByZXR1cm4gKGgxID4+PiAwKS50b1N0cmluZygxNikucGFkU3RhcnQoOCwgIjAiKSArIChoMiA+Pj4gMCkudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDgsICIwIik7CiAgfQp9Owp2YXIgU2VyaWFsaXphYmxlRW1wdHkgPSBPYmplY3QuZnJlZXplKHsKICBtYXA6IG51bGwsCiAgaGFzaDogIiIsCiAgdHJhbnNmZXI6IHZvaWQgMAp9KTsKdmFyIEFubm90YXRpb25TdG9yYWdlID0gY2xhc3MgewogICNtb2RpZmllZCA9IGZhbHNlOwogICNtb2RpZmllZElkcyA9IG51bGw7CiAgI2VkaXRvcnNNYXAgPSBudWxsOwogICNzdG9yYWdlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHRoaXMub25TZXRNb2RpZmllZCA9IG51bGw7CiAgICB0aGlzLm9uUmVzZXRNb2RpZmllZCA9IG51bGw7CiAgICB0aGlzLm9uQW5ub3RhdGlvbkVkaXRvciA9IG51bGw7CiAgfQogIGdldFZhbHVlKGtleSwgZGVmYXVsdFZhbHVlKSB7CiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI3N0b3JhZ2UuZ2V0KGtleSk7CiAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgfQogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oZGVmYXVsdFZhbHVlLCB2YWx1ZSk7CiAgfQogIGdldFJhd1ZhbHVlKGtleSkgewogICAgcmV0dXJuIHRoaXMuI3N0b3JhZ2UuZ2V0KGtleSk7CiAgfQogIHJlbW92ZShrZXkpIHsKICAgIGNvbnN0IHN0b3JlZFZhbHVlID0gdGhpcy4jc3RvcmFnZS5nZXQoa2V5KTsKICAgIGlmIChzdG9yZWRWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzdG9yZWRWYWx1ZSBpbnN0YW5jZW9mIEFubm90YXRpb25FZGl0b3IpIHsKICAgICAgdGhpcy4jZWRpdG9yc01hcC5kZWxldGUoc3RvcmVkVmFsdWUuYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgICB9CiAgICB0aGlzLiNzdG9yYWdlLmRlbGV0ZShrZXkpOwogICAgaWYgKHRoaXMuI3N0b3JhZ2Uuc2l6ZSA9PT0gMCkgewogICAgICB0aGlzLnJlc2V0TW9kaWZpZWQoKTsKICAgIH0KICAgIGlmICh0eXBlb2YgdGhpcy5vbkFubm90YXRpb25FZGl0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLiNzdG9yYWdlLnZhbHVlcygpKSB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5ub3RhdGlvbkVkaXRvcikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLm9uQW5ub3RhdGlvbkVkaXRvcihudWxsKTsKICAgIH0KICB9CiAgc2V0VmFsdWUoa2V5LCB2YWx1ZSkgewogICAgY29uc3Qgb2JqID0gdGhpcy4jc3RvcmFnZS5nZXQoa2V5KTsKICAgIGxldCBtb2RpZmllZCA9IGZhbHNlOwogICAgaWYgKG9iaiAhPT0gdm9pZCAwKSB7CiAgICAgIGZvciAoY29uc3QgW2VudHJ5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKHZhbHVlKSkgewogICAgICAgIGlmIChvYmpbZW50cnldICE9PSB2YWwpIHsKICAgICAgICAgIG1vZGlmaWVkID0gdHJ1ZTsKICAgICAgICAgIG9ialtlbnRyeV0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBtb2RpZmllZCA9IHRydWU7CiAgICAgIHRoaXMuI3N0b3JhZ2Uuc2V0KGtleSwgdmFsdWUpOwogICAgfQogICAgaWYgKG1vZGlmaWVkKSB7CiAgICAgIHRoaXMuI3NldE1vZGlmaWVkKCk7CiAgICB9CiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBBbm5vdGF0aW9uRWRpdG9yKSB7CiAgICAgICh0aGlzLiNlZGl0b3JzTWFwIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKS5zZXQodmFsdWUuYW5ub3RhdGlvbkVsZW1lbnRJZCwgdmFsdWUpOwogICAgICBpZiAodHlwZW9mIHRoaXMub25Bbm5vdGF0aW9uRWRpdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhpcy5vbkFubm90YXRpb25FZGl0b3IodmFsdWUuY29uc3RydWN0b3IuX3R5cGUpOwogICAgICB9CiAgICB9CiAgfQogIGhhcyhrZXkpIHsKICAgIHJldHVybiB0aGlzLiNzdG9yYWdlLmhhcyhrZXkpOwogIH0KICBnZXQgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLiNzdG9yYWdlLnNpemU7CiAgfQogICNzZXRNb2RpZmllZCgpIHsKICAgIGlmICghdGhpcy4jbW9kaWZpZWQpIHsKICAgICAgdGhpcy4jbW9kaWZpZWQgPSB0cnVlOwogICAgICBpZiAodHlwZW9mIHRoaXMub25TZXRNb2RpZmllZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMub25TZXRNb2RpZmllZCgpOwogICAgICB9CiAgICB9CiAgfQogIHJlc2V0TW9kaWZpZWQoKSB7CiAgICBpZiAodGhpcy4jbW9kaWZpZWQpIHsKICAgICAgdGhpcy4jbW9kaWZpZWQgPSBmYWxzZTsKICAgICAgaWYgKHR5cGVvZiB0aGlzLm9uUmVzZXRNb2RpZmllZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMub25SZXNldE1vZGlmaWVkKCk7CiAgICAgIH0KICAgIH0KICB9CiAgZ2V0IHByaW50KCkgewogICAgcmV0dXJuIG5ldyBQcmludEFubm90YXRpb25TdG9yYWdlKHRoaXMpOwogIH0KICBnZXQgc2VyaWFsaXphYmxlKCkgewogICAgaWYgKHRoaXMuI3N0b3JhZ2Uuc2l6ZSA9PT0gMCkgewogICAgICByZXR1cm4gU2VyaWFsaXphYmxlRW1wdHk7CiAgICB9CiAgICBjb25zdCBtYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBoYXNoID0gbmV3IE11cm11ckhhc2gzXzY0KCksIHRyYW5zZmVyID0gW107CiAgICBjb25zdCBjb250ZXh0ID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBsZXQgaGFzQml0bWFwID0gZmFsc2U7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbF0gb2YgdGhpcy4jc3RvcmFnZSkgewogICAgICBjb25zdCBzZXJpYWxpemVkID0gdmFsIGluc3RhbmNlb2YgQW5ub3RhdGlvbkVkaXRvciA/IHZhbC5zZXJpYWxpemUoZmFsc2UsIGNvbnRleHQpIDogdmFsOwogICAgICBpZiAoc2VyaWFsaXplZCkgewogICAgICAgIG1hcC5zZXQoa2V5LCBzZXJpYWxpemVkKTsKICAgICAgICBoYXNoLnVwZGF0ZShgJHtrZXl9OiR7SlNPTi5zdHJpbmdpZnkoc2VyaWFsaXplZCl9YCk7CiAgICAgICAgaGFzQml0bWFwIHx8PSAhIXNlcmlhbGl6ZWQuYml0bWFwOwogICAgICB9CiAgICB9CiAgICBpZiAoaGFzQml0bWFwKSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgbWFwLnZhbHVlcygpKSB7CiAgICAgICAgaWYgKHZhbHVlLmJpdG1hcCkgewogICAgICAgICAgdHJhbnNmZXIucHVzaCh2YWx1ZS5iaXRtYXApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG1hcC5zaXplID4gMCA/IHsKICAgICAgbWFwLAogICAgICBoYXNoOiBoYXNoLmhleGRpZ2VzdCgpLAogICAgICB0cmFuc2ZlcgogICAgfSA6IFNlcmlhbGl6YWJsZUVtcHR5OwogIH0KICBnZXQgZWRpdG9yU3RhdHMoKSB7CiAgICBsZXQgc3RhdHMgPSBudWxsOwogICAgY29uc3QgdHlwZVRvRWRpdG9yID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGxldCBudW1iZXJPZkVkaXRlZENvbW1lbnRzID0gMDsKICAgIGxldCBudW1iZXJPZkRlbGV0ZWRDb21tZW50cyA9IDA7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHRoaXMuI3N0b3JhZ2UudmFsdWVzKCkpIHsKICAgICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBBbm5vdGF0aW9uRWRpdG9yKSkgewogICAgICAgIGlmICh2YWx1ZS5wb3B1cCkgewogICAgICAgICAgaWYgKHZhbHVlLnBvcHVwLmRlbGV0ZWQpIHsKICAgICAgICAgICAgbnVtYmVyT2ZEZWxldGVkQ29tbWVudHMgKz0gMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG51bWJlck9mRWRpdGVkQ29tbWVudHMgKz0gMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlLmlzQ29tbWVudERlbGV0ZWQpIHsKICAgICAgICBudW1iZXJPZkRlbGV0ZWRDb21tZW50cyArPSAxOwogICAgICB9IGVsc2UgaWYgKHZhbHVlLmhhc0VkaXRlZENvbW1lbnQpIHsKICAgICAgICBudW1iZXJPZkVkaXRlZENvbW1lbnRzICs9IDE7CiAgICAgIH0KICAgICAgY29uc3QgZWRpdG9yU3RhdHMgPSB2YWx1ZS50ZWxlbWV0cnlGaW5hbERhdGE7CiAgICAgIGlmICghZWRpdG9yU3RhdHMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCB7CiAgICAgICAgdHlwZQogICAgICB9ID0gZWRpdG9yU3RhdHM7CiAgICAgIGlmICghdHlwZVRvRWRpdG9yLmhhcyh0eXBlKSkgewogICAgICAgIHR5cGVUb0VkaXRvci5zZXQodHlwZSwgT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlKS5jb25zdHJ1Y3Rvcik7CiAgICAgIH0KICAgICAgc3RhdHMgfHw9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBjb25zdCBtYXAgPSBzdGF0c1t0eXBlXSB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKGVkaXRvclN0YXRzKSkgewogICAgICAgIGlmIChrZXkgPT09ICJ0eXBlIikgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGxldCBjb3VudGVycyA9IG1hcC5nZXQoa2V5KTsKICAgICAgICBpZiAoIWNvdW50ZXJzKSB7CiAgICAgICAgICBjb3VudGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICBtYXAuc2V0KGtleSwgY291bnRlcnMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb3VudCA9IGNvdW50ZXJzLmdldCh2YWwpID8/IDA7CiAgICAgICAgY291bnRlcnMuc2V0KHZhbCwgY291bnQgKyAxKTsKICAgICAgfQogICAgfQogICAgaWYgKG51bWJlck9mRGVsZXRlZENvbW1lbnRzID4gMCB8fCBudW1iZXJPZkVkaXRlZENvbW1lbnRzID4gMCkgewogICAgICBzdGF0cyB8fD0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHN0YXRzLmNvbW1lbnRzID0gewogICAgICAgIGRlbGV0ZWQ6IG51bWJlck9mRGVsZXRlZENvbW1lbnRzLAogICAgICAgIGVkaXRlZDogbnVtYmVyT2ZFZGl0ZWRDb21tZW50cwogICAgICB9OwogICAgfQogICAgaWYgKCFzdGF0cykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGZvciAoY29uc3QgW3R5cGUsIGVkaXRvcl0gb2YgdHlwZVRvRWRpdG9yKSB7CiAgICAgIHN0YXRzW3R5cGVdID0gZWRpdG9yLmNvbXB1dGVUZWxlbWV0cnlGaW5hbERhdGEoc3RhdHNbdHlwZV0pOwogICAgfQogICAgcmV0dXJuIHN0YXRzOwogIH0KICByZXNldE1vZGlmaWVkSWRzKCkgewogICAgdGhpcy4jbW9kaWZpZWRJZHMgPSBudWxsOwogIH0KICB1cGRhdGVFZGl0b3IoYW5ub3RhdGlvbklkLCBkYXRhKSB7CiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI2VkaXRvcnNNYXA/LmdldChhbm5vdGF0aW9uSWQpOwogICAgaWYgKHZhbHVlKSB7CiAgICAgIHZhbHVlLnVwZGF0ZUZyb21Bbm5vdGF0aW9uTGF5ZXIoZGF0YSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBnZXRFZGl0b3IoYW5ub3RhdGlvbklkKSB7CiAgICByZXR1cm4gdGhpcy4jZWRpdG9yc01hcD8uZ2V0KGFubm90YXRpb25JZCkgfHwgbnVsbDsKICB9CiAgZ2V0IG1vZGlmaWVkSWRzKCkgewogICAgaWYgKHRoaXMuI21vZGlmaWVkSWRzKSB7CiAgICAgIHJldHVybiB0aGlzLiNtb2RpZmllZElkczsKICAgIH0KICAgIGNvbnN0IGlkcyA9IFtdOwogICAgaWYgKHRoaXMuI2VkaXRvcnNNYXApIHsKICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLiNlZGl0b3JzTWFwLnZhbHVlcygpKSB7CiAgICAgICAgaWYgKCF2YWx1ZS5zZXJpYWxpemUoKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlkcy5wdXNoKHZhbHVlLmFubm90YXRpb25FbGVtZW50SWQpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy4jbW9kaWZpZWRJZHMgPSB7CiAgICAgIGlkczogbmV3IFNldChpZHMpLAogICAgICBoYXNoOiBpZHMuam9pbigiLCIpCiAgICB9OwogIH0KICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLiNzdG9yYWdlLmVudHJpZXMoKTsKICB9Cn07CnZhciBQcmludEFubm90YXRpb25TdG9yYWdlID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uU3RvcmFnZSB7CiAgI3NlcmlhbGl6YWJsZTsKICBjb25zdHJ1Y3RvcihwYXJlbnQpIHsKICAgIHN1cGVyKCk7CiAgICBjb25zdCB7CiAgICAgIG1hcCwKICAgICAgaGFzaCwKICAgICAgdHJhbnNmZXIKICAgIH0gPSBwYXJlbnQuc2VyaWFsaXphYmxlOwogICAgY29uc3QgY2xvbmUgPSBzdHJ1Y3R1cmVkQ2xvbmUobWFwLCB0cmFuc2ZlciA/IHsKICAgICAgdHJhbnNmZXIKICAgIH0gOiBudWxsKTsKICAgIHRoaXMuI3NlcmlhbGl6YWJsZSA9IHsKICAgICAgbWFwOiBjbG9uZSwKICAgICAgaGFzaCwKICAgICAgdHJhbnNmZXIKICAgIH07CiAgfQogIGdldCBwcmludCgpIHsKICAgIHVucmVhY2hhYmxlKCJTaG91bGQgbm90IGNhbGwgUHJpbnRBbm5vdGF0aW9uU3RvcmFnZS5wcmludCIpOwogIH0KICBnZXQgc2VyaWFsaXphYmxlKCkgewogICAgcmV0dXJuIHRoaXMuI3NlcmlhbGl6YWJsZTsKICB9CiAgZ2V0IG1vZGlmaWVkSWRzKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAibW9kaWZpZWRJZHMiLCB7CiAgICAgIGlkczogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICAgICAgaGFzaDogIiIKICAgIH0pOwogIH0KfTsKdmFyIEZvbnRMb2FkZXIgPSBjbGFzcyB7CiAgI3N5c3RlbUZvbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICBjb25zdHJ1Y3Rvcih7CiAgICBvd25lckRvY3VtZW50ID0gZ2xvYmFsVGhpcy5kb2N1bWVudCwKICAgIHN0eWxlRWxlbWVudCA9IG51bGwKICB9KSB7CiAgICB0aGlzLl9kb2N1bWVudCA9IG93bmVyRG9jdW1lbnQ7CiAgICB0aGlzLm5hdGl2ZUZvbnRGYWNlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICB0aGlzLnN0eWxlRWxlbWVudCA9IG51bGw7CiAgICB0aGlzLmxvYWRpbmdSZXF1ZXN0cyA9IFtdOwogICAgdGhpcy5sb2FkVGVzdEZvbnRJZCA9IDA7CiAgfQogIGFkZE5hdGl2ZUZvbnRGYWNlKG5hdGl2ZUZvbnRGYWNlKSB7CiAgICB0aGlzLm5hdGl2ZUZvbnRGYWNlcy5hZGQobmF0aXZlRm9udEZhY2UpOwogICAgdGhpcy5fZG9jdW1lbnQuZm9udHMuYWRkKG5hdGl2ZUZvbnRGYWNlKTsKICB9CiAgcmVtb3ZlTmF0aXZlRm9udEZhY2UobmF0aXZlRm9udEZhY2UpIHsKICAgIHRoaXMubmF0aXZlRm9udEZhY2VzLmRlbGV0ZShuYXRpdmVGb250RmFjZSk7CiAgICB0aGlzLl9kb2N1bWVudC5mb250cy5kZWxldGUobmF0aXZlRm9udEZhY2UpOwogIH0KICBpbnNlcnRSdWxlKHJ1bGUpIHsKICAgIGlmICghdGhpcy5zdHlsZUVsZW1lbnQpIHsKICAgICAgdGhpcy5zdHlsZUVsZW1lbnQgPSB0aGlzLl9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICB0aGlzLl9kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXS5hcHBlbmQodGhpcy5zdHlsZUVsZW1lbnQpOwogICAgfQogICAgY29uc3Qgc3R5bGVTaGVldCA9IHRoaXMuc3R5bGVFbGVtZW50LnNoZWV0OwogICAgc3R5bGVTaGVldC5pbnNlcnRSdWxlKHJ1bGUsIHN0eWxlU2hlZXQuY3NzUnVsZXMubGVuZ3RoKTsKICB9CiAgY2xlYXIoKSB7CiAgICBmb3IgKGNvbnN0IG5hdGl2ZUZvbnRGYWNlIG9mIHRoaXMubmF0aXZlRm9udEZhY2VzKSB7CiAgICAgIHRoaXMuX2RvY3VtZW50LmZvbnRzLmRlbGV0ZShuYXRpdmVGb250RmFjZSk7CiAgICB9CiAgICB0aGlzLm5hdGl2ZUZvbnRGYWNlcy5jbGVhcigpOwogICAgdGhpcy4jc3lzdGVtRm9udHMuY2xlYXIoKTsKICAgIGlmICh0aGlzLnN0eWxlRWxlbWVudCkgewogICAgICB0aGlzLnN0eWxlRWxlbWVudC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdHlsZUVsZW1lbnQgPSBudWxsOwogICAgfQogIH0KICBhc3luYyBsb2FkU3lzdGVtRm9udCh7CiAgICBzeXN0ZW1Gb250SW5mbzogaW5mbzIsCiAgICBkaXNhYmxlRm9udEZhY2UsCiAgICBfaW5zcGVjdEZvbnQKICB9KSB7CiAgICBpZiAoIWluZm8yIHx8IHRoaXMuI3N5c3RlbUZvbnRzLmhhcyhpbmZvMi5sb2FkZWROYW1lKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBhc3NlcnQoIWRpc2FibGVGb250RmFjZSwgImxvYWRTeXN0ZW1Gb250IHNob3VsZG4ndCBiZSBjYWxsZWQgd2hlbiBgZGlzYWJsZUZvbnRGYWNlYCBpcyBzZXQuIik7CiAgICBpZiAodGhpcy5pc0ZvbnRMb2FkaW5nQVBJU3VwcG9ydGVkKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBsb2FkZWROYW1lLAogICAgICAgIHNyYywKICAgICAgICBzdHlsZQogICAgICB9ID0gaW5mbzI7CiAgICAgIGNvbnN0IGZvbnRGYWNlID0gbmV3IEZvbnRGYWNlKGxvYWRlZE5hbWUsIHNyYywgc3R5bGUpOwogICAgICB0aGlzLmFkZE5hdGl2ZUZvbnRGYWNlKGZvbnRGYWNlKTsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBmb250RmFjZS5sb2FkKCk7CiAgICAgICAgdGhpcy4jc3lzdGVtRm9udHMuYWRkKGxvYWRlZE5hbWUpOwogICAgICAgIF9pbnNwZWN0Rm9udD8uKGluZm8yKTsKICAgICAgfSBjYXRjaCB7CiAgICAgICAgd2FybihgQ2Fubm90IGxvYWQgc3lzdGVtIGZvbnQ6ICR7aW5mbzIuYmFzZUZvbnROYW1lfSwgaW5zdGFsbGluZyBpdCBjb3VsZCBoZWxwIHRvIGltcHJvdmUgUERGIHJlbmRlcmluZy5gKTsKICAgICAgICB0aGlzLnJlbW92ZU5hdGl2ZUZvbnRGYWNlKGZvbnRGYWNlKTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICB1bnJlYWNoYWJsZSgiTm90IGltcGxlbWVudGVkOiBsb2FkU3lzdGVtRm9udCB3aXRob3V0IHRoZSBGb250IExvYWRpbmcgQVBJLiIpOwogIH0KICBhc3luYyBiaW5kKGZvbnQpIHsKICAgIGlmIChmb250LmF0dGFjaGVkIHx8IGZvbnQubWlzc2luZ0ZpbGUgJiYgIWZvbnQuc3lzdGVtRm9udEluZm8pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9udC5hdHRhY2hlZCA9IHRydWU7CiAgICBpZiAoZm9udC5zeXN0ZW1Gb250SW5mbykgewogICAgICBhd2FpdCB0aGlzLmxvYWRTeXN0ZW1Gb250KGZvbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5pc0ZvbnRMb2FkaW5nQVBJU3VwcG9ydGVkKSB7CiAgICAgIGNvbnN0IG5hdGl2ZUZvbnRGYWNlID0gZm9udC5jcmVhdGVOYXRpdmVGb250RmFjZSgpOwogICAgICBpZiAobmF0aXZlRm9udEZhY2UpIHsKICAgICAgICB0aGlzLmFkZE5hdGl2ZUZvbnRGYWNlKG5hdGl2ZUZvbnRGYWNlKTsKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgbmF0aXZlRm9udEZhY2UubG9hZGVkOwogICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICB3YXJuKGBGYWlsZWQgdG8gbG9hZCBmb250ICcke25hdGl2ZUZvbnRGYWNlLmZhbWlseX0nOiAnJHtleH0nLmApOwogICAgICAgICAgZm9udC5kaXNhYmxlRm9udEZhY2UgPSB0cnVlOwogICAgICAgICAgdGhyb3cgZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHJ1bGUgPSBmb250LmNyZWF0ZUZvbnRGYWNlUnVsZSgpOwogICAgaWYgKHJ1bGUpIHsKICAgICAgdGhpcy5pbnNlcnRSdWxlKHJ1bGUpOwogICAgICBpZiAodGhpcy5pc1N5bmNGb250TG9hZGluZ1N1cHBvcnRlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLl9xdWV1ZUxvYWRpbmdDYWxsYmFjayhyZXNvbHZlKTsKICAgICAgICB0aGlzLl9wcmVwYXJlRm9udExvYWRFdmVudChmb250LCByZXF1ZXN0KTsKICAgICAgfSk7CiAgICB9CiAgfQogIGdldCBpc0ZvbnRMb2FkaW5nQVBJU3VwcG9ydGVkKCkgewogICAgY29uc3QgaGFzRm9udHMgPSAhIXRoaXMuX2RvY3VtZW50Py5mb250czsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzRm9udExvYWRpbmdBUElTdXBwb3J0ZWQiLCBoYXNGb250cyk7CiAgfQogIGdldCBpc1N5bmNGb250TG9hZGluZ1N1cHBvcnRlZCgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzU3luY0ZvbnRMb2FkaW5nU3VwcG9ydGVkIiwgaXNOb2RlSlMgfHwgdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybS5pc0ZpcmVmb3gpOwogIH0KICBfcXVldWVMb2FkaW5nQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgIGZ1bmN0aW9uIGNvbXBsZXRlUmVxdWVzdCgpIHsKICAgICAgYXNzZXJ0KCFyZXF1ZXN0LmRvbmUsICJjb21wbGV0ZVJlcXVlc3QoKSBjYW5ub3QgYmUgY2FsbGVkIHR3aWNlLiIpOwogICAgICByZXF1ZXN0LmRvbmUgPSB0cnVlOwogICAgICB3aGlsZSAobG9hZGluZ1JlcXVlc3RzLmxlbmd0aCA+IDAgJiYgbG9hZGluZ1JlcXVlc3RzWzBdLmRvbmUpIHsKICAgICAgICBjb25zdCBvdGhlclJlcXVlc3QgPSBsb2FkaW5nUmVxdWVzdHMuc2hpZnQoKTsKICAgICAgICBzZXRUaW1lb3V0KG90aGVyUmVxdWVzdC5jYWxsYmFjaywgMCk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHsKICAgICAgbG9hZGluZ1JlcXVlc3RzCiAgICB9ID0gdGhpczsKICAgIGNvbnN0IHJlcXVlc3QgPSB7CiAgICAgIGRvbmU6IGZhbHNlLAogICAgICBjb21wbGV0ZTogY29tcGxldGVSZXF1ZXN0LAogICAgICBjYWxsYmFjawogICAgfTsKICAgIGxvYWRpbmdSZXF1ZXN0cy5wdXNoKHJlcXVlc3QpOwogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfQogIGdldCBfbG9hZFRlc3RGb250KCkgewogICAgY29uc3QgdGVzdEZvbnQgPSBhdG9iKCJUMVJVVHdBTEFJQUFBd0F3UTBaR0lESHRaZzRBQUFPWUFBQUFnVVpHVkUxbGt6WndBQUFFSEFBQUFCeEhSRVZHQUJRQUZRQUFCRGdBQUFBZVQxTXZNbFlOWXdrQUFBRWdBQUFBWUdOdFlYQUJEUUxVQUFBQ05BQUFBVUpvWldGay94VkZEUUFBQUx3QUFBQTJhR2hsWVFka0Erb0FBQUQwQUFBQUpHaHRkSGdENkFBQUFBQUVXQUFBQUFadFlYaHdBQUpRQUFBQUFSZ0FBQUFHYm1GdFpWam1kSDRBQUFHQUFBQUFzWEJ2YzNUL2hnQXpBQUFEZUFBQUFDQUFBUUFBQUFFQUFMWlJGc1JmRHp6MUFBc0Q2QUFBQUFET0JPVExBQUFBQU00S0hEd0FBQUFBQStnRElRQUFBQWdBQWdBQUFBQUFBQUFCQUFBRElRQUFBRm9ENkFBQUFBQUQ2QUFCQUFBQUFBQUFBQUFBQUFBQUFBQUFBUUFBVUFBQUFnQUFBQVFENkFIMEFBVUFBQUtLQXJ3QUFBQ01Bb29DdkFBQUFlQUFNUUVDQUFBQ0FBWUpBQUFBQUFBQUFBQUFBUUFBQUFBQUFBQUFBQUFBQUZCbVJXUUF3QUF1QUM0RElQODRBRm9ESVFBQUFBQUFBUUFBQUFBQUFBQUFBQ0FBSUFBQkFBQUFEZ0N1QUFFQUFBQUFBQUFBQVFBQUFBRUFBQUFBQUFFQUFRQUFBQUVBQUFBQUFBSUFBUUFBQUFFQUFBQUFBQU1BQVFBQUFBRUFBQUFBQUFRQUFRQUFBQUVBQUFBQUFBVUFBUUFBQUFFQUFBQUFBQVlBQVFBQUFBTUFBUVFKQUFBQUFnQUJBQU1BQVFRSkFBRUFBZ0FCQUFNQUFRUUpBQUlBQWdBQkFBTUFBUVFKQUFNQUFnQUJBQU1BQVFRSkFBUUFBZ0FCQUFNQUFRUUpBQVVBQWdBQkFBTUFBUVFKQUFZQUFnQUJXQUJZQUFBQUFBQUFBd0FBQUFNQUFBQWNBQUVBQUFBQUFEd0FBd0FCQUFBQUhBQUVBQ0FBQUFBRUFBUUFBUUFBQUM3Ly93QUFBQzcvLy8vVEFBRUFBQUFBQUFBQkJnQUFBUUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUVBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBTUFBQUFBQUFEL2d3QXlBQUFBQVFBQUFBQUFBQUFBQUFBQUFBQUFBQUFCQUFRRUFBRUJBUUpZQUFFQkFTSDREd0Q0R3dIRUF2Z2NBL2dYQkl3TUFZdUwrbno1dFFYa0Q1ajNDQkxuRVFBQ0FRRUJJVmhZV0ZoWVdGaFlXRmhZV0ZoWVdGaFlXRmhZV0ZoWVdGaFlXRmhZV0ZoWUFBQUJBUUFBRHdBQ0FRRUVFL3QzRG92NmZBSDZmQVQrZlBwOCtud0hEb3NNQ3ZtMUN2bTFEQXo2ZkJRQUFBQUFBQUFCQUFBQUFNbUpiekVBQUFBQXpnVGpGUUFBQUFET0JPUXBBQUVBQUFBQUFBQUFEQUFVQUFRQUFBQUJBQUFBQWdBQkFBQUFBQUFBQUFBRDZBQUFBQUFBQUE9PSIpOwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2xvYWRUZXN0Rm9udCIsIHRlc3RGb250KTsKICB9CiAgX3ByZXBhcmVGb250TG9hZEV2ZW50KGZvbnQsIHJlcXVlc3QpIHsKICAgIGZ1bmN0aW9uIGludDMyKGRhdGEyLCBvZmZzZXQpIHsKICAgICAgcmV0dXJuIGRhdGEyLmNoYXJDb2RlQXQob2Zmc2V0KSA8PCAyNCB8IGRhdGEyLmNoYXJDb2RlQXQob2Zmc2V0ICsgMSkgPDwgMTYgfCBkYXRhMi5jaGFyQ29kZUF0KG9mZnNldCArIDIpIDw8IDggfCBkYXRhMi5jaGFyQ29kZUF0KG9mZnNldCArIDMpICYgMjU1OwogICAgfQogICAgZnVuY3Rpb24gc3BsaWNlU3RyaW5nKHMsIG9mZnNldCwgcmVtb3ZlLCBpbnNlcnQpIHsKICAgICAgY29uc3QgY2h1bmsxID0gcy5zdWJzdHJpbmcoMCwgb2Zmc2V0KTsKICAgICAgY29uc3QgY2h1bmsyID0gcy5zdWJzdHJpbmcob2Zmc2V0ICsgcmVtb3ZlKTsKICAgICAgcmV0dXJuIGNodW5rMSArIGluc2VydCArIGNodW5rMjsKICAgIH0KICAgIGxldCBpLCBpaTsKICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuX2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgY2FudmFzLndpZHRoID0gMTsKICAgIGNhbnZhcy5oZWlnaHQgPSAxOwogICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICBsZXQgY2FsbGVkID0gMDsKICAgIGZ1bmN0aW9uIGlzRm9udFJlYWR5KG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICgrK2NhbGxlZCA+IDMwKSB7CiAgICAgICAgd2FybigiTG9hZCB0ZXN0IGZvbnQgbmV2ZXIgbG9hZGVkLiIpOwogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGN0eC5mb250ID0gIjMwcHggIiArIG5hbWU7CiAgICAgIGN0eC5maWxsVGV4dCgiLiIsIDAsIDIwKTsKICAgICAgY29uc3QgaW1hZ2VEYXRhID0gY3R4LmdldEltYWdlRGF0YSgwLCAwLCAxLCAxKTsKICAgICAgaWYgKGltYWdlRGF0YS5kYXRhWzNdID4gMCkgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNldFRpbWVvdXQoaXNGb250UmVhZHkuYmluZChudWxsLCBuYW1lLCBjYWxsYmFjaykpOwogICAgfQogICAgY29uc3QgbG9hZFRlc3RGb250SWQgPSBgbHQke0RhdGUubm93KCl9JHt0aGlzLmxvYWRUZXN0Rm9udElkKyt9YDsKICAgIGxldCBkYXRhID0gdGhpcy5fbG9hZFRlc3RGb250OwogICAgY29uc3QgQ09NTUVOVF9PRkZTRVQgPSA5NzY7CiAgICBkYXRhID0gc3BsaWNlU3RyaW5nKGRhdGEsIENPTU1FTlRfT0ZGU0VULCBsb2FkVGVzdEZvbnRJZC5sZW5ndGgsIGxvYWRUZXN0Rm9udElkKTsKICAgIGNvbnN0IENGRl9DSEVDS1NVTV9PRkZTRVQgPSAxNjsKICAgIGNvbnN0IFhYWFhfVkFMVUUgPSAxNDgyMTg0NzkyOwogICAgbGV0IGNoZWNrc3VtID0gaW50MzIoZGF0YSwgQ0ZGX0NIRUNLU1VNX09GRlNFVCk7CiAgICBmb3IgKGkgPSAwLCBpaSA9IGxvYWRUZXN0Rm9udElkLmxlbmd0aCAtIDM7IGkgPCBpaTsgaSArPSA0KSB7CiAgICAgIGNoZWNrc3VtID0gY2hlY2tzdW0gLSBYWFhYX1ZBTFVFICsgaW50MzIobG9hZFRlc3RGb250SWQsIGkpIHwgMDsKICAgIH0KICAgIGlmIChpIDwgbG9hZFRlc3RGb250SWQubGVuZ3RoKSB7CiAgICAgIGNoZWNrc3VtID0gY2hlY2tzdW0gLSBYWFhYX1ZBTFVFICsgaW50MzIobG9hZFRlc3RGb250SWQgKyAiWFhYIiwgaSkgfCAwOwogICAgfQogICAgZGF0YSA9IHNwbGljZVN0cmluZyhkYXRhLCBDRkZfQ0hFQ0tTVU1fT0ZGU0VULCA0LCBzdHJpbmczMihjaGVja3N1bSkpOwogICAgY29uc3QgdXJsID0gYHVybChkYXRhOmZvbnQvb3BlbnR5cGU7YmFzZTY0LCR7YnRvYShkYXRhKX0pO2A7CiAgICBjb25zdCBydWxlID0gYEBmb250LWZhY2Uge2ZvbnQtZmFtaWx5OiIke2xvYWRUZXN0Rm9udElkfSI7c3JjOiR7dXJsfX1gOwogICAgdGhpcy5pbnNlcnRSdWxlKHJ1bGUpOwogICAgY29uc3QgZGl2ID0gdGhpcy5fZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXYuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgZGl2LnN0eWxlLndpZHRoID0gZGl2LnN0eWxlLmhlaWdodCA9ICIxMHB4IjsKICAgIGRpdi5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICBkaXYuc3R5bGUudG9wID0gZGl2LnN0eWxlLmxlZnQgPSAiMHB4IjsKICAgIGZvciAoY29uc3QgbmFtZSBvZiBbZm9udC5sb2FkZWROYW1lLCBsb2FkVGVzdEZvbnRJZF0pIHsKICAgICAgY29uc3Qgc3BhbiA9IHRoaXMuX2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgc3Bhbi50ZXh0Q29udGVudCA9ICJIaSI7CiAgICAgIHNwYW4uc3R5bGUuZm9udEZhbWlseSA9IG5hbWU7CiAgICAgIGRpdi5hcHBlbmQoc3Bhbik7CiAgICB9CiAgICB0aGlzLl9kb2N1bWVudC5ib2R5LmFwcGVuZChkaXYpOwogICAgaXNGb250UmVhZHkobG9hZFRlc3RGb250SWQsICgpID0+IHsKICAgICAgZGl2LnJlbW92ZSgpOwogICAgICByZXF1ZXN0LmNvbXBsZXRlKCk7CiAgICB9KTsKICB9Cn07CnZhciBGb250RmFjZU9iamVjdCA9IGNsYXNzIHsKICAjZm9udERhdGE7CiAgY29uc3RydWN0b3IodHJhbnNsYXRlZERhdGEsIGluc3BlY3RGb250ID0gbnVsbCwgZXh0cmEsIGNoYXJQcm9jT3BlcmF0b3JMaXN0KSB7CiAgICB0aGlzLmNvbXBpbGVkR2x5cGhzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB0aGlzLiNmb250RGF0YSA9IHRyYW5zbGF0ZWREYXRhOwogICAgdGhpcy5faW5zcGVjdEZvbnQgPSBpbnNwZWN0Rm9udDsKICAgIGlmIChleHRyYSkgewogICAgICBPYmplY3QuYXNzaWduKHRoaXMsIGV4dHJhKTsKICAgIH0KICAgIGlmIChjaGFyUHJvY09wZXJhdG9yTGlzdCkgewogICAgICB0aGlzLmNoYXJQcm9jT3BlcmF0b3JMaXN0ID0gY2hhclByb2NPcGVyYXRvckxpc3Q7CiAgICB9CiAgfQogIGNyZWF0ZU5hdGl2ZUZvbnRGYWNlKCkgewogICAgaWYgKCF0aGlzLmRhdGEgfHwgdGhpcy5kaXNhYmxlRm9udEZhY2UpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBsZXQgbmF0aXZlRm9udEZhY2U7CiAgICBpZiAoIXRoaXMuY3NzRm9udEluZm8pIHsKICAgICAgbmF0aXZlRm9udEZhY2UgPSBuZXcgRm9udEZhY2UodGhpcy5sb2FkZWROYW1lLCB0aGlzLmRhdGEsIHt9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGNzcyA9IHsKICAgICAgICB3ZWlnaHQ6IHRoaXMuY3NzRm9udEluZm8uZm9udFdlaWdodAogICAgICB9OwogICAgICBpZiAodGhpcy5jc3NGb250SW5mby5pdGFsaWNBbmdsZSkgewogICAgICAgIGNzcy5zdHlsZSA9IGBvYmxpcXVlICR7dGhpcy5jc3NGb250SW5mby5pdGFsaWNBbmdsZX1kZWdgOwogICAgICB9CiAgICAgIG5hdGl2ZUZvbnRGYWNlID0gbmV3IEZvbnRGYWNlKHRoaXMuY3NzRm9udEluZm8uZm9udEZhbWlseSwgdGhpcy5kYXRhLCBjc3MpOwogICAgfQogICAgdGhpcy5faW5zcGVjdEZvbnQ/Lih0aGlzKTsKICAgIHJldHVybiBuYXRpdmVGb250RmFjZTsKICB9CiAgY3JlYXRlRm9udEZhY2VSdWxlKCkgewogICAgaWYgKCF0aGlzLmRhdGEgfHwgdGhpcy5kaXNhYmxlRm9udEZhY2UpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB1cmwgPSBgdXJsKGRhdGE6JHt0aGlzLm1pbWV0eXBlfTtiYXNlNjQsJHt0b0Jhc2U2NFV0aWwodGhpcy5kYXRhKX0pO2A7CiAgICBsZXQgcnVsZTsKICAgIGlmICghdGhpcy5jc3NGb250SW5mbykgewogICAgICBydWxlID0gYEBmb250LWZhY2Uge2ZvbnQtZmFtaWx5OiIke3RoaXMubG9hZGVkTmFtZX0iO3NyYzoke3VybH19YDsKICAgIH0gZWxzZSB7CiAgICAgIGxldCBjc3MgPSBgZm9udC13ZWlnaHQ6ICR7dGhpcy5jc3NGb250SW5mby5mb250V2VpZ2h0fTtgOwogICAgICBpZiAodGhpcy5jc3NGb250SW5mby5pdGFsaWNBbmdsZSkgewogICAgICAgIGNzcyArPSBgZm9udC1zdHlsZTogb2JsaXF1ZSAke3RoaXMuY3NzRm9udEluZm8uaXRhbGljQW5nbGV9ZGVnO2A7CiAgICAgIH0KICAgICAgcnVsZSA9IGBAZm9udC1mYWNlIHtmb250LWZhbWlseToiJHt0aGlzLmNzc0ZvbnRJbmZvLmZvbnRGYW1pbHl9Ijske2Nzc31zcmM6JHt1cmx9fWA7CiAgICB9CiAgICB0aGlzLl9pbnNwZWN0Rm9udD8uKHRoaXMsIHVybCk7CiAgICByZXR1cm4gcnVsZTsKICB9CiAgZ2V0UGF0aEdlbmVyYXRvcihvYmpzLCBjaGFyYWN0ZXIpIHsKICAgIGlmICh0aGlzLmNvbXBpbGVkR2x5cGhzW2NoYXJhY3Rlcl0gIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gdGhpcy5jb21waWxlZEdseXBoc1tjaGFyYWN0ZXJdOwogICAgfQogICAgY29uc3Qgb2JqSWQgPSB0aGlzLmxvYWRlZE5hbWUgKyAiX3BhdGhfIiArIGNoYXJhY3RlcjsKICAgIGxldCBjbWRzOwogICAgdHJ5IHsKICAgICAgY21kcyA9IG9ianMuZ2V0KG9iaklkKTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIHdhcm4oYGdldFBhdGhHZW5lcmF0b3IgLSBpZ25vcmluZyBjaGFyYWN0ZXI6ICIke2V4fSIuYCk7CiAgICB9CiAgICBjb25zdCBwYXRoID0gbWFrZVBhdGhGcm9tRHJhd09QUyhjbWRzPy5wYXRoKTsKICAgIGlmICghdGhpcy5mb250RXh0cmFQcm9wZXJ0aWVzKSB7CiAgICAgIG9ianMuZGVsZXRlKG9iaklkKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbXBpbGVkR2x5cGhzW2NoYXJhY3Rlcl0gPSBwYXRoOwogIH0KICBnZXQgYmxhY2soKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuYmxhY2s7CiAgfQogIGdldCBib2xkKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmJvbGQ7CiAgfQogIGdldCBkaXNhYmxlRm9udEZhY2UoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuZGlzYWJsZUZvbnRGYWNlID8/IGZhbHNlOwogIH0KICBzZXQgZGlzYWJsZUZvbnRGYWNlKHZhbHVlKSB7CiAgICBzaGFkb3codGhpcywgImRpc2FibGVGb250RmFjZSIsICEhdmFsdWUpOwogIH0KICBnZXQgZm9udEV4dHJhUHJvcGVydGllcygpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5mb250RXh0cmFQcm9wZXJ0aWVzID8/IGZhbHNlOwogIH0KICBnZXQgaXNJbnZhbGlkUERGanNGb250KCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmlzSW52YWxpZFBERmpzRm9udDsKICB9CiAgZ2V0IGlzVHlwZTNGb250KCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmlzVHlwZTNGb250OwogIH0KICBnZXQgaXRhbGljKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLml0YWxpYzsKICB9CiAgZ2V0IG1pc3NpbmdGaWxlKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLm1pc3NpbmdGaWxlOwogIH0KICBnZXQgcmVtZWFzdXJlKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLnJlbWVhc3VyZTsKICB9CiAgZ2V0IHZlcnRpY2FsKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLnZlcnRpY2FsOwogIH0KICBnZXQgYXNjZW50KCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmFzY2VudDsKICB9CiAgZ2V0IGRlZmF1bHRXaWR0aCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5kZWZhdWx0V2lkdGg7CiAgfQogIGdldCBkZXNjZW50KCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmRlc2NlbnQ7CiAgfQogIGdldCBiYm94KCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmJib3g7CiAgfQogIHNldCBiYm94KGJib3gpIHsKICAgIHNoYWRvdyh0aGlzLCAiYmJveCIsIGJib3gpOwogIH0KICBnZXQgZm9udE1hdHJpeCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5mb250TWF0cml4OwogIH0KICBnZXQgZmFsbGJhY2tOYW1lKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmZhbGxiYWNrTmFtZTsKICB9CiAgZ2V0IGxvYWRlZE5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEubG9hZGVkTmFtZTsKICB9CiAgZ2V0IG1pbWV0eXBlKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLm1pbWV0eXBlOwogIH0KICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5uYW1lOwogIH0KICBnZXQgZGF0YSgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5kYXRhOwogIH0KICBjbGVhckRhdGEoKSB7CiAgICB0aGlzLiNmb250RGF0YS5jbGVhckRhdGEoKTsKICB9CiAgZ2V0IGNzc0ZvbnRJbmZvKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmNzc0ZvbnRJbmZvOwogIH0KICBnZXQgc3lzdGVtRm9udEluZm8oKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuc3lzdGVtRm9udEluZm87CiAgfQogIGdldCBkZWZhdWx0Vk1ldHJpY3MoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuZGVmYXVsdFZNZXRyaWNzOwogIH0KfTsKdmFyIENzc0ZvbnRJbmZvID0gY2xhc3MgX0Nzc0ZvbnRJbmZvIHsKICAjYnVmZmVyOwogICN2aWV3OwogICNkZWNvZGVyOwogIHN0YXRpYyBzdHJpbmdzID0gWyJmb250RmFtaWx5IiwgImZvbnRXZWlnaHQiLCAiaXRhbGljQW5nbGUiXTsKICBzdGF0aWMgd3JpdGUoaW5mbzIpIHsKICAgIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgIGNvbnN0IGVuY29kZWRTdHJpbmdzID0ge307CiAgICBsZXQgc3RyaW5nc0xlbmd0aCA9IDA7CiAgICBmb3IgKGNvbnN0IHByb3Agb2YgX0Nzc0ZvbnRJbmZvLnN0cmluZ3MpIHsKICAgICAgY29uc3QgZW5jb2RlZCA9IGVuY29kZXIuZW5jb2RlKGluZm8yW3Byb3BdKTsKICAgICAgZW5jb2RlZFN0cmluZ3NbcHJvcF0gPSBlbmNvZGVkOwogICAgICBzdHJpbmdzTGVuZ3RoICs9IDQgKyBlbmNvZGVkLmxlbmd0aDsKICAgIH0KICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihzdHJpbmdzTGVuZ3RoKTsKICAgIGNvbnN0IGRhdGEgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICBmb3IgKGNvbnN0IHByb3Agb2YgX0Nzc0ZvbnRJbmZvLnN0cmluZ3MpIHsKICAgICAgY29uc3QgZW5jb2RlZCA9IGVuY29kZWRTdHJpbmdzW3Byb3BdOwogICAgICBjb25zdCBsZW5ndGggPSBlbmNvZGVkLmxlbmd0aDsKICAgICAgdmlldy5zZXRVaW50MzIob2Zmc2V0LCBsZW5ndGgpOwogICAgICBkYXRhLnNldChlbmNvZGVkLCBvZmZzZXQgKyA0KTsKICAgICAgb2Zmc2V0ICs9IDQgKyBsZW5ndGg7CiAgICB9CiAgICBhc3NlcnQob2Zmc2V0ID09PSBidWZmZXIuYnl0ZUxlbmd0aCwgIkNzc0ZvbnRJbmZvLndyaXRlOiBCdWZmZXIgb3ZlcmZsb3ciKTsKICAgIHJldHVybiBidWZmZXI7CiAgfQogIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgdGhpcy4jYnVmZmVyID0gYnVmZmVyOwogICAgdGhpcy4jdmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLiNidWZmZXIpOwogICAgdGhpcy4jZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpOwogIH0KICAjcmVhZFN0cmluZyhpbmRleCkgewogICAgYXNzZXJ0KGluZGV4IDwgX0Nzc0ZvbnRJbmZvLnN0cmluZ3MubGVuZ3RoLCAiSW52YWxpZCBzdHJpbmcgaW5kZXgiKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleDsgaSsrKSB7CiAgICAgIG9mZnNldCArPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpICsgNDsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICByZXR1cm4gdGhpcy4jZGVjb2Rlci5kZWNvZGUobmV3IFVpbnQ4QXJyYXkodGhpcy4jYnVmZmVyLCBvZmZzZXQgKyA0LCBsZW5ndGgpKTsKICB9CiAgZ2V0IGZvbnRGYW1pbHkoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZFN0cmluZygwKTsKICB9CiAgZ2V0IGZvbnRXZWlnaHQoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZFN0cmluZygxKTsKICB9CiAgZ2V0IGl0YWxpY0FuZ2xlKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMik7CiAgfQp9Owp2YXIgU3lzdGVtRm9udEluZm8gPSBjbGFzcyBfU3lzdGVtRm9udEluZm8gewogICNidWZmZXI7CiAgI3ZpZXc7CiAgI2RlY29kZXI7CiAgc3RhdGljIHN0cmluZ3MgPSBbImNzcyIsICJsb2FkZWROYW1lIiwgImJhc2VGb250TmFtZSIsICJzcmMiXTsKICBzdGF0aWMgd3JpdGUoaW5mbzIpIHsKICAgIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgIGNvbnN0IGVuY29kZWRTdHJpbmdzID0ge307CiAgICBsZXQgc3RyaW5nc0xlbmd0aCA9IDA7CiAgICBmb3IgKGNvbnN0IHByb3Agb2YgX1N5c3RlbUZvbnRJbmZvLnN0cmluZ3MpIHsKICAgICAgY29uc3QgZW5jb2RlZCA9IGVuY29kZXIuZW5jb2RlKGluZm8yW3Byb3BdKTsKICAgICAgZW5jb2RlZFN0cmluZ3NbcHJvcF0gPSBlbmNvZGVkOwogICAgICBzdHJpbmdzTGVuZ3RoICs9IDQgKyBlbmNvZGVkLmxlbmd0aDsKICAgIH0KICAgIHN0cmluZ3NMZW5ndGggKz0gNDsKICAgIGxldCBlbmNvZGVkU3R5bGVTdHlsZSwgZW5jb2RlZFN0eWxlV2VpZ2h0LCBsZW5ndGhFc3RpbWF0ZSA9IDEgKyBzdHJpbmdzTGVuZ3RoOwogICAgaWYgKGluZm8yLnN0eWxlKSB7CiAgICAgIGVuY29kZWRTdHlsZVN0eWxlID0gZW5jb2Rlci5lbmNvZGUoaW5mbzIuc3R5bGUuc3R5bGUpOwogICAgICBlbmNvZGVkU3R5bGVXZWlnaHQgPSBlbmNvZGVyLmVuY29kZShpbmZvMi5zdHlsZS53ZWlnaHQpOwogICAgICBsZW5ndGhFc3RpbWF0ZSArPSA0ICsgZW5jb2RlZFN0eWxlU3R5bGUubGVuZ3RoICsgNCArIGVuY29kZWRTdHlsZVdlaWdodC5sZW5ndGg7CiAgICB9CiAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIobGVuZ3RoRXN0aW1hdGUpOwogICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHZpZXcuc2V0VWludDgob2Zmc2V0KyssIGluZm8yLmd1ZXNzRmFsbGJhY2sgPyAxIDogMCk7CiAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIDApOwogICAgb2Zmc2V0ICs9IDQ7CiAgICBzdHJpbmdzTGVuZ3RoID0gMDsKICAgIGZvciAoY29uc3QgcHJvcCBvZiBfU3lzdGVtRm9udEluZm8uc3RyaW5ncykgewogICAgICBjb25zdCBlbmNvZGVkID0gZW5jb2RlZFN0cmluZ3NbcHJvcF07CiAgICAgIGNvbnN0IGxlbmd0aCA9IGVuY29kZWQubGVuZ3RoOwogICAgICBzdHJpbmdzTGVuZ3RoICs9IDQgKyBsZW5ndGg7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgbGVuZ3RoKTsKICAgICAgZGF0YS5zZXQoZW5jb2RlZCwgb2Zmc2V0ICsgNCk7CiAgICAgIG9mZnNldCArPSA0ICsgbGVuZ3RoOwogICAgfQogICAgdmlldy5zZXRVaW50MzIob2Zmc2V0IC0gc3RyaW5nc0xlbmd0aCAtIDQsIHN0cmluZ3NMZW5ndGgpOwogICAgaWYgKGluZm8yLnN0eWxlKSB7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgZW5jb2RlZFN0eWxlU3R5bGUubGVuZ3RoKTsKICAgICAgZGF0YS5zZXQoZW5jb2RlZFN0eWxlU3R5bGUsIG9mZnNldCArIDQpOwogICAgICBvZmZzZXQgKz0gNCArIGVuY29kZWRTdHlsZVN0eWxlLmxlbmd0aDsKICAgICAgdmlldy5zZXRVaW50MzIob2Zmc2V0LCBlbmNvZGVkU3R5bGVXZWlnaHQubGVuZ3RoKTsKICAgICAgZGF0YS5zZXQoZW5jb2RlZFN0eWxlV2VpZ2h0LCBvZmZzZXQgKyA0KTsKICAgICAgb2Zmc2V0ICs9IDQgKyBlbmNvZGVkU3R5bGVXZWlnaHQubGVuZ3RoOwogICAgfQogICAgYXNzZXJ0KG9mZnNldCA8PSBidWZmZXIuYnl0ZUxlbmd0aCwgIlN1YnN0aXRpb25JbmZvLndyaXRlOiBCdWZmZXIgb3ZlcmZsb3ciKTsKICAgIHJldHVybiBidWZmZXIudHJhbnNmZXJUb0ZpeGVkTGVuZ3RoKG9mZnNldCk7CiAgfQogIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgdGhpcy4jYnVmZmVyID0gYnVmZmVyOwogICAgdGhpcy4jdmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLiNidWZmZXIpOwogICAgdGhpcy4jZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpOwogIH0KICBnZXQgZ3Vlc3NGYWxsYmFjaygpIHsKICAgIHJldHVybiB0aGlzLiN2aWV3LmdldFVpbnQ4KDApICE9PSAwOwogIH0KICAjcmVhZFN0cmluZyhpbmRleCkgewogICAgYXNzZXJ0KGluZGV4IDwgX1N5c3RlbUZvbnRJbmZvLnN0cmluZ3MubGVuZ3RoLCAiSW52YWxpZCBzdHJpbmcgaW5kZXgiKTsKICAgIGxldCBvZmZzZXQgPSA1OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleDsgaSsrKSB7CiAgICAgIG9mZnNldCArPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpICsgNDsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICByZXR1cm4gdGhpcy4jZGVjb2Rlci5kZWNvZGUobmV3IFVpbnQ4QXJyYXkodGhpcy4jYnVmZmVyLCBvZmZzZXQgKyA0LCBsZW5ndGgpKTsKICB9CiAgZ2V0IGNzcygpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkU3RyaW5nKDApOwogIH0KICBnZXQgbG9hZGVkTmFtZSgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkU3RyaW5nKDEpOwogIH0KICBnZXQgYmFzZUZvbnROYW1lKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMik7CiAgfQogIGdldCBzcmMoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZFN0cmluZygzKTsKICB9CiAgZ2V0IHN0eWxlKCkgewogICAgbGV0IG9mZnNldCA9IDE7CiAgICBvZmZzZXQgKz0gNCArIHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBjb25zdCBzdHlsZUxlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBjb25zdCBzdHlsZSA9IHRoaXMuI2RlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgc3R5bGVMZW5ndGgpKTsKICAgIG9mZnNldCArPSA0ICsgc3R5bGVMZW5ndGg7CiAgICBjb25zdCB3ZWlnaHRMZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgY29uc3Qgd2VpZ2h0ID0gdGhpcy4jZGVjb2Rlci5kZWNvZGUobmV3IFVpbnQ4QXJyYXkodGhpcy4jYnVmZmVyLCBvZmZzZXQgKyA0LCB3ZWlnaHRMZW5ndGgpKTsKICAgIHJldHVybiB7CiAgICAgIHN0eWxlLAogICAgICB3ZWlnaHQKICAgIH07CiAgfQp9Owp2YXIgRm9udEluZm8gPSBjbGFzcyBfRm9udEluZm8gewogIHN0YXRpYyBib29scyA9IFsiYmxhY2siLCAiYm9sZCIsICJkaXNhYmxlRm9udEZhY2UiLCAiZm9udEV4dHJhUHJvcGVydGllcyIsICJpc0ludmFsaWRQREZqc0ZvbnQiLCAiaXNUeXBlM0ZvbnQiLCAiaXRhbGljIiwgIm1pc3NpbmdGaWxlIiwgInJlbWVhc3VyZSIsICJ2ZXJ0aWNhbCJdOwogIHN0YXRpYyBudW1iZXJzID0gWyJhc2NlbnQiLCAiZGVmYXVsdFdpZHRoIiwgImRlc2NlbnQiXTsKICBzdGF0aWMgc3RyaW5ncyA9IFsiZmFsbGJhY2tOYW1lIiwgImxvYWRlZE5hbWUiLCAibWltZXR5cGUiLCAibmFtZSJdOwogIHN0YXRpYyAjT0ZGU0VUX05VTUJFUlMgPSBNYXRoLmNlaWwodGhpcy5ib29scy5sZW5ndGggKiAyIC8gOCk7CiAgc3RhdGljICNPRkZTRVRfQkJPWCA9IHRoaXMuI09GRlNFVF9OVU1CRVJTICsgdGhpcy5udW1iZXJzLmxlbmd0aCAqIDg7CiAgc3RhdGljICNPRkZTRVRfRk9OVF9NQVRSSVggPSB0aGlzLiNPRkZTRVRfQkJPWCArIDEgKyAyICogNDsKICBzdGF0aWMgI09GRlNFVF9ERUZBVUxUX1ZNRVRSSUNTID0gdGhpcy4jT0ZGU0VUX0ZPTlRfTUFUUklYICsgMSArIDggKiA2OwogIHN0YXRpYyAjT0ZGU0VUX1NUUklOR1MgPSB0aGlzLiNPRkZTRVRfREVGQVVMVF9WTUVUUklDUyArIDEgKyAyICogMzsKICAjYnVmZmVyOwogICNkZWNvZGVyOwogICN2aWV3OwogIGNvbnN0cnVjdG9yKHsKICAgIGRhdGEsCiAgICBleHRyYQogIH0pIHsKICAgIHRoaXMuI2J1ZmZlciA9IGRhdGE7CiAgICB0aGlzLiNkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7CiAgICB0aGlzLiN2aWV3ID0gbmV3IERhdGFWaWV3KHRoaXMuI2J1ZmZlcik7CiAgICBpZiAoZXh0cmEpIHsKICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBleHRyYSk7CiAgICB9CiAgfQogICNyZWFkQm9vbGVhbihpbmRleCkgewogICAgYXNzZXJ0KGluZGV4IDwgX0ZvbnRJbmZvLmJvb2xzLmxlbmd0aCwgIkludmFsaWQgYm9vbGVhbiBpbmRleCIpOwogICAgY29uc3QgYnl0ZU9mZnNldCA9IE1hdGguZmxvb3IoaW5kZXggLyA0KTsKICAgIGNvbnN0IGJpdE9mZnNldCA9IGluZGV4ICogMiAlIDg7CiAgICBjb25zdCB2YWx1ZSA9IHRoaXMuI3ZpZXcuZ2V0VWludDgoYnl0ZU9mZnNldCkgPj4gYml0T2Zmc2V0ICYgMzsKICAgIHJldHVybiB2YWx1ZSA9PT0gMCA/IHZvaWQgMCA6IHZhbHVlID09PSAyOwogIH0KICBnZXQgYmxhY2soKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZEJvb2xlYW4oMCk7CiAgfQogIGdldCBib2xkKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRCb29sZWFuKDEpOwogIH0KICBnZXQgZGlzYWJsZUZvbnRGYWNlKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRCb29sZWFuKDIpOwogIH0KICBnZXQgZm9udEV4dHJhUHJvcGVydGllcygpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkQm9vbGVhbigzKTsKICB9CiAgZ2V0IGlzSW52YWxpZFBERmpzRm9udCgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkQm9vbGVhbig0KTsKICB9CiAgZ2V0IGlzVHlwZTNGb250KCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRCb29sZWFuKDUpOwogIH0KICBnZXQgaXRhbGljKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRCb29sZWFuKDYpOwogIH0KICBnZXQgbWlzc2luZ0ZpbGUoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZEJvb2xlYW4oNyk7CiAgfQogIGdldCByZW1lYXN1cmUoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZEJvb2xlYW4oOCk7CiAgfQogIGdldCB2ZXJ0aWNhbCgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkQm9vbGVhbig5KTsKICB9CiAgI3JlYWROdW1iZXIoaW5kZXgpIHsKICAgIGFzc2VydChpbmRleCA8IF9Gb250SW5mby5udW1iZXJzLmxlbmd0aCwgIkludmFsaWQgbnVtYmVyIGluZGV4Iik7CiAgICByZXR1cm4gdGhpcy4jdmlldy5nZXRGbG9hdDY0KF9Gb250SW5mby4jT0ZGU0VUX05VTUJFUlMgKyBpbmRleCAqIDgpOwogIH0KICBnZXQgYXNjZW50KCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWROdW1iZXIoMCk7CiAgfQogIGdldCBkZWZhdWx0V2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZE51bWJlcigxKTsKICB9CiAgZ2V0IGRlc2NlbnQoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZE51bWJlcigyKTsKICB9CiAgZ2V0IGJib3goKSB7CiAgICBsZXQgb2Zmc2V0ID0gX0ZvbnRJbmZvLiNPRkZTRVRfQkJPWDsKICAgIGNvbnN0IG51bUNvb3JkcyA9IHRoaXMuI3ZpZXcuZ2V0VWludDgob2Zmc2V0KTsKICAgIGlmIChudW1Db29yZHMgPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIG9mZnNldCArPSAxOwogICAgY29uc3QgYmJveCA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgYmJveC5wdXNoKHRoaXMuI3ZpZXcuZ2V0SW50MTYob2Zmc2V0LCB0cnVlKSk7CiAgICAgIG9mZnNldCArPSAyOwogICAgfQogICAgcmV0dXJuIGJib3g7CiAgfQogIGdldCBmb250TWF0cml4KCkgewogICAgbGV0IG9mZnNldCA9IF9Gb250SW5mby4jT0ZGU0VUX0ZPTlRfTUFUUklYOwogICAgY29uc3QgbnVtUG9pbnRzID0gdGhpcy4jdmlldy5nZXRVaW50OChvZmZzZXQpOwogICAgaWYgKG51bVBvaW50cyA9PT0gMCkgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgb2Zmc2V0ICs9IDE7CiAgICBjb25zdCBmb250TWF0cml4ID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDY7IGkrKykgewogICAgICBmb250TWF0cml4LnB1c2godGhpcy4jdmlldy5nZXRGbG9hdDY0KG9mZnNldCwgdHJ1ZSkpOwogICAgICBvZmZzZXQgKz0gODsKICAgIH0KICAgIHJldHVybiBmb250TWF0cml4OwogIH0KICBnZXQgZGVmYXVsdFZNZXRyaWNzKCkgewogICAgbGV0IG9mZnNldCA9IF9Gb250SW5mby4jT0ZGU0VUX0RFRkFVTFRfVk1FVFJJQ1M7CiAgICBjb25zdCBudW1NZXRyaWNzID0gdGhpcy4jdmlldy5nZXRVaW50OChvZmZzZXQpOwogICAgaWYgKG51bU1ldHJpY3MgPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIG9mZnNldCArPSAxOwogICAgY29uc3QgZGVmYXVsdFZNZXRyaWNzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7IGkrKykgewogICAgICBkZWZhdWx0Vk1ldHJpY3MucHVzaCh0aGlzLiN2aWV3LmdldEludDE2KG9mZnNldCwgdHJ1ZSkpOwogICAgICBvZmZzZXQgKz0gMjsKICAgIH0KICAgIHJldHVybiBkZWZhdWx0Vk1ldHJpY3M7CiAgfQogICNyZWFkU3RyaW5nKGluZGV4KSB7CiAgICBhc3NlcnQoaW5kZXggPCBfRm9udEluZm8uc3RyaW5ncy5sZW5ndGgsICJJbnZhbGlkIHN0cmluZyBpbmRleCIpOwogICAgbGV0IG9mZnNldCA9IF9Gb250SW5mby4jT0ZGU0VUX1NUUklOR1MgKyA0OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleDsgaSsrKSB7CiAgICAgIG9mZnNldCArPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpICsgNDsKICAgIH0KICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBjb25zdCBzdHJpbmdEYXRhID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKTsKICAgIHN0cmluZ0RhdGEuc2V0KG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgbGVuZ3RoKSk7CiAgICByZXR1cm4gdGhpcy4jZGVjb2Rlci5kZWNvZGUoc3RyaW5nRGF0YSk7CiAgfQogIGdldCBmYWxsYmFja05hbWUoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZFN0cmluZygwKTsKICB9CiAgZ2V0IGxvYWRlZE5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZFN0cmluZygxKTsKICB9CiAgZ2V0IG1pbWV0eXBlKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMik7CiAgfQogIGdldCBuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMyk7CiAgfQogIGdldCBkYXRhKCkgewogICAgbGV0IG9mZnNldCA9IF9Gb250SW5mby4jT0ZGU0VUX1NUUklOR1M7CiAgICBjb25zdCBzdHJpbmdzTGVuZ3RoID0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKICAgIG9mZnNldCArPSA0ICsgc3RyaW5nc0xlbmd0aDsKICAgIGNvbnN0IHN5c3RlbUZvbnRJbmZvTGVuZ3RoID0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKICAgIG9mZnNldCArPSA0ICsgc3lzdGVtRm9udEluZm9MZW5ndGg7CiAgICBjb25zdCBjc3NGb250SW5mb0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIGNzc0ZvbnRJbmZvTGVuZ3RoOwogICAgY29uc3QgbGVuZ3RoID0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBuZXcgVWludDhBcnJheSh0aGlzLiNidWZmZXIsIG9mZnNldCArIDQsIGxlbmd0aCk7CiAgfQogIGNsZWFyRGF0YSgpIHsKICAgIGxldCBvZmZzZXQgPSBfRm9udEluZm8uI09GRlNFVF9TVFJJTkdTOwogICAgY29uc3Qgc3RyaW5nc0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIHN0cmluZ3NMZW5ndGg7CiAgICBjb25zdCBzeXN0ZW1Gb250SW5mb0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIHN5c3RlbUZvbnRJbmZvTGVuZ3RoOwogICAgY29uc3QgY3NzRm9udEluZm9MZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgb2Zmc2V0ICs9IDQgKyBjc3NGb250SW5mb0xlbmd0aDsKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4QXJyYXkodGhpcy4jYnVmZmVyLCBvZmZzZXQgKyA0LCBsZW5ndGgpOwogICAgZGF0YS5maWxsKDApOwogICAgdGhpcy4jdmlldy5zZXRVaW50MzIob2Zmc2V0LCAwKTsKICB9CiAgZ2V0IGNzc0ZvbnRJbmZvKCkgewogICAgbGV0IG9mZnNldCA9IF9Gb250SW5mby4jT0ZGU0VUX1NUUklOR1M7CiAgICBjb25zdCBzdHJpbmdzTGVuZ3RoID0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKICAgIG9mZnNldCArPSA0ICsgc3RyaW5nc0xlbmd0aDsKICAgIGNvbnN0IHN5c3RlbUZvbnRJbmZvTGVuZ3RoID0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKICAgIG9mZnNldCArPSA0ICsgc3lzdGVtRm9udEluZm9MZW5ndGg7CiAgICBjb25zdCBjc3NGb250SW5mb0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBpZiAoY3NzRm9udEluZm9MZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCBjc3NGb250SW5mb0RhdGEgPSBuZXcgVWludDhBcnJheShjc3NGb250SW5mb0xlbmd0aCk7CiAgICBjc3NGb250SW5mb0RhdGEuc2V0KG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgY3NzRm9udEluZm9MZW5ndGgpKTsKICAgIHJldHVybiBuZXcgQ3NzRm9udEluZm8oY3NzRm9udEluZm9EYXRhLmJ1ZmZlcik7CiAgfQogIGdldCBzeXN0ZW1Gb250SW5mbygpIHsKICAgIGxldCBvZmZzZXQgPSBfRm9udEluZm8uI09GRlNFVF9TVFJJTkdTOwogICAgY29uc3Qgc3RyaW5nc0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIHN0cmluZ3NMZW5ndGg7CiAgICBjb25zdCBzeXN0ZW1Gb250SW5mb0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBpZiAoc3lzdGVtRm9udEluZm9MZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCBzeXN0ZW1Gb250SW5mb0RhdGEgPSBuZXcgVWludDhBcnJheShzeXN0ZW1Gb250SW5mb0xlbmd0aCk7CiAgICBzeXN0ZW1Gb250SW5mb0RhdGEuc2V0KG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgc3lzdGVtRm9udEluZm9MZW5ndGgpKTsKICAgIHJldHVybiBuZXcgU3lzdGVtRm9udEluZm8oc3lzdGVtRm9udEluZm9EYXRhLmJ1ZmZlcik7CiAgfQogIHN0YXRpYyB3cml0ZShmb250KSB7CiAgICBjb25zdCBzeXN0ZW1Gb250SW5mb0J1ZmZlciA9IGZvbnQuc3lzdGVtRm9udEluZm8gPyBTeXN0ZW1Gb250SW5mby53cml0ZShmb250LnN5c3RlbUZvbnRJbmZvKSA6IG51bGw7CiAgICBjb25zdCBjc3NGb250SW5mb0J1ZmZlciA9IGZvbnQuY3NzRm9udEluZm8gPyBDc3NGb250SW5mby53cml0ZShmb250LmNzc0ZvbnRJbmZvKSA6IG51bGw7CiAgICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICBjb25zdCBlbmNvZGVkU3RyaW5ncyA9IHt9OwogICAgbGV0IHN0cmluZ3NMZW5ndGggPSAwOwogICAgZm9yIChjb25zdCBwcm9wIG9mIF9Gb250SW5mby5zdHJpbmdzKSB7CiAgICAgIGVuY29kZWRTdHJpbmdzW3Byb3BdID0gZW5jb2Rlci5lbmNvZGUoZm9udFtwcm9wXSk7CiAgICAgIHN0cmluZ3NMZW5ndGggKz0gNCArIGVuY29kZWRTdHJpbmdzW3Byb3BdLmxlbmd0aDsKICAgIH0KICAgIGNvbnN0IGxlbmd0aEVzdGltYXRlID0gX0ZvbnRJbmZvLiNPRkZTRVRfU1RSSU5HUyArIDQgKyBzdHJpbmdzTGVuZ3RoICsgNCArIChzeXN0ZW1Gb250SW5mb0J1ZmZlciA/IHN5c3RlbUZvbnRJbmZvQnVmZmVyLmJ5dGVMZW5ndGggOiAwKSArIDQgKyAoY3NzRm9udEluZm9CdWZmZXIgPyBjc3NGb250SW5mb0J1ZmZlci5ieXRlTGVuZ3RoIDogMCkgKyA0ICsgKGZvbnQuZGF0YSA/IGZvbnQuZGF0YS5sZW5ndGggOiAwKTsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihsZW5ndGhFc3RpbWF0ZSk7CiAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyKTsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgY29uc3QgbnVtQm9vbHMgPSBfRm9udEluZm8uYm9vbHMubGVuZ3RoOwogICAgbGV0IGJvb2xCeXRlID0gMCwgYm9vbEJpdCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bUJvb2xzOyBpKyspIHsKICAgICAgY29uc3QgdmFsdWUgPSBmb250W19Gb250SW5mby5ib29sc1tpXV07CiAgICAgIGNvbnN0IGJpdHMgPSB2YWx1ZSA9PT0gdm9pZCAwID8gMCA6IHZhbHVlID8gMiA6IDE7CiAgICAgIGJvb2xCeXRlIHw9IGJpdHMgPDwgYm9vbEJpdDsKICAgICAgYm9vbEJpdCArPSAyOwogICAgICBpZiAoYm9vbEJpdCA9PT0gOCB8fCBpID09PSBudW1Cb29scyAtIDEpIHsKICAgICAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBib29sQnl0ZSk7CiAgICAgICAgYm9vbEJ5dGUgPSAwOwogICAgICAgIGJvb2xCaXQgPSAwOwogICAgICB9CiAgICB9CiAgICBhc3NlcnQob2Zmc2V0ID09PSBfRm9udEluZm8uI09GRlNFVF9OVU1CRVJTLCAiRm9udEluZm8ud3JpdGU6IEJvb2xlYW4gcHJvcGVydGllcyBvZmZzZXQgbWlzbWF0Y2giKTsKICAgIGZvciAoY29uc3QgcHJvcCBvZiBfRm9udEluZm8ubnVtYmVycykgewogICAgICB2aWV3LnNldEZsb2F0NjQob2Zmc2V0LCBmb250W3Byb3BdKTsKICAgICAgb2Zmc2V0ICs9IDg7CiAgICB9CiAgICBhc3NlcnQob2Zmc2V0ID09PSBfRm9udEluZm8uI09GRlNFVF9CQk9YLCAiRm9udEluZm8ud3JpdGU6IE51bWJlciBwcm9wZXJ0aWVzIG9mZnNldCBtaXNtYXRjaCIpOwogICAgaWYgKGZvbnQuYmJveCkgewogICAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCA0KTsKICAgICAgZm9yIChjb25zdCBjb29yZCBvZiBmb250LmJib3gpIHsKICAgICAgICB2aWV3LnNldEludDE2KG9mZnNldCwgY29vcmQsIHRydWUpOwogICAgICAgIG9mZnNldCArPSAyOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCAwKTsKICAgICAgb2Zmc2V0ICs9IDIgKiA0OwogICAgfQogICAgYXNzZXJ0KG9mZnNldCA9PT0gX0ZvbnRJbmZvLiNPRkZTRVRfRk9OVF9NQVRSSVgsICJGb250SW5mby53cml0ZTogQkJveCBwcm9wZXJ0aWVzIG9mZnNldCBtaXNtYXRjaCIpOwogICAgaWYgKGZvbnQuZm9udE1hdHJpeCkgewogICAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCA2KTsKICAgICAgZm9yIChjb25zdCBwb2ludCBvZiBmb250LmZvbnRNYXRyaXgpIHsKICAgICAgICB2aWV3LnNldEZsb2F0NjQob2Zmc2V0LCBwb2ludCwgdHJ1ZSk7CiAgICAgICAgb2Zmc2V0ICs9IDg7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZpZXcuc2V0VWludDgob2Zmc2V0KyssIDApOwogICAgICBvZmZzZXQgKz0gOCAqIDY7CiAgICB9CiAgICBhc3NlcnQob2Zmc2V0ID09PSBfRm9udEluZm8uI09GRlNFVF9ERUZBVUxUX1ZNRVRSSUNTLCAiRm9udEluZm8ud3JpdGU6IEZvbnRNYXRyaXggcHJvcGVydGllcyBvZmZzZXQgbWlzbWF0Y2giKTsKICAgIGlmIChmb250LmRlZmF1bHRWTWV0cmljcykgewogICAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCAxKTsKICAgICAgZm9yIChjb25zdCBtZXRyaWMgb2YgZm9udC5kZWZhdWx0Vk1ldHJpY3MpIHsKICAgICAgICB2aWV3LnNldEludDE2KG9mZnNldCwgbWV0cmljLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gMjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgMCk7CiAgICAgIG9mZnNldCArPSAzICogMjsKICAgIH0KICAgIGFzc2VydChvZmZzZXQgPT09IF9Gb250SW5mby4jT0ZGU0VUX1NUUklOR1MsICJGb250SW5mby53cml0ZTogRGVmYXVsdFZNZXRyaWNzIHByb3BlcnRpZXMgb2Zmc2V0IG1pc21hdGNoIik7CiAgICB2aWV3LnNldFVpbnQzMihfRm9udEluZm8uI09GRlNFVF9TVFJJTkdTLCAwKTsKICAgIG9mZnNldCArPSA0OwogICAgZm9yIChjb25zdCBwcm9wIG9mIF9Gb250SW5mby5zdHJpbmdzKSB7CiAgICAgIGNvbnN0IGVuY29kZWQgPSBlbmNvZGVkU3RyaW5nc1twcm9wXTsKICAgICAgY29uc3QgbGVuZ3RoID0gZW5jb2RlZC5sZW5ndGg7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgbGVuZ3RoKTsKICAgICAgZGF0YS5zZXQoZW5jb2RlZCwgb2Zmc2V0ICsgNCk7CiAgICAgIG9mZnNldCArPSA0ICsgbGVuZ3RoOwogICAgfQogICAgdmlldy5zZXRVaW50MzIoX0ZvbnRJbmZvLiNPRkZTRVRfU1RSSU5HUywgb2Zmc2V0IC0gX0ZvbnRJbmZvLiNPRkZTRVRfU1RSSU5HUyAtIDQpOwogICAgaWYgKCFzeXN0ZW1Gb250SW5mb0J1ZmZlcikgewogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIDApOwogICAgICBvZmZzZXQgKz0gNDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IHN5c3RlbUZvbnRJbmZvQnVmZmVyLmJ5dGVMZW5ndGg7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgbGVuZ3RoKTsKICAgICAgYXNzZXJ0KG9mZnNldCArIDQgKyBsZW5ndGggPD0gYnVmZmVyLmJ5dGVMZW5ndGgsICJGb250SW5mby53cml0ZTogQnVmZmVyIG92ZXJmbG93IGF0IHN5c3RlbUZvbnRJbmZvIik7CiAgICAgIGRhdGEuc2V0KG5ldyBVaW50OEFycmF5KHN5c3RlbUZvbnRJbmZvQnVmZmVyKSwgb2Zmc2V0ICsgNCk7CiAgICAgIG9mZnNldCArPSA0ICsgbGVuZ3RoOwogICAgfQogICAgaWYgKCFjc3NGb250SW5mb0J1ZmZlcikgewogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIDApOwogICAgICBvZmZzZXQgKz0gNDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGxlbmd0aCA9IGNzc0ZvbnRJbmZvQnVmZmVyLmJ5dGVMZW5ndGg7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgbGVuZ3RoKTsKICAgICAgYXNzZXJ0KG9mZnNldCArIDQgKyBsZW5ndGggPD0gYnVmZmVyLmJ5dGVMZW5ndGgsICJGb250SW5mby53cml0ZTogQnVmZmVyIG92ZXJmbG93IGF0IGNzc0ZvbnRJbmZvIik7CiAgICAgIGRhdGEuc2V0KG5ldyBVaW50OEFycmF5KGNzc0ZvbnRJbmZvQnVmZmVyKSwgb2Zmc2V0ICsgNCk7CiAgICAgIG9mZnNldCArPSA0ICsgbGVuZ3RoOwogICAgfQogICAgaWYgKGZvbnQuZGF0YSA9PT0gdm9pZCAwKSB7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgMCk7CiAgICAgIG9mZnNldCArPSA0OwogICAgfSBlbHNlIHsKICAgICAgdmlldy5zZXRVaW50MzIob2Zmc2V0LCBmb250LmRhdGEubGVuZ3RoKTsKICAgICAgZGF0YS5zZXQoZm9udC5kYXRhLCBvZmZzZXQgKyA0KTsKICAgICAgb2Zmc2V0ICs9IDQgKyBmb250LmRhdGEubGVuZ3RoOwogICAgfQogICAgYXNzZXJ0KG9mZnNldCA8PSBidWZmZXIuYnl0ZUxlbmd0aCwgIkZvbnRJbmZvLndyaXRlOiBCdWZmZXIgb3ZlcmZsb3ciKTsKICAgIHJldHVybiBidWZmZXIudHJhbnNmZXJUb0ZpeGVkTGVuZ3RoKG9mZnNldCk7CiAgfQp9Owp2YXIgUGF0dGVybkluZm8gPSBjbGFzcyBfUGF0dGVybkluZm8gewogIHN0YXRpYyAjS0lORCA9IDA7CiAgc3RhdGljICNIQVNfQkJPWCA9IDE7CiAgc3RhdGljICNIQVNfQkFDS0dST1VORCA9IDI7CiAgc3RhdGljICNTSEFESU5HX1RZUEUgPSAzOwogIHN0YXRpYyAjTl9DT09SRCA9IDQ7CiAgc3RhdGljICNOX0NPTE9SID0gODsKICBzdGF0aWMgI05fU1RPUCA9IDEyOwogIHN0YXRpYyAjTl9GSUdVUkVTID0gMTY7CiAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICB0aGlzLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgIHRoaXMudmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgdGhpcy5kYXRhID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyKTsKICB9CiAgc3RhdGljIHdyaXRlKGlyKSB7CiAgICBsZXQga2luZCwgYmJveCA9IG51bGwsIGNvb3JkcyA9IFtdLCBjb2xvcnMgPSBbXSwgY29sb3JTdG9wcyA9IFtdLCBmaWd1cmVzID0gW10sIHNoYWRpbmdUeXBlID0gbnVsbCwgYmFja2dyb3VuZCA9IG51bGw7CiAgICBzd2l0Y2ggKGlyWzBdKSB7CiAgICAgIGNhc2UgIlJhZGlhbEF4aWFsIjoKICAgICAgICBraW5kID0gaXJbMV0gPT09ICJheGlhbCIgPyAxIDogMjsKICAgICAgICBiYm94ID0gaXJbMl07CiAgICAgICAgY29sb3JTdG9wcyA9IGlyWzNdOwogICAgICAgIGlmIChraW5kID09PSAxKSB7CiAgICAgICAgICBjb29yZHMucHVzaCguLi5pcls0XSwgLi4uaXJbNV0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb29yZHMucHVzaChpcls0XVswXSwgaXJbNF1bMV0sIGlyWzZdLCBpcls1XVswXSwgaXJbNV1bMV0sIGlyWzddKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIk1lc2giOgogICAgICAgIGtpbmQgPSAzOwogICAgICAgIHNoYWRpbmdUeXBlID0gaXJbMV07CiAgICAgICAgY29vcmRzID0gaXJbMl07CiAgICAgICAgY29sb3JzID0gaXJbM107CiAgICAgICAgZmlndXJlcyA9IGlyWzRdIHx8IFtdOwogICAgICAgIGJib3ggPSBpcls2XTsKICAgICAgICBiYWNrZ3JvdW5kID0gaXJbN107CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBwYXR0ZXJuIHR5cGU6ICR7aXJbMF19YCk7CiAgICB9CiAgICBjb25zdCBuQ29vcmQgPSBNYXRoLmZsb29yKGNvb3Jkcy5sZW5ndGggLyAyKTsKICAgIGNvbnN0IG5Db2xvciA9IE1hdGguZmxvb3IoY29sb3JzLmxlbmd0aCAvIDMpOwogICAgY29uc3QgblN0b3AgPSBjb2xvclN0b3BzLmxlbmd0aDsKICAgIGNvbnN0IG5GaWd1cmVzID0gZmlndXJlcy5sZW5ndGg7CiAgICBsZXQgZmlndXJlc1NpemUgPSAwOwogICAgZm9yIChjb25zdCBmaWd1cmUgb2YgZmlndXJlcykgewogICAgICBmaWd1cmVzU2l6ZSArPSAxOwogICAgICBmaWd1cmVzU2l6ZSA9IE1hdGguY2VpbChmaWd1cmVzU2l6ZSAvIDQpICogNDsKICAgICAgZmlndXJlc1NpemUgKz0gNCArIGZpZ3VyZS5jb29yZHMubGVuZ3RoICogNDsKICAgICAgZmlndXJlc1NpemUgKz0gNCArIGZpZ3VyZS5jb2xvcnMubGVuZ3RoICogNDsKICAgICAgaWYgKGZpZ3VyZS52ZXJ0aWNlc1BlclJvdyAhPT0gdm9pZCAwKSB7CiAgICAgICAgZmlndXJlc1NpemUgKz0gNDsKICAgICAgfQogICAgfQogICAgY29uc3QgYnl0ZUxlbiA9IDIwICsgbkNvb3JkICogOCArIG5Db2xvciAqIDMgKyBuU3RvcCAqIDggKyAoYmJveCA/IDE2IDogMCkgKyAoYmFja2dyb3VuZCA/IDMgOiAwKSArIGZpZ3VyZXNTaXplOwogICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGJ5dGVMZW4pOwogICAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIGNvbnN0IHU4ZGF0YSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgICBkYXRhVmlldy5zZXRVaW50OChfUGF0dGVybkluZm8uI0tJTkQsIGtpbmQpOwogICAgZGF0YVZpZXcuc2V0VWludDgoX1BhdHRlcm5JbmZvLiNIQVNfQkJPWCwgYmJveCA/IDEgOiAwKTsKICAgIGRhdGFWaWV3LnNldFVpbnQ4KF9QYXR0ZXJuSW5mby4jSEFTX0JBQ0tHUk9VTkQsIGJhY2tncm91bmQgPyAxIDogMCk7CiAgICBkYXRhVmlldy5zZXRVaW50OChfUGF0dGVybkluZm8uI1NIQURJTkdfVFlQRSwgc2hhZGluZ1R5cGUpOwogICAgZGF0YVZpZXcuc2V0VWludDMyKF9QYXR0ZXJuSW5mby4jTl9DT09SRCwgbkNvb3JkLCB0cnVlKTsKICAgIGRhdGFWaWV3LnNldFVpbnQzMihfUGF0dGVybkluZm8uI05fQ09MT1IsIG5Db2xvciwgdHJ1ZSk7CiAgICBkYXRhVmlldy5zZXRVaW50MzIoX1BhdHRlcm5JbmZvLiNOX1NUT1AsIG5TdG9wLCB0cnVlKTsKICAgIGRhdGFWaWV3LnNldFVpbnQzMihfUGF0dGVybkluZm8uI05fRklHVVJFUywgbkZpZ3VyZXMsIHRydWUpOwogICAgbGV0IG9mZnNldCA9IDIwOwogICAgY29uc3QgY29vcmRzVmlldyA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyLCBvZmZzZXQsIG5Db29yZCAqIDIpOwogICAgY29vcmRzVmlldy5zZXQoY29vcmRzKTsKICAgIG9mZnNldCArPSBuQ29vcmQgKiA4OwogICAgdThkYXRhLnNldChjb2xvcnMsIG9mZnNldCk7CiAgICBvZmZzZXQgKz0gbkNvbG9yICogMzsKICAgIGZvciAoY29uc3QgW3BvcywgaGV4XSBvZiBjb2xvclN0b3BzKSB7CiAgICAgIGRhdGFWaWV3LnNldEZsb2F0MzIob2Zmc2V0LCBwb3MsIHRydWUpOwogICAgICBvZmZzZXQgKz0gNDsKICAgICAgZGF0YVZpZXcuc2V0VWludDMyKG9mZnNldCwgcGFyc2VJbnQoaGV4LnNsaWNlKDEpLCAxNiksIHRydWUpOwogICAgICBvZmZzZXQgKz0gNDsKICAgIH0KICAgIGlmIChiYm94KSB7CiAgICAgIGZvciAoY29uc3QgdiBvZiBiYm94KSB7CiAgICAgICAgZGF0YVZpZXcuc2V0RmxvYXQzMihvZmZzZXQsIHYsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICB9CiAgICB9CiAgICBpZiAoYmFja2dyb3VuZCkgewogICAgICB1OGRhdGEuc2V0KGJhY2tncm91bmQsIG9mZnNldCk7CiAgICAgIG9mZnNldCArPSAzOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWd1cmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGZpZ3VyZSA9IGZpZ3VyZXNbaV07CiAgICAgIGRhdGFWaWV3LnNldFVpbnQ4KG9mZnNldCwgZmlndXJlLnR5cGUpOwogICAgICBvZmZzZXQgKz0gMTsKICAgICAgb2Zmc2V0ID0gTWF0aC5jZWlsKG9mZnNldCAvIDQpICogNDsKICAgICAgZGF0YVZpZXcuc2V0VWludDMyKG9mZnNldCwgZmlndXJlLmNvb3Jkcy5sZW5ndGgsIHRydWUpOwogICAgICBvZmZzZXQgKz0gNDsKICAgICAgY29uc3QgZmlndXJlQ29vcmRzVmlldyA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlciwgb2Zmc2V0LCBmaWd1cmUuY29vcmRzLmxlbmd0aCk7CiAgICAgIGZpZ3VyZUNvb3Jkc1ZpZXcuc2V0KGZpZ3VyZS5jb29yZHMpOwogICAgICBvZmZzZXQgKz0gZmlndXJlLmNvb3Jkcy5sZW5ndGggKiA0OwogICAgICBkYXRhVmlldy5zZXRVaW50MzIob2Zmc2V0LCBmaWd1cmUuY29sb3JzLmxlbmd0aCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBjb25zdCBjb2xvcnNWaWV3ID0gbmV3IEludDMyQXJyYXkoYnVmZmVyLCBvZmZzZXQsIGZpZ3VyZS5jb2xvcnMubGVuZ3RoKTsKICAgICAgY29sb3JzVmlldy5zZXQoZmlndXJlLmNvbG9ycyk7CiAgICAgIG9mZnNldCArPSBmaWd1cmUuY29sb3JzLmxlbmd0aCAqIDQ7CiAgICAgIGlmIChmaWd1cmUudmVydGljZXNQZXJSb3cgIT09IHZvaWQgMCkgewogICAgICAgIGRhdGFWaWV3LnNldFVpbnQzMihvZmZzZXQsIGZpZ3VyZS52ZXJ0aWNlc1BlclJvdywgdHJ1ZSk7CiAgICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBidWZmZXI7CiAgfQogIGdldElSKCkgewogICAgY29uc3QgZGF0YVZpZXcgPSB0aGlzLnZpZXc7CiAgICBjb25zdCBraW5kID0gdGhpcy5kYXRhW19QYXR0ZXJuSW5mby4jS0lORF07CiAgICBjb25zdCBoYXNCQm94ID0gISF0aGlzLmRhdGFbX1BhdHRlcm5JbmZvLiNIQVNfQkJPWF07CiAgICBjb25zdCBoYXNCYWNrZ3JvdW5kID0gISF0aGlzLmRhdGFbX1BhdHRlcm5JbmZvLiNIQVNfQkFDS0dST1VORF07CiAgICBjb25zdCBuQ29vcmQgPSBkYXRhVmlldy5nZXRVaW50MzIoX1BhdHRlcm5JbmZvLiNOX0NPT1JELCB0cnVlKTsKICAgIGNvbnN0IG5Db2xvciA9IGRhdGFWaWV3LmdldFVpbnQzMihfUGF0dGVybkluZm8uI05fQ09MT1IsIHRydWUpOwogICAgY29uc3QgblN0b3AgPSBkYXRhVmlldy5nZXRVaW50MzIoX1BhdHRlcm5JbmZvLiNOX1NUT1AsIHRydWUpOwogICAgY29uc3QgbkZpZ3VyZXMgPSBkYXRhVmlldy5nZXRVaW50MzIoX1BhdHRlcm5JbmZvLiNOX0ZJR1VSRVMsIHRydWUpOwogICAgbGV0IG9mZnNldCA9IDIwOwogICAgY29uc3QgY29vcmRzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmJ1ZmZlciwgb2Zmc2V0LCBuQ29vcmQgKiAyKTsKICAgIG9mZnNldCArPSBuQ29vcmQgKiA4OwogICAgY29uc3QgY29sb3JzID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5idWZmZXIsIG9mZnNldCwgbkNvbG9yICogMyk7CiAgICBvZmZzZXQgKz0gbkNvbG9yICogMzsKICAgIGNvbnN0IHN0b3BzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5TdG9wOyArK2kpIHsKICAgICAgY29uc3QgcCA9IGRhdGFWaWV3LmdldEZsb2F0MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGNvbnN0IHJnYiA9IGRhdGFWaWV3LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgICBvZmZzZXQgKz0gNDsKICAgICAgc3RvcHMucHVzaChbcCwgYCMke3JnYi50b1N0cmluZygxNikucGFkU3RhcnQoNiwgIjAiKX1gXSk7CiAgICB9CiAgICBsZXQgYmJveCA9IG51bGw7CiAgICBpZiAoaGFzQkJveCkgewogICAgICBiYm94ID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgKytpKSB7CiAgICAgICAgYmJveC5wdXNoKGRhdGFWaWV3LmdldEZsb2F0MzIob2Zmc2V0LCB0cnVlKSk7CiAgICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIH0KICAgIH0KICAgIGxldCBiYWNrZ3JvdW5kID0gbnVsbDsKICAgIGlmIChoYXNCYWNrZ3JvdW5kKSB7CiAgICAgIGJhY2tncm91bmQgPSBuZXcgVWludDhBcnJheSh0aGlzLmJ1ZmZlciwgb2Zmc2V0LCAzKTsKICAgICAgb2Zmc2V0ICs9IDM7CiAgICB9CiAgICBjb25zdCBmaWd1cmVzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5GaWd1cmVzOyArK2kpIHsKICAgICAgY29uc3QgdHlwZSA9IGRhdGFWaWV3LmdldFVpbnQ4KG9mZnNldCk7CiAgICAgIG9mZnNldCArPSAxOwogICAgICBvZmZzZXQgPSBNYXRoLmNlaWwob2Zmc2V0IC8gNCkgKiA0OwogICAgICBjb25zdCBjb29yZHNMZW5ndGggPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGNvbnN0IGZpZ3VyZUNvb3JkcyA9IG5ldyBJbnQzMkFycmF5KHRoaXMuYnVmZmVyLCBvZmZzZXQsIGNvb3Jkc0xlbmd0aCk7CiAgICAgIG9mZnNldCArPSBjb29yZHNMZW5ndGggKiA0OwogICAgICBjb25zdCBjb2xvcnNMZW5ndGggPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGNvbnN0IGZpZ3VyZUNvbG9ycyA9IG5ldyBJbnQzMkFycmF5KHRoaXMuYnVmZmVyLCBvZmZzZXQsIGNvbG9yc0xlbmd0aCk7CiAgICAgIG9mZnNldCArPSBjb2xvcnNMZW5ndGggKiA0OwogICAgICBjb25zdCBmaWd1cmUgPSB7CiAgICAgICAgdHlwZSwKICAgICAgICBjb29yZHM6IGZpZ3VyZUNvb3JkcywKICAgICAgICBjb2xvcnM6IGZpZ3VyZUNvbG9ycwogICAgICB9OwogICAgICBpZiAodHlwZSA9PT0gTWVzaEZpZ3VyZVR5cGUuTEFUVElDRSkgewogICAgICAgIGZpZ3VyZS52ZXJ0aWNlc1BlclJvdyA9IGRhdGFWaWV3LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICB9CiAgICAgIGZpZ3VyZXMucHVzaChmaWd1cmUpOwogICAgfQogICAgaWYgKGtpbmQgPT09IDEpIHsKICAgICAgcmV0dXJuIFsiUmFkaWFsQXhpYWwiLCAiYXhpYWwiLCBiYm94LCBzdG9wcywgQXJyYXkuZnJvbShjb29yZHMuc2xpY2UoMCwgMikpLCBBcnJheS5mcm9tKGNvb3Jkcy5zbGljZSgyLCA0KSksIG51bGwsIG51bGxdOwogICAgfQogICAgaWYgKGtpbmQgPT09IDIpIHsKICAgICAgcmV0dXJuIFsiUmFkaWFsQXhpYWwiLCAicmFkaWFsIiwgYmJveCwgc3RvcHMsIFtjb29yZHNbMF0sIGNvb3Jkc1sxXV0sIFtjb29yZHNbM10sIGNvb3Jkc1s0XV0sIGNvb3Jkc1syXSwgY29vcmRzWzVdXTsKICAgIH0KICAgIGlmIChraW5kID09PSAzKSB7CiAgICAgIGNvbnN0IHNoYWRpbmdUeXBlID0gdGhpcy5kYXRhW19QYXR0ZXJuSW5mby4jU0hBRElOR19UWVBFXTsKICAgICAgbGV0IGJvdW5kcyA9IG51bGw7CiAgICAgIGlmIChjb29yZHMubGVuZ3RoID4gMCkgewogICAgICAgIGxldCBtaW5YID0gY29vcmRzWzBdLCBtYXhYID0gY29vcmRzWzBdOwogICAgICAgIGxldCBtaW5ZID0gY29vcmRzWzFdLCBtYXhZID0gY29vcmRzWzFdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29vcmRzLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCB4ID0gY29vcmRzW2ldLCB5ID0gY29vcmRzW2kgKyAxXTsKICAgICAgICAgIG1pblggPSBtaW5YID4geCA/IHggOiBtaW5YOwogICAgICAgICAgbWluWSA9IG1pblkgPiB5ID8geSA6IG1pblk7CiAgICAgICAgICBtYXhYID0gbWF4WCA8IHggPyB4IDogbWF4WDsKICAgICAgICAgIG1heFkgPSBtYXhZIDwgeSA/IHkgOiBtYXhZOwogICAgICAgIH0KICAgICAgICBib3VuZHMgPSBbbWluWCwgbWluWSwgbWF4WCwgbWF4WV07CiAgICAgIH0KICAgICAgcmV0dXJuIFsiTWVzaCIsIHNoYWRpbmdUeXBlLCBjb29yZHMsIGNvbG9ycywgZmlndXJlcywgYm91bmRzLCBiYm94LCBiYWNrZ3JvdW5kXTsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgcGF0dGVybiBraW5kOiAke2tpbmR9YCk7CiAgfQp9Owp2YXIgRm9udFBhdGhJbmZvID0gY2xhc3MgewogIHN0YXRpYyB3cml0ZShwYXRoKSB7CiAgICBsZXQgZGF0YTsKICAgIGxldCBidWZmZXI7CiAgICBpZiAodXRpbF9GZWF0dXJlVGVzdC5pc0Zsb2F0MTZBcnJheVN1cHBvcnRlZCkgewogICAgICBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIocGF0aC5sZW5ndGggKiAyKTsKICAgICAgZGF0YSA9IG5ldyBGbG9hdDE2QXJyYXkoYnVmZmVyKTsKICAgIH0gZWxzZSB7CiAgICAgIGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihwYXRoLmxlbmd0aCAqIDQpOwogICAgICBkYXRhID0gbmV3IEZsb2F0MzJBcnJheShidWZmZXIpOwogICAgfQogICAgZGF0YS5zZXQocGF0aCk7CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICAjYnVmZmVyOwogIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgdGhpcy4jYnVmZmVyID0gYnVmZmVyOwogIH0KICBnZXQgcGF0aCgpIHsKICAgIGlmICh1dGlsX0ZlYXR1cmVUZXN0LmlzRmxvYXQxNkFycmF5U3VwcG9ydGVkKSB7CiAgICAgIHJldHVybiBuZXcgRmxvYXQxNkFycmF5KHRoaXMuI2J1ZmZlcik7CiAgICB9CiAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheSh0aGlzLiNidWZmZXIpOwogIH0KfTsKZnVuY3Rpb24gZ2V0VXJsUHJvcCh2YWwpIHsKICBpZiAodmFsIGluc3RhbmNlb2YgVVJMKSB7CiAgICByZXR1cm4gdmFsLmhyZWY7CiAgfQogIGlmICh0eXBlb2YgdmFsID09PSAic3RyaW5nIikgewogICAgaWYgKGlzTm9kZUpTKSB7CiAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgICBjb25zdCB1cmwgPSBVUkwucGFyc2UodmFsLCB3aW5kb3cubG9jYXRpb24pOwogICAgaWYgKHVybCkgewogICAgICByZXR1cm4gdXJsLmhyZWY7CiAgICB9CiAgfQogIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBQREYgdXJsIGRhdGE6IGVpdGhlciBzdHJpbmcgb3IgVVJMLW9iamVjdCBpcyBleHBlY3RlZCBpbiB0aGUgdXJsIHByb3BlcnR5LiIpOwp9CmZ1bmN0aW9uIGdldERhdGFQcm9wKHZhbCkgewogIGlmIChpc05vZGVKUyAmJiB0eXBlb2YgQnVmZmVyICE9PSAidW5kZWZpbmVkIiAmJiB2YWwgaW5zdGFuY2VvZiBCdWZmZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigiUGxlYXNlIHByb3ZpZGUgYmluYXJ5IGRhdGEgYXMgYFVpbnQ4QXJyYXlgLCByYXRoZXIgdGhhbiBgQnVmZmVyYC4iKTsKICB9CiAgaWYgKHZhbCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgJiYgdmFsLmJ5dGVMZW5ndGggPT09IHZhbC5idWZmZXIuYnl0ZUxlbmd0aCkgewogICAgcmV0dXJuIHZhbDsKICB9CiAgaWYgKHR5cGVvZiB2YWwgPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gc3RyaW5nVG9CeXRlcyh2YWwpOwogIH0KICBpZiAodmFsIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgfHwgQXJyYXlCdWZmZXIuaXNWaWV3KHZhbCkgfHwgdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgJiYgIWlzTmFOKHZhbD8ubGVuZ3RoKSkgewogICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHZhbCk7CiAgfQogIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBQREYgYmluYXJ5IGRhdGE6IGVpdGhlciBUeXBlZEFycmF5LCBzdHJpbmcsIG9yIGFycmF5LWxpa2Ugb2JqZWN0IGlzIGV4cGVjdGVkIGluIHRoZSBkYXRhIHByb3BlcnR5LiIpOwp9CmZ1bmN0aW9uIGdldEZhY3RvcnlVcmxQcm9wKHZhbCkgewogIGlmICh0eXBlb2YgdmFsICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICh2YWwuZW5kc1dpdGgoIi8iKSkgewogICAgcmV0dXJuIHZhbDsKICB9CiAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZhY3RvcnkgdXJsOiAiJHt2YWx9IiBtdXN0IGluY2x1ZGUgdHJhaWxpbmcgc2xhc2guYCk7Cn0KdmFyIGlzUmVmUHJveHkgPSAodikgPT4gdHlwZW9mIHYgPT09ICJvYmplY3QiICYmIE51bWJlci5pc0ludGVnZXIodj8ubnVtKSAmJiB2Lm51bSA+PSAwICYmIE51bWJlci5pc0ludGVnZXIodj8uZ2VuKSAmJiB2LmdlbiA+PSAwOwp2YXIgaXNOYW1lUHJveHkgPSAodikgPT4gdHlwZW9mIHYgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2Py5uYW1lID09PSAic3RyaW5nIjsKdmFyIGlzVmFsaWRFeHBsaWNpdERlc3QgPSBfaXNWYWxpZEV4cGxpY2l0RGVzdC5iaW5kKG51bGwsIGlzUmVmUHJveHksIGlzTmFtZVByb3h5KTsKdmFyIExvb3BiYWNrUG9ydCA9IGNsYXNzIHsKICAjbGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjZGVmZXJyZWQgPSBQcm9taXNlLnJlc29sdmUoKTsKICBwb3N0TWVzc2FnZShvYmosIHRyYW5zZmVyKSB7CiAgICBjb25zdCBldmVudCA9IHsKICAgICAgZGF0YTogc3RydWN0dXJlZENsb25lKG9iaiwgdHJhbnNmZXIgPyB7CiAgICAgICAgdHJhbnNmZXIKICAgICAgfSA6IG51bGwpCiAgICB9OwogICAgdGhpcy4jZGVmZXJyZWQudGhlbigoKSA9PiB7CiAgICAgIGZvciAoY29uc3QgW2xpc3RlbmVyXSBvZiB0aGlzLiNsaXN0ZW5lcnMpIHsKICAgICAgICBsaXN0ZW5lci5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgfSk7CiAgfQogIGFkZEV2ZW50TGlzdGVuZXIobmFtZSwgbGlzdGVuZXIsIG9wdGlvbnMgPSBudWxsKSB7CiAgICBsZXQgcm1BYm9ydCA9IG51bGw7CiAgICBpZiAob3B0aW9ucz8uc2lnbmFsIGluc3RhbmNlb2YgQWJvcnRTaWduYWwpIHsKICAgICAgY29uc3QgewogICAgICAgIHNpZ25hbAogICAgICB9ID0gb3B0aW9uczsKICAgICAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgd2FybigiTG9vcGJhY2tQb3J0IC0gY2Fubm90IHVzZSBhbiBgYWJvcnRlZGAgc2lnbmFsLiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBvbkFib3J0ID0gKCkgPT4gdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGxpc3RlbmVyKTsKICAgICAgcm1BYm9ydCA9ICgpID0+IHNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCJhYm9ydCIsIG9uQWJvcnQpOwogICAgICBzaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBvbkFib3J0KTsKICAgIH0KICAgIHRoaXMuI2xpc3RlbmVycy5zZXQobGlzdGVuZXIsIHJtQWJvcnQpOwogIH0KICByZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGxpc3RlbmVyKSB7CiAgICBjb25zdCBybUFib3J0ID0gdGhpcy4jbGlzdGVuZXJzLmdldChsaXN0ZW5lcik7CiAgICBybUFib3J0Py4oKTsKICAgIHRoaXMuI2xpc3RlbmVycy5kZWxldGUobGlzdGVuZXIpOwogIH0KICB0ZXJtaW5hdGUoKSB7CiAgICBmb3IgKGNvbnN0IFssIHJtQWJvcnRdIG9mIHRoaXMuI2xpc3RlbmVycykgewogICAgICBybUFib3J0Py4oKTsKICAgIH0KICAgIHRoaXMuI2xpc3RlbmVycy5jbGVhcigpOwogIH0KfTsKdmFyIENhbGxiYWNrS2luZCA9IHsKICBEQVRBOiAxLAogIEVSUk9SOiAyCn07CnZhciBTdHJlYW1LaW5kID0gewogIENBTkNFTDogMSwKICBDQU5DRUxfQ09NUExFVEU6IDIsCiAgQ0xPU0U6IDMsCiAgRU5RVUVVRTogNCwKICBFUlJPUjogNSwKICBQVUxMOiA2LAogIFBVTExfQ09NUExFVEU6IDcsCiAgU1RBUlRfQ09NUExFVEU6IDgKfTsKZnVuY3Rpb24gb25GbigpIHsKfQpmdW5jdGlvbiB3cmFwUmVhc29uKGV4KSB7CiAgaWYgKGV4IGluc3RhbmNlb2YgQWJvcnRFeGNlcHRpb24gfHwgZXggaW5zdGFuY2VvZiBJbnZhbGlkUERGRXhjZXB0aW9uIHx8IGV4IGluc3RhbmNlb2YgUGFzc3dvcmRFeGNlcHRpb24gfHwgZXggaW5zdGFuY2VvZiBSZXNwb25zZUV4Y2VwdGlvbiB8fCBleCBpbnN0YW5jZW9mIFVua25vd25FcnJvckV4Y2VwdGlvbikgewogICAgcmV0dXJuIGV4OwogIH0KICBpZiAoIShleCBpbnN0YW5jZW9mIEVycm9yIHx8IHR5cGVvZiBleCA9PT0gIm9iamVjdCIgJiYgZXggIT09IG51bGwpKSB7CiAgICB1bnJlYWNoYWJsZSgnd3JhcFJlYXNvbjogRXhwZWN0ZWQgInJlYXNvbiIgdG8gYmUgYSAocG9zc2libHkgY2xvbmVkKSBFcnJvci4nKTsKICB9CiAgc3dpdGNoIChleC5uYW1lKSB7CiAgICBjYXNlICJBYm9ydEV4Y2VwdGlvbiI6CiAgICAgIHJldHVybiBuZXcgQWJvcnRFeGNlcHRpb24oZXgubWVzc2FnZSk7CiAgICBjYXNlICJJbnZhbGlkUERGRXhjZXB0aW9uIjoKICAgICAgcmV0dXJuIG5ldyBJbnZhbGlkUERGRXhjZXB0aW9uKGV4Lm1lc3NhZ2UpOwogICAgY2FzZSAiUGFzc3dvcmRFeGNlcHRpb24iOgogICAgICByZXR1cm4gbmV3IFBhc3N3b3JkRXhjZXB0aW9uKGV4Lm1lc3NhZ2UsIGV4LmNvZGUpOwogICAgY2FzZSAiUmVzcG9uc2VFeGNlcHRpb24iOgogICAgICByZXR1cm4gbmV3IFJlc3BvbnNlRXhjZXB0aW9uKGV4Lm1lc3NhZ2UsIGV4LnN0YXR1cywgZXgubWlzc2luZyk7CiAgICBjYXNlICJVbmtub3duRXJyb3JFeGNlcHRpb24iOgogICAgICByZXR1cm4gbmV3IFVua25vd25FcnJvckV4Y2VwdGlvbihleC5tZXNzYWdlLCBleC5kZXRhaWxzKTsKICB9CiAgcmV0dXJuIG5ldyBVbmtub3duRXJyb3JFeGNlcHRpb24oZXgubWVzc2FnZSwgZXgudG9TdHJpbmcoKSk7Cn0KdmFyIE1lc3NhZ2VIYW5kbGVyID0gY2xhc3MgewogICNtZXNzYWdlQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgY29uc3RydWN0b3Ioc291cmNlTmFtZSwgdGFyZ2V0TmFtZSwgY29tT2JqKSB7CiAgICB0aGlzLnNvdXJjZU5hbWUgPSBzb3VyY2VOYW1lOwogICAgdGhpcy50YXJnZXROYW1lID0gdGFyZ2V0TmFtZTsKICAgIHRoaXMuY29tT2JqID0gY29tT2JqOwogICAgdGhpcy5jYWxsYmFja0lkID0gMTsKICAgIHRoaXMuc3RyZWFtSWQgPSAxOwogICAgdGhpcy5zdHJlYW1TaW5rcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5zdHJlYW1Db250cm9sbGVycyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5jYWxsYmFja0NhcGFiaWxpdGllcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5hY3Rpb25IYW5kbGVyID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBjb21PYmouYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIHRoaXMuI29uTWVzc2FnZS5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbDogdGhpcy4jbWVzc2FnZUFDLnNpZ25hbAogICAgfSk7CiAgfQogICNvbk1lc3NhZ2UoewogICAgZGF0YQogIH0pIHsKICAgIGlmIChkYXRhLnRhcmdldE5hbWUgIT09IHRoaXMuc291cmNlTmFtZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZGF0YS5zdHJlYW0pIHsKICAgICAgdGhpcy4jcHJvY2Vzc1N0cmVhbU1lc3NhZ2UoZGF0YSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChkYXRhLmNhbGxiYWNrKSB7CiAgICAgIGNvbnN0IGNhbGxiYWNrSWQgPSBkYXRhLmNhbGxiYWNrSWQ7CiAgICAgIGNvbnN0IGNhcGFiaWxpdHkgPSB0aGlzLmNhbGxiYWNrQ2FwYWJpbGl0aWVzW2NhbGxiYWNrSWRdOwogICAgICBpZiAoIWNhcGFiaWxpdHkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCByZXNvbHZlIGNhbGxiYWNrICR7Y2FsbGJhY2tJZH1gKTsKICAgICAgfQogICAgICBkZWxldGUgdGhpcy5jYWxsYmFja0NhcGFiaWxpdGllc1tjYWxsYmFja0lkXTsKICAgICAgaWYgKGRhdGEuY2FsbGJhY2sgPT09IENhbGxiYWNrS2luZC5EQVRBKSB7CiAgICAgICAgY2FwYWJpbGl0eS5yZXNvbHZlKGRhdGEuZGF0YSk7CiAgICAgIH0gZWxzZSBpZiAoZGF0YS5jYWxsYmFjayA9PT0gQ2FsbGJhY2tLaW5kLkVSUk9SKSB7CiAgICAgICAgY2FwYWJpbGl0eS5yZWplY3Qod3JhcFJlYXNvbihkYXRhLnJlYXNvbikpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjYWxsYmFjayBjYXNlIik7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgYWN0aW9uID0gdGhpcy5hY3Rpb25IYW5kbGVyW2RhdGEuYWN0aW9uXTsKICAgIGlmICghYWN0aW9uKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBhY3Rpb24gZnJvbSB3b3JrZXI6ICR7ZGF0YS5hY3Rpb259YCk7CiAgICB9CiAgICBpZiAoZGF0YS5jYWxsYmFja0lkKSB7CiAgICAgIGNvbnN0IHNvdXJjZU5hbWUgPSB0aGlzLnNvdXJjZU5hbWUsIHRhcmdldE5hbWUgPSBkYXRhLnNvdXJjZU5hbWUsIGNvbU9iaiA9IHRoaXMuY29tT2JqOwogICAgICBQcm9taXNlLnRyeShhY3Rpb24sIGRhdGEuZGF0YSkudGhlbihmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICBjYWxsYmFjazogQ2FsbGJhY2tLaW5kLkRBVEEsCiAgICAgICAgICBjYWxsYmFja0lkOiBkYXRhLmNhbGxiYWNrSWQsCiAgICAgICAgICBkYXRhOiByZXN1bHQKICAgICAgICB9KTsKICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgY2FsbGJhY2s6IENhbGxiYWNrS2luZC5FUlJPUiwKICAgICAgICAgIGNhbGxiYWNrSWQ6IGRhdGEuY2FsbGJhY2tJZCwKICAgICAgICAgIHJlYXNvbjogd3JhcFJlYXNvbihyZWFzb24pCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZGF0YS5zdHJlYW1JZCkgewogICAgICB0aGlzLiNjcmVhdGVTdHJlYW1TaW5rKGRhdGEpOwogICAgICByZXR1cm47CiAgICB9CiAgICBhY3Rpb24oZGF0YS5kYXRhKTsKICB9CiAgb24oYWN0aW9uTmFtZSwgaGFuZGxlcikgewogICAgY29uc3QgYWggPSB0aGlzLmFjdGlvbkhhbmRsZXI7CiAgICBpZiAoYWhbYWN0aW9uTmFtZV0pIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBhbHJlYWR5IGFuIGFjdGlvbk5hbWUgY2FsbGVkICIke2FjdGlvbk5hbWV9ImApOwogICAgfQogICAgYWhbYWN0aW9uTmFtZV0gPSBoYW5kbGVyOwogIH0KICBzZW5kKGFjdGlvbk5hbWUsIGRhdGEsIHRyYW5zZmVycykgewogICAgdGhpcy5jb21PYmoucG9zdE1lc3NhZ2UoewogICAgICBzb3VyY2VOYW1lOiB0aGlzLnNvdXJjZU5hbWUsCiAgICAgIHRhcmdldE5hbWU6IHRoaXMudGFyZ2V0TmFtZSwKICAgICAgYWN0aW9uOiBhY3Rpb25OYW1lLAogICAgICBkYXRhCiAgICB9LCB0cmFuc2ZlcnMpOwogIH0KICBzZW5kV2l0aFByb21pc2UoYWN0aW9uTmFtZSwgZGF0YSwgdHJhbnNmZXJzKSB7CiAgICBjb25zdCBjYWxsYmFja0lkID0gdGhpcy5jYWxsYmFja0lkKys7CiAgICBjb25zdCBjYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLmNhbGxiYWNrQ2FwYWJpbGl0aWVzW2NhbGxiYWNrSWRdID0gY2FwYWJpbGl0eTsKICAgIHRyeSB7CiAgICAgIHRoaXMuY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICBzb3VyY2VOYW1lOiB0aGlzLnNvdXJjZU5hbWUsCiAgICAgICAgdGFyZ2V0TmFtZTogdGhpcy50YXJnZXROYW1lLAogICAgICAgIGFjdGlvbjogYWN0aW9uTmFtZSwKICAgICAgICBjYWxsYmFja0lkLAogICAgICAgIGRhdGEKICAgICAgfSwgdHJhbnNmZXJzKTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIGNhcGFiaWxpdHkucmVqZWN0KGV4KTsKICAgIH0KICAgIHJldHVybiBjYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIHNlbmRXaXRoU3RyZWFtKGFjdGlvbk5hbWUsIGRhdGEsIHF1ZXVlaW5nU3RyYXRlZ3ksIHRyYW5zZmVycykgewogICAgY29uc3Qgc3RyZWFtSWQgPSB0aGlzLnN0cmVhbUlkKyssIHNvdXJjZU5hbWUgPSB0aGlzLnNvdXJjZU5hbWUsIHRhcmdldE5hbWUgPSB0aGlzLnRhcmdldE5hbWUsIGNvbU9iaiA9IHRoaXMuY29tT2JqOwogICAgcmV0dXJuIG5ldyBSZWFkYWJsZVN0cmVhbSh7CiAgICAgIHN0YXJ0OiAoY29udHJvbGxlcikgPT4gewogICAgICAgIGNvbnN0IHN0YXJ0Q2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgICAgIHRoaXMuc3RyZWFtQ29udHJvbGxlcnNbc3RyZWFtSWRdID0gewogICAgICAgICAgY29udHJvbGxlciwKICAgICAgICAgIHN0YXJ0Q2FsbDogc3RhcnRDYXBhYmlsaXR5LAogICAgICAgICAgcHVsbENhbGw6IG51bGwsCiAgICAgICAgICBjYW5jZWxDYWxsOiBudWxsLAogICAgICAgICAgaXNDbG9zZWQ6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICBhY3Rpb246IGFjdGlvbk5hbWUsCiAgICAgICAgICBzdHJlYW1JZCwKICAgICAgICAgIGRhdGEsCiAgICAgICAgICBkZXNpcmVkU2l6ZTogY29udHJvbGxlci5kZXNpcmVkU2l6ZQogICAgICAgIH0sIHRyYW5zZmVycyk7CiAgICAgICAgcmV0dXJuIHN0YXJ0Q2FwYWJpbGl0eS5wcm9taXNlOwogICAgICB9LAogICAgICBwdWxsOiAoY29udHJvbGxlcikgPT4gewogICAgICAgIGNvbnN0IHB1bGxDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICAgICAgdGhpcy5zdHJlYW1Db250cm9sbGVyc1tzdHJlYW1JZF0ucHVsbENhbGwgPSBwdWxsQ2FwYWJpbGl0eTsKICAgICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICBzdHJlYW06IFN0cmVhbUtpbmQuUFVMTCwKICAgICAgICAgIHN0cmVhbUlkLAogICAgICAgICAgZGVzaXJlZFNpemU6IGNvbnRyb2xsZXIuZGVzaXJlZFNpemUKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcHVsbENhcGFiaWxpdHkucHJvbWlzZTsKICAgICAgfSwKICAgICAgY2FuY2VsOiAocmVhc29uKSA9PiB7CiAgICAgICAgYXNzZXJ0KHJlYXNvbiBpbnN0YW5jZW9mIEVycm9yLCAiY2FuY2VsIG11c3QgaGF2ZSBhIHZhbGlkIHJlYXNvbiIpOwogICAgICAgIGNvbnN0IGNhbmNlbENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgICAgICB0aGlzLnN0cmVhbUNvbnRyb2xsZXJzW3N0cmVhbUlkXS5jYW5jZWxDYWxsID0gY2FuY2VsQ2FwYWJpbGl0eTsKICAgICAgICB0aGlzLnN0cmVhbUNvbnRyb2xsZXJzW3N0cmVhbUlkXS5pc0Nsb3NlZCA9IHRydWU7CiAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLkNBTkNFTCwKICAgICAgICAgIHN0cmVhbUlkLAogICAgICAgICAgcmVhc29uOiB3cmFwUmVhc29uKHJlYXNvbikKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY2FuY2VsQ2FwYWJpbGl0eS5wcm9taXNlOwogICAgICB9CiAgICB9LCBxdWV1ZWluZ1N0cmF0ZWd5KTsKICB9CiAgI2NyZWF0ZVN0cmVhbVNpbmsoZGF0YSkgewogICAgY29uc3Qgc3RyZWFtSWQgPSBkYXRhLnN0cmVhbUlkLCBzb3VyY2VOYW1lID0gdGhpcy5zb3VyY2VOYW1lLCB0YXJnZXROYW1lID0gZGF0YS5zb3VyY2VOYW1lLCBjb21PYmogPSB0aGlzLmNvbU9iajsKICAgIGNvbnN0IHNlbGYgPSB0aGlzLCBhY3Rpb24gPSB0aGlzLmFjdGlvbkhhbmRsZXJbZGF0YS5hY3Rpb25dOwogICAgY29uc3Qgc3RyZWFtU2luayA9IHsKICAgICAgZW5xdWV1ZShjaHVuaywgc2l6ZSA9IDEsIHRyYW5zZmVycykgewogICAgICAgIGlmICh0aGlzLmlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxhc3REZXNpcmVkU2l6ZSA9IHRoaXMuZGVzaXJlZFNpemU7CiAgICAgICAgdGhpcy5kZXNpcmVkU2l6ZSAtPSBzaXplOwogICAgICAgIGlmIChsYXN0RGVzaXJlZFNpemUgPiAwICYmIHRoaXMuZGVzaXJlZFNpemUgPD0gMCkgewogICAgICAgICAgdGhpcy5zaW5rQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgICAgICAgdGhpcy5yZWFkeSA9IHRoaXMuc2lua0NhcGFiaWxpdHkucHJvbWlzZTsKICAgICAgICB9CiAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLkVOUVVFVUUsCiAgICAgICAgICBzdHJlYW1JZCwKICAgICAgICAgIGNodW5rCiAgICAgICAgfSwgdHJhbnNmZXJzKTsKICAgICAgfSwKICAgICAgY2xvc2UoKSB7CiAgICAgICAgaWYgKHRoaXMuaXNDYW5jZWxsZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5pc0NhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLkNMT1NFLAogICAgICAgICAgc3RyZWFtSWQKICAgICAgICB9KTsKICAgICAgICBkZWxldGUgc2VsZi5zdHJlYW1TaW5rc1tzdHJlYW1JZF07CiAgICAgIH0sCiAgICAgIGVycm9yKHJlYXNvbikgewogICAgICAgIGFzc2VydChyZWFzb24gaW5zdGFuY2VvZiBFcnJvciwgImVycm9yIG11c3QgaGF2ZSBhIHZhbGlkIHJlYXNvbiIpOwogICAgICAgIGlmICh0aGlzLmlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuaXNDYW5jZWxsZWQgPSB0cnVlOwogICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5FUlJPUiwKICAgICAgICAgIHN0cmVhbUlkLAogICAgICAgICAgcmVhc29uOiB3cmFwUmVhc29uKHJlYXNvbikKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgc2lua0NhcGFiaWxpdHk6IFByb21pc2Uud2l0aFJlc29sdmVycygpLAogICAgICBvblB1bGw6IG51bGwsCiAgICAgIG9uQ2FuY2VsOiBudWxsLAogICAgICBpc0NhbmNlbGxlZDogZmFsc2UsCiAgICAgIGRlc2lyZWRTaXplOiBkYXRhLmRlc2lyZWRTaXplLAogICAgICByZWFkeTogbnVsbAogICAgfTsKICAgIHN0cmVhbVNpbmsuc2lua0NhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgc3RyZWFtU2luay5yZWFkeSA9IHN0cmVhbVNpbmsuc2lua0NhcGFiaWxpdHkucHJvbWlzZTsKICAgIHRoaXMuc3RyZWFtU2lua3Nbc3RyZWFtSWRdID0gc3RyZWFtU2luazsKICAgIFByb21pc2UudHJ5KGFjdGlvbiwgZGF0YS5kYXRhLCBzdHJlYW1TaW5rKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICBzdHJlYW06IFN0cmVhbUtpbmQuU1RBUlRfQ09NUExFVEUsCiAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgc3VjY2VzczogdHJ1ZQogICAgICB9KTsKICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICBzdHJlYW06IFN0cmVhbUtpbmQuU1RBUlRfQ09NUExFVEUsCiAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgcmVhc29uOiB3cmFwUmVhc29uKHJlYXNvbikKICAgICAgfSk7CiAgICB9KTsKICB9CiAgI3Byb2Nlc3NTdHJlYW1NZXNzYWdlKGRhdGEpIHsKICAgIGNvbnN0IHN0cmVhbUlkID0gZGF0YS5zdHJlYW1JZCwgc291cmNlTmFtZSA9IHRoaXMuc291cmNlTmFtZSwgdGFyZ2V0TmFtZSA9IGRhdGEuc291cmNlTmFtZSwgY29tT2JqID0gdGhpcy5jb21PYmo7CiAgICBjb25zdCBzdHJlYW1Db250cm9sbGVyID0gdGhpcy5zdHJlYW1Db250cm9sbGVyc1tzdHJlYW1JZF0sIHN0cmVhbVNpbmsgPSB0aGlzLnN0cmVhbVNpbmtzW3N0cmVhbUlkXTsKICAgIHN3aXRjaCAoZGF0YS5zdHJlYW0pIHsKICAgICAgY2FzZSBTdHJlYW1LaW5kLlNUQVJUX0NPTVBMRVRFOgogICAgICAgIGlmIChkYXRhLnN1Y2Nlc3MpIHsKICAgICAgICAgIHN0cmVhbUNvbnRyb2xsZXIuc3RhcnRDYWxsLnJlc29sdmUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyZWFtQ29udHJvbGxlci5zdGFydENhbGwucmVqZWN0KHdyYXBSZWFzb24oZGF0YS5yZWFzb24pKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgU3RyZWFtS2luZC5QVUxMX0NPTVBMRVRFOgogICAgICAgIGlmIChkYXRhLnN1Y2Nlc3MpIHsKICAgICAgICAgIHN0cmVhbUNvbnRyb2xsZXIucHVsbENhbGwucmVzb2x2ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHJlYW1Db250cm9sbGVyLnB1bGxDYWxsLnJlamVjdCh3cmFwUmVhc29uKGRhdGEucmVhc29uKSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlIFN0cmVhbUtpbmQuUFVMTDoKICAgICAgICBpZiAoIXN0cmVhbVNpbmspIHsKICAgICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5QVUxMX0NPTVBMRVRFLAogICAgICAgICAgICBzdHJlYW1JZCwKICAgICAgICAgICAgc3VjY2VzczogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmVhbVNpbmsuZGVzaXJlZFNpemUgPD0gMCAmJiBkYXRhLmRlc2lyZWRTaXplID4gMCkgewogICAgICAgICAgc3RyZWFtU2luay5zaW5rQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICAgICAgfQogICAgICAgIHN0cmVhbVNpbmsuZGVzaXJlZFNpemUgPSBkYXRhLmRlc2lyZWRTaXplOwogICAgICAgIFByb21pc2UudHJ5KHN0cmVhbVNpbmsub25QdWxsIHx8IG9uRm4pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgICBzdHJlYW06IFN0cmVhbUtpbmQuUFVMTF9DT01QTEVURSwKICAgICAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLlBVTExfQ09NUExFVEUsCiAgICAgICAgICAgIHN0cmVhbUlkLAogICAgICAgICAgICByZWFzb246IHdyYXBSZWFzb24ocmVhc29uKQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgU3RyZWFtS2luZC5FTlFVRVVFOgogICAgICAgIGFzc2VydChzdHJlYW1Db250cm9sbGVyLCAiZW5xdWV1ZSBzaG91bGQgaGF2ZSBzdHJlYW0gY29udHJvbGxlciIpOwogICAgICAgIGlmIChzdHJlYW1Db250cm9sbGVyLmlzQ2xvc2VkKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgc3RyZWFtQ29udHJvbGxlci5jb250cm9sbGVyLmVucXVldWUoZGF0YS5jaHVuayk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgU3RyZWFtS2luZC5DTE9TRToKICAgICAgICBhc3NlcnQoc3RyZWFtQ29udHJvbGxlciwgImNsb3NlIHNob3VsZCBoYXZlIHN0cmVhbSBjb250cm9sbGVyIik7CiAgICAgICAgaWYgKHN0cmVhbUNvbnRyb2xsZXIuaXNDbG9zZWQpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBzdHJlYW1Db250cm9sbGVyLmlzQ2xvc2VkID0gdHJ1ZTsKICAgICAgICBzdHJlYW1Db250cm9sbGVyLmNvbnRyb2xsZXIuY2xvc2UoKTsKICAgICAgICB0aGlzLiNkZWxldGVTdHJlYW1Db250cm9sbGVyKHN0cmVhbUNvbnRyb2xsZXIsIHN0cmVhbUlkKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBTdHJlYW1LaW5kLkVSUk9SOgogICAgICAgIGFzc2VydChzdHJlYW1Db250cm9sbGVyLCAiZXJyb3Igc2hvdWxkIGhhdmUgc3RyZWFtIGNvbnRyb2xsZXIiKTsKICAgICAgICBzdHJlYW1Db250cm9sbGVyLmNvbnRyb2xsZXIuZXJyb3Iod3JhcFJlYXNvbihkYXRhLnJlYXNvbikpOwogICAgICAgIHRoaXMuI2RlbGV0ZVN0cmVhbUNvbnRyb2xsZXIoc3RyZWFtQ29udHJvbGxlciwgc3RyZWFtSWQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIFN0cmVhbUtpbmQuQ0FOQ0VMX0NPTVBMRVRFOgogICAgICAgIGlmIChkYXRhLnN1Y2Nlc3MpIHsKICAgICAgICAgIHN0cmVhbUNvbnRyb2xsZXIuY2FuY2VsQ2FsbC5yZXNvbHZlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cmVhbUNvbnRyb2xsZXIuY2FuY2VsQ2FsbC5yZWplY3Qod3JhcFJlYXNvbihkYXRhLnJlYXNvbikpOwogICAgICAgIH0KICAgICAgICB0aGlzLiNkZWxldGVTdHJlYW1Db250cm9sbGVyKHN0cmVhbUNvbnRyb2xsZXIsIHN0cmVhbUlkKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBTdHJlYW1LaW5kLkNBTkNFTDoKICAgICAgICBpZiAoIXN0cmVhbVNpbmspIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBjb25zdCBkYXRhUmVhc29uID0gd3JhcFJlYXNvbihkYXRhLnJlYXNvbik7CiAgICAgICAgUHJvbWlzZS50cnkoc3RyZWFtU2luay5vbkNhbmNlbCB8fCBvbkZuLCBkYXRhUmVhc29uKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLkNBTkNFTF9DT01QTEVURSwKICAgICAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLkNBTkNFTF9DT01QTEVURSwKICAgICAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgICAgIHJlYXNvbjogd3JhcFJlYXNvbihyZWFzb24pCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBzdHJlYW1TaW5rLnNpbmtDYXBhYmlsaXR5LnJlamVjdChkYXRhUmVhc29uKTsKICAgICAgICBzdHJlYW1TaW5rLmlzQ2FuY2VsbGVkID0gdHJ1ZTsKICAgICAgICBkZWxldGUgdGhpcy5zdHJlYW1TaW5rc1tzdHJlYW1JZF07CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIHN0cmVhbSBjYXNlIik7CiAgICB9CiAgfQogIGFzeW5jICNkZWxldGVTdHJlYW1Db250cm9sbGVyKHN0cmVhbUNvbnRyb2xsZXIsIHN0cmVhbUlkKSB7CiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoW3N0cmVhbUNvbnRyb2xsZXIuc3RhcnRDYWxsPy5wcm9taXNlLCBzdHJlYW1Db250cm9sbGVyLnB1bGxDYWxsPy5wcm9taXNlLCBzdHJlYW1Db250cm9sbGVyLmNhbmNlbENhbGw/LnByb21pc2VdKTsKICAgIGRlbGV0ZSB0aGlzLnN0cmVhbUNvbnRyb2xsZXJzW3N0cmVhbUlkXTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI21lc3NhZ2VBQz8uYWJvcnQoKTsKICAgIHRoaXMuI21lc3NhZ2VBQyA9IG51bGw7CiAgfQp9Owp2YXIgQmFzZUNhbnZhc0ZhY3RvcnkgPSBjbGFzcyB7CiAgI2VuYWJsZUhXQSA9IGZhbHNlOwogIGNvbnN0cnVjdG9yKHsKICAgIGVuYWJsZUhXQSA9IGZhbHNlCiAgfSkgewogICAgdGhpcy4jZW5hYmxlSFdBID0gZW5hYmxlSFdBOwogIH0KICBjcmVhdGUod2lkdGgsIGhlaWdodCkgewogICAgaWYgKHdpZHRoIDw9IDAgfHwgaGVpZ2h0IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGNhbnZhcyBzaXplIik7CiAgICB9CiAgICBjb25zdCBjYW52YXMgPSB0aGlzLl9jcmVhdGVDYW52YXMod2lkdGgsIGhlaWdodCk7CiAgICByZXR1cm4gewogICAgICBjYW52YXMsCiAgICAgIGNvbnRleHQ6IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsKICAgICAgICB3aWxsUmVhZEZyZXF1ZW50bHk6ICF0aGlzLiNlbmFibGVIV0EKICAgICAgfSkKICAgIH07CiAgfQogIHJlc2V0KGNhbnZhc0FuZENvbnRleHQsIHdpZHRoLCBoZWlnaHQpIHsKICAgIGlmICghY2FudmFzQW5kQ29udGV4dC5jYW52YXMpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW52YXMgaXMgbm90IHNwZWNpZmllZCIpOwogICAgfQogICAgaWYgKHdpZHRoIDw9IDAgfHwgaGVpZ2h0IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGNhbnZhcyBzaXplIik7CiAgICB9CiAgICBjYW52YXNBbmRDb250ZXh0LmNhbnZhcy53aWR0aCA9IHdpZHRoOwogICAgY2FudmFzQW5kQ29udGV4dC5jYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwogIH0KICBkZXN0cm95KGNhbnZhc0FuZENvbnRleHQpIHsKICAgIGlmICghY2FudmFzQW5kQ29udGV4dC5jYW52YXMpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW52YXMgaXMgbm90IHNwZWNpZmllZCIpOwogICAgfQogICAgY2FudmFzQW5kQ29udGV4dC5jYW52YXMud2lkdGggPSAwOwogICAgY2FudmFzQW5kQ29udGV4dC5jYW52YXMuaGVpZ2h0ID0gMDsKICAgIGNhbnZhc0FuZENvbnRleHQuY2FudmFzID0gbnVsbDsKICAgIGNhbnZhc0FuZENvbnRleHQuY29udGV4dCA9IG51bGw7CiAgfQogIF9jcmVhdGVDYW52YXMod2lkdGgsIGhlaWdodCkgewogICAgdW5yZWFjaGFibGUoIkFic3RyYWN0IG1ldGhvZCBgX2NyZWF0ZUNhbnZhc2AgY2FsbGVkLiIpOwogIH0KfTsKdmFyIERPTUNhbnZhc0ZhY3RvcnkgPSBjbGFzcyBleHRlbmRzIEJhc2VDYW52YXNGYWN0b3J5IHsKICBjb25zdHJ1Y3Rvcih7CiAgICBvd25lckRvY3VtZW50ID0gZ2xvYmFsVGhpcy5kb2N1bWVudCwKICAgIGVuYWJsZUhXQSA9IGZhbHNlCiAgfSkgewogICAgc3VwZXIoewogICAgICBlbmFibGVIV0EKICAgIH0pOwogICAgdGhpcy5fZG9jdW1lbnQgPSBvd25lckRvY3VtZW50OwogIH0KICBfY3JlYXRlQ2FudmFzKHdpZHRoLCBoZWlnaHQpIHsKICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuX2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgY2FudmFzLndpZHRoID0gd2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgcmV0dXJuIGNhbnZhczsKICB9Cn07CnZhciBCYXNlQ01hcFJlYWRlckZhY3RvcnkgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoewogICAgYmFzZVVybCA9IG51bGwsCiAgICBpc0NvbXByZXNzZWQgPSB0cnVlCiAgfSkgewogICAgdGhpcy5iYXNlVXJsID0gYmFzZVVybDsKICAgIHRoaXMuaXNDb21wcmVzc2VkID0gaXNDb21wcmVzc2VkOwogIH0KICBhc3luYyBmZXRjaCh7CiAgICBuYW1lCiAgfSkgewogICAgaWYgKCF0aGlzLmJhc2VVcmwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbnN1cmUgdGhhdCB0aGUgYGNNYXBVcmxgIGFuZCBgY01hcFBhY2tlZGAgQVBJIHBhcmFtZXRlcnMgYXJlIHByb3ZpZGVkLiIpOwogICAgfQogICAgaWYgKCFuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQ01hcCBuYW1lIG11c3QgYmUgc3BlY2lmaWVkLiIpOwogICAgfQogICAgY29uc3QgdXJsID0gdGhpcy5iYXNlVXJsICsgbmFtZSArICh0aGlzLmlzQ29tcHJlc3NlZCA/ICIuYmNtYXAiIDogIiIpOwogICAgcmV0dXJuIHRoaXMuX2ZldGNoKHVybCkudGhlbigoY01hcERhdGEpID0+ICh7CiAgICAgIGNNYXBEYXRhLAogICAgICBpc0NvbXByZXNzZWQ6IHRoaXMuaXNDb21wcmVzc2VkCiAgICB9KSkuY2F0Y2goKHJlYXNvbikgPT4gewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBsb2FkICR7dGhpcy5pc0NvbXByZXNzZWQgPyAiYmluYXJ5ICIgOiAiIn1DTWFwIGF0OiAke3VybH1gKTsKICAgIH0pOwogIH0KICBhc3luYyBfZmV0Y2godXJsKSB7CiAgICB1bnJlYWNoYWJsZSgiQWJzdHJhY3QgbWV0aG9kIGBfZmV0Y2hgIGNhbGxlZC4iKTsKICB9Cn07CnZhciBET01DTWFwUmVhZGVyRmFjdG9yeSA9IGNsYXNzIGV4dGVuZHMgQmFzZUNNYXBSZWFkZXJGYWN0b3J5IHsKICBhc3luYyBfZmV0Y2godXJsKSB7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgZmV0Y2hEYXRhKHVybCwgdGhpcy5pc0NvbXByZXNzZWQgPyAiYXJyYXlidWZmZXIiIDogInRleHQiKTsKICAgIHJldHVybiBkYXRhIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgPyBuZXcgVWludDhBcnJheShkYXRhKSA6IHN0cmluZ1RvQnl0ZXMoZGF0YSk7CiAgfQp9Owp2YXIgQmFzZUZpbHRlckZhY3RvcnkgPSBjbGFzcyB7CiAgYWRkRmlsdGVyKG1hcHMpIHsKICAgIHJldHVybiAibm9uZSI7CiAgfQogIGFkZEhDTUZpbHRlcihmZ0NvbG9yLCBiZ0NvbG9yKSB7CiAgICByZXR1cm4gIm5vbmUiOwogIH0KICBhZGRBbHBoYUZpbHRlcihtYXApIHsKICAgIHJldHVybiAibm9uZSI7CiAgfQogIGFkZEx1bWlub3NpdHlGaWx0ZXIobWFwKSB7CiAgICByZXR1cm4gIm5vbmUiOwogIH0KICBhZGRIaWdobGlnaHRIQ01GaWx0ZXIoZmlsdGVyTmFtZSwgZmdDb2xvciwgYmdDb2xvciwgbmV3RmdDb2xvciwgbmV3QmdDb2xvcikgewogICAgcmV0dXJuICJub25lIjsKICB9CiAgZGVzdHJveShrZWVwSENNID0gZmFsc2UpIHsKICB9Cn07CnZhciBET01GaWx0ZXJGYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlRmlsdGVyRmFjdG9yeSB7CiAgI2Jhc2VVcmw7CiAgI19jYWNoZTsKICAjX2RlZnM7CiAgI2RvY0lkOwogICNkb2N1bWVudDsKICAjX2hjbUNhY2hlOwogICNpZCA9IDA7CiAgY29uc3RydWN0b3IoewogICAgZG9jSWQsCiAgICBvd25lckRvY3VtZW50ID0gZ2xvYmFsVGhpcy5kb2N1bWVudAogIH0pIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLiNkb2NJZCA9IGRvY0lkOwogICAgdGhpcy4jZG9jdW1lbnQgPSBvd25lckRvY3VtZW50OwogIH0KICBnZXQgI2NhY2hlKCkgewogICAgcmV0dXJuIHRoaXMuI19jYWNoZSB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICB9CiAgZ2V0ICNoY21DYWNoZSgpIHsKICAgIHJldHVybiB0aGlzLiNfaGNtQ2FjaGUgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgfQogIGdldCAjZGVmcygpIHsKICAgIGlmICghdGhpcy4jX2RlZnMpIHsKICAgICAgY29uc3QgZGl2ID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGNvbnN0IHsKICAgICAgICBzdHlsZQogICAgICB9ID0gZGl2OwogICAgICBzdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgIHN0eWxlLmNvbnRhaW4gPSAic3RyaWN0IjsKICAgICAgc3R5bGUud2lkdGggPSBzdHlsZS5oZWlnaHQgPSAwOwogICAgICBzdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgIHN0eWxlLnRvcCA9IHN0eWxlLmxlZnQgPSAwOwogICAgICBzdHlsZS56SW5kZXggPSAtMTsKICAgICAgY29uc3Qgc3ZnID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgInN2ZyIpOwogICAgICBzdmcuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIDApOwogICAgICBzdmcuc2V0QXR0cmlidXRlKCJoZWlnaHQiLCAwKTsKICAgICAgdGhpcy4jX2RlZnMgPSB0aGlzLiNkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoU1ZHX05TLCAiZGVmcyIpOwogICAgICBkaXYuYXBwZW5kKHN2Zyk7CiAgICAgIHN2Zy5hcHBlbmQodGhpcy4jX2RlZnMpOwogICAgICB0aGlzLiNkb2N1bWVudC5ib2R5LmFwcGVuZChkaXYpOwogICAgfQogICAgcmV0dXJuIHRoaXMuI19kZWZzOwogIH0KICAjY3JlYXRlVGFibGVzKG1hcHMpIHsKICAgIGlmIChtYXBzLmxlbmd0aCA9PT0gMSkgewogICAgICBjb25zdCBtYXBSMiA9IG1hcHNbMF07CiAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheSgyNTYpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI1NjsgaSsrKSB7CiAgICAgICAgYnVmZmVyW2ldID0gbWFwUjJbaV0gLyAyNTU7CiAgICAgIH0KICAgICAgY29uc3QgdGFibGUgPSBidWZmZXIuam9pbigiLCIpOwogICAgICByZXR1cm4gW3RhYmxlLCB0YWJsZSwgdGFibGVdOwogICAgfQogICAgY29uc3QgW21hcFIsIG1hcEcsIG1hcEJdID0gbWFwczsKICAgIGNvbnN0IGJ1ZmZlclIgPSBuZXcgQXJyYXkoMjU2KTsKICAgIGNvbnN0IGJ1ZmZlckcgPSBuZXcgQXJyYXkoMjU2KTsKICAgIGNvbnN0IGJ1ZmZlckIgPSBuZXcgQXJyYXkoMjU2KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjU2OyBpKyspIHsKICAgICAgYnVmZmVyUltpXSA9IG1hcFJbaV0gLyAyNTU7CiAgICAgIGJ1ZmZlckdbaV0gPSBtYXBHW2ldIC8gMjU1OwogICAgICBidWZmZXJCW2ldID0gbWFwQltpXSAvIDI1NTsKICAgIH0KICAgIHJldHVybiBbYnVmZmVyUi5qb2luKCIsIiksIGJ1ZmZlckcuam9pbigiLCIpLCBidWZmZXJCLmpvaW4oIiwiKV07CiAgfQogICNjcmVhdGVVcmwoaWQpIHsKICAgIGlmICh0aGlzLiNiYXNlVXJsID09PSB2b2lkIDApIHsKICAgICAgdGhpcy4jYmFzZVVybCA9ICIiOwogICAgICBjb25zdCB1cmwgPSB0aGlzLiNkb2N1bWVudC5VUkw7CiAgICAgIGlmICh1cmwgIT09IHRoaXMuI2RvY3VtZW50LmJhc2VVUkkpIHsKICAgICAgICBpZiAoaXNEYXRhU2NoZW1lKHVybCkpIHsKICAgICAgICAgIHdhcm4oJyNjcmVhdGVVcmw6IGlnbm9yZSAiZGF0YToiLVVSTCBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucy4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4jYmFzZVVybCA9IHVwZGF0ZVVybEhhc2godXJsLCAiIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYHVybCgke3RoaXMuI2Jhc2VVcmx9IyR7aWR9KWA7CiAgfQogIGFkZEZpbHRlcihtYXBzKSB7CiAgICBpZiAoIW1hcHMpIHsKICAgICAgcmV0dXJuICJub25lIjsKICAgIH0KICAgIGxldCB2YWx1ZSA9IHRoaXMuI2NhY2hlLmdldChtYXBzKTsKICAgIGlmICh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBjb25zdCBbdGFibGVSLCB0YWJsZUcsIHRhYmxlQl0gPSB0aGlzLiNjcmVhdGVUYWJsZXMobWFwcyk7CiAgICBjb25zdCBrZXkgPSBtYXBzLmxlbmd0aCA9PT0gMSA/IHRhYmxlUiA6IGAke3RhYmxlUn0ke3RhYmxlR30ke3RhYmxlQn1gOwogICAgdmFsdWUgPSB0aGlzLiNjYWNoZS5nZXQoa2V5KTsKICAgIGlmICh2YWx1ZSkgewogICAgICB0aGlzLiNjYWNoZS5zZXQobWFwcywgdmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBjb25zdCBpZCA9IGBnXyR7dGhpcy4jZG9jSWR9X3RyYW5zZmVyX21hcF8ke3RoaXMuI2lkKyt9YDsKICAgIGNvbnN0IHVybCA9IHRoaXMuI2NyZWF0ZVVybChpZCk7CiAgICB0aGlzLiNjYWNoZS5zZXQobWFwcywgdXJsKTsKICAgIHRoaXMuI2NhY2hlLnNldChrZXksIHVybCk7CiAgICBjb25zdCBmaWx0ZXIgPSB0aGlzLiNjcmVhdGVGaWx0ZXIoaWQpOwogICAgdGhpcy4jYWRkVHJhbnNmZXJNYXBDb252ZXJzaW9uKHRhYmxlUiwgdGFibGVHLCB0YWJsZUIsIGZpbHRlcik7CiAgICByZXR1cm4gdXJsOwogIH0KICBhZGRIQ01GaWx0ZXIoZmdDb2xvciwgYmdDb2xvcikgewogICAgY29uc3Qga2V5ID0gYCR7ZmdDb2xvcn0tJHtiZ0NvbG9yfWA7CiAgICBjb25zdCBmaWx0ZXJOYW1lID0gImJhc2UiOwogICAgbGV0IGluZm8yID0gdGhpcy4jaGNtQ2FjaGUuZ2V0KGZpbHRlck5hbWUpOwogICAgaWYgKGluZm8yPy5rZXkgPT09IGtleSkgewogICAgICByZXR1cm4gaW5mbzIudXJsOwogICAgfQogICAgaWYgKGluZm8yKSB7CiAgICAgIGluZm8yLmZpbHRlcj8ucmVtb3ZlKCk7CiAgICAgIGluZm8yLmtleSA9IGtleTsKICAgICAgaW5mbzIudXJsID0gIm5vbmUiOwogICAgICBpbmZvMi5maWx0ZXIgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgaW5mbzIgPSB7CiAgICAgICAga2V5LAogICAgICAgIHVybDogIm5vbmUiLAogICAgICAgIGZpbHRlcjogbnVsbAogICAgICB9OwogICAgICB0aGlzLiNoY21DYWNoZS5zZXQoZmlsdGVyTmFtZSwgaW5mbzIpOwogICAgfQogICAgaWYgKCFmZ0NvbG9yIHx8ICFiZ0NvbG9yKSB7CiAgICAgIHJldHVybiBpbmZvMi51cmw7CiAgICB9CiAgICBjb25zdCBmZ1JHQiA9IHRoaXMuI2dldFJHQihmZ0NvbG9yKTsKICAgIGZnQ29sb3IgPSBVdGlsLm1ha2VIZXhDb2xvciguLi5mZ1JHQik7CiAgICBjb25zdCBiZ1JHQiA9IHRoaXMuI2dldFJHQihiZ0NvbG9yKTsKICAgIGJnQ29sb3IgPSBVdGlsLm1ha2VIZXhDb2xvciguLi5iZ1JHQik7CiAgICB0aGlzLiNkZWZzLnN0eWxlLmNvbG9yID0gIiI7CiAgICBpZiAoZmdDb2xvciA9PT0gIiMwMDAwMDAiICYmIGJnQ29sb3IgPT09ICIjZmZmZmZmIiB8fCBmZ0NvbG9yID09PSBiZ0NvbG9yKSB7CiAgICAgIHJldHVybiBpbmZvMi51cmw7CiAgICB9CiAgICBjb25zdCBtYXAgPSBuZXcgQXJyYXkoMjU2KTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IDI1NTsgaSsrKSB7CiAgICAgIGNvbnN0IHggPSBpIC8gMjU1OwogICAgICBtYXBbaV0gPSB4IDw9IDAuMDM5MjggPyB4IC8gMTIuOTIgOiAoKHggKyAwLjA1NSkgLyAxLjA1NSkgKiogMi40OwogICAgfQogICAgY29uc3QgdGFibGUgPSBtYXAuam9pbigiLCIpOwogICAgY29uc3QgaWQgPSBgZ18ke3RoaXMuI2RvY0lkfV9oY21fZmlsdGVyYDsKICAgIGNvbnN0IGZpbHRlciA9IGluZm8yLmZpbHRlciA9IHRoaXMuI2NyZWF0ZUZpbHRlcihpZCk7CiAgICB0aGlzLiNhZGRUcmFuc2Zlck1hcENvbnZlcnNpb24odGFibGUsIHRhYmxlLCB0YWJsZSwgZmlsdGVyKTsKICAgIHRoaXMuI2FkZEdyYXlDb252ZXJzaW9uKGZpbHRlcik7CiAgICBjb25zdCBnZXRTdGVwcyA9IChjLCBuKSA9PiB7CiAgICAgIGNvbnN0IHN0YXJ0ID0gZmdSR0JbY10gLyAyNTU7CiAgICAgIGNvbnN0IGVuZCA9IGJnUkdCW2NdIC8gMjU1OwogICAgICBjb25zdCBhcnIgPSBuZXcgQXJyYXkobiArIDEpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBuOyBpKyspIHsKICAgICAgICBhcnJbaV0gPSBzdGFydCArIGkgLyBuICogKGVuZCAtIHN0YXJ0KTsKICAgICAgfQogICAgICByZXR1cm4gYXJyLmpvaW4oIiwiKTsKICAgIH07CiAgICB0aGlzLiNhZGRUcmFuc2Zlck1hcENvbnZlcnNpb24oZ2V0U3RlcHMoMCwgNSksIGdldFN0ZXBzKDEsIDUpLCBnZXRTdGVwcygyLCA1KSwgZmlsdGVyKTsKICAgIGluZm8yLnVybCA9IHRoaXMuI2NyZWF0ZVVybChpZCk7CiAgICByZXR1cm4gaW5mbzIudXJsOwogIH0KICBhZGRBbHBoYUZpbHRlcihtYXApIHsKICAgIGxldCB2YWx1ZSA9IHRoaXMuI2NhY2hlLmdldChtYXApOwogICAgaWYgKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGNvbnN0IFt0YWJsZUFdID0gdGhpcy4jY3JlYXRlVGFibGVzKFttYXBdKTsKICAgIGNvbnN0IGtleSA9IGBhbHBoYV8ke3RhYmxlQX1gOwogICAgdmFsdWUgPSB0aGlzLiNjYWNoZS5nZXQoa2V5KTsKICAgIGlmICh2YWx1ZSkgewogICAgICB0aGlzLiNjYWNoZS5zZXQobWFwLCB2YWx1ZSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGNvbnN0IGlkID0gYGdfJHt0aGlzLiNkb2NJZH1fYWxwaGFfbWFwXyR7dGhpcy4jaWQrK31gOwogICAgY29uc3QgdXJsID0gdGhpcy4jY3JlYXRlVXJsKGlkKTsKICAgIHRoaXMuI2NhY2hlLnNldChtYXAsIHVybCk7CiAgICB0aGlzLiNjYWNoZS5zZXQoa2V5LCB1cmwpOwogICAgY29uc3QgZmlsdGVyID0gdGhpcy4jY3JlYXRlRmlsdGVyKGlkKTsKICAgIHRoaXMuI2FkZFRyYW5zZmVyTWFwQWxwaGFDb252ZXJzaW9uKHRhYmxlQSwgZmlsdGVyKTsKICAgIHJldHVybiB1cmw7CiAgfQogIGFkZEx1bWlub3NpdHlGaWx0ZXIobWFwKSB7CiAgICBsZXQgdmFsdWUgPSB0aGlzLiNjYWNoZS5nZXQobWFwIHx8ICJsdW1pbm9zaXR5Iik7CiAgICBpZiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgbGV0IHRhYmxlQSwga2V5OwogICAgaWYgKG1hcCkgewogICAgICBbdGFibGVBXSA9IHRoaXMuI2NyZWF0ZVRhYmxlcyhbbWFwXSk7CiAgICAgIGtleSA9IGBsdW1pbm9zaXR5XyR7dGFibGVBfWA7CiAgICB9IGVsc2UgewogICAgICBrZXkgPSAibHVtaW5vc2l0eSI7CiAgICB9CiAgICB2YWx1ZSA9IHRoaXMuI2NhY2hlLmdldChrZXkpOwogICAgaWYgKHZhbHVlKSB7CiAgICAgIHRoaXMuI2NhY2hlLnNldChtYXAsIHZhbHVlKTsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgY29uc3QgaWQgPSBgZ18ke3RoaXMuI2RvY0lkfV9sdW1pbm9zaXR5X21hcF8ke3RoaXMuI2lkKyt9YDsKICAgIGNvbnN0IHVybCA9IHRoaXMuI2NyZWF0ZVVybChpZCk7CiAgICB0aGlzLiNjYWNoZS5zZXQobWFwLCB1cmwpOwogICAgdGhpcy4jY2FjaGUuc2V0KGtleSwgdXJsKTsKICAgIGNvbnN0IGZpbHRlciA9IHRoaXMuI2NyZWF0ZUZpbHRlcihpZCk7CiAgICB0aGlzLiNhZGRMdW1pbm9zaXR5Q29udmVyc2lvbihmaWx0ZXIpOwogICAgaWYgKG1hcCkgewogICAgICB0aGlzLiNhZGRUcmFuc2Zlck1hcEFscGhhQ29udmVyc2lvbih0YWJsZUEsIGZpbHRlcik7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0KICBhZGRIaWdobGlnaHRIQ01GaWx0ZXIoZmlsdGVyTmFtZSwgZmdDb2xvciwgYmdDb2xvciwgbmV3RmdDb2xvciwgbmV3QmdDb2xvcikgewogICAgY29uc3Qga2V5ID0gYCR7ZmdDb2xvcn0tJHtiZ0NvbG9yfS0ke25ld0ZnQ29sb3J9LSR7bmV3QmdDb2xvcn1gOwogICAgbGV0IGluZm8yID0gdGhpcy4jaGNtQ2FjaGUuZ2V0KGZpbHRlck5hbWUpOwogICAgaWYgKGluZm8yPy5rZXkgPT09IGtleSkgewogICAgICByZXR1cm4gaW5mbzIudXJsOwogICAgfQogICAgaWYgKGluZm8yKSB7CiAgICAgIGluZm8yLmZpbHRlcj8ucmVtb3ZlKCk7CiAgICAgIGluZm8yLmtleSA9IGtleTsKICAgICAgaW5mbzIudXJsID0gIm5vbmUiOwogICAgICBpbmZvMi5maWx0ZXIgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgaW5mbzIgPSB7CiAgICAgICAga2V5LAogICAgICAgIHVybDogIm5vbmUiLAogICAgICAgIGZpbHRlcjogbnVsbAogICAgICB9OwogICAgICB0aGlzLiNoY21DYWNoZS5zZXQoZmlsdGVyTmFtZSwgaW5mbzIpOwogICAgfQogICAgaWYgKCFmZ0NvbG9yIHx8ICFiZ0NvbG9yKSB7CiAgICAgIHJldHVybiBpbmZvMi51cmw7CiAgICB9CiAgICBjb25zdCBbZmdSR0IsIGJnUkdCXSA9IFtmZ0NvbG9yLCBiZ0NvbG9yXS5tYXAodGhpcy4jZ2V0UkdCLmJpbmQodGhpcykpOwogICAgbGV0IGZnR3JheSA9IE1hdGgucm91bmQoMC4yMTI2ICogZmdSR0JbMF0gKyAwLjcxNTIgKiBmZ1JHQlsxXSArIDAuMDcyMiAqIGZnUkdCWzJdKTsKICAgIGxldCBiZ0dyYXkgPSBNYXRoLnJvdW5kKDAuMjEyNiAqIGJnUkdCWzBdICsgMC43MTUyICogYmdSR0JbMV0gKyAwLjA3MjIgKiBiZ1JHQlsyXSk7CiAgICBsZXQgW25ld0ZnUkdCLCBuZXdCZ1JHQl0gPSBbbmV3RmdDb2xvciwgbmV3QmdDb2xvcl0ubWFwKHRoaXMuI2dldFJHQi5iaW5kKHRoaXMpKTsKICAgIGlmIChiZ0dyYXkgPCBmZ0dyYXkpIHsKICAgICAgW2ZnR3JheSwgYmdHcmF5LCBuZXdGZ1JHQiwgbmV3QmdSR0JdID0gW2JnR3JheSwgZmdHcmF5LCBuZXdCZ1JHQiwgbmV3RmdSR0JdOwogICAgfQogICAgdGhpcy4jZGVmcy5zdHlsZS5jb2xvciA9ICIiOwogICAgY29uc3QgZ2V0U3RlcHMgPSAoZmcsIGJnLCBuKSA9PiB7CiAgICAgIGNvbnN0IGFyciA9IG5ldyBBcnJheSgyNTYpOwogICAgICBjb25zdCBzdGVwID0gKGJnR3JheSAtIGZnR3JheSkgLyBuOwogICAgICBjb25zdCBuZXdTdGFydCA9IGZnIC8gMjU1OwogICAgICBjb25zdCBuZXdTdGVwID0gKGJnIC0gZmcpIC8gKDI1NSAqIG4pOwogICAgICBsZXQgcHJldiA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IG47IGkrKykgewogICAgICAgIGNvbnN0IGsgPSBNYXRoLnJvdW5kKGZnR3JheSArIGkgKiBzdGVwKTsKICAgICAgICBjb25zdCB2YWx1ZSA9IG5ld1N0YXJ0ICsgaSAqIG5ld1N0ZXA7CiAgICAgICAgZm9yIChsZXQgaiA9IHByZXY7IGogPD0gazsgaisrKSB7CiAgICAgICAgICBhcnJbal0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgcHJldiA9IGsgKyAxOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSBwcmV2OyBpIDwgMjU2OyBpKyspIHsKICAgICAgICBhcnJbaV0gPSBhcnJbcHJldiAtIDFdOwogICAgICB9CiAgICAgIHJldHVybiBhcnIuam9pbigiLCIpOwogICAgfTsKICAgIGNvbnN0IGlkID0gYGdfJHt0aGlzLiNkb2NJZH1faGNtXyR7ZmlsdGVyTmFtZX1fZmlsdGVyYDsKICAgIGNvbnN0IGZpbHRlciA9IGluZm8yLmZpbHRlciA9IHRoaXMuI2NyZWF0ZUZpbHRlcihpZCk7CiAgICB0aGlzLiNhZGRHcmF5Q29udmVyc2lvbihmaWx0ZXIpOwogICAgdGhpcy4jYWRkVHJhbnNmZXJNYXBDb252ZXJzaW9uKGdldFN0ZXBzKG5ld0ZnUkdCWzBdLCBuZXdCZ1JHQlswXSwgNSksIGdldFN0ZXBzKG5ld0ZnUkdCWzFdLCBuZXdCZ1JHQlsxXSwgNSksIGdldFN0ZXBzKG5ld0ZnUkdCWzJdLCBuZXdCZ1JHQlsyXSwgNSksIGZpbHRlcik7CiAgICBpbmZvMi51cmwgPSB0aGlzLiNjcmVhdGVVcmwoaWQpOwogICAgcmV0dXJuIGluZm8yLnVybDsKICB9CiAgZGVzdHJveShrZWVwSENNID0gZmFsc2UpIHsKICAgIGlmIChrZWVwSENNICYmIHRoaXMuI19oY21DYWNoZT8uc2l6ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNfZGVmcz8ucGFyZW50Tm9kZS5wYXJlbnROb2RlLnJlbW92ZSgpOwogICAgdGhpcy4jX2RlZnMgPSBudWxsOwogICAgdGhpcy4jX2NhY2hlPy5jbGVhcigpOwogICAgdGhpcy4jX2NhY2hlID0gbnVsbDsKICAgIHRoaXMuI19oY21DYWNoZT8uY2xlYXIoKTsKICAgIHRoaXMuI19oY21DYWNoZSA9IG51bGw7CiAgICB0aGlzLiNpZCA9IDA7CiAgfQogICNhZGRMdW1pbm9zaXR5Q29udmVyc2lvbihmaWx0ZXIpIHsKICAgIGNvbnN0IGZlQ29sb3JNYXRyaXggPSB0aGlzLiNkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoU1ZHX05TLCAiZmVDb2xvck1hdHJpeCIpOwogICAgZmVDb2xvck1hdHJpeC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAibWF0cml4Iik7CiAgICBmZUNvbG9yTWF0cml4LnNldEF0dHJpYnV0ZSgidmFsdWVzIiwgIjAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAuMyAwLjU5IDAuMTEgMCAwIik7CiAgICBmaWx0ZXIuYXBwZW5kKGZlQ29sb3JNYXRyaXgpOwogIH0KICAjYWRkR3JheUNvbnZlcnNpb24oZmlsdGVyKSB7CiAgICBjb25zdCBmZUNvbG9yTWF0cml4ID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgImZlQ29sb3JNYXRyaXgiKTsKICAgIGZlQ29sb3JNYXRyaXguc2V0QXR0cmlidXRlKCJ0eXBlIiwgIm1hdHJpeCIpOwogICAgZmVDb2xvck1hdHJpeC5zZXRBdHRyaWJ1dGUoInZhbHVlcyIsICIwLjIxMjYgMC43MTUyIDAuMDcyMiAwIDAgMC4yMTI2IDAuNzE1MiAwLjA3MjIgMCAwIDAuMjEyNiAwLjcxNTIgMC4wNzIyIDAgMCAwIDAgMCAxIDAiKTsKICAgIGZpbHRlci5hcHBlbmQoZmVDb2xvck1hdHJpeCk7CiAgfQogICNjcmVhdGVGaWx0ZXIoaWQpIHsKICAgIGNvbnN0IGZpbHRlciA9IHRoaXMuI2RvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhTVkdfTlMsICJmaWx0ZXIiKTsKICAgIGZpbHRlci5zZXRBdHRyaWJ1dGUoImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyIsICJzUkdCIik7CiAgICBmaWx0ZXIuc2V0QXR0cmlidXRlKCJpZCIsIGlkKTsKICAgIHRoaXMuI2RlZnMuYXBwZW5kKGZpbHRlcik7CiAgICByZXR1cm4gZmlsdGVyOwogIH0KICAjYXBwZW5kRmVGdW5jKGZlQ29tcG9uZW50VHJhbnNmZXIsIGZ1bmMsIHRhYmxlKSB7CiAgICBjb25zdCBmZUZ1bmMgPSB0aGlzLiNkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoU1ZHX05TLCBmdW5jKTsKICAgIGZlRnVuYy5zZXRBdHRyaWJ1dGUoInR5cGUiLCAiZGlzY3JldGUiKTsKICAgIGZlRnVuYy5zZXRBdHRyaWJ1dGUoInRhYmxlVmFsdWVzIiwgdGFibGUpOwogICAgZmVDb21wb25lbnRUcmFuc2Zlci5hcHBlbmQoZmVGdW5jKTsKICB9CiAgI2FkZFRyYW5zZmVyTWFwQ29udmVyc2lvbihyVGFibGUsIGdUYWJsZSwgYlRhYmxlLCBmaWx0ZXIpIHsKICAgIGNvbnN0IGZlQ29tcG9uZW50VHJhbnNmZXIgPSB0aGlzLiNkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoU1ZHX05TLCAiZmVDb21wb25lbnRUcmFuc2ZlciIpOwogICAgZmlsdGVyLmFwcGVuZChmZUNvbXBvbmVudFRyYW5zZmVyKTsKICAgIHRoaXMuI2FwcGVuZEZlRnVuYyhmZUNvbXBvbmVudFRyYW5zZmVyLCAiZmVGdW5jUiIsIHJUYWJsZSk7CiAgICB0aGlzLiNhcHBlbmRGZUZ1bmMoZmVDb21wb25lbnRUcmFuc2ZlciwgImZlRnVuY0ciLCBnVGFibGUpOwogICAgdGhpcy4jYXBwZW5kRmVGdW5jKGZlQ29tcG9uZW50VHJhbnNmZXIsICJmZUZ1bmNCIiwgYlRhYmxlKTsKICB9CiAgI2FkZFRyYW5zZmVyTWFwQWxwaGFDb252ZXJzaW9uKGFUYWJsZSwgZmlsdGVyKSB7CiAgICBjb25zdCBmZUNvbXBvbmVudFRyYW5zZmVyID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgImZlQ29tcG9uZW50VHJhbnNmZXIiKTsKICAgIGZpbHRlci5hcHBlbmQoZmVDb21wb25lbnRUcmFuc2Zlcik7CiAgICB0aGlzLiNhcHBlbmRGZUZ1bmMoZmVDb21wb25lbnRUcmFuc2ZlciwgImZlRnVuY0EiLCBhVGFibGUpOwogIH0KICAjZ2V0UkdCKGNvbG9yKSB7CiAgICB0aGlzLiNkZWZzLnN0eWxlLmNvbG9yID0gY29sb3I7CiAgICByZXR1cm4gZ2V0UkdCKGdldENvbXB1dGVkU3R5bGUodGhpcy4jZGVmcykuZ2V0UHJvcGVydHlWYWx1ZSgiY29sb3IiKSk7CiAgfQp9Owp2YXIgQmFzZVN0YW5kYXJkRm9udERhdGFGYWN0b3J5ID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHsKICAgIGJhc2VVcmwgPSBudWxsCiAgfSkgewogICAgdGhpcy5iYXNlVXJsID0gYmFzZVVybDsKICB9CiAgYXN5bmMgZmV0Y2goewogICAgZmlsZW5hbWUKICB9KSB7CiAgICBpZiAoIXRoaXMuYmFzZVVybCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkVuc3VyZSB0aGF0IHRoZSBgc3RhbmRhcmRGb250RGF0YVVybGAgQVBJIHBhcmFtZXRlciBpcyBwcm92aWRlZC4iKTsKICAgIH0KICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJGb250IGZpbGVuYW1lIG11c3QgYmUgc3BlY2lmaWVkLiIpOwogICAgfQogICAgY29uc3QgdXJsID0gYCR7dGhpcy5iYXNlVXJsfSR7ZmlsZW5hbWV9YDsKICAgIHJldHVybiB0aGlzLl9mZXRjaCh1cmwpLmNhdGNoKChyZWFzb24pID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gbG9hZCBmb250IGRhdGEgYXQ6ICR7dXJsfWApOwogICAgfSk7CiAgfQogIGFzeW5jIF9mZXRjaCh1cmwpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgYF9mZXRjaGAgY2FsbGVkLiIpOwogIH0KfTsKdmFyIERPTVN0YW5kYXJkRm9udERhdGFGYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlU3RhbmRhcmRGb250RGF0YUZhY3RvcnkgewogIGFzeW5jIF9mZXRjaCh1cmwpIHsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmZXRjaERhdGEodXJsLCAiYXJyYXlidWZmZXIiKTsKICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhKTsKICB9Cn07CnZhciBCYXNlV2FzbUZhY3RvcnkgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoewogICAgYmFzZVVybCA9IG51bGwKICB9KSB7CiAgICB0aGlzLmJhc2VVcmwgPSBiYXNlVXJsOwogIH0KICBhc3luYyBmZXRjaCh7CiAgICBmaWxlbmFtZQogIH0pIHsKICAgIGlmICghdGhpcy5iYXNlVXJsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRW5zdXJlIHRoYXQgdGhlIGB3YXNtVXJsYCBBUEkgcGFyYW1ldGVyIGlzIHByb3ZpZGVkLiIpOwogICAgfQogICAgaWYgKCFmaWxlbmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldhc20gZmlsZW5hbWUgbXVzdCBiZSBzcGVjaWZpZWQuIik7CiAgICB9CiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJhc2VVcmx9JHtmaWxlbmFtZX1gOwogICAgcmV0dXJuIHRoaXMuX2ZldGNoKHVybCkuY2F0Y2goKHJlYXNvbikgPT4gewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBsb2FkIHdhc20gZGF0YSBhdDogJHt1cmx9YCk7CiAgICB9KTsKICB9CiAgYXN5bmMgX2ZldGNoKHVybCkgewogICAgdW5yZWFjaGFibGUoIkFic3RyYWN0IG1ldGhvZCBgX2ZldGNoYCBjYWxsZWQuIik7CiAgfQp9Owp2YXIgRE9NV2FzbUZhY3RvcnkgPSBjbGFzcyBleHRlbmRzIEJhc2VXYXNtRmFjdG9yeSB7CiAgYXN5bmMgX2ZldGNoKHVybCkgewogICAgY29uc3QgZGF0YSA9IGF3YWl0IGZldGNoRGF0YSh1cmwsICJhcnJheWJ1ZmZlciIpOwogICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEpOwogIH0KfTsKaWYgKGlzTm9kZUpTKSB7CiAgd2FybigiUGxlYXNlIHVzZSB0aGUgYGxlZ2FjeWAgYnVpbGQgaW4gTm9kZS5qcyBlbnZpcm9ubWVudHMuIik7Cn0KYXN5bmMgZnVuY3Rpb24gbm9kZV91dGlsc19mZXRjaERhdGEodXJsKSB7CiAgY29uc3QgZnMgPSBwcm9jZXNzLmdldEJ1aWx0aW5Nb2R1bGUoImZzIik7CiAgY29uc3QgZGF0YSA9IGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHVybCk7CiAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEpOwp9CnZhciBOb2RlRmlsdGVyRmFjdG9yeSA9IGNsYXNzIGV4dGVuZHMgQmFzZUZpbHRlckZhY3Rvcnkgewp9Owp2YXIgTm9kZUNhbnZhc0ZhY3RvcnkgPSBjbGFzcyBleHRlbmRzIEJhc2VDYW52YXNGYWN0b3J5IHsKICBfY3JlYXRlQ2FudmFzKHdpZHRoLCBoZWlnaHQpIHsKICAgIGNvbnN0IHJlcXVpcmUyID0gcHJvY2Vzcy5nZXRCdWlsdGluTW9kdWxlKCJtb2R1bGUiKS5jcmVhdGVSZXF1aXJlKGltcG9ydC5tZXRhLnVybCk7CiAgICBjb25zdCBjYW52YXMgPSByZXF1aXJlMigiQG5hcGktcnMvY2FudmFzIik7CiAgICByZXR1cm4gY2FudmFzLmNyZWF0ZUNhbnZhcyh3aWR0aCwgaGVpZ2h0KTsKICB9Cn07CnZhciBOb2RlQ01hcFJlYWRlckZhY3RvcnkgPSBjbGFzcyBleHRlbmRzIEJhc2VDTWFwUmVhZGVyRmFjdG9yeSB7CiAgYXN5bmMgX2ZldGNoKHVybCkgewogICAgcmV0dXJuIG5vZGVfdXRpbHNfZmV0Y2hEYXRhKHVybCk7CiAgfQp9Owp2YXIgTm9kZVN0YW5kYXJkRm9udERhdGFGYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlU3RhbmRhcmRGb250RGF0YUZhY3RvcnkgewogIGFzeW5jIF9mZXRjaCh1cmwpIHsKICAgIHJldHVybiBub2RlX3V0aWxzX2ZldGNoRGF0YSh1cmwpOwogIH0KfTsKdmFyIE5vZGVXYXNtRmFjdG9yeSA9IGNsYXNzIGV4dGVuZHMgQmFzZVdhc21GYWN0b3J5IHsKICBhc3luYyBfZmV0Y2godXJsKSB7CiAgICByZXR1cm4gbm9kZV91dGlsc19mZXRjaERhdGEodXJsKTsKICB9Cn07CnZhciBGT1JDRURfREVQRU5ERU5DWV9MQUJFTCA9ICJfX2ZvcmNlZERlcGVuZGVuY3kiOwp2YXIgewogIGZsb29yLAogIGNlaWwKfSA9IE1hdGg7CmZ1bmN0aW9uIGV4cGFuZEJCb3goYXJyYXksIGluZGV4LCBtaW5YLCBtaW5ZLCBtYXhYLCBtYXhZKSB7CiAgYXJyYXlbaW5kZXggKiA0ICsgMF0gPSBNYXRoLm1pbihhcnJheVtpbmRleCAqIDQgKyAwXSwgbWluWCk7CiAgYXJyYXlbaW5kZXggKiA0ICsgMV0gPSBNYXRoLm1pbihhcnJheVtpbmRleCAqIDQgKyAxXSwgbWluWSk7CiAgYXJyYXlbaW5kZXggKiA0ICsgMl0gPSBNYXRoLm1heChhcnJheVtpbmRleCAqIDQgKyAyXSwgbWF4WCk7CiAgYXJyYXlbaW5kZXggKiA0ICsgM10gPSBNYXRoLm1heChhcnJheVtpbmRleCAqIDQgKyAzXSwgbWF4WSk7Cn0KdmFyIEVNUFRZX0JCT1ggPSBuZXcgVWludDMyQXJyYXkobmV3IFVpbnQ4QXJyYXkoWzI1NSwgMjU1LCAwLCAwXSkuYnVmZmVyKVswXTsKdmFyIEJCb3hSZWFkZXIgPSBjbGFzcyB7CiAgI2Jib3hlczsKICAjY29vcmRzOwogIGNvbnN0cnVjdG9yKGJib3hlcywgY29vcmRzKSB7CiAgICB0aGlzLiNiYm94ZXMgPSBiYm94ZXM7CiAgICB0aGlzLiNjb29yZHMgPSBjb29yZHM7CiAgfQogIGdldCBsZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy4jYmJveGVzLmxlbmd0aDsKICB9CiAgaXNFbXB0eShpKSB7CiAgICByZXR1cm4gdGhpcy4jYmJveGVzW2ldID09PSBFTVBUWV9CQk9YOwogIH0KICBtaW5YKGkpIHsKICAgIHJldHVybiB0aGlzLiNjb29yZHNbaSAqIDQgKyAwXSAvIDI1NjsKICB9CiAgbWluWShpKSB7CiAgICByZXR1cm4gdGhpcy4jY29vcmRzW2kgKiA0ICsgMV0gLyAyNTY7CiAgfQogIG1heFgoaSkgewogICAgcmV0dXJuICh0aGlzLiNjb29yZHNbaSAqIDQgKyAyXSArIDEpIC8gMjU2OwogIH0KICBtYXhZKGkpIHsKICAgIHJldHVybiAodGhpcy4jY29vcmRzW2kgKiA0ICsgM10gKyAxKSAvIDI1NjsKICB9Cn07CnZhciBlbnN1cmVEZWJ1Z01ldGFkYXRhID0gKG1hcCwga2V5KSA9PiB7CiAgaWYgKCFtYXApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGxldCB2YWx1ZSA9IG1hcC5nZXQoa2V5KTsKICBpZiAoIXZhbHVlKSB7CiAgICB2YWx1ZSA9IHsKICAgICAgZGVwZW5kZW5jaWVzOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLAogICAgICBpc1JlbmRlcmluZ09wZXJhdGlvbjogZmFsc2UKICAgIH07CiAgICBtYXAuc2V0KGtleSwgdmFsdWUpOwogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciBDYW52YXNEZXBlbmRlbmN5VHJhY2tlciA9IGNsYXNzIHsKICAjc2ltcGxlID0gewogICAgX19wcm90b19fOiBudWxsCiAgfTsKICAjaW5jcmVtZW50YWwgPSB7CiAgICBfX3Byb3RvX186IG51bGwsCiAgICB0cmFuc2Zvcm06IFtdLAogICAgbW92ZVRleHQ6IFtdLAogICAgc2FtZUxpbmVUZXh0OiBbXSwKICAgIFtGT1JDRURfREVQRU5ERU5DWV9MQUJFTF06IFtdCiAgfTsKICAjbmFtZWREZXBlbmRlbmNpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNzYXZlc1N0YWNrID0gW107CiAgI21hcmtlZENvbnRlbnRTdGFjayA9IFtdOwogICNiYXNlVHJhbnNmb3JtU3RhY2sgPSBbWzEsIDAsIDAsIDEsIDAsIDBdXTsKICAjY2xpcEJveCA9IFstSW5maW5pdHksIC1JbmZpbml0eSwgSW5maW5pdHksIEluZmluaXR5XTsKICAjcGVuZGluZ0JCb3ggPSBuZXcgRmxvYXQ2NEFycmF5KFtJbmZpbml0eSwgSW5maW5pdHksIC1JbmZpbml0eSwgLUluZmluaXR5XSk7CiAgI3BlbmRpbmdCQm94SWR4ID0gLTE7CiAgI3BlbmRpbmdEZXBlbmRlbmNpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICNvcGVyYXRpb25zID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjZm9udEJCb3hUcnVzdHdvcnRoeSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI2NhbnZhc1dpZHRoOwogICNjYW52YXNIZWlnaHQ7CiAgI2Jib3hlc0Nvb3JkczsKICAjYmJveGVzOwogICNkZWJ1Z01ldGFkYXRhOwogIGNvbnN0cnVjdG9yKGNhbnZhcywgb3BlcmF0aW9uc0NvdW50LCByZWNvcmREZWJ1Z01ldGFkYXRhID0gZmFsc2UpIHsKICAgIHRoaXMuI2NhbnZhc1dpZHRoID0gY2FudmFzLndpZHRoOwogICAgdGhpcy4jY2FudmFzSGVpZ2h0ID0gY2FudmFzLmhlaWdodDsKICAgIHRoaXMuI2luaXRpYWxpemVCQm94ZXMob3BlcmF0aW9uc0NvdW50KTsKICAgIGlmIChyZWNvcmREZWJ1Z01ldGFkYXRhKSB7CiAgICAgIHRoaXMuI2RlYnVnTWV0YWRhdGEgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgfQogIH0KICBncm93T3BlcmF0aW9uc0NvdW50KG9wZXJhdGlvbnNDb3VudCkgewogICAgaWYgKG9wZXJhdGlvbnNDb3VudCA+PSB0aGlzLiNiYm94ZXMubGVuZ3RoKSB7CiAgICAgIHRoaXMuI2luaXRpYWxpemVCQm94ZXMob3BlcmF0aW9uc0NvdW50LCB0aGlzLiNiYm94ZXMpOwogICAgfQogIH0KICAjaW5pdGlhbGl6ZUJCb3hlcyhvcGVyYXRpb25zQ291bnQsIG9sZEJCb3hlcykgewogICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKG9wZXJhdGlvbnNDb3VudCAqIDQpOwogICAgdGhpcy4jYmJveGVzQ29vcmRzID0gbmV3IFVpbnQ4Q2xhbXBlZEFycmF5KGJ1ZmZlcik7CiAgICB0aGlzLiNiYm94ZXMgPSBuZXcgVWludDMyQXJyYXkoYnVmZmVyKTsKICAgIGlmIChvbGRCQm94ZXMgJiYgb2xkQkJveGVzLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy4jYmJveGVzLnNldChvbGRCQm94ZXMpOwogICAgICB0aGlzLiNiYm94ZXMuZmlsbChFTVBUWV9CQk9YLCBvbGRCQm94ZXMubGVuZ3RoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuI2Jib3hlcy5maWxsKEVNUFRZX0JCT1gpOwogICAgfQogIH0KICBzYXZlKG9wSWR4KSB7CiAgICB0aGlzLiNzaW1wbGUgPSB7CiAgICAgIF9fcHJvdG9fXzogdGhpcy4jc2ltcGxlCiAgICB9OwogICAgdGhpcy4jaW5jcmVtZW50YWwgPSB7CiAgICAgIF9fcHJvdG9fXzogdGhpcy4jaW5jcmVtZW50YWwsCiAgICAgIHRyYW5zZm9ybTogewogICAgICAgIF9fcHJvdG9fXzogdGhpcy4jaW5jcmVtZW50YWwudHJhbnNmb3JtCiAgICAgIH0sCiAgICAgIG1vdmVUZXh0OiB7CiAgICAgICAgX19wcm90b19fOiB0aGlzLiNpbmNyZW1lbnRhbC5tb3ZlVGV4dAogICAgICB9LAogICAgICBzYW1lTGluZVRleHQ6IHsKICAgICAgICBfX3Byb3RvX186IHRoaXMuI2luY3JlbWVudGFsLnNhbWVMaW5lVGV4dAogICAgICB9LAogICAgICBbRk9SQ0VEX0RFUEVOREVOQ1lfTEFCRUxdOiB7CiAgICAgICAgX19wcm90b19fOiB0aGlzLiNpbmNyZW1lbnRhbFtGT1JDRURfREVQRU5ERU5DWV9MQUJFTF0KICAgICAgfQogICAgfTsKICAgIHRoaXMuI2NsaXBCb3ggPSB7CiAgICAgIF9fcHJvdG9fXzogdGhpcy4jY2xpcEJveAogICAgfTsKICAgIHRoaXMuI3NhdmVzU3RhY2sucHVzaChvcElkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVzdG9yZShvcElkeCkgewogICAgY29uc3QgcHJldmlvdXMgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcy4jc2ltcGxlKTsKICAgIGlmIChwcmV2aW91cyA9PT0gbnVsbCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHRoaXMuI3NpbXBsZSA9IHByZXZpb3VzOwogICAgdGhpcy4jaW5jcmVtZW50YWwgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcy4jaW5jcmVtZW50YWwpOwogICAgdGhpcy4jY2xpcEJveCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzLiNjbGlwQm94KTsKICAgIGNvbnN0IGxhc3RTYXZlID0gdGhpcy4jc2F2ZXNTdGFjay5wb3AoKTsKICAgIGlmIChsYXN0U2F2ZSAhPT0gdm9pZCAwKSB7CiAgICAgIGVuc3VyZURlYnVnTWV0YWRhdGEodGhpcy4jZGVidWdNZXRhZGF0YSwgb3BJZHgpPy5kZXBlbmRlbmNpZXMuYWRkKGxhc3RTYXZlKTsKICAgICAgdGhpcy4jYmJveGVzW29wSWR4XSA9IHRoaXMuI2Jib3hlc1tsYXN0U2F2ZV07CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkT3Blbk1hcmtlcihpZHgpIHsKICAgIHRoaXMuI3NhdmVzU3RhY2sucHVzaChpZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldE9wZW5NYXJrZXIoKSB7CiAgICBpZiAodGhpcy4jc2F2ZXNTdGFjay5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gdGhpcy4jc2F2ZXNTdGFjay5hdCgtMSk7CiAgfQogIHJlY29yZENsb3NlTWFya2VyKG9wSWR4KSB7CiAgICBjb25zdCBsYXN0U2F2ZSA9IHRoaXMuI3NhdmVzU3RhY2sucG9wKCk7CiAgICBpZiAobGFzdFNhdmUgIT09IHZvaWQgMCkgewogICAgICBlbnN1cmVEZWJ1Z01ldGFkYXRhKHRoaXMuI2RlYnVnTWV0YWRhdGEsIG9wSWR4KT8uZGVwZW5kZW5jaWVzLmFkZChsYXN0U2F2ZSk7CiAgICAgIHRoaXMuI2Jib3hlc1tvcElkeF0gPSB0aGlzLiNiYm94ZXNbbGFzdFNhdmVdOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGJlZ2luTWFya2VkQ29udGVudChvcElkeCkgewogICAgdGhpcy4jbWFya2VkQ29udGVudFN0YWNrLnB1c2gob3BJZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGVuZE1hcmtlZENvbnRlbnQob3BJZHgpIHsKICAgIGNvbnN0IGxhc3RTYXZlID0gdGhpcy4jbWFya2VkQ29udGVudFN0YWNrLnBvcCgpOwogICAgaWYgKGxhc3RTYXZlICE9PSB2b2lkIDApIHsKICAgICAgZW5zdXJlRGVidWdNZXRhZGF0YSh0aGlzLiNkZWJ1Z01ldGFkYXRhLCBvcElkeCk/LmRlcGVuZGVuY2llcy5hZGQobGFzdFNhdmUpOwogICAgICB0aGlzLiNiYm94ZXNbb3BJZHhdID0gdGhpcy4jYmJveGVzW2xhc3RTYXZlXTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBwdXNoQmFzZVRyYW5zZm9ybShjdHgpIHsKICAgIHRoaXMuI2Jhc2VUcmFuc2Zvcm1TdGFjay5wdXNoKFV0aWwubXVsdGlwbHlCeURPTU1hdHJpeCh0aGlzLiNiYXNlVHJhbnNmb3JtU3RhY2suYXQoLTEpLCBjdHguZ2V0VHJhbnNmb3JtKCkpKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBwb3BCYXNlVHJhbnNmb3JtKCkgewogICAgaWYgKHRoaXMuI2Jhc2VUcmFuc2Zvcm1TdGFjay5sZW5ndGggPiAxKSB7CiAgICAgIHRoaXMuI2Jhc2VUcmFuc2Zvcm1TdGFjay5wb3AoKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRTaW1wbGVEYXRhKG5hbWUsIGlkeCkgewogICAgdGhpcy4jc2ltcGxlW25hbWVdID0gaWR4OwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZEluY3JlbWVudGFsRGF0YShuYW1lLCBpZHgpIHsKICAgIHRoaXMuI2luY3JlbWVudGFsW25hbWVdLnB1c2goaWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZXNldEluY3JlbWVudGFsRGF0YShuYW1lLCBpZHgpIHsKICAgIHRoaXMuI2luY3JlbWVudGFsW25hbWVdLmxlbmd0aCA9IDA7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkTmFtZWREYXRhKG5hbWUsIGlkeCkgewogICAgdGhpcy4jbmFtZWREZXBlbmRlbmNpZXMuc2V0KG5hbWUsIGlkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkU2ltcGxlRGF0YUZyb21OYW1lZChuYW1lLCBkZXBOYW1lLCBmYWxsYmFja0lkeCkgewogICAgdGhpcy4jc2ltcGxlW25hbWVdID0gdGhpcy4jbmFtZWREZXBlbmRlbmNpZXMuZ2V0KGRlcE5hbWUpID8/IGZhbGxiYWNrSWR4OwogIH0KICByZWNvcmRGdXR1cmVGb3JjZWREZXBlbmRlbmN5KG5hbWUsIGlkeCkgewogICAgdGhpcy5yZWNvcmRJbmNyZW1lbnRhbERhdGEoRk9SQ0VEX0RFUEVOREVOQ1lfTEFCRUwsIGlkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgaW5oZXJpdFNpbXBsZURhdGFBc0Z1dHVyZUZvcmNlZERlcGVuZGVuY2llcyhuYW1lcykgewogICAgZm9yIChjb25zdCBuYW1lIG9mIG5hbWVzKSB7CiAgICAgIGlmIChuYW1lIGluIHRoaXMuI3NpbXBsZSkgewogICAgICAgIHRoaXMucmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeShuYW1lLCB0aGlzLiNzaW1wbGVbbmFtZV0pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgaW5oZXJpdFBlbmRpbmdEZXBlbmRlbmNpZXNBc0Z1dHVyZUZvcmNlZERlcGVuZGVuY2llcygpIHsKICAgIGZvciAoY29uc3QgZGVwIG9mIHRoaXMuI3BlbmRpbmdEZXBlbmRlbmNpZXMpIHsKICAgICAgdGhpcy5yZWNvcmRGdXR1cmVGb3JjZWREZXBlbmRlbmN5KEZPUkNFRF9ERVBFTkRFTkNZX0xBQkVMLCBkZXApOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlc2V0QkJveChpZHgpIHsKICAgIGlmICh0aGlzLiNwZW5kaW5nQkJveElkeCAhPT0gaWR4KSB7CiAgICAgIHRoaXMuI3BlbmRpbmdCQm94SWR4ID0gaWR4OwogICAgICB0aGlzLiNwZW5kaW5nQkJveFswXSA9IEluZmluaXR5OwogICAgICB0aGlzLiNwZW5kaW5nQkJveFsxXSA9IEluZmluaXR5OwogICAgICB0aGlzLiNwZW5kaW5nQkJveFsyXSA9IC1JbmZpbml0eTsKICAgICAgdGhpcy4jcGVuZGluZ0JCb3hbM10gPSAtSW5maW5pdHk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkQ2xpcEJveChpZHgsIGN0eCwgbWluWCwgbWF4WCwgbWluWSwgbWF4WSkgewogICAgY29uc3QgdHJhbnNmb3JtID0gVXRpbC5tdWx0aXBseUJ5RE9NTWF0cml4KHRoaXMuI2Jhc2VUcmFuc2Zvcm1TdGFjay5hdCgtMSksIGN0eC5nZXRUcmFuc2Zvcm0oKSk7CiAgICBjb25zdCBjbGlwQm94ID0gW0luZmluaXR5LCBJbmZpbml0eSwgLUluZmluaXR5LCAtSW5maW5pdHldOwogICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChbbWluWCwgbWluWSwgbWF4WCwgbWF4WV0sIHRyYW5zZm9ybSwgY2xpcEJveCk7CiAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSBVdGlsLmludGVyc2VjdCh0aGlzLiNjbGlwQm94LCBjbGlwQm94KTsKICAgIGlmIChpbnRlcnNlY3Rpb24pIHsKICAgICAgdGhpcy4jY2xpcEJveFswXSA9IGludGVyc2VjdGlvblswXTsKICAgICAgdGhpcy4jY2xpcEJveFsxXSA9IGludGVyc2VjdGlvblsxXTsKICAgICAgdGhpcy4jY2xpcEJveFsyXSA9IGludGVyc2VjdGlvblsyXTsKICAgICAgdGhpcy4jY2xpcEJveFszXSA9IGludGVyc2VjdGlvblszXTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuI2NsaXBCb3hbMF0gPSB0aGlzLiNjbGlwQm94WzFdID0gSW5maW5pdHk7CiAgICAgIHRoaXMuI2NsaXBCb3hbMl0gPSB0aGlzLiNjbGlwQm94WzNdID0gLUluZmluaXR5OwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZEJCb3goaWR4LCBjdHgsIG1pblgsIG1heFgsIG1pblksIG1heFkpIHsKICAgIGNvbnN0IGNsaXBCb3ggPSB0aGlzLiNjbGlwQm94OwogICAgaWYgKGNsaXBCb3hbMF0gPT09IEluZmluaXR5KSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY29uc3QgdHJhbnNmb3JtID0gVXRpbC5tdWx0aXBseUJ5RE9NTWF0cml4KHRoaXMuI2Jhc2VUcmFuc2Zvcm1TdGFjay5hdCgtMSksIGN0eC5nZXRUcmFuc2Zvcm0oKSk7CiAgICBpZiAoY2xpcEJveFswXSA9PT0gLUluZmluaXR5KSB7CiAgICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goW21pblgsIG1pblksIG1heFgsIG1heFldLCB0cmFuc2Zvcm0sIHRoaXMuI3BlbmRpbmdCQm94KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjb25zdCBiYm94ID0gW0luZmluaXR5LCBJbmZpbml0eSwgLUluZmluaXR5LCAtSW5maW5pdHldOwogICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChbbWluWCwgbWluWSwgbWF4WCwgbWF4WV0sIHRyYW5zZm9ybSwgYmJveCk7CiAgICB0aGlzLiNwZW5kaW5nQkJveFswXSA9IE1hdGgubWluKHRoaXMuI3BlbmRpbmdCQm94WzBdLCBNYXRoLm1heChiYm94WzBdLCBjbGlwQm94WzBdKSk7CiAgICB0aGlzLiNwZW5kaW5nQkJveFsxXSA9IE1hdGgubWluKHRoaXMuI3BlbmRpbmdCQm94WzFdLCBNYXRoLm1heChiYm94WzFdLCBjbGlwQm94WzFdKSk7CiAgICB0aGlzLiNwZW5kaW5nQkJveFsyXSA9IE1hdGgubWF4KHRoaXMuI3BlbmRpbmdCQm94WzJdLCBNYXRoLm1pbihiYm94WzJdLCBjbGlwQm94WzJdKSk7CiAgICB0aGlzLiNwZW5kaW5nQkJveFszXSA9IE1hdGgubWF4KHRoaXMuI3BlbmRpbmdCQm94WzNdLCBNYXRoLm1pbihiYm94WzNdLCBjbGlwQm94WzNdKSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkQ2hhcmFjdGVyQkJveChpZHgsIGN0eCwgZm9udCwgc2NhbGUgPSAxLCB4ID0gMCwgeSA9IDAsIGdldE1lYXN1cmUpIHsKICAgIGNvbnN0IGZvbnRCQm94ID0gZm9udC5iYm94OwogICAgbGV0IGlzQkJveFRydXN0d29ydGh5OwogICAgbGV0IGNvbXB1dGVkQkJveDsKICAgIGlmIChmb250QkJveCkgewogICAgICBpc0JCb3hUcnVzdHdvcnRoeSA9IGZvbnRCQm94WzJdICE9PSBmb250QkJveFswXSAmJiBmb250QkJveFszXSAhPT0gZm9udEJCb3hbMV0gJiYgdGhpcy4jZm9udEJCb3hUcnVzdHdvcnRoeS5nZXQoZm9udCk7CiAgICAgIGlmIChpc0JCb3hUcnVzdHdvcnRoeSAhPT0gZmFsc2UpIHsKICAgICAgICBjb21wdXRlZEJCb3ggPSBbMCwgMCwgMCwgMF07CiAgICAgICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChmb250QkJveCwgZm9udC5mb250TWF0cml4LCBjb21wdXRlZEJCb3gpOwogICAgICAgIGlmIChzY2FsZSAhPT0gMSB8fCB4ICE9PSAwIHx8IHkgIT09IDApIHsKICAgICAgICAgIFV0aWwuc2NhbGVNaW5NYXgoW3NjYWxlLCAwLCAwLCAtc2NhbGUsIHgsIHldLCBjb21wdXRlZEJCb3gpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNCQm94VHJ1c3R3b3J0aHkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnJlY29yZEJCb3goaWR4LCBjdHgsIGNvbXB1dGVkQkJveFswXSwgY29tcHV0ZWRCQm94WzJdLCBjb21wdXRlZEJCb3hbMV0sIGNvbXB1dGVkQkJveFszXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoIWdldE1lYXN1cmUpIHsKICAgICAgcmV0dXJuIHRoaXMucmVjb3JkRnVsbFBhZ2VCQm94KGlkeCk7CiAgICB9CiAgICBjb25zdCBtZWFzdXJlID0gZ2V0TWVhc3VyZSgpOwogICAgaWYgKGZvbnRCQm94ICYmIGNvbXB1dGVkQkJveCAmJiBpc0JCb3hUcnVzdHdvcnRoeSA9PT0gdm9pZCAwKSB7CiAgICAgIGlzQkJveFRydXN0d29ydGh5ID0gY29tcHV0ZWRCQm94WzBdIDw9IHggLSBtZWFzdXJlLmFjdHVhbEJvdW5kaW5nQm94TGVmdCAmJiBjb21wdXRlZEJCb3hbMl0gPj0geCArIG1lYXN1cmUuYWN0dWFsQm91bmRpbmdCb3hSaWdodCAmJiBjb21wdXRlZEJCb3hbMV0gPD0geSAtIG1lYXN1cmUuYWN0dWFsQm91bmRpbmdCb3hBc2NlbnQgJiYgY29tcHV0ZWRCQm94WzNdID49IHkgKyBtZWFzdXJlLmFjdHVhbEJvdW5kaW5nQm94RGVzY2VudDsKICAgICAgdGhpcy4jZm9udEJCb3hUcnVzdHdvcnRoeS5zZXQoZm9udCwgaXNCQm94VHJ1c3R3b3J0aHkpOwogICAgICBpZiAoaXNCQm94VHJ1c3R3b3J0aHkpIHsKICAgICAgICByZXR1cm4gdGhpcy5yZWNvcmRCQm94KGlkeCwgY3R4LCBjb21wdXRlZEJCb3hbMF0sIGNvbXB1dGVkQkJveFsyXSwgY29tcHV0ZWRCQm94WzFdLCBjb21wdXRlZEJCb3hbM10pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpcy5yZWNvcmRCQm94KGlkeCwgY3R4LCB4IC0gbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveExlZnQsIHggKyBtZWFzdXJlLmFjdHVhbEJvdW5kaW5nQm94UmlnaHQsIHkgLSBtZWFzdXJlLmFjdHVhbEJvdW5kaW5nQm94QXNjZW50LCB5ICsgbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveERlc2NlbnQpOwogIH0KICByZWNvcmRGdWxsUGFnZUJCb3goaWR4KSB7CiAgICB0aGlzLiNwZW5kaW5nQkJveFswXSA9IE1hdGgubWF4KDAsIHRoaXMuI2NsaXBCb3hbMF0pOwogICAgdGhpcy4jcGVuZGluZ0JCb3hbMV0gPSBNYXRoLm1heCgwLCB0aGlzLiNjbGlwQm94WzFdKTsKICAgIHRoaXMuI3BlbmRpbmdCQm94WzJdID0gTWF0aC5taW4odGhpcy4jY2FudmFzV2lkdGgsIHRoaXMuI2NsaXBCb3hbMl0pOwogICAgdGhpcy4jcGVuZGluZ0JCb3hbM10gPSBNYXRoLm1pbih0aGlzLiNjYW52YXNIZWlnaHQsIHRoaXMuI2NsaXBCb3hbM10pOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldFNpbXBsZUluZGV4KGRlcGVuZGVuY3lOYW1lKSB7CiAgICByZXR1cm4gdGhpcy4jc2ltcGxlW2RlcGVuZGVuY3lOYW1lXTsKICB9CiAgcmVjb3JkRGVwZW5kZW5jaWVzKGlkeCwgZGVwZW5kZW5jeU5hbWVzKSB7CiAgICBjb25zdCBwZW5kaW5nRGVwZW5kZW5jaWVzID0gdGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llczsKICAgIGNvbnN0IHNpbXBsZSA9IHRoaXMuI3NpbXBsZTsKICAgIGNvbnN0IGluY3JlbWVudGFsID0gdGhpcy4jaW5jcmVtZW50YWw7CiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgZGVwZW5kZW5jeU5hbWVzKSB7CiAgICAgIGlmIChuYW1lIGluIHRoaXMuI3NpbXBsZSkgewogICAgICAgIHBlbmRpbmdEZXBlbmRlbmNpZXMuYWRkKHNpbXBsZVtuYW1lXSk7CiAgICAgIH0gZWxzZSBpZiAobmFtZSBpbiBpbmNyZW1lbnRhbCkgewogICAgICAgIGluY3JlbWVudGFsW25hbWVdLmZvckVhY2gocGVuZGluZ0RlcGVuZGVuY2llcy5hZGQsIHBlbmRpbmdEZXBlbmRlbmNpZXMpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkTmFtZWREZXBlbmRlbmN5KGlkeCwgbmFtZSkgewogICAgaWYgKHRoaXMuI25hbWVkRGVwZW5kZW5jaWVzLmhhcyhuYW1lKSkgewogICAgICB0aGlzLiNwZW5kaW5nRGVwZW5kZW5jaWVzLmFkZCh0aGlzLiNuYW1lZERlcGVuZGVuY2llcy5nZXQobmFtZSkpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZE9wZXJhdGlvbihpZHgsIHByZXNlcnZlID0gZmFsc2UpIHsKICAgIHRoaXMucmVjb3JkRGVwZW5kZW5jaWVzKGlkeCwgW0ZPUkNFRF9ERVBFTkRFTkNZX0xBQkVMXSk7CiAgICBpZiAodGhpcy4jZGVidWdNZXRhZGF0YSkgewogICAgICBjb25zdCBtZXRhZGF0YSA9IGVuc3VyZURlYnVnTWV0YWRhdGEodGhpcy4jZGVidWdNZXRhZGF0YSwgaWR4KTsKICAgICAgY29uc3QgewogICAgICAgIGRlcGVuZGVuY2llcwogICAgICB9ID0gbWV0YWRhdGE7CiAgICAgIHRoaXMuI3BlbmRpbmdEZXBlbmRlbmNpZXMuZm9yRWFjaChkZXBlbmRlbmNpZXMuYWRkLCBkZXBlbmRlbmNpZXMpOwogICAgICB0aGlzLiNzYXZlc1N0YWNrLmZvckVhY2goZGVwZW5kZW5jaWVzLmFkZCwgZGVwZW5kZW5jaWVzKTsKICAgICAgdGhpcy4jbWFya2VkQ29udGVudFN0YWNrLmZvckVhY2goZGVwZW5kZW5jaWVzLmFkZCwgZGVwZW5kZW5jaWVzKTsKICAgICAgZGVwZW5kZW5jaWVzLmRlbGV0ZShpZHgpOwogICAgICBtZXRhZGF0YS5pc1JlbmRlcmluZ09wZXJhdGlvbiA9IHRydWU7CiAgICB9CiAgICBpZiAodGhpcy4jcGVuZGluZ0JCb3hJZHggPT09IGlkeCkgewogICAgICBjb25zdCBtaW5YID0gZmxvb3IodGhpcy4jcGVuZGluZ0JCb3hbMF0gKiAyNTYgLyB0aGlzLiNjYW52YXNXaWR0aCk7CiAgICAgIGNvbnN0IG1pblkgPSBmbG9vcih0aGlzLiNwZW5kaW5nQkJveFsxXSAqIDI1NiAvIHRoaXMuI2NhbnZhc0hlaWdodCk7CiAgICAgIGNvbnN0IG1heFggPSBjZWlsKHRoaXMuI3BlbmRpbmdCQm94WzJdICogMjU2IC8gdGhpcy4jY2FudmFzV2lkdGgpOwogICAgICBjb25zdCBtYXhZID0gY2VpbCh0aGlzLiNwZW5kaW5nQkJveFszXSAqIDI1NiAvIHRoaXMuI2NhbnZhc0hlaWdodCk7CiAgICAgIGV4cGFuZEJCb3godGhpcy4jYmJveGVzQ29vcmRzLCBpZHgsIG1pblgsIG1pblksIG1heFgsIG1heFkpOwogICAgICBmb3IgKGNvbnN0IGRlcElkeCBvZiB0aGlzLiNwZW5kaW5nRGVwZW5kZW5jaWVzKSB7CiAgICAgICAgaWYgKGRlcElkeCAhPT0gaWR4KSB7CiAgICAgICAgICBleHBhbmRCQm94KHRoaXMuI2Jib3hlc0Nvb3JkcywgZGVwSWR4LCBtaW5YLCBtaW5ZLCBtYXhYLCBtYXhZKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBzYXZlSWR4IG9mIHRoaXMuI3NhdmVzU3RhY2spIHsKICAgICAgICBpZiAoc2F2ZUlkeCAhPT0gaWR4KSB7CiAgICAgICAgICBleHBhbmRCQm94KHRoaXMuI2Jib3hlc0Nvb3Jkcywgc2F2ZUlkeCwgbWluWCwgbWluWSwgbWF4WCwgbWF4WSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoY29uc3Qgc2F2ZUlkeCBvZiB0aGlzLiNtYXJrZWRDb250ZW50U3RhY2spIHsKICAgICAgICBpZiAoc2F2ZUlkeCAhPT0gaWR4KSB7CiAgICAgICAgICBleHBhbmRCQm94KHRoaXMuI2Jib3hlc0Nvb3Jkcywgc2F2ZUlkeCwgbWluWCwgbWluWSwgbWF4WCwgbWF4WSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghcHJlc2VydmUpIHsKICAgICAgICB0aGlzLiNwZW5kaW5nRGVwZW5kZW5jaWVzLmNsZWFyKCk7CiAgICAgICAgdGhpcy4jcGVuZGluZ0JCb3hJZHggPSAtMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZFNob3dUZXh0T3BlcmF0aW9uKGlkeCwgcHJlc2VydmUgPSBmYWxzZSkgewogICAgY29uc3QgZGVwcyA9IEFycmF5LmZyb20odGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llcyk7CiAgICB0aGlzLnJlY29yZE9wZXJhdGlvbihpZHgsIHByZXNlcnZlKTsKICAgIHRoaXMucmVjb3JkSW5jcmVtZW50YWxEYXRhKCJzYW1lTGluZVRleHQiLCBpZHgpOwogICAgZm9yIChjb25zdCBkZXAgb2YgZGVwcykgewogICAgICB0aGlzLnJlY29yZEluY3JlbWVudGFsRGF0YSgic2FtZUxpbmVUZXh0IiwgZGVwKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBiYm94VG9DbGlwQm94RHJvcE9wZXJhdGlvbihpZHgsIHByZXNlcnZlID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLiNwZW5kaW5nQkJveElkeCA9PT0gaWR4KSB7CiAgICAgIHRoaXMuI3BlbmRpbmdCQm94SWR4ID0gLTE7CiAgICAgIHRoaXMuI2NsaXBCb3hbMF0gPSBNYXRoLm1heCh0aGlzLiNjbGlwQm94WzBdLCB0aGlzLiNwZW5kaW5nQkJveFswXSk7CiAgICAgIHRoaXMuI2NsaXBCb3hbMV0gPSBNYXRoLm1heCh0aGlzLiNjbGlwQm94WzFdLCB0aGlzLiNwZW5kaW5nQkJveFsxXSk7CiAgICAgIHRoaXMuI2NsaXBCb3hbMl0gPSBNYXRoLm1pbih0aGlzLiNjbGlwQm94WzJdLCB0aGlzLiNwZW5kaW5nQkJveFsyXSk7CiAgICAgIHRoaXMuI2NsaXBCb3hbM10gPSBNYXRoLm1pbih0aGlzLiNjbGlwQm94WzNdLCB0aGlzLiNwZW5kaW5nQkJveFszXSk7CiAgICAgIGlmICghcHJlc2VydmUpIHsKICAgICAgICB0aGlzLiNwZW5kaW5nRGVwZW5kZW5jaWVzLmNsZWFyKCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBfdGFrZVBlbmRpbmdEZXBlbmRlbmNpZXMoKSB7CiAgICBjb25zdCBwZW5kaW5nRGVwZW5kZW5jaWVzID0gdGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llczsKICAgIHRoaXMuI3BlbmRpbmdEZXBlbmRlbmNpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgcmV0dXJuIHBlbmRpbmdEZXBlbmRlbmNpZXM7CiAgfQogIF9leHRyYWN0T3BlcmF0aW9uKGlkeCkgewogICAgY29uc3Qgb3BlcmF0aW9uID0gdGhpcy4jb3BlcmF0aW9ucy5nZXQoaWR4KTsKICAgIHRoaXMuI29wZXJhdGlvbnMuZGVsZXRlKGlkeCk7CiAgICByZXR1cm4gb3BlcmF0aW9uOwogIH0KICBfcHVzaFBlbmRpbmdEZXBlbmRlbmNpZXMoZGVwZW5kZW5jaWVzKSB7CiAgICBmb3IgKGNvbnN0IGRlcCBvZiBkZXBlbmRlbmNpZXMpIHsKICAgICAgdGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llcy5hZGQoZGVwKTsKICAgIH0KICB9CiAgdGFrZSgpIHsKICAgIHRoaXMuI2ZvbnRCQm94VHJ1c3R3b3J0aHkuY2xlYXIoKTsKICAgIHJldHVybiBuZXcgQkJveFJlYWRlcih0aGlzLiNiYm94ZXMsIHRoaXMuI2Jib3hlc0Nvb3Jkcyk7CiAgfQogIHRha2VEZWJ1Z01ldGFkYXRhKCkgewogICAgcmV0dXJuIHRoaXMuI2RlYnVnTWV0YWRhdGE7CiAgfQp9Owp2YXIgQ2FudmFzTmVzdGVkRGVwZW5kZW5jeVRyYWNrZXIgPSBjbGFzcyBfQ2FudmFzTmVzdGVkRGVwZW5kZW5jeVRyYWNrZXIgewogICNkZXBlbmRlbmN5VHJhY2tlcjsKICAjb3BJZHg7CiAgI2lnbm9yZUJCb3hlczsKICAjbmVzdGluZ0xldmVsID0gMDsKICAjc2F2ZXNMZXZlbCA9IDA7CiAgY29uc3RydWN0b3IoZGVwZW5kZW5jeVRyYWNrZXIsIG9wSWR4LCBpZ25vcmVCQm94ZXMpIHsKICAgIGlmIChkZXBlbmRlbmN5VHJhY2tlciBpbnN0YW5jZW9mIF9DYW52YXNOZXN0ZWREZXBlbmRlbmN5VHJhY2tlciAmJiBkZXBlbmRlbmN5VHJhY2tlci4jaWdub3JlQkJveGVzID09PSAhIWlnbm9yZUJCb3hlcykgewogICAgICByZXR1cm4gZGVwZW5kZW5jeVRyYWNrZXI7CiAgICB9CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlciA9IGRlcGVuZGVuY3lUcmFja2VyOwogICAgdGhpcy4jb3BJZHggPSBvcElkeDsKICAgIHRoaXMuI2lnbm9yZUJCb3hlcyA9ICEhaWdub3JlQkJveGVzOwogIH0KICBncm93T3BlcmF0aW9uc0NvdW50KCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJVbnJlYWNoYWJsZSIpOwogIH0KICBzYXZlKG9wSWR4KSB7CiAgICB0aGlzLiNzYXZlc0xldmVsKys7CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5zYXZlKHRoaXMuI29wSWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZXN0b3JlKG9wSWR4KSB7CiAgICBpZiAodGhpcy4jc2F2ZXNMZXZlbCA+IDApIHsKICAgICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVzdG9yZSh0aGlzLiNvcElkeCk7CiAgICAgIHRoaXMuI3NhdmVzTGV2ZWwtLTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRPcGVuTWFya2VyKGlkeCkgewogICAgdGhpcy4jbmVzdGluZ0xldmVsKys7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZ2V0T3Blbk1hcmtlcigpIHsKICAgIHJldHVybiB0aGlzLiNuZXN0aW5nTGV2ZWwgPiAwID8gdGhpcy4jb3BJZHggOiB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5nZXRPcGVuTWFya2VyKCk7CiAgfQogIHJlY29yZENsb3NlTWFya2VyKGlkeCkgewogICAgdGhpcy4jbmVzdGluZ0xldmVsLS07CiAgICByZXR1cm4gdGhpczsKICB9CiAgYmVnaW5NYXJrZWRDb250ZW50KG9wSWR4KSB7CiAgICByZXR1cm4gdGhpczsKICB9CiAgZW5kTWFya2VkQ29udGVudChvcElkeCkgewogICAgcmV0dXJuIHRoaXM7CiAgfQogIHB1c2hCYXNlVHJhbnNmb3JtKGN0eCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucHVzaEJhc2VUcmFuc2Zvcm0oY3R4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBwb3BCYXNlVHJhbnNmb3JtKCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucG9wQmFzZVRyYW5zZm9ybSgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZFNpbXBsZURhdGEobmFtZSwgaWR4KSB7CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5yZWNvcmRTaW1wbGVEYXRhKG5hbWUsIHRoaXMuI29wSWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRJbmNyZW1lbnRhbERhdGEobmFtZSwgaWR4KSB7CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5yZWNvcmRJbmNyZW1lbnRhbERhdGEobmFtZSwgdGhpcy4jb3BJZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlc2V0SW5jcmVtZW50YWxEYXRhKG5hbWUsIGlkeCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVzZXRJbmNyZW1lbnRhbERhdGEobmFtZSwgdGhpcy4jb3BJZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZE5hbWVkRGF0YShuYW1lLCBpZHgpIHsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRTaW1wbGVEYXRhRnJvbU5hbWVkKG5hbWUsIGRlcE5hbWUsIGZhbGxiYWNrSWR4KSB7CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5yZWNvcmRTaW1wbGVEYXRhRnJvbU5hbWVkKG5hbWUsIGRlcE5hbWUsIHRoaXMuI29wSWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRGdXR1cmVGb3JjZWREZXBlbmRlbmN5KG5hbWUsIGlkeCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeShuYW1lLCB0aGlzLiNvcElkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgaW5oZXJpdFNpbXBsZURhdGFBc0Z1dHVyZUZvcmNlZERlcGVuZGVuY2llcyhuYW1lcykgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIuaW5oZXJpdFNpbXBsZURhdGFBc0Z1dHVyZUZvcmNlZERlcGVuZGVuY2llcyhuYW1lcyk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgaW5oZXJpdFBlbmRpbmdEZXBlbmRlbmNpZXNBc0Z1dHVyZUZvcmNlZERlcGVuZGVuY2llcygpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLmluaGVyaXRQZW5kaW5nRGVwZW5kZW5jaWVzQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMoKTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZXNldEJCb3goaWR4KSB7CiAgICBpZiAoIXRoaXMuI2lnbm9yZUJCb3hlcykgewogICAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5yZXNldEJCb3godGhpcy4jb3BJZHgpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZENsaXBCb3goaWR4LCBjdHgsIG1pblgsIG1heFgsIG1pblksIG1heFkpIHsKICAgIGlmICghdGhpcy4jaWdub3JlQkJveGVzKSB7CiAgICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlY29yZENsaXBCb3godGhpcy4jb3BJZHgsIGN0eCwgbWluWCwgbWF4WCwgbWluWSwgbWF4WSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkQkJveChpZHgsIGN0eCwgbWluWCwgbWF4WCwgbWluWSwgbWF4WSkgewogICAgaWYgKCF0aGlzLiNpZ25vcmVCQm94ZXMpIHsKICAgICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkQkJveCh0aGlzLiNvcElkeCwgY3R4LCBtaW5YLCBtYXhYLCBtaW5ZLCBtYXhZKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRDaGFyYWN0ZXJCQm94KGlkeCwgY3R4LCBmb250LCBzY2FsZSwgeCwgeSwgZ2V0TWVhc3VyZSkgewogICAgaWYgKCF0aGlzLiNpZ25vcmVCQm94ZXMpIHsKICAgICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkQ2hhcmFjdGVyQkJveCh0aGlzLiNvcElkeCwgY3R4LCBmb250LCBzY2FsZSwgeCwgeSwgZ2V0TWVhc3VyZSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkRnVsbFBhZ2VCQm94KGlkeCkgewogICAgaWYgKCF0aGlzLiNpZ25vcmVCQm94ZXMpIHsKICAgICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkRnVsbFBhZ2VCQm94KHRoaXMuI29wSWR4KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBnZXRTaW1wbGVJbmRleChkZXBlbmRlbmN5TmFtZSkgewogICAgcmV0dXJuIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLmdldFNpbXBsZUluZGV4KGRlcGVuZGVuY3lOYW1lKTsKICB9CiAgcmVjb3JkRGVwZW5kZW5jaWVzKGlkeCwgZGVwZW5kZW5jeU5hbWVzKSB7CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5yZWNvcmREZXBlbmRlbmNpZXModGhpcy4jb3BJZHgsIGRlcGVuZGVuY3lOYW1lcyk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkTmFtZWREZXBlbmRlbmN5KGlkeCwgbmFtZSkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkTmFtZWREZXBlbmRlbmN5KHRoaXMuI29wSWR4LCBuYW1lKTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRPcGVyYXRpb24oaWR4KSB7CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5yZWNvcmRPcGVyYXRpb24odGhpcy4jb3BJZHgsIHRydWUpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZFNob3dUZXh0T3BlcmF0aW9uKGlkeCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkU2hvd1RleHRPcGVyYXRpb24odGhpcy4jb3BJZHgsIHRydWUpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGJib3hUb0NsaXBCb3hEcm9wT3BlcmF0aW9uKGlkeCkgewogICAgaWYgKCF0aGlzLiNpZ25vcmVCQm94ZXMpIHsKICAgICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIuYmJveFRvQ2xpcEJveERyb3BPcGVyYXRpb24odGhpcy4jb3BJZHgsIHRydWUpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRha2UoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlVucmVhY2hhYmxlIik7CiAgfQogIHRha2VEZWJ1Z01ldGFkYXRhKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJVbnJlYWNoYWJsZSIpOwogIH0KfTsKdmFyIERlcGVuZGVuY2llcyA9IHsKICBzdHJva2U6IFsicGF0aCIsICJ0cmFuc2Zvcm0iLCAiZmlsdGVyIiwgInN0cm9rZUNvbG9yIiwgInN0cm9rZUFscGhhIiwgImxpbmVXaWR0aCIsICJsaW5lQ2FwIiwgImxpbmVKb2luIiwgIm1pdGVyTGltaXQiLCAiZGFzaCJdLAogIGZpbGw6IFsicGF0aCIsICJ0cmFuc2Zvcm0iLCAiZmlsdGVyIiwgImZpbGxDb2xvciIsICJmaWxsQWxwaGEiLCAiZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uIiwgIlNNYXNrIl0sCiAgaW1hZ2VYT2JqZWN0OiBbInRyYW5zZm9ybSIsICJTTWFzayIsICJmaWx0ZXIiLCAiZmlsbEFscGhhIiwgInN0cm9rZUFscGhhIiwgImdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiJdLAogIHJhd0ZpbGxQYXRoOiBbImZpbHRlciIsICJmaWxsQ29sb3IiLCAiZmlsbEFscGhhIl0sCiAgc2hvd1RleHQ6IFsidHJhbnNmb3JtIiwgImxlYWRpbmciLCAiY2hhclNwYWNpbmciLCAid29yZFNwYWNpbmciLCAiaFNjYWxlIiwgInRleHRSaXNlIiwgIm1vdmVUZXh0IiwgInRleHRNYXRyaXgiLCAiZm9udCIsICJmb250T2JqIiwgImZpbHRlciIsICJmaWxsQ29sb3IiLCAidGV4dFJlbmRlcmluZ01vZGUiLCAiU01hc2siLCAiZmlsbEFscGhhIiwgInN0cm9rZUFscGhhIiwgImdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiIsICJzYW1lTGluZVRleHQiXSwKICB0cmFuc2Zvcm06IFsidHJhbnNmb3JtIl0sCiAgdHJhbnNmb3JtQW5kRmlsbDogWyJ0cmFuc2Zvcm0iLCAiZmlsbENvbG9yIl0KfTsKdmFyIFBhdGhUeXBlID0gewogIEZJTEw6ICJGaWxsIiwKICBTVFJPS0U6ICJTdHJva2UiLAogIFNIQURJTkc6ICJTaGFkaW5nIgp9OwpmdW5jdGlvbiBhcHBseUJvdW5kaW5nQm94KGN0eCwgYmJveCkgewogIGlmICghYmJveCkgewogICAgcmV0dXJuOwogIH0KICBjb25zdCB3aWR0aCA9IGJib3hbMl0gLSBiYm94WzBdOwogIGNvbnN0IGhlaWdodCA9IGJib3hbM10gLSBiYm94WzFdOwogIGNvbnN0IHJlZ2lvbiA9IG5ldyBQYXRoMkQoKTsKICByZWdpb24ucmVjdChiYm94WzBdLCBiYm94WzFdLCB3aWR0aCwgaGVpZ2h0KTsKICBjdHguY2xpcChyZWdpb24pOwp9CnZhciBCYXNlU2hhZGluZ1BhdHRlcm4gPSBjbGFzcyB7CiAgaXNNb2RpZnlpbmdDdXJyZW50VHJhbnNmb3JtKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBnZXRQYXR0ZXJuKCkgewogICAgdW5yZWFjaGFibGUoIkFic3RyYWN0IG1ldGhvZCBgZ2V0UGF0dGVybmAgY2FsbGVkLiIpOwogIH0KfTsKdmFyIFJhZGlhbEF4aWFsU2hhZGluZ1BhdHRlcm4gPSBjbGFzcyBleHRlbmRzIEJhc2VTaGFkaW5nUGF0dGVybiB7CiAgY29uc3RydWN0b3IoSVIpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLl90eXBlID0gSVJbMV07CiAgICB0aGlzLl9iYm94ID0gSVJbMl07CiAgICB0aGlzLl9jb2xvclN0b3BzID0gSVJbM107CiAgICB0aGlzLl9wMCA9IElSWzRdOwogICAgdGhpcy5fcDEgPSBJUls1XTsKICAgIHRoaXMuX3IwID0gSVJbNl07CiAgICB0aGlzLl9yMSA9IElSWzddOwogICAgdGhpcy5tYXRyaXggPSBudWxsOwogIH0KICBpc09yaWdpbkJhc2VkKCkgewogICAgcmV0dXJuIHRoaXMuX3AwWzBdID09PSAwICYmIHRoaXMuX3AwWzFdID09PSAwICYmICghdGhpcy5pc1JhZGlhbCgpIHx8IHRoaXMuX3AxWzBdID09PSAwICYmIHRoaXMuX3AxWzFdID09PSAwKTsKICB9CiAgaXNSYWRpYWwoKSB7CiAgICByZXR1cm4gdGhpcy5fdHlwZSA9PT0gInJhZGlhbCI7CiAgfQogIF9jcmVhdGVHcmFkaWVudChjdHgsIHRyYW5zZm9ybSA9IG51bGwpIHsKICAgIGxldCBncmFkOwogICAgbGV0IGZpcnN0UG9pbnQgPSB0aGlzLl9wMDsKICAgIGxldCBzZWNvbmRQb2ludCA9IHRoaXMuX3AxOwogICAgaWYgKHRyYW5zZm9ybSkgewogICAgICBmaXJzdFBvaW50ID0gZmlyc3RQb2ludC5zbGljZSgpOwogICAgICBzZWNvbmRQb2ludCA9IHNlY29uZFBvaW50LnNsaWNlKCk7CiAgICAgIFV0aWwuYXBwbHlUcmFuc2Zvcm0oZmlyc3RQb2ludCwgdHJhbnNmb3JtKTsKICAgICAgVXRpbC5hcHBseVRyYW5zZm9ybShzZWNvbmRQb2ludCwgdHJhbnNmb3JtKTsKICAgIH0KICAgIGlmICh0aGlzLl90eXBlID09PSAiYXhpYWwiKSB7CiAgICAgIGdyYWQgPSBjdHguY3JlYXRlTGluZWFyR3JhZGllbnQoZmlyc3RQb2ludFswXSwgZmlyc3RQb2ludFsxXSwgc2Vjb25kUG9pbnRbMF0sIHNlY29uZFBvaW50WzFdKTsKICAgIH0gZWxzZSBpZiAodGhpcy5fdHlwZSA9PT0gInJhZGlhbCIpIHsKICAgICAgbGV0IHIwID0gdGhpcy5fcjA7CiAgICAgIGxldCByMSA9IHRoaXMuX3IxOwogICAgICBpZiAodHJhbnNmb3JtKSB7CiAgICAgICAgY29uc3Qgc2NhbGUgPSBuZXcgRmxvYXQzMkFycmF5KDIpOwogICAgICAgIFV0aWwuc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUodHJhbnNmb3JtLCBzY2FsZSk7CiAgICAgICAgcjAgKj0gc2NhbGVbMF07CiAgICAgICAgcjEgKj0gc2NhbGVbMF07CiAgICAgIH0KICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVSYWRpYWxHcmFkaWVudChmaXJzdFBvaW50WzBdLCBmaXJzdFBvaW50WzFdLCByMCwgc2Vjb25kUG9pbnRbMF0sIHNlY29uZFBvaW50WzFdLCByMSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGNvbG9yU3RvcCBvZiB0aGlzLl9jb2xvclN0b3BzKSB7CiAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGNvbG9yU3RvcFswXSwgY29sb3JTdG9wWzFdKTsKICAgIH0KICAgIHJldHVybiBncmFkOwogIH0KICBnZXRQYXR0ZXJuKGN0eCwgb3duZXIsIGludmVyc2UsIHBhdGhUeXBlKSB7CiAgICBsZXQgcGF0dGVybjsKICAgIGlmIChwYXRoVHlwZSA9PT0gUGF0aFR5cGUuU1RST0tFIHx8IHBhdGhUeXBlID09PSBQYXRoVHlwZS5GSUxMKSB7CiAgICAgIGlmICh0aGlzLmlzT3JpZ2luQmFzZWQoKSkgewogICAgICAgIGxldCB0cmFuc2YgPSBVdGlsLnRyYW5zZm9ybShpbnZlcnNlLCBvd25lci5iYXNlVHJhbnNmb3JtKTsKICAgICAgICBpZiAodGhpcy5tYXRyaXgpIHsKICAgICAgICAgIHRyYW5zZiA9IFV0aWwudHJhbnNmb3JtKHRyYW5zZiwgdGhpcy5tYXRyaXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmVjaXNpb24gPSAxZS0zOwogICAgICAgIGNvbnN0IG4xID0gTWF0aC5oeXBvdCh0cmFuc2ZbMF0sIHRyYW5zZlsxXSk7CiAgICAgICAgY29uc3QgbjIgPSBNYXRoLmh5cG90KHRyYW5zZlsyXSwgdHJhbnNmWzNdKTsKICAgICAgICBjb25zdCBwcyA9ICh0cmFuc2ZbMF0gKiB0cmFuc2ZbMl0gKyB0cmFuc2ZbMV0gKiB0cmFuc2ZbM10pIC8gKG4xICogbjIpOwogICAgICAgIGlmIChNYXRoLmFicyhwcykgPCBwcmVjaXNpb24pIHsKICAgICAgICAgIGlmICh0aGlzLmlzUmFkaWFsKCkpIHsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKG4xIC0gbjIpIDwgcHJlY2lzaW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZUdyYWRpZW50KGN0eCwgdHJhbnNmKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZUdyYWRpZW50KGN0eCwgdHJhbnNmKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3Qgb3duZXJCQm94ID0gb3duZXIuY3VycmVudC5nZXRDbGlwcGVkUGF0aEJvdW5kaW5nQm94KHBhdGhUeXBlLCBnZXRDdXJyZW50VHJhbnNmb3JtKGN0eCkpIHx8IFswLCAwLCAwLCAwXTsKICAgICAgY29uc3Qgd2lkdGggPSBNYXRoLmNlaWwob3duZXJCQm94WzJdIC0gb3duZXJCQm94WzBdKSB8fCAxOwogICAgICBjb25zdCBoZWlnaHQgPSBNYXRoLmNlaWwob3duZXJCQm94WzNdIC0gb3duZXJCQm94WzFdKSB8fCAxOwogICAgICBjb25zdCB0bXBDYW52YXMgPSBvd25lci5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoInBhdHRlcm4iLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgY29uc3QgdG1wQ3R4ID0gdG1wQ2FudmFzLmNvbnRleHQ7CiAgICAgIHRtcEN0eC5jbGVhclJlY3QoMCwgMCwgdG1wQ3R4LmNhbnZhcy53aWR0aCwgdG1wQ3R4LmNhbnZhcy5oZWlnaHQpOwogICAgICB0bXBDdHguYmVnaW5QYXRoKCk7CiAgICAgIHRtcEN0eC5yZWN0KDAsIDAsIHRtcEN0eC5jYW52YXMud2lkdGgsIHRtcEN0eC5jYW52YXMuaGVpZ2h0KTsKICAgICAgdG1wQ3R4LnRyYW5zbGF0ZSgtb3duZXJCQm94WzBdLCAtb3duZXJCQm94WzFdKTsKICAgICAgaW52ZXJzZSA9IFV0aWwudHJhbnNmb3JtKGludmVyc2UsIFsxLCAwLCAwLCAxLCBvd25lckJCb3hbMF0sIG93bmVyQkJveFsxXV0pOwogICAgICB0bXBDdHgudHJhbnNmb3JtKC4uLm93bmVyLmJhc2VUcmFuc2Zvcm0pOwogICAgICBpZiAodGhpcy5tYXRyaXgpIHsKICAgICAgICB0bXBDdHgudHJhbnNmb3JtKC4uLnRoaXMubWF0cml4KTsKICAgICAgfQogICAgICBhcHBseUJvdW5kaW5nQm94KHRtcEN0eCwgdGhpcy5fYmJveCk7CiAgICAgIHRtcEN0eC5maWxsU3R5bGUgPSB0aGlzLl9jcmVhdGVHcmFkaWVudCh0bXBDdHgpOwogICAgICB0bXBDdHguZmlsbCgpOwogICAgICBwYXR0ZXJuID0gY3R4LmNyZWF0ZVBhdHRlcm4odG1wQ2FudmFzLmNhbnZhcywgIm5vLXJlcGVhdCIpOwogICAgICBjb25zdCBkb21NYXRyaXggPSBuZXcgRE9NTWF0cml4KGludmVyc2UpOwogICAgICBwYXR0ZXJuLnNldFRyYW5zZm9ybShkb21NYXRyaXgpOwogICAgfSBlbHNlIHsKICAgICAgYXBwbHlCb3VuZGluZ0JveChjdHgsIHRoaXMuX2Jib3gpOwogICAgICBwYXR0ZXJuID0gdGhpcy5fY3JlYXRlR3JhZGllbnQoY3R4KTsKICAgIH0KICAgIHJldHVybiBwYXR0ZXJuOwogIH0KfTsKZnVuY3Rpb24gZHJhd1RyaWFuZ2xlKGRhdGEsIGNvbnRleHQsIHAxLCBwMiwgcDMsIGMxLCBjMiwgYzMpIHsKICBjb25zdCBjb29yZHMgPSBjb250ZXh0LmNvb3JkcywgY29sb3JzID0gY29udGV4dC5jb2xvcnM7CiAgY29uc3QgYnl0ZXMgPSBkYXRhLmRhdGEsIHJvd1NpemUgPSBkYXRhLndpZHRoICogNDsKICBsZXQgdG1wOwogIGlmIChjb29yZHNbcDEgKyAxXSA+IGNvb3Jkc1twMiArIDFdKSB7CiAgICB0bXAgPSBwMTsKICAgIHAxID0gcDI7CiAgICBwMiA9IHRtcDsKICAgIHRtcCA9IGMxOwogICAgYzEgPSBjMjsKICAgIGMyID0gdG1wOwogIH0KICBpZiAoY29vcmRzW3AyICsgMV0gPiBjb29yZHNbcDMgKyAxXSkgewogICAgdG1wID0gcDI7CiAgICBwMiA9IHAzOwogICAgcDMgPSB0bXA7CiAgICB0bXAgPSBjMjsKICAgIGMyID0gYzM7CiAgICBjMyA9IHRtcDsKICB9CiAgaWYgKGNvb3Jkc1twMSArIDFdID4gY29vcmRzW3AyICsgMV0pIHsKICAgIHRtcCA9IHAxOwogICAgcDEgPSBwMjsKICAgIHAyID0gdG1wOwogICAgdG1wID0gYzE7CiAgICBjMSA9IGMyOwogICAgYzIgPSB0bXA7CiAgfQogIGNvbnN0IHgxID0gKGNvb3Jkc1twMV0gKyBjb250ZXh0Lm9mZnNldFgpICogY29udGV4dC5zY2FsZVg7CiAgY29uc3QgeTEgPSAoY29vcmRzW3AxICsgMV0gKyBjb250ZXh0Lm9mZnNldFkpICogY29udGV4dC5zY2FsZVk7CiAgY29uc3QgeDIgPSAoY29vcmRzW3AyXSArIGNvbnRleHQub2Zmc2V0WCkgKiBjb250ZXh0LnNjYWxlWDsKICBjb25zdCB5MiA9IChjb29yZHNbcDIgKyAxXSArIGNvbnRleHQub2Zmc2V0WSkgKiBjb250ZXh0LnNjYWxlWTsKICBjb25zdCB4MyA9IChjb29yZHNbcDNdICsgY29udGV4dC5vZmZzZXRYKSAqIGNvbnRleHQuc2NhbGVYOwogIGNvbnN0IHkzID0gKGNvb3Jkc1twMyArIDFdICsgY29udGV4dC5vZmZzZXRZKSAqIGNvbnRleHQuc2NhbGVZOwogIGlmICh5MSA+PSB5MykgewogICAgcmV0dXJuOwogIH0KICBjb25zdCBjMXIgPSBjb2xvcnNbYzFdLCBjMWcgPSBjb2xvcnNbYzEgKyAxXSwgYzFiID0gY29sb3JzW2MxICsgMl07CiAgY29uc3QgYzJyID0gY29sb3JzW2MyXSwgYzJnID0gY29sb3JzW2MyICsgMV0sIGMyYiA9IGNvbG9yc1tjMiArIDJdOwogIGNvbnN0IGMzciA9IGNvbG9yc1tjM10sIGMzZyA9IGNvbG9yc1tjMyArIDFdLCBjM2IgPSBjb2xvcnNbYzMgKyAyXTsKICBjb25zdCBtaW5ZID0gTWF0aC5yb3VuZCh5MSksIG1heFkgPSBNYXRoLnJvdW5kKHkzKTsKICBsZXQgeGEsIGNhciwgY2FnLCBjYWI7CiAgbGV0IHhiLCBjYnIsIGNiZywgY2JiOwogIGZvciAobGV0IHkgPSBtaW5ZOyB5IDw9IG1heFk7IHkrKykgewogICAgaWYgKHkgPCB5MikgewogICAgICBjb25zdCBrMiA9IHkgPCB5MSA/IDAgOiAoeTEgLSB5KSAvICh5MSAtIHkyKTsKICAgICAgeGEgPSB4MSAtICh4MSAtIHgyKSAqIGsyOwogICAgICBjYXIgPSBjMXIgLSAoYzFyIC0gYzJyKSAqIGsyOwogICAgICBjYWcgPSBjMWcgLSAoYzFnIC0gYzJnKSAqIGsyOwogICAgICBjYWIgPSBjMWIgLSAoYzFiIC0gYzJiKSAqIGsyOwogICAgfSBlbHNlIHsKICAgICAgbGV0IGsyOwogICAgICBpZiAoeSA+IHkzKSB7CiAgICAgICAgazIgPSAxOwogICAgICB9IGVsc2UgaWYgKHkyID09PSB5MykgewogICAgICAgIGsyID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBrMiA9ICh5MiAtIHkpIC8gKHkyIC0geTMpOwogICAgICB9CiAgICAgIHhhID0geDIgLSAoeDIgLSB4MykgKiBrMjsKICAgICAgY2FyID0gYzJyIC0gKGMyciAtIGMzcikgKiBrMjsKICAgICAgY2FnID0gYzJnIC0gKGMyZyAtIGMzZykgKiBrMjsKICAgICAgY2FiID0gYzJiIC0gKGMyYiAtIGMzYikgKiBrMjsKICAgIH0KICAgIGxldCBrOwogICAgaWYgKHkgPCB5MSkgewogICAgICBrID0gMDsKICAgIH0gZWxzZSBpZiAoeSA+IHkzKSB7CiAgICAgIGsgPSAxOwogICAgfSBlbHNlIHsKICAgICAgayA9ICh5MSAtIHkpIC8gKHkxIC0geTMpOwogICAgfQogICAgeGIgPSB4MSAtICh4MSAtIHgzKSAqIGs7CiAgICBjYnIgPSBjMXIgLSAoYzFyIC0gYzNyKSAqIGs7CiAgICBjYmcgPSBjMWcgLSAoYzFnIC0gYzNnKSAqIGs7CiAgICBjYmIgPSBjMWIgLSAoYzFiIC0gYzNiKSAqIGs7CiAgICBjb25zdCB4MV8gPSBNYXRoLnJvdW5kKE1hdGgubWluKHhhLCB4YikpOwogICAgY29uc3QgeDJfID0gTWF0aC5yb3VuZChNYXRoLm1heCh4YSwgeGIpKTsKICAgIGxldCBqID0gcm93U2l6ZSAqIHkgKyB4MV8gKiA0OwogICAgZm9yIChsZXQgeCA9IHgxXzsgeCA8PSB4Ml87IHgrKykgewogICAgICBrID0gKHhhIC0geCkgLyAoeGEgLSB4Yik7CiAgICAgIGlmIChrIDwgMCkgewogICAgICAgIGsgPSAwOwogICAgICB9IGVsc2UgaWYgKGsgPiAxKSB7CiAgICAgICAgayA9IDE7CiAgICAgIH0KICAgICAgYnl0ZXNbaisrXSA9IGNhciAtIChjYXIgLSBjYnIpICogayB8IDA7CiAgICAgIGJ5dGVzW2orK10gPSBjYWcgLSAoY2FnIC0gY2JnKSAqIGsgfCAwOwogICAgICBieXRlc1tqKytdID0gY2FiIC0gKGNhYiAtIGNiYikgKiBrIHwgMDsKICAgICAgYnl0ZXNbaisrXSA9IDI1NTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gZHJhd0ZpZ3VyZShkYXRhLCBmaWd1cmUsIGNvbnRleHQpIHsKICBjb25zdCBwcyA9IGZpZ3VyZS5jb29yZHM7CiAgY29uc3QgY3MgPSBmaWd1cmUuY29sb3JzOwogIGxldCBpLCBpaTsKICBzd2l0Y2ggKGZpZ3VyZS50eXBlKSB7CiAgICBjYXNlIE1lc2hGaWd1cmVUeXBlLkxBVFRJQ0U6CiAgICAgIGNvbnN0IHZlcnRpY2VzUGVyUm93ID0gZmlndXJlLnZlcnRpY2VzUGVyUm93OwogICAgICBjb25zdCByb3dzID0gTWF0aC5mbG9vcihwcy5sZW5ndGggLyB2ZXJ0aWNlc1BlclJvdykgLSAxOwogICAgICBjb25zdCBjb2xzID0gdmVydGljZXNQZXJSb3cgLSAxOwogICAgICBmb3IgKGkgPSAwOyBpIDwgcm93czsgaSsrKSB7CiAgICAgICAgbGV0IHEgPSBpICogdmVydGljZXNQZXJSb3c7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjb2xzOyBqKyssIHErKykgewogICAgICAgICAgZHJhd1RyaWFuZ2xlKGRhdGEsIGNvbnRleHQsIHBzW3FdLCBwc1txICsgMV0sIHBzW3EgKyB2ZXJ0aWNlc1BlclJvd10sIGNzW3FdLCBjc1txICsgMV0sIGNzW3EgKyB2ZXJ0aWNlc1BlclJvd10pOwogICAgICAgICAgZHJhd1RyaWFuZ2xlKGRhdGEsIGNvbnRleHQsIHBzW3EgKyB2ZXJ0aWNlc1BlclJvdyArIDFdLCBwc1txICsgMV0sIHBzW3EgKyB2ZXJ0aWNlc1BlclJvd10sIGNzW3EgKyB2ZXJ0aWNlc1BlclJvdyArIDFdLCBjc1txICsgMV0sIGNzW3EgKyB2ZXJ0aWNlc1BlclJvd10pOwogICAgICAgIH0KICAgICAgfQogICAgICBicmVhazsKICAgIGNhc2UgTWVzaEZpZ3VyZVR5cGUuVFJJQU5HTEVTOgogICAgICBmb3IgKGkgPSAwLCBpaSA9IHBzLmxlbmd0aDsgaSA8IGlpOyBpICs9IDMpIHsKICAgICAgICBkcmF3VHJpYW5nbGUoZGF0YSwgY29udGV4dCwgcHNbaV0sIHBzW2kgKyAxXSwgcHNbaSArIDJdLCBjc1tpXSwgY3NbaSArIDFdLCBjc1tpICsgMl0pOwogICAgICB9CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbGxlZ2FsIGZpZ3VyZSIpOwogIH0KfQp2YXIgTWVzaFNoYWRpbmdQYXR0ZXJuID0gY2xhc3MgZXh0ZW5kcyBCYXNlU2hhZGluZ1BhdHRlcm4gewogIGNvbnN0cnVjdG9yKElSKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5fY29vcmRzID0gSVJbMl07CiAgICB0aGlzLl9jb2xvcnMgPSBJUlszXTsKICAgIHRoaXMuX2ZpZ3VyZXMgPSBJUls0XTsKICAgIHRoaXMuX2JvdW5kcyA9IElSWzVdOwogICAgdGhpcy5fYmJveCA9IElSWzZdOwogICAgdGhpcy5fYmFja2dyb3VuZCA9IElSWzddOwogICAgdGhpcy5tYXRyaXggPSBudWxsOwogIH0KICBfY3JlYXRlTWVzaENhbnZhcyhjb21iaW5lZFNjYWxlLCBiYWNrZ3JvdW5kQ29sb3IsIGNhY2hlZENhbnZhc2VzKSB7CiAgICBjb25zdCBFWFBFQ1RFRF9TQ0FMRSA9IDEuMTsKICAgIGNvbnN0IE1BWF9QQVRURVJOX1NJWkUgPSAzZTM7CiAgICBjb25zdCBCT1JERVJfU0laRSA9IDI7CiAgICBjb25zdCBvZmZzZXRYID0gTWF0aC5mbG9vcih0aGlzLl9ib3VuZHNbMF0pOwogICAgY29uc3Qgb2Zmc2V0WSA9IE1hdGguZmxvb3IodGhpcy5fYm91bmRzWzFdKTsKICAgIGNvbnN0IGJvdW5kc1dpZHRoID0gTWF0aC5jZWlsKHRoaXMuX2JvdW5kc1syXSkgLSBvZmZzZXRYOwogICAgY29uc3QgYm91bmRzSGVpZ2h0ID0gTWF0aC5jZWlsKHRoaXMuX2JvdW5kc1szXSkgLSBvZmZzZXRZOwogICAgY29uc3Qgd2lkdGggPSBNYXRoLm1pbihNYXRoLmNlaWwoTWF0aC5hYnMoYm91bmRzV2lkdGggKiBjb21iaW5lZFNjYWxlWzBdICogRVhQRUNURURfU0NBTEUpKSwgTUFYX1BBVFRFUk5fU0laRSk7CiAgICBjb25zdCBoZWlnaHQgPSBNYXRoLm1pbihNYXRoLmNlaWwoTWF0aC5hYnMoYm91bmRzSGVpZ2h0ICogY29tYmluZWRTY2FsZVsxXSAqIEVYUEVDVEVEX1NDQUxFKSksIE1BWF9QQVRURVJOX1NJWkUpOwogICAgY29uc3Qgc2NhbGVYID0gYm91bmRzV2lkdGggLyB3aWR0aDsKICAgIGNvbnN0IHNjYWxlWSA9IGJvdW5kc0hlaWdodCAvIGhlaWdodDsKICAgIGNvbnN0IGNvbnRleHQgPSB7CiAgICAgIGNvb3JkczogdGhpcy5fY29vcmRzLAogICAgICBjb2xvcnM6IHRoaXMuX2NvbG9ycywKICAgICAgb2Zmc2V0WDogLW9mZnNldFgsCiAgICAgIG9mZnNldFk6IC1vZmZzZXRZLAogICAgICBzY2FsZVg6IDEgLyBzY2FsZVgsCiAgICAgIHNjYWxlWTogMSAvIHNjYWxlWQogICAgfTsKICAgIGNvbnN0IHBhZGRlZFdpZHRoID0gd2lkdGggKyBCT1JERVJfU0laRSAqIDI7CiAgICBjb25zdCBwYWRkZWRIZWlnaHQgPSBoZWlnaHQgKyBCT1JERVJfU0laRSAqIDI7CiAgICBjb25zdCB0bXBDYW52YXMgPSBjYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoIm1lc2giLCBwYWRkZWRXaWR0aCwgcGFkZGVkSGVpZ2h0KTsKICAgIGNvbnN0IHRtcEN0eCA9IHRtcENhbnZhcy5jb250ZXh0OwogICAgY29uc3QgZGF0YSA9IHRtcEN0eC5jcmVhdGVJbWFnZURhdGEod2lkdGgsIGhlaWdodCk7CiAgICBpZiAoYmFja2dyb3VuZENvbG9yKSB7CiAgICAgIGNvbnN0IGJ5dGVzID0gZGF0YS5kYXRhOwogICAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBieXRlcy5sZW5ndGg7IGkgPCBpaTsgaSArPSA0KSB7CiAgICAgICAgYnl0ZXNbaV0gPSBiYWNrZ3JvdW5kQ29sb3JbMF07CiAgICAgICAgYnl0ZXNbaSArIDFdID0gYmFja2dyb3VuZENvbG9yWzFdOwogICAgICAgIGJ5dGVzW2kgKyAyXSA9IGJhY2tncm91bmRDb2xvclsyXTsKICAgICAgICBieXRlc1tpICsgM10gPSAyNTU7CiAgICAgIH0KICAgIH0KICAgIGZvciAoY29uc3QgZmlndXJlIG9mIHRoaXMuX2ZpZ3VyZXMpIHsKICAgICAgZHJhd0ZpZ3VyZShkYXRhLCBmaWd1cmUsIGNvbnRleHQpOwogICAgfQogICAgdG1wQ3R4LnB1dEltYWdlRGF0YShkYXRhLCBCT1JERVJfU0laRSwgQk9SREVSX1NJWkUpOwogICAgY29uc3QgY2FudmFzID0gdG1wQ2FudmFzLmNhbnZhczsKICAgIHJldHVybiB7CiAgICAgIGNhbnZhcywKICAgICAgb2Zmc2V0WDogb2Zmc2V0WCAtIEJPUkRFUl9TSVpFICogc2NhbGVYLAogICAgICBvZmZzZXRZOiBvZmZzZXRZIC0gQk9SREVSX1NJWkUgKiBzY2FsZVksCiAgICAgIHNjYWxlWCwKICAgICAgc2NhbGVZCiAgICB9OwogIH0KICBpc01vZGlmeWluZ0N1cnJlbnRUcmFuc2Zvcm0oKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZ2V0UGF0dGVybihjdHgsIG93bmVyLCBpbnZlcnNlLCBwYXRoVHlwZSkgewogICAgYXBwbHlCb3VuZGluZ0JveChjdHgsIHRoaXMuX2Jib3gpOwogICAgY29uc3Qgc2NhbGUgPSBuZXcgRmxvYXQzMkFycmF5KDIpOwogICAgaWYgKHBhdGhUeXBlID09PSBQYXRoVHlwZS5TSEFESU5HKSB7CiAgICAgIFV0aWwuc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUoZ2V0Q3VycmVudFRyYW5zZm9ybShjdHgpLCBzY2FsZSk7CiAgICB9IGVsc2UgaWYgKHRoaXMubWF0cml4KSB7CiAgICAgIFV0aWwuc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUodGhpcy5tYXRyaXgsIHNjYWxlKTsKICAgICAgY29uc3QgW21hdHJpeFNjYWxlWCwgbWF0cml4U2NhbGVZXSA9IHNjYWxlOwogICAgICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKG93bmVyLmJhc2VUcmFuc2Zvcm0sIHNjYWxlKTsKICAgICAgc2NhbGVbMF0gKj0gbWF0cml4U2NhbGVYOwogICAgICBzY2FsZVsxXSAqPSBtYXRyaXhTY2FsZVk7CiAgICB9IGVsc2UgewogICAgICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKG93bmVyLmJhc2VUcmFuc2Zvcm0sIHNjYWxlKTsKICAgIH0KICAgIGNvbnN0IHRlbXBvcmFyeVBhdHRlcm5DYW52YXMgPSB0aGlzLl9jcmVhdGVNZXNoQ2FudmFzKHNjYWxlLCBwYXRoVHlwZSA9PT0gUGF0aFR5cGUuU0hBRElORyA/IG51bGwgOiB0aGlzLl9iYWNrZ3JvdW5kLCBvd25lci5jYWNoZWRDYW52YXNlcyk7CiAgICBpZiAocGF0aFR5cGUgIT09IFBhdGhUeXBlLlNIQURJTkcpIHsKICAgICAgY3R4LnNldFRyYW5zZm9ybSguLi5vd25lci5iYXNlVHJhbnNmb3JtKTsKICAgICAgaWYgKHRoaXMubWF0cml4KSB7CiAgICAgICAgY3R4LnRyYW5zZm9ybSguLi50aGlzLm1hdHJpeCk7CiAgICAgIH0KICAgIH0KICAgIGN0eC50cmFuc2xhdGUodGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5vZmZzZXRYLCB0ZW1wb3JhcnlQYXR0ZXJuQ2FudmFzLm9mZnNldFkpOwogICAgY3R4LnNjYWxlKHRlbXBvcmFyeVBhdHRlcm5DYW52YXMuc2NhbGVYLCB0ZW1wb3JhcnlQYXR0ZXJuQ2FudmFzLnNjYWxlWSk7CiAgICByZXR1cm4gY3R4LmNyZWF0ZVBhdHRlcm4odGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5jYW52YXMsICJuby1yZXBlYXQiKTsKICB9Cn07CnZhciBEdW1teVNoYWRpbmdQYXR0ZXJuID0gY2xhc3MgZXh0ZW5kcyBCYXNlU2hhZGluZ1BhdHRlcm4gewogIGdldFBhdHRlcm4oKSB7CiAgICByZXR1cm4gImhvdHBpbmsiOwogIH0KfTsKZnVuY3Rpb24gZ2V0U2hhZGluZ1BhdHRlcm4oSVIpIHsKICBzd2l0Y2ggKElSWzBdKSB7CiAgICBjYXNlICJSYWRpYWxBeGlhbCI6CiAgICAgIHJldHVybiBuZXcgUmFkaWFsQXhpYWxTaGFkaW5nUGF0dGVybihJUik7CiAgICBjYXNlICJNZXNoIjoKICAgICAgcmV0dXJuIG5ldyBNZXNoU2hhZGluZ1BhdHRlcm4oSVIpOwogICAgY2FzZSAiRHVtbXkiOgogICAgICByZXR1cm4gbmV3IER1bW15U2hhZGluZ1BhdHRlcm4oKTsKICB9CiAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIElSIHR5cGU6ICR7SVJbMF19YCk7Cn0KdmFyIFBhaW50VHlwZSA9IHsKICBDT0xPUkVEOiAxLAogIFVOQ09MT1JFRDogMgp9Owp2YXIgVGlsaW5nUGF0dGVybiA9IGNsYXNzIF9UaWxpbmdQYXR0ZXJuIHsKICBzdGF0aWMgTUFYX1BBVFRFUk5fU0laRSA9IDNlMzsKICBjb25zdHJ1Y3RvcihJUiwgY3R4LCBjYW52YXNHcmFwaGljc0ZhY3RvcnksIGJhc2VUcmFuc2Zvcm0pIHsKICAgIHRoaXMuY29sb3IgPSBJUlsxXTsKICAgIHRoaXMub3BlcmF0b3JMaXN0ID0gSVJbMl07CiAgICB0aGlzLm1hdHJpeCA9IElSWzNdOwogICAgdGhpcy5iYm94ID0gSVJbNF07CiAgICB0aGlzLnhzdGVwID0gSVJbNV07CiAgICB0aGlzLnlzdGVwID0gSVJbNl07CiAgICB0aGlzLnBhaW50VHlwZSA9IElSWzddOwogICAgdGhpcy50aWxpbmdUeXBlID0gSVJbOF07CiAgICB0aGlzLmN0eCA9IGN0eDsKICAgIHRoaXMuY2FudmFzR3JhcGhpY3NGYWN0b3J5ID0gY2FudmFzR3JhcGhpY3NGYWN0b3J5OwogICAgdGhpcy5iYXNlVHJhbnNmb3JtID0gYmFzZVRyYW5zZm9ybTsKICB9CiAgY3JlYXRlUGF0dGVybkNhbnZhcyhvd25lciwgb3BJZHgpIHsKICAgIGNvbnN0IHsKICAgICAgYmJveCwKICAgICAgb3BlcmF0b3JMaXN0LAogICAgICBwYWludFR5cGUsCiAgICAgIHRpbGluZ1R5cGUsCiAgICAgIGNvbG9yLAogICAgICBjYW52YXNHcmFwaGljc0ZhY3RvcnkKICAgIH0gPSB0aGlzOwogICAgbGV0IHsKICAgICAgeHN0ZXAsCiAgICAgIHlzdGVwCiAgICB9ID0gdGhpczsKICAgIHhzdGVwID0gTWF0aC5hYnMoeHN0ZXApOwogICAgeXN0ZXAgPSBNYXRoLmFicyh5c3RlcCk7CiAgICBpbmZvKCJUaWxpbmdUeXBlOiAiICsgdGlsaW5nVHlwZSk7CiAgICBjb25zdCB4MCA9IGJib3hbMF0sIHkwID0gYmJveFsxXSwgeDEgPSBiYm94WzJdLCB5MSA9IGJib3hbM107CiAgICBjb25zdCB3aWR0aCA9IHgxIC0geDA7CiAgICBjb25zdCBoZWlnaHQgPSB5MSAtIHkwOwogICAgY29uc3Qgc2NhbGUgPSBuZXcgRmxvYXQzMkFycmF5KDIpOwogICAgVXRpbC5zaW5ndWxhclZhbHVlRGVjb21wb3NlMmRTY2FsZSh0aGlzLm1hdHJpeCwgc2NhbGUpOwogICAgY29uc3QgW21hdHJpeFNjYWxlWCwgbWF0cml4U2NhbGVZXSA9IHNjYWxlOwogICAgVXRpbC5zaW5ndWxhclZhbHVlRGVjb21wb3NlMmRTY2FsZSh0aGlzLmJhc2VUcmFuc2Zvcm0sIHNjYWxlKTsKICAgIGNvbnN0IGNvbWJpbmVkU2NhbGVYID0gbWF0cml4U2NhbGVYICogc2NhbGVbMF07CiAgICBjb25zdCBjb21iaW5lZFNjYWxlWSA9IG1hdHJpeFNjYWxlWSAqIHNjYWxlWzFdOwogICAgbGV0IGNhbnZhc1dpZHRoID0gd2lkdGgsIGNhbnZhc0hlaWdodCA9IGhlaWdodCwgcmVkcmF3SG9yaXpvbnRhbGx5ID0gZmFsc2UsIHJlZHJhd1ZlcnRpY2FsbHkgPSBmYWxzZTsKICAgIGNvbnN0IHhTY2FsZWRTdGVwID0gTWF0aC5jZWlsKHhzdGVwICogY29tYmluZWRTY2FsZVgpOwogICAgY29uc3QgeVNjYWxlZFN0ZXAgPSBNYXRoLmNlaWwoeXN0ZXAgKiBjb21iaW5lZFNjYWxlWSk7CiAgICBjb25zdCB4U2NhbGVkV2lkdGggPSBNYXRoLmNlaWwod2lkdGggKiBjb21iaW5lZFNjYWxlWCk7CiAgICBjb25zdCB5U2NhbGVkSGVpZ2h0ID0gTWF0aC5jZWlsKGhlaWdodCAqIGNvbWJpbmVkU2NhbGVZKTsKICAgIGlmICh4U2NhbGVkU3RlcCA+PSB4U2NhbGVkV2lkdGgpIHsKICAgICAgY2FudmFzV2lkdGggPSB4c3RlcDsKICAgIH0gZWxzZSB7CiAgICAgIHJlZHJhd0hvcml6b250YWxseSA9IHRydWU7CiAgICB9CiAgICBpZiAoeVNjYWxlZFN0ZXAgPj0geVNjYWxlZEhlaWdodCkgewogICAgICBjYW52YXNIZWlnaHQgPSB5c3RlcDsKICAgIH0gZWxzZSB7CiAgICAgIHJlZHJhd1ZlcnRpY2FsbHkgPSB0cnVlOwogICAgfQogICAgY29uc3QgZGlteCA9IHRoaXMuZ2V0U2l6ZUFuZFNjYWxlKGNhbnZhc1dpZHRoLCB0aGlzLmN0eC5jYW52YXMud2lkdGgsIGNvbWJpbmVkU2NhbGVYKTsKICAgIGNvbnN0IGRpbXkgPSB0aGlzLmdldFNpemVBbmRTY2FsZShjYW52YXNIZWlnaHQsIHRoaXMuY3R4LmNhbnZhcy5oZWlnaHQsIGNvbWJpbmVkU2NhbGVZKTsKICAgIGNvbnN0IHRtcENhbnZhcyA9IG93bmVyLmNhY2hlZENhbnZhc2VzLmdldENhbnZhcygicGF0dGVybiIsIGRpbXguc2l6ZSwgZGlteS5zaXplKTsKICAgIGNvbnN0IHRtcEN0eCA9IHRtcENhbnZhcy5jb250ZXh0OwogICAgY29uc3QgZ3JhcGhpY3MgPSBjYW52YXNHcmFwaGljc0ZhY3RvcnkuY3JlYXRlQ2FudmFzR3JhcGhpY3ModG1wQ3R4LCBvcElkeCk7CiAgICBncmFwaGljcy5ncm91cExldmVsID0gb3duZXIuZ3JvdXBMZXZlbDsKICAgIHRoaXMuc2V0RmlsbEFuZFN0cm9rZVN0eWxlVG9Db250ZXh0KGdyYXBoaWNzLCBwYWludFR5cGUsIGNvbG9yKTsKICAgIHRtcEN0eC50cmFuc2xhdGUoLWRpbXguc2NhbGUgKiB4MCwgLWRpbXkuc2NhbGUgKiB5MCk7CiAgICBncmFwaGljcy50cmFuc2Zvcm0oMCwgZGlteC5zY2FsZSwgMCwgMCwgZGlteS5zY2FsZSwgMCwgMCk7CiAgICB0bXBDdHguc2F2ZSgpOwogICAgZ3JhcGhpY3MuZGVwZW5kZW5jeVRyYWNrZXI/LnNhdmUoKTsKICAgIHRoaXMuY2xpcEJib3goZ3JhcGhpY3MsIHgwLCB5MCwgeDEsIHkxKTsKICAgIGdyYXBoaWNzLmJhc2VUcmFuc2Zvcm0gPSBnZXRDdXJyZW50VHJhbnNmb3JtKGdyYXBoaWNzLmN0eCk7CiAgICBncmFwaGljcy5leGVjdXRlT3BlcmF0b3JMaXN0KG9wZXJhdG9yTGlzdCk7CiAgICBncmFwaGljcy5lbmREcmF3aW5nKCk7CiAgICBncmFwaGljcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzdG9yZSgpOwogICAgdG1wQ3R4LnJlc3RvcmUoKTsKICAgIGlmIChyZWRyYXdIb3Jpem9udGFsbHkgfHwgcmVkcmF3VmVydGljYWxseSkgewogICAgICBjb25zdCBpbWFnZSA9IHRtcENhbnZhcy5jYW52YXM7CiAgICAgIGlmIChyZWRyYXdIb3Jpem9udGFsbHkpIHsKICAgICAgICBjYW52YXNXaWR0aCA9IHhzdGVwOwogICAgICB9CiAgICAgIGlmIChyZWRyYXdWZXJ0aWNhbGx5KSB7CiAgICAgICAgY2FudmFzSGVpZ2h0ID0geXN0ZXA7CiAgICAgIH0KICAgICAgY29uc3QgZGlteDIgPSB0aGlzLmdldFNpemVBbmRTY2FsZShjYW52YXNXaWR0aCwgdGhpcy5jdHguY2FudmFzLndpZHRoLCBjb21iaW5lZFNjYWxlWCk7CiAgICAgIGNvbnN0IGRpbXkyID0gdGhpcy5nZXRTaXplQW5kU2NhbGUoY2FudmFzSGVpZ2h0LCB0aGlzLmN0eC5jYW52YXMuaGVpZ2h0LCBjb21iaW5lZFNjYWxlWSk7CiAgICAgIGNvbnN0IHhTaXplID0gZGlteDIuc2l6ZTsKICAgICAgY29uc3QgeVNpemUgPSBkaW15Mi5zaXplOwogICAgICBjb25zdCB0bXBDYW52YXMyID0gb3duZXIuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJwYXR0ZXJuLXdvcmthcm91bmQiLCB4U2l6ZSwgeVNpemUpOwogICAgICBjb25zdCB0bXBDdHgyID0gdG1wQ2FudmFzMi5jb250ZXh0OwogICAgICBjb25zdCBpaSA9IHJlZHJhd0hvcml6b250YWxseSA/IE1hdGguZmxvb3Iod2lkdGggLyB4c3RlcCkgOiAwOwogICAgICBjb25zdCBqaiA9IHJlZHJhd1ZlcnRpY2FsbHkgPyBNYXRoLmZsb29yKGhlaWdodCAvIHlzdGVwKSA6IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IGlpOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8PSBqajsgaisrKSB7CiAgICAgICAgICB0bXBDdHgyLmRyYXdJbWFnZShpbWFnZSwgeFNpemUgKiBpLCB5U2l6ZSAqIGosIHhTaXplLCB5U2l6ZSwgMCwgMCwgeFNpemUsIHlTaXplKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjYW52YXM6IHRtcENhbnZhczIuY2FudmFzLAogICAgICAgIHNjYWxlWDogZGlteDIuc2NhbGUsCiAgICAgICAgc2NhbGVZOiBkaW15Mi5zY2FsZSwKICAgICAgICBvZmZzZXRYOiB4MCwKICAgICAgICBvZmZzZXRZOiB5MAogICAgICB9OwogICAgfQogICAgcmV0dXJuIHsKICAgICAgY2FudmFzOiB0bXBDYW52YXMuY2FudmFzLAogICAgICBzY2FsZVg6IGRpbXguc2NhbGUsCiAgICAgIHNjYWxlWTogZGlteS5zY2FsZSwKICAgICAgb2Zmc2V0WDogeDAsCiAgICAgIG9mZnNldFk6IHkwCiAgICB9OwogIH0KICBnZXRTaXplQW5kU2NhbGUoc3RlcCwgcmVhbE91dHB1dFNpemUsIHNjYWxlKSB7CiAgICBjb25zdCBtYXhTaXplID0gTWF0aC5tYXgoX1RpbGluZ1BhdHRlcm4uTUFYX1BBVFRFUk5fU0laRSwgcmVhbE91dHB1dFNpemUpOwogICAgbGV0IHNpemUgPSBNYXRoLmNlaWwoc3RlcCAqIHNjYWxlKTsKICAgIGlmIChzaXplID49IG1heFNpemUpIHsKICAgICAgc2l6ZSA9IG1heFNpemU7CiAgICB9IGVsc2UgewogICAgICBzY2FsZSA9IHNpemUgLyBzdGVwOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgc2NhbGUsCiAgICAgIHNpemUKICAgIH07CiAgfQogIGNsaXBCYm94KGdyYXBoaWNzLCB4MCwgeTAsIHgxLCB5MSkgewogICAgY29uc3QgYmJveFdpZHRoID0geDEgLSB4MDsKICAgIGNvbnN0IGJib3hIZWlnaHQgPSB5MSAtIHkwOwogICAgZ3JhcGhpY3MuY3R4LnJlY3QoeDAsIHkwLCBiYm94V2lkdGgsIGJib3hIZWlnaHQpOwogICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChbeDAsIHkwLCB4MSwgeTFdLCBnZXRDdXJyZW50VHJhbnNmb3JtKGdyYXBoaWNzLmN0eCksIGdyYXBoaWNzLmN1cnJlbnQubWluTWF4KTsKICAgIGdyYXBoaWNzLmNsaXAoKTsKICAgIGdyYXBoaWNzLmVuZFBhdGgoKTsKICB9CiAgc2V0RmlsbEFuZFN0cm9rZVN0eWxlVG9Db250ZXh0KGdyYXBoaWNzLCBwYWludFR5cGUsIGNvbG9yKSB7CiAgICBjb25zdCBjb250ZXh0ID0gZ3JhcGhpY3MuY3R4LCBjdXJyZW50ID0gZ3JhcGhpY3MuY3VycmVudDsKICAgIHN3aXRjaCAocGFpbnRUeXBlKSB7CiAgICAgIGNhc2UgUGFpbnRUeXBlLkNPTE9SRUQ6CiAgICAgICAgY29uc3QgewogICAgICAgICAgZmlsbFN0eWxlLAogICAgICAgICAgc3Ryb2tlU3R5bGUKICAgICAgICB9ID0gdGhpcy5jdHg7CiAgICAgICAgY29udGV4dC5maWxsU3R5bGUgPSBjdXJyZW50LmZpbGxDb2xvciA9IGZpbGxTdHlsZTsKICAgICAgICBjb250ZXh0LnN0cm9rZVN0eWxlID0gY3VycmVudC5zdHJva2VDb2xvciA9IHN0cm9rZVN0eWxlOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIFBhaW50VHlwZS5VTkNPTE9SRUQ6CiAgICAgICAgY29udGV4dC5maWxsU3R5bGUgPSBjb250ZXh0LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgY3VycmVudC5maWxsQ29sb3IgPSBjdXJyZW50LnN0cm9rZUNvbG9yID0gY29sb3I7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEZvcm1hdEVycm9yKGBVbnN1cHBvcnRlZCBwYWludCB0eXBlOiAke3BhaW50VHlwZX1gKTsKICAgIH0KICB9CiAgaXNNb2RpZnlpbmdDdXJyZW50VHJhbnNmb3JtKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBnZXRQYXR0ZXJuKGN0eCwgb3duZXIsIGludmVyc2UsIHBhdGhUeXBlLCBvcElkeCkgewogICAgbGV0IG1hdHJpeCA9IGludmVyc2U7CiAgICBpZiAocGF0aFR5cGUgIT09IFBhdGhUeXBlLlNIQURJTkcpIHsKICAgICAgbWF0cml4ID0gVXRpbC50cmFuc2Zvcm0obWF0cml4LCBvd25lci5iYXNlVHJhbnNmb3JtKTsKICAgICAgaWYgKHRoaXMubWF0cml4KSB7CiAgICAgICAgbWF0cml4ID0gVXRpbC50cmFuc2Zvcm0obWF0cml4LCB0aGlzLm1hdHJpeCk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRlbXBvcmFyeVBhdHRlcm5DYW52YXMgPSB0aGlzLmNyZWF0ZVBhdHRlcm5DYW52YXMob3duZXIsIG9wSWR4KTsKICAgIGxldCBkb21NYXRyaXggPSBuZXcgRE9NTWF0cml4KG1hdHJpeCk7CiAgICBkb21NYXRyaXggPSBkb21NYXRyaXgudHJhbnNsYXRlKHRlbXBvcmFyeVBhdHRlcm5DYW52YXMub2Zmc2V0WCwgdGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5vZmZzZXRZKTsKICAgIGRvbU1hdHJpeCA9IGRvbU1hdHJpeC5zY2FsZSgxIC8gdGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5zY2FsZVgsIDEgLyB0ZW1wb3JhcnlQYXR0ZXJuQ2FudmFzLnNjYWxlWSk7CiAgICBjb25zdCBwYXR0ZXJuID0gY3R4LmNyZWF0ZVBhdHRlcm4odGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5jYW52YXMsICJyZXBlYXQiKTsKICAgIHBhdHRlcm4uc2V0VHJhbnNmb3JtKGRvbU1hdHJpeCk7CiAgICByZXR1cm4gcGF0dGVybjsKICB9Cn07CmZ1bmN0aW9uIGNvbnZlcnRCbGFja0FuZFdoaXRlVG9SR0JBKHsKICBzcmMsCiAgc3JjUG9zID0gMCwKICBkZXN0LAogIHdpZHRoLAogIGhlaWdodCwKICBub25CbGFja0NvbG9yID0gNDI5NDk2NzI5NSwKICBpbnZlcnNlRGVjb2RlID0gZmFsc2UKfSkgewogIGNvbnN0IGJsYWNrID0gdXRpbF9GZWF0dXJlVGVzdC5pc0xpdHRsZUVuZGlhbiA/IDQyNzgxOTAwODAgOiAyNTU7CiAgY29uc3QgW3plcm9NYXBwaW5nLCBvbmVNYXBwaW5nXSA9IGludmVyc2VEZWNvZGUgPyBbbm9uQmxhY2tDb2xvciwgYmxhY2tdIDogW2JsYWNrLCBub25CbGFja0NvbG9yXTsKICBjb25zdCB3aWR0aEluU291cmNlID0gd2lkdGggPj4gMzsKICBjb25zdCB3aWR0aFJlbWFpbmRlciA9IHdpZHRoICYgNzsKICBjb25zdCBzcmNMZW5ndGggPSBzcmMubGVuZ3RoOwogIGRlc3QgPSBuZXcgVWludDMyQXJyYXkoZGVzdC5idWZmZXIpOwogIGxldCBkZXN0UG9zID0gMDsKICBmb3IgKGxldCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7CiAgICBmb3IgKGNvbnN0IG1heCA9IHNyY1BvcyArIHdpZHRoSW5Tb3VyY2U7IHNyY1BvcyA8IG1heDsgc3JjUG9zKyspIHsKICAgICAgY29uc3QgZWxlbTIgPSBzcmNQb3MgPCBzcmNMZW5ndGggPyBzcmNbc3JjUG9zXSA6IDI1NTsKICAgICAgZGVzdFtkZXN0UG9zKytdID0gZWxlbTIgJiAxMjggPyBvbmVNYXBwaW5nIDogemVyb01hcHBpbmc7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0yICYgNjQgPyBvbmVNYXBwaW5nIDogemVyb01hcHBpbmc7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0yICYgMzIgPyBvbmVNYXBwaW5nIDogemVyb01hcHBpbmc7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0yICYgMTYgPyBvbmVNYXBwaW5nIDogemVyb01hcHBpbmc7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0yICYgOCA/IG9uZU1hcHBpbmcgOiB6ZXJvTWFwcGluZzsKICAgICAgZGVzdFtkZXN0UG9zKytdID0gZWxlbTIgJiA0ID8gb25lTWFwcGluZyA6IHplcm9NYXBwaW5nOwogICAgICBkZXN0W2Rlc3RQb3MrK10gPSBlbGVtMiAmIDIgPyBvbmVNYXBwaW5nIDogemVyb01hcHBpbmc7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0yICYgMSA/IG9uZU1hcHBpbmcgOiB6ZXJvTWFwcGluZzsKICAgIH0KICAgIGlmICh3aWR0aFJlbWFpbmRlciA9PT0gMCkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGNvbnN0IGVsZW0gPSBzcmNQb3MgPCBzcmNMZW5ndGggPyBzcmNbc3JjUG9zKytdIDogMjU1OwogICAgZm9yIChsZXQgaiA9IDA7IGogPCB3aWR0aFJlbWFpbmRlcjsgaisrKSB7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0gJiAxIDw8IDcgLSBqID8gb25lTWFwcGluZyA6IHplcm9NYXBwaW5nOwogICAgfQogIH0KICByZXR1cm4gewogICAgc3JjUG9zLAogICAgZGVzdFBvcwogIH07Cn0KdmFyIE1JTl9GT05UX1NJWkUgPSAxNjsKdmFyIE1BWF9GT05UX1NJWkUgPSAxMDA7CnZhciBFWEVDVVRJT05fVElNRSA9IDE1Owp2YXIgRVhFQ1VUSU9OX1NURVBTID0gMTA7CnZhciBGVUxMX0NIVU5LX0hFSUdIVCA9IDE2Owp2YXIgU0NBTEVfTUFUUklYID0gbmV3IERPTU1hdHJpeCgpOwp2YXIgWFkgPSBuZXcgRmxvYXQzMkFycmF5KDIpOwp2YXIgTUlOX01BWF9JTklUID0gbmV3IEZsb2F0MzJBcnJheShbSW5maW5pdHksIEluZmluaXR5LCAtSW5maW5pdHksIC1JbmZpbml0eV0pOwpmdW5jdGlvbiBtaXJyb3JDb250ZXh0T3BlcmF0aW9ucyhjdHgsIGRlc3RDdHgpIHsKICBpZiAoY3R4Ll9yZW1vdmVNaXJyb3JpbmcpIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ29udGV4dCBpcyBhbHJlYWR5IGZvcndhcmRpbmcgb3BlcmF0aW9ucy4iKTsKICB9CiAgY3R4Ll9fb3JpZ2luYWxTYXZlID0gY3R4LnNhdmU7CiAgY3R4Ll9fb3JpZ2luYWxSZXN0b3JlID0gY3R4LnJlc3RvcmU7CiAgY3R4Ll9fb3JpZ2luYWxSb3RhdGUgPSBjdHgucm90YXRlOwogIGN0eC5fX29yaWdpbmFsU2NhbGUgPSBjdHguc2NhbGU7CiAgY3R4Ll9fb3JpZ2luYWxUcmFuc2xhdGUgPSBjdHgudHJhbnNsYXRlOwogIGN0eC5fX29yaWdpbmFsVHJhbnNmb3JtID0gY3R4LnRyYW5zZm9ybTsKICBjdHguX19vcmlnaW5hbFNldFRyYW5zZm9ybSA9IGN0eC5zZXRUcmFuc2Zvcm07CiAgY3R4Ll9fb3JpZ2luYWxSZXNldFRyYW5zZm9ybSA9IGN0eC5yZXNldFRyYW5zZm9ybTsKICBjdHguX19vcmlnaW5hbENsaXAgPSBjdHguY2xpcDsKICBjdHguX19vcmlnaW5hbE1vdmVUbyA9IGN0eC5tb3ZlVG87CiAgY3R4Ll9fb3JpZ2luYWxMaW5lVG8gPSBjdHgubGluZVRvOwogIGN0eC5fX29yaWdpbmFsQmV6aWVyQ3VydmVUbyA9IGN0eC5iZXppZXJDdXJ2ZVRvOwogIGN0eC5fX29yaWdpbmFsUmVjdCA9IGN0eC5yZWN0OwogIGN0eC5fX29yaWdpbmFsQ2xvc2VQYXRoID0gY3R4LmNsb3NlUGF0aDsKICBjdHguX19vcmlnaW5hbEJlZ2luUGF0aCA9IGN0eC5iZWdpblBhdGg7CiAgY3R4Ll9yZW1vdmVNaXJyb3JpbmcgPSAoKSA9PiB7CiAgICBjdHguc2F2ZSA9IGN0eC5fX29yaWdpbmFsU2F2ZTsKICAgIGN0eC5yZXN0b3JlID0gY3R4Ll9fb3JpZ2luYWxSZXN0b3JlOwogICAgY3R4LnJvdGF0ZSA9IGN0eC5fX29yaWdpbmFsUm90YXRlOwogICAgY3R4LnNjYWxlID0gY3R4Ll9fb3JpZ2luYWxTY2FsZTsKICAgIGN0eC50cmFuc2xhdGUgPSBjdHguX19vcmlnaW5hbFRyYW5zbGF0ZTsKICAgIGN0eC50cmFuc2Zvcm0gPSBjdHguX19vcmlnaW5hbFRyYW5zZm9ybTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0gPSBjdHguX19vcmlnaW5hbFNldFRyYW5zZm9ybTsKICAgIGN0eC5yZXNldFRyYW5zZm9ybSA9IGN0eC5fX29yaWdpbmFsUmVzZXRUcmFuc2Zvcm07CiAgICBjdHguY2xpcCA9IGN0eC5fX29yaWdpbmFsQ2xpcDsKICAgIGN0eC5tb3ZlVG8gPSBjdHguX19vcmlnaW5hbE1vdmVUbzsKICAgIGN0eC5saW5lVG8gPSBjdHguX19vcmlnaW5hbExpbmVUbzsKICAgIGN0eC5iZXppZXJDdXJ2ZVRvID0gY3R4Ll9fb3JpZ2luYWxCZXppZXJDdXJ2ZVRvOwogICAgY3R4LnJlY3QgPSBjdHguX19vcmlnaW5hbFJlY3Q7CiAgICBjdHguY2xvc2VQYXRoID0gY3R4Ll9fb3JpZ2luYWxDbG9zZVBhdGg7CiAgICBjdHguYmVnaW5QYXRoID0gY3R4Ll9fb3JpZ2luYWxCZWdpblBhdGg7CiAgICBkZWxldGUgY3R4Ll9yZW1vdmVNaXJyb3Jpbmc7CiAgfTsKICBjdHguc2F2ZSA9IGZ1bmN0aW9uKCkgewogICAgZGVzdEN0eC5zYXZlKCk7CiAgICB0aGlzLl9fb3JpZ2luYWxTYXZlKCk7CiAgfTsKICBjdHgucmVzdG9yZSA9IGZ1bmN0aW9uKCkgewogICAgZGVzdEN0eC5yZXN0b3JlKCk7CiAgICB0aGlzLl9fb3JpZ2luYWxSZXN0b3JlKCk7CiAgfTsKICBjdHgudHJhbnNsYXRlID0gZnVuY3Rpb24oeCwgeSkgewogICAgZGVzdEN0eC50cmFuc2xhdGUoeCwgeSk7CiAgICB0aGlzLl9fb3JpZ2luYWxUcmFuc2xhdGUoeCwgeSk7CiAgfTsKICBjdHguc2NhbGUgPSBmdW5jdGlvbih4LCB5KSB7CiAgICBkZXN0Q3R4LnNjYWxlKHgsIHkpOwogICAgdGhpcy5fX29yaWdpbmFsU2NhbGUoeCwgeSk7CiAgfTsKICBjdHgudHJhbnNmb3JtID0gZnVuY3Rpb24oYSwgYiwgYywgZCwgZSwgZikgewogICAgZGVzdEN0eC50cmFuc2Zvcm0oYSwgYiwgYywgZCwgZSwgZik7CiAgICB0aGlzLl9fb3JpZ2luYWxUcmFuc2Zvcm0oYSwgYiwgYywgZCwgZSwgZik7CiAgfTsKICBjdHguc2V0VHJhbnNmb3JtID0gZnVuY3Rpb24oYSwgYiwgYywgZCwgZSwgZikgewogICAgZGVzdEN0eC5zZXRUcmFuc2Zvcm0oYSwgYiwgYywgZCwgZSwgZik7CiAgICB0aGlzLl9fb3JpZ2luYWxTZXRUcmFuc2Zvcm0oYSwgYiwgYywgZCwgZSwgZik7CiAgfTsKICBjdHgucmVzZXRUcmFuc2Zvcm0gPSBmdW5jdGlvbigpIHsKICAgIGRlc3RDdHgucmVzZXRUcmFuc2Zvcm0oKTsKICAgIHRoaXMuX19vcmlnaW5hbFJlc2V0VHJhbnNmb3JtKCk7CiAgfTsKICBjdHgucm90YXRlID0gZnVuY3Rpb24oYW5nbGUpIHsKICAgIGRlc3RDdHgucm90YXRlKGFuZ2xlKTsKICAgIHRoaXMuX19vcmlnaW5hbFJvdGF0ZShhbmdsZSk7CiAgfTsKICBjdHguY2xpcCA9IGZ1bmN0aW9uKHJ1bGUpIHsKICAgIGRlc3RDdHguY2xpcChydWxlKTsKICAgIHRoaXMuX19vcmlnaW5hbENsaXAocnVsZSk7CiAgfTsKICBjdHgubW92ZVRvID0gZnVuY3Rpb24oeCwgeSkgewogICAgZGVzdEN0eC5tb3ZlVG8oeCwgeSk7CiAgICB0aGlzLl9fb3JpZ2luYWxNb3ZlVG8oeCwgeSk7CiAgfTsKICBjdHgubGluZVRvID0gZnVuY3Rpb24oeCwgeSkgewogICAgZGVzdEN0eC5saW5lVG8oeCwgeSk7CiAgICB0aGlzLl9fb3JpZ2luYWxMaW5lVG8oeCwgeSk7CiAgfTsKICBjdHguYmV6aWVyQ3VydmVUbyA9IGZ1bmN0aW9uKGNwMXgsIGNwMXksIGNwMngsIGNwMnksIHgsIHkpIHsKICAgIGRlc3RDdHguYmV6aWVyQ3VydmVUbyhjcDF4LCBjcDF5LCBjcDJ4LCBjcDJ5LCB4LCB5KTsKICAgIHRoaXMuX19vcmlnaW5hbEJlemllckN1cnZlVG8oY3AxeCwgY3AxeSwgY3AyeCwgY3AyeSwgeCwgeSk7CiAgfTsKICBjdHgucmVjdCA9IGZ1bmN0aW9uKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKICAgIGRlc3RDdHgucmVjdCh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKICAgIHRoaXMuX19vcmlnaW5hbFJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CiAgfTsKICBjdHguY2xvc2VQYXRoID0gZnVuY3Rpb24oKSB7CiAgICBkZXN0Q3R4LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fX29yaWdpbmFsQ2xvc2VQYXRoKCk7CiAgfTsKICBjdHguYmVnaW5QYXRoID0gZnVuY3Rpb24oKSB7CiAgICBkZXN0Q3R4LmJlZ2luUGF0aCgpOwogICAgdGhpcy5fX29yaWdpbmFsQmVnaW5QYXRoKCk7CiAgfTsKfQp2YXIgQ2FjaGVkQ2FudmFzZXMgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY2FudmFzRmFjdG9yeSkgewogICAgdGhpcy5jYW52YXNGYWN0b3J5ID0gY2FudmFzRmFjdG9yeTsKICAgIHRoaXMuY2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9CiAgZ2V0Q2FudmFzKGlkLCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBsZXQgY2FudmFzRW50cnk7CiAgICBpZiAodGhpcy5jYWNoZVtpZF0gIT09IHZvaWQgMCkgewogICAgICBjYW52YXNFbnRyeSA9IHRoaXMuY2FjaGVbaWRdOwogICAgICB0aGlzLmNhbnZhc0ZhY3RvcnkucmVzZXQoY2FudmFzRW50cnksIHdpZHRoLCBoZWlnaHQpOwogICAgfSBlbHNlIHsKICAgICAgY2FudmFzRW50cnkgPSB0aGlzLmNhbnZhc0ZhY3RvcnkuY3JlYXRlKHdpZHRoLCBoZWlnaHQpOwogICAgICB0aGlzLmNhY2hlW2lkXSA9IGNhbnZhc0VudHJ5OwogICAgfQogICAgcmV0dXJuIGNhbnZhc0VudHJ5OwogIH0KICBkZWxldGUoaWQpIHsKICAgIGRlbGV0ZSB0aGlzLmNhY2hlW2lkXTsKICB9CiAgY2xlYXIoKSB7CiAgICBmb3IgKGNvbnN0IGlkIGluIHRoaXMuY2FjaGUpIHsKICAgICAgY29uc3QgY2FudmFzRW50cnkgPSB0aGlzLmNhY2hlW2lkXTsKICAgICAgdGhpcy5jYW52YXNGYWN0b3J5LmRlc3Ryb3koY2FudmFzRW50cnkpOwogICAgICBkZWxldGUgdGhpcy5jYWNoZVtpZF07CiAgICB9CiAgfQp9OwpmdW5jdGlvbiBkcmF3SW1hZ2VBdEludGVnZXJDb29yZHMoY3R4LCBzcmNJbWcsIHNyY1gsIHNyY1ksIHNyY1csIHNyY0gsIGRlc3RYLCBkZXN0WSwgZGVzdFcsIGRlc3RIKSB7CiAgY29uc3QgW2EsIGIsIGMsIGQsIHR4LCB0eV0gPSBnZXRDdXJyZW50VHJhbnNmb3JtKGN0eCk7CiAgaWYgKGIgPT09IDAgJiYgYyA9PT0gMCkgewogICAgY29uc3QgdGxYID0gZGVzdFggKiBhICsgdHg7CiAgICBjb25zdCByVGxYID0gTWF0aC5yb3VuZCh0bFgpOwogICAgY29uc3QgdGxZID0gZGVzdFkgKiBkICsgdHk7CiAgICBjb25zdCByVGxZID0gTWF0aC5yb3VuZCh0bFkpOwogICAgY29uc3QgYnJYID0gKGRlc3RYICsgZGVzdFcpICogYSArIHR4OwogICAgY29uc3QgcldpZHRoID0gTWF0aC5hYnMoTWF0aC5yb3VuZChiclgpIC0gclRsWCkgfHwgMTsKICAgIGNvbnN0IGJyWSA9IChkZXN0WSArIGRlc3RIKSAqIGQgKyB0eTsKICAgIGNvbnN0IHJIZWlnaHQgPSBNYXRoLmFicyhNYXRoLnJvdW5kKGJyWSkgLSByVGxZKSB8fCAxOwogICAgY3R4LnNldFRyYW5zZm9ybShNYXRoLnNpZ24oYSksIDAsIDAsIE1hdGguc2lnbihkKSwgclRsWCwgclRsWSk7CiAgICBjdHguZHJhd0ltYWdlKHNyY0ltZywgc3JjWCwgc3JjWSwgc3JjVywgc3JjSCwgMCwgMCwgcldpZHRoLCBySGVpZ2h0KTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oYSwgYiwgYywgZCwgdHgsIHR5KTsKICAgIHJldHVybiBbcldpZHRoLCBySGVpZ2h0XTsKICB9CiAgaWYgKGEgPT09IDAgJiYgZCA9PT0gMCkgewogICAgY29uc3QgdGxYID0gZGVzdFkgKiBjICsgdHg7CiAgICBjb25zdCByVGxYID0gTWF0aC5yb3VuZCh0bFgpOwogICAgY29uc3QgdGxZID0gZGVzdFggKiBiICsgdHk7CiAgICBjb25zdCByVGxZID0gTWF0aC5yb3VuZCh0bFkpOwogICAgY29uc3QgYnJYID0gKGRlc3RZICsgZGVzdEgpICogYyArIHR4OwogICAgY29uc3QgcldpZHRoID0gTWF0aC5hYnMoTWF0aC5yb3VuZChiclgpIC0gclRsWCkgfHwgMTsKICAgIGNvbnN0IGJyWSA9IChkZXN0WCArIGRlc3RXKSAqIGIgKyB0eTsKICAgIGNvbnN0IHJIZWlnaHQgPSBNYXRoLmFicyhNYXRoLnJvdW5kKGJyWSkgLSByVGxZKSB8fCAxOwogICAgY3R4LnNldFRyYW5zZm9ybSgwLCBNYXRoLnNpZ24oYiksIE1hdGguc2lnbihjKSwgMCwgclRsWCwgclRsWSk7CiAgICBjdHguZHJhd0ltYWdlKHNyY0ltZywgc3JjWCwgc3JjWSwgc3JjVywgc3JjSCwgMCwgMCwgckhlaWdodCwgcldpZHRoKTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oYSwgYiwgYywgZCwgdHgsIHR5KTsKICAgIHJldHVybiBbckhlaWdodCwgcldpZHRoXTsKICB9CiAgY3R4LmRyYXdJbWFnZShzcmNJbWcsIHNyY1gsIHNyY1ksIHNyY1csIHNyY0gsIGRlc3RYLCBkZXN0WSwgZGVzdFcsIGRlc3RIKTsKICBjb25zdCBzY2FsZVggPSBNYXRoLmh5cG90KGEsIGIpOwogIGNvbnN0IHNjYWxlWSA9IE1hdGguaHlwb3QoYywgZCk7CiAgcmV0dXJuIFtzY2FsZVggKiBkZXN0Vywgc2NhbGVZICogZGVzdEhdOwp9CnZhciBDYW52YXNFeHRyYVN0YXRlID0gY2xhc3MgewogIGFscGhhSXNTaGFwZSA9IGZhbHNlOwogIGZvbnRTaXplID0gMDsKICBmb250U2l6ZVNjYWxlID0gMTsKICB0ZXh0TWF0cml4ID0gbnVsbDsKICB0ZXh0TWF0cml4U2NhbGUgPSAxOwogIGZvbnRNYXRyaXggPSBGT05UX0lERU5USVRZX01BVFJJWDsKICBsZWFkaW5nID0gMDsKICB4ID0gMDsKICB5ID0gMDsKICBsaW5lWCA9IDA7CiAgbGluZVkgPSAwOwogIGNoYXJTcGFjaW5nID0gMDsKICB3b3JkU3BhY2luZyA9IDA7CiAgdGV4dEhTY2FsZSA9IDE7CiAgdGV4dFJlbmRlcmluZ01vZGUgPSBUZXh0UmVuZGVyaW5nTW9kZS5GSUxMOwogIHRleHRSaXNlID0gMDsKICBmaWxsQ29sb3IgPSAiIzAwMDAwMCI7CiAgc3Ryb2tlQ29sb3IgPSAiIzAwMDAwMCI7CiAgcGF0dGVybkZpbGwgPSBmYWxzZTsKICBwYXR0ZXJuU3Ryb2tlID0gZmFsc2U7CiAgZmlsbEFscGhhID0gMTsKICBzdHJva2VBbHBoYSA9IDE7CiAgbGluZVdpZHRoID0gMTsKICBhY3RpdmVTTWFzayA9IG51bGw7CiAgdHJhbnNmZXJNYXBzID0gIm5vbmUiOwogIGNvbnN0cnVjdG9yKHdpZHRoLCBoZWlnaHQsIHByZUluaXQpIHsKICAgIHByZUluaXQ/Lih0aGlzKTsKICAgIHRoaXMuY2xpcEJveCA9IG5ldyBGbG9hdDMyQXJyYXkoWzAsIDAsIHdpZHRoLCBoZWlnaHRdKTsKICAgIHRoaXMubWluTWF4ID0gTUlOX01BWF9JTklULnNsaWNlKCk7CiAgfQogIGNsb25lKCkgewogICAgY29uc3QgY2xvbmUgPSBPYmplY3QuY3JlYXRlKHRoaXMpOwogICAgY2xvbmUuY2xpcEJveCA9IHRoaXMuY2xpcEJveC5zbGljZSgpOwogICAgY2xvbmUubWluTWF4ID0gdGhpcy5taW5NYXguc2xpY2UoKTsKICAgIHJldHVybiBjbG9uZTsKICB9CiAgZ2V0UGF0aEJvdW5kaW5nQm94KHBhdGhUeXBlID0gUGF0aFR5cGUuRklMTCwgdHJhbnNmb3JtID0gbnVsbCkgewogICAgY29uc3QgYm94ID0gdGhpcy5taW5NYXguc2xpY2UoKTsKICAgIGlmIChwYXRoVHlwZSA9PT0gUGF0aFR5cGUuU1RST0tFKSB7CiAgICAgIGlmICghdHJhbnNmb3JtKSB7CiAgICAgICAgdW5yZWFjaGFibGUoIlN0cm9rZSBib3VuZGluZyBib3ggbXVzdCBpbmNsdWRlIHRyYW5zZm9ybS4iKTsKICAgICAgfQogICAgICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKHRyYW5zZm9ybSwgWFkpOwogICAgICBjb25zdCB4U3Ryb2tlUGFkID0gWFlbMF0gKiB0aGlzLmxpbmVXaWR0aCAvIDI7CiAgICAgIGNvbnN0IHlTdHJva2VQYWQgPSBYWVsxXSAqIHRoaXMubGluZVdpZHRoIC8gMjsKICAgICAgYm94WzBdIC09IHhTdHJva2VQYWQ7CiAgICAgIGJveFsxXSAtPSB5U3Ryb2tlUGFkOwogICAgICBib3hbMl0gKz0geFN0cm9rZVBhZDsKICAgICAgYm94WzNdICs9IHlTdHJva2VQYWQ7CiAgICB9CiAgICByZXR1cm4gYm94OwogIH0KICB1cGRhdGVDbGlwRnJvbVBhdGgoKSB7CiAgICBjb25zdCBpbnRlcnNlY3QgPSBVdGlsLmludGVyc2VjdCh0aGlzLmNsaXBCb3gsIHRoaXMuZ2V0UGF0aEJvdW5kaW5nQm94KCkpOwogICAgdGhpcy5zdGFydE5ld1BhdGhBbmRDbGlwQm94KGludGVyc2VjdCB8fCBbMCwgMCwgMCwgMF0pOwogIH0KICBpc0VtcHR5Q2xpcCgpIHsKICAgIHJldHVybiB0aGlzLm1pbk1heFswXSA9PT0gSW5maW5pdHk7CiAgfQogIHN0YXJ0TmV3UGF0aEFuZENsaXBCb3goYm94KSB7CiAgICB0aGlzLmNsaXBCb3guc2V0KGJveCwgMCk7CiAgICB0aGlzLm1pbk1heC5zZXQoTUlOX01BWF9JTklULCAwKTsKICB9CiAgZ2V0Q2xpcHBlZFBhdGhCb3VuZGluZ0JveChwYXRoVHlwZSA9IFBhdGhUeXBlLkZJTEwsIHRyYW5zZm9ybSA9IG51bGwpIHsKICAgIHJldHVybiBVdGlsLmludGVyc2VjdCh0aGlzLmNsaXBCb3gsIHRoaXMuZ2V0UGF0aEJvdW5kaW5nQm94KHBhdGhUeXBlLCB0cmFuc2Zvcm0pKTsKICB9Cn07CmZ1bmN0aW9uIHB1dEJpbmFyeUltYWdlRGF0YShjdHgsIGltZ0RhdGEpIHsKICBpZiAoaW1nRGF0YSBpbnN0YW5jZW9mIEltYWdlRGF0YSkgewogICAgY3R4LnB1dEltYWdlRGF0YShpbWdEYXRhLCAwLCAwKTsKICAgIHJldHVybjsKICB9CiAgY29uc3QgaGVpZ2h0ID0gaW1nRGF0YS5oZWlnaHQsIHdpZHRoID0gaW1nRGF0YS53aWR0aDsKICBjb25zdCBwYXJ0aWFsQ2h1bmtIZWlnaHQgPSBoZWlnaHQgJSBGVUxMX0NIVU5LX0hFSUdIVDsKICBjb25zdCBmdWxsQ2h1bmtzID0gKGhlaWdodCAtIHBhcnRpYWxDaHVua0hlaWdodCkgLyBGVUxMX0NIVU5LX0hFSUdIVDsKICBjb25zdCB0b3RhbENodW5rcyA9IHBhcnRpYWxDaHVua0hlaWdodCA9PT0gMCA/IGZ1bGxDaHVua3MgOiBmdWxsQ2h1bmtzICsgMTsKICBjb25zdCBjaHVua0ltZ0RhdGEgPSBjdHguY3JlYXRlSW1hZ2VEYXRhKHdpZHRoLCBGVUxMX0NIVU5LX0hFSUdIVCk7CiAgbGV0IHNyY1BvcyA9IDAsIGRlc3RQb3M7CiAgY29uc3Qgc3JjID0gaW1nRGF0YS5kYXRhOwogIGNvbnN0IGRlc3QgPSBjaHVua0ltZ0RhdGEuZGF0YTsKICBsZXQgaSwgaiwgdGhpc0NodW5rSGVpZ2h0LCBlbGVtc0luVGhpc0NodW5rOwogIGlmIChpbWdEYXRhLmtpbmQgPT09IHV0aWxfSW1hZ2VLaW5kLkdSQVlTQ0FMRV8xQlBQKSB7CiAgICBjb25zdCBzcmNMZW5ndGggPSBzcmMuYnl0ZUxlbmd0aDsKICAgIGNvbnN0IGRlc3QzMiA9IG5ldyBVaW50MzJBcnJheShkZXN0LmJ1ZmZlciwgMCwgZGVzdC5ieXRlTGVuZ3RoID4+IDIpOwogICAgY29uc3QgZGVzdDMyRGF0YUxlbmd0aCA9IGRlc3QzMi5sZW5ndGg7CiAgICBjb25zdCBmdWxsU3JjRGlmZiA9IHdpZHRoICsgNyA+PiAzOwogICAgY29uc3Qgd2hpdGUgPSA0Mjk0OTY3Mjk1OwogICAgY29uc3QgYmxhY2sgPSB1dGlsX0ZlYXR1cmVUZXN0LmlzTGl0dGxlRW5kaWFuID8gNDI3ODE5MDA4MCA6IDI1NTsKICAgIGZvciAoaSA9IDA7IGkgPCB0b3RhbENodW5rczsgaSsrKSB7CiAgICAgIHRoaXNDaHVua0hlaWdodCA9IGkgPCBmdWxsQ2h1bmtzID8gRlVMTF9DSFVOS19IRUlHSFQgOiBwYXJ0aWFsQ2h1bmtIZWlnaHQ7CiAgICAgIGRlc3RQb3MgPSAwOwogICAgICBmb3IgKGogPSAwOyBqIDwgdGhpc0NodW5rSGVpZ2h0OyBqKyspIHsKICAgICAgICBjb25zdCBzcmNEaWZmID0gc3JjTGVuZ3RoIC0gc3JjUG9zOwogICAgICAgIGxldCBrID0gMDsKICAgICAgICBjb25zdCBrRW5kID0gc3JjRGlmZiA+IGZ1bGxTcmNEaWZmID8gd2lkdGggOiBzcmNEaWZmICogOCAtIDc7CiAgICAgICAgY29uc3Qga0VuZFVucm9sbGVkID0ga0VuZCAmIH43OwogICAgICAgIGxldCBtYXNrID0gMDsKICAgICAgICBsZXQgc3JjQnl0ZSA9IDA7CiAgICAgICAgZm9yICg7IGsgPCBrRW5kVW5yb2xsZWQ7IGsgKz0gOCkgewogICAgICAgICAgc3JjQnl0ZSA9IHNyY1tzcmNQb3MrK107CiAgICAgICAgICBkZXN0MzJbZGVzdFBvcysrXSA9IHNyY0J5dGUgJiAxMjggPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSBzcmNCeXRlICYgNjQgPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSBzcmNCeXRlICYgMzIgPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSBzcmNCeXRlICYgMTYgPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSBzcmNCeXRlICYgOCA/IHdoaXRlIDogYmxhY2s7CiAgICAgICAgICBkZXN0MzJbZGVzdFBvcysrXSA9IHNyY0J5dGUgJiA0ID8gd2hpdGUgOiBibGFjazsKICAgICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gc3JjQnl0ZSAmIDIgPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSBzcmNCeXRlICYgMSA/IHdoaXRlIDogYmxhY2s7CiAgICAgICAgfQogICAgICAgIGZvciAoOyBrIDwga0VuZDsgaysrKSB7CiAgICAgICAgICBpZiAobWFzayA9PT0gMCkgewogICAgICAgICAgICBzcmNCeXRlID0gc3JjW3NyY1BvcysrXTsKICAgICAgICAgICAgbWFzayA9IDEyODsKICAgICAgICAgIH0KICAgICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gc3JjQnl0ZSAmIG1hc2sgPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgICAgbWFzayA+Pj0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKGRlc3RQb3MgPCBkZXN0MzJEYXRhTGVuZ3RoKSB7CiAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSAwOwogICAgICB9CiAgICAgIGN0eC5wdXRJbWFnZURhdGEoY2h1bmtJbWdEYXRhLCAwLCBpICogRlVMTF9DSFVOS19IRUlHSFQpOwogICAgfQogIH0gZWxzZSBpZiAoaW1nRGF0YS5raW5kID09PSB1dGlsX0ltYWdlS2luZC5SR0JBXzMyQlBQKSB7CiAgICBqID0gMDsKICAgIGVsZW1zSW5UaGlzQ2h1bmsgPSB3aWR0aCAqIEZVTExfQ0hVTktfSEVJR0hUICogNDsKICAgIGZvciAoaSA9IDA7IGkgPCBmdWxsQ2h1bmtzOyBpKyspIHsKICAgICAgZGVzdC5zZXQoc3JjLnN1YmFycmF5KHNyY1Bvcywgc3JjUG9zICsgZWxlbXNJblRoaXNDaHVuaykpOwogICAgICBzcmNQb3MgKz0gZWxlbXNJblRoaXNDaHVuazsKICAgICAgY3R4LnB1dEltYWdlRGF0YShjaHVua0ltZ0RhdGEsIDAsIGopOwogICAgICBqICs9IEZVTExfQ0hVTktfSEVJR0hUOwogICAgfQogICAgaWYgKGkgPCB0b3RhbENodW5rcykgewogICAgICBlbGVtc0luVGhpc0NodW5rID0gd2lkdGggKiBwYXJ0aWFsQ2h1bmtIZWlnaHQgKiA0OwogICAgICBkZXN0LnNldChzcmMuc3ViYXJyYXkoc3JjUG9zLCBzcmNQb3MgKyBlbGVtc0luVGhpc0NodW5rKSk7CiAgICAgIGN0eC5wdXRJbWFnZURhdGEoY2h1bmtJbWdEYXRhLCAwLCBqKTsKICAgIH0KICB9IGVsc2UgaWYgKGltZ0RhdGEua2luZCA9PT0gdXRpbF9JbWFnZUtpbmQuUkdCXzI0QlBQKSB7CiAgICB0aGlzQ2h1bmtIZWlnaHQgPSBGVUxMX0NIVU5LX0hFSUdIVDsKICAgIGVsZW1zSW5UaGlzQ2h1bmsgPSB3aWR0aCAqIHRoaXNDaHVua0hlaWdodDsKICAgIGZvciAoaSA9IDA7IGkgPCB0b3RhbENodW5rczsgaSsrKSB7CiAgICAgIGlmIChpID49IGZ1bGxDaHVua3MpIHsKICAgICAgICB0aGlzQ2h1bmtIZWlnaHQgPSBwYXJ0aWFsQ2h1bmtIZWlnaHQ7CiAgICAgICAgZWxlbXNJblRoaXNDaHVuayA9IHdpZHRoICogdGhpc0NodW5rSGVpZ2h0OwogICAgICB9CiAgICAgIGRlc3RQb3MgPSAwOwogICAgICBmb3IgKGogPSBlbGVtc0luVGhpc0NodW5rOyBqLS07ICkgewogICAgICAgIGRlc3RbZGVzdFBvcysrXSA9IHNyY1tzcmNQb3MrK107CiAgICAgICAgZGVzdFtkZXN0UG9zKytdID0gc3JjW3NyY1BvcysrXTsKICAgICAgICBkZXN0W2Rlc3RQb3MrK10gPSBzcmNbc3JjUG9zKytdOwogICAgICAgIGRlc3RbZGVzdFBvcysrXSA9IDI1NTsKICAgICAgfQogICAgICBjdHgucHV0SW1hZ2VEYXRhKGNodW5rSW1nRGF0YSwgMCwgaSAqIEZVTExfQ0hVTktfSEVJR0hUKTsKICAgIH0KICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKGBiYWQgaW1hZ2Uga2luZDogJHtpbWdEYXRhLmtpbmR9YCk7CiAgfQp9CmZ1bmN0aW9uIHB1dEJpbmFyeUltYWdlTWFzayhjdHgsIGltZ0RhdGEpIHsKICBpZiAoaW1nRGF0YS5iaXRtYXApIHsKICAgIGN0eC5kcmF3SW1hZ2UoaW1nRGF0YS5iaXRtYXAsIDAsIDApOwogICAgcmV0dXJuOwogIH0KICBjb25zdCBoZWlnaHQgPSBpbWdEYXRhLmhlaWdodCwgd2lkdGggPSBpbWdEYXRhLndpZHRoOwogIGNvbnN0IHBhcnRpYWxDaHVua0hlaWdodCA9IGhlaWdodCAlIEZVTExfQ0hVTktfSEVJR0hUOwogIGNvbnN0IGZ1bGxDaHVua3MgPSAoaGVpZ2h0IC0gcGFydGlhbENodW5rSGVpZ2h0KSAvIEZVTExfQ0hVTktfSEVJR0hUOwogIGNvbnN0IHRvdGFsQ2h1bmtzID0gcGFydGlhbENodW5rSGVpZ2h0ID09PSAwID8gZnVsbENodW5rcyA6IGZ1bGxDaHVua3MgKyAxOwogIGNvbnN0IGNodW5rSW1nRGF0YSA9IGN0eC5jcmVhdGVJbWFnZURhdGEod2lkdGgsIEZVTExfQ0hVTktfSEVJR0hUKTsKICBsZXQgc3JjUG9zID0gMDsKICBjb25zdCBzcmMgPSBpbWdEYXRhLmRhdGE7CiAgY29uc3QgZGVzdCA9IGNodW5rSW1nRGF0YS5kYXRhOwogIGZvciAobGV0IGkgPSAwOyBpIDwgdG90YWxDaHVua3M7IGkrKykgewogICAgY29uc3QgdGhpc0NodW5rSGVpZ2h0ID0gaSA8IGZ1bGxDaHVua3MgPyBGVUxMX0NIVU5LX0hFSUdIVCA6IHBhcnRpYWxDaHVua0hlaWdodDsKICAgICh7CiAgICAgIHNyY1BvcwogICAgfSA9IGNvbnZlcnRCbGFja0FuZFdoaXRlVG9SR0JBKHsKICAgICAgc3JjLAogICAgICBzcmNQb3MsCiAgICAgIGRlc3QsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQ6IHRoaXNDaHVua0hlaWdodCwKICAgICAgbm9uQmxhY2tDb2xvcjogMAogICAgfSkpOwogICAgY3R4LnB1dEltYWdlRGF0YShjaHVua0ltZ0RhdGEsIDAsIGkgKiBGVUxMX0NIVU5LX0hFSUdIVCk7CiAgfQp9CmZ1bmN0aW9uIGNvcHlDdHhTdGF0ZShzb3VyY2VDdHgsIGRlc3RDdHgpIHsKICBjb25zdCBwcm9wZXJ0aWVzID0gWyJzdHJva2VTdHlsZSIsICJmaWxsU3R5bGUiLCAiZmlsbFJ1bGUiLCAiZ2xvYmFsQWxwaGEiLCAibGluZVdpZHRoIiwgImxpbmVDYXAiLCAibGluZUpvaW4iLCAibWl0ZXJMaW1pdCIsICJnbG9iYWxDb21wb3NpdGVPcGVyYXRpb24iLCAiZm9udCIsICJmaWx0ZXIiXTsKICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIHByb3BlcnRpZXMpIHsKICAgIGlmIChzb3VyY2VDdHhbcHJvcGVydHldICE9PSB2b2lkIDApIHsKICAgICAgZGVzdEN0eFtwcm9wZXJ0eV0gPSBzb3VyY2VDdHhbcHJvcGVydHldOwogICAgfQogIH0KICBpZiAoc291cmNlQ3R4LnNldExpbmVEYXNoICE9PSB2b2lkIDApIHsKICAgIGRlc3RDdHguc2V0TGluZURhc2goc291cmNlQ3R4LmdldExpbmVEYXNoKCkpOwogICAgZGVzdEN0eC5saW5lRGFzaE9mZnNldCA9IHNvdXJjZUN0eC5saW5lRGFzaE9mZnNldDsKICB9Cn0KZnVuY3Rpb24gcmVzZXRDdHhUb0RlZmF1bHQoY3R4KSB7CiAgY3R4LnN0cm9rZVN0eWxlID0gY3R4LmZpbGxTdHlsZSA9ICIjMDAwMDAwIjsKICBjdHguZmlsbFJ1bGUgPSAibm9uemVybyI7CiAgY3R4Lmdsb2JhbEFscGhhID0gMTsKICBjdHgubGluZVdpZHRoID0gMTsKICBjdHgubGluZUNhcCA9ICJidXR0IjsKICBjdHgubGluZUpvaW4gPSAibWl0ZXIiOwogIGN0eC5taXRlckxpbWl0ID0gMTA7CiAgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJzb3VyY2Utb3ZlciI7CiAgY3R4LmZvbnQgPSAiMTBweCBzYW5zLXNlcmlmIjsKICBpZiAoY3R4LnNldExpbmVEYXNoICE9PSB2b2lkIDApIHsKICAgIGN0eC5zZXRMaW5lRGFzaChbXSk7CiAgICBjdHgubGluZURhc2hPZmZzZXQgPSAwOwogIH0KICBjb25zdCB7CiAgICBmaWx0ZXIKICB9ID0gY3R4OwogIGlmIChmaWx0ZXIgIT09ICJub25lIiAmJiBmaWx0ZXIgIT09ICIiKSB7CiAgICBjdHguZmlsdGVyID0gIm5vbmUiOwogIH0KfQpmdW5jdGlvbiBnZXRJbWFnZVNtb290aGluZ0VuYWJsZWQodHJhbnNmb3JtLCBpbnRlcnBvbGF0ZSkgewogIGlmIChpbnRlcnBvbGF0ZSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIFV0aWwuc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUodHJhbnNmb3JtLCBYWSk7CiAgY29uc3QgYWN0dWFsU2NhbGUgPSBNYXRoLmZyb3VuZChPdXRwdXRTY2FsZS5waXhlbFJhdGlvICogUGl4ZWxzUGVySW5jaC5QREZfVE9fQ1NTX1VOSVRTKTsKICByZXR1cm4gWFlbMF0gPD0gYWN0dWFsU2NhbGUgJiYgWFlbMV0gPD0gYWN0dWFsU2NhbGU7Cn0KdmFyIExJTkVfQ0FQX1NUWUxFUyA9IFsiYnV0dCIsICJyb3VuZCIsICJzcXVhcmUiXTsKdmFyIExJTkVfSk9JTl9TVFlMRVMgPSBbIm1pdGVyIiwgInJvdW5kIiwgImJldmVsIl07CnZhciBOT1JNQUxfQ0xJUCA9IHt9Owp2YXIgRU9fQ0xJUCA9IHt9Owp2YXIgQ2FudmFzR3JhcGhpY3MgPSBjbGFzcyBfQ2FudmFzR3JhcGhpY3MgewogIGNvbnN0cnVjdG9yKGNhbnZhc0N0eCwgY29tbW9uT2Jqcywgb2JqcywgY2FudmFzRmFjdG9yeSwgZmlsdGVyRmFjdG9yeSwgewogICAgb3B0aW9uYWxDb250ZW50Q29uZmlnLAogICAgbWFya2VkQ29udGVudFN0YWNrID0gbnVsbAogIH0sIGFubm90YXRpb25DYW52YXNNYXAsIHBhZ2VDb2xvcnMsIGRlcGVuZGVuY3lUcmFja2VyKSB7CiAgICB0aGlzLmN0eCA9IGNhbnZhc0N0eDsKICAgIHRoaXMuY3VycmVudCA9IG5ldyBDYW52YXNFeHRyYVN0YXRlKHRoaXMuY3R4LmNhbnZhcy53aWR0aCwgdGhpcy5jdHguY2FudmFzLmhlaWdodCk7CiAgICB0aGlzLnN0YXRlU3RhY2sgPSBbXTsKICAgIHRoaXMucGVuZGluZ0NsaXAgPSBudWxsOwogICAgdGhpcy5wZW5kaW5nRU9GaWxsID0gZmFsc2U7CiAgICB0aGlzLnJlcyA9IG51bGw7CiAgICB0aGlzLnhvYmpzID0gbnVsbDsKICAgIHRoaXMuY29tbW9uT2JqcyA9IGNvbW1vbk9ianM7CiAgICB0aGlzLm9ianMgPSBvYmpzOwogICAgdGhpcy5jYW52YXNGYWN0b3J5ID0gY2FudmFzRmFjdG9yeTsKICAgIHRoaXMuZmlsdGVyRmFjdG9yeSA9IGZpbHRlckZhY3Rvcnk7CiAgICB0aGlzLmdyb3VwU3RhY2sgPSBbXTsKICAgIHRoaXMuYmFzZVRyYW5zZm9ybSA9IG51bGw7CiAgICB0aGlzLmJhc2VUcmFuc2Zvcm1TdGFjayA9IFtdOwogICAgdGhpcy5ncm91cExldmVsID0gMDsKICAgIHRoaXMuc21hc2tTdGFjayA9IFtdOwogICAgdGhpcy5zbWFza0NvdW50ZXIgPSAwOwogICAgdGhpcy50ZW1wU01hc2sgPSBudWxsOwogICAgdGhpcy5zdXNwZW5kZWRDdHggPSBudWxsOwogICAgdGhpcy5jb250ZW50VmlzaWJsZSA9IHRydWU7CiAgICB0aGlzLm1hcmtlZENvbnRlbnRTdGFjayA9IG1hcmtlZENvbnRlbnRTdGFjayB8fCBbXTsKICAgIHRoaXMub3B0aW9uYWxDb250ZW50Q29uZmlnID0gb3B0aW9uYWxDb250ZW50Q29uZmlnOwogICAgdGhpcy5jYWNoZWRDYW52YXNlcyA9IG5ldyBDYWNoZWRDYW52YXNlcyh0aGlzLmNhbnZhc0ZhY3RvcnkpOwogICAgdGhpcy5jYWNoZWRQYXR0ZXJucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLmFubm90YXRpb25DYW52YXNNYXAgPSBhbm5vdGF0aW9uQ2FudmFzTWFwOwogICAgdGhpcy52aWV3cG9ydFNjYWxlID0gMTsKICAgIHRoaXMub3V0cHV0U2NhbGVYID0gMTsKICAgIHRoaXMub3V0cHV0U2NhbGVZID0gMTsKICAgIHRoaXMucGFnZUNvbG9ycyA9IHBhZ2VDb2xvcnM7CiAgICB0aGlzLl9jYWNoZWRTY2FsZUZvclN0cm9raW5nID0gWy0xLCAwXTsKICAgIHRoaXMuX2NhY2hlZEdldFNpbmdsZVBpeGVsV2lkdGggPSBudWxsOwogICAgdGhpcy5fY2FjaGVkQml0bWFwc01hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyID0gZGVwZW5kZW5jeVRyYWNrZXIgPz8gbnVsbDsKICB9CiAgZ2V0T2JqZWN0KG9wSWR4LCBkYXRhLCBmYWxsYmFjayA9IG51bGwpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIpIHsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkTmFtZWREZXBlbmRlbmN5KG9wSWR4LCBkYXRhKTsKICAgICAgcmV0dXJuIGRhdGEuc3RhcnRzV2l0aCgiZ18iKSA/IHRoaXMuY29tbW9uT2Jqcy5nZXQoZGF0YSkgOiB0aGlzLm9ianMuZ2V0KGRhdGEpOwogICAgfQogICAgcmV0dXJuIGZhbGxiYWNrOwogIH0KICBiZWdpbkRyYXdpbmcoewogICAgdHJhbnNmb3JtLAogICAgdmlld3BvcnQsCiAgICB0cmFuc3BhcmVuY3kgPSBmYWxzZSwKICAgIGJhY2tncm91bmQgPSBudWxsCiAgfSkgewogICAgY29uc3Qgd2lkdGggPSB0aGlzLmN0eC5jYW52YXMud2lkdGg7CiAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmN0eC5jYW52YXMuaGVpZ2h0OwogICAgY29uc3Qgc2F2ZWRGaWxsU3R5bGUgPSB0aGlzLmN0eC5maWxsU3R5bGU7CiAgICB0aGlzLmN0eC5maWxsU3R5bGUgPSBiYWNrZ3JvdW5kIHx8ICIjZmZmZmZmIjsKICAgIHRoaXMuY3R4LmZpbGxSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgdGhpcy5jdHguZmlsbFN0eWxlID0gc2F2ZWRGaWxsU3R5bGU7CiAgICBpZiAodHJhbnNwYXJlbmN5KSB7CiAgICAgIGNvbnN0IHRyYW5zcGFyZW50Q2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoInRyYW5zcGFyZW50Iiwgd2lkdGgsIGhlaWdodCk7CiAgICAgIHRoaXMuY29tcG9zaXRlQ3R4ID0gdGhpcy5jdHg7CiAgICAgIHRoaXMudHJhbnNwYXJlbnRDYW52YXMgPSB0cmFuc3BhcmVudENhbnZhcy5jYW52YXM7CiAgICAgIHRoaXMuY3R4ID0gdHJhbnNwYXJlbnRDYW52YXMuY29udGV4dDsKICAgICAgdGhpcy5jdHguc2F2ZSgpOwogICAgICB0aGlzLmN0eC50cmFuc2Zvcm0oLi4uZ2V0Q3VycmVudFRyYW5zZm9ybSh0aGlzLmNvbXBvc2l0ZUN0eCkpOwogICAgfQogICAgdGhpcy5jdHguc2F2ZSgpOwogICAgcmVzZXRDdHhUb0RlZmF1bHQodGhpcy5jdHgpOwogICAgaWYgKHRyYW5zZm9ybSkgewogICAgICB0aGlzLmN0eC50cmFuc2Zvcm0oLi4udHJhbnNmb3JtKTsKICAgICAgdGhpcy5vdXRwdXRTY2FsZVggPSB0cmFuc2Zvcm1bMF07CiAgICAgIHRoaXMub3V0cHV0U2NhbGVZID0gdHJhbnNmb3JtWzBdOwogICAgfQogICAgdGhpcy5jdHgudHJhbnNmb3JtKC4uLnZpZXdwb3J0LnRyYW5zZm9ybSk7CiAgICB0aGlzLnZpZXdwb3J0U2NhbGUgPSB2aWV3cG9ydC5zY2FsZTsKICAgIHRoaXMuYmFzZVRyYW5zZm9ybSA9IGdldEN1cnJlbnRUcmFuc2Zvcm0odGhpcy5jdHgpOwogIH0KICBleGVjdXRlT3BlcmF0b3JMaXN0KG9wZXJhdG9yTGlzdCwgZXhlY3V0aW9uU3RhcnRJZHgsIGNvbnRpbnVlQ2FsbGJhY2ssIHN0ZXBwZXIsIG9wZXJhdGlvbnNGaWx0ZXIpIHsKICAgIGNvbnN0IGFyZ3NBcnJheSA9IG9wZXJhdG9yTGlzdC5hcmdzQXJyYXk7CiAgICBjb25zdCBmbkFycmF5ID0gb3BlcmF0b3JMaXN0LmZuQXJyYXk7CiAgICBsZXQgaSA9IGV4ZWN1dGlvblN0YXJ0SWR4IHx8IDA7CiAgICBjb25zdCBhcmdzQXJyYXlMZW4gPSBhcmdzQXJyYXkubGVuZ3RoOwogICAgaWYgKGFyZ3NBcnJheUxlbiA9PT0gaSkgewogICAgICByZXR1cm4gaTsKICAgIH0KICAgIGNvbnN0IGNodW5rT3BlcmF0aW9ucyA9IGFyZ3NBcnJheUxlbiAtIGkgPiBFWEVDVVRJT05fU1RFUFMgJiYgdHlwZW9mIGNvbnRpbnVlQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiI7CiAgICBjb25zdCBlbmRUaW1lID0gY2h1bmtPcGVyYXRpb25zID8gRGF0ZS5ub3coKSArIEVYRUNVVElPTl9USU1FIDogMDsKICAgIGxldCBzdGVwcyA9IDA7CiAgICBjb25zdCBjb21tb25PYmpzID0gdGhpcy5jb21tb25PYmpzOwogICAgY29uc3Qgb2JqcyA9IHRoaXMub2JqczsKICAgIGxldCBmbklkLCBmbkFyZ3M7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAoc3RlcHBlciAhPT0gdm9pZCAwICYmIGkgPT09IHN0ZXBwZXIubmV4dEJyZWFrUG9pbnQpIHsKICAgICAgICBzdGVwcGVyLmJyZWFrSXQoaSwgY29udGludWVDYWxsYmFjayk7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgICAgaWYgKCFvcGVyYXRpb25zRmlsdGVyIHx8IG9wZXJhdGlvbnNGaWx0ZXIoaSkpIHsKICAgICAgICBmbklkID0gZm5BcnJheVtpXTsKICAgICAgICBmbkFyZ3MgPSBhcmdzQXJyYXlbaV0gPz8gbnVsbDsKICAgICAgICBpZiAoZm5JZCAhPT0gT1BTLmRlcGVuZGVuY3kpIHsKICAgICAgICAgIGlmIChmbkFyZ3MgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhpc1tmbklkXShpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNbZm5JZF0oaSwgLi4uZm5BcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChjb25zdCBkZXBPYmpJZCBvZiBmbkFyZ3MpIHsKICAgICAgICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkTmFtZWREYXRhKGRlcE9iaklkLCBpKTsKICAgICAgICAgICAgY29uc3Qgb2Jqc1Bvb2wgPSBkZXBPYmpJZC5zdGFydHNXaXRoKCJnXyIpID8gY29tbW9uT2JqcyA6IG9ianM7CiAgICAgICAgICAgIGlmICghb2Jqc1Bvb2wuaGFzKGRlcE9iaklkKSkgewogICAgICAgICAgICAgIG9ianNQb29sLmdldChkZXBPYmpJZCwgY29udGludWVDYWxsYmFjayk7CiAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaSsrOwogICAgICBpZiAoaSA9PT0gYXJnc0FycmF5TGVuKSB7CiAgICAgICAgcmV0dXJuIGk7CiAgICAgIH0KICAgICAgaWYgKGNodW5rT3BlcmF0aW9ucyAmJiArK3N0ZXBzID4gRVhFQ1VUSU9OX1NURVBTKSB7CiAgICAgICAgaWYgKERhdGUubm93KCkgPiBlbmRUaW1lKSB7CiAgICAgICAgICBjb250aW51ZUNhbGxiYWNrKCk7CiAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9CiAgICAgICAgc3RlcHMgPSAwOwogICAgICB9CiAgICB9CiAgfQogICNyZXN0b3JlSW5pdGlhbFN0YXRlKCkgewogICAgd2hpbGUgKHRoaXMuc3RhdGVTdGFjay5sZW5ndGggfHwgdGhpcy5pblNNYXNrTW9kZSkgewogICAgICB0aGlzLnJlc3RvcmUoKTsKICAgIH0KICAgIHRoaXMuY3VycmVudC5hY3RpdmVTTWFzayA9IG51bGw7CiAgICB0aGlzLmN0eC5yZXN0b3JlKCk7CiAgICBpZiAodGhpcy50cmFuc3BhcmVudENhbnZhcykgewogICAgICB0aGlzLmN0eCA9IHRoaXMuY29tcG9zaXRlQ3R4OwogICAgICB0aGlzLmN0eC5zYXZlKCk7CiAgICAgIHRoaXMuY3R4LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKICAgICAgdGhpcy5jdHguZHJhd0ltYWdlKHRoaXMudHJhbnNwYXJlbnRDYW52YXMsIDAsIDApOwogICAgICB0aGlzLmN0eC5yZXN0b3JlKCk7CiAgICAgIHRoaXMudHJhbnNwYXJlbnRDYW52YXMgPSBudWxsOwogICAgfQogIH0KICBlbmREcmF3aW5nKCkgewogICAgdGhpcy4jcmVzdG9yZUluaXRpYWxTdGF0ZSgpOwogICAgdGhpcy5jYWNoZWRDYW52YXNlcy5jbGVhcigpOwogICAgdGhpcy5jYWNoZWRQYXR0ZXJucy5jbGVhcigpOwogICAgZm9yIChjb25zdCBjYWNoZSBvZiB0aGlzLl9jYWNoZWRCaXRtYXBzTWFwLnZhbHVlcygpKSB7CiAgICAgIGZvciAoY29uc3QgY2FudmFzIG9mIGNhY2hlLnZhbHVlcygpKSB7CiAgICAgICAgaWYgKHR5cGVvZiBIVE1MQ2FudmFzRWxlbWVudCAhPT0gInVuZGVmaW5lZCIgJiYgY2FudmFzIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQpIHsKICAgICAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5oZWlnaHQgPSAwOwogICAgICAgIH0KICAgICAgfQogICAgICBjYWNoZS5jbGVhcigpOwogICAgfQogICAgdGhpcy5fY2FjaGVkQml0bWFwc01hcC5jbGVhcigpOwogICAgdGhpcy4jZHJhd0ZpbHRlcigpOwogIH0KICAjZHJhd0ZpbHRlcigpIHsKICAgIGlmICh0aGlzLnBhZ2VDb2xvcnMpIHsKICAgICAgY29uc3QgaGNtRmlsdGVySWQgPSB0aGlzLmZpbHRlckZhY3RvcnkuYWRkSENNRmlsdGVyKHRoaXMucGFnZUNvbG9ycy5mb3JlZ3JvdW5kLCB0aGlzLnBhZ2VDb2xvcnMuYmFja2dyb3VuZCk7CiAgICAgIGlmIChoY21GaWx0ZXJJZCAhPT0gIm5vbmUiKSB7CiAgICAgICAgY29uc3Qgc2F2ZWRGaWx0ZXIgPSB0aGlzLmN0eC5maWx0ZXI7CiAgICAgICAgdGhpcy5jdHguZmlsdGVyID0gaGNtRmlsdGVySWQ7CiAgICAgICAgdGhpcy5jdHguZHJhd0ltYWdlKHRoaXMuY3R4LmNhbnZhcywgMCwgMCk7CiAgICAgICAgdGhpcy5jdHguZmlsdGVyID0gc2F2ZWRGaWx0ZXI7CiAgICAgIH0KICAgIH0KICB9CiAgX3NjYWxlSW1hZ2UoaW1nLCBpbnZlcnNlVHJhbnNmb3JtKSB7CiAgICBjb25zdCB3aWR0aCA9IGltZy53aWR0aCA/PyBpbWcuZGlzcGxheVdpZHRoOwogICAgY29uc3QgaGVpZ2h0ID0gaW1nLmhlaWdodCA/PyBpbWcuZGlzcGxheUhlaWdodDsKICAgIGxldCB3aWR0aFNjYWxlID0gTWF0aC5tYXgoTWF0aC5oeXBvdChpbnZlcnNlVHJhbnNmb3JtWzBdLCBpbnZlcnNlVHJhbnNmb3JtWzFdKSwgMSk7CiAgICBsZXQgaGVpZ2h0U2NhbGUgPSBNYXRoLm1heChNYXRoLmh5cG90KGludmVyc2VUcmFuc2Zvcm1bMl0sIGludmVyc2VUcmFuc2Zvcm1bM10pLCAxKTsKICAgIGxldCBwYWludFdpZHRoID0gd2lkdGgsIHBhaW50SGVpZ2h0ID0gaGVpZ2h0OwogICAgbGV0IHRtcENhbnZhc0lkID0gInByZXNjYWxlMSI7CiAgICBsZXQgdG1wQ2FudmFzLCB0bXBDdHg7CiAgICB3aGlsZSAod2lkdGhTY2FsZSA+IDIgJiYgcGFpbnRXaWR0aCA+IDEgfHwgaGVpZ2h0U2NhbGUgPiAyICYmIHBhaW50SGVpZ2h0ID4gMSkgewogICAgICBsZXQgbmV3V2lkdGggPSBwYWludFdpZHRoLCBuZXdIZWlnaHQgPSBwYWludEhlaWdodDsKICAgICAgaWYgKHdpZHRoU2NhbGUgPiAyICYmIHBhaW50V2lkdGggPiAxKSB7CiAgICAgICAgbmV3V2lkdGggPSBwYWludFdpZHRoID49IDE2Mzg0ID8gTWF0aC5mbG9vcihwYWludFdpZHRoIC8gMikgLSAxIHx8IDEgOiBNYXRoLmNlaWwocGFpbnRXaWR0aCAvIDIpOwogICAgICAgIHdpZHRoU2NhbGUgLz0gcGFpbnRXaWR0aCAvIG5ld1dpZHRoOwogICAgICB9CiAgICAgIGlmIChoZWlnaHRTY2FsZSA+IDIgJiYgcGFpbnRIZWlnaHQgPiAxKSB7CiAgICAgICAgbmV3SGVpZ2h0ID0gcGFpbnRIZWlnaHQgPj0gMTYzODQgPyBNYXRoLmZsb29yKHBhaW50SGVpZ2h0IC8gMikgLSAxIHx8IDEgOiBNYXRoLmNlaWwocGFpbnRIZWlnaHQpIC8gMjsKICAgICAgICBoZWlnaHRTY2FsZSAvPSBwYWludEhlaWdodCAvIG5ld0hlaWdodDsKICAgICAgfQogICAgICB0bXBDYW52YXMgPSB0aGlzLmNhY2hlZENhbnZhc2VzLmdldENhbnZhcyh0bXBDYW52YXNJZCwgbmV3V2lkdGgsIG5ld0hlaWdodCk7CiAgICAgIHRtcEN0eCA9IHRtcENhbnZhcy5jb250ZXh0OwogICAgICB0bXBDdHguY2xlYXJSZWN0KDAsIDAsIG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgICB0bXBDdHguZHJhd0ltYWdlKGltZywgMCwgMCwgcGFpbnRXaWR0aCwgcGFpbnRIZWlnaHQsIDAsIDAsIG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgICBpbWcgPSB0bXBDYW52YXMuY2FudmFzOwogICAgICBwYWludFdpZHRoID0gbmV3V2lkdGg7CiAgICAgIHBhaW50SGVpZ2h0ID0gbmV3SGVpZ2h0OwogICAgICB0bXBDYW52YXNJZCA9IHRtcENhbnZhc0lkID09PSAicHJlc2NhbGUxIiA/ICJwcmVzY2FsZTIiIDogInByZXNjYWxlMSI7CiAgICB9CiAgICByZXR1cm4gewogICAgICBpbWcsCiAgICAgIHBhaW50V2lkdGgsCiAgICAgIHBhaW50SGVpZ2h0CiAgICB9OwogIH0KICBfY3JlYXRlTWFza0NhbnZhcyhvcElkeCwgaW1nKSB7CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IGltZzsKICAgIGNvbnN0IGZpbGxDb2xvciA9IHRoaXMuY3VycmVudC5maWxsQ29sb3I7CiAgICBjb25zdCBpc1BhdHRlcm5GaWxsID0gdGhpcy5jdXJyZW50LnBhdHRlcm5GaWxsOwogICAgY29uc3QgY3VycmVudFRyYW5zZm9ybSA9IGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KTsKICAgIGxldCBjYWNoZSwgY2FjaGVLZXksIHNjYWxlZCwgbWFza0NhbnZhczsKICAgIGlmICgoaW1nLmJpdG1hcCB8fCBpbWcuZGF0YSkgJiYgaW1nLmNvdW50ID4gMSkgewogICAgICBjb25zdCBtYWluS2V5ID0gaW1nLmJpdG1hcCB8fCBpbWcuZGF0YS5idWZmZXI7CiAgICAgIGNhY2hlS2V5ID0gSlNPTi5zdHJpbmdpZnkoaXNQYXR0ZXJuRmlsbCA/IGN1cnJlbnRUcmFuc2Zvcm0gOiBbY3VycmVudFRyYW5zZm9ybS5zbGljZSgwLCA0KSwgZmlsbENvbG9yXSk7CiAgICAgIGNhY2hlID0gdGhpcy5fY2FjaGVkQml0bWFwc01hcC5nZXQobWFpbktleSk7CiAgICAgIGlmICghY2FjaGUpIHsKICAgICAgICBjYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fY2FjaGVkQml0bWFwc01hcC5zZXQobWFpbktleSwgY2FjaGUpOwogICAgICB9CiAgICAgIGNvbnN0IGNhY2hlZEltYWdlID0gY2FjaGUuZ2V0KGNhY2hlS2V5KTsKICAgICAgaWYgKGNhY2hlZEltYWdlICYmICFpc1BhdHRlcm5GaWxsKSB7CiAgICAgICAgY29uc3Qgb2Zmc2V0WDIgPSBNYXRoLnJvdW5kKE1hdGgubWluKGN1cnJlbnRUcmFuc2Zvcm1bMF0sIGN1cnJlbnRUcmFuc2Zvcm1bMl0pICsgY3VycmVudFRyYW5zZm9ybVs0XSk7CiAgICAgICAgY29uc3Qgb2Zmc2V0WTIgPSBNYXRoLnJvdW5kKE1hdGgubWluKGN1cnJlbnRUcmFuc2Zvcm1bMV0sIGN1cnJlbnRUcmFuc2Zvcm1bM10pICsgY3VycmVudFRyYW5zZm9ybVs1XSk7CiAgICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMudHJhbnNmb3JtQW5kRmlsbCk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNhbnZhczogY2FjaGVkSW1hZ2UsCiAgICAgICAgICBvZmZzZXRYOiBvZmZzZXRYMiwKICAgICAgICAgIG9mZnNldFk6IG9mZnNldFkyCiAgICAgICAgfTsKICAgICAgfQogICAgICBzY2FsZWQgPSBjYWNoZWRJbWFnZTsKICAgIH0KICAgIGlmICghc2NhbGVkKSB7CiAgICAgIG1hc2tDYW52YXMgPSB0aGlzLmNhY2hlZENhbnZhc2VzLmdldENhbnZhcygibWFza0NhbnZhcyIsIHdpZHRoLCBoZWlnaHQpOwogICAgICBwdXRCaW5hcnlJbWFnZU1hc2sobWFza0NhbnZhcy5jb250ZXh0LCBpbWcpOwogICAgfQogICAgbGV0IG1hc2tUb0NhbnZhcyA9IFV0aWwudHJhbnNmb3JtKGN1cnJlbnRUcmFuc2Zvcm0sIFsxIC8gd2lkdGgsIDAsIDAsIC0xIC8gaGVpZ2h0LCAwLCAwXSk7CiAgICBtYXNrVG9DYW52YXMgPSBVdGlsLnRyYW5zZm9ybShtYXNrVG9DYW52YXMsIFsxLCAwLCAwLCAxLCAwLCAtaGVpZ2h0XSk7CiAgICBjb25zdCBtaW5NYXggPSBNSU5fTUFYX0lOSVQuc2xpY2UoKTsKICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goWzAsIDAsIHdpZHRoLCBoZWlnaHRdLCBtYXNrVG9DYW52YXMsIG1pbk1heCk7CiAgICBjb25zdCBbbWluWCwgbWluWSwgbWF4WCwgbWF4WV0gPSBtaW5NYXg7CiAgICBjb25zdCBkcmF3bldpZHRoID0gTWF0aC5yb3VuZChtYXhYIC0gbWluWCkgfHwgMTsKICAgIGNvbnN0IGRyYXduSGVpZ2h0ID0gTWF0aC5yb3VuZChtYXhZIC0gbWluWSkgfHwgMTsKICAgIGNvbnN0IGZpbGxDYW52YXMgPSB0aGlzLmNhY2hlZENhbnZhc2VzLmdldENhbnZhcygiZmlsbENhbnZhcyIsIGRyYXduV2lkdGgsIGRyYXduSGVpZ2h0KTsKICAgIGNvbnN0IGZpbGxDdHggPSBmaWxsQ2FudmFzLmNvbnRleHQ7CiAgICBjb25zdCBvZmZzZXRYID0gbWluWDsKICAgIGNvbnN0IG9mZnNldFkgPSBtaW5ZOwogICAgZmlsbEN0eC50cmFuc2xhdGUoLW9mZnNldFgsIC1vZmZzZXRZKTsKICAgIGZpbGxDdHgudHJhbnNmb3JtKC4uLm1hc2tUb0NhbnZhcyk7CiAgICBpZiAoIXNjYWxlZCkgewogICAgICBzY2FsZWQgPSB0aGlzLl9zY2FsZUltYWdlKG1hc2tDYW52YXMuY2FudmFzLCBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShmaWxsQ3R4KSk7CiAgICAgIHNjYWxlZCA9IHNjYWxlZC5pbWc7CiAgICAgIGlmIChjYWNoZSAmJiBpc1BhdHRlcm5GaWxsKSB7CiAgICAgICAgY2FjaGUuc2V0KGNhY2hlS2V5LCBzY2FsZWQpOwogICAgICB9CiAgICB9CiAgICBmaWxsQ3R4LmltYWdlU21vb3RoaW5nRW5hYmxlZCA9IGdldEltYWdlU21vb3RoaW5nRW5hYmxlZChnZXRDdXJyZW50VHJhbnNmb3JtKGZpbGxDdHgpLCBpbWcuaW50ZXJwb2xhdGUpOwogICAgZHJhd0ltYWdlQXRJbnRlZ2VyQ29vcmRzKGZpbGxDdHgsIHNjYWxlZCwgMCwgMCwgc2NhbGVkLndpZHRoLCBzY2FsZWQuaGVpZ2h0LCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKICAgIGZpbGxDdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gInNvdXJjZS1pbiI7CiAgICBjb25zdCBpbnZlcnNlID0gVXRpbC50cmFuc2Zvcm0oZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoZmlsbEN0eCksIFsxLCAwLCAwLCAxLCAtb2Zmc2V0WCwgLW9mZnNldFldKTsKICAgIGZpbGxDdHguZmlsbFN0eWxlID0gaXNQYXR0ZXJuRmlsbCA/IGZpbGxDb2xvci5nZXRQYXR0ZXJuKGN0eCwgdGhpcywgaW52ZXJzZSwgUGF0aFR5cGUuRklMTCwgb3BJZHgpIDogZmlsbENvbG9yOwogICAgZmlsbEN0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKICAgIGlmIChjYWNoZSAmJiAhaXNQYXR0ZXJuRmlsbCkgewogICAgICB0aGlzLmNhY2hlZENhbnZhc2VzLmRlbGV0ZSgiZmlsbENhbnZhcyIpOwogICAgICBjYWNoZS5zZXQoY2FjaGVLZXksIGZpbGxDYW52YXMuY2FudmFzKTsKICAgIH0KICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLnRyYW5zZm9ybUFuZEZpbGwpOwogICAgcmV0dXJuIHsKICAgICAgY2FudmFzOiBmaWxsQ2FudmFzLmNhbnZhcywKICAgICAgb2Zmc2V0WDogTWF0aC5yb3VuZChvZmZzZXRYKSwKICAgICAgb2Zmc2V0WTogTWF0aC5yb3VuZChvZmZzZXRZKQogICAgfTsKICB9CiAgc2V0TGluZVdpZHRoKG9wSWR4LCB3aWR0aCkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgibGluZVdpZHRoIiwgb3BJZHgpOwogICAgaWYgKHdpZHRoICE9PSB0aGlzLmN1cnJlbnQubGluZVdpZHRoKSB7CiAgICAgIHRoaXMuX2NhY2hlZFNjYWxlRm9yU3Ryb2tpbmdbMF0gPSAtMTsKICAgIH0KICAgIHRoaXMuY3VycmVudC5saW5lV2lkdGggPSB3aWR0aDsKICAgIHRoaXMuY3R4LmxpbmVXaWR0aCA9IHdpZHRoOwogIH0KICBzZXRMaW5lQ2FwKG9wSWR4LCBzdHlsZSkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgibGluZUNhcCIsIG9wSWR4KTsKICAgIHRoaXMuY3R4LmxpbmVDYXAgPSBMSU5FX0NBUF9TVFlMRVNbc3R5bGVdOwogIH0KICBzZXRMaW5lSm9pbihvcElkeCwgc3R5bGUpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImxpbmVKb2luIiwgb3BJZHgpOwogICAgdGhpcy5jdHgubGluZUpvaW4gPSBMSU5FX0pPSU5fU1RZTEVTW3N0eWxlXTsKICB9CiAgc2V0TWl0ZXJMaW1pdChvcElkeCwgbGltaXQpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoIm1pdGVyTGltaXQiLCBvcElkeCk7CiAgICB0aGlzLmN0eC5taXRlckxpbWl0ID0gbGltaXQ7CiAgfQogIHNldERhc2gob3BJZHgsIGRhc2hBcnJheSwgZGFzaFBoYXNlKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJkYXNoIiwgb3BJZHgpOwogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBpZiAoY3R4LnNldExpbmVEYXNoICE9PSB2b2lkIDApIHsKICAgICAgY3R4LnNldExpbmVEYXNoKGRhc2hBcnJheSk7CiAgICAgIGN0eC5saW5lRGFzaE9mZnNldCA9IGRhc2hQaGFzZTsKICAgIH0KICB9CiAgc2V0UmVuZGVyaW5nSW50ZW50KG9wSWR4LCBpbnRlbnQpIHsKICB9CiAgc2V0RmxhdG5lc3Mob3BJZHgsIGZsYXRuZXNzKSB7CiAgfQogIHNldEdTdGF0ZShvcElkeCwgc3RhdGVzKSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBzdGF0ZXMpIHsKICAgICAgc3dpdGNoIChrZXkpIHsKICAgICAgICBjYXNlICJMVyI6CiAgICAgICAgICB0aGlzLnNldExpbmVXaWR0aChvcElkeCwgdmFsdWUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiTEMiOgogICAgICAgICAgdGhpcy5zZXRMaW5lQ2FwKG9wSWR4LCB2YWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJMSiI6CiAgICAgICAgICB0aGlzLnNldExpbmVKb2luKG9wSWR4LCB2YWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJNTCI6CiAgICAgICAgICB0aGlzLnNldE1pdGVyTGltaXQob3BJZHgsIHZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkQiOgogICAgICAgICAgdGhpcy5zZXREYXNoKG9wSWR4LCB2YWx1ZVswXSwgdmFsdWVbMV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiUkkiOgogICAgICAgICAgdGhpcy5zZXRSZW5kZXJpbmdJbnRlbnQob3BJZHgsIHZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkZMIjoKICAgICAgICAgIHRoaXMuc2V0RmxhdG5lc3Mob3BJZHgsIHZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkZvbnQiOgogICAgICAgICAgdGhpcy5zZXRGb250KG9wSWR4LCB2YWx1ZVswXSwgdmFsdWVbMV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiQ0EiOgogICAgICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgic3Ryb2tlQWxwaGEiLCBvcElkeCk7CiAgICAgICAgICB0aGlzLmN1cnJlbnQuc3Ryb2tlQWxwaGEgPSB2YWx1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgImNhIjoKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImZpbGxBbHBoYSIsIG9wSWR4KTsKICAgICAgICAgIHRoaXMuY3R4Lmdsb2JhbEFscGhhID0gdGhpcy5jdXJyZW50LmZpbGxBbHBoYSA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiQk0iOgogICAgICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgiZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uIiwgb3BJZHgpOwogICAgICAgICAgdGhpcy5jdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gdmFsdWU7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJTTWFzayI6CiAgICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJTTWFzayIsIG9wSWR4KTsKICAgICAgICAgIHRoaXMuY3VycmVudC5hY3RpdmVTTWFzayA9IHZhbHVlID8gdGhpcy50ZW1wU01hc2sgOiBudWxsOwogICAgICAgICAgdGhpcy50ZW1wU01hc2sgPSBudWxsOwogICAgICAgICAgdGhpcy5jaGVja1NNYXNrU3RhdGUoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIlRSIjoKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImZpbHRlciIsIG9wSWR4KTsKICAgICAgICAgIHRoaXMuY3R4LmZpbHRlciA9IHRoaXMuY3VycmVudC50cmFuc2Zlck1hcHMgPSB0aGlzLmZpbHRlckZhY3RvcnkuYWRkRmlsdGVyKHZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQogIGdldCBpblNNYXNrTW9kZSgpIHsKICAgIHJldHVybiAhIXRoaXMuc3VzcGVuZGVkQ3R4OwogIH0KICBjaGVja1NNYXNrU3RhdGUoKSB7CiAgICBjb25zdCBpblNNYXNrTW9kZSA9IHRoaXMuaW5TTWFza01vZGU7CiAgICBpZiAodGhpcy5jdXJyZW50LmFjdGl2ZVNNYXNrICYmICFpblNNYXNrTW9kZSkgewogICAgICB0aGlzLmJlZ2luU01hc2tNb2RlKCk7CiAgICB9IGVsc2UgaWYgKCF0aGlzLmN1cnJlbnQuYWN0aXZlU01hc2sgJiYgaW5TTWFza01vZGUpIHsKICAgICAgdGhpcy5lbmRTTWFza01vZGUoKTsKICAgIH0KICB9CiAgYmVnaW5TTWFza01vZGUob3BJZHgpIHsKICAgIGlmICh0aGlzLmluU01hc2tNb2RlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiYmVnaW5TTWFza01vZGUgY2FsbGVkIHdoaWxlIGFscmVhZHkgaW4gc21hc2sgbW9kZSIpOwogICAgfQogICAgY29uc3QgZHJhd25XaWR0aCA9IHRoaXMuY3R4LmNhbnZhcy53aWR0aDsKICAgIGNvbnN0IGRyYXduSGVpZ2h0ID0gdGhpcy5jdHguY2FudmFzLmhlaWdodDsKICAgIGNvbnN0IGNhY2hlSWQgPSAic21hc2tHcm91cEF0IiArIHRoaXMuZ3JvdXBMZXZlbDsKICAgIGNvbnN0IHNjcmF0Y2hDYW52YXMgPSB0aGlzLmNhY2hlZENhbnZhc2VzLmdldENhbnZhcyhjYWNoZUlkLCBkcmF3bldpZHRoLCBkcmF3bkhlaWdodCk7CiAgICB0aGlzLnN1c3BlbmRlZEN0eCA9IHRoaXMuY3R4OwogICAgY29uc3QgY3R4ID0gdGhpcy5jdHggPSBzY3JhdGNoQ2FudmFzLmNvbnRleHQ7CiAgICBjdHguc2V0VHJhbnNmb3JtKHRoaXMuc3VzcGVuZGVkQ3R4LmdldFRyYW5zZm9ybSgpKTsKICAgIGNvcHlDdHhTdGF0ZSh0aGlzLnN1c3BlbmRlZEN0eCwgY3R4KTsKICAgIG1pcnJvckNvbnRleHRPcGVyYXRpb25zKGN0eCwgdGhpcy5zdXNwZW5kZWRDdHgpOwogICAgdGhpcy5zZXRHU3RhdGUob3BJZHgsIFtbIkJNIiwgInNvdXJjZS1vdmVyIl1dKTsKICB9CiAgZW5kU01hc2tNb2RlKCkgewogICAgaWYgKCF0aGlzLmluU01hc2tNb2RlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiZW5kU01hc2tNb2RlIGNhbGxlZCB3aGlsZSBub3QgaW4gc21hc2sgbW9kZSIpOwogICAgfQogICAgdGhpcy5jdHguX3JlbW92ZU1pcnJvcmluZygpOwogICAgY29weUN0eFN0YXRlKHRoaXMuY3R4LCB0aGlzLnN1c3BlbmRlZEN0eCk7CiAgICB0aGlzLmN0eCA9IHRoaXMuc3VzcGVuZGVkQ3R4OwogICAgdGhpcy5zdXNwZW5kZWRDdHggPSBudWxsOwogIH0KICBjb21wb3NlKGRpcnR5Qm94KSB7CiAgICBpZiAoIXRoaXMuY3VycmVudC5hY3RpdmVTTWFzaykgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIWRpcnR5Qm94KSB7CiAgICAgIGRpcnR5Qm94ID0gWzAsIDAsIHRoaXMuY3R4LmNhbnZhcy53aWR0aCwgdGhpcy5jdHguY2FudmFzLmhlaWdodF07CiAgICB9IGVsc2UgewogICAgICBkaXJ0eUJveFswXSA9IE1hdGguZmxvb3IoZGlydHlCb3hbMF0pOwogICAgICBkaXJ0eUJveFsxXSA9IE1hdGguZmxvb3IoZGlydHlCb3hbMV0pOwogICAgICBkaXJ0eUJveFsyXSA9IE1hdGguY2VpbChkaXJ0eUJveFsyXSk7CiAgICAgIGRpcnR5Qm94WzNdID0gTWF0aC5jZWlsKGRpcnR5Qm94WzNdKTsKICAgIH0KICAgIGNvbnN0IHNtYXNrID0gdGhpcy5jdXJyZW50LmFjdGl2ZVNNYXNrOwogICAgY29uc3Qgc3VzcGVuZGVkQ3R4ID0gdGhpcy5zdXNwZW5kZWRDdHg7CiAgICB0aGlzLmNvbXBvc2VTTWFzayhzdXNwZW5kZWRDdHgsIHNtYXNrLCB0aGlzLmN0eCwgZGlydHlCb3gpOwogICAgdGhpcy5jdHguc2F2ZSgpOwogICAgdGhpcy5jdHguc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgdGhpcy5jdHguY2xlYXJSZWN0KDAsIDAsIHRoaXMuY3R4LmNhbnZhcy53aWR0aCwgdGhpcy5jdHguY2FudmFzLmhlaWdodCk7CiAgICB0aGlzLmN0eC5yZXN0b3JlKCk7CiAgfQogIGNvbXBvc2VTTWFzayhjdHgsIHNtYXNrLCBsYXllckN0eCwgbGF5ZXJCb3gpIHsKICAgIGNvbnN0IGxheWVyT2Zmc2V0WCA9IGxheWVyQm94WzBdOwogICAgY29uc3QgbGF5ZXJPZmZzZXRZID0gbGF5ZXJCb3hbMV07CiAgICBjb25zdCBsYXllcldpZHRoID0gbGF5ZXJCb3hbMl0gLSBsYXllck9mZnNldFg7CiAgICBjb25zdCBsYXllckhlaWdodCA9IGxheWVyQm94WzNdIC0gbGF5ZXJPZmZzZXRZOwogICAgaWYgKGxheWVyV2lkdGggPT09IDAgfHwgbGF5ZXJIZWlnaHQgPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5nZW5lcmljQ29tcG9zZVNNYXNrKHNtYXNrLmNvbnRleHQsIGxheWVyQ3R4LCBsYXllcldpZHRoLCBsYXllckhlaWdodCwgc21hc2suc3VidHlwZSwgc21hc2suYmFja2Ryb3AsIHNtYXNrLnRyYW5zZmVyTWFwLCBsYXllck9mZnNldFgsIGxheWVyT2Zmc2V0WSwgc21hc2sub2Zmc2V0WCwgc21hc2sub2Zmc2V0WSk7CiAgICBjdHguc2F2ZSgpOwogICAgY3R4Lmdsb2JhbEFscGhhID0gMTsKICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAic291cmNlLW92ZXIiOwogICAgY3R4LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKICAgIGN0eC5kcmF3SW1hZ2UobGF5ZXJDdHguY2FudmFzLCAwLCAwKTsKICAgIGN0eC5yZXN0b3JlKCk7CiAgfQogIGdlbmVyaWNDb21wb3NlU01hc2sobWFza0N0eCwgbGF5ZXJDdHgsIHdpZHRoLCBoZWlnaHQsIHN1YnR5cGUsIGJhY2tkcm9wLCB0cmFuc2Zlck1hcCwgbGF5ZXJPZmZzZXRYLCBsYXllck9mZnNldFksIG1hc2tPZmZzZXRYLCBtYXNrT2Zmc2V0WSkgewogICAgbGV0IG1hc2tDYW52YXMgPSBtYXNrQ3R4LmNhbnZhczsKICAgIGxldCBtYXNrWCA9IGxheWVyT2Zmc2V0WCAtIG1hc2tPZmZzZXRYOwogICAgbGV0IG1hc2tZID0gbGF5ZXJPZmZzZXRZIC0gbWFza09mZnNldFk7CiAgICBpZiAoYmFja2Ryb3ApIHsKICAgICAgaWYgKG1hc2tYIDwgMCB8fCBtYXNrWSA8IDAgfHwgbWFza1ggKyB3aWR0aCA+IG1hc2tDYW52YXMud2lkdGggfHwgbWFza1kgKyBoZWlnaHQgPiBtYXNrQ2FudmFzLmhlaWdodCkgewogICAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJtYXNrRXh0ZW5zaW9uIiwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmNvbnRleHQ7CiAgICAgICAgY3R4LmRyYXdJbWFnZShtYXNrQ2FudmFzLCAtbWFza1gsIC1tYXNrWSk7CiAgICAgICAgY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJkZXN0aW5hdGlvbi1hdG9wIjsKICAgICAgICBjdHguZmlsbFN0eWxlID0gYmFja2Ryb3A7CiAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAic291cmNlLW92ZXIiOwogICAgICAgIG1hc2tDYW52YXMgPSBjYW52YXMuY2FudmFzOwogICAgICAgIG1hc2tYID0gbWFza1kgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIG1hc2tDdHguc2F2ZSgpOwogICAgICAgIG1hc2tDdHguZ2xvYmFsQWxwaGEgPSAxOwogICAgICAgIG1hc2tDdHguc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgICAgIGNvbnN0IGNsaXAyID0gbmV3IFBhdGgyRCgpOwogICAgICAgIGNsaXAyLnJlY3QobWFza1gsIG1hc2tZLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBtYXNrQ3R4LmNsaXAoY2xpcDIpOwogICAgICAgIG1hc2tDdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gImRlc3RpbmF0aW9uLWF0b3AiOwogICAgICAgIG1hc2tDdHguZmlsbFN0eWxlID0gYmFja2Ryb3A7CiAgICAgICAgbWFza0N0eC5maWxsUmVjdChtYXNrWCwgbWFza1ksIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIG1hc2tDdHgucmVzdG9yZSgpOwogICAgICB9CiAgICB9CiAgICBsYXllckN0eC5zYXZlKCk7CiAgICBsYXllckN0eC5nbG9iYWxBbHBoYSA9IDE7CiAgICBsYXllckN0eC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgMCwgMCk7CiAgICBpZiAoc3VidHlwZSA9PT0gIkFscGhhIiAmJiB0cmFuc2Zlck1hcCkgewogICAgICBsYXllckN0eC5maWx0ZXIgPSB0aGlzLmZpbHRlckZhY3RvcnkuYWRkQWxwaGFGaWx0ZXIodHJhbnNmZXJNYXApOwogICAgfSBlbHNlIGlmIChzdWJ0eXBlID09PSAiTHVtaW5vc2l0eSIpIHsKICAgICAgbGF5ZXJDdHguZmlsdGVyID0gdGhpcy5maWx0ZXJGYWN0b3J5LmFkZEx1bWlub3NpdHlGaWx0ZXIodHJhbnNmZXJNYXApOwogICAgfQogICAgY29uc3QgY2xpcCA9IG5ldyBQYXRoMkQoKTsKICAgIGNsaXAucmVjdChsYXllck9mZnNldFgsIGxheWVyT2Zmc2V0WSwgd2lkdGgsIGhlaWdodCk7CiAgICBsYXllckN0eC5jbGlwKGNsaXApOwogICAgbGF5ZXJDdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gImRlc3RpbmF0aW9uLWluIjsKICAgIGxheWVyQ3R4LmRyYXdJbWFnZShtYXNrQ2FudmFzLCBtYXNrWCwgbWFza1ksIHdpZHRoLCBoZWlnaHQsIGxheWVyT2Zmc2V0WCwgbGF5ZXJPZmZzZXRZLCB3aWR0aCwgaGVpZ2h0KTsKICAgIGxheWVyQ3R4LnJlc3RvcmUoKTsKICB9CiAgc2F2ZShvcElkeCkgewogICAgaWYgKHRoaXMuaW5TTWFza01vZGUpIHsKICAgICAgY29weUN0eFN0YXRlKHRoaXMuY3R4LCB0aGlzLnN1c3BlbmRlZEN0eCk7CiAgICB9CiAgICB0aGlzLmN0eC5zYXZlKCk7CiAgICBjb25zdCBvbGQgPSB0aGlzLmN1cnJlbnQ7CiAgICB0aGlzLnN0YXRlU3RhY2sucHVzaChvbGQpOwogICAgdGhpcy5jdXJyZW50ID0gb2xkLmNsb25lKCk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5zYXZlKG9wSWR4KTsKICB9CiAgcmVzdG9yZShvcElkeCkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzdG9yZShvcElkeCk7CiAgICBpZiAodGhpcy5zdGF0ZVN0YWNrLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAodGhpcy5pblNNYXNrTW9kZSkgewogICAgICAgIHRoaXMuZW5kU01hc2tNb2RlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5jdXJyZW50ID0gdGhpcy5zdGF0ZVN0YWNrLnBvcCgpOwogICAgdGhpcy5jdHgucmVzdG9yZSgpOwogICAgaWYgKHRoaXMuaW5TTWFza01vZGUpIHsKICAgICAgY29weUN0eFN0YXRlKHRoaXMuc3VzcGVuZGVkQ3R4LCB0aGlzLmN0eCk7CiAgICB9CiAgICB0aGlzLmNoZWNrU01hc2tTdGF0ZSgpOwogICAgdGhpcy5wZW5kaW5nQ2xpcCA9IG51bGw7CiAgICB0aGlzLl9jYWNoZWRTY2FsZUZvclN0cm9raW5nWzBdID0gLTE7CiAgICB0aGlzLl9jYWNoZWRHZXRTaW5nbGVQaXhlbFdpZHRoID0gbnVsbDsKICB9CiAgdHJhbnNmb3JtKG9wSWR4LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRJbmNyZW1lbnRhbERhdGEoInRyYW5zZm9ybSIsIG9wSWR4KTsKICAgIHRoaXMuY3R4LnRyYW5zZm9ybShhLCBiLCBjLCBkLCBlLCBmKTsKICAgIHRoaXMuX2NhY2hlZFNjYWxlRm9yU3Ryb2tpbmdbMF0gPSAtMTsKICAgIHRoaXMuX2NhY2hlZEdldFNpbmdsZVBpeGVsV2lkdGggPSBudWxsOwogIH0KICBjb25zdHJ1Y3RQYXRoKG9wSWR4LCBvcCwgZGF0YSwgbWluTWF4KSB7CiAgICBsZXQgW3BhdGhdID0gZGF0YTsKICAgIGlmICghbWluTWF4KSB7CiAgICAgIHBhdGggfHw9IGRhdGFbMF0gPSBuZXcgUGF0aDJEKCk7CiAgICAgIHRoaXNbb3BdKG9wSWR4LCBwYXRoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIgIT09IG51bGwpIHsKICAgICAgY29uc3Qgb3V0ZXJFeHRyYVNpemUgPSBvcCA9PT0gT1BTLnN0cm9rZSA/IHRoaXMuY3VycmVudC5saW5lV2lkdGggLyAyIDogMDsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlci5yZXNldEJCb3gob3BJZHgpLnJlY29yZEJCb3gob3BJZHgsIHRoaXMuY3R4LCBtaW5NYXhbMF0gLSBvdXRlckV4dHJhU2l6ZSwgbWluTWF4WzJdICsgb3V0ZXJFeHRyYVNpemUsIG1pbk1heFsxXSAtIG91dGVyRXh0cmFTaXplLCBtaW5NYXhbM10gKyBvdXRlckV4dHJhU2l6ZSkucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBbInRyYW5zZm9ybSJdKTsKICAgIH0KICAgIGlmICghKHBhdGggaW5zdGFuY2VvZiBQYXRoMkQpKSB7CiAgICAgIHBhdGggPSBkYXRhWzBdID0gbWFrZVBhdGhGcm9tRHJhd09QUyhwYXRoKTsKICAgIH0KICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3gobWluTWF4LCBnZXRDdXJyZW50VHJhbnNmb3JtKHRoaXMuY3R4KSwgdGhpcy5jdXJyZW50Lm1pbk1heCk7CiAgICB0aGlzW29wXShvcElkeCwgcGF0aCk7CiAgICB0aGlzLl9wYXRoU3RhcnRJZHggPSBvcElkeDsKICB9CiAgY2xvc2VQYXRoKG9wSWR4KSB7CiAgICB0aGlzLmN0eC5jbG9zZVBhdGgoKTsKICB9CiAgc3Ryb2tlKG9wSWR4LCBwYXRoLCBjb25zdW1lUGF0aCA9IHRydWUpIHsKICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgY29uc3Qgc3Ryb2tlQ29sb3IgPSB0aGlzLmN1cnJlbnQuc3Ryb2tlQ29sb3I7CiAgICBjdHguZ2xvYmFsQWxwaGEgPSB0aGlzLmN1cnJlbnQuc3Ryb2tlQWxwaGE7CiAgICBpZiAodGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICBpZiAodHlwZW9mIHN0cm9rZUNvbG9yID09PSAib2JqZWN0IiAmJiBzdHJva2VDb2xvcj8uZ2V0UGF0dGVybikgewogICAgICAgIGNvbnN0IGJhc2VUcmFuc2Zvcm0gPSBzdHJva2VDb2xvci5pc01vZGlmeWluZ0N1cnJlbnRUcmFuc2Zvcm0oKSA/IGN0eC5nZXRUcmFuc2Zvcm0oKSA6IG51bGw7CiAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBzdHJva2VDb2xvci5nZXRQYXR0ZXJuKGN0eCwgdGhpcywgZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoY3R4KSwgUGF0aFR5cGUuU1RST0tFLCBvcElkeCk7CiAgICAgICAgaWYgKGJhc2VUcmFuc2Zvcm0pIHsKICAgICAgICAgIGNvbnN0IG5ld1BhdGggPSBuZXcgUGF0aDJEKCk7CiAgICAgICAgICBuZXdQYXRoLmFkZFBhdGgocGF0aCwgY3R4LmdldFRyYW5zZm9ybSgpLmludmVydFNlbGYoKS5tdWx0aXBseVNlbGYoYmFzZVRyYW5zZm9ybSkpOwogICAgICAgICAgcGF0aCA9IG5ld1BhdGg7CiAgICAgICAgfQogICAgICAgIHRoaXMucmVzY2FsZUFuZFN0cm9rZShwYXRoLCBmYWxzZSk7CiAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJlc2NhbGVBbmRTdHJva2UocGF0aCwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLnN0cm9rZSk7CiAgICBpZiAoY29uc3VtZVBhdGgpIHsKICAgICAgdGhpcy5jb25zdW1lUGF0aChvcElkeCwgcGF0aCwgdGhpcy5jdXJyZW50LmdldENsaXBwZWRQYXRoQm91bmRpbmdCb3goUGF0aFR5cGUuU1RST0tFLCBnZXRDdXJyZW50VHJhbnNmb3JtKHRoaXMuY3R4KSkpOwogICAgfQogICAgY3R4Lmdsb2JhbEFscGhhID0gdGhpcy5jdXJyZW50LmZpbGxBbHBoYTsKICB9CiAgY2xvc2VTdHJva2Uob3BJZHgsIHBhdGgpIHsKICAgIHRoaXMuc3Ryb2tlKG9wSWR4LCBwYXRoKTsKICB9CiAgZmlsbChvcElkeCwgcGF0aCwgY29uc3VtZVBhdGggPSB0cnVlKSB7CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IGZpbGxDb2xvciA9IHRoaXMuY3VycmVudC5maWxsQ29sb3I7CiAgICBjb25zdCBpc1BhdHRlcm5GaWxsID0gdGhpcy5jdXJyZW50LnBhdHRlcm5GaWxsOwogICAgbGV0IG5lZWRSZXN0b3JlID0gZmFsc2U7CiAgICBpZiAoaXNQYXR0ZXJuRmlsbCkgewogICAgICBjb25zdCBiYXNlVHJhbnNmb3JtID0gZmlsbENvbG9yLmlzTW9kaWZ5aW5nQ3VycmVudFRyYW5zZm9ybSgpID8gY3R4LmdldFRyYW5zZm9ybSgpIDogbnVsbDsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8uc2F2ZShvcElkeCk7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC5maWxsU3R5bGUgPSBmaWxsQ29sb3IuZ2V0UGF0dGVybihjdHgsIHRoaXMsIGdldEN1cnJlbnRUcmFuc2Zvcm1JbnZlcnNlKGN0eCksIFBhdGhUeXBlLkZJTEwsIG9wSWR4KTsKICAgICAgaWYgKGJhc2VUcmFuc2Zvcm0pIHsKICAgICAgICBjb25zdCBuZXdQYXRoID0gbmV3IFBhdGgyRCgpOwogICAgICAgIG5ld1BhdGguYWRkUGF0aChwYXRoLCBjdHguZ2V0VHJhbnNmb3JtKCkuaW52ZXJ0U2VsZigpLm11bHRpcGx5U2VsZihiYXNlVHJhbnNmb3JtKSk7CiAgICAgICAgcGF0aCA9IG5ld1BhdGg7CiAgICAgIH0KICAgICAgbmVlZFJlc3RvcmUgPSB0cnVlOwogICAgfQogICAgY29uc3QgaW50ZXJzZWN0ID0gdGhpcy5jdXJyZW50LmdldENsaXBwZWRQYXRoQm91bmRpbmdCb3goKTsKICAgIGlmICh0aGlzLmNvbnRlbnRWaXNpYmxlICYmIGludGVyc2VjdCAhPT0gbnVsbCkgewogICAgICBpZiAodGhpcy5wZW5kaW5nRU9GaWxsKSB7CiAgICAgICAgY3R4LmZpbGwocGF0aCwgImV2ZW5vZGQiKTsKICAgICAgICB0aGlzLnBlbmRpbmdFT0ZpbGwgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdHguZmlsbChwYXRoKTsKICAgICAgfQogICAgfQogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMuZmlsbCk7CiAgICBpZiAobmVlZFJlc3RvcmUpIHsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzdG9yZShvcElkeCk7CiAgICB9CiAgICBpZiAoY29uc3VtZVBhdGgpIHsKICAgICAgdGhpcy5jb25zdW1lUGF0aChvcElkeCwgcGF0aCwgaW50ZXJzZWN0KTsKICAgIH0KICB9CiAgZW9GaWxsKG9wSWR4LCBwYXRoKSB7CiAgICB0aGlzLnBlbmRpbmdFT0ZpbGwgPSB0cnVlOwogICAgdGhpcy5maWxsKG9wSWR4LCBwYXRoKTsKICB9CiAgZmlsbFN0cm9rZShvcElkeCwgcGF0aCkgewogICAgdGhpcy5maWxsKG9wSWR4LCBwYXRoLCBmYWxzZSk7CiAgICB0aGlzLnN0cm9rZShvcElkeCwgcGF0aCwgZmFsc2UpOwogICAgdGhpcy5jb25zdW1lUGF0aChvcElkeCwgcGF0aCk7CiAgfQogIGVvRmlsbFN0cm9rZShvcElkeCwgcGF0aCkgewogICAgdGhpcy5wZW5kaW5nRU9GaWxsID0gdHJ1ZTsKICAgIHRoaXMuZmlsbFN0cm9rZShvcElkeCwgcGF0aCk7CiAgfQogIGNsb3NlRmlsbFN0cm9rZShvcElkeCwgcGF0aCkgewogICAgdGhpcy5maWxsU3Ryb2tlKG9wSWR4LCBwYXRoKTsKICB9CiAgY2xvc2VFT0ZpbGxTdHJva2Uob3BJZHgsIHBhdGgpIHsKICAgIHRoaXMucGVuZGluZ0VPRmlsbCA9IHRydWU7CiAgICB0aGlzLmZpbGxTdHJva2Uob3BJZHgsIHBhdGgpOwogIH0KICBlbmRQYXRoKG9wSWR4LCBwYXRoKSB7CiAgICB0aGlzLmNvbnN1bWVQYXRoKG9wSWR4LCBwYXRoKTsKICB9CiAgcmF3RmlsbFBhdGgob3BJZHgsIHBhdGgpIHsKICAgIHRoaXMuY3R4LmZpbGwocGF0aCk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmREZXBlbmRlbmNpZXMob3BJZHgsIERlcGVuZGVuY2llcy5yYXdGaWxsUGF0aCkucmVjb3JkT3BlcmF0aW9uKG9wSWR4KTsKICB9CiAgY2xpcChvcElkeCkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeSgiY2xpcE1vZGUiLCBvcElkeCk7CiAgICB0aGlzLnBlbmRpbmdDbGlwID0gTk9STUFMX0NMSVA7CiAgfQogIGVvQ2xpcChvcElkeCkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeSgiY2xpcE1vZGUiLCBvcElkeCk7CiAgICB0aGlzLnBlbmRpbmdDbGlwID0gRU9fQ0xJUDsKICB9CiAgYmVnaW5UZXh0KG9wSWR4KSB7CiAgICB0aGlzLmN1cnJlbnQudGV4dE1hdHJpeCA9IG51bGw7CiAgICB0aGlzLmN1cnJlbnQudGV4dE1hdHJpeFNjYWxlID0gMTsKICAgIHRoaXMuY3VycmVudC54ID0gdGhpcy5jdXJyZW50LmxpbmVYID0gMDsKICAgIHRoaXMuY3VycmVudC55ID0gdGhpcy5jdXJyZW50LmxpbmVZID0gMDsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE9wZW5NYXJrZXIob3BJZHgpLnJlc2V0SW5jcmVtZW50YWxEYXRhKCJzYW1lTGluZVRleHQiKS5yZXNldEluY3JlbWVudGFsRGF0YSgibW92ZVRleHQiLCBvcElkeCk7CiAgfQogIGVuZFRleHQob3BJZHgpIHsKICAgIGNvbnN0IHBhdGhzID0gdGhpcy5wZW5kaW5nVGV4dFBhdGhzOwogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBpZiAodGhpcy5kZXBlbmRlbmN5VHJhY2tlcikgewogICAgICBjb25zdCB7CiAgICAgICAgZGVwZW5kZW5jeVRyYWNrZXIKICAgICAgfSA9IHRoaXM7CiAgICAgIGlmIChwYXRocyAhPT0gdm9pZCAwKSB7CiAgICAgICAgZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeSgidGV4dENsaXAiLCBkZXBlbmRlbmN5VHJhY2tlci5nZXRPcGVuTWFya2VyKCkpLnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3koInRleHRDbGlwIiwgb3BJZHgpOwogICAgICB9CiAgICAgIGRlcGVuZGVuY3lUcmFja2VyLnJlY29yZENsb3NlTWFya2VyKG9wSWR4KTsKICAgIH0KICAgIGlmIChwYXRocyAhPT0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IG5ld1BhdGggPSBuZXcgUGF0aDJEKCk7CiAgICAgIGNvbnN0IGludlRyYW5zZiA9IGN0eC5nZXRUcmFuc2Zvcm0oKS5pbnZlcnRTZWxmKCk7CiAgICAgIGZvciAoY29uc3QgewogICAgICAgIHRyYW5zZm9ybSwKICAgICAgICB4LAogICAgICAgIHksCiAgICAgICAgZm9udFNpemUsCiAgICAgICAgcGF0aAogICAgICB9IG9mIHBhdGhzKSB7CiAgICAgICAgaWYgKCFwYXRoKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbmV3UGF0aC5hZGRQYXRoKHBhdGgsIG5ldyBET01NYXRyaXgodHJhbnNmb3JtKS5wcmVNdWx0aXBseVNlbGYoaW52VHJhbnNmKS50cmFuc2xhdGUoeCwgeSkuc2NhbGUoZm9udFNpemUsIC1mb250U2l6ZSkpOwogICAgICB9CiAgICAgIGN0eC5jbGlwKG5ld1BhdGgpOwogICAgfQogICAgZGVsZXRlIHRoaXMucGVuZGluZ1RleHRQYXRoczsKICB9CiAgc2V0Q2hhclNwYWNpbmcob3BJZHgsIHNwYWNpbmcpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImNoYXJTcGFjaW5nIiwgb3BJZHgpOwogICAgdGhpcy5jdXJyZW50LmNoYXJTcGFjaW5nID0gc3BhY2luZzsKICB9CiAgc2V0V29yZFNwYWNpbmcob3BJZHgsIHNwYWNpbmcpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoIndvcmRTcGFjaW5nIiwgb3BJZHgpOwogICAgdGhpcy5jdXJyZW50LndvcmRTcGFjaW5nID0gc3BhY2luZzsKICB9CiAgc2V0SFNjYWxlKG9wSWR4LCBzY2FsZSkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgiaFNjYWxlIiwgb3BJZHgpOwogICAgdGhpcy5jdXJyZW50LnRleHRIU2NhbGUgPSBzY2FsZSAvIDEwMDsKICB9CiAgc2V0TGVhZGluZyhvcElkeCwgbGVhZGluZykgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgibGVhZGluZyIsIG9wSWR4KTsKICAgIHRoaXMuY3VycmVudC5sZWFkaW5nID0gLWxlYWRpbmc7CiAgfQogIHNldEZvbnQob3BJZHgsIGZvbnRSZWZOYW1lLCBzaXplKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJmb250Iiwgb3BJZHgpLnJlY29yZFNpbXBsZURhdGFGcm9tTmFtZWQoImZvbnRPYmoiLCBmb250UmVmTmFtZSwgb3BJZHgpOwogICAgY29uc3QgZm9udE9iaiA9IHRoaXMuY29tbW9uT2Jqcy5nZXQoZm9udFJlZk5hbWUpOwogICAgY29uc3QgY3VycmVudCA9IHRoaXMuY3VycmVudDsKICAgIGlmICghZm9udE9iaikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbid0IGZpbmQgZm9udCBmb3IgJHtmb250UmVmTmFtZX1gKTsKICAgIH0KICAgIGN1cnJlbnQuZm9udE1hdHJpeCA9IGZvbnRPYmouZm9udE1hdHJpeCB8fCBGT05UX0lERU5USVRZX01BVFJJWDsKICAgIGlmIChjdXJyZW50LmZvbnRNYXRyaXhbMF0gPT09IDAgfHwgY3VycmVudC5mb250TWF0cml4WzNdID09PSAwKSB7CiAgICAgIHdhcm4oIkludmFsaWQgZm9udCBtYXRyaXggZm9yIGZvbnQgIiArIGZvbnRSZWZOYW1lKTsKICAgIH0KICAgIGlmIChzaXplIDwgMCkgewogICAgICBzaXplID0gLXNpemU7CiAgICAgIGN1cnJlbnQuZm9udERpcmVjdGlvbiA9IC0xOwogICAgfSBlbHNlIHsKICAgICAgY3VycmVudC5mb250RGlyZWN0aW9uID0gMTsKICAgIH0KICAgIHRoaXMuY3VycmVudC5mb250ID0gZm9udE9iajsKICAgIHRoaXMuY3VycmVudC5mb250U2l6ZSA9IHNpemU7CiAgICBpZiAoZm9udE9iai5pc1R5cGUzRm9udCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBuYW1lID0gZm9udE9iai5sb2FkZWROYW1lIHx8ICJzYW5zLXNlcmlmIjsKICAgIGNvbnN0IHR5cGVmYWNlID0gZm9udE9iai5zeXN0ZW1Gb250SW5mbz8uY3NzIHx8IGAiJHtuYW1lfSIsICR7Zm9udE9iai5mYWxsYmFja05hbWV9YDsKICAgIGxldCBib2xkID0gIm5vcm1hbCI7CiAgICBpZiAoZm9udE9iai5ibGFjaykgewogICAgICBib2xkID0gIjkwMCI7CiAgICB9IGVsc2UgaWYgKGZvbnRPYmouYm9sZCkgewogICAgICBib2xkID0gImJvbGQiOwogICAgfQogICAgY29uc3QgaXRhbGljID0gZm9udE9iai5pdGFsaWMgPyAiaXRhbGljIiA6ICJub3JtYWwiOwogICAgbGV0IGJyb3dzZXJGb250U2l6ZSA9IHNpemU7CiAgICBpZiAoc2l6ZSA8IE1JTl9GT05UX1NJWkUpIHsKICAgICAgYnJvd3NlckZvbnRTaXplID0gTUlOX0ZPTlRfU0laRTsKICAgIH0gZWxzZSBpZiAoc2l6ZSA+IE1BWF9GT05UX1NJWkUpIHsKICAgICAgYnJvd3NlckZvbnRTaXplID0gTUFYX0ZPTlRfU0laRTsKICAgIH0KICAgIHRoaXMuY3VycmVudC5mb250U2l6ZVNjYWxlID0gc2l6ZSAvIGJyb3dzZXJGb250U2l6ZTsKICAgIHRoaXMuY3R4LmZvbnQgPSBgJHtpdGFsaWN9ICR7Ym9sZH0gJHticm93c2VyRm9udFNpemV9cHggJHt0eXBlZmFjZX1gOwogIH0KICBzZXRUZXh0UmVuZGVyaW5nTW9kZShvcElkeCwgbW9kZSkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgidGV4dFJlbmRlcmluZ01vZGUiLCBvcElkeCk7CiAgICB0aGlzLmN1cnJlbnQudGV4dFJlbmRlcmluZ01vZGUgPSBtb2RlOwogIH0KICBzZXRUZXh0UmlzZShvcElkeCwgcmlzZSkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgidGV4dFJpc2UiLCBvcElkeCk7CiAgICB0aGlzLmN1cnJlbnQudGV4dFJpc2UgPSByaXNlOwogIH0KICBtb3ZlVGV4dChvcElkeCwgeCwgeSkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzZXRJbmNyZW1lbnRhbERhdGEoInNhbWVMaW5lVGV4dCIpLnJlY29yZEluY3JlbWVudGFsRGF0YSgibW92ZVRleHQiLCBvcElkeCk7CiAgICB0aGlzLmN1cnJlbnQueCA9IHRoaXMuY3VycmVudC5saW5lWCArPSB4OwogICAgdGhpcy5jdXJyZW50LnkgPSB0aGlzLmN1cnJlbnQubGluZVkgKz0geTsKICB9CiAgc2V0TGVhZGluZ01vdmVUZXh0KG9wSWR4LCB4LCB5KSB7CiAgICB0aGlzLnNldExlYWRpbmcob3BJZHgsIC15KTsKICAgIHRoaXMubW92ZVRleHQob3BJZHgsIHgsIHkpOwogIH0KICBzZXRUZXh0TWF0cml4KG9wSWR4LCBtYXRyaXgpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc2V0SW5jcmVtZW50YWxEYXRhKCJzYW1lTGluZVRleHQiKS5yZWNvcmRTaW1wbGVEYXRhKCJ0ZXh0TWF0cml4Iiwgb3BJZHgpOwogICAgY29uc3QgewogICAgICBjdXJyZW50CiAgICB9ID0gdGhpczsKICAgIGN1cnJlbnQudGV4dE1hdHJpeCA9IG1hdHJpeDsKICAgIGN1cnJlbnQudGV4dE1hdHJpeFNjYWxlID0gTWF0aC5oeXBvdChtYXRyaXhbMF0sIG1hdHJpeFsxXSk7CiAgICBjdXJyZW50LnggPSBjdXJyZW50LmxpbmVYID0gMDsKICAgIGN1cnJlbnQueSA9IGN1cnJlbnQubGluZVkgPSAwOwogIH0KICBuZXh0TGluZShvcElkeCkgewogICAgdGhpcy5tb3ZlVGV4dChvcElkeCwgMCwgdGhpcy5jdXJyZW50LmxlYWRpbmcpOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkSW5jcmVtZW50YWxEYXRhKCJtb3ZlVGV4dCIsIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIuZ2V0U2ltcGxlSW5kZXgoImxlYWRpbmciKSA/PyBvcElkeCk7CiAgfQogICNnZXRTY2FsZWRQYXRoKHBhdGgsIGN1cnJlbnRUcmFuc2Zvcm0sIHRyYW5zZm9ybSkgewogICAgY29uc3QgbmV3UGF0aCA9IG5ldyBQYXRoMkQoKTsKICAgIG5ld1BhdGguYWRkUGF0aChwYXRoLCBuZXcgRE9NTWF0cml4KHRyYW5zZm9ybSkuaW52ZXJ0U2VsZigpLm11bHRpcGx5U2VsZihjdXJyZW50VHJhbnNmb3JtKSk7CiAgICByZXR1cm4gbmV3UGF0aDsKICB9CiAgcGFpbnRDaGFyKG9wSWR4LCBjaGFyYWN0ZXIsIHgsIHksIHBhdHRlcm5GaWxsVHJhbnNmb3JtLCBwYXR0ZXJuU3Ryb2tlVHJhbnNmb3JtKSB7CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CiAgICBjb25zdCBmb250ID0gY3VycmVudC5mb250OwogICAgY29uc3QgdGV4dFJlbmRlcmluZ01vZGUgPSBjdXJyZW50LnRleHRSZW5kZXJpbmdNb2RlOwogICAgY29uc3QgZm9udFNpemUgPSBjdXJyZW50LmZvbnRTaXplIC8gY3VycmVudC5mb250U2l6ZVNjYWxlOwogICAgY29uc3QgZmlsbFN0cm9rZU1vZGUgPSB0ZXh0UmVuZGVyaW5nTW9kZSAmIFRleHRSZW5kZXJpbmdNb2RlLkZJTExfU1RST0tFX01BU0s7CiAgICBjb25zdCBpc0FkZFRvUGF0aFNldCA9ICEhKHRleHRSZW5kZXJpbmdNb2RlICYgVGV4dFJlbmRlcmluZ01vZGUuQUREX1RPX1BBVEhfRkxBRyk7CiAgICBjb25zdCBwYXR0ZXJuRmlsbCA9IGN1cnJlbnQucGF0dGVybkZpbGwgJiYgIWZvbnQubWlzc2luZ0ZpbGU7CiAgICBjb25zdCBwYXR0ZXJuU3Ryb2tlID0gY3VycmVudC5wYXR0ZXJuU3Ryb2tlICYmICFmb250Lm1pc3NpbmdGaWxlOwogICAgbGV0IHBhdGg7CiAgICBpZiAoKGZvbnQuZGlzYWJsZUZvbnRGYWNlIHx8IGlzQWRkVG9QYXRoU2V0IHx8IHBhdHRlcm5GaWxsIHx8IHBhdHRlcm5TdHJva2UpICYmICFmb250Lm1pc3NpbmdGaWxlKSB7CiAgICAgIHBhdGggPSBmb250LmdldFBhdGhHZW5lcmF0b3IodGhpcy5jb21tb25PYmpzLCBjaGFyYWN0ZXIpOwogICAgfQogICAgaWYgKHBhdGggJiYgKGZvbnQuZGlzYWJsZUZvbnRGYWNlIHx8IHBhdHRlcm5GaWxsIHx8IHBhdHRlcm5TdHJva2UpKSB7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC50cmFuc2xhdGUoeCwgeSk7CiAgICAgIGN0eC5zY2FsZShmb250U2l6ZSwgLWZvbnRTaXplKTsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkQ2hhcmFjdGVyQkJveChvcElkeCwgY3R4LCBmb250KTsKICAgICAgbGV0IGN1cnJlbnRUcmFuc2Zvcm07CiAgICAgIGlmIChmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTCB8fCBmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTF9TVFJPS0UpIHsKICAgICAgICBpZiAocGF0dGVybkZpbGxUcmFuc2Zvcm0pIHsKICAgICAgICAgIGN1cnJlbnRUcmFuc2Zvcm0gPSBjdHguZ2V0VHJhbnNmb3JtKCk7CiAgICAgICAgICBjdHguc2V0VHJhbnNmb3JtKC4uLnBhdHRlcm5GaWxsVHJhbnNmb3JtKTsKICAgICAgICAgIGNvbnN0IHNjYWxlZFBhdGggPSB0aGlzLiNnZXRTY2FsZWRQYXRoKHBhdGgsIGN1cnJlbnRUcmFuc2Zvcm0sIHBhdHRlcm5GaWxsVHJhbnNmb3JtKTsKICAgICAgICAgIGN0eC5maWxsKHNjYWxlZFBhdGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdHguZmlsbChwYXRoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZpbGxTdHJva2VNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5TVFJPS0UgfHwgZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLkZJTExfU1RST0tFKSB7CiAgICAgICAgaWYgKHBhdHRlcm5TdHJva2VUcmFuc2Zvcm0pIHsKICAgICAgICAgIGN1cnJlbnRUcmFuc2Zvcm0gfHw9IGN0eC5nZXRUcmFuc2Zvcm0oKTsKICAgICAgICAgIGN0eC5zZXRUcmFuc2Zvcm0oLi4ucGF0dGVyblN0cm9rZVRyYW5zZm9ybSk7CiAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgIGEsCiAgICAgICAgICAgIGIsCiAgICAgICAgICAgIGMsCiAgICAgICAgICAgIGQKICAgICAgICAgIH0gPSBjdXJyZW50VHJhbnNmb3JtOwogICAgICAgICAgY29uc3QgaW52UGF0dGVyblRyYW5zZm9ybSA9IFV0aWwuaW52ZXJzZVRyYW5zZm9ybShwYXR0ZXJuU3Ryb2tlVHJhbnNmb3JtKTsKICAgICAgICAgIGNvbnN0IHRyYW5zZiA9IFV0aWwudHJhbnNmb3JtKFthLCBiLCBjLCBkLCAwLCAwXSwgaW52UGF0dGVyblRyYW5zZm9ybSk7CiAgICAgICAgICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKHRyYW5zZiwgWFkpOwogICAgICAgICAgY3R4LmxpbmVXaWR0aCAqPSBNYXRoLm1heChYWVswXSwgWFlbMV0pIC8gZm9udFNpemU7CiAgICAgICAgICBjdHguc3Ryb2tlKHRoaXMuI2dldFNjYWxlZFBhdGgocGF0aCwgY3VycmVudFRyYW5zZm9ybSwgcGF0dGVyblN0cm9rZVRyYW5zZm9ybSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdHgubGluZVdpZHRoIC89IGZvbnRTaXplOwogICAgICAgICAgY3R4LnN0cm9rZShwYXRoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTCB8fCBmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTF9TVFJPS0UpIHsKICAgICAgICBjdHguZmlsbFRleHQoY2hhcmFjdGVyLCB4LCB5KTsKICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRDaGFyYWN0ZXJCQm94KG9wSWR4LCBjdHgsIGZvbnQsIGZvbnRTaXplLCB4LCB5LCAoKSA9PiBjdHgubWVhc3VyZVRleHQoY2hhcmFjdGVyKSk7CiAgICAgIH0KICAgICAgaWYgKGZpbGxTdHJva2VNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5TVFJPS0UgfHwgZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLkZJTExfU1RST0tFKSB7CiAgICAgICAgaWYgKHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIpIHsKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZENoYXJhY3RlckJCb3gob3BJZHgsIGN0eCwgZm9udCwgZm9udFNpemUsIHgsIHksICgpID0+IGN0eC5tZWFzdXJlVGV4dChjaGFyYWN0ZXIpKS5yZWNvcmREZXBlbmRlbmNpZXMob3BJZHgsIERlcGVuZGVuY2llcy5zdHJva2UpOwogICAgICAgIH0KICAgICAgICBjdHguc3Ryb2tlVGV4dChjaGFyYWN0ZXIsIHgsIHkpOwogICAgICB9CiAgICB9CiAgICBpZiAoaXNBZGRUb1BhdGhTZXQpIHsKICAgICAgY29uc3QgcGF0aHMgPSB0aGlzLnBlbmRpbmdUZXh0UGF0aHMgfHw9IFtdOwogICAgICBwYXRocy5wdXNoKHsKICAgICAgICB0cmFuc2Zvcm06IGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KSwKICAgICAgICB4LAogICAgICAgIHksCiAgICAgICAgZm9udFNpemUsCiAgICAgICAgcGF0aAogICAgICB9KTsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkQ2hhcmFjdGVyQkJveChvcElkeCwgY3R4LCBmb250LCBmb250U2l6ZSwgeCwgeSk7CiAgICB9CiAgfQogIGdldCBpc0ZvbnRTdWJwaXhlbEFBRW5hYmxlZCgpIHsKICAgIGNvbnN0IHsKICAgICAgY29udGV4dDogY3R4CiAgICB9ID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoImlzRm9udFN1YnBpeGVsQUFFbmFibGVkIiwgMTAsIDEwKTsKICAgIGN0eC5zY2FsZSgxLjUsIDEpOwogICAgY3R4LmZpbGxUZXh0KCJJIiwgMCwgMTApOwogICAgY29uc3QgZGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgMTAsIDEwKS5kYXRhOwogICAgbGV0IGVuYWJsZWQgPSBmYWxzZTsKICAgIGZvciAobGV0IGkgPSAzOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gNCkgewogICAgICBpZiAoZGF0YVtpXSA+IDAgJiYgZGF0YVtpXSA8IDI1NSkgewogICAgICAgIGVuYWJsZWQgPSB0cnVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc0ZvbnRTdWJwaXhlbEFBRW5hYmxlZCIsIGVuYWJsZWQpOwogIH0KICBzaG93VGV4dChvcElkeCwgZ2x5cGhzKSB7CiAgICBpZiAodGhpcy5kZXBlbmRlbmN5VHJhY2tlcikgewogICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyLnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLnNob3dUZXh0KS5yZXNldEJCb3gob3BJZHgpOwogICAgICBpZiAodGhpcy5jdXJyZW50LnRleHRSZW5kZXJpbmdNb2RlICYgVGV4dFJlbmRlcmluZ01vZGUuQUREX1RPX1BBVEhfRkxBRykgewogICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeSgidGV4dENsaXAiLCBvcElkeCkuaW5oZXJpdFBlbmRpbmdEZXBlbmRlbmNpZXNBc0Z1dHVyZUZvcmNlZERlcGVuZGVuY2llcygpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5jdXJyZW50OwogICAgY29uc3QgZm9udCA9IGN1cnJlbnQuZm9udDsKICAgIGlmIChmb250LmlzVHlwZTNGb250KSB7CiAgICAgIHRoaXMuc2hvd1R5cGUzVGV4dChvcElkeCwgZ2x5cGhzKTsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2hvd1RleHRPcGVyYXRpb24ob3BJZHgpOwogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgY29uc3QgZm9udFNpemUgPSBjdXJyZW50LmZvbnRTaXplOwogICAgaWYgKGZvbnRTaXplID09PSAwKSB7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IGZvbnRTaXplU2NhbGUgPSBjdXJyZW50LmZvbnRTaXplU2NhbGU7CiAgICBjb25zdCBjaGFyU3BhY2luZyA9IGN1cnJlbnQuY2hhclNwYWNpbmc7CiAgICBjb25zdCB3b3JkU3BhY2luZyA9IGN1cnJlbnQud29yZFNwYWNpbmc7CiAgICBjb25zdCBmb250RGlyZWN0aW9uID0gY3VycmVudC5mb250RGlyZWN0aW9uOwogICAgY29uc3QgdGV4dEhTY2FsZSA9IGN1cnJlbnQudGV4dEhTY2FsZSAqIGZvbnREaXJlY3Rpb247CiAgICBjb25zdCBnbHlwaHNMZW5ndGggPSBnbHlwaHMubGVuZ3RoOwogICAgY29uc3QgdmVydGljYWwgPSBmb250LnZlcnRpY2FsOwogICAgY29uc3Qgc3BhY2luZ0RpciA9IHZlcnRpY2FsID8gMSA6IC0xOwogICAgY29uc3QgZGVmYXVsdFZNZXRyaWNzID0gZm9udC5kZWZhdWx0Vk1ldHJpY3M7CiAgICBjb25zdCB3aWR0aEFkdmFuY2VTY2FsZSA9IGZvbnRTaXplICogY3VycmVudC5mb250TWF0cml4WzBdOwogICAgY29uc3Qgc2ltcGxlRmlsbFRleHQgPSBjdXJyZW50LnRleHRSZW5kZXJpbmdNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5GSUxMICYmICFmb250LmRpc2FibGVGb250RmFjZSAmJiAhY3VycmVudC5wYXR0ZXJuRmlsbDsKICAgIGN0eC5zYXZlKCk7CiAgICBpZiAoY3VycmVudC50ZXh0TWF0cml4KSB7CiAgICAgIGN0eC50cmFuc2Zvcm0oLi4uY3VycmVudC50ZXh0TWF0cml4KTsKICAgIH0KICAgIGN0eC50cmFuc2xhdGUoY3VycmVudC54LCBjdXJyZW50LnkgKyBjdXJyZW50LnRleHRSaXNlKTsKICAgIGlmIChmb250RGlyZWN0aW9uID4gMCkgewogICAgICBjdHguc2NhbGUodGV4dEhTY2FsZSwgLTEpOwogICAgfSBlbHNlIHsKICAgICAgY3R4LnNjYWxlKHRleHRIU2NhbGUsIDEpOwogICAgfQogICAgbGV0IHBhdHRlcm5GaWxsVHJhbnNmb3JtLCBwYXR0ZXJuU3Ryb2tlVHJhbnNmb3JtOwogICAgY29uc3QgZmlsbFN0cm9rZU1vZGUgPSBjdXJyZW50LnRleHRSZW5kZXJpbmdNb2RlICYgVGV4dFJlbmRlcmluZ01vZGUuRklMTF9TVFJPS0VfTUFTSzsKICAgIGNvbnN0IG5lZWRzRmlsbCA9IGZpbGxTdHJva2VNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5GSUxMIHx8IGZpbGxTdHJva2VNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5GSUxMX1NUUk9LRTsKICAgIGNvbnN0IG5lZWRzU3Ryb2tlID0gZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLlNUUk9LRSB8fCBmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTF9TVFJPS0U7CiAgICBpZiAobmVlZHNGaWxsICYmIGN1cnJlbnQucGF0dGVybkZpbGwpIHsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY29uc3QgcGF0dGVybiA9IGN1cnJlbnQuZmlsbENvbG9yLmdldFBhdHRlcm4oY3R4LCB0aGlzLCBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShjdHgpLCBQYXRoVHlwZS5GSUxMLCBvcElkeCk7CiAgICAgIHBhdHRlcm5GaWxsVHJhbnNmb3JtID0gZ2V0Q3VycmVudFRyYW5zZm9ybShjdHgpOwogICAgICBjdHgucmVzdG9yZSgpOwogICAgICBjdHguZmlsbFN0eWxlID0gcGF0dGVybjsKICAgIH0KICAgIGlmIChuZWVkc1N0cm9rZSAmJiBjdXJyZW50LnBhdHRlcm5TdHJva2UpIHsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY29uc3QgcGF0dGVybiA9IGN1cnJlbnQuc3Ryb2tlQ29sb3IuZ2V0UGF0dGVybihjdHgsIHRoaXMsIGdldEN1cnJlbnRUcmFuc2Zvcm1JbnZlcnNlKGN0eCksIFBhdGhUeXBlLlNUUk9LRSwgb3BJZHgpOwogICAgICBwYXR0ZXJuU3Ryb2tlVHJhbnNmb3JtID0gZ2V0Q3VycmVudFRyYW5zZm9ybShjdHgpOwogICAgICBjdHgucmVzdG9yZSgpOwogICAgICBjdHguc3Ryb2tlU3R5bGUgPSBwYXR0ZXJuOwogICAgfQogICAgbGV0IGxpbmVXaWR0aCA9IGN1cnJlbnQubGluZVdpZHRoOwogICAgY29uc3Qgc2NhbGUgPSBjdXJyZW50LnRleHRNYXRyaXhTY2FsZTsKICAgIGlmIChzY2FsZSA9PT0gMCB8fCBsaW5lV2lkdGggPT09IDApIHsKICAgICAgaWYgKG5lZWRzU3Ryb2tlKSB7CiAgICAgICAgbGluZVdpZHRoID0gdGhpcy5nZXRTaW5nbGVQaXhlbFdpZHRoKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGxpbmVXaWR0aCAvPSBzY2FsZTsKICAgIH0KICAgIGlmIChmb250U2l6ZVNjYWxlICE9PSAxKSB7CiAgICAgIGN0eC5zY2FsZShmb250U2l6ZVNjYWxlLCBmb250U2l6ZVNjYWxlKTsKICAgICAgbGluZVdpZHRoIC89IGZvbnRTaXplU2NhbGU7CiAgICB9CiAgICBjdHgubGluZVdpZHRoID0gbGluZVdpZHRoOwogICAgaWYgKGZvbnQuaXNJbnZhbGlkUERGanNGb250KSB7CiAgICAgIGNvbnN0IGNoYXJzID0gW107CiAgICAgIGxldCB3aWR0aCA9IDA7CiAgICAgIGZvciAoY29uc3QgZ2x5cGggb2YgZ2x5cGhzKSB7CiAgICAgICAgY2hhcnMucHVzaChnbHlwaC51bmljb2RlKTsKICAgICAgICB3aWR0aCArPSBnbHlwaC53aWR0aDsKICAgICAgfQogICAgICBjb25zdCBqb2luZWRDaGFycyA9IGNoYXJzLmpvaW4oIiIpOwogICAgICBjdHguZmlsbFRleHQoam9pbmVkQ2hhcnMsIDAsIDApOwogICAgICBpZiAodGhpcy5kZXBlbmRlbmN5VHJhY2tlciAhPT0gbnVsbCkgewogICAgICAgIGNvbnN0IG1lYXN1cmUgPSBjdHgubWVhc3VyZVRleHQoam9pbmVkQ2hhcnMpOwogICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkQkJveChvcElkeCwgdGhpcy5jdHgsIC1tZWFzdXJlLmFjdHVhbEJvdW5kaW5nQm94TGVmdCwgbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveFJpZ2h0LCAtbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveEFzY2VudCwgbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveERlc2NlbnQpLnJlY29yZFNob3dUZXh0T3BlcmF0aW9uKG9wSWR4KTsKICAgICAgfQogICAgICBjdXJyZW50LnggKz0gd2lkdGggKiB3aWR0aEFkdmFuY2VTY2FsZSAqIHRleHRIU2NhbGU7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgIHRoaXMuY29tcG9zZSgpOwogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgbGV0IHggPSAwLCBpOwogICAgZm9yIChpID0gMDsgaSA8IGdseXBoc0xlbmd0aDsgKytpKSB7CiAgICAgIGNvbnN0IGdseXBoID0gZ2x5cGhzW2ldOwogICAgICBpZiAodHlwZW9mIGdseXBoID09PSAibnVtYmVyIikgewogICAgICAgIHggKz0gc3BhY2luZ0RpciAqIGdseXBoICogZm9udFNpemUgLyAxZTM7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbGV0IHJlc3RvcmVOZWVkZWQgPSBmYWxzZTsKICAgICAgY29uc3Qgc3BhY2luZyA9IChnbHlwaC5pc1NwYWNlID8gd29yZFNwYWNpbmcgOiAwKSArIGNoYXJTcGFjaW5nOwogICAgICBjb25zdCBjaGFyYWN0ZXIgPSBnbHlwaC5mb250Q2hhcjsKICAgICAgY29uc3QgYWNjZW50ID0gZ2x5cGguYWNjZW50OwogICAgICBsZXQgc2NhbGVkWCwgc2NhbGVkWTsKICAgICAgbGV0IHdpZHRoID0gZ2x5cGgud2lkdGg7CiAgICAgIGlmICh2ZXJ0aWNhbCkgewogICAgICAgIGNvbnN0IHZtZXRyaWMgPSBnbHlwaC52bWV0cmljIHx8IGRlZmF1bHRWTWV0cmljczsKICAgICAgICBjb25zdCB2eCA9IC0oZ2x5cGgudm1ldHJpYyA/IHZtZXRyaWNbMV0gOiB3aWR0aCAqIDAuNSkgKiB3aWR0aEFkdmFuY2VTY2FsZTsKICAgICAgICBjb25zdCB2eSA9IHZtZXRyaWNbMl0gKiB3aWR0aEFkdmFuY2VTY2FsZTsKICAgICAgICB3aWR0aCA9IHZtZXRyaWMgPyAtdm1ldHJpY1swXSA6IHdpZHRoOwogICAgICAgIHNjYWxlZFggPSB2eCAvIGZvbnRTaXplU2NhbGU7CiAgICAgICAgc2NhbGVkWSA9ICh4ICsgdnkpIC8gZm9udFNpemVTY2FsZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzY2FsZWRYID0geCAvIGZvbnRTaXplU2NhbGU7CiAgICAgICAgc2NhbGVkWSA9IDA7CiAgICAgIH0KICAgICAgbGV0IG1lYXN1cmU7CiAgICAgIGlmIChmb250LnJlbWVhc3VyZSAmJiB3aWR0aCA+IDApIHsKICAgICAgICBtZWFzdXJlID0gY3R4Lm1lYXN1cmVUZXh0KGNoYXJhY3Rlcik7CiAgICAgICAgY29uc3QgbWVhc3VyZWRXaWR0aCA9IG1lYXN1cmUud2lkdGggKiAxZTMgLyBmb250U2l6ZSAqIGZvbnRTaXplU2NhbGU7CiAgICAgICAgaWYgKHdpZHRoIDwgbWVhc3VyZWRXaWR0aCAmJiB0aGlzLmlzRm9udFN1YnBpeGVsQUFFbmFibGVkKSB7CiAgICAgICAgICBjb25zdCBjaGFyYWN0ZXJTY2FsZVggPSB3aWR0aCAvIG1lYXN1cmVkV2lkdGg7CiAgICAgICAgICByZXN0b3JlTmVlZGVkID0gdHJ1ZTsKICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICBjdHguc2NhbGUoY2hhcmFjdGVyU2NhbGVYLCAxKTsKICAgICAgICAgIHNjYWxlZFggLz0gY2hhcmFjdGVyU2NhbGVYOwogICAgICAgIH0gZWxzZSBpZiAod2lkdGggIT09IG1lYXN1cmVkV2lkdGgpIHsKICAgICAgICAgIHNjYWxlZFggKz0gKHdpZHRoIC0gbWVhc3VyZWRXaWR0aCkgLyAyZTMgKiBmb250U2l6ZSAvIGZvbnRTaXplU2NhbGU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLmNvbnRlbnRWaXNpYmxlICYmIChnbHlwaC5pc0luRm9udCB8fCBmb250Lm1pc3NpbmdGaWxlKSkgewogICAgICAgIGlmIChzaW1wbGVGaWxsVGV4dCAmJiAhYWNjZW50KSB7CiAgICAgICAgICBjdHguZmlsbFRleHQoY2hhcmFjdGVyLCBzY2FsZWRYLCBzY2FsZWRZKTsKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZENoYXJhY3RlckJCb3gob3BJZHgsIGN0eCwgbWVhc3VyZSA/IHsKICAgICAgICAgICAgYmJveDogbnVsbAogICAgICAgICAgfSA6IGZvbnQsIGZvbnRTaXplIC8gZm9udFNpemVTY2FsZSwgc2NhbGVkWCwgc2NhbGVkWSwgKCkgPT4gbWVhc3VyZSA/PyBjdHgubWVhc3VyZVRleHQoY2hhcmFjdGVyKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucGFpbnRDaGFyKG9wSWR4LCBjaGFyYWN0ZXIsIHNjYWxlZFgsIHNjYWxlZFksIHBhdHRlcm5GaWxsVHJhbnNmb3JtLCBwYXR0ZXJuU3Ryb2tlVHJhbnNmb3JtKTsKICAgICAgICAgIGlmIChhY2NlbnQpIHsKICAgICAgICAgICAgY29uc3Qgc2NhbGVkQWNjZW50WCA9IHNjYWxlZFggKyBmb250U2l6ZSAqIGFjY2VudC5vZmZzZXQueCAvIGZvbnRTaXplU2NhbGU7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlZEFjY2VudFkgPSBzY2FsZWRZIC0gZm9udFNpemUgKiBhY2NlbnQub2Zmc2V0LnkgLyBmb250U2l6ZVNjYWxlOwogICAgICAgICAgICB0aGlzLnBhaW50Q2hhcihvcElkeCwgYWNjZW50LmZvbnRDaGFyLCBzY2FsZWRBY2NlbnRYLCBzY2FsZWRBY2NlbnRZLCBwYXR0ZXJuRmlsbFRyYW5zZm9ybSwgcGF0dGVyblN0cm9rZVRyYW5zZm9ybSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGNoYXJXaWR0aCA9IHZlcnRpY2FsID8gd2lkdGggKiB3aWR0aEFkdmFuY2VTY2FsZSAtIHNwYWNpbmcgKiBmb250RGlyZWN0aW9uIDogd2lkdGggKiB3aWR0aEFkdmFuY2VTY2FsZSArIHNwYWNpbmcgKiBmb250RGlyZWN0aW9uOwogICAgICB4ICs9IGNoYXJXaWR0aDsKICAgICAgaWYgKHJlc3RvcmVOZWVkZWQpIHsKICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICB9CiAgICB9CiAgICBpZiAodmVydGljYWwpIHsKICAgICAgY3VycmVudC55IC09IHg7CiAgICB9IGVsc2UgewogICAgICBjdXJyZW50LnggKz0geCAqIHRleHRIU2NhbGU7CiAgICB9CiAgICBjdHgucmVzdG9yZSgpOwogICAgdGhpcy5jb21wb3NlKCk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaG93VGV4dE9wZXJhdGlvbihvcElkeCk7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBzaG93VHlwZTNUZXh0KG9wSWR4LCBnbHlwaHMpIHsKICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgY29uc3QgY3VycmVudCA9IHRoaXMuY3VycmVudDsKICAgIGNvbnN0IGZvbnQgPSBjdXJyZW50LmZvbnQ7CiAgICBjb25zdCBmb250U2l6ZSA9IGN1cnJlbnQuZm9udFNpemU7CiAgICBjb25zdCBmb250RGlyZWN0aW9uID0gY3VycmVudC5mb250RGlyZWN0aW9uOwogICAgY29uc3Qgc3BhY2luZ0RpciA9IGZvbnQudmVydGljYWwgPyAxIDogLTE7CiAgICBjb25zdCBjaGFyU3BhY2luZyA9IGN1cnJlbnQuY2hhclNwYWNpbmc7CiAgICBjb25zdCB3b3JkU3BhY2luZyA9IGN1cnJlbnQud29yZFNwYWNpbmc7CiAgICBjb25zdCB0ZXh0SFNjYWxlID0gY3VycmVudC50ZXh0SFNjYWxlICogZm9udERpcmVjdGlvbjsKICAgIGNvbnN0IGZvbnRNYXRyaXggPSBjdXJyZW50LmZvbnRNYXRyaXggfHwgRk9OVF9JREVOVElUWV9NQVRSSVg7CiAgICBjb25zdCBnbHlwaHNMZW5ndGggPSBnbHlwaHMubGVuZ3RoOwogICAgY29uc3QgaXNUZXh0SW52aXNpYmxlID0gY3VycmVudC50ZXh0UmVuZGVyaW5nTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuSU5WSVNJQkxFOwogICAgbGV0IGksIGdseXBoLCB3aWR0aCwgc3BhY2luZ0xlbmd0aDsKICAgIGlmIChpc1RleHRJbnZpc2libGUgfHwgZm9udFNpemUgPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fY2FjaGVkU2NhbGVGb3JTdHJva2luZ1swXSA9IC0xOwogICAgdGhpcy5fY2FjaGVkR2V0U2luZ2xlUGl4ZWxXaWR0aCA9IG51bGw7CiAgICBjdHguc2F2ZSgpOwogICAgaWYgKGN1cnJlbnQudGV4dE1hdHJpeCkgewogICAgICBjdHgudHJhbnNmb3JtKC4uLmN1cnJlbnQudGV4dE1hdHJpeCk7CiAgICB9CiAgICBjdHgudHJhbnNsYXRlKGN1cnJlbnQueCwgY3VycmVudC55ICsgY3VycmVudC50ZXh0UmlzZSk7CiAgICBjdHguc2NhbGUodGV4dEhTY2FsZSwgZm9udERpcmVjdGlvbik7CiAgICBjb25zdCBkZXBlbmRlbmN5VHJhY2tlciA9IHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyID0gZGVwZW5kZW5jeVRyYWNrZXIgPyBuZXcgQ2FudmFzTmVzdGVkRGVwZW5kZW5jeVRyYWNrZXIoZGVwZW5kZW5jeVRyYWNrZXIsIG9wSWR4KSA6IG51bGw7CiAgICBmb3IgKGkgPSAwOyBpIDwgZ2x5cGhzTGVuZ3RoOyArK2kpIHsKICAgICAgZ2x5cGggPSBnbHlwaHNbaV07CiAgICAgIGlmICh0eXBlb2YgZ2x5cGggPT09ICJudW1iZXIiKSB7CiAgICAgICAgc3BhY2luZ0xlbmd0aCA9IHNwYWNpbmdEaXIgKiBnbHlwaCAqIGZvbnRTaXplIC8gMWUzOwogICAgICAgIHRoaXMuY3R4LnRyYW5zbGF0ZShzcGFjaW5nTGVuZ3RoLCAwKTsKICAgICAgICBjdXJyZW50LnggKz0gc3BhY2luZ0xlbmd0aCAqIHRleHRIU2NhbGU7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3Qgc3BhY2luZyA9IChnbHlwaC5pc1NwYWNlID8gd29yZFNwYWNpbmcgOiAwKSArIGNoYXJTcGFjaW5nOwogICAgICBjb25zdCBvcGVyYXRvckxpc3QgPSBmb250LmNoYXJQcm9jT3BlcmF0b3JMaXN0W2dseXBoLm9wZXJhdG9yTGlzdElkXTsKICAgICAgaWYgKCFvcGVyYXRvckxpc3QpIHsKICAgICAgICB3YXJuKGBUeXBlMyBjaGFyYWN0ZXIgIiR7Z2x5cGgub3BlcmF0b3JMaXN0SWR9IiBpcyBub3QgYXZhaWxhYmxlLmApOwogICAgICB9IGVsc2UgaWYgKHRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgICB0aGlzLnNhdmUoKTsKICAgICAgICBjdHguc2NhbGUoZm9udFNpemUsIGZvbnRTaXplKTsKICAgICAgICBjdHgudHJhbnNmb3JtKC4uLmZvbnRNYXRyaXgpOwogICAgICAgIHRoaXMuZXhlY3V0ZU9wZXJhdG9yTGlzdChvcGVyYXRvckxpc3QpOwogICAgICAgIHRoaXMucmVzdG9yZSgpOwogICAgICB9CiAgICAgIGNvbnN0IHAgPSBbZ2x5cGgud2lkdGgsIDBdOwogICAgICBVdGlsLmFwcGx5VHJhbnNmb3JtKHAsIGZvbnRNYXRyaXgpOwogICAgICB3aWR0aCA9IHBbMF0gKiBmb250U2l6ZSArIHNwYWNpbmc7CiAgICAgIGN0eC50cmFuc2xhdGUod2lkdGgsIDApOwogICAgICBjdXJyZW50LnggKz0gd2lkdGggKiB0ZXh0SFNjYWxlOwogICAgfQogICAgY3R4LnJlc3RvcmUoKTsKICAgIGlmIChkZXBlbmRlbmN5VHJhY2tlcikgewogICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyID0gZGVwZW5kZW5jeVRyYWNrZXI7CiAgICB9CiAgfQogIHNldENoYXJXaWR0aChvcElkeCwgeFdpZHRoLCB5V2lkdGgpIHsKICB9CiAgc2V0Q2hhcldpZHRoQW5kQm91bmRzKG9wSWR4LCB4V2lkdGgsIHlXaWR0aCwgbGx4LCBsbHksIHVyeCwgdXJ5KSB7CiAgICBjb25zdCBjbGlwID0gbmV3IFBhdGgyRCgpOwogICAgY2xpcC5yZWN0KGxseCwgbGx5LCB1cnggLSBsbHgsIHVyeSAtIGxseSk7CiAgICB0aGlzLmN0eC5jbGlwKGNsaXApOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkQkJveChvcElkeCwgdGhpcy5jdHgsIGxseCwgdXJ4LCBsbHksIHVyeSkucmVjb3JkQ2xpcEJveChvcElkeCwgdGhpcy5jdHgsIGxseCwgdXJ4LCBsbHksIHVyeSk7CiAgICB0aGlzLmVuZFBhdGgob3BJZHgpOwogIH0KICBnZXRDb2xvck5fUGF0dGVybihvcElkeCwgSVIpIHsKICAgIGxldCBwYXR0ZXJuOwogICAgaWYgKElSWzBdID09PSAiVGlsaW5nUGF0dGVybiIpIHsKICAgICAgY29uc3QgYmFzZVRyYW5zZm9ybSA9IHRoaXMuYmFzZVRyYW5zZm9ybSB8fCBnZXRDdXJyZW50VHJhbnNmb3JtKHRoaXMuY3R4KTsKICAgICAgY29uc3QgY2FudmFzR3JhcGhpY3NGYWN0b3J5ID0gewogICAgICAgIGNyZWF0ZUNhbnZhc0dyYXBoaWNzOiAoY3R4LCByZW5kZXJpbmdPcElkeCkgPT4gbmV3IF9DYW52YXNHcmFwaGljcyhjdHgsIHRoaXMuY29tbW9uT2JqcywgdGhpcy5vYmpzLCB0aGlzLmNhbnZhc0ZhY3RvcnksIHRoaXMuZmlsdGVyRmFjdG9yeSwgewogICAgICAgICAgb3B0aW9uYWxDb250ZW50Q29uZmlnOiB0aGlzLm9wdGlvbmFsQ29udGVudENvbmZpZywKICAgICAgICAgIG1hcmtlZENvbnRlbnRTdGFjazogdGhpcy5tYXJrZWRDb250ZW50U3RhY2sKICAgICAgICB9LCB2b2lkIDAsIHZvaWQgMCwgdGhpcy5kZXBlbmRlbmN5VHJhY2tlciA/IG5ldyBDYW52YXNOZXN0ZWREZXBlbmRlbmN5VHJhY2tlcih0aGlzLmRlcGVuZGVuY3lUcmFja2VyLCByZW5kZXJpbmdPcElkeCwgdHJ1ZSkgOiBudWxsKQogICAgICB9OwogICAgICBwYXR0ZXJuID0gbmV3IFRpbGluZ1BhdHRlcm4oSVIsIHRoaXMuY3R4LCBjYW52YXNHcmFwaGljc0ZhY3RvcnksIGJhc2VUcmFuc2Zvcm0pOwogICAgfSBlbHNlIHsKICAgICAgcGF0dGVybiA9IHRoaXMuX2dldFBhdHRlcm4ob3BJZHgsIElSWzFdLCBJUlsyXSk7CiAgICB9CiAgICByZXR1cm4gcGF0dGVybjsKICB9CiAgc2V0U3Ryb2tlQ29sb3JOKG9wSWR4LCAuLi5hcmdzKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJzdHJva2VDb2xvciIsIG9wSWR4KTsKICAgIHRoaXMuY3VycmVudC5zdHJva2VDb2xvciA9IHRoaXMuZ2V0Q29sb3JOX1BhdHRlcm4ob3BJZHgsIGFyZ3MpOwogICAgdGhpcy5jdXJyZW50LnBhdHRlcm5TdHJva2UgPSB0cnVlOwogIH0KICBzZXRGaWxsQ29sb3JOKG9wSWR4LCAuLi5hcmdzKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJmaWxsQ29sb3IiLCBvcElkeCk7CiAgICB0aGlzLmN1cnJlbnQuZmlsbENvbG9yID0gdGhpcy5nZXRDb2xvck5fUGF0dGVybihvcElkeCwgYXJncyk7CiAgICB0aGlzLmN1cnJlbnQucGF0dGVybkZpbGwgPSB0cnVlOwogIH0KICBzZXRTdHJva2VSR0JDb2xvcihvcElkeCwgY29sb3IpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoInN0cm9rZUNvbG9yIiwgb3BJZHgpOwogICAgdGhpcy5jdHguc3Ryb2tlU3R5bGUgPSB0aGlzLmN1cnJlbnQuc3Ryb2tlQ29sb3IgPSBjb2xvcjsKICAgIHRoaXMuY3VycmVudC5wYXR0ZXJuU3Ryb2tlID0gZmFsc2U7CiAgfQogIHNldFN0cm9rZVRyYW5zcGFyZW50KG9wSWR4KSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJzdHJva2VDb2xvciIsIG9wSWR4KTsKICAgIHRoaXMuY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5jdXJyZW50LnN0cm9rZUNvbG9yID0gInRyYW5zcGFyZW50IjsKICAgIHRoaXMuY3VycmVudC5wYXR0ZXJuU3Ryb2tlID0gZmFsc2U7CiAgfQogIHNldEZpbGxSR0JDb2xvcihvcElkeCwgY29sb3IpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImZpbGxDb2xvciIsIG9wSWR4KTsKICAgIHRoaXMuY3R4LmZpbGxTdHlsZSA9IHRoaXMuY3VycmVudC5maWxsQ29sb3IgPSBjb2xvcjsKICAgIHRoaXMuY3VycmVudC5wYXR0ZXJuRmlsbCA9IGZhbHNlOwogIH0KICBzZXRGaWxsVHJhbnNwYXJlbnQob3BJZHgpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImZpbGxDb2xvciIsIG9wSWR4KTsKICAgIHRoaXMuY3R4LmZpbGxTdHlsZSA9IHRoaXMuY3VycmVudC5maWxsQ29sb3IgPSAidHJhbnNwYXJlbnQiOwogICAgdGhpcy5jdXJyZW50LnBhdHRlcm5GaWxsID0gZmFsc2U7CiAgfQogIF9nZXRQYXR0ZXJuKG9wSWR4LCBvYmpJZCwgbWF0cml4ID0gbnVsbCkgewogICAgbGV0IHBhdHRlcm47CiAgICBpZiAodGhpcy5jYWNoZWRQYXR0ZXJucy5oYXMob2JqSWQpKSB7CiAgICAgIHBhdHRlcm4gPSB0aGlzLmNhY2hlZFBhdHRlcm5zLmdldChvYmpJZCk7CiAgICB9IGVsc2UgewogICAgICBwYXR0ZXJuID0gZ2V0U2hhZGluZ1BhdHRlcm4odGhpcy5nZXRPYmplY3Qob3BJZHgsIG9iaklkKSk7CiAgICAgIHRoaXMuY2FjaGVkUGF0dGVybnMuc2V0KG9iaklkLCBwYXR0ZXJuKTsKICAgIH0KICAgIGlmIChtYXRyaXgpIHsKICAgICAgcGF0dGVybi5tYXRyaXggPSBtYXRyaXg7CiAgICB9CiAgICByZXR1cm4gcGF0dGVybjsKICB9CiAgc2hhZGluZ0ZpbGwob3BJZHgsIG9iaklkKSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICB0aGlzLnNhdmUob3BJZHgpOwogICAgY29uc3QgcGF0dGVybiA9IHRoaXMuX2dldFBhdHRlcm4ob3BJZHgsIG9iaklkKTsKICAgIGN0eC5maWxsU3R5bGUgPSBwYXR0ZXJuLmdldFBhdHRlcm4oY3R4LCB0aGlzLCBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShjdHgpLCBQYXRoVHlwZS5TSEFESU5HLCBvcElkeCk7CiAgICBjb25zdCBpbnYgPSBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShjdHgpOwogICAgaWYgKGludikgewogICAgICBjb25zdCB7CiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0CiAgICAgIH0gPSBjdHguY2FudmFzOwogICAgICBjb25zdCBtaW5NYXggPSBNSU5fTUFYX0lOSVQuc2xpY2UoKTsKICAgICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChbMCwgMCwgd2lkdGgsIGhlaWdodF0sIGludiwgbWluTWF4KTsKICAgICAgY29uc3QgW3gwLCB5MCwgeDEsIHkxXSA9IG1pbk1heDsKICAgICAgdGhpcy5jdHguZmlsbFJlY3QoeDAsIHkwLCB4MSAtIHgwLCB5MSAtIHkwKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuY3R4LmZpbGxSZWN0KC0xZTEwLCAtMWUxMCwgMmUxMCwgMmUxMCk7CiAgICB9CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZXNldEJCb3gob3BJZHgpLnJlY29yZEZ1bGxQYWdlQkJveChvcElkeCkucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMudHJhbnNmb3JtKS5yZWNvcmREZXBlbmRlbmNpZXMob3BJZHgsIERlcGVuZGVuY2llcy5maWxsKS5yZWNvcmRPcGVyYXRpb24ob3BJZHgpOwogICAgdGhpcy5jb21wb3NlKHRoaXMuY3VycmVudC5nZXRDbGlwcGVkUGF0aEJvdW5kaW5nQm94KCkpOwogICAgdGhpcy5yZXN0b3JlKG9wSWR4KTsKICB9CiAgYmVnaW5JbmxpbmVJbWFnZSgpIHsKICAgIHVucmVhY2hhYmxlKCJTaG91bGQgbm90IGNhbGwgYmVnaW5JbmxpbmVJbWFnZSIpOwogIH0KICBiZWdpbkltYWdlRGF0YSgpIHsKICAgIHVucmVhY2hhYmxlKCJTaG91bGQgbm90IGNhbGwgYmVnaW5JbWFnZURhdGEiKTsKICB9CiAgcGFpbnRGb3JtWE9iamVjdEJlZ2luKG9wSWR4LCBtYXRyaXgsIGJib3gpIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnNhdmUob3BJZHgpOwogICAgdGhpcy5iYXNlVHJhbnNmb3JtU3RhY2sucHVzaCh0aGlzLmJhc2VUcmFuc2Zvcm0pOwogICAgaWYgKG1hdHJpeCkgewogICAgICB0aGlzLnRyYW5zZm9ybShvcElkeCwgLi4ubWF0cml4KTsKICAgIH0KICAgIHRoaXMuYmFzZVRyYW5zZm9ybSA9IGdldEN1cnJlbnRUcmFuc2Zvcm0odGhpcy5jdHgpOwogICAgaWYgKGJib3gpIHsKICAgICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChiYm94LCB0aGlzLmJhc2VUcmFuc2Zvcm0sIHRoaXMuY3VycmVudC5taW5NYXgpOwogICAgICBjb25zdCBbeDAsIHkwLCB4MSwgeTFdID0gYmJveDsKICAgICAgY29uc3QgY2xpcCA9IG5ldyBQYXRoMkQoKTsKICAgICAgY2xpcC5yZWN0KHgwLCB5MCwgeDEgLSB4MCwgeTEgLSB5MCk7CiAgICAgIHRoaXMuY3R4LmNsaXAoY2xpcCk7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZENsaXBCb3gob3BJZHgsIHRoaXMuY3R4LCB4MCwgeDEsIHkwLCB5MSk7CiAgICAgIHRoaXMuZW5kUGF0aChvcElkeCk7CiAgICB9CiAgfQogIHBhaW50Rm9ybVhPYmplY3RFbmQob3BJZHgpIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnJlc3RvcmUob3BJZHgpOwogICAgdGhpcy5iYXNlVHJhbnNmb3JtID0gdGhpcy5iYXNlVHJhbnNmb3JtU3RhY2sucG9wKCk7CiAgfQogIGJlZ2luR3JvdXAob3BJZHgsIGdyb3VwKSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5zYXZlKG9wSWR4KTsKICAgIGlmICh0aGlzLmluU01hc2tNb2RlKSB7CiAgICAgIHRoaXMuZW5kU01hc2tNb2RlKCk7CiAgICAgIHRoaXMuY3VycmVudC5hY3RpdmVTTWFzayA9IG51bGw7CiAgICB9CiAgICBjb25zdCBjdXJyZW50Q3R4ID0gdGhpcy5jdHg7CiAgICBpZiAoIWdyb3VwLmlzb2xhdGVkKSB7CiAgICAgIGluZm8oIlRPRE86IFN1cHBvcnQgbm9uLWlzb2xhdGVkIGdyb3Vwcy4iKTsKICAgIH0KICAgIGlmIChncm91cC5rbm9ja291dCkgewogICAgICB3YXJuKCJLbm9ja291dCBncm91cHMgbm90IHN1cHBvcnRlZC4iKTsKICAgIH0KICAgIGNvbnN0IGN1cnJlbnRUcmFuc2Zvcm0gPSBnZXRDdXJyZW50VHJhbnNmb3JtKGN1cnJlbnRDdHgpOwogICAgaWYgKGdyb3VwLm1hdHJpeCkgewogICAgICBjdXJyZW50Q3R4LnRyYW5zZm9ybSguLi5ncm91cC5tYXRyaXgpOwogICAgfQogICAgaWYgKCFncm91cC5iYm94KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQm91bmRpbmcgYm94IGlzIHJlcXVpcmVkLiIpOwogICAgfQogICAgbGV0IGJvdW5kcyA9IE1JTl9NQVhfSU5JVC5zbGljZSgpOwogICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChncm91cC5iYm94LCBnZXRDdXJyZW50VHJhbnNmb3JtKGN1cnJlbnRDdHgpLCBib3VuZHMpOwogICAgY29uc3QgY2FudmFzQm91bmRzID0gWzAsIDAsIGN1cnJlbnRDdHguY2FudmFzLndpZHRoLCBjdXJyZW50Q3R4LmNhbnZhcy5oZWlnaHRdOwogICAgYm91bmRzID0gVXRpbC5pbnRlcnNlY3QoYm91bmRzLCBjYW52YXNCb3VuZHMpIHx8IFswLCAwLCAwLCAwXTsKICAgIGNvbnN0IG9mZnNldFggPSBNYXRoLmZsb29yKGJvdW5kc1swXSk7CiAgICBjb25zdCBvZmZzZXRZID0gTWF0aC5mbG9vcihib3VuZHNbMV0pOwogICAgY29uc3QgZHJhd25XaWR0aCA9IE1hdGgubWF4KE1hdGguY2VpbChib3VuZHNbMl0pIC0gb2Zmc2V0WCwgMSk7CiAgICBjb25zdCBkcmF3bkhlaWdodCA9IE1hdGgubWF4KE1hdGguY2VpbChib3VuZHNbM10pIC0gb2Zmc2V0WSwgMSk7CiAgICB0aGlzLmN1cnJlbnQuc3RhcnROZXdQYXRoQW5kQ2xpcEJveChbMCwgMCwgZHJhd25XaWR0aCwgZHJhd25IZWlnaHRdKTsKICAgIGxldCBjYWNoZUlkID0gImdyb3VwQXQiICsgdGhpcy5ncm91cExldmVsOwogICAgaWYgKGdyb3VwLnNtYXNrKSB7CiAgICAgIGNhY2hlSWQgKz0gIl9zbWFza18iICsgdGhpcy5zbWFza0NvdW50ZXIrKyAlIDI7CiAgICB9CiAgICBjb25zdCBzY3JhdGNoQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoY2FjaGVJZCwgZHJhd25XaWR0aCwgZHJhd25IZWlnaHQpOwogICAgY29uc3QgZ3JvdXBDdHggPSBzY3JhdGNoQ2FudmFzLmNvbnRleHQ7CiAgICBncm91cEN0eC50cmFuc2xhdGUoLW9mZnNldFgsIC1vZmZzZXRZKTsKICAgIGdyb3VwQ3R4LnRyYW5zZm9ybSguLi5jdXJyZW50VHJhbnNmb3JtKTsKICAgIGxldCBjbGlwID0gbmV3IFBhdGgyRCgpOwogICAgY29uc3QgW3gwLCB5MCwgeDEsIHkxXSA9IGdyb3VwLmJib3g7CiAgICBjbGlwLnJlY3QoeDAsIHkwLCB4MSAtIHgwLCB5MSAtIHkwKTsKICAgIGlmIChncm91cC5tYXRyaXgpIHsKICAgICAgY29uc3QgcGF0aCA9IG5ldyBQYXRoMkQoKTsKICAgICAgcGF0aC5hZGRQYXRoKGNsaXAsIG5ldyBET01NYXRyaXgoZ3JvdXAubWF0cml4KSk7CiAgICAgIGNsaXAgPSBwYXRoOwogICAgfQogICAgZ3JvdXBDdHguY2xpcChjbGlwKTsKICAgIGlmIChncm91cC5zbWFzaykgewogICAgICB0aGlzLnNtYXNrU3RhY2sucHVzaCh7CiAgICAgICAgY2FudmFzOiBzY3JhdGNoQ2FudmFzLmNhbnZhcywKICAgICAgICBjb250ZXh0OiBncm91cEN0eCwKICAgICAgICBvZmZzZXRYLAogICAgICAgIG9mZnNldFksCiAgICAgICAgc3VidHlwZTogZ3JvdXAuc21hc2suc3VidHlwZSwKICAgICAgICBiYWNrZHJvcDogZ3JvdXAuc21hc2suYmFja2Ryb3AsCiAgICAgICAgdHJhbnNmZXJNYXA6IGdyb3VwLnNtYXNrLnRyYW5zZmVyTWFwIHx8IG51bGwsCiAgICAgICAgc3RhcnRUcmFuc2Zvcm1JbnZlcnNlOiBudWxsCiAgICAgIH0pOwogICAgfQogICAgaWYgKCFncm91cC5zbWFzayB8fCB0aGlzLmRlcGVuZGVuY3lUcmFja2VyKSB7CiAgICAgIGN1cnJlbnRDdHguc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgICBjdXJyZW50Q3R4LnRyYW5zbGF0ZShvZmZzZXRYLCBvZmZzZXRZKTsKICAgICAgY3VycmVudEN0eC5zYXZlKCk7CiAgICB9CiAgICBjb3B5Q3R4U3RhdGUoY3VycmVudEN0eCwgZ3JvdXBDdHgpOwogICAgdGhpcy5jdHggPSBncm91cEN0eDsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LmluaGVyaXRTaW1wbGVEYXRhQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMoWyJmaWxsQWxwaGEiLCAic3Ryb2tlQWxwaGEiLCAiZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uIl0pLnB1c2hCYXNlVHJhbnNmb3JtKGN1cnJlbnRDdHgpOwogICAgdGhpcy5zZXRHU3RhdGUob3BJZHgsIFtbIkJNIiwgInNvdXJjZS1vdmVyIl0sIFsiY2EiLCAxXSwgWyJDQSIsIDFdXSk7CiAgICB0aGlzLmdyb3VwU3RhY2sucHVzaChjdXJyZW50Q3R4KTsKICAgIHRoaXMuZ3JvdXBMZXZlbCsrOwogIH0KICBlbmRHcm91cChvcElkeCwgZ3JvdXApIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmdyb3VwTGV2ZWwtLTsKICAgIGNvbnN0IGdyb3VwQ3R4ID0gdGhpcy5jdHg7CiAgICBjb25zdCBjdHggPSB0aGlzLmdyb3VwU3RhY2sucG9wKCk7CiAgICB0aGlzLmN0eCA9IGN0eDsKICAgIHRoaXMuY3R4LmltYWdlU21vb3RoaW5nRW5hYmxlZCA9IGZhbHNlOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucG9wQmFzZVRyYW5zZm9ybSgpOwogICAgaWYgKGdyb3VwLnNtYXNrKSB7CiAgICAgIHRoaXMudGVtcFNNYXNrID0gdGhpcy5zbWFza1N0YWNrLnBvcCgpOwogICAgICB0aGlzLnJlc3RvcmUob3BJZHgpOwogICAgICBpZiAodGhpcy5kZXBlbmRlbmN5VHJhY2tlcikgewogICAgICAgIHRoaXMuY3R4LnJlc3RvcmUoKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5jdHgucmVzdG9yZSgpOwogICAgICBjb25zdCBjdXJyZW50TXR4ID0gZ2V0Q3VycmVudFRyYW5zZm9ybSh0aGlzLmN0eCk7CiAgICAgIHRoaXMucmVzdG9yZShvcElkeCk7CiAgICAgIHRoaXMuY3R4LnNhdmUoKTsKICAgICAgdGhpcy5jdHguc2V0VHJhbnNmb3JtKC4uLmN1cnJlbnRNdHgpOwogICAgICBjb25zdCBkaXJ0eUJveCA9IE1JTl9NQVhfSU5JVC5zbGljZSgpOwogICAgICBVdGlsLmF4aWFsQWxpZ25lZEJvdW5kaW5nQm94KFswLCAwLCBncm91cEN0eC5jYW52YXMud2lkdGgsIGdyb3VwQ3R4LmNhbnZhcy5oZWlnaHRdLCBjdXJyZW50TXR4LCBkaXJ0eUJveCk7CiAgICAgIHRoaXMuY3R4LmRyYXdJbWFnZShncm91cEN0eC5jYW52YXMsIDAsIDApOwogICAgICB0aGlzLmN0eC5yZXN0b3JlKCk7CiAgICAgIHRoaXMuY29tcG9zZShkaXJ0eUJveCk7CiAgICB9CiAgfQogIGJlZ2luQW5ub3RhdGlvbihvcElkeCwgaWQsIHJlY3QsIHRyYW5zZm9ybSwgbWF0cml4LCBoYXNPd25DYW52YXMpIHsKICAgIHRoaXMuI3Jlc3RvcmVJbml0aWFsU3RhdGUoKTsKICAgIHJlc2V0Q3R4VG9EZWZhdWx0KHRoaXMuY3R4KTsKICAgIHRoaXMuY3R4LnNhdmUoKTsKICAgIHRoaXMuc2F2ZShvcElkeCk7CiAgICBpZiAodGhpcy5iYXNlVHJhbnNmb3JtKSB7CiAgICAgIHRoaXMuY3R4LnNldFRyYW5zZm9ybSguLi50aGlzLmJhc2VUcmFuc2Zvcm0pOwogICAgfQogICAgaWYgKHJlY3QpIHsKICAgICAgY29uc3Qgd2lkdGggPSByZWN0WzJdIC0gcmVjdFswXTsKICAgICAgY29uc3QgaGVpZ2h0ID0gcmVjdFszXSAtIHJlY3RbMV07CiAgICAgIGlmIChoYXNPd25DYW52YXMgJiYgdGhpcy5hbm5vdGF0aW9uQ2FudmFzTWFwKSB7CiAgICAgICAgdHJhbnNmb3JtID0gdHJhbnNmb3JtLnNsaWNlKCk7CiAgICAgICAgdHJhbnNmb3JtWzRdIC09IHJlY3RbMF07CiAgICAgICAgdHJhbnNmb3JtWzVdIC09IHJlY3RbMV07CiAgICAgICAgcmVjdCA9IHJlY3Quc2xpY2UoKTsKICAgICAgICByZWN0WzBdID0gcmVjdFsxXSA9IDA7CiAgICAgICAgcmVjdFsyXSA9IHdpZHRoOwogICAgICAgIHJlY3RbM10gPSBoZWlnaHQ7CiAgICAgICAgVXRpbC5zaW5ndWxhclZhbHVlRGVjb21wb3NlMmRTY2FsZShnZXRDdXJyZW50VHJhbnNmb3JtKHRoaXMuY3R4KSwgWFkpOwogICAgICAgIGNvbnN0IHsKICAgICAgICAgIHZpZXdwb3J0U2NhbGUKICAgICAgICB9ID0gdGhpczsKICAgICAgICBjb25zdCBjYW52YXNXaWR0aCA9IE1hdGguY2VpbCh3aWR0aCAqIHRoaXMub3V0cHV0U2NhbGVYICogdmlld3BvcnRTY2FsZSk7CiAgICAgICAgY29uc3QgY2FudmFzSGVpZ2h0ID0gTWF0aC5jZWlsKGhlaWdodCAqIHRoaXMub3V0cHV0U2NhbGVZICogdmlld3BvcnRTY2FsZSk7CiAgICAgICAgdGhpcy5hbm5vdGF0aW9uQ2FudmFzID0gdGhpcy5jYW52YXNGYWN0b3J5LmNyZWF0ZShjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0KTsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBjYW52YXMsCiAgICAgICAgICBjb250ZXh0CiAgICAgICAgfSA9IHRoaXMuYW5ub3RhdGlvbkNhbnZhczsKICAgICAgICB0aGlzLmFubm90YXRpb25DYW52YXNNYXAuc2V0KGlkLCBjYW52YXMpOwogICAgICAgIHRoaXMuYW5ub3RhdGlvbkNhbnZhcy5zYXZlZEN0eCA9IHRoaXMuY3R4OwogICAgICAgIHRoaXMuY3R4ID0gY29udGV4dDsKICAgICAgICB0aGlzLmN0eC5zYXZlKCk7CiAgICAgICAgdGhpcy5jdHguc2V0VHJhbnNmb3JtKFhZWzBdLCAwLCAwLCAtWFlbMV0sIDAsIGhlaWdodCAqIFhZWzFdKTsKICAgICAgICByZXNldEN0eFRvRGVmYXVsdCh0aGlzLmN0eCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzZXRDdHhUb0RlZmF1bHQodGhpcy5jdHgpOwogICAgICAgIHRoaXMuZW5kUGF0aChvcElkeCk7CiAgICAgICAgY29uc3QgY2xpcCA9IG5ldyBQYXRoMkQoKTsKICAgICAgICBjbGlwLnJlY3QocmVjdFswXSwgcmVjdFsxXSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgdGhpcy5jdHguY2xpcChjbGlwKTsKICAgICAgfQogICAgfQogICAgdGhpcy5jdXJyZW50ID0gbmV3IENhbnZhc0V4dHJhU3RhdGUodGhpcy5jdHguY2FudmFzLndpZHRoLCB0aGlzLmN0eC5jYW52YXMuaGVpZ2h0KTsKICAgIHRoaXMudHJhbnNmb3JtKG9wSWR4LCAuLi50cmFuc2Zvcm0pOwogICAgdGhpcy50cmFuc2Zvcm0ob3BJZHgsIC4uLm1hdHJpeCk7CiAgfQogIGVuZEFubm90YXRpb24ob3BJZHgpIHsKICAgIGlmICh0aGlzLmFubm90YXRpb25DYW52YXMpIHsKICAgICAgdGhpcy5jdHgucmVzdG9yZSgpOwogICAgICB0aGlzLiNkcmF3RmlsdGVyKCk7CiAgICAgIHRoaXMuY3R4ID0gdGhpcy5hbm5vdGF0aW9uQ2FudmFzLnNhdmVkQ3R4OwogICAgICBkZWxldGUgdGhpcy5hbm5vdGF0aW9uQ2FudmFzLnNhdmVkQ3R4OwogICAgICBkZWxldGUgdGhpcy5hbm5vdGF0aW9uQ2FudmFzOwogICAgfQogIH0KICBwYWludEltYWdlTWFza1hPYmplY3Qob3BJZHgsIGltZykgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGNvdW50ID0gaW1nLmNvdW50OwogICAgaW1nID0gdGhpcy5nZXRPYmplY3Qob3BJZHgsIGltZy5kYXRhLCBpbWcpOwogICAgaW1nLmNvdW50ID0gY291bnQ7CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IG1hc2sgPSB0aGlzLl9jcmVhdGVNYXNrQ2FudmFzKG9wSWR4LCBpbWcpOwogICAgY29uc3QgbWFza0NhbnZhcyA9IG1hc2suY2FudmFzOwogICAgY3R4LnNhdmUoKTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgMCwgMCk7CiAgICBjdHguZHJhd0ltYWdlKG1hc2tDYW52YXMsIG1hc2sub2Zmc2V0WCwgbWFzay5vZmZzZXRZKTsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc2V0QkJveChvcElkeCkucmVjb3JkQkJveChvcElkeCwgdGhpcy5jdHgsIG1hc2sub2Zmc2V0WCwgbWFzay5vZmZzZXRYICsgbWFza0NhbnZhcy53aWR0aCwgbWFzay5vZmZzZXRZLCBtYXNrLm9mZnNldFkgKyBtYXNrQ2FudmFzLmhlaWdodCkucmVjb3JkT3BlcmF0aW9uKG9wSWR4KTsKICAgIGN0eC5yZXN0b3JlKCk7CiAgICB0aGlzLmNvbXBvc2UoKTsKICB9CiAgcGFpbnRJbWFnZU1hc2tYT2JqZWN0UmVwZWF0KG9wSWR4LCBpbWcsIHNjYWxlWCwgc2tld1ggPSAwLCBza2V3WSA9IDAsIHNjYWxlWSwgcG9zaXRpb25zKSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaW1nID0gdGhpcy5nZXRPYmplY3Qob3BJZHgsIGltZy5kYXRhLCBpbWcpOwogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBjdHguc2F2ZSgpOwogICAgY29uc3QgY3VycmVudFRyYW5zZm9ybSA9IGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KTsKICAgIGN0eC50cmFuc2Zvcm0oc2NhbGVYLCBza2V3WCwgc2tld1ksIHNjYWxlWSwgMCwgMCk7CiAgICBjb25zdCBtYXNrID0gdGhpcy5fY3JlYXRlTWFza0NhbnZhcyhvcElkeCwgaW1nKTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgbWFzay5vZmZzZXRYIC0gY3VycmVudFRyYW5zZm9ybVs0XSwgbWFzay5vZmZzZXRZIC0gY3VycmVudFRyYW5zZm9ybVs1XSk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZXNldEJCb3gob3BJZHgpOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gcG9zaXRpb25zLmxlbmd0aDsgaSA8IGlpOyBpICs9IDIpIHsKICAgICAgY29uc3QgdHJhbnMgPSBVdGlsLnRyYW5zZm9ybShjdXJyZW50VHJhbnNmb3JtLCBbc2NhbGVYLCBza2V3WCwgc2tld1ksIHNjYWxlWSwgcG9zaXRpb25zW2ldLCBwb3NpdGlvbnNbaSArIDFdXSk7CiAgICAgIGN0eC5kcmF3SW1hZ2UobWFzay5jYW52YXMsIHRyYW5zWzRdLCB0cmFuc1s1XSk7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZEJCb3gob3BJZHgsIHRoaXMuY3R4LCB0cmFuc1s0XSwgdHJhbnNbNF0gKyBtYXNrLmNhbnZhcy53aWR0aCwgdHJhbnNbNV0sIHRyYW5zWzVdICsgbWFzay5jYW52YXMuaGVpZ2h0KTsKICAgIH0KICAgIGN0eC5yZXN0b3JlKCk7CiAgICB0aGlzLmNvbXBvc2UoKTsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgfQogIHBhaW50SW1hZ2VNYXNrWE9iamVjdEdyb3VwKG9wSWR4LCBpbWFnZXMpIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IGZpbGxDb2xvciA9IHRoaXMuY3VycmVudC5maWxsQ29sb3I7CiAgICBjb25zdCBpc1BhdHRlcm5GaWxsID0gdGhpcy5jdXJyZW50LnBhdHRlcm5GaWxsOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzZXRCQm94KG9wSWR4KS5yZWNvcmREZXBlbmRlbmNpZXMob3BJZHgsIERlcGVuZGVuY2llcy50cmFuc2Zvcm1BbmRGaWxsKTsKICAgIGZvciAoY29uc3QgaW1hZ2Ugb2YgaW1hZ2VzKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRhLAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodCwKICAgICAgICB0cmFuc2Zvcm0KICAgICAgfSA9IGltYWdlOwogICAgICBjb25zdCBtYXNrQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoIm1hc2tDYW52YXMiLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgY29uc3QgbWFza0N0eCA9IG1hc2tDYW52YXMuY29udGV4dDsKICAgICAgbWFza0N0eC5zYXZlKCk7CiAgICAgIGNvbnN0IGltZyA9IHRoaXMuZ2V0T2JqZWN0KG9wSWR4LCBkYXRhLCBpbWFnZSk7CiAgICAgIHB1dEJpbmFyeUltYWdlTWFzayhtYXNrQ3R4LCBpbWcpOwogICAgICBtYXNrQ3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJzb3VyY2UtaW4iOwogICAgICBtYXNrQ3R4LmZpbGxTdHlsZSA9IGlzUGF0dGVybkZpbGwgPyBmaWxsQ29sb3IuZ2V0UGF0dGVybihtYXNrQ3R4LCB0aGlzLCBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShjdHgpLCBQYXRoVHlwZS5GSUxMLCBvcElkeCkgOiBmaWxsQ29sb3I7CiAgICAgIG1hc2tDdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7CiAgICAgIG1hc2tDdHgucmVzdG9yZSgpOwogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHgudHJhbnNmb3JtKC4uLnRyYW5zZm9ybSk7CiAgICAgIGN0eC5zY2FsZSgxLCAtMSk7CiAgICAgIGRyYXdJbWFnZUF0SW50ZWdlckNvb3JkcyhjdHgsIG1hc2tDYW52YXMuY2FudmFzLCAwLCAwLCB3aWR0aCwgaGVpZ2h0LCAwLCAtMSwgMSwgMSk7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZEJCb3gob3BJZHgsIGN0eCwgMCwgd2lkdGgsIDAsIGhlaWdodCk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CiAgICB0aGlzLmNvbXBvc2UoKTsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgfQogIHBhaW50SW1hZ2VYT2JqZWN0KG9wSWR4LCBvYmpJZCkgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGltZ0RhdGEgPSB0aGlzLmdldE9iamVjdChvcElkeCwgb2JqSWQpOwogICAgaWYgKCFpbWdEYXRhKSB7CiAgICAgIHdhcm4oIkRlcGVuZGVudCBpbWFnZSBpc24ndCByZWFkeSB5ZXQiKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5wYWludElubGluZUltYWdlWE9iamVjdChvcElkeCwgaW1nRGF0YSk7CiAgfQogIHBhaW50SW1hZ2VYT2JqZWN0UmVwZWF0KG9wSWR4LCBvYmpJZCwgc2NhbGVYLCBzY2FsZVksIHBvc2l0aW9ucykgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGltZ0RhdGEgPSB0aGlzLmdldE9iamVjdChvcElkeCwgb2JqSWQpOwogICAgaWYgKCFpbWdEYXRhKSB7CiAgICAgIHdhcm4oIkRlcGVuZGVudCBpbWFnZSBpc24ndCByZWFkeSB5ZXQiKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgd2lkdGggPSBpbWdEYXRhLndpZHRoOwogICAgY29uc3QgaGVpZ2h0ID0gaW1nRGF0YS5oZWlnaHQ7CiAgICBjb25zdCBtYXAgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHBvc2l0aW9ucy5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIG1hcC5wdXNoKHsKICAgICAgICB0cmFuc2Zvcm06IFtzY2FsZVgsIDAsIDAsIHNjYWxlWSwgcG9zaXRpb25zW2ldLCBwb3NpdGlvbnNbaSArIDFdXSwKICAgICAgICB4OiAwLAogICAgICAgIHk6IDAsCiAgICAgICAgdzogd2lkdGgsCiAgICAgICAgaDogaGVpZ2h0CiAgICAgIH0pOwogICAgfQogICAgdGhpcy5wYWludElubGluZUltYWdlWE9iamVjdEdyb3VwKG9wSWR4LCBpbWdEYXRhLCBtYXApOwogIH0KICBhcHBseVRyYW5zZmVyTWFwc1RvQ2FudmFzKGN0eCkgewogICAgaWYgKHRoaXMuY3VycmVudC50cmFuc2Zlck1hcHMgIT09ICJub25lIikgewogICAgICBjdHguZmlsdGVyID0gdGhpcy5jdXJyZW50LnRyYW5zZmVyTWFwczsKICAgICAgY3R4LmRyYXdJbWFnZShjdHguY2FudmFzLCAwLCAwKTsKICAgICAgY3R4LmZpbHRlciA9ICJub25lIjsKICAgIH0KICAgIHJldHVybiBjdHguY2FudmFzOwogIH0KICBhcHBseVRyYW5zZmVyTWFwc1RvQml0bWFwKGltZ0RhdGEpIHsKICAgIGlmICh0aGlzLmN1cnJlbnQudHJhbnNmZXJNYXBzID09PSAibm9uZSIpIHsKICAgICAgcmV0dXJuIGltZ0RhdGEuYml0bWFwOwogICAgfQogICAgY29uc3QgewogICAgICBiaXRtYXAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSBpbWdEYXRhOwogICAgY29uc3QgdG1wQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoImlubGluZUltYWdlIiwgd2lkdGgsIGhlaWdodCk7CiAgICBjb25zdCB0bXBDdHggPSB0bXBDYW52YXMuY29udGV4dDsKICAgIHRtcEN0eC5maWx0ZXIgPSB0aGlzLmN1cnJlbnQudHJhbnNmZXJNYXBzOwogICAgdG1wQ3R4LmRyYXdJbWFnZShiaXRtYXAsIDAsIDApOwogICAgdG1wQ3R4LmZpbHRlciA9ICJub25lIjsKICAgIHJldHVybiB0bXBDYW52YXMuY2FudmFzOwogIH0KICBwYWludElubGluZUltYWdlWE9iamVjdChvcElkeCwgaW1nRGF0YSkgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHdpZHRoID0gaW1nRGF0YS53aWR0aDsKICAgIGNvbnN0IGhlaWdodCA9IGltZ0RhdGEuaGVpZ2h0OwogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICB0aGlzLnNhdmUob3BJZHgpOwogICAgY29uc3QgewogICAgICBmaWx0ZXIKICAgIH0gPSBjdHg7CiAgICBpZiAoZmlsdGVyICE9PSAibm9uZSIgJiYgZmlsdGVyICE9PSAiIikgewogICAgICBjdHguZmlsdGVyID0gIm5vbmUiOwogICAgfQogICAgY3R4LnNjYWxlKDEgLyB3aWR0aCwgLTEgLyBoZWlnaHQpOwogICAgbGV0IGltZ1RvUGFpbnQ7CiAgICBpZiAoaW1nRGF0YS5iaXRtYXApIHsKICAgICAgaW1nVG9QYWludCA9IHRoaXMuYXBwbHlUcmFuc2Zlck1hcHNUb0JpdG1hcChpbWdEYXRhKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIEhUTUxFbGVtZW50ID09PSAiZnVuY3Rpb24iICYmIGltZ0RhdGEgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCB8fCAhaW1nRGF0YS5kYXRhKSB7CiAgICAgIGltZ1RvUGFpbnQgPSBpbWdEYXRhOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgdG1wQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoImlubGluZUltYWdlIiwgd2lkdGgsIGhlaWdodCk7CiAgICAgIGNvbnN0IHRtcEN0eCA9IHRtcENhbnZhcy5jb250ZXh0OwogICAgICBwdXRCaW5hcnlJbWFnZURhdGEodG1wQ3R4LCBpbWdEYXRhKTsKICAgICAgaW1nVG9QYWludCA9IHRoaXMuYXBwbHlUcmFuc2Zlck1hcHNUb0NhbnZhcyh0bXBDdHgpOwogICAgfQogICAgY29uc3Qgc2NhbGVkID0gdGhpcy5fc2NhbGVJbWFnZShpbWdUb1BhaW50LCBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShjdHgpKTsKICAgIGN0eC5pbWFnZVNtb290aGluZ0VuYWJsZWQgPSBnZXRJbWFnZVNtb290aGluZ0VuYWJsZWQoZ2V0Q3VycmVudFRyYW5zZm9ybShjdHgpLCBpbWdEYXRhLmludGVycG9sYXRlKTsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc2V0QkJveChvcElkeCkucmVjb3JkQkJveChvcElkeCwgY3R4LCAwLCB3aWR0aCwgLWhlaWdodCwgMCkucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMuaW1hZ2VYT2JqZWN0KS5yZWNvcmRPcGVyYXRpb24ob3BJZHgpOwogICAgZHJhd0ltYWdlQXRJbnRlZ2VyQ29vcmRzKGN0eCwgc2NhbGVkLmltZywgMCwgMCwgc2NhbGVkLnBhaW50V2lkdGgsIHNjYWxlZC5wYWludEhlaWdodCwgMCwgLWhlaWdodCwgd2lkdGgsIGhlaWdodCk7CiAgICB0aGlzLmNvbXBvc2UoKTsKICAgIHRoaXMucmVzdG9yZShvcElkeCk7CiAgfQogIHBhaW50SW5saW5lSW1hZ2VYT2JqZWN0R3JvdXAob3BJZHgsIGltZ0RhdGEsIG1hcCkgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgbGV0IGltZ1RvUGFpbnQ7CiAgICBpZiAoaW1nRGF0YS5iaXRtYXApIHsKICAgICAgaW1nVG9QYWludCA9IGltZ0RhdGEuYml0bWFwOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgdyA9IGltZ0RhdGEud2lkdGg7CiAgICAgIGNvbnN0IGggPSBpbWdEYXRhLmhlaWdodDsKICAgICAgY29uc3QgdG1wQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoImlubGluZUltYWdlIiwgdywgaCk7CiAgICAgIGNvbnN0IHRtcEN0eCA9IHRtcENhbnZhcy5jb250ZXh0OwogICAgICBwdXRCaW5hcnlJbWFnZURhdGEodG1wQ3R4LCBpbWdEYXRhKTsKICAgICAgaW1nVG9QYWludCA9IHRoaXMuYXBwbHlUcmFuc2Zlck1hcHNUb0NhbnZhcyh0bXBDdHgpOwogICAgfQogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzZXRCQm94KG9wSWR4KTsKICAgIGZvciAoY29uc3QgZW50cnkgb2YgbWFwKSB7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC50cmFuc2Zvcm0oLi4uZW50cnkudHJhbnNmb3JtKTsKICAgICAgY3R4LnNjYWxlKDEsIC0xKTsKICAgICAgZHJhd0ltYWdlQXRJbnRlZ2VyQ29vcmRzKGN0eCwgaW1nVG9QYWludCwgZW50cnkueCwgZW50cnkueSwgZW50cnkudywgZW50cnkuaCwgMCwgLTEsIDEsIDEpOwogICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRCQm94KG9wSWR4LCBjdHgsIDAsIDEsIC0xLCAwKTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0KICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgICB0aGlzLmNvbXBvc2UoKTsKICB9CiAgcGFpbnRTb2xpZENvbG9ySW1hZ2VNYXNrKG9wSWR4KSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzZXRCQm94KG9wSWR4KS5yZWNvcmRCQm94KG9wSWR4LCB0aGlzLmN0eCwgMCwgMSwgMCwgMSkucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMuZmlsbCkucmVjb3JkT3BlcmF0aW9uKG9wSWR4KTsKICAgIHRoaXMuY3R4LmZpbGxSZWN0KDAsIDAsIDEsIDEpOwogICAgdGhpcy5jb21wb3NlKCk7CiAgfQogIG1hcmtQb2ludChvcElkeCwgdGFnKSB7CiAgfQogIG1hcmtQb2ludFByb3BzKG9wSWR4LCB0YWcsIHByb3BlcnRpZXMpIHsKICB9CiAgYmVnaW5NYXJrZWRDb250ZW50KG9wSWR4LCB0YWcpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LmJlZ2luTWFya2VkQ29udGVudChvcElkeCk7CiAgICB0aGlzLm1hcmtlZENvbnRlbnRTdGFjay5wdXNoKHsKICAgICAgdmlzaWJsZTogdHJ1ZQogICAgfSk7CiAgfQogIGJlZ2luTWFya2VkQ29udGVudFByb3BzKG9wSWR4LCB0YWcsIHByb3BlcnRpZXMpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LmJlZ2luTWFya2VkQ29udGVudChvcElkeCk7CiAgICBpZiAodGFnID09PSAiT0MiKSB7CiAgICAgIHRoaXMubWFya2VkQ29udGVudFN0YWNrLnB1c2goewogICAgICAgIHZpc2libGU6IHRoaXMub3B0aW9uYWxDb250ZW50Q29uZmlnLmlzVmlzaWJsZShwcm9wZXJ0aWVzKQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubWFya2VkQ29udGVudFN0YWNrLnB1c2goewogICAgICAgIHZpc2libGU6IHRydWUKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLmNvbnRlbnRWaXNpYmxlID0gdGhpcy5pc0NvbnRlbnRWaXNpYmxlKCk7CiAgfQogIGVuZE1hcmtlZENvbnRlbnQob3BJZHgpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LmVuZE1hcmtlZENvbnRlbnQob3BJZHgpOwogICAgdGhpcy5tYXJrZWRDb250ZW50U3RhY2sucG9wKCk7CiAgICB0aGlzLmNvbnRlbnRWaXNpYmxlID0gdGhpcy5pc0NvbnRlbnRWaXNpYmxlKCk7CiAgfQogIGJlZ2luQ29tcGF0KG9wSWR4KSB7CiAgfQogIGVuZENvbXBhdChvcElkeCkgewogIH0KICBjb25zdW1lUGF0aChvcElkeCwgcGF0aCwgY2xpcEJveCkgewogICAgY29uc3QgaXNFbXB0eSA9IHRoaXMuY3VycmVudC5pc0VtcHR5Q2xpcCgpOwogICAgaWYgKHRoaXMucGVuZGluZ0NsaXApIHsKICAgICAgdGhpcy5jdXJyZW50LnVwZGF0ZUNsaXBGcm9tUGF0aCgpOwogICAgfQogICAgaWYgKCF0aGlzLnBlbmRpbmdDbGlwKSB7CiAgICAgIHRoaXMuY29tcG9zZShjbGlwQm94KTsKICAgIH0KICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgaWYgKHRoaXMucGVuZGluZ0NsaXApIHsKICAgICAgaWYgKCFpc0VtcHR5KSB7CiAgICAgICAgaWYgKHRoaXMucGVuZGluZ0NsaXAgPT09IEVPX0NMSVApIHsKICAgICAgICAgIGN0eC5jbGlwKHBhdGgsICJldmVub2RkIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0eC5jbGlwKHBhdGgpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLnBlbmRpbmdDbGlwID0gbnVsbDsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8uYmJveFRvQ2xpcEJveERyb3BPcGVyYXRpb24ob3BJZHgpLnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3koImNsaXBQYXRoIiwgb3BJZHgpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkT3BlcmF0aW9uKG9wSWR4KTsKICAgIH0KICAgIHRoaXMuY3VycmVudC5zdGFydE5ld1BhdGhBbmRDbGlwQm94KHRoaXMuY3VycmVudC5jbGlwQm94KTsKICB9CiAgZ2V0U2luZ2xlUGl4ZWxXaWR0aCgpIHsKICAgIGlmICghdGhpcy5fY2FjaGVkR2V0U2luZ2xlUGl4ZWxXaWR0aCkgewogICAgICBjb25zdCBtID0gZ2V0Q3VycmVudFRyYW5zZm9ybSh0aGlzLmN0eCk7CiAgICAgIGlmIChtWzFdID09PSAwICYmIG1bMl0gPT09IDApIHsKICAgICAgICB0aGlzLl9jYWNoZWRHZXRTaW5nbGVQaXhlbFdpZHRoID0gMSAvIE1hdGgubWluKE1hdGguYWJzKG1bMF0pLCBNYXRoLmFicyhtWzNdKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYWJzRGV0ID0gTWF0aC5hYnMobVswXSAqIG1bM10gLSBtWzJdICogbVsxXSk7CiAgICAgICAgY29uc3Qgbm9ybVggPSBNYXRoLmh5cG90KG1bMF0sIG1bMl0pOwogICAgICAgIGNvbnN0IG5vcm1ZID0gTWF0aC5oeXBvdChtWzFdLCBtWzNdKTsKICAgICAgICB0aGlzLl9jYWNoZWRHZXRTaW5nbGVQaXhlbFdpZHRoID0gTWF0aC5tYXgobm9ybVgsIG5vcm1ZKSAvIGFic0RldDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuX2NhY2hlZEdldFNpbmdsZVBpeGVsV2lkdGg7CiAgfQogIGdldFNjYWxlRm9yU3Ryb2tpbmcoKSB7CiAgICBpZiAodGhpcy5fY2FjaGVkU2NhbGVGb3JTdHJva2luZ1swXSA9PT0gLTEpIHsKICAgICAgY29uc3QgewogICAgICAgIGxpbmVXaWR0aAogICAgICB9ID0gdGhpcy5jdXJyZW50OwogICAgICBjb25zdCB7CiAgICAgICAgYSwKICAgICAgICBiLAogICAgICAgIGMsCiAgICAgICAgZAogICAgICB9ID0gdGhpcy5jdHguZ2V0VHJhbnNmb3JtKCk7CiAgICAgIGxldCBzY2FsZVgsIHNjYWxlWTsKICAgICAgaWYgKGIgPT09IDAgJiYgYyA9PT0gMCkgewogICAgICAgIGNvbnN0IG5vcm1YID0gTWF0aC5hYnMoYSk7CiAgICAgICAgY29uc3Qgbm9ybVkgPSBNYXRoLmFicyhkKTsKICAgICAgICBpZiAobm9ybVggPT09IG5vcm1ZKSB7CiAgICAgICAgICBpZiAobGluZVdpZHRoID09PSAwKSB7CiAgICAgICAgICAgIHNjYWxlWCA9IHNjYWxlWSA9IDEgLyBub3JtWDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlZExpbmVXaWR0aCA9IG5vcm1YICogbGluZVdpZHRoOwogICAgICAgICAgICBzY2FsZVggPSBzY2FsZVkgPSBzY2FsZWRMaW5lV2lkdGggPCAxID8gMSAvIHNjYWxlZExpbmVXaWR0aCA6IDE7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChsaW5lV2lkdGggPT09IDApIHsKICAgICAgICAgIHNjYWxlWCA9IDEgLyBub3JtWDsKICAgICAgICAgIHNjYWxlWSA9IDEgLyBub3JtWTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3Qgc2NhbGVkWExpbmVXaWR0aCA9IG5vcm1YICogbGluZVdpZHRoOwogICAgICAgICAgY29uc3Qgc2NhbGVkWUxpbmVXaWR0aCA9IG5vcm1ZICogbGluZVdpZHRoOwogICAgICAgICAgc2NhbGVYID0gc2NhbGVkWExpbmVXaWR0aCA8IDEgPyAxIC8gc2NhbGVkWExpbmVXaWR0aCA6IDE7CiAgICAgICAgICBzY2FsZVkgPSBzY2FsZWRZTGluZVdpZHRoIDwgMSA/IDEgLyBzY2FsZWRZTGluZVdpZHRoIDogMTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYWJzRGV0ID0gTWF0aC5hYnMoYSAqIGQgLSBiICogYyk7CiAgICAgICAgY29uc3Qgbm9ybVggPSBNYXRoLmh5cG90KGEsIGIpOwogICAgICAgIGNvbnN0IG5vcm1ZID0gTWF0aC5oeXBvdChjLCBkKTsKICAgICAgICBpZiAobGluZVdpZHRoID09PSAwKSB7CiAgICAgICAgICBzY2FsZVggPSBub3JtWSAvIGFic0RldDsKICAgICAgICAgIHNjYWxlWSA9IG5vcm1YIC8gYWJzRGV0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBiYXNlQXJlYSA9IGxpbmVXaWR0aCAqIGFic0RldDsKICAgICAgICAgIHNjYWxlWCA9IG5vcm1ZID4gYmFzZUFyZWEgPyBub3JtWSAvIGJhc2VBcmVhIDogMTsKICAgICAgICAgIHNjYWxlWSA9IG5vcm1YID4gYmFzZUFyZWEgPyBub3JtWCAvIGJhc2VBcmVhIDogMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fY2FjaGVkU2NhbGVGb3JTdHJva2luZ1swXSA9IHNjYWxlWDsKICAgICAgdGhpcy5fY2FjaGVkU2NhbGVGb3JTdHJva2luZ1sxXSA9IHNjYWxlWTsKICAgIH0KICAgIHJldHVybiB0aGlzLl9jYWNoZWRTY2FsZUZvclN0cm9raW5nOwogIH0KICByZXNjYWxlQW5kU3Ryb2tlKHBhdGgsIHNhdmVSZXN0b3JlKSB7CiAgICBjb25zdCB7CiAgICAgIGN0eCwKICAgICAgY3VycmVudDogewogICAgICAgIGxpbmVXaWR0aAogICAgICB9CiAgICB9ID0gdGhpczsKICAgIGNvbnN0IFtzY2FsZVgsIHNjYWxlWV0gPSB0aGlzLmdldFNjYWxlRm9yU3Ryb2tpbmcoKTsKICAgIGlmIChzY2FsZVggPT09IHNjYWxlWSkgewogICAgICBjdHgubGluZVdpZHRoID0gKGxpbmVXaWR0aCB8fCAxKSAqIHNjYWxlWDsKICAgICAgY3R4LnN0cm9rZShwYXRoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgZGFzaGVzID0gY3R4LmdldExpbmVEYXNoKCk7CiAgICBpZiAoc2F2ZVJlc3RvcmUpIHsKICAgICAgY3R4LnNhdmUoKTsKICAgIH0KICAgIGN0eC5zY2FsZShzY2FsZVgsIHNjYWxlWSk7CiAgICBTQ0FMRV9NQVRSSVguYSA9IDEgLyBzY2FsZVg7CiAgICBTQ0FMRV9NQVRSSVguZCA9IDEgLyBzY2FsZVk7CiAgICBjb25zdCBuZXdQYXRoID0gbmV3IFBhdGgyRCgpOwogICAgbmV3UGF0aC5hZGRQYXRoKHBhdGgsIFNDQUxFX01BVFJJWCk7CiAgICBpZiAoZGFzaGVzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3Qgc2NhbGUgPSBNYXRoLm1heChzY2FsZVgsIHNjYWxlWSk7CiAgICAgIGN0eC5zZXRMaW5lRGFzaChkYXNoZXMubWFwKCh4KSA9PiB4IC8gc2NhbGUpKTsKICAgICAgY3R4LmxpbmVEYXNoT2Zmc2V0IC89IHNjYWxlOwogICAgfQogICAgY3R4LmxpbmVXaWR0aCA9IGxpbmVXaWR0aCB8fCAxOwogICAgY3R4LnN0cm9rZShuZXdQYXRoKTsKICAgIGlmIChzYXZlUmVzdG9yZSkgewogICAgICBjdHgucmVzdG9yZSgpOwogICAgfQogIH0KICBpc0NvbnRlbnRWaXNpYmxlKCkgewogICAgZm9yIChsZXQgaSA9IHRoaXMubWFya2VkQ29udGVudFN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGlmICghdGhpcy5tYXJrZWRDb250ZW50U3RhY2tbaV0udmlzaWJsZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9Owpmb3IgKGNvbnN0IG9wIGluIE9QUykgewogIGlmIChDYW52YXNHcmFwaGljcy5wcm90b3R5cGVbb3BdICE9PSB2b2lkIDApIHsKICAgIENhbnZhc0dyYXBoaWNzLnByb3RvdHlwZVtPUFNbb3BdXSA9IENhbnZhc0dyYXBoaWNzLnByb3RvdHlwZVtvcF07CiAgfQp9CnZhciBHbG9iYWxXb3JrZXJPcHRpb25zID0gY2xhc3MgewogIHN0YXRpYyAjcG9ydCA9IG51bGw7CiAgc3RhdGljICNzcmMgPSAiIjsKICBzdGF0aWMgZ2V0IHdvcmtlclBvcnQoKSB7CiAgICByZXR1cm4gdGhpcy4jcG9ydDsKICB9CiAgc3RhdGljIHNldCB3b3JrZXJQb3J0KHZhbCkgewogICAgaWYgKCEodHlwZW9mIFdvcmtlciAhPT0gInVuZGVmaW5lZCIgJiYgdmFsIGluc3RhbmNlb2YgV29ya2VyKSAmJiB2YWwgIT09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGB3b3JrZXJQb3J0YCB0eXBlLiIpOwogICAgfQogICAgdGhpcy4jcG9ydCA9IHZhbDsKICB9CiAgc3RhdGljIGdldCB3b3JrZXJTcmMoKSB7CiAgICByZXR1cm4gdGhpcy4jc3JjOwogIH0KICBzdGF0aWMgc2V0IHdvcmtlclNyYyh2YWwpIHsKICAgIGlmICh0eXBlb2YgdmFsICE9PSAic3RyaW5nIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYHdvcmtlclNyY2AgdHlwZS4iKTsKICAgIH0KICAgIHRoaXMuI3NyYyA9IHZhbDsKICB9Cn07CnZhciBNZXRhZGF0YSA9IGNsYXNzIHsKICAjbWFwOwogICNkYXRhOwogIGNvbnN0cnVjdG9yKHsKICAgIHBhcnNlZERhdGEsCiAgICByYXdEYXRhCiAgfSkgewogICAgdGhpcy4jbWFwID0gcGFyc2VkRGF0YTsKICAgIHRoaXMuI2RhdGEgPSByYXdEYXRhOwogIH0KICBnZXRSYXcoKSB7CiAgICByZXR1cm4gdGhpcy4jZGF0YTsKICB9CiAgZ2V0KG5hbWUpIHsKICAgIHJldHVybiB0aGlzLiNtYXAuZ2V0KG5hbWUpID8/IG51bGw7CiAgfQogIFtTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgcmV0dXJuIHRoaXMuI21hcC5lbnRyaWVzKCk7CiAgfQp9Owp2YXIgSU5URVJOQUwgPSBTeW1ib2woIklOVEVSTkFMIik7CnZhciBPcHRpb25hbENvbnRlbnRHcm91cCA9IGNsYXNzIHsKICAjaXNEaXNwbGF5ID0gZmFsc2U7CiAgI2lzUHJpbnQgPSBmYWxzZTsKICAjdXNlclNldCA9IGZhbHNlOwogICN2aXNpYmxlID0gdHJ1ZTsKICBjb25zdHJ1Y3RvcihyZW5kZXJpbmdJbnRlbnQsIHsKICAgIG5hbWUsCiAgICBpbnRlbnQsCiAgICB1c2FnZSwKICAgIHJiR3JvdXBzCiAgfSkgewogICAgdGhpcy4jaXNEaXNwbGF5ID0gISEocmVuZGVyaW5nSW50ZW50ICYgUmVuZGVyaW5nSW50ZW50RmxhZy5ESVNQTEFZKTsKICAgIHRoaXMuI2lzUHJpbnQgPSAhIShyZW5kZXJpbmdJbnRlbnQgJiBSZW5kZXJpbmdJbnRlbnRGbGFnLlBSSU5UKTsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLmludGVudCA9IGludGVudDsKICAgIHRoaXMudXNhZ2UgPSB1c2FnZTsKICAgIHRoaXMucmJHcm91cHMgPSByYkdyb3VwczsKICB9CiAgZ2V0IHZpc2libGUoKSB7CiAgICBpZiAodGhpcy4jdXNlclNldCkgewogICAgICByZXR1cm4gdGhpcy4jdmlzaWJsZTsKICAgIH0KICAgIGlmICghdGhpcy4jdmlzaWJsZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHByaW50LAogICAgICB2aWV3CiAgICB9ID0gdGhpcy51c2FnZTsKICAgIGlmICh0aGlzLiNpc0Rpc3BsYXkpIHsKICAgICAgcmV0dXJuIHZpZXc/LnZpZXdTdGF0ZSAhPT0gIk9GRiI7CiAgICB9IGVsc2UgaWYgKHRoaXMuI2lzUHJpbnQpIHsKICAgICAgcmV0dXJuIHByaW50Py5wcmludFN0YXRlICE9PSAiT0ZGIjsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICBfc2V0VmlzaWJsZShpbnRlcm5hbCwgdmlzaWJsZSwgdXNlclNldCA9IGZhbHNlKSB7CiAgICBpZiAoaW50ZXJuYWwgIT09IElOVEVSTkFMKSB7CiAgICAgIHVucmVhY2hhYmxlKCJJbnRlcm5hbCBtZXRob2QgYF9zZXRWaXNpYmxlYCBjYWxsZWQuIik7CiAgICB9CiAgICB0aGlzLiN1c2VyU2V0ID0gdXNlclNldDsKICAgIHRoaXMuI3Zpc2libGUgPSB2aXNpYmxlOwogIH0KfTsKdmFyIE9wdGlvbmFsQ29udGVudENvbmZpZyA9IGNsYXNzIHsKICAjY2FjaGVkR2V0SGFzaCA9IG51bGw7CiAgI2dyb3VwcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI2luaXRpYWxIYXNoID0gbnVsbDsKICAjb3JkZXIgPSBudWxsOwogIGNvbnN0cnVjdG9yKGRhdGEsIHJlbmRlcmluZ0ludGVudCA9IFJlbmRlcmluZ0ludGVudEZsYWcuRElTUExBWSkgewogICAgdGhpcy5yZW5kZXJpbmdJbnRlbnQgPSByZW5kZXJpbmdJbnRlbnQ7CiAgICB0aGlzLm5hbWUgPSBudWxsOwogICAgdGhpcy5jcmVhdG9yID0gbnVsbDsKICAgIGlmIChkYXRhID09PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMubmFtZSA9IGRhdGEubmFtZTsKICAgIHRoaXMuY3JlYXRvciA9IGRhdGEuY3JlYXRvcjsKICAgIHRoaXMuI29yZGVyID0gZGF0YS5vcmRlcjsKICAgIGZvciAoY29uc3QgZ3JvdXAgb2YgZGF0YS5ncm91cHMpIHsKICAgICAgdGhpcy4jZ3JvdXBzLnNldChncm91cC5pZCwgbmV3IE9wdGlvbmFsQ29udGVudEdyb3VwKHJlbmRlcmluZ0ludGVudCwgZ3JvdXApKTsKICAgIH0KICAgIGlmIChkYXRhLmJhc2VTdGF0ZSA9PT0gIk9GRiIpIHsKICAgICAgZm9yIChjb25zdCBncm91cCBvZiB0aGlzLiNncm91cHMudmFsdWVzKCkpIHsKICAgICAgICBncm91cC5fc2V0VmlzaWJsZShJTlRFUk5BTCwgZmFsc2UpOwogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IG9uIG9mIGRhdGEub24pIHsKICAgICAgdGhpcy4jZ3JvdXBzLmdldChvbikuX3NldFZpc2libGUoSU5URVJOQUwsIHRydWUpOwogICAgfQogICAgZm9yIChjb25zdCBvZmYgb2YgZGF0YS5vZmYpIHsKICAgICAgdGhpcy4jZ3JvdXBzLmdldChvZmYpLl9zZXRWaXNpYmxlKElOVEVSTkFMLCBmYWxzZSk7CiAgICB9CiAgICB0aGlzLiNpbml0aWFsSGFzaCA9IHRoaXMuZ2V0SGFzaCgpOwogIH0KICAjZXZhbHVhdGVWaXNpYmlsaXR5RXhwcmVzc2lvbihhcnJheSkgewogICAgY29uc3QgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBjb25zdCBvcGVyYXRvciA9IGFycmF5WzBdOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBjb25zdCBlbGVtZW50ID0gYXJyYXlbaV07CiAgICAgIGxldCBzdGF0ZTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZWxlbWVudCkpIHsKICAgICAgICBzdGF0ZSA9IHRoaXMuI2V2YWx1YXRlVmlzaWJpbGl0eUV4cHJlc3Npb24oZWxlbWVudCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy4jZ3JvdXBzLmhhcyhlbGVtZW50KSkgewogICAgICAgIHN0YXRlID0gdGhpcy4jZ3JvdXBzLmdldChlbGVtZW50KS52aXNpYmxlOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4oYE9wdGlvbmFsIGNvbnRlbnQgZ3JvdXAgbm90IGZvdW5kOiAke2VsZW1lbnR9YCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgc3dpdGNoIChvcGVyYXRvcikgewogICAgICAgIGNhc2UgIkFuZCI6CiAgICAgICAgICBpZiAoIXN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIk9yIjoKICAgICAgICAgIGlmIChzdGF0ZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIk5vdCI6CiAgICAgICAgICByZXR1cm4gIXN0YXRlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9wZXJhdG9yID09PSAiQW5kIjsKICB9CiAgaXNWaXNpYmxlKGdyb3VwKSB7CiAgICBpZiAodGhpcy4jZ3JvdXBzLnNpemUgPT09IDApIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoIWdyb3VwKSB7CiAgICAgIGluZm8oIk9wdGlvbmFsIGNvbnRlbnQgZ3JvdXAgbm90IGRlZmluZWQuIik7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKGdyb3VwLnR5cGUgPT09ICJPQ0ciKSB7CiAgICAgIGlmICghdGhpcy4jZ3JvdXBzLmhhcyhncm91cC5pZCkpIHsKICAgICAgICB3YXJuKGBPcHRpb25hbCBjb250ZW50IGdyb3VwIG5vdCBmb3VuZDogJHtncm91cC5pZH1gKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy4jZ3JvdXBzLmdldChncm91cC5pZCkudmlzaWJsZTsKICAgIH0gZWxzZSBpZiAoZ3JvdXAudHlwZSA9PT0gIk9DTUQiKSB7CiAgICAgIGlmIChncm91cC5leHByZXNzaW9uKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuI2V2YWx1YXRlVmlzaWJpbGl0eUV4cHJlc3Npb24oZ3JvdXAuZXhwcmVzc2lvbik7CiAgICAgIH0KICAgICAgaWYgKCFncm91cC5wb2xpY3kgfHwgZ3JvdXAucG9saWN5ID09PSAiQW55T24iKSB7CiAgICAgICAgZm9yIChjb25zdCBpZCBvZiBncm91cC5pZHMpIHsKICAgICAgICAgIGlmICghdGhpcy4jZ3JvdXBzLmhhcyhpZCkpIHsKICAgICAgICAgICAgd2FybihgT3B0aW9uYWwgY29udGVudCBncm91cCBub3QgZm91bmQ6ICR7aWR9YCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuI2dyb3Vwcy5nZXQoaWQpLnZpc2libGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChncm91cC5wb2xpY3kgPT09ICJBbGxPbiIpIHsKICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIGdyb3VwLmlkcykgewogICAgICAgICAgaWYgKCF0aGlzLiNncm91cHMuaGFzKGlkKSkgewogICAgICAgICAgICB3YXJuKGBPcHRpb25hbCBjb250ZW50IGdyb3VwIG5vdCBmb3VuZDogJHtpZH1gKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXRoaXMuI2dyb3Vwcy5nZXQoaWQpLnZpc2libGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChncm91cC5wb2xpY3kgPT09ICJBbnlPZmYiKSB7CiAgICAgICAgZm9yIChjb25zdCBpZCBvZiBncm91cC5pZHMpIHsKICAgICAgICAgIGlmICghdGhpcy4jZ3JvdXBzLmhhcyhpZCkpIHsKICAgICAgICAgICAgd2FybihgT3B0aW9uYWwgY29udGVudCBncm91cCBub3QgZm91bmQ6ICR7aWR9YCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0aGlzLiNncm91cHMuZ2V0KGlkKS52aXNpYmxlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoZ3JvdXAucG9saWN5ID09PSAiQWxsT2ZmIikgewogICAgICAgIGZvciAoY29uc3QgaWQgb2YgZ3JvdXAuaWRzKSB7CiAgICAgICAgICBpZiAoIXRoaXMuI2dyb3Vwcy5oYXMoaWQpKSB7CiAgICAgICAgICAgIHdhcm4oYE9wdGlvbmFsIGNvbnRlbnQgZ3JvdXAgbm90IGZvdW5kOiAke2lkfWApOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLiNncm91cHMuZ2V0KGlkKS52aXNpYmxlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgd2FybihgVW5rbm93biBvcHRpb25hbCBjb250ZW50IHBvbGljeSAke2dyb3VwLnBvbGljeX0uYCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgd2FybihgVW5rbm93biBncm91cCB0eXBlICR7Z3JvdXAudHlwZX0uYCk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgc2V0VmlzaWJpbGl0eShpZCwgdmlzaWJsZSA9IHRydWUsIHByZXNlcnZlUkIgPSB0cnVlKSB7CiAgICBjb25zdCBncm91cCA9IHRoaXMuI2dyb3Vwcy5nZXQoaWQpOwogICAgaWYgKCFncm91cCkgewogICAgICB3YXJuKGBPcHRpb25hbCBjb250ZW50IGdyb3VwIG5vdCBmb3VuZDogJHtpZH1gKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHByZXNlcnZlUkIgJiYgdmlzaWJsZSAmJiBncm91cC5yYkdyb3Vwcy5sZW5ndGgpIHsKICAgICAgZm9yIChjb25zdCByYkdyb3VwIG9mIGdyb3VwLnJiR3JvdXBzKSB7CiAgICAgICAgZm9yIChjb25zdCBvdGhlcklkIG9mIHJiR3JvdXApIHsKICAgICAgICAgIGlmIChvdGhlcklkICE9PSBpZCkgewogICAgICAgICAgICB0aGlzLiNncm91cHMuZ2V0KG90aGVySWQpPy5fc2V0VmlzaWJsZShJTlRFUk5BTCwgZmFsc2UsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZ3JvdXAuX3NldFZpc2libGUoSU5URVJOQUwsICEhdmlzaWJsZSwgdHJ1ZSk7CiAgICB0aGlzLiNjYWNoZWRHZXRIYXNoID0gbnVsbDsKICB9CiAgc2V0T0NHU3RhdGUoewogICAgc3RhdGUsCiAgICBwcmVzZXJ2ZVJCCiAgfSkgewogICAgbGV0IG9wZXJhdG9yOwogICAgZm9yIChjb25zdCBlbGVtIG9mIHN0YXRlKSB7CiAgICAgIHN3aXRjaCAoZWxlbSkgewogICAgICAgIGNhc2UgIk9OIjoKICAgICAgICBjYXNlICJPRkYiOgogICAgICAgIGNhc2UgIlRvZ2dsZSI6CiAgICAgICAgICBvcGVyYXRvciA9IGVsZW07CiAgICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBncm91cCA9IHRoaXMuI2dyb3Vwcy5nZXQoZWxlbSk7CiAgICAgIGlmICghZ3JvdXApIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKG9wZXJhdG9yKSB7CiAgICAgICAgY2FzZSAiT04iOgogICAgICAgICAgdGhpcy5zZXRWaXNpYmlsaXR5KGVsZW0sIHRydWUsIHByZXNlcnZlUkIpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiT0ZGIjoKICAgICAgICAgIHRoaXMuc2V0VmlzaWJpbGl0eShlbGVtLCBmYWxzZSwgcHJlc2VydmVSQik7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJUb2dnbGUiOgogICAgICAgICAgdGhpcy5zZXRWaXNpYmlsaXR5KGVsZW0sICFncm91cC52aXNpYmxlLCBwcmVzZXJ2ZVJCKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLiNjYWNoZWRHZXRIYXNoID0gbnVsbDsKICB9CiAgZ2V0IGhhc0luaXRpYWxWaXNpYmlsaXR5KCkgewogICAgcmV0dXJuIHRoaXMuI2luaXRpYWxIYXNoID09PSBudWxsIHx8IHRoaXMuZ2V0SGFzaCgpID09PSB0aGlzLiNpbml0aWFsSGFzaDsKICB9CiAgZ2V0T3JkZXIoKSB7CiAgICBpZiAoIXRoaXMuI2dyb3Vwcy5zaXplKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHRoaXMuI29yZGVyKSB7CiAgICAgIHJldHVybiB0aGlzLiNvcmRlci5zbGljZSgpOwogICAgfQogICAgcmV0dXJuIFsuLi50aGlzLiNncm91cHMua2V5cygpXTsKICB9CiAgZ2V0R3JvdXAoaWQpIHsKICAgIHJldHVybiB0aGlzLiNncm91cHMuZ2V0KGlkKSB8fCBudWxsOwogIH0KICBnZXRIYXNoKCkgewogICAgaWYgKHRoaXMuI2NhY2hlZEdldEhhc2ggIT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRoaXMuI2NhY2hlZEdldEhhc2g7CiAgICB9CiAgICBjb25zdCBoYXNoID0gbmV3IE11cm11ckhhc2gzXzY0KCk7CiAgICBmb3IgKGNvbnN0IFtpZCwgZ3JvdXBdIG9mIHRoaXMuI2dyb3VwcykgewogICAgICBoYXNoLnVwZGF0ZShgJHtpZH06JHtncm91cC52aXNpYmxlfWApOwogICAgfQogICAgcmV0dXJuIHRoaXMuI2NhY2hlZEdldEhhc2ggPSBoYXNoLmhleGRpZ2VzdCgpOwogIH0KICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLiNncm91cHMuZW50cmllcygpOwogIH0KfTsKdmFyIFBERkRhdGFUcmFuc3BvcnRTdHJlYW0gPSBjbGFzcyB7CiAgY29uc3RydWN0b3IocGRmRGF0YVJhbmdlVHJhbnNwb3J0LCB7CiAgICBkaXNhYmxlUmFuZ2UgPSBmYWxzZSwKICAgIGRpc2FibGVTdHJlYW0gPSBmYWxzZQogIH0pIHsKICAgIGFzc2VydChwZGZEYXRhUmFuZ2VUcmFuc3BvcnQsICdQREZEYXRhVHJhbnNwb3J0U3RyZWFtIC0gbWlzc2luZyByZXF1aXJlZCAicGRmRGF0YVJhbmdlVHJhbnNwb3J0IiBhcmd1bWVudC4nKTsKICAgIGNvbnN0IHsKICAgICAgbGVuZ3RoLAogICAgICBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyLAogICAgICBwcm9ncmVzc2l2ZURvbmUsCiAgICAgIGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lCiAgICB9ID0gcGRmRGF0YVJhbmdlVHJhbnNwb3J0OwogICAgdGhpcy5fcXVldWVkQ2h1bmtzID0gW107CiAgICB0aGlzLl9wcm9ncmVzc2l2ZURvbmUgPSBwcm9ncmVzc2l2ZURvbmU7CiAgICB0aGlzLl9jb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSA9IGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lOwogICAgaWYgKGluaXRpYWxEYXRhMj8ubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBidWZmZXIgPSBpbml0aWFsRGF0YTIgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIGluaXRpYWxEYXRhMi5ieXRlTGVuZ3RoID09PSBpbml0aWFsRGF0YTIuYnVmZmVyLmJ5dGVMZW5ndGggPyBpbml0aWFsRGF0YTIuYnVmZmVyIDogbmV3IFVpbnQ4QXJyYXkoaW5pdGlhbERhdGEyKS5idWZmZXI7CiAgICAgIHRoaXMuX3F1ZXVlZENodW5rcy5wdXNoKGJ1ZmZlcik7CiAgICB9CiAgICB0aGlzLl9wZGZEYXRhUmFuZ2VUcmFuc3BvcnQgPSBwZGZEYXRhUmFuZ2VUcmFuc3BvcnQ7CiAgICB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZCA9ICFkaXNhYmxlU3RyZWFtOwogICAgdGhpcy5faXNSYW5nZVN1cHBvcnRlZCA9ICFkaXNhYmxlUmFuZ2U7CiAgICB0aGlzLl9jb250ZW50TGVuZ3RoID0gbGVuZ3RoOwogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIgPSBudWxsOwogICAgdGhpcy5fcmFuZ2VSZWFkZXJzID0gW107CiAgICBwZGZEYXRhUmFuZ2VUcmFuc3BvcnQuYWRkUmFuZ2VMaXN0ZW5lcigoYmVnaW4sIGNodW5rKSA9PiB7CiAgICAgIHRoaXMuX29uUmVjZWl2ZURhdGEoewogICAgICAgIGJlZ2luLAogICAgICAgIGNodW5rCiAgICAgIH0pOwogICAgfSk7CiAgICBwZGZEYXRhUmFuZ2VUcmFuc3BvcnQuYWRkUHJvZ3Jlc3NMaXN0ZW5lcigobG9hZGVkLCB0b3RhbCkgPT4gewogICAgICB0aGlzLl9vblByb2dyZXNzKHsKICAgICAgICBsb2FkZWQsCiAgICAgICAgdG90YWwKICAgICAgfSk7CiAgICB9KTsKICAgIHBkZkRhdGFSYW5nZVRyYW5zcG9ydC5hZGRQcm9ncmVzc2l2ZVJlYWRMaXN0ZW5lcigoY2h1bmspID0+IHsKICAgICAgdGhpcy5fb25SZWNlaXZlRGF0YSh7CiAgICAgICAgY2h1bmsKICAgICAgfSk7CiAgICB9KTsKICAgIHBkZkRhdGFSYW5nZVRyYW5zcG9ydC5hZGRQcm9ncmVzc2l2ZURvbmVMaXN0ZW5lcigoKSA9PiB7CiAgICAgIHRoaXMuX29uUHJvZ3Jlc3NpdmVEb25lKCk7CiAgICB9KTsKICAgIHBkZkRhdGFSYW5nZVRyYW5zcG9ydC50cmFuc3BvcnRSZWFkeSgpOwogIH0KICBfb25SZWNlaXZlRGF0YSh7CiAgICBiZWdpbiwKICAgIGNodW5rCiAgfSkgewogICAgY29uc3QgYnVmZmVyID0gY2h1bmsgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIGNodW5rLmJ5dGVMZW5ndGggPT09IGNodW5rLmJ1ZmZlci5ieXRlTGVuZ3RoID8gY2h1bmsuYnVmZmVyIDogbmV3IFVpbnQ4QXJyYXkoY2h1bmspLmJ1ZmZlcjsKICAgIGlmIChiZWdpbiA9PT0gdm9pZCAwKSB7CiAgICAgIGlmICh0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcikgewogICAgICAgIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyLl9lbnF1ZXVlKGJ1ZmZlcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcXVldWVkQ2h1bmtzLnB1c2goYnVmZmVyKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgZm91bmQgPSB0aGlzLl9yYW5nZVJlYWRlcnMuc29tZShmdW5jdGlvbihyYW5nZVJlYWRlcikgewogICAgICAgIGlmIChyYW5nZVJlYWRlci5fYmVnaW4gIT09IGJlZ2luKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJhbmdlUmVhZGVyLl9lbnF1ZXVlKGJ1ZmZlcik7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgICBhc3NlcnQoZm91bmQsICJfb25SZWNlaXZlRGF0YSAtIG5vIGBQREZEYXRhVHJhbnNwb3J0U3RyZWFtUmFuZ2VSZWFkZXJgIGluc3RhbmNlIGZvdW5kLiIpOwogICAgfQogIH0KICBnZXQgX3Byb2dyZXNzaXZlRGF0YUxlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcj8uX2xvYWRlZCA/PyAwOwogIH0KICBfb25Qcm9ncmVzcyhldnQpIHsKICAgIGlmIChldnQudG90YWwgPT09IHZvaWQgMCkgewogICAgICB0aGlzLl9yYW5nZVJlYWRlcnNbMF0/Lm9uUHJvZ3Jlc3M/Lih7CiAgICAgICAgbG9hZGVkOiBldnQubG9hZGVkCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/Lm9uUHJvZ3Jlc3M/Lih7CiAgICAgICAgbG9hZGVkOiBldnQubG9hZGVkLAogICAgICAgIHRvdGFsOiBldnQudG90YWwKICAgICAgfSk7CiAgICB9CiAgfQogIF9vblByb2dyZXNzaXZlRG9uZSgpIHsKICAgIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyPy5wcm9ncmVzc2l2ZURvbmUoKTsKICAgIHRoaXMuX3Byb2dyZXNzaXZlRG9uZSA9IHRydWU7CiAgfQogIF9yZW1vdmVSYW5nZVJlYWRlcihyZWFkZXIpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9yYW5nZVJlYWRlcnMuaW5kZXhPZihyZWFkZXIpOwogICAgaWYgKGkgPj0gMCkgewogICAgICB0aGlzLl9yYW5nZVJlYWRlcnMuc3BsaWNlKGksIDEpOwogICAgfQogIH0KICBnZXRGdWxsUmVhZGVyKCkgewogICAgYXNzZXJ0KCF0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciwgIlBERkRhdGFUcmFuc3BvcnRTdHJlYW0uZ2V0RnVsbFJlYWRlciBjYW4gb25seSBiZSBjYWxsZWQgb25jZS4iKTsKICAgIGNvbnN0IHF1ZXVlZENodW5rcyA9IHRoaXMuX3F1ZXVlZENodW5rczsKICAgIHRoaXMuX3F1ZXVlZENodW5rcyA9IG51bGw7CiAgICByZXR1cm4gbmV3IFBERkRhdGFUcmFuc3BvcnRTdHJlYW1SZWFkZXIodGhpcywgcXVldWVkQ2h1bmtzLCB0aGlzLl9wcm9ncmVzc2l2ZURvbmUsIHRoaXMuX2NvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lKTsKICB9CiAgZ2V0UmFuZ2VSZWFkZXIoYmVnaW4sIGVuZCkgewogICAgaWYgKGVuZCA8PSB0aGlzLl9wcm9ncmVzc2l2ZURhdGFMZW5ndGgpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCByZWFkZXIgPSBuZXcgUERGRGF0YVRyYW5zcG9ydFN0cmVhbVJhbmdlUmVhZGVyKHRoaXMsIGJlZ2luLCBlbmQpOwogICAgdGhpcy5fcGRmRGF0YVJhbmdlVHJhbnNwb3J0LnJlcXVlc3REYXRhUmFuZ2UoYmVnaW4sIGVuZCk7CiAgICB0aGlzLl9yYW5nZVJlYWRlcnMucHVzaChyZWFkZXIpOwogICAgcmV0dXJuIHJlYWRlcjsKICB9CiAgY2FuY2VsQWxsUmVxdWVzdHMocmVhc29uKSB7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcj8uY2FuY2VsKHJlYXNvbik7CiAgICBmb3IgKGNvbnN0IHJlYWRlciBvZiB0aGlzLl9yYW5nZVJlYWRlcnMuc2xpY2UoMCkpIHsKICAgICAgcmVhZGVyLmNhbmNlbChyZWFzb24pOwogICAgfQogICAgdGhpcy5fcGRmRGF0YVJhbmdlVHJhbnNwb3J0LmFib3J0KCk7CiAgfQp9Owp2YXIgUERGRGF0YVRyYW5zcG9ydFN0cmVhbVJlYWRlciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihzdHJlYW0sIHF1ZXVlZENodW5rcywgcHJvZ3Jlc3NpdmVEb25lID0gZmFsc2UsIGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lID0gbnVsbCkgewogICAgdGhpcy5fc3RyZWFtID0gc3RyZWFtOwogICAgdGhpcy5fZG9uZSA9IHByb2dyZXNzaXZlRG9uZSB8fCBmYWxzZTsKICAgIHRoaXMuX2ZpbGVuYW1lID0gaXNQZGZGaWxlKGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lKSA/IGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lIDogbnVsbDsKICAgIHRoaXMuX3F1ZXVlZENodW5rcyA9IHF1ZXVlZENodW5rcyB8fCBbXTsKICAgIHRoaXMuX2xvYWRlZCA9IDA7CiAgICBmb3IgKGNvbnN0IGNodW5rIG9mIHRoaXMuX3F1ZXVlZENodW5rcykgewogICAgICB0aGlzLl9sb2FkZWQgKz0gY2h1bmsuYnl0ZUxlbmd0aDsKICAgIH0KICAgIHRoaXMuX3JlcXVlc3RzID0gW107CiAgICB0aGlzLl9oZWFkZXJzUmVhZHkgPSBQcm9taXNlLnJlc29sdmUoKTsKICAgIHN0cmVhbS5fZnVsbFJlcXVlc3RSZWFkZXIgPSB0aGlzOwogICAgdGhpcy5vblByb2dyZXNzID0gbnVsbDsKICB9CiAgX2VucXVldWUoY2h1bmspIHsKICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5ID0gdGhpcy5fcmVxdWVzdHMuc2hpZnQoKTsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IGNodW5rLAogICAgICAgIGRvbmU6IGZhbHNlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcXVldWVkQ2h1bmtzLnB1c2goY2h1bmspOwogICAgfQogICAgdGhpcy5fbG9hZGVkICs9IGNodW5rLmJ5dGVMZW5ndGg7CiAgfQogIGdldCBoZWFkZXJzUmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5faGVhZGVyc1JlYWR5OwogIH0KICBnZXQgZmlsZW5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fZmlsZW5hbWU7CiAgfQogIGdldCBpc1JhbmdlU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHRoaXMuX3N0cmVhbS5faXNSYW5nZVN1cHBvcnRlZDsKICB9CiAgZ2V0IGlzU3RyZWFtaW5nU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHRoaXMuX3N0cmVhbS5faXNTdHJlYW1pbmdTdXBwb3J0ZWQ7CiAgfQogIGdldCBjb250ZW50TGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX3N0cmVhbS5fY29udGVudExlbmd0aDsKICB9CiAgYXN5bmMgcmVhZCgpIHsKICAgIGlmICh0aGlzLl9xdWV1ZWRDaHVua3MubGVuZ3RoID4gMCkgewogICAgICBjb25zdCBjaHVuayA9IHRoaXMuX3F1ZXVlZENodW5rcy5zaGlmdCgpOwogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiBjaHVuaywKICAgICAgICBkb25lOiBmYWxzZQogICAgICB9OwogICAgfQogICAgaWYgKHRoaXMuX2RvbmUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgIGRvbmU6IHRydWUKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLl9yZXF1ZXN0cy5wdXNoKHJlcXVlc3RDYXBhYmlsaXR5KTsKICAgIHJldHVybiByZXF1ZXN0Q2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICBjYW5jZWwocmVhc29uKSB7CiAgICB0aGlzLl9kb25lID0gdHJ1ZTsKICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICB9CiAgcHJvZ3Jlc3NpdmVEb25lKCkgewogICAgaWYgKHRoaXMuX2RvbmUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgfQp9Owp2YXIgUERGRGF0YVRyYW5zcG9ydFN0cmVhbVJhbmdlUmVhZGVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHN0cmVhbSwgYmVnaW4sIGVuZCkgewogICAgdGhpcy5fc3RyZWFtID0gc3RyZWFtOwogICAgdGhpcy5fYmVnaW4gPSBiZWdpbjsKICAgIHRoaXMuX2VuZCA9IGVuZDsKICAgIHRoaXMuX3F1ZXVlZENodW5rID0gbnVsbDsKICAgIHRoaXMuX3JlcXVlc3RzID0gW107CiAgICB0aGlzLl9kb25lID0gZmFsc2U7CiAgICB0aGlzLm9uUHJvZ3Jlc3MgPSBudWxsOwogIH0KICBfZW5xdWV1ZShjaHVuaykgewogICAgaWYgKHRoaXMuX2RvbmUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aGlzLl9xdWV1ZWRDaHVuayA9IGNodW5rOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgcmVxdWVzdHNDYXBhYmlsaXR5ID0gdGhpcy5fcmVxdWVzdHMuc2hpZnQoKTsKICAgICAgcmVxdWVzdHNDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgIHZhbHVlOiBjaHVuaywKICAgICAgICBkb25lOiBmYWxzZQogICAgICB9KTsKICAgICAgZm9yIChjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSBvZiB0aGlzLl9yZXF1ZXN0cykgewogICAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgIGRvbmU6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPSAwOwogICAgfQogICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgICB0aGlzLl9zdHJlYW0uX3JlbW92ZVJhbmdlUmVhZGVyKHRoaXMpOwogIH0KICBnZXQgaXNTdHJlYW1pbmdTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGFzeW5jIHJlYWQoKSB7CiAgICBpZiAodGhpcy5fcXVldWVkQ2h1bmspIHsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLl9xdWV1ZWRDaHVuazsKICAgICAgdGhpcy5fcXVldWVkQ2h1bmsgPSBudWxsOwogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiBjaHVuaywKICAgICAgICBkb25lOiBmYWxzZQogICAgICB9OwogICAgfQogICAgaWYgKHRoaXMuX2RvbmUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgIGRvbmU6IHRydWUKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLl9yZXF1ZXN0cy5wdXNoKHJlcXVlc3RDYXBhYmlsaXR5KTsKICAgIHJldHVybiByZXF1ZXN0Q2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICBjYW5jZWwocmVhc29uKSB7CiAgICB0aGlzLl9kb25lID0gdHJ1ZTsKICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICAgIHRoaXMuX3N0cmVhbS5fcmVtb3ZlUmFuZ2VSZWFkZXIodGhpcyk7CiAgfQp9OwpmdW5jdGlvbiBnZXRGaWxlbmFtZUZyb21Db250ZW50RGlzcG9zaXRpb25IZWFkZXIoY29udGVudERpc3Bvc2l0aW9uKSB7CiAgbGV0IG5lZWRzRW5jb2RpbmdGaXh1cCA9IHRydWU7CiAgbGV0IHRtcCA9IHRvUGFyYW1SZWdFeHAoImZpbGVuYW1lXFwqIiwgImkiKS5leGVjKGNvbnRlbnREaXNwb3NpdGlvbik7CiAgaWYgKHRtcCkgewogICAgdG1wID0gdG1wWzFdOwogICAgbGV0IGZpbGVuYW1lID0gcmZjMjYxNnVucXVvdGUodG1wKTsKICAgIGZpbGVuYW1lID0gdW5lc2NhcGUoZmlsZW5hbWUpOwogICAgZmlsZW5hbWUgPSByZmM1OTg3ZGVjb2RlKGZpbGVuYW1lKTsKICAgIGZpbGVuYW1lID0gcmZjMjA0N2RlY29kZShmaWxlbmFtZSk7CiAgICByZXR1cm4gZml4dXBFbmNvZGluZyhmaWxlbmFtZSk7CiAgfQogIHRtcCA9IHJmYzIyMzFnZXRwYXJhbShjb250ZW50RGlzcG9zaXRpb24pOwogIGlmICh0bXApIHsKICAgIGNvbnN0IGZpbGVuYW1lID0gcmZjMjA0N2RlY29kZSh0bXApOwogICAgcmV0dXJuIGZpeHVwRW5jb2RpbmcoZmlsZW5hbWUpOwogIH0KICB0bXAgPSB0b1BhcmFtUmVnRXhwKCJmaWxlbmFtZSIsICJpIikuZXhlYyhjb250ZW50RGlzcG9zaXRpb24pOwogIGlmICh0bXApIHsKICAgIHRtcCA9IHRtcFsxXTsKICAgIGxldCBmaWxlbmFtZSA9IHJmYzI2MTZ1bnF1b3RlKHRtcCk7CiAgICBmaWxlbmFtZSA9IHJmYzIwNDdkZWNvZGUoZmlsZW5hbWUpOwogICAgcmV0dXJuIGZpeHVwRW5jb2RpbmcoZmlsZW5hbWUpOwogIH0KICBmdW5jdGlvbiB0b1BhcmFtUmVnRXhwKGF0dHJpYnV0ZVBhdHRlcm4sIGZsYWdzKSB7CiAgICByZXR1cm4gbmV3IFJlZ0V4cCgiKD86Xnw7KVxccyoiICsgYXR0cmlidXRlUGF0dGVybiArICdcXHMqPVxccyooW14iO1xcc11bXjtcXHNdKnwiKD86W14iXFxcXF18XFxcXCI/KSsiPyknLCBmbGFncyk7CiAgfQogIGZ1bmN0aW9uIHRleHRkZWNvZGUoZW5jb2RpbmcsIHZhbHVlKSB7CiAgICBpZiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCEvXltceDAwLVx4RkZdKyQvLnRlc3QodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcihlbmNvZGluZywgewogICAgICAgICAgZmF0YWw6IHRydWUKICAgICAgICB9KTsKICAgICAgICBjb25zdCBidWZmZXIgPSBzdHJpbmdUb0J5dGVzKHZhbHVlKTsKICAgICAgICB2YWx1ZSA9IGRlY29kZXIuZGVjb2RlKGJ1ZmZlcik7CiAgICAgICAgbmVlZHNFbmNvZGluZ0ZpeHVwID0gZmFsc2U7CiAgICAgIH0gY2F0Y2ggewogICAgICB9CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGZ1bmN0aW9uIGZpeHVwRW5jb2RpbmcodmFsdWUpIHsKICAgIGlmIChuZWVkc0VuY29kaW5nRml4dXAgJiYgL1tceDgwLVx4ZmZdLy50ZXN0KHZhbHVlKSkgewogICAgICB2YWx1ZSA9IHRleHRkZWNvZGUoInV0Zi04IiwgdmFsdWUpOwogICAgICBpZiAobmVlZHNFbmNvZGluZ0ZpeHVwKSB7CiAgICAgICAgdmFsdWUgPSB0ZXh0ZGVjb2RlKCJpc28tODg1OS0xIiwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGZ1bmN0aW9uIHJmYzIyMzFnZXRwYXJhbShjb250ZW50RGlzcG9zaXRpb25TdHIpIHsKICAgIGNvbnN0IG1hdGNoZXMgPSBbXTsKICAgIGxldCBtYXRjaDsKICAgIGNvbnN0IGl0ZXIgPSB0b1BhcmFtUmVnRXhwKCJmaWxlbmFtZVxcKigoPyEwXFxkKVxcZCspKFxcKj8pIiwgImlnIik7CiAgICB3aGlsZSAoKG1hdGNoID0gaXRlci5leGVjKGNvbnRlbnREaXNwb3NpdGlvblN0cikpICE9PSBudWxsKSB7CiAgICAgIGxldCBbLCBuLCBxdW90LCBwYXJ0XSA9IG1hdGNoOwogICAgICBuID0gcGFyc2VJbnQobiwgMTApOwogICAgICBpZiAobiBpbiBtYXRjaGVzKSB7CiAgICAgICAgaWYgKG4gPT09IDApIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBtYXRjaGVzW25dID0gW3F1b3QsIHBhcnRdOwogICAgfQogICAgY29uc3QgcGFydHMgPSBbXTsKICAgIGZvciAobGV0IG4gPSAwOyBuIDwgbWF0Y2hlcy5sZW5ndGg7ICsrbikgewogICAgICBpZiAoIShuIGluIG1hdGNoZXMpKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgbGV0IFtxdW90LCBwYXJ0XSA9IG1hdGNoZXNbbl07CiAgICAgIHBhcnQgPSByZmMyNjE2dW5xdW90ZShwYXJ0KTsKICAgICAgaWYgKHF1b3QpIHsKICAgICAgICBwYXJ0ID0gdW5lc2NhcGUocGFydCk7CiAgICAgICAgaWYgKG4gPT09IDApIHsKICAgICAgICAgIHBhcnQgPSByZmM1OTg3ZGVjb2RlKHBhcnQpOwogICAgICAgIH0KICAgICAgfQogICAgICBwYXJ0cy5wdXNoKHBhcnQpOwogICAgfQogICAgcmV0dXJuIHBhcnRzLmpvaW4oIiIpOwogIH0KICBmdW5jdGlvbiByZmMyNjE2dW5xdW90ZSh2YWx1ZSkgewogICAgaWYgKHZhbHVlLnN0YXJ0c1dpdGgoJyInKSkgewogICAgICBjb25zdCBwYXJ0cyA9IHZhbHVlLnNsaWNlKDEpLnNwbGl0KCdcXCInKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7ICsraSkgewogICAgICAgIGNvbnN0IHF1b3RpbmRleCA9IHBhcnRzW2ldLmluZGV4T2YoJyInKTsKICAgICAgICBpZiAocXVvdGluZGV4ICE9PSAtMSkgewogICAgICAgICAgcGFydHNbaV0gPSBwYXJ0c1tpXS5zbGljZSgwLCBxdW90aW5kZXgpOwogICAgICAgICAgcGFydHMubGVuZ3RoID0gaSArIDE7CiAgICAgICAgfQogICAgICAgIHBhcnRzW2ldID0gcGFydHNbaV0ucmVwbGFjZUFsbCgvXFwoLikvZywgIiQxIik7CiAgICAgIH0KICAgICAgdmFsdWUgPSBwYXJ0cy5qb2luKCciJyk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGZ1bmN0aW9uIHJmYzU5ODdkZWNvZGUoZXh0dmFsdWUpIHsKICAgIGNvbnN0IGVuY29kaW5nZW5kID0gZXh0dmFsdWUuaW5kZXhPZigiJyIpOwogICAgaWYgKGVuY29kaW5nZW5kID09PSAtMSkgewogICAgICByZXR1cm4gZXh0dmFsdWU7CiAgICB9CiAgICBjb25zdCBlbmNvZGluZyA9IGV4dHZhbHVlLnNsaWNlKDAsIGVuY29kaW5nZW5kKTsKICAgIGNvbnN0IGxhbmd2YWx1ZSA9IGV4dHZhbHVlLnNsaWNlKGVuY29kaW5nZW5kICsgMSk7CiAgICBjb25zdCB2YWx1ZSA9IGxhbmd2YWx1ZS5yZXBsYWNlKC9eW14nXSonLywgIiIpOwogICAgcmV0dXJuIHRleHRkZWNvZGUoZW5jb2RpbmcsIHZhbHVlKTsKICB9CiAgZnVuY3Rpb24gcmZjMjA0N2RlY29kZSh2YWx1ZSkgewogICAgaWYgKCF2YWx1ZS5zdGFydHNXaXRoKCI9PyIpIHx8IC9bXHgwMC1ceDE5XHg4MC1ceGZmXS8udGVzdCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2VBbGwoLz1cPyhbXHctXSopXD8oW1FxQmJdKVw/KCg/OlteP118XD8oPyE9KSkqKVw/PS9nLCBmdW5jdGlvbihtYXRjaGVzLCBjaGFyc2V0LCBlbmNvZGluZywgdGV4dCkgewogICAgICBpZiAoZW5jb2RpbmcgPT09ICJxIiB8fCBlbmNvZGluZyA9PT0gIlEiKSB7CiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZUFsbCgiXyIsICIgIik7CiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZUFsbCgvPShbMC05YS1mQS1GXXsyfSkvZywgZnVuY3Rpb24obWF0Y2gsIGhleCkgewogICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0ZXh0ZGVjb2RlKGNoYXJzZXQsIHRleHQpOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgdGV4dCA9IGF0b2IodGV4dCk7CiAgICAgIH0gY2F0Y2ggewogICAgICB9CiAgICAgIHJldHVybiB0ZXh0ZGVjb2RlKGNoYXJzZXQsIHRleHQpOwogICAgfSk7CiAgfQogIHJldHVybiAiIjsKfQpmdW5jdGlvbiBjcmVhdGVIZWFkZXJzKGlzSHR0cCwgaHR0cEhlYWRlcnMpIHsKICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoKTsKICBpZiAoIWlzSHR0cCB8fCAhaHR0cEhlYWRlcnMgfHwgdHlwZW9mIGh0dHBIZWFkZXJzICE9PSAib2JqZWN0IikgewogICAgcmV0dXJuIGhlYWRlcnM7CiAgfQogIGZvciAoY29uc3Qga2V5IGluIGh0dHBIZWFkZXJzKSB7CiAgICBjb25zdCB2YWwgPSBodHRwSGVhZGVyc1trZXldOwogICAgaWYgKHZhbCAhPT0gdm9pZCAwKSB7CiAgICAgIGhlYWRlcnMuYXBwZW5kKGtleSwgdmFsKTsKICAgIH0KICB9CiAgcmV0dXJuIGhlYWRlcnM7Cn0KZnVuY3Rpb24gZ2V0UmVzcG9uc2VPcmlnaW4odXJsKSB7CiAgcmV0dXJuIFVSTC5wYXJzZSh1cmwpPy5vcmlnaW4gPz8gbnVsbDsKfQpmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlUmVxdWVzdENhcGFiaWxpdGllcyh7CiAgcmVzcG9uc2VIZWFkZXJzLAogIGlzSHR0cCwKICByYW5nZUNodW5rU2l6ZSwKICBkaXNhYmxlUmFuZ2UKfSkgewogIGNvbnN0IHJldHVyblZhbHVlcyA9IHsKICAgIGFsbG93UmFuZ2VSZXF1ZXN0czogZmFsc2UsCiAgICBzdWdnZXN0ZWRMZW5ndGg6IHZvaWQgMAogIH07CiAgY29uc3QgbGVuZ3RoID0gcGFyc2VJbnQocmVzcG9uc2VIZWFkZXJzLmdldCgiQ29udGVudC1MZW5ndGgiKSwgMTApOwogIGlmICghTnVtYmVyLmlzSW50ZWdlcihsZW5ndGgpKSB7CiAgICByZXR1cm4gcmV0dXJuVmFsdWVzOwogIH0KICByZXR1cm5WYWx1ZXMuc3VnZ2VzdGVkTGVuZ3RoID0gbGVuZ3RoOwogIGlmIChsZW5ndGggPD0gMiAqIHJhbmdlQ2h1bmtTaXplKSB7CiAgICByZXR1cm4gcmV0dXJuVmFsdWVzOwogIH0KICBpZiAoZGlzYWJsZVJhbmdlIHx8ICFpc0h0dHApIHsKICAgIHJldHVybiByZXR1cm5WYWx1ZXM7CiAgfQogIGlmIChyZXNwb25zZUhlYWRlcnMuZ2V0KCJBY2NlcHQtUmFuZ2VzIikgIT09ICJieXRlcyIpIHsKICAgIHJldHVybiByZXR1cm5WYWx1ZXM7CiAgfQogIGNvbnN0IGNvbnRlbnRFbmNvZGluZyA9IHJlc3BvbnNlSGVhZGVycy5nZXQoIkNvbnRlbnQtRW5jb2RpbmciKSB8fCAiaWRlbnRpdHkiOwogIGlmIChjb250ZW50RW5jb2RpbmcgIT09ICJpZGVudGl0eSIpIHsKICAgIHJldHVybiByZXR1cm5WYWx1ZXM7CiAgfQogIHJldHVyblZhbHVlcy5hbGxvd1JhbmdlUmVxdWVzdHMgPSB0cnVlOwogIHJldHVybiByZXR1cm5WYWx1ZXM7Cn0KZnVuY3Rpb24gZXh0cmFjdEZpbGVuYW1lRnJvbUhlYWRlcihyZXNwb25zZUhlYWRlcnMpIHsKICBjb25zdCBjb250ZW50RGlzcG9zaXRpb24gPSByZXNwb25zZUhlYWRlcnMuZ2V0KCJDb250ZW50LURpc3Bvc2l0aW9uIik7CiAgaWYgKGNvbnRlbnREaXNwb3NpdGlvbikgewogICAgbGV0IGZpbGVuYW1lID0gZ2V0RmlsZW5hbWVGcm9tQ29udGVudERpc3Bvc2l0aW9uSGVhZGVyKGNvbnRlbnREaXNwb3NpdGlvbik7CiAgICBpZiAoZmlsZW5hbWUuaW5jbHVkZXMoIiUiKSkgewogICAgICB0cnkgewogICAgICAgIGZpbGVuYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KGZpbGVuYW1lKTsKICAgICAgfSBjYXRjaCB7CiAgICAgIH0KICAgIH0KICAgIGlmIChpc1BkZkZpbGUoZmlsZW5hbWUpKSB7CiAgICAgIHJldHVybiBmaWxlbmFtZTsKICAgIH0KICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gY3JlYXRlUmVzcG9uc2VFcnJvcihzdGF0dXMsIHVybCkgewogIHJldHVybiBuZXcgUmVzcG9uc2VFeGNlcHRpb24oYFVuZXhwZWN0ZWQgc2VydmVyIHJlc3BvbnNlICgke3N0YXR1c30pIHdoaWxlIHJldHJpZXZpbmcgUERGICIke3VybH0iLmAsIHN0YXR1cywgc3RhdHVzID09PSA0MDQgfHwgc3RhdHVzID09PSAwICYmIHVybC5zdGFydHNXaXRoKCJmaWxlOiIpKTsKfQpmdW5jdGlvbiB2YWxpZGF0ZVJlc3BvbnNlU3RhdHVzKHN0YXR1cykgewogIHJldHVybiBzdGF0dXMgPT09IDIwMCB8fCBzdGF0dXMgPT09IDIwNjsKfQpmdW5jdGlvbiBjcmVhdGVGZXRjaE9wdGlvbnMoaGVhZGVycywgd2l0aENyZWRlbnRpYWxzLCBhYm9ydENvbnRyb2xsZXIpIHsKICByZXR1cm4gewogICAgbWV0aG9kOiAiR0VUIiwKICAgIGhlYWRlcnMsCiAgICBzaWduYWw6IGFib3J0Q29udHJvbGxlci5zaWduYWwsCiAgICBtb2RlOiAiY29ycyIsCiAgICBjcmVkZW50aWFsczogd2l0aENyZWRlbnRpYWxzID8gImluY2x1ZGUiIDogInNhbWUtb3JpZ2luIiwKICAgIHJlZGlyZWN0OiAiZm9sbG93IgogIH07Cn0KZnVuY3Rpb24gZ2V0QXJyYXlCdWZmZXIodmFsKSB7CiAgaWYgKHZhbCBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpIHsKICAgIHJldHVybiB2YWwuYnVmZmVyOwogIH0KICBpZiAodmFsIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgIHJldHVybiB2YWw7CiAgfQogIHdhcm4oYGdldEFycmF5QnVmZmVyIC0gdW5leHBlY3RlZCBkYXRhIGZvcm1hdDogJHt2YWx9YCk7CiAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHZhbCkuYnVmZmVyOwp9CnZhciBQREZGZXRjaFN0cmVhbSA9IGNsYXNzIHsKICBfcmVzcG9uc2VPcmlnaW4gPSBudWxsOwogIGNvbnN0cnVjdG9yKHNvdXJjZSkgewogICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7CiAgICB0aGlzLmlzSHR0cCA9IC9eaHR0cHM/Oi9pLnRlc3Qoc291cmNlLnVybCk7CiAgICB0aGlzLmhlYWRlcnMgPSBjcmVhdGVIZWFkZXJzKHRoaXMuaXNIdHRwLCBzb3VyY2UuaHR0cEhlYWRlcnMpOwogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIgPSBudWxsOwogICAgdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycyA9IFtdOwogIH0KICBnZXQgX3Byb2dyZXNzaXZlRGF0YUxlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcj8uX2xvYWRlZCA/PyAwOwogIH0KICBnZXRGdWxsUmVhZGVyKCkgewogICAgYXNzZXJ0KCF0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciwgIlBERkZldGNoU3RyZWFtLmdldEZ1bGxSZWFkZXIgY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2UuIik7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciA9IG5ldyBQREZGZXRjaFN0cmVhbVJlYWRlcih0aGlzKTsKICAgIHJldHVybiB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcjsKICB9CiAgZ2V0UmFuZ2VSZWFkZXIoYmVnaW4sIGVuZCkgewogICAgaWYgKGVuZCA8PSB0aGlzLl9wcm9ncmVzc2l2ZURhdGFMZW5ndGgpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCByZWFkZXIgPSBuZXcgUERGRmV0Y2hTdHJlYW1SYW5nZVJlYWRlcih0aGlzLCBiZWdpbiwgZW5kKTsKICAgIHRoaXMuX3JhbmdlUmVxdWVzdFJlYWRlcnMucHVzaChyZWFkZXIpOwogICAgcmV0dXJuIHJlYWRlcjsKICB9CiAgY2FuY2VsQWxsUmVxdWVzdHMocmVhc29uKSB7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcj8uY2FuY2VsKHJlYXNvbik7CiAgICBmb3IgKGNvbnN0IHJlYWRlciBvZiB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzLnNsaWNlKDApKSB7CiAgICAgIHJlYWRlci5jYW5jZWwocmVhc29uKTsKICAgIH0KICB9Cn07CnZhciBQREZGZXRjaFN0cmVhbVJlYWRlciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihzdHJlYW0pIHsKICAgIHRoaXMuX3N0cmVhbSA9IHN0cmVhbTsKICAgIHRoaXMuX3JlYWRlciA9IG51bGw7CiAgICB0aGlzLl9sb2FkZWQgPSAwOwogICAgdGhpcy5fZmlsZW5hbWUgPSBudWxsOwogICAgY29uc3Qgc291cmNlID0gc3RyZWFtLnNvdXJjZTsKICAgIHRoaXMuX3dpdGhDcmVkZW50aWFscyA9IHNvdXJjZS53aXRoQ3JlZGVudGlhbHMgfHwgZmFsc2U7CiAgICB0aGlzLl9jb250ZW50TGVuZ3RoID0gc291cmNlLmxlbmd0aDsKICAgIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLl9kaXNhYmxlUmFuZ2UgPSBzb3VyY2UuZGlzYWJsZVJhbmdlIHx8IGZhbHNlOwogICAgdGhpcy5fcmFuZ2VDaHVua1NpemUgPSBzb3VyY2UucmFuZ2VDaHVua1NpemU7CiAgICBpZiAoIXRoaXMuX3JhbmdlQ2h1bmtTaXplICYmICF0aGlzLl9kaXNhYmxlUmFuZ2UpIHsKICAgICAgdGhpcy5fZGlzYWJsZVJhbmdlID0gdHJ1ZTsKICAgIH0KICAgIHRoaXMuX2Fib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIHRoaXMuX2lzU3RyZWFtaW5nU3VwcG9ydGVkID0gIXNvdXJjZS5kaXNhYmxlU3RyZWFtOwogICAgdGhpcy5faXNSYW5nZVN1cHBvcnRlZCA9ICFzb3VyY2UuZGlzYWJsZVJhbmdlOwogICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKHN0cmVhbS5oZWFkZXJzKTsKICAgIGNvbnN0IHVybCA9IHNvdXJjZS51cmw7CiAgICBmZXRjaCh1cmwsIGNyZWF0ZUZldGNoT3B0aW9ucyhoZWFkZXJzLCB0aGlzLl93aXRoQ3JlZGVudGlhbHMsIHRoaXMuX2Fib3J0Q29udHJvbGxlcikpLnRoZW4oKHJlc3BvbnNlKSA9PiB7CiAgICAgIHN0cmVhbS5fcmVzcG9uc2VPcmlnaW4gPSBnZXRSZXNwb25zZU9yaWdpbihyZXNwb25zZS51cmwpOwogICAgICBpZiAoIXZhbGlkYXRlUmVzcG9uc2VTdGF0dXMocmVzcG9uc2Uuc3RhdHVzKSkgewogICAgICAgIHRocm93IGNyZWF0ZVJlc3BvbnNlRXJyb3IocmVzcG9uc2Uuc3RhdHVzLCB1cmwpOwogICAgICB9CiAgICAgIHRoaXMuX3JlYWRlciA9IHJlc3BvbnNlLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgICAgY29uc3QgcmVzcG9uc2VIZWFkZXJzID0gcmVzcG9uc2UuaGVhZGVyczsKICAgICAgY29uc3QgewogICAgICAgIGFsbG93UmFuZ2VSZXF1ZXN0cywKICAgICAgICBzdWdnZXN0ZWRMZW5ndGgKICAgICAgfSA9IHZhbGlkYXRlUmFuZ2VSZXF1ZXN0Q2FwYWJpbGl0aWVzKHsKICAgICAgICByZXNwb25zZUhlYWRlcnMsCiAgICAgICAgaXNIdHRwOiBzdHJlYW0uaXNIdHRwLAogICAgICAgIHJhbmdlQ2h1bmtTaXplOiB0aGlzLl9yYW5nZUNodW5rU2l6ZSwKICAgICAgICBkaXNhYmxlUmFuZ2U6IHRoaXMuX2Rpc2FibGVSYW5nZQogICAgICB9KTsKICAgICAgdGhpcy5faXNSYW5nZVN1cHBvcnRlZCA9IGFsbG93UmFuZ2VSZXF1ZXN0czsKICAgICAgdGhpcy5fY29udGVudExlbmd0aCA9IHN1Z2dlc3RlZExlbmd0aCB8fCB0aGlzLl9jb250ZW50TGVuZ3RoOwogICAgICB0aGlzLl9maWxlbmFtZSA9IGV4dHJhY3RGaWxlbmFtZUZyb21IZWFkZXIocmVzcG9uc2VIZWFkZXJzKTsKICAgICAgaWYgKCF0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZCAmJiB0aGlzLl9pc1JhbmdlU3VwcG9ydGVkKSB7CiAgICAgICAgdGhpcy5jYW5jZWwobmV3IEFib3J0RXhjZXB0aW9uKCJTdHJlYW1pbmcgaXMgZGlzYWJsZWQuIikpOwogICAgICB9CiAgICB9KS5jYXRjaCh0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5yZWplY3QpOwogICAgdGhpcy5vblByb2dyZXNzID0gbnVsbDsKICB9CiAgZ2V0IGhlYWRlcnNSZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICBnZXQgZmlsZW5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fZmlsZW5hbWU7CiAgfQogIGdldCBjb250ZW50TGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2NvbnRlbnRMZW5ndGg7CiAgfQogIGdldCBpc1JhbmdlU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQ7CiAgfQogIGdldCBpc1N0cmVhbWluZ1N1cHBvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZDsKICB9CiAgYXN5bmMgcmVhZCgpIHsKICAgIGF3YWl0IHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnByb21pc2U7CiAgICBjb25zdCB7CiAgICAgIHZhbHVlLAogICAgICBkb25lCiAgICB9ID0gYXdhaXQgdGhpcy5fcmVhZGVyLnJlYWQoKTsKICAgIGlmIChkb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUsCiAgICAgICAgZG9uZQogICAgICB9OwogICAgfQogICAgdGhpcy5fbG9hZGVkICs9IHZhbHVlLmJ5dGVMZW5ndGg7CiAgICB0aGlzLm9uUHJvZ3Jlc3M/Lih7CiAgICAgIGxvYWRlZDogdGhpcy5fbG9hZGVkLAogICAgICB0b3RhbDogdGhpcy5fY29udGVudExlbmd0aAogICAgfSk7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogZ2V0QXJyYXlCdWZmZXIodmFsdWUpLAogICAgICBkb25lOiBmYWxzZQogICAgfTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgdGhpcy5fcmVhZGVyPy5jYW5jZWwocmVhc29uKTsKICAgIHRoaXMuX2Fib3J0Q29udHJvbGxlci5hYm9ydCgpOwogIH0KfTsKdmFyIFBERkZldGNoU3RyZWFtUmFuZ2VSZWFkZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3Ioc3RyZWFtLCBiZWdpbiwgZW5kKSB7CiAgICB0aGlzLl9zdHJlYW0gPSBzdHJlYW07CiAgICB0aGlzLl9yZWFkZXIgPSBudWxsOwogICAgdGhpcy5fbG9hZGVkID0gMDsKICAgIGNvbnN0IHNvdXJjZSA9IHN0cmVhbS5zb3VyY2U7CiAgICB0aGlzLl93aXRoQ3JlZGVudGlhbHMgPSBzb3VyY2Uud2l0aENyZWRlbnRpYWxzIHx8IGZhbHNlOwogICAgdGhpcy5fcmVhZENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIHRoaXMuX2lzU3RyZWFtaW5nU3VwcG9ydGVkID0gIXNvdXJjZS5kaXNhYmxlU3RyZWFtOwogICAgdGhpcy5fYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKHN0cmVhbS5oZWFkZXJzKTsKICAgIGhlYWRlcnMuYXBwZW5kKCJSYW5nZSIsIGBieXRlcz0ke2JlZ2lufS0ke2VuZCAtIDF9YCk7CiAgICBjb25zdCB1cmwgPSBzb3VyY2UudXJsOwogICAgZmV0Y2godXJsLCBjcmVhdGVGZXRjaE9wdGlvbnMoaGVhZGVycywgdGhpcy5fd2l0aENyZWRlbnRpYWxzLCB0aGlzLl9hYm9ydENvbnRyb2xsZXIpKS50aGVuKChyZXNwb25zZSkgPT4gewogICAgICBjb25zdCByZXNwb25zZU9yaWdpbiA9IGdldFJlc3BvbnNlT3JpZ2luKHJlc3BvbnNlLnVybCk7CiAgICAgIGlmIChyZXNwb25zZU9yaWdpbiAhPT0gc3RyZWFtLl9yZXNwb25zZU9yaWdpbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgcmFuZ2UgcmVzcG9uc2Utb3JpZ2luICIke3Jlc3BvbnNlT3JpZ2lufSIgdG8gbWF0Y2ggIiR7c3RyZWFtLl9yZXNwb25zZU9yaWdpbn0iLmApOwogICAgICB9CiAgICAgIGlmICghdmFsaWRhdGVSZXNwb25zZVN0YXR1cyhyZXNwb25zZS5zdGF0dXMpKSB7CiAgICAgICAgdGhyb3cgY3JlYXRlUmVzcG9uc2VFcnJvcihyZXNwb25zZS5zdGF0dXMsIHVybCk7CiAgICAgIH0KICAgICAgdGhpcy5fcmVhZENhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgICB0aGlzLl9yZWFkZXIgPSByZXNwb25zZS5ib2R5LmdldFJlYWRlcigpOwogICAgfSkuY2F0Y2godGhpcy5fcmVhZENhcGFiaWxpdHkucmVqZWN0KTsKICAgIHRoaXMub25Qcm9ncmVzcyA9IG51bGw7CiAgfQogIGdldCBpc1N0cmVhbWluZ1N1cHBvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZDsKICB9CiAgYXN5bmMgcmVhZCgpIHsKICAgIGF3YWl0IHRoaXMuX3JlYWRDYXBhYmlsaXR5LnByb21pc2U7CiAgICBjb25zdCB7CiAgICAgIHZhbHVlLAogICAgICBkb25lCiAgICB9ID0gYXdhaXQgdGhpcy5fcmVhZGVyLnJlYWQoKTsKICAgIGlmIChkb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUsCiAgICAgICAgZG9uZQogICAgICB9OwogICAgfQogICAgdGhpcy5fbG9hZGVkICs9IHZhbHVlLmJ5dGVMZW5ndGg7CiAgICB0aGlzLm9uUHJvZ3Jlc3M/Lih7CiAgICAgIGxvYWRlZDogdGhpcy5fbG9hZGVkCiAgICB9KTsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBnZXRBcnJheUJ1ZmZlcih2YWx1ZSksCiAgICAgIGRvbmU6IGZhbHNlCiAgICB9OwogIH0KICBjYW5jZWwocmVhc29uKSB7CiAgICB0aGlzLl9yZWFkZXI/LmNhbmNlbChyZWFzb24pOwogICAgdGhpcy5fYWJvcnRDb250cm9sbGVyLmFib3J0KCk7CiAgfQp9Owp2YXIgT0tfUkVTUE9OU0UgPSAyMDA7CnZhciBQQVJUSUFMX0NPTlRFTlRfUkVTUE9OU0UgPSAyMDY7CmZ1bmN0aW9uIG5ldHdvcmtfZ2V0QXJyYXlCdWZmZXIoeGhyKSB7CiAgY29uc3QgZGF0YSA9IHhoci5yZXNwb25zZTsKICBpZiAodHlwZW9mIGRhdGEgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZGF0YTsKICB9CiAgcmV0dXJuIHN0cmluZ1RvQnl0ZXMoZGF0YSkuYnVmZmVyOwp9CnZhciBOZXR3b3JrTWFuYWdlciA9IGNsYXNzIHsKICBfcmVzcG9uc2VPcmlnaW4gPSBudWxsOwogIGNvbnN0cnVjdG9yKHsKICAgIHVybCwKICAgIGh0dHBIZWFkZXJzLAogICAgd2l0aENyZWRlbnRpYWxzCiAgfSkgewogICAgdGhpcy51cmwgPSB1cmw7CiAgICB0aGlzLmlzSHR0cCA9IC9eaHR0cHM/Oi9pLnRlc3QodXJsKTsKICAgIHRoaXMuaGVhZGVycyA9IGNyZWF0ZUhlYWRlcnModGhpcy5pc0h0dHAsIGh0dHBIZWFkZXJzKTsKICAgIHRoaXMud2l0aENyZWRlbnRpYWxzID0gd2l0aENyZWRlbnRpYWxzIHx8IGZhbHNlOwogICAgdGhpcy5jdXJyWGhySWQgPSAwOwogICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9CiAgcmVxdWVzdChhcmdzKSB7CiAgICBjb25zdCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIGNvbnN0IHhocklkID0gdGhpcy5jdXJyWGhySWQrKzsKICAgIGNvbnN0IHBlbmRpbmdSZXF1ZXN0ID0gdGhpcy5wZW5kaW5nUmVxdWVzdHNbeGhySWRdID0gewogICAgICB4aHIKICAgIH07CiAgICB4aHIub3BlbigiR0VUIiwgdGhpcy51cmwpOwogICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRoaXMud2l0aENyZWRlbnRpYWxzOwogICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIHRoaXMuaGVhZGVycykgewogICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbCk7CiAgICB9CiAgICBpZiAodGhpcy5pc0h0dHAgJiYgImJlZ2luIiBpbiBhcmdzICYmICJlbmQiIGluIGFyZ3MpIHsKICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoIlJhbmdlIiwgYGJ5dGVzPSR7YXJncy5iZWdpbn0tJHthcmdzLmVuZCAtIDF9YCk7CiAgICAgIHBlbmRpbmdSZXF1ZXN0LmV4cGVjdGVkU3RhdHVzID0gUEFSVElBTF9DT05URU5UX1JFU1BPTlNFOwogICAgfSBlbHNlIHsKICAgICAgcGVuZGluZ1JlcXVlc3QuZXhwZWN0ZWRTdGF0dXMgPSBPS19SRVNQT05TRTsKICAgIH0KICAgIHhoci5yZXNwb25zZVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgYXNzZXJ0KGFyZ3Mub25FcnJvciwgIkV4cGVjdGVkIGBvbkVycm9yYCBjYWxsYmFjayB0byBiZSBwcm92aWRlZC4iKTsKICAgIHhoci5vbmVycm9yID0gKCkgPT4gewogICAgICBhcmdzLm9uRXJyb3IoeGhyLnN0YXR1cyk7CiAgICB9OwogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHRoaXMub25TdGF0ZUNoYW5nZS5iaW5kKHRoaXMsIHhocklkKTsKICAgIHhoci5vbnByb2dyZXNzID0gdGhpcy5vblByb2dyZXNzLmJpbmQodGhpcywgeGhySWQpOwogICAgcGVuZGluZ1JlcXVlc3Qub25IZWFkZXJzUmVjZWl2ZWQgPSBhcmdzLm9uSGVhZGVyc1JlY2VpdmVkOwogICAgcGVuZGluZ1JlcXVlc3Qub25Eb25lID0gYXJncy5vbkRvbmU7CiAgICBwZW5kaW5nUmVxdWVzdC5vbkVycm9yID0gYXJncy5vbkVycm9yOwogICAgcGVuZGluZ1JlcXVlc3Qub25Qcm9ncmVzcyA9IGFyZ3Mub25Qcm9ncmVzczsKICAgIHhoci5zZW5kKG51bGwpOwogICAgcmV0dXJuIHhocklkOwogIH0KICBvblByb2dyZXNzKHhocklkLCBldnQpIHsKICAgIGNvbnN0IHBlbmRpbmdSZXF1ZXN0ID0gdGhpcy5wZW5kaW5nUmVxdWVzdHNbeGhySWRdOwogICAgaWYgKCFwZW5kaW5nUmVxdWVzdCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBwZW5kaW5nUmVxdWVzdC5vblByb2dyZXNzPy4oZXZ0KTsKICB9CiAgb25TdGF0ZUNoYW5nZSh4aHJJZCwgZXZ0KSB7CiAgICBjb25zdCBwZW5kaW5nUmVxdWVzdCA9IHRoaXMucGVuZGluZ1JlcXVlc3RzW3hocklkXTsKICAgIGlmICghcGVuZGluZ1JlcXVlc3QpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgeGhyID0gcGVuZGluZ1JlcXVlc3QueGhyOwogICAgaWYgKHhoci5yZWFkeVN0YXRlID49IDIgJiYgcGVuZGluZ1JlcXVlc3Qub25IZWFkZXJzUmVjZWl2ZWQpIHsKICAgICAgcGVuZGluZ1JlcXVlc3Qub25IZWFkZXJzUmVjZWl2ZWQoKTsKICAgICAgZGVsZXRlIHBlbmRpbmdSZXF1ZXN0Lm9uSGVhZGVyc1JlY2VpdmVkOwogICAgfQogICAgaWYgKHhoci5yZWFkeVN0YXRlICE9PSA0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghKHhocklkIGluIHRoaXMucGVuZGluZ1JlcXVlc3RzKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBkZWxldGUgdGhpcy5wZW5kaW5nUmVxdWVzdHNbeGhySWRdOwogICAgaWYgKHhoci5zdGF0dXMgPT09IDAgJiYgdGhpcy5pc0h0dHApIHsKICAgICAgcGVuZGluZ1JlcXVlc3Qub25FcnJvcih4aHIuc3RhdHVzKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgeGhyU3RhdHVzID0geGhyLnN0YXR1cyB8fCBPS19SRVNQT05TRTsKICAgIGNvbnN0IG9rX3Jlc3BvbnNlX29uX3JhbmdlX3JlcXVlc3QgPSB4aHJTdGF0dXMgPT09IE9LX1JFU1BPTlNFICYmIHBlbmRpbmdSZXF1ZXN0LmV4cGVjdGVkU3RhdHVzID09PSBQQVJUSUFMX0NPTlRFTlRfUkVTUE9OU0U7CiAgICBpZiAoIW9rX3Jlc3BvbnNlX29uX3JhbmdlX3JlcXVlc3QgJiYgeGhyU3RhdHVzICE9PSBwZW5kaW5nUmVxdWVzdC5leHBlY3RlZFN0YXR1cykgewogICAgICBwZW5kaW5nUmVxdWVzdC5vbkVycm9yKHhoci5zdGF0dXMpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjaHVuayA9IG5ldHdvcmtfZ2V0QXJyYXlCdWZmZXIoeGhyKTsKICAgIGlmICh4aHJTdGF0dXMgPT09IFBBUlRJQUxfQ09OVEVOVF9SRVNQT05TRSkgewogICAgICBjb25zdCByYW5nZUhlYWRlciA9IHhoci5nZXRSZXNwb25zZUhlYWRlcigiQ29udGVudC1SYW5nZSIpOwogICAgICBjb25zdCBtYXRjaGVzID0gL2J5dGVzIChcZCspLShcZCspXC8oXGQrKS8uZXhlYyhyYW5nZUhlYWRlcik7CiAgICAgIGlmIChtYXRjaGVzKSB7CiAgICAgICAgcGVuZGluZ1JlcXVlc3Qub25Eb25lKHsKICAgICAgICAgIGJlZ2luOiBwYXJzZUludChtYXRjaGVzWzFdLCAxMCksCiAgICAgICAgICBjaHVuawogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4oYE1pc3Npbmcgb3IgaW52YWxpZCAiQ29udGVudC1SYW5nZSIgaGVhZGVyLmApOwogICAgICAgIHBlbmRpbmdSZXF1ZXN0Lm9uRXJyb3IoMCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoY2h1bmspIHsKICAgICAgcGVuZGluZ1JlcXVlc3Qub25Eb25lKHsKICAgICAgICBiZWdpbjogMCwKICAgICAgICBjaHVuawogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHBlbmRpbmdSZXF1ZXN0Lm9uRXJyb3IoeGhyLnN0YXR1cyk7CiAgICB9CiAgfQogIGdldFJlcXVlc3RYaHIoeGhySWQpIHsKICAgIHJldHVybiB0aGlzLnBlbmRpbmdSZXF1ZXN0c1t4aHJJZF0ueGhyOwogIH0KICBpc1BlbmRpbmdSZXF1ZXN0KHhocklkKSB7CiAgICByZXR1cm4geGhySWQgaW4gdGhpcy5wZW5kaW5nUmVxdWVzdHM7CiAgfQogIGFib3J0UmVxdWVzdCh4aHJJZCkgewogICAgY29uc3QgeGhyID0gdGhpcy5wZW5kaW5nUmVxdWVzdHNbeGhySWRdLnhocjsKICAgIGRlbGV0ZSB0aGlzLnBlbmRpbmdSZXF1ZXN0c1t4aHJJZF07CiAgICB4aHIuYWJvcnQoKTsKICB9Cn07CnZhciBQREZOZXR3b3JrU3RyZWFtID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHNvdXJjZSkgewogICAgdGhpcy5fc291cmNlID0gc291cmNlOwogICAgdGhpcy5fbWFuYWdlciA9IG5ldyBOZXR3b3JrTWFuYWdlcihzb3VyY2UpOwogICAgdGhpcy5fcmFuZ2VDaHVua1NpemUgPSBzb3VyY2UucmFuZ2VDaHVua1NpemU7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciA9IG51bGw7CiAgICB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzID0gW107CiAgfQogIF9vblJhbmdlUmVxdWVzdFJlYWRlckNsb3NlZChyZWFkZXIpIHsKICAgIGNvbnN0IGkgPSB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzLmluZGV4T2YocmVhZGVyKTsKICAgIGlmIChpID49IDApIHsKICAgICAgdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycy5zcGxpY2UoaSwgMSk7CiAgICB9CiAgfQogIGdldEZ1bGxSZWFkZXIoKSB7CiAgICBhc3NlcnQoIXRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyLCAiUERGTmV0d29ya1N0cmVhbS5nZXRGdWxsUmVhZGVyIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlLiIpOwogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIgPSBuZXcgUERGTmV0d29ya1N0cmVhbUZ1bGxSZXF1ZXN0UmVhZGVyKHRoaXMuX21hbmFnZXIsIHRoaXMuX3NvdXJjZSk7CiAgICByZXR1cm4gdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI7CiAgfQogIGdldFJhbmdlUmVhZGVyKGJlZ2luLCBlbmQpIHsKICAgIGNvbnN0IHJlYWRlciA9IG5ldyBQREZOZXR3b3JrU3RyZWFtUmFuZ2VSZXF1ZXN0UmVhZGVyKHRoaXMuX21hbmFnZXIsIGJlZ2luLCBlbmQpOwogICAgcmVhZGVyLm9uQ2xvc2VkID0gdGhpcy5fb25SYW5nZVJlcXVlc3RSZWFkZXJDbG9zZWQuYmluZCh0aGlzKTsKICAgIHRoaXMuX3JhbmdlUmVxdWVzdFJlYWRlcnMucHVzaChyZWFkZXIpOwogICAgcmV0dXJuIHJlYWRlcjsKICB9CiAgY2FuY2VsQWxsUmVxdWVzdHMocmVhc29uKSB7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcj8uY2FuY2VsKHJlYXNvbik7CiAgICBmb3IgKGNvbnN0IHJlYWRlciBvZiB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzLnNsaWNlKDApKSB7CiAgICAgIHJlYWRlci5jYW5jZWwocmVhc29uKTsKICAgIH0KICB9Cn07CnZhciBQREZOZXR3b3JrU3RyZWFtRnVsbFJlcXVlc3RSZWFkZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IobWFuYWdlciwgc291cmNlKSB7CiAgICB0aGlzLl9tYW5hZ2VyID0gbWFuYWdlcjsKICAgIHRoaXMuX3VybCA9IHNvdXJjZS51cmw7CiAgICB0aGlzLl9mdWxsUmVxdWVzdElkID0gbWFuYWdlci5yZXF1ZXN0KHsKICAgICAgb25IZWFkZXJzUmVjZWl2ZWQ6IHRoaXMuX29uSGVhZGVyc1JlY2VpdmVkLmJpbmQodGhpcyksCiAgICAgIG9uRG9uZTogdGhpcy5fb25Eb25lLmJpbmQodGhpcyksCiAgICAgIG9uRXJyb3I6IHRoaXMuX29uRXJyb3IuYmluZCh0aGlzKSwKICAgICAgb25Qcm9ncmVzczogdGhpcy5fb25Qcm9ncmVzcy5iaW5kKHRoaXMpCiAgICB9KTsKICAgIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLl9kaXNhYmxlUmFuZ2UgPSBzb3VyY2UuZGlzYWJsZVJhbmdlIHx8IGZhbHNlOwogICAgdGhpcy5fY29udGVudExlbmd0aCA9IHNvdXJjZS5sZW5ndGg7CiAgICB0aGlzLl9yYW5nZUNodW5rU2l6ZSA9IHNvdXJjZS5yYW5nZUNodW5rU2l6ZTsKICAgIGlmICghdGhpcy5fcmFuZ2VDaHVua1NpemUgJiYgIXRoaXMuX2Rpc2FibGVSYW5nZSkgewogICAgICB0aGlzLl9kaXNhYmxlUmFuZ2UgPSB0cnVlOwogICAgfQogICAgdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQgPSBmYWxzZTsKICAgIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQgPSBmYWxzZTsKICAgIHRoaXMuX2NhY2hlZENodW5rcyA9IFtdOwogICAgdGhpcy5fcmVxdWVzdHMgPSBbXTsKICAgIHRoaXMuX2RvbmUgPSBmYWxzZTsKICAgIHRoaXMuX3N0b3JlZEVycm9yID0gdm9pZCAwOwogICAgdGhpcy5fZmlsZW5hbWUgPSBudWxsOwogICAgdGhpcy5vblByb2dyZXNzID0gbnVsbDsKICB9CiAgX29uSGVhZGVyc1JlY2VpdmVkKCkgewogICAgY29uc3QgZnVsbFJlcXVlc3RYaHJJZCA9IHRoaXMuX2Z1bGxSZXF1ZXN0SWQ7CiAgICBjb25zdCBmdWxsUmVxdWVzdFhociA9IHRoaXMuX21hbmFnZXIuZ2V0UmVxdWVzdFhocihmdWxsUmVxdWVzdFhocklkKTsKICAgIHRoaXMuX21hbmFnZXIuX3Jlc3BvbnNlT3JpZ2luID0gZ2V0UmVzcG9uc2VPcmlnaW4oZnVsbFJlcXVlc3RYaHIucmVzcG9uc2VVUkwpOwogICAgY29uc3QgcmF3UmVzcG9uc2VIZWFkZXJzID0gZnVsbFJlcXVlc3RYaHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICBjb25zdCByZXNwb25zZUhlYWRlcnMgPSBuZXcgSGVhZGVycyhyYXdSZXNwb25zZUhlYWRlcnMgPyByYXdSZXNwb25zZUhlYWRlcnMudHJpbVN0YXJ0KCkucmVwbGFjZSgvW15cUyBdKyQvLCAiIikuc3BsaXQoL1tcclxuXSsvKS5tYXAoKHgpID0+IHsKICAgICAgY29uc3QgW2tleSwgLi4udmFsXSA9IHguc3BsaXQoIjogIik7CiAgICAgIHJldHVybiBba2V5LCB2YWwuam9pbigiOiAiKV07CiAgICB9KSA6IFtdKTsKICAgIGNvbnN0IHsKICAgICAgYWxsb3dSYW5nZVJlcXVlc3RzLAogICAgICBzdWdnZXN0ZWRMZW5ndGgKICAgIH0gPSB2YWxpZGF0ZVJhbmdlUmVxdWVzdENhcGFiaWxpdGllcyh7CiAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgaXNIdHRwOiB0aGlzLl9tYW5hZ2VyLmlzSHR0cCwKICAgICAgcmFuZ2VDaHVua1NpemU6IHRoaXMuX3JhbmdlQ2h1bmtTaXplLAogICAgICBkaXNhYmxlUmFuZ2U6IHRoaXMuX2Rpc2FibGVSYW5nZQogICAgfSk7CiAgICBpZiAoYWxsb3dSYW5nZVJlcXVlc3RzKSB7CiAgICAgIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQgPSB0cnVlOwogICAgfQogICAgdGhpcy5fY29udGVudExlbmd0aCA9IHN1Z2dlc3RlZExlbmd0aCB8fCB0aGlzLl9jb250ZW50TGVuZ3RoOwogICAgdGhpcy5fZmlsZW5hbWUgPSBleHRyYWN0RmlsZW5hbWVGcm9tSGVhZGVyKHJlc3BvbnNlSGVhZGVycyk7CiAgICBpZiAodGhpcy5faXNSYW5nZVN1cHBvcnRlZCkgewogICAgICB0aGlzLl9tYW5hZ2VyLmFib3J0UmVxdWVzdChmdWxsUmVxdWVzdFhocklkKTsKICAgIH0KICAgIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnJlc29sdmUoKTsKICB9CiAgX29uRG9uZShkYXRhKSB7CiAgICBpZiAoZGF0YSkgewogICAgICBpZiAodGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5ID0gdGhpcy5fcmVxdWVzdHMuc2hpZnQoKTsKICAgICAgICByZXF1ZXN0Q2FwYWJpbGl0eS5yZXNvbHZlKHsKICAgICAgICAgIHZhbHVlOiBkYXRhLmNodW5rLAogICAgICAgICAgZG9uZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9jYWNoZWRDaHVua3MucHVzaChkYXRhLmNodW5rKTsKICAgICAgfQogICAgfQogICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgICBpZiAodGhpcy5fY2FjaGVkQ2h1bmtzLmxlbmd0aCA+IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSBvZiB0aGlzLl9yZXF1ZXN0cykgewogICAgICByZXF1ZXN0Q2FwYWJpbGl0eS5yZXNvbHZlKHsKICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgIGRvbmU6IHRydWUKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPSAwOwogIH0KICBfb25FcnJvcihzdGF0dXMpIHsKICAgIHRoaXMuX3N0b3JlZEVycm9yID0gY3JlYXRlUmVzcG9uc2VFcnJvcihzdGF0dXMsIHRoaXMuX3VybCk7CiAgICB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5yZWplY3QodGhpcy5fc3RvcmVkRXJyb3IpOwogICAgZm9yIChjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSBvZiB0aGlzLl9yZXF1ZXN0cykgewogICAgICByZXF1ZXN0Q2FwYWJpbGl0eS5yZWplY3QodGhpcy5fc3RvcmVkRXJyb3IpOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICAgIHRoaXMuX2NhY2hlZENodW5rcy5sZW5ndGggPSAwOwogIH0KICBfb25Qcm9ncmVzcyhldnQpIHsKICAgIHRoaXMub25Qcm9ncmVzcz8uKHsKICAgICAgbG9hZGVkOiBldnQubG9hZGVkLAogICAgICB0b3RhbDogZXZ0Lmxlbmd0aENvbXB1dGFibGUgPyBldnQudG90YWwgOiB0aGlzLl9jb250ZW50TGVuZ3RoCiAgICB9KTsKICB9CiAgZ2V0IGZpbGVuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX2ZpbGVuYW1lOwogIH0KICBnZXQgaXNSYW5nZVN1cHBvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9pc1JhbmdlU3VwcG9ydGVkOwogIH0KICBnZXQgaXNTdHJlYW1pbmdTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQ7CiAgfQogIGdldCBjb250ZW50TGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2NvbnRlbnRMZW5ndGg7CiAgfQogIGdldCBoZWFkZXJzUmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5faGVhZGVyc0NhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgYXN5bmMgcmVhZCgpIHsKICAgIGF3YWl0IHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnByb21pc2U7CiAgICBpZiAodGhpcy5fc3RvcmVkRXJyb3IpIHsKICAgICAgdGhyb3cgdGhpcy5fc3RvcmVkRXJyb3I7CiAgICB9CiAgICBpZiAodGhpcy5fY2FjaGVkQ2h1bmtzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLl9jYWNoZWRDaHVua3Muc2hpZnQoKTsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogY2h1bmssCiAgICAgICAgZG9uZTogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5fcmVxdWVzdHMucHVzaChyZXF1ZXN0Q2FwYWJpbGl0eSk7CiAgICByZXR1cm4gcmVxdWVzdENhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgICB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5yZWplY3QocmVhc29uKTsKICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICAgIGlmICh0aGlzLl9tYW5hZ2VyLmlzUGVuZGluZ1JlcXVlc3QodGhpcy5fZnVsbFJlcXVlc3RJZCkpIHsKICAgICAgdGhpcy5fbWFuYWdlci5hYm9ydFJlcXVlc3QodGhpcy5fZnVsbFJlcXVlc3RJZCk7CiAgICB9CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciA9IG51bGw7CiAgfQp9Owp2YXIgUERGTmV0d29ya1N0cmVhbVJhbmdlUmVxdWVzdFJlYWRlciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihtYW5hZ2VyLCBiZWdpbiwgZW5kKSB7CiAgICB0aGlzLl9tYW5hZ2VyID0gbWFuYWdlcjsKICAgIHRoaXMuX3VybCA9IG1hbmFnZXIudXJsOwogICAgdGhpcy5fcmVxdWVzdElkID0gbWFuYWdlci5yZXF1ZXN0KHsKICAgICAgYmVnaW4sCiAgICAgIGVuZCwKICAgICAgb25IZWFkZXJzUmVjZWl2ZWQ6IHRoaXMuX29uSGVhZGVyc1JlY2VpdmVkLmJpbmQodGhpcyksCiAgICAgIG9uRG9uZTogdGhpcy5fb25Eb25lLmJpbmQodGhpcyksCiAgICAgIG9uRXJyb3I6IHRoaXMuX29uRXJyb3IuYmluZCh0aGlzKSwKICAgICAgb25Qcm9ncmVzczogdGhpcy5fb25Qcm9ncmVzcy5iaW5kKHRoaXMpCiAgICB9KTsKICAgIHRoaXMuX3JlcXVlc3RzID0gW107CiAgICB0aGlzLl9xdWV1ZWRDaHVuayA9IG51bGw7CiAgICB0aGlzLl9kb25lID0gZmFsc2U7CiAgICB0aGlzLl9zdG9yZWRFcnJvciA9IHZvaWQgMDsKICAgIHRoaXMub25Qcm9ncmVzcyA9IG51bGw7CiAgICB0aGlzLm9uQ2xvc2VkID0gbnVsbDsKICB9CiAgX29uSGVhZGVyc1JlY2VpdmVkKCkgewogICAgY29uc3QgcmVzcG9uc2VPcmlnaW4gPSBnZXRSZXNwb25zZU9yaWdpbih0aGlzLl9tYW5hZ2VyLmdldFJlcXVlc3RYaHIodGhpcy5fcmVxdWVzdElkKT8ucmVzcG9uc2VVUkwpOwogICAgaWYgKHJlc3BvbnNlT3JpZ2luICE9PSB0aGlzLl9tYW5hZ2VyLl9yZXNwb25zZU9yaWdpbikgewogICAgICB0aGlzLl9zdG9yZWRFcnJvciA9IG5ldyBFcnJvcihgRXhwZWN0ZWQgcmFuZ2UgcmVzcG9uc2Utb3JpZ2luICIke3Jlc3BvbnNlT3JpZ2lufSIgdG8gbWF0Y2ggIiR7dGhpcy5fbWFuYWdlci5fcmVzcG9uc2VPcmlnaW59Ii5gKTsKICAgICAgdGhpcy5fb25FcnJvcigwKTsKICAgIH0KICB9CiAgX2Nsb3NlKCkgewogICAgdGhpcy5vbkNsb3NlZD8uKHRoaXMpOwogIH0KICBfb25Eb25lKGRhdGEpIHsKICAgIGNvbnN0IGNodW5rID0gZGF0YS5jaHVuazsKICAgIGlmICh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5ID0gdGhpcy5fcmVxdWVzdHMuc2hpZnQoKTsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IGNodW5rLAogICAgICAgIGRvbmU6IGZhbHNlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fcXVldWVkQ2h1bmsgPSBjaHVuazsKICAgIH0KICAgIHRoaXMuX2RvbmUgPSB0cnVlOwogICAgZm9yIChjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSBvZiB0aGlzLl9yZXF1ZXN0cykgewogICAgICByZXF1ZXN0Q2FwYWJpbGl0eS5yZXNvbHZlKHsKICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgIGRvbmU6IHRydWUKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPSAwOwogICAgdGhpcy5fY2xvc2UoKTsKICB9CiAgX29uRXJyb3Ioc3RhdHVzKSB7CiAgICB0aGlzLl9zdG9yZWRFcnJvciA/Pz0gY3JlYXRlUmVzcG9uc2VFcnJvcihzdGF0dXMsIHRoaXMuX3VybCk7CiAgICBmb3IgKGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5IG9mIHRoaXMuX3JlcXVlc3RzKSB7CiAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlamVjdCh0aGlzLl9zdG9yZWRFcnJvcik7CiAgICB9CiAgICB0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPSAwOwogICAgdGhpcy5fcXVldWVkQ2h1bmsgPSBudWxsOwogIH0KICBfb25Qcm9ncmVzcyhldnQpIHsKICAgIGlmICghdGhpcy5pc1N0cmVhbWluZ1N1cHBvcnRlZCkgewogICAgICB0aGlzLm9uUHJvZ3Jlc3M/Lih7CiAgICAgICAgbG9hZGVkOiBldnQubG9hZGVkCiAgICAgIH0pOwogICAgfQogIH0KICBnZXQgaXNTdHJlYW1pbmdTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGFzeW5jIHJlYWQoKSB7CiAgICBpZiAodGhpcy5fc3RvcmVkRXJyb3IpIHsKICAgICAgdGhyb3cgdGhpcy5fc3RvcmVkRXJyb3I7CiAgICB9CiAgICBpZiAodGhpcy5fcXVldWVkQ2h1bmsgIT09IG51bGwpIHsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLl9xdWV1ZWRDaHVuazsKICAgICAgdGhpcy5fcXVldWVkQ2h1bmsgPSBudWxsOwogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiBjaHVuaywKICAgICAgICBkb25lOiBmYWxzZQogICAgICB9OwogICAgfQogICAgaWYgKHRoaXMuX2RvbmUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgIGRvbmU6IHRydWUKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLl9yZXF1ZXN0cy5wdXNoKHJlcXVlc3RDYXBhYmlsaXR5KTsKICAgIHJldHVybiByZXF1ZXN0Q2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICBjYW5jZWwocmVhc29uKSB7CiAgICB0aGlzLl9kb25lID0gdHJ1ZTsKICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICAgIGlmICh0aGlzLl9tYW5hZ2VyLmlzUGVuZGluZ1JlcXVlc3QodGhpcy5fcmVxdWVzdElkKSkgewogICAgICB0aGlzLl9tYW5hZ2VyLmFib3J0UmVxdWVzdCh0aGlzLl9yZXF1ZXN0SWQpOwogICAgfQogICAgdGhpcy5fY2xvc2UoKTsKICB9Cn07CnZhciB1cmxSZWdleCA9IC9eW2Etel1bYS16MC05XC0rLl0rOi9pOwpmdW5jdGlvbiBwYXJzZVVybE9yUGF0aChzb3VyY2VVcmwpIHsKICBpZiAodXJsUmVnZXgudGVzdChzb3VyY2VVcmwpKSB7CiAgICByZXR1cm4gbmV3IFVSTChzb3VyY2VVcmwpOwogIH0KICBjb25zdCB1cmwgPSBwcm9jZXNzLmdldEJ1aWx0aW5Nb2R1bGUoInVybCIpOwogIHJldHVybiBuZXcgVVJMKHVybC5wYXRoVG9GaWxlVVJMKHNvdXJjZVVybCkpOwp9CnZhciBQREZOb2RlU3RyZWFtID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHNvdXJjZSkgewogICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7CiAgICB0aGlzLnVybCA9IHBhcnNlVXJsT3JQYXRoKHNvdXJjZS51cmwpOwogICAgYXNzZXJ0KHRoaXMudXJsLnByb3RvY29sID09PSAiZmlsZToiLCAiUERGTm9kZVN0cmVhbSBvbmx5IHN1cHBvcnRzIGZpbGU6Ly8gVVJMcy4iKTsKICAgIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyID0gbnVsbDsKICAgIHRoaXMuX3JhbmdlUmVxdWVzdFJlYWRlcnMgPSBbXTsKICB9CiAgZ2V0IF9wcm9ncmVzc2l2ZURhdGFMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/Ll9sb2FkZWQgPz8gMDsKICB9CiAgZ2V0RnVsbFJlYWRlcigpIHsKICAgIGFzc2VydCghdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIsICJQREZOb2RlU3RyZWFtLmdldEZ1bGxSZWFkZXIgY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2UuIik7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciA9IG5ldyBQREZOb2RlU3RyZWFtRnNGdWxsUmVhZGVyKHRoaXMpOwogICAgcmV0dXJuIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyOwogIH0KICBnZXRSYW5nZVJlYWRlcihzdGFydCwgZW5kKSB7CiAgICBpZiAoZW5kIDw9IHRoaXMuX3Byb2dyZXNzaXZlRGF0YUxlbmd0aCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHJhbmdlUmVhZGVyID0gbmV3IFBERk5vZGVTdHJlYW1Gc1JhbmdlUmVhZGVyKHRoaXMsIHN0YXJ0LCBlbmQpOwogICAgdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycy5wdXNoKHJhbmdlUmVhZGVyKTsKICAgIHJldHVybiByYW5nZVJlYWRlcjsKICB9CiAgY2FuY2VsQWxsUmVxdWVzdHMocmVhc29uKSB7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcj8uY2FuY2VsKHJlYXNvbik7CiAgICBmb3IgKGNvbnN0IHJlYWRlciBvZiB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzLnNsaWNlKDApKSB7CiAgICAgIHJlYWRlci5jYW5jZWwocmVhc29uKTsKICAgIH0KICB9Cn07CnZhciBQREZOb2RlU3RyZWFtRnNGdWxsUmVhZGVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHN0cmVhbSkgewogICAgdGhpcy5fdXJsID0gc3RyZWFtLnVybDsKICAgIHRoaXMuX2RvbmUgPSBmYWxzZTsKICAgIHRoaXMuX3N0b3JlZEVycm9yID0gbnVsbDsKICAgIHRoaXMub25Qcm9ncmVzcyA9IG51bGw7CiAgICBjb25zdCBzb3VyY2UgPSBzdHJlYW0uc291cmNlOwogICAgdGhpcy5fY29udGVudExlbmd0aCA9IHNvdXJjZS5sZW5ndGg7CiAgICB0aGlzLl9sb2FkZWQgPSAwOwogICAgdGhpcy5fZmlsZW5hbWUgPSBudWxsOwogICAgdGhpcy5fZGlzYWJsZVJhbmdlID0gc291cmNlLmRpc2FibGVSYW5nZSB8fCBmYWxzZTsKICAgIHRoaXMuX3JhbmdlQ2h1bmtTaXplID0gc291cmNlLnJhbmdlQ2h1bmtTaXplOwogICAgaWYgKCF0aGlzLl9yYW5nZUNodW5rU2l6ZSAmJiAhdGhpcy5fZGlzYWJsZVJhbmdlKSB7CiAgICAgIHRoaXMuX2Rpc2FibGVSYW5nZSA9IHRydWU7CiAgICB9CiAgICB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZCA9ICFzb3VyY2UuZGlzYWJsZVN0cmVhbTsKICAgIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQgPSAhc291cmNlLmRpc2FibGVSYW5nZTsKICAgIHRoaXMuX3JlYWRhYmxlU3RyZWFtID0gbnVsbDsKICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgY29uc3QgZnMgPSBwcm9jZXNzLmdldEJ1aWx0aW5Nb2R1bGUoImZzIik7CiAgICBmcy5wcm9taXNlcy5sc3RhdCh0aGlzLl91cmwpLnRoZW4oKHN0YXQpID0+IHsKICAgICAgdGhpcy5fY29udGVudExlbmd0aCA9IHN0YXQuc2l6ZTsKICAgICAgdGhpcy5fc2V0UmVhZGFibGVTdHJlYW0oZnMuY3JlYXRlUmVhZFN0cmVhbSh0aGlzLl91cmwpKTsKICAgICAgdGhpcy5faGVhZGVyc0NhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgfSwgKGVycm9yKSA9PiB7CiAgICAgIGlmIChlcnJvci5jb2RlID09PSAiRU5PRU5UIikgewogICAgICAgIGVycm9yID0gY3JlYXRlUmVzcG9uc2VFcnJvcigwLCB0aGlzLl91cmwuaHJlZik7CiAgICAgIH0KICAgICAgdGhpcy5fc3RvcmVkRXJyb3IgPSBlcnJvcjsKICAgICAgdGhpcy5faGVhZGVyc0NhcGFiaWxpdHkucmVqZWN0KGVycm9yKTsKICAgIH0pOwogIH0KICBnZXQgaGVhZGVyc1JlYWR5KCkgewogICAgcmV0dXJuIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIGdldCBmaWxlbmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9maWxlbmFtZTsKICB9CiAgZ2V0IGNvbnRlbnRMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fY29udGVudExlbmd0aDsKICB9CiAgZ2V0IGlzUmFuZ2VTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5faXNSYW5nZVN1cHBvcnRlZDsKICB9CiAgZ2V0IGlzU3RyZWFtaW5nU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHRoaXMuX2lzU3RyZWFtaW5nU3VwcG9ydGVkOwogIH0KICBhc3luYyByZWFkKCkgewogICAgYXdhaXQgdGhpcy5fcmVhZENhcGFiaWxpdHkucHJvbWlzZTsKICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH07CiAgICB9CiAgICBpZiAodGhpcy5fc3RvcmVkRXJyb3IpIHsKICAgICAgdGhyb3cgdGhpcy5fc3RvcmVkRXJyb3I7CiAgICB9CiAgICBjb25zdCBjaHVuayA9IHRoaXMuX3JlYWRhYmxlU3RyZWFtLnJlYWQoKTsKICAgIGlmIChjaHVuayA9PT0gbnVsbCkgewogICAgICB0aGlzLl9yZWFkQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgICByZXR1cm4gdGhpcy5yZWFkKCk7CiAgICB9CiAgICB0aGlzLl9sb2FkZWQgKz0gY2h1bmsubGVuZ3RoOwogICAgdGhpcy5vblByb2dyZXNzPy4oewogICAgICBsb2FkZWQ6IHRoaXMuX2xvYWRlZCwKICAgICAgdG90YWw6IHRoaXMuX2NvbnRlbnRMZW5ndGgKICAgIH0pOwogICAgY29uc3QgYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoY2h1bmspLmJ1ZmZlcjsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBidWZmZXIsCiAgICAgIGRvbmU6IGZhbHNlCiAgICB9OwogIH0KICBjYW5jZWwocmVhc29uKSB7CiAgICBpZiAoIXRoaXMuX3JlYWRhYmxlU3RyZWFtKSB7CiAgICAgIHRoaXMuX2Vycm9yKHJlYXNvbik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX3JlYWRhYmxlU3RyZWFtLmRlc3Ryb3kocmVhc29uKTsKICB9CiAgX2Vycm9yKHJlYXNvbikgewogICAgdGhpcy5fc3RvcmVkRXJyb3IgPSByZWFzb247CiAgICB0aGlzLl9yZWFkQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgfQogIF9zZXRSZWFkYWJsZVN0cmVhbShyZWFkYWJsZVN0cmVhbSkgewogICAgdGhpcy5fcmVhZGFibGVTdHJlYW0gPSByZWFkYWJsZVN0cmVhbTsKICAgIHJlYWRhYmxlU3RyZWFtLm9uKCJyZWFkYWJsZSIsICgpID0+IHsKICAgICAgdGhpcy5fcmVhZENhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgfSk7CiAgICByZWFkYWJsZVN0cmVhbS5vbigiZW5kIiwgKCkgPT4gewogICAgICByZWFkYWJsZVN0cmVhbS5kZXN0cm95KCk7CiAgICAgIHRoaXMuX2RvbmUgPSB0cnVlOwogICAgICB0aGlzLl9yZWFkQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICB9KTsKICAgIHJlYWRhYmxlU3RyZWFtLm9uKCJlcnJvciIsIChyZWFzb24pID0+IHsKICAgICAgdGhpcy5fZXJyb3IocmVhc29uKTsKICAgIH0pOwogICAgaWYgKCF0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZCAmJiB0aGlzLl9pc1JhbmdlU3VwcG9ydGVkKSB7CiAgICAgIHRoaXMuX2Vycm9yKG5ldyBBYm9ydEV4Y2VwdGlvbigic3RyZWFtaW5nIGlzIGRpc2FibGVkIikpOwogICAgfQogICAgaWYgKHRoaXMuX3N0b3JlZEVycm9yKSB7CiAgICAgIHRoaXMuX3JlYWRhYmxlU3RyZWFtLmRlc3Ryb3kodGhpcy5fc3RvcmVkRXJyb3IpOwogICAgfQogIH0KfTsKdmFyIFBERk5vZGVTdHJlYW1Gc1JhbmdlUmVhZGVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHN0cmVhbSwgc3RhcnQsIGVuZCkgewogICAgdGhpcy5fdXJsID0gc3RyZWFtLnVybDsKICAgIHRoaXMuX2RvbmUgPSBmYWxzZTsKICAgIHRoaXMuX3N0b3JlZEVycm9yID0gbnVsbDsKICAgIHRoaXMub25Qcm9ncmVzcyA9IG51bGw7CiAgICB0aGlzLl9sb2FkZWQgPSAwOwogICAgdGhpcy5fcmVhZGFibGVTdHJlYW0gPSBudWxsOwogICAgdGhpcy5fcmVhZENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIGNvbnN0IHNvdXJjZSA9IHN0cmVhbS5zb3VyY2U7CiAgICB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZCA9ICFzb3VyY2UuZGlzYWJsZVN0cmVhbTsKICAgIGNvbnN0IGZzID0gcHJvY2Vzcy5nZXRCdWlsdGluTW9kdWxlKCJmcyIpOwogICAgdGhpcy5fc2V0UmVhZGFibGVTdHJlYW0oZnMuY3JlYXRlUmVhZFN0cmVhbSh0aGlzLl91cmwsIHsKICAgICAgc3RhcnQsCiAgICAgIGVuZDogZW5kIC0gMQogICAgfSkpOwogIH0KICBnZXQgaXNTdHJlYW1pbmdTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQ7CiAgfQogIGFzeW5jIHJlYWQoKSB7CiAgICBhd2FpdCB0aGlzLl9yZWFkQ2FwYWJpbGl0eS5wcm9taXNlOwogICAgaWYgKHRoaXMuX2RvbmUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgIGRvbmU6IHRydWUKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLl9zdG9yZWRFcnJvcikgewogICAgICB0aHJvdyB0aGlzLl9zdG9yZWRFcnJvcjsKICAgIH0KICAgIGNvbnN0IGNodW5rID0gdGhpcy5fcmVhZGFibGVTdHJlYW0ucmVhZCgpOwogICAgaWYgKGNodW5rID09PSBudWxsKSB7CiAgICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICAgIHJldHVybiB0aGlzLnJlYWQoKTsKICAgIH0KICAgIHRoaXMuX2xvYWRlZCArPSBjaHVuay5sZW5ndGg7CiAgICB0aGlzLm9uUHJvZ3Jlc3M/Lih7CiAgICAgIGxvYWRlZDogdGhpcy5fbG9hZGVkCiAgICB9KTsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGNodW5rKS5idWZmZXI7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogYnVmZmVyLAogICAgICBkb25lOiBmYWxzZQogICAgfTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgaWYgKCF0aGlzLl9yZWFkYWJsZVN0cmVhbSkgewogICAgICB0aGlzLl9lcnJvcihyZWFzb24pOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9yZWFkYWJsZVN0cmVhbS5kZXN0cm95KHJlYXNvbik7CiAgfQogIF9lcnJvcihyZWFzb24pIHsKICAgIHRoaXMuX3N0b3JlZEVycm9yID0gcmVhc29uOwogICAgdGhpcy5fcmVhZENhcGFiaWxpdHkucmVzb2x2ZSgpOwogIH0KICBfc2V0UmVhZGFibGVTdHJlYW0ocmVhZGFibGVTdHJlYW0pIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RyZWFtID0gcmVhZGFibGVTdHJlYW07CiAgICByZWFkYWJsZVN0cmVhbS5vbigicmVhZGFibGUiLCAoKSA9PiB7CiAgICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgIH0pOwogICAgcmVhZGFibGVTdHJlYW0ub24oImVuZCIsICgpID0+IHsKICAgICAgcmVhZGFibGVTdHJlYW0uZGVzdHJveSgpOwogICAgICB0aGlzLl9kb25lID0gdHJ1ZTsKICAgICAgdGhpcy5fcmVhZENhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgfSk7CiAgICByZWFkYWJsZVN0cmVhbS5vbigiZXJyb3IiLCAocmVhc29uKSA9PiB7CiAgICAgIHRoaXMuX2Vycm9yKHJlYXNvbik7CiAgICB9KTsKICAgIGlmICh0aGlzLl9zdG9yZWRFcnJvcikgewogICAgICB0aGlzLl9yZWFkYWJsZVN0cmVhbS5kZXN0cm95KHRoaXMuX3N0b3JlZEVycm9yKTsKICAgIH0KICB9Cn07CnZhciBJTklUSUFMX0RBVEEgPSBTeW1ib2woIklOSVRJQUxfREFUQSIpOwp2YXIgUERGT2JqZWN0cyA9IGNsYXNzIHsKICAjb2JqcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICNlbnN1cmVPYmoob2JqSWQpIHsKICAgIHJldHVybiB0aGlzLiNvYmpzW29iaklkXSB8fD0gewogICAgICAuLi5Qcm9taXNlLndpdGhSZXNvbHZlcnMoKSwKICAgICAgZGF0YTogSU5JVElBTF9EQVRBCiAgICB9OwogIH0KICBnZXQob2JqSWQsIGNhbGxiYWNrID0gbnVsbCkgewogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIGNvbnN0IG9iajIgPSB0aGlzLiNlbnN1cmVPYmoob2JqSWQpOwogICAgICBvYmoyLnByb21pc2UudGhlbigoKSA9PiBjYWxsYmFjayhvYmoyLmRhdGEpKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCBvYmogPSB0aGlzLiNvYmpzW29iaklkXTsKICAgIGlmICghb2JqIHx8IG9iai5kYXRhID09PSBJTklUSUFMX0RBVEEpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZXF1ZXN0aW5nIG9iamVjdCB0aGF0IGlzbid0IHJlc29sdmVkIHlldCAke29iaklkfS5gKTsKICAgIH0KICAgIHJldHVybiBvYmouZGF0YTsKICB9CiAgaGFzKG9iaklkKSB7CiAgICBjb25zdCBvYmogPSB0aGlzLiNvYmpzW29iaklkXTsKICAgIHJldHVybiAhIW9iaiAmJiBvYmouZGF0YSAhPT0gSU5JVElBTF9EQVRBOwogIH0KICBkZWxldGUob2JqSWQpIHsKICAgIGNvbnN0IG9iaiA9IHRoaXMuI29ianNbb2JqSWRdOwogICAgaWYgKCFvYmogfHwgb2JqLmRhdGEgPT09IElOSVRJQUxfREFUQSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBkZWxldGUgdGhpcy4jb2Jqc1tvYmpJZF07CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmVzb2x2ZShvYmpJZCwgZGF0YSA9IG51bGwpIHsKICAgIGNvbnN0IG9iaiA9IHRoaXMuI2Vuc3VyZU9iaihvYmpJZCk7CiAgICBvYmouZGF0YSA9IGRhdGE7CiAgICBvYmoucmVzb2x2ZSgpOwogIH0KICBjbGVhcigpIHsKICAgIGZvciAoY29uc3Qgb2JqSWQgaW4gdGhpcy4jb2JqcykgewogICAgICBjb25zdCB7CiAgICAgICAgZGF0YQogICAgICB9ID0gdGhpcy4jb2Jqc1tvYmpJZF07CiAgICAgIGRhdGE/LmJpdG1hcD8uY2xvc2UoKTsKICAgIH0KICAgIHRoaXMuI29ianMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB9CiAgKltTeW1ib2wuaXRlcmF0b3JdKCkgewogICAgZm9yIChjb25zdCBvYmpJZCBpbiB0aGlzLiNvYmpzKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRhCiAgICAgIH0gPSB0aGlzLiNvYmpzW29iaklkXTsKICAgICAgaWYgKGRhdGEgPT09IElOSVRJQUxfREFUQSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHlpZWxkIFtvYmpJZCwgZGF0YV07CiAgICB9CiAgfQp9Owp2YXIgTUFYX1RFWFRfRElWU19UT19SRU5ERVIgPSAxZTU7CnZhciBERUZBVUxUX0ZPTlRfU0laRSA9IDMwOwp2YXIgVGV4dExheWVyID0gY2xhc3MgX1RleHRMYXllciB7CiAgI2NhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAjY29udGFpbmVyID0gbnVsbDsKICAjZGlzYWJsZVByb2Nlc3NJdGVtcyA9IGZhbHNlOwogICNmb250SW5zcGVjdG9yRW5hYmxlZCA9ICEhZ2xvYmFsVGhpcy5Gb250SW5zcGVjdG9yPy5lbmFibGVkOwogICNsYW5nID0gbnVsbDsKICAjbGF5b3V0VGV4dFBhcmFtcyA9IG51bGw7CiAgI3BhZ2VIZWlnaHQgPSAwOwogICNwYWdlV2lkdGggPSAwOwogICNyZWFkZXIgPSBudWxsOwogICNyb290Q29udGFpbmVyID0gbnVsbDsKICAjcm90YXRpb24gPSAwOwogICNzY2FsZSA9IDA7CiAgI3N0eWxlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAjdGV4dENvbnRlbnRJdGVtc1N0ciA9IFtdOwogICN0ZXh0Q29udGVudFNvdXJjZSA9IG51bGw7CiAgI3RleHREaXZzID0gW107CiAgI3RleHREaXZQcm9wZXJ0aWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgI3RyYW5zZm9ybSA9IG51bGw7CiAgc3RhdGljICNhc2NlbnRDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgc3RhdGljICNjYW52YXNDb250ZXh0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgc3RhdGljICNjYW52YXNDdHhGb250cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogIHN0YXRpYyAjbWluRm9udFNpemUgPSBudWxsOwogIHN0YXRpYyAjcGVuZGluZ1RleHRMYXllcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogIGNvbnN0cnVjdG9yKHsKICAgIHRleHRDb250ZW50U291cmNlLAogICAgY29udGFpbmVyOiBjb250YWluZXIyLAogICAgdmlld3BvcnQKICB9KSB7CiAgICBpZiAodGV4dENvbnRlbnRTb3VyY2UgaW5zdGFuY2VvZiBSZWFkYWJsZVN0cmVhbSkgewogICAgICB0aGlzLiN0ZXh0Q29udGVudFNvdXJjZSA9IHRleHRDb250ZW50U291cmNlOwogICAgfSBlbHNlIGlmICh0eXBlb2YgdGV4dENvbnRlbnRTb3VyY2UgPT09ICJvYmplY3QiKSB7CiAgICAgIHRoaXMuI3RleHRDb250ZW50U291cmNlID0gbmV3IFJlYWRhYmxlU3RyZWFtKHsKICAgICAgICBzdGFydChjb250cm9sbGVyKSB7CiAgICAgICAgICBjb250cm9sbGVyLmVucXVldWUodGV4dENvbnRlbnRTb3VyY2UpOwogICAgICAgICAgY29udHJvbGxlci5jbG9zZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vICJ0ZXh0Q29udGVudFNvdXJjZSIgcGFyYW1ldGVyIHNwZWNpZmllZC4nKTsKICAgIH0KICAgIHRoaXMuI2NvbnRhaW5lciA9IHRoaXMuI3Jvb3RDb250YWluZXIgPSBjb250YWluZXIyOwogICAgdGhpcy4jc2NhbGUgPSB2aWV3cG9ydC5zY2FsZSAqIE91dHB1dFNjYWxlLnBpeGVsUmF0aW87CiAgICB0aGlzLiNyb3RhdGlvbiA9IHZpZXdwb3J0LnJvdGF0aW9uOwogICAgdGhpcy4jbGF5b3V0VGV4dFBhcmFtcyA9IHsKICAgICAgZGl2OiBudWxsLAogICAgICBwcm9wZXJ0aWVzOiBudWxsLAogICAgICBjdHg6IG51bGwKICAgIH07CiAgICBjb25zdCB7CiAgICAgIHBhZ2VXaWR0aCwKICAgICAgcGFnZUhlaWdodCwKICAgICAgcGFnZVgsCiAgICAgIHBhZ2VZCiAgICB9ID0gdmlld3BvcnQucmF3RGltczsKICAgIHRoaXMuI3RyYW5zZm9ybSA9IFsxLCAwLCAwLCAtMSwgLXBhZ2VYLCBwYWdlWSArIHBhZ2VIZWlnaHRdOwogICAgdGhpcy4jcGFnZVdpZHRoID0gcGFnZVdpZHRoOwogICAgdGhpcy4jcGFnZUhlaWdodCA9IHBhZ2VIZWlnaHQ7CiAgICBfVGV4dExheWVyLiNlbnN1cmVNaW5Gb250U2l6ZUNvbXB1dGVkKCk7CiAgICBjb250YWluZXIyLnN0eWxlLnNldFByb3BlcnR5KCItLW1pbi1mb250LXNpemUiLCBfVGV4dExheWVyLiNtaW5Gb250U2l6ZSk7CiAgICBzZXRMYXllckRpbWVuc2lvbnMoY29udGFpbmVyMiwgdmlld3BvcnQpOwogICAgdGhpcy4jY2FwYWJpbGl0eS5wcm9taXNlLmZpbmFsbHkoKCkgPT4gewogICAgICBfVGV4dExheWVyLiNwZW5kaW5nVGV4dExheWVycy5kZWxldGUodGhpcyk7CiAgICAgIHRoaXMuI2xheW91dFRleHRQYXJhbXMgPSBudWxsOwogICAgICB0aGlzLiNzdHlsZUNhY2hlID0gbnVsbDsKICAgIH0pLmNhdGNoKCgpID0+IHsKICAgIH0pOwogIH0KICBzdGF0aWMgZ2V0IGZvbnRGYW1pbHlNYXAoKSB7CiAgICBjb25zdCB7CiAgICAgIGlzV2luZG93cywKICAgICAgaXNGaXJlZm94CiAgICB9ID0gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybTsKICAgIHJldHVybiBzaGFkb3codGhpcywgImZvbnRGYW1pbHlNYXAiLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbWyJzYW5zLXNlcmlmIiwgYCR7aXNXaW5kb3dzICYmIGlzRmlyZWZveCA/ICJDYWxpYnJpLCAiIDogIiJ9c2Fucy1zZXJpZmBdLCBbIm1vbm9zcGFjZSIsIGAke2lzV2luZG93cyAmJiBpc0ZpcmVmb3ggPyAiTHVjaWRhIENvbnNvbGUsICIgOiAiIn1tb25vc3BhY2VgXV0pKTsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3QgcHVtcCA9ICgpID0+IHsKICAgICAgdGhpcy4jcmVhZGVyLnJlYWQoKS50aGVuKCh7CiAgICAgICAgdmFsdWUsCiAgICAgICAgZG9uZQogICAgICB9KSA9PiB7CiAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgIHRoaXMuI2NhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLiNsYW5nID8/PSB2YWx1ZS5sYW5nOwogICAgICAgIE9iamVjdC5hc3NpZ24odGhpcy4jc3R5bGVDYWNoZSwgdmFsdWUuc3R5bGVzKTsKICAgICAgICB0aGlzLiNwcm9jZXNzSXRlbXModmFsdWUuaXRlbXMpOwogICAgICAgIHB1bXAoKTsKICAgICAgfSwgdGhpcy4jY2FwYWJpbGl0eS5yZWplY3QpOwogICAgfTsKICAgIHRoaXMuI3JlYWRlciA9IHRoaXMuI3RleHRDb250ZW50U291cmNlLmdldFJlYWRlcigpOwogICAgX1RleHRMYXllci4jcGVuZGluZ1RleHRMYXllcnMuYWRkKHRoaXMpOwogICAgcHVtcCgpOwogICAgcmV0dXJuIHRoaXMuI2NhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgdXBkYXRlKHsKICAgIHZpZXdwb3J0LAogICAgb25CZWZvcmUgPSBudWxsCiAgfSkgewogICAgY29uc3Qgc2NhbGUgPSB2aWV3cG9ydC5zY2FsZSAqIE91dHB1dFNjYWxlLnBpeGVsUmF0aW87CiAgICBjb25zdCByb3RhdGlvbiA9IHZpZXdwb3J0LnJvdGF0aW9uOwogICAgaWYgKHJvdGF0aW9uICE9PSB0aGlzLiNyb3RhdGlvbikgewogICAgICBvbkJlZm9yZT8uKCk7CiAgICAgIHRoaXMuI3JvdGF0aW9uID0gcm90YXRpb247CiAgICAgIHNldExheWVyRGltZW5zaW9ucyh0aGlzLiNyb290Q29udGFpbmVyLCB7CiAgICAgICAgcm90YXRpb24KICAgICAgfSk7CiAgICB9CiAgICBpZiAoc2NhbGUgIT09IHRoaXMuI3NjYWxlKSB7CiAgICAgIG9uQmVmb3JlPy4oKTsKICAgICAgdGhpcy4jc2NhbGUgPSBzY2FsZTsKICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgIGRpdjogbnVsbCwKICAgICAgICBwcm9wZXJ0aWVzOiBudWxsLAogICAgICAgIGN0eDogX1RleHRMYXllci4jZ2V0Q3R4KHRoaXMuI2xhbmcpCiAgICAgIH07CiAgICAgIGZvciAoY29uc3QgZGl2IG9mIHRoaXMuI3RleHREaXZzKSB7CiAgICAgICAgcGFyYW1zLnByb3BlcnRpZXMgPSB0aGlzLiN0ZXh0RGl2UHJvcGVydGllcy5nZXQoZGl2KTsKICAgICAgICBwYXJhbXMuZGl2ID0gZGl2OwogICAgICAgIHRoaXMuI2xheW91dChwYXJhbXMpOwogICAgICB9CiAgICB9CiAgfQogIGNhbmNlbCgpIHsKICAgIGNvbnN0IGFib3J0RXggPSBuZXcgQWJvcnRFeGNlcHRpb24oIlRleHRMYXllciB0YXNrIGNhbmNlbGxlZC4iKTsKICAgIHRoaXMuI3JlYWRlcj8uY2FuY2VsKGFib3J0RXgpLmNhdGNoKCgpID0+IHsKICAgIH0pOwogICAgdGhpcy4jcmVhZGVyID0gbnVsbDsKICAgIHRoaXMuI2NhcGFiaWxpdHkucmVqZWN0KGFib3J0RXgpOwogIH0KICBnZXQgdGV4dERpdnMoKSB7CiAgICByZXR1cm4gdGhpcy4jdGV4dERpdnM7CiAgfQogIGdldCB0ZXh0Q29udGVudEl0ZW1zU3RyKCkgewogICAgcmV0dXJuIHRoaXMuI3RleHRDb250ZW50SXRlbXNTdHI7CiAgfQogICNwcm9jZXNzSXRlbXMoaXRlbXMpIHsKICAgIGlmICh0aGlzLiNkaXNhYmxlUHJvY2Vzc0l0ZW1zKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2xheW91dFRleHRQYXJhbXMuY3R4ID8/PSBfVGV4dExheWVyLiNnZXRDdHgodGhpcy4jbGFuZyk7CiAgICBjb25zdCB0ZXh0RGl2cyA9IHRoaXMuI3RleHREaXZzLCB0ZXh0Q29udGVudEl0ZW1zU3RyID0gdGhpcy4jdGV4dENvbnRlbnRJdGVtc1N0cjsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykgewogICAgICBpZiAodGV4dERpdnMubGVuZ3RoID4gTUFYX1RFWFRfRElWU19UT19SRU5ERVIpIHsKICAgICAgICB3YXJuKCJJZ25vcmluZyBhZGRpdGlvbmFsIHRleHREaXZzIGZvciBwZXJmb3JtYW5jZSByZWFzb25zLiIpOwogICAgICAgIHRoaXMuI2Rpc2FibGVQcm9jZXNzSXRlbXMgPSB0cnVlOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaXRlbS5zdHIgPT09IHZvaWQgMCkgewogICAgICAgIGlmIChpdGVtLnR5cGUgPT09ICJiZWdpbk1hcmtlZENvbnRlbnRQcm9wcyIgfHwgaXRlbS50eXBlID09PSAiYmVnaW5NYXJrZWRDb250ZW50IikgewogICAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy4jY29udGFpbmVyOwogICAgICAgICAgdGhpcy4jY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICAgICAgdGhpcy4jY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoIm1hcmtlZENvbnRlbnQiKTsKICAgICAgICAgIGlmIChpdGVtLmlkKSB7CiAgICAgICAgICAgIHRoaXMuI2NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoImlkIiwgYCR7aXRlbS5pZH1gKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcmVudC5hcHBlbmQodGhpcy4jY29udGFpbmVyKTsKICAgICAgICB9IGVsc2UgaWYgKGl0ZW0udHlwZSA9PT0gImVuZE1hcmtlZENvbnRlbnQiKSB7CiAgICAgICAgICB0aGlzLiNjb250YWluZXIgPSB0aGlzLiNjb250YWluZXIucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgdGV4dENvbnRlbnRJdGVtc1N0ci5wdXNoKGl0ZW0uc3RyKTsKICAgICAgdGhpcy4jYXBwZW5kVGV4dChpdGVtKTsKICAgIH0KICB9CiAgI2FwcGVuZFRleHQoZ2VvbSkgewogICAgY29uc3QgdGV4dERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIGNvbnN0IHRleHREaXZQcm9wZXJ0aWVzID0gewogICAgICBhbmdsZTogMCwKICAgICAgY2FudmFzV2lkdGg6IDAsCiAgICAgIGhhc1RleHQ6IGdlb20uc3RyICE9PSAiIiwKICAgICAgaGFzRU9MOiBnZW9tLmhhc0VPTCwKICAgICAgZm9udFNpemU6IDAKICAgIH07CiAgICB0aGlzLiN0ZXh0RGl2cy5wdXNoKHRleHREaXYpOwogICAgY29uc3QgdHggPSBVdGlsLnRyYW5zZm9ybSh0aGlzLiN0cmFuc2Zvcm0sIGdlb20udHJhbnNmb3JtKTsKICAgIGxldCBhbmdsZSA9IE1hdGguYXRhbjIodHhbMV0sIHR4WzBdKTsKICAgIGNvbnN0IHN0eWxlID0gdGhpcy4jc3R5bGVDYWNoZVtnZW9tLmZvbnROYW1lXTsKICAgIGlmIChzdHlsZS52ZXJ0aWNhbCkgewogICAgICBhbmdsZSArPSBNYXRoLlBJIC8gMjsKICAgIH0KICAgIGxldCBmb250RmFtaWx5ID0gdGhpcy4jZm9udEluc3BlY3RvckVuYWJsZWQgJiYgc3R5bGUuZm9udFN1YnN0aXR1dGlvbiB8fCBzdHlsZS5mb250RmFtaWx5OwogICAgZm9udEZhbWlseSA9IF9UZXh0TGF5ZXIuZm9udEZhbWlseU1hcC5nZXQoZm9udEZhbWlseSkgfHwgZm9udEZhbWlseTsKICAgIGNvbnN0IGZvbnRIZWlnaHQgPSBNYXRoLmh5cG90KHR4WzJdLCB0eFszXSk7CiAgICBjb25zdCBmb250QXNjZW50ID0gZm9udEhlaWdodCAqIF9UZXh0TGF5ZXIuI2dldEFzY2VudChmb250RmFtaWx5LCBzdHlsZSwgdGhpcy4jbGFuZyk7CiAgICBsZXQgbGVmdCwgdG9wOwogICAgaWYgKGFuZ2xlID09PSAwKSB7CiAgICAgIGxlZnQgPSB0eFs0XTsKICAgICAgdG9wID0gdHhbNV0gLSBmb250QXNjZW50OwogICAgfSBlbHNlIHsKICAgICAgbGVmdCA9IHR4WzRdICsgZm9udEFzY2VudCAqIE1hdGguc2luKGFuZ2xlKTsKICAgICAgdG9wID0gdHhbNV0gLSBmb250QXNjZW50ICogTWF0aC5jb3MoYW5nbGUpOwogICAgfQogICAgY29uc3QgZGl2U3R5bGUgPSB0ZXh0RGl2LnN0eWxlOwogICAgZGl2U3R5bGUubGVmdCA9IGAkeygxMDAgKiBsZWZ0IC8gdGhpcy4jcGFnZVdpZHRoKS50b0ZpeGVkKDIpfSVgOwogICAgZGl2U3R5bGUudG9wID0gYCR7KDEwMCAqIHRvcCAvIHRoaXMuI3BhZ2VIZWlnaHQpLnRvRml4ZWQoMil9JWA7CiAgICBkaXZTdHlsZS5zZXRQcm9wZXJ0eSgiLS1mb250LWhlaWdodCIsIGAke2ZvbnRIZWlnaHQudG9GaXhlZCgyKX1weGApOwogICAgZGl2U3R5bGUuZm9udEZhbWlseSA9IGZvbnRGYW1pbHk7CiAgICB0ZXh0RGl2UHJvcGVydGllcy5mb250U2l6ZSA9IGZvbnRIZWlnaHQ7CiAgICB0ZXh0RGl2LnNldEF0dHJpYnV0ZSgicm9sZSIsICJwcmVzZW50YXRpb24iKTsKICAgIHRleHREaXYudGV4dENvbnRlbnQgPSBnZW9tLnN0cjsKICAgIHRleHREaXYuZGlyID0gZ2VvbS5kaXI7CiAgICBpZiAodGhpcy4jZm9udEluc3BlY3RvckVuYWJsZWQpIHsKICAgICAgdGV4dERpdi5kYXRhc2V0LmZvbnROYW1lID0gc3R5bGUuZm9udFN1YnN0aXR1dGlvbkxvYWRlZE5hbWUgfHwgZ2VvbS5mb250TmFtZTsKICAgIH0KICAgIGlmIChhbmdsZSAhPT0gMCkgewogICAgICB0ZXh0RGl2UHJvcGVydGllcy5hbmdsZSA9IGFuZ2xlICogKDE4MCAvIE1hdGguUEkpOwogICAgfQogICAgbGV0IHNob3VsZFNjYWxlVGV4dCA9IGZhbHNlOwogICAgaWYgKGdlb20uc3RyLmxlbmd0aCA+IDEpIHsKICAgICAgc2hvdWxkU2NhbGVUZXh0ID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoZ2VvbS5zdHIgIT09ICIgIiAmJiBnZW9tLnRyYW5zZm9ybVswXSAhPT0gZ2VvbS50cmFuc2Zvcm1bM10pIHsKICAgICAgY29uc3QgYWJzU2NhbGVYID0gTWF0aC5hYnMoZ2VvbS50cmFuc2Zvcm1bMF0pLCBhYnNTY2FsZVkgPSBNYXRoLmFicyhnZW9tLnRyYW5zZm9ybVszXSk7CiAgICAgIGlmIChhYnNTY2FsZVggIT09IGFic1NjYWxlWSAmJiBNYXRoLm1heChhYnNTY2FsZVgsIGFic1NjYWxlWSkgLyBNYXRoLm1pbihhYnNTY2FsZVgsIGFic1NjYWxlWSkgPiAxLjUpIHsKICAgICAgICBzaG91bGRTY2FsZVRleHQgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICBpZiAoc2hvdWxkU2NhbGVUZXh0KSB7CiAgICAgIHRleHREaXZQcm9wZXJ0aWVzLmNhbnZhc1dpZHRoID0gc3R5bGUudmVydGljYWwgPyBnZW9tLmhlaWdodCA6IGdlb20ud2lkdGg7CiAgICB9CiAgICB0aGlzLiN0ZXh0RGl2UHJvcGVydGllcy5zZXQodGV4dERpdiwgdGV4dERpdlByb3BlcnRpZXMpOwogICAgdGhpcy4jbGF5b3V0VGV4dFBhcmFtcy5kaXYgPSB0ZXh0RGl2OwogICAgdGhpcy4jbGF5b3V0VGV4dFBhcmFtcy5wcm9wZXJ0aWVzID0gdGV4dERpdlByb3BlcnRpZXM7CiAgICB0aGlzLiNsYXlvdXQodGhpcy4jbGF5b3V0VGV4dFBhcmFtcyk7CiAgICBpZiAodGV4dERpdlByb3BlcnRpZXMuaGFzVGV4dCkgewogICAgICB0aGlzLiNjb250YWluZXIuYXBwZW5kKHRleHREaXYpOwogICAgfQogICAgaWYgKHRleHREaXZQcm9wZXJ0aWVzLmhhc0VPTCkgewogICAgICBjb25zdCBiciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJyIik7CiAgICAgIGJyLnNldEF0dHJpYnV0ZSgicm9sZSIsICJwcmVzZW50YXRpb24iKTsKICAgICAgdGhpcy4jY29udGFpbmVyLmFwcGVuZChicik7CiAgICB9CiAgfQogICNsYXlvdXQocGFyYW1zKSB7CiAgICBjb25zdCB7CiAgICAgIGRpdiwKICAgICAgcHJvcGVydGllcywKICAgICAgY3R4CiAgICB9ID0gcGFyYW1zOwogICAgY29uc3QgewogICAgICBzdHlsZQogICAgfSA9IGRpdjsKICAgIGlmIChwcm9wZXJ0aWVzLmNhbnZhc1dpZHRoICE9PSAwICYmIHByb3BlcnRpZXMuaGFzVGV4dCkgewogICAgICBjb25zdCB7CiAgICAgICAgZm9udEZhbWlseQogICAgICB9ID0gc3R5bGU7CiAgICAgIGNvbnN0IHsKICAgICAgICBjYW52YXNXaWR0aCwKICAgICAgICBmb250U2l6ZQogICAgICB9ID0gcHJvcGVydGllczsKICAgICAgX1RleHRMYXllci4jZW5zdXJlQ3R4Rm9udChjdHgsIGZvbnRTaXplICogdGhpcy4jc2NhbGUsIGZvbnRGYW1pbHkpOwogICAgICBjb25zdCB7CiAgICAgICAgd2lkdGgKICAgICAgfSA9IGN0eC5tZWFzdXJlVGV4dChkaXYudGV4dENvbnRlbnQpOwogICAgICBpZiAod2lkdGggPiAwKSB7CiAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoIi0tc2NhbGUteCIsIGNhbnZhc1dpZHRoICogdGhpcy4jc2NhbGUgLyB3aWR0aCk7CiAgICAgIH0KICAgIH0KICAgIGlmIChwcm9wZXJ0aWVzLmFuZ2xlICE9PSAwKSB7CiAgICAgIHN0eWxlLnNldFByb3BlcnR5KCItLXJvdGF0ZSIsIGAke3Byb3BlcnRpZXMuYW5nbGV9ZGVnYCk7CiAgICB9CiAgfQogIHN0YXRpYyBjbGVhbnVwKCkgewogICAgaWYgKHRoaXMuI3BlbmRpbmdUZXh0TGF5ZXJzLnNpemUgPiAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FzY2VudENhY2hlLmNsZWFyKCk7CiAgICBmb3IgKGNvbnN0IHsKICAgICAgY2FudmFzCiAgICB9IG9mIHRoaXMuI2NhbnZhc0NvbnRleHRzLnZhbHVlcygpKSB7CiAgICAgIGNhbnZhcy5yZW1vdmUoKTsKICAgIH0KICAgIHRoaXMuI2NhbnZhc0NvbnRleHRzLmNsZWFyKCk7CiAgfQogIHN0YXRpYyAjZ2V0Q3R4KGxhbmcgPSBudWxsKSB7CiAgICBsZXQgY3R4ID0gdGhpcy4jY2FudmFzQ29udGV4dHMuZ2V0KGxhbmcgfHw9ICIiKTsKICAgIGlmICghY3R4KSB7CiAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICBjYW52YXMuY2xhc3NOYW1lID0gImhpZGRlbkNhbnZhc0VsZW1lbnQiOwogICAgICBjYW52YXMubGFuZyA9IGxhbmc7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kKGNhbnZhcyk7CiAgICAgIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsKICAgICAgICBhbHBoYTogZmFsc2UsCiAgICAgICAgd2lsbFJlYWRGcmVxdWVudGx5OiB0cnVlCiAgICAgIH0pOwogICAgICB0aGlzLiNjYW52YXNDb250ZXh0cy5zZXQobGFuZywgY3R4KTsKICAgICAgdGhpcy4jY2FudmFzQ3R4Rm9udHMuc2V0KGN0eCwgewogICAgICAgIHNpemU6IDAsCiAgICAgICAgZmFtaWx5OiAiIgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBjdHg7CiAgfQogIHN0YXRpYyAjZW5zdXJlQ3R4Rm9udChjdHgsIHNpemUsIGZhbWlseSkgewogICAgY29uc3QgY2FjaGVkID0gdGhpcy4jY2FudmFzQ3R4Rm9udHMuZ2V0KGN0eCk7CiAgICBpZiAoc2l6ZSA9PT0gY2FjaGVkLnNpemUgJiYgZmFtaWx5ID09PSBjYWNoZWQuZmFtaWx5KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGN0eC5mb250ID0gYCR7c2l6ZX1weCAke2ZhbWlseX1gOwogICAgY2FjaGVkLnNpemUgPSBzaXplOwogICAgY2FjaGVkLmZhbWlseSA9IGZhbWlseTsKICB9CiAgc3RhdGljICNlbnN1cmVNaW5Gb250U2l6ZUNvbXB1dGVkKCkgewogICAgaWYgKHRoaXMuI21pbkZvbnRTaXplICE9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2LnN0eWxlLm9wYWNpdHkgPSAwOwogICAgZGl2LnN0eWxlLmxpbmVIZWlnaHQgPSAxOwogICAgZGl2LnN0eWxlLmZvbnRTaXplID0gIjFweCI7CiAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgZGl2LnRleHRDb250ZW50ID0gIlgiOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmQoZGl2KTsKICAgIHRoaXMuI21pbkZvbnRTaXplID0gZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmhlaWdodDsKICAgIGRpdi5yZW1vdmUoKTsKICB9CiAgc3RhdGljICNnZXRBc2NlbnQoZm9udEZhbWlseSwgc3R5bGUsIGxhbmcpIHsKICAgIGNvbnN0IGNhY2hlZEFzY2VudCA9IHRoaXMuI2FzY2VudENhY2hlLmdldChmb250RmFtaWx5KTsKICAgIGlmIChjYWNoZWRBc2NlbnQpIHsKICAgICAgcmV0dXJuIGNhY2hlZEFzY2VudDsKICAgIH0KICAgIGNvbnN0IGN0eCA9IHRoaXMuI2dldEN0eChsYW5nKTsKICAgIGN0eC5jYW52YXMud2lkdGggPSBjdHguY2FudmFzLmhlaWdodCA9IERFRkFVTFRfRk9OVF9TSVpFOwogICAgdGhpcy4jZW5zdXJlQ3R4Rm9udChjdHgsIERFRkFVTFRfRk9OVF9TSVpFLCBmb250RmFtaWx5KTsKICAgIGNvbnN0IG1ldHJpY3MgPSBjdHgubWVhc3VyZVRleHQoIiIpOwogICAgY29uc3QgYXNjZW50ID0gbWV0cmljcy5mb250Qm91bmRpbmdCb3hBc2NlbnQ7CiAgICBjb25zdCBkZXNjZW50ID0gTWF0aC5hYnMobWV0cmljcy5mb250Qm91bmRpbmdCb3hEZXNjZW50KTsKICAgIGN0eC5jYW52YXMud2lkdGggPSBjdHguY2FudmFzLmhlaWdodCA9IDA7CiAgICBsZXQgcmF0aW8gPSAwLjg7CiAgICBpZiAoYXNjZW50KSB7CiAgICAgIHJhdGlvID0gYXNjZW50IC8gKGFzY2VudCArIGRlc2NlbnQpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm0uaXNGaXJlZm94KSB7CiAgICAgICAgd2FybigiRW5hYmxlIHRoZSBgZG9tLnRleHRNZXRyaWNzLmZvbnRCb3VuZGluZ0JveC5lbmFibGVkYCBwcmVmZXJlbmNlIGluIGBhYm91dDpjb25maWdgIHRvIGltcHJvdmUgVGV4dExheWVyIHJlbmRlcmluZy4iKTsKICAgICAgfQogICAgICBpZiAoc3R5bGUuYXNjZW50KSB7CiAgICAgICAgcmF0aW8gPSBzdHlsZS5hc2NlbnQ7CiAgICAgIH0gZWxzZSBpZiAoc3R5bGUuZGVzY2VudCkgewogICAgICAgIHJhdGlvID0gMSArIHN0eWxlLmRlc2NlbnQ7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2FzY2VudENhY2hlLnNldChmb250RmFtaWx5LCByYXRpbyk7CiAgICByZXR1cm4gcmF0aW87CiAgfQp9Owp2YXIgUkVOREVSSU5HX0NBTkNFTExFRF9USU1FT1VUID0gMTAwOwpmdW5jdGlvbiBnZXREb2N1bWVudChzcmMgPSB7fSkgewogIGlmICh0eXBlb2Ygc3JjID09PSAic3RyaW5nIiB8fCBzcmMgaW5zdGFuY2VvZiBVUkwpIHsKICAgIHNyYyA9IHsKICAgICAgdXJsOiBzcmMKICAgIH07CiAgfSBlbHNlIGlmIChzcmMgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciB8fCBBcnJheUJ1ZmZlci5pc1ZpZXcoc3JjKSkgewogICAgc3JjID0gewogICAgICBkYXRhOiBzcmMKICAgIH07CiAgfQogIGNvbnN0IHRhc2sgPSBuZXcgUERGRG9jdW1lbnRMb2FkaW5nVGFzaygpOwogIGNvbnN0IHsKICAgIGRvY0lkCiAgfSA9IHRhc2s7CiAgY29uc3QgdXJsID0gc3JjLnVybCA/IGdldFVybFByb3Aoc3JjLnVybCkgOiBudWxsOwogIGNvbnN0IGRhdGEgPSBzcmMuZGF0YSA/IGdldERhdGFQcm9wKHNyYy5kYXRhKSA6IG51bGw7CiAgY29uc3QgaHR0cEhlYWRlcnMgPSBzcmMuaHR0cEhlYWRlcnMgfHwgbnVsbDsKICBjb25zdCB3aXRoQ3JlZGVudGlhbHMgPSBzcmMud2l0aENyZWRlbnRpYWxzID09PSB0cnVlOwogIGNvbnN0IHBhc3N3b3JkID0gc3JjLnBhc3N3b3JkID8/IG51bGw7CiAgY29uc3QgcmFuZ2VUcmFuc3BvcnQgPSBzcmMucmFuZ2UgaW5zdGFuY2VvZiBQREZEYXRhUmFuZ2VUcmFuc3BvcnQgPyBzcmMucmFuZ2UgOiBudWxsOwogIGNvbnN0IHJhbmdlQ2h1bmtTaXplID0gTnVtYmVyLmlzSW50ZWdlcihzcmMucmFuZ2VDaHVua1NpemUpICYmIHNyYy5yYW5nZUNodW5rU2l6ZSA+IDAgPyBzcmMucmFuZ2VDaHVua1NpemUgOiAyICoqIDE2OwogIGxldCB3b3JrZXIgPSBzcmMud29ya2VyIGluc3RhbmNlb2YgUERGV29ya2VyID8gc3JjLndvcmtlciA6IG51bGw7CiAgY29uc3QgdmVyYm9zaXR5MiA9IHNyYy52ZXJib3NpdHk7CiAgY29uc3QgZG9jQmFzZVVybCA9IHR5cGVvZiBzcmMuZG9jQmFzZVVybCA9PT0gInN0cmluZyIgJiYgIWlzRGF0YVNjaGVtZShzcmMuZG9jQmFzZVVybCkgPyBzcmMuZG9jQmFzZVVybCA6IG51bGw7CiAgY29uc3QgY01hcFVybCA9IGdldEZhY3RvcnlVcmxQcm9wKHNyYy5jTWFwVXJsKTsKICBjb25zdCBjTWFwUGFja2VkID0gc3JjLmNNYXBQYWNrZWQgIT09IGZhbHNlOwogIGNvbnN0IENNYXBSZWFkZXJGYWN0b3J5ID0gc3JjLkNNYXBSZWFkZXJGYWN0b3J5IHx8IChpc05vZGVKUyA/IE5vZGVDTWFwUmVhZGVyRmFjdG9yeSA6IERPTUNNYXBSZWFkZXJGYWN0b3J5KTsKICBjb25zdCBpY2NVcmwgPSBnZXRGYWN0b3J5VXJsUHJvcChzcmMuaWNjVXJsKTsKICBjb25zdCBzdGFuZGFyZEZvbnREYXRhVXJsID0gZ2V0RmFjdG9yeVVybFByb3Aoc3JjLnN0YW5kYXJkRm9udERhdGFVcmwpOwogIGNvbnN0IFN0YW5kYXJkRm9udERhdGFGYWN0b3J5ID0gc3JjLlN0YW5kYXJkRm9udERhdGFGYWN0b3J5IHx8IChpc05vZGVKUyA/IE5vZGVTdGFuZGFyZEZvbnREYXRhRmFjdG9yeSA6IERPTVN0YW5kYXJkRm9udERhdGFGYWN0b3J5KTsKICBjb25zdCB3YXNtVXJsID0gZ2V0RmFjdG9yeVVybFByb3Aoc3JjLndhc21VcmwpOwogIGNvbnN0IFdhc21GYWN0b3J5ID0gc3JjLldhc21GYWN0b3J5IHx8IChpc05vZGVKUyA/IE5vZGVXYXNtRmFjdG9yeSA6IERPTVdhc21GYWN0b3J5KTsKICBjb25zdCBpZ25vcmVFcnJvcnMgPSBzcmMuc3RvcEF0RXJyb3JzICE9PSB0cnVlOwogIGNvbnN0IG1heEltYWdlU2l6ZSA9IE51bWJlci5pc0ludGVnZXIoc3JjLm1heEltYWdlU2l6ZSkgJiYgc3JjLm1heEltYWdlU2l6ZSA+IC0xID8gc3JjLm1heEltYWdlU2l6ZSA6IC0xOwogIGNvbnN0IGlzRXZhbFN1cHBvcnRlZDIgPSBzcmMuaXNFdmFsU3VwcG9ydGVkICE9PSBmYWxzZTsKICBjb25zdCBpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRlZCA9IHR5cGVvZiBzcmMuaXNPZmZzY3JlZW5DYW52YXNTdXBwb3J0ZWQgPT09ICJib29sZWFuIiA/IHNyYy5pc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRlZCA6ICFpc05vZGVKUzsKICBjb25zdCBpc0ltYWdlRGVjb2RlclN1cHBvcnRlZCA9IHR5cGVvZiBzcmMuaXNJbWFnZURlY29kZXJTdXBwb3J0ZWQgPT09ICJib29sZWFuIiA/IHNyYy5pc0ltYWdlRGVjb2RlclN1cHBvcnRlZCA6ICFpc05vZGVKUyAmJiAodXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybS5pc0ZpcmVmb3ggfHwgIWdsb2JhbFRoaXMuY2hyb21lKTsKICBjb25zdCBjYW52YXNNYXhBcmVhSW5CeXRlcyA9IE51bWJlci5pc0ludGVnZXIoc3JjLmNhbnZhc01heEFyZWFJbkJ5dGVzKSA/IHNyYy5jYW52YXNNYXhBcmVhSW5CeXRlcyA6IC0xOwogIGNvbnN0IGRpc2FibGVGb250RmFjZSA9IHR5cGVvZiBzcmMuZGlzYWJsZUZvbnRGYWNlID09PSAiYm9vbGVhbiIgPyBzcmMuZGlzYWJsZUZvbnRGYWNlIDogaXNOb2RlSlM7CiAgY29uc3QgZm9udEV4dHJhUHJvcGVydGllcyA9IHNyYy5mb250RXh0cmFQcm9wZXJ0aWVzID09PSB0cnVlOwogIGNvbnN0IGVuYWJsZVhmYSA9IHNyYy5lbmFibGVYZmEgPT09IHRydWU7CiAgY29uc3Qgb3duZXJEb2N1bWVudCA9IHNyYy5vd25lckRvY3VtZW50IHx8IGdsb2JhbFRoaXMuZG9jdW1lbnQ7CiAgY29uc3QgZGlzYWJsZVJhbmdlID0gc3JjLmRpc2FibGVSYW5nZSA9PT0gdHJ1ZTsKICBjb25zdCBkaXNhYmxlU3RyZWFtID0gc3JjLmRpc2FibGVTdHJlYW0gPT09IHRydWU7CiAgY29uc3QgZGlzYWJsZUF1dG9GZXRjaCA9IHNyYy5kaXNhYmxlQXV0b0ZldGNoID09PSB0cnVlOwogIGNvbnN0IHBkZkJ1ZyA9IHNyYy5wZGZCdWcgPT09IHRydWU7CiAgY29uc3QgQ2FudmFzRmFjdG9yeSA9IHNyYy5DYW52YXNGYWN0b3J5IHx8IChpc05vZGVKUyA/IE5vZGVDYW52YXNGYWN0b3J5IDogRE9NQ2FudmFzRmFjdG9yeSk7CiAgY29uc3QgRmlsdGVyRmFjdG9yeSA9IHNyYy5GaWx0ZXJGYWN0b3J5IHx8IChpc05vZGVKUyA/IE5vZGVGaWx0ZXJGYWN0b3J5IDogRE9NRmlsdGVyRmFjdG9yeSk7CiAgY29uc3QgZW5hYmxlSFdBID0gc3JjLmVuYWJsZUhXQSA9PT0gdHJ1ZTsKICBjb25zdCB1c2VXYXNtID0gc3JjLnVzZVdhc20gIT09IGZhbHNlOwogIGNvbnN0IGxlbmd0aCA9IHJhbmdlVHJhbnNwb3J0ID8gcmFuZ2VUcmFuc3BvcnQubGVuZ3RoIDogc3JjLmxlbmd0aCA/PyBOYU47CiAgY29uc3QgdXNlU3lzdGVtRm9udHMgPSB0eXBlb2Ygc3JjLnVzZVN5c3RlbUZvbnRzID09PSAiYm9vbGVhbiIgPyBzcmMudXNlU3lzdGVtRm9udHMgOiAhaXNOb2RlSlMgJiYgIWRpc2FibGVGb250RmFjZTsKICBjb25zdCB1c2VXb3JrZXJGZXRjaCA9IHR5cGVvZiBzcmMudXNlV29ya2VyRmV0Y2ggPT09ICJib29sZWFuIiA/IHNyYy51c2VXb3JrZXJGZXRjaCA6ICEhKENNYXBSZWFkZXJGYWN0b3J5ID09PSBET01DTWFwUmVhZGVyRmFjdG9yeSAmJiBTdGFuZGFyZEZvbnREYXRhRmFjdG9yeSA9PT0gRE9NU3RhbmRhcmRGb250RGF0YUZhY3RvcnkgJiYgV2FzbUZhY3RvcnkgPT09IERPTVdhc21GYWN0b3J5ICYmIGNNYXBVcmwgJiYgc3RhbmRhcmRGb250RGF0YVVybCAmJiB3YXNtVXJsICYmIGlzVmFsaWRGZXRjaFVybChjTWFwVXJsLCBkb2N1bWVudC5iYXNlVVJJKSAmJiBpc1ZhbGlkRmV0Y2hVcmwoc3RhbmRhcmRGb250RGF0YVVybCwgZG9jdW1lbnQuYmFzZVVSSSkgJiYgaXNWYWxpZEZldGNoVXJsKHdhc21VcmwsIGRvY3VtZW50LmJhc2VVUkkpKTsKICBjb25zdCBzdHlsZUVsZW1lbnQgPSBudWxsOwogIHNldFZlcmJvc2l0eUxldmVsKHZlcmJvc2l0eTIpOwogIGNvbnN0IHRyYW5zcG9ydEZhY3RvcnkgPSB7CiAgICBjYW52YXNGYWN0b3J5OiBuZXcgQ2FudmFzRmFjdG9yeSh7CiAgICAgIG93bmVyRG9jdW1lbnQsCiAgICAgIGVuYWJsZUhXQQogICAgfSksCiAgICBmaWx0ZXJGYWN0b3J5OiBuZXcgRmlsdGVyRmFjdG9yeSh7CiAgICAgIGRvY0lkLAogICAgICBvd25lckRvY3VtZW50CiAgICB9KSwKICAgIGNNYXBSZWFkZXJGYWN0b3J5OiB1c2VXb3JrZXJGZXRjaCA/IG51bGwgOiBuZXcgQ01hcFJlYWRlckZhY3RvcnkoewogICAgICBiYXNlVXJsOiBjTWFwVXJsLAogICAgICBpc0NvbXByZXNzZWQ6IGNNYXBQYWNrZWQKICAgIH0pLAogICAgc3RhbmRhcmRGb250RGF0YUZhY3Rvcnk6IHVzZVdvcmtlckZldGNoID8gbnVsbCA6IG5ldyBTdGFuZGFyZEZvbnREYXRhRmFjdG9yeSh7CiAgICAgIGJhc2VVcmw6IHN0YW5kYXJkRm9udERhdGFVcmwKICAgIH0pLAogICAgd2FzbUZhY3Rvcnk6IHVzZVdvcmtlckZldGNoID8gbnVsbCA6IG5ldyBXYXNtRmFjdG9yeSh7CiAgICAgIGJhc2VVcmw6IHdhc21VcmwKICAgIH0pCiAgfTsKICBpZiAoIXdvcmtlcikgewogICAgd29ya2VyID0gUERGV29ya2VyLmNyZWF0ZSh7CiAgICAgIHZlcmJvc2l0eTogdmVyYm9zaXR5MiwKICAgICAgcG9ydDogR2xvYmFsV29ya2VyT3B0aW9ucy53b3JrZXJQb3J0CiAgICB9KTsKICAgIHRhc2suX3dvcmtlciA9IHdvcmtlcjsKICB9CiAgY29uc3QgZG9jUGFyYW1zID0gewogICAgZG9jSWQsCiAgICBhcGlWZXJzaW9uOiAiNS40LjUzMCIsCiAgICBkYXRhLAogICAgcGFzc3dvcmQsCiAgICBkaXNhYmxlQXV0b0ZldGNoLAogICAgcmFuZ2VDaHVua1NpemUsCiAgICBsZW5ndGgsCiAgICBkb2NCYXNlVXJsLAogICAgZW5hYmxlWGZhLAogICAgZXZhbHVhdG9yT3B0aW9uczogewogICAgICBtYXhJbWFnZVNpemUsCiAgICAgIGRpc2FibGVGb250RmFjZSwKICAgICAgaWdub3JlRXJyb3JzLAogICAgICBpc0V2YWxTdXBwb3J0ZWQ6IGlzRXZhbFN1cHBvcnRlZDIsCiAgICAgIGlzT2Zmc2NyZWVuQ2FudmFzU3VwcG9ydGVkLAogICAgICBpc0ltYWdlRGVjb2RlclN1cHBvcnRlZCwKICAgICAgY2FudmFzTWF4QXJlYUluQnl0ZXMsCiAgICAgIGZvbnRFeHRyYVByb3BlcnRpZXMsCiAgICAgIHVzZVN5c3RlbUZvbnRzLAogICAgICB1c2VXYXNtLAogICAgICB1c2VXb3JrZXJGZXRjaCwKICAgICAgY01hcFVybCwKICAgICAgaWNjVXJsLAogICAgICBzdGFuZGFyZEZvbnREYXRhVXJsLAogICAgICB3YXNtVXJsCiAgICB9CiAgfTsKICBjb25zdCB0cmFuc3BvcnRQYXJhbXMgPSB7CiAgICBvd25lckRvY3VtZW50LAogICAgcGRmQnVnLAogICAgc3R5bGVFbGVtZW50LAogICAgbG9hZGluZ1BhcmFtczogewogICAgICBkaXNhYmxlQXV0b0ZldGNoLAogICAgICBlbmFibGVYZmEKICAgIH0KICB9OwogIHdvcmtlci5wcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7CiAgICBpZiAodGFzay5kZXN0cm95ZWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJMb2FkaW5nIGFib3J0ZWQiKTsKICAgIH0KICAgIGlmICh3b3JrZXIuZGVzdHJveWVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiV29ya2VyIHdhcyBkZXN0cm95ZWQiKTsKICAgIH0KICAgIGNvbnN0IHdvcmtlcklkUHJvbWlzZSA9IHdvcmtlci5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldERvY1JlcXVlc3QiLCBkb2NQYXJhbXMsIGRhdGEgPyBbZGF0YS5idWZmZXJdIDogbnVsbCk7CiAgICBsZXQgbmV0d29ya1N0cmVhbTsKICAgIGlmIChyYW5nZVRyYW5zcG9ydCkgewogICAgICBuZXR3b3JrU3RyZWFtID0gbmV3IFBERkRhdGFUcmFuc3BvcnRTdHJlYW0ocmFuZ2VUcmFuc3BvcnQsIHsKICAgICAgICBkaXNhYmxlUmFuZ2UsCiAgICAgICAgZGlzYWJsZVN0cmVhbQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoIWRhdGEpIHsKICAgICAgaWYgKCF1cmwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImdldERvY3VtZW50IC0gbm8gYHVybGAgcGFyYW1ldGVyIHByb3ZpZGVkLiIpOwogICAgICB9CiAgICAgIGNvbnN0IE5ldHdvcmtTdHJlYW0gPSBpc1ZhbGlkRmV0Y2hVcmwodXJsKSA/IFBERkZldGNoU3RyZWFtIDogaXNOb2RlSlMgPyBQREZOb2RlU3RyZWFtIDogUERGTmV0d29ya1N0cmVhbTsKICAgICAgbmV0d29ya1N0cmVhbSA9IG5ldyBOZXR3b3JrU3RyZWFtKHsKICAgICAgICB1cmwsCiAgICAgICAgbGVuZ3RoLAogICAgICAgIGh0dHBIZWFkZXJzLAogICAgICAgIHdpdGhDcmVkZW50aWFscywKICAgICAgICByYW5nZUNodW5rU2l6ZSwKICAgICAgICBkaXNhYmxlUmFuZ2UsCiAgICAgICAgZGlzYWJsZVN0cmVhbQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB3b3JrZXJJZFByb21pc2UudGhlbigod29ya2VySWQpID0+IHsKICAgICAgaWYgKHRhc2suZGVzdHJveWVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJMb2FkaW5nIGFib3J0ZWQiKTsKICAgICAgfQogICAgICBpZiAod29ya2VyLmRlc3Ryb3llZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiV29ya2VyIHdhcyBkZXN0cm95ZWQiKTsKICAgICAgfQogICAgICBjb25zdCBtZXNzYWdlSGFuZGxlciA9IG5ldyBNZXNzYWdlSGFuZGxlcihkb2NJZCwgd29ya2VySWQsIHdvcmtlci5wb3J0KTsKICAgICAgY29uc3QgdHJhbnNwb3J0ID0gbmV3IFdvcmtlclRyYW5zcG9ydChtZXNzYWdlSGFuZGxlciwgdGFzaywgbmV0d29ya1N0cmVhbSwgdHJhbnNwb3J0UGFyYW1zLCB0cmFuc3BvcnRGYWN0b3J5LCBlbmFibGVIV0EpOwogICAgICB0YXNrLl90cmFuc3BvcnQgPSB0cmFuc3BvcnQ7CiAgICAgIG1lc3NhZ2VIYW5kbGVyLnNlbmQoIlJlYWR5IiwgbnVsbCk7CiAgICB9KTsKICB9KS5jYXRjaCh0YXNrLl9jYXBhYmlsaXR5LnJlamVjdCk7CiAgcmV0dXJuIHRhc2s7Cn0KdmFyIFBERkRvY3VtZW50TG9hZGluZ1Rhc2sgPSBjbGFzcyBfUERGRG9jdW1lbnRMb2FkaW5nVGFzayB7CiAgc3RhdGljICNkb2NJZCA9IDA7CiAgX2NhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICBfdHJhbnNwb3J0ID0gbnVsbDsKICBfd29ya2VyID0gbnVsbDsKICBkb2NJZCA9IGBkJHtfUERGRG9jdW1lbnRMb2FkaW5nVGFzay4jZG9jSWQrK31gOwogIGRlc3Ryb3llZCA9IGZhbHNlOwogIG9uUGFzc3dvcmQgPSBudWxsOwogIG9uUHJvZ3Jlc3MgPSBudWxsOwogIGdldCBwcm9taXNlKCkgewogICAgcmV0dXJuIHRoaXMuX2NhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgYXN5bmMgZGVzdHJveSgpIHsKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLl93b3JrZXI/LnBvcnQpIHsKICAgICAgICB0aGlzLl93b3JrZXIuX3BlbmRpbmdEZXN0cm95ID0gdHJ1ZTsKICAgICAgfQogICAgICBhd2FpdCB0aGlzLl90cmFuc3BvcnQ/LmRlc3Ryb3koKTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIGlmICh0aGlzLl93b3JrZXI/LnBvcnQpIHsKICAgICAgICBkZWxldGUgdGhpcy5fd29ya2VyLl9wZW5kaW5nRGVzdHJveTsKICAgICAgfQogICAgICB0aHJvdyBleDsKICAgIH0KICAgIHRoaXMuX3RyYW5zcG9ydCA9IG51bGw7CiAgICB0aGlzLl93b3JrZXI/LmRlc3Ryb3koKTsKICAgIHRoaXMuX3dvcmtlciA9IG51bGw7CiAgfQogIGFzeW5jIGdldERhdGEoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldERhdGEoKTsKICB9Cn07CnZhciBQREZEYXRhUmFuZ2VUcmFuc3BvcnQgPSBjbGFzcyB7CiAgI2NhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAjcHJvZ3Jlc3NpdmVEb25lTGlzdGVuZXJzID0gW107CiAgI3Byb2dyZXNzaXZlUmVhZExpc3RlbmVycyA9IFtdOwogICNwcm9ncmVzc0xpc3RlbmVycyA9IFtdOwogICNyYW5nZUxpc3RlbmVycyA9IFtdOwogIGNvbnN0cnVjdG9yKGxlbmd0aCwgaW5pdGlhbERhdGEyLCBwcm9ncmVzc2l2ZURvbmUgPSBmYWxzZSwgY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWUgPSBudWxsKSB7CiAgICB0aGlzLmxlbmd0aCA9IGxlbmd0aDsKICAgIHRoaXMuaW5pdGlhbERhdGEgPSBpbml0aWFsRGF0YTI7CiAgICB0aGlzLnByb2dyZXNzaXZlRG9uZSA9IHByb2dyZXNzaXZlRG9uZTsKICAgIHRoaXMuY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWUgPSBjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZTsKICB9CiAgYWRkUmFuZ2VMaXN0ZW5lcihsaXN0ZW5lcikgewogICAgdGhpcy4jcmFuZ2VMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgfQogIGFkZFByb2dyZXNzTGlzdGVuZXIobGlzdGVuZXIpIHsKICAgIHRoaXMuI3Byb2dyZXNzTGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpOwogIH0KICBhZGRQcm9ncmVzc2l2ZVJlYWRMaXN0ZW5lcihsaXN0ZW5lcikgewogICAgdGhpcy4jcHJvZ3Jlc3NpdmVSZWFkTGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpOwogIH0KICBhZGRQcm9ncmVzc2l2ZURvbmVMaXN0ZW5lcihsaXN0ZW5lcikgewogICAgdGhpcy4jcHJvZ3Jlc3NpdmVEb25lTGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpOwogIH0KICBvbkRhdGFSYW5nZShiZWdpbiwgY2h1bmspIHsKICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgdGhpcy4jcmFuZ2VMaXN0ZW5lcnMpIHsKICAgICAgbGlzdGVuZXIoYmVnaW4sIGNodW5rKTsKICAgIH0KICB9CiAgb25EYXRhUHJvZ3Jlc3MobG9hZGVkLCB0b3RhbCkgewogICAgdGhpcy4jY2FwYWJpbGl0eS5wcm9taXNlLnRoZW4oKCkgPT4gewogICAgICBmb3IgKGNvbnN0IGxpc3RlbmVyIG9mIHRoaXMuI3Byb2dyZXNzTGlzdGVuZXJzKSB7CiAgICAgICAgbGlzdGVuZXIobG9hZGVkLCB0b3RhbCk7CiAgICAgIH0KICAgIH0pOwogIH0KICBvbkRhdGFQcm9ncmVzc2l2ZVJlYWQoY2h1bmspIHsKICAgIHRoaXMuI2NhcGFiaWxpdHkucHJvbWlzZS50aGVuKCgpID0+IHsKICAgICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiB0aGlzLiNwcm9ncmVzc2l2ZVJlYWRMaXN0ZW5lcnMpIHsKICAgICAgICBsaXN0ZW5lcihjaHVuayk7CiAgICAgIH0KICAgIH0pOwogIH0KICBvbkRhdGFQcm9ncmVzc2l2ZURvbmUoKSB7CiAgICB0aGlzLiNjYXBhYmlsaXR5LnByb21pc2UudGhlbigoKSA9PiB7CiAgICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgdGhpcy4jcHJvZ3Jlc3NpdmVEb25lTGlzdGVuZXJzKSB7CiAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgfQogICAgfSk7CiAgfQogIHRyYW5zcG9ydFJlYWR5KCkgewogICAgdGhpcy4jY2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgfQogIHJlcXVlc3REYXRhUmFuZ2UoYmVnaW4sIGVuZCkgewogICAgdW5yZWFjaGFibGUoIkFic3RyYWN0IG1ldGhvZCBQREZEYXRhUmFuZ2VUcmFuc3BvcnQucmVxdWVzdERhdGFSYW5nZSIpOwogIH0KICBhYm9ydCgpIHsKICB9Cn07CnZhciBQREZEb2N1bWVudFByb3h5ID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBkZkluZm8sIHRyYW5zcG9ydCkgewogICAgdGhpcy5fcGRmSW5mbyA9IHBkZkluZm87CiAgICB0aGlzLl90cmFuc3BvcnQgPSB0cmFuc3BvcnQ7CiAgfQogIGdldCBhbm5vdGF0aW9uU3RvcmFnZSgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuYW5ub3RhdGlvblN0b3JhZ2U7CiAgfQogIGdldCBjYW52YXNGYWN0b3J5KCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5jYW52YXNGYWN0b3J5OwogIH0KICBnZXQgZmlsdGVyRmFjdG9yeSgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZmlsdGVyRmFjdG9yeTsKICB9CiAgZ2V0IG51bVBhZ2VzKCkgewogICAgcmV0dXJuIHRoaXMuX3BkZkluZm8ubnVtUGFnZXM7CiAgfQogIGdldCBmaW5nZXJwcmludHMoKSB7CiAgICByZXR1cm4gdGhpcy5fcGRmSW5mby5maW5nZXJwcmludHM7CiAgfQogIGdldCBpc1B1cmVYZmEoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc1B1cmVYZmEiLCAhIXRoaXMuX3RyYW5zcG9ydC5faHRtbEZvclhmYSk7CiAgfQogIGdldCBhbGxYZmFIdG1sKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5faHRtbEZvclhmYTsKICB9CiAgZ2V0UGFnZShwYWdlTnVtYmVyKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldFBhZ2UocGFnZU51bWJlcik7CiAgfQogIGdldFBhZ2VJbmRleChyZWYpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0UGFnZUluZGV4KHJlZik7CiAgfQogIGdldERlc3RpbmF0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0RGVzdGluYXRpb25zKCk7CiAgfQogIGdldERlc3RpbmF0aW9uKGlkKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldERlc3RpbmF0aW9uKGlkKTsKICB9CiAgZ2V0UGFnZUxhYmVscygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0UGFnZUxhYmVscygpOwogIH0KICBnZXRQYWdlTGF5b3V0KCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRQYWdlTGF5b3V0KCk7CiAgfQogIGdldFBhZ2VNb2RlKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRQYWdlTW9kZSgpOwogIH0KICBnZXRWaWV3ZXJQcmVmZXJlbmNlcygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0Vmlld2VyUHJlZmVyZW5jZXMoKTsKICB9CiAgZ2V0T3BlbkFjdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0T3BlbkFjdGlvbigpOwogIH0KICBnZXRBdHRhY2htZW50cygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0QXR0YWNobWVudHMoKTsKICB9CiAgZ2V0QW5ub3RhdGlvbnNCeVR5cGUodHlwZXMsIHBhZ2VJbmRleGVzVG9Ta2lwKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldEFubm90YXRpb25zQnlUeXBlKHR5cGVzLCBwYWdlSW5kZXhlc1RvU2tpcCk7CiAgfQogIGdldEpTQWN0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0RG9jSlNBY3Rpb25zKCk7CiAgfQogIGdldE91dGxpbmUoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldE91dGxpbmUoKTsKICB9CiAgZ2V0T3B0aW9uYWxDb250ZW50Q29uZmlnKHsKICAgIGludGVudCA9ICJkaXNwbGF5IgogIH0gPSB7fSkgewogICAgY29uc3QgewogICAgICByZW5kZXJpbmdJbnRlbnQKICAgIH0gPSB0aGlzLl90cmFuc3BvcnQuZ2V0UmVuZGVyaW5nSW50ZW50KGludGVudCk7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldE9wdGlvbmFsQ29udGVudENvbmZpZyhyZW5kZXJpbmdJbnRlbnQpOwogIH0KICBnZXRQZXJtaXNzaW9ucygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0UGVybWlzc2lvbnMoKTsKICB9CiAgZ2V0TWV0YWRhdGEoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldE1ldGFkYXRhKCk7CiAgfQogIGdldE1hcmtJbmZvKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRNYXJrSW5mbygpOwogIH0KICBnZXREYXRhKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXREYXRhKCk7CiAgfQogIHNhdmVEb2N1bWVudCgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuc2F2ZURvY3VtZW50KCk7CiAgfQogIGV4dHJhY3RQYWdlcyhwYWdlSW5mb3MpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZXh0cmFjdFBhZ2VzKHBhZ2VJbmZvcyk7CiAgfQogIGdldERvd25sb2FkSW5mbygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZG93bmxvYWRJbmZvQ2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICBjbGVhbnVwKGtlZXBMb2FkZWRGb250cyA9IGZhbHNlKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LnN0YXJ0Q2xlYW51cChrZWVwTG9hZGVkRm9udHMgfHwgdGhpcy5pc1B1cmVYZmEpOwogIH0KICBkZXN0cm95KCkgewogICAgcmV0dXJuIHRoaXMubG9hZGluZ1Rhc2suZGVzdHJveSgpOwogIH0KICBjYWNoZWRQYWdlTnVtYmVyKHJlZikgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5jYWNoZWRQYWdlTnVtYmVyKHJlZik7CiAgfQogIGdldCBsb2FkaW5nUGFyYW1zKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5sb2FkaW5nUGFyYW1zOwogIH0KICBnZXQgbG9hZGluZ1Rhc2soKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmxvYWRpbmdUYXNrOwogIH0KICBnZXRGaWVsZE9iamVjdHMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldEZpZWxkT2JqZWN0cygpOwogIH0KICBoYXNKU0FjdGlvbnMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0Lmhhc0pTQWN0aW9ucygpOwogIH0KICBnZXRDYWxjdWxhdGlvbk9yZGVySWRzKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRDYWxjdWxhdGlvbk9yZGVySWRzKCk7CiAgfQp9Owp2YXIgUERGUGFnZVByb3h5ID0gY2xhc3MgewogICNwZW5kaW5nQ2xlYW51cCA9IGZhbHNlOwogIGNvbnN0cnVjdG9yKHBhZ2VJbmRleCwgcGFnZUluZm8sIHRyYW5zcG9ydCwgcGRmQnVnID0gZmFsc2UpIHsKICAgIHRoaXMuX3BhZ2VJbmRleCA9IHBhZ2VJbmRleDsKICAgIHRoaXMuX3BhZ2VJbmZvID0gcGFnZUluZm87CiAgICB0aGlzLl90cmFuc3BvcnQgPSB0cmFuc3BvcnQ7CiAgICB0aGlzLl9zdGF0cyA9IHBkZkJ1ZyA/IG5ldyBTdGF0VGltZXIoKSA6IG51bGw7CiAgICB0aGlzLl9wZGZCdWcgPSBwZGZCdWc7CiAgICB0aGlzLmNvbW1vbk9ianMgPSB0cmFuc3BvcnQuY29tbW9uT2JqczsKICAgIHRoaXMub2JqcyA9IG5ldyBQREZPYmplY3RzKCk7CiAgICB0aGlzLl9pbnRlbnRTdGF0ZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZTsKICAgIHRoaXMucmVjb3JkZWRCQm94ZXMgPSBudWxsOwogIH0KICBnZXQgcGFnZU51bWJlcigpIHsKICAgIHJldHVybiB0aGlzLl9wYWdlSW5kZXggKyAxOwogIH0KICBnZXQgcm90YXRlKCkgewogICAgcmV0dXJuIHRoaXMuX3BhZ2VJbmZvLnJvdGF0ZTsKICB9CiAgZ2V0IHJlZigpIHsKICAgIHJldHVybiB0aGlzLl9wYWdlSW5mby5yZWY7CiAgfQogIGdldCB1c2VyVW5pdCgpIHsKICAgIHJldHVybiB0aGlzLl9wYWdlSW5mby51c2VyVW5pdDsKICB9CiAgZ2V0IHZpZXcoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFnZUluZm8udmlldzsKICB9CiAgZ2V0Vmlld3BvcnQoewogICAgc2NhbGUsCiAgICByb3RhdGlvbiA9IHRoaXMucm90YXRlLAogICAgb2Zmc2V0WCA9IDAsCiAgICBvZmZzZXRZID0gMCwKICAgIGRvbnRGbGlwID0gZmFsc2UKICB9ID0ge30pIHsKICAgIHJldHVybiBuZXcgUGFnZVZpZXdwb3J0KHsKICAgICAgdmlld0JveDogdGhpcy52aWV3LAogICAgICB1c2VyVW5pdDogdGhpcy51c2VyVW5pdCwKICAgICAgc2NhbGUsCiAgICAgIHJvdGF0aW9uLAogICAgICBvZmZzZXRYLAogICAgICBvZmZzZXRZLAogICAgICBkb250RmxpcAogICAgfSk7CiAgfQogIGdldEFubm90YXRpb25zKHsKICAgIGludGVudCA9ICJkaXNwbGF5IgogIH0gPSB7fSkgewogICAgY29uc3QgewogICAgICByZW5kZXJpbmdJbnRlbnQKICAgIH0gPSB0aGlzLl90cmFuc3BvcnQuZ2V0UmVuZGVyaW5nSW50ZW50KGludGVudCk7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldEFubm90YXRpb25zKHRoaXMuX3BhZ2VJbmRleCwgcmVuZGVyaW5nSW50ZW50KTsKICB9CiAgZ2V0SlNBY3Rpb25zKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRQYWdlSlNBY3Rpb25zKHRoaXMuX3BhZ2VJbmRleCk7CiAgfQogIGdldCBmaWx0ZXJGYWN0b3J5KCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5maWx0ZXJGYWN0b3J5OwogIH0KICBnZXQgaXNQdXJlWGZhKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaXNQdXJlWGZhIiwgISF0aGlzLl90cmFuc3BvcnQuX2h0bWxGb3JYZmEpOwogIH0KICBhc3luYyBnZXRYZmEoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0Ll9odG1sRm9yWGZhPy5jaGlsZHJlblt0aGlzLl9wYWdlSW5kZXhdIHx8IG51bGw7CiAgfQogIHJlbmRlcih7CiAgICBjYW52YXNDb250ZXh0LAogICAgY2FudmFzID0gY2FudmFzQ29udGV4dC5jYW52YXMsCiAgICB2aWV3cG9ydCwKICAgIGludGVudCA9ICJkaXNwbGF5IiwKICAgIGFubm90YXRpb25Nb2RlID0gQW5ub3RhdGlvbk1vZGUuRU5BQkxFLAogICAgdHJhbnNmb3JtID0gbnVsbCwKICAgIGJhY2tncm91bmQgPSBudWxsLAogICAgb3B0aW9uYWxDb250ZW50Q29uZmlnUHJvbWlzZSA9IG51bGwsCiAgICBhbm5vdGF0aW9uQ2FudmFzTWFwID0gbnVsbCwKICAgIHBhZ2VDb2xvcnMgPSBudWxsLAogICAgcHJpbnRBbm5vdGF0aW9uU3RvcmFnZSA9IG51bGwsCiAgICBpc0VkaXRpbmcgPSBmYWxzZSwKICAgIHJlY29yZE9wZXJhdGlvbnMgPSBmYWxzZSwKICAgIG9wZXJhdGlvbnNGaWx0ZXIgPSBudWxsCiAgfSkgewogICAgdGhpcy5fc3RhdHM/LnRpbWUoIk92ZXJhbGwiKTsKICAgIGNvbnN0IGludGVudEFyZ3MgPSB0aGlzLl90cmFuc3BvcnQuZ2V0UmVuZGVyaW5nSW50ZW50KGludGVudCwgYW5ub3RhdGlvbk1vZGUsIHByaW50QW5ub3RhdGlvblN0b3JhZ2UsIGlzRWRpdGluZyk7CiAgICBjb25zdCB7CiAgICAgIHJlbmRlcmluZ0ludGVudCwKICAgICAgY2FjaGVLZXkKICAgIH0gPSBpbnRlbnRBcmdzOwogICAgdGhpcy4jcGVuZGluZ0NsZWFudXAgPSBmYWxzZTsKICAgIG9wdGlvbmFsQ29udGVudENvbmZpZ1Byb21pc2UgfHw9IHRoaXMuX3RyYW5zcG9ydC5nZXRPcHRpb25hbENvbnRlbnRDb25maWcocmVuZGVyaW5nSW50ZW50KTsKICAgIGxldCBpbnRlbnRTdGF0ZSA9IHRoaXMuX2ludGVudFN0YXRlcy5nZXQoY2FjaGVLZXkpOwogICAgaWYgKCFpbnRlbnRTdGF0ZSkgewogICAgICBpbnRlbnRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICB0aGlzLl9pbnRlbnRTdGF0ZXMuc2V0KGNhY2hlS2V5LCBpbnRlbnRTdGF0ZSk7CiAgICB9CiAgICBpZiAoaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyQ2FuY2VsVGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQoaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyQ2FuY2VsVGltZW91dCk7CiAgICAgIGludGVudFN0YXRlLnN0cmVhbVJlYWRlckNhbmNlbFRpbWVvdXQgPSBudWxsOwogICAgfQogICAgY29uc3QgaW50ZW50UHJpbnQgPSAhIShyZW5kZXJpbmdJbnRlbnQgJiBSZW5kZXJpbmdJbnRlbnRGbGFnLlBSSU5UKTsKICAgIGlmICghaW50ZW50U3RhdGUuZGlzcGxheVJlYWR5Q2FwYWJpbGl0eSkgewogICAgICBpbnRlbnRTdGF0ZS5kaXNwbGF5UmVhZHlDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICAgIGludGVudFN0YXRlLm9wZXJhdG9yTGlzdCA9IHsKICAgICAgICBmbkFycmF5OiBbXSwKICAgICAgICBhcmdzQXJyYXk6IFtdLAogICAgICAgIGxhc3RDaHVuazogZmFsc2UsCiAgICAgICAgc2VwYXJhdGVBbm5vdHM6IG51bGwKICAgICAgfTsKICAgICAgdGhpcy5fc3RhdHM/LnRpbWUoIlBhZ2UgUmVxdWVzdCIpOwogICAgICB0aGlzLl9wdW1wT3BlcmF0b3JMaXN0KGludGVudEFyZ3MpOwogICAgfQogICAgY29uc3QgcmVjb3JkRm9yRGVidWdnZXIgPSBCb29sZWFuKHRoaXMuX3BkZkJ1ZyAmJiBnbG9iYWxUaGlzLlN0ZXBwZXJNYW5hZ2VyPy5lbmFibGVkKTsKICAgIGNvbnN0IHNob3VsZFJlY29yZE9wZXJhdGlvbnMgPSAhdGhpcy5yZWNvcmRlZEJCb3hlcyAmJiAocmVjb3JkT3BlcmF0aW9ucyB8fCByZWNvcmRGb3JEZWJ1Z2dlcik7CiAgICBjb25zdCBjb21wbGV0ZSA9IChlcnJvcikgPT4gewogICAgICBpbnRlbnRTdGF0ZS5yZW5kZXJUYXNrcy5kZWxldGUoaW50ZXJuYWxSZW5kZXJUYXNrKTsKICAgICAgaWYgKHNob3VsZFJlY29yZE9wZXJhdGlvbnMpIHsKICAgICAgICBjb25zdCByZWNvcmRlZEJCb3hlcyA9IGludGVybmFsUmVuZGVyVGFzay5nZng/LmRlcGVuZGVuY3lUcmFja2VyLnRha2UoKTsKICAgICAgICBpZiAocmVjb3JkZWRCQm94ZXMpIHsKICAgICAgICAgIGlmIChpbnRlcm5hbFJlbmRlclRhc2suc3RlcHBlcikgewogICAgICAgICAgICBpbnRlcm5hbFJlbmRlclRhc2suc3RlcHBlci5zZXRPcGVyYXRvckJCb3hlcyhyZWNvcmRlZEJCb3hlcywgaW50ZXJuYWxSZW5kZXJUYXNrLmdmeC5kZXBlbmRlbmN5VHJhY2tlci50YWtlRGVidWdNZXRhZGF0YSgpKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWNvcmRPcGVyYXRpb25zKSB7CiAgICAgICAgICAgIHRoaXMucmVjb3JkZWRCQm94ZXMgPSByZWNvcmRlZEJCb3hlczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGludGVudFByaW50KSB7CiAgICAgICAgdGhpcy4jcGVuZGluZ0NsZWFudXAgPSB0cnVlOwogICAgICB9CiAgICAgIHRoaXMuI3RyeUNsZWFudXAoKTsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgaW50ZXJuYWxSZW5kZXJUYXNrLmNhcGFiaWxpdHkucmVqZWN0KGVycm9yKTsKICAgICAgICB0aGlzLl9hYm9ydE9wZXJhdG9yTGlzdCh7CiAgICAgICAgICBpbnRlbnRTdGF0ZSwKICAgICAgICAgIHJlYXNvbjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IEVycm9yKGVycm9yKQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGludGVybmFsUmVuZGVyVGFzay5jYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgICAgfQogICAgICBpZiAodGhpcy5fc3RhdHMpIHsKICAgICAgICB0aGlzLl9zdGF0cy50aW1lRW5kKCJSZW5kZXJpbmciKTsKICAgICAgICB0aGlzLl9zdGF0cy50aW1lRW5kKCJPdmVyYWxsIik7CiAgICAgICAgaWYgKGdsb2JhbFRoaXMuU3RhdHM/LmVuYWJsZWQpIHsKICAgICAgICAgIGdsb2JhbFRoaXMuU3RhdHMuYWRkKHRoaXMucGFnZU51bWJlciwgdGhpcy5fc3RhdHMpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIGNvbnN0IGludGVybmFsUmVuZGVyVGFzayA9IG5ldyBJbnRlcm5hbFJlbmRlclRhc2soewogICAgICBjYWxsYmFjazogY29tcGxldGUsCiAgICAgIHBhcmFtczogewogICAgICAgIGNhbnZhcywKICAgICAgICBjYW52YXNDb250ZXh0LAogICAgICAgIGRlcGVuZGVuY3lUcmFja2VyOiBzaG91bGRSZWNvcmRPcGVyYXRpb25zID8gbmV3IENhbnZhc0RlcGVuZGVuY3lUcmFja2VyKGNhbnZhcywgaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0Lmxlbmd0aCwgcmVjb3JkRm9yRGVidWdnZXIpIDogbnVsbCwKICAgICAgICB2aWV3cG9ydCwKICAgICAgICB0cmFuc2Zvcm0sCiAgICAgICAgYmFja2dyb3VuZAogICAgICB9LAogICAgICBvYmpzOiB0aGlzLm9ianMsCiAgICAgIGNvbW1vbk9ianM6IHRoaXMuY29tbW9uT2JqcywKICAgICAgYW5ub3RhdGlvbkNhbnZhc01hcCwKICAgICAgb3BlcmF0b3JMaXN0OiBpbnRlbnRTdGF0ZS5vcGVyYXRvckxpc3QsCiAgICAgIHBhZ2VJbmRleDogdGhpcy5fcGFnZUluZGV4LAogICAgICBjYW52YXNGYWN0b3J5OiB0aGlzLl90cmFuc3BvcnQuY2FudmFzRmFjdG9yeSwKICAgICAgZmlsdGVyRmFjdG9yeTogdGhpcy5fdHJhbnNwb3J0LmZpbHRlckZhY3RvcnksCiAgICAgIHVzZVJlcXVlc3RBbmltYXRpb25GcmFtZTogIWludGVudFByaW50LAogICAgICBwZGZCdWc6IHRoaXMuX3BkZkJ1ZywKICAgICAgcGFnZUNvbG9ycywKICAgICAgZW5hYmxlSFdBOiB0aGlzLl90cmFuc3BvcnQuZW5hYmxlSFdBLAogICAgICBvcGVyYXRpb25zRmlsdGVyCiAgICB9KTsKICAgIChpbnRlbnRTdGF0ZS5yZW5kZXJUYXNrcyB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSkuYWRkKGludGVybmFsUmVuZGVyVGFzayk7CiAgICBjb25zdCByZW5kZXJUYXNrID0gaW50ZXJuYWxSZW5kZXJUYXNrLnRhc2s7CiAgICBQcm9taXNlLmFsbChbaW50ZW50U3RhdGUuZGlzcGxheVJlYWR5Q2FwYWJpbGl0eS5wcm9taXNlLCBvcHRpb25hbENvbnRlbnRDb25maWdQcm9taXNlXSkudGhlbigoW3RyYW5zcGFyZW5jeSwgb3B0aW9uYWxDb250ZW50Q29uZmlnXSkgPT4gewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICBjb21wbGV0ZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9zdGF0cz8udGltZSgiUmVuZGVyaW5nIik7CiAgICAgIGlmICghKG9wdGlvbmFsQ29udGVudENvbmZpZy5yZW5kZXJpbmdJbnRlbnQgJiByZW5kZXJpbmdJbnRlbnQpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdXN0IHVzZSB0aGUgc2FtZSBgaW50ZW50YC1hcmd1bWVudCB3aGVuIGNhbGxpbmcgdGhlIGBQREZQYWdlUHJveHkucmVuZGVyYCBhbmQgYFBERkRvY3VtZW50UHJveHkuZ2V0T3B0aW9uYWxDb250ZW50Q29uZmlnYCBtZXRob2RzLiIpOwogICAgICB9CiAgICAgIGludGVybmFsUmVuZGVyVGFzay5pbml0aWFsaXplR3JhcGhpY3MoewogICAgICAgIHRyYW5zcGFyZW5jeSwKICAgICAgICBvcHRpb25hbENvbnRlbnRDb25maWcKICAgICAgfSk7CiAgICAgIGludGVybmFsUmVuZGVyVGFzay5vcGVyYXRvckxpc3RDaGFuZ2VkKCk7CiAgICB9KS5jYXRjaChjb21wbGV0ZSk7CiAgICByZXR1cm4gcmVuZGVyVGFzazsKICB9CiAgZ2V0T3BlcmF0b3JMaXN0KHsKICAgIGludGVudCA9ICJkaXNwbGF5IiwKICAgIGFubm90YXRpb25Nb2RlID0gQW5ub3RhdGlvbk1vZGUuRU5BQkxFLAogICAgcHJpbnRBbm5vdGF0aW9uU3RvcmFnZSA9IG51bGwsCiAgICBpc0VkaXRpbmcgPSBmYWxzZQogIH0gPSB7fSkgewogICAgZnVuY3Rpb24gb3BlcmF0b3JMaXN0Q2hhbmdlZCgpIHsKICAgICAgaWYgKGludGVudFN0YXRlLm9wZXJhdG9yTGlzdC5sYXN0Q2h1bmspIHsKICAgICAgICBpbnRlbnRTdGF0ZS5vcExpc3RSZWFkQ2FwYWJpbGl0eS5yZXNvbHZlKGludGVudFN0YXRlLm9wZXJhdG9yTGlzdCk7CiAgICAgICAgaW50ZW50U3RhdGUucmVuZGVyVGFza3MuZGVsZXRlKG9wTGlzdFRhc2spOwogICAgICB9CiAgICB9CiAgICBjb25zdCBpbnRlbnRBcmdzID0gdGhpcy5fdHJhbnNwb3J0LmdldFJlbmRlcmluZ0ludGVudChpbnRlbnQsIGFubm90YXRpb25Nb2RlLCBwcmludEFubm90YXRpb25TdG9yYWdlLCBpc0VkaXRpbmcsIHRydWUpOwogICAgbGV0IGludGVudFN0YXRlID0gdGhpcy5faW50ZW50U3RhdGVzLmdldChpbnRlbnRBcmdzLmNhY2hlS2V5KTsKICAgIGlmICghaW50ZW50U3RhdGUpIHsKICAgICAgaW50ZW50U3RhdGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdGhpcy5faW50ZW50U3RhdGVzLnNldChpbnRlbnRBcmdzLmNhY2hlS2V5LCBpbnRlbnRTdGF0ZSk7CiAgICB9CiAgICBsZXQgb3BMaXN0VGFzazsKICAgIGlmICghaW50ZW50U3RhdGUub3BMaXN0UmVhZENhcGFiaWxpdHkpIHsKICAgICAgb3BMaXN0VGFzayA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBvcExpc3RUYXNrLm9wZXJhdG9yTGlzdENoYW5nZWQgPSBvcGVyYXRvckxpc3RDaGFuZ2VkOwogICAgICBpbnRlbnRTdGF0ZS5vcExpc3RSZWFkQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgICAoaW50ZW50U3RhdGUucmVuZGVyVGFza3MgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkpLmFkZChvcExpc3RUYXNrKTsKICAgICAgaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0ID0gewogICAgICAgIGZuQXJyYXk6IFtdLAogICAgICAgIGFyZ3NBcnJheTogW10sCiAgICAgICAgbGFzdENodW5rOiBmYWxzZSwKICAgICAgICBzZXBhcmF0ZUFubm90czogbnVsbAogICAgICB9OwogICAgICB0aGlzLl9zdGF0cz8udGltZSgiUGFnZSBSZXF1ZXN0Iik7CiAgICAgIHRoaXMuX3B1bXBPcGVyYXRvckxpc3QoaW50ZW50QXJncyk7CiAgICB9CiAgICByZXR1cm4gaW50ZW50U3RhdGUub3BMaXN0UmVhZENhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgc3RyZWFtVGV4dENvbnRlbnQoewogICAgaW5jbHVkZU1hcmtlZENvbnRlbnQgPSBmYWxzZSwKICAgIGRpc2FibGVOb3JtYWxpemF0aW9uID0gZmFsc2UKICB9ID0ge30pIHsKICAgIGNvbnN0IFRFWFRfQ09OVEVOVF9DSFVOS19TSVpFID0gMTAwOwogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFN0cmVhbSgiR2V0VGV4dENvbnRlbnQiLCB7CiAgICAgIHBhZ2VJbmRleDogdGhpcy5fcGFnZUluZGV4LAogICAgICBpbmNsdWRlTWFya2VkQ29udGVudDogaW5jbHVkZU1hcmtlZENvbnRlbnQgPT09IHRydWUsCiAgICAgIGRpc2FibGVOb3JtYWxpemF0aW9uOiBkaXNhYmxlTm9ybWFsaXphdGlvbiA9PT0gdHJ1ZQogICAgfSwgewogICAgICBoaWdoV2F0ZXJNYXJrOiBURVhUX0NPTlRFTlRfQ0hVTktfU0laRSwKICAgICAgc2l6ZSh0ZXh0Q29udGVudCkgewogICAgICAgIHJldHVybiB0ZXh0Q29udGVudC5pdGVtcy5sZW5ndGg7CiAgICAgIH0KICAgIH0pOwogIH0KICBnZXRUZXh0Q29udGVudChwYXJhbXMgPSB7fSkgewogICAgaWYgKHRoaXMuX3RyYW5zcG9ydC5faHRtbEZvclhmYSkgewogICAgICByZXR1cm4gdGhpcy5nZXRYZmEoKS50aGVuKCh4ZmEpID0+IFhmYVRleHQudGV4dENvbnRlbnQoeGZhKSk7CiAgICB9CiAgICBjb25zdCByZWFkYWJsZVN0cmVhbSA9IHRoaXMuc3RyZWFtVGV4dENvbnRlbnQocGFyYW1zKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZnVuY3Rpb24gcHVtcCgpIHsKICAgICAgICByZWFkZXIucmVhZCgpLnRoZW4oZnVuY3Rpb24oewogICAgICAgICAgdmFsdWUsCiAgICAgICAgICBkb25lCiAgICAgICAgfSkgewogICAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgICAgcmVzb2x2ZSh0ZXh0Q29udGVudCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRleHRDb250ZW50LmxhbmcgPz89IHZhbHVlLmxhbmc7CiAgICAgICAgICBPYmplY3QuYXNzaWduKHRleHRDb250ZW50LnN0eWxlcywgdmFsdWUuc3R5bGVzKTsKICAgICAgICAgIHRleHRDb250ZW50Lml0ZW1zLnB1c2goLi4udmFsdWUuaXRlbXMpOwogICAgICAgICAgcHVtcCgpOwogICAgICAgIH0sIHJlamVjdCk7CiAgICAgIH0KICAgICAgY29uc3QgcmVhZGVyID0gcmVhZGFibGVTdHJlYW0uZ2V0UmVhZGVyKCk7CiAgICAgIGNvbnN0IHRleHRDb250ZW50ID0gewogICAgICAgIGl0ZW1zOiBbXSwKICAgICAgICBzdHlsZXM6IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpLAogICAgICAgIGxhbmc6IG51bGwKICAgICAgfTsKICAgICAgcHVtcCgpOwogICAgfSk7CiAgfQogIGdldFN0cnVjdFRyZWUoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldFN0cnVjdFRyZWUodGhpcy5fcGFnZUluZGV4KTsKICB9CiAgX2Rlc3Ryb3koKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7CiAgICBjb25zdCB3YWl0T24gPSBbXTsKICAgIGZvciAoY29uc3QgaW50ZW50U3RhdGUgb2YgdGhpcy5faW50ZW50U3RhdGVzLnZhbHVlcygpKSB7CiAgICAgIHRoaXMuX2Fib3J0T3BlcmF0b3JMaXN0KHsKICAgICAgICBpbnRlbnRTdGF0ZSwKICAgICAgICByZWFzb246IG5ldyBFcnJvcigiUGFnZSB3YXMgZGVzdHJveWVkLiIpLAogICAgICAgIGZvcmNlOiB0cnVlCiAgICAgIH0pOwogICAgICBpZiAoaW50ZW50U3RhdGUub3BMaXN0UmVhZENhcGFiaWxpdHkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IGludGVybmFsUmVuZGVyVGFzayBvZiBpbnRlbnRTdGF0ZS5yZW5kZXJUYXNrcykgewogICAgICAgIHdhaXRPbi5wdXNoKGludGVybmFsUmVuZGVyVGFzay5jb21wbGV0ZWQpOwogICAgICAgIGludGVybmFsUmVuZGVyVGFzay5jYW5jZWwoKTsKICAgICAgfQogICAgfQogICAgdGhpcy5vYmpzLmNsZWFyKCk7CiAgICB0aGlzLiNwZW5kaW5nQ2xlYW51cCA9IGZhbHNlOwogICAgcmV0dXJuIFByb21pc2UuYWxsKHdhaXRPbik7CiAgfQogIGNsZWFudXAocmVzZXRTdGF0cyA9IGZhbHNlKSB7CiAgICB0aGlzLiNwZW5kaW5nQ2xlYW51cCA9IHRydWU7CiAgICBjb25zdCBzdWNjZXNzID0gdGhpcy4jdHJ5Q2xlYW51cCgpOwogICAgaWYgKHJlc2V0U3RhdHMgJiYgc3VjY2VzcykgewogICAgICB0aGlzLl9zdGF0cyAmJj0gbmV3IFN0YXRUaW1lcigpOwogICAgfQogICAgcmV0dXJuIHN1Y2Nlc3M7CiAgfQogICN0cnlDbGVhbnVwKCkgewogICAgaWYgKCF0aGlzLiNwZW5kaW5nQ2xlYW51cCB8fCB0aGlzLmRlc3Ryb3llZCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsKICAgICAgcmVuZGVyVGFza3MsCiAgICAgIG9wZXJhdG9yTGlzdAogICAgfSBvZiB0aGlzLl9pbnRlbnRTdGF0ZXMudmFsdWVzKCkpIHsKICAgICAgaWYgKHJlbmRlclRhc2tzLnNpemUgPiAwIHx8ICFvcGVyYXRvckxpc3QubGFzdENodW5rKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICB0aGlzLl9pbnRlbnRTdGF0ZXMuY2xlYXIoKTsKICAgIHRoaXMub2Jqcy5jbGVhcigpOwogICAgdGhpcy4jcGVuZGluZ0NsZWFudXAgPSBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH0KICBfc3RhcnRSZW5kZXJQYWdlKHRyYW5zcGFyZW5jeSwgY2FjaGVLZXkpIHsKICAgIGNvbnN0IGludGVudFN0YXRlID0gdGhpcy5faW50ZW50U3RhdGVzLmdldChjYWNoZUtleSk7CiAgICBpZiAoIWludGVudFN0YXRlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX3N0YXRzPy50aW1lRW5kKCJQYWdlIFJlcXVlc3QiKTsKICAgIGludGVudFN0YXRlLmRpc3BsYXlSZWFkeUNhcGFiaWxpdHk/LnJlc29sdmUodHJhbnNwYXJlbmN5KTsKICB9CiAgX3JlbmRlclBhZ2VDaHVuayhvcGVyYXRvckxpc3RDaHVuaywgaW50ZW50U3RhdGUpIHsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IG9wZXJhdG9yTGlzdENodW5rLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0LmZuQXJyYXkucHVzaChvcGVyYXRvckxpc3RDaHVuay5mbkFycmF5W2ldKTsKICAgICAgaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0LmFyZ3NBcnJheS5wdXNoKG9wZXJhdG9yTGlzdENodW5rLmFyZ3NBcnJheVtpXSk7CiAgICB9CiAgICBpbnRlbnRTdGF0ZS5vcGVyYXRvckxpc3QubGFzdENodW5rID0gb3BlcmF0b3JMaXN0Q2h1bmsubGFzdENodW5rOwogICAgaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0LnNlcGFyYXRlQW5ub3RzID0gb3BlcmF0b3JMaXN0Q2h1bmsuc2VwYXJhdGVBbm5vdHM7CiAgICBmb3IgKGNvbnN0IGludGVybmFsUmVuZGVyVGFzayBvZiBpbnRlbnRTdGF0ZS5yZW5kZXJUYXNrcykgewogICAgICBpbnRlcm5hbFJlbmRlclRhc2sub3BlcmF0b3JMaXN0Q2hhbmdlZCgpOwogICAgfQogICAgaWYgKG9wZXJhdG9yTGlzdENodW5rLmxhc3RDaHVuaykgewogICAgICB0aGlzLiN0cnlDbGVhbnVwKCk7CiAgICB9CiAgfQogIF9wdW1wT3BlcmF0b3JMaXN0KHsKICAgIHJlbmRlcmluZ0ludGVudCwKICAgIGNhY2hlS2V5LAogICAgYW5ub3RhdGlvblN0b3JhZ2VTZXJpYWxpemFibGUsCiAgICBtb2RpZmllZElkcwogIH0pIHsKICAgIGNvbnN0IHsKICAgICAgbWFwLAogICAgICB0cmFuc2ZlcgogICAgfSA9IGFubm90YXRpb25TdG9yYWdlU2VyaWFsaXphYmxlOwogICAgY29uc3QgcmVhZGFibGVTdHJlYW0gPSB0aGlzLl90cmFuc3BvcnQubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhTdHJlYW0oIkdldE9wZXJhdG9yTGlzdCIsIHsKICAgICAgcGFnZUluZGV4OiB0aGlzLl9wYWdlSW5kZXgsCiAgICAgIGludGVudDogcmVuZGVyaW5nSW50ZW50LAogICAgICBjYWNoZUtleSwKICAgICAgYW5ub3RhdGlvblN0b3JhZ2U6IG1hcCwKICAgICAgbW9kaWZpZWRJZHMKICAgIH0sIHRyYW5zZmVyKTsKICAgIGNvbnN0IHJlYWRlciA9IHJlYWRhYmxlU3RyZWFtLmdldFJlYWRlcigpOwogICAgY29uc3QgaW50ZW50U3RhdGUgPSB0aGlzLl9pbnRlbnRTdGF0ZXMuZ2V0KGNhY2hlS2V5KTsKICAgIGludGVudFN0YXRlLnN0cmVhbVJlYWRlciA9IHJlYWRlcjsKICAgIGNvbnN0IHB1bXAgPSAoKSA9PiB7CiAgICAgIHJlYWRlci5yZWFkKCkudGhlbigoewogICAgICAgIHZhbHVlLAogICAgICAgIGRvbmUKICAgICAgfSkgPT4gewogICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXIgPSBudWxsOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fdHJhbnNwb3J0LmRlc3Ryb3llZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW5kZXJQYWdlQ2h1bmsodmFsdWUsIGludGVudFN0YXRlKTsKICAgICAgICBwdW1wKCk7CiAgICAgIH0sIChyZWFzb24pID0+IHsKICAgICAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXIgPSBudWxsOwogICAgICAgIGlmICh0aGlzLl90cmFuc3BvcnQuZGVzdHJveWVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChpbnRlbnRTdGF0ZS5vcGVyYXRvckxpc3QpIHsKICAgICAgICAgIGludGVudFN0YXRlLm9wZXJhdG9yTGlzdC5sYXN0Q2h1bmsgPSB0cnVlOwogICAgICAgICAgZm9yIChjb25zdCBpbnRlcm5hbFJlbmRlclRhc2sgb2YgaW50ZW50U3RhdGUucmVuZGVyVGFza3MpIHsKICAgICAgICAgICAgaW50ZXJuYWxSZW5kZXJUYXNrLm9wZXJhdG9yTGlzdENoYW5nZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuI3RyeUNsZWFudXAoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGludGVudFN0YXRlLmRpc3BsYXlSZWFkeUNhcGFiaWxpdHkpIHsKICAgICAgICAgIGludGVudFN0YXRlLmRpc3BsYXlSZWFkeUNhcGFiaWxpdHkucmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSBlbHNlIGlmIChpbnRlbnRTdGF0ZS5vcExpc3RSZWFkQ2FwYWJpbGl0eSkgewogICAgICAgICAgaW50ZW50U3RhdGUub3BMaXN0UmVhZENhcGFiaWxpdHkucmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IHJlYXNvbjsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKICAgIHB1bXAoKTsKICB9CiAgX2Fib3J0T3BlcmF0b3JMaXN0KHsKICAgIGludGVudFN0YXRlLAogICAgcmVhc29uLAogICAgZm9yY2UgPSBmYWxzZQogIH0pIHsKICAgIGlmICghaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXJDYW5jZWxUaW1lb3V0KSB7CiAgICAgIGNsZWFyVGltZW91dChpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXJDYW5jZWxUaW1lb3V0KTsKICAgICAgaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyQ2FuY2VsVGltZW91dCA9IG51bGw7CiAgICB9CiAgICBpZiAoIWZvcmNlKSB7CiAgICAgIGlmIChpbnRlbnRTdGF0ZS5yZW5kZXJUYXNrcy5zaXplID4gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAocmVhc29uIGluc3RhbmNlb2YgUmVuZGVyaW5nQ2FuY2VsbGVkRXhjZXB0aW9uKSB7CiAgICAgICAgbGV0IGRlbGF5ID0gUkVOREVSSU5HX0NBTkNFTExFRF9USU1FT1VUOwogICAgICAgIGlmIChyZWFzb24uZXh0cmFEZWxheSA+IDAgJiYgcmVhc29uLmV4dHJhRGVsYXkgPCAxZTMpIHsKICAgICAgICAgIGRlbGF5ICs9IHJlYXNvbi5leHRyYURlbGF5OwogICAgICAgIH0KICAgICAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXJDYW5jZWxUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXJDYW5jZWxUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuX2Fib3J0T3BlcmF0b3JMaXN0KHsKICAgICAgICAgICAgaW50ZW50U3RhdGUsCiAgICAgICAgICAgIHJlYXNvbiwKICAgICAgICAgICAgZm9yY2U6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0sIGRlbGF5KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGludGVudFN0YXRlLnN0cmVhbVJlYWRlci5jYW5jZWwobmV3IEFib3J0RXhjZXB0aW9uKHJlYXNvbi5tZXNzYWdlKSkuY2F0Y2goKCkgPT4gewogICAgfSk7CiAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXIgPSBudWxsOwogICAgaWYgKHRoaXMuX3RyYW5zcG9ydC5kZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChjb25zdCBbY3VyQ2FjaGVLZXksIGN1ckludGVudFN0YXRlXSBvZiB0aGlzLl9pbnRlbnRTdGF0ZXMpIHsKICAgICAgaWYgKGN1ckludGVudFN0YXRlID09PSBpbnRlbnRTdGF0ZSkgewogICAgICAgIHRoaXMuX2ludGVudFN0YXRlcy5kZWxldGUoY3VyQ2FjaGVLZXkpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLmNsZWFudXAoKTsKICB9CiAgZ2V0IHN0YXRzKCkgewogICAgcmV0dXJuIHRoaXMuX3N0YXRzOwogIH0KfTsKdmFyIFBERldvcmtlciA9IGNsYXNzIF9QREZXb3JrZXIgewogICNjYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgI21lc3NhZ2VIYW5kbGVyID0gbnVsbDsKICAjcG9ydCA9IG51bGw7CiAgI3dlYldvcmtlciA9IG51bGw7CiAgc3RhdGljICNmYWtlV29ya2VySWQgPSAwOwogIHN0YXRpYyAjaXNXb3JrZXJEaXNhYmxlZCA9IGZhbHNlOwogIHN0YXRpYyAjd29ya2VyUG9ydHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBzdGF0aWMgewogICAgaWYgKGlzTm9kZUpTKSB7CiAgICAgIHRoaXMuI2lzV29ya2VyRGlzYWJsZWQgPSB0cnVlOwogICAgICBHbG9iYWxXb3JrZXJPcHRpb25zLndvcmtlclNyYyB8fD0gIi4vcGRmLndvcmtlci5tanMiOwogICAgfQogICAgdGhpcy5faXNTYW1lT3JpZ2luID0gKGJhc2VVcmwsIG90aGVyVXJsKSA9PiB7CiAgICAgIGNvbnN0IGJhc2UgPSBVUkwucGFyc2UoYmFzZVVybCk7CiAgICAgIGlmICghYmFzZT8ub3JpZ2luIHx8IGJhc2Uub3JpZ2luID09PSAibnVsbCIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgY29uc3Qgb3RoZXIgPSBuZXcgVVJMKG90aGVyVXJsLCBiYXNlKTsKICAgICAgcmV0dXJuIGJhc2Uub3JpZ2luID09PSBvdGhlci5vcmlnaW47CiAgICB9OwogICAgdGhpcy5fY3JlYXRlQ0ROV3JhcHBlciA9ICh1cmwpID0+IHsKICAgICAgY29uc3Qgd3JhcHBlciA9IGBhd2FpdCBpbXBvcnQoIiR7dXJsfSIpO2A7CiAgICAgIHJldHVybiBVUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFt3cmFwcGVyXSwgewogICAgICAgIHR5cGU6ICJ0ZXh0L2phdmFzY3JpcHQiCiAgICAgIH0pKTsKICAgIH07CiAgICB0aGlzLmZyb21Qb3J0ID0gKHBhcmFtcykgPT4gewogICAgICBkZXByZWNhdGVkKCJgUERGV29ya2VyLmZyb21Qb3J0YCAtIHBsZWFzZSB1c2UgYFBERldvcmtlci5jcmVhdGVgIGluc3RlYWQuIik7CiAgICAgIGlmICghcGFyYW1zPy5wb3J0KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQREZXb3JrZXIuZnJvbVBvcnQgLSBpbnZhbGlkIG1ldGhvZCBzaWduYXR1cmUuIik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHBhcmFtcyk7CiAgICB9OwogIH0KICBjb25zdHJ1Y3Rvcih7CiAgICBuYW1lID0gbnVsbCwKICAgIHBvcnQgPSBudWxsLAogICAgdmVyYm9zaXR5OiB2ZXJib3NpdHkyID0gZ2V0VmVyYm9zaXR5TGV2ZWwoKQogIH0gPSB7fSkgewogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2U7CiAgICB0aGlzLnZlcmJvc2l0eSA9IHZlcmJvc2l0eTI7CiAgICBpZiAocG9ydCkgewogICAgICBpZiAoX1BERldvcmtlci4jd29ya2VyUG9ydHMuaGFzKHBvcnQpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgdXNlIG1vcmUgdGhhbiBvbmUgUERGV29ya2VyIHBlciBwb3J0LiIpOwogICAgICB9CiAgICAgIF9QREZXb3JrZXIuI3dvcmtlclBvcnRzLnNldChwb3J0LCB0aGlzKTsKICAgICAgdGhpcy4jaW5pdGlhbGl6ZUZyb21Qb3J0KHBvcnQpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jaW5pdGlhbGl6ZSgpOwogICAgfQogIH0KICBnZXQgcHJvbWlzZSgpIHsKICAgIHJldHVybiB0aGlzLiNjYXBhYmlsaXR5LnByb21pc2U7CiAgfQogICNyZXNvbHZlKCkgewogICAgdGhpcy4jY2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICB0aGlzLiNtZXNzYWdlSGFuZGxlci5zZW5kKCJjb25maWd1cmUiLCB7CiAgICAgIHZlcmJvc2l0eTogdGhpcy52ZXJib3NpdHkKICAgIH0pOwogIH0KICBnZXQgcG9ydCgpIHsKICAgIHJldHVybiB0aGlzLiNwb3J0OwogIH0KICBnZXQgbWVzc2FnZUhhbmRsZXIoKSB7CiAgICByZXR1cm4gdGhpcy4jbWVzc2FnZUhhbmRsZXI7CiAgfQogICNpbml0aWFsaXplRnJvbVBvcnQocG9ydCkgewogICAgdGhpcy4jcG9ydCA9IHBvcnQ7CiAgICB0aGlzLiNtZXNzYWdlSGFuZGxlciA9IG5ldyBNZXNzYWdlSGFuZGxlcigibWFpbiIsICJ3b3JrZXIiLCBwb3J0KTsKICAgIHRoaXMuI21lc3NhZ2VIYW5kbGVyLm9uKCJyZWFkeSIsICgpID0+IHsKICAgIH0pOwogICAgdGhpcy4jcmVzb2x2ZSgpOwogIH0KICAjaW5pdGlhbGl6ZSgpIHsKICAgIGlmIChfUERGV29ya2VyLiNpc1dvcmtlckRpc2FibGVkIHx8IF9QREZXb3JrZXIuI21haW5UaHJlYWRXb3JrZXJNZXNzYWdlSGFuZGxlcikgewogICAgICB0aGlzLiNzZXR1cEZha2VXb3JrZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IHsKICAgICAgd29ya2VyU3JjCiAgICB9ID0gX1BERldvcmtlcjsKICAgIHRyeSB7CiAgICAgIGlmICghX1BERldvcmtlci5faXNTYW1lT3JpZ2luKHdpbmRvdy5sb2NhdGlvbiwgd29ya2VyU3JjKSkgewogICAgICAgIHdvcmtlclNyYyA9IF9QREZXb3JrZXIuX2NyZWF0ZUNETldyYXBwZXIobmV3IFVSTCh3b3JrZXJTcmMsIHdpbmRvdy5sb2NhdGlvbikuaHJlZik7CiAgICAgIH0KICAgICAgY29uc3Qgd29ya2VyID0gbmV3IFdvcmtlcih3b3JrZXJTcmMsIHsKICAgICAgICB0eXBlOiAibW9kdWxlIgogICAgICB9KTsKICAgICAgY29uc3QgbWVzc2FnZUhhbmRsZXIgPSBuZXcgTWVzc2FnZUhhbmRsZXIoIm1haW4iLCAid29ya2VyIiwgd29ya2VyKTsKICAgICAgY29uc3QgdGVybWluYXRlRWFybHkgPSAoKSA9PiB7CiAgICAgICAgYWMuYWJvcnQoKTsKICAgICAgICBtZXNzYWdlSGFuZGxlci5kZXN0cm95KCk7CiAgICAgICAgd29ya2VyLnRlcm1pbmF0ZSgpOwogICAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgICAgdGhpcy4jY2FwYWJpbGl0eS5yZWplY3QobmV3IEVycm9yKCJXb3JrZXIgd2FzIGRlc3Ryb3llZCIpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4jc2V0dXBGYWtlV29ya2VyKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBhYyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgd29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgKCkgPT4gewogICAgICAgIGlmICghdGhpcy4jd2ViV29ya2VyKSB7CiAgICAgICAgICB0ZXJtaW5hdGVFYXJseSgpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHNpZ25hbDogYWMuc2lnbmFsCiAgICAgIH0pOwogICAgICBtZXNzYWdlSGFuZGxlci5vbigidGVzdCIsIChkYXRhKSA9PiB7CiAgICAgICAgYWMuYWJvcnQoKTsKICAgICAgICBpZiAodGhpcy5kZXN0cm95ZWQgfHwgIWRhdGEpIHsKICAgICAgICAgIHRlcm1pbmF0ZUVhcmx5KCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuI21lc3NhZ2VIYW5kbGVyID0gbWVzc2FnZUhhbmRsZXI7CiAgICAgICAgdGhpcy4jcG9ydCA9IHdvcmtlcjsKICAgICAgICB0aGlzLiN3ZWJXb3JrZXIgPSB3b3JrZXI7CiAgICAgICAgdGhpcy4jcmVzb2x2ZSgpOwogICAgICB9KTsKICAgICAgbWVzc2FnZUhhbmRsZXIub24oInJlYWR5IiwgKGRhdGEpID0+IHsKICAgICAgICBhYy5hYm9ydCgpOwogICAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgICAgdGVybWluYXRlRWFybHkoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHNlbmRUZXN0KCk7CiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICB0aGlzLiNzZXR1cEZha2VXb3JrZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBjb25zdCBzZW5kVGVzdCA9ICgpID0+IHsKICAgICAgICBjb25zdCB0ZXN0T2JqID0gbmV3IFVpbnQ4QXJyYXkoKTsKICAgICAgICBtZXNzYWdlSGFuZGxlci5zZW5kKCJ0ZXN0IiwgdGVzdE9iaiwgW3Rlc3RPYmouYnVmZmVyXSk7CiAgICAgIH07CiAgICAgIHNlbmRUZXN0KCk7CiAgICAgIHJldHVybjsKICAgIH0gY2F0Y2ggewogICAgICBpbmZvKCJUaGUgd29ya2VyIGhhcyBiZWVuIGRpc2FibGVkLiIpOwogICAgfQogICAgdGhpcy4jc2V0dXBGYWtlV29ya2VyKCk7CiAgfQogICNzZXR1cEZha2VXb3JrZXIoKSB7CiAgICBpZiAoIV9QREZXb3JrZXIuI2lzV29ya2VyRGlzYWJsZWQpIHsKICAgICAgd2FybigiU2V0dGluZyB1cCBmYWtlIHdvcmtlci4iKTsKICAgICAgX1BERldvcmtlci4jaXNXb3JrZXJEaXNhYmxlZCA9IHRydWU7CiAgICB9CiAgICBfUERGV29ya2VyLl9zZXR1cEZha2VXb3JrZXJHbG9iYWwudGhlbigoV29ya2VyTWVzc2FnZUhhbmRsZXIpID0+IHsKICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgdGhpcy4jY2FwYWJpbGl0eS5yZWplY3QobmV3IEVycm9yKCJXb3JrZXIgd2FzIGRlc3Ryb3llZCIpKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgcG9ydCA9IG5ldyBMb29wYmFja1BvcnQoKTsKICAgICAgdGhpcy4jcG9ydCA9IHBvcnQ7CiAgICAgIGNvbnN0IGlkID0gYGZha2Uke19QREZXb3JrZXIuI2Zha2VXb3JrZXJJZCsrfWA7CiAgICAgIGNvbnN0IHdvcmtlckhhbmRsZXIgPSBuZXcgTWVzc2FnZUhhbmRsZXIoaWQgKyAiX3dvcmtlciIsIGlkLCBwb3J0KTsKICAgICAgV29ya2VyTWVzc2FnZUhhbmRsZXIuc2V0dXAod29ya2VySGFuZGxlciwgcG9ydCk7CiAgICAgIHRoaXMuI21lc3NhZ2VIYW5kbGVyID0gbmV3IE1lc3NhZ2VIYW5kbGVyKGlkLCBpZCArICJfd29ya2VyIiwgcG9ydCk7CiAgICAgIHRoaXMuI3Jlc29sdmUoKTsKICAgIH0pLmNhdGNoKChyZWFzb24pID0+IHsKICAgICAgdGhpcy4jY2FwYWJpbGl0eS5yZWplY3QobmV3IEVycm9yKGBTZXR0aW5nIHVwIGZha2Ugd29ya2VyIGZhaWxlZDogIiR7cmVhc29uLm1lc3NhZ2V9Ii5gKSk7CiAgICB9KTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKICAgIHRoaXMuI3dlYldvcmtlcj8udGVybWluYXRlKCk7CiAgICB0aGlzLiN3ZWJXb3JrZXIgPSBudWxsOwogICAgX1BERldvcmtlci4jd29ya2VyUG9ydHMuZGVsZXRlKHRoaXMuI3BvcnQpOwogICAgdGhpcy4jcG9ydCA9IG51bGw7CiAgICB0aGlzLiNtZXNzYWdlSGFuZGxlcj8uZGVzdHJveSgpOwogICAgdGhpcy4jbWVzc2FnZUhhbmRsZXIgPSBudWxsOwogIH0KICBzdGF0aWMgY3JlYXRlKHBhcmFtcykgewogICAgY29uc3QgY2FjaGVkUG9ydCA9IHRoaXMuI3dvcmtlclBvcnRzLmdldChwYXJhbXM/LnBvcnQpOwogICAgaWYgKGNhY2hlZFBvcnQpIHsKICAgICAgaWYgKGNhY2hlZFBvcnQuX3BlbmRpbmdEZXN0cm95KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQREZXb3JrZXIuY3JlYXRlIC0gdGhlIHdvcmtlciBpcyBiZWluZyBkZXN0cm95ZWQuXG5QbGVhc2UgcmVtZW1iZXIgdG8gYXdhaXQgYFBERkRvY3VtZW50TG9hZGluZ1Rhc2suZGVzdHJveSgpYC1jYWxscy4iKTsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGVkUG9ydDsKICAgIH0KICAgIHJldHVybiBuZXcgX1BERldvcmtlcihwYXJhbXMpOwogIH0KICBzdGF0aWMgZ2V0IHdvcmtlclNyYygpIHsKICAgIGlmIChHbG9iYWxXb3JrZXJPcHRpb25zLndvcmtlclNyYykgewogICAgICByZXR1cm4gR2xvYmFsV29ya2VyT3B0aW9ucy53b3JrZXJTcmM7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vICJHbG9iYWxXb3JrZXJPcHRpb25zLndvcmtlclNyYyIgc3BlY2lmaWVkLicpOwogIH0KICBzdGF0aWMgZ2V0ICNtYWluVGhyZWFkV29ya2VyTWVzc2FnZUhhbmRsZXIoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gZ2xvYmFsVGhpcy5wZGZqc1dvcmtlcj8uV29ya2VyTWVzc2FnZUhhbmRsZXIgfHwgbnVsbDsKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9CiAgc3RhdGljIGdldCBfc2V0dXBGYWtlV29ya2VyR2xvYmFsKCkgewogICAgY29uc3QgbG9hZGVyID0gYXN5bmMgKCkgPT4gewogICAgICBpZiAodGhpcy4jbWFpblRocmVhZFdvcmtlck1lc3NhZ2VIYW5kbGVyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuI21haW5UaHJlYWRXb3JrZXJNZXNzYWdlSGFuZGxlcjsKICAgICAgfQogICAgICBjb25zdCB3b3JrZXIgPSBhd2FpdCBpbXBvcnQoCiAgICAgICAgLyp3ZWJwYWNrSWdub3JlOiB0cnVlKi8KICAgICAgICAvKkB2aXRlLWlnbm9yZSovCiAgICAgICAgdGhpcy53b3JrZXJTcmMKICAgICAgKTsKICAgICAgcmV0dXJuIHdvcmtlci5Xb3JrZXJNZXNzYWdlSGFuZGxlcjsKICAgIH07CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfc2V0dXBGYWtlV29ya2VyR2xvYmFsIiwgbG9hZGVyKCkpOwogIH0KfTsKdmFyIFdvcmtlclRyYW5zcG9ydCA9IGNsYXNzIHsKICAjbWV0aG9kUHJvbWlzZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNwYWdlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNwYWdlUHJvbWlzZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNwYWdlUmVmQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNwYXNzd29yZENhcGFiaWxpdHkgPSBudWxsOwogIGNvbnN0cnVjdG9yKG1lc3NhZ2VIYW5kbGVyLCBsb2FkaW5nVGFzaywgbmV0d29ya1N0cmVhbSwgcGFyYW1zLCBmYWN0b3J5LCBlbmFibGVIV0EpIHsKICAgIHRoaXMubWVzc2FnZUhhbmRsZXIgPSBtZXNzYWdlSGFuZGxlcjsKICAgIHRoaXMubG9hZGluZ1Rhc2sgPSBsb2FkaW5nVGFzazsKICAgIHRoaXMuY29tbW9uT2JqcyA9IG5ldyBQREZPYmplY3RzKCk7CiAgICB0aGlzLmZvbnRMb2FkZXIgPSBuZXcgRm9udExvYWRlcih7CiAgICAgIG93bmVyRG9jdW1lbnQ6IHBhcmFtcy5vd25lckRvY3VtZW50LAogICAgICBzdHlsZUVsZW1lbnQ6IHBhcmFtcy5zdHlsZUVsZW1lbnQKICAgIH0pOwogICAgdGhpcy5sb2FkaW5nUGFyYW1zID0gcGFyYW1zLmxvYWRpbmdQYXJhbXM7CiAgICB0aGlzLl9wYXJhbXMgPSBwYXJhbXM7CiAgICB0aGlzLmNhbnZhc0ZhY3RvcnkgPSBmYWN0b3J5LmNhbnZhc0ZhY3Rvcnk7CiAgICB0aGlzLmZpbHRlckZhY3RvcnkgPSBmYWN0b3J5LmZpbHRlckZhY3Rvcnk7CiAgICB0aGlzLmNNYXBSZWFkZXJGYWN0b3J5ID0gZmFjdG9yeS5jTWFwUmVhZGVyRmFjdG9yeTsKICAgIHRoaXMuc3RhbmRhcmRGb250RGF0YUZhY3RvcnkgPSBmYWN0b3J5LnN0YW5kYXJkRm9udERhdGFGYWN0b3J5OwogICAgdGhpcy53YXNtRmFjdG9yeSA9IGZhY3Rvcnkud2FzbUZhY3Rvcnk7CiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlOwogICAgdGhpcy5kZXN0cm95Q2FwYWJpbGl0eSA9IG51bGw7CiAgICB0aGlzLl9uZXR3b3JrU3RyZWFtID0gbmV0d29ya1N0cmVhbTsKICAgIHRoaXMuX2Z1bGxSZWFkZXIgPSBudWxsOwogICAgdGhpcy5fbGFzdFByb2dyZXNzID0gbnVsbDsKICAgIHRoaXMuZG93bmxvYWRJbmZvQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5lbmFibGVIV0EgPSBlbmFibGVIV0E7CiAgICB0aGlzLnNldHVwTWVzc2FnZUhhbmRsZXIoKTsKICB9CiAgI2NhY2hlU2ltcGxlTWV0aG9kKG5hbWUsIGRhdGEgPSBudWxsKSB7CiAgICBjb25zdCBjYWNoZWRQcm9taXNlID0gdGhpcy4jbWV0aG9kUHJvbWlzZXMuZ2V0KG5hbWUpOwogICAgaWYgKGNhY2hlZFByb21pc2UpIHsKICAgICAgcmV0dXJuIGNhY2hlZFByb21pc2U7CiAgICB9CiAgICBjb25zdCBwcm9taXNlID0gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UobmFtZSwgZGF0YSk7CiAgICB0aGlzLiNtZXRob2RQcm9taXNlcy5zZXQobmFtZSwgcHJvbWlzZSk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CiAgZ2V0IGFubm90YXRpb25TdG9yYWdlKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiYW5ub3RhdGlvblN0b3JhZ2UiLCBuZXcgQW5ub3RhdGlvblN0b3JhZ2UoKSk7CiAgfQogIGdldFJlbmRlcmluZ0ludGVudChpbnRlbnQsIGFubm90YXRpb25Nb2RlID0gQW5ub3RhdGlvbk1vZGUuRU5BQkxFLCBwcmludEFubm90YXRpb25TdG9yYWdlID0gbnVsbCwgaXNFZGl0aW5nID0gZmFsc2UsIGlzT3BMaXN0ID0gZmFsc2UpIHsKICAgIGxldCByZW5kZXJpbmdJbnRlbnQgPSBSZW5kZXJpbmdJbnRlbnRGbGFnLkRJU1BMQVk7CiAgICBsZXQgYW5ub3RhdGlvblN0b3JhZ2VTZXJpYWxpemFibGUgPSBTZXJpYWxpemFibGVFbXB0eTsKICAgIHN3aXRjaCAoaW50ZW50KSB7CiAgICAgIGNhc2UgImFueSI6CiAgICAgICAgcmVuZGVyaW5nSW50ZW50ID0gUmVuZGVyaW5nSW50ZW50RmxhZy5BTlk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImRpc3BsYXkiOgogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJwcmludCI6CiAgICAgICAgcmVuZGVyaW5nSW50ZW50ID0gUmVuZGVyaW5nSW50ZW50RmxhZy5QUklOVDsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB3YXJuKGBnZXRSZW5kZXJpbmdJbnRlbnQgLSBpbnZhbGlkIGludGVudDogJHtpbnRlbnR9YCk7CiAgICB9CiAgICBjb25zdCBhbm5vdGF0aW9uU3RvcmFnZSA9IHJlbmRlcmluZ0ludGVudCAmIFJlbmRlcmluZ0ludGVudEZsYWcuUFJJTlQgJiYgcHJpbnRBbm5vdGF0aW9uU3RvcmFnZSBpbnN0YW5jZW9mIFByaW50QW5ub3RhdGlvblN0b3JhZ2UgPyBwcmludEFubm90YXRpb25TdG9yYWdlIDogdGhpcy5hbm5vdGF0aW9uU3RvcmFnZTsKICAgIHN3aXRjaCAoYW5ub3RhdGlvbk1vZGUpIHsKICAgICAgY2FzZSBBbm5vdGF0aW9uTW9kZS5ESVNBQkxFOgogICAgICAgIHJlbmRlcmluZ0ludGVudCArPSBSZW5kZXJpbmdJbnRlbnRGbGFnLkFOTk9UQVRJT05TX0RJU0FCTEU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgQW5ub3RhdGlvbk1vZGUuRU5BQkxFOgogICAgICAgIGJyZWFrOwogICAgICBjYXNlIEFubm90YXRpb25Nb2RlLkVOQUJMRV9GT1JNUzoKICAgICAgICByZW5kZXJpbmdJbnRlbnQgKz0gUmVuZGVyaW5nSW50ZW50RmxhZy5BTk5PVEFUSU9OU19GT1JNUzsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBBbm5vdGF0aW9uTW9kZS5FTkFCTEVfU1RPUkFHRToKICAgICAgICByZW5kZXJpbmdJbnRlbnQgKz0gUmVuZGVyaW5nSW50ZW50RmxhZy5BTk5PVEFUSU9OU19TVE9SQUdFOwogICAgICAgIGFubm90YXRpb25TdG9yYWdlU2VyaWFsaXphYmxlID0gYW5ub3RhdGlvblN0b3JhZ2Uuc2VyaWFsaXphYmxlOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHdhcm4oYGdldFJlbmRlcmluZ0ludGVudCAtIGludmFsaWQgYW5ub3RhdGlvbk1vZGU6ICR7YW5ub3RhdGlvbk1vZGV9YCk7CiAgICB9CiAgICBpZiAoaXNFZGl0aW5nKSB7CiAgICAgIHJlbmRlcmluZ0ludGVudCArPSBSZW5kZXJpbmdJbnRlbnRGbGFnLklTX0VESVRJTkc7CiAgICB9CiAgICBpZiAoaXNPcExpc3QpIHsKICAgICAgcmVuZGVyaW5nSW50ZW50ICs9IFJlbmRlcmluZ0ludGVudEZsYWcuT1BMSVNUOwogICAgfQogICAgY29uc3QgewogICAgICBpZHM6IG1vZGlmaWVkSWRzLAogICAgICBoYXNoOiBtb2RpZmllZElkc0hhc2gKICAgIH0gPSBhbm5vdGF0aW9uU3RvcmFnZS5tb2RpZmllZElkczsKICAgIGNvbnN0IGNhY2hlS2V5QnVmID0gW3JlbmRlcmluZ0ludGVudCwgYW5ub3RhdGlvblN0b3JhZ2VTZXJpYWxpemFibGUuaGFzaCwgbW9kaWZpZWRJZHNIYXNoXTsKICAgIHJldHVybiB7CiAgICAgIHJlbmRlcmluZ0ludGVudCwKICAgICAgY2FjaGVLZXk6IGNhY2hlS2V5QnVmLmpvaW4oIl8iKSwKICAgICAgYW5ub3RhdGlvblN0b3JhZ2VTZXJpYWxpemFibGUsCiAgICAgIG1vZGlmaWVkSWRzCiAgICB9OwogIH0KICBkZXN0cm95KCkgewogICAgaWYgKHRoaXMuZGVzdHJveUNhcGFiaWxpdHkpIHsKICAgICAgcmV0dXJuIHRoaXMuZGVzdHJveUNhcGFiaWxpdHkucHJvbWlzZTsKICAgIH0KICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKICAgIHRoaXMuZGVzdHJveUNhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIHRoaXMuI3Bhc3N3b3JkQ2FwYWJpbGl0eT8ucmVqZWN0KG5ldyBFcnJvcigiV29ya2VyIHdhcyBkZXN0cm95ZWQgZHVyaW5nIG9uUGFzc3dvcmQgY2FsbGJhY2siKSk7CiAgICBjb25zdCB3YWl0T24gPSBbXTsKICAgIGZvciAoY29uc3QgcGFnZSBvZiB0aGlzLiNwYWdlQ2FjaGUudmFsdWVzKCkpIHsKICAgICAgd2FpdE9uLnB1c2gocGFnZS5fZGVzdHJveSgpKTsKICAgIH0KICAgIHRoaXMuI3BhZ2VDYWNoZS5jbGVhcigpOwogICAgdGhpcy4jcGFnZVByb21pc2VzLmNsZWFyKCk7CiAgICB0aGlzLiNwYWdlUmVmQ2FjaGUuY2xlYXIoKTsKICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KCJhbm5vdGF0aW9uU3RvcmFnZSIpKSB7CiAgICAgIHRoaXMuYW5ub3RhdGlvblN0b3JhZ2UucmVzZXRNb2RpZmllZCgpOwogICAgfQogICAgY29uc3QgdGVybWluYXRlZCA9IHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJUZXJtaW5hdGUiLCBudWxsKTsKICAgIHdhaXRPbi5wdXNoKHRlcm1pbmF0ZWQpOwogICAgUHJvbWlzZS5hbGwod2FpdE9uKS50aGVuKCgpID0+IHsKICAgICAgdGhpcy5jb21tb25PYmpzLmNsZWFyKCk7CiAgICAgIHRoaXMuZm9udExvYWRlci5jbGVhcigpOwogICAgICB0aGlzLiNtZXRob2RQcm9taXNlcy5jbGVhcigpOwogICAgICB0aGlzLmZpbHRlckZhY3RvcnkuZGVzdHJveSgpOwogICAgICBUZXh0TGF5ZXIuY2xlYW51cCgpOwogICAgICB0aGlzLl9uZXR3b3JrU3RyZWFtPy5jYW5jZWxBbGxSZXF1ZXN0cyhuZXcgQWJvcnRFeGNlcHRpb24oIldvcmtlciB3YXMgdGVybWluYXRlZC4iKSk7CiAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXI/LmRlc3Ryb3koKTsKICAgICAgdGhpcy5tZXNzYWdlSGFuZGxlciA9IG51bGw7CiAgICAgIHRoaXMuZGVzdHJveUNhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgfSwgdGhpcy5kZXN0cm95Q2FwYWJpbGl0eS5yZWplY3QpOwogICAgcmV0dXJuIHRoaXMuZGVzdHJveUNhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgc2V0dXBNZXNzYWdlSGFuZGxlcigpIHsKICAgIGNvbnN0IHsKICAgICAgbWVzc2FnZUhhbmRsZXIsCiAgICAgIGxvYWRpbmdUYXNrCiAgICB9ID0gdGhpczsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJHZXRSZWFkZXIiLCAoZGF0YSwgc2luaykgPT4gewogICAgICBhc3NlcnQodGhpcy5fbmV0d29ya1N0cmVhbSwgIkdldFJlYWRlciAtIG5vIGBJUERGU3RyZWFtYCBpbnN0YW5jZSBhdmFpbGFibGUuIik7CiAgICAgIHRoaXMuX2Z1bGxSZWFkZXIgPSB0aGlzLl9uZXR3b3JrU3RyZWFtLmdldEZ1bGxSZWFkZXIoKTsKICAgICAgdGhpcy5fZnVsbFJlYWRlci5vblByb2dyZXNzID0gKGV2dCkgPT4gewogICAgICAgIHRoaXMuX2xhc3RQcm9ncmVzcyA9IHsKICAgICAgICAgIGxvYWRlZDogZXZ0LmxvYWRlZCwKICAgICAgICAgIHRvdGFsOiBldnQudG90YWwKICAgICAgICB9OwogICAgICB9OwogICAgICBzaW5rLm9uUHVsbCA9ICgpID0+IHsKICAgICAgICB0aGlzLl9mdWxsUmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uKHsKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgZG9uZQogICAgICAgIH0pIHsKICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgIHNpbmsuY2xvc2UoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0KHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIsICJHZXRSZWFkZXIgLSBleHBlY3RlZCBhbiBBcnJheUJ1ZmZlci4iKTsKICAgICAgICAgIHNpbmsuZW5xdWV1ZShuZXcgVWludDhBcnJheSh2YWx1ZSksIDEsIFt2YWx1ZV0pOwogICAgICAgIH0pLmNhdGNoKChyZWFzb24pID0+IHsKICAgICAgICAgIHNpbmsuZXJyb3IocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgc2luay5vbkNhbmNlbCA9IChyZWFzb24pID0+IHsKICAgICAgICB0aGlzLl9mdWxsUmVhZGVyLmNhbmNlbChyZWFzb24pOwogICAgICAgIHNpbmsucmVhZHkuY2F0Y2goKHJlYWR5UmVhc29uKSA9PiB7CiAgICAgICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgcmVhZHlSZWFzb247CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJSZWFkZXJIZWFkZXJzUmVhZHkiLCBhc3luYyAoZGF0YSkgPT4gewogICAgICBhd2FpdCB0aGlzLl9mdWxsUmVhZGVyLmhlYWRlcnNSZWFkeTsKICAgICAgY29uc3QgewogICAgICAgIGlzU3RyZWFtaW5nU3VwcG9ydGVkLAogICAgICAgIGlzUmFuZ2VTdXBwb3J0ZWQsCiAgICAgICAgY29udGVudExlbmd0aAogICAgICB9ID0gdGhpcy5fZnVsbFJlYWRlcjsKICAgICAgaWYgKCFpc1N0cmVhbWluZ1N1cHBvcnRlZCB8fCAhaXNSYW5nZVN1cHBvcnRlZCkgewogICAgICAgIGlmICh0aGlzLl9sYXN0UHJvZ3Jlc3MpIHsKICAgICAgICAgIGxvYWRpbmdUYXNrLm9uUHJvZ3Jlc3M/Lih0aGlzLl9sYXN0UHJvZ3Jlc3MpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9mdWxsUmVhZGVyLm9uUHJvZ3Jlc3MgPSAoZXZ0KSA9PiB7CiAgICAgICAgICBsb2FkaW5nVGFzay5vblByb2dyZXNzPy4oewogICAgICAgICAgICBsb2FkZWQ6IGV2dC5sb2FkZWQsCiAgICAgICAgICAgIHRvdGFsOiBldnQudG90YWwKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBpc1N0cmVhbWluZ1N1cHBvcnRlZCwKICAgICAgICBpc1JhbmdlU3VwcG9ydGVkLAogICAgICAgIGNvbnRlbnRMZW5ndGgKICAgICAgfTsKICAgIH0pOwogICAgbWVzc2FnZUhhbmRsZXIub24oIkdldFJhbmdlUmVhZGVyIiwgKGRhdGEsIHNpbmspID0+IHsKICAgICAgYXNzZXJ0KHRoaXMuX25ldHdvcmtTdHJlYW0sICJHZXRSYW5nZVJlYWRlciAtIG5vIGBJUERGU3RyZWFtYCBpbnN0YW5jZSBhdmFpbGFibGUuIik7CiAgICAgIGNvbnN0IHJhbmdlUmVhZGVyID0gdGhpcy5fbmV0d29ya1N0cmVhbS5nZXRSYW5nZVJlYWRlcihkYXRhLmJlZ2luLCBkYXRhLmVuZCk7CiAgICAgIGlmICghcmFuZ2VSZWFkZXIpIHsKICAgICAgICBzaW5rLmNsb3NlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNpbmsub25QdWxsID0gKCkgPT4gewogICAgICAgIHJhbmdlUmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uKHsKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgZG9uZQogICAgICAgIH0pIHsKICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgIHNpbmsuY2xvc2UoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0KHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIsICJHZXRSYW5nZVJlYWRlciAtIGV4cGVjdGVkIGFuIEFycmF5QnVmZmVyLiIpOwogICAgICAgICAgc2luay5lbnF1ZXVlKG5ldyBVaW50OEFycmF5KHZhbHVlKSwgMSwgW3ZhbHVlXSk7CiAgICAgICAgfSkuY2F0Y2goKHJlYXNvbikgPT4gewogICAgICAgICAgc2luay5lcnJvcihyZWFzb24pOwogICAgICAgIH0pOwogICAgICB9OwogICAgICBzaW5rLm9uQ2FuY2VsID0gKHJlYXNvbikgPT4gewogICAgICAgIHJhbmdlUmVhZGVyLmNhbmNlbChyZWFzb24pOwogICAgICAgIHNpbmsucmVhZHkuY2F0Y2goKHJlYWR5UmVhc29uKSA9PiB7CiAgICAgICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgcmVhZHlSZWFzb247CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJHZXREb2MiLCAoewogICAgICBwZGZJbmZvCiAgICB9KSA9PiB7CiAgICAgIHRoaXMuX251bVBhZ2VzID0gcGRmSW5mby5udW1QYWdlczsKICAgICAgdGhpcy5faHRtbEZvclhmYSA9IHBkZkluZm8uaHRtbEZvclhmYTsKICAgICAgZGVsZXRlIHBkZkluZm8uaHRtbEZvclhmYTsKICAgICAgbG9hZGluZ1Rhc2suX2NhcGFiaWxpdHkucmVzb2x2ZShuZXcgUERGRG9jdW1lbnRQcm94eShwZGZJbmZvLCB0aGlzKSk7CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJEb2NFeGNlcHRpb24iLCAoZXgpID0+IHsKICAgICAgbG9hZGluZ1Rhc2suX2NhcGFiaWxpdHkucmVqZWN0KHdyYXBSZWFzb24oZXgpKTsKICAgIH0pOwogICAgbWVzc2FnZUhhbmRsZXIub24oIlBhc3N3b3JkUmVxdWVzdCIsIChleCkgPT4gewogICAgICB0aGlzLiNwYXNzd29yZENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoIWxvYWRpbmdUYXNrLm9uUGFzc3dvcmQpIHsKICAgICAgICAgIHRocm93IHdyYXBSZWFzb24oZXgpOwogICAgICAgIH0KICAgICAgICBjb25zdCB1cGRhdGVQYXNzd29yZCA9IChwYXNzd29yZCkgPT4gewogICAgICAgICAgaWYgKHBhc3N3b3JkIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgdGhpcy4jcGFzc3dvcmRDYXBhYmlsaXR5LnJlamVjdChwYXNzd29yZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLiNwYXNzd29yZENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgICAgICAgcGFzc3dvcmQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBsb2FkaW5nVGFzay5vblBhc3N3b3JkKHVwZGF0ZVBhc3N3b3JkLCBleC5jb2RlKTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgdGhpcy4jcGFzc3dvcmRDYXBhYmlsaXR5LnJlamVjdChlcnIpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLiNwYXNzd29yZENhcGFiaWxpdHkucHJvbWlzZTsKICAgIH0pOwogICAgbWVzc2FnZUhhbmRsZXIub24oIkRhdGFMb2FkZWQiLCAoZGF0YSkgPT4gewogICAgICBsb2FkaW5nVGFzay5vblByb2dyZXNzPy4oewogICAgICAgIGxvYWRlZDogZGF0YS5sZW5ndGgsCiAgICAgICAgdG90YWw6IGRhdGEubGVuZ3RoCiAgICAgIH0pOwogICAgICB0aGlzLmRvd25sb2FkSW5mb0NhcGFiaWxpdHkucmVzb2x2ZShkYXRhKTsKICAgIH0pOwogICAgbWVzc2FnZUhhbmRsZXIub24oIlN0YXJ0UmVuZGVyUGFnZSIsIChkYXRhKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBwYWdlID0gdGhpcy4jcGFnZUNhY2hlLmdldChkYXRhLnBhZ2VJbmRleCk7CiAgICAgIHBhZ2UuX3N0YXJ0UmVuZGVyUGFnZShkYXRhLnRyYW5zcGFyZW5jeSwgZGF0YS5jYWNoZUtleSk7CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJjb21tb25vYmoiLCAoW2lkLCB0eXBlLCBleHBvcnRlZERhdGFdKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmICh0aGlzLmNvbW1vbk9ianMuaGFzKGlkKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgIGNhc2UgIkZvbnQiOgogICAgICAgICAgaWYgKCJlcnJvciIgaW4gZXhwb3J0ZWREYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGV4cG9ydGVkRXJyb3IgPSBleHBvcnRlZERhdGEuZXJyb3I7CiAgICAgICAgICAgIHdhcm4oYEVycm9yIGR1cmluZyBmb250IGxvYWRpbmc6ICR7ZXhwb3J0ZWRFcnJvcn1gKTsKICAgICAgICAgICAgdGhpcy5jb21tb25PYmpzLnJlc29sdmUoaWQsIGV4cG9ydGVkRXJyb3IpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGZvbnREYXRhID0gbmV3IEZvbnRJbmZvKGV4cG9ydGVkRGF0YSk7CiAgICAgICAgICBjb25zdCBpbnNwZWN0Rm9udCA9IHRoaXMuX3BhcmFtcy5wZGZCdWcgJiYgZ2xvYmFsVGhpcy5Gb250SW5zcGVjdG9yPy5lbmFibGVkID8gKGZvbnQyLCB1cmwpID0+IGdsb2JhbFRoaXMuRm9udEluc3BlY3Rvci5mb250QWRkZWQoZm9udDIsIHVybCkgOiBudWxsOwogICAgICAgICAgY29uc3QgZm9udCA9IG5ldyBGb250RmFjZU9iamVjdChmb250RGF0YSwgaW5zcGVjdEZvbnQsIGV4cG9ydGVkRGF0YS5leHRyYSwgZXhwb3J0ZWREYXRhLmNoYXJQcm9jT3BlcmF0b3JMaXN0KTsKICAgICAgICAgIHRoaXMuZm9udExvYWRlci5iaW5kKGZvbnQpLmNhdGNoKCgpID0+IG1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiRm9udEZhbGxiYWNrIiwgewogICAgICAgICAgICBpZAogICAgICAgICAgfSkpLmZpbmFsbHkoKCkgPT4gewogICAgICAgICAgICBpZiAoIWZvbnQuZm9udEV4dHJhUHJvcGVydGllcyAmJiBmb250LmRhdGEpIHsKICAgICAgICAgICAgICBmb250LmNsZWFyRGF0YSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY29tbW9uT2Jqcy5yZXNvbHZlKGlkLCBmb250KTsKICAgICAgICAgIH0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiQ29weUxvY2FsSW1hZ2UiOgogICAgICAgICAgY29uc3QgewogICAgICAgICAgICBpbWFnZVJlZgogICAgICAgICAgfSA9IGV4cG9ydGVkRGF0YTsKICAgICAgICAgIGFzc2VydChpbWFnZVJlZiwgIlRoZSBpbWFnZVJlZiBtdXN0IGJlIGRlZmluZWQuIik7CiAgICAgICAgICBmb3IgKGNvbnN0IHBhZ2VQcm94eSBvZiB0aGlzLiNwYWdlQ2FjaGUudmFsdWVzKCkpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBbLCBkYXRhXSBvZiBwYWdlUHJveHkub2JqcykgewogICAgICAgICAgICAgIGlmIChkYXRhPy5yZWYgIT09IGltYWdlUmVmKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkYXRhLmRhdGFMZW4pIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmNvbW1vbk9ianMucmVzb2x2ZShpZCwgc3RydWN0dXJlZENsb25lKGRhdGEpKTsKICAgICAgICAgICAgICByZXR1cm4gZGF0YS5kYXRhTGVuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJGb250UGF0aCI6CiAgICAgICAgICB0aGlzLmNvbW1vbk9ianMucmVzb2x2ZShpZCwgbmV3IEZvbnRQYXRoSW5mbyhleHBvcnRlZERhdGEpKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkltYWdlIjoKICAgICAgICAgIHRoaXMuY29tbW9uT2Jqcy5yZXNvbHZlKGlkLCBleHBvcnRlZERhdGEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiUGF0dGVybiI6CiAgICAgICAgICBjb25zdCBwYXR0ZXJuID0gbmV3IFBhdHRlcm5JbmZvKGV4cG9ydGVkRGF0YSk7CiAgICAgICAgICB0aGlzLmNvbW1vbk9ianMucmVzb2x2ZShpZCwgcGF0dGVybi5nZXRJUigpKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEdvdCB1bmtub3duIGNvbW1vbiBvYmplY3QgdHlwZSAke3R5cGV9YCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJvYmoiLCAoW2lkLCBwYWdlSW5kZXgsIHR5cGUsIGltYWdlRGF0YV0pID0+IHsKICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHBhZ2VQcm94eSA9IHRoaXMuI3BhZ2VDYWNoZS5nZXQocGFnZUluZGV4KTsKICAgICAgaWYgKHBhZ2VQcm94eS5vYmpzLmhhcyhpZCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHBhZ2VQcm94eS5faW50ZW50U3RhdGVzLnNpemUgPT09IDApIHsKICAgICAgICBpbWFnZURhdGE/LmJpdG1hcD8uY2xvc2UoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgY2FzZSAiSW1hZ2UiOgogICAgICAgIGNhc2UgIlBhdHRlcm4iOgogICAgICAgICAgcGFnZVByb3h5Lm9ianMucmVzb2x2ZShpZCwgaW1hZ2VEYXRhKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEdvdCB1bmtub3duIG9iamVjdCB0eXBlICR7dHlwZX1gKTsKICAgICAgfQogICAgfSk7CiAgICBtZXNzYWdlSGFuZGxlci5vbigiRG9jUHJvZ3Jlc3MiLCAoZGF0YSkgPT4gewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbG9hZGluZ1Rhc2sub25Qcm9ncmVzcz8uKHsKICAgICAgICBsb2FkZWQ6IGRhdGEubG9hZGVkLAogICAgICAgIHRvdGFsOiBkYXRhLnRvdGFsCiAgICAgIH0pOwogICAgfSk7CiAgICBtZXNzYWdlSGFuZGxlci5vbigiRmV0Y2hCaW5hcnlEYXRhIiwgYXN5bmMgKGRhdGEpID0+IHsKICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXb3JrZXIgd2FzIGRlc3Ryb3llZC4iKTsKICAgICAgfQogICAgICBjb25zdCBmYWN0b3J5ID0gdGhpc1tkYXRhLnR5cGVdOwogICAgICBpZiAoIWZhY3RvcnkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZGF0YS50eXBlfSBub3QgaW5pdGlhbGl6ZWQsIHNlZSB0aGUgXGB1c2VXb3JrZXJGZXRjaFxgIHBhcmFtZXRlci5gKTsKICAgICAgfQogICAgICByZXR1cm4gZmFjdG9yeS5mZXRjaChkYXRhKTsKICAgIH0pOwogIH0KICBnZXREYXRhKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXREYXRhIiwgbnVsbCk7CiAgfQogIHNhdmVEb2N1bWVudCgpIHsKICAgIGlmICh0aGlzLmFubm90YXRpb25TdG9yYWdlLnNpemUgPD0gMCkgewogICAgICB3YXJuKCJzYXZlRG9jdW1lbnQgY2FsbGVkIHdoaWxlIGBhbm5vdGF0aW9uU3RvcmFnZWAgaXMgZW1wdHksIHBsZWFzZSB1c2UgdGhlIGdldERhdGEtbWV0aG9kIGluc3RlYWQuIik7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIG1hcCwKICAgICAgdHJhbnNmZXIKICAgIH0gPSB0aGlzLmFubm90YXRpb25TdG9yYWdlLnNlcmlhbGl6YWJsZTsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiU2F2ZURvY3VtZW50IiwgewogICAgICBpc1B1cmVYZmE6ICEhdGhpcy5faHRtbEZvclhmYSwKICAgICAgbnVtUGFnZXM6IHRoaXMuX251bVBhZ2VzLAogICAgICBhbm5vdGF0aW9uU3RvcmFnZTogbWFwLAogICAgICBmaWxlbmFtZTogdGhpcy5fZnVsbFJlYWRlcj8uZmlsZW5hbWUgPz8gbnVsbAogICAgfSwgdHJhbnNmZXIpLmZpbmFsbHkoKCkgPT4gewogICAgICB0aGlzLmFubm90YXRpb25TdG9yYWdlLnJlc2V0TW9kaWZpZWQoKTsKICAgIH0pOwogIH0KICBleHRyYWN0UGFnZXMocGFnZUluZm9zKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkV4dHJhY3RQYWdlcyIsIHsKICAgICAgcGFnZUluZm9zCiAgICB9KTsKICB9CiAgZ2V0UGFnZShwYWdlTnVtYmVyKSB7CiAgICBpZiAoIU51bWJlci5pc0ludGVnZXIocGFnZU51bWJlcikgfHwgcGFnZU51bWJlciA8PSAwIHx8IHBhZ2VOdW1iZXIgPiB0aGlzLl9udW1QYWdlcykgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCJJbnZhbGlkIHBhZ2UgcmVxdWVzdC4iKSk7CiAgICB9CiAgICBjb25zdCBwYWdlSW5kZXggPSBwYWdlTnVtYmVyIC0gMSwgY2FjaGVkUHJvbWlzZSA9IHRoaXMuI3BhZ2VQcm9taXNlcy5nZXQocGFnZUluZGV4KTsKICAgIGlmIChjYWNoZWRQcm9taXNlKSB7CiAgICAgIHJldHVybiBjYWNoZWRQcm9taXNlOwogICAgfQogICAgY29uc3QgcHJvbWlzZSA9IHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRQYWdlIiwgewogICAgICBwYWdlSW5kZXgKICAgIH0pLnRoZW4oKHBhZ2VJbmZvKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiVHJhbnNwb3J0IGRlc3Ryb3llZCIpOwogICAgICB9CiAgICAgIGlmIChwYWdlSW5mby5yZWZTdHIpIHsKICAgICAgICB0aGlzLiNwYWdlUmVmQ2FjaGUuc2V0KHBhZ2VJbmZvLnJlZlN0ciwgcGFnZU51bWJlcik7CiAgICAgIH0KICAgICAgY29uc3QgcGFnZSA9IG5ldyBQREZQYWdlUHJveHkocGFnZUluZGV4LCBwYWdlSW5mbywgdGhpcywgdGhpcy5fcGFyYW1zLnBkZkJ1Zyk7CiAgICAgIHRoaXMuI3BhZ2VDYWNoZS5zZXQocGFnZUluZGV4LCBwYWdlKTsKICAgICAgcmV0dXJuIHBhZ2U7CiAgICB9KTsKICAgIHRoaXMuI3BhZ2VQcm9taXNlcy5zZXQocGFnZUluZGV4LCBwcm9taXNlKTsKICAgIHJldHVybiBwcm9taXNlOwogIH0KICBnZXRQYWdlSW5kZXgocmVmKSB7CiAgICBpZiAoIWlzUmVmUHJveHkocmVmKSkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCJJbnZhbGlkIHBhZ2VJbmRleCByZXF1ZXN0LiIpKTsKICAgIH0KICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0UGFnZUluZGV4IiwgewogICAgICBudW06IHJlZi5udW0sCiAgICAgIGdlbjogcmVmLmdlbgogICAgfSk7CiAgfQogIGdldEFubm90YXRpb25zKHBhZ2VJbmRleCwgaW50ZW50KSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldEFubm90YXRpb25zIiwgewogICAgICBwYWdlSW5kZXgsCiAgICAgIGludGVudAogICAgfSk7CiAgfQogIGdldEZpZWxkT2JqZWN0cygpIHsKICAgIHJldHVybiB0aGlzLiNjYWNoZVNpbXBsZU1ldGhvZCgiR2V0RmllbGRPYmplY3RzIik7CiAgfQogIGhhc0pTQWN0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLiNjYWNoZVNpbXBsZU1ldGhvZCgiSGFzSlNBY3Rpb25zIik7CiAgfQogIGdldENhbGN1bGF0aW9uT3JkZXJJZHMoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldENhbGN1bGF0aW9uT3JkZXJJZHMiLCBudWxsKTsKICB9CiAgZ2V0RGVzdGluYXRpb25zKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXREZXN0aW5hdGlvbnMiLCBudWxsKTsKICB9CiAgZ2V0RGVzdGluYXRpb24oaWQpIHsKICAgIGlmICh0eXBlb2YgaWQgIT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoIkludmFsaWQgZGVzdGluYXRpb24gcmVxdWVzdC4iKSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldERlc3RpbmF0aW9uIiwgewogICAgICBpZAogICAgfSk7CiAgfQogIGdldFBhZ2VMYWJlbHMoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldFBhZ2VMYWJlbHMiLCBudWxsKTsKICB9CiAgZ2V0UGFnZUxheW91dCgpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0UGFnZUxheW91dCIsIG51bGwpOwogIH0KICBnZXRQYWdlTW9kZSgpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0UGFnZU1vZGUiLCBudWxsKTsKICB9CiAgZ2V0Vmlld2VyUHJlZmVyZW5jZXMoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldFZpZXdlclByZWZlcmVuY2VzIiwgbnVsbCk7CiAgfQogIGdldE9wZW5BY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldE9wZW5BY3Rpb24iLCBudWxsKTsKICB9CiAgZ2V0QXR0YWNobWVudHMoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldEF0dGFjaG1lbnRzIiwgbnVsbCk7CiAgfQogIGdldEFubm90YXRpb25zQnlUeXBlKHR5cGVzLCBwYWdlSW5kZXhlc1RvU2tpcCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRBbm5vdGF0aW9uc0J5VHlwZSIsIHsKICAgICAgdHlwZXMsCiAgICAgIHBhZ2VJbmRleGVzVG9Ta2lwCiAgICB9KTsKICB9CiAgZ2V0RG9jSlNBY3Rpb25zKCkgewogICAgcmV0dXJuIHRoaXMuI2NhY2hlU2ltcGxlTWV0aG9kKCJHZXREb2NKU0FjdGlvbnMiKTsKICB9CiAgZ2V0UGFnZUpTQWN0aW9ucyhwYWdlSW5kZXgpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0UGFnZUpTQWN0aW9ucyIsIHsKICAgICAgcGFnZUluZGV4CiAgICB9KTsKICB9CiAgZ2V0U3RydWN0VHJlZShwYWdlSW5kZXgpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0U3RydWN0VHJlZSIsIHsKICAgICAgcGFnZUluZGV4CiAgICB9KTsKICB9CiAgZ2V0T3V0bGluZSgpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0T3V0bGluZSIsIG51bGwpOwogIH0KICBnZXRPcHRpb25hbENvbnRlbnRDb25maWcocmVuZGVyaW5nSW50ZW50KSB7CiAgICByZXR1cm4gdGhpcy4jY2FjaGVTaW1wbGVNZXRob2QoIkdldE9wdGlvbmFsQ29udGVudENvbmZpZyIpLnRoZW4oKGRhdGEpID0+IG5ldyBPcHRpb25hbENvbnRlbnRDb25maWcoZGF0YSwgcmVuZGVyaW5nSW50ZW50KSk7CiAgfQogIGdldFBlcm1pc3Npb25zKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRQZXJtaXNzaW9ucyIsIG51bGwpOwogIH0KICBnZXRNZXRhZGF0YSgpIHsKICAgIGNvbnN0IG5hbWUgPSAiR2V0TWV0YWRhdGEiLCBjYWNoZWRQcm9taXNlID0gdGhpcy4jbWV0aG9kUHJvbWlzZXMuZ2V0KG5hbWUpOwogICAgaWYgKGNhY2hlZFByb21pc2UpIHsKICAgICAgcmV0dXJuIGNhY2hlZFByb21pc2U7CiAgICB9CiAgICBjb25zdCBwcm9taXNlID0gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UobmFtZSwgbnVsbCkudGhlbigocmVzdWx0cykgPT4gKHsKICAgICAgaW5mbzogcmVzdWx0c1swXSwKICAgICAgbWV0YWRhdGE6IHJlc3VsdHNbMV0gPyBuZXcgTWV0YWRhdGEocmVzdWx0c1sxXSkgOiBudWxsLAogICAgICBjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZTogdGhpcy5fZnVsbFJlYWRlcj8uZmlsZW5hbWUgPz8gbnVsbCwKICAgICAgY29udGVudExlbmd0aDogdGhpcy5fZnVsbFJlYWRlcj8uY29udGVudExlbmd0aCA/PyBudWxsLAogICAgICBoYXNTdHJ1Y3RUcmVlOiByZXN1bHRzWzJdCiAgICB9KSk7CiAgICB0aGlzLiNtZXRob2RQcm9taXNlcy5zZXQobmFtZSwgcHJvbWlzZSk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CiAgZ2V0TWFya0luZm8oKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldE1hcmtJbmZvIiwgbnVsbCk7CiAgfQogIGFzeW5jIHN0YXJ0Q2xlYW51cChrZWVwTG9hZGVkRm9udHMgPSBmYWxzZSkgewogICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGF3YWl0IHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJDbGVhbnVwIiwgbnVsbCk7CiAgICBmb3IgKGNvbnN0IHBhZ2Ugb2YgdGhpcy4jcGFnZUNhY2hlLnZhbHVlcygpKSB7CiAgICAgIGNvbnN0IGNsZWFudXBTdWNjZXNzZnVsID0gcGFnZS5jbGVhbnVwKCk7CiAgICAgIGlmICghY2xlYW51cFN1Y2Nlc3NmdWwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHN0YXJ0Q2xlYW51cDogUGFnZSAke3BhZ2UucGFnZU51bWJlcn0gaXMgY3VycmVudGx5IHJlbmRlcmluZy5gKTsKICAgICAgfQogICAgfQogICAgdGhpcy5jb21tb25PYmpzLmNsZWFyKCk7CiAgICBpZiAoIWtlZXBMb2FkZWRGb250cykgewogICAgICB0aGlzLmZvbnRMb2FkZXIuY2xlYXIoKTsKICAgIH0KICAgIHRoaXMuI21ldGhvZFByb21pc2VzLmNsZWFyKCk7CiAgICB0aGlzLmZpbHRlckZhY3RvcnkuZGVzdHJveSh0cnVlKTsKICAgIFRleHRMYXllci5jbGVhbnVwKCk7CiAgfQogIGNhY2hlZFBhZ2VOdW1iZXIocmVmKSB7CiAgICBpZiAoIWlzUmVmUHJveHkocmVmKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHJlZlN0ciA9IHJlZi5nZW4gPT09IDAgPyBgJHtyZWYubnVtfVJgIDogYCR7cmVmLm51bX1SJHtyZWYuZ2VufWA7CiAgICByZXR1cm4gdGhpcy4jcGFnZVJlZkNhY2hlLmdldChyZWZTdHIpID8/IG51bGw7CiAgfQp9Owp2YXIgUmVuZGVyVGFzayA9IGNsYXNzIHsKICAjaW50ZXJuYWxSZW5kZXJUYXNrID0gbnVsbDsKICBvbkNvbnRpbnVlID0gbnVsbDsKICBvbkVycm9yID0gbnVsbDsKICBjb25zdHJ1Y3RvcihpbnRlcm5hbFJlbmRlclRhc2spIHsKICAgIHRoaXMuI2ludGVybmFsUmVuZGVyVGFzayA9IGludGVybmFsUmVuZGVyVGFzazsKICB9CiAgZ2V0IHByb21pc2UoKSB7CiAgICByZXR1cm4gdGhpcy4jaW50ZXJuYWxSZW5kZXJUYXNrLmNhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgY2FuY2VsKGV4dHJhRGVsYXkgPSAwKSB7CiAgICB0aGlzLiNpbnRlcm5hbFJlbmRlclRhc2suY2FuY2VsKG51bGwsIGV4dHJhRGVsYXkpOwogIH0KICBnZXQgc2VwYXJhdGVBbm5vdHMoKSB7CiAgICBjb25zdCB7CiAgICAgIHNlcGFyYXRlQW5ub3RzCiAgICB9ID0gdGhpcy4jaW50ZXJuYWxSZW5kZXJUYXNrLm9wZXJhdG9yTGlzdDsKICAgIGlmICghc2VwYXJhdGVBbm5vdHMpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3QgewogICAgICBhbm5vdGF0aW9uQ2FudmFzTWFwCiAgICB9ID0gdGhpcy4jaW50ZXJuYWxSZW5kZXJUYXNrOwogICAgcmV0dXJuIHNlcGFyYXRlQW5ub3RzLmZvcm0gfHwgc2VwYXJhdGVBbm5vdHMuY2FudmFzICYmIGFubm90YXRpb25DYW52YXNNYXA/LnNpemUgPiAwOwogIH0KfTsKdmFyIEludGVybmFsUmVuZGVyVGFzayA9IGNsYXNzIF9JbnRlcm5hbFJlbmRlclRhc2sgewogICNyQUYgPSBudWxsOwogIHN0YXRpYyAjY2FudmFzSW5Vc2UgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICBjb25zdHJ1Y3Rvcih7CiAgICBjYWxsYmFjaywKICAgIHBhcmFtcywKICAgIG9ianMsCiAgICBjb21tb25PYmpzLAogICAgYW5ub3RhdGlvbkNhbnZhc01hcCwKICAgIG9wZXJhdG9yTGlzdCwKICAgIHBhZ2VJbmRleCwKICAgIGNhbnZhc0ZhY3RvcnksCiAgICBmaWx0ZXJGYWN0b3J5LAogICAgdXNlUmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZmFsc2UsCiAgICBwZGZCdWcgPSBmYWxzZSwKICAgIHBhZ2VDb2xvcnMgPSBudWxsLAogICAgZW5hYmxlSFdBID0gZmFsc2UsCiAgICBvcGVyYXRpb25zRmlsdGVyID0gbnVsbAogIH0pIHsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgdGhpcy5vYmpzID0gb2JqczsKICAgIHRoaXMuY29tbW9uT2JqcyA9IGNvbW1vbk9ianM7CiAgICB0aGlzLmFubm90YXRpb25DYW52YXNNYXAgPSBhbm5vdGF0aW9uQ2FudmFzTWFwOwogICAgdGhpcy5vcGVyYXRvckxpc3RJZHggPSBudWxsOwogICAgdGhpcy5vcGVyYXRvckxpc3QgPSBvcGVyYXRvckxpc3Q7CiAgICB0aGlzLl9wYWdlSW5kZXggPSBwYWdlSW5kZXg7CiAgICB0aGlzLmNhbnZhc0ZhY3RvcnkgPSBjYW52YXNGYWN0b3J5OwogICAgdGhpcy5maWx0ZXJGYWN0b3J5ID0gZmlsdGVyRmFjdG9yeTsKICAgIHRoaXMuX3BkZkJ1ZyA9IHBkZkJ1ZzsKICAgIHRoaXMucGFnZUNvbG9ycyA9IHBhZ2VDb2xvcnM7CiAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKICAgIHRoaXMuZ3JhcGhpY3NSZWFkeUNhbGxiYWNrID0gbnVsbDsKICAgIHRoaXMuZ3JhcGhpY3NSZWFkeSA9IGZhbHNlOwogICAgdGhpcy5fdXNlUmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gdXNlUmVxdWVzdEFuaW1hdGlvbkZyYW1lID09PSB0cnVlICYmIHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiOwogICAgdGhpcy5jYW5jZWxsZWQgPSBmYWxzZTsKICAgIHRoaXMuY2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy50YXNrID0gbmV3IFJlbmRlclRhc2sodGhpcyk7CiAgICB0aGlzLl9jYW5jZWxCb3VuZCA9IHRoaXMuY2FuY2VsLmJpbmQodGhpcyk7CiAgICB0aGlzLl9jb250aW51ZUJvdW5kID0gdGhpcy5fY29udGludWUuYmluZCh0aGlzKTsKICAgIHRoaXMuX3NjaGVkdWxlTmV4dEJvdW5kID0gdGhpcy5fc2NoZWR1bGVOZXh0LmJpbmQodGhpcyk7CiAgICB0aGlzLl9uZXh0Qm91bmQgPSB0aGlzLl9uZXh0LmJpbmQodGhpcyk7CiAgICB0aGlzLl9jYW52YXMgPSBwYXJhbXMuY2FudmFzOwogICAgdGhpcy5fY2FudmFzQ29udGV4dCA9IHBhcmFtcy5jYW52YXMgPyBudWxsIDogcGFyYW1zLmNhbnZhc0NvbnRleHQ7CiAgICB0aGlzLl9lbmFibGVIV0EgPSBlbmFibGVIV0E7CiAgICB0aGlzLl9kZXBlbmRlbmN5VHJhY2tlciA9IHBhcmFtcy5kZXBlbmRlbmN5VHJhY2tlcjsKICAgIHRoaXMuX29wZXJhdGlvbnNGaWx0ZXIgPSBvcGVyYXRpb25zRmlsdGVyOwogIH0KICBnZXQgY29tcGxldGVkKCkgewogICAgcmV0dXJuIHRoaXMuY2FwYWJpbGl0eS5wcm9taXNlLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgfSk7CiAgfQogIGluaXRpYWxpemVHcmFwaGljcyh7CiAgICB0cmFuc3BhcmVuY3kgPSBmYWxzZSwKICAgIG9wdGlvbmFsQ29udGVudENvbmZpZwogIH0pIHsKICAgIGlmICh0aGlzLmNhbmNlbGxlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5fY2FudmFzKSB7CiAgICAgIGlmIChfSW50ZXJuYWxSZW5kZXJUYXNrLiNjYW52YXNJblVzZS5oYXModGhpcy5fY2FudmFzKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVzZSB0aGUgc2FtZSBjYW52YXMgZHVyaW5nIG11bHRpcGxlIHJlbmRlcigpIG9wZXJhdGlvbnMuIFVzZSBkaWZmZXJlbnQgY2FudmFzIG9yIGVuc3VyZSBwcmV2aW91cyBvcGVyYXRpb25zIHdlcmUgY2FuY2VsbGVkIG9yIGNvbXBsZXRlZC4iKTsKICAgICAgfQogICAgICBfSW50ZXJuYWxSZW5kZXJUYXNrLiNjYW52YXNJblVzZS5hZGQodGhpcy5fY2FudmFzKTsKICAgIH0KICAgIGlmICh0aGlzLl9wZGZCdWcgJiYgZ2xvYmFsVGhpcy5TdGVwcGVyTWFuYWdlcj8uZW5hYmxlZCkgewogICAgICB0aGlzLnN0ZXBwZXIgPSBnbG9iYWxUaGlzLlN0ZXBwZXJNYW5hZ2VyLmNyZWF0ZSh0aGlzLl9wYWdlSW5kZXgpOwogICAgICB0aGlzLnN0ZXBwZXIuaW5pdCh0aGlzLm9wZXJhdG9yTGlzdCk7CiAgICAgIHRoaXMuc3RlcHBlci5uZXh0QnJlYWtQb2ludCA9IHRoaXMuc3RlcHBlci5nZXROZXh0QnJlYWtQb2ludCgpOwogICAgfQogICAgY29uc3QgewogICAgICB2aWV3cG9ydCwKICAgICAgdHJhbnNmb3JtLAogICAgICBiYWNrZ3JvdW5kLAogICAgICBkZXBlbmRlbmN5VHJhY2tlcgogICAgfSA9IHRoaXMucGFyYW1zOwogICAgY29uc3QgY2FudmFzQ29udGV4dCA9IHRoaXMuX2NhbnZhc0NvbnRleHQgfHwgdGhpcy5fY2FudmFzLmdldENvbnRleHQoIjJkIiwgewogICAgICBhbHBoYTogZmFsc2UsCiAgICAgIHdpbGxSZWFkRnJlcXVlbnRseTogIXRoaXMuX2VuYWJsZUhXQQogICAgfSk7CiAgICB0aGlzLmdmeCA9IG5ldyBDYW52YXNHcmFwaGljcyhjYW52YXNDb250ZXh0LCB0aGlzLmNvbW1vbk9ianMsIHRoaXMub2JqcywgdGhpcy5jYW52YXNGYWN0b3J5LCB0aGlzLmZpbHRlckZhY3RvcnksIHsKICAgICAgb3B0aW9uYWxDb250ZW50Q29uZmlnCiAgICB9LCB0aGlzLmFubm90YXRpb25DYW52YXNNYXAsIHRoaXMucGFnZUNvbG9ycywgZGVwZW5kZW5jeVRyYWNrZXIpOwogICAgdGhpcy5nZnguYmVnaW5EcmF3aW5nKHsKICAgICAgdHJhbnNmb3JtLAogICAgICB2aWV3cG9ydCwKICAgICAgdHJhbnNwYXJlbmN5LAogICAgICBiYWNrZ3JvdW5kCiAgICB9KTsKICAgIHRoaXMub3BlcmF0b3JMaXN0SWR4ID0gMDsKICAgIHRoaXMuZ3JhcGhpY3NSZWFkeSA9IHRydWU7CiAgICB0aGlzLmdyYXBoaWNzUmVhZHlDYWxsYmFjaz8uKCk7CiAgfQogIGNhbmNlbChlcnJvciA9IG51bGwsIGV4dHJhRGVsYXkgPSAwKSB7CiAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKICAgIHRoaXMuY2FuY2VsbGVkID0gdHJ1ZTsKICAgIHRoaXMuZ2Z4Py5lbmREcmF3aW5nKCk7CiAgICBpZiAodGhpcy4jckFGKSB7CiAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLiNyQUYpOwogICAgICB0aGlzLiNyQUYgPSBudWxsOwogICAgfQogICAgX0ludGVybmFsUmVuZGVyVGFzay4jY2FudmFzSW5Vc2UuZGVsZXRlKHRoaXMuX2NhbnZhcyk7CiAgICBlcnJvciB8fD0gbmV3IFJlbmRlcmluZ0NhbmNlbGxlZEV4Y2VwdGlvbihgUmVuZGVyaW5nIGNhbmNlbGxlZCwgcGFnZSAke3RoaXMuX3BhZ2VJbmRleCArIDF9YCwgZXh0cmFEZWxheSk7CiAgICB0aGlzLmNhbGxiYWNrKGVycm9yKTsKICAgIHRoaXMudGFzay5vbkVycm9yPy4oZXJyb3IpOwogIH0KICBvcGVyYXRvckxpc3RDaGFuZ2VkKCkgewogICAgaWYgKCF0aGlzLmdyYXBoaWNzUmVhZHkpIHsKICAgICAgdGhpcy5ncmFwaGljc1JlYWR5Q2FsbGJhY2sgfHw9IHRoaXMuX2NvbnRpbnVlQm91bmQ7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuZ2Z4LmRlcGVuZGVuY3lUcmFja2VyPy5ncm93T3BlcmF0aW9uc0NvdW50KHRoaXMub3BlcmF0b3JMaXN0LmZuQXJyYXkubGVuZ3RoKTsKICAgIHRoaXMuc3RlcHBlcj8udXBkYXRlT3BlcmF0b3JMaXN0KHRoaXMub3BlcmF0b3JMaXN0KTsKICAgIGlmICh0aGlzLnJ1bm5pbmcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fY29udGludWUoKTsKICB9CiAgX2NvbnRpbnVlKCkgewogICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTsKICAgIGlmICh0aGlzLmNhbmNlbGxlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy50YXNrLm9uQ29udGludWUpIHsKICAgICAgdGhpcy50YXNrLm9uQ29udGludWUodGhpcy5fc2NoZWR1bGVOZXh0Qm91bmQpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fc2NoZWR1bGVOZXh0KCk7CiAgICB9CiAgfQogIF9zY2hlZHVsZU5leHQoKSB7CiAgICBpZiAodGhpcy5fdXNlUmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7CiAgICAgIHRoaXMuI3JBRiA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICAgIHRoaXMuI3JBRiA9IG51bGw7CiAgICAgICAgdGhpcy5fbmV4dEJvdW5kKCkuY2F0Y2godGhpcy5fY2FuY2VsQm91bmQpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4odGhpcy5fbmV4dEJvdW5kKS5jYXRjaCh0aGlzLl9jYW5jZWxCb3VuZCk7CiAgICB9CiAgfQogIGFzeW5jIF9uZXh0KCkgewogICAgaWYgKHRoaXMuY2FuY2VsbGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMub3BlcmF0b3JMaXN0SWR4ID0gdGhpcy5nZnguZXhlY3V0ZU9wZXJhdG9yTGlzdCh0aGlzLm9wZXJhdG9yTGlzdCwgdGhpcy5vcGVyYXRvckxpc3RJZHgsIHRoaXMuX2NvbnRpbnVlQm91bmQsIHRoaXMuc3RlcHBlciwgdGhpcy5fb3BlcmF0aW9uc0ZpbHRlcik7CiAgICBpZiAodGhpcy5vcGVyYXRvckxpc3RJZHggPT09IHRoaXMub3BlcmF0b3JMaXN0LmFyZ3NBcnJheS5sZW5ndGgpIHsKICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7CiAgICAgIGlmICh0aGlzLm9wZXJhdG9yTGlzdC5sYXN0Q2h1bmspIHsKICAgICAgICB0aGlzLmdmeC5lbmREcmF3aW5nKCk7CiAgICAgICAgX0ludGVybmFsUmVuZGVyVGFzay4jY2FudmFzSW5Vc2UuZGVsZXRlKHRoaXMuX2NhbnZhcyk7CiAgICAgICAgdGhpcy5jYWxsYmFjaygpOwogICAgICB9CiAgICB9CiAgfQp9Owp2YXIgdmVyc2lvbiA9ICI1LjQuNTMwIjsKdmFyIGJ1aWxkID0gIjUwY2M0YWRhYyI7CnZhciBDb2xvclBpY2tlciA9IGNsYXNzIF9Db2xvclBpY2tlciB7CiAgI2J1dHRvbiA9IG51bGw7CiAgI2J1dHRvblN3YXRjaCA9IG51bGw7CiAgI2RlZmF1bHRDb2xvcjsKICAjZHJvcGRvd24gPSBudWxsOwogICNkcm9wZG93bldhc0Zyb21LZXlib2FyZCA9IGZhbHNlOwogICNpc01haW5Db2xvclBpY2tlciA9IGZhbHNlOwogICNlZGl0b3IgPSBudWxsOwogICNldmVudEJ1czsKICAjb3BlbkRyb3Bkb3duQUMgPSBudWxsOwogICN1aU1hbmFnZXIgPSBudWxsOwogIHN0YXRpYyAjbDEwbkNvbG9yID0gbnVsbDsKICBzdGF0aWMgZ2V0IF9rZXlib2FyZE1hbmFnZXIoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfa2V5Ym9hcmRNYW5hZ2VyIiwgbmV3IEtleWJvYXJkTWFuYWdlcihbW1siRXNjYXBlIiwgIm1hYytFc2NhcGUiXSwgX0NvbG9yUGlja2VyLnByb3RvdHlwZS5faGlkZURyb3Bkb3duRnJvbUtleWJvYXJkXSwgW1siICIsICJtYWMrICJdLCBfQ29sb3JQaWNrZXIucHJvdG90eXBlLl9jb2xvclNlbGVjdEZyb21LZXlib2FyZF0sIFtbIkFycm93RG93biIsICJBcnJvd1JpZ2h0IiwgIm1hYytBcnJvd0Rvd24iLCAibWFjK0Fycm93UmlnaHQiXSwgX0NvbG9yUGlja2VyLnByb3RvdHlwZS5fbW92ZVRvTmV4dF0sIFtbIkFycm93VXAiLCAiQXJyb3dMZWZ0IiwgIm1hYytBcnJvd1VwIiwgIm1hYytBcnJvd0xlZnQiXSwgX0NvbG9yUGlja2VyLnByb3RvdHlwZS5fbW92ZVRvUHJldmlvdXNdLCBbWyJIb21lIiwgIm1hYytIb21lIl0sIF9Db2xvclBpY2tlci5wcm90b3R5cGUuX21vdmVUb0JlZ2lubmluZ10sIFtbIkVuZCIsICJtYWMrRW5kIl0sIF9Db2xvclBpY2tlci5wcm90b3R5cGUuX21vdmVUb0VuZF1dKSk7CiAgfQogIGNvbnN0cnVjdG9yKHsKICAgIGVkaXRvciA9IG51bGwsCiAgICB1aU1hbmFnZXIgPSBudWxsCiAgfSkgewogICAgaWYgKGVkaXRvcikgewogICAgICB0aGlzLiNpc01haW5Db2xvclBpY2tlciA9IGZhbHNlOwogICAgICB0aGlzLiNlZGl0b3IgPSBlZGl0b3I7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNpc01haW5Db2xvclBpY2tlciA9IHRydWU7CiAgICB9CiAgICB0aGlzLiN1aU1hbmFnZXIgPSBlZGl0b3I/Ll91aU1hbmFnZXIgfHwgdWlNYW5hZ2VyOwogICAgdGhpcy4jZXZlbnRCdXMgPSB0aGlzLiN1aU1hbmFnZXIuX2V2ZW50QnVzOwogICAgdGhpcy4jZGVmYXVsdENvbG9yID0gZWRpdG9yPy5jb2xvcj8udG9VcHBlckNhc2UoKSB8fCB0aGlzLiN1aU1hbmFnZXI/LmhpZ2hsaWdodENvbG9ycy52YWx1ZXMoKS5uZXh0KCkudmFsdWUgfHwgIiNGRkZGOTgiOwogICAgX0NvbG9yUGlja2VyLiNsMTBuQ29sb3IgfHw9IE9iamVjdC5mcmVlemUoewogICAgICBibHVlOiAicGRmanMtZWRpdG9yLWNvbG9ycGlja2VyLWJsdWUiLAogICAgICBncmVlbjogInBkZmpzLWVkaXRvci1jb2xvcnBpY2tlci1ncmVlbiIsCiAgICAgIHBpbms6ICJwZGZqcy1lZGl0b3ItY29sb3JwaWNrZXItcGluayIsCiAgICAgIHJlZDogInBkZmpzLWVkaXRvci1jb2xvcnBpY2tlci1yZWQiLAogICAgICB5ZWxsb3c6ICJwZGZqcy1lZGl0b3ItY29sb3JwaWNrZXIteWVsbG93IgogICAgfSk7CiAgfQogIHJlbmRlckJ1dHRvbigpIHsKICAgIGNvbnN0IGJ1dHRvbiA9IHRoaXMuI2J1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgYnV0dG9uLmNsYXNzTmFtZSA9ICJjb2xvclBpY2tlciI7CiAgICBidXR0b24udGFiSW5kZXggPSAiMCI7CiAgICBidXR0b24uc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCAicGRmanMtZWRpdG9yLWNvbG9ycGlja2VyLWJ1dHRvbiIpOwogICAgYnV0dG9uLmFyaWFIYXNQb3B1cCA9ICJ0cnVlIjsKICAgIGlmICh0aGlzLiNlZGl0b3IpIHsKICAgICAgYnV0dG9uLmFyaWFDb250cm9scyA9IGAke3RoaXMuI2VkaXRvci5pZH1fY29sb3JwaWNrZXJfZHJvcGRvd25gOwogICAgfQogICAgY29uc3Qgc2lnbmFsID0gdGhpcy4jdWlNYW5hZ2VyLl9zaWduYWw7CiAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLiNvcGVuRHJvcGRvd24uYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLiNrZXlEb3duLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGNvbnN0IHN3YXRjaCA9IHRoaXMuI2J1dHRvblN3YXRjaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIHN3YXRjaC5jbGFzc05hbWUgPSAic3dhdGNoIjsKICAgIHN3YXRjaC5hcmlhSGlkZGVuID0gInRydWUiOwogICAgc3dhdGNoLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHRoaXMuI2RlZmF1bHRDb2xvcjsKICAgIGJ1dHRvbi5hcHBlbmQoc3dhdGNoKTsKICAgIHJldHVybiBidXR0b247CiAgfQogIHJlbmRlck1haW5Ecm9wZG93bigpIHsKICAgIGNvbnN0IGRyb3Bkb3duID0gdGhpcy4jZHJvcGRvd24gPSB0aGlzLiNnZXREcm9wZG93blJvb3QoKTsKICAgIGRyb3Bkb3duLmFyaWFPcmllbnRhdGlvbiA9ICJob3Jpem9udGFsIjsKICAgIGRyb3Bkb3duLmFyaWFMYWJlbGxlZEJ5ID0gImhpZ2hsaWdodENvbG9yUGlja2VyTGFiZWwiOwogICAgcmV0dXJuIGRyb3Bkb3duOwogIH0KICAjZ2V0RHJvcGRvd25Sb290KCkgewogICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiN1aU1hbmFnZXIuX3NpZ25hbDsKICAgIGRpdi5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIG5vQ29udGV4dE1lbnUsIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGRpdi5jbGFzc05hbWUgPSAiZHJvcGRvd24iOwogICAgZGl2LnJvbGUgPSAibGlzdGJveCI7CiAgICBkaXYuYXJpYU11bHRpU2VsZWN0YWJsZSA9ICJmYWxzZSI7CiAgICBkaXYuYXJpYU9yaWVudGF0aW9uID0gInZlcnRpY2FsIjsKICAgIGRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1lZGl0b3ItY29sb3JwaWNrZXItZHJvcGRvd24iKTsKICAgIGlmICh0aGlzLiNlZGl0b3IpIHsKICAgICAgZGl2LmlkID0gYCR7dGhpcy4jZWRpdG9yLmlkfV9jb2xvcnBpY2tlcl9kcm9wZG93bmA7CiAgICB9CiAgICBmb3IgKGNvbnN0IFtuYW1lLCBjb2xvcl0gb2YgdGhpcy4jdWlNYW5hZ2VyLmhpZ2hsaWdodENvbG9ycykgewogICAgICBjb25zdCBidXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgICAgYnV0dG9uLnRhYkluZGV4ID0gIjAiOwogICAgICBidXR0b24ucm9sZSA9ICJvcHRpb24iOwogICAgICBidXR0b24uc2V0QXR0cmlidXRlKCJkYXRhLWNvbG9yIiwgY29sb3IpOwogICAgICBidXR0b24udGl0bGUgPSBuYW1lOwogICAgICBidXR0b24uc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCBfQ29sb3JQaWNrZXIuI2wxMG5Db2xvcltuYW1lXSk7CiAgICAgIGNvbnN0IHN3YXRjaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgYnV0dG9uLmFwcGVuZChzd2F0Y2gpOwogICAgICBzd2F0Y2guY2xhc3NOYW1lID0gInN3YXRjaCI7CiAgICAgIHN3YXRjaC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjsKICAgICAgYnV0dG9uLmFyaWFTZWxlY3RlZCA9IGNvbG9yID09PSB0aGlzLiNkZWZhdWx0Q29sb3I7CiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuI2NvbG9yU2VsZWN0LmJpbmQodGhpcywgY29sb3IpLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBkaXYuYXBwZW5kKGJ1dHRvbik7CiAgICB9CiAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuI2tleURvd24uYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgcmV0dXJuIGRpdjsKICB9CiAgI2NvbG9yU2VsZWN0KGNvbG9yLCBldmVudCkgewogICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICB0aGlzLiNldmVudEJ1cy5kaXNwYXRjaCgic3dpdGNoYW5ub3RhdGlvbmVkaXRvcnBhcmFtcyIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICB0eXBlOiBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfQ09MT1IsCiAgICAgIHZhbHVlOiBjb2xvcgogICAgfSk7CiAgICB0aGlzLnVwZGF0ZUNvbG9yKGNvbG9yKTsKICB9CiAgX2NvbG9yU2VsZWN0RnJvbUtleWJvYXJkKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSB0aGlzLiNidXR0b24pIHsKICAgICAgdGhpcy4jb3BlbkRyb3Bkb3duKGV2ZW50KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY29sb3IgPSBldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCJkYXRhLWNvbG9yIik7CiAgICBpZiAoIWNvbG9yKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvbG9yU2VsZWN0KGNvbG9yLCBldmVudCk7CiAgfQogIF9tb3ZlVG9OZXh0KGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuI2lzRHJvcGRvd25WaXNpYmxlKSB7CiAgICAgIHRoaXMuI29wZW5Ecm9wZG93bihldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChldmVudC50YXJnZXQgPT09IHRoaXMuI2J1dHRvbikgewogICAgICB0aGlzLiNkcm9wZG93bi5maXJzdEVsZW1lbnRDaGlsZD8uZm9jdXMoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgZXZlbnQudGFyZ2V0Lm5leHRTaWJsaW5nPy5mb2N1cygpOwogIH0KICBfbW92ZVRvUHJldmlvdXMoZXZlbnQpIHsKICAgIGlmIChldmVudC50YXJnZXQgPT09IHRoaXMuI2Ryb3Bkb3duPy5maXJzdEVsZW1lbnRDaGlsZCB8fCBldmVudC50YXJnZXQgPT09IHRoaXMuI2J1dHRvbikgewogICAgICBpZiAodGhpcy4jaXNEcm9wZG93blZpc2libGUpIHsKICAgICAgICB0aGlzLl9oaWRlRHJvcGRvd25Gcm9tS2V5Ym9hcmQoKTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI2lzRHJvcGRvd25WaXNpYmxlKSB7CiAgICAgIHRoaXMuI29wZW5Ecm9wZG93bihldmVudCk7CiAgICB9CiAgICBldmVudC50YXJnZXQucHJldmlvdXNTaWJsaW5nPy5mb2N1cygpOwogIH0KICBfbW92ZVRvQmVnaW5uaW5nKGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuI2lzRHJvcGRvd25WaXNpYmxlKSB7CiAgICAgIHRoaXMuI29wZW5Ecm9wZG93bihldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2Ryb3Bkb3duLmZpcnN0RWxlbWVudENoaWxkPy5mb2N1cygpOwogIH0KICBfbW92ZVRvRW5kKGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuI2lzRHJvcGRvd25WaXNpYmxlKSB7CiAgICAgIHRoaXMuI29wZW5Ecm9wZG93bihldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2Ryb3Bkb3duLmxhc3RFbGVtZW50Q2hpbGQ/LmZvY3VzKCk7CiAgfQogICNrZXlEb3duKGV2ZW50KSB7CiAgICBfQ29sb3JQaWNrZXIuX2tleWJvYXJkTWFuYWdlci5leGVjKHRoaXMsIGV2ZW50KTsKICB9CiAgI29wZW5Ecm9wZG93bihldmVudCkgewogICAgaWYgKHRoaXMuI2lzRHJvcGRvd25WaXNpYmxlKSB7CiAgICAgIHRoaXMuaGlkZURyb3Bkb3duKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2Ryb3Bkb3duV2FzRnJvbUtleWJvYXJkID0gZXZlbnQuZGV0YWlsID09PSAwOwogICAgaWYgKCF0aGlzLiNvcGVuRHJvcGRvd25BQykgewogICAgICB0aGlzLiNvcGVuRHJvcGRvd25BQyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgdGhpcy4jcG9pbnRlckRvd24uYmluZCh0aGlzKSwgewogICAgICAgIHNpZ25hbDogdGhpcy4jdWlNYW5hZ2VyLmNvbWJpbmVkU2lnbmFsKHRoaXMuI29wZW5Ecm9wZG93bkFDKQogICAgICB9KTsKICAgIH0KICAgIHRoaXMuI2J1dHRvbi5hcmlhRXhwYW5kZWQgPSAidHJ1ZSI7CiAgICBpZiAodGhpcy4jZHJvcGRvd24pIHsKICAgICAgdGhpcy4jZHJvcGRvd24uY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHJvb3QyID0gdGhpcy4jZHJvcGRvd24gPSB0aGlzLiNnZXREcm9wZG93blJvb3QoKTsKICAgIHRoaXMuI2J1dHRvbi5hcHBlbmQocm9vdDIpOwogIH0KICAjcG9pbnRlckRvd24oZXZlbnQpIHsKICAgIGlmICh0aGlzLiNkcm9wZG93bj8uY29udGFpbnMoZXZlbnQudGFyZ2V0KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmhpZGVEcm9wZG93bigpOwogIH0KICBoaWRlRHJvcGRvd24oKSB7CiAgICB0aGlzLiNkcm9wZG93bj8uY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7CiAgICB0aGlzLiNidXR0b24uYXJpYUV4cGFuZGVkID0gImZhbHNlIjsKICAgIHRoaXMuI29wZW5Ecm9wZG93bkFDPy5hYm9ydCgpOwogICAgdGhpcy4jb3BlbkRyb3Bkb3duQUMgPSBudWxsOwogIH0KICBnZXQgI2lzRHJvcGRvd25WaXNpYmxlKCkgewogICAgcmV0dXJuIHRoaXMuI2Ryb3Bkb3duICYmICF0aGlzLiNkcm9wZG93bi5jbGFzc0xpc3QuY29udGFpbnMoImhpZGRlbiIpOwogIH0KICBfaGlkZURyb3Bkb3duRnJvbUtleWJvYXJkKCkgewogICAgaWYgKHRoaXMuI2lzTWFpbkNvbG9yUGlja2VyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy4jaXNEcm9wZG93blZpc2libGUpIHsKICAgICAgdGhpcy4jZWRpdG9yPy51bnNlbGVjdCgpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmhpZGVEcm9wZG93bigpOwogICAgdGhpcy4jYnV0dG9uLmZvY3VzKHsKICAgICAgcHJldmVudFNjcm9sbDogdHJ1ZSwKICAgICAgZm9jdXNWaXNpYmxlOiB0aGlzLiNkcm9wZG93bldhc0Zyb21LZXlib2FyZAogICAgfSk7CiAgfQogIHVwZGF0ZUNvbG9yKGNvbG9yKSB7CiAgICBpZiAodGhpcy4jYnV0dG9uU3dhdGNoKSB7CiAgICAgIHRoaXMuI2J1dHRvblN3YXRjaC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjsKICAgIH0KICAgIGlmICghdGhpcy4jZHJvcGRvd24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaSA9IHRoaXMuI3VpTWFuYWdlci5oaWdobGlnaHRDb2xvcnMudmFsdWVzKCk7CiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuI2Ryb3Bkb3duLmNoaWxkcmVuKSB7CiAgICAgIGNoaWxkLmFyaWFTZWxlY3RlZCA9IGkubmV4dCgpLnZhbHVlID09PSBjb2xvci50b1VwcGVyQ2FzZSgpOwogICAgfQogIH0KICBkZXN0cm95KCkgewogICAgdGhpcy4jYnV0dG9uPy5yZW1vdmUoKTsKICAgIHRoaXMuI2J1dHRvbiA9IG51bGw7CiAgICB0aGlzLiNidXR0b25Td2F0Y2ggPSBudWxsOwogICAgdGhpcy4jZHJvcGRvd24/LnJlbW92ZSgpOwogICAgdGhpcy4jZHJvcGRvd24gPSBudWxsOwogIH0KfTsKdmFyIEJhc2ljQ29sb3JQaWNrZXIgPSBjbGFzcyBfQmFzaWNDb2xvclBpY2tlciB7CiAgI2lucHV0ID0gbnVsbDsKICAjZWRpdG9yID0gbnVsbDsKICAjdWlNYW5hZ2VyID0gbnVsbDsKICBzdGF0aWMgI2wxMG5Db2xvciA9IG51bGw7CiAgY29uc3RydWN0b3IoZWRpdG9yKSB7CiAgICB0aGlzLiNlZGl0b3IgPSBlZGl0b3I7CiAgICB0aGlzLiN1aU1hbmFnZXIgPSBlZGl0b3IuX3VpTWFuYWdlcjsKICAgIF9CYXNpY0NvbG9yUGlja2VyLiNsMTBuQ29sb3IgfHw9IE9iamVjdC5mcmVlemUoewogICAgICBmcmVldGV4dDogInBkZmpzLWVkaXRvci1jb2xvci1waWNrZXItZnJlZS10ZXh0LWlucHV0IiwKICAgICAgaW5rOiAicGRmanMtZWRpdG9yLWNvbG9yLXBpY2tlci1pbmstaW5wdXQiCiAgICB9KTsKICB9CiAgcmVuZGVyQnV0dG9uKCkgewogICAgaWYgKHRoaXMuI2lucHV0KSB7CiAgICAgIHJldHVybiB0aGlzLiNpbnB1dDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgZWRpdG9yVHlwZSwKICAgICAgY29sb3JUeXBlLAogICAgICBjb2xvcgogICAgfSA9IHRoaXMuI2VkaXRvcjsKICAgIGNvbnN0IGlucHV0ID0gdGhpcy4jaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgaW5wdXQudHlwZSA9ICJjb2xvciI7CiAgICBpbnB1dC52YWx1ZSA9IGNvbG9yIHx8ICIjMDAwMDAwIjsKICAgIGlucHV0LmNsYXNzTmFtZSA9ICJiYXNpY0NvbG9yUGlja2VyIjsKICAgIGlucHV0LnRhYkluZGV4ID0gMDsKICAgIGlucHV0LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0Jhc2ljQ29sb3JQaWNrZXIuI2wxMG5Db2xvcltlZGl0b3JUeXBlXSk7CiAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsICgpID0+IHsKICAgICAgdGhpcy4jdWlNYW5hZ2VyLnVwZGF0ZVBhcmFtcyhjb2xvclR5cGUsIGlucHV0LnZhbHVlKTsKICAgIH0sIHsKICAgICAgc2lnbmFsOiB0aGlzLiN1aU1hbmFnZXIuX3NpZ25hbAogICAgfSk7CiAgICByZXR1cm4gaW5wdXQ7CiAgfQogIHVwZGF0ZSh2YWx1ZSkgewogICAgaWYgKCF0aGlzLiNpbnB1dCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNpbnB1dC52YWx1ZSA9IHZhbHVlOwogIH0KICBkZXN0cm95KCkgewogICAgdGhpcy4jaW5wdXQ/LnJlbW92ZSgpOwogICAgdGhpcy4jaW5wdXQgPSBudWxsOwogIH0KICBoaWRlRHJvcGRvd24oKSB7CiAgfQp9OwpmdW5jdGlvbiBtYWtlQ29sb3JDb21wKG4pIHsKICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBuKSkgKiAyNTUpLnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCAiMCIpOwp9CmZ1bmN0aW9uIHNjYWxlQW5kQ2xhbXAoeCkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigyNTUsIDI1NSAqIHgpKTsKfQp2YXIgQ29sb3JDb252ZXJ0ZXJzID0gY2xhc3MgewogIHN0YXRpYyBDTVlLX0coW2MsIHksIG0sIGtdKSB7CiAgICByZXR1cm4gWyJHIiwgMSAtIE1hdGgubWluKDEsIDAuMyAqIGMgKyAwLjU5ICogbSArIDAuMTEgKiB5ICsgayldOwogIH0KICBzdGF0aWMgR19DTVlLKFtnXSkgewogICAgcmV0dXJuIFsiQ01ZSyIsIDAsIDAsIDAsIDEgLSBnXTsKICB9CiAgc3RhdGljIEdfUkdCKFtnXSkgewogICAgcmV0dXJuIFsiUkdCIiwgZywgZywgZ107CiAgfQogIHN0YXRpYyBHX3JnYihbZ10pIHsKICAgIGcgPSBzY2FsZUFuZENsYW1wKGcpOwogICAgcmV0dXJuIFtnLCBnLCBnXTsKICB9CiAgc3RhdGljIEdfSFRNTChbZ10pIHsKICAgIGNvbnN0IEcgPSBtYWtlQ29sb3JDb21wKGcpOwogICAgcmV0dXJuIGAjJHtHfSR7R30ke0d9YDsKICB9CiAgc3RhdGljIFJHQl9HKFtyLCBnLCBiXSkgewogICAgcmV0dXJuIFsiRyIsIDAuMyAqIHIgKyAwLjU5ICogZyArIDAuMTEgKiBiXTsKICB9CiAgc3RhdGljIFJHQl9yZ2IoY29sb3IpIHsKICAgIHJldHVybiBjb2xvci5tYXAoc2NhbGVBbmRDbGFtcCk7CiAgfQogIHN0YXRpYyBSR0JfSFRNTChjb2xvcikgewogICAgcmV0dXJuIGAjJHtjb2xvci5tYXAobWFrZUNvbG9yQ29tcCkuam9pbigiIil9YDsKICB9CiAgc3RhdGljIFRfSFRNTCgpIHsKICAgIHJldHVybiAiIzAwMDAwMDAwIjsKICB9CiAgc3RhdGljIFRfcmdiKCkgewogICAgcmV0dXJuIFtudWxsXTsKICB9CiAgc3RhdGljIENNWUtfUkdCKFtjLCB5LCBtLCBrXSkgewogICAgcmV0dXJuIFsiUkdCIiwgMSAtIE1hdGgubWluKDEsIGMgKyBrKSwgMSAtIE1hdGgubWluKDEsIG0gKyBrKSwgMSAtIE1hdGgubWluKDEsIHkgKyBrKV07CiAgfQogIHN0YXRpYyBDTVlLX3JnYihbYywgeSwgbSwga10pIHsKICAgIHJldHVybiBbc2NhbGVBbmRDbGFtcCgxIC0gTWF0aC5taW4oMSwgYyArIGspKSwgc2NhbGVBbmRDbGFtcCgxIC0gTWF0aC5taW4oMSwgbSArIGspKSwgc2NhbGVBbmRDbGFtcCgxIC0gTWF0aC5taW4oMSwgeSArIGspKV07CiAgfQogIHN0YXRpYyBDTVlLX0hUTUwoY29tcG9uZW50cykgewogICAgY29uc3QgcmdiID0gdGhpcy5DTVlLX1JHQihjb21wb25lbnRzKS5zbGljZSgxKTsKICAgIHJldHVybiB0aGlzLlJHQl9IVE1MKHJnYik7CiAgfQogIHN0YXRpYyBSR0JfQ01ZSyhbciwgZywgYl0pIHsKICAgIGNvbnN0IGMgPSAxIC0gcjsKICAgIGNvbnN0IG0gPSAxIC0gZzsKICAgIGNvbnN0IHkgPSAxIC0gYjsKICAgIGNvbnN0IGsgPSBNYXRoLm1pbihjLCBtLCB5KTsKICAgIHJldHVybiBbIkNNWUsiLCBjLCBtLCB5LCBrXTsKICB9Cn07CnZhciBCYXNlU1ZHRmFjdG9yeSA9IGNsYXNzIHsKICBjcmVhdGUod2lkdGgsIGhlaWdodCwgc2tpcERpbWVuc2lvbnMgPSBmYWxzZSkgewogICAgaWYgKHdpZHRoIDw9IDAgfHwgaGVpZ2h0IDw9IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIFNWRyBkaW1lbnNpb25zIik7CiAgICB9CiAgICBjb25zdCBzdmcgPSB0aGlzLl9jcmVhdGVTVkcoInN2ZzpzdmciKTsKICAgIHN2Zy5zZXRBdHRyaWJ1dGUoInZlcnNpb24iLCAiMS4xIik7CiAgICBpZiAoIXNraXBEaW1lbnNpb25zKSB7CiAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoIndpZHRoIiwgYCR7d2lkdGh9cHhgKTsKICAgICAgc3ZnLnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgYCR7aGVpZ2h0fXB4YCk7CiAgICB9CiAgICBzdmcuc2V0QXR0cmlidXRlKCJwcmVzZXJ2ZUFzcGVjdFJhdGlvIiwgIm5vbmUiKTsKICAgIHN2Zy5zZXRBdHRyaWJ1dGUoInZpZXdCb3giLCBgMCAwICR7d2lkdGh9ICR7aGVpZ2h0fWApOwogICAgcmV0dXJuIHN2ZzsKICB9CiAgY3JlYXRlRWxlbWVudCh0eXBlKSB7CiAgICBpZiAodHlwZW9mIHR5cGUgIT09ICJzdHJpbmciKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBTVkcgZWxlbWVudCB0eXBlIik7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fY3JlYXRlU1ZHKHR5cGUpOwogIH0KICBfY3JlYXRlU1ZHKHR5cGUpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgYF9jcmVhdGVTVkdgIGNhbGxlZC4iKTsKICB9Cn07CnZhciBET01TVkdGYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlU1ZHRmFjdG9yeSB7CiAgX2NyZWF0ZVNWRyh0eXBlKSB7CiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgdHlwZSk7CiAgfQp9Owp2YXIgYW5ub3RhdGlvbl9sYXllcl9ERUZBVUxUX0ZPTlRfU0laRSA9IDk7CnZhciBHZXRFbGVtZW50c0J5TmFtZVNldCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwp2YXIgVElNRVpPTkVfT0ZGU0VUID0gKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lem9uZU9mZnNldCgpICogNjAgKiAxZTM7CnZhciBBbm5vdGF0aW9uRWxlbWVudEZhY3RvcnkgPSBjbGFzcyB7CiAgc3RhdGljIGNyZWF0ZShwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBzdWJ0eXBlID0gcGFyYW1ldGVycy5kYXRhLmFubm90YXRpb25UeXBlOwogICAgc3dpdGNoIChzdWJ0eXBlKSB7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuTElOSzoKICAgICAgICByZXR1cm4gbmV3IExpbmtBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5URVhUOgogICAgICAgIHJldHVybiBuZXcgVGV4dEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLldJREdFVDoKICAgICAgICBjb25zdCBmaWVsZFR5cGUgPSBwYXJhbWV0ZXJzLmRhdGEuZmllbGRUeXBlOwogICAgICAgIHN3aXRjaCAoZmllbGRUeXBlKSB7CiAgICAgICAgICBjYXNlICJUeCI6CiAgICAgICAgICAgIHJldHVybiBuZXcgVGV4dFdpZGdldEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICAgICAgY2FzZSAiQnRuIjoKICAgICAgICAgICAgaWYgKHBhcmFtZXRlcnMuZGF0YS5yYWRpb0J1dHRvbikgewogICAgICAgICAgICAgIHJldHVybiBuZXcgUmFkaW9CdXR0b25XaWRnZXRBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJhbWV0ZXJzLmRhdGEuY2hlY2tCb3gpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IENoZWNrYm94V2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBQdXNoQnV0dG9uV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgICAgICBjYXNlICJDaCI6CiAgICAgICAgICAgIHJldHVybiBuZXcgQ2hvaWNlV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgICAgICBjYXNlICJTaWciOgogICAgICAgICAgICByZXR1cm4gbmV3IFNpZ25hdHVyZVdpZGdldEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IFdpZGdldEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLlBPUFVQOgogICAgICAgIHJldHVybiBuZXcgUG9wdXBBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5GUkVFVEVYVDoKICAgICAgICByZXR1cm4gbmV3IEZyZWVUZXh0QW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuTElORToKICAgICAgICByZXR1cm4gbmV3IExpbmVBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5TUVVBUkU6CiAgICAgICAgcmV0dXJuIG5ldyBTcXVhcmVBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5DSVJDTEU6CiAgICAgICAgcmV0dXJuIG5ldyBDaXJjbGVBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5QT0xZTElORToKICAgICAgICByZXR1cm4gbmV3IFBvbHlsaW5lQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuQ0FSRVQ6CiAgICAgICAgcmV0dXJuIG5ldyBDYXJldEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLklOSzoKICAgICAgICByZXR1cm4gbmV3IElua0Fubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLlBPTFlHT046CiAgICAgICAgcmV0dXJuIG5ldyBQb2x5Z29uQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuSElHSExJR0hUOgogICAgICAgIHJldHVybiBuZXcgSGlnaGxpZ2h0QW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuVU5ERVJMSU5FOgogICAgICAgIHJldHVybiBuZXcgVW5kZXJsaW5lQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuU1FVSUdHTFk6CiAgICAgICAgcmV0dXJuIG5ldyBTcXVpZ2dseUFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLlNUUklLRU9VVDoKICAgICAgICByZXR1cm4gbmV3IFN0cmlrZU91dEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLlNUQU1QOgogICAgICAgIHJldHVybiBuZXcgU3RhbXBBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5GSUxFQVRUQUNITUVOVDoKICAgICAgICByZXR1cm4gbmV3IEZpbGVBdHRhY2htZW50QW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIG5ldyBBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgIH0KICB9Cn07CnZhciBBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIF9Bbm5vdGF0aW9uRWxlbWVudCB7CiAgI3VwZGF0ZXMgPSBudWxsOwogICNoYXNCb3JkZXIgPSBmYWxzZTsKICAjcG9wdXBFbGVtZW50ID0gbnVsbDsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzLCB7CiAgICBpc1JlbmRlcmFibGUgPSBmYWxzZSwKICAgIGlnbm9yZUJvcmRlciA9IGZhbHNlLAogICAgY3JlYXRlUXVhZHJpbGF0ZXJhbHMgPSBmYWxzZQogIH0gPSB7fSkgewogICAgdGhpcy5pc1JlbmRlcmFibGUgPSBpc1JlbmRlcmFibGU7CiAgICB0aGlzLmRhdGEgPSBwYXJhbWV0ZXJzLmRhdGE7CiAgICB0aGlzLmxheWVyID0gcGFyYW1ldGVycy5sYXllcjsKICAgIHRoaXMubGlua1NlcnZpY2UgPSBwYXJhbWV0ZXJzLmxpbmtTZXJ2aWNlOwogICAgdGhpcy5kb3dubG9hZE1hbmFnZXIgPSBwYXJhbWV0ZXJzLmRvd25sb2FkTWFuYWdlcjsKICAgIHRoaXMuaW1hZ2VSZXNvdXJjZXNQYXRoID0gcGFyYW1ldGVycy5pbWFnZVJlc291cmNlc1BhdGg7CiAgICB0aGlzLnJlbmRlckZvcm1zID0gcGFyYW1ldGVycy5yZW5kZXJGb3JtczsKICAgIHRoaXMuc3ZnRmFjdG9yeSA9IHBhcmFtZXRlcnMuc3ZnRmFjdG9yeTsKICAgIHRoaXMuYW5ub3RhdGlvblN0b3JhZ2UgPSBwYXJhbWV0ZXJzLmFubm90YXRpb25TdG9yYWdlOwogICAgdGhpcy5lbmFibGVDb21tZW50ID0gcGFyYW1ldGVycy5lbmFibGVDb21tZW50OwogICAgdGhpcy5lbmFibGVTY3JpcHRpbmcgPSBwYXJhbWV0ZXJzLmVuYWJsZVNjcmlwdGluZzsKICAgIHRoaXMuaGFzSlNBY3Rpb25zID0gcGFyYW1ldGVycy5oYXNKU0FjdGlvbnM7CiAgICB0aGlzLl9maWVsZE9iamVjdHMgPSBwYXJhbWV0ZXJzLmZpZWxkT2JqZWN0czsKICAgIHRoaXMucGFyZW50ID0gcGFyYW1ldGVycy5wYXJlbnQ7CiAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSBmYWxzZTsKICAgIGlmIChpc1JlbmRlcmFibGUpIHsKICAgICAgdGhpcy5jb250ZW50RWxlbWVudCA9IHRoaXMuY29udGFpbmVyID0gdGhpcy5fY3JlYXRlQ29udGFpbmVyKGlnbm9yZUJvcmRlcik7CiAgICB9CiAgICBpZiAoY3JlYXRlUXVhZHJpbGF0ZXJhbHMpIHsKICAgICAgdGhpcy5fY3JlYXRlUXVhZHJpbGF0ZXJhbHMoKTsKICAgIH0KICB9CiAgc3RhdGljIF9oYXNQb3B1cERhdGEoewogICAgY29udGVudHNPYmosCiAgICByaWNoVGV4dAogIH0pIHsKICAgIHJldHVybiAhIShjb250ZW50c09iaj8uc3RyIHx8IHJpY2hUZXh0Py5zdHIpOwogIH0KICBnZXQgX2lzRWRpdGFibGUoKSB7CiAgICByZXR1cm4gdGhpcy5kYXRhLmlzRWRpdGFibGU7CiAgfQogIGdldCBoYXNQb3B1cERhdGEoKSB7CiAgICByZXR1cm4gX0Fubm90YXRpb25FbGVtZW50Ll9oYXNQb3B1cERhdGEodGhpcy5kYXRhKSB8fCB0aGlzLmVuYWJsZUNvbW1lbnQgJiYgISF0aGlzLmNvbW1lbnRUZXh0OwogIH0KICBnZXQgY29tbWVudERhdGEoKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGEKICAgIH0gPSB0aGlzOwogICAgY29uc3QgZWRpdG9yID0gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZT8uZ2V0RWRpdG9yKGRhdGEuaWQpOwogICAgaWYgKGVkaXRvcikgewogICAgICByZXR1cm4gZWRpdG9yLmdldERhdGEoKTsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICBnZXQgaGFzQ29tbWVudEJ1dHRvbigpIHsKICAgIHJldHVybiB0aGlzLmVuYWJsZUNvbW1lbnQgJiYgdGhpcy5oYXNQb3B1cEVsZW1lbnQ7CiAgfQogIGdldCBjb21tZW50QnV0dG9uUG9zaXRpb24oKSB7CiAgICBjb25zdCBlZGl0b3IgPSB0aGlzLmFubm90YXRpb25TdG9yYWdlPy5nZXRFZGl0b3IodGhpcy5kYXRhLmlkKTsKICAgIGlmIChlZGl0b3IpIHsKICAgICAgcmV0dXJuIGVkaXRvci5jb21tZW50QnV0dG9uUG9zaXRpb25JblBhZ2U7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHF1YWRQb2ludHMsCiAgICAgIGlua0xpc3RzLAogICAgICByZWN0CiAgICB9ID0gdGhpcy5kYXRhOwogICAgbGV0IG1heFggPSAtSW5maW5pdHk7CiAgICBsZXQgbWF4WSA9IC1JbmZpbml0eTsKICAgIGlmIChxdWFkUG9pbnRzPy5sZW5ndGggPj0gOCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHF1YWRQb2ludHMubGVuZ3RoOyBpICs9IDgpIHsKICAgICAgICBpZiAocXVhZFBvaW50c1tpICsgMV0gPiBtYXhZKSB7CiAgICAgICAgICBtYXhZID0gcXVhZFBvaW50c1tpICsgMV07CiAgICAgICAgICBtYXhYID0gcXVhZFBvaW50c1tpICsgMl07CiAgICAgICAgfSBlbHNlIGlmIChxdWFkUG9pbnRzW2kgKyAxXSA9PT0gbWF4WSkgewogICAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHF1YWRQb2ludHNbaSArIDJdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIFttYXhYLCBtYXhZXTsKICAgIH0KICAgIGlmIChpbmtMaXN0cz8ubGVuZ3RoID49IDEpIHsKICAgICAgZm9yIChjb25zdCBpbmtMaXN0IG9mIGlua0xpc3RzKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGlpID0gaW5rTGlzdC5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgICAgICBpZiAoaW5rTGlzdFtpICsgMV0gPiBtYXhZKSB7CiAgICAgICAgICAgIG1heFkgPSBpbmtMaXN0W2kgKyAxXTsKICAgICAgICAgICAgbWF4WCA9IGlua0xpc3RbaV07CiAgICAgICAgICB9IGVsc2UgaWYgKGlua0xpc3RbaSArIDFdID09PSBtYXhZKSB7CiAgICAgICAgICAgIG1heFggPSBNYXRoLm1heChtYXhYLCBpbmtMaXN0W2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG1heFggIT09IEluZmluaXR5KSB7CiAgICAgICAgcmV0dXJuIFttYXhYLCBtYXhZXTsKICAgICAgfQogICAgfQogICAgaWYgKHJlY3QpIHsKICAgICAgcmV0dXJuIFtyZWN0WzJdLCByZWN0WzNdXTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBfbm9ybWFsaXplUG9pbnQocG9pbnQpIHsKICAgIGNvbnN0IHsKICAgICAgcGFnZTogewogICAgICAgIHZpZXcKICAgICAgfSwKICAgICAgdmlld3BvcnQ6IHsKICAgICAgICByYXdEaW1zOiB7CiAgICAgICAgICBwYWdlV2lkdGgsCiAgICAgICAgICBwYWdlSGVpZ2h0LAogICAgICAgICAgcGFnZVgsCiAgICAgICAgICBwYWdlWQogICAgICAgIH0KICAgICAgfQogICAgfSA9IHRoaXMucGFyZW50OwogICAgcG9pbnRbMV0gPSB2aWV3WzNdIC0gcG9pbnRbMV0gKyB2aWV3WzFdOwogICAgcG9pbnRbMF0gPSAxMDAgKiAocG9pbnRbMF0gLSBwYWdlWCkgLyBwYWdlV2lkdGg7CiAgICBwb2ludFsxXSA9IDEwMCAqIChwb2ludFsxXSAtIHBhZ2VZKSAvIHBhZ2VIZWlnaHQ7CiAgICByZXR1cm4gcG9pbnQ7CiAgfQogIGdldCBjb21tZW50VGV4dCgpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YQogICAgfSA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5nZXRSYXdWYWx1ZShgJHtBbm5vdGF0aW9uRWRpdG9yUHJlZml4fSR7ZGF0YS5pZH1gKT8ucG9wdXA/LmNvbnRlbnRzIHx8IGRhdGEuY29udGVudHNPYmo/LnN0ciB8fCAiIjsKICB9CiAgc2V0IGNvbW1lbnRUZXh0KHRleHQpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YQogICAgfSA9IHRoaXM7CiAgICBjb25zdCBwb3B1cCA9IHsKICAgICAgZGVsZXRlZDogIXRleHQsCiAgICAgIGNvbnRlbnRzOiB0ZXh0IHx8ICIiCiAgICB9OwogICAgaWYgKCF0aGlzLmFubm90YXRpb25TdG9yYWdlLnVwZGF0ZUVkaXRvcihkYXRhLmlkLCB7CiAgICAgIHBvcHVwCiAgICB9KSkgewogICAgICB0aGlzLmFubm90YXRpb25TdG9yYWdlLnNldFZhbHVlKGAke0Fubm90YXRpb25FZGl0b3JQcmVmaXh9JHtkYXRhLmlkfWAsIHsKICAgICAgICBpZDogZGF0YS5pZCwKICAgICAgICBhbm5vdGF0aW9uVHlwZTogZGF0YS5hbm5vdGF0aW9uVHlwZSwKICAgICAgICBwYWdlSW5kZXg6IHRoaXMucGFyZW50LnBhZ2UuX3BhZ2VJbmRleCwKICAgICAgICBwb3B1cCwKICAgICAgICBwb3B1cFJlZjogZGF0YS5wb3B1cFJlZiwKICAgICAgICBtb2RpZmljYXRpb25EYXRlOiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKQogICAgICB9KTsKICAgIH0KICAgIGlmICghdGV4dCkgewogICAgICB0aGlzLnJlbW92ZVBvcHVwKCk7CiAgICB9CiAgfQogIHJlbW92ZVBvcHVwKCkgewogICAgKHRoaXMuI3BvcHVwRWxlbWVudD8ucG9wdXAgfHwgdGhpcy5wb3B1cCk/LnJlbW92ZSgpOwogICAgdGhpcy4jcG9wdXBFbGVtZW50ID0gdGhpcy5wb3B1cCA9IG51bGw7CiAgfQogIHVwZGF0ZUVkaXRlZChwYXJhbXMpIHsKICAgIGlmICghdGhpcy5jb250YWluZXIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHBhcmFtcy5yZWN0KSB7CiAgICAgIHRoaXMuI3VwZGF0ZXMgfHw9IHsKICAgICAgICByZWN0OiB0aGlzLmRhdGEucmVjdC5zbGljZSgwKQogICAgICB9OwogICAgfQogICAgY29uc3QgewogICAgICByZWN0LAogICAgICBwb3B1cDogbmV3UG9wdXAKICAgIH0gPSBwYXJhbXM7CiAgICBpZiAocmVjdCkgewogICAgICB0aGlzLiNzZXRSZWN0RWRpdGVkKHJlY3QpOwogICAgfQogICAgbGV0IHBvcHVwID0gdGhpcy4jcG9wdXBFbGVtZW50Py5wb3B1cCB8fCB0aGlzLnBvcHVwOwogICAgaWYgKCFwb3B1cCAmJiBuZXdQb3B1cD8udGV4dCkgewogICAgICB0aGlzLl9jcmVhdGVQb3B1cChuZXdQb3B1cCk7CiAgICAgIHBvcHVwID0gdGhpcy4jcG9wdXBFbGVtZW50LnBvcHVwOwogICAgfQogICAgaWYgKCFwb3B1cCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBwb3B1cC51cGRhdGVFZGl0ZWQocGFyYW1zKTsKICAgIGlmIChuZXdQb3B1cD8uZGVsZXRlZCkgewogICAgICBwb3B1cC5yZW1vdmUoKTsKICAgICAgdGhpcy4jcG9wdXBFbGVtZW50ID0gbnVsbDsKICAgICAgdGhpcy5wb3B1cCA9IG51bGw7CiAgICB9CiAgfQogIHJlc2V0RWRpdGVkKCkgewogICAgaWYgKCF0aGlzLiN1cGRhdGVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3NldFJlY3RFZGl0ZWQodGhpcy4jdXBkYXRlcy5yZWN0KTsKICAgIHRoaXMuI3BvcHVwRWxlbWVudD8ucG9wdXAucmVzZXRFZGl0ZWQoKTsKICAgIHRoaXMuI3VwZGF0ZXMgPSBudWxsOwogIH0KICAjc2V0UmVjdEVkaXRlZChyZWN0KSB7CiAgICBjb25zdCB7CiAgICAgIGNvbnRhaW5lcjogewogICAgICAgIHN0eWxlCiAgICAgIH0sCiAgICAgIGRhdGE6IHsKICAgICAgICByZWN0OiBjdXJyZW50UmVjdCwKICAgICAgICByb3RhdGlvbgogICAgICB9LAogICAgICBwYXJlbnQ6IHsKICAgICAgICB2aWV3cG9ydDogewogICAgICAgICAgcmF3RGltczogewogICAgICAgICAgICBwYWdlV2lkdGgsCiAgICAgICAgICAgIHBhZ2VIZWlnaHQsCiAgICAgICAgICAgIHBhZ2VYLAogICAgICAgICAgICBwYWdlWQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBjdXJyZW50UmVjdD8uc3BsaWNlKDAsIDQsIC4uLnJlY3QpOwogICAgc3R5bGUubGVmdCA9IGAkezEwMCAqIChyZWN0WzBdIC0gcGFnZVgpIC8gcGFnZVdpZHRofSVgOwogICAgc3R5bGUudG9wID0gYCR7MTAwICogKHBhZ2VIZWlnaHQgLSByZWN0WzNdICsgcGFnZVkpIC8gcGFnZUhlaWdodH0lYDsKICAgIGlmIChyb3RhdGlvbiA9PT0gMCkgewogICAgICBzdHlsZS53aWR0aCA9IGAkezEwMCAqIChyZWN0WzJdIC0gcmVjdFswXSkgLyBwYWdlV2lkdGh9JWA7CiAgICAgIHN0eWxlLmhlaWdodCA9IGAkezEwMCAqIChyZWN0WzNdIC0gcmVjdFsxXSkgLyBwYWdlSGVpZ2h0fSVgOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zZXRSb3RhdGlvbihyb3RhdGlvbik7CiAgICB9CiAgfQogIF9jcmVhdGVDb250YWluZXIoaWdub3JlQm9yZGVyKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIHBhcmVudDogewogICAgICAgIHBhZ2UsCiAgICAgICAgdmlld3BvcnQKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBjb25zdCBjb250YWluZXIyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2VjdGlvbiIpOwogICAgY29udGFpbmVyMi5zZXRBdHRyaWJ1dGUoImRhdGEtYW5ub3RhdGlvbi1pZCIsIGRhdGEuaWQpOwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFdpZGdldEFubm90YXRpb25FbGVtZW50KSAmJiAhKHRoaXMgaW5zdGFuY2VvZiBMaW5rQW5ub3RhdGlvbkVsZW1lbnQpKSB7CiAgICAgIGNvbnRhaW5lcjIudGFiSW5kZXggPSAwOwogICAgfQogICAgY29uc3QgewogICAgICBzdHlsZQogICAgfSA9IGNvbnRhaW5lcjI7CiAgICBzdHlsZS56SW5kZXggPSB0aGlzLnBhcmVudC56SW5kZXg7CiAgICB0aGlzLnBhcmVudC56SW5kZXggKz0gMjsKICAgIGlmIChkYXRhLmFsdGVybmF0aXZlVGV4dCkgewogICAgICBjb250YWluZXIyLnRpdGxlID0gZGF0YS5hbHRlcm5hdGl2ZVRleHQ7CiAgICB9CiAgICBpZiAoZGF0YS5ub1JvdGF0ZSkgewogICAgICBjb250YWluZXIyLmNsYXNzTGlzdC5hZGQoIm5vcm90YXRlIik7CiAgICB9CiAgICBpZiAoIWRhdGEucmVjdCB8fCB0aGlzIGluc3RhbmNlb2YgUG9wdXBBbm5vdGF0aW9uRWxlbWVudCkgewogICAgICBjb25zdCB7CiAgICAgICAgcm90YXRpb246IHJvdGF0aW9uMgogICAgICB9ID0gZGF0YTsKICAgICAgaWYgKCFkYXRhLmhhc093bkNhbnZhcyAmJiByb3RhdGlvbjIgIT09IDApIHsKICAgICAgICB0aGlzLnNldFJvdGF0aW9uKHJvdGF0aW9uMiwgY29udGFpbmVyMik7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbnRhaW5lcjI7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgaWYgKCFpZ25vcmVCb3JkZXIgJiYgZGF0YS5ib3JkZXJTdHlsZS53aWR0aCA+IDApIHsKICAgICAgc3R5bGUuYm9yZGVyV2lkdGggPSBgJHtkYXRhLmJvcmRlclN0eWxlLndpZHRofXB4YDsKICAgICAgY29uc3QgaG9yaXpvbnRhbFJhZGl1cyA9IGRhdGEuYm9yZGVyU3R5bGUuaG9yaXpvbnRhbENvcm5lclJhZGl1czsKICAgICAgY29uc3QgdmVydGljYWxSYWRpdXMgPSBkYXRhLmJvcmRlclN0eWxlLnZlcnRpY2FsQ29ybmVyUmFkaXVzOwogICAgICBpZiAoaG9yaXpvbnRhbFJhZGl1cyA+IDAgfHwgdmVydGljYWxSYWRpdXMgPiAwKSB7CiAgICAgICAgY29uc3QgcmFkaXVzID0gYGNhbGMoJHtob3Jpem9udGFsUmFkaXVzfXB4ICogdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSkgLyBjYWxjKCR7dmVydGljYWxSYWRpdXN9cHggKiB2YXIoLS10b3RhbC1zY2FsZS1mYWN0b3IpKWA7CiAgICAgICAgc3R5bGUuYm9yZGVyUmFkaXVzID0gcmFkaXVzOwogICAgICB9IGVsc2UgaWYgKHRoaXMgaW5zdGFuY2VvZiBSYWRpb0J1dHRvbldpZGdldEFubm90YXRpb25FbGVtZW50KSB7CiAgICAgICAgY29uc3QgcmFkaXVzID0gYGNhbGMoJHt3aWR0aH1weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikpIC8gY2FsYygke2hlaWdodH1weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikpYDsKICAgICAgICBzdHlsZS5ib3JkZXJSYWRpdXMgPSByYWRpdXM7CiAgICAgIH0KICAgICAgc3dpdGNoIChkYXRhLmJvcmRlclN0eWxlLnN0eWxlKSB7CiAgICAgICAgY2FzZSBBbm5vdGF0aW9uQm9yZGVyU3R5bGVUeXBlLlNPTElEOgogICAgICAgICAgc3R5bGUuYm9yZGVyU3R5bGUgPSAic29saWQiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBBbm5vdGF0aW9uQm9yZGVyU3R5bGVUeXBlLkRBU0hFRDoKICAgICAgICAgIHN0eWxlLmJvcmRlclN0eWxlID0gImRhc2hlZCI7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIEFubm90YXRpb25Cb3JkZXJTdHlsZVR5cGUuQkVWRUxFRDoKICAgICAgICAgIHdhcm4oIlVuaW1wbGVtZW50ZWQgYm9yZGVyIHN0eWxlOiBiZXZlbGVkIik7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIEFubm90YXRpb25Cb3JkZXJTdHlsZVR5cGUuSU5TRVQ6CiAgICAgICAgICB3YXJuKCJVbmltcGxlbWVudGVkIGJvcmRlciBzdHlsZTogaW5zZXQiKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgQW5ub3RhdGlvbkJvcmRlclN0eWxlVHlwZS5VTkRFUkxJTkU6CiAgICAgICAgICBzdHlsZS5ib3JkZXJCb3R0b21TdHlsZSA9ICJzb2xpZCI7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY29uc3QgYm9yZGVyQ29sb3IgPSBkYXRhLmJvcmRlckNvbG9yIHx8IG51bGw7CiAgICAgIGlmIChib3JkZXJDb2xvcikgewogICAgICAgIHRoaXMuI2hhc0JvcmRlciA9IHRydWU7CiAgICAgICAgc3R5bGUuYm9yZGVyQ29sb3IgPSBVdGlsLm1ha2VIZXhDb2xvcihib3JkZXJDb2xvclswXSB8IDAsIGJvcmRlckNvbG9yWzFdIHwgMCwgYm9yZGVyQ29sb3JbMl0gfCAwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHlsZS5ib3JkZXJXaWR0aCA9IDA7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlY3QgPSBVdGlsLm5vcm1hbGl6ZVJlY3QoW2RhdGEucmVjdFswXSwgcGFnZS52aWV3WzNdIC0gZGF0YS5yZWN0WzFdICsgcGFnZS52aWV3WzFdLCBkYXRhLnJlY3RbMl0sIHBhZ2Uudmlld1szXSAtIGRhdGEucmVjdFszXSArIHBhZ2Uudmlld1sxXV0pOwogICAgY29uc3QgewogICAgICBwYWdlV2lkdGgsCiAgICAgIHBhZ2VIZWlnaHQsCiAgICAgIHBhZ2VYLAogICAgICBwYWdlWQogICAgfSA9IHZpZXdwb3J0LnJhd0RpbXM7CiAgICBzdHlsZS5sZWZ0ID0gYCR7MTAwICogKHJlY3RbMF0gLSBwYWdlWCkgLyBwYWdlV2lkdGh9JWA7CiAgICBzdHlsZS50b3AgPSBgJHsxMDAgKiAocmVjdFsxXSAtIHBhZ2VZKSAvIHBhZ2VIZWlnaHR9JWA7CiAgICBjb25zdCB7CiAgICAgIHJvdGF0aW9uCiAgICB9ID0gZGF0YTsKICAgIGlmIChkYXRhLmhhc093bkNhbnZhcyB8fCByb3RhdGlvbiA9PT0gMCkgewogICAgICBzdHlsZS53aWR0aCA9IGAkezEwMCAqIHdpZHRoIC8gcGFnZVdpZHRofSVgOwogICAgICBzdHlsZS5oZWlnaHQgPSBgJHsxMDAgKiBoZWlnaHQgLyBwYWdlSGVpZ2h0fSVgOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zZXRSb3RhdGlvbihyb3RhdGlvbiwgY29udGFpbmVyMik7CiAgICB9CiAgICByZXR1cm4gY29udGFpbmVyMjsKICB9CiAgc2V0Um90YXRpb24oYW5nbGUsIGNvbnRhaW5lcjIgPSB0aGlzLmNvbnRhaW5lcikgewogICAgaWYgKCF0aGlzLmRhdGEucmVjdCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHBhZ2VXaWR0aCwKICAgICAgcGFnZUhlaWdodAogICAgfSA9IHRoaXMucGFyZW50LnZpZXdwb3J0LnJhd0RpbXM7CiAgICBsZXQgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gdGhpczsKICAgIGlmIChhbmdsZSAlIDE4MCAhPT0gMCkgewogICAgICBbd2lkdGgsIGhlaWdodF0gPSBbaGVpZ2h0LCB3aWR0aF07CiAgICB9CiAgICBjb250YWluZXIyLnN0eWxlLndpZHRoID0gYCR7MTAwICogd2lkdGggLyBwYWdlV2lkdGh9JWA7CiAgICBjb250YWluZXIyLnN0eWxlLmhlaWdodCA9IGAkezEwMCAqIGhlaWdodCAvIHBhZ2VIZWlnaHR9JWA7CiAgICBjb250YWluZXIyLnNldEF0dHJpYnV0ZSgiZGF0YS1tYWluLXJvdGF0aW9uIiwgKDM2MCAtIGFuZ2xlKSAlIDM2MCk7CiAgfQogIGdldCBfY29tbW9uQWN0aW9ucygpIHsKICAgIGNvbnN0IHNldENvbG9yID0gKGpzTmFtZSwgc3R5bGVOYW1lLCBldmVudCkgPT4gewogICAgICBjb25zdCBjb2xvciA9IGV2ZW50LmRldGFpbFtqc05hbWVdOwogICAgICBjb25zdCBjb2xvclR5cGUgPSBjb2xvclswXTsKICAgICAgY29uc3QgY29sb3JBcnJheSA9IGNvbG9yLnNsaWNlKDEpOwogICAgICBldmVudC50YXJnZXQuc3R5bGVbc3R5bGVOYW1lXSA9IENvbG9yQ29udmVydGVyc1tgJHtjb2xvclR5cGV9X0hUTUxgXShjb2xvckFycmF5KTsKICAgICAgdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5zZXRWYWx1ZSh0aGlzLmRhdGEuaWQsIHsKICAgICAgICBbc3R5bGVOYW1lXTogQ29sb3JDb252ZXJ0ZXJzW2Ake2NvbG9yVHlwZX1fcmdiYF0oY29sb3JBcnJheSkKICAgICAgfSk7CiAgICB9OwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2NvbW1vbkFjdGlvbnMiLCB7CiAgICAgIGRpc3BsYXk6IChldmVudCkgPT4gewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGRpc3BsYXkKICAgICAgICB9ID0gZXZlbnQuZGV0YWlsOwogICAgICAgIGNvbnN0IGhpZGRlbiA9IGRpc3BsYXkgJSAyID09PSAxOwogICAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLnZpc2liaWxpdHkgPSBoaWRkZW4gPyAiaGlkZGVuIiA6ICJ2aXNpYmxlIjsKICAgICAgICB0aGlzLmFubm90YXRpb25TdG9yYWdlLnNldFZhbHVlKHRoaXMuZGF0YS5pZCwgewogICAgICAgICAgbm9WaWV3OiBoaWRkZW4sCiAgICAgICAgICBub1ByaW50OiBkaXNwbGF5ID09PSAxIHx8IGRpc3BsYXkgPT09IDIKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgcHJpbnQ6IChldmVudCkgPT4gewogICAgICAgIHRoaXMuYW5ub3RhdGlvblN0b3JhZ2Uuc2V0VmFsdWUodGhpcy5kYXRhLmlkLCB7CiAgICAgICAgICBub1ByaW50OiAhZXZlbnQuZGV0YWlsLnByaW50CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGhpZGRlbjogKGV2ZW50KSA9PiB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgaGlkZGVuCiAgICAgICAgfSA9IGV2ZW50LmRldGFpbDsKICAgICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS52aXNpYmlsaXR5ID0gaGlkZGVuID8gImhpZGRlbiIgOiAidmlzaWJsZSI7CiAgICAgICAgdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5zZXRWYWx1ZSh0aGlzLmRhdGEuaWQsIHsKICAgICAgICAgIG5vUHJpbnQ6IGhpZGRlbiwKICAgICAgICAgIG5vVmlldzogaGlkZGVuCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGZvY3VzOiAoZXZlbnQpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGV2ZW50LnRhcmdldC5mb2N1cyh7CiAgICAgICAgICBwcmV2ZW50U2Nyb2xsOiBmYWxzZQogICAgICAgIH0pLCAwKTsKICAgICAgfSwKICAgICAgdXNlck5hbWU6IChldmVudCkgPT4gewogICAgICAgIGV2ZW50LnRhcmdldC50aXRsZSA9IGV2ZW50LmRldGFpbC51c2VyTmFtZTsKICAgICAgfSwKICAgICAgcmVhZG9ubHk6IChldmVudCkgPT4gewogICAgICAgIGV2ZW50LnRhcmdldC5kaXNhYmxlZCA9IGV2ZW50LmRldGFpbC5yZWFkb25seTsKICAgICAgfSwKICAgICAgcmVxdWlyZWQ6IChldmVudCkgPT4gewogICAgICAgIHRoaXMuX3NldFJlcXVpcmVkKGV2ZW50LnRhcmdldCwgZXZlbnQuZGV0YWlsLnJlcXVpcmVkKTsKICAgICAgfSwKICAgICAgYmdDb2xvcjogKGV2ZW50KSA9PiB7CiAgICAgICAgc2V0Q29sb3IoImJnQ29sb3IiLCAiYmFja2dyb3VuZENvbG9yIiwgZXZlbnQpOwogICAgICB9LAogICAgICBmaWxsQ29sb3I6IChldmVudCkgPT4gewogICAgICAgIHNldENvbG9yKCJmaWxsQ29sb3IiLCAiYmFja2dyb3VuZENvbG9yIiwgZXZlbnQpOwogICAgICB9LAogICAgICBmZ0NvbG9yOiAoZXZlbnQpID0+IHsKICAgICAgICBzZXRDb2xvcigiZmdDb2xvciIsICJjb2xvciIsIGV2ZW50KTsKICAgICAgfSwKICAgICAgdGV4dENvbG9yOiAoZXZlbnQpID0+IHsKICAgICAgICBzZXRDb2xvcigidGV4dENvbG9yIiwgImNvbG9yIiwgZXZlbnQpOwogICAgICB9LAogICAgICBib3JkZXJDb2xvcjogKGV2ZW50KSA9PiB7CiAgICAgICAgc2V0Q29sb3IoImJvcmRlckNvbG9yIiwgImJvcmRlckNvbG9yIiwgZXZlbnQpOwogICAgICB9LAogICAgICBzdHJva2VDb2xvcjogKGV2ZW50KSA9PiB7CiAgICAgICAgc2V0Q29sb3IoInN0cm9rZUNvbG9yIiwgImJvcmRlckNvbG9yIiwgZXZlbnQpOwogICAgICB9LAogICAgICByb3RhdGlvbjogKGV2ZW50KSA9PiB7CiAgICAgICAgY29uc3QgYW5nbGUgPSBldmVudC5kZXRhaWwucm90YXRpb247CiAgICAgICAgdGhpcy5zZXRSb3RhdGlvbihhbmdsZSk7CiAgICAgICAgdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5zZXRWYWx1ZSh0aGlzLmRhdGEuaWQsIHsKICAgICAgICAgIHJvdGF0aW9uOiBhbmdsZQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CiAgX2Rpc3BhdGNoRXZlbnRGcm9tU2FuZGJveChhY3Rpb25zLCBqc0V2ZW50KSB7CiAgICBjb25zdCBjb21tb25BY3Rpb25zID0gdGhpcy5fY29tbW9uQWN0aW9uczsKICAgIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhqc0V2ZW50LmRldGFpbCkpIHsKICAgICAgY29uc3QgYWN0aW9uID0gYWN0aW9uc1tuYW1lXSB8fCBjb21tb25BY3Rpb25zW25hbWVdOwogICAgICBhY3Rpb24/Lihqc0V2ZW50KTsKICAgIH0KICB9CiAgX3NldERlZmF1bHRQcm9wZXJ0aWVzRnJvbUpTKGVsZW1lbnQpIHsKICAgIGlmICghdGhpcy5lbmFibGVTY3JpcHRpbmcpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc3RvcmVkRGF0YSA9IHRoaXMuYW5ub3RhdGlvblN0b3JhZ2UuZ2V0UmF3VmFsdWUodGhpcy5kYXRhLmlkKTsKICAgIGlmICghc3RvcmVkRGF0YSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjb21tb25BY3Rpb25zID0gdGhpcy5fY29tbW9uQWN0aW9uczsKICAgIGZvciAoY29uc3QgW2FjdGlvbk5hbWUsIGRldGFpbF0gb2YgT2JqZWN0LmVudHJpZXMoc3RvcmVkRGF0YSkpIHsKICAgICAgY29uc3QgYWN0aW9uID0gY29tbW9uQWN0aW9uc1thY3Rpb25OYW1lXTsKICAgICAgaWYgKGFjdGlvbikgewogICAgICAgIGNvbnN0IGV2ZW50UHJveHkgPSB7CiAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgW2FjdGlvbk5hbWVdOiBkZXRhaWwKICAgICAgICAgIH0sCiAgICAgICAgICB0YXJnZXQ6IGVsZW1lbnQKICAgICAgICB9OwogICAgICAgIGFjdGlvbihldmVudFByb3h5KTsKICAgICAgICBkZWxldGUgc3RvcmVkRGF0YVthY3Rpb25OYW1lXTsKICAgICAgfQogICAgfQogIH0KICBfY3JlYXRlUXVhZHJpbGF0ZXJhbHMoKSB7CiAgICBpZiAoIXRoaXMuY29udGFpbmVyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgcXVhZFBvaW50cwogICAgfSA9IHRoaXMuZGF0YTsKICAgIGlmICghcXVhZFBvaW50cykgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBbcmVjdEJsWCwgcmVjdEJsWSwgcmVjdFRyWCwgcmVjdFRyWV0gPSB0aGlzLmRhdGEucmVjdC5tYXAoKHgpID0+IE1hdGguZnJvdW5kKHgpKTsKICAgIGlmIChxdWFkUG9pbnRzLmxlbmd0aCA9PT0gOCkgewogICAgICBjb25zdCBbdHJYLCB0clksIGJsWCwgYmxZXSA9IHF1YWRQb2ludHMuc3ViYXJyYXkoMiwgNik7CiAgICAgIGlmIChyZWN0VHJYID09PSB0clggJiYgcmVjdFRyWSA9PT0gdHJZICYmIHJlY3RCbFggPT09IGJsWCAmJiByZWN0QmxZID09PSBibFkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSB0aGlzLmNvbnRhaW5lcjsKICAgIGxldCBzdmdCdWZmZXI7CiAgICBpZiAodGhpcy4jaGFzQm9yZGVyKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBib3JkZXJDb2xvciwKICAgICAgICBib3JkZXJXaWR0aAogICAgICB9ID0gc3R5bGU7CiAgICAgIHN0eWxlLmJvcmRlcldpZHRoID0gMDsKICAgICAgc3ZnQnVmZmVyID0gWyJ1cmwoJ2RhdGE6aW1hZ2Uvc3ZnK3htbDt1dGY4LCIsIGA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyJgLCBgIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiIHZpZXdCb3g9IjAgMCAxIDEiPmAsIGA8ZyBmaWxsPSJ0cmFuc3BhcmVudCIgc3Ryb2tlPSIke2JvcmRlckNvbG9yfSIgc3Ryb2tlLXdpZHRoPSIke2JvcmRlcldpZHRofSI+YF07CiAgICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImhhc0JvcmRlciIpOwogICAgfQogICAgY29uc3Qgd2lkdGggPSByZWN0VHJYIC0gcmVjdEJsWDsKICAgIGNvbnN0IGhlaWdodCA9IHJlY3RUclkgLSByZWN0QmxZOwogICAgY29uc3QgewogICAgICBzdmdGYWN0b3J5CiAgICB9ID0gdGhpczsKICAgIGNvbnN0IHN2ZyA9IHN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgic3ZnIik7CiAgICBzdmcuY2xhc3NMaXN0LmFkZCgicXVhZHJpbGF0ZXJhbHNDb250YWluZXIiKTsKICAgIHN2Zy5zZXRBdHRyaWJ1dGUoIndpZHRoIiwgMCk7CiAgICBzdmcuc2V0QXR0cmlidXRlKCJoZWlnaHQiLCAwKTsKICAgIHN2Zy5yb2xlID0gIm5vbmUiOwogICAgY29uc3QgZGVmcyA9IHN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgiZGVmcyIpOwogICAgc3ZnLmFwcGVuZChkZWZzKTsKICAgIGNvbnN0IGNsaXBQYXRoID0gc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIpOwogICAgY29uc3QgaWQgPSBgY2xpcHBhdGhfJHt0aGlzLmRhdGEuaWR9YDsKICAgIGNsaXBQYXRoLnNldEF0dHJpYnV0ZSgiaWQiLCBpZCk7CiAgICBjbGlwUGF0aC5zZXRBdHRyaWJ1dGUoImNsaXBQYXRoVW5pdHMiLCAib2JqZWN0Qm91bmRpbmdCb3giKTsKICAgIGRlZnMuYXBwZW5kKGNsaXBQYXRoKTsKICAgIGZvciAobGV0IGkgPSAyLCBpaSA9IHF1YWRQb2ludHMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gOCkgewogICAgICBjb25zdCB0clggPSBxdWFkUG9pbnRzW2ldOwogICAgICBjb25zdCB0clkgPSBxdWFkUG9pbnRzW2kgKyAxXTsKICAgICAgY29uc3QgYmxYID0gcXVhZFBvaW50c1tpICsgMl07CiAgICAgIGNvbnN0IGJsWSA9IHF1YWRQb2ludHNbaSArIDNdOwogICAgICBjb25zdCByZWN0ID0gc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJyZWN0Iik7CiAgICAgIGNvbnN0IHggPSAoYmxYIC0gcmVjdEJsWCkgLyB3aWR0aDsKICAgICAgY29uc3QgeSA9IChyZWN0VHJZIC0gdHJZKSAvIGhlaWdodDsKICAgICAgY29uc3QgcmVjdFdpZHRoID0gKHRyWCAtIGJsWCkgLyB3aWR0aDsKICAgICAgY29uc3QgcmVjdEhlaWdodCA9ICh0clkgLSBibFkpIC8gaGVpZ2h0OwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgieCIsIHgpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgieSIsIHkpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgid2lkdGgiLCByZWN0V2lkdGgpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgcmVjdEhlaWdodCk7CiAgICAgIGNsaXBQYXRoLmFwcGVuZChyZWN0KTsKICAgICAgc3ZnQnVmZmVyPy5wdXNoKGA8cmVjdCB2ZWN0b3ItZWZmZWN0PSJub24tc2NhbGluZy1zdHJva2UiIHg9IiR7eH0iIHk9IiR7eX0iIHdpZHRoPSIke3JlY3RXaWR0aH0iIGhlaWdodD0iJHtyZWN0SGVpZ2h0fSIvPmApOwogICAgfQogICAgaWYgKHRoaXMuI2hhc0JvcmRlcikgewogICAgICBzdmdCdWZmZXIucHVzaChgPC9nPjwvc3ZnPicpYCk7CiAgICAgIHN0eWxlLmJhY2tncm91bmRJbWFnZSA9IHN2Z0J1ZmZlci5qb2luKCIiKTsKICAgIH0KICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChzdmcpOwogICAgdGhpcy5jb250YWluZXIuc3R5bGUuY2xpcFBhdGggPSBgdXJsKCMke2lkfSlgOwogIH0KICBfY3JlYXRlUG9wdXAocG9wdXBEYXRhID0gbnVsbCkgewogICAgY29uc3QgewogICAgICBkYXRhCiAgICB9ID0gdGhpczsKICAgIGxldCBjb250ZW50c09iaiwgbW9kaWZpY2F0aW9uRGF0ZTsKICAgIGlmIChwb3B1cERhdGEpIHsKICAgICAgY29udGVudHNPYmogPSB7CiAgICAgICAgc3RyOiBwb3B1cERhdGEudGV4dAogICAgICB9OwogICAgICBtb2RpZmljYXRpb25EYXRlID0gcG9wdXBEYXRhLmRhdGU7CiAgICB9IGVsc2UgewogICAgICBjb250ZW50c09iaiA9IGRhdGEuY29udGVudHNPYmo7CiAgICAgIG1vZGlmaWNhdGlvbkRhdGUgPSBkYXRhLm1vZGlmaWNhdGlvbkRhdGU7CiAgICB9CiAgICB0aGlzLiNwb3B1cEVsZW1lbnQgPSBuZXcgUG9wdXBBbm5vdGF0aW9uRWxlbWVudCh7CiAgICAgIGRhdGE6IHsKICAgICAgICBjb2xvcjogZGF0YS5jb2xvciwKICAgICAgICB0aXRsZU9iajogZGF0YS50aXRsZU9iaiwKICAgICAgICBtb2RpZmljYXRpb25EYXRlLAogICAgICAgIGNvbnRlbnRzT2JqLAogICAgICAgIHJpY2hUZXh0OiBkYXRhLnJpY2hUZXh0LAogICAgICAgIHBhcmVudFJlY3Q6IGRhdGEucmVjdCwKICAgICAgICBib3JkZXJTdHlsZTogMCwKICAgICAgICBpZDogYHBvcHVwXyR7ZGF0YS5pZH1gLAogICAgICAgIHJvdGF0aW9uOiBkYXRhLnJvdGF0aW9uLAogICAgICAgIG5vUm90YXRlOiB0cnVlCiAgICAgIH0sCiAgICAgIGxpbmtTZXJ2aWNlOiB0aGlzLmxpbmtTZXJ2aWNlLAogICAgICBwYXJlbnQ6IHRoaXMucGFyZW50LAogICAgICBlbGVtZW50czogW3RoaXNdCiAgICB9KTsKICB9CiAgZ2V0IGhhc1BvcHVwRWxlbWVudCgpIHsKICAgIHJldHVybiAhISh0aGlzLiNwb3B1cEVsZW1lbnQgfHwgdGhpcy5wb3B1cCB8fCB0aGlzLmRhdGEucG9wdXBSZWYpOwogIH0KICBnZXQgZXh0cmFQb3B1cEVsZW1lbnQoKSB7CiAgICByZXR1cm4gdGhpcy4jcG9wdXBFbGVtZW50OwogIH0KICByZW5kZXIoKSB7CiAgICB1bnJlYWNoYWJsZSgiQWJzdHJhY3QgbWV0aG9kIGBBbm5vdGF0aW9uRWxlbWVudC5yZW5kZXJgIGNhbGxlZCIpOwogIH0KICBfZ2V0RWxlbWVudHNCeU5hbWUobmFtZSwgc2tpcElkID0gbnVsbCkgewogICAgY29uc3QgZmllbGRzID0gW107CiAgICBpZiAodGhpcy5fZmllbGRPYmplY3RzKSB7CiAgICAgIGNvbnN0IGZpZWxkT2JqID0gdGhpcy5fZmllbGRPYmplY3RzW25hbWVdOwogICAgICBpZiAoZmllbGRPYmopIHsKICAgICAgICBmb3IgKGNvbnN0IHsKICAgICAgICAgIHBhZ2UsCiAgICAgICAgICBpZCwKICAgICAgICAgIGV4cG9ydFZhbHVlcwogICAgICAgIH0gb2YgZmllbGRPYmopIHsKICAgICAgICAgIGlmIChwYWdlID09PSAtMSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpZCA9PT0gc2tpcElkKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZXhwb3J0VmFsdWUgPSB0eXBlb2YgZXhwb3J0VmFsdWVzID09PSAic3RyaW5nIiA/IGV4cG9ydFZhbHVlcyA6IG51bGw7CiAgICAgICAgICBjb25zdCBkb21FbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgW2RhdGEtZWxlbWVudC1pZD0iJHtpZH0iXWApOwogICAgICAgICAgaWYgKGRvbUVsZW1lbnQgJiYgIUdldEVsZW1lbnRzQnlOYW1lU2V0Lmhhcyhkb21FbGVtZW50KSkgewogICAgICAgICAgICB3YXJuKGBfZ2V0RWxlbWVudHNCeU5hbWUgLSBlbGVtZW50IG5vdCBhbGxvd2VkOiAke2lkfWApOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGZpZWxkcy5wdXNoKHsKICAgICAgICAgICAgaWQsCiAgICAgICAgICAgIGV4cG9ydFZhbHVlLAogICAgICAgICAgICBkb21FbGVtZW50CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZpZWxkczsKICAgIH0KICAgIGZvciAoY29uc3QgZG9tRWxlbWVudCBvZiBkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZShuYW1lKSkgewogICAgICBjb25zdCB7CiAgICAgICAgZXhwb3J0VmFsdWUKICAgICAgfSA9IGRvbUVsZW1lbnQ7CiAgICAgIGNvbnN0IGlkID0gZG9tRWxlbWVudC5nZXRBdHRyaWJ1dGUoImRhdGEtZWxlbWVudC1pZCIpOwogICAgICBpZiAoaWQgPT09IHNraXBJZCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghR2V0RWxlbWVudHNCeU5hbWVTZXQuaGFzKGRvbUVsZW1lbnQpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgZmllbGRzLnB1c2goewogICAgICAgIGlkLAogICAgICAgIGV4cG9ydFZhbHVlLAogICAgICAgIGRvbUVsZW1lbnQKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gZmllbGRzOwogIH0KICBzaG93KCkgewogICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgIHRoaXMuY29udGFpbmVyLmhpZGRlbiA9IGZhbHNlOwogICAgfQogICAgdGhpcy5wb3B1cD8ubWF5YmVTaG93KCk7CiAgfQogIGhpZGUoKSB7CiAgICBpZiAodGhpcy5jb250YWluZXIpIHsKICAgICAgdGhpcy5jb250YWluZXIuaGlkZGVuID0gdHJ1ZTsKICAgIH0KICAgIHRoaXMucG9wdXA/LmZvcmNlSGlkZSgpOwogIH0KICBnZXRFbGVtZW50c1RvVHJpZ2dlclBvcHVwKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KICBhZGRIaWdobGlnaHRBcmVhKCkgewogICAgY29uc3QgdHJpZ2dlcnMgPSB0aGlzLmdldEVsZW1lbnRzVG9UcmlnZ2VyUG9wdXAoKTsKICAgIGlmIChBcnJheS5pc0FycmF5KHRyaWdnZXJzKSkgewogICAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdHJpZ2dlcnMpIHsKICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodEFyZWEiKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdHJpZ2dlcnMuY2xhc3NMaXN0LmFkZCgiaGlnaGxpZ2h0QXJlYSIpOwogICAgfQogIH0KICBfZWRpdE9uRG91YmxlQ2xpY2soKSB7CiAgICBpZiAoIXRoaXMuX2lzRWRpdGFibGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBhbm5vdGF0aW9uRWRpdG9yVHlwZTogbW9kZSwKICAgICAgZGF0YTogewogICAgICAgIGlkOiBlZGl0SWQKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICB0aGlzLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJkYmxjbGljayIsICgpID0+IHsKICAgICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goInN3aXRjaGFubm90YXRpb25lZGl0b3Jtb2RlIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBtb2RlLAogICAgICAgIGVkaXRJZCwKICAgICAgICBtdXN0RW50ZXJJbkVkaXRNb2RlOiB0cnVlCiAgICAgIH0pOwogICAgfSk7CiAgfQogIGdldCB3aWR0aCgpIHsKICAgIHJldHVybiB0aGlzLmRhdGEucmVjdFsyXSAtIHRoaXMuZGF0YS5yZWN0WzBdOwogIH0KICBnZXQgaGVpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMuZGF0YS5yZWN0WzNdIC0gdGhpcy5kYXRhLnJlY3RbMV07CiAgfQp9Owp2YXIgRWRpdG9yQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlCiAgICB9KTsKICAgIHRoaXMuZWRpdG9yID0gcGFyYW1ldGVycy5lZGl0b3I7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTmFtZSA9ICJlZGl0b3JBbm5vdGF0aW9uIjsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgY3JlYXRlT3JVcGRhdGVQb3B1cCgpIHsKICAgIGNvbnN0IHsKICAgICAgZWRpdG9yCiAgICB9ID0gdGhpczsKICAgIGlmICghZWRpdG9yLmhhc0NvbW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fY3JlYXRlUG9wdXAoZWRpdG9yLmNvbW1lbnQpOwogIH0KICBnZXQgaGFzQ29tbWVudEJ1dHRvbigpIHsKICAgIHJldHVybiB0aGlzLmVuYWJsZUNvbW1lbnQgJiYgdGhpcy5lZGl0b3IuaGFzQ29tbWVudDsKICB9CiAgZ2V0IGNvbW1lbnRCdXR0b25Qb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmVkaXRvci5jb21tZW50QnV0dG9uUG9zaXRpb25JblBhZ2U7CiAgfQogIGdldCBjb21tZW50VGV4dCgpIHsKICAgIHJldHVybiB0aGlzLmVkaXRvci5jb21tZW50LnRleHQ7CiAgfQogIHNldCBjb21tZW50VGV4dCh0ZXh0KSB7CiAgICB0aGlzLmVkaXRvci5jb21tZW50ID0gdGV4dDsKICAgIGlmICghdGV4dCkgewogICAgICB0aGlzLnJlbW92ZVBvcHVwKCk7CiAgICB9CiAgfQogIGdldCBjb21tZW50RGF0YSgpIHsKICAgIHJldHVybiB0aGlzLmVkaXRvci5nZXREYXRhKCk7CiAgfQogIHJlbW92ZSgpIHsKICAgIHRoaXMucGFyZW50LnJlbW92ZUFubm90YXRpb24odGhpcy5kYXRhLmlkKTsKICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZSgpOwogICAgdGhpcy5jb250YWluZXIgPSBudWxsOwogICAgdGhpcy5yZW1vdmVQb3B1cCgpOwogIH0KfTsKdmFyIExpbmtBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMsIG9wdGlvbnMgPSBudWxsKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiAhIW9wdGlvbnM/Lmlnbm9yZUJvcmRlciwKICAgICAgY3JlYXRlUXVhZHJpbGF0ZXJhbHM6IHRydWUKICAgIH0pOwogICAgdGhpcy5pc1Rvb2x0aXBPbmx5ID0gcGFyYW1ldGVycy5kYXRhLmlzVG9vbHRpcE9ubHk7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YSwKICAgICAgbGlua1NlcnZpY2UKICAgIH0gPSB0aGlzOwogICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgIGxpbmsuc2V0QXR0cmlidXRlKCJkYXRhLWVsZW1lbnQtaWQiLCBkYXRhLmlkKTsKICAgIGxldCBpc0JvdW5kID0gZmFsc2U7CiAgICBpZiAoZGF0YS51cmwpIHsKICAgICAgbGlua1NlcnZpY2UuYWRkTGlua0F0dHJpYnV0ZXMobGluaywgZGF0YS51cmwsIGRhdGEubmV3V2luZG93KTsKICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGRhdGEuYWN0aW9uKSB7CiAgICAgIHRoaXMuX2JpbmROYW1lZEFjdGlvbihsaW5rLCBkYXRhLmFjdGlvbiwgZGF0YS5vdmVybGFpZFRleHQpOwogICAgICBpc0JvdW5kID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoZGF0YS5hdHRhY2htZW50KSB7CiAgICAgIHRoaXMuI2JpbmRBdHRhY2htZW50KGxpbmssIGRhdGEuYXR0YWNobWVudCwgZGF0YS5vdmVybGFpZFRleHQsIGRhdGEuYXR0YWNobWVudERlc3QpOwogICAgICBpc0JvdW5kID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoZGF0YS5zZXRPQ0dTdGF0ZSkgewogICAgICB0aGlzLiNiaW5kU2V0T0NHU3RhdGUobGluaywgZGF0YS5zZXRPQ0dTdGF0ZSwgZGF0YS5vdmVybGFpZFRleHQpOwogICAgICBpc0JvdW5kID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoZGF0YS5kZXN0KSB7CiAgICAgIHRoaXMuX2JpbmRMaW5rKGxpbmssIGRhdGEuZGVzdCwgZGF0YS5vdmVybGFpZFRleHQpOwogICAgICBpc0JvdW5kID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChkYXRhLmFjdGlvbnMgJiYgKGRhdGEuYWN0aW9ucy5BY3Rpb24gfHwgZGF0YS5hY3Rpb25zWyJNb3VzZSBVcCJdIHx8IGRhdGEuYWN0aW9uc1siTW91c2UgRG93biJdKSAmJiB0aGlzLmVuYWJsZVNjcmlwdGluZyAmJiB0aGlzLmhhc0pTQWN0aW9ucykgewogICAgICAgIHRoaXMuX2JpbmRKU0FjdGlvbihsaW5rLCBkYXRhKTsKICAgICAgICBpc0JvdW5kID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoZGF0YS5yZXNldEZvcm0pIHsKICAgICAgICB0aGlzLl9iaW5kUmVzZXRGb3JtQWN0aW9uKGxpbmssIGRhdGEucmVzZXRGb3JtKTsKICAgICAgICBpc0JvdW5kID0gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmlzVG9vbHRpcE9ubHkgJiYgIWlzQm91bmQpIHsKICAgICAgICB0aGlzLl9iaW5kTGluayhsaW5rLCAiIik7CiAgICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImxpbmtBbm5vdGF0aW9uIik7CiAgICBpZiAoaXNCb3VuZCkgewogICAgICB0aGlzLmNvbnRlbnRFbGVtZW50ID0gbGluazsKICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kKGxpbmspOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KICAjc2V0SW50ZXJuYWxMaW5rKCkgewogICAgdGhpcy5jb250YWluZXIuc2V0QXR0cmlidXRlKCJkYXRhLWludGVybmFsLWxpbmsiLCAiIik7CiAgfQogIF9iaW5kTGluayhsaW5rLCBkZXN0aW5hdGlvbiwgb3ZlcmxhaWRUZXh0ID0gIiIpIHsKICAgIGxpbmsuaHJlZiA9IHRoaXMubGlua1NlcnZpY2UuZ2V0RGVzdGluYXRpb25IYXNoKGRlc3RpbmF0aW9uKTsKICAgIGxpbmsub25jbGljayA9ICgpID0+IHsKICAgICAgaWYgKGRlc3RpbmF0aW9uKSB7CiAgICAgICAgdGhpcy5saW5rU2VydmljZS5nb1RvRGVzdGluYXRpb24oZGVzdGluYXRpb24pOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CiAgICBpZiAoZGVzdGluYXRpb24gfHwgZGVzdGluYXRpb24gPT09ICIiKSB7CiAgICAgIHRoaXMuI3NldEludGVybmFsTGluaygpOwogICAgfQogICAgaWYgKG92ZXJsYWlkVGV4dCkgewogICAgICBsaW5rLnRpdGxlID0gb3ZlcmxhaWRUZXh0OwogICAgfQogIH0KICBfYmluZE5hbWVkQWN0aW9uKGxpbmssIGFjdGlvbiwgb3ZlcmxhaWRUZXh0ID0gIiIpIHsKICAgIGxpbmsuaHJlZiA9IHRoaXMubGlua1NlcnZpY2UuZ2V0QW5jaG9yVXJsKCIiKTsKICAgIGxpbmsub25jbGljayA9ICgpID0+IHsKICAgICAgdGhpcy5saW5rU2VydmljZS5leGVjdXRlTmFtZWRBY3Rpb24oYWN0aW9uKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKICAgIGlmIChvdmVybGFpZFRleHQpIHsKICAgICAgbGluay50aXRsZSA9IG92ZXJsYWlkVGV4dDsKICAgIH0KICAgIHRoaXMuI3NldEludGVybmFsTGluaygpOwogIH0KICAjYmluZEF0dGFjaG1lbnQobGluaywgYXR0YWNobWVudCwgb3ZlcmxhaWRUZXh0ID0gIiIsIGRlc3QgPSBudWxsKSB7CiAgICBsaW5rLmhyZWYgPSB0aGlzLmxpbmtTZXJ2aWNlLmdldEFuY2hvclVybCgiIik7CiAgICBpZiAoYXR0YWNobWVudC5kZXNjcmlwdGlvbikgewogICAgICBsaW5rLnRpdGxlID0gYXR0YWNobWVudC5kZXNjcmlwdGlvbjsKICAgIH0gZWxzZSBpZiAob3ZlcmxhaWRUZXh0KSB7CiAgICAgIGxpbmsudGl0bGUgPSBvdmVybGFpZFRleHQ7CiAgICB9CiAgICBsaW5rLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgIHRoaXMuZG93bmxvYWRNYW5hZ2VyPy5vcGVuT3JEb3dubG9hZERhdGEoYXR0YWNobWVudC5jb250ZW50LCBhdHRhY2htZW50LmZpbGVuYW1lLCBkZXN0KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKICAgIHRoaXMuI3NldEludGVybmFsTGluaygpOwogIH0KICAjYmluZFNldE9DR1N0YXRlKGxpbmssIGFjdGlvbiwgb3ZlcmxhaWRUZXh0ID0gIiIpIHsKICAgIGxpbmsuaHJlZiA9IHRoaXMubGlua1NlcnZpY2UuZ2V0QW5jaG9yVXJsKCIiKTsKICAgIGxpbmsub25jbGljayA9ICgpID0+IHsKICAgICAgdGhpcy5saW5rU2VydmljZS5leGVjdXRlU2V0T0NHU3RhdGUoYWN0aW9uKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKICAgIGlmIChvdmVybGFpZFRleHQpIHsKICAgICAgbGluay50aXRsZSA9IG92ZXJsYWlkVGV4dDsKICAgIH0KICAgIHRoaXMuI3NldEludGVybmFsTGluaygpOwogIH0KICBfYmluZEpTQWN0aW9uKGxpbmssIGRhdGEpIHsKICAgIGxpbmsuaHJlZiA9IHRoaXMubGlua1NlcnZpY2UuZ2V0QW5jaG9yVXJsKCIiKTsKICAgIGNvbnN0IG1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbIkFjdGlvbiIsICJvbmNsaWNrIl0sIFsiTW91c2UgVXAiLCAib25tb3VzZXVwIl0sIFsiTW91c2UgRG93biIsICJvbm1vdXNlZG93biJdXSk7CiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoZGF0YS5hY3Rpb25zKSkgewogICAgICBjb25zdCBqc05hbWUgPSBtYXAuZ2V0KG5hbWUpOwogICAgICBpZiAoIWpzTmFtZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGxpbmtbanNOYW1lXSA9ICgpID0+IHsKICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLmV2ZW50QnVzPy5kaXNwYXRjaCgiZGlzcGF0Y2hldmVudGluc2FuZGJveCIsIHsKICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgIGRldGFpbDogewogICAgICAgICAgICBpZDogZGF0YS5pZCwKICAgICAgICAgICAgbmFtZQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgIH0KICAgIGlmIChkYXRhLm92ZXJsYWlkVGV4dCkgewogICAgICBsaW5rLnRpdGxlID0gZGF0YS5vdmVybGFpZFRleHQ7CiAgICB9CiAgICBpZiAoIWxpbmsub25jbGljaykgewogICAgICBsaW5rLm9uY2xpY2sgPSAoKSA9PiBmYWxzZTsKICAgIH0KICAgIHRoaXMuI3NldEludGVybmFsTGluaygpOwogIH0KICBfYmluZFJlc2V0Rm9ybUFjdGlvbihsaW5rLCByZXNldEZvcm0pIHsKICAgIGNvbnN0IG90aGVyQ2xpY2tBY3Rpb24gPSBsaW5rLm9uY2xpY2s7CiAgICBpZiAoIW90aGVyQ2xpY2tBY3Rpb24pIHsKICAgICAgbGluay5ocmVmID0gdGhpcy5saW5rU2VydmljZS5nZXRBbmNob3JVcmwoIiIpOwogICAgfQogICAgdGhpcy4jc2V0SW50ZXJuYWxMaW5rKCk7CiAgICBpZiAoIXRoaXMuX2ZpZWxkT2JqZWN0cykgewogICAgICB3YXJuKGBfYmluZFJlc2V0Rm9ybUFjdGlvbiAtICJyZXNldEZvcm0iIGFjdGlvbiBub3Qgc3VwcG9ydGVkLCBlbnN1cmUgdGhhdCB0aGUgXGBmaWVsZE9iamVjdHNcYCBwYXJhbWV0ZXIgaXMgcHJvdmlkZWQuYCk7CiAgICAgIGlmICghb3RoZXJDbGlja0FjdGlvbikgewogICAgICAgIGxpbmsub25jbGljayA9ICgpID0+IGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxpbmsub25jbGljayA9ICgpID0+IHsKICAgICAgb3RoZXJDbGlja0FjdGlvbj8uKCk7CiAgICAgIGNvbnN0IHsKICAgICAgICBmaWVsZHM6IHJlc2V0Rm9ybUZpZWxkcywKICAgICAgICByZWZzOiByZXNldEZvcm1SZWZzLAogICAgICAgIGluY2x1ZGUKICAgICAgfSA9IHJlc2V0Rm9ybTsKICAgICAgY29uc3QgYWxsRmllbGRzID0gW107CiAgICAgIGlmIChyZXNldEZvcm1GaWVsZHMubGVuZ3RoICE9PSAwIHx8IHJlc2V0Rm9ybVJlZnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgY29uc3QgZmllbGRJZHMgPSBuZXcgU2V0KHJlc2V0Rm9ybVJlZnMpOwogICAgICAgIGZvciAoY29uc3QgZmllbGROYW1lIG9mIHJlc2V0Rm9ybUZpZWxkcykgewogICAgICAgICAgY29uc3QgZmllbGRzID0gdGhpcy5fZmllbGRPYmplY3RzW2ZpZWxkTmFtZV0gfHwgW107CiAgICAgICAgICBmb3IgKGNvbnN0IHsKICAgICAgICAgICAgaWQKICAgICAgICAgIH0gb2YgZmllbGRzKSB7CiAgICAgICAgICAgIGZpZWxkSWRzLmFkZChpZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgZmllbGRzIG9mIE9iamVjdC52YWx1ZXModGhpcy5fZmllbGRPYmplY3RzKSkgewogICAgICAgICAgZm9yIChjb25zdCBmaWVsZCBvZiBmaWVsZHMpIHsKICAgICAgICAgICAgaWYgKGZpZWxkSWRzLmhhcyhmaWVsZC5pZCkgPT09IGluY2x1ZGUpIHsKICAgICAgICAgICAgICBhbGxGaWVsZHMucHVzaChmaWVsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjb25zdCBmaWVsZHMgb2YgT2JqZWN0LnZhbHVlcyh0aGlzLl9maWVsZE9iamVjdHMpKSB7CiAgICAgICAgICBhbGxGaWVsZHMucHVzaCguLi5maWVsZHMpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZTsKICAgICAgY29uc3QgYWxsSWRzID0gW107CiAgICAgIGZvciAoY29uc3QgZmllbGQgb2YgYWxsRmllbGRzKSB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgaWQKICAgICAgICB9ID0gZmllbGQ7CiAgICAgICAgYWxsSWRzLnB1c2goaWQpOwogICAgICAgIHN3aXRjaCAoZmllbGQudHlwZSkgewogICAgICAgICAgY2FzZSAidGV4dCI6IHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBmaWVsZC5kZWZhdWx0VmFsdWUgfHwgIiI7CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJjaGVja2JveCI6CiAgICAgICAgICBjYXNlICJyYWRpb2J1dHRvbiI6IHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBmaWVsZC5kZWZhdWx0VmFsdWUgPT09IGZpZWxkLmV4cG9ydFZhbHVlczsKICAgICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgImNvbWJvYm94IjoKICAgICAgICAgIGNhc2UgImxpc3Rib3giOiB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZmllbGQuZGVmYXVsdFZhbHVlIHx8ICIiOwogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGRvbUVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBbZGF0YS1lbGVtZW50LWlkPSIke2lkfSJdYCk7CiAgICAgICAgaWYgKCFkb21FbGVtZW50KSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IGVsc2UgaWYgKCFHZXRFbGVtZW50c0J5TmFtZVNldC5oYXMoZG9tRWxlbWVudCkpIHsKICAgICAgICAgIHdhcm4oYF9iaW5kUmVzZXRGb3JtQWN0aW9uIC0gZWxlbWVudCBub3QgYWxsb3dlZDogJHtpZH1gKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBkb21FbGVtZW50LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCJyZXNldGZvcm0iKSk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZW5hYmxlU2NyaXB0aW5nKSB7CiAgICAgICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goImRpc3BhdGNoZXZlbnRpbnNhbmRib3giLCB7CiAgICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgaWQ6ICJhcHAiLAogICAgICAgICAgICBpZHM6IGFsbElkcywKICAgICAgICAgICAgbmFtZTogIlJlc2V0Rm9ybSIKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwogIH0KfTsKdmFyIFRleHRBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgidGV4dEFubm90YXRpb24iKTsKICAgIGNvbnN0IGltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICBpbWFnZS5zcmMgPSB0aGlzLmltYWdlUmVzb3VyY2VzUGF0aCArICJhbm5vdGF0aW9uLSIgKyB0aGlzLmRhdGEubmFtZS50b0xvd2VyQ2FzZSgpICsgIi5zdmciOwogICAgaW1hZ2Uuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCAicGRmanMtdGV4dC1hbm5vdGF0aW9uLXR5cGUiKTsKICAgIGltYWdlLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWFyZ3MiLCBKU09OLnN0cmluZ2lmeSh7CiAgICAgIHR5cGU6IHRoaXMuZGF0YS5uYW1lCiAgICB9KSk7CiAgICBpZiAoIXRoaXMuZGF0YS5wb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKGltYWdlKTsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIHJlbmRlcigpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgc2hvd0VsZW1lbnRBbmRIaWRlQ2FudmFzKGVsZW1lbnQpIHsKICAgIGlmICh0aGlzLmRhdGEuaGFzT3duQ2FudmFzKSB7CiAgICAgIGlmIChlbGVtZW50LnByZXZpb3VzU2libGluZz8ubm9kZU5hbWUgPT09ICJDQU5WQVMiKSB7CiAgICAgICAgZWxlbWVudC5wcmV2aW91c1NpYmxpbmcuaGlkZGVuID0gdHJ1ZTsKICAgICAgfQogICAgICBlbGVtZW50LmhpZGRlbiA9IGZhbHNlOwogICAgfQogIH0KICBfZ2V0S2V5TW9kaWZpZXIoZXZlbnQpIHsKICAgIHJldHVybiB1dGlsX0ZlYXR1cmVUZXN0LnBsYXRmb3JtLmlzTWFjID8gZXZlbnQubWV0YUtleSA6IGV2ZW50LmN0cmxLZXk7CiAgfQogIF9zZXRFdmVudExpc3RlbmVyKGVsZW1lbnQsIGVsZW1lbnREYXRhLCBiYXNlTmFtZSwgZXZlbnROYW1lLCB2YWx1ZUdldHRlcikgewogICAgaWYgKGJhc2VOYW1lLmluY2x1ZGVzKCJtb3VzZSIpKSB7CiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihiYXNlTmFtZSwgKGV2ZW50KSA9PiB7CiAgICAgICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goImRpc3BhdGNoZXZlbnRpbnNhbmRib3giLCB7CiAgICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgaWQ6IHRoaXMuZGF0YS5pZCwKICAgICAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgICAgICB2YWx1ZTogdmFsdWVHZXR0ZXIoZXZlbnQpLAogICAgICAgICAgICBzaGlmdDogZXZlbnQuc2hpZnRLZXksCiAgICAgICAgICAgIG1vZGlmaWVyOiB0aGlzLl9nZXRLZXlNb2RpZmllcihldmVudCkKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoYmFzZU5hbWUsIChldmVudCkgPT4gewogICAgICAgIGlmIChiYXNlTmFtZSA9PT0gImJsdXIiKSB7CiAgICAgICAgICBpZiAoIWVsZW1lbnREYXRhLmZvY3VzZWQgfHwgIWV2ZW50LnJlbGF0ZWRUYXJnZXQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudERhdGEuZm9jdXNlZCA9IGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoYmFzZU5hbWUgPT09ICJmb2N1cyIpIHsKICAgICAgICAgIGlmIChlbGVtZW50RGF0YS5mb2N1c2VkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnREYXRhLmZvY3VzZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoIXZhbHVlR2V0dGVyKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMubGlua1NlcnZpY2UuZXZlbnRCdXM/LmRpc3BhdGNoKCJkaXNwYXRjaGV2ZW50aW5zYW5kYm94IiwgewogICAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgIGlkOiB0aGlzLmRhdGEuaWQsCiAgICAgICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICAgICAgdmFsdWU6IHZhbHVlR2V0dGVyKGV2ZW50KQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9CiAgX3NldEV2ZW50TGlzdGVuZXJzKGVsZW1lbnQsIGVsZW1lbnREYXRhLCBuYW1lcywgZ2V0dGVyKSB7CiAgICBmb3IgKGNvbnN0IFtiYXNlTmFtZSwgZXZlbnROYW1lXSBvZiBuYW1lcykgewogICAgICBpZiAoZXZlbnROYW1lID09PSAiQWN0aW9uIiB8fCB0aGlzLmRhdGEuYWN0aW9ucz8uW2V2ZW50TmFtZV0pIHsKICAgICAgICBpZiAoZXZlbnROYW1lID09PSAiRm9jdXMiIHx8IGV2ZW50TmFtZSA9PT0gIkJsdXIiKSB7CiAgICAgICAgICBlbGVtZW50RGF0YSB8fD0gewogICAgICAgICAgICBmb2N1c2VkOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fc2V0RXZlbnRMaXN0ZW5lcihlbGVtZW50LCBlbGVtZW50RGF0YSwgYmFzZU5hbWUsIGV2ZW50TmFtZSwgZ2V0dGVyKTsKICAgICAgICBpZiAoZXZlbnROYW1lID09PSAiRm9jdXMiICYmICF0aGlzLmRhdGEuYWN0aW9ucz8uQmx1cikgewogICAgICAgICAgdGhpcy5fc2V0RXZlbnRMaXN0ZW5lcihlbGVtZW50LCBlbGVtZW50RGF0YSwgImJsdXIiLCAiQmx1ciIsIG51bGwpOwogICAgICAgIH0gZWxzZSBpZiAoZXZlbnROYW1lID09PSAiQmx1ciIgJiYgIXRoaXMuZGF0YS5hY3Rpb25zPy5Gb2N1cykgewogICAgICAgICAgdGhpcy5fc2V0RXZlbnRMaXN0ZW5lcihlbGVtZW50LCBlbGVtZW50RGF0YSwgImZvY3VzIiwgIkZvY3VzIiwgbnVsbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIF9zZXRCYWNrZ3JvdW5kQ29sb3IoZWxlbWVudCkgewogICAgY29uc3QgY29sb3IgPSB0aGlzLmRhdGEuYmFja2dyb3VuZENvbG9yIHx8IG51bGw7CiAgICBlbGVtZW50LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yID09PSBudWxsID8gInRyYW5zcGFyZW50IiA6IFV0aWwubWFrZUhleENvbG9yKGNvbG9yWzBdLCBjb2xvclsxXSwgY29sb3JbMl0pOwogIH0KICBfc2V0VGV4dFN0eWxlKGVsZW1lbnQpIHsKICAgIGNvbnN0IFRFWFRfQUxJR05NRU5UID0gWyJsZWZ0IiwgImNlbnRlciIsICJyaWdodCJdOwogICAgY29uc3QgewogICAgICBmb250Q29sb3IKICAgIH0gPSB0aGlzLmRhdGEuZGVmYXVsdEFwcGVhcmFuY2VEYXRhOwogICAgY29uc3QgZm9udFNpemUgPSB0aGlzLmRhdGEuZGVmYXVsdEFwcGVhcmFuY2VEYXRhLmZvbnRTaXplIHx8IGFubm90YXRpb25fbGF5ZXJfREVGQVVMVF9GT05UX1NJWkU7CiAgICBjb25zdCBzdHlsZSA9IGVsZW1lbnQuc3R5bGU7CiAgICBsZXQgY29tcHV0ZWRGb250U2l6ZTsKICAgIGNvbnN0IEJPUkRFUl9TSVpFID0gMjsKICAgIGNvbnN0IHJvdW5kVG9PbmVEZWNpbWFsID0gKHgpID0+IE1hdGgucm91bmQoMTAgKiB4KSAvIDEwOwogICAgaWYgKHRoaXMuZGF0YS5tdWx0aUxpbmUpIHsKICAgICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5hYnModGhpcy5kYXRhLnJlY3RbM10gLSB0aGlzLmRhdGEucmVjdFsxXSAtIEJPUkRFUl9TSVpFKTsKICAgICAgY29uc3QgbnVtYmVyT2ZMaW5lcyA9IE1hdGgucm91bmQoaGVpZ2h0IC8gKExJTkVfRkFDVE9SICogZm9udFNpemUpKSB8fCAxOwogICAgICBjb25zdCBsaW5lSGVpZ2h0ID0gaGVpZ2h0IC8gbnVtYmVyT2ZMaW5lczsKICAgICAgY29tcHV0ZWRGb250U2l6ZSA9IE1hdGgubWluKGZvbnRTaXplLCByb3VuZFRvT25lRGVjaW1hbChsaW5lSGVpZ2h0IC8gTElORV9GQUNUT1IpKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGguYWJzKHRoaXMuZGF0YS5yZWN0WzNdIC0gdGhpcy5kYXRhLnJlY3RbMV0gLSBCT1JERVJfU0laRSk7CiAgICAgIGNvbXB1dGVkRm9udFNpemUgPSBNYXRoLm1pbihmb250U2l6ZSwgcm91bmRUb09uZURlY2ltYWwoaGVpZ2h0IC8gTElORV9GQUNUT1IpKTsKICAgIH0KICAgIHN0eWxlLmZvbnRTaXplID0gYGNhbGMoJHtjb21wdXRlZEZvbnRTaXplfXB4ICogdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSlgOwogICAgc3R5bGUuY29sb3IgPSBVdGlsLm1ha2VIZXhDb2xvcihmb250Q29sb3JbMF0sIGZvbnRDb2xvclsxXSwgZm9udENvbG9yWzJdKTsKICAgIGlmICh0aGlzLmRhdGEudGV4dEFsaWdubWVudCAhPT0gbnVsbCkgewogICAgICBzdHlsZS50ZXh0QWxpZ24gPSBURVhUX0FMSUdOTUVOVFt0aGlzLmRhdGEudGV4dEFsaWdubWVudF07CiAgICB9CiAgfQogIF9zZXRSZXF1aXJlZChlbGVtZW50LCBpc1JlcXVpcmVkKSB7CiAgICBpZiAoaXNSZXF1aXJlZCkgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgicmVxdWlyZWQiLCB0cnVlKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJyZXF1aXJlZCIpOwogICAgfQogICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImFyaWEtcmVxdWlyZWQiLCBpc1JlcXVpcmVkKTsKICB9Cn07CnZhciBUZXh0V2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIFdpZGdldEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCBpc1JlbmRlcmFibGUgPSBwYXJhbWV0ZXJzLnJlbmRlckZvcm1zIHx8IHBhcmFtZXRlcnMuZGF0YS5oYXNPd25DYW52YXMgfHwgIXBhcmFtZXRlcnMuZGF0YS5oYXNBcHBlYXJhbmNlICYmICEhcGFyYW1ldGVycy5kYXRhLmZpZWxkVmFsdWU7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZQogICAgfSk7CiAgfQogIHNldFByb3BlcnR5T25TaWJsaW5ncyhiYXNlLCBrZXksIHZhbHVlLCBrZXlJblN0b3JhZ2UpIHsKICAgIGNvbnN0IHN0b3JhZ2UgPSB0aGlzLmFubm90YXRpb25TdG9yYWdlOwogICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMuX2dldEVsZW1lbnRzQnlOYW1lKGJhc2UubmFtZSwgYmFzZS5pZCkpIHsKICAgICAgaWYgKGVsZW1lbnQuZG9tRWxlbWVudCkgewogICAgICAgIGVsZW1lbnQuZG9tRWxlbWVudFtrZXldID0gdmFsdWU7CiAgICAgIH0KICAgICAgc3RvcmFnZS5zZXRWYWx1ZShlbGVtZW50LmlkLCB7CiAgICAgICAgW2tleUluU3RvcmFnZV06IHZhbHVlCiAgICAgIH0pOwogICAgfQogIH0KICByZW5kZXIoKSB7CiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZTsKICAgIGNvbnN0IGlkID0gdGhpcy5kYXRhLmlkOwogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgidGV4dFdpZGdldEFubm90YXRpb24iKTsKICAgIGxldCBlbGVtZW50ID0gbnVsbDsKICAgIGlmICh0aGlzLnJlbmRlckZvcm1zKSB7CiAgICAgIGNvbnN0IHN0b3JlZERhdGEgPSBzdG9yYWdlLmdldFZhbHVlKGlkLCB7CiAgICAgICAgdmFsdWU6IHRoaXMuZGF0YS5maWVsZFZhbHVlCiAgICAgIH0pOwogICAgICBsZXQgdGV4dENvbnRlbnQgPSBzdG9yZWREYXRhLnZhbHVlIHx8ICIiOwogICAgICBjb25zdCBtYXhMZW4gPSBzdG9yYWdlLmdldFZhbHVlKGlkLCB7CiAgICAgICAgY2hhckxpbWl0OiB0aGlzLmRhdGEubWF4TGVuCiAgICAgIH0pLmNoYXJMaW1pdDsKICAgICAgaWYgKG1heExlbiAmJiB0ZXh0Q29udGVudC5sZW5ndGggPiBtYXhMZW4pIHsKICAgICAgICB0ZXh0Q29udGVudCA9IHRleHRDb250ZW50LnNsaWNlKDAsIG1heExlbik7CiAgICAgIH0KICAgICAgbGV0IGZpZWxkRm9ybWF0dGVkVmFsdWVzID0gc3RvcmVkRGF0YS5mb3JtYXR0ZWRWYWx1ZSB8fCB0aGlzLmRhdGEudGV4dENvbnRlbnQ/LmpvaW4oIlxuIikgfHwgbnVsbDsKICAgICAgaWYgKGZpZWxkRm9ybWF0dGVkVmFsdWVzICYmIHRoaXMuZGF0YS5jb21iKSB7CiAgICAgICAgZmllbGRGb3JtYXR0ZWRWYWx1ZXMgPSBmaWVsZEZvcm1hdHRlZFZhbHVlcy5yZXBsYWNlQWxsKC9ccysvZywgIiIpOwogICAgICB9CiAgICAgIGNvbnN0IGVsZW1lbnREYXRhID0gewogICAgICAgIHVzZXJWYWx1ZTogdGV4dENvbnRlbnQsCiAgICAgICAgZm9ybWF0dGVkVmFsdWU6IGZpZWxkRm9ybWF0dGVkVmFsdWVzLAogICAgICAgIGxhc3RDb21taXR0ZWRWYWx1ZTogbnVsbCwKICAgICAgICBjb21taXRLZXk6IDEsCiAgICAgICAgZm9jdXNlZDogZmFsc2UKICAgICAgfTsKICAgICAgaWYgKHRoaXMuZGF0YS5tdWx0aUxpbmUpIHsKICAgICAgICBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGV4dGFyZWEiKTsKICAgICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gZmllbGRGb3JtYXR0ZWRWYWx1ZXMgPz8gdGV4dENvbnRlbnQ7CiAgICAgICAgaWYgKHRoaXMuZGF0YS5kb05vdFNjcm9sbCkgewogICAgICAgICAgZWxlbWVudC5zdHlsZS5vdmVyZmxvd1kgPSAiaGlkZGVuIjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgZWxlbWVudC50eXBlID0gdGhpcy5kYXRhLnBhc3N3b3JkID8gInBhc3N3b3JkIiA6ICJ0ZXh0IjsKICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgidmFsdWUiLCBmaWVsZEZvcm1hdHRlZFZhbHVlcyA/PyB0ZXh0Q29udGVudCk7CiAgICAgICAgaWYgKHRoaXMuZGF0YS5kb05vdFNjcm9sbCkgewogICAgICAgICAgZWxlbWVudC5zdHlsZS5vdmVyZmxvd1ggPSAiaGlkZGVuIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZGF0YS5oYXNPd25DYW52YXMpIHsKICAgICAgICBlbGVtZW50LmhpZGRlbiA9IHRydWU7CiAgICAgIH0KICAgICAgR2V0RWxlbWVudHNCeU5hbWVTZXQuYWRkKGVsZW1lbnQpOwogICAgICB0aGlzLmNvbnRlbnRFbGVtZW50ID0gZWxlbWVudDsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtZWxlbWVudC1pZCIsIGlkKTsKICAgICAgZWxlbWVudC5kaXNhYmxlZCA9IHRoaXMuZGF0YS5yZWFkT25seTsKICAgICAgZWxlbWVudC5uYW1lID0gdGhpcy5kYXRhLmZpZWxkTmFtZTsKICAgICAgZWxlbWVudC50YWJJbmRleCA9IDA7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRldGltZUZvcm1hdCwKICAgICAgICBkYXRldGltZVR5cGUsCiAgICAgICAgdGltZVN0ZXAKICAgICAgfSA9IHRoaXMuZGF0YTsKICAgICAgY29uc3QgaGFzRGF0ZU9yVGltZSA9ICEhZGF0ZXRpbWVUeXBlICYmIHRoaXMuZW5hYmxlU2NyaXB0aW5nOwogICAgICBpZiAoZGF0ZXRpbWVGb3JtYXQpIHsKICAgICAgICBlbGVtZW50LnRpdGxlID0gZGF0ZXRpbWVGb3JtYXQ7CiAgICAgIH0KICAgICAgdGhpcy5fc2V0UmVxdWlyZWQoZWxlbWVudCwgdGhpcy5kYXRhLnJlcXVpcmVkKTsKICAgICAgaWYgKG1heExlbikgewogICAgICAgIGVsZW1lbnQubWF4TGVuZ3RoID0gbWF4TGVuOwogICAgICB9CiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCAoZXZlbnQpID0+IHsKICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICB2YWx1ZTogZXZlbnQudGFyZ2V0LnZhbHVlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zZXRQcm9wZXJ0eU9uU2libGluZ3MoZWxlbWVudCwgInZhbHVlIiwgZXZlbnQudGFyZ2V0LnZhbHVlLCAidmFsdWUiKTsKICAgICAgICBlbGVtZW50RGF0YS5mb3JtYXR0ZWRWYWx1ZSA9IG51bGw7CiAgICAgIH0pOwogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInJlc2V0Zm9ybSIsIChldmVudCkgPT4gewogICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IHRoaXMuZGF0YS5kZWZhdWx0RmllbGRWYWx1ZSA/PyAiIjsKICAgICAgICBlbGVtZW50LnZhbHVlID0gZWxlbWVudERhdGEudXNlclZhbHVlID0gZGVmYXVsdFZhbHVlOwogICAgICAgIGVsZW1lbnREYXRhLmZvcm1hdHRlZFZhbHVlID0gbnVsbDsKICAgICAgfSk7CiAgICAgIGxldCBibHVyTGlzdGVuZXIgPSAoZXZlbnQpID0+IHsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBmb3JtYXR0ZWRWYWx1ZQogICAgICAgIH0gPSBlbGVtZW50RGF0YTsKICAgICAgICBpZiAoZm9ybWF0dGVkVmFsdWUgIT09IG51bGwgJiYgZm9ybWF0dGVkVmFsdWUgIT09IHZvaWQgMCkgewogICAgICAgICAgZXZlbnQudGFyZ2V0LnZhbHVlID0gZm9ybWF0dGVkVmFsdWU7CiAgICAgICAgfQogICAgICAgIGV2ZW50LnRhcmdldC5zY3JvbGxMZWZ0ID0gMDsKICAgICAgfTsKICAgICAgaWYgKHRoaXMuZW5hYmxlU2NyaXB0aW5nICYmIHRoaXMuaGFzSlNBY3Rpb25zKSB7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJmb2N1cyIsIChldmVudCkgPT4gewogICAgICAgICAgaWYgKGVsZW1lbnREYXRhLmZvY3VzZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgewogICAgICAgICAgICB0YXJnZXQKICAgICAgICAgIH0gPSBldmVudDsKICAgICAgICAgIGlmIChoYXNEYXRlT3JUaW1lKSB7CiAgICAgICAgICAgIHRhcmdldC50eXBlID0gZGF0ZXRpbWVUeXBlOwogICAgICAgICAgICBpZiAodGltZVN0ZXApIHsKICAgICAgICAgICAgICB0YXJnZXQuc3RlcCA9IHRpbWVTdGVwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZWxlbWVudERhdGEudXNlclZhbHVlKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZWxlbWVudERhdGEudXNlclZhbHVlOwogICAgICAgICAgICBpZiAoaGFzRGF0ZU9yVGltZSkgewogICAgICAgICAgICAgIGlmIChkYXRldGltZVR5cGUgPT09ICJ0aW1lIikgewogICAgICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gW2RhdGUuZ2V0SG91cnMoKSwgZGF0ZS5nZXRNaW51dGVzKCksIGRhdGUuZ2V0U2Vjb25kcygpXTsKICAgICAgICAgICAgICAgIHRhcmdldC52YWx1ZSA9IHBhcnRzLm1hcCgodikgPT4gdi50b1N0cmluZygpLnBhZFN0YXJ0KDIsICIwIikpLmpvaW4oIjoiKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFyZ2V0LnZhbHVlID0gbmV3IERhdGUodmFsdWUgLSBUSU1FWk9ORV9PRkZTRVQpLnRvSVNPU3RyaW5nKCkuc3BsaXQoZGF0ZXRpbWVUeXBlID09PSAiZGF0ZSIgPyAiVCIgOiAiLiIsIDEpWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0YXJnZXQudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudERhdGEubGFzdENvbW1pdHRlZFZhbHVlID0gdGFyZ2V0LnZhbHVlOwogICAgICAgICAgZWxlbWVudERhdGEuY29tbWl0S2V5ID0gMTsKICAgICAgICAgIGlmICghdGhpcy5kYXRhLmFjdGlvbnM/LkZvY3VzKSB7CiAgICAgICAgICAgIGVsZW1lbnREYXRhLmZvY3VzZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidXBkYXRlZnJvbXNhbmRib3giLCAoanNFdmVudCkgPT4gewogICAgICAgICAgdGhpcy5zaG93RWxlbWVudEFuZEhpZGVDYW52YXMoanNFdmVudC50YXJnZXQpOwogICAgICAgICAgY29uc3QgYWN0aW9ucyA9IHsKICAgICAgICAgICAgdmFsdWUoZXZlbnQpIHsKICAgICAgICAgICAgICBlbGVtZW50RGF0YS51c2VyVmFsdWUgPSBldmVudC5kZXRhaWwudmFsdWUgPz8gIiI7CiAgICAgICAgICAgICAgaWYgKCFoYXNEYXRlT3JUaW1lKSB7CiAgICAgICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBlbGVtZW50RGF0YS51c2VyVmFsdWUudG9TdHJpbmcoKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IGVsZW1lbnREYXRhLnVzZXJWYWx1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZm9ybWF0dGVkVmFsdWUoZXZlbnQpIHsKICAgICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAgICBmb3JtYXR0ZWRWYWx1ZQogICAgICAgICAgICAgIH0gPSBldmVudC5kZXRhaWw7CiAgICAgICAgICAgICAgZWxlbWVudERhdGEuZm9ybWF0dGVkVmFsdWUgPSBmb3JtYXR0ZWRWYWx1ZTsKICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVkVmFsdWUgIT09IG51bGwgJiYgZm9ybWF0dGVkVmFsdWUgIT09IHZvaWQgMCAmJiBldmVudC50YXJnZXQgIT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IGZvcm1hdHRlZFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBkYXRhID0gewogICAgICAgICAgICAgICAgZm9ybWF0dGVkVmFsdWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChoYXNEYXRlT3JUaW1lKSB7CiAgICAgICAgICAgICAgICBkYXRhLnZhbHVlID0gZm9ybWF0dGVkVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIGRhdGEpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZWxSYW5nZShldmVudCkgewogICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5zZXRTZWxlY3Rpb25SYW5nZSguLi5ldmVudC5kZXRhaWwuc2VsUmFuZ2UpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGFyTGltaXQ6IChldmVudCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICAgIGNoYXJMaW1pdAogICAgICAgICAgICAgIH0gPSBldmVudC5kZXRhaWw7CiAgICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgICAgdGFyZ2V0CiAgICAgICAgICAgICAgfSA9IGV2ZW50OwogICAgICAgICAgICAgIGlmIChjaGFyTGltaXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHRhcmdldC5yZW1vdmVBdHRyaWJ1dGUoIm1heExlbmd0aCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0YXJnZXQuc2V0QXR0cmlidXRlKCJtYXhMZW5ndGgiLCBjaGFyTGltaXQpOwogICAgICAgICAgICAgIGxldCB2YWx1ZSA9IGVsZW1lbnREYXRhLnVzZXJWYWx1ZTsKICAgICAgICAgICAgICBpZiAoIXZhbHVlIHx8IHZhbHVlLmxlbmd0aCA8PSBjaGFyTGltaXQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZSgwLCBjaGFyTGltaXQpOwogICAgICAgICAgICAgIHRhcmdldC52YWx1ZSA9IGVsZW1lbnREYXRhLnVzZXJWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goImRpc3BhdGNoZXZlbnRpbnNhbmRib3giLCB7CiAgICAgICAgICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgICAgICAgaWQsCiAgICAgICAgICAgICAgICAgIG5hbWU6ICJLZXlzdHJva2UiLAogICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgd2lsbENvbW1pdDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgY29tbWl0S2V5OiAxLAogICAgICAgICAgICAgICAgICBzZWxTdGFydDogdGFyZ2V0LnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgICAgICBzZWxFbmQ6IHRhcmdldC5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuX2Rpc3BhdGNoRXZlbnRGcm9tU2FuZGJveChhY3Rpb25zLCBqc0V2ZW50KTsKICAgICAgICB9KTsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCAoZXZlbnQpID0+IHsKICAgICAgICAgIGVsZW1lbnREYXRhLmNvbW1pdEtleSA9IDE7CiAgICAgICAgICBsZXQgY29tbWl0S2V5ID0gLTE7CiAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAiRXNjYXBlIikgewogICAgICAgICAgICBjb21taXRLZXkgPSAwOwogICAgICAgICAgfSBlbHNlIGlmIChldmVudC5rZXkgPT09ICJFbnRlciIgJiYgIXRoaXMuZGF0YS5tdWx0aUxpbmUpIHsKICAgICAgICAgICAgY29tbWl0S2V5ID0gMjsKICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSAiVGFiIikgewogICAgICAgICAgICBlbGVtZW50RGF0YS5jb21taXRLZXkgPSAzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbW1pdEtleSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgewogICAgICAgICAgICB2YWx1ZQogICAgICAgICAgfSA9IGV2ZW50LnRhcmdldDsKICAgICAgICAgIGlmIChlbGVtZW50RGF0YS5sYXN0Q29tbWl0dGVkVmFsdWUgPT09IHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnREYXRhLmxhc3RDb21taXR0ZWRWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgZWxlbWVudERhdGEudXNlclZhbHVlID0gdmFsdWU7CiAgICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLmV2ZW50QnVzPy5kaXNwYXRjaCgiZGlzcGF0Y2hldmVudGluc2FuZGJveCIsIHsKICAgICAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgICBpZCwKICAgICAgICAgICAgICBuYW1lOiAiS2V5c3Ryb2tlIiwKICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICB3aWxsQ29tbWl0OiB0cnVlLAogICAgICAgICAgICAgIGNvbW1pdEtleSwKICAgICAgICAgICAgICBzZWxTdGFydDogZXZlbnQudGFyZ2V0LnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIHNlbEVuZDogZXZlbnQudGFyZ2V0LnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBfYmx1ckxpc3RlbmVyID0gYmx1ckxpc3RlbmVyOwogICAgICAgIGJsdXJMaXN0ZW5lciA9IG51bGw7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICBpZiAoIWVsZW1lbnREYXRhLmZvY3VzZWQgfHwgIWV2ZW50LnJlbGF0ZWRUYXJnZXQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0aGlzLmRhdGEuYWN0aW9ucz8uQmx1cikgewogICAgICAgICAgICBlbGVtZW50RGF0YS5mb2N1c2VkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgIHRhcmdldAogICAgICAgICAgfSA9IGV2ZW50OwogICAgICAgICAgbGV0IHsKICAgICAgICAgICAgdmFsdWUKICAgICAgICAgIH0gPSB0YXJnZXQ7CiAgICAgICAgICBpZiAoaGFzRGF0ZU9yVGltZSkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgZGF0ZXRpbWVUeXBlID09PSAidGltZSIpIHsKICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHZhbHVlLnNwbGl0KCI6IikubWFwKCh2KSA9PiBwYXJzZUludCh2LCAxMCkpOwogICAgICAgICAgICAgIHZhbHVlID0gbmV3IERhdGUoMmUzLCAwLCAxLCBwYXJ0c1swXSwgcGFydHNbMV0sIHBhcnRzWzJdIHx8IDApLnZhbHVlT2YoKTsKICAgICAgICAgICAgICB0YXJnZXQuc3RlcCA9ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghdmFsdWUuaW5jbHVkZXMoIlQiKSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSBgJHt2YWx1ZX1UMDA6MDBgOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YWx1ZSA9IG5ldyBEYXRlKHZhbHVlKS52YWx1ZU9mKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0LnR5cGUgPSAidGV4dCI7CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50RGF0YS51c2VyVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIGlmIChlbGVtZW50RGF0YS5sYXN0Q29tbWl0dGVkVmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMubGlua1NlcnZpY2UuZXZlbnRCdXM/LmRpc3BhdGNoKCJkaXNwYXRjaGV2ZW50aW5zYW5kYm94IiwgewogICAgICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgICAgIGlkLAogICAgICAgICAgICAgICAgbmFtZTogIktleXN0cm9rZSIsCiAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgIHdpbGxDb21taXQ6IHRydWUsCiAgICAgICAgICAgICAgICBjb21taXRLZXk6IGVsZW1lbnREYXRhLmNvbW1pdEtleSwKICAgICAgICAgICAgICAgIHNlbFN0YXJ0OiBldmVudC50YXJnZXQuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgICBzZWxFbmQ6IGV2ZW50LnRhcmdldC5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgX2JsdXJMaXN0ZW5lcihldmVudCk7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuZGF0YS5hY3Rpb25zPy5LZXlzdHJva2UpIHsKICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiYmVmb3JlaW5wdXQiLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgZWxlbWVudERhdGEubGFzdENvbW1pdHRlZFZhbHVlID0gbnVsbDsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGRhdGEsCiAgICAgICAgICAgICAgdGFyZ2V0CiAgICAgICAgICAgIH0gPSBldmVudDsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICAgIHNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIHNlbGVjdGlvbkVuZAogICAgICAgICAgICB9ID0gdGFyZ2V0OwogICAgICAgICAgICBsZXQgc2VsU3RhcnQgPSBzZWxlY3Rpb25TdGFydCwgc2VsRW5kID0gc2VsZWN0aW9uRW5kOwogICAgICAgICAgICBzd2l0Y2ggKGV2ZW50LmlucHV0VHlwZSkgewogICAgICAgICAgICAgIGNhc2UgImRlbGV0ZVdvcmRCYWNrd2FyZCI6IHsKICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gdmFsdWUuc3Vic3RyaW5nKDAsIHNlbGVjdGlvblN0YXJ0KS5tYXRjaCgvXHcqW15cd10qJC8pOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgIHNlbFN0YXJ0IC09IG1hdGNoWzBdLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJkZWxldGVXb3JkRm9yd2FyZCI6IHsKICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gdmFsdWUuc3Vic3RyaW5nKHNlbGVjdGlvblN0YXJ0KS5tYXRjaCgvXlteXHddKlx3Ki8pOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgIHNlbEVuZCArPSBtYXRjaFswXS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAiZGVsZXRlQ29udGVudEJhY2t3YXJkIjoKICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rpb25TdGFydCA9PT0gc2VsZWN0aW9uRW5kKSB7CiAgICAgICAgICAgICAgICAgIHNlbFN0YXJ0IC09IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJkZWxldGVDb250ZW50Rm9yd2FyZCI6CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0aW9uU3RhcnQgPT09IHNlbGVjdGlvbkVuZCkgewogICAgICAgICAgICAgICAgICBzZWxFbmQgKz0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHRoaXMubGlua1NlcnZpY2UuZXZlbnRCdXM/LmRpc3BhdGNoKCJkaXNwYXRjaGV2ZW50aW5zYW5kYm94IiwgewogICAgICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgICAgIGlkLAogICAgICAgICAgICAgICAgbmFtZTogIktleXN0cm9rZSIsCiAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgIGNoYW5nZTogZGF0YSB8fCAiIiwKICAgICAgICAgICAgICAgIHdpbGxDb21taXQ6IGZhbHNlLAogICAgICAgICAgICAgICAgc2VsU3RhcnQsCiAgICAgICAgICAgICAgICBzZWxFbmQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3NldEV2ZW50TGlzdGVuZXJzKGVsZW1lbnQsIGVsZW1lbnREYXRhLCBbWyJmb2N1cyIsICJGb2N1cyJdLCBbImJsdXIiLCAiQmx1ciJdLCBbIm1vdXNlZG93biIsICJNb3VzZSBEb3duIl0sIFsibW91c2VlbnRlciIsICJNb3VzZSBFbnRlciJdLCBbIm1vdXNlbGVhdmUiLCAiTW91c2UgRXhpdCJdLCBbIm1vdXNldXAiLCAiTW91c2UgVXAiXV0sIChldmVudCkgPT4gZXZlbnQudGFyZ2V0LnZhbHVlKTsKICAgICAgfQogICAgICBpZiAoYmx1ckxpc3RlbmVyKSB7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgYmx1ckxpc3RlbmVyKTsKICAgICAgfQogICAgICBpZiAodGhpcy5kYXRhLmNvbWIpIHsKICAgICAgICBjb25zdCBmaWVsZFdpZHRoID0gdGhpcy5kYXRhLnJlY3RbMl0gLSB0aGlzLmRhdGEucmVjdFswXTsKICAgICAgICBjb25zdCBjb21iV2lkdGggPSBmaWVsZFdpZHRoIC8gbWF4TGVuOwogICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgiY29tYiIpOwogICAgICAgIGVsZW1lbnQuc3R5bGUubGV0dGVyU3BhY2luZyA9IGBjYWxjKCR7Y29tYldpZHRofXB4ICogdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSAtIDFjaClgOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGVsZW1lbnQudGV4dENvbnRlbnQgPSB0aGlzLmRhdGEuZmllbGRWYWx1ZTsKICAgICAgZWxlbWVudC5zdHlsZS52ZXJ0aWNhbEFsaWduID0gIm1pZGRsZSI7CiAgICAgIGVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJ0YWJsZS1jZWxsIjsKICAgICAgaWYgKHRoaXMuZGF0YS5oYXNPd25DYW52YXMpIHsKICAgICAgICBlbGVtZW50LmhpZGRlbiA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3NldFRleHRTdHlsZShlbGVtZW50KTsKICAgIHRoaXMuX3NldEJhY2tncm91bmRDb2xvcihlbGVtZW50KTsKICAgIHRoaXMuX3NldERlZmF1bHRQcm9wZXJ0aWVzRnJvbUpTKGVsZW1lbnQpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKGVsZW1lbnQpOwogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIFNpZ25hdHVyZVdpZGdldEFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6ICEhcGFyYW1ldGVycy5kYXRhLmhhc093bkNhbnZhcwogICAgfSk7CiAgfQp9Owp2YXIgQ2hlY2tib3hXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiBwYXJhbWV0ZXJzLnJlbmRlckZvcm1zCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuYW5ub3RhdGlvblN0b3JhZ2U7CiAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgY29uc3QgaWQgPSBkYXRhLmlkOwogICAgbGV0IHZhbHVlID0gc3RvcmFnZS5nZXRWYWx1ZShpZCwgewogICAgICB2YWx1ZTogZGF0YS5leHBvcnRWYWx1ZSA9PT0gZGF0YS5maWVsZFZhbHVlCiAgICB9KS52YWx1ZTsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgIHZhbHVlID0gdmFsdWUgIT09ICJPZmYiOwogICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgdmFsdWUKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJidXR0b25XaWRnZXRBbm5vdGF0aW9uIiwgImNoZWNrQm94Iik7CiAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIEdldEVsZW1lbnRzQnlOYW1lU2V0LmFkZChlbGVtZW50KTsKICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJkYXRhLWVsZW1lbnQtaWQiLCBpZCk7CiAgICBlbGVtZW50LmRpc2FibGVkID0gZGF0YS5yZWFkT25seTsKICAgIHRoaXMuX3NldFJlcXVpcmVkKGVsZW1lbnQsIHRoaXMuZGF0YS5yZXF1aXJlZCk7CiAgICBlbGVtZW50LnR5cGUgPSAiY2hlY2tib3giOwogICAgZWxlbWVudC5uYW1lID0gZGF0YS5maWVsZE5hbWU7CiAgICBpZiAodmFsdWUpIHsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImNoZWNrZWQiLCB0cnVlKTsKICAgIH0KICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJleHBvcnRWYWx1ZSIsIGRhdGEuZXhwb3J0VmFsdWUpOwogICAgZWxlbWVudC50YWJJbmRleCA9IDA7CiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIChldmVudCkgPT4gewogICAgICBjb25zdCB7CiAgICAgICAgbmFtZSwKICAgICAgICBjaGVja2VkCiAgICAgIH0gPSBldmVudC50YXJnZXQ7CiAgICAgIGZvciAoY29uc3QgY2hlY2tib3ggb2YgdGhpcy5fZ2V0RWxlbWVudHNCeU5hbWUobmFtZSwgaWQpKSB7CiAgICAgICAgY29uc3QgY3VyQ2hlY2tlZCA9IGNoZWNrZWQgJiYgY2hlY2tib3guZXhwb3J0VmFsdWUgPT09IGRhdGEuZXhwb3J0VmFsdWU7CiAgICAgICAgaWYgKGNoZWNrYm94LmRvbUVsZW1lbnQpIHsKICAgICAgICAgIGNoZWNrYm94LmRvbUVsZW1lbnQuY2hlY2tlZCA9IGN1ckNoZWNrZWQ7CiAgICAgICAgfQogICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoY2hlY2tib3guaWQsIHsKICAgICAgICAgIHZhbHVlOiBjdXJDaGVja2VkCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgIHZhbHVlOiBjaGVja2VkCiAgICAgIH0pOwogICAgfSk7CiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInJlc2V0Zm9ybSIsIChldmVudCkgPT4gewogICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBkYXRhLmRlZmF1bHRGaWVsZFZhbHVlIHx8ICJPZmYiOwogICAgICBldmVudC50YXJnZXQuY2hlY2tlZCA9IGRlZmF1bHRWYWx1ZSA9PT0gZGF0YS5leHBvcnRWYWx1ZTsKICAgIH0pOwogICAgaWYgKHRoaXMuZW5hYmxlU2NyaXB0aW5nICYmIHRoaXMuaGFzSlNBY3Rpb25zKSB7CiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidXBkYXRlZnJvbXNhbmRib3giLCAoanNFdmVudCkgPT4gewogICAgICAgIGNvbnN0IGFjdGlvbnMgPSB7CiAgICAgICAgICB2YWx1ZShldmVudCkgewogICAgICAgICAgICBldmVudC50YXJnZXQuY2hlY2tlZCA9IGV2ZW50LmRldGFpbC52YWx1ZSAhPT0gIk9mZiI7CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogZXZlbnQudGFyZ2V0LmNoZWNrZWQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0aGlzLl9kaXNwYXRjaEV2ZW50RnJvbVNhbmRib3goYWN0aW9ucywganNFdmVudCk7CiAgICAgIH0pOwogICAgICB0aGlzLl9zZXRFdmVudExpc3RlbmVycyhlbGVtZW50LCBudWxsLCBbWyJjaGFuZ2UiLCAiVmFsaWRhdGUiXSwgWyJjaGFuZ2UiLCAiQWN0aW9uIl0sIFsiZm9jdXMiLCAiRm9jdXMiXSwgWyJibHVyIiwgIkJsdXIiXSwgWyJtb3VzZWRvd24iLCAiTW91c2UgRG93biJdLCBbIm1vdXNlZW50ZXIiLCAiTW91c2UgRW50ZXIiXSwgWyJtb3VzZWxlYXZlIiwgIk1vdXNlIEV4aXQiXSwgWyJtb3VzZXVwIiwgIk1vdXNlIFVwIl1dLCAoZXZlbnQpID0+IGV2ZW50LnRhcmdldC5jaGVja2VkKTsKICAgIH0KICAgIHRoaXMuX3NldEJhY2tncm91bmRDb2xvcihlbGVtZW50KTsKICAgIHRoaXMuX3NldERlZmF1bHRQcm9wZXJ0aWVzRnJvbUpTKGVsZW1lbnQpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKGVsZW1lbnQpOwogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIFJhZGlvQnV0dG9uV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIFdpZGdldEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogcGFyYW1ldGVycy5yZW5kZXJGb3JtcwogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImJ1dHRvbldpZGdldEFubm90YXRpb24iLCAicmFkaW9CdXR0b24iKTsKICAgIGNvbnN0IHN0b3JhZ2UgPSB0aGlzLmFubm90YXRpb25TdG9yYWdlOwogICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgIGNvbnN0IGlkID0gZGF0YS5pZDsKICAgIGxldCB2YWx1ZSA9IHN0b3JhZ2UuZ2V0VmFsdWUoaWQsIHsKICAgICAgdmFsdWU6IGRhdGEuZmllbGRWYWx1ZSA9PT0gZGF0YS5idXR0b25WYWx1ZQogICAgfSkudmFsdWU7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICB2YWx1ZSA9IHZhbHVlICE9PSBkYXRhLmJ1dHRvblZhbHVlOwogICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgdmFsdWUKICAgICAgfSk7CiAgICB9CiAgICBpZiAodmFsdWUpIHsKICAgICAgZm9yIChjb25zdCByYWRpbyBvZiB0aGlzLl9nZXRFbGVtZW50c0J5TmFtZShkYXRhLmZpZWxkTmFtZSwgaWQpKSB7CiAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShyYWRpby5pZCwgewogICAgICAgICAgdmFsdWU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgR2V0RWxlbWVudHNCeU5hbWVTZXQuYWRkKGVsZW1lbnQpOwogICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtZWxlbWVudC1pZCIsIGlkKTsKICAgIGVsZW1lbnQuZGlzYWJsZWQgPSBkYXRhLnJlYWRPbmx5OwogICAgdGhpcy5fc2V0UmVxdWlyZWQoZWxlbWVudCwgdGhpcy5kYXRhLnJlcXVpcmVkKTsKICAgIGVsZW1lbnQudHlwZSA9ICJyYWRpbyI7CiAgICBlbGVtZW50Lm5hbWUgPSBkYXRhLmZpZWxkTmFtZTsKICAgIGlmICh2YWx1ZSkgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiY2hlY2tlZCIsIHRydWUpOwogICAgfQogICAgZWxlbWVudC50YWJJbmRleCA9IDA7CiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNoYW5nZSIsIChldmVudCkgPT4gewogICAgICBjb25zdCB7CiAgICAgICAgbmFtZSwKICAgICAgICBjaGVja2VkCiAgICAgIH0gPSBldmVudC50YXJnZXQ7CiAgICAgIGZvciAoY29uc3QgcmFkaW8gb2YgdGhpcy5fZ2V0RWxlbWVudHNCeU5hbWUobmFtZSwgaWQpKSB7CiAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShyYWRpby5pZCwgewogICAgICAgICAgdmFsdWU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgIHZhbHVlOiBjaGVja2VkCiAgICAgIH0pOwogICAgfSk7CiAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInJlc2V0Zm9ybSIsIChldmVudCkgPT4gewogICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBkYXRhLmRlZmF1bHRGaWVsZFZhbHVlOwogICAgICBldmVudC50YXJnZXQuY2hlY2tlZCA9IGRlZmF1bHRWYWx1ZSAhPT0gbnVsbCAmJiBkZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiBkZWZhdWx0VmFsdWUgPT09IGRhdGEuYnV0dG9uVmFsdWU7CiAgICB9KTsKICAgIGlmICh0aGlzLmVuYWJsZVNjcmlwdGluZyAmJiB0aGlzLmhhc0pTQWN0aW9ucykgewogICAgICBjb25zdCBwZGZCdXR0b25WYWx1ZSA9IGRhdGEuYnV0dG9uVmFsdWU7CiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidXBkYXRlZnJvbXNhbmRib3giLCAoanNFdmVudCkgPT4gewogICAgICAgIGNvbnN0IGFjdGlvbnMgPSB7CiAgICAgICAgICB2YWx1ZTogKGV2ZW50KSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNoZWNrZWQgPSBwZGZCdXR0b25WYWx1ZSA9PT0gZXZlbnQuZGV0YWlsLnZhbHVlOwogICAgICAgICAgICBmb3IgKGNvbnN0IHJhZGlvIG9mIHRoaXMuX2dldEVsZW1lbnRzQnlOYW1lKGV2ZW50LnRhcmdldC5uYW1lKSkgewogICAgICAgICAgICAgIGNvbnN0IGN1ckNoZWNrZWQgPSBjaGVja2VkICYmIHJhZGlvLmlkID09PSBpZDsKICAgICAgICAgICAgICBpZiAocmFkaW8uZG9tRWxlbWVudCkgewogICAgICAgICAgICAgICAgcmFkaW8uZG9tRWxlbWVudC5jaGVja2VkID0gY3VyQ2hlY2tlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShyYWRpby5pZCwgewogICAgICAgICAgICAgICAgdmFsdWU6IGN1ckNoZWNrZWQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudEZyb21TYW5kYm94KGFjdGlvbnMsIGpzRXZlbnQpOwogICAgICB9KTsKICAgICAgdGhpcy5fc2V0RXZlbnRMaXN0ZW5lcnMoZWxlbWVudCwgbnVsbCwgW1siY2hhbmdlIiwgIlZhbGlkYXRlIl0sIFsiY2hhbmdlIiwgIkFjdGlvbiJdLCBbImZvY3VzIiwgIkZvY3VzIl0sIFsiYmx1ciIsICJCbHVyIl0sIFsibW91c2Vkb3duIiwgIk1vdXNlIERvd24iXSwgWyJtb3VzZWVudGVyIiwgIk1vdXNlIEVudGVyIl0sIFsibW91c2VsZWF2ZSIsICJNb3VzZSBFeGl0Il0sIFsibW91c2V1cCIsICJNb3VzZSBVcCJdXSwgKGV2ZW50KSA9PiBldmVudC50YXJnZXQuY2hlY2tlZCk7CiAgICB9CiAgICB0aGlzLl9zZXRCYWNrZ3JvdW5kQ29sb3IoZWxlbWVudCk7CiAgICB0aGlzLl9zZXREZWZhdWx0UHJvcGVydGllc0Zyb21KUyhlbGVtZW50KTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChlbGVtZW50KTsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBQdXNoQnV0dG9uV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIExpbmtBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpZ25vcmVCb3JkZXI6IHBhcmFtZXRlcnMuZGF0YS5oYXNBcHBlYXJhbmNlCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3QgY29udGFpbmVyMiA9IHN1cGVyLnJlbmRlcigpOwogICAgY29udGFpbmVyMi5jbGFzc0xpc3QuYWRkKCJidXR0b25XaWRnZXRBbm5vdGF0aW9uIiwgInB1c2hCdXR0b24iKTsKICAgIGNvbnN0IGxpbmtFbGVtZW50ID0gY29udGFpbmVyMi5sYXN0Q2hpbGQ7CiAgICBpZiAodGhpcy5lbmFibGVTY3JpcHRpbmcgJiYgdGhpcy5oYXNKU0FjdGlvbnMgJiYgbGlua0VsZW1lbnQpIHsKICAgICAgdGhpcy5fc2V0RGVmYXVsdFByb3BlcnRpZXNGcm9tSlMobGlua0VsZW1lbnQpOwogICAgICBsaW5rRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJ1cGRhdGVmcm9tc2FuZGJveCIsIChqc0V2ZW50KSA9PiB7CiAgICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudEZyb21TYW5kYm94KHt9LCBqc0V2ZW50KTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gY29udGFpbmVyMjsKICB9Cn07CnZhciBDaG9pY2VXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiBwYXJhbWV0ZXJzLnJlbmRlckZvcm1zCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiY2hvaWNlV2lkZ2V0QW5ub3RhdGlvbiIpOwogICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuYW5ub3RhdGlvblN0b3JhZ2U7CiAgICBjb25zdCBpZCA9IHRoaXMuZGF0YS5pZDsKICAgIGNvbnN0IHN0b3JlZERhdGEgPSBzdG9yYWdlLmdldFZhbHVlKGlkLCB7CiAgICAgIHZhbHVlOiB0aGlzLmRhdGEuZmllbGRWYWx1ZQogICAgfSk7CiAgICBjb25zdCBzZWxlY3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2VsZWN0Iik7CiAgICBHZXRFbGVtZW50c0J5TmFtZVNldC5hZGQoc2VsZWN0RWxlbWVudCk7CiAgICBzZWxlY3RFbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1lbGVtZW50LWlkIiwgaWQpOwogICAgc2VsZWN0RWxlbWVudC5kaXNhYmxlZCA9IHRoaXMuZGF0YS5yZWFkT25seTsKICAgIHRoaXMuX3NldFJlcXVpcmVkKHNlbGVjdEVsZW1lbnQsIHRoaXMuZGF0YS5yZXF1aXJlZCk7CiAgICBzZWxlY3RFbGVtZW50Lm5hbWUgPSB0aGlzLmRhdGEuZmllbGROYW1lOwogICAgc2VsZWN0RWxlbWVudC50YWJJbmRleCA9IDA7CiAgICBsZXQgYWRkQW5FbXB0eUVudHJ5ID0gdGhpcy5kYXRhLmNvbWJvICYmIHRoaXMuZGF0YS5vcHRpb25zLmxlbmd0aCA+IDA7CiAgICBpZiAoIXRoaXMuZGF0YS5jb21ibykgewogICAgICBzZWxlY3RFbGVtZW50LnNpemUgPSB0aGlzLmRhdGEub3B0aW9ucy5sZW5ndGg7CiAgICAgIGlmICh0aGlzLmRhdGEubXVsdGlTZWxlY3QpIHsKICAgICAgICBzZWxlY3RFbGVtZW50Lm11bHRpcGxlID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgc2VsZWN0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJyZXNldGZvcm0iLCAoZXZlbnQpID0+IHsKICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gdGhpcy5kYXRhLmRlZmF1bHRGaWVsZFZhbHVlOwogICAgICBmb3IgKGNvbnN0IG9wdGlvbiBvZiBzZWxlY3RFbGVtZW50Lm9wdGlvbnMpIHsKICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24udmFsdWUgPT09IGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgfSk7CiAgICBmb3IgKGNvbnN0IG9wdGlvbiBvZiB0aGlzLmRhdGEub3B0aW9ucykgewogICAgICBjb25zdCBvcHRpb25FbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7CiAgICAgIG9wdGlvbkVsZW1lbnQudGV4dENvbnRlbnQgPSBvcHRpb24uZGlzcGxheVZhbHVlOwogICAgICBvcHRpb25FbGVtZW50LnZhbHVlID0gb3B0aW9uLmV4cG9ydFZhbHVlOwogICAgICBpZiAoc3RvcmVkRGF0YS52YWx1ZS5pbmNsdWRlcyhvcHRpb24uZXhwb3J0VmFsdWUpKSB7CiAgICAgICAgb3B0aW9uRWxlbWVudC5zZXRBdHRyaWJ1dGUoInNlbGVjdGVkIiwgdHJ1ZSk7CiAgICAgICAgYWRkQW5FbXB0eUVudHJ5ID0gZmFsc2U7CiAgICAgIH0KICAgICAgc2VsZWN0RWxlbWVudC5hcHBlbmQob3B0aW9uRWxlbWVudCk7CiAgICB9CiAgICBsZXQgcmVtb3ZlRW1wdHlFbnRyeSA9IG51bGw7CiAgICBpZiAoYWRkQW5FbXB0eUVudHJ5KSB7CiAgICAgIGNvbnN0IG5vbmVPcHRpb25FbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7CiAgICAgIG5vbmVPcHRpb25FbGVtZW50LnZhbHVlID0gIiAiOwogICAgICBub25lT3B0aW9uRWxlbWVudC5zZXRBdHRyaWJ1dGUoImhpZGRlbiIsIHRydWUpOwogICAgICBub25lT3B0aW9uRWxlbWVudC5zZXRBdHRyaWJ1dGUoInNlbGVjdGVkIiwgdHJ1ZSk7CiAgICAgIHNlbGVjdEVsZW1lbnQucHJlcGVuZChub25lT3B0aW9uRWxlbWVudCk7CiAgICAgIHJlbW92ZUVtcHR5RW50cnkgPSAoKSA9PiB7CiAgICAgICAgbm9uZU9wdGlvbkVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgc2VsZWN0RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJpbnB1dCIsIHJlbW92ZUVtcHR5RW50cnkpOwogICAgICAgIHJlbW92ZUVtcHR5RW50cnkgPSBudWxsOwogICAgICB9OwogICAgICBzZWxlY3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgcmVtb3ZlRW1wdHlFbnRyeSk7CiAgICB9CiAgICBjb25zdCBnZXRWYWx1ZSA9IChpc0V4cG9ydCkgPT4gewogICAgICBjb25zdCBuYW1lID0gaXNFeHBvcnQgPyAidmFsdWUiIDogInRleHRDb250ZW50IjsKICAgICAgY29uc3QgewogICAgICAgIG9wdGlvbnMsCiAgICAgICAgbXVsdGlwbGUKICAgICAgfSA9IHNlbGVjdEVsZW1lbnQ7CiAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICByZXR1cm4gb3B0aW9ucy5zZWxlY3RlZEluZGV4ID09PSAtMSA/IG51bGwgOiBvcHRpb25zW29wdGlvbnMuc2VsZWN0ZWRJbmRleF1bbmFtZV07CiAgICAgIH0KICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChvcHRpb25zLCAob3B0aW9uKSA9PiBvcHRpb24uc2VsZWN0ZWQpLm1hcCgob3B0aW9uKSA9PiBvcHRpb25bbmFtZV0pOwogICAgfTsKICAgIGxldCBzZWxlY3RlZFZhbHVlcyA9IGdldFZhbHVlKGZhbHNlKTsKICAgIGNvbnN0IGdldEl0ZW1zID0gKGV2ZW50KSA9PiB7CiAgICAgIGNvbnN0IG9wdGlvbnMgPSBldmVudC50YXJnZXQub3B0aW9uczsKICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5tYXAuY2FsbChvcHRpb25zLCAob3B0aW9uKSA9PiAoewogICAgICAgIGRpc3BsYXlWYWx1ZTogb3B0aW9uLnRleHRDb250ZW50LAogICAgICAgIGV4cG9ydFZhbHVlOiBvcHRpb24udmFsdWUKICAgICAgfSkpOwogICAgfTsKICAgIGlmICh0aGlzLmVuYWJsZVNjcmlwdGluZyAmJiB0aGlzLmhhc0pTQWN0aW9ucykgewogICAgICBzZWxlY3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInVwZGF0ZWZyb21zYW5kYm94IiwgKGpzRXZlbnQpID0+IHsKICAgICAgICBjb25zdCBhY3Rpb25zID0gewogICAgICAgICAgdmFsdWUoZXZlbnQpIHsKICAgICAgICAgICAgcmVtb3ZlRW1wdHlFbnRyeT8uKCk7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZXZlbnQuZGV0YWlsLnZhbHVlOwogICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBuZXcgU2V0KEFycmF5LmlzQXJyYXkodmFsdWUpID8gdmFsdWUgOiBbdmFsdWVdKTsKICAgICAgICAgICAgZm9yIChjb25zdCBvcHRpb24gb2Ygc2VsZWN0RWxlbWVudC5vcHRpb25zKSB7CiAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gdmFsdWVzLmhhcyhvcHRpb24udmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogZ2V0VmFsdWUodHJ1ZSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVzID0gZ2V0VmFsdWUoZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIG11bHRpcGxlU2VsZWN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQubXVsdGlwbGUgPSB0cnVlOwogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZShldmVudCkgewogICAgICAgICAgICBjb25zdCBvcHRpb25zID0gc2VsZWN0RWxlbWVudC5vcHRpb25zOwogICAgICAgICAgICBjb25zdCBpbmRleCA9IGV2ZW50LmRldGFpbC5yZW1vdmU7CiAgICAgICAgICAgIG9wdGlvbnNbaW5kZXhdLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQucmVtb3ZlKGluZGV4KTsKICAgICAgICAgICAgaWYgKG9wdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIGNvbnN0IGkgPSBBcnJheS5wcm90b3R5cGUuZmluZEluZGV4LmNhbGwob3B0aW9ucywgKG9wdGlvbikgPT4gb3B0aW9uLnNlbGVjdGVkKTsKICAgICAgICAgICAgICBpZiAoaSA9PT0gLTEpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnNbMF0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWU6IGdldFZhbHVlKHRydWUpLAogICAgICAgICAgICAgIGl0ZW1zOiBnZXRJdGVtcyhldmVudCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVzID0gZ2V0VmFsdWUoZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIGNsZWFyKGV2ZW50KSB7CiAgICAgICAgICAgIHdoaWxlIChzZWxlY3RFbGVtZW50Lmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQucmVtb3ZlKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogbnVsbCwKICAgICAgICAgICAgICBpdGVtczogW10KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVzID0gZ2V0VmFsdWUoZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIGluc2VydChldmVudCkgewogICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgZGlzcGxheVZhbHVlLAogICAgICAgICAgICAgIGV4cG9ydFZhbHVlCiAgICAgICAgICAgIH0gPSBldmVudC5kZXRhaWwuaW5zZXJ0OwogICAgICAgICAgICBjb25zdCBzZWxlY3RDaGlsZCA9IHNlbGVjdEVsZW1lbnQuY2hpbGRyZW5baW5kZXhdOwogICAgICAgICAgICBjb25zdCBvcHRpb25FbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIik7CiAgICAgICAgICAgIG9wdGlvbkVsZW1lbnQudGV4dENvbnRlbnQgPSBkaXNwbGF5VmFsdWU7CiAgICAgICAgICAgIG9wdGlvbkVsZW1lbnQudmFsdWUgPSBleHBvcnRWYWx1ZTsKICAgICAgICAgICAgaWYgKHNlbGVjdENoaWxkKSB7CiAgICAgICAgICAgICAgc2VsZWN0Q2hpbGQuYmVmb3JlKG9wdGlvbkVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYXBwZW5kKG9wdGlvbkVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogZ2V0VmFsdWUodHJ1ZSksCiAgICAgICAgICAgICAgaXRlbXM6IGdldEl0ZW1zKGV2ZW50KQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2VsZWN0ZWRWYWx1ZXMgPSBnZXRWYWx1ZShmYWxzZSk7CiAgICAgICAgICB9LAogICAgICAgICAgaXRlbXMoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGl0ZW1zCiAgICAgICAgICAgIH0gPSBldmVudC5kZXRhaWw7CiAgICAgICAgICAgIHdoaWxlIChzZWxlY3RFbGVtZW50Lmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQucmVtb3ZlKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykgewogICAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSwKICAgICAgICAgICAgICAgIGV4cG9ydFZhbHVlCiAgICAgICAgICAgICAgfSA9IGl0ZW07CiAgICAgICAgICAgICAgY29uc3Qgb3B0aW9uRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwogICAgICAgICAgICAgIG9wdGlvbkVsZW1lbnQudGV4dENvbnRlbnQgPSBkaXNwbGF5VmFsdWU7CiAgICAgICAgICAgICAgb3B0aW9uRWxlbWVudC52YWx1ZSA9IGV4cG9ydFZhbHVlOwogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQuYXBwZW5kKG9wdGlvbkVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZWxlY3RFbGVtZW50Lm9wdGlvbnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQub3B0aW9uc1swXS5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICAgIHZhbHVlOiBnZXRWYWx1ZSh0cnVlKSwKICAgICAgICAgICAgICBpdGVtczogZ2V0SXRlbXMoZXZlbnQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxlY3RlZFZhbHVlcyA9IGdldFZhbHVlKGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBpbmRpY2VzKGV2ZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGluZGljZXMgPSBuZXcgU2V0KGV2ZW50LmRldGFpbC5pbmRpY2VzKTsKICAgICAgICAgICAgZm9yIChjb25zdCBvcHRpb24gb2YgZXZlbnQudGFyZ2V0Lm9wdGlvbnMpIHsKICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBpbmRpY2VzLmhhcyhvcHRpb24uaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogZ2V0VmFsdWUodHJ1ZSkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVzID0gZ2V0VmFsdWUoZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIGVkaXRhYmxlKGV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50LnRhcmdldC5kaXNhYmxlZCA9ICFldmVudC5kZXRhaWwuZWRpdGFibGU7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0aGlzLl9kaXNwYXRjaEV2ZW50RnJvbVNhbmRib3goYWN0aW9ucywganNFdmVudCk7CiAgICAgIH0pOwogICAgICBzZWxlY3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgKGV2ZW50KSA9PiB7CiAgICAgICAgY29uc3QgZXhwb3J0VmFsdWUgPSBnZXRWYWx1ZSh0cnVlKTsKICAgICAgICBjb25zdCBjaGFuZ2UgPSBnZXRWYWx1ZShmYWxzZSk7CiAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgdmFsdWU6IGV4cG9ydFZhbHVlCiAgICAgICAgfSk7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLmV2ZW50QnVzPy5kaXNwYXRjaCgiZGlzcGF0Y2hldmVudGluc2FuZGJveCIsIHsKICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgIGRldGFpbDogewogICAgICAgICAgICBpZCwKICAgICAgICAgICAgbmFtZTogIktleXN0cm9rZSIsCiAgICAgICAgICAgIHZhbHVlOiBzZWxlY3RlZFZhbHVlcywKICAgICAgICAgICAgY2hhbmdlLAogICAgICAgICAgICBjaGFuZ2VFeDogZXhwb3J0VmFsdWUsCiAgICAgICAgICAgIHdpbGxDb21taXQ6IGZhbHNlLAogICAgICAgICAgICBjb21taXRLZXk6IDEsCiAgICAgICAgICAgIGtleURvd246IGZhbHNlCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICB0aGlzLl9zZXRFdmVudExpc3RlbmVycyhzZWxlY3RFbGVtZW50LCBudWxsLCBbWyJmb2N1cyIsICJGb2N1cyJdLCBbImJsdXIiLCAiQmx1ciJdLCBbIm1vdXNlZG93biIsICJNb3VzZSBEb3duIl0sIFsibW91c2VlbnRlciIsICJNb3VzZSBFbnRlciJdLCBbIm1vdXNlbGVhdmUiLCAiTW91c2UgRXhpdCJdLCBbIm1vdXNldXAiLCAiTW91c2UgVXAiXSwgWyJpbnB1dCIsICJBY3Rpb24iXSwgWyJpbnB1dCIsICJWYWxpZGF0ZSJdXSwgKGV2ZW50KSA9PiBldmVudC50YXJnZXQudmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgc2VsZWN0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgdmFsdWU6IGdldFZhbHVlKHRydWUpCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfQogICAgaWYgKHRoaXMuZGF0YS5jb21ibykgewogICAgICB0aGlzLl9zZXRUZXh0U3R5bGUoc2VsZWN0RWxlbWVudCk7CiAgICB9IGVsc2UgewogICAgfQogICAgdGhpcy5fc2V0QmFja2dyb3VuZENvbG9yKHNlbGVjdEVsZW1lbnQpOwogICAgdGhpcy5fc2V0RGVmYXVsdFByb3BlcnRpZXNGcm9tSlMoc2VsZWN0RWxlbWVudCk7CiAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmQoc2VsZWN0RWxlbWVudCk7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgUG9wdXBBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YSwKICAgICAgZWxlbWVudHMsCiAgICAgIHBhcmVudAogICAgfSA9IHBhcmFtZXRlcnM7CiAgICBjb25zdCBoYXNDb21tZW50TWFuYWdlciA9ICEhcGFyZW50Ll9jb21tZW50TWFuYWdlcjsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiAhaGFzQ29tbWVudE1hbmFnZXIgJiYgQW5ub3RhdGlvbkVsZW1lbnQuX2hhc1BvcHVwRGF0YShkYXRhKQogICAgfSk7CiAgICB0aGlzLmVsZW1lbnRzID0gZWxlbWVudHM7CiAgICBpZiAoaGFzQ29tbWVudE1hbmFnZXIgJiYgQW5ub3RhdGlvbkVsZW1lbnQuX2hhc1BvcHVwRGF0YShkYXRhKSkgewogICAgICBjb25zdCBwb3B1cCA9IHRoaXMucG9wdXAgPSB0aGlzLiNjcmVhdGVQb3B1cCgpOwogICAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgZWxlbWVudHMpIHsKICAgICAgICBlbGVtZW50LnBvcHVwID0gcG9wdXA7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucG9wdXAgPSBudWxsOwogICAgfQogIH0KICAjY3JlYXRlUG9wdXAoKSB7CiAgICByZXR1cm4gbmV3IFBvcHVwRWxlbWVudCh7CiAgICAgIGNvbnRhaW5lcjogdGhpcy5jb250YWluZXIsCiAgICAgIGNvbG9yOiB0aGlzLmRhdGEuY29sb3IsCiAgICAgIHRpdGxlT2JqOiB0aGlzLmRhdGEudGl0bGVPYmosCiAgICAgIG1vZGlmaWNhdGlvbkRhdGU6IHRoaXMuZGF0YS5tb2RpZmljYXRpb25EYXRlIHx8IHRoaXMuZGF0YS5jcmVhdGlvbkRhdGUsCiAgICAgIGNvbnRlbnRzT2JqOiB0aGlzLmRhdGEuY29udGVudHNPYmosCiAgICAgIHJpY2hUZXh0OiB0aGlzLmRhdGEucmljaFRleHQsCiAgICAgIHJlY3Q6IHRoaXMuZGF0YS5yZWN0LAogICAgICBwYXJlbnRSZWN0OiB0aGlzLmRhdGEucGFyZW50UmVjdCB8fCBudWxsLAogICAgICBwYXJlbnQ6IHRoaXMucGFyZW50LAogICAgICBlbGVtZW50czogdGhpcy5lbGVtZW50cywKICAgICAgb3BlbjogdGhpcy5kYXRhLm9wZW4sCiAgICAgIGNvbW1lbnRNYW5hZ2VyOiB0aGlzLnBhcmVudC5fY29tbWVudE1hbmFnZXIKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICBjb25zdCB7CiAgICAgIGNvbnRhaW5lcjogY29udGFpbmVyMgogICAgfSA9IHRoaXM7CiAgICBjb250YWluZXIyLmNsYXNzTGlzdC5hZGQoInBvcHVwQW5ub3RhdGlvbiIpOwogICAgY29udGFpbmVyMi5yb2xlID0gImNvbW1lbnQiOwogICAgY29uc3QgcG9wdXAgPSB0aGlzLnBvcHVwID0gdGhpcy4jY3JlYXRlUG9wdXAoKTsKICAgIGNvbnN0IGVsZW1lbnRJZHMgPSBbXTsKICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLmVsZW1lbnRzKSB7CiAgICAgIGVsZW1lbnQucG9wdXAgPSBwb3B1cDsKICAgICAgZWxlbWVudC5jb250YWluZXIuYXJpYUhhc1BvcHVwID0gImRpYWxvZyI7CiAgICAgIGVsZW1lbnRJZHMucHVzaChlbGVtZW50LmRhdGEuaWQpOwogICAgICBlbGVtZW50LmFkZEhpZ2hsaWdodEFyZWEoKTsKICAgIH0KICAgIHRoaXMuY29udGFpbmVyLnNldEF0dHJpYnV0ZSgiYXJpYS1jb250cm9scyIsIGVsZW1lbnRJZHMubWFwKChpZCkgPT4gYCR7QW5ub3RhdGlvblByZWZpeH0ke2lkfWApLmpvaW4oIiwiKSk7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgUG9wdXBFbGVtZW50ID0gY2xhc3MgewogICNjb21tZW50TWFuYWdlciA9IG51bGw7CiAgI2JvdW5kS2V5RG93biA9IHRoaXMuI2tleURvd24uYmluZCh0aGlzKTsKICAjYm91bmRIaWRlID0gdGhpcy4jaGlkZS5iaW5kKHRoaXMpOwogICNib3VuZFNob3cgPSB0aGlzLiNzaG93LmJpbmQodGhpcyk7CiAgI2JvdW5kVG9nZ2xlID0gdGhpcy4jdG9nZ2xlLmJpbmQodGhpcyk7CiAgI2NvbG9yID0gbnVsbDsKICAjY29udGFpbmVyID0gbnVsbDsKICAjY29udGVudHNPYmogPSBudWxsOwogICNkYXRlT2JqID0gbnVsbDsKICAjZWxlbWVudHMgPSBudWxsOwogICNwYXJlbnQgPSBudWxsOwogICNwYXJlbnRSZWN0ID0gbnVsbDsKICAjcGlubmVkID0gZmFsc2U7CiAgI3BvcHVwID0gbnVsbDsKICAjcG9wdXBBYm9ydENvbnRyb2xsZXIgPSBudWxsOwogICNwb3NpdGlvbiA9IG51bGw7CiAgI2NvbW1lbnRCdXR0b24gPSBudWxsOwogICNjb21tZW50QnV0dG9uUG9zaXRpb24gPSBudWxsOwogICNwb3B1cFBvc2l0aW9uID0gbnVsbDsKICAjcmVjdCA9IG51bGw7CiAgI3JpY2hUZXh0ID0gbnVsbDsKICAjdGl0bGVPYmogPSBudWxsOwogICN1cGRhdGVzID0gbnVsbDsKICAjd2FzVmlzaWJsZSA9IGZhbHNlOwogICNmaXJzdEVsZW1lbnQgPSBudWxsOwogICNjb21tZW50VGV4dCA9IG51bGw7CiAgY29uc3RydWN0b3IoewogICAgY29udGFpbmVyOiBjb250YWluZXIyLAogICAgY29sb3IsCiAgICBlbGVtZW50cywKICAgIHRpdGxlT2JqLAogICAgbW9kaWZpY2F0aW9uRGF0ZSwKICAgIGNvbnRlbnRzT2JqLAogICAgcmljaFRleHQsCiAgICBwYXJlbnQsCiAgICByZWN0LAogICAgcGFyZW50UmVjdCwKICAgIG9wZW4sCiAgICBjb21tZW50TWFuYWdlciA9IG51bGwKICB9KSB7CiAgICB0aGlzLiNjb250YWluZXIgPSBjb250YWluZXIyOwogICAgdGhpcy4jdGl0bGVPYmogPSB0aXRsZU9iajsKICAgIHRoaXMuI2NvbnRlbnRzT2JqID0gY29udGVudHNPYmo7CiAgICB0aGlzLiNyaWNoVGV4dCA9IHJpY2hUZXh0OwogICAgdGhpcy4jcGFyZW50ID0gcGFyZW50OwogICAgdGhpcy4jY29sb3IgPSBjb2xvcjsKICAgIHRoaXMuI3JlY3QgPSByZWN0OwogICAgdGhpcy4jcGFyZW50UmVjdCA9IHBhcmVudFJlY3Q7CiAgICB0aGlzLiNlbGVtZW50cyA9IGVsZW1lbnRzOwogICAgdGhpcy4jY29tbWVudE1hbmFnZXIgPSBjb21tZW50TWFuYWdlcjsKICAgIHRoaXMuI2ZpcnN0RWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgdGhpcy4jZGF0ZU9iaiA9IFBERkRhdGVTdHJpbmcudG9EYXRlT2JqZWN0KG1vZGlmaWNhdGlvbkRhdGUpOwogICAgdGhpcy50cmlnZ2VyID0gZWxlbWVudHMuZmxhdE1hcCgoZSkgPT4gZS5nZXRFbGVtZW50c1RvVHJpZ2dlclBvcHVwKCkpOwogICAgaWYgKCFjb21tZW50TWFuYWdlcikgewogICAgICB0aGlzLiNhZGRFdmVudExpc3RlbmVycygpOwogICAgICB0aGlzLiNjb250YWluZXIuaGlkZGVuID0gdHJ1ZTsKICAgICAgaWYgKG9wZW4pIHsKICAgICAgICB0aGlzLiN0b2dnbGUoKTsKICAgICAgfQogICAgfQogIH0KICAjYWRkRXZlbnRMaXN0ZW5lcnMoKSB7CiAgICBpZiAodGhpcy4jcG9wdXBBYm9ydENvbnRyb2xsZXIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jcG9wdXBBYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCB7CiAgICAgIHNpZ25hbAogICAgfSA9IHRoaXMuI3BvcHVwQWJvcnRDb250cm9sbGVyOwogICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMudHJpZ2dlcikgewogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy4jYm91bmRUb2dnbGUsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmVudGVyIiwgdGhpcy4jYm91bmRTaG93LCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJsZWF2ZSIsIHRoaXMuI2JvdW5kSGlkZSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKCJwb3B1cFRyaWdnZXJBcmVhIik7CiAgICB9CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdGhpcy4jZWxlbWVudHMpIHsKICAgICAgZWxlbWVudC5jb250YWluZXI/LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLiNib3VuZEtleURvd24sIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICB9CiAgfQogICNzZXRDb21tZW50QnV0dG9uUG9zaXRpb24oKSB7CiAgICBjb25zdCBlbGVtZW50ID0gdGhpcy4jZWxlbWVudHMuZmluZCgoZSkgPT4gZS5oYXNDb21tZW50QnV0dG9uKTsKICAgIGlmICghZWxlbWVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNjb21tZW50QnV0dG9uUG9zaXRpb24gPSBlbGVtZW50Ll9ub3JtYWxpemVQb2ludChlbGVtZW50LmNvbW1lbnRCdXR0b25Qb3NpdGlvbik7CiAgfQogIHJlbmRlckNvbW1lbnRCdXR0b24oKSB7CiAgICBpZiAodGhpcy4jY29tbWVudEJ1dHRvbikgewogICAgICBpZiAoIXRoaXMuI2NvbW1lbnRCdXR0b24ucGFyZW50Tm9kZSkgewogICAgICAgIHRoaXMuI2ZpcnN0RWxlbWVudC5jb250YWluZXIuYWZ0ZXIodGhpcy4jY29tbWVudEJ1dHRvbik7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLiNjb21tZW50QnV0dG9uUG9zaXRpb24pIHsKICAgICAgdGhpcy4jc2V0Q29tbWVudEJ1dHRvblBvc2l0aW9uKCk7CiAgICB9CiAgICBpZiAoIXRoaXMuI2NvbW1lbnRCdXR0b25Qb3NpdGlvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHNpZ25hbAogICAgfSA9IHRoaXMuI3BvcHVwQWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3QgaGFzT3duQnV0dG9uID0gdGhpcy4jZmlyc3RFbGVtZW50Lmhhc093bkNvbW1lbnRCdXR0b247CiAgICBjb25zdCB0b2dnbGVQb3B1cCA9ICgpID0+IHsKICAgICAgdGhpcy4jY29tbWVudE1hbmFnZXIudG9nZ2xlQ29tbWVudFBvcHVwKHRoaXMsIHRydWUsIHZvaWQgMCwgIWhhc093bkJ1dHRvbik7CiAgICB9OwogICAgY29uc3Qgc2hvd1BvcHVwID0gKCkgPT4gewogICAgICB0aGlzLiNjb21tZW50TWFuYWdlci50b2dnbGVDb21tZW50UG9wdXAodGhpcywgZmFsc2UsIHRydWUsICFoYXNPd25CdXR0b24pOwogICAgfTsKICAgIGNvbnN0IGhpZGVQb3B1cCA9ICgpID0+IHsKICAgICAgdGhpcy4jY29tbWVudE1hbmFnZXIudG9nZ2xlQ29tbWVudFBvcHVwKHRoaXMsIGZhbHNlLCBmYWxzZSk7CiAgICB9OwogICAgaWYgKCFoYXNPd25CdXR0b24pIHsKICAgICAgY29uc3QgYnV0dG9uID0gdGhpcy4jY29tbWVudEJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgICBidXR0b24uY2xhc3NOYW1lID0gImFubm90YXRpb25Db21tZW50QnV0dG9uIjsKICAgICAgY29uc3QgcGFyZW50Q29udGFpbmVyID0gdGhpcy4jZmlyc3RFbGVtZW50LmNvbnRhaW5lcjsKICAgICAgYnV0dG9uLnN0eWxlLnpJbmRleCA9IHBhcmVudENvbnRhaW5lci5zdHlsZS56SW5kZXggKyAxOwogICAgICBidXR0b24udGFiSW5kZXggPSAwOwogICAgICBidXR0b24uYXJpYUhhc1BvcHVwID0gImRpYWxvZyI7CiAgICAgIGJ1dHRvbi5hcmlhQ29udHJvbHMgPSAiY29tbWVudFBvcHVwIjsKICAgICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLXNob3ctY29tbWVudC1idXR0b24iKTsKICAgICAgdGhpcy4jdXBkYXRlQ29sb3IoKTsKICAgICAgdGhpcy4jdXBkYXRlQ29tbWVudEJ1dHRvblBvc2l0aW9uKCk7CiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy4jYm91bmRLZXlEb3duLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0b2dnbGVQb3B1cCwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJlbnRlciIsIHNob3dQb3B1cCwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJsZWF2ZSIsIGhpZGVQb3B1cCwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgcGFyZW50Q29udGFpbmVyLmFmdGVyKGJ1dHRvbik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNjb21tZW50QnV0dG9uID0gdGhpcy4jZmlyc3RFbGVtZW50LmNvbnRhaW5lcjsKICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMudHJpZ2dlcikgewogICAgICAgIGVsZW1lbnQuYXJpYUhhc1BvcHVwID0gImRpYWxvZyI7CiAgICAgICAgZWxlbWVudC5hcmlhQ29udHJvbHMgPSAiY29tbWVudFBvcHVwIjsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLiNib3VuZEtleURvd24sIHsKICAgICAgICAgIHNpZ25hbAogICAgICAgIH0pOwogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0b2dnbGVQb3B1cCwgewogICAgICAgICAgc2lnbmFsCiAgICAgICAgfSk7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZW50ZXIiLCBzaG93UG9wdXAsIHsKICAgICAgICAgIHNpZ25hbAogICAgICAgIH0pOwogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmxlYXZlIiwgaGlkZVBvcHVwLCB7CiAgICAgICAgICBzaWduYWwKICAgICAgICB9KTsKICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoInBvcHVwVHJpZ2dlckFyZWEiKTsKICAgICAgfQogICAgfQogIH0KICAjdXBkYXRlQ29tbWVudEJ1dHRvblBvc2l0aW9uKCkgewogICAgaWYgKHRoaXMuI2ZpcnN0RWxlbWVudC5leHRyYVBvcHVwRWxlbWVudCAmJiAhdGhpcy4jZmlyc3RFbGVtZW50LmVkaXRvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI2NvbW1lbnRCdXR0b24pIHsKICAgICAgdGhpcy5yZW5kZXJDb21tZW50QnV0dG9uKCk7CiAgICB9CiAgICBjb25zdCBbeCwgeV0gPSB0aGlzLiNjb21tZW50QnV0dG9uUG9zaXRpb247CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gdGhpcy4jY29tbWVudEJ1dHRvbjsKICAgIHN0eWxlLmxlZnQgPSBgY2FsYygke3h9JSlgOwogICAgc3R5bGUudG9wID0gYGNhbGMoJHt5fSUgLSB2YXIoLS1jb21tZW50LWJ1dHRvbi1kaW0pKWA7CiAgfQogICN1cGRhdGVDb2xvcigpIHsKICAgIGlmICh0aGlzLiNmaXJzdEVsZW1lbnQuZXh0cmFQb3B1cEVsZW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLiNjb21tZW50QnV0dG9uKSB7CiAgICAgIHRoaXMucmVuZGVyQ29tbWVudEJ1dHRvbigpOwogICAgfQogICAgdGhpcy4jY29tbWVudEJ1dHRvbi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSB0aGlzLmNvbW1lbnRCdXR0b25Db2xvciB8fCAiIjsKICB9CiAgZ2V0IGNvbW1lbnRCdXR0b25Db2xvcigpIHsKICAgIGNvbnN0IHsKICAgICAgY29sb3IsCiAgICAgIG9wYWNpdHkKICAgIH0gPSB0aGlzLiNmaXJzdEVsZW1lbnQuY29tbWVudERhdGE7CiAgICBpZiAoIWNvbG9yKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIHRoaXMuI3BhcmVudC5fY29tbWVudE1hbmFnZXIubWFrZUNvbW1lbnRDb2xvcihjb2xvciwgb3BhY2l0eSk7CiAgfQogIGZvY3VzQ29tbWVudEJ1dHRvbigpIHsKICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aGlzLiNjb21tZW50QnV0dG9uPy5mb2N1cygpOwogICAgfSwgMCk7CiAgfQogIGdldERhdGEoKSB7CiAgICBjb25zdCB7CiAgICAgIHJpY2hUZXh0LAogICAgICBjb2xvciwKICAgICAgb3BhY2l0eSwKICAgICAgY3JlYXRpb25EYXRlLAogICAgICBtb2RpZmljYXRpb25EYXRlCiAgICB9ID0gdGhpcy4jZmlyc3RFbGVtZW50LmNvbW1lbnREYXRhOwogICAgcmV0dXJuIHsKICAgICAgY29udGVudHNPYmo6IHsKICAgICAgICBzdHI6IHRoaXMuY29tbWVudAogICAgICB9LAogICAgICByaWNoVGV4dCwKICAgICAgY29sb3IsCiAgICAgIG9wYWNpdHksCiAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgfTsKICB9CiAgZ2V0IGVsZW1lbnRCZWZvcmVQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50QnV0dG9uOwogIH0KICBnZXQgY29tbWVudCgpIHsKICAgIHRoaXMuI2NvbW1lbnRUZXh0IHx8PSB0aGlzLiNmaXJzdEVsZW1lbnQuY29tbWVudFRleHQ7CiAgICByZXR1cm4gdGhpcy4jY29tbWVudFRleHQ7CiAgfQogIHNldCBjb21tZW50KHRleHQpIHsKICAgIGlmICh0ZXh0ID09PSB0aGlzLmNvbW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jZmlyc3RFbGVtZW50LmNvbW1lbnRUZXh0ID0gdGhpcy4jY29tbWVudFRleHQgPSB0ZXh0OwogIH0KICBmb2N1cygpIHsKICAgIHRoaXMuI2ZpcnN0RWxlbWVudC5jb250YWluZXI/LmZvY3VzKCk7CiAgfQogIGdldCBwYXJlbnRCb3VuZGluZ0NsaWVudFJlY3QoKSB7CiAgICByZXR1cm4gdGhpcy4jZmlyc3RFbGVtZW50LmxheWVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIH0KICBzZXRDb21tZW50QnV0dG9uU3RhdGVzKHsKICAgIHNlbGVjdGVkLAogICAgaGFzUG9wdXAKICB9KSB7CiAgICBpZiAoIXRoaXMuI2NvbW1lbnRCdXR0b24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29tbWVudEJ1dHRvbi5jbGFzc0xpc3QudG9nZ2xlKCJzZWxlY3RlZCIsIHNlbGVjdGVkKTsKICAgIHRoaXMuI2NvbW1lbnRCdXR0b24uYXJpYUV4cGFuZGVkID0gaGFzUG9wdXA7CiAgfQogIHNldFNlbGVjdGVkQ29tbWVudEJ1dHRvbihzZWxlY3RlZCkgewogICAgdGhpcy4jY29tbWVudEJ1dHRvbi5jbGFzc0xpc3QudG9nZ2xlKCJzZWxlY3RlZCIsIHNlbGVjdGVkKTsKICB9CiAgZ2V0IGNvbW1lbnRQb3B1cFBvc2l0aW9uKCkgewogICAgaWYgKHRoaXMuI3BvcHVwUG9zaXRpb24pIHsKICAgICAgcmV0dXJuIHRoaXMuI3BvcHVwUG9zaXRpb247CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHgsCiAgICAgIHksCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXMuI2NvbW1lbnRCdXR0b24uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCB7CiAgICAgIHg6IHBhcmVudFgsCiAgICAgIHk6IHBhcmVudFksCiAgICAgIHdpZHRoOiBwYXJlbnRXaWR0aCwKICAgICAgaGVpZ2h0OiBwYXJlbnRIZWlnaHQKICAgIH0gPSB0aGlzLiNmaXJzdEVsZW1lbnQubGF5ZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICByZXR1cm4gWyh4IC0gcGFyZW50WCkgLyBwYXJlbnRXaWR0aCwgKHkgKyBoZWlnaHQgLSBwYXJlbnRZKSAvIHBhcmVudEhlaWdodF07CiAgfQogIHNldCBjb21tZW50UG9wdXBQb3NpdGlvbihwb3MpIHsKICAgIHRoaXMuI3BvcHVwUG9zaXRpb24gPSBwb3M7CiAgfQogIGhhc0RlZmF1bHRQb3B1cFBvc2l0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuI3BvcHVwUG9zaXRpb24gPT09IG51bGw7CiAgfQogIGdldCBjb21tZW50QnV0dG9uUG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy4jY29tbWVudEJ1dHRvblBvc2l0aW9uOwogIH0KICBnZXQgY29tbWVudEJ1dHRvbldpZHRoKCkgewogICAgcmV0dXJuIHRoaXMuI2NvbW1lbnRCdXR0b24uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggLyB0aGlzLnBhcmVudEJvdW5kaW5nQ2xpZW50UmVjdC53aWR0aDsKICB9CiAgZWRpdENvbW1lbnQob3B0aW9ucykgewogICAgY29uc3QgW3Bvc1gsIHBvc1ldID0gdGhpcy4jcG9wdXBQb3NpdGlvbiB8fCB0aGlzLmNvbW1lbnRCdXR0b25Qb3NpdGlvbi5tYXAoKHgpID0+IHggLyAxMDApOwogICAgY29uc3QgcGFyZW50RGltZW5zaW9ucyA9IHRoaXMucGFyZW50Qm91bmRpbmdDbGllbnRSZWN0OwogICAgY29uc3QgewogICAgICB4OiBwYXJlbnRYLAogICAgICB5OiBwYXJlbnRZLAogICAgICB3aWR0aDogcGFyZW50V2lkdGgsCiAgICAgIGhlaWdodDogcGFyZW50SGVpZ2h0CiAgICB9ID0gcGFyZW50RGltZW5zaW9uczsKICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyLnNob3dEaWFsb2cobnVsbCwgdGhpcywgcGFyZW50WCArIHBvc1ggKiBwYXJlbnRXaWR0aCwgcGFyZW50WSArIHBvc1kgKiBwYXJlbnRIZWlnaHQsIHsKICAgICAgLi4ub3B0aW9ucywKICAgICAgcGFyZW50RGltZW5zaW9ucwogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLiNwb3B1cCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBwb3B1cCA9IHRoaXMuI3BvcHVwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBwb3B1cC5jbGFzc05hbWUgPSAicG9wdXAiOwogICAgaWYgKHRoaXMuI2NvbG9yKSB7CiAgICAgIGNvbnN0IGJhc2VDb2xvciA9IHBvcHVwLnN0eWxlLm91dGxpbmVDb2xvciA9IFV0aWwubWFrZUhleENvbG9yKC4uLnRoaXMuI2NvbG9yKTsKICAgICAgcG9wdXAuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYGNvbG9yLW1peChpbiBzcmdiLCAke2Jhc2VDb2xvcn0gMzAlLCB3aGl0ZSlgOwogICAgfQogICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgaGVhZGVyLmNsYXNzTmFtZSA9ICJoZWFkZXIiOwogICAgaWYgKHRoaXMuI3RpdGxlT2JqPy5zdHIpIHsKICAgICAgY29uc3QgdGl0bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgIHRpdGxlLmNsYXNzTmFtZSA9ICJ0aXRsZSI7CiAgICAgIGhlYWRlci5hcHBlbmQodGl0bGUpOwogICAgICAoewogICAgICAgIGRpcjogdGl0bGUuZGlyLAogICAgICAgIHN0cjogdGl0bGUudGV4dENvbnRlbnQKICAgICAgfSA9IHRoaXMuI3RpdGxlT2JqKTsKICAgIH0KICAgIHBvcHVwLmFwcGVuZChoZWFkZXIpOwogICAgaWYgKHRoaXMuI2RhdGVPYmopIHsKICAgICAgY29uc3QgbW9kaWZpY2F0aW9uRGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRpbWUiKTsKICAgICAgbW9kaWZpY2F0aW9uRGF0ZS5jbGFzc05hbWUgPSAicG9wdXBEYXRlIjsKICAgICAgbW9kaWZpY2F0aW9uRGF0ZS5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1hbm5vdGF0aW9uLWRhdGUtdGltZS1zdHJpbmciKTsKICAgICAgbW9kaWZpY2F0aW9uRGF0ZS5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1hcmdzIiwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgIGRhdGVPYmo6IHRoaXMuI2RhdGVPYmoudmFsdWVPZigpCiAgICAgIH0pKTsKICAgICAgbW9kaWZpY2F0aW9uRGF0ZS5kYXRlVGltZSA9IHRoaXMuI2RhdGVPYmoudG9JU09TdHJpbmcoKTsKICAgICAgaGVhZGVyLmFwcGVuZChtb2RpZmljYXRpb25EYXRlKTsKICAgIH0KICAgIHJlbmRlclJpY2hUZXh0KHsKICAgICAgaHRtbDogdGhpcy4jaHRtbCB8fCB0aGlzLiNjb250ZW50c09iai5zdHIsCiAgICAgIGRpcjogdGhpcy4jY29udGVudHNPYmo/LmRpciwKICAgICAgY2xhc3NOYW1lOiAicG9wdXBDb250ZW50IgogICAgfSwgcG9wdXApOwogICAgdGhpcy4jY29udGFpbmVyLmFwcGVuZChwb3B1cCk7CiAgfQogIGdldCAjaHRtbCgpIHsKICAgIGNvbnN0IHJpY2hUZXh0ID0gdGhpcy4jcmljaFRleHQ7CiAgICBjb25zdCBjb250ZW50c09iaiA9IHRoaXMuI2NvbnRlbnRzT2JqOwogICAgaWYgKHJpY2hUZXh0Py5zdHIgJiYgKCFjb250ZW50c09iaj8uc3RyIHx8IGNvbnRlbnRzT2JqLnN0ciA9PT0gcmljaFRleHQuc3RyKSkgewogICAgICByZXR1cm4gdGhpcy4jcmljaFRleHQuaHRtbCB8fCBudWxsOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGdldCAjZm9udFNpemUoKSB7CiAgICByZXR1cm4gdGhpcy4jaHRtbD8uYXR0cmlidXRlcz8uc3R5bGU/LmZvbnRTaXplIHx8IDA7CiAgfQogIGdldCAjZm9udENvbG9yKCkgewogICAgcmV0dXJuIHRoaXMuI2h0bWw/LmF0dHJpYnV0ZXM/LnN0eWxlPy5jb2xvciB8fCBudWxsOwogIH0KICAjbWFrZVBvcHVwQ29udGVudCh0ZXh0KSB7CiAgICBjb25zdCBwb3B1cExpbmVzID0gW107CiAgICBjb25zdCBwb3B1cENvbnRlbnQgPSB7CiAgICAgIHN0cjogdGV4dCwKICAgICAgaHRtbDogewogICAgICAgIG5hbWU6ICJkaXYiLAogICAgICAgIGF0dHJpYnV0ZXM6IHsKICAgICAgICAgIGRpcjogImF1dG8iCiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogW3sKICAgICAgICAgIG5hbWU6ICJwIiwKICAgICAgICAgIGNoaWxkcmVuOiBwb3B1cExpbmVzCiAgICAgICAgfV0KICAgICAgfQogICAgfTsKICAgIGNvbnN0IGxpbmVBdHRyaWJ1dGVzID0gewogICAgICBzdHlsZTogewogICAgICAgIGNvbG9yOiB0aGlzLiNmb250Q29sb3IsCiAgICAgICAgZm9udFNpemU6IHRoaXMuI2ZvbnRTaXplID8gYGNhbGMoJHt0aGlzLiNmb250U2l6ZX1weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikpYCA6ICIiCiAgICAgIH0KICAgIH07CiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgdGV4dC5zcGxpdCgiXG4iKSkgewogICAgICBwb3B1cExpbmVzLnB1c2goewogICAgICAgIG5hbWU6ICJzcGFuIiwKICAgICAgICB2YWx1ZTogbGluZSwKICAgICAgICBhdHRyaWJ1dGVzOiBsaW5lQXR0cmlidXRlcwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBwb3B1cENvbnRlbnQ7CiAgfQogICNrZXlEb3duKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQuYWx0S2V5IHx8IGV2ZW50LnNoaWZ0S2V5IHx8IGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnQua2V5ID09PSAiRW50ZXIiIHx8IGV2ZW50LmtleSA9PT0gIkVzY2FwZSIgJiYgdGhpcy4jcGlubmVkKSB7CiAgICAgIHRoaXMuI3RvZ2dsZSgpOwogICAgfQogIH0KICB1cGRhdGVFZGl0ZWQoewogICAgcmVjdCwKICAgIHBvcHVwLAogICAgZGVsZXRlZAogIH0pIHsKICAgIGlmICh0aGlzLiNjb21tZW50TWFuYWdlcikgewogICAgICBpZiAoZGVsZXRlZCkgewogICAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgICAgdGhpcy4jY29tbWVudFRleHQgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKHBvcHVwKSB7CiAgICAgICAgaWYgKHBvcHVwLmRlbGV0ZWQpIHsKICAgICAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuI3VwZGF0ZUNvbG9yKCk7CiAgICAgICAgICB0aGlzLiNjb21tZW50VGV4dCA9IHBvcHVwLnRleHQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChyZWN0KSB7CiAgICAgICAgdGhpcy4jY29tbWVudEJ1dHRvblBvc2l0aW9uID0gbnVsbDsKICAgICAgICB0aGlzLiNzZXRDb21tZW50QnV0dG9uUG9zaXRpb24oKTsKICAgICAgICB0aGlzLiN1cGRhdGVDb21tZW50QnV0dG9uUG9zaXRpb24oKTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZGVsZXRlZCB8fCBwb3B1cD8uZGVsZXRlZCkgewogICAgICB0aGlzLnJlbW92ZSgpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNhZGRFdmVudExpc3RlbmVycygpOwogICAgdGhpcy4jdXBkYXRlcyB8fD0gewogICAgICBjb250ZW50c09iajogdGhpcy4jY29udGVudHNPYmosCiAgICAgIHJpY2hUZXh0OiB0aGlzLiNyaWNoVGV4dAogICAgfTsKICAgIGlmIChyZWN0KSB7CiAgICAgIHRoaXMuI3Bvc2l0aW9uID0gbnVsbDsKICAgIH0KICAgIGlmIChwb3B1cCAmJiBwb3B1cC50ZXh0KSB7CiAgICAgIHRoaXMuI3JpY2hUZXh0ID0gdGhpcy4jbWFrZVBvcHVwQ29udGVudChwb3B1cC50ZXh0KTsKICAgICAgdGhpcy4jZGF0ZU9iaiA9IFBERkRhdGVTdHJpbmcudG9EYXRlT2JqZWN0KHBvcHVwLmRhdGUpOwogICAgICB0aGlzLiNjb250ZW50c09iaiA9IG51bGw7CiAgICB9CiAgICB0aGlzLiNwb3B1cD8ucmVtb3ZlKCk7CiAgICB0aGlzLiNwb3B1cCA9IG51bGw7CiAgfQogIHJlc2V0RWRpdGVkKCkgewogICAgaWYgKCF0aGlzLiN1cGRhdGVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgICh7CiAgICAgIGNvbnRlbnRzT2JqOiB0aGlzLiNjb250ZW50c09iaiwKICAgICAgcmljaFRleHQ6IHRoaXMuI3JpY2hUZXh0CiAgICB9ID0gdGhpcy4jdXBkYXRlcyk7CiAgICB0aGlzLiN1cGRhdGVzID0gbnVsbDsKICAgIHRoaXMuI3BvcHVwPy5yZW1vdmUoKTsKICAgIHRoaXMuI3BvcHVwID0gbnVsbDsKICAgIHRoaXMuI3Bvc2l0aW9uID0gbnVsbDsKICB9CiAgcmVtb3ZlKCkgewogICAgdGhpcy4jcG9wdXBBYm9ydENvbnRyb2xsZXI/LmFib3J0KCk7CiAgICB0aGlzLiNwb3B1cEFib3J0Q29udHJvbGxlciA9IG51bGw7CiAgICB0aGlzLiNwb3B1cD8ucmVtb3ZlKCk7CiAgICB0aGlzLiNwb3B1cCA9IG51bGw7CiAgICB0aGlzLiN3YXNWaXNpYmxlID0gZmFsc2U7CiAgICB0aGlzLiNwaW5uZWQgPSBmYWxzZTsKICAgIHRoaXMuI2NvbW1lbnRCdXR0b24/LnJlbW92ZSgpOwogICAgdGhpcy4jY29tbWVudEJ1dHRvbiA9IG51bGw7CiAgICBpZiAodGhpcy50cmlnZ2VyKSB7CiAgICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLnRyaWdnZXIpIHsKICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoInBvcHVwVHJpZ2dlckFyZWEiKTsKICAgICAgfQogICAgfQogIH0KICAjc2V0UG9zaXRpb24oKSB7CiAgICBpZiAodGhpcy4jcG9zaXRpb24gIT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBwYWdlOiB7CiAgICAgICAgdmlldwogICAgICB9LAogICAgICB2aWV3cG9ydDogewogICAgICAgIHJhd0RpbXM6IHsKICAgICAgICAgIHBhZ2VXaWR0aCwKICAgICAgICAgIHBhZ2VIZWlnaHQsCiAgICAgICAgICBwYWdlWCwKICAgICAgICAgIHBhZ2VZCiAgICAgICAgfQogICAgICB9CiAgICB9ID0gdGhpcy4jcGFyZW50OwogICAgbGV0IHVzZVBhcmVudFJlY3QgPSAhIXRoaXMuI3BhcmVudFJlY3Q7CiAgICBsZXQgcmVjdCA9IHVzZVBhcmVudFJlY3QgPyB0aGlzLiNwYXJlbnRSZWN0IDogdGhpcy4jcmVjdDsKICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLiNlbGVtZW50cykgewogICAgICBpZiAoIXJlY3QgfHwgVXRpbC5pbnRlcnNlY3QoZWxlbWVudC5kYXRhLnJlY3QsIHJlY3QpICE9PSBudWxsKSB7CiAgICAgICAgcmVjdCA9IGVsZW1lbnQuZGF0YS5yZWN0OwogICAgICAgIHVzZVBhcmVudFJlY3QgPSB0cnVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBjb25zdCBub3JtYWxpemVkUmVjdCA9IFV0aWwubm9ybWFsaXplUmVjdChbcmVjdFswXSwgdmlld1szXSAtIHJlY3RbMV0gKyB2aWV3WzFdLCByZWN0WzJdLCB2aWV3WzNdIC0gcmVjdFszXSArIHZpZXdbMV1dKTsKICAgIGNvbnN0IEhPUklaT05UQUxfU1BBQ0VfQUZURVJfQU5OT1RBVElPTiA9IDU7CiAgICBjb25zdCBwYXJlbnRXaWR0aCA9IHVzZVBhcmVudFJlY3QgPyByZWN0WzJdIC0gcmVjdFswXSArIEhPUklaT05UQUxfU1BBQ0VfQUZURVJfQU5OT1RBVElPTiA6IDA7CiAgICBjb25zdCBwb3B1cExlZnQgPSBub3JtYWxpemVkUmVjdFswXSArIHBhcmVudFdpZHRoOwogICAgY29uc3QgcG9wdXBUb3AgPSBub3JtYWxpemVkUmVjdFsxXTsKICAgIHRoaXMuI3Bvc2l0aW9uID0gWzEwMCAqIChwb3B1cExlZnQgLSBwYWdlWCkgLyBwYWdlV2lkdGgsIDEwMCAqIChwb3B1cFRvcCAtIHBhZ2VZKSAvIHBhZ2VIZWlnaHRdOwogICAgY29uc3QgewogICAgICBzdHlsZQogICAgfSA9IHRoaXMuI2NvbnRhaW5lcjsKICAgIHN0eWxlLmxlZnQgPSBgJHt0aGlzLiNwb3NpdGlvblswXX0lYDsKICAgIHN0eWxlLnRvcCA9IGAke3RoaXMuI3Bvc2l0aW9uWzFdfSVgOwogIH0KICAjdG9nZ2xlKCkgewogICAgaWYgKHRoaXMuI2NvbW1lbnRNYW5hZ2VyKSB7CiAgICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyLnRvZ2dsZUNvbW1lbnRQb3B1cCh0aGlzLCBmYWxzZSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3Bpbm5lZCA9ICF0aGlzLiNwaW5uZWQ7CiAgICBpZiAodGhpcy4jcGlubmVkKSB7CiAgICAgIHRoaXMuI3Nob3coKTsKICAgICAgdGhpcy4jY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy4jYm91bmRUb2dnbGUpOwogICAgICB0aGlzLiNjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuI2JvdW5kS2V5RG93bik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNoaWRlKCk7CiAgICAgIHRoaXMuI2NvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuI2JvdW5kVG9nZ2xlKTsKICAgICAgdGhpcy4jY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLiNib3VuZEtleURvd24pOwogICAgfQogIH0KICAjc2hvdygpIHsKICAgIGlmICghdGhpcy4jcG9wdXApIHsKICAgICAgdGhpcy5yZW5kZXIoKTsKICAgIH0KICAgIGlmICghdGhpcy5pc1Zpc2libGUpIHsKICAgICAgdGhpcy4jc2V0UG9zaXRpb24oKTsKICAgICAgdGhpcy4jY29udGFpbmVyLmhpZGRlbiA9IGZhbHNlOwogICAgICB0aGlzLiNjb250YWluZXIuc3R5bGUuekluZGV4ID0gcGFyc2VJbnQodGhpcy4jY29udGFpbmVyLnN0eWxlLnpJbmRleCkgKyAxZTM7CiAgICB9IGVsc2UgaWYgKHRoaXMuI3Bpbm5lZCkgewogICAgICB0aGlzLiNjb250YWluZXIuY2xhc3NMaXN0LmFkZCgiZm9jdXNlZCIpOwogICAgfQogIH0KICAjaGlkZSgpIHsKICAgIHRoaXMuI2NvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCJmb2N1c2VkIik7CiAgICBpZiAodGhpcy4jcGlubmVkIHx8ICF0aGlzLmlzVmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNjb250YWluZXIuaGlkZGVuID0gdHJ1ZTsKICAgIHRoaXMuI2NvbnRhaW5lci5zdHlsZS56SW5kZXggPSBwYXJzZUludCh0aGlzLiNjb250YWluZXIuc3R5bGUuekluZGV4KSAtIDFlMzsKICB9CiAgZm9yY2VIaWRlKCkgewogICAgdGhpcy4jd2FzVmlzaWJsZSA9IHRoaXMuaXNWaXNpYmxlOwogICAgaWYgKCF0aGlzLiN3YXNWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvbnRhaW5lci5oaWRkZW4gPSB0cnVlOwogIH0KICBtYXliZVNob3coKSB7CiAgICBpZiAodGhpcy4jY29tbWVudE1hbmFnZXIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jYWRkRXZlbnRMaXN0ZW5lcnMoKTsKICAgIGlmICghdGhpcy4jd2FzVmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI3BvcHVwKSB7CiAgICAgIHRoaXMuI3Nob3coKTsKICAgIH0KICAgIHRoaXMuI3dhc1Zpc2libGUgPSBmYWxzZTsKICAgIHRoaXMuI2NvbnRhaW5lci5oaWRkZW4gPSBmYWxzZTsKICB9CiAgZ2V0IGlzVmlzaWJsZSgpIHsKICAgIGlmICh0aGlzLiNjb21tZW50TWFuYWdlcikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdGhpcy4jY29udGFpbmVyLmhpZGRlbiA9PT0gZmFsc2U7CiAgfQp9Owp2YXIgRnJlZVRleHRBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUKICAgIH0pOwogICAgdGhpcy50ZXh0Q29udGVudCA9IHBhcmFtZXRlcnMuZGF0YS50ZXh0Q29udGVudDsKICAgIHRoaXMudGV4dFBvc2l0aW9uID0gcGFyYW1ldGVycy5kYXRhLnRleHRQb3NpdGlvbjsKICAgIHRoaXMuYW5ub3RhdGlvbkVkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5GUkVFVEVYVDsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiZnJlZVRleHRBbm5vdGF0aW9uIik7CiAgICBpZiAodGhpcy50ZXh0Q29udGVudCkgewogICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5jb250ZW50RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBjb250ZW50LmNsYXNzTGlzdC5hZGQoImFubm90YXRpb25UZXh0Q29udGVudCIpOwogICAgICBjb250ZW50LnNldEF0dHJpYnV0ZSgicm9sZSIsICJjb21tZW50Iik7CiAgICAgIGZvciAoY29uc3QgbGluZSBvZiB0aGlzLnRleHRDb250ZW50KSB7CiAgICAgICAgY29uc3QgbGluZVNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgICAgbGluZVNwYW4udGV4dENvbnRlbnQgPSBsaW5lOwogICAgICAgIGNvbnRlbnQuYXBwZW5kKGxpbmVTcGFuKTsKICAgICAgfQogICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmQoY29udGVudCk7CiAgICB9CiAgICBpZiAoIXRoaXMuZGF0YS5wb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgdGhpcy5fZWRpdE9uRG91YmxlQ2xpY2soKTsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBMaW5lQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICAjbGluZSA9IG51bGw7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogdHJ1ZQogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImxpbmVBbm5vdGF0aW9uIik7CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgY29uc3Qgc3ZnID0gdGhpcy5zdmdGYWN0b3J5LmNyZWF0ZSh3aWR0aCwgaGVpZ2h0LCB0cnVlKTsKICAgIGNvbnN0IGxpbmUgPSB0aGlzLiNsaW5lID0gdGhpcy5zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInN2ZzpsaW5lIik7CiAgICBsaW5lLnNldEF0dHJpYnV0ZSgieDEiLCBkYXRhLnJlY3RbMl0gLSBkYXRhLmxpbmVDb29yZGluYXRlc1swXSk7CiAgICBsaW5lLnNldEF0dHJpYnV0ZSgieTEiLCBkYXRhLnJlY3RbM10gLSBkYXRhLmxpbmVDb29yZGluYXRlc1sxXSk7CiAgICBsaW5lLnNldEF0dHJpYnV0ZSgieDIiLCBkYXRhLnJlY3RbMl0gLSBkYXRhLmxpbmVDb29yZGluYXRlc1syXSk7CiAgICBsaW5lLnNldEF0dHJpYnV0ZSgieTIiLCBkYXRhLnJlY3RbM10gLSBkYXRhLmxpbmVDb29yZGluYXRlc1szXSk7CiAgICBsaW5lLnNldEF0dHJpYnV0ZSgic3Ryb2tlLXdpZHRoIiwgZGF0YS5ib3JkZXJTdHlsZS53aWR0aCB8fCAxKTsKICAgIGxpbmUuc2V0QXR0cmlidXRlKCJzdHJva2UiLCAidHJhbnNwYXJlbnQiKTsKICAgIGxpbmUuc2V0QXR0cmlidXRlKCJmaWxsIiwgInRyYW5zcGFyZW50Iik7CiAgICBzdmcuYXBwZW5kKGxpbmUpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHN2Zyk7CiAgICBpZiAoIWRhdGEucG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgZ2V0RWxlbWVudHNUb1RyaWdnZXJQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLiNsaW5lOwogIH0KICBhZGRIaWdobGlnaHRBcmVhKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiaGlnaGxpZ2h0QXJlYSIpOwogIH0KfTsKdmFyIFNxdWFyZUFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgI3NxdWFyZSA9IG51bGw7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogdHJ1ZQogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInNxdWFyZUFubm90YXRpb24iKTsKICAgIGNvbnN0IHsKICAgICAgZGF0YSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXM7CiAgICBjb25zdCBzdmcgPSB0aGlzLnN2Z0ZhY3RvcnkuY3JlYXRlKHdpZHRoLCBoZWlnaHQsIHRydWUpOwogICAgY29uc3QgYm9yZGVyV2lkdGggPSBkYXRhLmJvcmRlclN0eWxlLndpZHRoOwogICAgY29uc3Qgc3F1YXJlID0gdGhpcy4jc3F1YXJlID0gdGhpcy5zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInN2ZzpyZWN0Iik7CiAgICBzcXVhcmUuc2V0QXR0cmlidXRlKCJ4IiwgYm9yZGVyV2lkdGggLyAyKTsKICAgIHNxdWFyZS5zZXRBdHRyaWJ1dGUoInkiLCBib3JkZXJXaWR0aCAvIDIpOwogICAgc3F1YXJlLnNldEF0dHJpYnV0ZSgid2lkdGgiLCB3aWR0aCAtIGJvcmRlcldpZHRoKTsKICAgIHNxdWFyZS5zZXRBdHRyaWJ1dGUoImhlaWdodCIsIGhlaWdodCAtIGJvcmRlcldpZHRoKTsKICAgIHNxdWFyZS5zZXRBdHRyaWJ1dGUoInN0cm9rZS13aWR0aCIsIGJvcmRlcldpZHRoIHx8IDEpOwogICAgc3F1YXJlLnNldEF0dHJpYnV0ZSgic3Ryb2tlIiwgInRyYW5zcGFyZW50Iik7CiAgICBzcXVhcmUuc2V0QXR0cmlidXRlKCJmaWxsIiwgInRyYW5zcGFyZW50Iik7CiAgICBzdmcuYXBwZW5kKHNxdWFyZSk7CiAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmQoc3ZnKTsKICAgIGlmICghZGF0YS5wb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KICBnZXRFbGVtZW50c1RvVHJpZ2dlclBvcHVwKCkgewogICAgcmV0dXJuIHRoaXMuI3NxdWFyZTsKICB9CiAgYWRkSGlnaGxpZ2h0QXJlYSgpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodEFyZWEiKTsKICB9Cn07CnZhciBDaXJjbGVBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogICNjaXJjbGUgPSBudWxsOwogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJjaXJjbGVBbm5vdGF0aW9uIik7CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgY29uc3Qgc3ZnID0gdGhpcy5zdmdGYWN0b3J5LmNyZWF0ZSh3aWR0aCwgaGVpZ2h0LCB0cnVlKTsKICAgIGNvbnN0IGJvcmRlcldpZHRoID0gZGF0YS5ib3JkZXJTdHlsZS53aWR0aDsKICAgIGNvbnN0IGNpcmNsZSA9IHRoaXMuI2NpcmNsZSA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJzdmc6ZWxsaXBzZSIpOwogICAgY2lyY2xlLnNldEF0dHJpYnV0ZSgiY3giLCB3aWR0aCAvIDIpOwogICAgY2lyY2xlLnNldEF0dHJpYnV0ZSgiY3kiLCBoZWlnaHQgLyAyKTsKICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoInJ4Iiwgd2lkdGggLyAyIC0gYm9yZGVyV2lkdGggLyAyKTsKICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoInJ5IiwgaGVpZ2h0IC8gMiAtIGJvcmRlcldpZHRoIC8gMik7CiAgICBjaXJjbGUuc2V0QXR0cmlidXRlKCJzdHJva2Utd2lkdGgiLCBib3JkZXJXaWR0aCB8fCAxKTsKICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoInN0cm9rZSIsICJ0cmFuc3BhcmVudCIpOwogICAgY2lyY2xlLnNldEF0dHJpYnV0ZSgiZmlsbCIsICJ0cmFuc3BhcmVudCIpOwogICAgc3ZnLmFwcGVuZChjaXJjbGUpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHN2Zyk7CiAgICBpZiAoIWRhdGEucG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgZ2V0RWxlbWVudHNUb1RyaWdnZXJQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLiNjaXJjbGU7CiAgfQogIGFkZEhpZ2hsaWdodEFyZWEoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJoaWdobGlnaHRBcmVhIik7CiAgfQp9Owp2YXIgUG9seWxpbmVBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogICNwb2x5bGluZSA9IG51bGw7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogdHJ1ZQogICAgfSk7CiAgICB0aGlzLmNvbnRhaW5lckNsYXNzTmFtZSA9ICJwb2x5bGluZUFubm90YXRpb24iOwogICAgdGhpcy5zdmdFbGVtZW50TmFtZSA9ICJzdmc6cG9seWxpbmUiOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKHRoaXMuY29udGFpbmVyQ2xhc3NOYW1lKTsKICAgIGNvbnN0IHsKICAgICAgZGF0YTogewogICAgICAgIHJlY3QsCiAgICAgICAgdmVydGljZXMsCiAgICAgICAgYm9yZGVyU3R5bGUsCiAgICAgICAgcG9wdXBSZWYKICAgICAgfSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXM7CiAgICBpZiAoIXZlcnRpY2VzKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICAgIH0KICAgIGNvbnN0IHN2ZyA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGUod2lkdGgsIGhlaWdodCwgdHJ1ZSk7CiAgICBsZXQgcG9pbnRzID0gW107CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSB2ZXJ0aWNlcy5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIGNvbnN0IHggPSB2ZXJ0aWNlc1tpXSAtIHJlY3RbMF07CiAgICAgIGNvbnN0IHkgPSByZWN0WzNdIC0gdmVydGljZXNbaSArIDFdOwogICAgICBwb2ludHMucHVzaChgJHt4fSwke3l9YCk7CiAgICB9CiAgICBwb2ludHMgPSBwb2ludHMuam9pbigiICIpOwogICAgY29uc3QgcG9seWxpbmUgPSB0aGlzLiNwb2x5bGluZSA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KHRoaXMuc3ZnRWxlbWVudE5hbWUpOwogICAgcG9seWxpbmUuc2V0QXR0cmlidXRlKCJwb2ludHMiLCBwb2ludHMpOwogICAgcG9seWxpbmUuc2V0QXR0cmlidXRlKCJzdHJva2Utd2lkdGgiLCBib3JkZXJTdHlsZS53aWR0aCB8fCAxKTsKICAgIHBvbHlsaW5lLnNldEF0dHJpYnV0ZSgic3Ryb2tlIiwgInRyYW5zcGFyZW50Iik7CiAgICBwb2x5bGluZS5zZXRBdHRyaWJ1dGUoImZpbGwiLCAidHJhbnNwYXJlbnQiKTsKICAgIHN2Zy5hcHBlbmQocG9seWxpbmUpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHN2Zyk7CiAgICBpZiAoIXBvcHVwUmVmICYmIHRoaXMuaGFzUG9wdXBEYXRhKSB7CiAgICAgIHRoaXMuaGFzT3duQ29tbWVudEJ1dHRvbiA9IHRydWU7CiAgICAgIHRoaXMuX2NyZWF0ZVBvcHVwKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQogIGdldEVsZW1lbnRzVG9UcmlnZ2VyUG9wdXAoKSB7CiAgICByZXR1cm4gdGhpcy4jcG9seWxpbmU7CiAgfQogIGFkZEhpZ2hsaWdodEFyZWEoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJoaWdobGlnaHRBcmVhIik7CiAgfQp9Owp2YXIgUG9seWdvbkFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBQb2x5bGluZUFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzKTsKICAgIHRoaXMuY29udGFpbmVyQ2xhc3NOYW1lID0gInBvbHlnb25Bbm5vdGF0aW9uIjsKICAgIHRoaXMuc3ZnRWxlbWVudE5hbWUgPSAic3ZnOnBvbHlnb24iOwogIH0KfTsKdmFyIENhcmV0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiY2FyZXRBbm5vdGF0aW9uIik7CiAgICBpZiAoIXRoaXMuZGF0YS5wb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIElua0Fubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgI3BvbHlsaW5lc0dyb3VwRWxlbWVudCA9IG51bGw7CiAgI3BvbHlsaW5lcyA9IFtdOwogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUKICAgIH0pOwogICAgdGhpcy5jb250YWluZXJDbGFzc05hbWUgPSAiaW5rQW5ub3RhdGlvbiI7CiAgICB0aGlzLnN2Z0VsZW1lbnROYW1lID0gInN2Zzpwb2x5bGluZSI7CiAgICB0aGlzLmFubm90YXRpb25FZGl0b3JUeXBlID0gdGhpcy5kYXRhLml0ID09PSAiSW5rSGlnaGxpZ2h0IiA/IEFubm90YXRpb25FZGl0b3JUeXBlLkhJR0hMSUdIVCA6IEFubm90YXRpb25FZGl0b3JUeXBlLklOSzsKICB9CiAgI2dldFRyYW5zZm9ybShyb3RhdGlvbiwgcmVjdCkgewogICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0cmFuc2Zvcm06IGByb3RhdGUoOTApIHRyYW5zbGF0ZSgkey1yZWN0WzBdfSwke3JlY3RbMV19KSBzY2FsZSgxLC0xKWAsCiAgICAgICAgICB3aWR0aDogcmVjdFszXSAtIHJlY3RbMV0sCiAgICAgICAgICBoZWlnaHQ6IHJlY3RbMl0gLSByZWN0WzBdCiAgICAgICAgfTsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHRyYW5zZm9ybTogYHJvdGF0ZSgxODApIHRyYW5zbGF0ZSgkey1yZWN0WzJdfSwke3JlY3RbMV19KSBzY2FsZSgxLC0xKWAsCiAgICAgICAgICB3aWR0aDogcmVjdFsyXSAtIHJlY3RbMF0sCiAgICAgICAgICBoZWlnaHQ6IHJlY3RbM10gLSByZWN0WzFdCiAgICAgICAgfTsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHRyYW5zZm9ybTogYHJvdGF0ZSgyNzApIHRyYW5zbGF0ZSgkey1yZWN0WzJdfSwke3JlY3RbM119KSBzY2FsZSgxLC0xKWAsCiAgICAgICAgICB3aWR0aDogcmVjdFszXSAtIHJlY3RbMV0sCiAgICAgICAgICBoZWlnaHQ6IHJlY3RbMl0gLSByZWN0WzBdCiAgICAgICAgfTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHJhbnNmb3JtOiBgdHJhbnNsYXRlKCR7LXJlY3RbMF19LCR7cmVjdFszXX0pIHNjYWxlKDEsLTEpYCwKICAgICAgICAgIHdpZHRoOiByZWN0WzJdIC0gcmVjdFswXSwKICAgICAgICAgIGhlaWdodDogcmVjdFszXSAtIHJlY3RbMV0KICAgICAgICB9OwogICAgfQogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKHRoaXMuY29udGFpbmVyQ2xhc3NOYW1lKTsKICAgIGNvbnN0IHsKICAgICAgZGF0YTogewogICAgICAgIHJlY3QsCiAgICAgICAgcm90YXRpb24sCiAgICAgICAgaW5rTGlzdHMsCiAgICAgICAgYm9yZGVyU3R5bGUsCiAgICAgICAgcG9wdXBSZWYKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBjb25zdCB7CiAgICAgIHRyYW5zZm9ybSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXMuI2dldFRyYW5zZm9ybShyb3RhdGlvbiwgcmVjdCk7CiAgICBjb25zdCBzdmcgPSB0aGlzLnN2Z0ZhY3RvcnkuY3JlYXRlKHdpZHRoLCBoZWlnaHQsIHRydWUpOwogICAgY29uc3QgZyA9IHRoaXMuI3BvbHlsaW5lc0dyb3VwRWxlbWVudCA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJzdmc6ZyIpOwogICAgc3ZnLmFwcGVuZChnKTsKICAgIGcuc2V0QXR0cmlidXRlKCJzdHJva2Utd2lkdGgiLCBib3JkZXJTdHlsZS53aWR0aCB8fCAxKTsKICAgIGcuc2V0QXR0cmlidXRlKCJzdHJva2UtbGluZWNhcCIsICJyb3VuZCIpOwogICAgZy5zZXRBdHRyaWJ1dGUoInN0cm9rZS1saW5lam9pbiIsICJyb3VuZCIpOwogICAgZy5zZXRBdHRyaWJ1dGUoInN0cm9rZS1taXRlcmxpbWl0IiwgMTApOwogICAgZy5zZXRBdHRyaWJ1dGUoInN0cm9rZSIsICJ0cmFuc3BhcmVudCIpOwogICAgZy5zZXRBdHRyaWJ1dGUoImZpbGwiLCAidHJhbnNwYXJlbnQiKTsKICAgIGcuc2V0QXR0cmlidXRlKCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0pOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gaW5rTGlzdHMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICBjb25zdCBwb2x5bGluZSA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KHRoaXMuc3ZnRWxlbWVudE5hbWUpOwogICAgICB0aGlzLiNwb2x5bGluZXMucHVzaChwb2x5bGluZSk7CiAgICAgIHBvbHlsaW5lLnNldEF0dHJpYnV0ZSgicG9pbnRzIiwgaW5rTGlzdHNbaV0uam9pbigiLCIpKTsKICAgICAgZy5hcHBlbmQocG9seWxpbmUpOwogICAgfQogICAgaWYgKCFwb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHN2Zyk7CiAgICB0aGlzLl9lZGl0T25Eb3VibGVDbGljaygpOwogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KICB1cGRhdGVFZGl0ZWQocGFyYW1zKSB7CiAgICBzdXBlci51cGRhdGVFZGl0ZWQocGFyYW1zKTsKICAgIGNvbnN0IHsKICAgICAgdGhpY2tuZXNzLAogICAgICBwb2ludHMsCiAgICAgIHJlY3QKICAgIH0gPSBwYXJhbXM7CiAgICBjb25zdCBnID0gdGhpcy4jcG9seWxpbmVzR3JvdXBFbGVtZW50OwogICAgaWYgKHRoaWNrbmVzcyA+PSAwKSB7CiAgICAgIGcuc2V0QXR0cmlidXRlKCJzdHJva2Utd2lkdGgiLCB0aGlja25lc3MgfHwgMSk7CiAgICB9CiAgICBpZiAocG9pbnRzKSB7CiAgICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHRoaXMuI3BvbHlsaW5lcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgdGhpcy4jcG9seWxpbmVzW2ldLnNldEF0dHJpYnV0ZSgicG9pbnRzIiwgcG9pbnRzW2ldLmpvaW4oIiwiKSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChyZWN0KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICB0cmFuc2Zvcm0sCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0CiAgICAgIH0gPSB0aGlzLiNnZXRUcmFuc2Zvcm0odGhpcy5kYXRhLnJvdGF0aW9uLCByZWN0KTsKICAgICAgY29uc3Qgcm9vdDIgPSBnLnBhcmVudEVsZW1lbnQ7CiAgICAgIHJvb3QyLnNldEF0dHJpYnV0ZSgidmlld0JveCIsIGAwIDAgJHt3aWR0aH0gJHtoZWlnaHR9YCk7CiAgICAgIGcuc2V0QXR0cmlidXRlKCJ0cmFuc2Zvcm0iLCB0cmFuc2Zvcm0pOwogICAgfQogIH0KICBnZXRFbGVtZW50c1RvVHJpZ2dlclBvcHVwKCkgewogICAgcmV0dXJuIHRoaXMuI3BvbHlsaW5lczsKICB9CiAgYWRkSGlnaGxpZ2h0QXJlYSgpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodEFyZWEiKTsKICB9Cn07CnZhciBIaWdobGlnaHRBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUsCiAgICAgIGNyZWF0ZVF1YWRyaWxhdGVyYWxzOiB0cnVlCiAgICB9KTsKICAgIHRoaXMuYW5ub3RhdGlvbkVkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQ7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YTogewogICAgICAgIG92ZXJsYWlkVGV4dCwKICAgICAgICBwb3B1cFJlZgogICAgICB9CiAgICB9ID0gdGhpczsKICAgIGlmICghcG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodEFubm90YXRpb24iKTsKICAgIHRoaXMuX2VkaXRPbkRvdWJsZUNsaWNrKCk7CiAgICBpZiAob3ZlcmxhaWRUZXh0KSB7CiAgICAgIGNvbnN0IG1hcmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJtYXJrIik7CiAgICAgIG1hcmsuY2xhc3NMaXN0LmFkZCgib3ZlcmxhaWRUZXh0Iik7CiAgICAgIG1hcmsudGV4dENvbnRlbnQgPSBvdmVybGFpZFRleHQ7CiAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChtYXJrKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBVbmRlcmxpbmVBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUsCiAgICAgIGNyZWF0ZVF1YWRyaWxhdGVyYWxzOiB0cnVlCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3QgewogICAgICBkYXRhOiB7CiAgICAgICAgb3ZlcmxhaWRUZXh0LAogICAgICAgIHBvcHVwUmVmCiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgaWYgKCFwb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgidW5kZXJsaW5lQW5ub3RhdGlvbiIpOwogICAgaWYgKG92ZXJsYWlkVGV4dCkgewogICAgICBjb25zdCB1bmRlcmxpbmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ1Iik7CiAgICAgIHVuZGVybGluZS5jbGFzc0xpc3QuYWRkKCJvdmVybGFpZFRleHQiKTsKICAgICAgdW5kZXJsaW5lLnRleHRDb250ZW50ID0gb3ZlcmxhaWRUZXh0OwogICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmQodW5kZXJsaW5lKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBTcXVpZ2dseUFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogdHJ1ZSwKICAgICAgY3JlYXRlUXVhZHJpbGF0ZXJhbHM6IHRydWUKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGE6IHsKICAgICAgICBvdmVybGFpZFRleHQsCiAgICAgICAgcG9wdXBSZWYKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBpZiAoIXBvcHVwUmVmICYmIHRoaXMuaGFzUG9wdXBEYXRhKSB7CiAgICAgIHRoaXMuaGFzT3duQ29tbWVudEJ1dHRvbiA9IHRydWU7CiAgICAgIHRoaXMuX2NyZWF0ZVBvcHVwKCk7CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJzcXVpZ2dseUFubm90YXRpb24iKTsKICAgIGlmIChvdmVybGFpZFRleHQpIHsKICAgICAgY29uc3QgdW5kZXJsaW5lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidSIpOwogICAgICB1bmRlcmxpbmUuY2xhc3NMaXN0LmFkZCgib3ZlcmxhaWRUZXh0Iik7CiAgICAgIHVuZGVybGluZS50ZXh0Q29udGVudCA9IG92ZXJsYWlkVGV4dDsKICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHVuZGVybGluZSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgU3RyaWtlT3V0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlLAogICAgICBjcmVhdGVRdWFkcmlsYXRlcmFsczogdHJ1ZQogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YTogewogICAgICAgIG92ZXJsYWlkVGV4dCwKICAgICAgICBwb3B1cFJlZgogICAgICB9CiAgICB9ID0gdGhpczsKICAgIGlmICghcG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInN0cmlrZW91dEFubm90YXRpb24iKTsKICAgIGlmIChvdmVybGFpZFRleHQpIHsKICAgICAgY29uc3Qgc3RyaWtlb3V0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicyIpOwogICAgICBzdHJpa2VvdXQuY2xhc3NMaXN0LmFkZCgib3ZlcmxhaWRUZXh0Iik7CiAgICAgIHN0cmlrZW91dC50ZXh0Q29udGVudCA9IG92ZXJsYWlkVGV4dDsKICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHN0cmlrZW91dCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgU3RhbXBBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUKICAgIH0pOwogICAgdGhpcy5hbm5vdGF0aW9uRWRpdG9yVHlwZSA9IEFubm90YXRpb25FZGl0b3JUeXBlLlNUQU1QOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJzdGFtcEFubm90YXRpb24iKTsKICAgIHRoaXMuY29udGFpbmVyLnNldEF0dHJpYnV0ZSgicm9sZSIsICJpbWciKTsKICAgIGlmICghdGhpcy5kYXRhLnBvcHVwUmVmICYmIHRoaXMuaGFzUG9wdXBEYXRhKSB7CiAgICAgIHRoaXMuaGFzT3duQ29tbWVudEJ1dHRvbiA9IHRydWU7CiAgICAgIHRoaXMuX2NyZWF0ZVBvcHVwKCk7CiAgICB9CiAgICB0aGlzLl9lZGl0T25Eb3VibGVDbGljaygpOwogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIEZpbGVBdHRhY2htZW50QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICAjdHJpZ2dlciA9IG51bGw7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUKICAgIH0pOwogICAgY29uc3QgewogICAgICBmaWxlCiAgICB9ID0gdGhpcy5kYXRhOwogICAgdGhpcy5maWxlbmFtZSA9IGZpbGUuZmlsZW5hbWU7CiAgICB0aGlzLmNvbnRlbnQgPSBmaWxlLmNvbnRlbnQ7CiAgICB0aGlzLmxpbmtTZXJ2aWNlLmV2ZW50QnVzPy5kaXNwYXRjaCgiZmlsZWF0dGFjaG1lbnRhbm5vdGF0aW9uIiwgewogICAgICBzb3VyY2U6IHRoaXMsCiAgICAgIC4uLmZpbGUKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJmaWxlQXR0YWNobWVudEFubm90YXRpb24iKTsKICAgIGNvbnN0IHsKICAgICAgY29udGFpbmVyOiBjb250YWluZXIyLAogICAgICBkYXRhCiAgICB9ID0gdGhpczsKICAgIGxldCB0cmlnZ2VyOwogICAgaWYgKGRhdGEuaGFzQXBwZWFyYW5jZSB8fCBkYXRhLmZpbGxBbHBoYSA9PT0gMCkgewogICAgICB0cmlnZ2VyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB9IGVsc2UgewogICAgICB0cmlnZ2VyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgICAgIHRyaWdnZXIuc3JjID0gYCR7dGhpcy5pbWFnZVJlc291cmNlc1BhdGh9YW5ub3RhdGlvbi0key9wYXBlcmNsaXAvaS50ZXN0KGRhdGEubmFtZSkgPyAicGFwZXJjbGlwIiA6ICJwdXNocGluIn0uc3ZnYDsKICAgICAgaWYgKGRhdGEuZmlsbEFscGhhICYmIGRhdGEuZmlsbEFscGhhIDwgMSkgewogICAgICAgIHRyaWdnZXIuc3R5bGUgPSBgZmlsdGVyOiBvcGFjaXR5KCR7TWF0aC5yb3VuZChkYXRhLmZpbGxBbHBoYSAqIDEwMCl9JSk7YDsKICAgICAgfQogICAgfQogICAgdHJpZ2dlci5hZGRFdmVudExpc3RlbmVyKCJkYmxjbGljayIsIHRoaXMuI2Rvd25sb2FkLmJpbmQodGhpcykpOwogICAgdGhpcy4jdHJpZ2dlciA9IHRyaWdnZXI7CiAgICBjb25zdCB7CiAgICAgIGlzTWFjCiAgICB9ID0gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybTsKICAgIGNvbnRhaW5lcjIuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIChldnQpID0+IHsKICAgICAgaWYgKGV2dC5rZXkgPT09ICJFbnRlciIgJiYgKGlzTWFjID8gZXZ0Lm1ldGFLZXkgOiBldnQuY3RybEtleSkpIHsKICAgICAgICB0aGlzLiNkb3dubG9hZCgpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghZGF0YS5wb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfSBlbHNlIHsKICAgICAgdHJpZ2dlci5jbGFzc0xpc3QuYWRkKCJwb3B1cFRyaWdnZXJBcmVhIik7CiAgICB9CiAgICBjb250YWluZXIyLmFwcGVuZCh0cmlnZ2VyKTsKICAgIHJldHVybiBjb250YWluZXIyOwogIH0KICBnZXRFbGVtZW50c1RvVHJpZ2dlclBvcHVwKCkgewogICAgcmV0dXJuIHRoaXMuI3RyaWdnZXI7CiAgfQogIGFkZEhpZ2hsaWdodEFyZWEoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJoaWdobGlnaHRBcmVhIik7CiAgfQogICNkb3dubG9hZCgpIHsKICAgIHRoaXMuZG93bmxvYWRNYW5hZ2VyPy5vcGVuT3JEb3dubG9hZERhdGEodGhpcy5jb250ZW50LCB0aGlzLmZpbGVuYW1lKTsKICB9Cn07CnZhciBBbm5vdGF0aW9uTGF5ZXIgPSBjbGFzcyBfQW5ub3RhdGlvbkxheWVyIHsKICAjYWNjZXNzaWJpbGl0eU1hbmFnZXIgPSBudWxsOwogICNhbm5vdGF0aW9uQ2FudmFzTWFwID0gbnVsbDsKICAjYW5ub3RhdGlvblN0b3JhZ2UgPSBudWxsOwogICNlZGl0YWJsZUFubm90YXRpb25zID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjc3RydWN0VHJlZUxheWVyID0gbnVsbDsKICAjbGlua1NlcnZpY2UgPSBudWxsOwogICNlbGVtZW50cyA9IFtdOwogICNoYXNBcmlhQXR0cmlidXRlc0Zyb21TdHJ1Y3RUcmVlID0gZmFsc2U7CiAgY29uc3RydWN0b3IoewogICAgZGl2LAogICAgYWNjZXNzaWJpbGl0eU1hbmFnZXIsCiAgICBhbm5vdGF0aW9uQ2FudmFzTWFwLAogICAgYW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlciwKICAgIHBhZ2UsCiAgICB2aWV3cG9ydCwKICAgIHN0cnVjdFRyZWVMYXllciwKICAgIGNvbW1lbnRNYW5hZ2VyLAogICAgbGlua1NlcnZpY2UsCiAgICBhbm5vdGF0aW9uU3RvcmFnZQogIH0pIHsKICAgIHRoaXMuZGl2ID0gZGl2OwogICAgdGhpcy4jYWNjZXNzaWJpbGl0eU1hbmFnZXIgPSBhY2Nlc3NpYmlsaXR5TWFuYWdlcjsKICAgIHRoaXMuI2Fubm90YXRpb25DYW52YXNNYXAgPSBhbm5vdGF0aW9uQ2FudmFzTWFwOwogICAgdGhpcy4jc3RydWN0VHJlZUxheWVyID0gc3RydWN0VHJlZUxheWVyIHx8IG51bGw7CiAgICB0aGlzLiNsaW5rU2VydmljZSA9IGxpbmtTZXJ2aWNlIHx8IG51bGw7CiAgICB0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZSA9IGFubm90YXRpb25TdG9yYWdlIHx8IG5ldyBBbm5vdGF0aW9uU3RvcmFnZSgpOwogICAgdGhpcy5wYWdlID0gcGFnZTsKICAgIHRoaXMudmlld3BvcnQgPSB2aWV3cG9ydDsKICAgIHRoaXMuekluZGV4ID0gMDsKICAgIHRoaXMuX2Fubm90YXRpb25FZGl0b3JVSU1hbmFnZXIgPSBhbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyOwogICAgdGhpcy5fY29tbWVudE1hbmFnZXIgPSBjb21tZW50TWFuYWdlciB8fCBudWxsOwogIH0KICBoYXNFZGl0YWJsZUFubm90YXRpb25zKCkgewogICAgcmV0dXJuIHRoaXMuI2VkaXRhYmxlQW5ub3RhdGlvbnMuc2l6ZSA+IDA7CiAgfQogIGFzeW5jIHJlbmRlcihwYXJhbXMpIHsKICAgIGNvbnN0IHsKICAgICAgYW5ub3RhdGlvbnMKICAgIH0gPSBwYXJhbXM7CiAgICBjb25zdCBsYXllciA9IHRoaXMuZGl2OwogICAgc2V0TGF5ZXJEaW1lbnNpb25zKGxheWVyLCB0aGlzLnZpZXdwb3J0KTsKICAgIGNvbnN0IHBvcHVwVG9FbGVtZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBjb25zdCBwb3B1cEFubm90YXRpb25zID0gW107CiAgICBjb25zdCBlbGVtZW50UGFyYW1zID0gewogICAgICBkYXRhOiBudWxsLAogICAgICBsYXllciwKICAgICAgbGlua1NlcnZpY2U6IHRoaXMuI2xpbmtTZXJ2aWNlLAogICAgICBkb3dubG9hZE1hbmFnZXI6IHBhcmFtcy5kb3dubG9hZE1hbmFnZXIsCiAgICAgIGltYWdlUmVzb3VyY2VzUGF0aDogcGFyYW1zLmltYWdlUmVzb3VyY2VzUGF0aCB8fCAiIiwKICAgICAgcmVuZGVyRm9ybXM6IHBhcmFtcy5yZW5kZXJGb3JtcyAhPT0gZmFsc2UsCiAgICAgIHN2Z0ZhY3Rvcnk6IG5ldyBET01TVkdGYWN0b3J5KCksCiAgICAgIGFubm90YXRpb25TdG9yYWdlOiB0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZSwKICAgICAgZW5hYmxlQ29tbWVudDogcGFyYW1zLmVuYWJsZUNvbW1lbnQgPT09IHRydWUsCiAgICAgIGVuYWJsZVNjcmlwdGluZzogcGFyYW1zLmVuYWJsZVNjcmlwdGluZyA9PT0gdHJ1ZSwKICAgICAgaGFzSlNBY3Rpb25zOiBwYXJhbXMuaGFzSlNBY3Rpb25zLAogICAgICBmaWVsZE9iamVjdHM6IHBhcmFtcy5maWVsZE9iamVjdHMsCiAgICAgIHBhcmVudDogdGhpcywKICAgICAgZWxlbWVudHM6IG51bGwKICAgIH07CiAgICBmb3IgKGNvbnN0IGRhdGEgb2YgYW5ub3RhdGlvbnMpIHsKICAgICAgaWYgKGRhdGEubm9IVE1MKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgaXNQb3B1cEFubm90YXRpb24gPSBkYXRhLmFubm90YXRpb25UeXBlID09PSBBbm5vdGF0aW9uVHlwZS5QT1BVUDsKICAgICAgaWYgKCFpc1BvcHVwQW5ub3RhdGlvbikgewogICAgICAgIGlmIChkYXRhLnJlY3RbMl0gPT09IGRhdGEucmVjdFswXSB8fCBkYXRhLnJlY3RbM10gPT09IGRhdGEucmVjdFsxXSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gcG9wdXBUb0VsZW1lbnRzLmdldChkYXRhLmlkKTsKICAgICAgICBpZiAoIWVsZW1lbnRzKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9jb21tZW50TWFuYWdlcikgewogICAgICAgICAgcG9wdXBBbm5vdGF0aW9ucy5wdXNoKGRhdGEpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGVsZW1lbnRQYXJhbXMuZWxlbWVudHMgPSBlbGVtZW50czsKICAgICAgfQogICAgICBlbGVtZW50UGFyYW1zLmRhdGEgPSBkYXRhOwogICAgICBjb25zdCBlbGVtZW50ID0gQW5ub3RhdGlvbkVsZW1lbnRGYWN0b3J5LmNyZWF0ZShlbGVtZW50UGFyYW1zKTsKICAgICAgaWYgKCFlbGVtZW50LmlzUmVuZGVyYWJsZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghaXNQb3B1cEFubm90YXRpb24pIHsKICAgICAgICB0aGlzLiNlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgIGlmIChkYXRhLnBvcHVwUmVmKSB7CiAgICAgICAgICBjb25zdCBlbGVtZW50cyA9IHBvcHVwVG9FbGVtZW50cy5nZXQoZGF0YS5wb3B1cFJlZik7CiAgICAgICAgICBpZiAoIWVsZW1lbnRzKSB7CiAgICAgICAgICAgIHBvcHVwVG9FbGVtZW50cy5zZXQoZGF0YS5wb3B1cFJlZiwgW2VsZW1lbnRdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsZW1lbnRzLnB1c2goZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHJlbmRlcmVkID0gZWxlbWVudC5yZW5kZXIoKTsKICAgICAgaWYgKGRhdGEuaGlkZGVuKSB7CiAgICAgICAgcmVuZGVyZWQuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgICB9CiAgICAgIGlmIChlbGVtZW50Ll9pc0VkaXRhYmxlKSB7CiAgICAgICAgdGhpcy4jZWRpdGFibGVBbm5vdGF0aW9ucy5zZXQoZWxlbWVudC5kYXRhLmlkLCBlbGVtZW50KTsKICAgICAgICB0aGlzLl9hbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyPy5yZW5kZXJBbm5vdGF0aW9uRWxlbWVudChlbGVtZW50KTsKICAgICAgfQogICAgfQogICAgYXdhaXQgdGhpcy4jYWRkRWxlbWVudHNUb0RPTSgpOwogICAgZm9yIChjb25zdCBkYXRhIG9mIHBvcHVwQW5ub3RhdGlvbnMpIHsKICAgICAgY29uc3QgZWxlbWVudHMgPSBlbGVtZW50UGFyYW1zLmVsZW1lbnRzID0gcG9wdXBUb0VsZW1lbnRzLmdldChkYXRhLmlkKTsKICAgICAgZWxlbWVudFBhcmFtcy5kYXRhID0gZGF0YTsKICAgICAgY29uc3QgZWxlbWVudCA9IEFubm90YXRpb25FbGVtZW50RmFjdG9yeS5jcmVhdGUoZWxlbWVudFBhcmFtcyk7CiAgICAgIGlmICghZWxlbWVudC5pc1JlbmRlcmFibGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCByZW5kZXJlZCA9IGVsZW1lbnQucmVuZGVyKCk7CiAgICAgIGVsZW1lbnQuY29udGVudEVsZW1lbnQuaWQgPSBgJHtBbm5vdGF0aW9uUHJlZml4fSR7ZGF0YS5pZH1gOwogICAgICBpZiAoZGF0YS5oaWRkZW4pIHsKICAgICAgICByZW5kZXJlZC5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICAgIH0KICAgICAgZWxlbWVudHMuYXQoLTEpLmNvbnRhaW5lci5hZnRlcihyZW5kZXJlZCk7CiAgICB9CiAgICB0aGlzLiNzZXRBbm5vdGF0aW9uQ2FudmFzTWFwKCk7CiAgfQogIGFzeW5jICNhZGRFbGVtZW50c1RvRE9NKCkgewogICAgaWYgKHRoaXMuI2VsZW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmRpdi5yZXBsYWNlQ2hpbGRyZW4oKTsKICAgIGNvbnN0IHByb21pc2VzID0gW107CiAgICBpZiAoIXRoaXMuI2hhc0FyaWFBdHRyaWJ1dGVzRnJvbVN0cnVjdFRyZWUpIHsKICAgICAgdGhpcy4jaGFzQXJpYUF0dHJpYnV0ZXNGcm9tU3RydWN0VHJlZSA9IHRydWU7CiAgICAgIGZvciAoY29uc3QgewogICAgICAgIGNvbnRlbnRFbGVtZW50LAogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlkCiAgICAgICAgfQogICAgICB9IG9mIHRoaXMuI2VsZW1lbnRzKSB7CiAgICAgICAgY29uc3QgYW5ub3RhdGlvbklkID0gY29udGVudEVsZW1lbnQuaWQgPSBgJHtBbm5vdGF0aW9uUHJlZml4fSR7aWR9YDsKICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMuI3N0cnVjdFRyZWVMYXllcj8uZ2V0QXJpYUF0dHJpYnV0ZXMoYW5ub3RhdGlvbklkKS50aGVuKChhcmlhQXR0cmlidXRlcykgPT4gewogICAgICAgICAgaWYgKGFyaWFBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGFyaWFBdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgY29udGVudEVsZW1lbnQuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICB9CiAgICB0aGlzLiNlbGVtZW50cy5zb3J0KCh7CiAgICAgIGRhdGE6IHsKICAgICAgICByZWN0OiBbYTAsIGExLCBhMiwgYTNdCiAgICAgIH0KICAgIH0sIHsKICAgICAgZGF0YTogewogICAgICAgIHJlY3Q6IFtiMCwgYjEsIGIyLCBiM10KICAgICAgfQogICAgfSkgPT4gewogICAgICBpZiAoYTAgPT09IGEyICYmIGExID09PSBhMykgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGlmIChiMCA9PT0gYjIgJiYgYjEgPT09IGIzKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIGNvbnN0IHRvcDEgPSBhMzsKICAgICAgY29uc3QgYm90MSA9IGExOwogICAgICBjb25zdCBtaWQxID0gKGExICsgYTMpIC8gMjsKICAgICAgY29uc3QgdG9wMiA9IGIzOwogICAgICBjb25zdCBib3QyID0gYjE7CiAgICAgIGNvbnN0IG1pZDIgPSAoYjEgKyBiMykgLyAyOwogICAgICBpZiAobWlkMSA+PSB0b3AyICYmIG1pZDIgPD0gYm90MSkgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgICBpZiAobWlkMiA+PSB0b3AxICYmIG1pZDEgPD0gYm90MikgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGNvbnN0IGNlbnRlclgxID0gKGEwICsgYTIpIC8gMjsKICAgICAgY29uc3QgY2VudGVyWDIgPSAoYjAgKyBiMikgLyAyOwogICAgICByZXR1cm4gY2VudGVyWDEgLSBjZW50ZXJYMjsKICAgIH0pOwogICAgY29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdGhpcy4jZWxlbWVudHMpIHsKICAgICAgZnJhZ21lbnQuYXBwZW5kKGVsZW1lbnQuY29udGFpbmVyKTsKICAgICAgaWYgKHRoaXMuX2NvbW1lbnRNYW5hZ2VyKSB7CiAgICAgICAgKGVsZW1lbnQuZXh0cmFQb3B1cEVsZW1lbnQ/LnBvcHVwIHx8IGVsZW1lbnQucG9wdXApPy5yZW5kZXJDb21tZW50QnV0dG9uKCk7CiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5leHRyYVBvcHVwRWxlbWVudCkgewogICAgICAgIGZyYWdtZW50LmFwcGVuZChlbGVtZW50LmV4dHJhUG9wdXBFbGVtZW50LnJlbmRlcigpKTsKICAgICAgfQogICAgfQogICAgdGhpcy5kaXYuYXBwZW5kKGZyYWdtZW50KTsKICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTsKICAgIGlmICh0aGlzLiNhY2Nlc3NpYmlsaXR5TWFuYWdlcikgewogICAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdGhpcy4jZWxlbWVudHMpIHsKICAgICAgICB0aGlzLiNhY2Nlc3NpYmlsaXR5TWFuYWdlci5hZGRQb2ludGVySW5UZXh0TGF5ZXIoZWxlbWVudC5jb250ZW50RWxlbWVudCwgZmFsc2UpOwogICAgICB9CiAgICB9CiAgfQogIGFzeW5jIGFkZExpbmtBbm5vdGF0aW9ucyhhbm5vdGF0aW9ucykgewogICAgY29uc3QgZWxlbWVudFBhcmFtcyA9IHsKICAgICAgZGF0YTogbnVsbCwKICAgICAgbGF5ZXI6IHRoaXMuZGl2LAogICAgICBsaW5rU2VydmljZTogdGhpcy4jbGlua1NlcnZpY2UsCiAgICAgIHN2Z0ZhY3Rvcnk6IG5ldyBET01TVkdGYWN0b3J5KCksCiAgICAgIHBhcmVudDogdGhpcwogICAgfTsKICAgIGZvciAoY29uc3QgZGF0YSBvZiBhbm5vdGF0aW9ucykgewogICAgICBkYXRhLmJvcmRlclN0eWxlIHx8PSBfQW5ub3RhdGlvbkxheWVyLl9kZWZhdWx0Qm9yZGVyU3R5bGU7CiAgICAgIGVsZW1lbnRQYXJhbXMuZGF0YSA9IGRhdGE7CiAgICAgIGNvbnN0IGVsZW1lbnQgPSBBbm5vdGF0aW9uRWxlbWVudEZhY3RvcnkuY3JlYXRlKGVsZW1lbnRQYXJhbXMpOwogICAgICBpZiAoIWVsZW1lbnQuaXNSZW5kZXJhYmxlKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgZWxlbWVudC5yZW5kZXIoKTsKICAgICAgZWxlbWVudC5jb250ZW50RWxlbWVudC5pZCA9IGAke0Fubm90YXRpb25QcmVmaXh9JHtkYXRhLmlkfWA7CiAgICAgIHRoaXMuI2VsZW1lbnRzLnB1c2goZWxlbWVudCk7CiAgICB9CiAgICBhd2FpdCB0aGlzLiNhZGRFbGVtZW50c1RvRE9NKCk7CiAgfQogIHVwZGF0ZSh7CiAgICB2aWV3cG9ydAogIH0pIHsKICAgIGNvbnN0IGxheWVyID0gdGhpcy5kaXY7CiAgICB0aGlzLnZpZXdwb3J0ID0gdmlld3BvcnQ7CiAgICBzZXRMYXllckRpbWVuc2lvbnMobGF5ZXIsIHsKICAgICAgcm90YXRpb246IHZpZXdwb3J0LnJvdGF0aW9uCiAgICB9KTsKICAgIHRoaXMuI3NldEFubm90YXRpb25DYW52YXNNYXAoKTsKICAgIGxheWVyLmhpZGRlbiA9IGZhbHNlOwogIH0KICAjc2V0QW5ub3RhdGlvbkNhbnZhc01hcCgpIHsKICAgIGlmICghdGhpcy4jYW5ub3RhdGlvbkNhbnZhc01hcCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBsYXllciA9IHRoaXMuZGl2OwogICAgZm9yIChjb25zdCBbaWQsIGNhbnZhc10gb2YgdGhpcy4jYW5ub3RhdGlvbkNhbnZhc01hcCkgewogICAgICBjb25zdCBlbGVtZW50ID0gbGF5ZXIucXVlcnlTZWxlY3RvcihgW2RhdGEtYW5ub3RhdGlvbi1pZD0iJHtpZH0iXWApOwogICAgICBpZiAoIWVsZW1lbnQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjYW52YXMuY2xhc3NOYW1lID0gImFubm90YXRpb25Db250ZW50IjsKICAgICAgY29uc3QgewogICAgICAgIGZpcnN0Q2hpbGQKICAgICAgfSA9IGVsZW1lbnQ7CiAgICAgIGlmICghZmlyc3RDaGlsZCkgewogICAgICAgIGVsZW1lbnQuYXBwZW5kKGNhbnZhcyk7CiAgICAgIH0gZWxzZSBpZiAoZmlyc3RDaGlsZC5ub2RlTmFtZSA9PT0gIkNBTlZBUyIpIHsKICAgICAgICBmaXJzdENoaWxkLnJlcGxhY2VXaXRoKGNhbnZhcyk7CiAgICAgIH0gZWxzZSBpZiAoIWZpcnN0Q2hpbGQuY2xhc3NMaXN0LmNvbnRhaW5zKCJhbm5vdGF0aW9uQ29udGVudCIpKSB7CiAgICAgICAgZmlyc3RDaGlsZC5iZWZvcmUoY2FudmFzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaXJzdENoaWxkLmFmdGVyKGNhbnZhcyk7CiAgICAgIH0KICAgICAgY29uc3QgZWRpdGFibGVBbm5vdGF0aW9uID0gdGhpcy4jZWRpdGFibGVBbm5vdGF0aW9ucy5nZXQoaWQpOwogICAgICBpZiAoIWVkaXRhYmxlQW5ub3RhdGlvbikgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChlZGl0YWJsZUFubm90YXRpb24uX2hhc05vQ2FudmFzKSB7CiAgICAgICAgdGhpcy5fYW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlcj8uc2V0TWlzc2luZ0NhbnZhcyhpZCwgZWxlbWVudC5pZCwgY2FudmFzKTsKICAgICAgICBlZGl0YWJsZUFubm90YXRpb24uX2hhc05vQ2FudmFzID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWRpdGFibGVBbm5vdGF0aW9uLmNhbnZhcyA9IGNhbnZhczsKICAgICAgfQogICAgfQogICAgdGhpcy4jYW5ub3RhdGlvbkNhbnZhc01hcC5jbGVhcigpOwogIH0KICBnZXRFZGl0YWJsZUFubm90YXRpb25zKCkgewogICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy4jZWRpdGFibGVBbm5vdGF0aW9ucy52YWx1ZXMoKSk7CiAgfQogIGdldEVkaXRhYmxlQW5ub3RhdGlvbihpZCkgewogICAgcmV0dXJuIHRoaXMuI2VkaXRhYmxlQW5ub3RhdGlvbnMuZ2V0KGlkKTsKICB9CiAgYWRkRmFrZUFubm90YXRpb24oZWRpdG9yKSB7CiAgICBjb25zdCB7CiAgICAgIGRpdgogICAgfSA9IHRoaXM7CiAgICBjb25zdCB7CiAgICAgIGlkLAogICAgICByb3RhdGlvbgogICAgfSA9IGVkaXRvcjsKICAgIGNvbnN0IGVsZW1lbnQgPSBuZXcgRWRpdG9yQW5ub3RhdGlvbkVsZW1lbnQoewogICAgICBkYXRhOiB7CiAgICAgICAgaWQsCiAgICAgICAgcmVjdDogZWRpdG9yLmdldFBERlJlY3QoKSwKICAgICAgICByb3RhdGlvbgogICAgICB9LAogICAgICBlZGl0b3IsCiAgICAgIGxheWVyOiBkaXYsCiAgICAgIHBhcmVudDogdGhpcywKICAgICAgZW5hYmxlQ29tbWVudDogISF0aGlzLl9jb21tZW50TWFuYWdlciwKICAgICAgbGlua1NlcnZpY2U6IHRoaXMuI2xpbmtTZXJ2aWNlLAogICAgICBhbm5vdGF0aW9uU3RvcmFnZTogdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UKICAgIH0pOwogICAgZWxlbWVudC5yZW5kZXIoKTsKICAgIGVsZW1lbnQuY29udGVudEVsZW1lbnQuaWQgPSBgJHtBbm5vdGF0aW9uUHJlZml4fSR7aWR9YDsKICAgIGVsZW1lbnQuY3JlYXRlT3JVcGRhdGVQb3B1cCgpOwogICAgdGhpcy4jZWxlbWVudHMucHVzaChlbGVtZW50KTsKICAgIHJldHVybiBlbGVtZW50OwogIH0KICByZW1vdmVBbm5vdGF0aW9uKGlkKSB7CiAgICBjb25zdCBpbmRleCA9IHRoaXMuI2VsZW1lbnRzLmZpbmRJbmRleCgoZWwpID0+IGVsLmRhdGEuaWQgPT09IGlkKTsKICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgW2VsZW1lbnRdID0gdGhpcy4jZWxlbWVudHMuc3BsaWNlKGluZGV4LCAxKTsKICAgIHRoaXMuI2FjY2Vzc2liaWxpdHlNYW5hZ2VyPy5yZW1vdmVQb2ludGVySW5UZXh0TGF5ZXIoZWxlbWVudC5jb250ZW50RWxlbWVudCk7CiAgfQogIHVwZGF0ZUZha2VBbm5vdGF0aW9ucyhlZGl0b3JzKSB7CiAgICBpZiAoZWRpdG9ycy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgZWRpdG9ycykgewogICAgICBlZGl0b3IudXBkYXRlRmFrZUFubm90YXRpb25FbGVtZW50KHRoaXMpOwogICAgfQogICAgdGhpcy4jYWRkRWxlbWVudHNUb0RPTSgpOwogIH0KICB0b2dnbGVQb2ludGVyRXZlbnRzKGVuYWJsZWQgPSBmYWxzZSkgewogICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgiZGlzYWJsZWQiLCAhZW5hYmxlZCk7CiAgfQogIHN0YXRpYyBnZXQgX2RlZmF1bHRCb3JkZXJTdHlsZSgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgIl9kZWZhdWx0Qm9yZGVyU3R5bGUiLCBPYmplY3QuZnJlZXplKHsKICAgICAgd2lkdGg6IDEsCiAgICAgIHJhd1dpZHRoOiAxLAogICAgICBzdHlsZTogQW5ub3RhdGlvbkJvcmRlclN0eWxlVHlwZS5TT0xJRCwKICAgICAgZGFzaEFycmF5OiBbM10sCiAgICAgIGhvcml6b250YWxDb3JuZXJSYWRpdXM6IDAsCiAgICAgIHZlcnRpY2FsQ29ybmVyUmFkaXVzOiAwCiAgICB9KSk7CiAgfQp9Owp2YXIgRU9MX1BBVFRFUk4gPSAvXHJcbj98XG4vZzsKdmFyIEZyZWVUZXh0RWRpdG9yID0gY2xhc3MgX0ZyZWVUZXh0RWRpdG9yIGV4dGVuZHMgQW5ub3RhdGlvbkVkaXRvciB7CiAgI2NvbnRlbnQgPSAiIjsKICAjZWRpdG9yRGl2SWQgPSBgJHt0aGlzLmlkfS1lZGl0b3JgOwogICNlZGl0TW9kZUFDID0gbnVsbDsKICAjZm9udFNpemU7CiAgX2NvbG9yUGlja2VyID0gbnVsbDsKICBzdGF0aWMgX2ZyZWVUZXh0RGVmYXVsdENvbnRlbnQgPSAiIjsKICBzdGF0aWMgX2ludGVybmFsUGFkZGluZyA9IDA7CiAgc3RhdGljIF9kZWZhdWx0Q29sb3IgPSBudWxsOwogIHN0YXRpYyBfZGVmYXVsdEZvbnRTaXplID0gMTA7CiAgc3RhdGljIGdldCBfa2V5Ym9hcmRNYW5hZ2VyKCkgewogICAgY29uc3QgcHJvdG8gPSBfRnJlZVRleHRFZGl0b3IucHJvdG90eXBlOwogICAgY29uc3QgYXJyb3dDaGVja2VyID0gKHNlbGYpID0+IHNlbGYuaXNFbXB0eSgpOwogICAgY29uc3Qgc21hbGwgPSBBbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyLlRSQU5TTEFURV9TTUFMTDsKICAgIGNvbnN0IGJpZyA9IEFubm90YXRpb25FZGl0b3JVSU1hbmFnZXIuVFJBTlNMQVRFX0JJRzsKICAgIHJldHVybiBzaGFkb3codGhpcywgIl9rZXlib2FyZE1hbmFnZXIiLCBuZXcgS2V5Ym9hcmRNYW5hZ2VyKFtbWyJjdHJsK3MiLCAibWFjK21ldGErcyIsICJjdHJsK3AiLCAibWFjK21ldGErcCJdLCBwcm90by5jb21taXRPclJlbW92ZSwgewogICAgICBidWJibGVzOiB0cnVlCiAgICB9XSwgW1siY3RybCtFbnRlciIsICJtYWMrbWV0YStFbnRlciIsICJFc2NhcGUiLCAibWFjK0VzY2FwZSJdLCBwcm90by5jb21taXRPclJlbW92ZV0sIFtbIkFycm93TGVmdCIsICJtYWMrQXJyb3dMZWZ0Il0sIHByb3RvLl90cmFuc2xhdGVFbXB0eSwgewogICAgICBhcmdzOiBbLXNtYWxsLCAwXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siY3RybCtBcnJvd0xlZnQiLCAibWFjK3NoaWZ0K0Fycm93TGVmdCJdLCBwcm90by5fdHJhbnNsYXRlRW1wdHksIHsKICAgICAgYXJnczogWy1iaWcsIDBdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJBcnJvd1JpZ2h0IiwgIm1hYytBcnJvd1JpZ2h0Il0sIHByb3RvLl90cmFuc2xhdGVFbXB0eSwgewogICAgICBhcmdzOiBbc21hbGwsIDBdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJjdHJsK0Fycm93UmlnaHQiLCAibWFjK3NoaWZ0K0Fycm93UmlnaHQiXSwgcHJvdG8uX3RyYW5zbGF0ZUVtcHR5LCB7CiAgICAgIGFyZ3M6IFtiaWcsIDBdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJBcnJvd1VwIiwgIm1hYytBcnJvd1VwIl0sIHByb3RvLl90cmFuc2xhdGVFbXB0eSwgewogICAgICBhcmdzOiBbMCwgLXNtYWxsXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siY3RybCtBcnJvd1VwIiwgIm1hYytzaGlmdCtBcnJvd1VwIl0sIHByb3RvLl90cmFuc2xhdGVFbXB0eSwgewogICAgICBhcmdzOiBbMCwgLWJpZ10sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbIkFycm93RG93biIsICJtYWMrQXJyb3dEb3duIl0sIHByb3RvLl90cmFuc2xhdGVFbXB0eSwgewogICAgICBhcmdzOiBbMCwgc21hbGxdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJjdHJsK0Fycm93RG93biIsICJtYWMrc2hpZnQrQXJyb3dEb3duIl0sIHByb3RvLl90cmFuc2xhdGVFbXB0eSwgewogICAgICBhcmdzOiBbMCwgYmlnXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XV0pKTsKICB9CiAgc3RhdGljIF90eXBlID0gImZyZWV0ZXh0IjsKICBzdGF0aWMgX2VkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5GUkVFVEVYVDsKICBjb25zdHJ1Y3RvcihwYXJhbXMpIHsKICAgIHN1cGVyKHsKICAgICAgLi4ucGFyYW1zLAogICAgICBuYW1lOiAiZnJlZVRleHRFZGl0b3IiCiAgICB9KTsKICAgIHRoaXMuY29sb3IgPSBwYXJhbXMuY29sb3IgfHwgX0ZyZWVUZXh0RWRpdG9yLl9kZWZhdWx0Q29sb3IgfHwgQW5ub3RhdGlvbkVkaXRvci5fZGVmYXVsdExpbmVDb2xvcjsKICAgIHRoaXMuI2ZvbnRTaXplID0gcGFyYW1zLmZvbnRTaXplIHx8IF9GcmVlVGV4dEVkaXRvci5fZGVmYXVsdEZvbnRTaXplOwogICAgaWYgKCF0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLmExMXlBbGVydCgicGRmanMtZWRpdG9yLWZyZWV0ZXh0LWFkZGVkLWFsZXJ0Iik7CiAgICB9CiAgICB0aGlzLmNhbkFkZENvbW1lbnQgPSBmYWxzZTsKICB9CiAgc3RhdGljIGluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKSB7CiAgICBBbm5vdGF0aW9uRWRpdG9yLmluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKTsKICAgIGNvbnN0IHN0eWxlID0gZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwogICAgdGhpcy5faW50ZXJuYWxQYWRkaW5nID0gcGFyc2VGbG9hdChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCItLWZyZWV0ZXh0LXBhZGRpbmciKSk7CiAgfQogIHN0YXRpYyB1cGRhdGVEZWZhdWx0UGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9TSVpFOgogICAgICAgIF9GcmVlVGV4dEVkaXRvci5fZGVmYXVsdEZvbnRTaXplID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRlJFRVRFWFRfQ09MT1I6CiAgICAgICAgX0ZyZWVUZXh0RWRpdG9yLl9kZWZhdWx0Q29sb3IgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgdXBkYXRlUGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9TSVpFOgogICAgICAgIHRoaXMuI3VwZGF0ZUZvbnRTaXplKHZhbHVlKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9DT0xPUjoKICAgICAgICB0aGlzLiN1cGRhdGVDb2xvcih2YWx1ZSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHN0YXRpYyBnZXQgZGVmYXVsdFByb3BlcnRpZXNUb1VwZGF0ZSgpIHsKICAgIHJldHVybiBbW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkZSRUVURVhUX1NJWkUsIF9GcmVlVGV4dEVkaXRvci5fZGVmYXVsdEZvbnRTaXplXSwgW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkZSRUVURVhUX0NPTE9SLCBfRnJlZVRleHRFZGl0b3IuX2RlZmF1bHRDb2xvciB8fCBBbm5vdGF0aW9uRWRpdG9yLl9kZWZhdWx0TGluZUNvbG9yXV07CiAgfQogIGdldCBwcm9wZXJ0aWVzVG9VcGRhdGUoKSB7CiAgICByZXR1cm4gW1tBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9TSVpFLCB0aGlzLiNmb250U2l6ZV0sIFtBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9DT0xPUiwgdGhpcy5jb2xvcl1dOwogIH0KICBnZXQgdG9vbGJhckJ1dHRvbnMoKSB7CiAgICB0aGlzLl9jb2xvclBpY2tlciB8fD0gbmV3IEJhc2ljQ29sb3JQaWNrZXIodGhpcyk7CiAgICByZXR1cm4gW1siY29sb3JQaWNrZXIiLCB0aGlzLl9jb2xvclBpY2tlcl1dOwogIH0KICBnZXQgY29sb3JUeXBlKCkgewogICAgcmV0dXJuIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkZSRUVURVhUX0NPTE9SOwogIH0KICAjdXBkYXRlRm9udFNpemUoZm9udFNpemUpIHsKICAgIGNvbnN0IHNldEZvbnRzaXplID0gKHNpemUpID0+IHsKICAgICAgdGhpcy5lZGl0b3JEaXYuc3R5bGUuZm9udFNpemUgPSBgY2FsYygke3NpemV9cHggKiB2YXIoLS10b3RhbC1zY2FsZS1mYWN0b3IpKWA7CiAgICAgIHRoaXMudHJhbnNsYXRlKDAsIC0oc2l6ZSAtIHRoaXMuI2ZvbnRTaXplKSAqIHRoaXMucGFyZW50U2NhbGUpOwogICAgICB0aGlzLiNmb250U2l6ZSA9IHNpemU7CiAgICAgIHRoaXMuI3NldEVkaXRvckRpbWVuc2lvbnMoKTsKICAgIH07CiAgICBjb25zdCBzYXZlZEZvbnRzaXplID0gdGhpcy4jZm9udFNpemU7CiAgICB0aGlzLmFkZENvbW1hbmRzKHsKICAgICAgY21kOiBzZXRGb250c2l6ZS5iaW5kKHRoaXMsIGZvbnRTaXplKSwKICAgICAgdW5kbzogc2V0Rm9udHNpemUuYmluZCh0aGlzLCBzYXZlZEZvbnRzaXplKSwKICAgICAgcG9zdDogdGhpcy5fdWlNYW5hZ2VyLnVwZGF0ZVVJLmJpbmQodGhpcy5fdWlNYW5hZ2VyLCB0aGlzKSwKICAgICAgbXVzdEV4ZWM6IHRydWUsCiAgICAgIHR5cGU6IEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkZSRUVURVhUX1NJWkUsCiAgICAgIG92ZXJ3cml0ZUlmU2FtZVR5cGU6IHRydWUsCiAgICAgIGtlZXBVbmRvOiB0cnVlCiAgICB9KTsKICB9CiAgb25VcGRhdGVkQ29sb3IoKSB7CiAgICB0aGlzLmVkaXRvckRpdi5zdHlsZS5jb2xvciA9IHRoaXMuY29sb3I7CiAgICB0aGlzLl9jb2xvclBpY2tlcj8udXBkYXRlKHRoaXMuY29sb3IpOwogICAgc3VwZXIub25VcGRhdGVkQ29sb3IoKTsKICB9CiAgI3VwZGF0ZUNvbG9yKGNvbG9yKSB7CiAgICBjb25zdCBzZXRDb2xvciA9IChjb2wpID0+IHsKICAgICAgdGhpcy5jb2xvciA9IGNvbDsKICAgICAgdGhpcy5vblVwZGF0ZWRDb2xvcigpOwogICAgfTsKICAgIGNvbnN0IHNhdmVkQ29sb3IgPSB0aGlzLmNvbG9yOwogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZDogc2V0Q29sb3IuYmluZCh0aGlzLCBjb2xvciksCiAgICAgIHVuZG86IHNldENvbG9yLmJpbmQodGhpcywgc2F2ZWRDb2xvciksCiAgICAgIHBvc3Q6IHRoaXMuX3VpTWFuYWdlci51cGRhdGVVSS5iaW5kKHRoaXMuX3VpTWFuYWdlciwgdGhpcyksCiAgICAgIG11c3RFeGVjOiB0cnVlLAogICAgICB0eXBlOiBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9DT0xPUiwKICAgICAgb3ZlcndyaXRlSWZTYW1lVHlwZTogdHJ1ZSwKICAgICAga2VlcFVuZG86IHRydWUKICAgIH0pOwogIH0KICBfdHJhbnNsYXRlRW1wdHkoeCwgeSkgewogICAgdGhpcy5fdWlNYW5hZ2VyLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycyh4LCB5LCB0cnVlKTsKICB9CiAgZ2V0SW5pdGlhbFRyYW5zbGF0aW9uKCkgewogICAgY29uc3Qgc2NhbGUgPSB0aGlzLnBhcmVudFNjYWxlOwogICAgcmV0dXJuIFstX0ZyZWVUZXh0RWRpdG9yLl9pbnRlcm5hbFBhZGRpbmcgKiBzY2FsZSwgLShfRnJlZVRleHRFZGl0b3IuX2ludGVybmFsUGFkZGluZyArIHRoaXMuI2ZvbnRTaXplKSAqIHNjYWxlXTsKICB9CiAgcmVidWlsZCgpIHsKICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3VwZXIucmVidWlsZCgpOwogICAgaWYgKHRoaXMuZGl2ID09PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy5pc0F0dGFjaGVkVG9ET00pIHsKICAgICAgdGhpcy5wYXJlbnQuYWRkKHRoaXMpOwogICAgfQogIH0KICBlbmFibGVFZGl0TW9kZSgpIHsKICAgIGlmICghc3VwZXIuZW5hYmxlRWRpdE1vZGUoKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLm92ZXJsYXlEaXYuY2xhc3NMaXN0LnJlbW92ZSgiZW5hYmxlZCIpOwogICAgdGhpcy5lZGl0b3JEaXYuY29udGVudEVkaXRhYmxlID0gdHJ1ZTsKICAgIHRoaXMuX2lzRHJhZ2dhYmxlID0gZmFsc2U7CiAgICB0aGlzLmRpdi5yZW1vdmVBdHRyaWJ1dGUoImFyaWEtYWN0aXZlZGVzY2VuZGFudCIpOwogICAgdGhpcy4jZWRpdE1vZGVBQyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuX3VpTWFuYWdlci5jb21iaW5lZFNpZ25hbCh0aGlzLiNlZGl0TW9kZUFDKTsKICAgIHRoaXMuZWRpdG9yRGl2LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmVkaXRvckRpdktleWRvd24uYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgdGhpcy5lZGl0b3JEaXYuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXMiLCB0aGlzLmVkaXRvckRpdkZvY3VzLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuZWRpdG9yRGl2LmFkZEV2ZW50TGlzdGVuZXIoImJsdXIiLCB0aGlzLmVkaXRvckRpdkJsdXIuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgdGhpcy5lZGl0b3JEaXYuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCB0aGlzLmVkaXRvckRpdklucHV0LmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuZWRpdG9yRGl2LmFkZEV2ZW50TGlzdGVuZXIoInBhc3RlIiwgdGhpcy5lZGl0b3JEaXZQYXN0ZS5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZGlzYWJsZUVkaXRNb2RlKCkgewogICAgaWYgKCFzdXBlci5kaXNhYmxlRWRpdE1vZGUoKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLm92ZXJsYXlEaXYuY2xhc3NMaXN0LmFkZCgiZW5hYmxlZCIpOwogICAgdGhpcy5lZGl0b3JEaXYuY29udGVudEVkaXRhYmxlID0gZmFsc2U7CiAgICB0aGlzLmRpdi5zZXRBdHRyaWJ1dGUoImFyaWEtYWN0aXZlZGVzY2VuZGFudCIsIHRoaXMuI2VkaXRvckRpdklkKTsKICAgIHRoaXMuX2lzRHJhZ2dhYmxlID0gdHJ1ZTsKICAgIHRoaXMuI2VkaXRNb2RlQUM/LmFib3J0KCk7CiAgICB0aGlzLiNlZGl0TW9kZUFDID0gbnVsbDsKICAgIHRoaXMuZGl2LmZvY3VzKHsKICAgICAgcHJldmVudFNjcm9sbDogdHJ1ZQogICAgfSk7CiAgICB0aGlzLmlzRWRpdGluZyA9IGZhbHNlOwogICAgdGhpcy5wYXJlbnQuZGl2LmNsYXNzTGlzdC5hZGQoImZyZWV0ZXh0RWRpdGluZyIpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGZvY3VzaW4oZXZlbnQpIHsKICAgIGlmICghdGhpcy5fZm9jdXNFdmVudHNBbGxvd2VkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN1cGVyLmZvY3VzaW4oZXZlbnQpOwogICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gdGhpcy5lZGl0b3JEaXYpIHsKICAgICAgdGhpcy5lZGl0b3JEaXYuZm9jdXMoKTsKICAgIH0KICB9CiAgb25jZUFkZGVkKGZvY3VzKSB7CiAgICBpZiAodGhpcy53aWR0aCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmVuYWJsZUVkaXRNb2RlKCk7CiAgICBpZiAoZm9jdXMpIHsKICAgICAgdGhpcy5lZGl0b3JEaXYuZm9jdXMoKTsKICAgIH0KICAgIGlmICh0aGlzLl9pbml0aWFsT3B0aW9ucz8uaXNDZW50ZXJlZCkgewogICAgICB0aGlzLmNlbnRlcigpOwogICAgfQogICAgdGhpcy5faW5pdGlhbE9wdGlvbnMgPSBudWxsOwogIH0KICBpc0VtcHR5KCkgewogICAgcmV0dXJuICF0aGlzLmVkaXRvckRpdiB8fCB0aGlzLmVkaXRvckRpdi5pbm5lclRleHQudHJpbSgpID09PSAiIjsKICB9CiAgcmVtb3ZlKCkgewogICAgdGhpcy5pc0VkaXRpbmcgPSBmYWxzZTsKICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICB0aGlzLnBhcmVudC5zZXRFZGl0aW5nU3RhdGUodHJ1ZSk7CiAgICAgIHRoaXMucGFyZW50LmRpdi5jbGFzc0xpc3QuYWRkKCJmcmVldGV4dEVkaXRpbmciKTsKICAgIH0KICAgIHN1cGVyLnJlbW92ZSgpOwogIH0KICAjZXh0cmFjdFRleHQoKSB7CiAgICBjb25zdCBidWZmZXIgPSBbXTsKICAgIHRoaXMuZWRpdG9yRGl2Lm5vcm1hbGl6ZSgpOwogICAgbGV0IHByZXZDaGlsZCA9IG51bGw7CiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuZWRpdG9yRGl2LmNoaWxkTm9kZXMpIHsKICAgICAgaWYgKHByZXZDaGlsZD8ubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFICYmIGNoaWxkLm5vZGVOYW1lID09PSAiQlIiKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgYnVmZmVyLnB1c2goX0ZyZWVUZXh0RWRpdG9yLiNnZXROb2RlQ29udGVudChjaGlsZCkpOwogICAgICBwcmV2Q2hpbGQgPSBjaGlsZDsKICAgIH0KICAgIHJldHVybiBidWZmZXIuam9pbigiXG4iKTsKICB9CiAgI3NldEVkaXRvckRpbWVuc2lvbnMoKSB7CiAgICBjb25zdCBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICBsZXQgcmVjdDsKICAgIGlmICh0aGlzLmlzQXR0YWNoZWRUb0RPTSkgewogICAgICByZWN0ID0gdGhpcy5kaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB7CiAgICAgICAgY3VycmVudExheWVyLAogICAgICAgIGRpdgogICAgICB9ID0gdGhpczsKICAgICAgY29uc3Qgc2F2ZWREaXNwbGF5ID0gZGl2LnN0eWxlLmRpc3BsYXk7CiAgICAgIGNvbnN0IHNhdmVkVmlzaWJpbGl0eSA9IGRpdi5jbGFzc0xpc3QuY29udGFpbnMoImhpZGRlbiIpOwogICAgICBkaXYuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CiAgICAgIGRpdi5zdHlsZS5kaXNwbGF5ID0gImhpZGRlbiI7CiAgICAgIGN1cnJlbnRMYXllci5kaXYuYXBwZW5kKHRoaXMuZGl2KTsKICAgICAgcmVjdCA9IGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgZGl2LnJlbW92ZSgpOwogICAgICBkaXYuc3R5bGUuZGlzcGxheSA9IHNhdmVkRGlzcGxheTsKICAgICAgZGl2LmNsYXNzTGlzdC50b2dnbGUoImhpZGRlbiIsIHNhdmVkVmlzaWJpbGl0eSk7CiAgICB9CiAgICBpZiAodGhpcy5yb3RhdGlvbiAlIDE4MCA9PT0gdGhpcy5wYXJlbnRSb3RhdGlvbiAlIDE4MCkgewogICAgICB0aGlzLndpZHRoID0gcmVjdC53aWR0aCAvIHBhcmVudFdpZHRoOwogICAgICB0aGlzLmhlaWdodCA9IHJlY3QuaGVpZ2h0IC8gcGFyZW50SGVpZ2h0OwogICAgfSBlbHNlIHsKICAgICAgdGhpcy53aWR0aCA9IHJlY3QuaGVpZ2h0IC8gcGFyZW50V2lkdGg7CiAgICAgIHRoaXMuaGVpZ2h0ID0gcmVjdC53aWR0aCAvIHBhcmVudEhlaWdodDsKICAgIH0KICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICB9CiAgY29tbWl0KCkgewogICAgaWYgKCF0aGlzLmlzSW5FZGl0TW9kZSgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN1cGVyLmNvbW1pdCgpOwogICAgdGhpcy5kaXNhYmxlRWRpdE1vZGUoKTsKICAgIGNvbnN0IHNhdmVkVGV4dCA9IHRoaXMuI2NvbnRlbnQ7CiAgICBjb25zdCBuZXdUZXh0ID0gdGhpcy4jY29udGVudCA9IHRoaXMuI2V4dHJhY3RUZXh0KCkudHJpbUVuZCgpOwogICAgaWYgKHNhdmVkVGV4dCA9PT0gbmV3VGV4dCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBzZXRUZXh0ID0gKHRleHQpID0+IHsKICAgICAgdGhpcy4jY29udGVudCA9IHRleHQ7CiAgICAgIGlmICghdGV4dCkgewogICAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuI3NldENvbnRlbnQoKTsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLnJlYnVpbGQodGhpcyk7CiAgICAgIHRoaXMuI3NldEVkaXRvckRpbWVuc2lvbnMoKTsKICAgIH07CiAgICB0aGlzLmFkZENvbW1hbmRzKHsKICAgICAgY21kOiAoKSA9PiB7CiAgICAgICAgc2V0VGV4dChuZXdUZXh0KTsKICAgICAgfSwKICAgICAgdW5kbzogKCkgPT4gewogICAgICAgIHNldFRleHQoc2F2ZWRUZXh0KTsKICAgICAgfSwKICAgICAgbXVzdEV4ZWM6IGZhbHNlCiAgICB9KTsKICAgIHRoaXMuI3NldEVkaXRvckRpbWVuc2lvbnMoKTsKICB9CiAgc2hvdWxkR2V0S2V5Ym9hcmRFdmVudHMoKSB7CiAgICByZXR1cm4gdGhpcy5pc0luRWRpdE1vZGUoKTsKICB9CiAgZW50ZXJJbkVkaXRNb2RlKCkgewogICAgdGhpcy5lbmFibGVFZGl0TW9kZSgpOwogICAgdGhpcy5lZGl0b3JEaXYuZm9jdXMoKTsKICB9CiAga2V5ZG93bihldmVudCkgewogICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gdGhpcy5kaXYgJiYgZXZlbnQua2V5ID09PSAiRW50ZXIiKSB7CiAgICAgIHRoaXMuZW50ZXJJbkVkaXRNb2RlKCk7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICB9CiAgfQogIGVkaXRvckRpdktleWRvd24oZXZlbnQpIHsKICAgIF9GcmVlVGV4dEVkaXRvci5fa2V5Ym9hcmRNYW5hZ2VyLmV4ZWModGhpcywgZXZlbnQpOwogIH0KICBlZGl0b3JEaXZGb2N1cyhldmVudCkgewogICAgdGhpcy5pc0VkaXRpbmcgPSB0cnVlOwogIH0KICBlZGl0b3JEaXZCbHVyKGV2ZW50KSB7CiAgICB0aGlzLmlzRWRpdGluZyA9IGZhbHNlOwogIH0KICBlZGl0b3JEaXZJbnB1dChldmVudCkgewogICAgdGhpcy5wYXJlbnQuZGl2LmNsYXNzTGlzdC50b2dnbGUoImZyZWV0ZXh0RWRpdGluZyIsIHRoaXMuaXNFbXB0eSgpKTsKICB9CiAgZGlzYWJsZUVkaXRpbmcoKSB7CiAgICB0aGlzLmVkaXRvckRpdi5zZXRBdHRyaWJ1dGUoInJvbGUiLCAiY29tbWVudCIpOwogICAgdGhpcy5lZGl0b3JEaXYucmVtb3ZlQXR0cmlidXRlKCJhcmlhLW11bHRpbGluZSIpOwogIH0KICBlbmFibGVFZGl0aW5nKCkgewogICAgdGhpcy5lZGl0b3JEaXYuc2V0QXR0cmlidXRlKCJyb2xlIiwgInRleHRib3giKTsKICAgIHRoaXMuZWRpdG9yRGl2LnNldEF0dHJpYnV0ZSgiYXJpYS1tdWx0aWxpbmUiLCB0cnVlKTsKICB9CiAgZ2V0IGNhbkNoYW5nZUNvbnRlbnQoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHJldHVybiB0aGlzLmRpdjsKICAgIH0KICAgIGxldCBiYXNlWCwgYmFzZVk7CiAgICBpZiAodGhpcy5faXNDb3B5IHx8IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICBiYXNlWCA9IHRoaXMueDsKICAgICAgYmFzZVkgPSB0aGlzLnk7CiAgICB9CiAgICBzdXBlci5yZW5kZXIoKTsKICAgIHRoaXMuZWRpdG9yRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0aGlzLmVkaXRvckRpdi5jbGFzc05hbWUgPSAiaW50ZXJuYWwiOwogICAgdGhpcy5lZGl0b3JEaXYuc2V0QXR0cmlidXRlKCJpZCIsIHRoaXMuI2VkaXRvckRpdklkKTsKICAgIHRoaXMuZWRpdG9yRGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLWZyZWUtdGV4dDIiKTsKICAgIHRoaXMuZWRpdG9yRGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWF0dHJzIiwgImRlZmF1bHQtY29udGVudCIpOwogICAgdGhpcy5lbmFibGVFZGl0aW5nKCk7CiAgICB0aGlzLmVkaXRvckRpdi5jb250ZW50RWRpdGFibGUgPSB0cnVlOwogICAgY29uc3QgewogICAgICBzdHlsZQogICAgfSA9IHRoaXMuZWRpdG9yRGl2OwogICAgc3R5bGUuZm9udFNpemUgPSBgY2FsYygke3RoaXMuI2ZvbnRTaXplfXB4ICogdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSlgOwogICAgc3R5bGUuY29sb3IgPSB0aGlzLmNvbG9yOwogICAgdGhpcy5kaXYuYXBwZW5kKHRoaXMuZWRpdG9yRGl2KTsKICAgIHRoaXMub3ZlcmxheURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy5vdmVybGF5RGl2LmNsYXNzTGlzdC5hZGQoIm92ZXJsYXkiLCAiZW5hYmxlZCIpOwogICAgdGhpcy5kaXYuYXBwZW5kKHRoaXMub3ZlcmxheURpdik7CiAgICBpZiAodGhpcy5faXNDb3B5IHx8IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICBjb25zdCBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICAgIGlmICh0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBwb3NpdGlvbgogICAgICAgIH0gPSB0aGlzLl9pbml0aWFsRGF0YTsKICAgICAgICBsZXQgW3R4LCB0eV0gPSB0aGlzLmdldEluaXRpYWxUcmFuc2xhdGlvbigpOwogICAgICAgIFt0eCwgdHldID0gdGhpcy5wYWdlVHJhbnNsYXRpb25Ub1NjcmVlbih0eCwgdHkpOwogICAgICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgICAgICBjb25zdCBbcGFnZVgsIHBhZ2VZXSA9IHRoaXMucGFnZVRyYW5zbGF0aW9uOwogICAgICAgIGxldCBwb3NYLCBwb3NZOwogICAgICAgIHN3aXRjaCAodGhpcy5yb3RhdGlvbikgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBwb3NYID0gYmFzZVggKyAocG9zaXRpb25bMF0gLSBwYWdlWCkgLyBwYWdlV2lkdGg7CiAgICAgICAgICAgIHBvc1kgPSBiYXNlWSArIHRoaXMuaGVpZ2h0IC0gKHBvc2l0aW9uWzFdIC0gcGFnZVkpIC8gcGFnZUhlaWdodDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDkwOgogICAgICAgICAgICBwb3NYID0gYmFzZVggKyAocG9zaXRpb25bMF0gLSBwYWdlWCkgLyBwYWdlV2lkdGg7CiAgICAgICAgICAgIHBvc1kgPSBiYXNlWSAtIChwb3NpdGlvblsxXSAtIHBhZ2VZKSAvIHBhZ2VIZWlnaHQ7CiAgICAgICAgICAgIFt0eCwgdHldID0gW3R5LCAtdHhdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMTgwOgogICAgICAgICAgICBwb3NYID0gYmFzZVggLSB0aGlzLndpZHRoICsgKHBvc2l0aW9uWzBdIC0gcGFnZVgpIC8gcGFnZVdpZHRoOwogICAgICAgICAgICBwb3NZID0gYmFzZVkgLSAocG9zaXRpb25bMV0gLSBwYWdlWSkgLyBwYWdlSGVpZ2h0OwogICAgICAgICAgICBbdHgsIHR5XSA9IFstdHgsIC10eV07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyNzA6CiAgICAgICAgICAgIHBvc1ggPSBiYXNlWCArIChwb3NpdGlvblswXSAtIHBhZ2VYIC0gdGhpcy5oZWlnaHQgKiBwYWdlSGVpZ2h0KSAvIHBhZ2VXaWR0aDsKICAgICAgICAgICAgcG9zWSA9IGJhc2VZICsgKHBvc2l0aW9uWzFdIC0gcGFnZVkgLSB0aGlzLndpZHRoICogcGFnZVdpZHRoKSAvIHBhZ2VIZWlnaHQ7CiAgICAgICAgICAgIFt0eCwgdHldID0gWy10eSwgdHhdOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXRBdChwb3NYICogcGFyZW50V2lkdGgsIHBvc1kgKiBwYXJlbnRIZWlnaHQsIHR4LCB0eSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fbW92ZUFmdGVyUGFzdGUoYmFzZVgsIGJhc2VZKTsKICAgICAgfQogICAgICB0aGlzLiNzZXRDb250ZW50KCk7CiAgICAgIHRoaXMuX2lzRHJhZ2dhYmxlID0gdHJ1ZTsKICAgICAgdGhpcy5lZGl0b3JEaXYuY29udGVudEVkaXRhYmxlID0gZmFsc2U7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9pc0RyYWdnYWJsZSA9IGZhbHNlOwogICAgICB0aGlzLmVkaXRvckRpdi5jb250ZW50RWRpdGFibGUgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIHRoaXMuZGl2OwogIH0KICBzdGF0aWMgI2dldE5vZGVDb250ZW50KG5vZGUpIHsKICAgIHJldHVybiAobm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUgPyBub2RlLm5vZGVWYWx1ZSA6IG5vZGUuaW5uZXJUZXh0KS5yZXBsYWNlQWxsKEVPTF9QQVRURVJOLCAiIik7CiAgfQogIGVkaXRvckRpdlBhc3RlKGV2ZW50KSB7CiAgICBjb25zdCBjbGlwYm9hcmREYXRhID0gZXZlbnQuY2xpcGJvYXJkRGF0YSB8fCB3aW5kb3cuY2xpcGJvYXJkRGF0YTsKICAgIGNvbnN0IHsKICAgICAgdHlwZXMKICAgIH0gPSBjbGlwYm9hcmREYXRhOwogICAgaWYgKHR5cGVzLmxlbmd0aCA9PT0gMSAmJiB0eXBlc1swXSA9PT0gInRleHQvcGxhaW4iKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICBjb25zdCBwYXN0ZSA9IF9GcmVlVGV4dEVkaXRvci4jZGVzZXJpYWxpemVDb250ZW50KGNsaXBib2FyZERhdGEuZ2V0RGF0YSgidGV4dCIpIHx8ICIiKS5yZXBsYWNlQWxsKEVPTF9QQVRURVJOLCAiXG4iKTsKICAgIGlmICghcGFzdGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpOwogICAgaWYgKCFzZWxlY3Rpb24ucmFuZ2VDb3VudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmVkaXRvckRpdi5ub3JtYWxpemUoKTsKICAgIHNlbGVjdGlvbi5kZWxldGVGcm9tRG9jdW1lbnQoKTsKICAgIGNvbnN0IHJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7CiAgICBpZiAoIXBhc3RlLmluY2x1ZGVzKCJcbiIpKSB7CiAgICAgIHJhbmdlLmluc2VydE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocGFzdGUpKTsKICAgICAgdGhpcy5lZGl0b3JEaXYubm9ybWFsaXplKCk7CiAgICAgIHNlbGVjdGlvbi5jb2xsYXBzZVRvU3RhcnQoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBzdGFydENvbnRhaW5lciwKICAgICAgc3RhcnRPZmZzZXQKICAgIH0gPSByYW5nZTsKICAgIGNvbnN0IGJ1ZmZlckJlZm9yZSA9IFtdOwogICAgY29uc3QgYnVmZmVyQWZ0ZXIgPSBbXTsKICAgIGlmIChzdGFydENvbnRhaW5lci5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUpIHsKICAgICAgY29uc3QgcGFyZW50ID0gc3RhcnRDb250YWluZXIucGFyZW50RWxlbWVudDsKICAgICAgYnVmZmVyQWZ0ZXIucHVzaChzdGFydENvbnRhaW5lci5ub2RlVmFsdWUuc2xpY2Uoc3RhcnRPZmZzZXQpLnJlcGxhY2VBbGwoRU9MX1BBVFRFUk4sICIiKSk7CiAgICAgIGlmIChwYXJlbnQgIT09IHRoaXMuZWRpdG9yRGl2KSB7CiAgICAgICAgbGV0IGJ1ZmZlciA9IGJ1ZmZlckJlZm9yZTsKICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuZWRpdG9yRGl2LmNoaWxkTm9kZXMpIHsKICAgICAgICAgIGlmIChjaGlsZCA9PT0gcGFyZW50KSB7CiAgICAgICAgICAgIGJ1ZmZlciA9IGJ1ZmZlckFmdGVyOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlci5wdXNoKF9GcmVlVGV4dEVkaXRvci4jZ2V0Tm9kZUNvbnRlbnQoY2hpbGQpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYnVmZmVyQmVmb3JlLnB1c2goc3RhcnRDb250YWluZXIubm9kZVZhbHVlLnNsaWNlKDAsIHN0YXJ0T2Zmc2V0KS5yZXBsYWNlQWxsKEVPTF9QQVRURVJOLCAiIikpOwogICAgfSBlbHNlIGlmIChzdGFydENvbnRhaW5lciA9PT0gdGhpcy5lZGl0b3JEaXYpIHsKICAgICAgbGV0IGJ1ZmZlciA9IGJ1ZmZlckJlZm9yZTsKICAgICAgbGV0IGkgPSAwOwogICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuZWRpdG9yRGl2LmNoaWxkTm9kZXMpIHsKICAgICAgICBpZiAoaSsrID09PSBzdGFydE9mZnNldCkgewogICAgICAgICAgYnVmZmVyID0gYnVmZmVyQWZ0ZXI7CiAgICAgICAgfQogICAgICAgIGJ1ZmZlci5wdXNoKF9GcmVlVGV4dEVkaXRvci4jZ2V0Tm9kZUNvbnRlbnQoY2hpbGQpKTsKICAgICAgfQogICAgfQogICAgdGhpcy4jY29udGVudCA9IGAke2J1ZmZlckJlZm9yZS5qb2luKCJcbiIpfSR7cGFzdGV9JHtidWZmZXJBZnRlci5qb2luKCJcbiIpfWA7CiAgICB0aGlzLiNzZXRDb250ZW50KCk7CiAgICBjb25zdCBuZXdSYW5nZSA9IG5ldyBSYW5nZSgpOwogICAgbGV0IGJlZm9yZUxlbmd0aCA9IE1hdGguc3VtUHJlY2lzZShidWZmZXJCZWZvcmUubWFwKChsaW5lKSA9PiBsaW5lLmxlbmd0aCkpOwogICAgZm9yIChjb25zdCB7CiAgICAgIGZpcnN0Q2hpbGQKICAgIH0gb2YgdGhpcy5lZGl0b3JEaXYuY2hpbGROb2RlcykgewogICAgICBpZiAoZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gTm9kZS5URVhUX05PREUpIHsKICAgICAgICBjb25zdCBsZW5ndGggPSBmaXJzdENoaWxkLm5vZGVWYWx1ZS5sZW5ndGg7CiAgICAgICAgaWYgKGJlZm9yZUxlbmd0aCA8PSBsZW5ndGgpIHsKICAgICAgICAgIG5ld1JhbmdlLnNldFN0YXJ0KGZpcnN0Q2hpbGQsIGJlZm9yZUxlbmd0aCk7CiAgICAgICAgICBuZXdSYW5nZS5zZXRFbmQoZmlyc3RDaGlsZCwgYmVmb3JlTGVuZ3RoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBiZWZvcmVMZW5ndGggLT0gbGVuZ3RoOwogICAgICB9CiAgICB9CiAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICBzZWxlY3Rpb24uYWRkUmFuZ2UobmV3UmFuZ2UpOwogIH0KICAjc2V0Q29udGVudCgpIHsKICAgIHRoaXMuZWRpdG9yRGl2LnJlcGxhY2VDaGlsZHJlbigpOwogICAgaWYgKCF0aGlzLiNjb250ZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAoY29uc3QgbGluZSBvZiB0aGlzLiNjb250ZW50LnNwbGl0KCJcbiIpKSB7CiAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBkaXYuYXBwZW5kKGxpbmUgPyBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShsaW5lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJyIikpOwogICAgICB0aGlzLmVkaXRvckRpdi5hcHBlbmQoZGl2KTsKICAgIH0KICB9CiAgI3NlcmlhbGl6ZUNvbnRlbnQoKSB7CiAgICByZXR1cm4gdGhpcy4jY29udGVudC5yZXBsYWNlQWxsKCJceEEwIiwgIiAiKTsKICB9CiAgc3RhdGljICNkZXNlcmlhbGl6ZUNvbnRlbnQoY29udGVudCkgewogICAgcmV0dXJuIGNvbnRlbnQucmVwbGFjZUFsbCgiICIsICJceEEwIik7CiAgfQogIGdldCBjb250ZW50RGl2KCkgewogICAgcmV0dXJuIHRoaXMuZWRpdG9yRGl2OwogIH0KICBnZXRQREZSZWN0KCkgewogICAgY29uc3QgcGFkZGluZyA9IF9GcmVlVGV4dEVkaXRvci5faW50ZXJuYWxQYWRkaW5nICogdGhpcy5wYXJlbnRTY2FsZTsKICAgIHJldHVybiB0aGlzLmdldFJlY3QocGFkZGluZywgcGFkZGluZyk7CiAgfQogIHN0YXRpYyBhc3luYyBkZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcikgewogICAgbGV0IGluaXRpYWxEYXRhMiA9IG51bGw7CiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEZyZWVUZXh0QW5ub3RhdGlvbkVsZW1lbnQpIHsKICAgICAgY29uc3QgewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGRlZmF1bHRBcHBlYXJhbmNlRGF0YTogewogICAgICAgICAgICBmb250U2l6ZSwKICAgICAgICAgICAgZm9udENvbG9yCiAgICAgICAgICB9LAogICAgICAgICAgcmVjdCwKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgaWQsCiAgICAgICAgICBwb3B1cFJlZiwKICAgICAgICAgIHJpY2hUZXh0LAogICAgICAgICAgY29udGVudHNPYmosCiAgICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgICBtb2RpZmljYXRpb25EYXRlCiAgICAgICAgfSwKICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICB0ZXh0UG9zaXRpb24sCiAgICAgICAgcGFyZW50OiB7CiAgICAgICAgICBwYWdlOiB7CiAgICAgICAgICAgIHBhZ2VOdW1iZXIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gPSBkYXRhOwogICAgICBpZiAoIXRleHRDb250ZW50IHx8IHRleHRDb250ZW50Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGluaXRpYWxEYXRhMiA9IGRhdGEgPSB7CiAgICAgICAgYW5ub3RhdGlvblR5cGU6IEFubm90YXRpb25FZGl0b3JUeXBlLkZSRUVURVhULAogICAgICAgIGNvbG9yOiBBcnJheS5mcm9tKGZvbnRDb2xvciksCiAgICAgICAgZm9udFNpemUsCiAgICAgICAgdmFsdWU6IHRleHRDb250ZW50LmpvaW4oIlxuIiksCiAgICAgICAgcG9zaXRpb246IHRleHRQb3NpdGlvbiwKICAgICAgICBwYWdlSW5kZXg6IHBhZ2VOdW1iZXIgLSAxLAogICAgICAgIHJlY3Q6IHJlY3Quc2xpY2UoMCksCiAgICAgICAgcm90YXRpb24sCiAgICAgICAgYW5ub3RhdGlvbkVsZW1lbnRJZDogaWQsCiAgICAgICAgaWQsCiAgICAgICAgZGVsZXRlZDogZmFsc2UsCiAgICAgICAgcG9wdXBSZWYsCiAgICAgICAgY29tbWVudDogY29udGVudHNPYmo/LnN0ciB8fCBudWxsLAogICAgICAgIHJpY2hUZXh0LAogICAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgICBtb2RpZmljYXRpb25EYXRlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBlZGl0b3IgPSBhd2FpdCBzdXBlci5kZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcik7CiAgICBlZGl0b3IuI2ZvbnRTaXplID0gZGF0YS5mb250U2l6ZTsKICAgIGVkaXRvci5jb2xvciA9IFV0aWwubWFrZUhleENvbG9yKC4uLmRhdGEuY29sb3IpOwogICAgZWRpdG9yLiNjb250ZW50ID0gX0ZyZWVUZXh0RWRpdG9yLiNkZXNlcmlhbGl6ZUNvbnRlbnQoZGF0YS52YWx1ZSk7CiAgICBlZGl0b3IuX2luaXRpYWxEYXRhID0gaW5pdGlhbERhdGEyOwogICAgaWYgKGRhdGEuY29tbWVudCkgewogICAgICBlZGl0b3Iuc2V0Q29tbWVudERhdGEoZGF0YSk7CiAgICB9CiAgICByZXR1cm4gZWRpdG9yOwogIH0KICBzZXJpYWxpemUoaXNGb3JDb3B5aW5nID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0aGlzLmRlbGV0ZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplRGVsZXRlZCgpOwogICAgfQogICAgY29uc3QgY29sb3IgPSBBbm5vdGF0aW9uRWRpdG9yLl9jb2xvck1hbmFnZXIuY29udmVydCh0aGlzLmlzQXR0YWNoZWRUb0RPTSA/IGdldENvbXB1dGVkU3R5bGUodGhpcy5lZGl0b3JEaXYpLmNvbG9yIDogdGhpcy5jb2xvcik7CiAgICBjb25zdCBzZXJpYWxpemVkID0gT2JqZWN0LmFzc2lnbihzdXBlci5zZXJpYWxpemUoaXNGb3JDb3B5aW5nKSwgewogICAgICBjb2xvciwKICAgICAgZm9udFNpemU6IHRoaXMuI2ZvbnRTaXplLAogICAgICB2YWx1ZTogdGhpcy4jc2VyaWFsaXplQ29udGVudCgpCiAgICB9KTsKICAgIHRoaXMuYWRkQ29tbWVudChzZXJpYWxpemVkKTsKICAgIGlmIChpc0ZvckNvcHlpbmcpIHsKICAgICAgc2VyaWFsaXplZC5pc0NvcHkgPSB0cnVlOwogICAgICByZXR1cm4gc2VyaWFsaXplZDsKICAgIH0KICAgIGlmICh0aGlzLmFubm90YXRpb25FbGVtZW50SWQgJiYgIXRoaXMuI2hhc0VsZW1lbnRDaGFuZ2VkKHNlcmlhbGl6ZWQpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgc2VyaWFsaXplZC5pZCA9IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZDsKICAgIHJldHVybiBzZXJpYWxpemVkOwogIH0KICAjaGFzRWxlbWVudENoYW5nZWQoc2VyaWFsaXplZCkgewogICAgY29uc3QgewogICAgICB2YWx1ZSwKICAgICAgZm9udFNpemUsCiAgICAgIGNvbG9yLAogICAgICBwYWdlSW5kZXgKICAgIH0gPSB0aGlzLl9pbml0aWFsRGF0YTsKICAgIHJldHVybiB0aGlzLmhhc0VkaXRlZENvbW1lbnQgfHwgdGhpcy5faGFzQmVlbk1vdmVkIHx8IHNlcmlhbGl6ZWQudmFsdWUgIT09IHZhbHVlIHx8IHNlcmlhbGl6ZWQuZm9udFNpemUgIT09IGZvbnRTaXplIHx8IHNlcmlhbGl6ZWQuY29sb3Iuc29tZSgoYywgaSkgPT4gYyAhPT0gY29sb3JbaV0pIHx8IHNlcmlhbGl6ZWQucGFnZUluZGV4ICE9PSBwYWdlSW5kZXg7CiAgfQogIHJlbmRlckFubm90YXRpb25FbGVtZW50KGFubm90YXRpb24pIHsKICAgIGNvbnN0IGNvbnRlbnQgPSBzdXBlci5yZW5kZXJBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKTsKICAgIGlmICghY29udGVudCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSBjb250ZW50OwogICAgc3R5bGUuZm9udFNpemUgPSBgY2FsYygke3RoaXMuI2ZvbnRTaXplfXB4ICogdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSlgOwogICAgc3R5bGUuY29sb3IgPSB0aGlzLmNvbG9yOwogICAgY29udGVudC5yZXBsYWNlQ2hpbGRyZW4oKTsKICAgIGZvciAoY29uc3QgbGluZSBvZiB0aGlzLiNjb250ZW50LnNwbGl0KCJcbiIpKSB7CiAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBkaXYuYXBwZW5kKGxpbmUgPyBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShsaW5lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJyIikpOwogICAgICBjb250ZW50LmFwcGVuZChkaXYpOwogICAgfQogICAgYW5ub3RhdGlvbi51cGRhdGVFZGl0ZWQoewogICAgICByZWN0OiB0aGlzLmdldFBERlJlY3QoKSwKICAgICAgcG9wdXA6IHRoaXMuX3VpTWFuYWdlci5oYXNDb21tZW50TWFuYWdlcigpIHx8IHRoaXMuaGFzRWRpdGVkQ29tbWVudCA/IHRoaXMuY29tbWVudCA6IHsKICAgICAgICB0ZXh0OiB0aGlzLiNjb250ZW50CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNvbnRlbnQ7CiAgfQogIHJlc2V0QW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbikgewogICAgc3VwZXIucmVzZXRBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKTsKICAgIGFubm90YXRpb24ucmVzZXRFZGl0ZWQoKTsKICB9Cn07CnZhciBPdXRsaW5lID0gY2xhc3MgewogIHN0YXRpYyBQUkVDSVNJT04gPSAxZS00OwogIHRvU1ZHUGF0aCgpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgYHRvU1ZHUGF0aGAgbXVzdCBiZSBpbXBsZW1lbnRlZC4iKTsKICB9CiAgZ2V0IGJveCgpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBnZXR0ZXIgYGJveGAgbXVzdCBiZSBpbXBsZW1lbnRlZC4iKTsKICB9CiAgc2VyaWFsaXplKF9iYm94LCBfcm90YXRpb24pIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgYHNlcmlhbGl6ZWAgbXVzdCBiZSBpbXBsZW1lbnRlZC4iKTsKICB9CiAgc3RhdGljIF9yZXNjYWxlKHNyYywgdHgsIHR5LCBzeCwgc3ksIGRlc3QpIHsKICAgIGRlc3QgfHw9IG5ldyBGbG9hdDMyQXJyYXkoc3JjLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBzcmMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gMikgewogICAgICBkZXN0W2ldID0gdHggKyBzcmNbaV0gKiBzeDsKICAgICAgZGVzdFtpICsgMV0gPSB0eSArIHNyY1tpICsgMV0gKiBzeTsKICAgIH0KICAgIHJldHVybiBkZXN0OwogIH0KICBzdGF0aWMgX3Jlc2NhbGVBbmRTd2FwKHNyYywgdHgsIHR5LCBzeCwgc3ksIGRlc3QpIHsKICAgIGRlc3QgfHw9IG5ldyBGbG9hdDMyQXJyYXkoc3JjLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBzcmMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gMikgewogICAgICBkZXN0W2ldID0gdHggKyBzcmNbaSArIDFdICogc3g7CiAgICAgIGRlc3RbaSArIDFdID0gdHkgKyBzcmNbaV0gKiBzeTsKICAgIH0KICAgIHJldHVybiBkZXN0OwogIH0KICBzdGF0aWMgX3RyYW5zbGF0ZShzcmMsIHR4LCB0eSwgZGVzdCkgewogICAgZGVzdCB8fD0gbmV3IEZsb2F0MzJBcnJheShzcmMubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHNyYy5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIGRlc3RbaV0gPSB0eCArIHNyY1tpXTsKICAgICAgZGVzdFtpICsgMV0gPSB0eSArIHNyY1tpICsgMV07CiAgICB9CiAgICByZXR1cm4gZGVzdDsKICB9CiAgc3RhdGljIHN2Z1JvdW5kKHgpIHsKICAgIHJldHVybiBNYXRoLnJvdW5kKHggKiAxZTQpOwogIH0KICBzdGF0aWMgX25vcm1hbGl6ZVBvaW50KHgsIHksIHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHQsIHJvdGF0aW9uKSB7CiAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgcmV0dXJuIFsxIC0geSAvIHBhcmVudFdpZHRoLCB4IC8gcGFyZW50SGVpZ2h0XTsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcmV0dXJuIFsxIC0geCAvIHBhcmVudFdpZHRoLCAxIC0geSAvIHBhcmVudEhlaWdodF07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiBbeSAvIHBhcmVudFdpZHRoLCAxIC0geCAvIHBhcmVudEhlaWdodF07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIFt4IC8gcGFyZW50V2lkdGgsIHkgLyBwYXJlbnRIZWlnaHRdOwogICAgfQogIH0KICBzdGF0aWMgX25vcm1hbGl6ZVBhZ2VQb2ludCh4LCB5LCByb3RhdGlvbikgewogICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbMSAtIHksIHhdOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXR1cm4gWzEgLSB4LCAxIC0geV07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiBbeSwgMSAtIHhdOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbeCwgeV07CiAgICB9CiAgfQogIHN0YXRpYyBjcmVhdGVCZXppZXJQb2ludHMoeDEsIHkxLCB4MiwgeTIsIHgzLCB5MykgewogICAgcmV0dXJuIFsoeDEgKyA1ICogeDIpIC8gNiwgKHkxICsgNSAqIHkyKSAvIDYsICg1ICogeDIgKyB4MykgLyA2LCAoNSAqIHkyICsgeTMpIC8gNiwgKHgyICsgeDMpIC8gMiwgKHkyICsgeTMpIC8gMl07CiAgfQp9Owp2YXIgRnJlZURyYXdPdXRsaW5lciA9IGNsYXNzIF9GcmVlRHJhd091dGxpbmVyIHsKICAjYm94OwogICNib3R0b20gPSBbXTsKICAjaW5uZXJNYXJnaW47CiAgI2lzTFRSOwogICN0b3AgPSBbXTsKICAjbGFzdCA9IG5ldyBGbG9hdDMyQXJyYXkoMTgpOwogICNsYXN0WDsKICAjbGFzdFk7CiAgI21pbjsKICAjbWluX2Rpc3Q7CiAgI3NjYWxlRmFjdG9yOwogICN0aGlja25lc3M7CiAgI3BvaW50cyA9IFtdOwogIHN0YXRpYyAjTUlOX0RJU1QgPSA4OwogIHN0YXRpYyAjTUlOX0RJRkYgPSAyOwogIHN0YXRpYyAjTUlOID0gX0ZyZWVEcmF3T3V0bGluZXIuI01JTl9ESVNUICsgX0ZyZWVEcmF3T3V0bGluZXIuI01JTl9ESUZGOwogIGNvbnN0cnVjdG9yKHsKICAgIHgsCiAgICB5CiAgfSwgYm94LCBzY2FsZUZhY3RvciwgdGhpY2tuZXNzLCBpc0xUUiwgaW5uZXJNYXJnaW4gPSAwKSB7CiAgICB0aGlzLiNib3ggPSBib3g7CiAgICB0aGlzLiN0aGlja25lc3MgPSB0aGlja25lc3MgKiBzY2FsZUZhY3RvcjsKICAgIHRoaXMuI2lzTFRSID0gaXNMVFI7CiAgICB0aGlzLiNsYXN0LnNldChbTmFOLCBOYU4sIE5hTiwgTmFOLCB4LCB5XSwgNik7CiAgICB0aGlzLiNpbm5lck1hcmdpbiA9IGlubmVyTWFyZ2luOwogICAgdGhpcy4jbWluX2Rpc3QgPSBfRnJlZURyYXdPdXRsaW5lci4jTUlOX0RJU1QgKiBzY2FsZUZhY3RvcjsKICAgIHRoaXMuI21pbiA9IF9GcmVlRHJhd091dGxpbmVyLiNNSU4gKiBzY2FsZUZhY3RvcjsKICAgIHRoaXMuI3NjYWxlRmFjdG9yID0gc2NhbGVGYWN0b3I7CiAgICB0aGlzLiNwb2ludHMucHVzaCh4LCB5KTsKICB9CiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiBpc05hTih0aGlzLiNsYXN0WzhdKTsKICB9CiAgI2dldExhc3RDb29yZHMoKSB7CiAgICBjb25zdCBsYXN0VG9wID0gdGhpcy4jbGFzdC5zdWJhcnJheSg0LCA2KTsKICAgIGNvbnN0IGxhc3RCb3R0b20gPSB0aGlzLiNsYXN0LnN1YmFycmF5KDE2LCAxOCk7CiAgICBjb25zdCBbeCwgeSwgd2lkdGgsIGhlaWdodF0gPSB0aGlzLiNib3g7CiAgICByZXR1cm4gWyh0aGlzLiNsYXN0WCArIChsYXN0VG9wWzBdIC0gbGFzdEJvdHRvbVswXSkgLyAyIC0geCkgLyB3aWR0aCwgKHRoaXMuI2xhc3RZICsgKGxhc3RUb3BbMV0gLSBsYXN0Qm90dG9tWzFdKSAvIDIgLSB5KSAvIGhlaWdodCwgKHRoaXMuI2xhc3RYICsgKGxhc3RCb3R0b21bMF0gLSBsYXN0VG9wWzBdKSAvIDIgLSB4KSAvIHdpZHRoLCAodGhpcy4jbGFzdFkgKyAobGFzdEJvdHRvbVsxXSAtIGxhc3RUb3BbMV0pIC8gMiAtIHkpIC8gaGVpZ2h0XTsKICB9CiAgYWRkKHsKICAgIHgsCiAgICB5CiAgfSkgewogICAgdGhpcy4jbGFzdFggPSB4OwogICAgdGhpcy4jbGFzdFkgPSB5OwogICAgY29uc3QgW2xheWVyWCwgbGF5ZXJZLCBsYXllcldpZHRoLCBsYXllckhlaWdodF0gPSB0aGlzLiNib3g7CiAgICBsZXQgW3gxLCB5MSwgeDIsIHkyXSA9IHRoaXMuI2xhc3Quc3ViYXJyYXkoOCwgMTIpOwogICAgY29uc3QgZGlmZlggPSB4IC0geDI7CiAgICBjb25zdCBkaWZmWSA9IHkgLSB5MjsKICAgIGNvbnN0IGQgPSBNYXRoLmh5cG90KGRpZmZYLCBkaWZmWSk7CiAgICBpZiAoZCA8IHRoaXMuI21pbikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBjb25zdCBkaWZmRCA9IGQgLSB0aGlzLiNtaW5fZGlzdDsKICAgIGNvbnN0IEsgPSBkaWZmRCAvIGQ7CiAgICBjb25zdCBzaGlmdFggPSBLICogZGlmZlg7CiAgICBjb25zdCBzaGlmdFkgPSBLICogZGlmZlk7CiAgICBsZXQgeDAgPSB4MTsKICAgIGxldCB5MCA9IHkxOwogICAgeDEgPSB4MjsKICAgIHkxID0geTI7CiAgICB4MiArPSBzaGlmdFg7CiAgICB5MiArPSBzaGlmdFk7CiAgICB0aGlzLiNwb2ludHM/LnB1c2goeCwgeSk7CiAgICBjb25zdCBuWCA9IC1zaGlmdFkgLyBkaWZmRDsKICAgIGNvbnN0IG5ZID0gc2hpZnRYIC8gZGlmZkQ7CiAgICBjb25zdCB0aFggPSBuWCAqIHRoaXMuI3RoaWNrbmVzczsKICAgIGNvbnN0IHRoWSA9IG5ZICogdGhpcy4jdGhpY2tuZXNzOwogICAgdGhpcy4jbGFzdC5zZXQodGhpcy4jbGFzdC5zdWJhcnJheSgyLCA4KSwgMCk7CiAgICB0aGlzLiNsYXN0LnNldChbeDIgKyB0aFgsIHkyICsgdGhZXSwgNCk7CiAgICB0aGlzLiNsYXN0LnNldCh0aGlzLiNsYXN0LnN1YmFycmF5KDE0LCAxOCksIDEyKTsKICAgIHRoaXMuI2xhc3Quc2V0KFt4MiAtIHRoWCwgeTIgLSB0aFldLCAxNik7CiAgICBpZiAoaXNOYU4odGhpcy4jbGFzdFs2XSkpIHsKICAgICAgaWYgKHRoaXMuI3RvcC5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLiNsYXN0LnNldChbeDEgKyB0aFgsIHkxICsgdGhZXSwgMik7CiAgICAgICAgdGhpcy4jdG9wLnB1c2goTmFOLCBOYU4sIE5hTiwgTmFOLCAoeDEgKyB0aFggLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKHkxICsgdGhZIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0KTsKICAgICAgICB0aGlzLiNsYXN0LnNldChbeDEgLSB0aFgsIHkxIC0gdGhZXSwgMTQpOwogICAgICAgIHRoaXMuI2JvdHRvbS5wdXNoKE5hTiwgTmFOLCBOYU4sIE5hTiwgKHgxIC0gdGhYIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsICh5MSAtIHRoWSAtIGxheWVyWSkgLyBsYXllckhlaWdodCk7CiAgICAgIH0KICAgICAgdGhpcy4jbGFzdC5zZXQoW3gwLCB5MCwgeDEsIHkxLCB4MiwgeTJdLCA2KTsKICAgICAgcmV0dXJuICF0aGlzLmlzRW1wdHkoKTsKICAgIH0KICAgIHRoaXMuI2xhc3Quc2V0KFt4MCwgeTAsIHgxLCB5MSwgeDIsIHkyXSwgNik7CiAgICBjb25zdCBhbmdsZSA9IE1hdGguYWJzKE1hdGguYXRhbjIoeTAgLSB5MSwgeDAgLSB4MSkgLSBNYXRoLmF0YW4yKHNoaWZ0WSwgc2hpZnRYKSk7CiAgICBpZiAoYW5nbGUgPCBNYXRoLlBJIC8gMikgewogICAgICBbeDEsIHkxLCB4MiwgeTJdID0gdGhpcy4jbGFzdC5zdWJhcnJheSgyLCA2KTsKICAgICAgdGhpcy4jdG9wLnB1c2goTmFOLCBOYU4sIE5hTiwgTmFOLCAoKHgxICsgeDIpIC8gMiAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAoKHkxICsgeTIpIC8gMiAtIGxheWVyWSkgLyBsYXllckhlaWdodCk7CiAgICAgIFt4MSwgeTEsIHgwLCB5MF0gPSB0aGlzLiNsYXN0LnN1YmFycmF5KDE0LCAxOCk7CiAgICAgIHRoaXMuI2JvdHRvbS5wdXNoKE5hTiwgTmFOLCBOYU4sIE5hTiwgKCh4MCArIHgxKSAvIDIgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCh5MCArIHkxKSAvIDIgLSBsYXllclkpIC8gbGF5ZXJIZWlnaHQpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIFt4MCwgeTAsIHgxLCB5MSwgeDIsIHkyXSA9IHRoaXMuI2xhc3Quc3ViYXJyYXkoMCwgNik7CiAgICB0aGlzLiN0b3AucHVzaCgoKHgwICsgNSAqIHgxKSAvIDYgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCh5MCArIDUgKiB5MSkgLyA2IC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0LCAoKDUgKiB4MSArIHgyKSAvIDYgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCg1ICogeTEgKyB5MikgLyA2IC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0LCAoKHgxICsgeDIpIC8gMiAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAoKHkxICsgeTIpIC8gMiAtIGxheWVyWSkgLyBsYXllckhlaWdodCk7CiAgICBbeDIsIHkyLCB4MSwgeTEsIHgwLCB5MF0gPSB0aGlzLiNsYXN0LnN1YmFycmF5KDEyLCAxOCk7CiAgICB0aGlzLiNib3R0b20ucHVzaCgoKHgwICsgNSAqIHgxKSAvIDYgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCh5MCArIDUgKiB5MSkgLyA2IC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0LCAoKDUgKiB4MSArIHgyKSAvIDYgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCg1ICogeTEgKyB5MikgLyA2IC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0LCAoKHgxICsgeDIpIC8gMiAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAoKHkxICsgeTIpIC8gMiAtIGxheWVyWSkgLyBsYXllckhlaWdodCk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdG9TVkdQYXRoKCkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIGNvbnN0IHRvcCA9IHRoaXMuI3RvcDsKICAgIGNvbnN0IGJvdHRvbSA9IHRoaXMuI2JvdHRvbTsKICAgIGlmIChpc05hTih0aGlzLiNsYXN0WzZdKSAmJiAhdGhpcy5pc0VtcHR5KCkpIHsKICAgICAgcmV0dXJuIHRoaXMuI3RvU1ZHUGF0aFR3b1BvaW50cygpOwogICAgfQogICAgY29uc3QgYnVmZmVyID0gW107CiAgICBidWZmZXIucHVzaChgTSR7dG9wWzRdfSAke3RvcFs1XX1gKTsKICAgIGZvciAobGV0IGkgPSA2OyBpIDwgdG9wLmxlbmd0aDsgaSArPSA2KSB7CiAgICAgIGlmIChpc05hTih0b3BbaV0pKSB7CiAgICAgICAgYnVmZmVyLnB1c2goYEwke3RvcFtpICsgNF19ICR7dG9wW2kgKyA1XX1gKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBidWZmZXIucHVzaChgQyR7dG9wW2ldfSAke3RvcFtpICsgMV19ICR7dG9wW2kgKyAyXX0gJHt0b3BbaSArIDNdfSAke3RvcFtpICsgNF19ICR7dG9wW2kgKyA1XX1gKTsKICAgICAgfQogICAgfQogICAgdGhpcy4jdG9TVkdQYXRoRW5kKGJ1ZmZlcik7CiAgICBmb3IgKGxldCBpID0gYm90dG9tLmxlbmd0aCAtIDY7IGkgPj0gNjsgaSAtPSA2KSB7CiAgICAgIGlmIChpc05hTihib3R0b21baV0pKSB7CiAgICAgICAgYnVmZmVyLnB1c2goYEwke2JvdHRvbVtpICsgNF19ICR7Ym90dG9tW2kgKyA1XX1gKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBidWZmZXIucHVzaChgQyR7Ym90dG9tW2ldfSAke2JvdHRvbVtpICsgMV19ICR7Ym90dG9tW2kgKyAyXX0gJHtib3R0b21baSArIDNdfSAke2JvdHRvbVtpICsgNF19ICR7Ym90dG9tW2kgKyA1XX1gKTsKICAgICAgfQogICAgfQogICAgdGhpcy4jdG9TVkdQYXRoU3RhcnQoYnVmZmVyKTsKICAgIHJldHVybiBidWZmZXIuam9pbigiICIpOwogIH0KICAjdG9TVkdQYXRoVHdvUG9pbnRzKCkgewogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gdGhpcy4jYm94OwogICAgY29uc3QgW2xhc3RUb3BYLCBsYXN0VG9wWSwgbGFzdEJvdHRvbVgsIGxhc3RCb3R0b21ZXSA9IHRoaXMuI2dldExhc3RDb29yZHMoKTsKICAgIHJldHVybiBgTSR7KHRoaXMuI2xhc3RbMl0gLSB4KSAvIHdpZHRofSAkeyh0aGlzLiNsYXN0WzNdIC0geSkgLyBoZWlnaHR9IEwkeyh0aGlzLiNsYXN0WzRdIC0geCkgLyB3aWR0aH0gJHsodGhpcy4jbGFzdFs1XSAtIHkpIC8gaGVpZ2h0fSBMJHtsYXN0VG9wWH0gJHtsYXN0VG9wWX0gTCR7bGFzdEJvdHRvbVh9ICR7bGFzdEJvdHRvbVl9IEwkeyh0aGlzLiNsYXN0WzE2XSAtIHgpIC8gd2lkdGh9ICR7KHRoaXMuI2xhc3RbMTddIC0geSkgLyBoZWlnaHR9IEwkeyh0aGlzLiNsYXN0WzE0XSAtIHgpIC8gd2lkdGh9ICR7KHRoaXMuI2xhc3RbMTVdIC0geSkgLyBoZWlnaHR9IFpgOwogIH0KICAjdG9TVkdQYXRoU3RhcnQoYnVmZmVyKSB7CiAgICBjb25zdCBib3R0b20gPSB0aGlzLiNib3R0b207CiAgICBidWZmZXIucHVzaChgTCR7Ym90dG9tWzRdfSAke2JvdHRvbVs1XX0gWmApOwogIH0KICAjdG9TVkdQYXRoRW5kKGJ1ZmZlcikgewogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gdGhpcy4jYm94OwogICAgY29uc3QgbGFzdFRvcCA9IHRoaXMuI2xhc3Quc3ViYXJyYXkoNCwgNik7CiAgICBjb25zdCBsYXN0Qm90dG9tID0gdGhpcy4jbGFzdC5zdWJhcnJheSgxNiwgMTgpOwogICAgY29uc3QgW2xhc3RUb3BYLCBsYXN0VG9wWSwgbGFzdEJvdHRvbVgsIGxhc3RCb3R0b21ZXSA9IHRoaXMuI2dldExhc3RDb29yZHMoKTsKICAgIGJ1ZmZlci5wdXNoKGBMJHsobGFzdFRvcFswXSAtIHgpIC8gd2lkdGh9ICR7KGxhc3RUb3BbMV0gLSB5KSAvIGhlaWdodH0gTCR7bGFzdFRvcFh9ICR7bGFzdFRvcFl9IEwke2xhc3RCb3R0b21YfSAke2xhc3RCb3R0b21ZfSBMJHsobGFzdEJvdHRvbVswXSAtIHgpIC8gd2lkdGh9ICR7KGxhc3RCb3R0b21bMV0gLSB5KSAvIGhlaWdodH1gKTsKICB9CiAgbmV3RnJlZURyYXdPdXRsaW5lKG91dGxpbmUsIHBvaW50cywgYm94LCBzY2FsZUZhY3RvciwgaW5uZXJNYXJnaW4sIGlzTFRSKSB7CiAgICByZXR1cm4gbmV3IEZyZWVEcmF3T3V0bGluZShvdXRsaW5lLCBwb2ludHMsIGJveCwgc2NhbGVGYWN0b3IsIGlubmVyTWFyZ2luLCBpc0xUUik7CiAgfQogIGdldE91dGxpbmVzKCkgewogICAgY29uc3QgdG9wID0gdGhpcy4jdG9wOwogICAgY29uc3QgYm90dG9tID0gdGhpcy4jYm90dG9tOwogICAgY29uc3QgbGFzdCA9IHRoaXMuI2xhc3Q7CiAgICBjb25zdCBbbGF5ZXJYLCBsYXllclksIGxheWVyV2lkdGgsIGxheWVySGVpZ2h0XSA9IHRoaXMuI2JveDsKICAgIGNvbnN0IHBvaW50cyA9IG5ldyBGbG9hdDMyQXJyYXkoKHRoaXMuI3BvaW50cz8ubGVuZ3RoID8/IDApICsgMik7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBwb2ludHMubGVuZ3RoIC0gMjsgaSA8IGlpOyBpICs9IDIpIHsKICAgICAgcG9pbnRzW2ldID0gKHRoaXMuI3BvaW50c1tpXSAtIGxheWVyWCkgLyBsYXllcldpZHRoOwogICAgICBwb2ludHNbaSArIDFdID0gKHRoaXMuI3BvaW50c1tpICsgMV0gLSBsYXllclkpIC8gbGF5ZXJIZWlnaHQ7CiAgICB9CiAgICBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDJdID0gKHRoaXMuI2xhc3RYIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGg7CiAgICBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdID0gKHRoaXMuI2xhc3RZIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0OwogICAgaWYgKGlzTmFOKGxhc3RbNl0pICYmICF0aGlzLmlzRW1wdHkoKSkgewogICAgICByZXR1cm4gdGhpcy4jZ2V0T3V0bGluZVR3b1BvaW50cyhwb2ludHMpOwogICAgfQogICAgY29uc3Qgb3V0bGluZSA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy4jdG9wLmxlbmd0aCArIDI0ICsgdGhpcy4jYm90dG9tLmxlbmd0aCk7CiAgICBsZXQgTiA9IHRvcC5sZW5ndGg7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE47IGkgKz0gMikgewogICAgICBpZiAoaXNOYU4odG9wW2ldKSkgewogICAgICAgIG91dGxpbmVbaV0gPSBvdXRsaW5lW2kgKyAxXSA9IE5hTjsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBvdXRsaW5lW2ldID0gdG9wW2ldOwogICAgICBvdXRsaW5lW2kgKyAxXSA9IHRvcFtpICsgMV07CiAgICB9CiAgICBOID0gdGhpcy4jZ2V0T3V0bGluZUVuZChvdXRsaW5lLCBOKTsKICAgIGZvciAobGV0IGkgPSBib3R0b20ubGVuZ3RoIC0gNjsgaSA+PSA2OyBpIC09IDYpIHsKICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCA2OyBqICs9IDIpIHsKICAgICAgICBpZiAoaXNOYU4oYm90dG9tW2kgKyBqXSkpIHsKICAgICAgICAgIG91dGxpbmVbTl0gPSBvdXRsaW5lW04gKyAxXSA9IE5hTjsKICAgICAgICAgIE4gKz0gMjsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBvdXRsaW5lW05dID0gYm90dG9tW2kgKyBqXTsKICAgICAgICBvdXRsaW5lW04gKyAxXSA9IGJvdHRvbVtpICsgaiArIDFdOwogICAgICAgIE4gKz0gMjsKICAgICAgfQogICAgfQogICAgdGhpcy4jZ2V0T3V0bGluZVN0YXJ0KG91dGxpbmUsIE4pOwogICAgcmV0dXJuIHRoaXMubmV3RnJlZURyYXdPdXRsaW5lKG91dGxpbmUsIHBvaW50cywgdGhpcy4jYm94LCB0aGlzLiNzY2FsZUZhY3RvciwgdGhpcy4jaW5uZXJNYXJnaW4sIHRoaXMuI2lzTFRSKTsKICB9CiAgI2dldE91dGxpbmVUd29Qb2ludHMocG9pbnRzKSB7CiAgICBjb25zdCBsYXN0ID0gdGhpcy4jbGFzdDsKICAgIGNvbnN0IFtsYXllclgsIGxheWVyWSwgbGF5ZXJXaWR0aCwgbGF5ZXJIZWlnaHRdID0gdGhpcy4jYm94OwogICAgY29uc3QgW2xhc3RUb3BYLCBsYXN0VG9wWSwgbGFzdEJvdHRvbVgsIGxhc3RCb3R0b21ZXSA9IHRoaXMuI2dldExhc3RDb29yZHMoKTsKICAgIGNvbnN0IG91dGxpbmUgPSBuZXcgRmxvYXQzMkFycmF5KDM2KTsKICAgIG91dGxpbmUuc2V0KFtOYU4sIE5hTiwgTmFOLCBOYU4sIChsYXN0WzJdIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsIChsYXN0WzNdIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0LCBOYU4sIE5hTiwgTmFOLCBOYU4sIChsYXN0WzRdIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsIChsYXN0WzVdIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0LCBOYU4sIE5hTiwgTmFOLCBOYU4sIGxhc3RUb3BYLCBsYXN0VG9wWSwgTmFOLCBOYU4sIE5hTiwgTmFOLCBsYXN0Qm90dG9tWCwgbGFzdEJvdHRvbVksIE5hTiwgTmFOLCBOYU4sIE5hTiwgKGxhc3RbMTZdIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsIChsYXN0WzE3XSAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgTmFOLCBOYU4sIE5hTiwgTmFOLCAobGFzdFsxNF0gLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKGxhc3RbMTVdIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0XSwgMCk7CiAgICByZXR1cm4gdGhpcy5uZXdGcmVlRHJhd091dGxpbmUob3V0bGluZSwgcG9pbnRzLCB0aGlzLiNib3gsIHRoaXMuI3NjYWxlRmFjdG9yLCB0aGlzLiNpbm5lck1hcmdpbiwgdGhpcy4jaXNMVFIpOwogIH0KICAjZ2V0T3V0bGluZVN0YXJ0KG91dGxpbmUsIHBvcykgewogICAgY29uc3QgYm90dG9tID0gdGhpcy4jYm90dG9tOwogICAgb3V0bGluZS5zZXQoW05hTiwgTmFOLCBOYU4sIE5hTiwgYm90dG9tWzRdLCBib3R0b21bNV1dLCBwb3MpOwogICAgcmV0dXJuIHBvcyArPSA2OwogIH0KICAjZ2V0T3V0bGluZUVuZChvdXRsaW5lLCBwb3MpIHsKICAgIGNvbnN0IGxhc3RUb3AgPSB0aGlzLiNsYXN0LnN1YmFycmF5KDQsIDYpOwogICAgY29uc3QgbGFzdEJvdHRvbSA9IHRoaXMuI2xhc3Quc3ViYXJyYXkoMTYsIDE4KTsKICAgIGNvbnN0IFtsYXllclgsIGxheWVyWSwgbGF5ZXJXaWR0aCwgbGF5ZXJIZWlnaHRdID0gdGhpcy4jYm94OwogICAgY29uc3QgW2xhc3RUb3BYLCBsYXN0VG9wWSwgbGFzdEJvdHRvbVgsIGxhc3RCb3R0b21ZXSA9IHRoaXMuI2dldExhc3RDb29yZHMoKTsKICAgIG91dGxpbmUuc2V0KFtOYU4sIE5hTiwgTmFOLCBOYU4sIChsYXN0VG9wWzBdIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsIChsYXN0VG9wWzFdIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0LCBOYU4sIE5hTiwgTmFOLCBOYU4sIGxhc3RUb3BYLCBsYXN0VG9wWSwgTmFOLCBOYU4sIE5hTiwgTmFOLCBsYXN0Qm90dG9tWCwgbGFzdEJvdHRvbVksIE5hTiwgTmFOLCBOYU4sIE5hTiwgKGxhc3RCb3R0b21bMF0gLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKGxhc3RCb3R0b21bMV0gLSBsYXllclkpIC8gbGF5ZXJIZWlnaHRdLCBwb3MpOwogICAgcmV0dXJuIHBvcyArPSAyNDsKICB9Cn07CnZhciBGcmVlRHJhd091dGxpbmUgPSBjbGFzcyBleHRlbmRzIE91dGxpbmUgewogICNib3g7CiAgI2Jib3ggPSBuZXcgRmxvYXQzMkFycmF5KDQpOwogICNpbm5lck1hcmdpbjsKICAjaXNMVFI7CiAgI3BvaW50czsKICAjc2NhbGVGYWN0b3I7CiAgI291dGxpbmU7CiAgY29uc3RydWN0b3Iob3V0bGluZSwgcG9pbnRzLCBib3gsIHNjYWxlRmFjdG9yLCBpbm5lck1hcmdpbiwgaXNMVFIpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLiNvdXRsaW5lID0gb3V0bGluZTsKICAgIHRoaXMuI3BvaW50cyA9IHBvaW50czsKICAgIHRoaXMuI2JveCA9IGJveDsKICAgIHRoaXMuI3NjYWxlRmFjdG9yID0gc2NhbGVGYWN0b3I7CiAgICB0aGlzLiNpbm5lck1hcmdpbiA9IGlubmVyTWFyZ2luOwogICAgdGhpcy4jaXNMVFIgPSBpc0xUUjsKICAgIHRoaXMuZmlyc3RQb2ludCA9IFtOYU4sIE5hTl07CiAgICB0aGlzLmxhc3RQb2ludCA9IFtOYU4sIE5hTl07CiAgICB0aGlzLiNjb21wdXRlTWluTWF4KGlzTFRSKTsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuI2Jib3g7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBvdXRsaW5lLmxlbmd0aDsgaSA8IGlpOyBpICs9IDIpIHsKICAgICAgb3V0bGluZVtpXSA9IChvdXRsaW5lW2ldIC0geCkgLyB3aWR0aDsKICAgICAgb3V0bGluZVtpICsgMV0gPSAob3V0bGluZVtpICsgMV0gLSB5KSAvIGhlaWdodDsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHBvaW50cy5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIHBvaW50c1tpXSA9IChwb2ludHNbaV0gLSB4KSAvIHdpZHRoOwogICAgICBwb2ludHNbaSArIDFdID0gKHBvaW50c1tpICsgMV0gLSB5KSAvIGhlaWdodDsKICAgIH0KICB9CiAgdG9TVkdQYXRoKCkgewogICAgY29uc3QgYnVmZmVyID0gW2BNJHt0aGlzLiNvdXRsaW5lWzRdfSAke3RoaXMuI291dGxpbmVbNV19YF07CiAgICBmb3IgKGxldCBpID0gNiwgaWkgPSB0aGlzLiNvdXRsaW5lLmxlbmd0aDsgaSA8IGlpOyBpICs9IDYpIHsKICAgICAgaWYgKGlzTmFOKHRoaXMuI291dGxpbmVbaV0pKSB7CiAgICAgICAgYnVmZmVyLnB1c2goYEwke3RoaXMuI291dGxpbmVbaSArIDRdfSAke3RoaXMuI291dGxpbmVbaSArIDVdfWApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGJ1ZmZlci5wdXNoKGBDJHt0aGlzLiNvdXRsaW5lW2ldfSAke3RoaXMuI291dGxpbmVbaSArIDFdfSAke3RoaXMuI291dGxpbmVbaSArIDJdfSAke3RoaXMuI291dGxpbmVbaSArIDNdfSAke3RoaXMuI291dGxpbmVbaSArIDRdfSAke3RoaXMuI291dGxpbmVbaSArIDVdfWApOwogICAgfQogICAgYnVmZmVyLnB1c2goIloiKTsKICAgIHJldHVybiBidWZmZXIuam9pbigiICIpOwogIH0KICBzZXJpYWxpemUoW2JsWCwgYmxZLCB0clgsIHRyWV0sIHJvdGF0aW9uKSB7CiAgICBjb25zdCB3aWR0aCA9IHRyWCAtIGJsWDsKICAgIGNvbnN0IGhlaWdodCA9IHRyWSAtIGJsWTsKICAgIGxldCBvdXRsaW5lOwogICAgbGV0IHBvaW50czsKICAgIHN3aXRjaCAocm90YXRpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIG91dGxpbmUgPSBPdXRsaW5lLl9yZXNjYWxlKHRoaXMuI291dGxpbmUsIGJsWCwgdHJZLCB3aWR0aCwgLWhlaWdodCk7CiAgICAgICAgcG9pbnRzID0gT3V0bGluZS5fcmVzY2FsZSh0aGlzLiNwb2ludHMsIGJsWCwgdHJZLCB3aWR0aCwgLWhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgb3V0bGluZSA9IE91dGxpbmUuX3Jlc2NhbGVBbmRTd2FwKHRoaXMuI291dGxpbmUsIGJsWCwgYmxZLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBwb2ludHMgPSBPdXRsaW5lLl9yZXNjYWxlQW5kU3dhcCh0aGlzLiNwb2ludHMsIGJsWCwgYmxZLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxODA6CiAgICAgICAgb3V0bGluZSA9IE91dGxpbmUuX3Jlc2NhbGUodGhpcy4jb3V0bGluZSwgdHJYLCBibFksIC13aWR0aCwgaGVpZ2h0KTsKICAgICAgICBwb2ludHMgPSBPdXRsaW5lLl9yZXNjYWxlKHRoaXMuI3BvaW50cywgdHJYLCBibFksIC13aWR0aCwgaGVpZ2h0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgb3V0bGluZSA9IE91dGxpbmUuX3Jlc2NhbGVBbmRTd2FwKHRoaXMuI291dGxpbmUsIHRyWCwgdHJZLCAtd2lkdGgsIC1oZWlnaHQpOwogICAgICAgIHBvaW50cyA9IE91dGxpbmUuX3Jlc2NhbGVBbmRTd2FwKHRoaXMuI3BvaW50cywgdHJYLCB0clksIC13aWR0aCwgLWhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gewogICAgICBvdXRsaW5lOiBBcnJheS5mcm9tKG91dGxpbmUpLAogICAgICBwb2ludHM6IFtBcnJheS5mcm9tKHBvaW50cyldCiAgICB9OwogIH0KICAjY29tcHV0ZU1pbk1heChpc0xUUikgewogICAgY29uc3Qgb3V0bGluZSA9IHRoaXMuI291dGxpbmU7CiAgICBsZXQgbGFzdFggPSBvdXRsaW5lWzRdOwogICAgbGV0IGxhc3RZID0gb3V0bGluZVs1XTsKICAgIGNvbnN0IG1pbk1heCA9IFtsYXN0WCwgbGFzdFksIGxhc3RYLCBsYXN0WV07CiAgICBsZXQgZmlyc3RQb2ludFggPSBsYXN0WDsKICAgIGxldCBmaXJzdFBvaW50WSA9IGxhc3RZOwogICAgbGV0IGxhc3RQb2ludFggPSBsYXN0WDsKICAgIGxldCBsYXN0UG9pbnRZID0gbGFzdFk7CiAgICBjb25zdCBsdHJDYWxsYmFjayA9IGlzTFRSID8gTWF0aC5tYXggOiBNYXRoLm1pbjsKICAgIGNvbnN0IGJlemllckJib3ggPSBuZXcgRmxvYXQzMkFycmF5KDQpOwogICAgZm9yIChsZXQgaSA9IDYsIGlpID0gb3V0bGluZS5sZW5ndGg7IGkgPCBpaTsgaSArPSA2KSB7CiAgICAgIGNvbnN0IHggPSBvdXRsaW5lW2kgKyA0XSwgeSA9IG91dGxpbmVbaSArIDVdOwogICAgICBpZiAoaXNOYU4ob3V0bGluZVtpXSkpIHsKICAgICAgICBVdGlsLnBvaW50Qm91bmRpbmdCb3goeCwgeSwgbWluTWF4KTsKICAgICAgICBpZiAoZmlyc3RQb2ludFkgPiB5KSB7CiAgICAgICAgICBmaXJzdFBvaW50WCA9IHg7CiAgICAgICAgICBmaXJzdFBvaW50WSA9IHk7CiAgICAgICAgfSBlbHNlIGlmIChmaXJzdFBvaW50WSA9PT0geSkgewogICAgICAgICAgZmlyc3RQb2ludFggPSBsdHJDYWxsYmFjayhmaXJzdFBvaW50WCwgeCk7CiAgICAgICAgfQogICAgICAgIGlmIChsYXN0UG9pbnRZIDwgeSkgewogICAgICAgICAgbGFzdFBvaW50WCA9IHg7CiAgICAgICAgICBsYXN0UG9pbnRZID0geTsKICAgICAgICB9IGVsc2UgaWYgKGxhc3RQb2ludFkgPT09IHkpIHsKICAgICAgICAgIGxhc3RQb2ludFggPSBsdHJDYWxsYmFjayhsYXN0UG9pbnRYLCB4KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYmV6aWVyQmJveFswXSA9IGJlemllckJib3hbMV0gPSBJbmZpbml0eTsKICAgICAgICBiZXppZXJCYm94WzJdID0gYmV6aWVyQmJveFszXSA9IC1JbmZpbml0eTsKICAgICAgICBVdGlsLmJlemllckJvdW5kaW5nQm94KGxhc3RYLCBsYXN0WSwgLi4ub3V0bGluZS5zbGljZShpLCBpICsgNiksIGJlemllckJib3gpOwogICAgICAgIFV0aWwucmVjdEJvdW5kaW5nQm94KGJlemllckJib3hbMF0sIGJlemllckJib3hbMV0sIGJlemllckJib3hbMl0sIGJlemllckJib3hbM10sIG1pbk1heCk7CiAgICAgICAgaWYgKGZpcnN0UG9pbnRZID4gYmV6aWVyQmJveFsxXSkgewogICAgICAgICAgZmlyc3RQb2ludFggPSBiZXppZXJCYm94WzBdOwogICAgICAgICAgZmlyc3RQb2ludFkgPSBiZXppZXJCYm94WzFdOwogICAgICAgIH0gZWxzZSBpZiAoZmlyc3RQb2ludFkgPT09IGJlemllckJib3hbMV0pIHsKICAgICAgICAgIGZpcnN0UG9pbnRYID0gbHRyQ2FsbGJhY2soZmlyc3RQb2ludFgsIGJlemllckJib3hbMF0pOwogICAgICAgIH0KICAgICAgICBpZiAobGFzdFBvaW50WSA8IGJlemllckJib3hbM10pIHsKICAgICAgICAgIGxhc3RQb2ludFggPSBiZXppZXJCYm94WzJdOwogICAgICAgICAgbGFzdFBvaW50WSA9IGJlemllckJib3hbM107CiAgICAgICAgfSBlbHNlIGlmIChsYXN0UG9pbnRZID09PSBiZXppZXJCYm94WzNdKSB7CiAgICAgICAgICBsYXN0UG9pbnRYID0gbHRyQ2FsbGJhY2sobGFzdFBvaW50WCwgYmV6aWVyQmJveFsyXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGxhc3RYID0geDsKICAgICAgbGFzdFkgPSB5OwogICAgfQogICAgY29uc3QgYmJveCA9IHRoaXMuI2Jib3g7CiAgICBiYm94WzBdID0gbWluTWF4WzBdIC0gdGhpcy4jaW5uZXJNYXJnaW47CiAgICBiYm94WzFdID0gbWluTWF4WzFdIC0gdGhpcy4jaW5uZXJNYXJnaW47CiAgICBiYm94WzJdID0gbWluTWF4WzJdIC0gbWluTWF4WzBdICsgMiAqIHRoaXMuI2lubmVyTWFyZ2luOwogICAgYmJveFszXSA9IG1pbk1heFszXSAtIG1pbk1heFsxXSArIDIgKiB0aGlzLiNpbm5lck1hcmdpbjsKICAgIHRoaXMuZmlyc3RQb2ludCA9IFtmaXJzdFBvaW50WCwgZmlyc3RQb2ludFldOwogICAgdGhpcy5sYXN0UG9pbnQgPSBbbGFzdFBvaW50WCwgbGFzdFBvaW50WV07CiAgfQogIGdldCBib3goKSB7CiAgICByZXR1cm4gdGhpcy4jYmJveDsKICB9CiAgbmV3T3V0bGluZXIocG9pbnQsIGJveCwgc2NhbGVGYWN0b3IsIHRoaWNrbmVzcywgaXNMVFIsIGlubmVyTWFyZ2luID0gMCkgewogICAgcmV0dXJuIG5ldyBGcmVlRHJhd091dGxpbmVyKHBvaW50LCBib3gsIHNjYWxlRmFjdG9yLCB0aGlja25lc3MsIGlzTFRSLCBpbm5lck1hcmdpbik7CiAgfQogIGdldE5ld091dGxpbmUodGhpY2tuZXNzLCBpbm5lck1hcmdpbikgewogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gdGhpcy4jYmJveDsKICAgIGNvbnN0IFtsYXllclgsIGxheWVyWSwgbGF5ZXJXaWR0aCwgbGF5ZXJIZWlnaHRdID0gdGhpcy4jYm94OwogICAgY29uc3Qgc3ggPSB3aWR0aCAqIGxheWVyV2lkdGg7CiAgICBjb25zdCBzeSA9IGhlaWdodCAqIGxheWVySGVpZ2h0OwogICAgY29uc3QgdHggPSB4ICogbGF5ZXJXaWR0aCArIGxheWVyWDsKICAgIGNvbnN0IHR5ID0geSAqIGxheWVySGVpZ2h0ICsgbGF5ZXJZOwogICAgY29uc3Qgb3V0bGluZXIgPSB0aGlzLm5ld091dGxpbmVyKHsKICAgICAgeDogdGhpcy4jcG9pbnRzWzBdICogc3ggKyB0eCwKICAgICAgeTogdGhpcy4jcG9pbnRzWzFdICogc3kgKyB0eQogICAgfSwgdGhpcy4jYm94LCB0aGlzLiNzY2FsZUZhY3RvciwgdGhpY2tuZXNzLCB0aGlzLiNpc0xUUiwgaW5uZXJNYXJnaW4gPz8gdGhpcy4jaW5uZXJNYXJnaW4pOwogICAgZm9yIChsZXQgaSA9IDI7IGkgPCB0aGlzLiNwb2ludHMubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgb3V0bGluZXIuYWRkKHsKICAgICAgICB4OiB0aGlzLiNwb2ludHNbaV0gKiBzeCArIHR4LAogICAgICAgIHk6IHRoaXMuI3BvaW50c1tpICsgMV0gKiBzeSArIHR5CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG91dGxpbmVyLmdldE91dGxpbmVzKCk7CiAgfQp9Owp2YXIgSGlnaGxpZ2h0T3V0bGluZXIgPSBjbGFzcyB7CiAgI2JveDsKICAjZmlyc3RQb2ludDsKICAjbGFzdFBvaW50OwogICN2ZXJ0aWNhbEVkZ2VzID0gW107CiAgI2ludGVydmFscyA9IFtdOwogIGNvbnN0cnVjdG9yKGJveGVzLCBib3JkZXJXaWR0aCA9IDAsIGlubmVyTWFyZ2luID0gMCwgaXNMVFIgPSB0cnVlKSB7CiAgICBjb25zdCBtaW5NYXggPSBbSW5maW5pdHksIEluZmluaXR5LCAtSW5maW5pdHksIC1JbmZpbml0eV07CiAgICBjb25zdCBOVU1CRVJfT0ZfRElHSVRTID0gNDsKICAgIGNvbnN0IEVQU0lMT04gPSAxMCAqKiAtTlVNQkVSX09GX0RJR0lUUzsKICAgIGZvciAoY29uc3QgewogICAgICB4LAogICAgICB5LAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9IG9mIGJveGVzKSB7CiAgICAgIGNvbnN0IHgxID0gTWF0aC5mbG9vcigoeCAtIGJvcmRlcldpZHRoKSAvIEVQU0lMT04pICogRVBTSUxPTjsKICAgICAgY29uc3QgeDIgPSBNYXRoLmNlaWwoKHggKyB3aWR0aCArIGJvcmRlcldpZHRoKSAvIEVQU0lMT04pICogRVBTSUxPTjsKICAgICAgY29uc3QgeTEgPSBNYXRoLmZsb29yKCh5IC0gYm9yZGVyV2lkdGgpIC8gRVBTSUxPTikgKiBFUFNJTE9OOwogICAgICBjb25zdCB5MiA9IE1hdGguY2VpbCgoeSArIGhlaWdodCArIGJvcmRlcldpZHRoKSAvIEVQU0lMT04pICogRVBTSUxPTjsKICAgICAgY29uc3QgbGVmdCA9IFt4MSwgeTEsIHkyLCB0cnVlXTsKICAgICAgY29uc3QgcmlnaHQgPSBbeDIsIHkxLCB5MiwgZmFsc2VdOwogICAgICB0aGlzLiN2ZXJ0aWNhbEVkZ2VzLnB1c2gobGVmdCwgcmlnaHQpOwogICAgICBVdGlsLnJlY3RCb3VuZGluZ0JveCh4MSwgeTEsIHgyLCB5MiwgbWluTWF4KTsKICAgIH0KICAgIGNvbnN0IGJib3hXaWR0aCA9IG1pbk1heFsyXSAtIG1pbk1heFswXSArIDIgKiBpbm5lck1hcmdpbjsKICAgIGNvbnN0IGJib3hIZWlnaHQgPSBtaW5NYXhbM10gLSBtaW5NYXhbMV0gKyAyICogaW5uZXJNYXJnaW47CiAgICBjb25zdCBzaGlmdGVkTWluWCA9IG1pbk1heFswXSAtIGlubmVyTWFyZ2luOwogICAgY29uc3Qgc2hpZnRlZE1pblkgPSBtaW5NYXhbMV0gLSBpbm5lck1hcmdpbjsKICAgIGxldCBmaXJzdFBvaW50WCA9IGlzTFRSID8gLUluZmluaXR5IDogSW5maW5pdHk7CiAgICBsZXQgZmlyc3RQb2ludFkgPSBJbmZpbml0eTsKICAgIGNvbnN0IGxhc3RFZGdlID0gdGhpcy4jdmVydGljYWxFZGdlcy5hdChpc0xUUiA/IC0xIDogLTIpOwogICAgY29uc3QgbGFzdFBvaW50ID0gW2xhc3RFZGdlWzBdLCBsYXN0RWRnZVsyXV07CiAgICBmb3IgKGNvbnN0IGVkZ2Ugb2YgdGhpcy4jdmVydGljYWxFZGdlcykgewogICAgICBjb25zdCBbeCwgeTEsIHkyLCBsZWZ0XSA9IGVkZ2U7CiAgICAgIGlmICghbGVmdCAmJiBpc0xUUikgewogICAgICAgIGlmICh5MSA8IGZpcnN0UG9pbnRZKSB7CiAgICAgICAgICBmaXJzdFBvaW50WSA9IHkxOwogICAgICAgICAgZmlyc3RQb2ludFggPSB4OwogICAgICAgIH0gZWxzZSBpZiAoeTEgPT09IGZpcnN0UG9pbnRZKSB7CiAgICAgICAgICBmaXJzdFBvaW50WCA9IE1hdGgubWF4KGZpcnN0UG9pbnRYLCB4KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobGVmdCAmJiAhaXNMVFIpIHsKICAgICAgICBpZiAoeTEgPCBmaXJzdFBvaW50WSkgewogICAgICAgICAgZmlyc3RQb2ludFkgPSB5MTsKICAgICAgICAgIGZpcnN0UG9pbnRYID0geDsKICAgICAgICB9IGVsc2UgaWYgKHkxID09PSBmaXJzdFBvaW50WSkgewogICAgICAgICAgZmlyc3RQb2ludFggPSBNYXRoLm1pbihmaXJzdFBvaW50WCwgeCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVkZ2VbMF0gPSAoeCAtIHNoaWZ0ZWRNaW5YKSAvIGJib3hXaWR0aDsKICAgICAgZWRnZVsxXSA9ICh5MSAtIHNoaWZ0ZWRNaW5ZKSAvIGJib3hIZWlnaHQ7CiAgICAgIGVkZ2VbMl0gPSAoeTIgLSBzaGlmdGVkTWluWSkgLyBiYm94SGVpZ2h0OwogICAgfQogICAgdGhpcy4jYm94ID0gbmV3IEZsb2F0MzJBcnJheShbc2hpZnRlZE1pblgsIHNoaWZ0ZWRNaW5ZLCBiYm94V2lkdGgsIGJib3hIZWlnaHRdKTsKICAgIHRoaXMuI2ZpcnN0UG9pbnQgPSBbZmlyc3RQb2ludFgsIGZpcnN0UG9pbnRZXTsKICAgIHRoaXMuI2xhc3RQb2ludCA9IGxhc3RQb2ludDsKICB9CiAgZ2V0T3V0bGluZXMoKSB7CiAgICB0aGlzLiN2ZXJ0aWNhbEVkZ2VzLnNvcnQoKGEsIGIpID0+IGFbMF0gLSBiWzBdIHx8IGFbMV0gLSBiWzFdIHx8IGFbMl0gLSBiWzJdKTsKICAgIGNvbnN0IG91dGxpbmVWZXJ0aWNhbEVkZ2VzID0gW107CiAgICBmb3IgKGNvbnN0IGVkZ2Ugb2YgdGhpcy4jdmVydGljYWxFZGdlcykgewogICAgICBpZiAoZWRnZVszXSkgewogICAgICAgIG91dGxpbmVWZXJ0aWNhbEVkZ2VzLnB1c2goLi4udGhpcy4jYnJlYWtFZGdlKGVkZ2UpKTsKICAgICAgICB0aGlzLiNpbnNlcnQoZWRnZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4jcmVtb3ZlKGVkZ2UpOwogICAgICAgIG91dGxpbmVWZXJ0aWNhbEVkZ2VzLnB1c2goLi4udGhpcy4jYnJlYWtFZGdlKGVkZ2UpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuI2dldE91dGxpbmVzKG91dGxpbmVWZXJ0aWNhbEVkZ2VzKTsKICB9CiAgI2dldE91dGxpbmVzKG91dGxpbmVWZXJ0aWNhbEVkZ2VzKSB7CiAgICBjb25zdCBlZGdlcyA9IFtdOwogICAgY29uc3QgYWxsRWRnZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgZm9yIChjb25zdCBlZGdlIG9mIG91dGxpbmVWZXJ0aWNhbEVkZ2VzKSB7CiAgICAgIGNvbnN0IFt4LCB5MSwgeTJdID0gZWRnZTsKICAgICAgZWRnZXMucHVzaChbeCwgeTEsIGVkZ2VdLCBbeCwgeTIsIGVkZ2VdKTsKICAgIH0KICAgIGVkZ2VzLnNvcnQoKGEsIGIpID0+IGFbMV0gLSBiWzFdIHx8IGFbMF0gLSBiWzBdKTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGVkZ2VzLmxlbmd0aDsgaSA8IGlpOyBpICs9IDIpIHsKICAgICAgY29uc3QgZWRnZTEgPSBlZGdlc1tpXVsyXTsKICAgICAgY29uc3QgZWRnZTIgPSBlZGdlc1tpICsgMV1bMl07CiAgICAgIGVkZ2UxLnB1c2goZWRnZTIpOwogICAgICBlZGdlMi5wdXNoKGVkZ2UxKTsKICAgICAgYWxsRWRnZXMuYWRkKGVkZ2UxKTsKICAgICAgYWxsRWRnZXMuYWRkKGVkZ2UyKTsKICAgIH0KICAgIGNvbnN0IG91dGxpbmVzID0gW107CiAgICBsZXQgb3V0bGluZTsKICAgIHdoaWxlIChhbGxFZGdlcy5zaXplID4gMCkgewogICAgICBjb25zdCBlZGdlID0gYWxsRWRnZXMudmFsdWVzKCkubmV4dCgpLnZhbHVlOwogICAgICBsZXQgW3gsIHkxLCB5MiwgZWRnZTEsIGVkZ2UyXSA9IGVkZ2U7CiAgICAgIGFsbEVkZ2VzLmRlbGV0ZShlZGdlKTsKICAgICAgbGV0IGxhc3RQb2ludFggPSB4OwogICAgICBsZXQgbGFzdFBvaW50WSA9IHkxOwogICAgICBvdXRsaW5lID0gW3gsIHkyXTsKICAgICAgb3V0bGluZXMucHVzaChvdXRsaW5lKTsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBsZXQgZTsKICAgICAgICBpZiAoYWxsRWRnZXMuaGFzKGVkZ2UxKSkgewogICAgICAgICAgZSA9IGVkZ2UxOwogICAgICAgIH0gZWxzZSBpZiAoYWxsRWRnZXMuaGFzKGVkZ2UyKSkgewogICAgICAgICAgZSA9IGVkZ2UyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgYWxsRWRnZXMuZGVsZXRlKGUpOwogICAgICAgIFt4LCB5MSwgeTIsIGVkZ2UxLCBlZGdlMl0gPSBlOwogICAgICAgIGlmIChsYXN0UG9pbnRYICE9PSB4KSB7CiAgICAgICAgICBvdXRsaW5lLnB1c2gobGFzdFBvaW50WCwgbGFzdFBvaW50WSwgeCwgbGFzdFBvaW50WSA9PT0geTEgPyB5MSA6IHkyKTsKICAgICAgICAgIGxhc3RQb2ludFggPSB4OwogICAgICAgIH0KICAgICAgICBsYXN0UG9pbnRZID0gbGFzdFBvaW50WSA9PT0geTEgPyB5MiA6IHkxOwogICAgICB9CiAgICAgIG91dGxpbmUucHVzaChsYXN0UG9pbnRYLCBsYXN0UG9pbnRZKTsKICAgIH0KICAgIHJldHVybiBuZXcgSGlnaGxpZ2h0T3V0bGluZShvdXRsaW5lcywgdGhpcy4jYm94LCB0aGlzLiNmaXJzdFBvaW50LCB0aGlzLiNsYXN0UG9pbnQpOwogIH0KICAjYmluYXJ5U2VhcmNoKHkpIHsKICAgIGNvbnN0IGFycmF5ID0gdGhpcy4jaW50ZXJ2YWxzOwogICAgbGV0IHN0YXJ0ID0gMDsKICAgIGxldCBlbmQgPSBhcnJheS5sZW5ndGggLSAxOwogICAgd2hpbGUgKHN0YXJ0IDw9IGVuZCkgewogICAgICBjb25zdCBtaWRkbGUgPSBzdGFydCArIGVuZCA+PiAxOwogICAgICBjb25zdCB5MSA9IGFycmF5W21pZGRsZV1bMF07CiAgICAgIGlmICh5MSA9PT0geSkgewogICAgICAgIHJldHVybiBtaWRkbGU7CiAgICAgIH0KICAgICAgaWYgKHkxIDwgeSkgewogICAgICAgIHN0YXJ0ID0gbWlkZGxlICsgMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmQgPSBtaWRkbGUgLSAxOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZW5kICsgMTsKICB9CiAgI2luc2VydChbLCB5MSwgeTJdKSB7CiAgICBjb25zdCBpbmRleCA9IHRoaXMuI2JpbmFyeVNlYXJjaCh5MSk7CiAgICB0aGlzLiNpbnRlcnZhbHMuc3BsaWNlKGluZGV4LCAwLCBbeTEsIHkyXSk7CiAgfQogICNyZW1vdmUoWywgeTEsIHkyXSkgewogICAgY29uc3QgaW5kZXggPSB0aGlzLiNiaW5hcnlTZWFyY2goeTEpOwogICAgZm9yIChsZXQgaSA9IGluZGV4OyBpIDwgdGhpcy4jaW50ZXJ2YWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IHRoaXMuI2ludGVydmFsc1tpXTsKICAgICAgaWYgKHN0YXJ0ICE9PSB5MSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGlmIChzdGFydCA9PT0geTEgJiYgZW5kID09PSB5MikgewogICAgICAgIHRoaXMuI2ludGVydmFscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBmb3IgKGxldCBpID0gaW5kZXggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSB0aGlzLiNpbnRlcnZhbHNbaV07CiAgICAgIGlmIChzdGFydCAhPT0geTEpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpZiAoc3RhcnQgPT09IHkxICYmIGVuZCA9PT0geTIpIHsKICAgICAgICB0aGlzLiNpbnRlcnZhbHMuc3BsaWNlKGksIDEpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogIH0KICAjYnJlYWtFZGdlKGVkZ2UpIHsKICAgIGNvbnN0IFt4LCB5MSwgeTJdID0gZWRnZTsKICAgIGNvbnN0IHJlc3VsdHMgPSBbW3gsIHkxLCB5Ml1dOwogICAgY29uc3QgaW5kZXggPSB0aGlzLiNiaW5hcnlTZWFyY2goeTIpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleDsgaSsrKSB7CiAgICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IHRoaXMuI2ludGVydmFsc1tpXTsKICAgICAgZm9yIChsZXQgaiA9IDAsIGpqID0gcmVzdWx0cy5sZW5ndGg7IGogPCBqajsgaisrKSB7CiAgICAgICAgY29uc3QgWywgeTMsIHk0XSA9IHJlc3VsdHNbal07CiAgICAgICAgaWYgKGVuZCA8PSB5MyB8fCB5NCA8PSBzdGFydCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmICh5MyA+PSBzdGFydCkgewogICAgICAgICAgaWYgKHk0ID4gZW5kKSB7CiAgICAgICAgICAgIHJlc3VsdHNbal1bMV0gPSBlbmQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoamogPT09IDEpIHsKICAgICAgICAgICAgICByZXR1cm4gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0cy5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgIGotLTsKICAgICAgICAgICAgamotLTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICByZXN1bHRzW2pdWzJdID0gc3RhcnQ7CiAgICAgICAgaWYgKHk0ID4gZW5kKSB7CiAgICAgICAgICByZXN1bHRzLnB1c2goW3gsIGVuZCwgeTRdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH0KfTsKdmFyIEhpZ2hsaWdodE91dGxpbmUgPSBjbGFzcyBleHRlbmRzIE91dGxpbmUgewogICNib3g7CiAgI291dGxpbmVzOwogIGNvbnN0cnVjdG9yKG91dGxpbmVzLCBib3gsIGZpcnN0UG9pbnQsIGxhc3RQb2ludCkgewogICAgc3VwZXIoKTsKICAgIHRoaXMuI291dGxpbmVzID0gb3V0bGluZXM7CiAgICB0aGlzLiNib3ggPSBib3g7CiAgICB0aGlzLmZpcnN0UG9pbnQgPSBmaXJzdFBvaW50OwogICAgdGhpcy5sYXN0UG9pbnQgPSBsYXN0UG9pbnQ7CiAgfQogIHRvU1ZHUGF0aCgpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IFtdOwogICAgZm9yIChjb25zdCBwb2x5Z29uIG9mIHRoaXMuI291dGxpbmVzKSB7CiAgICAgIGxldCBbcHJldlgsIHByZXZZXSA9IHBvbHlnb247CiAgICAgIGJ1ZmZlci5wdXNoKGBNJHtwcmV2WH0gJHtwcmV2WX1gKTsKICAgICAgZm9yIChsZXQgaSA9IDI7IGkgPCBwb2x5Z29uLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgY29uc3QgeCA9IHBvbHlnb25baV07CiAgICAgICAgY29uc3QgeSA9IHBvbHlnb25baSArIDFdOwogICAgICAgIGlmICh4ID09PSBwcmV2WCkgewogICAgICAgICAgYnVmZmVyLnB1c2goYFYke3l9YCk7CiAgICAgICAgICBwcmV2WSA9IHk7CiAgICAgICAgfSBlbHNlIGlmICh5ID09PSBwcmV2WSkgewogICAgICAgICAgYnVmZmVyLnB1c2goYEgke3h9YCk7CiAgICAgICAgICBwcmV2WCA9IHg7CiAgICAgICAgfQogICAgICB9CiAgICAgIGJ1ZmZlci5wdXNoKCJaIik7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyLmpvaW4oIiAiKTsKICB9CiAgc2VyaWFsaXplKFtibFgsIGJsWSwgdHJYLCB0clldLCBfcm90YXRpb24pIHsKICAgIGNvbnN0IG91dGxpbmVzID0gW107CiAgICBjb25zdCB3aWR0aCA9IHRyWCAtIGJsWDsKICAgIGNvbnN0IGhlaWdodCA9IHRyWSAtIGJsWTsKICAgIGZvciAoY29uc3Qgb3V0bGluZSBvZiB0aGlzLiNvdXRsaW5lcykgewogICAgICBjb25zdCBwb2ludHMgPSBuZXcgQXJyYXkob3V0bGluZS5sZW5ndGgpOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG91dGxpbmUubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICBwb2ludHNbaV0gPSBibFggKyBvdXRsaW5lW2ldICogd2lkdGg7CiAgICAgICAgcG9pbnRzW2kgKyAxXSA9IHRyWSAtIG91dGxpbmVbaSArIDFdICogaGVpZ2h0OwogICAgICB9CiAgICAgIG91dGxpbmVzLnB1c2gocG9pbnRzKTsKICAgIH0KICAgIHJldHVybiBvdXRsaW5lczsKICB9CiAgZ2V0IGJveCgpIHsKICAgIHJldHVybiB0aGlzLiNib3g7CiAgfQogIGdldCBjbGFzc05hbWVzRm9yT3V0bGluaW5nKCkgewogICAgcmV0dXJuIFsiaGlnaGxpZ2h0T3V0bGluZSJdOwogIH0KfTsKdmFyIEZyZWVIaWdobGlnaHRPdXRsaW5lciA9IGNsYXNzIGV4dGVuZHMgRnJlZURyYXdPdXRsaW5lciB7CiAgbmV3RnJlZURyYXdPdXRsaW5lKG91dGxpbmUsIHBvaW50cywgYm94LCBzY2FsZUZhY3RvciwgaW5uZXJNYXJnaW4sIGlzTFRSKSB7CiAgICByZXR1cm4gbmV3IEZyZWVIaWdobGlnaHRPdXRsaW5lKG91dGxpbmUsIHBvaW50cywgYm94LCBzY2FsZUZhY3RvciwgaW5uZXJNYXJnaW4sIGlzTFRSKTsKICB9Cn07CnZhciBGcmVlSGlnaGxpZ2h0T3V0bGluZSA9IGNsYXNzIGV4dGVuZHMgRnJlZURyYXdPdXRsaW5lIHsKICBuZXdPdXRsaW5lcihwb2ludCwgYm94LCBzY2FsZUZhY3RvciwgdGhpY2tuZXNzLCBpc0xUUiwgaW5uZXJNYXJnaW4gPSAwKSB7CiAgICByZXR1cm4gbmV3IEZyZWVIaWdobGlnaHRPdXRsaW5lcihwb2ludCwgYm94LCBzY2FsZUZhY3RvciwgdGhpY2tuZXNzLCBpc0xUUiwgaW5uZXJNYXJnaW4pOwogIH0KfTsKdmFyIEhpZ2hsaWdodEVkaXRvciA9IGNsYXNzIF9IaWdobGlnaHRFZGl0b3IgZXh0ZW5kcyBBbm5vdGF0aW9uRWRpdG9yIHsKICAjYW5jaG9yTm9kZSA9IG51bGw7CiAgI2FuY2hvck9mZnNldCA9IDA7CiAgI2JveGVzOwogICNjbGlwUGF0aElkID0gbnVsbDsKICAjY29sb3JQaWNrZXIgPSBudWxsOwogICNmb2N1c091dGxpbmVzID0gbnVsbDsKICAjZm9jdXNOb2RlID0gbnVsbDsKICAjZm9jdXNPZmZzZXQgPSAwOwogICNoaWdobGlnaHREaXYgPSBudWxsOwogICNoaWdobGlnaHRPdXRsaW5lcyA9IG51bGw7CiAgI2lkID0gbnVsbDsKICAjaXNGcmVlSGlnaGxpZ2h0ID0gZmFsc2U7CiAgI2ZpcnN0UG9pbnQgPSBudWxsOwogICNsYXN0UG9pbnQgPSBudWxsOwogICNvdXRsaW5lSWQgPSBudWxsOwogICN0ZXh0ID0gIiI7CiAgI3RoaWNrbmVzczsKICAjbWV0aG9kT2ZDcmVhdGlvbiA9ICIiOwogIHN0YXRpYyBfZGVmYXVsdENvbG9yID0gbnVsbDsKICBzdGF0aWMgX2RlZmF1bHRPcGFjaXR5ID0gMTsKICBzdGF0aWMgX2RlZmF1bHRUaGlja25lc3MgPSAxMjsKICBzdGF0aWMgX3R5cGUgPSAiaGlnaGxpZ2h0IjsKICBzdGF0aWMgX2VkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQ7CiAgc3RhdGljIF9mcmVlSGlnaGxpZ2h0SWQgPSAtMTsKICBzdGF0aWMgX2ZyZWVIaWdobGlnaHQgPSBudWxsOwogIHN0YXRpYyBfZnJlZUhpZ2hsaWdodENsaXBJZCA9ICIiOwogIHN0YXRpYyBnZXQgX2tleWJvYXJkTWFuYWdlcigpIHsKICAgIGNvbnN0IHByb3RvID0gX0hpZ2hsaWdodEVkaXRvci5wcm90b3R5cGU7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfa2V5Ym9hcmRNYW5hZ2VyIiwgbmV3IEtleWJvYXJkTWFuYWdlcihbW1siQXJyb3dMZWZ0IiwgIm1hYytBcnJvd0xlZnQiXSwgcHJvdG8uX21vdmVDYXJldCwgewogICAgICBhcmdzOiBbMF0KICAgIH1dLCBbWyJBcnJvd1JpZ2h0IiwgIm1hYytBcnJvd1JpZ2h0Il0sIHByb3RvLl9tb3ZlQ2FyZXQsIHsKICAgICAgYXJnczogWzFdCiAgICB9XSwgW1siQXJyb3dVcCIsICJtYWMrQXJyb3dVcCJdLCBwcm90by5fbW92ZUNhcmV0LCB7CiAgICAgIGFyZ3M6IFsyXQogICAgfV0sIFtbIkFycm93RG93biIsICJtYWMrQXJyb3dEb3duIl0sIHByb3RvLl9tb3ZlQ2FyZXQsIHsKICAgICAgYXJnczogWzNdCiAgICB9XV0pKTsKICB9CiAgY29uc3RydWN0b3IocGFyYW1zKSB7CiAgICBzdXBlcih7CiAgICAgIC4uLnBhcmFtcywKICAgICAgbmFtZTogImhpZ2hsaWdodEVkaXRvciIKICAgIH0pOwogICAgdGhpcy5jb2xvciA9IHBhcmFtcy5jb2xvciB8fCBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0Q29sb3I7CiAgICB0aGlzLiN0aGlja25lc3MgPSBwYXJhbXMudGhpY2tuZXNzIHx8IF9IaWdobGlnaHRFZGl0b3IuX2RlZmF1bHRUaGlja25lc3M7CiAgICB0aGlzLm9wYWNpdHkgPSBwYXJhbXMub3BhY2l0eSB8fCBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0T3BhY2l0eTsKICAgIHRoaXMuI2JveGVzID0gcGFyYW1zLmJveGVzIHx8IG51bGw7CiAgICB0aGlzLiNtZXRob2RPZkNyZWF0aW9uID0gcGFyYW1zLm1ldGhvZE9mQ3JlYXRpb24gfHwgIiI7CiAgICB0aGlzLiN0ZXh0ID0gcGFyYW1zLnRleHQgfHwgIiI7CiAgICB0aGlzLl9pc0RyYWdnYWJsZSA9IGZhbHNlOwogICAgdGhpcy5kZWZhdWx0TDEwbklkID0gInBkZmpzLWVkaXRvci1oaWdobGlnaHQtZWRpdG9yIjsKICAgIGlmIChwYXJhbXMuaGlnaGxpZ2h0SWQgPiAtMSkgewogICAgICB0aGlzLiNpc0ZyZWVIaWdobGlnaHQgPSB0cnVlOwogICAgICB0aGlzLiNjcmVhdGVGcmVlT3V0bGluZXMocGFyYW1zKTsKICAgICAgdGhpcy4jYWRkVG9EcmF3TGF5ZXIoKTsKICAgIH0gZWxzZSBpZiAodGhpcy4jYm94ZXMpIHsKICAgICAgdGhpcy4jYW5jaG9yTm9kZSA9IHBhcmFtcy5hbmNob3JOb2RlOwogICAgICB0aGlzLiNhbmNob3JPZmZzZXQgPSBwYXJhbXMuYW5jaG9yT2Zmc2V0OwogICAgICB0aGlzLiNmb2N1c05vZGUgPSBwYXJhbXMuZm9jdXNOb2RlOwogICAgICB0aGlzLiNmb2N1c09mZnNldCA9IHBhcmFtcy5mb2N1c09mZnNldDsKICAgICAgdGhpcy4jY3JlYXRlT3V0bGluZXMoKTsKICAgICAgdGhpcy4jYWRkVG9EcmF3TGF5ZXIoKTsKICAgICAgdGhpcy5yb3RhdGUodGhpcy5yb3RhdGlvbik7CiAgICB9CiAgICBpZiAoIXRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICB0aGlzLl91aU1hbmFnZXIuYTExeUFsZXJ0KCJwZGZqcy1lZGl0b3ItaGlnaGxpZ2h0LWFkZGVkLWFsZXJ0Iik7CiAgICB9CiAgfQogIGdldCB0ZWxlbWV0cnlJbml0aWFsRGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIGFjdGlvbjogImFkZGVkIiwKICAgICAgdHlwZTogdGhpcy4jaXNGcmVlSGlnaGxpZ2h0ID8gImZyZWVfaGlnaGxpZ2h0IiA6ICJoaWdobGlnaHQiLAogICAgICBjb2xvcjogdGhpcy5fdWlNYW5hZ2VyLmdldE5vbkhDTUNvbG9yTmFtZSh0aGlzLmNvbG9yKSwKICAgICAgdGhpY2tuZXNzOiB0aGlzLiN0aGlja25lc3MsCiAgICAgIG1ldGhvZE9mQ3JlYXRpb246IHRoaXMuI21ldGhvZE9mQ3JlYXRpb24KICAgIH07CiAgfQogIGdldCB0ZWxlbWV0cnlGaW5hbERhdGEoKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAiaGlnaGxpZ2h0IiwKICAgICAgY29sb3I6IHRoaXMuX3VpTWFuYWdlci5nZXROb25IQ01Db2xvck5hbWUodGhpcy5jb2xvcikKICAgIH07CiAgfQogIHN0YXRpYyBjb21wdXRlVGVsZW1ldHJ5RmluYWxEYXRhKGRhdGEpIHsKICAgIHJldHVybiB7CiAgICAgIG51bWJlck9mQ29sb3JzOiBkYXRhLmdldCgiY29sb3IiKS5zaXplCiAgICB9OwogIH0KICAjY3JlYXRlT3V0bGluZXMoKSB7CiAgICBjb25zdCBvdXRsaW5lciA9IG5ldyBIaWdobGlnaHRPdXRsaW5lcih0aGlzLiNib3hlcywgMWUtMyk7CiAgICB0aGlzLiNoaWdobGlnaHRPdXRsaW5lcyA9IG91dGxpbmVyLmdldE91dGxpbmVzKCk7CiAgICBbdGhpcy54LCB0aGlzLnksIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0XSA9IHRoaXMuI2hpZ2hsaWdodE91dGxpbmVzLmJveDsKICAgIGNvbnN0IG91dGxpbmVyRm9yT3V0bGluZSA9IG5ldyBIaWdobGlnaHRPdXRsaW5lcih0aGlzLiNib3hlcywgMjVlLTQsIDFlLTMsIHRoaXMuX3VpTWFuYWdlci5kaXJlY3Rpb24gPT09ICJsdHIiKTsKICAgIHRoaXMuI2ZvY3VzT3V0bGluZXMgPSBvdXRsaW5lckZvck91dGxpbmUuZ2V0T3V0bGluZXMoKTsKICAgIGNvbnN0IHsKICAgICAgZmlyc3RQb2ludAogICAgfSA9IHRoaXMuI2hpZ2hsaWdodE91dGxpbmVzOwogICAgdGhpcy4jZmlyc3RQb2ludCA9IFsoZmlyc3RQb2ludFswXSAtIHRoaXMueCkgLyB0aGlzLndpZHRoLCAoZmlyc3RQb2ludFsxXSAtIHRoaXMueSkgLyB0aGlzLmhlaWdodF07CiAgICBjb25zdCB7CiAgICAgIGxhc3RQb2ludAogICAgfSA9IHRoaXMuI2ZvY3VzT3V0bGluZXM7CiAgICB0aGlzLiNsYXN0UG9pbnQgPSBbKGxhc3RQb2ludFswXSAtIHRoaXMueCkgLyB0aGlzLndpZHRoLCAobGFzdFBvaW50WzFdIC0gdGhpcy55KSAvIHRoaXMuaGVpZ2h0XTsKICB9CiAgI2NyZWF0ZUZyZWVPdXRsaW5lcyh7CiAgICBoaWdobGlnaHRPdXRsaW5lcywKICAgIGhpZ2hsaWdodElkLAogICAgY2xpcFBhdGhJZAogIH0pIHsKICAgIHRoaXMuI2hpZ2hsaWdodE91dGxpbmVzID0gaGlnaGxpZ2h0T3V0bGluZXM7CiAgICBjb25zdCBleHRyYVRoaWNrbmVzcyA9IDEuNTsKICAgIHRoaXMuI2ZvY3VzT3V0bGluZXMgPSBoaWdobGlnaHRPdXRsaW5lcy5nZXROZXdPdXRsaW5lKHRoaXMuI3RoaWNrbmVzcyAvIDIgKyBleHRyYVRoaWNrbmVzcywgMjVlLTQpOwogICAgaWYgKGhpZ2hsaWdodElkID49IDApIHsKICAgICAgdGhpcy4jaWQgPSBoaWdobGlnaHRJZDsKICAgICAgdGhpcy4jY2xpcFBhdGhJZCA9IGNsaXBQYXRoSWQ7CiAgICAgIHRoaXMucGFyZW50LmRyYXdMYXllci5maW5hbGl6ZURyYXcoaGlnaGxpZ2h0SWQsIHsKICAgICAgICBiYm94OiBoaWdobGlnaHRPdXRsaW5lcy5ib3gsCiAgICAgICAgcGF0aDogewogICAgICAgICAgZDogaGlnaGxpZ2h0T3V0bGluZXMudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLiNvdXRsaW5lSWQgPSB0aGlzLnBhcmVudC5kcmF3TGF5ZXIuZHJhd091dGxpbmUoewogICAgICAgIHJvb3RDbGFzczogewogICAgICAgICAgaGlnaGxpZ2h0T3V0bGluZTogdHJ1ZSwKICAgICAgICAgIGZyZWU6IHRydWUKICAgICAgICB9LAogICAgICAgIGJib3g6IHRoaXMuI2ZvY3VzT3V0bGluZXMuYm94LAogICAgICAgIHBhdGg6IHsKICAgICAgICAgIGQ6IHRoaXMuI2ZvY3VzT3V0bGluZXMudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH0sIHRydWUpOwogICAgfSBlbHNlIGlmICh0aGlzLnBhcmVudCkgewogICAgICBjb25zdCBhbmdsZSA9IHRoaXMucGFyZW50LnZpZXdwb3J0LnJvdGF0aW9uOwogICAgICB0aGlzLnBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLiNpZCwgewogICAgICAgIGJib3g6IF9IaWdobGlnaHRFZGl0b3IuI3JvdGF0ZUJib3godGhpcy4jaGlnaGxpZ2h0T3V0bGluZXMuYm94LCAoYW5nbGUgLSB0aGlzLnJvdGF0aW9uICsgMzYwKSAlIDM2MCksCiAgICAgICAgcGF0aDogewogICAgICAgICAgZDogaGlnaGxpZ2h0T3V0bGluZXMudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLnBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLiNvdXRsaW5lSWQsIHsKICAgICAgICBiYm94OiBfSGlnaGxpZ2h0RWRpdG9yLiNyb3RhdGVCYm94KHRoaXMuI2ZvY3VzT3V0bGluZXMuYm94LCBhbmdsZSksCiAgICAgICAgcGF0aDogewogICAgICAgICAgZDogdGhpcy4jZm9jdXNPdXRsaW5lcy50b1NWR1BhdGgoKQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBbeCwgeSwgd2lkdGgsIGhlaWdodF0gPSBoaWdobGlnaHRPdXRsaW5lcy5ib3g7CiAgICBzd2l0Y2ggKHRoaXMucm90YXRpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMueCA9IHg7CiAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgOTA6IHsKICAgICAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgICAgICB0aGlzLnggPSB5OwogICAgICAgIHRoaXMueSA9IDEgLSB4OwogICAgICAgIHRoaXMud2lkdGggPSB3aWR0aCAqIHBhZ2VIZWlnaHQgLyBwYWdlV2lkdGg7CiAgICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQgKiBwYWdlV2lkdGggLyBwYWdlSGVpZ2h0OwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHRoaXMueCA9IDEgLSB4OwogICAgICAgIHRoaXMueSA9IDEgLSB5OwogICAgICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgICAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyNzA6IHsKICAgICAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgICAgICB0aGlzLnggPSAxIC0geTsKICAgICAgICB0aGlzLnkgPSB4OwogICAgICAgIHRoaXMud2lkdGggPSB3aWR0aCAqIHBhZ2VIZWlnaHQgLyBwYWdlV2lkdGg7CiAgICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQgKiBwYWdlV2lkdGggLyBwYWdlSGVpZ2h0OwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGZpcnN0UG9pbnQKICAgIH0gPSBoaWdobGlnaHRPdXRsaW5lczsKICAgIHRoaXMuI2ZpcnN0UG9pbnQgPSBbKGZpcnN0UG9pbnRbMF0gLSB4KSAvIHdpZHRoLCAoZmlyc3RQb2ludFsxXSAtIHkpIC8gaGVpZ2h0XTsKICAgIGNvbnN0IHsKICAgICAgbGFzdFBvaW50CiAgICB9ID0gdGhpcy4jZm9jdXNPdXRsaW5lczsKICAgIHRoaXMuI2xhc3RQb2ludCA9IFsobGFzdFBvaW50WzBdIC0geCkgLyB3aWR0aCwgKGxhc3RQb2ludFsxXSAtIHkpIC8gaGVpZ2h0XTsKICB9CiAgc3RhdGljIGluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKSB7CiAgICBBbm5vdGF0aW9uRWRpdG9yLmluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKTsKICAgIF9IaWdobGlnaHRFZGl0b3IuX2RlZmF1bHRDb2xvciB8fD0gdWlNYW5hZ2VyLmhpZ2hsaWdodENvbG9ycz8udmFsdWVzKCkubmV4dCgpLnZhbHVlIHx8ICIjZmZmMDY2IjsKICB9CiAgc3RhdGljIHVwZGF0ZURlZmF1bHRQYXJhbXModHlwZSwgdmFsdWUpIHsKICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9DT0xPUjoKICAgICAgICBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0Q29sb3IgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfVEhJQ0tORVNTOgogICAgICAgIF9IaWdobGlnaHRFZGl0b3IuX2RlZmF1bHRUaGlja25lc3MgPSB2YWx1ZTsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgdHJhbnNsYXRlSW5QYWdlKHgsIHkpIHsKICB9CiAgZ2V0IHRvb2xiYXJQb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLiNsYXN0UG9pbnQ7CiAgfQogIGdldCBjb21tZW50QnV0dG9uUG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy4jZmlyc3RQb2ludDsKICB9CiAgdXBkYXRlUGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfQ09MT1I6CiAgICAgICAgdGhpcy4jdXBkYXRlQ29sb3IodmFsdWUpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9USElDS05FU1M6CiAgICAgICAgdGhpcy4jdXBkYXRlVGhpY2tuZXNzKHZhbHVlKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgc3RhdGljIGdldCBkZWZhdWx0UHJvcGVydGllc1RvVXBkYXRlKCkgewogICAgcmV0dXJuIFtbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX0NPTE9SLCBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0Q29sb3JdLCBbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX1RISUNLTkVTUywgX0hpZ2hsaWdodEVkaXRvci5fZGVmYXVsdFRoaWNrbmVzc11dOwogIH0KICBnZXQgcHJvcGVydGllc1RvVXBkYXRlKCkgewogICAgcmV0dXJuIFtbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX0NPTE9SLCB0aGlzLmNvbG9yIHx8IF9IaWdobGlnaHRFZGl0b3IuX2RlZmF1bHRDb2xvcl0sIFtBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfVEhJQ0tORVNTLCB0aGlzLiN0aGlja25lc3MgfHwgX0hpZ2hsaWdodEVkaXRvci5fZGVmYXVsdFRoaWNrbmVzc10sIFtBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfRlJFRSwgdGhpcy4jaXNGcmVlSGlnaGxpZ2h0XV07CiAgfQogIG9uVXBkYXRlZENvbG9yKCkgewogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuI2lkLCB7CiAgICAgIHJvb3Q6IHsKICAgICAgICBmaWxsOiB0aGlzLmNvbG9yLAogICAgICAgICJmaWxsLW9wYWNpdHkiOiB0aGlzLm9wYWNpdHkKICAgICAgfQogICAgfSk7CiAgICB0aGlzLiNjb2xvclBpY2tlcj8udXBkYXRlQ29sb3IodGhpcy5jb2xvcik7CiAgICBzdXBlci5vblVwZGF0ZWRDb2xvcigpOwogIH0KICAjdXBkYXRlQ29sb3IoY29sb3IpIHsKICAgIGNvbnN0IHNldENvbG9yQW5kT3BhY2l0eSA9IChjb2wsIG9wYSkgPT4gewogICAgICB0aGlzLmNvbG9yID0gY29sOwogICAgICB0aGlzLm9wYWNpdHkgPSBvcGE7CiAgICAgIHRoaXMub25VcGRhdGVkQ29sb3IoKTsKICAgIH07CiAgICBjb25zdCBzYXZlZENvbG9yID0gdGhpcy5jb2xvcjsKICAgIGNvbnN0IHNhdmVkT3BhY2l0eSA9IHRoaXMub3BhY2l0eTsKICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICBjbWQ6IHNldENvbG9yQW5kT3BhY2l0eS5iaW5kKHRoaXMsIGNvbG9yLCBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0T3BhY2l0eSksCiAgICAgIHVuZG86IHNldENvbG9yQW5kT3BhY2l0eS5iaW5kKHRoaXMsIHNhdmVkQ29sb3IsIHNhdmVkT3BhY2l0eSksCiAgICAgIHBvc3Q6IHRoaXMuX3VpTWFuYWdlci51cGRhdGVVSS5iaW5kKHRoaXMuX3VpTWFuYWdlciwgdGhpcyksCiAgICAgIG11c3RFeGVjOiB0cnVlLAogICAgICB0eXBlOiBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfQ09MT1IsCiAgICAgIG92ZXJ3cml0ZUlmU2FtZVR5cGU6IHRydWUsCiAgICAgIGtlZXBVbmRvOiB0cnVlCiAgICB9KTsKICAgIHRoaXMuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgIGFjdGlvbjogImNvbG9yX2NoYW5nZWQiLAogICAgICBjb2xvcjogdGhpcy5fdWlNYW5hZ2VyLmdldE5vbkhDTUNvbG9yTmFtZShjb2xvcikKICAgIH0sIHRydWUpOwogIH0KICAjdXBkYXRlVGhpY2tuZXNzKHRoaWNrbmVzcykgewogICAgY29uc3Qgc2F2ZWRUaGlja25lc3MgPSB0aGlzLiN0aGlja25lc3M7CiAgICBjb25zdCBzZXRUaGlja25lc3MgPSAodGgpID0+IHsKICAgICAgdGhpcy4jdGhpY2tuZXNzID0gdGg7CiAgICAgIHRoaXMuI2NoYW5nZVRoaWNrbmVzcyh0aCk7CiAgICB9OwogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZDogc2V0VGhpY2tuZXNzLmJpbmQodGhpcywgdGhpY2tuZXNzKSwKICAgICAgdW5kbzogc2V0VGhpY2tuZXNzLmJpbmQodGhpcywgc2F2ZWRUaGlja25lc3MpLAogICAgICBwb3N0OiB0aGlzLl91aU1hbmFnZXIudXBkYXRlVUkuYmluZCh0aGlzLl91aU1hbmFnZXIsIHRoaXMpLAogICAgICBtdXN0RXhlYzogdHJ1ZSwKICAgICAgdHlwZTogQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSU5LX1RISUNLTkVTUywKICAgICAgb3ZlcndyaXRlSWZTYW1lVHlwZTogdHJ1ZSwKICAgICAga2VlcFVuZG86IHRydWUKICAgIH0pOwogICAgdGhpcy5fcmVwb3J0VGVsZW1ldHJ5KHsKICAgICAgYWN0aW9uOiAidGhpY2tuZXNzX2NoYW5nZWQiLAogICAgICB0aGlja25lc3MKICAgIH0sIHRydWUpOwogIH0KICBnZXQgdG9vbGJhckJ1dHRvbnMoKSB7CiAgICBpZiAodGhpcy5fdWlNYW5hZ2VyLmhpZ2hsaWdodENvbG9ycykgewogICAgICBjb25zdCBjb2xvclBpY2tlciA9IHRoaXMuI2NvbG9yUGlja2VyID0gbmV3IENvbG9yUGlja2VyKHsKICAgICAgICBlZGl0b3I6IHRoaXMKICAgICAgfSk7CiAgICAgIHJldHVybiBbWyJjb2xvclBpY2tlciIsIGNvbG9yUGlja2VyXV07CiAgICB9CiAgICByZXR1cm4gc3VwZXIudG9vbGJhckJ1dHRvbnM7CiAgfQogIGRpc2FibGVFZGl0aW5nKCkgewogICAgc3VwZXIuZGlzYWJsZUVkaXRpbmcoKTsKICAgIHRoaXMuZGl2LmNsYXNzTGlzdC50b2dnbGUoImRpc2FibGVkIiwgdHJ1ZSk7CiAgfQogIGVuYWJsZUVkaXRpbmcoKSB7CiAgICBzdXBlci5lbmFibGVFZGl0aW5nKCk7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJkaXNhYmxlZCIsIGZhbHNlKTsKICB9CiAgZml4QW5kU2V0UG9zaXRpb24oKSB7CiAgICByZXR1cm4gc3VwZXIuZml4QW5kU2V0UG9zaXRpb24odGhpcy4jZ2V0Um90YXRpb24oKSk7CiAgfQogIGdldEJhc2VUcmFuc2xhdGlvbigpIHsKICAgIHJldHVybiBbMCwgMF07CiAgfQogIGdldFJlY3QodHgsIHR5KSB7CiAgICByZXR1cm4gc3VwZXIuZ2V0UmVjdCh0eCwgdHksIHRoaXMuI2dldFJvdGF0aW9uKCkpOwogIH0KICBvbmNlQWRkZWQoZm9jdXMpIHsKICAgIGlmICghdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIHRoaXMucGFyZW50LmFkZFVuZG9hYmxlRWRpdG9yKHRoaXMpOwogICAgfQogICAgaWYgKGZvY3VzKSB7CiAgICAgIHRoaXMuZGl2LmZvY3VzKCk7CiAgICB9CiAgfQogIHJlbW92ZSgpIHsKICAgIHRoaXMuI2NsZWFuRHJhd0xheWVyKCk7CiAgICB0aGlzLl9yZXBvcnRUZWxlbWV0cnkoewogICAgICBhY3Rpb246ICJkZWxldGVkIgogICAgfSk7CiAgICBzdXBlci5yZW1vdmUoKTsKICB9CiAgcmVidWlsZCgpIHsKICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3VwZXIucmVidWlsZCgpOwogICAgaWYgKHRoaXMuZGl2ID09PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FkZFRvRHJhd0xheWVyKCk7CiAgICBpZiAoIXRoaXMuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIHRoaXMucGFyZW50LmFkZCh0aGlzKTsKICAgIH0KICB9CiAgc2V0UGFyZW50KHBhcmVudCkgewogICAgbGV0IG11c3RCZVNlbGVjdGVkID0gZmFsc2U7CiAgICBpZiAodGhpcy5wYXJlbnQgJiYgIXBhcmVudCkgewogICAgICB0aGlzLiNjbGVhbkRyYXdMYXllcigpOwogICAgfSBlbHNlIGlmIChwYXJlbnQpIHsKICAgICAgdGhpcy4jYWRkVG9EcmF3TGF5ZXIocGFyZW50KTsKICAgICAgbXVzdEJlU2VsZWN0ZWQgPSAhdGhpcy5wYXJlbnQgJiYgdGhpcy5kaXY/LmNsYXNzTGlzdC5jb250YWlucygic2VsZWN0ZWRFZGl0b3IiKTsKICAgIH0KICAgIHN1cGVyLnNldFBhcmVudChwYXJlbnQpOwogICAgdGhpcy5zaG93KHRoaXMuX2lzVmlzaWJsZSk7CiAgICBpZiAobXVzdEJlU2VsZWN0ZWQpIHsKICAgICAgdGhpcy5zZWxlY3QoKTsKICAgIH0KICB9CiAgI2NoYW5nZVRoaWNrbmVzcyh0aGlja25lc3MpIHsKICAgIGlmICghdGhpcy4jaXNGcmVlSGlnaGxpZ2h0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NyZWF0ZUZyZWVPdXRsaW5lcyh7CiAgICAgIGhpZ2hsaWdodE91dGxpbmVzOiB0aGlzLiNoaWdobGlnaHRPdXRsaW5lcy5nZXROZXdPdXRsaW5lKHRoaWNrbmVzcyAvIDIpCiAgICB9KTsKICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICAgIHRoaXMuc2V0RGltcygpOwogIH0KICAjY2xlYW5EcmF3TGF5ZXIoKSB7CiAgICBpZiAodGhpcy4jaWQgPT09IG51bGwgfHwgIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMucGFyZW50LmRyYXdMYXllci5yZW1vdmUodGhpcy4jaWQpOwogICAgdGhpcy4jaWQgPSBudWxsOwogICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLnJlbW92ZSh0aGlzLiNvdXRsaW5lSWQpOwogICAgdGhpcy4jb3V0bGluZUlkID0gbnVsbDsKICB9CiAgI2FkZFRvRHJhd0xheWVyKHBhcmVudCA9IHRoaXMucGFyZW50KSB7CiAgICBpZiAodGhpcy4jaWQgIT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgKHsKICAgICAgaWQ6IHRoaXMuI2lkLAogICAgICBjbGlwUGF0aElkOiB0aGlzLiNjbGlwUGF0aElkCiAgICB9ID0gcGFyZW50LmRyYXdMYXllci5kcmF3KHsKICAgICAgYmJveDogdGhpcy4jaGlnaGxpZ2h0T3V0bGluZXMuYm94LAogICAgICByb290OiB7CiAgICAgICAgdmlld0JveDogIjAgMCAxIDEiLAogICAgICAgIGZpbGw6IHRoaXMuY29sb3IsCiAgICAgICAgImZpbGwtb3BhY2l0eSI6IHRoaXMub3BhY2l0eQogICAgICB9LAogICAgICByb290Q2xhc3M6IHsKICAgICAgICBoaWdobGlnaHQ6IHRydWUsCiAgICAgICAgZnJlZTogdGhpcy4jaXNGcmVlSGlnaGxpZ2h0CiAgICAgIH0sCiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLiNoaWdobGlnaHRPdXRsaW5lcy50b1NWR1BhdGgoKQogICAgICB9CiAgICB9LCBmYWxzZSwgdHJ1ZSkpOwogICAgdGhpcy4jb3V0bGluZUlkID0gcGFyZW50LmRyYXdMYXllci5kcmF3T3V0bGluZSh7CiAgICAgIHJvb3RDbGFzczogewogICAgICAgIGhpZ2hsaWdodE91dGxpbmU6IHRydWUsCiAgICAgICAgZnJlZTogdGhpcy4jaXNGcmVlSGlnaGxpZ2h0CiAgICAgIH0sCiAgICAgIGJib3g6IHRoaXMuI2ZvY3VzT3V0bGluZXMuYm94LAogICAgICBwYXRoOiB7CiAgICAgICAgZDogdGhpcy4jZm9jdXNPdXRsaW5lcy50b1NWR1BhdGgoKQogICAgICB9CiAgICB9LCB0aGlzLiNpc0ZyZWVIaWdobGlnaHQpOwogICAgaWYgKHRoaXMuI2hpZ2hsaWdodERpdikgewogICAgICB0aGlzLiNoaWdobGlnaHREaXYuc3R5bGUuY2xpcFBhdGggPSB0aGlzLiNjbGlwUGF0aElkOwogICAgfQogIH0KICBzdGF0aWMgI3JvdGF0ZUJib3goW3gsIHksIHdpZHRoLCBoZWlnaHRdLCBhbmdsZSkgewogICAgc3dpdGNoIChhbmdsZSkgewogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbMSAtIHkgLSBoZWlnaHQsIHgsIGhlaWdodCwgd2lkdGhdOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXR1cm4gWzEgLSB4IC0gd2lkdGgsIDEgLSB5IC0gaGVpZ2h0LCB3aWR0aCwgaGVpZ2h0XTsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmV0dXJuIFt5LCAxIC0geCAtIHdpZHRoLCBoZWlnaHQsIHdpZHRoXTsKICAgIH0KICAgIHJldHVybiBbeCwgeSwgd2lkdGgsIGhlaWdodF07CiAgfQogIHJvdGF0ZShhbmdsZSkgewogICAgY29uc3QgewogICAgICBkcmF3TGF5ZXIKICAgIH0gPSB0aGlzLnBhcmVudDsKICAgIGxldCBib3g7CiAgICBpZiAodGhpcy4jaXNGcmVlSGlnaGxpZ2h0KSB7CiAgICAgIGFuZ2xlID0gKGFuZ2xlIC0gdGhpcy5yb3RhdGlvbiArIDM2MCkgJSAzNjA7CiAgICAgIGJveCA9IF9IaWdobGlnaHRFZGl0b3IuI3JvdGF0ZUJib3godGhpcy4jaGlnaGxpZ2h0T3V0bGluZXMuYm94LCBhbmdsZSk7CiAgICB9IGVsc2UgewogICAgICBib3ggPSBfSGlnaGxpZ2h0RWRpdG9yLiNyb3RhdGVCYm94KFt0aGlzLngsIHRoaXMueSwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHRdLCBhbmdsZSk7CiAgICB9CiAgICBkcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLiNpZCwgewogICAgICBiYm94OiBib3gsCiAgICAgIHJvb3Q6IHsKICAgICAgICAiZGF0YS1tYWluLXJvdGF0aW9uIjogYW5nbGUKICAgICAgfQogICAgfSk7CiAgICBkcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLiNvdXRsaW5lSWQsIHsKICAgICAgYmJveDogX0hpZ2hsaWdodEVkaXRvci4jcm90YXRlQmJveCh0aGlzLiNmb2N1c091dGxpbmVzLmJveCwgYW5nbGUpLAogICAgICByb290OiB7CiAgICAgICAgImRhdGEtbWFpbi1yb3RhdGlvbiI6IGFuZ2xlCiAgICAgIH0KICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICBpZiAodGhpcy5kaXYpIHsKICAgICAgcmV0dXJuIHRoaXMuZGl2OwogICAgfQogICAgY29uc3QgZGl2ID0gc3VwZXIucmVuZGVyKCk7CiAgICBpZiAodGhpcy4jdGV4dCkgewogICAgICBkaXYuc2V0QXR0cmlidXRlKCJhcmlhLWxhYmVsIiwgdGhpcy4jdGV4dCk7CiAgICAgIGRpdi5zZXRBdHRyaWJ1dGUoInJvbGUiLCAibWFyayIpOwogICAgfQogICAgaWYgKHRoaXMuI2lzRnJlZUhpZ2hsaWdodCkgewogICAgICBkaXYuY2xhc3NMaXN0LmFkZCgiZnJlZSIpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5kaXYuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuI2tleWRvd24uYmluZCh0aGlzKSwgewogICAgICAgIHNpZ25hbDogdGhpcy5fdWlNYW5hZ2VyLl9zaWduYWwKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBoaWdobGlnaHREaXYgPSB0aGlzLiNoaWdobGlnaHREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5hcHBlbmQoaGlnaGxpZ2h0RGl2KTsKICAgIGhpZ2hsaWdodERpdi5zZXRBdHRyaWJ1dGUoImFyaWEtaGlkZGVuIiwgInRydWUiKTsKICAgIGhpZ2hsaWdodERpdi5jbGFzc05hbWUgPSAiaW50ZXJuYWwiOwogICAgaGlnaGxpZ2h0RGl2LnN0eWxlLmNsaXBQYXRoID0gdGhpcy4jY2xpcFBhdGhJZDsKICAgIHRoaXMuc2V0RGltcygpOwogICAgYmluZEV2ZW50cyh0aGlzLCB0aGlzLiNoaWdobGlnaHREaXYsIFsicG9pbnRlcm92ZXIiLCAicG9pbnRlcmxlYXZlIl0pOwogICAgdGhpcy5lbmFibGVFZGl0aW5nKCk7CiAgICByZXR1cm4gZGl2OwogIH0KICBwb2ludGVyb3ZlcigpIHsKICAgIGlmICghdGhpcy5pc1NlbGVjdGVkKSB7CiAgICAgIHRoaXMucGFyZW50Py5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLiNvdXRsaW5lSWQsIHsKICAgICAgICByb290Q2xhc3M6IHsKICAgICAgICAgIGhvdmVyZWQ6IHRydWUKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICBwb2ludGVybGVhdmUoKSB7CiAgICBpZiAoIXRoaXMuaXNTZWxlY3RlZCkgewogICAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jb3V0bGluZUlkLCB7CiAgICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgICBob3ZlcmVkOiBmYWxzZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogICNrZXlkb3duKGV2ZW50KSB7CiAgICBfSGlnaGxpZ2h0RWRpdG9yLl9rZXlib2FyZE1hbmFnZXIuZXhlYyh0aGlzLCBldmVudCk7CiAgfQogIF9tb3ZlQ2FyZXQoZGlyZWN0aW9uKSB7CiAgICB0aGlzLnBhcmVudC51bnNlbGVjdCh0aGlzKTsKICAgIHN3aXRjaCAoZGlyZWN0aW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuI3NldENhcmV0KHRydWUpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLiNzZXRDYXJldChmYWxzZSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogICNzZXRDYXJldChzdGFydCkgewogICAgaWYgKCF0aGlzLiNhbmNob3JOb2RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTsKICAgIGlmIChzdGFydCkgewogICAgICBzZWxlY3Rpb24uc2V0UG9zaXRpb24odGhpcy4jYW5jaG9yTm9kZSwgdGhpcy4jYW5jaG9yT2Zmc2V0KTsKICAgIH0gZWxzZSB7CiAgICAgIHNlbGVjdGlvbi5zZXRQb3NpdGlvbih0aGlzLiNmb2N1c05vZGUsIHRoaXMuI2ZvY3VzT2Zmc2V0KTsKICAgIH0KICB9CiAgc2VsZWN0KCkgewogICAgc3VwZXIuc2VsZWN0KCk7CiAgICBpZiAoIXRoaXMuI291dGxpbmVJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jb3V0bGluZUlkLCB7CiAgICAgIHJvb3RDbGFzczogewogICAgICAgIGhvdmVyZWQ6IGZhbHNlLAogICAgICAgIHNlbGVjdGVkOiB0cnVlCiAgICAgIH0KICAgIH0pOwogIH0KICB1bnNlbGVjdCgpIHsKICAgIHN1cGVyLnVuc2VsZWN0KCk7CiAgICBpZiAoIXRoaXMuI291dGxpbmVJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jb3V0bGluZUlkLCB7CiAgICAgIHJvb3RDbGFzczogewogICAgICAgIHNlbGVjdGVkOiBmYWxzZQogICAgICB9CiAgICB9KTsKICAgIGlmICghdGhpcy4jaXNGcmVlSGlnaGxpZ2h0KSB7CiAgICAgIHRoaXMuI3NldENhcmV0KGZhbHNlKTsKICAgIH0KICB9CiAgZ2V0IF9tdXN0Rml4UG9zaXRpb24oKSB7CiAgICByZXR1cm4gIXRoaXMuI2lzRnJlZUhpZ2hsaWdodDsKICB9CiAgc2hvdyh2aXNpYmxlID0gdGhpcy5faXNWaXNpYmxlKSB7CiAgICBzdXBlci5zaG93KHZpc2libGUpOwogICAgaWYgKHRoaXMucGFyZW50KSB7CiAgICAgIHRoaXMucGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuI2lkLCB7CiAgICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgICBoaWRkZW46ICF2aXNpYmxlCiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jb3V0bGluZUlkLCB7CiAgICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgICBoaWRkZW46ICF2aXNpYmxlCiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgI2dldFJvdGF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuI2lzRnJlZUhpZ2hsaWdodCA/IHRoaXMucm90YXRpb24gOiAwOwogIH0KICAjc2VyaWFsaXplQm94ZXMoKSB7CiAgICBpZiAodGhpcy4jaXNGcmVlSGlnaGxpZ2h0KSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhZ2VEaW1lbnNpb25zOwogICAgY29uc3QgW3BhZ2VYLCBwYWdlWV0gPSB0aGlzLnBhZ2VUcmFuc2xhdGlvbjsKICAgIGNvbnN0IGJveGVzID0gdGhpcy4jYm94ZXM7CiAgICBjb25zdCBxdWFkUG9pbnRzID0gbmV3IEZsb2F0MzJBcnJheShib3hlcy5sZW5ndGggKiA4KTsKICAgIGxldCBpID0gMDsKICAgIGZvciAoY29uc3QgewogICAgICB4LAogICAgICB5LAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9IG9mIGJveGVzKSB7CiAgICAgIGNvbnN0IHN4ID0geCAqIHBhZ2VXaWR0aCArIHBhZ2VYOwogICAgICBjb25zdCBzeSA9ICgxIC0geSkgKiBwYWdlSGVpZ2h0ICsgcGFnZVk7CiAgICAgIHF1YWRQb2ludHNbaV0gPSBxdWFkUG9pbnRzW2kgKyA0XSA9IHN4OwogICAgICBxdWFkUG9pbnRzW2kgKyAxXSA9IHF1YWRQb2ludHNbaSArIDNdID0gc3k7CiAgICAgIHF1YWRQb2ludHNbaSArIDJdID0gcXVhZFBvaW50c1tpICsgNl0gPSBzeCArIHdpZHRoICogcGFnZVdpZHRoOwogICAgICBxdWFkUG9pbnRzW2kgKyA1XSA9IHF1YWRQb2ludHNbaSArIDddID0gc3kgLSBoZWlnaHQgKiBwYWdlSGVpZ2h0OwogICAgICBpICs9IDg7CiAgICB9CiAgICByZXR1cm4gcXVhZFBvaW50czsKICB9CiAgI3NlcmlhbGl6ZU91dGxpbmVzKHJlY3QpIHsKICAgIHJldHVybiB0aGlzLiNoaWdobGlnaHRPdXRsaW5lcy5zZXJpYWxpemUocmVjdCwgdGhpcy4jZ2V0Um90YXRpb24oKSk7CiAgfQogIHN0YXRpYyBzdGFydEhpZ2hsaWdodGluZyhwYXJlbnQsIGlzTFRSLCB7CiAgICB0YXJnZXQ6IHRleHRMYXllciwKICAgIHgsCiAgICB5CiAgfSkgewogICAgY29uc3QgewogICAgICB4OiBsYXllclgsCiAgICAgIHk6IGxheWVyWSwKICAgICAgd2lkdGg6IHBhcmVudFdpZHRoLAogICAgICBoZWlnaHQ6IHBhcmVudEhlaWdodAogICAgfSA9IHRleHRMYXllci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIGNvbnN0IGFjID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gcGFyZW50LmNvbWJpbmVkU2lnbmFsKGFjKTsKICAgIGNvbnN0IHBvaW50ZXJVcENhbGxiYWNrID0gKGUpID0+IHsKICAgICAgYWMuYWJvcnQoKTsKICAgICAgdGhpcy4jZW5kSGlnaGxpZ2h0KHBhcmVudCwgZSk7CiAgICB9OwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImJsdXIiLCBwb2ludGVyVXBDYWxsYmFjaywgewogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHBvaW50ZXJVcENhbGxiYWNrLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmRvd24iLCBzdG9wRXZlbnQsIHsKICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgcGFzc2l2ZTogZmFsc2UsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0ZXh0TGF5ZXIuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcm1vdmUiLCB0aGlzLiNoaWdobGlnaHRNb3ZlLmJpbmQodGhpcywgcGFyZW50KSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgdGhpcy5fZnJlZUhpZ2hsaWdodCA9IG5ldyBGcmVlSGlnaGxpZ2h0T3V0bGluZXIoewogICAgICB4LAogICAgICB5CiAgICB9LCBbbGF5ZXJYLCBsYXllclksIHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdLCBwYXJlbnQuc2NhbGUsIHRoaXMuX2RlZmF1bHRUaGlja25lc3MgLyAyLCBpc0xUUiwgMWUtMyk7CiAgICAoewogICAgICBpZDogdGhpcy5fZnJlZUhpZ2hsaWdodElkLAogICAgICBjbGlwUGF0aElkOiB0aGlzLl9mcmVlSGlnaGxpZ2h0Q2xpcElkCiAgICB9ID0gcGFyZW50LmRyYXdMYXllci5kcmF3KHsKICAgICAgYmJveDogWzAsIDAsIDEsIDFdLAogICAgICByb290OiB7CiAgICAgICAgdmlld0JveDogIjAgMCAxIDEiLAogICAgICAgIGZpbGw6IHRoaXMuX2RlZmF1bHRDb2xvciwKICAgICAgICAiZmlsbC1vcGFjaXR5IjogdGhpcy5fZGVmYXVsdE9wYWNpdHkKICAgICAgfSwKICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgaGlnaGxpZ2h0OiB0cnVlLAogICAgICAgIGZyZWU6IHRydWUKICAgICAgfSwKICAgICAgcGF0aDogewogICAgICAgIGQ6IHRoaXMuX2ZyZWVIaWdobGlnaHQudG9TVkdQYXRoKCkKICAgICAgfQogICAgfSwgdHJ1ZSwgdHJ1ZSkpOwogIH0KICBzdGF0aWMgI2hpZ2hsaWdodE1vdmUocGFyZW50LCBldmVudCkgewogICAgaWYgKHRoaXMuX2ZyZWVIaWdobGlnaHQuYWRkKGV2ZW50KSkgewogICAgICBwYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fZnJlZUhpZ2hsaWdodElkLCB7CiAgICAgICAgcGF0aDogewogICAgICAgICAgZDogdGhpcy5fZnJlZUhpZ2hsaWdodC50b1NWR1BhdGgoKQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogIHN0YXRpYyAjZW5kSGlnaGxpZ2h0KHBhcmVudCwgZXZlbnQpIHsKICAgIGlmICghdGhpcy5fZnJlZUhpZ2hsaWdodC5pc0VtcHR5KCkpIHsKICAgICAgcGFyZW50LmNyZWF0ZUFuZEFkZE5ld0VkaXRvcihldmVudCwgZmFsc2UsIHsKICAgICAgICBoaWdobGlnaHRJZDogdGhpcy5fZnJlZUhpZ2hsaWdodElkLAogICAgICAgIGhpZ2hsaWdodE91dGxpbmVzOiB0aGlzLl9mcmVlSGlnaGxpZ2h0LmdldE91dGxpbmVzKCksCiAgICAgICAgY2xpcFBhdGhJZDogdGhpcy5fZnJlZUhpZ2hsaWdodENsaXBJZCwKICAgICAgICBtZXRob2RPZkNyZWF0aW9uOiAibWFpbl90b29sYmFyIgogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHBhcmVudC5kcmF3TGF5ZXIucmVtb3ZlKHRoaXMuX2ZyZWVIaWdobGlnaHRJZCk7CiAgICB9CiAgICB0aGlzLl9mcmVlSGlnaGxpZ2h0SWQgPSAtMTsKICAgIHRoaXMuX2ZyZWVIaWdobGlnaHQgPSBudWxsOwogICAgdGhpcy5fZnJlZUhpZ2hsaWdodENsaXBJZCA9ICIiOwogIH0KICBzdGF0aWMgYXN5bmMgZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpIHsKICAgIGxldCBpbml0aWFsRGF0YTIgPSBudWxsOwogICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBIaWdobGlnaHRBbm5vdGF0aW9uRWxlbWVudCkgewogICAgICBjb25zdCB7CiAgICAgICAgZGF0YTogewogICAgICAgICAgcXVhZFBvaW50czogcXVhZFBvaW50czIsCiAgICAgICAgICByZWN0LAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBpZCwKICAgICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgICBvcGFjaXR5OiBvcGFjaXR5MiwKICAgICAgICAgIHBvcHVwUmVmLAogICAgICAgICAgcmljaFRleHQsCiAgICAgICAgICBjb250ZW50c09iaiwKICAgICAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgICAgICB9LAogICAgICAgIHBhcmVudDogewogICAgICAgICAgcGFnZTogewogICAgICAgICAgICBwYWdlTnVtYmVyCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9ID0gZGF0YTsKICAgICAgaW5pdGlhbERhdGEyID0gZGF0YSA9IHsKICAgICAgICBhbm5vdGF0aW9uVHlwZTogQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hULAogICAgICAgIGNvbG9yOiBBcnJheS5mcm9tKGNvbG9yMiksCiAgICAgICAgb3BhY2l0eTogb3BhY2l0eTIsCiAgICAgICAgcXVhZFBvaW50czogcXVhZFBvaW50czIsCiAgICAgICAgYm94ZXM6IG51bGwsCiAgICAgICAgcGFnZUluZGV4OiBwYWdlTnVtYmVyIC0gMSwKICAgICAgICByZWN0OiByZWN0LnNsaWNlKDApLAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGFubm90YXRpb25FbGVtZW50SWQ6IGlkLAogICAgICAgIGlkLAogICAgICAgIGRlbGV0ZWQ6IGZhbHNlLAogICAgICAgIHBvcHVwUmVmLAogICAgICAgIHJpY2hUZXh0LAogICAgICAgIGNvbW1lbnQ6IGNvbnRlbnRzT2JqPy5zdHIgfHwgbnVsbCwKICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgICB9OwogICAgfSBlbHNlIGlmIChkYXRhIGluc3RhbmNlb2YgSW5rQW5ub3RhdGlvbkVsZW1lbnQpIHsKICAgICAgY29uc3QgewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGlua0xpc3RzOiBpbmtMaXN0czIsCiAgICAgICAgICByZWN0LAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBpZCwKICAgICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgICBib3JkZXJTdHlsZTogewogICAgICAgICAgICByYXdXaWR0aDogdGhpY2tuZXNzCiAgICAgICAgICB9LAogICAgICAgICAgcG9wdXBSZWYsCiAgICAgICAgICByaWNoVGV4dCwKICAgICAgICAgIGNvbnRlbnRzT2JqLAogICAgICAgICAgY3JlYXRpb25EYXRlLAogICAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgICAgIH0sCiAgICAgICAgcGFyZW50OiB7CiAgICAgICAgICBwYWdlOiB7CiAgICAgICAgICAgIHBhZ2VOdW1iZXIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gPSBkYXRhOwogICAgICBpbml0aWFsRGF0YTIgPSBkYXRhID0gewogICAgICAgIGFubm90YXRpb25UeXBlOiBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQsCiAgICAgICAgY29sb3I6IEFycmF5LmZyb20oY29sb3IyKSwKICAgICAgICB0aGlja25lc3MsCiAgICAgICAgaW5rTGlzdHM6IGlua0xpc3RzMiwKICAgICAgICBib3hlczogbnVsbCwKICAgICAgICBwYWdlSW5kZXg6IHBhZ2VOdW1iZXIgLSAxLAogICAgICAgIHJlY3Q6IHJlY3Quc2xpY2UoMCksCiAgICAgICAgcm90YXRpb24sCiAgICAgICAgYW5ub3RhdGlvbkVsZW1lbnRJZDogaWQsCiAgICAgICAgaWQsCiAgICAgICAgZGVsZXRlZDogZmFsc2UsCiAgICAgICAgcG9wdXBSZWYsCiAgICAgICAgcmljaFRleHQsCiAgICAgICAgY29tbWVudDogY29udGVudHNPYmo/LnN0ciB8fCBudWxsLAogICAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgICBtb2RpZmljYXRpb25EYXRlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGNvbG9yLAogICAgICBxdWFkUG9pbnRzLAogICAgICBpbmtMaXN0cywKICAgICAgb3BhY2l0eQogICAgfSA9IGRhdGE7CiAgICBjb25zdCBlZGl0b3IgPSBhd2FpdCBzdXBlci5kZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcik7CiAgICBlZGl0b3IuY29sb3IgPSBVdGlsLm1ha2VIZXhDb2xvciguLi5jb2xvcik7CiAgICBlZGl0b3Iub3BhY2l0eSA9IG9wYWNpdHkgfHwgMTsKICAgIGlmIChpbmtMaXN0cykgewogICAgICBlZGl0b3IuI3RoaWNrbmVzcyA9IGRhdGEudGhpY2tuZXNzOwogICAgfQogICAgZWRpdG9yLl9pbml0aWFsRGF0YSA9IGluaXRpYWxEYXRhMjsKICAgIGlmIChkYXRhLmNvbW1lbnQpIHsKICAgICAgZWRpdG9yLnNldENvbW1lbnREYXRhKGRhdGEpOwogICAgfQogICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSBlZGl0b3IucGFnZURpbWVuc2lvbnM7CiAgICBjb25zdCBbcGFnZVgsIHBhZ2VZXSA9IGVkaXRvci5wYWdlVHJhbnNsYXRpb247CiAgICBpZiAocXVhZFBvaW50cykgewogICAgICBjb25zdCBib3hlcyA9IGVkaXRvci4jYm94ZXMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWFkUG9pbnRzLmxlbmd0aDsgaSArPSA4KSB7CiAgICAgICAgYm94ZXMucHVzaCh7CiAgICAgICAgICB4OiAocXVhZFBvaW50c1tpXSAtIHBhZ2VYKSAvIHBhZ2VXaWR0aCwKICAgICAgICAgIHk6IDEgLSAocXVhZFBvaW50c1tpICsgMV0gLSBwYWdlWSkgLyBwYWdlSGVpZ2h0LAogICAgICAgICAgd2lkdGg6IChxdWFkUG9pbnRzW2kgKyAyXSAtIHF1YWRQb2ludHNbaV0pIC8gcGFnZVdpZHRoLAogICAgICAgICAgaGVpZ2h0OiAocXVhZFBvaW50c1tpICsgMV0gLSBxdWFkUG9pbnRzW2kgKyA1XSkgLyBwYWdlSGVpZ2h0CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZWRpdG9yLiNjcmVhdGVPdXRsaW5lcygpOwogICAgICBlZGl0b3IuI2FkZFRvRHJhd0xheWVyKCk7CiAgICAgIGVkaXRvci5yb3RhdGUoZWRpdG9yLnJvdGF0aW9uKTsKICAgIH0gZWxzZSBpZiAoaW5rTGlzdHMpIHsKICAgICAgZWRpdG9yLiNpc0ZyZWVIaWdobGlnaHQgPSB0cnVlOwogICAgICBjb25zdCBwb2ludHMgPSBpbmtMaXN0c1swXTsKICAgICAgY29uc3QgcG9pbnQgPSB7CiAgICAgICAgeDogcG9pbnRzWzBdIC0gcGFnZVgsCiAgICAgICAgeTogcGFnZUhlaWdodCAtIChwb2ludHNbMV0gLSBwYWdlWSkKICAgICAgfTsKICAgICAgY29uc3Qgb3V0bGluZXIgPSBuZXcgRnJlZUhpZ2hsaWdodE91dGxpbmVyKHBvaW50LCBbMCwgMCwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSwgMSwgZWRpdG9yLiN0aGlja25lc3MgLyAyLCB0cnVlLCAxZS0zKTsKICAgICAgZm9yIChsZXQgaSA9IDAsIGlpID0gcG9pbnRzLmxlbmd0aDsgaSA8IGlpOyBpICs9IDIpIHsKICAgICAgICBwb2ludC54ID0gcG9pbnRzW2ldIC0gcGFnZVg7CiAgICAgICAgcG9pbnQueSA9IHBhZ2VIZWlnaHQgLSAocG9pbnRzW2kgKyAxXSAtIHBhZ2VZKTsKICAgICAgICBvdXRsaW5lci5hZGQocG9pbnQpOwogICAgICB9CiAgICAgIGNvbnN0IHsKICAgICAgICBpZCwKICAgICAgICBjbGlwUGF0aElkCiAgICAgIH0gPSBwYXJlbnQuZHJhd0xheWVyLmRyYXcoewogICAgICAgIGJib3g6IFswLCAwLCAxLCAxXSwKICAgICAgICByb290OiB7CiAgICAgICAgICB2aWV3Qm94OiAiMCAwIDEgMSIsCiAgICAgICAgICBmaWxsOiBlZGl0b3IuY29sb3IsCiAgICAgICAgICAiZmlsbC1vcGFjaXR5IjogZWRpdG9yLl9kZWZhdWx0T3BhY2l0eQogICAgICAgIH0sCiAgICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgICBoaWdobGlnaHQ6IHRydWUsCiAgICAgICAgICBmcmVlOiB0cnVlCiAgICAgICAgfSwKICAgICAgICBwYXRoOiB7CiAgICAgICAgICBkOiBvdXRsaW5lci50b1NWR1BhdGgoKQogICAgICAgIH0KICAgICAgfSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgIGVkaXRvci4jY3JlYXRlRnJlZU91dGxpbmVzKHsKICAgICAgICBoaWdobGlnaHRPdXRsaW5lczogb3V0bGluZXIuZ2V0T3V0bGluZXMoKSwKICAgICAgICBoaWdobGlnaHRJZDogaWQsCiAgICAgICAgY2xpcFBhdGhJZAogICAgICB9KTsKICAgICAgZWRpdG9yLiNhZGRUb0RyYXdMYXllcigpOwogICAgICBlZGl0b3Iucm90YXRlKGVkaXRvci5wYXJlbnRSb3RhdGlvbik7CiAgICB9CiAgICByZXR1cm4gZWRpdG9yOwogIH0KICBzZXJpYWxpemUoaXNGb3JDb3B5aW5nID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSB8fCBpc0ZvckNvcHlpbmcpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZURlbGV0ZWQoKTsKICAgIH0KICAgIGNvbnN0IGNvbG9yID0gQW5ub3RhdGlvbkVkaXRvci5fY29sb3JNYW5hZ2VyLmNvbnZlcnQodGhpcy5fdWlNYW5hZ2VyLmdldE5vbkhDTUNvbG9yKHRoaXMuY29sb3IpKTsKICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBzdXBlci5zZXJpYWxpemUoaXNGb3JDb3B5aW5nKTsKICAgIE9iamVjdC5hc3NpZ24oc2VyaWFsaXplZCwgewogICAgICBjb2xvciwKICAgICAgb3BhY2l0eTogdGhpcy5vcGFjaXR5LAogICAgICB0aGlja25lc3M6IHRoaXMuI3RoaWNrbmVzcywKICAgICAgcXVhZFBvaW50czogdGhpcy4jc2VyaWFsaXplQm94ZXMoKSwKICAgICAgb3V0bGluZXM6IHRoaXMuI3NlcmlhbGl6ZU91dGxpbmVzKHNlcmlhbGl6ZWQucmVjdCkKICAgIH0pOwogICAgdGhpcy5hZGRDb21tZW50KHNlcmlhbGl6ZWQpOwogICAgaWYgKHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCAmJiAhdGhpcy4jaGFzRWxlbWVudENoYW5nZWQoc2VyaWFsaXplZCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBzZXJpYWxpemVkLmlkID0gdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkOwogICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgfQogICNoYXNFbGVtZW50Q2hhbmdlZChzZXJpYWxpemVkKSB7CiAgICBjb25zdCB7CiAgICAgIGNvbG9yCiAgICB9ID0gdGhpcy5faW5pdGlhbERhdGE7CiAgICByZXR1cm4gdGhpcy5oYXNFZGl0ZWRDb21tZW50IHx8IHNlcmlhbGl6ZWQuY29sb3Iuc29tZSgoYywgaSkgPT4gYyAhPT0gY29sb3JbaV0pOwogIH0KICByZW5kZXJBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKSB7CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIGFubm90YXRpb24uaGlkZSgpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGFubm90YXRpb24udXBkYXRlRWRpdGVkKHsKICAgICAgcmVjdDogdGhpcy5nZXRQREZSZWN0KCksCiAgICAgIHBvcHVwOiB0aGlzLmNvbW1lbnQKICAgIH0pOwogICAgcmV0dXJuIG51bGw7CiAgfQogIHN0YXRpYyBjYW5DcmVhdGVOZXdFbXB0eUVkaXRvcigpIHsKICAgIHJldHVybiBmYWxzZTsKICB9Cn07CnZhciBEcmF3aW5nT3B0aW9ucyA9IGNsYXNzIHsKICAjc3ZnUHJvcGVydGllcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogIHVwZGF0ZVByb3BlcnR5KG5hbWUsIHZhbHVlKSB7CiAgICB0aGlzW25hbWVdID0gdmFsdWU7CiAgICB0aGlzLnVwZGF0ZVNWR1Byb3BlcnR5KG5hbWUsIHZhbHVlKTsKICB9CiAgdXBkYXRlUHJvcGVydGllcyhwcm9wZXJ0aWVzKSB7CiAgICBpZiAoIXByb3BlcnRpZXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHByb3BlcnRpZXMpKSB7CiAgICAgIGlmICghbmFtZS5zdGFydHNXaXRoKCJfIikpIHsKICAgICAgICB0aGlzLnVwZGF0ZVByb3BlcnR5KG5hbWUsIHZhbHVlKTsKICAgICAgfQogICAgfQogIH0KICB1cGRhdGVTVkdQcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgdGhpcy4jc3ZnUHJvcGVydGllc1tuYW1lXSA9IHZhbHVlOwogIH0KICB0b1NWR1Byb3BlcnRpZXMoKSB7CiAgICBjb25zdCByb290MiA9IHRoaXMuI3N2Z1Byb3BlcnRpZXM7CiAgICB0aGlzLiNzdmdQcm9wZXJ0aWVzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICByZXR1cm4gewogICAgICByb290OiByb290MgogICAgfTsKICB9CiAgcmVzZXQoKSB7CiAgICB0aGlzLiNzdmdQcm9wZXJ0aWVzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfQogIHVwZGF0ZUFsbChvcHRpb25zID0gdGhpcykgewogICAgdGhpcy51cGRhdGVQcm9wZXJ0aWVzKG9wdGlvbnMpOwogIH0KICBjbG9uZSgpIHsKICAgIHVucmVhY2hhYmxlKCJOb3QgaW1wbGVtZW50ZWQiKTsKICB9Cn07CnZhciBEcmF3aW5nRWRpdG9yID0gY2xhc3MgX0RyYXdpbmdFZGl0b3IgZXh0ZW5kcyBBbm5vdGF0aW9uRWRpdG9yIHsKICAjZHJhd091dGxpbmVzID0gbnVsbDsKICAjbXVzdEJlQ29tbWl0dGVkOwogIF9jb2xvclBpY2tlciA9IG51bGw7CiAgX2RyYXdJZCA9IG51bGw7CiAgc3RhdGljIF9jdXJyZW50RHJhd0lkID0gLTE7CiAgc3RhdGljIF9jdXJyZW50UGFyZW50ID0gbnVsbDsKICBzdGF0aWMgI2N1cnJlbnREcmF3ID0gbnVsbDsKICBzdGF0aWMgI2N1cnJlbnREcmF3aW5nQUMgPSBudWxsOwogIHN0YXRpYyAjY3VycmVudERyYXdpbmdPcHRpb25zID0gbnVsbDsKICBzdGF0aWMgX0lOTkVSX01BUkdJTiA9IDM7CiAgY29uc3RydWN0b3IocGFyYW1zKSB7CiAgICBzdXBlcihwYXJhbXMpOwogICAgdGhpcy4jbXVzdEJlQ29tbWl0dGVkID0gcGFyYW1zLm11c3RCZUNvbW1pdHRlZCB8fCBmYWxzZTsKICAgIHRoaXMuX2FkZE91dGxpbmVzKHBhcmFtcyk7CiAgfQogIG9uVXBkYXRlZENvbG9yKCkgewogICAgdGhpcy5fY29sb3JQaWNrZXI/LnVwZGF0ZSh0aGlzLmNvbG9yKTsKICAgIHN1cGVyLm9uVXBkYXRlZENvbG9yKCk7CiAgfQogIF9hZGRPdXRsaW5lcyhwYXJhbXMpIHsKICAgIGlmIChwYXJhbXMuZHJhd091dGxpbmVzKSB7CiAgICAgIHRoaXMuI2NyZWF0ZURyYXdPdXRsaW5lcyhwYXJhbXMpOwogICAgICB0aGlzLiNhZGRUb0RyYXdMYXllcigpOwogICAgfQogIH0KICAjY3JlYXRlRHJhd091dGxpbmVzKHsKICAgIGRyYXdPdXRsaW5lcywKICAgIGRyYXdJZCwKICAgIGRyYXdpbmdPcHRpb25zCiAgfSkgewogICAgdGhpcy4jZHJhd091dGxpbmVzID0gZHJhd091dGxpbmVzOwogICAgdGhpcy5fZHJhd2luZ09wdGlvbnMgfHw9IGRyYXdpbmdPcHRpb25zOwogICAgaWYgKCF0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLmExMXlBbGVydChgcGRmanMtZWRpdG9yLSR7dGhpcy5lZGl0b3JUeXBlfS1hZGRlZC1hbGVydGApOwogICAgfQogICAgaWYgKGRyYXdJZCA+PSAwKSB7CiAgICAgIHRoaXMuX2RyYXdJZCA9IGRyYXdJZDsKICAgICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLmZpbmFsaXplRHJhdyhkcmF3SWQsIGRyYXdPdXRsaW5lcy5kZWZhdWx0UHJvcGVydGllcyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9kcmF3SWQgPSB0aGlzLiNjcmVhdGVEcmF3aW5nKGRyYXdPdXRsaW5lcywgdGhpcy5wYXJlbnQpOwogICAgfQogICAgdGhpcy4jdXBkYXRlQmJveChkcmF3T3V0bGluZXMuYm94KTsKICB9CiAgI2NyZWF0ZURyYXdpbmcoZHJhd091dGxpbmVzLCBwYXJlbnQpIHsKICAgIGNvbnN0IHsKICAgICAgaWQKICAgIH0gPSBwYXJlbnQuZHJhd0xheWVyLmRyYXcoX0RyYXdpbmdFZGl0b3IuX21lcmdlU1ZHUHJvcGVydGllcyh0aGlzLl9kcmF3aW5nT3B0aW9ucy50b1NWR1Byb3BlcnRpZXMoKSwgZHJhd091dGxpbmVzLmRlZmF1bHRTVkdQcm9wZXJ0aWVzKSwgZmFsc2UsIGZhbHNlKTsKICAgIHJldHVybiBpZDsKICB9CiAgc3RhdGljIF9tZXJnZVNWR1Byb3BlcnRpZXMocDEsIHAyKSB7CiAgICBjb25zdCBwMUtleXMgPSBuZXcgU2V0KE9iamVjdC5rZXlzKHAxKSk7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwMikpIHsKICAgICAgaWYgKHAxS2V5cy5oYXMoa2V5KSkgewogICAgICAgIE9iamVjdC5hc3NpZ24ocDFba2V5XSwgdmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHAxW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHAxOwogIH0KICBzdGF0aWMgZ2V0RGVmYXVsdERyYXdpbmdPcHRpb25zKF9vcHRpb25zKSB7CiAgICB1bnJlYWNoYWJsZSgiTm90IGltcGxlbWVudGVkIik7CiAgfQogIHN0YXRpYyBnZXQgdHlwZXNNYXAoKSB7CiAgICB1bnJlYWNoYWJsZSgiTm90IGltcGxlbWVudGVkIik7CiAgfQogIHN0YXRpYyBnZXQgaXNEcmF3ZXIoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgc3RhdGljIGdldCBzdXBwb3J0TXVsdGlwbGVEcmF3aW5ncygpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgc3RhdGljIHVwZGF0ZURlZmF1bHRQYXJhbXModHlwZSwgdmFsdWUpIHsKICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHRoaXMudHlwZXNNYXAuZ2V0KHR5cGUpOwogICAgaWYgKHByb3BlcnR5TmFtZSkgewogICAgICB0aGlzLl9kZWZhdWx0RHJhd2luZ09wdGlvbnMudXBkYXRlUHJvcGVydHkocHJvcGVydHlOYW1lLCB2YWx1ZSk7CiAgICB9CiAgICBpZiAodGhpcy5fY3VycmVudFBhcmVudCkgewogICAgICBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcudXBkYXRlUHJvcGVydHkocHJvcGVydHlOYW1lLCB2YWx1ZSk7CiAgICAgIHRoaXMuX2N1cnJlbnRQYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fY3VycmVudERyYXdJZCwgdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zLnRvU1ZHUHJvcGVydGllcygpKTsKICAgIH0KICB9CiAgdXBkYXRlUGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSB0aGlzLmNvbnN0cnVjdG9yLnR5cGVzTWFwLmdldCh0eXBlKTsKICAgIGlmIChwcm9wZXJ0eU5hbWUpIHsKICAgICAgdGhpcy5fdXBkYXRlUHJvcGVydHkodHlwZSwgcHJvcGVydHlOYW1lLCB2YWx1ZSk7CiAgICB9CiAgfQogIHN0YXRpYyBnZXQgZGVmYXVsdFByb3BlcnRpZXNUb1VwZGF0ZSgpIHsKICAgIGNvbnN0IHByb3BlcnRpZXMgPSBbXTsKICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLl9kZWZhdWx0RHJhd2luZ09wdGlvbnM7CiAgICBmb3IgKGNvbnN0IFt0eXBlLCBuYW1lXSBvZiB0aGlzLnR5cGVzTWFwKSB7CiAgICAgIHByb3BlcnRpZXMucHVzaChbdHlwZSwgb3B0aW9uc1tuYW1lXV0pOwogICAgfQogICAgcmV0dXJuIHByb3BlcnRpZXM7CiAgfQogIGdldCBwcm9wZXJ0aWVzVG9VcGRhdGUoKSB7CiAgICBjb25zdCBwcm9wZXJ0aWVzID0gW107CiAgICBjb25zdCB7CiAgICAgIF9kcmF3aW5nT3B0aW9ucwogICAgfSA9IHRoaXM7CiAgICBmb3IgKGNvbnN0IFt0eXBlLCBuYW1lXSBvZiB0aGlzLmNvbnN0cnVjdG9yLnR5cGVzTWFwKSB7CiAgICAgIHByb3BlcnRpZXMucHVzaChbdHlwZSwgX2RyYXdpbmdPcHRpb25zW25hbWVdXSk7CiAgICB9CiAgICByZXR1cm4gcHJvcGVydGllczsKICB9CiAgX3VwZGF0ZVByb3BlcnR5KHR5cGUsIG5hbWUsIHZhbHVlKSB7CiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5fZHJhd2luZ09wdGlvbnM7CiAgICBjb25zdCBzYXZlZFZhbHVlID0gb3B0aW9uc1tuYW1lXTsKICAgIGNvbnN0IHNldHRlciA9ICh2YWwpID0+IHsKICAgICAgb3B0aW9ucy51cGRhdGVQcm9wZXJ0eShuYW1lLCB2YWwpOwogICAgICBjb25zdCBiYm94ID0gdGhpcy4jZHJhd091dGxpbmVzLnVwZGF0ZVByb3BlcnR5KG5hbWUsIHZhbCk7CiAgICAgIGlmIChiYm94KSB7CiAgICAgICAgdGhpcy4jdXBkYXRlQmJveChiYm94KTsKICAgICAgfQogICAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fZHJhd0lkLCBvcHRpb25zLnRvU1ZHUHJvcGVydGllcygpKTsKICAgICAgaWYgKHR5cGUgPT09IHRoaXMuY29sb3JUeXBlKSB7CiAgICAgICAgdGhpcy5vblVwZGF0ZWRDb2xvcigpOwogICAgICB9CiAgICB9OwogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZDogc2V0dGVyLmJpbmQodGhpcywgdmFsdWUpLAogICAgICB1bmRvOiBzZXR0ZXIuYmluZCh0aGlzLCBzYXZlZFZhbHVlKSwKICAgICAgcG9zdDogdGhpcy5fdWlNYW5hZ2VyLnVwZGF0ZVVJLmJpbmQodGhpcy5fdWlNYW5hZ2VyLCB0aGlzKSwKICAgICAgbXVzdEV4ZWM6IHRydWUsCiAgICAgIHR5cGUsCiAgICAgIG92ZXJ3cml0ZUlmU2FtZVR5cGU6IHRydWUsCiAgICAgIGtlZXBVbmRvOiB0cnVlCiAgICB9KTsKICB9CiAgX29uUmVzaXppbmcoKSB7CiAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fZHJhd0lkLCBfRHJhd2luZ0VkaXRvci5fbWVyZ2VTVkdQcm9wZXJ0aWVzKHRoaXMuI2RyYXdPdXRsaW5lcy5nZXRQYXRoUmVzaXppbmdTVkdQcm9wZXJ0aWVzKHRoaXMuI2NvbnZlcnRUb0RyYXdTcGFjZSgpKSwgewogICAgICBiYm94OiB0aGlzLiNyb3RhdGVCb3goKQogICAgfSkpOwogIH0KICBfb25SZXNpemVkKCkgewogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2RyYXdJZCwgX0RyYXdpbmdFZGl0b3IuX21lcmdlU1ZHUHJvcGVydGllcyh0aGlzLiNkcmF3T3V0bGluZXMuZ2V0UGF0aFJlc2l6ZWRTVkdQcm9wZXJ0aWVzKHRoaXMuI2NvbnZlcnRUb0RyYXdTcGFjZSgpKSwgewogICAgICBiYm94OiB0aGlzLiNyb3RhdGVCb3goKQogICAgfSkpOwogIH0KICBfb25UcmFuc2xhdGluZyhfeCwgX3kpIHsKICAgIHRoaXMucGFyZW50Py5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9kcmF3SWQsIHsKICAgICAgYmJveDogdGhpcy4jcm90YXRlQm94KCkKICAgIH0pOwogIH0KICBfb25UcmFuc2xhdGVkKCkgewogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2RyYXdJZCwgX0RyYXdpbmdFZGl0b3IuX21lcmdlU1ZHUHJvcGVydGllcyh0aGlzLiNkcmF3T3V0bGluZXMuZ2V0UGF0aFRyYW5zbGF0ZWRTVkdQcm9wZXJ0aWVzKHRoaXMuI2NvbnZlcnRUb0RyYXdTcGFjZSgpLCB0aGlzLnBhcmVudERpbWVuc2lvbnMpLCB7CiAgICAgIGJib3g6IHRoaXMuI3JvdGF0ZUJveCgpCiAgICB9KSk7CiAgfQogIF9vblN0YXJ0RHJhZ2dpbmcoKSB7CiAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fZHJhd0lkLCB7CiAgICAgIHJvb3RDbGFzczogewogICAgICAgIG1vdmluZzogdHJ1ZQogICAgICB9CiAgICB9KTsKICB9CiAgX29uU3RvcERyYWdnaW5nKCkgewogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2RyYXdJZCwgewogICAgICByb290Q2xhc3M6IHsKICAgICAgICBtb3Zpbmc6IGZhbHNlCiAgICAgIH0KICAgIH0pOwogIH0KICBjb21taXQoKSB7CiAgICBzdXBlci5jb21taXQoKTsKICAgIHRoaXMuZGlzYWJsZUVkaXRNb2RlKCk7CiAgICB0aGlzLmRpc2FibGVFZGl0aW5nKCk7CiAgfQogIGRpc2FibGVFZGl0aW5nKCkgewogICAgc3VwZXIuZGlzYWJsZUVkaXRpbmcoKTsKICAgIHRoaXMuZGl2LmNsYXNzTGlzdC50b2dnbGUoImRpc2FibGVkIiwgdHJ1ZSk7CiAgfQogIGVuYWJsZUVkaXRpbmcoKSB7CiAgICBzdXBlci5lbmFibGVFZGl0aW5nKCk7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJkaXNhYmxlZCIsIGZhbHNlKTsKICB9CiAgZ2V0QmFzZVRyYW5zbGF0aW9uKCkgewogICAgcmV0dXJuIFswLCAwXTsKICB9CiAgZ2V0IGlzUmVzaXphYmxlKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIG9uY2VBZGRlZChmb2N1cykgewogICAgaWYgKCF0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgdGhpcy5wYXJlbnQuYWRkVW5kb2FibGVFZGl0b3IodGhpcyk7CiAgICB9CiAgICB0aGlzLl9pc0RyYWdnYWJsZSA9IHRydWU7CiAgICBpZiAodGhpcy4jbXVzdEJlQ29tbWl0dGVkKSB7CiAgICAgIHRoaXMuI211c3RCZUNvbW1pdHRlZCA9IGZhbHNlOwogICAgICB0aGlzLmNvbW1pdCgpOwogICAgICB0aGlzLnBhcmVudC5zZXRTZWxlY3RlZCh0aGlzKTsKICAgICAgaWYgKGZvY3VzICYmIHRoaXMuaXNPblNjcmVlbikgewogICAgICAgIHRoaXMuZGl2LmZvY3VzKCk7CiAgICAgIH0KICAgIH0KICB9CiAgcmVtb3ZlKCkgewogICAgdGhpcy4jY2xlYW5EcmF3TGF5ZXIoKTsKICAgIHN1cGVyLnJlbW92ZSgpOwogIH0KICByZWJ1aWxkKCkgewogICAgaWYgKCF0aGlzLnBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5yZWJ1aWxkKCk7CiAgICBpZiAodGhpcy5kaXYgPT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jYWRkVG9EcmF3TGF5ZXIoKTsKICAgIHRoaXMuI3VwZGF0ZUJib3godGhpcy4jZHJhd091dGxpbmVzLmJveCk7CiAgICBpZiAoIXRoaXMuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIHRoaXMucGFyZW50LmFkZCh0aGlzKTsKICAgIH0KICB9CiAgc2V0UGFyZW50KHBhcmVudCkgewogICAgbGV0IG11c3RCZVNlbGVjdGVkID0gZmFsc2U7CiAgICBpZiAodGhpcy5wYXJlbnQgJiYgIXBhcmVudCkgewogICAgICB0aGlzLl91aU1hbmFnZXIucmVtb3ZlU2hvdWxkUmVzY2FsZSh0aGlzKTsKICAgICAgdGhpcy4jY2xlYW5EcmF3TGF5ZXIoKTsKICAgIH0gZWxzZSBpZiAocGFyZW50KSB7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5hZGRTaG91bGRSZXNjYWxlKHRoaXMpOwogICAgICB0aGlzLiNhZGRUb0RyYXdMYXllcihwYXJlbnQpOwogICAgICBtdXN0QmVTZWxlY3RlZCA9ICF0aGlzLnBhcmVudCAmJiB0aGlzLmRpdj8uY2xhc3NMaXN0LmNvbnRhaW5zKCJzZWxlY3RlZEVkaXRvciIpOwogICAgfQogICAgc3VwZXIuc2V0UGFyZW50KHBhcmVudCk7CiAgICBpZiAobXVzdEJlU2VsZWN0ZWQpIHsKICAgICAgdGhpcy5zZWxlY3QoKTsKICAgIH0KICB9CiAgI2NsZWFuRHJhd0xheWVyKCkgewogICAgaWYgKHRoaXMuX2RyYXdJZCA9PT0gbnVsbCB8fCAhdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLnJlbW92ZSh0aGlzLl9kcmF3SWQpOwogICAgdGhpcy5fZHJhd0lkID0gbnVsbDsKICAgIHRoaXMuX2RyYXdpbmdPcHRpb25zLnJlc2V0KCk7CiAgfQogICNhZGRUb0RyYXdMYXllcihwYXJlbnQgPSB0aGlzLnBhcmVudCkgewogICAgaWYgKHRoaXMuX2RyYXdJZCAhPT0gbnVsbCAmJiB0aGlzLnBhcmVudCA9PT0gcGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLl9kcmF3SWQgIT09IG51bGwpIHsKICAgICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVBhcmVudCh0aGlzLl9kcmF3SWQsIHBhcmVudC5kcmF3TGF5ZXIpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9kcmF3aW5nT3B0aW9ucy51cGRhdGVBbGwoKTsKICAgIHRoaXMuX2RyYXdJZCA9IHRoaXMuI2NyZWF0ZURyYXdpbmcodGhpcy4jZHJhd091dGxpbmVzLCBwYXJlbnQpOwogIH0KICAjY29udmVydFRvUGFyZW50U3BhY2UoW3gsIHksIHdpZHRoLCBoZWlnaHRdKSB7CiAgICBjb25zdCB7CiAgICAgIHBhcmVudERpbWVuc2lvbnM6IFtwVywgcEhdLAogICAgICByb3RhdGlvbgogICAgfSA9IHRoaXM7CiAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgcmV0dXJuIFt5LCAxIC0geCwgd2lkdGggKiAocEggLyBwVyksIGhlaWdodCAqIChwVyAvIHBIKV07CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiBbMSAtIHgsIDEgLSB5LCB3aWR0aCwgaGVpZ2h0XTsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmV0dXJuIFsxIC0geSwgeCwgd2lkdGggKiAocEggLyBwVyksIGhlaWdodCAqIChwVyAvIHBIKV07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIFt4LCB5LCB3aWR0aCwgaGVpZ2h0XTsKICAgIH0KICB9CiAgI2NvbnZlcnRUb0RyYXdTcGFjZSgpIHsKICAgIGNvbnN0IHsKICAgICAgeCwKICAgICAgeSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgcGFyZW50RGltZW5zaW9uczogW3BXLCBwSF0sCiAgICAgIHJvdGF0aW9uCiAgICB9ID0gdGhpczsKICAgIHN3aXRjaCAocm90YXRpb24pIHsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXR1cm4gWzEgLSB5LCB4LCB3aWR0aCAqIChwVyAvIHBIKSwgaGVpZ2h0ICogKHBIIC8gcFcpXTsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcmV0dXJuIFsxIC0geCwgMSAtIHksIHdpZHRoLCBoZWlnaHRdOwogICAgICBjYXNlIDI3MDoKICAgICAgICByZXR1cm4gW3ksIDEgLSB4LCB3aWR0aCAqIChwVyAvIHBIKSwgaGVpZ2h0ICogKHBIIC8gcFcpXTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gW3gsIHksIHdpZHRoLCBoZWlnaHRdOwogICAgfQogIH0KICAjdXBkYXRlQmJveChiYm94KSB7CiAgICBbdGhpcy54LCB0aGlzLnksIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0XSA9IHRoaXMuI2NvbnZlcnRUb1BhcmVudFNwYWNlKGJib3gpOwogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICAgICAgdGhpcy5zZXREaW1zKCk7CiAgICB9CiAgICB0aGlzLl9vblJlc2l6ZWQoKTsKICB9CiAgI3JvdGF0ZUJveCgpIHsKICAgIGNvbnN0IHsKICAgICAgeCwKICAgICAgeSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgcm90YXRpb24sCiAgICAgIHBhcmVudFJvdGF0aW9uLAogICAgICBwYXJlbnREaW1lbnNpb25zOiBbcFcsIHBIXQogICAgfSA9IHRoaXM7CiAgICBzd2l0Y2ggKChyb3RhdGlvbiAqIDQgKyBwYXJlbnRSb3RhdGlvbikgLyA5MCkgewogICAgICBjYXNlIDE6CiAgICAgICAgcmV0dXJuIFsxIC0geSAtIGhlaWdodCwgeCwgaGVpZ2h0LCB3aWR0aF07CiAgICAgIGNhc2UgMjoKICAgICAgICByZXR1cm4gWzEgLSB4IC0gd2lkdGgsIDEgLSB5IC0gaGVpZ2h0LCB3aWR0aCwgaGVpZ2h0XTsKICAgICAgY2FzZSAzOgogICAgICAgIHJldHVybiBbeSwgMSAtIHggLSB3aWR0aCwgaGVpZ2h0LCB3aWR0aF07CiAgICAgIGNhc2UgNDoKICAgICAgICByZXR1cm4gW3gsIHkgLSB3aWR0aCAqIChwVyAvIHBIKSwgaGVpZ2h0ICogKHBIIC8gcFcpLCB3aWR0aCAqIChwVyAvIHBIKV07CiAgICAgIGNhc2UgNToKICAgICAgICByZXR1cm4gWzEgLSB5LCB4LCB3aWR0aCAqIChwVyAvIHBIKSwgaGVpZ2h0ICogKHBIIC8gcFcpXTsKICAgICAgY2FzZSA2OgogICAgICAgIHJldHVybiBbMSAtIHggLSBoZWlnaHQgKiAocEggLyBwVyksIDEgLSB5LCBoZWlnaHQgKiAocEggLyBwVyksIHdpZHRoICogKHBXIC8gcEgpXTsKICAgICAgY2FzZSA3OgogICAgICAgIHJldHVybiBbeSAtIHdpZHRoICogKHBXIC8gcEgpLCAxIC0geCAtIGhlaWdodCAqIChwSCAvIHBXKSwgd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKV07CiAgICAgIGNhc2UgODoKICAgICAgICByZXR1cm4gW3ggLSB3aWR0aCwgeSAtIGhlaWdodCwgd2lkdGgsIGhlaWdodF07CiAgICAgIGNhc2UgOToKICAgICAgICByZXR1cm4gWzEgLSB5LCB4IC0gd2lkdGgsIGhlaWdodCwgd2lkdGhdOwogICAgICBjYXNlIDEwOgogICAgICAgIHJldHVybiBbMSAtIHgsIDEgLSB5LCB3aWR0aCwgaGVpZ2h0XTsKICAgICAgY2FzZSAxMToKICAgICAgICByZXR1cm4gW3kgLSBoZWlnaHQsIDEgLSB4LCBoZWlnaHQsIHdpZHRoXTsKICAgICAgY2FzZSAxMjoKICAgICAgICByZXR1cm4gW3ggLSBoZWlnaHQgKiAocEggLyBwVyksIHksIGhlaWdodCAqIChwSCAvIHBXKSwgd2lkdGggKiAocFcgLyBwSCldOwogICAgICBjYXNlIDEzOgogICAgICAgIHJldHVybiBbMSAtIHkgLSB3aWR0aCAqIChwVyAvIHBIKSwgeCAtIGhlaWdodCAqIChwSCAvIHBXKSwgd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKV07CiAgICAgIGNhc2UgMTQ6CiAgICAgICAgcmV0dXJuIFsxIC0geCwgMSAtIHkgLSB3aWR0aCAqIChwVyAvIHBIKSwgaGVpZ2h0ICogKHBIIC8gcFcpLCB3aWR0aCAqIChwVyAvIHBIKV07CiAgICAgIGNhc2UgMTU6CiAgICAgICAgcmV0dXJuIFt5LCAxIC0geCwgd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKV07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIFt4LCB5LCB3aWR0aCwgaGVpZ2h0XTsKICAgIH0KICB9CiAgcm90YXRlKCkgewogICAgaWYgKCF0aGlzLnBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9kcmF3SWQsIF9EcmF3aW5nRWRpdG9yLl9tZXJnZVNWR1Byb3BlcnRpZXMoewogICAgICBiYm94OiB0aGlzLiNyb3RhdGVCb3goKQogICAgfSwgdGhpcy4jZHJhd091dGxpbmVzLnVwZGF0ZVJvdGF0aW9uKCh0aGlzLnBhcmVudFJvdGF0aW9uIC0gdGhpcy5yb3RhdGlvbiArIDM2MCkgJSAzNjApKSk7CiAgfQogIG9uU2NhbGVDaGFuZ2luZygpIHsKICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jdXBkYXRlQmJveCh0aGlzLiNkcmF3T3V0bGluZXMudXBkYXRlUGFyZW50RGltZW5zaW9ucyh0aGlzLnBhcmVudERpbWVuc2lvbnMsIHRoaXMucGFyZW50LnNjYWxlKSk7CiAgfQogIHN0YXRpYyBvblNjYWxlQ2hhbmdpbmdXaGVuRHJhd2luZygpIHsKICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHJldHVybiB0aGlzLmRpdjsKICAgIH0KICAgIGxldCBiYXNlWCwgYmFzZVk7CiAgICBpZiAodGhpcy5faXNDb3B5KSB7CiAgICAgIGJhc2VYID0gdGhpcy54OwogICAgICBiYXNlWSA9IHRoaXMueTsKICAgIH0KICAgIGNvbnN0IGRpdiA9IHN1cGVyLnJlbmRlcigpOwogICAgZGl2LmNsYXNzTGlzdC5hZGQoImRyYXciKTsKICAgIGNvbnN0IGRyYXdEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5hcHBlbmQoZHJhd0Rpdik7CiAgICBkcmF3RGl2LnNldEF0dHJpYnV0ZSgiYXJpYS1oaWRkZW4iLCAidHJ1ZSIpOwogICAgZHJhd0Rpdi5jbGFzc05hbWUgPSAiaW50ZXJuYWwiOwogICAgdGhpcy5zZXREaW1zKCk7CiAgICB0aGlzLl91aU1hbmFnZXIuYWRkU2hvdWxkUmVzY2FsZSh0aGlzKTsKICAgIHRoaXMuZGlzYWJsZUVkaXRpbmcoKTsKICAgIGlmICh0aGlzLl9pc0NvcHkpIHsKICAgICAgdGhpcy5fbW92ZUFmdGVyUGFzdGUoYmFzZVgsIGJhc2VZKTsKICAgIH0KICAgIHJldHVybiBkaXY7CiAgfQogIHN0YXRpYyBjcmVhdGVEcmF3ZXJJbnN0YW5jZShfeCwgX3ksIF9wYXJlbnRXaWR0aCwgX3BhcmVudEhlaWdodCwgX3JvdGF0aW9uKSB7CiAgICB1bnJlYWNoYWJsZSgiTm90IGltcGxlbWVudGVkIik7CiAgfQogIHN0YXRpYyBzdGFydERyYXdpbmcocGFyZW50LCB1aU1hbmFnZXIsIF9pc0xUUiwgZXZlbnQpIHsKICAgIGNvbnN0IHsKICAgICAgdGFyZ2V0LAogICAgICBvZmZzZXRYOiB4LAogICAgICBvZmZzZXRZOiB5LAogICAgICBwb2ludGVySWQsCiAgICAgIHBvaW50ZXJUeXBlCiAgICB9ID0gZXZlbnQ7CiAgICBpZiAoQ3VycmVudFBvaW50ZXJzLmlzSW5pdGlhbGl6ZWRBbmREaWZmZXJlbnRQb2ludGVyVHlwZShwb2ludGVyVHlwZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICB2aWV3cG9ydDogewogICAgICAgIHJvdGF0aW9uCiAgICAgIH0KICAgIH0gPSBwYXJlbnQ7CiAgICBjb25zdCB7CiAgICAgIHdpZHRoOiBwYXJlbnRXaWR0aCwKICAgICAgaGVpZ2h0OiBwYXJlbnRIZWlnaHQKICAgIH0gPSB0YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCBhYyA9IF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhd2luZ0FDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gcGFyZW50LmNvbWJpbmVkU2lnbmFsKGFjKTsKICAgIEN1cnJlbnRQb2ludGVycy5zZXRQb2ludGVyKHBvaW50ZXJUeXBlLCBwb2ludGVySWQpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIChlKSA9PiB7CiAgICAgIGlmIChDdXJyZW50UG9pbnRlcnMuaXNTYW1lUG9pbnRlcklkT3JSZW1vdmUoZS5wb2ludGVySWQpKSB7CiAgICAgICAgdGhpcy5fZW5kRHJhdyhlKTsKICAgICAgfQogICAgfSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJjYW5jZWwiLCAoZSkgPT4gewogICAgICBpZiAoQ3VycmVudFBvaW50ZXJzLmlzU2FtZVBvaW50ZXJJZE9yUmVtb3ZlKGUucG9pbnRlcklkKSkgewogICAgICAgIHRoaXMuX2N1cnJlbnRQYXJlbnQuZW5kRHJhd2luZ1Nlc3Npb24oKTsKICAgICAgfQogICAgfSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgKGUpID0+IHsKICAgICAgaWYgKCFDdXJyZW50UG9pbnRlcnMuaXNTYW1lUG9pbnRlclR5cGUoZS5wb2ludGVyVHlwZSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgQ3VycmVudFBvaW50ZXJzLmluaXRpYWxpemVBbmRBZGRQb2ludGVySWQoZS5wb2ludGVySWQpOwogICAgICBpZiAoX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3LmlzQ2FuY2VsbGFibGUoKSkgewogICAgICAgIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdy5yZW1vdmVMYXN0RWxlbWVudCgpOwogICAgICAgIGlmIChfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcuaXNFbXB0eSgpKSB7CiAgICAgICAgICB0aGlzLl9jdXJyZW50UGFyZW50LmVuZERyYXdpbmdTZXNzaW9uKHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9lbmREcmF3KG51bGwpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgewogICAgICBjYXB0dXJlOiB0cnVlLAogICAgICBwYXNzaXZlOiBmYWxzZSwKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIG5vQ29udGV4dE1lbnUsIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybW92ZSIsIHRoaXMuX2RyYXdNb3ZlLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaG1vdmUiLCAoZSkgPT4gewogICAgICBpZiAoQ3VycmVudFBvaW50ZXJzLmlzU2FtZVRpbWVTdGFtcChlLnRpbWVTdGFtcCkpIHsKICAgICAgICBzdG9wRXZlbnQoZSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHBhcmVudC50b2dnbGVEcmF3aW5nKCk7CiAgICB1aU1hbmFnZXIuX2VkaXRvclVuZG9CYXI/LmhpZGUoKTsKICAgIGlmIChfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcpIHsKICAgICAgcGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2N1cnJlbnREcmF3SWQsIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdy5zdGFydE5ldyh4LCB5LCBwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0LCByb3RhdGlvbikpOwogICAgICByZXR1cm47CiAgICB9CiAgICB1aU1hbmFnZXIudXBkYXRlVUlGb3JEZWZhdWx0UHJvcGVydGllcyh0aGlzKTsKICAgIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdyA9IHRoaXMuY3JlYXRlRHJhd2VySW5zdGFuY2UoeCwgeSwgcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodCwgcm90YXRpb24pOwogICAgX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3aW5nT3B0aW9ucyA9IHRoaXMuZ2V0RGVmYXVsdERyYXdpbmdPcHRpb25zKCk7CiAgICB0aGlzLl9jdXJyZW50UGFyZW50ID0gcGFyZW50OwogICAgKHsKICAgICAgaWQ6IHRoaXMuX2N1cnJlbnREcmF3SWQKICAgIH0gPSBwYXJlbnQuZHJhd0xheWVyLmRyYXcodGhpcy5fbWVyZ2VTVkdQcm9wZXJ0aWVzKF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhd2luZ09wdGlvbnMudG9TVkdQcm9wZXJ0aWVzKCksIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdy5kZWZhdWx0U1ZHUHJvcGVydGllcyksIHRydWUsIGZhbHNlKSk7CiAgfQogIHN0YXRpYyBfZHJhd01vdmUoZXZlbnQpIHsKICAgIEN1cnJlbnRQb2ludGVycy5pc1NhbWVUaW1lU3RhbXAoZXZlbnQudGltZVN0YW1wKTsKICAgIGlmICghX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgb2Zmc2V0WCwKICAgICAgb2Zmc2V0WSwKICAgICAgcG9pbnRlcklkCiAgICB9ID0gZXZlbnQ7CiAgICBpZiAoIUN1cnJlbnRQb2ludGVycy5pc1NhbWVQb2ludGVySWQocG9pbnRlcklkKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoQ3VycmVudFBvaW50ZXJzLmlzVXNpbmdNdWx0aXBsZVBvaW50ZXJzKCkpIHsKICAgICAgdGhpcy5fZW5kRHJhdyhldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2N1cnJlbnRQYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fY3VycmVudERyYXdJZCwgX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3LmFkZChvZmZzZXRYLCBvZmZzZXRZKSk7CiAgICBDdXJyZW50UG9pbnRlcnMuc2V0VGltZVN0YW1wKGV2ZW50LnRpbWVTdGFtcCk7CiAgICBzdG9wRXZlbnQoZXZlbnQpOwogIH0KICBzdGF0aWMgX2NsZWFudXAoYWxsKSB7CiAgICBpZiAoYWxsKSB7CiAgICAgIHRoaXMuX2N1cnJlbnREcmF3SWQgPSAtMTsKICAgICAgdGhpcy5fY3VycmVudFBhcmVudCA9IG51bGw7CiAgICAgIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdyA9IG51bGw7CiAgICAgIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhd2luZ09wdGlvbnMgPSBudWxsOwogICAgICBDdXJyZW50UG9pbnRlcnMuY2xlYXJUaW1lU3RhbXAoKTsKICAgIH0KICAgIGlmIChfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXdpbmdBQykgewogICAgICBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXdpbmdBQy5hYm9ydCgpOwogICAgICBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXdpbmdBQyA9IG51bGw7CiAgICAgIEN1cnJlbnRQb2ludGVycy5jbGVhclBvaW50ZXJJZHMoKTsKICAgIH0KICB9CiAgc3RhdGljIF9lbmREcmF3KGV2ZW50KSB7CiAgICBjb25zdCBwYXJlbnQgPSB0aGlzLl9jdXJyZW50UGFyZW50OwogICAgaWYgKCFwYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcGFyZW50LnRvZ2dsZURyYXdpbmcodHJ1ZSk7CiAgICB0aGlzLl9jbGVhbnVwKGZhbHNlKTsKICAgIGlmIChldmVudD8udGFyZ2V0ID09PSBwYXJlbnQuZGl2KSB7CiAgICAgIHBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9jdXJyZW50RHJhd0lkLCBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcuZW5kKGV2ZW50Lm9mZnNldFgsIGV2ZW50Lm9mZnNldFkpKTsKICAgIH0KICAgIGlmICh0aGlzLnN1cHBvcnRNdWx0aXBsZURyYXdpbmdzKSB7CiAgICAgIGNvbnN0IGRyYXcgPSBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXc7CiAgICAgIGNvbnN0IGRyYXdJZCA9IHRoaXMuX2N1cnJlbnREcmF3SWQ7CiAgICAgIGNvbnN0IGxhc3RFbGVtZW50ID0gZHJhdy5nZXRMYXN0RWxlbWVudCgpOwogICAgICBwYXJlbnQuYWRkQ29tbWFuZHMoewogICAgICAgIGNtZDogKCkgPT4gewogICAgICAgICAgcGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKGRyYXdJZCwgZHJhdy5zZXRMYXN0RWxlbWVudChsYXN0RWxlbWVudCkpOwogICAgICAgIH0sCiAgICAgICAgdW5kbzogKCkgPT4gewogICAgICAgICAgcGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKGRyYXdJZCwgZHJhdy5yZW1vdmVMYXN0RWxlbWVudCgpKTsKICAgICAgICB9LAogICAgICAgIG11c3RFeGVjOiBmYWxzZSwKICAgICAgICB0eXBlOiBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5EUkFXX1NURVAKICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuZW5kRHJhd2luZyhmYWxzZSk7CiAgfQogIHN0YXRpYyBlbmREcmF3aW5nKGlzQWJvcnRlZCkgewogICAgY29uc3QgcGFyZW50ID0gdGhpcy5fY3VycmVudFBhcmVudDsKICAgIGlmICghcGFyZW50KSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcGFyZW50LnRvZ2dsZURyYXdpbmcodHJ1ZSk7CiAgICBwYXJlbnQuY2xlYW5VbmRvU3RhY2soQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRFJBV19TVEVQKTsKICAgIGlmICghX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3LmlzRW1wdHkoKSkgewogICAgICBjb25zdCB7CiAgICAgICAgcGFnZURpbWVuc2lvbnM6IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdLAogICAgICAgIHNjYWxlCiAgICAgIH0gPSBwYXJlbnQ7CiAgICAgIGNvbnN0IGVkaXRvciA9IHBhcmVudC5jcmVhdGVBbmRBZGROZXdFZGl0b3IoewogICAgICAgIG9mZnNldFg6IDAsCiAgICAgICAgb2Zmc2V0WTogMAogICAgICB9LCBmYWxzZSwgewogICAgICAgIGRyYXdJZDogdGhpcy5fY3VycmVudERyYXdJZCwKICAgICAgICBkcmF3T3V0bGluZXM6IF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdy5nZXRPdXRsaW5lcyhwYWdlV2lkdGggKiBzY2FsZSwgcGFnZUhlaWdodCAqIHNjYWxlLCBzY2FsZSwgdGhpcy5fSU5ORVJfTUFSR0lOKSwKICAgICAgICBkcmF3aW5nT3B0aW9uczogX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3aW5nT3B0aW9ucywKICAgICAgICBtdXN0QmVDb21taXR0ZWQ6ICFpc0Fib3J0ZWQKICAgICAgfSk7CiAgICAgIHRoaXMuX2NsZWFudXAodHJ1ZSk7CiAgICAgIHJldHVybiBlZGl0b3I7CiAgICB9CiAgICBwYXJlbnQuZHJhd0xheWVyLnJlbW92ZSh0aGlzLl9jdXJyZW50RHJhd0lkKTsKICAgIHRoaXMuX2NsZWFudXAodHJ1ZSk7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgY3JlYXRlRHJhd2luZ09wdGlvbnMoX2RhdGEpIHsKICB9CiAgc3RhdGljIGRlc2VyaWFsaXplRHJhdyhfcGFnZVgsIF9wYWdlWSwgX3BhZ2VXaWR0aCwgX3BhZ2VIZWlnaHQsIF9pbm5lcldpZHRoLCBfZGF0YSkgewogICAgdW5yZWFjaGFibGUoIk5vdCBpbXBsZW1lbnRlZCIpOwogIH0KICBzdGF0aWMgYXN5bmMgZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpIHsKICAgIGNvbnN0IHsKICAgICAgcmF3RGltczogewogICAgICAgIHBhZ2VXaWR0aCwKICAgICAgICBwYWdlSGVpZ2h0LAogICAgICAgIHBhZ2VYLAogICAgICAgIHBhZ2VZCiAgICAgIH0KICAgIH0gPSBwYXJlbnQudmlld3BvcnQ7CiAgICBjb25zdCBkcmF3T3V0bGluZXMgPSB0aGlzLmRlc2VyaWFsaXplRHJhdyhwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgdGhpcy5fSU5ORVJfTUFSR0lOLCBkYXRhKTsKICAgIGNvbnN0IGVkaXRvciA9IGF3YWl0IHN1cGVyLmRlc2VyaWFsaXplKGRhdGEsIHBhcmVudCwgdWlNYW5hZ2VyKTsKICAgIGVkaXRvci5jcmVhdGVEcmF3aW5nT3B0aW9ucyhkYXRhKTsKICAgIGVkaXRvci4jY3JlYXRlRHJhd091dGxpbmVzKHsKICAgICAgZHJhd091dGxpbmVzCiAgICB9KTsKICAgIGVkaXRvci4jYWRkVG9EcmF3TGF5ZXIoKTsKICAgIGVkaXRvci5vblNjYWxlQ2hhbmdpbmcoKTsKICAgIGVkaXRvci5yb3RhdGUoKTsKICAgIHJldHVybiBlZGl0b3I7CiAgfQogIHNlcmlhbGl6ZURyYXcoaXNGb3JDb3B5aW5nKSB7CiAgICBjb25zdCBbcGFnZVgsIHBhZ2VZXSA9IHRoaXMucGFnZVRyYW5zbGF0aW9uOwogICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhZ2VEaW1lbnNpb25zOwogICAgcmV0dXJuIHRoaXMuI2RyYXdPdXRsaW5lcy5zZXJpYWxpemUoW3BhZ2VYLCBwYWdlWSwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSwgaXNGb3JDb3B5aW5nKTsKICB9CiAgcmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbikgewogICAgYW5ub3RhdGlvbi51cGRhdGVFZGl0ZWQoewogICAgICByZWN0OiB0aGlzLmdldFBERlJlY3QoKQogICAgfSk7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgc3RhdGljIGNhbkNyZWF0ZU5ld0VtcHR5RWRpdG9yKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfTsKdmFyIElua0RyYXdPdXRsaW5lciA9IGNsYXNzIHsKICAjbGFzdCA9IG5ldyBGbG9hdDY0QXJyYXkoNik7CiAgI2xpbmU7CiAgI2xpbmVzOwogICNyb3RhdGlvbjsKICAjdGhpY2tuZXNzOwogICNwb2ludHM7CiAgI2xhc3RTVkdQYXRoID0gIiI7CiAgI2xhc3RJbmRleCA9IDA7CiAgI291dGxpbmVzID0gbmV3IElua0RyYXdPdXRsaW5lKCk7CiAgI3BhcmVudFdpZHRoOwogICNwYXJlbnRIZWlnaHQ7CiAgY29uc3RydWN0b3IoeCwgeSwgcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodCwgcm90YXRpb24sIHRoaWNrbmVzcykgewogICAgdGhpcy4jcGFyZW50V2lkdGggPSBwYXJlbnRXaWR0aDsKICAgIHRoaXMuI3BhcmVudEhlaWdodCA9IHBhcmVudEhlaWdodDsKICAgIHRoaXMuI3JvdGF0aW9uID0gcm90YXRpb247CiAgICB0aGlzLiN0aGlja25lc3MgPSB0aGlja25lc3M7CiAgICBbeCwgeV0gPSB0aGlzLiNub3JtYWxpemVQb2ludCh4LCB5KTsKICAgIGNvbnN0IGxpbmUgPSB0aGlzLiNsaW5lID0gW05hTiwgTmFOLCBOYU4sIE5hTiwgeCwgeV07CiAgICB0aGlzLiNwb2ludHMgPSBbeCwgeV07CiAgICB0aGlzLiNsaW5lcyA9IFt7CiAgICAgIGxpbmUsCiAgICAgIHBvaW50czogdGhpcy4jcG9pbnRzCiAgICB9XTsKICAgIHRoaXMuI2xhc3Quc2V0KGxpbmUsIDApOwogIH0KICB1cGRhdGVQcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgaWYgKG5hbWUgPT09ICJzdHJva2Utd2lkdGgiKSB7CiAgICAgIHRoaXMuI3RoaWNrbmVzcyA9IHZhbHVlOwogICAgfQogIH0KICAjbm9ybWFsaXplUG9pbnQoeCwgeSkgewogICAgcmV0dXJuIE91dGxpbmUuX25vcm1hbGl6ZVBvaW50KHgsIHksIHRoaXMuI3BhcmVudFdpZHRoLCB0aGlzLiNwYXJlbnRIZWlnaHQsIHRoaXMuI3JvdGF0aW9uKTsKICB9CiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiAhdGhpcy4jbGluZXMgfHwgdGhpcy4jbGluZXMubGVuZ3RoID09PSAwOwogIH0KICBpc0NhbmNlbGxhYmxlKCkgewogICAgcmV0dXJuIHRoaXMuI3BvaW50cy5sZW5ndGggPD0gMTA7CiAgfQogIGFkZCh4LCB5KSB7CiAgICBbeCwgeV0gPSB0aGlzLiNub3JtYWxpemVQb2ludCh4LCB5KTsKICAgIGNvbnN0IFt4MSwgeTEsIHgyLCB5Ml0gPSB0aGlzLiNsYXN0LnN1YmFycmF5KDIsIDYpOwogICAgY29uc3QgZGlmZlggPSB4IC0geDI7CiAgICBjb25zdCBkaWZmWSA9IHkgLSB5MjsKICAgIGNvbnN0IGQgPSBNYXRoLmh5cG90KHRoaXMuI3BhcmVudFdpZHRoICogZGlmZlgsIHRoaXMuI3BhcmVudEhlaWdodCAqIGRpZmZZKTsKICAgIGlmIChkIDw9IDIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB0aGlzLiNwb2ludHMucHVzaCh4LCB5KTsKICAgIGlmIChpc05hTih4MSkpIHsKICAgICAgdGhpcy4jbGFzdC5zZXQoW3gyLCB5MiwgeCwgeV0sIDIpOwogICAgICB0aGlzLiNsaW5lLnB1c2goTmFOLCBOYU4sIE5hTiwgTmFOLCB4LCB5KTsKICAgICAgcmV0dXJuIHsKICAgICAgICBwYXRoOiB7CiAgICAgICAgICBkOiB0aGlzLnRvU1ZHUGF0aCgpCiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgaWYgKGlzTmFOKHRoaXMuI2xhc3RbMF0pKSB7CiAgICAgIHRoaXMuI2xpbmUuc3BsaWNlKDYsIDYpOwogICAgfQogICAgdGhpcy4jbGFzdC5zZXQoW3gxLCB5MSwgeDIsIHkyLCB4LCB5XSwgMCk7CiAgICB0aGlzLiNsaW5lLnB1c2goLi4uT3V0bGluZS5jcmVhdGVCZXppZXJQb2ludHMoeDEsIHkxLCB4MiwgeTIsIHgsIHkpKTsKICAgIHJldHVybiB7CiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLnRvU1ZHUGF0aCgpCiAgICAgIH0KICAgIH07CiAgfQogIGVuZCh4LCB5KSB7CiAgICBjb25zdCBjaGFuZ2UgPSB0aGlzLmFkZCh4LCB5KTsKICAgIGlmIChjaGFuZ2UpIHsKICAgICAgcmV0dXJuIGNoYW5nZTsKICAgIH0KICAgIGlmICh0aGlzLiNwb2ludHMubGVuZ3RoID09PSAyKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcGF0aDogewogICAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBzdGFydE5ldyh4LCB5LCBwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0LCByb3RhdGlvbikgewogICAgdGhpcy4jcGFyZW50V2lkdGggPSBwYXJlbnRXaWR0aDsKICAgIHRoaXMuI3BhcmVudEhlaWdodCA9IHBhcmVudEhlaWdodDsKICAgIHRoaXMuI3JvdGF0aW9uID0gcm90YXRpb247CiAgICBbeCwgeV0gPSB0aGlzLiNub3JtYWxpemVQb2ludCh4LCB5KTsKICAgIGNvbnN0IGxpbmUgPSB0aGlzLiNsaW5lID0gW05hTiwgTmFOLCBOYU4sIE5hTiwgeCwgeV07CiAgICB0aGlzLiNwb2ludHMgPSBbeCwgeV07CiAgICBjb25zdCBsYXN0ID0gdGhpcy4jbGluZXMuYXQoLTEpOwogICAgaWYgKGxhc3QpIHsKICAgICAgbGFzdC5saW5lID0gbmV3IEZsb2F0MzJBcnJheShsYXN0LmxpbmUpOwogICAgICBsYXN0LnBvaW50cyA9IG5ldyBGbG9hdDMyQXJyYXkobGFzdC5wb2ludHMpOwogICAgfQogICAgdGhpcy4jbGluZXMucHVzaCh7CiAgICAgIGxpbmUsCiAgICAgIHBvaW50czogdGhpcy4jcG9pbnRzCiAgICB9KTsKICAgIHRoaXMuI2xhc3Quc2V0KGxpbmUsIDApOwogICAgdGhpcy4jbGFzdEluZGV4ID0gMDsKICAgIHRoaXMudG9TVkdQYXRoKCk7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZ2V0TGFzdEVsZW1lbnQoKSB7CiAgICByZXR1cm4gdGhpcy4jbGluZXMuYXQoLTEpOwogIH0KICBzZXRMYXN0RWxlbWVudChlbGVtZW50KSB7CiAgICBpZiAoIXRoaXMuI2xpbmVzKSB7CiAgICAgIHJldHVybiB0aGlzLiNvdXRsaW5lcy5zZXRMYXN0RWxlbWVudChlbGVtZW50KTsKICAgIH0KICAgIHRoaXMuI2xpbmVzLnB1c2goZWxlbWVudCk7CiAgICB0aGlzLiNsaW5lID0gZWxlbWVudC5saW5lOwogICAgdGhpcy4jcG9pbnRzID0gZWxlbWVudC5wb2ludHM7CiAgICB0aGlzLiNsYXN0SW5kZXggPSAwOwogICAgcmV0dXJuIHsKICAgICAgcGF0aDogewogICAgICAgIGQ6IHRoaXMudG9TVkdQYXRoKCkKICAgICAgfQogICAgfTsKICB9CiAgcmVtb3ZlTGFzdEVsZW1lbnQoKSB7CiAgICBpZiAoIXRoaXMuI2xpbmVzKSB7CiAgICAgIHJldHVybiB0aGlzLiNvdXRsaW5lcy5yZW1vdmVMYXN0RWxlbWVudCgpOwogICAgfQogICAgdGhpcy4jbGluZXMucG9wKCk7CiAgICB0aGlzLiNsYXN0U1ZHUGF0aCA9ICIiOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gdGhpcy4jbGluZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICBjb25zdCB7CiAgICAgICAgbGluZSwKICAgICAgICBwb2ludHMKICAgICAgfSA9IHRoaXMuI2xpbmVzW2ldOwogICAgICB0aGlzLiNsaW5lID0gbGluZTsKICAgICAgdGhpcy4jcG9pbnRzID0gcG9pbnRzOwogICAgICB0aGlzLiNsYXN0SW5kZXggPSAwOwogICAgICB0aGlzLnRvU1ZHUGF0aCgpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcGF0aDogewogICAgICAgIGQ6IHRoaXMuI2xhc3RTVkdQYXRoCiAgICAgIH0KICAgIH07CiAgfQogIHRvU1ZHUGF0aCgpIHsKICAgIGNvbnN0IGZpcnN0WCA9IE91dGxpbmUuc3ZnUm91bmQodGhpcy4jbGluZVs0XSk7CiAgICBjb25zdCBmaXJzdFkgPSBPdXRsaW5lLnN2Z1JvdW5kKHRoaXMuI2xpbmVbNV0pOwogICAgaWYgKHRoaXMuI3BvaW50cy5sZW5ndGggPT09IDIpIHsKICAgICAgdGhpcy4jbGFzdFNWR1BhdGggPSBgJHt0aGlzLiNsYXN0U1ZHUGF0aH0gTSAke2ZpcnN0WH0gJHtmaXJzdFl9IFpgOwogICAgICByZXR1cm4gdGhpcy4jbGFzdFNWR1BhdGg7CiAgICB9CiAgICBpZiAodGhpcy4jcG9pbnRzLmxlbmd0aCA8PSA2KSB7CiAgICAgIGNvbnN0IGkgPSB0aGlzLiNsYXN0U1ZHUGF0aC5sYXN0SW5kZXhPZigiTSIpOwogICAgICB0aGlzLiNsYXN0U1ZHUGF0aCA9IGAke3RoaXMuI2xhc3RTVkdQYXRoLnNsaWNlKDAsIGkpfSBNICR7Zmlyc3RYfSAke2ZpcnN0WX1gOwogICAgICB0aGlzLiNsYXN0SW5kZXggPSA2OwogICAgfQogICAgaWYgKHRoaXMuI3BvaW50cy5sZW5ndGggPT09IDQpIHsKICAgICAgY29uc3Qgc2Vjb25kWCA9IE91dGxpbmUuc3ZnUm91bmQodGhpcy4jbGluZVsxMF0pOwogICAgICBjb25zdCBzZWNvbmRZID0gT3V0bGluZS5zdmdSb3VuZCh0aGlzLiNsaW5lWzExXSk7CiAgICAgIHRoaXMuI2xhc3RTVkdQYXRoID0gYCR7dGhpcy4jbGFzdFNWR1BhdGh9IEwgJHtzZWNvbmRYfSAke3NlY29uZFl9YDsKICAgICAgdGhpcy4jbGFzdEluZGV4ID0gMTI7CiAgICAgIHJldHVybiB0aGlzLiNsYXN0U1ZHUGF0aDsKICAgIH0KICAgIGNvbnN0IGJ1ZmZlciA9IFtdOwogICAgaWYgKHRoaXMuI2xhc3RJbmRleCA9PT0gMCkgewogICAgICBidWZmZXIucHVzaChgTSAke2ZpcnN0WH0gJHtmaXJzdFl9YCk7CiAgICAgIHRoaXMuI2xhc3RJbmRleCA9IDY7CiAgICB9CiAgICBmb3IgKGxldCBpID0gdGhpcy4jbGFzdEluZGV4LCBpaSA9IHRoaXMuI2xpbmUubGVuZ3RoOyBpIDwgaWk7IGkgKz0gNikgewogICAgICBjb25zdCBbYzF4LCBjMXksIGMyeCwgYzJ5LCB4LCB5XSA9IHRoaXMuI2xpbmUuc2xpY2UoaSwgaSArIDYpLm1hcChPdXRsaW5lLnN2Z1JvdW5kKTsKICAgICAgYnVmZmVyLnB1c2goYEMke2MxeH0gJHtjMXl9ICR7YzJ4fSAke2MyeX0gJHt4fSAke3l9YCk7CiAgICB9CiAgICB0aGlzLiNsYXN0U1ZHUGF0aCArPSBidWZmZXIuam9pbigiICIpOwogICAgdGhpcy4jbGFzdEluZGV4ID0gdGhpcy4jbGluZS5sZW5ndGg7CiAgICByZXR1cm4gdGhpcy4jbGFzdFNWR1BhdGg7CiAgfQogIGdldE91dGxpbmVzKHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHQsIHNjYWxlLCBpbm5lck1hcmdpbikgewogICAgY29uc3QgbGFzdCA9IHRoaXMuI2xpbmVzLmF0KC0xKTsKICAgIGxhc3QubGluZSA9IG5ldyBGbG9hdDMyQXJyYXkobGFzdC5saW5lKTsKICAgIGxhc3QucG9pbnRzID0gbmV3IEZsb2F0MzJBcnJheShsYXN0LnBvaW50cyk7CiAgICB0aGlzLiNvdXRsaW5lcy5idWlsZCh0aGlzLiNsaW5lcywgcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodCwgc2NhbGUsIHRoaXMuI3JvdGF0aW9uLCB0aGlzLiN0aGlja25lc3MsIGlubmVyTWFyZ2luKTsKICAgIHRoaXMuI2xhc3QgPSBudWxsOwogICAgdGhpcy4jbGluZSA9IG51bGw7CiAgICB0aGlzLiNsaW5lcyA9IG51bGw7CiAgICB0aGlzLiNsYXN0U1ZHUGF0aCA9IG51bGw7CiAgICByZXR1cm4gdGhpcy4jb3V0bGluZXM7CiAgfQogIGdldCBkZWZhdWx0U1ZHUHJvcGVydGllcygpIHsKICAgIHJldHVybiB7CiAgICAgIHJvb3Q6IHsKICAgICAgICB2aWV3Qm94OiAiMCAwIDEwMDAwIDEwMDAwIgogICAgICB9LAogICAgICByb290Q2xhc3M6IHsKICAgICAgICBkcmF3OiB0cnVlCiAgICAgIH0sCiAgICAgIGJib3g6IFswLCAwLCAxLCAxXQogICAgfTsKICB9Cn07CnZhciBJbmtEcmF3T3V0bGluZSA9IGNsYXNzIGV4dGVuZHMgT3V0bGluZSB7CiAgI2Jib3g7CiAgI2N1cnJlbnRSb3RhdGlvbiA9IDA7CiAgI2lubmVyTWFyZ2luOwogICNsaW5lczsKICAjcGFyZW50V2lkdGg7CiAgI3BhcmVudEhlaWdodDsKICAjcGFyZW50U2NhbGU7CiAgI3JvdGF0aW9uOwogICN0aGlja25lc3M7CiAgYnVpbGQobGluZXMsIHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHQsIHBhcmVudFNjYWxlLCByb3RhdGlvbiwgdGhpY2tuZXNzLCBpbm5lck1hcmdpbikgewogICAgdGhpcy4jcGFyZW50V2lkdGggPSBwYXJlbnRXaWR0aDsKICAgIHRoaXMuI3BhcmVudEhlaWdodCA9IHBhcmVudEhlaWdodDsKICAgIHRoaXMuI3BhcmVudFNjYWxlID0gcGFyZW50U2NhbGU7CiAgICB0aGlzLiNyb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgdGhpcy4jdGhpY2tuZXNzID0gdGhpY2tuZXNzOwogICAgdGhpcy4jaW5uZXJNYXJnaW4gPSBpbm5lck1hcmdpbiA/PyAwOwogICAgdGhpcy4jbGluZXMgPSBsaW5lczsKICAgIHRoaXMuI2NvbXB1dGVCYm94KCk7CiAgfQogIGdldCB0aGlja25lc3MoKSB7CiAgICByZXR1cm4gdGhpcy4jdGhpY2tuZXNzOwogIH0KICBzZXRMYXN0RWxlbWVudChlbGVtZW50KSB7CiAgICB0aGlzLiNsaW5lcy5wdXNoKGVsZW1lbnQpOwogICAgcmV0dXJuIHsKICAgICAgcGF0aDogewogICAgICAgIGQ6IHRoaXMudG9TVkdQYXRoKCkKICAgICAgfQogICAgfTsKICB9CiAgcmVtb3ZlTGFzdEVsZW1lbnQoKSB7CiAgICB0aGlzLiNsaW5lcy5wb3AoKTsKICAgIHJldHVybiB7CiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLnRvU1ZHUGF0aCgpCiAgICAgIH0KICAgIH07CiAgfQogIHRvU1ZHUGF0aCgpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IFtdOwogICAgZm9yIChjb25zdCB7CiAgICAgIGxpbmUKICAgIH0gb2YgdGhpcy4jbGluZXMpIHsKICAgICAgYnVmZmVyLnB1c2goYE0ke091dGxpbmUuc3ZnUm91bmQobGluZVs0XSl9ICR7T3V0bGluZS5zdmdSb3VuZChsaW5lWzVdKX1gKTsKICAgICAgaWYgKGxpbmUubGVuZ3RoID09PSA2KSB7CiAgICAgICAgYnVmZmVyLnB1c2goIloiKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAobGluZS5sZW5ndGggPT09IDEyICYmIGlzTmFOKGxpbmVbNl0pKSB7CiAgICAgICAgYnVmZmVyLnB1c2goYEwke091dGxpbmUuc3ZnUm91bmQobGluZVsxMF0pfSAke091dGxpbmUuc3ZnUm91bmQobGluZVsxMV0pfWApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSA2LCBpaSA9IGxpbmUubGVuZ3RoOyBpIDwgaWk7IGkgKz0gNikgewogICAgICAgIGNvbnN0IFtjMXgsIGMxeSwgYzJ4LCBjMnksIHgsIHldID0gbGluZS5zdWJhcnJheShpLCBpICsgNikubWFwKE91dGxpbmUuc3ZnUm91bmQpOwogICAgICAgIGJ1ZmZlci5wdXNoKGBDJHtjMXh9ICR7YzF5fSAke2MyeH0gJHtjMnl9ICR7eH0gJHt5fWApOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYnVmZmVyLmpvaW4oIiIpOwogIH0KICBzZXJpYWxpemUoW3BhZ2VYLCBwYWdlWSwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSwgaXNGb3JDb3B5aW5nKSB7CiAgICBjb25zdCBzZXJpYWxpemVkTGluZXMgPSBbXTsKICAgIGNvbnN0IHNlcmlhbGl6ZWRQb2ludHMgPSBbXTsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuI2dldEJCb3hXaXRoTm9NYXJnaW4oKTsKICAgIGxldCB0eCwgdHksIHN4LCBzeSwgeDEsIHkxLCB4MiwgeTIsIHJlc2NhbGVGbjsKICAgIHN3aXRjaCAodGhpcy4jcm90YXRpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJlc2NhbGVGbiA9IE91dGxpbmUuX3Jlc2NhbGU7CiAgICAgICAgdHggPSBwYWdlWDsKICAgICAgICB0eSA9IHBhZ2VZICsgcGFnZUhlaWdodDsKICAgICAgICBzeCA9IHBhZ2VXaWR0aDsKICAgICAgICBzeSA9IC1wYWdlSGVpZ2h0OwogICAgICAgIHgxID0gcGFnZVggKyB4ICogcGFnZVdpZHRoOwogICAgICAgIHkxID0gcGFnZVkgKyAoMSAtIHkgLSBoZWlnaHQpICogcGFnZUhlaWdodDsKICAgICAgICB4MiA9IHBhZ2VYICsgKHggKyB3aWR0aCkgKiBwYWdlV2lkdGg7CiAgICAgICAgeTIgPSBwYWdlWSArICgxIC0geSkgKiBwYWdlSGVpZ2h0OwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDkwOgogICAgICAgIHJlc2NhbGVGbiA9IE91dGxpbmUuX3Jlc2NhbGVBbmRTd2FwOwogICAgICAgIHR4ID0gcGFnZVg7CiAgICAgICAgdHkgPSBwYWdlWTsKICAgICAgICBzeCA9IHBhZ2VXaWR0aDsKICAgICAgICBzeSA9IHBhZ2VIZWlnaHQ7CiAgICAgICAgeDEgPSBwYWdlWCArIHkgKiBwYWdlV2lkdGg7CiAgICAgICAgeTEgPSBwYWdlWSArIHggKiBwYWdlSGVpZ2h0OwogICAgICAgIHgyID0gcGFnZVggKyAoeSArIGhlaWdodCkgKiBwYWdlV2lkdGg7CiAgICAgICAgeTIgPSBwYWdlWSArICh4ICsgd2lkdGgpICogcGFnZUhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcmVzY2FsZUZuID0gT3V0bGluZS5fcmVzY2FsZTsKICAgICAgICB0eCA9IHBhZ2VYICsgcGFnZVdpZHRoOwogICAgICAgIHR5ID0gcGFnZVk7CiAgICAgICAgc3ggPSAtcGFnZVdpZHRoOwogICAgICAgIHN5ID0gcGFnZUhlaWdodDsKICAgICAgICB4MSA9IHBhZ2VYICsgKDEgLSB4IC0gd2lkdGgpICogcGFnZVdpZHRoOwogICAgICAgIHkxID0gcGFnZVkgKyB5ICogcGFnZUhlaWdodDsKICAgICAgICB4MiA9IHBhZ2VYICsgKDEgLSB4KSAqIHBhZ2VXaWR0aDsKICAgICAgICB5MiA9IHBhZ2VZICsgKHkgKyBoZWlnaHQpICogcGFnZUhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmVzY2FsZUZuID0gT3V0bGluZS5fcmVzY2FsZUFuZFN3YXA7CiAgICAgICAgdHggPSBwYWdlWCArIHBhZ2VXaWR0aDsKICAgICAgICB0eSA9IHBhZ2VZICsgcGFnZUhlaWdodDsKICAgICAgICBzeCA9IC1wYWdlV2lkdGg7CiAgICAgICAgc3kgPSAtcGFnZUhlaWdodDsKICAgICAgICB4MSA9IHBhZ2VYICsgKDEgLSB5IC0gaGVpZ2h0KSAqIHBhZ2VXaWR0aDsKICAgICAgICB5MSA9IHBhZ2VZICsgKDEgLSB4IC0gd2lkdGgpICogcGFnZUhlaWdodDsKICAgICAgICB4MiA9IHBhZ2VYICsgKDEgLSB5KSAqIHBhZ2VXaWR0aDsKICAgICAgICB5MiA9IHBhZ2VZICsgKDEgLSB4KSAqIHBhZ2VIZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsKICAgICAgbGluZSwKICAgICAgcG9pbnRzCiAgICB9IG9mIHRoaXMuI2xpbmVzKSB7CiAgICAgIHNlcmlhbGl6ZWRMaW5lcy5wdXNoKHJlc2NhbGVGbihsaW5lLCB0eCwgdHksIHN4LCBzeSwgaXNGb3JDb3B5aW5nID8gbmV3IEFycmF5KGxpbmUubGVuZ3RoKSA6IG51bGwpKTsKICAgICAgc2VyaWFsaXplZFBvaW50cy5wdXNoKHJlc2NhbGVGbihwb2ludHMsIHR4LCB0eSwgc3gsIHN5LCBpc0ZvckNvcHlpbmcgPyBuZXcgQXJyYXkocG9pbnRzLmxlbmd0aCkgOiBudWxsKSk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBsaW5lczogc2VyaWFsaXplZExpbmVzLAogICAgICBwb2ludHM6IHNlcmlhbGl6ZWRQb2ludHMsCiAgICAgIHJlY3Q6IFt4MSwgeTEsIHgyLCB5Ml0KICAgIH07CiAgfQogIHN0YXRpYyBkZXNlcmlhbGl6ZShwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgaW5uZXJNYXJnaW4sIHsKICAgIHBhdGhzOiB7CiAgICAgIGxpbmVzLAogICAgICBwb2ludHMKICAgIH0sCiAgICByb3RhdGlvbiwKICAgIHRoaWNrbmVzcwogIH0pIHsKICAgIGNvbnN0IG5ld0xpbmVzID0gW107CiAgICBsZXQgdHgsIHR5LCBzeCwgc3ksIHJlc2NhbGVGbjsKICAgIHN3aXRjaCAocm90YXRpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIHJlc2NhbGVGbiA9IE91dGxpbmUuX3Jlc2NhbGU7CiAgICAgICAgdHggPSAtcGFnZVggLyBwYWdlV2lkdGg7CiAgICAgICAgdHkgPSBwYWdlWSAvIHBhZ2VIZWlnaHQgKyAxOwogICAgICAgIHN4ID0gMSAvIHBhZ2VXaWR0aDsKICAgICAgICBzeSA9IC0xIC8gcGFnZUhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXNjYWxlRm4gPSBPdXRsaW5lLl9yZXNjYWxlQW5kU3dhcDsKICAgICAgICB0eCA9IC1wYWdlWSAvIHBhZ2VIZWlnaHQ7CiAgICAgICAgdHkgPSAtcGFnZVggLyBwYWdlV2lkdGg7CiAgICAgICAgc3ggPSAxIC8gcGFnZUhlaWdodDsKICAgICAgICBzeSA9IDEgLyBwYWdlV2lkdGg7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJlc2NhbGVGbiA9IE91dGxpbmUuX3Jlc2NhbGU7CiAgICAgICAgdHggPSBwYWdlWCAvIHBhZ2VXaWR0aCArIDE7CiAgICAgICAgdHkgPSAtcGFnZVkgLyBwYWdlSGVpZ2h0OwogICAgICAgIHN4ID0gLTEgLyBwYWdlV2lkdGg7CiAgICAgICAgc3kgPSAxIC8gcGFnZUhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmVzY2FsZUZuID0gT3V0bGluZS5fcmVzY2FsZUFuZFN3YXA7CiAgICAgICAgdHggPSBwYWdlWSAvIHBhZ2VIZWlnaHQgKyAxOwogICAgICAgIHR5ID0gcGFnZVggLyBwYWdlV2lkdGggKyAxOwogICAgICAgIHN4ID0gLTEgLyBwYWdlSGVpZ2h0OwogICAgICAgIHN5ID0gLTEgLyBwYWdlV2lkdGg7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBpZiAoIWxpbmVzKSB7CiAgICAgIGxpbmVzID0gW107CiAgICAgIGZvciAoY29uc3QgcG9pbnQgb2YgcG9pbnRzKSB7CiAgICAgICAgY29uc3QgbGVuID0gcG9pbnQubGVuZ3RoOwogICAgICAgIGlmIChsZW4gPT09IDIpIHsKICAgICAgICAgIGxpbmVzLnB1c2gobmV3IEZsb2F0MzJBcnJheShbTmFOLCBOYU4sIE5hTiwgTmFOLCBwb2ludFswXSwgcG9pbnRbMV1dKSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGxlbiA9PT0gNCkgewogICAgICAgICAgbGluZXMucHVzaChuZXcgRmxvYXQzMkFycmF5KFtOYU4sIE5hTiwgTmFOLCBOYU4sIHBvaW50WzBdLCBwb2ludFsxXSwgTmFOLCBOYU4sIE5hTiwgTmFOLCBwb2ludFsyXSwgcG9pbnRbM11dKSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbGluZSA9IG5ldyBGbG9hdDMyQXJyYXkoMyAqIChsZW4gLSAyKSk7CiAgICAgICAgbGluZXMucHVzaChsaW5lKTsKICAgICAgICBsZXQgW3gxLCB5MSwgeDIsIHkyXSA9IHBvaW50LnN1YmFycmF5KDAsIDQpOwogICAgICAgIGxpbmUuc2V0KFtOYU4sIE5hTiwgTmFOLCBOYU4sIHgxLCB5MV0sIDApOwogICAgICAgIGZvciAobGV0IGkgPSA0OyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgICAgIGNvbnN0IHggPSBwb2ludFtpXTsKICAgICAgICAgIGNvbnN0IHkgPSBwb2ludFtpICsgMV07CiAgICAgICAgICBsaW5lLnNldChPdXRsaW5lLmNyZWF0ZUJlemllclBvaW50cyh4MSwgeTEsIHgyLCB5MiwgeCwgeSksIChpIC0gMikgKiAzKTsKICAgICAgICAgIFt4MSwgeTEsIHgyLCB5Ml0gPSBbeDIsIHkyLCB4LCB5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGxpbmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgbmV3TGluZXMucHVzaCh7CiAgICAgICAgbGluZTogcmVzY2FsZUZuKGxpbmVzW2ldLm1hcCgoeCkgPT4geCA/PyBOYU4pLCB0eCwgdHksIHN4LCBzeSksCiAgICAgICAgcG9pbnRzOiByZXNjYWxlRm4ocG9pbnRzW2ldLm1hcCgoeCkgPT4geCA/PyBOYU4pLCB0eCwgdHksIHN4LCBzeSkKICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBvdXRsaW5lcyA9IG5ldyB0aGlzLnByb3RvdHlwZS5jb25zdHJ1Y3RvcigpOwogICAgb3V0bGluZXMuYnVpbGQobmV3TGluZXMsIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgMSwgcm90YXRpb24sIHRoaWNrbmVzcywgaW5uZXJNYXJnaW4pOwogICAgcmV0dXJuIG91dGxpbmVzOwogIH0KICAjZ2V0TWFyZ2luQ29tcG9uZW50cyh0aGlja25lc3MgPSB0aGlzLiN0aGlja25lc3MpIHsKICAgIGNvbnN0IG1hcmdpbiA9IHRoaXMuI2lubmVyTWFyZ2luICsgdGhpY2tuZXNzIC8gMiAqIHRoaXMuI3BhcmVudFNjYWxlOwogICAgcmV0dXJuIHRoaXMuI3JvdGF0aW9uICUgMTgwID09PSAwID8gW21hcmdpbiAvIHRoaXMuI3BhcmVudFdpZHRoLCBtYXJnaW4gLyB0aGlzLiNwYXJlbnRIZWlnaHRdIDogW21hcmdpbiAvIHRoaXMuI3BhcmVudEhlaWdodCwgbWFyZ2luIC8gdGhpcy4jcGFyZW50V2lkdGhdOwogIH0KICAjZ2V0QkJveFdpdGhOb01hcmdpbigpIHsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuI2Jib3g7CiAgICBjb25zdCBbbWFyZ2luWCwgbWFyZ2luWV0gPSB0aGlzLiNnZXRNYXJnaW5Db21wb25lbnRzKDApOwogICAgcmV0dXJuIFt4ICsgbWFyZ2luWCwgeSArIG1hcmdpblksIHdpZHRoIC0gMiAqIG1hcmdpblgsIGhlaWdodCAtIDIgKiBtYXJnaW5ZXTsKICB9CiAgI2NvbXB1dGVCYm94KCkgewogICAgY29uc3QgYmJveCA9IHRoaXMuI2Jib3ggPSBuZXcgRmxvYXQzMkFycmF5KFtJbmZpbml0eSwgSW5maW5pdHksIC1JbmZpbml0eSwgLUluZmluaXR5XSk7CiAgICBmb3IgKGNvbnN0IHsKICAgICAgbGluZQogICAgfSBvZiB0aGlzLiNsaW5lcykgewogICAgICBpZiAobGluZS5sZW5ndGggPD0gMTIpIHsKICAgICAgICBmb3IgKGxldCBpID0gNCwgaWkgPSBsaW5lLmxlbmd0aDsgaSA8IGlpOyBpICs9IDYpIHsKICAgICAgICAgIFV0aWwucG9pbnRCb3VuZGluZ0JveChsaW5lW2ldLCBsaW5lW2kgKyAxXSwgYmJveCk7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGxldCBsYXN0WCA9IGxpbmVbNF0sIGxhc3RZID0gbGluZVs1XTsKICAgICAgZm9yIChsZXQgaSA9IDYsIGlpID0gbGluZS5sZW5ndGg7IGkgPCBpaTsgaSArPSA2KSB7CiAgICAgICAgY29uc3QgW2MxeCwgYzF5LCBjMngsIGMyeSwgeCwgeV0gPSBsaW5lLnN1YmFycmF5KGksIGkgKyA2KTsKICAgICAgICBVdGlsLmJlemllckJvdW5kaW5nQm94KGxhc3RYLCBsYXN0WSwgYzF4LCBjMXksIGMyeCwgYzJ5LCB4LCB5LCBiYm94KTsKICAgICAgICBsYXN0WCA9IHg7CiAgICAgICAgbGFzdFkgPSB5OwogICAgICB9CiAgICB9CiAgICBjb25zdCBbbWFyZ2luWCwgbWFyZ2luWV0gPSB0aGlzLiNnZXRNYXJnaW5Db21wb25lbnRzKCk7CiAgICBiYm94WzBdID0gTWF0aENsYW1wKGJib3hbMF0gLSBtYXJnaW5YLCAwLCAxKTsKICAgIGJib3hbMV0gPSBNYXRoQ2xhbXAoYmJveFsxXSAtIG1hcmdpblksIDAsIDEpOwogICAgYmJveFsyXSA9IE1hdGhDbGFtcChiYm94WzJdICsgbWFyZ2luWCwgMCwgMSk7CiAgICBiYm94WzNdID0gTWF0aENsYW1wKGJib3hbM10gKyBtYXJnaW5ZLCAwLCAxKTsKICAgIGJib3hbMl0gLT0gYmJveFswXTsKICAgIGJib3hbM10gLT0gYmJveFsxXTsKICB9CiAgZ2V0IGJveCgpIHsKICAgIHJldHVybiB0aGlzLiNiYm94OwogIH0KICB1cGRhdGVQcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgaWYgKG5hbWUgPT09ICJzdHJva2Utd2lkdGgiKSB7CiAgICAgIHJldHVybiB0aGlzLiN1cGRhdGVUaGlja25lc3ModmFsdWUpOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogICN1cGRhdGVUaGlja25lc3ModGhpY2tuZXNzKSB7CiAgICBjb25zdCBbb2xkTWFyZ2luWCwgb2xkTWFyZ2luWV0gPSB0aGlzLiNnZXRNYXJnaW5Db21wb25lbnRzKCk7CiAgICB0aGlzLiN0aGlja25lc3MgPSB0aGlja25lc3M7CiAgICBjb25zdCBbbmV3TWFyZ2luWCwgbmV3TWFyZ2luWV0gPSB0aGlzLiNnZXRNYXJnaW5Db21wb25lbnRzKCk7CiAgICBjb25zdCBbZGlmZk1hcmdpblgsIGRpZmZNYXJnaW5ZXSA9IFtuZXdNYXJnaW5YIC0gb2xkTWFyZ2luWCwgbmV3TWFyZ2luWSAtIG9sZE1hcmdpblldOwogICAgY29uc3QgYmJveCA9IHRoaXMuI2Jib3g7CiAgICBiYm94WzBdIC09IGRpZmZNYXJnaW5YOwogICAgYmJveFsxXSAtPSBkaWZmTWFyZ2luWTsKICAgIGJib3hbMl0gKz0gMiAqIGRpZmZNYXJnaW5YOwogICAgYmJveFszXSArPSAyICogZGlmZk1hcmdpblk7CiAgICByZXR1cm4gYmJveDsKICB9CiAgdXBkYXRlUGFyZW50RGltZW5zaW9ucyhbd2lkdGgsIGhlaWdodF0sIHNjYWxlKSB7CiAgICBjb25zdCBbb2xkTWFyZ2luWCwgb2xkTWFyZ2luWV0gPSB0aGlzLiNnZXRNYXJnaW5Db21wb25lbnRzKCk7CiAgICB0aGlzLiNwYXJlbnRXaWR0aCA9IHdpZHRoOwogICAgdGhpcy4jcGFyZW50SGVpZ2h0ID0gaGVpZ2h0OwogICAgdGhpcy4jcGFyZW50U2NhbGUgPSBzY2FsZTsKICAgIGNvbnN0IFtuZXdNYXJnaW5YLCBuZXdNYXJnaW5ZXSA9IHRoaXMuI2dldE1hcmdpbkNvbXBvbmVudHMoKTsKICAgIGNvbnN0IGRpZmZNYXJnaW5YID0gbmV3TWFyZ2luWCAtIG9sZE1hcmdpblg7CiAgICBjb25zdCBkaWZmTWFyZ2luWSA9IG5ld01hcmdpblkgLSBvbGRNYXJnaW5ZOwogICAgY29uc3QgYmJveCA9IHRoaXMuI2Jib3g7CiAgICBiYm94WzBdIC09IGRpZmZNYXJnaW5YOwogICAgYmJveFsxXSAtPSBkaWZmTWFyZ2luWTsKICAgIGJib3hbMl0gKz0gMiAqIGRpZmZNYXJnaW5YOwogICAgYmJveFszXSArPSAyICogZGlmZk1hcmdpblk7CiAgICByZXR1cm4gYmJveDsKICB9CiAgdXBkYXRlUm90YXRpb24ocm90YXRpb24pIHsKICAgIHRoaXMuI2N1cnJlbnRSb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgcmV0dXJuIHsKICAgICAgcGF0aDogewogICAgICAgIHRyYW5zZm9ybTogdGhpcy5yb3RhdGlvblRyYW5zZm9ybQogICAgICB9CiAgICB9OwogIH0KICBnZXQgdmlld0JveCgpIHsKICAgIHJldHVybiB0aGlzLiNiYm94Lm1hcChPdXRsaW5lLnN2Z1JvdW5kKS5qb2luKCIgIik7CiAgfQogIGdldCBkZWZhdWx0UHJvcGVydGllcygpIHsKICAgIGNvbnN0IFt4LCB5XSA9IHRoaXMuI2Jib3g7CiAgICByZXR1cm4gewogICAgICByb290OiB7CiAgICAgICAgdmlld0JveDogdGhpcy52aWV3Qm94CiAgICAgIH0sCiAgICAgIHBhdGg6IHsKICAgICAgICAidHJhbnNmb3JtLW9yaWdpbiI6IGAke091dGxpbmUuc3ZnUm91bmQoeCl9ICR7T3V0bGluZS5zdmdSb3VuZCh5KX1gCiAgICAgIH0KICAgIH07CiAgfQogIGdldCByb3RhdGlvblRyYW5zZm9ybSgpIHsKICAgIGNvbnN0IFssICwgd2lkdGgsIGhlaWdodF0gPSB0aGlzLiNiYm94OwogICAgbGV0IGEgPSAwLCBiID0gMCwgYyA9IDAsIGQgPSAwLCBlID0gMCwgZiA9IDA7CiAgICBzd2l0Y2ggKHRoaXMuI2N1cnJlbnRSb3RhdGlvbikgewogICAgICBjYXNlIDkwOgogICAgICAgIGIgPSBoZWlnaHQgLyB3aWR0aDsKICAgICAgICBjID0gLXdpZHRoIC8gaGVpZ2h0OwogICAgICAgIGUgPSB3aWR0aDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxODA6CiAgICAgICAgYSA9IC0xOwogICAgICAgIGQgPSAtMTsKICAgICAgICBlID0gd2lkdGg7CiAgICAgICAgZiA9IGhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgYiA9IC1oZWlnaHQgLyB3aWR0aDsKICAgICAgICBjID0gd2lkdGggLyBoZWlnaHQ7CiAgICAgICAgZiA9IGhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gIiI7CiAgICB9CiAgICByZXR1cm4gYG1hdHJpeCgke2F9ICR7Yn0gJHtjfSAke2R9ICR7T3V0bGluZS5zdmdSb3VuZChlKX0gJHtPdXRsaW5lLnN2Z1JvdW5kKGYpfSlgOwogIH0KICBnZXRQYXRoUmVzaXppbmdTVkdQcm9wZXJ0aWVzKFtuZXdYLCBuZXdZLCBuZXdXaWR0aCwgbmV3SGVpZ2h0XSkgewogICAgY29uc3QgW21hcmdpblgsIG1hcmdpblldID0gdGhpcy4jZ2V0TWFyZ2luQ29tcG9uZW50cygpOwogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gdGhpcy4jYmJveDsKICAgIGlmIChNYXRoLmFicyh3aWR0aCAtIG1hcmdpblgpIDw9IE91dGxpbmUuUFJFQ0lTSU9OIHx8IE1hdGguYWJzKGhlaWdodCAtIG1hcmdpblkpIDw9IE91dGxpbmUuUFJFQ0lTSU9OKSB7CiAgICAgIGNvbnN0IHR4ID0gbmV3WCArIG5ld1dpZHRoIC8gMiAtICh4ICsgd2lkdGggLyAyKTsKICAgICAgY29uc3QgdHkgPSBuZXdZICsgbmV3SGVpZ2h0IC8gMiAtICh5ICsgaGVpZ2h0IC8gMik7CiAgICAgIHJldHVybiB7CiAgICAgICAgcGF0aDogewogICAgICAgICAgInRyYW5zZm9ybS1vcmlnaW4iOiBgJHtPdXRsaW5lLnN2Z1JvdW5kKG5ld1gpfSAke091dGxpbmUuc3ZnUm91bmQobmV3WSl9YCwKICAgICAgICAgIHRyYW5zZm9ybTogYCR7dGhpcy5yb3RhdGlvblRyYW5zZm9ybX0gdHJhbnNsYXRlKCR7dHh9ICR7dHl9KWAKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBjb25zdCBzMXggPSAobmV3V2lkdGggLSAyICogbWFyZ2luWCkgLyAod2lkdGggLSAyICogbWFyZ2luWCk7CiAgICBjb25zdCBzMXkgPSAobmV3SGVpZ2h0IC0gMiAqIG1hcmdpblkpIC8gKGhlaWdodCAtIDIgKiBtYXJnaW5ZKTsKICAgIGNvbnN0IHMyeCA9IHdpZHRoIC8gbmV3V2lkdGg7CiAgICBjb25zdCBzMnkgPSBoZWlnaHQgLyBuZXdIZWlnaHQ7CiAgICByZXR1cm4gewogICAgICBwYXRoOiB7CiAgICAgICAgInRyYW5zZm9ybS1vcmlnaW4iOiBgJHtPdXRsaW5lLnN2Z1JvdW5kKHgpfSAke091dGxpbmUuc3ZnUm91bmQoeSl9YCwKICAgICAgICB0cmFuc2Zvcm06IGAke3RoaXMucm90YXRpb25UcmFuc2Zvcm19IHNjYWxlKCR7czJ4fSAke3MyeX0pIHRyYW5zbGF0ZSgke091dGxpbmUuc3ZnUm91bmQobWFyZ2luWCl9ICR7T3V0bGluZS5zdmdSb3VuZChtYXJnaW5ZKX0pIHNjYWxlKCR7czF4fSAke3MxeX0pIHRyYW5zbGF0ZSgke091dGxpbmUuc3ZnUm91bmQoLW1hcmdpblgpfSAke091dGxpbmUuc3ZnUm91bmQoLW1hcmdpblkpfSlgCiAgICAgIH0KICAgIH07CiAgfQogIGdldFBhdGhSZXNpemVkU1ZHUHJvcGVydGllcyhbbmV3WCwgbmV3WSwgbmV3V2lkdGgsIG5ld0hlaWdodF0pIHsKICAgIGNvbnN0IFttYXJnaW5YLCBtYXJnaW5ZXSA9IHRoaXMuI2dldE1hcmdpbkNvbXBvbmVudHMoKTsKICAgIGNvbnN0IGJib3ggPSB0aGlzLiNiYm94OwogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gYmJveDsKICAgIGJib3hbMF0gPSBuZXdYOwogICAgYmJveFsxXSA9IG5ld1k7CiAgICBiYm94WzJdID0gbmV3V2lkdGg7CiAgICBiYm94WzNdID0gbmV3SGVpZ2h0OwogICAgaWYgKE1hdGguYWJzKHdpZHRoIC0gbWFyZ2luWCkgPD0gT3V0bGluZS5QUkVDSVNJT04gfHwgTWF0aC5hYnMoaGVpZ2h0IC0gbWFyZ2luWSkgPD0gT3V0bGluZS5QUkVDSVNJT04pIHsKICAgICAgY29uc3QgdHgyID0gbmV3WCArIG5ld1dpZHRoIC8gMiAtICh4ICsgd2lkdGggLyAyKTsKICAgICAgY29uc3QgdHkyID0gbmV3WSArIG5ld0hlaWdodCAvIDIgLSAoeSArIGhlaWdodCAvIDIpOwogICAgICBmb3IgKGNvbnN0IHsKICAgICAgICBsaW5lLAogICAgICAgIHBvaW50cwogICAgICB9IG9mIHRoaXMuI2xpbmVzKSB7CiAgICAgICAgT3V0bGluZS5fdHJhbnNsYXRlKGxpbmUsIHR4MiwgdHkyLCBsaW5lKTsKICAgICAgICBPdXRsaW5lLl90cmFuc2xhdGUocG9pbnRzLCB0eDIsIHR5MiwgcG9pbnRzKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHJvb3Q6IHsKICAgICAgICAgIHZpZXdCb3g6IHRoaXMudmlld0JveAogICAgICAgIH0sCiAgICAgICAgcGF0aDogewogICAgICAgICAgInRyYW5zZm9ybS1vcmlnaW4iOiBgJHtPdXRsaW5lLnN2Z1JvdW5kKG5ld1gpfSAke091dGxpbmUuc3ZnUm91bmQobmV3WSl9YCwKICAgICAgICAgIHRyYW5zZm9ybTogdGhpcy5yb3RhdGlvblRyYW5zZm9ybSB8fCBudWxsLAogICAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHMxeCA9IChuZXdXaWR0aCAtIDIgKiBtYXJnaW5YKSAvICh3aWR0aCAtIDIgKiBtYXJnaW5YKTsKICAgIGNvbnN0IHMxeSA9IChuZXdIZWlnaHQgLSAyICogbWFyZ2luWSkgLyAoaGVpZ2h0IC0gMiAqIG1hcmdpblkpOwogICAgY29uc3QgdHggPSAtczF4ICogKHggKyBtYXJnaW5YKSArIG5ld1ggKyBtYXJnaW5YOwogICAgY29uc3QgdHkgPSAtczF5ICogKHkgKyBtYXJnaW5ZKSArIG5ld1kgKyBtYXJnaW5ZOwogICAgaWYgKHMxeCAhPT0gMSB8fCBzMXkgIT09IDEgfHwgdHggIT09IDAgfHwgdHkgIT09IDApIHsKICAgICAgZm9yIChjb25zdCB7CiAgICAgICAgbGluZSwKICAgICAgICBwb2ludHMKICAgICAgfSBvZiB0aGlzLiNsaW5lcykgewogICAgICAgIE91dGxpbmUuX3Jlc2NhbGUobGluZSwgdHgsIHR5LCBzMXgsIHMxeSwgbGluZSk7CiAgICAgICAgT3V0bGluZS5fcmVzY2FsZShwb2ludHMsIHR4LCB0eSwgczF4LCBzMXksIHBvaW50cyk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIHJvb3Q6IHsKICAgICAgICB2aWV3Qm94OiB0aGlzLnZpZXdCb3gKICAgICAgfSwKICAgICAgcGF0aDogewogICAgICAgICJ0cmFuc2Zvcm0tb3JpZ2luIjogYCR7T3V0bGluZS5zdmdSb3VuZChuZXdYKX0gJHtPdXRsaW5lLnN2Z1JvdW5kKG5ld1kpfWAsCiAgICAgICAgdHJhbnNmb3JtOiB0aGlzLnJvdGF0aW9uVHJhbnNmb3JtIHx8IG51bGwsCiAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKQogICAgICB9CiAgICB9OwogIH0KICBnZXRQYXRoVHJhbnNsYXRlZFNWR1Byb3BlcnRpZXMoW25ld1gsIG5ld1ldLCBwYXJlbnREaW1lbnNpb25zKSB7CiAgICBjb25zdCBbbmV3UGFyZW50V2lkdGgsIG5ld1BhcmVudEhlaWdodF0gPSBwYXJlbnREaW1lbnNpb25zOwogICAgY29uc3QgYmJveCA9IHRoaXMuI2Jib3g7CiAgICBjb25zdCB0eCA9IG5ld1ggLSBiYm94WzBdOwogICAgY29uc3QgdHkgPSBuZXdZIC0gYmJveFsxXTsKICAgIGlmICh0aGlzLiNwYXJlbnRXaWR0aCA9PT0gbmV3UGFyZW50V2lkdGggJiYgdGhpcy4jcGFyZW50SGVpZ2h0ID09PSBuZXdQYXJlbnRIZWlnaHQpIHsKICAgICAgZm9yIChjb25zdCB7CiAgICAgICAgbGluZSwKICAgICAgICBwb2ludHMKICAgICAgfSBvZiB0aGlzLiNsaW5lcykgewogICAgICAgIE91dGxpbmUuX3RyYW5zbGF0ZShsaW5lLCB0eCwgdHksIGxpbmUpOwogICAgICAgIE91dGxpbmUuX3RyYW5zbGF0ZShwb2ludHMsIHR4LCB0eSwgcG9pbnRzKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3Qgc3ggPSB0aGlzLiNwYXJlbnRXaWR0aCAvIG5ld1BhcmVudFdpZHRoOwogICAgICBjb25zdCBzeSA9IHRoaXMuI3BhcmVudEhlaWdodCAvIG5ld1BhcmVudEhlaWdodDsKICAgICAgdGhpcy4jcGFyZW50V2lkdGggPSBuZXdQYXJlbnRXaWR0aDsKICAgICAgdGhpcy4jcGFyZW50SGVpZ2h0ID0gbmV3UGFyZW50SGVpZ2h0OwogICAgICBmb3IgKGNvbnN0IHsKICAgICAgICBsaW5lLAogICAgICAgIHBvaW50cwogICAgICB9IG9mIHRoaXMuI2xpbmVzKSB7CiAgICAgICAgT3V0bGluZS5fcmVzY2FsZShsaW5lLCB0eCwgdHksIHN4LCBzeSwgbGluZSk7CiAgICAgICAgT3V0bGluZS5fcmVzY2FsZShwb2ludHMsIHR4LCB0eSwgc3gsIHN5LCBwb2ludHMpOwogICAgICB9CiAgICAgIGJib3hbMl0gKj0gc3g7CiAgICAgIGJib3hbM10gKj0gc3k7CiAgICB9CiAgICBiYm94WzBdID0gbmV3WDsKICAgIGJib3hbMV0gPSBuZXdZOwogICAgcmV0dXJuIHsKICAgICAgcm9vdDogewogICAgICAgIHZpZXdCb3g6IHRoaXMudmlld0JveAogICAgICB9LAogICAgICBwYXRoOiB7CiAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKSwKICAgICAgICAidHJhbnNmb3JtLW9yaWdpbiI6IGAke091dGxpbmUuc3ZnUm91bmQobmV3WCl9ICR7T3V0bGluZS5zdmdSb3VuZChuZXdZKX1gCiAgICAgIH0KICAgIH07CiAgfQogIGdldCBkZWZhdWx0U1ZHUHJvcGVydGllcygpIHsKICAgIGNvbnN0IGJib3ggPSB0aGlzLiNiYm94OwogICAgcmV0dXJuIHsKICAgICAgcm9vdDogewogICAgICAgIHZpZXdCb3g6IHRoaXMudmlld0JveAogICAgICB9LAogICAgICByb290Q2xhc3M6IHsKICAgICAgICBkcmF3OiB0cnVlCiAgICAgIH0sCiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLnRvU1ZHUGF0aCgpLAogICAgICAgICJ0cmFuc2Zvcm0tb3JpZ2luIjogYCR7T3V0bGluZS5zdmdSb3VuZChiYm94WzBdKX0gJHtPdXRsaW5lLnN2Z1JvdW5kKGJib3hbMV0pfWAsCiAgICAgICAgdHJhbnNmb3JtOiB0aGlzLnJvdGF0aW9uVHJhbnNmb3JtIHx8IG51bGwKICAgICAgfSwKICAgICAgYmJveAogICAgfTsKICB9Cn07CnZhciBJbmtEcmF3aW5nT3B0aW9ucyA9IGNsYXNzIF9JbmtEcmF3aW5nT3B0aW9ucyBleHRlbmRzIERyYXdpbmdPcHRpb25zIHsKICBjb25zdHJ1Y3Rvcih2aWV3ZXJQYXJhbWV0ZXJzKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5fdmlld1BhcmFtZXRlcnMgPSB2aWV3ZXJQYXJhbWV0ZXJzOwogICAgc3VwZXIudXBkYXRlUHJvcGVydGllcyh7CiAgICAgIGZpbGw6ICJub25lIiwKICAgICAgc3Ryb2tlOiBBbm5vdGF0aW9uRWRpdG9yLl9kZWZhdWx0TGluZUNvbG9yLAogICAgICAic3Ryb2tlLW9wYWNpdHkiOiAxLAogICAgICAic3Ryb2tlLXdpZHRoIjogMSwKICAgICAgInN0cm9rZS1saW5lY2FwIjogInJvdW5kIiwKICAgICAgInN0cm9rZS1saW5lam9pbiI6ICJyb3VuZCIsCiAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCI6IDEwCiAgICB9KTsKICB9CiAgdXBkYXRlU1ZHUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgIGlmIChuYW1lID09PSAic3Ryb2tlLXdpZHRoIikgewogICAgICB2YWx1ZSA/Pz0gdGhpc1sic3Ryb2tlLXdpZHRoIl07CiAgICAgIHZhbHVlICo9IHRoaXMuX3ZpZXdQYXJhbWV0ZXJzLnJlYWxTY2FsZTsKICAgIH0KICAgIHN1cGVyLnVwZGF0ZVNWR1Byb3BlcnR5KG5hbWUsIHZhbHVlKTsKICB9CiAgY2xvbmUoKSB7CiAgICBjb25zdCBjbG9uZSA9IG5ldyBfSW5rRHJhd2luZ09wdGlvbnModGhpcy5fdmlld1BhcmFtZXRlcnMpOwogICAgY2xvbmUudXBkYXRlQWxsKHRoaXMpOwogICAgcmV0dXJuIGNsb25lOwogIH0KfTsKdmFyIElua0VkaXRvciA9IGNsYXNzIF9JbmtFZGl0b3IgZXh0ZW5kcyBEcmF3aW5nRWRpdG9yIHsKICBzdGF0aWMgX3R5cGUgPSAiaW5rIjsKICBzdGF0aWMgX2VkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5JTks7CiAgc3RhdGljIF9kZWZhdWx0RHJhd2luZ09wdGlvbnMgPSBudWxsOwogIGNvbnN0cnVjdG9yKHBhcmFtcykgewogICAgc3VwZXIoewogICAgICAuLi5wYXJhbXMsCiAgICAgIG5hbWU6ICJpbmtFZGl0b3IiCiAgICB9KTsKICAgIHRoaXMuX3dpbGxLZWVwQXNwZWN0UmF0aW8gPSB0cnVlOwogICAgdGhpcy5kZWZhdWx0TDEwbklkID0gInBkZmpzLWVkaXRvci1pbmstZWRpdG9yIjsKICB9CiAgc3RhdGljIGluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKSB7CiAgICBBbm5vdGF0aW9uRWRpdG9yLmluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKTsKICAgIHRoaXMuX2RlZmF1bHREcmF3aW5nT3B0aW9ucyA9IG5ldyBJbmtEcmF3aW5nT3B0aW9ucyh1aU1hbmFnZXIudmlld1BhcmFtZXRlcnMpOwogIH0KICBzdGF0aWMgZ2V0RGVmYXVsdERyYXdpbmdPcHRpb25zKG9wdGlvbnMpIHsKICAgIGNvbnN0IGNsb25lID0gdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zLmNsb25lKCk7CiAgICBjbG9uZS51cGRhdGVQcm9wZXJ0aWVzKG9wdGlvbnMpOwogICAgcmV0dXJuIGNsb25lOwogIH0KICBzdGF0aWMgZ2V0IHN1cHBvcnRNdWx0aXBsZURyYXdpbmdzKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHN0YXRpYyBnZXQgdHlwZXNNYXAoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJ0eXBlc01hcCIsIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSU5LX1RISUNLTkVTUywgInN0cm9rZS13aWR0aCJdLCBbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSU5LX0NPTE9SLCAic3Ryb2tlIl0sIFtBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5JTktfT1BBQ0lUWSwgInN0cm9rZS1vcGFjaXR5Il1dKSk7CiAgfQogIHN0YXRpYyBjcmVhdGVEcmF3ZXJJbnN0YW5jZSh4LCB5LCBwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0LCByb3RhdGlvbikgewogICAgcmV0dXJuIG5ldyBJbmtEcmF3T3V0bGluZXIoeCwgeSwgcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodCwgcm90YXRpb24sIHRoaXMuX2RlZmF1bHREcmF3aW5nT3B0aW9uc1sic3Ryb2tlLXdpZHRoIl0pOwogIH0KICBzdGF0aWMgZGVzZXJpYWxpemVEcmF3KHBhZ2VYLCBwYWdlWSwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCBpbm5lck1hcmdpbiwgZGF0YSkgewogICAgcmV0dXJuIElua0RyYXdPdXRsaW5lLmRlc2VyaWFsaXplKHBhZ2VYLCBwYWdlWSwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCBpbm5lck1hcmdpbiwgZGF0YSk7CiAgfQogIHN0YXRpYyBhc3luYyBkZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcikgewogICAgbGV0IGluaXRpYWxEYXRhMiA9IG51bGw7CiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIElua0Fubm90YXRpb25FbGVtZW50KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBpbmtMaXN0cywKICAgICAgICAgIHJlY3QsCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIGlkLAogICAgICAgICAgY29sb3IsCiAgICAgICAgICBvcGFjaXR5LAogICAgICAgICAgYm9yZGVyU3R5bGU6IHsKICAgICAgICAgICAgcmF3V2lkdGg6IHRoaWNrbmVzcwogICAgICAgICAgfSwKICAgICAgICAgIHBvcHVwUmVmLAogICAgICAgICAgcmljaFRleHQsCiAgICAgICAgICBjb250ZW50c09iaiwKICAgICAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgICAgICB9LAogICAgICAgIHBhcmVudDogewogICAgICAgICAgcGFnZTogewogICAgICAgICAgICBwYWdlTnVtYmVyCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9ID0gZGF0YTsKICAgICAgaW5pdGlhbERhdGEyID0gZGF0YSA9IHsKICAgICAgICBhbm5vdGF0aW9uVHlwZTogQW5ub3RhdGlvbkVkaXRvclR5cGUuSU5LLAogICAgICAgIGNvbG9yOiBBcnJheS5mcm9tKGNvbG9yKSwKICAgICAgICB0aGlja25lc3MsCiAgICAgICAgb3BhY2l0eSwKICAgICAgICBwYXRoczogewogICAgICAgICAgcG9pbnRzOiBpbmtMaXN0cwogICAgICAgIH0sCiAgICAgICAgYm94ZXM6IG51bGwsCiAgICAgICAgcGFnZUluZGV4OiBwYWdlTnVtYmVyIC0gMSwKICAgICAgICByZWN0OiByZWN0LnNsaWNlKDApLAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGFubm90YXRpb25FbGVtZW50SWQ6IGlkLAogICAgICAgIGlkLAogICAgICAgIGRlbGV0ZWQ6IGZhbHNlLAogICAgICAgIHBvcHVwUmVmLAogICAgICAgIHJpY2hUZXh0LAogICAgICAgIGNvbW1lbnQ6IGNvbnRlbnRzT2JqPy5zdHIgfHwgbnVsbCwKICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgICB9OwogICAgfQogICAgY29uc3QgZWRpdG9yID0gYXdhaXQgc3VwZXIuZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpOwogICAgZWRpdG9yLl9pbml0aWFsRGF0YSA9IGluaXRpYWxEYXRhMjsKICAgIGlmIChkYXRhLmNvbW1lbnQpIHsKICAgICAgZWRpdG9yLnNldENvbW1lbnREYXRhKGRhdGEpOwogICAgfQogICAgcmV0dXJuIGVkaXRvcjsKICB9CiAgZ2V0IHRvb2xiYXJCdXR0b25zKCkgewogICAgdGhpcy5fY29sb3JQaWNrZXIgfHw9IG5ldyBCYXNpY0NvbG9yUGlja2VyKHRoaXMpOwogICAgcmV0dXJuIFtbImNvbG9yUGlja2VyIiwgdGhpcy5fY29sb3JQaWNrZXJdXTsKICB9CiAgZ2V0IGNvbG9yVHlwZSgpIHsKICAgIHJldHVybiBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5JTktfQ09MT1I7CiAgfQogIGdldCBjb2xvcigpIHsKICAgIHJldHVybiB0aGlzLl9kcmF3aW5nT3B0aW9ucy5zdHJva2U7CiAgfQogIGdldCBvcGFjaXR5KCkgewogICAgcmV0dXJuIHRoaXMuX2RyYXdpbmdPcHRpb25zWyJzdHJva2Utb3BhY2l0eSJdOwogIH0KICBvblNjYWxlQ2hhbmdpbmcoKSB7CiAgICBpZiAoIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN1cGVyLm9uU2NhbGVDaGFuZ2luZygpOwogICAgY29uc3QgewogICAgICBfZHJhd0lkLAogICAgICBfZHJhd2luZ09wdGlvbnMsCiAgICAgIHBhcmVudAogICAgfSA9IHRoaXM7CiAgICBfZHJhd2luZ09wdGlvbnMudXBkYXRlU1ZHUHJvcGVydHkoInN0cm9rZS13aWR0aCIpOwogICAgcGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKF9kcmF3SWQsIF9kcmF3aW5nT3B0aW9ucy50b1NWR1Byb3BlcnRpZXMoKSk7CiAgfQogIHN0YXRpYyBvblNjYWxlQ2hhbmdpbmdXaGVuRHJhd2luZygpIHsKICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuX2N1cnJlbnRQYXJlbnQ7CiAgICBpZiAoIXBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5vblNjYWxlQ2hhbmdpbmdXaGVuRHJhd2luZygpOwogICAgdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zLnVwZGF0ZVNWR1Byb3BlcnR5KCJzdHJva2Utd2lkdGgiKTsKICAgIHBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9jdXJyZW50RHJhd0lkLCB0aGlzLl9kZWZhdWx0RHJhd2luZ09wdGlvbnMudG9TVkdQcm9wZXJ0aWVzKCkpOwogIH0KICBjcmVhdGVEcmF3aW5nT3B0aW9ucyh7CiAgICBjb2xvciwKICAgIHRoaWNrbmVzcywKICAgIG9wYWNpdHkKICB9KSB7CiAgICB0aGlzLl9kcmF3aW5nT3B0aW9ucyA9IF9JbmtFZGl0b3IuZ2V0RGVmYXVsdERyYXdpbmdPcHRpb25zKHsKICAgICAgc3Ryb2tlOiBVdGlsLm1ha2VIZXhDb2xvciguLi5jb2xvciksCiAgICAgICJzdHJva2Utd2lkdGgiOiB0aGlja25lc3MsCiAgICAgICJzdHJva2Utb3BhY2l0eSI6IG9wYWNpdHkKICAgIH0pOwogIH0KICBzZXJpYWxpemUoaXNGb3JDb3B5aW5nID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0aGlzLmRlbGV0ZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplRGVsZXRlZCgpOwogICAgfQogICAgY29uc3QgewogICAgICBsaW5lcywKICAgICAgcG9pbnRzCiAgICB9ID0gdGhpcy5zZXJpYWxpemVEcmF3KGlzRm9yQ29weWluZyk7CiAgICBjb25zdCB7CiAgICAgIF9kcmF3aW5nT3B0aW9uczogewogICAgICAgIHN0cm9rZSwKICAgICAgICAic3Ryb2tlLW9wYWNpdHkiOiBvcGFjaXR5LAogICAgICAgICJzdHJva2Utd2lkdGgiOiB0aGlja25lc3MKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBjb25zdCBzZXJpYWxpemVkID0gT2JqZWN0LmFzc2lnbihzdXBlci5zZXJpYWxpemUoaXNGb3JDb3B5aW5nKSwgewogICAgICBjb2xvcjogQW5ub3RhdGlvbkVkaXRvci5fY29sb3JNYW5hZ2VyLmNvbnZlcnQoc3Ryb2tlKSwKICAgICAgb3BhY2l0eSwKICAgICAgdGhpY2tuZXNzLAogICAgICBwYXRoczogewogICAgICAgIGxpbmVzLAogICAgICAgIHBvaW50cwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuYWRkQ29tbWVudChzZXJpYWxpemVkKTsKICAgIGlmIChpc0ZvckNvcHlpbmcpIHsKICAgICAgc2VyaWFsaXplZC5pc0NvcHkgPSB0cnVlOwogICAgICByZXR1cm4gc2VyaWFsaXplZDsKICAgIH0KICAgIGlmICh0aGlzLmFubm90YXRpb25FbGVtZW50SWQgJiYgIXRoaXMuI2hhc0VsZW1lbnRDaGFuZ2VkKHNlcmlhbGl6ZWQpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgc2VyaWFsaXplZC5pZCA9IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZDsKICAgIHJldHVybiBzZXJpYWxpemVkOwogIH0KICAjaGFzRWxlbWVudENoYW5nZWQoc2VyaWFsaXplZCkgewogICAgY29uc3QgewogICAgICBjb2xvciwKICAgICAgdGhpY2tuZXNzLAogICAgICBvcGFjaXR5LAogICAgICBwYWdlSW5kZXgKICAgIH0gPSB0aGlzLl9pbml0aWFsRGF0YTsKICAgIHJldHVybiB0aGlzLmhhc0VkaXRlZENvbW1lbnQgfHwgdGhpcy5faGFzQmVlbk1vdmVkIHx8IHRoaXMuX2hhc0JlZW5SZXNpemVkIHx8IHNlcmlhbGl6ZWQuY29sb3Iuc29tZSgoYywgaSkgPT4gYyAhPT0gY29sb3JbaV0pIHx8IHNlcmlhbGl6ZWQudGhpY2tuZXNzICE9PSB0aGlja25lc3MgfHwgc2VyaWFsaXplZC5vcGFjaXR5ICE9PSBvcGFjaXR5IHx8IHNlcmlhbGl6ZWQucGFnZUluZGV4ICE9PSBwYWdlSW5kZXg7CiAgfQogIHJlbmRlckFubm90YXRpb25FbGVtZW50KGFubm90YXRpb24pIHsKICAgIGlmICh0aGlzLmRlbGV0ZWQpIHsKICAgICAgYW5ub3RhdGlvbi5oaWRlKCk7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgewogICAgICBwb2ludHMsCiAgICAgIHJlY3QKICAgIH0gPSB0aGlzLnNlcmlhbGl6ZURyYXcoZmFsc2UpOwogICAgYW5ub3RhdGlvbi51cGRhdGVFZGl0ZWQoewogICAgICByZWN0LAogICAgICB0aGlja25lc3M6IHRoaXMuX2RyYXdpbmdPcHRpb25zWyJzdHJva2Utd2lkdGgiXSwKICAgICAgcG9pbnRzLAogICAgICBwb3B1cDogdGhpcy5jb21tZW50CiAgICB9KTsKICAgIHJldHVybiBudWxsOwogIH0KfTsKdmFyIENvbnRvdXJEcmF3T3V0bGluZSA9IGNsYXNzIGV4dGVuZHMgSW5rRHJhd091dGxpbmUgewogIHRvU1ZHUGF0aCgpIHsKICAgIGxldCBwYXRoID0gc3VwZXIudG9TVkdQYXRoKCk7CiAgICBpZiAoIXBhdGguZW5kc1dpdGgoIloiKSkgewogICAgICBwYXRoICs9ICJaIjsKICAgIH0KICAgIHJldHVybiBwYXRoOwogIH0KfTsKdmFyIEJBU0VfSEVBREVSX0xFTkdUSCA9IDg7CnZhciBQT0lOVFNfUFJPUEVSVElFU19OVU1CRVIgPSAzOwp2YXIgU2lnbmF0dXJlRXh0cmFjdG9yID0gY2xhc3MgewogIHN0YXRpYyAjUEFSQU1FVEVSUyA9IHsKICAgIG1heERpbTogNTEyLAogICAgc2lnbWFTRmFjdG9yOiAwLjAyLAogICAgc2lnbWFSOiAyNSwKICAgIGtlcm5lbFNpemU6IDE2CiAgfTsKICBzdGF0aWMgI25laWdoYm9ySW5kZXhUb0lkKGkwLCBqMCwgaSwgaikgewogICAgaSAtPSBpMDsKICAgIGogLT0gajA7CiAgICBpZiAoaSA9PT0gMCkgewogICAgICByZXR1cm4gaiA+IDAgPyAwIDogNDsKICAgIH0KICAgIGlmIChpID09PSAxKSB7CiAgICAgIHJldHVybiBqICsgNjsKICAgIH0KICAgIHJldHVybiAyIC0gajsKICB9CiAgc3RhdGljICNuZWlnaGJvcklkVG9JbmRleCA9IG5ldyBJbnQzMkFycmF5KFswLCAxLCAtMSwgMSwgLTEsIDAsIC0xLCAtMSwgMCwgLTEsIDEsIC0xLCAxLCAwLCAxLCAxXSk7CiAgc3RhdGljICNjbG9ja3dpc2VOb25aZXJvKGJ1Ziwgd2lkdGgsIGkwLCBqMCwgaSwgaiwgb2Zmc2V0KSB7CiAgICBjb25zdCBpZCA9IHRoaXMuI25laWdoYm9ySW5kZXhUb0lkKGkwLCBqMCwgaSwgaik7CiAgICBmb3IgKGxldCBrID0gMDsgayA8IDg7IGsrKykgewogICAgICBjb25zdCBrayA9ICgtayArIGlkIC0gb2Zmc2V0ICsgMTYpICUgODsKICAgICAgY29uc3Qgc2hpZnRJID0gdGhpcy4jbmVpZ2hib3JJZFRvSW5kZXhbMiAqIGtrXTsKICAgICAgY29uc3Qgc2hpZnRKID0gdGhpcy4jbmVpZ2hib3JJZFRvSW5kZXhbMiAqIGtrICsgMV07CiAgICAgIGlmIChidWZbKGkwICsgc2hpZnRJKSAqIHdpZHRoICsgKGowICsgc2hpZnRKKV0gIT09IDApIHsKICAgICAgICByZXR1cm4ga2s7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CiAgc3RhdGljICNjb3VudGVyQ2xvY2t3aXNlTm9uWmVybyhidWYsIHdpZHRoLCBpMCwgajAsIGksIGosIG9mZnNldCkgewogICAgY29uc3QgaWQgPSB0aGlzLiNuZWlnaGJvckluZGV4VG9JZChpMCwgajAsIGksIGopOwogICAgZm9yIChsZXQgayA9IDA7IGsgPCA4OyBrKyspIHsKICAgICAgY29uc3Qga2sgPSAoayArIGlkICsgb2Zmc2V0ICsgMTYpICUgODsKICAgICAgY29uc3Qgc2hpZnRJID0gdGhpcy4jbmVpZ2hib3JJZFRvSW5kZXhbMiAqIGtrXTsKICAgICAgY29uc3Qgc2hpZnRKID0gdGhpcy4jbmVpZ2hib3JJZFRvSW5kZXhbMiAqIGtrICsgMV07CiAgICAgIGlmIChidWZbKGkwICsgc2hpZnRJKSAqIHdpZHRoICsgKGowICsgc2hpZnRKKV0gIT09IDApIHsKICAgICAgICByZXR1cm4ga2s7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CiAgc3RhdGljICNmaW5kQ29udG91cnMoYnVmLCB3aWR0aCwgaGVpZ2h0LCB0aHJlc2hvbGQpIHsKICAgIGNvbnN0IE4gPSBidWYubGVuZ3RoOwogICAgY29uc3QgdHlwZXMgPSBuZXcgSW50MzJBcnJheShOKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTjsgaSsrKSB7CiAgICAgIHR5cGVzW2ldID0gYnVmW2ldIDw9IHRocmVzaG9sZCA/IDEgOiAwOwogICAgfQogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBoZWlnaHQgLSAxOyBpKyspIHsKICAgICAgdHlwZXNbaSAqIHdpZHRoXSA9IHR5cGVzW2kgKiB3aWR0aCArIHdpZHRoIC0gMV0gPSAwOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB3aWR0aDsgaSsrKSB7CiAgICAgIHR5cGVzW2ldID0gdHlwZXNbd2lkdGggKiBoZWlnaHQgLSAxIC0gaV0gPSAwOwogICAgfQogICAgbGV0IG5iZCA9IDE7CiAgICBsZXQgbG5iZDsKICAgIGNvbnN0IGNvbnRvdXJzID0gW107CiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGhlaWdodCAtIDE7IGkrKykgewogICAgICBsbmJkID0gMTsKICAgICAgZm9yIChsZXQgaiA9IDE7IGogPCB3aWR0aCAtIDE7IGorKykgewogICAgICAgIGNvbnN0IGlqID0gaSAqIHdpZHRoICsgajsKICAgICAgICBjb25zdCBwaXggPSB0eXBlc1tpal07CiAgICAgICAgaWYgKHBpeCA9PT0gMCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGxldCBpMiA9IGk7CiAgICAgICAgbGV0IGoyID0gajsKICAgICAgICBpZiAocGl4ID09PSAxICYmIHR5cGVzW2lqIC0gMV0gPT09IDApIHsKICAgICAgICAgIG5iZCArPSAxOwogICAgICAgICAgajIgLT0gMTsKICAgICAgICB9IGVsc2UgaWYgKHBpeCA+PSAxICYmIHR5cGVzW2lqICsgMV0gPT09IDApIHsKICAgICAgICAgIG5iZCArPSAxOwogICAgICAgICAgajIgKz0gMTsKICAgICAgICAgIGlmIChwaXggPiAxKSB7CiAgICAgICAgICAgIGxuYmQgPSBwaXg7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChwaXggIT09IDEpIHsKICAgICAgICAgICAgbG5iZCA9IE1hdGguYWJzKHBpeCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcG9pbnRzID0gW2osIGldOwogICAgICAgIGNvbnN0IGlzSG9sZSA9IGoyID09PSBqICsgMTsKICAgICAgICBjb25zdCBjb250b3VyID0gewogICAgICAgICAgaXNIb2xlLAogICAgICAgICAgcG9pbnRzLAogICAgICAgICAgaWQ6IG5iZCwKICAgICAgICAgIHBhcmVudDogMAogICAgICAgIH07CiAgICAgICAgY29udG91cnMucHVzaChjb250b3VyKTsKICAgICAgICBsZXQgY29udG91cjA7CiAgICAgICAgZm9yIChjb25zdCBjIG9mIGNvbnRvdXJzKSB7CiAgICAgICAgICBpZiAoYy5pZCA9PT0gbG5iZCkgewogICAgICAgICAgICBjb250b3VyMCA9IGM7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWNvbnRvdXIwKSB7CiAgICAgICAgICBjb250b3VyLnBhcmVudCA9IGlzSG9sZSA/IGxuYmQgOiAwOwogICAgICAgIH0gZWxzZSBpZiAoY29udG91cjAuaXNIb2xlKSB7CiAgICAgICAgICBjb250b3VyLnBhcmVudCA9IGlzSG9sZSA/IGNvbnRvdXIwLnBhcmVudCA6IGxuYmQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnRvdXIucGFyZW50ID0gaXNIb2xlID8gbG5iZCA6IGNvbnRvdXIwLnBhcmVudDsKICAgICAgICB9CiAgICAgICAgY29uc3QgayA9IHRoaXMuI2Nsb2Nrd2lzZU5vblplcm8odHlwZXMsIHdpZHRoLCBpLCBqLCBpMiwgajIsIDApOwogICAgICAgIGlmIChrID09PSAtMSkgewogICAgICAgICAgdHlwZXNbaWpdID0gLW5iZDsKICAgICAgICAgIGlmICh0eXBlc1tpal0gIT09IDEpIHsKICAgICAgICAgICAgbG5iZCA9IE1hdGguYWJzKHR5cGVzW2lqXSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbGV0IHNoaWZ0SSA9IHRoaXMuI25laWdoYm9ySWRUb0luZGV4WzIgKiBrXTsKICAgICAgICBsZXQgc2hpZnRKID0gdGhpcy4jbmVpZ2hib3JJZFRvSW5kZXhbMiAqIGsgKyAxXTsKICAgICAgICBjb25zdCBpMSA9IGkgKyBzaGlmdEk7CiAgICAgICAgY29uc3QgajEgPSBqICsgc2hpZnRKOwogICAgICAgIGkyID0gaTE7CiAgICAgICAgajIgPSBqMTsKICAgICAgICBsZXQgaTMgPSBpOwogICAgICAgIGxldCBqMyA9IGo7CiAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgIGNvbnN0IGtrID0gdGhpcy4jY291bnRlckNsb2Nrd2lzZU5vblplcm8odHlwZXMsIHdpZHRoLCBpMywgajMsIGkyLCBqMiwgMSk7CiAgICAgICAgICBzaGlmdEkgPSB0aGlzLiNuZWlnaGJvcklkVG9JbmRleFsyICoga2tdOwogICAgICAgICAgc2hpZnRKID0gdGhpcy4jbmVpZ2hib3JJZFRvSW5kZXhbMiAqIGtrICsgMV07CiAgICAgICAgICBjb25zdCBpNCA9IGkzICsgc2hpZnRJOwogICAgICAgICAgY29uc3QgajQgPSBqMyArIHNoaWZ0SjsKICAgICAgICAgIHBvaW50cy5wdXNoKGo0LCBpNCk7CiAgICAgICAgICBjb25zdCBpajMgPSBpMyAqIHdpZHRoICsgajM7CiAgICAgICAgICBpZiAodHlwZXNbaWozICsgMV0gPT09IDApIHsKICAgICAgICAgICAgdHlwZXNbaWozXSA9IC1uYmQ7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVzW2lqM10gPT09IDEpIHsKICAgICAgICAgICAgdHlwZXNbaWozXSA9IG5iZDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpNCA9PT0gaSAmJiBqNCA9PT0gaiAmJiBpMyA9PT0gaTEgJiYgajMgPT09IGoxKSB7CiAgICAgICAgICAgIGlmICh0eXBlc1tpal0gIT09IDEpIHsKICAgICAgICAgICAgICBsbmJkID0gTWF0aC5hYnModHlwZXNbaWpdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGkyID0gaTM7CiAgICAgICAgICAgIGoyID0gajM7CiAgICAgICAgICAgIGkzID0gaTQ7CiAgICAgICAgICAgIGozID0gajQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29udG91cnM7CiAgfQogIHN0YXRpYyAjZG91Z2xhc1BldWNrZXJIZWxwZXIocG9pbnRzLCBzdGFydCwgZW5kLCBvdXRwdXQpIHsKICAgIGlmIChlbmQgLSBzdGFydCA8PSA0KSB7CiAgICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGVuZCAtIDI7IGkgKz0gMikgewogICAgICAgIG91dHB1dC5wdXNoKHBvaW50c1tpXSwgcG9pbnRzW2kgKyAxXSk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgYXggPSBwb2ludHNbc3RhcnRdOwogICAgY29uc3QgYXkgPSBwb2ludHNbc3RhcnQgKyAxXTsKICAgIGNvbnN0IGFieCA9IHBvaW50c1tlbmQgLSA0XSAtIGF4OwogICAgY29uc3QgYWJ5ID0gcG9pbnRzW2VuZCAtIDNdIC0gYXk7CiAgICBjb25zdCBkaXN0ID0gTWF0aC5oeXBvdChhYngsIGFieSk7CiAgICBjb25zdCBuYWJ4ID0gYWJ4IC8gZGlzdDsKICAgIGNvbnN0IG5hYnkgPSBhYnkgLyBkaXN0OwogICAgY29uc3QgYWEgPSBuYWJ4ICogYXkgLSBuYWJ5ICogYXg7CiAgICBjb25zdCBtID0gYWJ5IC8gYWJ4OwogICAgY29uc3QgaW52UyA9IDEgLyBkaXN0OwogICAgY29uc3QgcGhpID0gTWF0aC5hdGFuKG0pOwogICAgY29uc3QgY29zUGhpID0gTWF0aC5jb3MocGhpKTsKICAgIGNvbnN0IHNpblBoaSA9IE1hdGguc2luKHBoaSk7CiAgICBjb25zdCB0bWF4ID0gaW52UyAqIChNYXRoLmFicyhjb3NQaGkpICsgTWF0aC5hYnMoc2luUGhpKSk7CiAgICBjb25zdCBwb2x5ID0gaW52UyAqICgxIC0gdG1heCArIHRtYXggKiogMik7CiAgICBjb25zdCBwYXJ0aWFsUGhpID0gTWF0aC5tYXgoTWF0aC5hdGFuKE1hdGguYWJzKHNpblBoaSArIGNvc1BoaSkgKiBwb2x5KSwgTWF0aC5hdGFuKE1hdGguYWJzKHNpblBoaSAtIGNvc1BoaSkgKiBwb2x5KSk7CiAgICBsZXQgZG1heCA9IDA7CiAgICBsZXQgaW5kZXggPSBzdGFydDsKICAgIGZvciAobGV0IGkgPSBzdGFydCArIDI7IGkgPCBlbmQgLSAyOyBpICs9IDIpIHsKICAgICAgY29uc3QgZCA9IE1hdGguYWJzKGFhIC0gbmFieCAqIHBvaW50c1tpICsgMV0gKyBuYWJ5ICogcG9pbnRzW2ldKTsKICAgICAgaWYgKGQgPiBkbWF4KSB7CiAgICAgICAgaW5kZXggPSBpOwogICAgICAgIGRtYXggPSBkOwogICAgICB9CiAgICB9CiAgICBpZiAoZG1heCA+IChkaXN0ICogcGFydGlhbFBoaSkgKiogMikgewogICAgICB0aGlzLiNkb3VnbGFzUGV1Y2tlckhlbHBlcihwb2ludHMsIHN0YXJ0LCBpbmRleCArIDIsIG91dHB1dCk7CiAgICAgIHRoaXMuI2RvdWdsYXNQZXVja2VySGVscGVyKHBvaW50cywgaW5kZXgsIGVuZCwgb3V0cHV0KTsKICAgIH0gZWxzZSB7CiAgICAgIG91dHB1dC5wdXNoKGF4LCBheSk7CiAgICB9CiAgfQogIHN0YXRpYyAjZG91Z2xhc1BldWNrZXIocG9pbnRzKSB7CiAgICBjb25zdCBvdXRwdXQgPSBbXTsKICAgIGNvbnN0IGxlbiA9IHBvaW50cy5sZW5ndGg7CiAgICB0aGlzLiNkb3VnbGFzUGV1Y2tlckhlbHBlcihwb2ludHMsIDAsIGxlbiwgb3V0cHV0KTsKICAgIG91dHB1dC5wdXNoKHBvaW50c1tsZW4gLSAyXSwgcG9pbnRzW2xlbiAtIDFdKTsKICAgIHJldHVybiBvdXRwdXQubGVuZ3RoIDw9IDQgPyBudWxsIDogb3V0cHV0OwogIH0KICBzdGF0aWMgI2JpbGF0ZXJhbEZpbHRlcihidWYsIHdpZHRoLCBoZWlnaHQsIHNpZ21hUywgc2lnbWFSLCBrZXJuZWxTaXplKSB7CiAgICBjb25zdCBrZXJuZWwgPSBuZXcgRmxvYXQzMkFycmF5KGtlcm5lbFNpemUgKiogMik7CiAgICBjb25zdCBzaWdtYVMyID0gLTIgKiBzaWdtYVMgKiogMjsKICAgIGNvbnN0IGhhbGZTaXplID0ga2VybmVsU2l6ZSA+PiAxOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXJuZWxTaXplOyBpKyspIHsKICAgICAgY29uc3QgeCA9IChpIC0gaGFsZlNpemUpICoqIDI7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwga2VybmVsU2l6ZTsgaisrKSB7CiAgICAgICAga2VybmVsW2kgKiBrZXJuZWxTaXplICsgal0gPSBNYXRoLmV4cCgoeCArIChqIC0gaGFsZlNpemUpICoqIDIpIC8gc2lnbWFTMik7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJhbmdlVmFsdWVzID0gbmV3IEZsb2F0MzJBcnJheSgyNTYpOwogICAgY29uc3Qgc2lnbWFSMiA9IC0yICogc2lnbWFSICoqIDI7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI1NjsgaSsrKSB7CiAgICAgIHJhbmdlVmFsdWVzW2ldID0gTWF0aC5leHAoaSAqKiAyIC8gc2lnbWFSMik7CiAgICB9CiAgICBjb25zdCBOID0gYnVmLmxlbmd0aDsKICAgIGNvbnN0IG91dCA9IG5ldyBVaW50OEFycmF5KE4pOwogICAgY29uc3QgaGlzdG9ncmFtID0gbmV3IFVpbnQzMkFycmF5KDI1Nik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhlaWdodDsgaSsrKSB7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgd2lkdGg7IGorKykgewogICAgICAgIGNvbnN0IGlqID0gaSAqIHdpZHRoICsgajsKICAgICAgICBjb25zdCBjZW50ZXIgPSBidWZbaWpdOwogICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgIGxldCBub3JtID0gMDsKICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IGtlcm5lbFNpemU7IGsrKykgewogICAgICAgICAgY29uc3QgeSA9IGkgKyBrIC0gaGFsZlNpemU7CiAgICAgICAgICBpZiAoeSA8IDAgfHwgeSA+PSBoZWlnaHQpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGxldCBsID0gMDsgbCA8IGtlcm5lbFNpemU7IGwrKykgewogICAgICAgICAgICBjb25zdCB4ID0gaiArIGwgLSBoYWxmU2l6ZTsKICAgICAgICAgICAgaWYgKHggPCAwIHx8IHggPj0gd2lkdGgpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBuZWlnaGJvdXIgPSBidWZbeSAqIHdpZHRoICsgeF07CiAgICAgICAgICAgIGNvbnN0IHcgPSBrZXJuZWxbayAqIGtlcm5lbFNpemUgKyBsXSAqIHJhbmdlVmFsdWVzW01hdGguYWJzKG5laWdoYm91ciAtIGNlbnRlcildOwogICAgICAgICAgICBzdW0gKz0gbmVpZ2hib3VyICogdzsKICAgICAgICAgICAgbm9ybSArPSB3OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBwaXggPSBvdXRbaWpdID0gTWF0aC5yb3VuZChzdW0gLyBub3JtKTsKICAgICAgICBoaXN0b2dyYW1bcGl4XSsrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW291dCwgaGlzdG9ncmFtXTsKICB9CiAgc3RhdGljICNnZXRIaXN0b2dyYW0oYnVmKSB7CiAgICBjb25zdCBoaXN0b2dyYW0gPSBuZXcgVWludDMyQXJyYXkoMjU2KTsKICAgIGZvciAoY29uc3QgZyBvZiBidWYpIHsKICAgICAgaGlzdG9ncmFtW2ddKys7CiAgICB9CiAgICByZXR1cm4gaGlzdG9ncmFtOwogIH0KICBzdGF0aWMgI3RvVWludDgoYnVmKSB7CiAgICBjb25zdCBOID0gYnVmLmxlbmd0aDsKICAgIGNvbnN0IG91dCA9IG5ldyBVaW50OENsYW1wZWRBcnJheShOID4+IDIpOwogICAgbGV0IG1heCA9IC1JbmZpbml0eTsKICAgIGxldCBtaW4gPSBJbmZpbml0eTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IG91dC5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgIGNvbnN0IHBpeCA9IG91dFtpXSA9IGJ1ZltpIDw8IDJdOwogICAgICBtYXggPSBNYXRoLm1heChtYXgsIHBpeCk7CiAgICAgIG1pbiA9IE1hdGgubWluKG1pbiwgcGl4KTsKICAgIH0KICAgIGNvbnN0IHJhdGlvID0gMjU1IC8gKG1heCAtIG1pbik7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBvdXQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICBvdXRbaV0gPSAob3V0W2ldIC0gbWluKSAqIHJhdGlvOwogICAgfQogICAgcmV0dXJuIG91dDsKICB9CiAgc3RhdGljICNndWVzc1RocmVzaG9sZChoaXN0b2dyYW0pIHsKICAgIGxldCBpOwogICAgbGV0IE0gPSAtSW5maW5pdHk7CiAgICBsZXQgTCA9IC1JbmZpbml0eTsKICAgIGNvbnN0IG1pbiA9IGhpc3RvZ3JhbS5maW5kSW5kZXgoKHYpID0+IHYgIT09IDApOwogICAgbGV0IHBvcyA9IG1pbjsKICAgIGxldCBzcG9zID0gbWluOwogICAgZm9yIChpID0gbWluOyBpIDwgMjU2OyBpKyspIHsKICAgICAgY29uc3QgdiA9IGhpc3RvZ3JhbVtpXTsKICAgICAgaWYgKHYgPiBNKSB7CiAgICAgICAgaWYgKGkgLSBwb3MgPiBMKSB7CiAgICAgICAgICBMID0gaSAtIHBvczsKICAgICAgICAgIHNwb3MgPSBpIC0gMTsKICAgICAgICB9CiAgICAgICAgTSA9IHY7CiAgICAgICAgcG9zID0gaTsKICAgICAgfQogICAgfQogICAgZm9yIChpID0gc3BvcyAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGlmIChoaXN0b2dyYW1baV0gPiBoaXN0b2dyYW1baSArIDFdKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpOwogIH0KICBzdGF0aWMgI2dldEdyYXlQaXhlbHMoYml0bWFwKSB7CiAgICBjb25zdCBvcmlnaW5hbEJpdG1hcCA9IGJpdG1hcDsKICAgIGNvbnN0IHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IGJpdG1hcDsKICAgIGNvbnN0IHsKICAgICAgbWF4RGltCiAgICB9ID0gdGhpcy4jUEFSQU1FVEVSUzsKICAgIGxldCBuZXdXaWR0aCA9IHdpZHRoOwogICAgbGV0IG5ld0hlaWdodCA9IGhlaWdodDsKICAgIGlmICh3aWR0aCA+IG1heERpbSB8fCBoZWlnaHQgPiBtYXhEaW0pIHsKICAgICAgbGV0IHByZXZXaWR0aCA9IHdpZHRoOwogICAgICBsZXQgcHJldkhlaWdodCA9IGhlaWdodDsKICAgICAgbGV0IHN0ZXBzID0gTWF0aC5sb2cyKE1hdGgubWF4KHdpZHRoLCBoZWlnaHQpIC8gbWF4RGltKTsKICAgICAgY29uc3QgaXN0ZXBzID0gTWF0aC5mbG9vcihzdGVwcyk7CiAgICAgIHN0ZXBzID0gc3RlcHMgPT09IGlzdGVwcyA/IGlzdGVwcyAtIDEgOiBpc3RlcHM7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RlcHM7IGkrKykgewogICAgICAgIG5ld1dpZHRoID0gTWF0aC5jZWlsKHByZXZXaWR0aCAvIDIpOwogICAgICAgIG5ld0hlaWdodCA9IE1hdGguY2VpbChwcmV2SGVpZ2h0IC8gMik7CiAgICAgICAgY29uc3Qgb2Zmc2NyZWVuMiA9IG5ldyBPZmZzY3JlZW5DYW52YXMobmV3V2lkdGgsIG5ld0hlaWdodCk7CiAgICAgICAgY29uc3QgY3R4MiA9IG9mZnNjcmVlbjIuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgICBjdHgyLmRyYXdJbWFnZShiaXRtYXAsIDAsIDAsIHByZXZXaWR0aCwgcHJldkhlaWdodCwgMCwgMCwgbmV3V2lkdGgsIG5ld0hlaWdodCk7CiAgICAgICAgcHJldldpZHRoID0gbmV3V2lkdGg7CiAgICAgICAgcHJldkhlaWdodCA9IG5ld0hlaWdodDsKICAgICAgICBpZiAoYml0bWFwICE9PSBvcmlnaW5hbEJpdG1hcCkgewogICAgICAgICAgYml0bWFwLmNsb3NlKCk7CiAgICAgICAgfQogICAgICAgIGJpdG1hcCA9IG9mZnNjcmVlbjIudHJhbnNmZXJUb0ltYWdlQml0bWFwKCk7CiAgICAgIH0KICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbihtYXhEaW0gLyBuZXdXaWR0aCwgbWF4RGltIC8gbmV3SGVpZ2h0KTsKICAgICAgbmV3V2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoICogcmF0aW8pOwogICAgICBuZXdIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCAqIHJhdGlvKTsKICAgIH0KICAgIGNvbnN0IG9mZnNjcmVlbiA9IG5ldyBPZmZzY3JlZW5DYW52YXMobmV3V2lkdGgsIG5ld0hlaWdodCk7CiAgICBjb25zdCBjdHggPSBvZmZzY3JlZW4uZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgIHdpbGxSZWFkRnJlcXVlbnRseTogdHJ1ZQogICAgfSk7CiAgICBjdHguZmlsbFN0eWxlID0gIndoaXRlIjsKICAgIGN0eC5maWxsUmVjdCgwLCAwLCBuZXdXaWR0aCwgbmV3SGVpZ2h0KTsKICAgIGN0eC5maWx0ZXIgPSAiZ3JheXNjYWxlKDEpIjsKICAgIGN0eC5kcmF3SW1hZ2UoYml0bWFwLCAwLCAwLCBiaXRtYXAud2lkdGgsIGJpdG1hcC5oZWlnaHQsIDAsIDAsIG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgY29uc3QgZ3JheUltYWdlID0gY3R4LmdldEltYWdlRGF0YSgwLCAwLCBuZXdXaWR0aCwgbmV3SGVpZ2h0KS5kYXRhOwogICAgY29uc3QgdWludDhCdWYgPSB0aGlzLiN0b1VpbnQ4KGdyYXlJbWFnZSk7CiAgICByZXR1cm4gW3VpbnQ4QnVmLCBuZXdXaWR0aCwgbmV3SGVpZ2h0XTsKICB9CiAgc3RhdGljIGV4dHJhY3RDb250b3Vyc0Zyb21UZXh0KHRleHQsIHsKICAgIGZvbnRGYW1pbHksCiAgICBmb250U3R5bGUsCiAgICBmb250V2VpZ2h0CiAgfSwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCByb3RhdGlvbiwgaW5uZXJNYXJnaW4pIHsKICAgIGxldCBjYW52YXMgPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKDEsIDEpOwogICAgbGV0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsKICAgICAgYWxwaGE6IGZhbHNlCiAgICB9KTsKICAgIGNvbnN0IGZvbnRTaXplID0gMjAwOwogICAgY29uc3QgZm9udCA9IGN0eC5mb250ID0gYCR7Zm9udFN0eWxlfSAke2ZvbnRXZWlnaHR9ICR7Zm9udFNpemV9cHggJHtmb250RmFtaWx5fWA7CiAgICBjb25zdCB7CiAgICAgIGFjdHVhbEJvdW5kaW5nQm94TGVmdCwKICAgICAgYWN0dWFsQm91bmRpbmdCb3hSaWdodCwKICAgICAgYWN0dWFsQm91bmRpbmdCb3hBc2NlbnQsCiAgICAgIGFjdHVhbEJvdW5kaW5nQm94RGVzY2VudCwKICAgICAgZm9udEJvdW5kaW5nQm94QXNjZW50LAogICAgICBmb250Qm91bmRpbmdCb3hEZXNjZW50LAogICAgICB3aWR0aAogICAgfSA9IGN0eC5tZWFzdXJlVGV4dCh0ZXh0KTsKICAgIGNvbnN0IFNDQUxFID0gMS41OwogICAgY29uc3QgY2FudmFzV2lkdGggPSBNYXRoLmNlaWwoTWF0aC5tYXgoTWF0aC5hYnMoYWN0dWFsQm91bmRpbmdCb3hMZWZ0KSArIE1hdGguYWJzKGFjdHVhbEJvdW5kaW5nQm94UmlnaHQpIHx8IDAsIHdpZHRoKSAqIFNDQUxFKTsKICAgIGNvbnN0IGNhbnZhc0hlaWdodCA9IE1hdGguY2VpbChNYXRoLm1heChNYXRoLmFicyhhY3R1YWxCb3VuZGluZ0JveEFzY2VudCkgKyBNYXRoLmFicyhhY3R1YWxCb3VuZGluZ0JveERlc2NlbnQpIHx8IGZvbnRTaXplLCBNYXRoLmFicyhmb250Qm91bmRpbmdCb3hBc2NlbnQpICsgTWF0aC5hYnMoZm9udEJvdW5kaW5nQm94RGVzY2VudCkgfHwgZm9udFNpemUpICogU0NBTEUpOwogICAgY2FudmFzID0gbmV3IE9mZnNjcmVlbkNhbnZhcyhjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0KTsKICAgIGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsKICAgICAgYWxwaGE6IHRydWUsCiAgICAgIHdpbGxSZWFkRnJlcXVlbnRseTogdHJ1ZQogICAgfSk7CiAgICBjdHguZm9udCA9IGZvbnQ7CiAgICBjdHguZmlsdGVyID0gImdyYXlzY2FsZSgxKSI7CiAgICBjdHguZmlsbFN0eWxlID0gIndoaXRlIjsKICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0KTsKICAgIGN0eC5maWxsU3R5bGUgPSAiYmxhY2siOwogICAgY3R4LmZpbGxUZXh0KHRleHQsIGNhbnZhc1dpZHRoICogKFNDQUxFIC0gMSkgLyAyLCBjYW52YXNIZWlnaHQgKiAoMyAtIFNDQUxFKSAvIDIpOwogICAgY29uc3QgdWludDhCdWYgPSB0aGlzLiN0b1VpbnQ4KGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgY2FudmFzV2lkdGgsIGNhbnZhc0hlaWdodCkuZGF0YSk7CiAgICBjb25zdCBoaXN0b2dyYW0gPSB0aGlzLiNnZXRIaXN0b2dyYW0odWludDhCdWYpOwogICAgY29uc3QgdGhyZXNob2xkID0gdGhpcy4jZ3Vlc3NUaHJlc2hvbGQoaGlzdG9ncmFtKTsKICAgIGNvbnN0IGNvbnRvdXJMaXN0ID0gdGhpcy4jZmluZENvbnRvdXJzKHVpbnQ4QnVmLCBjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0LCB0aHJlc2hvbGQpOwogICAgcmV0dXJuIHRoaXMucHJvY2Vzc0RyYXduTGluZXMoewogICAgICBsaW5lczogewogICAgICAgIGN1cnZlczogY29udG91ckxpc3QsCiAgICAgICAgd2lkdGg6IGNhbnZhc1dpZHRoLAogICAgICAgIGhlaWdodDogY2FudmFzSGVpZ2h0CiAgICAgIH0sCiAgICAgIHBhZ2VXaWR0aCwKICAgICAgcGFnZUhlaWdodCwKICAgICAgcm90YXRpb24sCiAgICAgIGlubmVyTWFyZ2luLAogICAgICBtdXN0U21vb3RoOiB0cnVlLAogICAgICBhcmVDb250b3VyczogdHJ1ZQogICAgfSk7CiAgfQogIHN0YXRpYyBwcm9jZXNzKGJpdG1hcCwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCByb3RhdGlvbiwgaW5uZXJNYXJnaW4pIHsKICAgIGNvbnN0IFt1aW50OEJ1Ziwgd2lkdGgsIGhlaWdodF0gPSB0aGlzLiNnZXRHcmF5UGl4ZWxzKGJpdG1hcCk7CiAgICBjb25zdCBbYnVmZmVyLCBoaXN0b2dyYW1dID0gdGhpcy4jYmlsYXRlcmFsRmlsdGVyKHVpbnQ4QnVmLCB3aWR0aCwgaGVpZ2h0LCBNYXRoLmh5cG90KHdpZHRoLCBoZWlnaHQpICogdGhpcy4jUEFSQU1FVEVSUy5zaWdtYVNGYWN0b3IsIHRoaXMuI1BBUkFNRVRFUlMuc2lnbWFSLCB0aGlzLiNQQVJBTUVURVJTLmtlcm5lbFNpemUpOwogICAgY29uc3QgdGhyZXNob2xkID0gdGhpcy4jZ3Vlc3NUaHJlc2hvbGQoaGlzdG9ncmFtKTsKICAgIGNvbnN0IGNvbnRvdXJMaXN0ID0gdGhpcy4jZmluZENvbnRvdXJzKGJ1ZmZlciwgd2lkdGgsIGhlaWdodCwgdGhyZXNob2xkKTsKICAgIHJldHVybiB0aGlzLnByb2Nlc3NEcmF3bkxpbmVzKHsKICAgICAgbGluZXM6IHsKICAgICAgICBjdXJ2ZXM6IGNvbnRvdXJMaXN0LAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9LAogICAgICBwYWdlV2lkdGgsCiAgICAgIHBhZ2VIZWlnaHQsCiAgICAgIHJvdGF0aW9uLAogICAgICBpbm5lck1hcmdpbiwKICAgICAgbXVzdFNtb290aDogdHJ1ZSwKICAgICAgYXJlQ29udG91cnM6IHRydWUKICAgIH0pOwogIH0KICBzdGF0aWMgcHJvY2Vzc0RyYXduTGluZXMoewogICAgbGluZXMsCiAgICBwYWdlV2lkdGgsCiAgICBwYWdlSGVpZ2h0LAogICAgcm90YXRpb24sCiAgICBpbm5lck1hcmdpbiwKICAgIG11c3RTbW9vdGgsCiAgICBhcmVDb250b3VycwogIH0pIHsKICAgIGlmIChyb3RhdGlvbiAlIDE4MCAhPT0gMCkgewogICAgICBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IFtwYWdlSGVpZ2h0LCBwYWdlV2lkdGhdOwogICAgfQogICAgY29uc3QgewogICAgICBjdXJ2ZXMsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSBsaW5lczsKICAgIGNvbnN0IHRoaWNrbmVzcyA9IGxpbmVzLnRoaWNrbmVzcyA/PyAwOwogICAgY29uc3QgbGluZXNBbmRQb2ludHMgPSBbXTsKICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4ocGFnZVdpZHRoIC8gd2lkdGgsIHBhZ2VIZWlnaHQgLyBoZWlnaHQpOwogICAgY29uc3QgeFNjYWxlID0gcmF0aW8gLyBwYWdlV2lkdGg7CiAgICBjb25zdCB5U2NhbGUgPSByYXRpbyAvIHBhZ2VIZWlnaHQ7CiAgICBjb25zdCBuZXdDdXJ2ZXMgPSBbXTsKICAgIGZvciAoY29uc3QgewogICAgICBwb2ludHMKICAgIH0gb2YgY3VydmVzKSB7CiAgICAgIGNvbnN0IHJlZHVjZWRQb2ludHMgPSBtdXN0U21vb3RoID8gdGhpcy4jZG91Z2xhc1BldWNrZXIocG9pbnRzKSA6IHBvaW50czsKICAgICAgaWYgKCFyZWR1Y2VkUG9pbnRzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbmV3Q3VydmVzLnB1c2gocmVkdWNlZFBvaW50cyk7CiAgICAgIGNvbnN0IGxlbiA9IHJlZHVjZWRQb2ludHMubGVuZ3RoOwogICAgICBjb25zdCBuZXdQb2ludHMgPSBuZXcgRmxvYXQzMkFycmF5KGxlbik7CiAgICAgIGNvbnN0IGxpbmUgPSBuZXcgRmxvYXQzMkFycmF5KDMgKiAobGVuID09PSAyID8gMiA6IGxlbiAtIDIpKTsKICAgICAgbGluZXNBbmRQb2ludHMucHVzaCh7CiAgICAgICAgbGluZSwKICAgICAgICBwb2ludHM6IG5ld1BvaW50cwogICAgICB9KTsKICAgICAgaWYgKGxlbiA9PT0gMikgewogICAgICAgIG5ld1BvaW50c1swXSA9IHJlZHVjZWRQb2ludHNbMF0gKiB4U2NhbGU7CiAgICAgICAgbmV3UG9pbnRzWzFdID0gcmVkdWNlZFBvaW50c1sxXSAqIHlTY2FsZTsKICAgICAgICBsaW5lLnNldChbTmFOLCBOYU4sIE5hTiwgTmFOLCBuZXdQb2ludHNbMF0sIG5ld1BvaW50c1sxXV0sIDApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGxldCBbeDEsIHkxLCB4MiwgeTJdID0gcmVkdWNlZFBvaW50czsKICAgICAgeDEgKj0geFNjYWxlOwogICAgICB5MSAqPSB5U2NhbGU7CiAgICAgIHgyICo9IHhTY2FsZTsKICAgICAgeTIgKj0geVNjYWxlOwogICAgICBuZXdQb2ludHMuc2V0KFt4MSwgeTEsIHgyLCB5Ml0sIDApOwogICAgICBsaW5lLnNldChbTmFOLCBOYU4sIE5hTiwgTmFOLCB4MSwgeTFdLCAwKTsKICAgICAgZm9yIChsZXQgaSA9IDQ7IGkgPCBsZW47IGkgKz0gMikgewogICAgICAgIGNvbnN0IHggPSBuZXdQb2ludHNbaV0gPSByZWR1Y2VkUG9pbnRzW2ldICogeFNjYWxlOwogICAgICAgIGNvbnN0IHkgPSBuZXdQb2ludHNbaSArIDFdID0gcmVkdWNlZFBvaW50c1tpICsgMV0gKiB5U2NhbGU7CiAgICAgICAgbGluZS5zZXQoT3V0bGluZS5jcmVhdGVCZXppZXJQb2ludHMoeDEsIHkxLCB4MiwgeTIsIHgsIHkpLCAoaSAtIDIpICogMyk7CiAgICAgICAgW3gxLCB5MSwgeDIsIHkyXSA9IFt4MiwgeTIsIHgsIHldOwogICAgICB9CiAgICB9CiAgICBpZiAobGluZXNBbmRQb2ludHMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgb3V0bGluZSA9IGFyZUNvbnRvdXJzID8gbmV3IENvbnRvdXJEcmF3T3V0bGluZSgpIDogbmV3IElua0RyYXdPdXRsaW5lKCk7CiAgICBvdXRsaW5lLmJ1aWxkKGxpbmVzQW5kUG9pbnRzLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQsIDEsIHJvdGF0aW9uLCBhcmVDb250b3VycyA/IDAgOiB0aGlja25lc3MsIGlubmVyTWFyZ2luKTsKICAgIHJldHVybiB7CiAgICAgIG91dGxpbmUsCiAgICAgIG5ld0N1cnZlcywKICAgICAgYXJlQ29udG91cnMsCiAgICAgIHRoaWNrbmVzcywKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfTsKICB9CiAgc3RhdGljIGFzeW5jIGNvbXByZXNzU2lnbmF0dXJlKHsKICAgIG91dGxpbmVzLAogICAgYXJlQ29udG91cnMsCiAgICB0aGlja25lc3MsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pIHsKICAgIGxldCBtaW5EaWZmID0gSW5maW5pdHk7CiAgICBsZXQgbWF4RGlmZiA9IC1JbmZpbml0eTsKICAgIGxldCBvdXRsaW5lc0xlbmd0aCA9IDA7CiAgICBmb3IgKGNvbnN0IHBvaW50cyBvZiBvdXRsaW5lcykgewogICAgICBvdXRsaW5lc0xlbmd0aCArPSBwb2ludHMubGVuZ3RoOwogICAgICBmb3IgKGxldCBpID0gMiwgaWkgPSBwb2ludHMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGNvbnN0IGR4ID0gcG9pbnRzW2ldIC0gcG9pbnRzW2kgLSAyXTsKICAgICAgICBtaW5EaWZmID0gTWF0aC5taW4obWluRGlmZiwgZHgpOwogICAgICAgIG1heERpZmYgPSBNYXRoLm1heChtYXhEaWZmLCBkeCk7CiAgICAgIH0KICAgIH0KICAgIGxldCBidWZmZXJUeXBlOwogICAgaWYgKG1pbkRpZmYgPj0gLTEyOCAmJiBtYXhEaWZmIDw9IDEyNykgewogICAgICBidWZmZXJUeXBlID0gSW50OEFycmF5OwogICAgfSBlbHNlIGlmIChtaW5EaWZmID49IC0zMjc2OCAmJiBtYXhEaWZmIDw9IDMyNzY3KSB7CiAgICAgIGJ1ZmZlclR5cGUgPSBJbnQxNkFycmF5OwogICAgfSBlbHNlIHsKICAgICAgYnVmZmVyVHlwZSA9IEludDMyQXJyYXk7CiAgICB9CiAgICBjb25zdCBsZW4gPSBvdXRsaW5lcy5sZW5ndGg7CiAgICBjb25zdCBoZWFkZXJMZW5ndGggPSBCQVNFX0hFQURFUl9MRU5HVEggKyBQT0lOVFNfUFJPUEVSVElFU19OVU1CRVIgKiBsZW47CiAgICBjb25zdCBoZWFkZXIgPSBuZXcgVWludDMyQXJyYXkoaGVhZGVyTGVuZ3RoKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgaGVhZGVyW29mZnNldCsrXSA9IGhlYWRlckxlbmd0aCAqIFVpbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UICsgKG91dGxpbmVzTGVuZ3RoIC0gMiAqIGxlbikgKiBidWZmZXJUeXBlLkJZVEVTX1BFUl9FTEVNRU5UOwogICAgaGVhZGVyW29mZnNldCsrXSA9IDA7CiAgICBoZWFkZXJbb2Zmc2V0KytdID0gd2lkdGg7CiAgICBoZWFkZXJbb2Zmc2V0KytdID0gaGVpZ2h0OwogICAgaGVhZGVyW29mZnNldCsrXSA9IGFyZUNvbnRvdXJzID8gMCA6IDE7CiAgICBoZWFkZXJbb2Zmc2V0KytdID0gTWF0aC5tYXgoMCwgTWF0aC5mbG9vcih0aGlja25lc3MgPz8gMCkpOwogICAgaGVhZGVyW29mZnNldCsrXSA9IGxlbjsKICAgIGhlYWRlcltvZmZzZXQrK10gPSBidWZmZXJUeXBlLkJZVEVTX1BFUl9FTEVNRU5UOwogICAgZm9yIChjb25zdCBwb2ludHMgb2Ygb3V0bGluZXMpIHsKICAgICAgaGVhZGVyW29mZnNldCsrXSA9IHBvaW50cy5sZW5ndGggLSAyOwogICAgICBoZWFkZXJbb2Zmc2V0KytdID0gcG9pbnRzWzBdOwogICAgICBoZWFkZXJbb2Zmc2V0KytdID0gcG9pbnRzWzFdOwogICAgfQogICAgY29uc3QgY3MgPSBuZXcgQ29tcHJlc3Npb25TdHJlYW0oImRlZmxhdGUtcmF3Iik7CiAgICBjb25zdCB3cml0ZXIgPSBjcy53cml0YWJsZS5nZXRXcml0ZXIoKTsKICAgIGF3YWl0IHdyaXRlci5yZWFkeTsKICAgIHdyaXRlci53cml0ZShoZWFkZXIpOwogICAgY29uc3QgQnVmZmVyQ3RvciA9IGJ1ZmZlclR5cGUucHJvdG90eXBlLmNvbnN0cnVjdG9yOwogICAgZm9yIChjb25zdCBwb2ludHMgb2Ygb3V0bGluZXMpIHsKICAgICAgY29uc3QgZGlmZnMgPSBuZXcgQnVmZmVyQ3Rvcihwb2ludHMubGVuZ3RoIC0gMik7CiAgICAgIGZvciAobGV0IGkgPSAyLCBpaSA9IHBvaW50cy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgZGlmZnNbaSAtIDJdID0gcG9pbnRzW2ldIC0gcG9pbnRzW2kgLSAyXTsKICAgICAgfQogICAgICB3cml0ZXIud3JpdGUoZGlmZnMpOwogICAgfQogICAgd3JpdGVyLmNsb3NlKCk7CiAgICBjb25zdCBidWYgPSBhd2FpdCBuZXcgUmVzcG9uc2UoY3MucmVhZGFibGUpLmFycmF5QnVmZmVyKCk7CiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgICByZXR1cm4gdG9CYXNlNjRVdGlsKGJ5dGVzKTsKICB9CiAgc3RhdGljIGFzeW5jIGRlY29tcHJlc3NTaWduYXR1cmUoc2lnbmF0dXJlRGF0YSkgewogICAgdHJ5IHsKICAgICAgY29uc3QgYnl0ZXMgPSBmcm9tQmFzZTY0VXRpbChzaWduYXR1cmVEYXRhKTsKICAgICAgY29uc3QgewogICAgICAgIHJlYWRhYmxlLAogICAgICAgIHdyaXRhYmxlCiAgICAgIH0gPSBuZXcgRGVjb21wcmVzc2lvblN0cmVhbSgiZGVmbGF0ZS1yYXciKTsKICAgICAgY29uc3Qgd3JpdGVyID0gd3JpdGFibGUuZ2V0V3JpdGVyKCk7CiAgICAgIGF3YWl0IHdyaXRlci5yZWFkeTsKICAgICAgd3JpdGVyLndyaXRlKGJ5dGVzKS50aGVuKGFzeW5jICgpID0+IHsKICAgICAgICBhd2FpdCB3cml0ZXIucmVhZHk7CiAgICAgICAgYXdhaXQgd3JpdGVyLmNsb3NlKCk7CiAgICAgIH0pLmNhdGNoKCgpID0+IHsKICAgICAgfSk7CiAgICAgIGxldCBkYXRhID0gbnVsbDsKICAgICAgbGV0IG9mZnNldCA9IDA7CiAgICAgIGZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgcmVhZGFibGUpIHsKICAgICAgICBkYXRhIHx8PSBuZXcgVWludDhBcnJheShuZXcgVWludDMyQXJyYXkoY2h1bmsuYnVmZmVyLCAwLCA0KVswXSk7CiAgICAgICAgZGF0YS5zZXQoY2h1bmssIG9mZnNldCk7CiAgICAgICAgb2Zmc2V0ICs9IGNodW5rLmxlbmd0aDsKICAgICAgfQogICAgICBjb25zdCBoZWFkZXIgPSBuZXcgVWludDMyQXJyYXkoZGF0YS5idWZmZXIsIDAsIGRhdGEubGVuZ3RoID4+IDIpOwogICAgICBjb25zdCB2ZXJzaW9uMiA9IGhlYWRlclsxXTsKICAgICAgaWYgKHZlcnNpb24yICE9PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHZlcnNpb246ICR7dmVyc2lvbjJ9YCk7CiAgICAgIH0KICAgICAgY29uc3Qgd2lkdGggPSBoZWFkZXJbMl07CiAgICAgIGNvbnN0IGhlaWdodCA9IGhlYWRlclszXTsKICAgICAgY29uc3QgYXJlQ29udG91cnMgPSBoZWFkZXJbNF0gPT09IDA7CiAgICAgIGNvbnN0IHRoaWNrbmVzcyA9IGhlYWRlcls1XTsKICAgICAgY29uc3QgbnVtYmVyT2ZEcmF3aW5ncyA9IGhlYWRlcls2XTsKICAgICAgY29uc3QgYnVmZmVyVHlwZSA9IGhlYWRlcls3XTsKICAgICAgY29uc3Qgb3V0bGluZXMgPSBbXTsKICAgICAgY29uc3QgZGlmZnNPZmZzZXQgPSAoQkFTRV9IRUFERVJfTEVOR1RIICsgUE9JTlRTX1BST1BFUlRJRVNfTlVNQkVSICogbnVtYmVyT2ZEcmF3aW5ncykgKiBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKICAgICAgbGV0IGRpZmZzOwogICAgICBzd2l0Y2ggKGJ1ZmZlclR5cGUpIHsKICAgICAgICBjYXNlIEludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVDoKICAgICAgICAgIGRpZmZzID0gbmV3IEludDhBcnJheShkYXRhLmJ1ZmZlciwgZGlmZnNPZmZzZXQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBJbnQxNkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOgogICAgICAgICAgZGlmZnMgPSBuZXcgSW50MTZBcnJheShkYXRhLmJ1ZmZlciwgZGlmZnNPZmZzZXQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBJbnQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOgogICAgICAgICAgZGlmZnMgPSBuZXcgSW50MzJBcnJheShkYXRhLmJ1ZmZlciwgZGlmZnNPZmZzZXQpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgb2Zmc2V0ID0gMDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1iZXJPZkRyYXdpbmdzOyBpKyspIHsKICAgICAgICBjb25zdCBsZW4gPSBoZWFkZXJbUE9JTlRTX1BST1BFUlRJRVNfTlVNQkVSICogaSArIEJBU0VfSEVBREVSX0xFTkdUSF07CiAgICAgICAgY29uc3QgcG9pbnRzID0gbmV3IEZsb2F0MzJBcnJheShsZW4gKyAyKTsKICAgICAgICBvdXRsaW5lcy5wdXNoKHBvaW50cyk7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBQT0lOVFNfUFJPUEVSVElFU19OVU1CRVIgLSAxOyBqKyspIHsKICAgICAgICAgIHBvaW50c1tqXSA9IGhlYWRlcltQT0lOVFNfUFJPUEVSVElFU19OVU1CRVIgKiBpICsgQkFTRV9IRUFERVJfTEVOR1RIICsgaiArIDFdOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICBwb2ludHNbaiArIDJdID0gcG9pbnRzW2pdICsgZGlmZnNbb2Zmc2V0KytdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGFyZUNvbnRvdXJzLAogICAgICAgIHRoaWNrbmVzcywKICAgICAgICBvdXRsaW5lcywKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQKICAgICAgfTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgd2FybihgZGVjb21wcmVzc1NpZ25hdHVyZTogJHtlfWApOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9Cn07CnZhciBTaWduYXR1cmVPcHRpb25zID0gY2xhc3MgX1NpZ25hdHVyZU9wdGlvbnMgZXh0ZW5kcyBEcmF3aW5nT3B0aW9ucyB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigpOwogICAgc3VwZXIudXBkYXRlUHJvcGVydGllcyh7CiAgICAgIGZpbGw6IEFubm90YXRpb25FZGl0b3IuX2RlZmF1bHRMaW5lQ29sb3IsCiAgICAgICJzdHJva2Utd2lkdGgiOiAwCiAgICB9KTsKICB9CiAgY2xvbmUoKSB7CiAgICBjb25zdCBjbG9uZSA9IG5ldyBfU2lnbmF0dXJlT3B0aW9ucygpOwogICAgY2xvbmUudXBkYXRlQWxsKHRoaXMpOwogICAgcmV0dXJuIGNsb25lOwogIH0KfTsKdmFyIERyYXduU2lnbmF0dXJlT3B0aW9ucyA9IGNsYXNzIF9EcmF3blNpZ25hdHVyZU9wdGlvbnMgZXh0ZW5kcyBJbmtEcmF3aW5nT3B0aW9ucyB7CiAgY29uc3RydWN0b3Iodmlld2VyUGFyYW1ldGVycykgewogICAgc3VwZXIodmlld2VyUGFyYW1ldGVycyk7CiAgICBzdXBlci51cGRhdGVQcm9wZXJ0aWVzKHsKICAgICAgc3Ryb2tlOiBBbm5vdGF0aW9uRWRpdG9yLl9kZWZhdWx0TGluZUNvbG9yLAogICAgICAic3Ryb2tlLXdpZHRoIjogMQogICAgfSk7CiAgfQogIGNsb25lKCkgewogICAgY29uc3QgY2xvbmUgPSBuZXcgX0RyYXduU2lnbmF0dXJlT3B0aW9ucyh0aGlzLl92aWV3UGFyYW1ldGVycyk7CiAgICBjbG9uZS51cGRhdGVBbGwodGhpcyk7CiAgICByZXR1cm4gY2xvbmU7CiAgfQp9Owp2YXIgU2lnbmF0dXJlRWRpdG9yID0gY2xhc3MgX1NpZ25hdHVyZUVkaXRvciBleHRlbmRzIERyYXdpbmdFZGl0b3IgewogICNpc0V4dHJhY3RlZCA9IGZhbHNlOwogICNkZXNjcmlwdGlvbiA9IG51bGw7CiAgI3NpZ25hdHVyZURhdGEgPSBudWxsOwogICNzaWduYXR1cmVVVUlEID0gbnVsbDsKICBzdGF0aWMgX3R5cGUgPSAic2lnbmF0dXJlIjsKICBzdGF0aWMgX2VkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5TSUdOQVRVUkU7CiAgc3RhdGljIF9kZWZhdWx0RHJhd2luZ09wdGlvbnMgPSBudWxsOwogIGNvbnN0cnVjdG9yKHBhcmFtcykgewogICAgc3VwZXIoewogICAgICAuLi5wYXJhbXMsCiAgICAgIG11c3RCZUNvbW1pdHRlZDogdHJ1ZSwKICAgICAgbmFtZTogInNpZ25hdHVyZUVkaXRvciIKICAgIH0pOwogICAgdGhpcy5fd2lsbEtlZXBBc3BlY3RSYXRpbyA9IHRydWU7CiAgICB0aGlzLiNzaWduYXR1cmVEYXRhID0gcGFyYW1zLnNpZ25hdHVyZURhdGEgfHwgbnVsbDsKICAgIHRoaXMuI2Rlc2NyaXB0aW9uID0gbnVsbDsKICAgIHRoaXMuZGVmYXVsdEwxMG5JZCA9ICJwZGZqcy1lZGl0b3Itc2lnbmF0dXJlLWVkaXRvcjEiOwogIH0KICBzdGF0aWMgaW5pdGlhbGl6ZShsMTBuLCB1aU1hbmFnZXIpIHsKICAgIEFubm90YXRpb25FZGl0b3IuaW5pdGlhbGl6ZShsMTBuLCB1aU1hbmFnZXIpOwogICAgdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zID0gbmV3IFNpZ25hdHVyZU9wdGlvbnMoKTsKICAgIHRoaXMuX2RlZmF1bHREcmF3blNpZ25hdHVyZU9wdGlvbnMgPSBuZXcgRHJhd25TaWduYXR1cmVPcHRpb25zKHVpTWFuYWdlci52aWV3UGFyYW1ldGVycyk7CiAgfQogIHN0YXRpYyBnZXREZWZhdWx0RHJhd2luZ09wdGlvbnMob3B0aW9ucykgewogICAgY29uc3QgY2xvbmUgPSB0aGlzLl9kZWZhdWx0RHJhd2luZ09wdGlvbnMuY2xvbmUoKTsKICAgIGNsb25lLnVwZGF0ZVByb3BlcnRpZXMob3B0aW9ucyk7CiAgICByZXR1cm4gY2xvbmU7CiAgfQogIHN0YXRpYyBnZXQgc3VwcG9ydE11bHRpcGxlRHJhd2luZ3MoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHN0YXRpYyBnZXQgdHlwZXNNYXAoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJ0eXBlc01hcCIsIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogIH0KICBzdGF0aWMgZ2V0IGlzRHJhd2VyKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBnZXQgdGVsZW1ldHJ5RmluYWxEYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogInNpZ25hdHVyZSIsCiAgICAgIGhhc0Rlc2NyaXB0aW9uOiAhIXRoaXMuI2Rlc2NyaXB0aW9uCiAgICB9OwogIH0KICBzdGF0aWMgY29tcHV0ZVRlbGVtZXRyeUZpbmFsRGF0YShkYXRhKSB7CiAgICBjb25zdCBoYXNEZXNjcmlwdGlvblN0YXRzID0gZGF0YS5nZXQoImhhc0Rlc2NyaXB0aW9uIik7CiAgICByZXR1cm4gewogICAgICBoYXNBbHRUZXh0OiBoYXNEZXNjcmlwdGlvblN0YXRzLmdldCh0cnVlKSA/PyAwLAogICAgICBoYXNOb0FsdFRleHQ6IGhhc0Rlc2NyaXB0aW9uU3RhdHMuZ2V0KGZhbHNlKSA/PyAwCiAgICB9OwogIH0KICBnZXQgaXNSZXNpemFibGUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgb25TY2FsZUNoYW5naW5nKCkgewogICAgaWYgKHRoaXMuX2RyYXdJZCA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5vblNjYWxlQ2hhbmdpbmcoKTsKICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHJldHVybiB0aGlzLmRpdjsKICAgIH0KICAgIGxldCBiYXNlWCwgYmFzZVk7CiAgICBjb25zdCB7CiAgICAgIF9pc0NvcHkKICAgIH0gPSB0aGlzOwogICAgaWYgKF9pc0NvcHkpIHsKICAgICAgdGhpcy5faXNDb3B5ID0gZmFsc2U7CiAgICAgIGJhc2VYID0gdGhpcy54OwogICAgICBiYXNlWSA9IHRoaXMueTsKICAgIH0KICAgIHN1cGVyLnJlbmRlcigpOwogICAgaWYgKHRoaXMuX2RyYXdJZCA9PT0gbnVsbCkgewogICAgICBpZiAodGhpcy4jc2lnbmF0dXJlRGF0YSkgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGxpbmVzLAogICAgICAgICAgbXVzdFNtb290aCwKICAgICAgICAgIGFyZUNvbnRvdXJzLAogICAgICAgICAgZGVzY3JpcHRpb24sCiAgICAgICAgICB1dWlkLAogICAgICAgICAgaGVpZ2h0SW5QYWdlCiAgICAgICAgfSA9IHRoaXMuI3NpZ25hdHVyZURhdGE7CiAgICAgICAgY29uc3QgewogICAgICAgICAgcmF3RGltczogewogICAgICAgICAgICBwYWdlV2lkdGgsCiAgICAgICAgICAgIHBhZ2VIZWlnaHQKICAgICAgICAgIH0sCiAgICAgICAgICByb3RhdGlvbgogICAgICAgIH0gPSB0aGlzLnBhcmVudC52aWV3cG9ydDsKICAgICAgICBjb25zdCBvdXRsaW5lID0gU2lnbmF0dXJlRXh0cmFjdG9yLnByb2Nlc3NEcmF3bkxpbmVzKHsKICAgICAgICAgIGxpbmVzLAogICAgICAgICAgcGFnZVdpZHRoLAogICAgICAgICAgcGFnZUhlaWdodCwKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgaW5uZXJNYXJnaW46IF9TaWduYXR1cmVFZGl0b3IuX0lOTkVSX01BUkdJTiwKICAgICAgICAgIG11c3RTbW9vdGgsCiAgICAgICAgICBhcmVDb250b3VycwogICAgICAgIH0pOwogICAgICAgIHRoaXMuYWRkU2lnbmF0dXJlKG91dGxpbmUsIGhlaWdodEluUGFnZSwgZGVzY3JpcHRpb24sIHV1aWQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWFyZ3MiLCBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBkZXNjcmlwdGlvbjogIiIKICAgICAgICB9KSk7CiAgICAgICAgdGhpcy5kaXYuaGlkZGVuID0gdHJ1ZTsKICAgICAgICB0aGlzLl91aU1hbmFnZXIuZ2V0U2lnbmF0dXJlKHRoaXMpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLmRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1hcmdzIiwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLiNkZXNjcmlwdGlvbiB8fCAiIgogICAgICB9KSk7CiAgICB9CiAgICBpZiAoX2lzQ29weSkgewogICAgICB0aGlzLl9pc0NvcHkgPSB0cnVlOwogICAgICB0aGlzLl9tb3ZlQWZ0ZXJQYXN0ZShiYXNlWCwgYmFzZVkpOwogICAgfQogICAgcmV0dXJuIHRoaXMuZGl2OwogIH0KICBzZXRVdWlkKHV1aWQpIHsKICAgIHRoaXMuI3NpZ25hdHVyZVVVSUQgPSB1dWlkOwogICAgdGhpcy5hZGRFZGl0VG9vbGJhcigpOwogIH0KICBnZXRVdWlkKCkgewogICAgcmV0dXJuIHRoaXMuI3NpZ25hdHVyZVVVSUQ7CiAgfQogIGdldCBkZXNjcmlwdGlvbigpIHsKICAgIHJldHVybiB0aGlzLiNkZXNjcmlwdGlvbjsKICB9CiAgc2V0IGRlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKSB7CiAgICB0aGlzLiNkZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uOwogICAgaWYgKCF0aGlzLmRpdikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1hcmdzIiwgSlNPTi5zdHJpbmdpZnkoewogICAgICBkZXNjcmlwdGlvbgogICAgfSkpOwogICAgc3VwZXIuYWRkRWRpdFRvb2xiYXIoKS50aGVuKCh0b29sYmFyKSA9PiB7CiAgICAgIHRvb2xiYXI/LnVwZGF0ZUVkaXRTaWduYXR1cmVCdXR0b24oZGVzY3JpcHRpb24pOwogICAgfSk7CiAgfQogIGdldFNpZ25hdHVyZVByZXZpZXcoKSB7CiAgICBjb25zdCB7CiAgICAgIG5ld0N1cnZlcywKICAgICAgYXJlQ29udG91cnMsCiAgICAgIHRoaWNrbmVzcywKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXMuI3NpZ25hdHVyZURhdGE7CiAgICBjb25zdCBtYXhEaW0gPSBNYXRoLm1heCh3aWR0aCwgaGVpZ2h0KTsKICAgIGNvbnN0IG91dGxpbmVEYXRhID0gU2lnbmF0dXJlRXh0cmFjdG9yLnByb2Nlc3NEcmF3bkxpbmVzKHsKICAgICAgbGluZXM6IHsKICAgICAgICBjdXJ2ZXM6IG5ld0N1cnZlcy5tYXAoKHBvaW50cykgPT4gKHsKICAgICAgICAgIHBvaW50cwogICAgICAgIH0pKSwKICAgICAgICB0aGlja25lc3MsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0CiAgICAgIH0sCiAgICAgIHBhZ2VXaWR0aDogbWF4RGltLAogICAgICBwYWdlSGVpZ2h0OiBtYXhEaW0sCiAgICAgIHJvdGF0aW9uOiAwLAogICAgICBpbm5lck1hcmdpbjogMCwKICAgICAgbXVzdFNtb290aDogZmFsc2UsCiAgICAgIGFyZUNvbnRvdXJzCiAgICB9KTsKICAgIHJldHVybiB7CiAgICAgIGFyZUNvbnRvdXJzLAogICAgICBvdXRsaW5lOiBvdXRsaW5lRGF0YS5vdXRsaW5lCiAgICB9OwogIH0KICBnZXQgdG9vbGJhckJ1dHRvbnMoKSB7CiAgICBpZiAodGhpcy5fdWlNYW5hZ2VyLnNpZ25hdHVyZU1hbmFnZXIpIHsKICAgICAgcmV0dXJuIFtbImVkaXRTaWduYXR1cmUiLCB0aGlzLl91aU1hbmFnZXIuc2lnbmF0dXJlTWFuYWdlcl1dOwogICAgfQogICAgcmV0dXJuIHN1cGVyLnRvb2xiYXJCdXR0b25zOwogIH0KICBhZGRTaWduYXR1cmUoZGF0YSwgaGVpZ2h0SW5QYWdlLCBkZXNjcmlwdGlvbiwgdXVpZCkgewogICAgY29uc3QgewogICAgICB4OiBzYXZlZFgsCiAgICAgIHk6IHNhdmVkWQogICAgfSA9IHRoaXM7CiAgICBjb25zdCB7CiAgICAgIG91dGxpbmUKICAgIH0gPSB0aGlzLiNzaWduYXR1cmVEYXRhID0gZGF0YTsKICAgIHRoaXMuI2lzRXh0cmFjdGVkID0gb3V0bGluZSBpbnN0YW5jZW9mIENvbnRvdXJEcmF3T3V0bGluZTsKICAgIHRoaXMuZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjsKICAgIGxldCBkcmF3aW5nT3B0aW9uczsKICAgIGlmICh0aGlzLiNpc0V4dHJhY3RlZCkgewogICAgICBkcmF3aW5nT3B0aW9ucyA9IF9TaWduYXR1cmVFZGl0b3IuZ2V0RGVmYXVsdERyYXdpbmdPcHRpb25zKCk7CiAgICB9IGVsc2UgewogICAgICBkcmF3aW5nT3B0aW9ucyA9IF9TaWduYXR1cmVFZGl0b3IuX2RlZmF1bHREcmF3blNpZ25hdHVyZU9wdGlvbnMuY2xvbmUoKTsKICAgICAgZHJhd2luZ09wdGlvbnMudXBkYXRlUHJvcGVydGllcyh7CiAgICAgICAgInN0cm9rZS13aWR0aCI6IG91dGxpbmUudGhpY2tuZXNzCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fYWRkT3V0bGluZXMoewogICAgICBkcmF3T3V0bGluZXM6IG91dGxpbmUsCiAgICAgIGRyYXdpbmdPcHRpb25zCiAgICB9KTsKICAgIGNvbnN0IFssIHBhZ2VIZWlnaHRdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgIGxldCBuZXdIZWlnaHQgPSBoZWlnaHRJblBhZ2UgLyBwYWdlSGVpZ2h0OwogICAgbmV3SGVpZ2h0ID0gbmV3SGVpZ2h0ID49IDEgPyAwLjUgOiBuZXdIZWlnaHQ7CiAgICB0aGlzLndpZHRoICo9IG5ld0hlaWdodCAvIHRoaXMuaGVpZ2h0OwogICAgaWYgKHRoaXMud2lkdGggPj0gMSkgewogICAgICBuZXdIZWlnaHQgKj0gMC45IC8gdGhpcy53aWR0aDsKICAgICAgdGhpcy53aWR0aCA9IDAuOTsKICAgIH0KICAgIHRoaXMuaGVpZ2h0ID0gbmV3SGVpZ2h0OwogICAgdGhpcy5zZXREaW1zKCk7CiAgICB0aGlzLnggPSBzYXZlZFg7CiAgICB0aGlzLnkgPSBzYXZlZFk7CiAgICB0aGlzLmNlbnRlcigpOwogICAgdGhpcy5fb25SZXNpemVkKCk7CiAgICB0aGlzLm9uU2NhbGVDaGFuZ2luZygpOwogICAgdGhpcy5yb3RhdGUoKTsKICAgIHRoaXMuX3VpTWFuYWdlci5hZGRUb0Fubm90YXRpb25TdG9yYWdlKHRoaXMpOwogICAgdGhpcy5zZXRVdWlkKHV1aWQpOwogICAgdGhpcy5fcmVwb3J0VGVsZW1ldHJ5KHsKICAgICAgYWN0aW9uOiAicGRmanMuc2lnbmF0dXJlLmluc2VydGVkIiwKICAgICAgZGF0YTogewogICAgICAgIGhhc0JlZW5TYXZlZDogISF1dWlkLAogICAgICAgIGhhc0Rlc2NyaXB0aW9uOiAhIWRlc2NyaXB0aW9uCiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5kaXYuaGlkZGVuID0gZmFsc2U7CiAgfQogIGdldEZyb21JbWFnZShiaXRtYXApIHsKICAgIGNvbnN0IHsKICAgICAgcmF3RGltczogewogICAgICAgIHBhZ2VXaWR0aCwKICAgICAgICBwYWdlSGVpZ2h0CiAgICAgIH0sCiAgICAgIHJvdGF0aW9uCiAgICB9ID0gdGhpcy5wYXJlbnQudmlld3BvcnQ7CiAgICByZXR1cm4gU2lnbmF0dXJlRXh0cmFjdG9yLnByb2Nlc3MoYml0bWFwLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQsIHJvdGF0aW9uLCBfU2lnbmF0dXJlRWRpdG9yLl9JTk5FUl9NQVJHSU4pOwogIH0KICBnZXRGcm9tVGV4dCh0ZXh0LCBmb250SW5mbykgewogICAgY29uc3QgewogICAgICByYXdEaW1zOiB7CiAgICAgICAgcGFnZVdpZHRoLAogICAgICAgIHBhZ2VIZWlnaHQKICAgICAgfSwKICAgICAgcm90YXRpb24KICAgIH0gPSB0aGlzLnBhcmVudC52aWV3cG9ydDsKICAgIHJldHVybiBTaWduYXR1cmVFeHRyYWN0b3IuZXh0cmFjdENvbnRvdXJzRnJvbVRleHQodGV4dCwgZm9udEluZm8sIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgcm90YXRpb24sIF9TaWduYXR1cmVFZGl0b3IuX0lOTkVSX01BUkdJTik7CiAgfQogIGdldERyYXduU2lnbmF0dXJlKGN1cnZlcykgewogICAgY29uc3QgewogICAgICByYXdEaW1zOiB7CiAgICAgICAgcGFnZVdpZHRoLAogICAgICAgIHBhZ2VIZWlnaHQKICAgICAgfSwKICAgICAgcm90YXRpb24KICAgIH0gPSB0aGlzLnBhcmVudC52aWV3cG9ydDsKICAgIHJldHVybiBTaWduYXR1cmVFeHRyYWN0b3IucHJvY2Vzc0RyYXduTGluZXMoewogICAgICBsaW5lczogY3VydmVzLAogICAgICBwYWdlV2lkdGgsCiAgICAgIHBhZ2VIZWlnaHQsCiAgICAgIHJvdGF0aW9uLAogICAgICBpbm5lck1hcmdpbjogX1NpZ25hdHVyZUVkaXRvci5fSU5ORVJfTUFSR0lOLAogICAgICBtdXN0U21vb3RoOiBmYWxzZSwKICAgICAgYXJlQ29udG91cnM6IGZhbHNlCiAgICB9KTsKICB9CiAgY3JlYXRlRHJhd2luZ09wdGlvbnMoewogICAgYXJlQ29udG91cnMsCiAgICB0aGlja25lc3MKICB9KSB7CiAgICBpZiAoYXJlQ29udG91cnMpIHsKICAgICAgdGhpcy5fZHJhd2luZ09wdGlvbnMgPSBfU2lnbmF0dXJlRWRpdG9yLmdldERlZmF1bHREcmF3aW5nT3B0aW9ucygpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fZHJhd2luZ09wdGlvbnMgPSBfU2lnbmF0dXJlRWRpdG9yLl9kZWZhdWx0RHJhd25TaWduYXR1cmVPcHRpb25zLmNsb25lKCk7CiAgICAgIHRoaXMuX2RyYXdpbmdPcHRpb25zLnVwZGF0ZVByb3BlcnRpZXMoewogICAgICAgICJzdHJva2Utd2lkdGgiOiB0aGlja25lc3MKICAgICAgfSk7CiAgICB9CiAgfQogIHNlcmlhbGl6ZShpc0ZvckNvcHlpbmcgPSBmYWxzZSkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgewogICAgICBsaW5lcywKICAgICAgcG9pbnRzCiAgICB9ID0gdGhpcy5zZXJpYWxpemVEcmF3KGlzRm9yQ29weWluZyk7CiAgICBjb25zdCB7CiAgICAgIF9kcmF3aW5nT3B0aW9uczogewogICAgICAgICJzdHJva2Utd2lkdGgiOiB0aGlja25lc3MKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBjb25zdCBzZXJpYWxpemVkID0gT2JqZWN0LmFzc2lnbihzdXBlci5zZXJpYWxpemUoaXNGb3JDb3B5aW5nKSwgewogICAgICBpc1NpZ25hdHVyZTogdHJ1ZSwKICAgICAgYXJlQ29udG91cnM6IHRoaXMuI2lzRXh0cmFjdGVkLAogICAgICBjb2xvcjogWzAsIDAsIDBdLAogICAgICB0aGlja25lc3M6IHRoaXMuI2lzRXh0cmFjdGVkID8gMCA6IHRoaWNrbmVzcwogICAgfSk7CiAgICB0aGlzLmFkZENvbW1lbnQoc2VyaWFsaXplZCk7CiAgICBpZiAoaXNGb3JDb3B5aW5nKSB7CiAgICAgIHNlcmlhbGl6ZWQucGF0aHMgPSB7CiAgICAgICAgbGluZXMsCiAgICAgICAgcG9pbnRzCiAgICAgIH07CiAgICAgIHNlcmlhbGl6ZWQudXVpZCA9IHRoaXMuI3NpZ25hdHVyZVVVSUQ7CiAgICAgIHNlcmlhbGl6ZWQuaXNDb3B5ID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHNlcmlhbGl6ZWQubGluZXMgPSBsaW5lczsKICAgIH0KICAgIGlmICh0aGlzLiNkZXNjcmlwdGlvbikgewogICAgICBzZXJpYWxpemVkLmFjY2Vzc2liaWxpdHlEYXRhID0gewogICAgICAgIHR5cGU6ICJGaWd1cmUiLAogICAgICAgIGFsdDogdGhpcy4jZGVzY3JpcHRpb24KICAgICAgfTsKICAgIH0KICAgIHJldHVybiBzZXJpYWxpemVkOwogIH0KICBzdGF0aWMgZGVzZXJpYWxpemVEcmF3KHBhZ2VYLCBwYWdlWSwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCBpbm5lck1hcmdpbiwgZGF0YSkgewogICAgaWYgKGRhdGEuYXJlQ29udG91cnMpIHsKICAgICAgcmV0dXJuIENvbnRvdXJEcmF3T3V0bGluZS5kZXNlcmlhbGl6ZShwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgaW5uZXJNYXJnaW4sIGRhdGEpOwogICAgfQogICAgcmV0dXJuIElua0RyYXdPdXRsaW5lLmRlc2VyaWFsaXplKHBhZ2VYLCBwYWdlWSwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCBpbm5lck1hcmdpbiwgZGF0YSk7CiAgfQogIHN0YXRpYyBhc3luYyBkZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcikgewogICAgY29uc3QgZWRpdG9yID0gYXdhaXQgc3VwZXIuZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpOwogICAgZWRpdG9yLiNpc0V4dHJhY3RlZCA9IGRhdGEuYXJlQ29udG91cnM7CiAgICBlZGl0b3IuZGVzY3JpcHRpb24gPSBkYXRhLmFjY2Vzc2liaWxpdHlEYXRhPy5hbHQgfHwgIiI7CiAgICBlZGl0b3IuI3NpZ25hdHVyZVVVSUQgPSBkYXRhLnV1aWQ7CiAgICByZXR1cm4gZWRpdG9yOwogIH0KfTsKdmFyIFN0YW1wRWRpdG9yID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWRpdG9yIHsKICAjYml0bWFwID0gbnVsbDsKICAjYml0bWFwSWQgPSBudWxsOwogICNiaXRtYXBQcm9taXNlID0gbnVsbDsKICAjYml0bWFwVXJsID0gbnVsbDsKICAjYml0bWFwRmlsZSA9IG51bGw7CiAgI2JpdG1hcEZpbGVOYW1lID0gIiI7CiAgI2NhbnZhcyA9IG51bGw7CiAgI21pc3NpbmdDYW52YXMgPSBmYWxzZTsKICAjcmVzaXplVGltZW91dElkID0gbnVsbDsKICAjaXNTdmcgPSBmYWxzZTsKICAjaGFzQmVlbkFkZGVkSW5VbmRvU3RhY2sgPSBmYWxzZTsKICBzdGF0aWMgX3R5cGUgPSAic3RhbXAiOwogIHN0YXRpYyBfZWRpdG9yVHlwZSA9IEFubm90YXRpb25FZGl0b3JUeXBlLlNUQU1QOwogIGNvbnN0cnVjdG9yKHBhcmFtcykgewogICAgc3VwZXIoewogICAgICAuLi5wYXJhbXMsCiAgICAgIG5hbWU6ICJzdGFtcEVkaXRvciIKICAgIH0pOwogICAgdGhpcy4jYml0bWFwVXJsID0gcGFyYW1zLmJpdG1hcFVybDsKICAgIHRoaXMuI2JpdG1hcEZpbGUgPSBwYXJhbXMuYml0bWFwRmlsZTsKICAgIHRoaXMuZGVmYXVsdEwxMG5JZCA9ICJwZGZqcy1lZGl0b3Itc3RhbXAtZWRpdG9yIjsKICB9CiAgc3RhdGljIGluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKSB7CiAgICBBbm5vdGF0aW9uRWRpdG9yLmluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKTsKICB9CiAgc3RhdGljIGlzSGFuZGxpbmdNaW1lRm9yUGFzdGluZyhtaW1lKSB7CiAgICByZXR1cm4gU3VwcG9ydGVkSW1hZ2VNaW1lVHlwZXMuaW5jbHVkZXMobWltZSk7CiAgfQogIHN0YXRpYyBwYXN0ZShpdGVtLCBwYXJlbnQpIHsKICAgIHBhcmVudC5wYXN0ZUVkaXRvcih7CiAgICAgIG1vZGU6IEFubm90YXRpb25FZGl0b3JUeXBlLlNUQU1QCiAgICB9LCB7CiAgICAgIGJpdG1hcEZpbGU6IGl0ZW0uZ2V0QXNGaWxlKCkKICAgIH0pOwogIH0KICBhbHRUZXh0RmluaXNoKCkgewogICAgaWYgKHRoaXMuX3VpTWFuYWdlci51c2VOZXdBbHRUZXh0RmxvdykgewogICAgICB0aGlzLmRpdi5oaWRkZW4gPSBmYWxzZTsKICAgIH0KICAgIHN1cGVyLmFsdFRleHRGaW5pc2goKTsKICB9CiAgZ2V0IHRlbGVtZXRyeUZpbmFsRGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6ICJzdGFtcCIsCiAgICAgIGhhc0FsdFRleHQ6ICEhdGhpcy5hbHRUZXh0RGF0YT8uYWx0VGV4dAogICAgfTsKICB9CiAgc3RhdGljIGNvbXB1dGVUZWxlbWV0cnlGaW5hbERhdGEoZGF0YSkgewogICAgY29uc3QgaGFzQWx0VGV4dFN0YXRzID0gZGF0YS5nZXQoImhhc0FsdFRleHQiKTsKICAgIHJldHVybiB7CiAgICAgIGhhc0FsdFRleHQ6IGhhc0FsdFRleHRTdGF0cy5nZXQodHJ1ZSkgPz8gMCwKICAgICAgaGFzTm9BbHRUZXh0OiBoYXNBbHRUZXh0U3RhdHMuZ2V0KGZhbHNlKSA/PyAwCiAgICB9OwogIH0KICAjZ2V0Qml0bWFwRmV0Y2hlZChkYXRhLCBmcm9tSWQgPSBmYWxzZSkgewogICAgaWYgKCFkYXRhKSB7CiAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2JpdG1hcCA9IGRhdGEuYml0bWFwOwogICAgaWYgKCFmcm9tSWQpIHsKICAgICAgdGhpcy4jYml0bWFwSWQgPSBkYXRhLmlkOwogICAgICB0aGlzLiNpc1N2ZyA9IGRhdGEuaXNTdmc7CiAgICB9CiAgICBpZiAoZGF0YS5maWxlKSB7CiAgICAgIHRoaXMuI2JpdG1hcEZpbGVOYW1lID0gZGF0YS5maWxlLm5hbWU7CiAgICB9CiAgICB0aGlzLiNjcmVhdGVDYW52YXMoKTsKICB9CiAgI2dldEJpdG1hcERvbmUoKSB7CiAgICB0aGlzLiNiaXRtYXBQcm9taXNlID0gbnVsbDsKICAgIHRoaXMuX3VpTWFuYWdlci5lbmFibGVXYWl0aW5nKGZhbHNlKTsKICAgIGlmICghdGhpcy4jY2FudmFzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZSAmJiB0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dEZsb3cgJiYgdGhpcy4jYml0bWFwKSB7CiAgICAgIHRoaXMuYWRkRWRpdFRvb2xiYXIoKS50aGVuKCgpID0+IHsKICAgICAgICB0aGlzLl9lZGl0VG9vbGJhci5oaWRlKCk7CiAgICAgICAgdGhpcy5fdWlNYW5hZ2VyLmVkaXRBbHRUZXh0KHRoaXMsIHRydWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZSAmJiB0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dEZsb3cgJiYgdGhpcy4jYml0bWFwKSB7CiAgICAgIHRoaXMuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgICAgYWN0aW9uOiAicGRmanMuaW1hZ2UuaW1hZ2VfYWRkZWQiLAogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGFsdF90ZXh0X21vZGFsOiBmYWxzZSwKICAgICAgICAgIGFsdF90ZXh0X3R5cGU6ICJlbXB0eSIKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0cnkgewogICAgICAgIHRoaXMubWxHdWVzc0FsdFRleHQoKTsKICAgICAgfSBjYXRjaCB7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZGl2LmZvY3VzKCk7CiAgfQogIGFzeW5jIG1sR3Vlc3NBbHRUZXh0KGltYWdlRGF0YSA9IG51bGwsIHVwZGF0ZUFsdFRleHREYXRhID0gdHJ1ZSkgewogICAgaWYgKHRoaXMuaGFzQWx0VGV4dERhdGEoKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgbWxNYW5hZ2VyCiAgICB9ID0gdGhpcy5fdWlNYW5hZ2VyOwogICAgaWYgKCFtbE1hbmFnZXIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBNTC4iKTsKICAgIH0KICAgIGlmICghYXdhaXQgbWxNYW5hZ2VyLmlzRW5hYmxlZEZvcigiYWx0VGV4dCIpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTUwgaXNuJ3QgZW5hYmxlZCBmb3IgYWx0IHRleHQuIik7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSBpbWFnZURhdGEgfHwgdGhpcy5jb3B5Q2FudmFzKG51bGwsIG51bGwsIHRydWUpLmltYWdlRGF0YTsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgbWxNYW5hZ2VyLmd1ZXNzKHsKICAgICAgbmFtZTogImFsdFRleHQiLAogICAgICByZXF1ZXN0OiB7CiAgICAgICAgZGF0YSwKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQsCiAgICAgICAgY2hhbm5lbHM6IGRhdGEubGVuZ3RoIC8gKHdpZHRoICogaGVpZ2h0KQogICAgICB9CiAgICB9KTsKICAgIGlmICghcmVzcG9uc2UpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyByZXNwb25zZSBmcm9tIHRoZSBBSSBzZXJ2aWNlLiIpOwogICAgfQogICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRXJyb3IgZnJvbSB0aGUgQUkgc2VydmljZS4iKTsKICAgIH0KICAgIGlmIChyZXNwb25zZS5jYW5jZWwpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAoIXJlc3BvbnNlLm91dHB1dCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIHZhbGlkIHJlc3BvbnNlIGZyb20gdGhlIEFJIHNlcnZpY2UuIik7CiAgICB9CiAgICBjb25zdCBhbHRUZXh0ID0gcmVzcG9uc2Uub3V0cHV0OwogICAgYXdhaXQgdGhpcy5zZXRHdWVzc2VkQWx0VGV4dChhbHRUZXh0KTsKICAgIGlmICh1cGRhdGVBbHRUZXh0RGF0YSAmJiAhdGhpcy5oYXNBbHRUZXh0RGF0YSgpKSB7CiAgICAgIHRoaXMuYWx0VGV4dERhdGEgPSB7CiAgICAgICAgYWx0OiBhbHRUZXh0LAogICAgICAgIGRlY29yYXRpdmU6IGZhbHNlCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gYWx0VGV4dDsKICB9CiAgI2dldEJpdG1hcCgpIHsKICAgIGlmICh0aGlzLiNiaXRtYXBJZCkgewogICAgICB0aGlzLl91aU1hbmFnZXIuZW5hYmxlV2FpdGluZyh0cnVlKTsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLmltYWdlTWFuYWdlci5nZXRGcm9tSWQodGhpcy4jYml0bWFwSWQpLnRoZW4oKGRhdGEpID0+IHRoaXMuI2dldEJpdG1hcEZldGNoZWQoZGF0YSwgdHJ1ZSkpLmZpbmFsbHkoKCkgPT4gdGhpcy4jZ2V0Qml0bWFwRG9uZSgpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI2JpdG1hcFVybCkgewogICAgICBjb25zdCB1cmwgPSB0aGlzLiNiaXRtYXBVcmw7CiAgICAgIHRoaXMuI2JpdG1hcFVybCA9IG51bGw7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5lbmFibGVXYWl0aW5nKHRydWUpOwogICAgICB0aGlzLiNiaXRtYXBQcm9taXNlID0gdGhpcy5fdWlNYW5hZ2VyLmltYWdlTWFuYWdlci5nZXRGcm9tVXJsKHVybCkudGhlbigoZGF0YSkgPT4gdGhpcy4jZ2V0Qml0bWFwRmV0Y2hlZChkYXRhKSkuZmluYWxseSgoKSA9PiB0aGlzLiNnZXRCaXRtYXBEb25lKCkpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jYml0bWFwRmlsZSkgewogICAgICBjb25zdCBmaWxlID0gdGhpcy4jYml0bWFwRmlsZTsKICAgICAgdGhpcy4jYml0bWFwRmlsZSA9IG51bGw7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5lbmFibGVXYWl0aW5nKHRydWUpOwogICAgICB0aGlzLiNiaXRtYXBQcm9taXNlID0gdGhpcy5fdWlNYW5hZ2VyLmltYWdlTWFuYWdlci5nZXRGcm9tRmlsZShmaWxlKS50aGVuKChkYXRhKSA9PiB0aGlzLiNnZXRCaXRtYXBGZXRjaGVkKGRhdGEpKS5maW5hbGx5KCgpID0+IHRoaXMuI2dldEJpdG1hcERvbmUoKSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIGlucHV0LnR5cGUgPSAiZmlsZSI7CiAgICBpbnB1dC5hY2NlcHQgPSBTdXBwb3J0ZWRJbWFnZU1pbWVUeXBlcy5qb2luKCIsIik7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLl91aU1hbmFnZXIuX3NpZ25hbDsKICAgIHRoaXMuI2JpdG1hcFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCBhc3luYyAoKSA9PiB7CiAgICAgICAgaWYgKCFpbnB1dC5maWxlcyB8fCBpbnB1dC5maWxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3VpTWFuYWdlci5lbmFibGVXYWl0aW5nKHRydWUpOwogICAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuX3VpTWFuYWdlci5pbWFnZU1hbmFnZXIuZ2V0RnJvbUZpbGUoaW5wdXQuZmlsZXNbMF0pOwogICAgICAgICAgdGhpcy5fcmVwb3J0VGVsZW1ldHJ5KHsKICAgICAgICAgICAgYWN0aW9uOiAicGRmanMuaW1hZ2UuaW1hZ2Vfc2VsZWN0ZWQiLAogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgYWx0X3RleHRfbW9kYWw6IHRoaXMuX3VpTWFuYWdlci51c2VOZXdBbHRUZXh0RmxvdwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuI2dldEJpdG1hcEZldGNoZWQoZGF0YSk7CiAgICAgICAgfQogICAgICAgIHJlc29sdmUoKTsKICAgICAgfSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigiY2FuY2VsIiwgKCkgPT4gewogICAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICAgICAgcmVzb2x2ZSgpOwogICAgICB9LCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgfSkuZmluYWxseSgoKSA9PiB0aGlzLiNnZXRCaXRtYXBEb25lKCkpOwogICAgaW5wdXQuY2xpY2soKTsKICB9CiAgcmVtb3ZlKCkgewogICAgaWYgKHRoaXMuI2JpdG1hcElkKSB7CiAgICAgIHRoaXMuI2JpdG1hcCA9IG51bGw7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5pbWFnZU1hbmFnZXIuZGVsZXRlSWQodGhpcy4jYml0bWFwSWQpOwogICAgICB0aGlzLiNjYW52YXM/LnJlbW92ZSgpOwogICAgICB0aGlzLiNjYW52YXMgPSBudWxsOwogICAgICBpZiAodGhpcy4jcmVzaXplVGltZW91dElkKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuI3Jlc2l6ZVRpbWVvdXRJZCk7CiAgICAgICAgdGhpcy4jcmVzaXplVGltZW91dElkID0gbnVsbDsKICAgICAgfQogICAgfQogICAgc3VwZXIucmVtb3ZlKCk7CiAgfQogIHJlYnVpbGQoKSB7CiAgICBpZiAoIXRoaXMucGFyZW50KSB7CiAgICAgIGlmICh0aGlzLiNiaXRtYXBJZCkgewogICAgICAgIHRoaXMuI2dldEJpdG1hcCgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN1cGVyLnJlYnVpbGQoKTsKICAgIGlmICh0aGlzLmRpdiA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jYml0bWFwSWQgJiYgdGhpcy4jY2FudmFzID09PSBudWxsKSB7CiAgICAgIHRoaXMuI2dldEJpdG1hcCgpOwogICAgfQogICAgaWYgKCF0aGlzLmlzQXR0YWNoZWRUb0RPTSkgewogICAgICB0aGlzLnBhcmVudC5hZGQodGhpcyk7CiAgICB9CiAgfQogIG9uY2VBZGRlZChmb2N1cykgewogICAgdGhpcy5faXNEcmFnZ2FibGUgPSB0cnVlOwogICAgaWYgKGZvY3VzKSB7CiAgICAgIHRoaXMuZGl2LmZvY3VzKCk7CiAgICB9CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gISh0aGlzLiNiaXRtYXBQcm9taXNlIHx8IHRoaXMuI2JpdG1hcCB8fCB0aGlzLiNiaXRtYXBVcmwgfHwgdGhpcy4jYml0bWFwRmlsZSB8fCB0aGlzLiNiaXRtYXBJZCB8fCB0aGlzLiNtaXNzaW5nQ2FudmFzKTsKICB9CiAgZ2V0IHRvb2xiYXJCdXR0b25zKCkgewogICAgcmV0dXJuIFtbImFsdFRleHQiLCB0aGlzLmNyZWF0ZUFsdFRleHQoKV1dOwogIH0KICBnZXQgaXNSZXNpemFibGUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHJldHVybiB0aGlzLmRpdjsKICAgIH0KICAgIGxldCBiYXNlWCwgYmFzZVk7CiAgICBpZiAodGhpcy5faXNDb3B5KSB7CiAgICAgIGJhc2VYID0gdGhpcy54OwogICAgICBiYXNlWSA9IHRoaXMueTsKICAgIH0KICAgIHN1cGVyLnJlbmRlcigpOwogICAgdGhpcy5kaXYuaGlkZGVuID0gdHJ1ZTsKICAgIHRoaXMuY3JlYXRlQWx0VGV4dCgpOwogICAgaWYgKCF0aGlzLiNtaXNzaW5nQ2FudmFzKSB7CiAgICAgIGlmICh0aGlzLiNiaXRtYXApIHsKICAgICAgICB0aGlzLiNjcmVhdGVDYW52YXMoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiNnZXRCaXRtYXAoKTsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuX2lzQ29weSkgewogICAgICB0aGlzLl9tb3ZlQWZ0ZXJQYXN0ZShiYXNlWCwgYmFzZVkpOwogICAgfQogICAgdGhpcy5fdWlNYW5hZ2VyLmFkZFNob3VsZFJlc2NhbGUodGhpcyk7CiAgICByZXR1cm4gdGhpcy5kaXY7CiAgfQogIHNldENhbnZhcyhhbm5vdGF0aW9uRWxlbWVudElkLCBjYW52YXMpIHsKICAgIGNvbnN0IHsKICAgICAgaWQ6IGJpdG1hcElkLAogICAgICBiaXRtYXAKICAgIH0gPSB0aGlzLl91aU1hbmFnZXIuaW1hZ2VNYW5hZ2VyLmdldEZyb21DYW52YXMoYW5ub3RhdGlvbkVsZW1lbnRJZCwgY2FudmFzKTsKICAgIGNhbnZhcy5yZW1vdmUoKTsKICAgIGlmIChiaXRtYXBJZCAmJiB0aGlzLl91aU1hbmFnZXIuaW1hZ2VNYW5hZ2VyLmlzVmFsaWRJZChiaXRtYXBJZCkpIHsKICAgICAgdGhpcy4jYml0bWFwSWQgPSBiaXRtYXBJZDsKICAgICAgaWYgKGJpdG1hcCkgewogICAgICAgIHRoaXMuI2JpdG1hcCA9IGJpdG1hcDsKICAgICAgfQogICAgICB0aGlzLiNtaXNzaW5nQ2FudmFzID0gZmFsc2U7CiAgICAgIHRoaXMuI2NyZWF0ZUNhbnZhcygpOwogICAgfQogIH0KICBfb25SZXNpemVkKCkgewogICAgdGhpcy5vblNjYWxlQ2hhbmdpbmcoKTsKICB9CiAgb25TY2FsZUNoYW5naW5nKCkgewogICAgaWYgKCF0aGlzLnBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jcmVzaXplVGltZW91dElkICE9PSBudWxsKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLiNyZXNpemVUaW1lb3V0SWQpOwogICAgfQogICAgY29uc3QgVElNRV9UT19XQUlUID0gMjAwOwogICAgdGhpcy4jcmVzaXplVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRoaXMuI3Jlc2l6ZVRpbWVvdXRJZCA9IG51bGw7CiAgICAgIHRoaXMuI2RyYXdCaXRtYXAoKTsKICAgIH0sIFRJTUVfVE9fV0FJVCk7CiAgfQogICNjcmVhdGVDYW52YXMoKSB7CiAgICBjb25zdCB7CiAgICAgIGRpdgogICAgfSA9IHRoaXM7CiAgICBsZXQgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gdGhpcy4jYml0bWFwOwogICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhZ2VEaW1lbnNpb25zOwogICAgY29uc3QgTUFYX1JBVElPID0gMC43NTsKICAgIGlmICh0aGlzLndpZHRoKSB7CiAgICAgIHdpZHRoID0gdGhpcy53aWR0aCAqIHBhZ2VXaWR0aDsKICAgICAgaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKiBwYWdlSGVpZ2h0OwogICAgfSBlbHNlIGlmICh3aWR0aCA+IE1BWF9SQVRJTyAqIHBhZ2VXaWR0aCB8fCBoZWlnaHQgPiBNQVhfUkFUSU8gKiBwYWdlSGVpZ2h0KSB7CiAgICAgIGNvbnN0IGZhY3RvciA9IE1hdGgubWluKE1BWF9SQVRJTyAqIHBhZ2VXaWR0aCAvIHdpZHRoLCBNQVhfUkFUSU8gKiBwYWdlSGVpZ2h0IC8gaGVpZ2h0KTsKICAgICAgd2lkdGggKj0gZmFjdG9yOwogICAgICBoZWlnaHQgKj0gZmFjdG9yOwogICAgfQogICAgdGhpcy5fdWlNYW5hZ2VyLmVuYWJsZVdhaXRpbmcoZmFsc2UpOwogICAgY29uc3QgY2FudmFzID0gdGhpcy4jY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICBjYW52YXMuc2V0QXR0cmlidXRlKCJyb2xlIiwgImltZyIpOwogICAgdGhpcy5hZGRDb250YWluZXIoY2FudmFzKTsKICAgIHRoaXMud2lkdGggPSB3aWR0aCAvIHBhZ2VXaWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0IC8gcGFnZUhlaWdodDsKICAgIHRoaXMuc2V0RGltcygpOwogICAgaWYgKHRoaXMuX2luaXRpYWxPcHRpb25zPy5pc0NlbnRlcmVkKSB7CiAgICAgIHRoaXMuY2VudGVyKCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmZpeEFuZFNldFBvc2l0aW9uKCk7CiAgICB9CiAgICB0aGlzLl9pbml0aWFsT3B0aW9ucyA9IG51bGw7CiAgICBpZiAoIXRoaXMuX3VpTWFuYWdlci51c2VOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlIHx8ICF0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dEZsb3cgfHwgdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIGRpdi5oaWRkZW4gPSBmYWxzZTsKICAgIH0KICAgIHRoaXMuI2RyYXdCaXRtYXAoKTsKICAgIGlmICghdGhpcy4jaGFzQmVlbkFkZGVkSW5VbmRvU3RhY2spIHsKICAgICAgdGhpcy5wYXJlbnQuYWRkVW5kb2FibGVFZGl0b3IodGhpcyk7CiAgICAgIHRoaXMuI2hhc0JlZW5BZGRlZEluVW5kb1N0YWNrID0gdHJ1ZTsKICAgIH0KICAgIHRoaXMuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgIGFjdGlvbjogImluc2VydGVkX2ltYWdlIgogICAgfSk7CiAgICBpZiAodGhpcy4jYml0bWFwRmlsZU5hbWUpIHsKICAgICAgdGhpcy5kaXYuc2V0QXR0cmlidXRlKCJhcmlhLWRlc2NyaXB0aW9uIiwgdGhpcy4jYml0bWFwRmlsZU5hbWUpOwogICAgfQogICAgaWYgKCF0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLmExMXlBbGVydCgicGRmanMtZWRpdG9yLXN0YW1wLWFkZGVkLWFsZXJ0Iik7CiAgICB9CiAgfQogIGNvcHlDYW52YXMobWF4RGF0YURpbWVuc2lvbiwgbWF4UHJldmlld0RpbWVuc2lvbiwgY3JlYXRlSW1hZ2VEYXRhID0gZmFsc2UpIHsKICAgIGlmICghbWF4RGF0YURpbWVuc2lvbikgewogICAgICBtYXhEYXRhRGltZW5zaW9uID0gMjI0OwogICAgfQogICAgY29uc3QgewogICAgICB3aWR0aDogYml0bWFwV2lkdGgsCiAgICAgIGhlaWdodDogYml0bWFwSGVpZ2h0CiAgICB9ID0gdGhpcy4jYml0bWFwOwogICAgY29uc3Qgb3V0cHV0U2NhbGUgPSBuZXcgT3V0cHV0U2NhbGUoKTsKICAgIGxldCBiaXRtYXAgPSB0aGlzLiNiaXRtYXA7CiAgICBsZXQgd2lkdGggPSBiaXRtYXBXaWR0aCwgaGVpZ2h0ID0gYml0bWFwSGVpZ2h0OwogICAgbGV0IGNhbnZhcyA9IG51bGw7CiAgICBpZiAobWF4UHJldmlld0RpbWVuc2lvbikgewogICAgICBpZiAoYml0bWFwV2lkdGggPiBtYXhQcmV2aWV3RGltZW5zaW9uIHx8IGJpdG1hcEhlaWdodCA+IG1heFByZXZpZXdEaW1lbnNpb24pIHsKICAgICAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKG1heFByZXZpZXdEaW1lbnNpb24gLyBiaXRtYXBXaWR0aCwgbWF4UHJldmlld0RpbWVuc2lvbiAvIGJpdG1hcEhlaWdodCk7CiAgICAgICAgd2lkdGggPSBNYXRoLmZsb29yKGJpdG1hcFdpZHRoICogcmF0aW8pOwogICAgICAgIGhlaWdodCA9IE1hdGguZmxvb3IoYml0bWFwSGVpZ2h0ICogcmF0aW8pOwogICAgICB9CiAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICBjb25zdCBzY2FsZWRXaWR0aCA9IGNhbnZhcy53aWR0aCA9IE1hdGguY2VpbCh3aWR0aCAqIG91dHB1dFNjYWxlLnN4KTsKICAgICAgY29uc3Qgc2NhbGVkSGVpZ2h0ID0gY2FudmFzLmhlaWdodCA9IE1hdGguY2VpbChoZWlnaHQgKiBvdXRwdXRTY2FsZS5zeSk7CiAgICAgIGlmICghdGhpcy4jaXNTdmcpIHsKICAgICAgICBiaXRtYXAgPSB0aGlzLiNzY2FsZUJpdG1hcChzY2FsZWRXaWR0aCwgc2NhbGVkSGVpZ2h0KTsKICAgICAgfQogICAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgY3R4LmZpbHRlciA9IHRoaXMuX3VpTWFuYWdlci5oY21GaWx0ZXI7CiAgICAgIGxldCB3aGl0ZSA9ICJ3aGl0ZSIsIGJsYWNrID0gIiNjZmNmZDgiOwogICAgICBpZiAodGhpcy5fdWlNYW5hZ2VyLmhjbUZpbHRlciAhPT0gIm5vbmUiKSB7CiAgICAgICAgYmxhY2sgPSAiYmxhY2siOwogICAgICB9IGVsc2UgaWYgKENvbG9yU2NoZW1lLmlzRGFya01vZGUpIHsKICAgICAgICB3aGl0ZSA9ICIjOGY4ZjlkIjsKICAgICAgICBibGFjayA9ICIjNDI0MTRkIjsKICAgICAgfQogICAgICBjb25zdCBib3hEaW0gPSAxNTsKICAgICAgY29uc3QgYm94RGltV2lkdGggPSBib3hEaW0gKiBvdXRwdXRTY2FsZS5zeDsKICAgICAgY29uc3QgYm94RGltSGVpZ2h0ID0gYm94RGltICogb3V0cHV0U2NhbGUuc3k7CiAgICAgIGNvbnN0IHBhdHRlcm4gPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKGJveERpbVdpZHRoICogMiwgYm94RGltSGVpZ2h0ICogMik7CiAgICAgIGNvbnN0IHBhdHRlcm5DdHggPSBwYXR0ZXJuLmdldENvbnRleHQoIjJkIik7CiAgICAgIHBhdHRlcm5DdHguZmlsbFN0eWxlID0gd2hpdGU7CiAgICAgIHBhdHRlcm5DdHguZmlsbFJlY3QoMCwgMCwgYm94RGltV2lkdGggKiAyLCBib3hEaW1IZWlnaHQgKiAyKTsKICAgICAgcGF0dGVybkN0eC5maWxsU3R5bGUgPSBibGFjazsKICAgICAgcGF0dGVybkN0eC5maWxsUmVjdCgwLCAwLCBib3hEaW1XaWR0aCwgYm94RGltSGVpZ2h0KTsKICAgICAgcGF0dGVybkN0eC5maWxsUmVjdChib3hEaW1XaWR0aCwgYm94RGltSGVpZ2h0LCBib3hEaW1XaWR0aCwgYm94RGltSGVpZ2h0KTsKICAgICAgY3R4LmZpbGxTdHlsZSA9IGN0eC5jcmVhdGVQYXR0ZXJuKHBhdHRlcm4sICJyZXBlYXQiKTsKICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIHNjYWxlZFdpZHRoLCBzY2FsZWRIZWlnaHQpOwogICAgICBjdHguZHJhd0ltYWdlKGJpdG1hcCwgMCwgMCwgYml0bWFwLndpZHRoLCBiaXRtYXAuaGVpZ2h0LCAwLCAwLCBzY2FsZWRXaWR0aCwgc2NhbGVkSGVpZ2h0KTsKICAgIH0KICAgIGxldCBpbWFnZURhdGEgPSBudWxsOwogICAgaWYgKGNyZWF0ZUltYWdlRGF0YSkgewogICAgICBsZXQgZGF0YVdpZHRoLCBkYXRhSGVpZ2h0OwogICAgICBpZiAob3V0cHV0U2NhbGUuc3ltbWV0cmljICYmIGJpdG1hcC53aWR0aCA8IG1heERhdGFEaW1lbnNpb24gJiYgYml0bWFwLmhlaWdodCA8IG1heERhdGFEaW1lbnNpb24pIHsKICAgICAgICBkYXRhV2lkdGggPSBiaXRtYXAud2lkdGg7CiAgICAgICAgZGF0YUhlaWdodCA9IGJpdG1hcC5oZWlnaHQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYml0bWFwID0gdGhpcy4jYml0bWFwOwogICAgICAgIGlmIChiaXRtYXBXaWR0aCA+IG1heERhdGFEaW1lbnNpb24gfHwgYml0bWFwSGVpZ2h0ID4gbWF4RGF0YURpbWVuc2lvbikgewogICAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbihtYXhEYXRhRGltZW5zaW9uIC8gYml0bWFwV2lkdGgsIG1heERhdGFEaW1lbnNpb24gLyBiaXRtYXBIZWlnaHQpOwogICAgICAgICAgZGF0YVdpZHRoID0gTWF0aC5mbG9vcihiaXRtYXBXaWR0aCAqIHJhdGlvKTsKICAgICAgICAgIGRhdGFIZWlnaHQgPSBNYXRoLmZsb29yKGJpdG1hcEhlaWdodCAqIHJhdGlvKTsKICAgICAgICAgIGlmICghdGhpcy4jaXNTdmcpIHsKICAgICAgICAgICAgYml0bWFwID0gdGhpcy4jc2NhbGVCaXRtYXAoZGF0YVdpZHRoLCBkYXRhSGVpZ2h0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3Qgb2Zmc2NyZWVuID0gbmV3IE9mZnNjcmVlbkNhbnZhcyhkYXRhV2lkdGgsIGRhdGFIZWlnaHQpOwogICAgICBjb25zdCBvZmZzY3JlZW5DdHggPSBvZmZzY3JlZW4uZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgICAgd2lsbFJlYWRGcmVxdWVudGx5OiB0cnVlCiAgICAgIH0pOwogICAgICBvZmZzY3JlZW5DdHguZHJhd0ltYWdlKGJpdG1hcCwgMCwgMCwgYml0bWFwLndpZHRoLCBiaXRtYXAuaGVpZ2h0LCAwLCAwLCBkYXRhV2lkdGgsIGRhdGFIZWlnaHQpOwogICAgICBpbWFnZURhdGEgPSB7CiAgICAgICAgd2lkdGg6IGRhdGFXaWR0aCwKICAgICAgICBoZWlnaHQ6IGRhdGFIZWlnaHQsCiAgICAgICAgZGF0YTogb2Zmc2NyZWVuQ3R4LmdldEltYWdlRGF0YSgwLCAwLCBkYXRhV2lkdGgsIGRhdGFIZWlnaHQpLmRhdGEKICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGNhbnZhcywKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgaW1hZ2VEYXRhCiAgICB9OwogIH0KICAjc2NhbGVCaXRtYXAod2lkdGgsIGhlaWdodCkgewogICAgY29uc3QgewogICAgICB3aWR0aDogYml0bWFwV2lkdGgsCiAgICAgIGhlaWdodDogYml0bWFwSGVpZ2h0CiAgICB9ID0gdGhpcy4jYml0bWFwOwogICAgbGV0IG5ld1dpZHRoID0gYml0bWFwV2lkdGg7CiAgICBsZXQgbmV3SGVpZ2h0ID0gYml0bWFwSGVpZ2h0OwogICAgbGV0IGJpdG1hcCA9IHRoaXMuI2JpdG1hcDsKICAgIHdoaWxlIChuZXdXaWR0aCA+IDIgKiB3aWR0aCB8fCBuZXdIZWlnaHQgPiAyICogaGVpZ2h0KSB7CiAgICAgIGNvbnN0IHByZXZXaWR0aCA9IG5ld1dpZHRoOwogICAgICBjb25zdCBwcmV2SGVpZ2h0ID0gbmV3SGVpZ2h0OwogICAgICBpZiAobmV3V2lkdGggPiAyICogd2lkdGgpIHsKICAgICAgICBuZXdXaWR0aCA9IG5ld1dpZHRoID49IDE2Mzg0ID8gTWF0aC5mbG9vcihuZXdXaWR0aCAvIDIpIC0gMSA6IE1hdGguY2VpbChuZXdXaWR0aCAvIDIpOwogICAgICB9CiAgICAgIGlmIChuZXdIZWlnaHQgPiAyICogaGVpZ2h0KSB7CiAgICAgICAgbmV3SGVpZ2h0ID0gbmV3SGVpZ2h0ID49IDE2Mzg0ID8gTWF0aC5mbG9vcihuZXdIZWlnaHQgLyAyKSAtIDEgOiBNYXRoLmNlaWwobmV3SGVpZ2h0IC8gMik7CiAgICAgIH0KICAgICAgY29uc3Qgb2Zmc2NyZWVuID0gbmV3IE9mZnNjcmVlbkNhbnZhcyhuZXdXaWR0aCwgbmV3SGVpZ2h0KTsKICAgICAgY29uc3QgY3R4ID0gb2Zmc2NyZWVuLmdldENvbnRleHQoIjJkIik7CiAgICAgIGN0eC5kcmF3SW1hZ2UoYml0bWFwLCAwLCAwLCBwcmV2V2lkdGgsIHByZXZIZWlnaHQsIDAsIDAsIG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgICBiaXRtYXAgPSBvZmZzY3JlZW4udHJhbnNmZXJUb0ltYWdlQml0bWFwKCk7CiAgICB9CiAgICByZXR1cm4gYml0bWFwOwogIH0KICAjZHJhd0JpdG1hcCgpIHsKICAgIGNvbnN0IFtwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgIGNvbnN0IHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXM7CiAgICBjb25zdCBvdXRwdXRTY2FsZSA9IG5ldyBPdXRwdXRTY2FsZSgpOwogICAgY29uc3Qgc2NhbGVkV2lkdGggPSBNYXRoLmNlaWwod2lkdGggKiBwYXJlbnRXaWR0aCAqIG91dHB1dFNjYWxlLnN4KTsKICAgIGNvbnN0IHNjYWxlZEhlaWdodCA9IE1hdGguY2VpbChoZWlnaHQgKiBwYXJlbnRIZWlnaHQgKiBvdXRwdXRTY2FsZS5zeSk7CiAgICBjb25zdCBjYW52YXMgPSB0aGlzLiNjYW52YXM7CiAgICBpZiAoIWNhbnZhcyB8fCBjYW52YXMud2lkdGggPT09IHNjYWxlZFdpZHRoICYmIGNhbnZhcy5oZWlnaHQgPT09IHNjYWxlZEhlaWdodCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjYW52YXMud2lkdGggPSBzY2FsZWRXaWR0aDsKICAgIGNhbnZhcy5oZWlnaHQgPSBzY2FsZWRIZWlnaHQ7CiAgICBjb25zdCBiaXRtYXAgPSB0aGlzLiNpc1N2ZyA/IHRoaXMuI2JpdG1hcCA6IHRoaXMuI3NjYWxlQml0bWFwKHNjYWxlZFdpZHRoLCBzY2FsZWRIZWlnaHQpOwogICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICBjdHguZmlsdGVyID0gdGhpcy5fdWlNYW5hZ2VyLmhjbUZpbHRlcjsKICAgIGN0eC5kcmF3SW1hZ2UoYml0bWFwLCAwLCAwLCBiaXRtYXAud2lkdGgsIGJpdG1hcC5oZWlnaHQsIDAsIDAsIHNjYWxlZFdpZHRoLCBzY2FsZWRIZWlnaHQpOwogIH0KICAjc2VyaWFsaXplQml0bWFwKHRvVXJsKSB7CiAgICBpZiAodG9VcmwpIHsKICAgICAgaWYgKHRoaXMuI2lzU3ZnKSB7CiAgICAgICAgY29uc3QgdXJsID0gdGhpcy5fdWlNYW5hZ2VyLmltYWdlTWFuYWdlci5nZXRTdmdVcmwodGhpcy4jYml0bWFwSWQpOwogICAgICAgIGlmICh1cmwpIHsKICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgICAoewogICAgICAgIHdpZHRoOiBjYW52YXMud2lkdGgsCiAgICAgICAgaGVpZ2h0OiBjYW52YXMuaGVpZ2h0CiAgICAgIH0gPSB0aGlzLiNiaXRtYXApOwogICAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgY3R4LmRyYXdJbWFnZSh0aGlzLiNiaXRtYXAsIDAsIDApOwogICAgICByZXR1cm4gY2FudmFzLnRvRGF0YVVSTCgpOwogICAgfQogICAgaWYgKHRoaXMuI2lzU3ZnKSB7CiAgICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgICAgY29uc3Qgd2lkdGggPSBNYXRoLnJvdW5kKHRoaXMud2lkdGggKiBwYWdlV2lkdGggKiBQaXhlbHNQZXJJbmNoLlBERl9UT19DU1NfVU5JVFMpOwogICAgICBjb25zdCBoZWlnaHQgPSBNYXRoLnJvdW5kKHRoaXMuaGVpZ2h0ICogcGFnZUhlaWdodCAqIFBpeGVsc1BlckluY2guUERGX1RPX0NTU19VTklUUyk7CiAgICAgIGNvbnN0IG9mZnNjcmVlbiA9IG5ldyBPZmZzY3JlZW5DYW52YXMod2lkdGgsIGhlaWdodCk7CiAgICAgIGNvbnN0IGN0eCA9IG9mZnNjcmVlbi5nZXRDb250ZXh0KCIyZCIpOwogICAgICBjdHguZHJhd0ltYWdlKHRoaXMuI2JpdG1hcCwgMCwgMCwgdGhpcy4jYml0bWFwLndpZHRoLCB0aGlzLiNiaXRtYXAuaGVpZ2h0LCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgcmV0dXJuIG9mZnNjcmVlbi50cmFuc2ZlclRvSW1hZ2VCaXRtYXAoKTsKICAgIH0KICAgIHJldHVybiBzdHJ1Y3R1cmVkQ2xvbmUodGhpcy4jYml0bWFwKTsKICB9CiAgc3RhdGljIGFzeW5jIGRlc2VyaWFsaXplKGRhdGEsIHBhcmVudCwgdWlNYW5hZ2VyKSB7CiAgICBsZXQgaW5pdGlhbERhdGEyID0gbnVsbDsKICAgIGxldCBtaXNzaW5nQ2FudmFzID0gZmFsc2U7CiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIFN0YW1wQW5ub3RhdGlvbkVsZW1lbnQpIHsKICAgICAgY29uc3QgewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHJlY3Q6IHJlY3QyLAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBpZCwKICAgICAgICAgIHN0cnVjdFBhcmVudCwKICAgICAgICAgIHBvcHVwUmVmLAogICAgICAgICAgcmljaFRleHQsCiAgICAgICAgICBjb250ZW50c09iaiwKICAgICAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgICAgICB9LAogICAgICAgIGNvbnRhaW5lcjogY29udGFpbmVyMiwKICAgICAgICBwYXJlbnQ6IHsKICAgICAgICAgIHBhZ2U6IHsKICAgICAgICAgICAgcGFnZU51bWJlcgogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgY2FudmFzCiAgICAgIH0gPSBkYXRhOwogICAgICBsZXQgYml0bWFwSWQyLCBiaXRtYXAyOwogICAgICBpZiAoY2FudmFzKSB7CiAgICAgICAgZGVsZXRlIGRhdGEuY2FudmFzOwogICAgICAgICh7CiAgICAgICAgICBpZDogYml0bWFwSWQyLAogICAgICAgICAgYml0bWFwOiBiaXRtYXAyCiAgICAgICAgfSA9IHVpTWFuYWdlci5pbWFnZU1hbmFnZXIuZ2V0RnJvbUNhbnZhcyhjb250YWluZXIyLmlkLCBjYW52YXMpKTsKICAgICAgICBjYW52YXMucmVtb3ZlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWlzc2luZ0NhbnZhcyA9IHRydWU7CiAgICAgICAgZGF0YS5faGFzTm9DYW52YXMgPSB0cnVlOwogICAgICB9CiAgICAgIGNvbnN0IGFsdFRleHQgPSAoYXdhaXQgcGFyZW50Ll9zdHJ1Y3RUcmVlLmdldEFyaWFBdHRyaWJ1dGVzKGAke0Fubm90YXRpb25QcmVmaXh9JHtpZH1gKSk/LmdldCgiYXJpYS1sYWJlbCIpIHx8ICIiOwogICAgICBpbml0aWFsRGF0YTIgPSBkYXRhID0gewogICAgICAgIGFubm90YXRpb25UeXBlOiBBbm5vdGF0aW9uRWRpdG9yVHlwZS5TVEFNUCwKICAgICAgICBiaXRtYXBJZDogYml0bWFwSWQyLAogICAgICAgIGJpdG1hcDogYml0bWFwMiwKICAgICAgICBwYWdlSW5kZXg6IHBhZ2VOdW1iZXIgLSAxLAogICAgICAgIHJlY3Q6IHJlY3QyLnNsaWNlKDApLAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGFubm90YXRpb25FbGVtZW50SWQ6IGlkLAogICAgICAgIGlkLAogICAgICAgIGRlbGV0ZWQ6IGZhbHNlLAogICAgICAgIGFjY2Vzc2liaWxpdHlEYXRhOiB7CiAgICAgICAgICBkZWNvcmF0aXZlOiBmYWxzZSwKICAgICAgICAgIGFsdFRleHQKICAgICAgICB9LAogICAgICAgIGlzU3ZnOiBmYWxzZSwKICAgICAgICBzdHJ1Y3RQYXJlbnQsCiAgICAgICAgcG9wdXBSZWYsCiAgICAgICAgcmljaFRleHQsCiAgICAgICAgY29tbWVudDogY29udGVudHNPYmo/LnN0ciB8fCBudWxsLAogICAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgICBtb2RpZmljYXRpb25EYXRlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBlZGl0b3IgPSBhd2FpdCBzdXBlci5kZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcik7CiAgICBjb25zdCB7CiAgICAgIHJlY3QsCiAgICAgIGJpdG1hcCwKICAgICAgYml0bWFwVXJsLAogICAgICBiaXRtYXBJZCwKICAgICAgaXNTdmcsCiAgICAgIGFjY2Vzc2liaWxpdHlEYXRhCiAgICB9ID0gZGF0YTsKICAgIGlmIChtaXNzaW5nQ2FudmFzKSB7CiAgICAgIHVpTWFuYWdlci5hZGRNaXNzaW5nQ2FudmFzKGRhdGEuaWQsIGVkaXRvcik7CiAgICAgIGVkaXRvci4jbWlzc2luZ0NhbnZhcyA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGJpdG1hcElkICYmIHVpTWFuYWdlci5pbWFnZU1hbmFnZXIuaXNWYWxpZElkKGJpdG1hcElkKSkgewogICAgICBlZGl0b3IuI2JpdG1hcElkID0gYml0bWFwSWQ7CiAgICAgIGlmIChiaXRtYXApIHsKICAgICAgICBlZGl0b3IuI2JpdG1hcCA9IGJpdG1hcDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWRpdG9yLiNiaXRtYXBVcmwgPSBiaXRtYXBVcmw7CiAgICB9CiAgICBlZGl0b3IuI2lzU3ZnID0gaXNTdmc7CiAgICBjb25zdCBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0gPSBlZGl0b3IucGFnZURpbWVuc2lvbnM7CiAgICBlZGl0b3Iud2lkdGggPSAocmVjdFsyXSAtIHJlY3RbMF0pIC8gcGFyZW50V2lkdGg7CiAgICBlZGl0b3IuaGVpZ2h0ID0gKHJlY3RbM10gLSByZWN0WzFdKSAvIHBhcmVudEhlaWdodDsKICAgIGlmIChhY2Nlc3NpYmlsaXR5RGF0YSkgewogICAgICBlZGl0b3IuYWx0VGV4dERhdGEgPSBhY2Nlc3NpYmlsaXR5RGF0YTsKICAgIH0KICAgIGVkaXRvci5faW5pdGlhbERhdGEgPSBpbml0aWFsRGF0YTI7CiAgICBpZiAoZGF0YS5jb21tZW50KSB7CiAgICAgIGVkaXRvci5zZXRDb21tZW50RGF0YShkYXRhKTsKICAgIH0KICAgIGVkaXRvci4jaGFzQmVlbkFkZGVkSW5VbmRvU3RhY2sgPSAhIWluaXRpYWxEYXRhMjsKICAgIHJldHVybiBlZGl0b3I7CiAgfQogIHNlcmlhbGl6ZShpc0ZvckNvcHlpbmcgPSBmYWxzZSwgY29udGV4dCA9IG51bGwpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0aGlzLmRlbGV0ZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplRGVsZXRlZCgpOwogICAgfQogICAgY29uc3Qgc2VyaWFsaXplZCA9IE9iamVjdC5hc3NpZ24oc3VwZXIuc2VyaWFsaXplKGlzRm9yQ29weWluZyksIHsKICAgICAgYml0bWFwSWQ6IHRoaXMuI2JpdG1hcElkLAogICAgICBpc1N2ZzogdGhpcy4jaXNTdmcKICAgIH0pOwogICAgdGhpcy5hZGRDb21tZW50KHNlcmlhbGl6ZWQpOwogICAgaWYgKGlzRm9yQ29weWluZykgewogICAgICBzZXJpYWxpemVkLmJpdG1hcFVybCA9IHRoaXMuI3NlcmlhbGl6ZUJpdG1hcCh0cnVlKTsKICAgICAgc2VyaWFsaXplZC5hY2Nlc3NpYmlsaXR5RGF0YSA9IHRoaXMuc2VyaWFsaXplQWx0VGV4dCh0cnVlKTsKICAgICAgc2VyaWFsaXplZC5pc0NvcHkgPSB0cnVlOwogICAgICByZXR1cm4gc2VyaWFsaXplZDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgZGVjb3JhdGl2ZSwKICAgICAgYWx0VGV4dAogICAgfSA9IHRoaXMuc2VyaWFsaXplQWx0VGV4dChmYWxzZSk7CiAgICBpZiAoIWRlY29yYXRpdmUgJiYgYWx0VGV4dCkgewogICAgICBzZXJpYWxpemVkLmFjY2Vzc2liaWxpdHlEYXRhID0gewogICAgICAgIHR5cGU6ICJGaWd1cmUiLAogICAgICAgIGFsdDogYWx0VGV4dAogICAgICB9OwogICAgfQogICAgaWYgKHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy4jaGFzRWxlbWVudENoYW5nZWQoc2VyaWFsaXplZCk7CiAgICAgIGlmIChjaGFuZ2VzLmlzU2FtZSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmIChjaGFuZ2VzLmlzU2FtZUFsdFRleHQpIHsKICAgICAgICBkZWxldGUgc2VyaWFsaXplZC5hY2Nlc3NpYmlsaXR5RGF0YTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXJpYWxpemVkLmFjY2Vzc2liaWxpdHlEYXRhLnN0cnVjdFBhcmVudCA9IHRoaXMuX2luaXRpYWxEYXRhLnN0cnVjdFBhcmVudCA/PyAtMTsKICAgICAgfQogICAgICBzZXJpYWxpemVkLmlkID0gdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkOwogICAgICBkZWxldGUgc2VyaWFsaXplZC5iaXRtYXBJZDsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICB9CiAgICBpZiAoY29udGV4dCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gc2VyaWFsaXplZDsKICAgIH0KICAgIGNvbnRleHQuc3RhbXBzIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgYXJlYSA9IHRoaXMuI2lzU3ZnID8gKHNlcmlhbGl6ZWQucmVjdFsyXSAtIHNlcmlhbGl6ZWQucmVjdFswXSkgKiAoc2VyaWFsaXplZC5yZWN0WzNdIC0gc2VyaWFsaXplZC5yZWN0WzFdKSA6IG51bGw7CiAgICBpZiAoIWNvbnRleHQuc3RhbXBzLmhhcyh0aGlzLiNiaXRtYXBJZCkpIHsKICAgICAgY29udGV4dC5zdGFtcHMuc2V0KHRoaXMuI2JpdG1hcElkLCB7CiAgICAgICAgYXJlYSwKICAgICAgICBzZXJpYWxpemVkCiAgICAgIH0pOwogICAgICBzZXJpYWxpemVkLmJpdG1hcCA9IHRoaXMuI3NlcmlhbGl6ZUJpdG1hcChmYWxzZSk7CiAgICB9IGVsc2UgaWYgKHRoaXMuI2lzU3ZnKSB7CiAgICAgIGNvbnN0IHByZXZEYXRhID0gY29udGV4dC5zdGFtcHMuZ2V0KHRoaXMuI2JpdG1hcElkKTsKICAgICAgaWYgKGFyZWEgPiBwcmV2RGF0YS5hcmVhKSB7CiAgICAgICAgcHJldkRhdGEuYXJlYSA9IGFyZWE7CiAgICAgICAgcHJldkRhdGEuc2VyaWFsaXplZC5iaXRtYXAuY2xvc2UoKTsKICAgICAgICBwcmV2RGF0YS5zZXJpYWxpemVkLmJpdG1hcCA9IHRoaXMuI3NlcmlhbGl6ZUJpdG1hcChmYWxzZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzZXJpYWxpemVkOwogIH0KICAjaGFzRWxlbWVudENoYW5nZWQoc2VyaWFsaXplZCkgewogICAgY29uc3QgewogICAgICBwYWdlSW5kZXgsCiAgICAgIGFjY2Vzc2liaWxpdHlEYXRhOiB7CiAgICAgICAgYWx0VGV4dAogICAgICB9CiAgICB9ID0gdGhpcy5faW5pdGlhbERhdGE7CiAgICBjb25zdCBpc1NhbWVQYWdlSW5kZXggPSBzZXJpYWxpemVkLnBhZ2VJbmRleCA9PT0gcGFnZUluZGV4OwogICAgY29uc3QgaXNTYW1lQWx0VGV4dCA9IChzZXJpYWxpemVkLmFjY2Vzc2liaWxpdHlEYXRhPy5hbHQgfHwgIiIpID09PSBhbHRUZXh0OwogICAgcmV0dXJuIHsKICAgICAgaXNTYW1lOiAhdGhpcy5oYXNFZGl0ZWRDb21tZW50ICYmICF0aGlzLl9oYXNCZWVuTW92ZWQgJiYgIXRoaXMuX2hhc0JlZW5SZXNpemVkICYmIGlzU2FtZVBhZ2VJbmRleCAmJiBpc1NhbWVBbHRUZXh0LAogICAgICBpc1NhbWVBbHRUZXh0CiAgICB9OwogIH0KICByZW5kZXJBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKSB7CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIGFubm90YXRpb24uaGlkZSgpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGFubm90YXRpb24udXBkYXRlRWRpdGVkKHsKICAgICAgcmVjdDogdGhpcy5nZXRQREZSZWN0KCksCiAgICAgIHBvcHVwOiB0aGlzLmNvbW1lbnQKICAgIH0pOwogICAgcmV0dXJuIG51bGw7CiAgfQp9Owp2YXIgQW5ub3RhdGlvbkVkaXRvckxheWVyID0gY2xhc3MgX0Fubm90YXRpb25FZGl0b3JMYXllciB7CiAgI2FjY2Vzc2liaWxpdHlNYW5hZ2VyOwogICNhbGxvd0NsaWNrID0gZmFsc2U7CiAgI2Fubm90YXRpb25MYXllciA9IG51bGw7CiAgI2NsaWNrQUMgPSBudWxsOwogICNlZGl0b3JGb2N1c1RpbWVvdXRJZCA9IG51bGw7CiAgI2VkaXRvcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNoYWRQb2ludGVyRG93biA9IGZhbHNlOwogICNpc0Rpc2FibGluZyA9IGZhbHNlOwogICNpc0VuYWJsaW5nID0gZmFsc2U7CiAgI2RyYXdpbmdBQyA9IG51bGw7CiAgI2ZvY3VzZWRFbGVtZW50ID0gbnVsbDsKICAjdGV4dExheWVyID0gbnVsbDsKICAjdGV4dFNlbGVjdGlvbkFDID0gbnVsbDsKICAjdGV4dExheWVyRGJsQ2xpY2tBQyA9IG51bGw7CiAgI2xhc3RQb2ludGVyRG93blRpbWVzdGFtcCA9IC0xOwogICN1aU1hbmFnZXI7CiAgc3RhdGljIF9pbml0aWFsaXplZCA9IGZhbHNlOwogIHN0YXRpYyAjZWRpdG9yVHlwZXMgPSBuZXcgTWFwKFtGcmVlVGV4dEVkaXRvciwgSW5rRWRpdG9yLCBTdGFtcEVkaXRvciwgSGlnaGxpZ2h0RWRpdG9yLCBTaWduYXR1cmVFZGl0b3JdLm1hcCgodHlwZSkgPT4gW3R5cGUuX2VkaXRvclR5cGUsIHR5cGVdKSk7CiAgY29uc3RydWN0b3IoewogICAgdWlNYW5hZ2VyLAogICAgcGFnZUluZGV4LAogICAgZGl2LAogICAgc3RydWN0VHJlZUxheWVyLAogICAgYWNjZXNzaWJpbGl0eU1hbmFnZXIsCiAgICBhbm5vdGF0aW9uTGF5ZXIsCiAgICBkcmF3TGF5ZXIsCiAgICB0ZXh0TGF5ZXIsCiAgICB2aWV3cG9ydCwKICAgIGwxMG4KICB9KSB7CiAgICBjb25zdCBlZGl0b3JUeXBlcyA9IFsuLi5fQW5ub3RhdGlvbkVkaXRvckxheWVyLiNlZGl0b3JUeXBlcy52YWx1ZXMoKV07CiAgICBpZiAoIV9Bbm5vdGF0aW9uRWRpdG9yTGF5ZXIuX2luaXRpYWxpemVkKSB7CiAgICAgIF9Bbm5vdGF0aW9uRWRpdG9yTGF5ZXIuX2luaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgZm9yIChjb25zdCBlZGl0b3JUeXBlIG9mIGVkaXRvclR5cGVzKSB7CiAgICAgICAgZWRpdG9yVHlwZS5pbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcik7CiAgICAgIH0KICAgIH0KICAgIHVpTWFuYWdlci5yZWdpc3RlckVkaXRvclR5cGVzKGVkaXRvclR5cGVzKTsKICAgIHRoaXMuI3VpTWFuYWdlciA9IHVpTWFuYWdlcjsKICAgIHRoaXMucGFnZUluZGV4ID0gcGFnZUluZGV4OwogICAgdGhpcy5kaXYgPSBkaXY7CiAgICB0aGlzLiNhY2Nlc3NpYmlsaXR5TWFuYWdlciA9IGFjY2Vzc2liaWxpdHlNYW5hZ2VyOwogICAgdGhpcy4jYW5ub3RhdGlvbkxheWVyID0gYW5ub3RhdGlvbkxheWVyOwogICAgdGhpcy52aWV3cG9ydCA9IHZpZXdwb3J0OwogICAgdGhpcy4jdGV4dExheWVyID0gdGV4dExheWVyOwogICAgdGhpcy5kcmF3TGF5ZXIgPSBkcmF3TGF5ZXI7CiAgICB0aGlzLl9zdHJ1Y3RUcmVlID0gc3RydWN0VHJlZUxheWVyOwogICAgdGhpcy4jdWlNYW5hZ2VyLmFkZExheWVyKHRoaXMpOwogIH0KICBnZXQgaXNFbXB0eSgpIHsKICAgIHJldHVybiB0aGlzLiNlZGl0b3JzLnNpemUgPT09IDA7CiAgfQogIGdldCBpc0ludmlzaWJsZSgpIHsKICAgIHJldHVybiB0aGlzLmlzRW1wdHkgJiYgdGhpcy4jdWlNYW5hZ2VyLmdldE1vZGUoKSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORTsKICB9CiAgdXBkYXRlVG9vbGJhcihvcHRpb25zKSB7CiAgICB0aGlzLiN1aU1hbmFnZXIudXBkYXRlVG9vbGJhcihvcHRpb25zKTsKICB9CiAgdXBkYXRlTW9kZShtb2RlID0gdGhpcy4jdWlNYW5hZ2VyLmdldE1vZGUoKSkgewogICAgdGhpcy4jY2xlYW51cCgpOwogICAgc3dpdGNoIChtb2RlKSB7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORToKICAgICAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJub25FZGl0aW5nIiwgdHJ1ZSk7CiAgICAgICAgdGhpcy5kaXNhYmxlVGV4dFNlbGVjdGlvbigpOwogICAgICAgIHRoaXMudG9nZ2xlUG9pbnRlckV2ZW50cyhmYWxzZSk7CiAgICAgICAgdGhpcy50b2dnbGVBbm5vdGF0aW9uTGF5ZXJQb2ludGVyRXZlbnRzKHRydWUpOwogICAgICAgIHRoaXMuZGlzYWJsZUNsaWNrKCk7CiAgICAgICAgcmV0dXJuOwogICAgICBjYXNlIEFubm90YXRpb25FZGl0b3JUeXBlLklOSzoKICAgICAgICB0aGlzLmRpc2FibGVUZXh0U2VsZWN0aW9uKCk7CiAgICAgICAgdGhpcy50b2dnbGVQb2ludGVyRXZlbnRzKHRydWUpOwogICAgICAgIHRoaXMuZW5hYmxlQ2xpY2soKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQ6CiAgICAgICAgdGhpcy5lbmFibGVUZXh0U2VsZWN0aW9uKCk7CiAgICAgICAgdGhpcy50b2dnbGVQb2ludGVyRXZlbnRzKGZhbHNlKTsKICAgICAgICB0aGlzLmRpc2FibGVDbGljaygpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuZGlzYWJsZVRleHRTZWxlY3Rpb24oKTsKICAgICAgICB0aGlzLnRvZ2dsZVBvaW50ZXJFdmVudHModHJ1ZSk7CiAgICAgICAgdGhpcy5lbmFibGVDbGljaygpOwogICAgfQogICAgdGhpcy50b2dnbGVBbm5vdGF0aW9uTGF5ZXJQb2ludGVyRXZlbnRzKGZhbHNlKTsKICAgIGNvbnN0IHsKICAgICAgY2xhc3NMaXN0CiAgICB9ID0gdGhpcy5kaXY7CiAgICBjbGFzc0xpc3QudG9nZ2xlKCJub25FZGl0aW5nIiwgZmFsc2UpOwogICAgaWYgKG1vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLlBPUFVQKSB7CiAgICAgIGNsYXNzTGlzdC50b2dnbGUoImNvbW1lbnRFZGl0aW5nIiwgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBjbGFzc0xpc3QudG9nZ2xlKCJjb21tZW50RWRpdGluZyIsIGZhbHNlKTsKICAgICAgZm9yIChjb25zdCBlZGl0b3JUeXBlIG9mIF9Bbm5vdGF0aW9uRWRpdG9yTGF5ZXIuI2VkaXRvclR5cGVzLnZhbHVlcygpKSB7CiAgICAgICAgY2xhc3NMaXN0LnRvZ2dsZShgJHtlZGl0b3JUeXBlLl90eXBlfUVkaXRpbmdgLCBtb2RlID09PSBlZGl0b3JUeXBlLl9lZGl0b3JUeXBlKTsKICAgICAgfQogICAgfQogICAgdGhpcy5kaXYuaGlkZGVuID0gZmFsc2U7CiAgfQogIGhhc1RleHRMYXllcih0ZXh0TGF5ZXIpIHsKICAgIHJldHVybiB0ZXh0TGF5ZXIgPT09IHRoaXMuI3RleHRMYXllcj8uZGl2OwogIH0KICBzZXRFZGl0aW5nU3RhdGUoaXNFZGl0aW5nKSB7CiAgICB0aGlzLiN1aU1hbmFnZXIuc2V0RWRpdGluZ1N0YXRlKGlzRWRpdGluZyk7CiAgfQogIGFkZENvbW1hbmRzKHBhcmFtcykgewogICAgdGhpcy4jdWlNYW5hZ2VyLmFkZENvbW1hbmRzKHBhcmFtcyk7CiAgfQogIGNsZWFuVW5kb1N0YWNrKHR5cGUpIHsKICAgIHRoaXMuI3VpTWFuYWdlci5jbGVhblVuZG9TdGFjayh0eXBlKTsKICB9CiAgdG9nZ2xlRHJhd2luZyhlbmFibGVkID0gZmFsc2UpIHsKICAgIHRoaXMuZGl2LmNsYXNzTGlzdC50b2dnbGUoImRyYXdpbmciLCAhZW5hYmxlZCk7CiAgfQogIHRvZ2dsZVBvaW50ZXJFdmVudHMoZW5hYmxlZCA9IGZhbHNlKSB7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJkaXNhYmxlZCIsICFlbmFibGVkKTsKICB9CiAgdG9nZ2xlQW5ub3RhdGlvbkxheWVyUG9pbnRlckV2ZW50cyhlbmFibGVkID0gZmFsc2UpIHsKICAgIHRoaXMuI2Fubm90YXRpb25MYXllcj8udG9nZ2xlUG9pbnRlckV2ZW50cyhlbmFibGVkKTsKICB9CiAgZ2V0ICNhbGxFZGl0b3JzSXRlcmF0b3IoKSB7CiAgICByZXR1cm4gdGhpcy4jZWRpdG9ycy5zaXplICE9PSAwID8gdGhpcy4jZWRpdG9ycy52YWx1ZXMoKSA6IHRoaXMuI3VpTWFuYWdlci5nZXRFZGl0b3JzKHRoaXMucGFnZUluZGV4KTsKICB9CiAgYXN5bmMgZW5hYmxlKCkgewogICAgdGhpcy4jaXNFbmFibGluZyA9IHRydWU7CiAgICB0aGlzLmRpdi50YWJJbmRleCA9IDA7CiAgICB0aGlzLnRvZ2dsZVBvaW50ZXJFdmVudHModHJ1ZSk7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJub25FZGl0aW5nIiwgZmFsc2UpOwogICAgdGhpcy4jdGV4dExheWVyRGJsQ2xpY2tBQz8uYWJvcnQoKTsKICAgIHRoaXMuI3RleHRMYXllckRibENsaWNrQUMgPSBudWxsOwogICAgY29uc3QgYW5ub3RhdGlvbkVsZW1lbnRJZHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9yc0l0ZXJhdG9yKSB7CiAgICAgIGVkaXRvci5lbmFibGVFZGl0aW5nKCk7CiAgICAgIGVkaXRvci5zaG93KHRydWUpOwogICAgICBpZiAoZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgICB0aGlzLiN1aU1hbmFnZXIucmVtb3ZlQ2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbihlZGl0b3IpOwogICAgICAgIGFubm90YXRpb25FbGVtZW50SWRzLmFkZChlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGFubm90YXRpb25MYXllciA9IHRoaXMuI2Fubm90YXRpb25MYXllcjsKICAgIGlmIChhbm5vdGF0aW9uTGF5ZXIpIHsKICAgICAgZm9yIChjb25zdCBlZGl0YWJsZSBvZiBhbm5vdGF0aW9uTGF5ZXIuZ2V0RWRpdGFibGVBbm5vdGF0aW9ucygpKSB7CiAgICAgICAgZWRpdGFibGUuaGlkZSgpOwogICAgICAgIGlmICh0aGlzLiN1aU1hbmFnZXIuaXNEZWxldGVkQW5ub3RhdGlvbkVsZW1lbnQoZWRpdGFibGUuZGF0YS5pZCkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoYW5ub3RhdGlvbkVsZW1lbnRJZHMuaGFzKGVkaXRhYmxlLmRhdGEuaWQpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWRpdG9yID0gYXdhaXQgdGhpcy5kZXNlcmlhbGl6ZShlZGl0YWJsZSk7CiAgICAgICAgaWYgKCFlZGl0b3IpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICB0aGlzLmFkZE9yUmVidWlsZChlZGl0b3IpOwogICAgICAgIGVkaXRvci5lbmFibGVFZGl0aW5nKCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2lzRW5hYmxpbmcgPSBmYWxzZTsKICAgIHRoaXMuI3VpTWFuYWdlci5fZXZlbnRCdXMuZGlzcGF0Y2goImVkaXRvcnNyZW5kZXJlZCIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICBwYWdlTnVtYmVyOiB0aGlzLnBhZ2VJbmRleCArIDEKICAgIH0pOwogIH0KICBkaXNhYmxlKCkgewogICAgdGhpcy4jaXNEaXNhYmxpbmcgPSB0cnVlOwogICAgdGhpcy5kaXYudGFiSW5kZXggPSAtMTsKICAgIHRoaXMudG9nZ2xlUG9pbnRlckV2ZW50cyhmYWxzZSk7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJub25FZGl0aW5nIiwgdHJ1ZSk7CiAgICBpZiAodGhpcy4jdGV4dExheWVyICYmICF0aGlzLiN0ZXh0TGF5ZXJEYmxDbGlja0FDKSB7CiAgICAgIHRoaXMuI3RleHRMYXllckRibENsaWNrQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI3VpTWFuYWdlci5jb21iaW5lZFNpZ25hbCh0aGlzLiN0ZXh0TGF5ZXJEYmxDbGlja0FDKTsKICAgICAgdGhpcy4jdGV4dExheWVyLmRpdi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIChlKSA9PiB7CiAgICAgICAgY29uc3QgREJMX0NMSUNLX1RIUkVTSE9MRCA9IDUwMDsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBjbGllbnRYLAogICAgICAgICAgY2xpZW50WSwKICAgICAgICAgIHRpbWVTdGFtcAogICAgICAgIH0gPSBlOwogICAgICAgIGNvbnN0IGxhc3RQb2ludGVyRG93blRpbWVzdGFtcCA9IHRoaXMuI2xhc3RQb2ludGVyRG93blRpbWVzdGFtcDsKICAgICAgICBpZiAodGltZVN0YW1wIC0gbGFzdFBvaW50ZXJEb3duVGltZXN0YW1wID4gREJMX0NMSUNLX1RIUkVTSE9MRCkgewogICAgICAgICAgdGhpcy4jbGFzdFBvaW50ZXJEb3duVGltZXN0YW1wID0gdGltZVN0YW1wOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLiNsYXN0UG9pbnRlckRvd25UaW1lc3RhbXAgPSAtMTsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBjbGFzc0xpc3Q6IGNsYXNzTGlzdDIKICAgICAgICB9ID0gdGhpcy5kaXY7CiAgICAgICAgY2xhc3NMaXN0Mi50b2dnbGUoImdldEVsZW1lbnRzIiwgdHJ1ZSk7CiAgICAgICAgY29uc3QgZWxlbWVudHMgPSBkb2N1bWVudC5lbGVtZW50c0Zyb21Qb2ludChjbGllbnRYLCBjbGllbnRZKTsKICAgICAgICBjbGFzc0xpc3QyLnRvZ2dsZSgiZ2V0RWxlbWVudHMiLCBmYWxzZSk7CiAgICAgICAgaWYgKCF0aGlzLmRpdi5jb250YWlucyhlbGVtZW50c1swXSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbGV0IGlkOwogICAgICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChgXiR7QW5ub3RhdGlvbkVkaXRvclByZWZpeH1bMC05XSskYCk7CiAgICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7CiAgICAgICAgICBpZiAocmVnZXgudGVzdChlbGVtZW50LmlkKSkgewogICAgICAgICAgICBpZCA9IGVsZW1lbnQuaWQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWlkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuI2VkaXRvcnMuZ2V0KGlkKTsKICAgICAgICBpZiAoZWRpdG9yPy5hbm5vdGF0aW9uRWxlbWVudElkID09PSBudWxsKSB7CiAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgZWRpdG9yLmRibGNsaWNrKGUpOwogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHNpZ25hbCwKICAgICAgICBjYXB0dXJlOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgYW5ub3RhdGlvbkxheWVyID0gdGhpcy4jYW5ub3RhdGlvbkxheWVyOwogICAgY29uc3QgbmVlZEZha2VBbm5vdGF0aW9uID0gW107CiAgICBpZiAoYW5ub3RhdGlvbkxheWVyKSB7CiAgICAgIGNvbnN0IGNoYW5nZWRBbm5vdGF0aW9ucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgIGNvbnN0IHJlc2V0QW5ub3RhdGlvbnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzSXRlcmF0b3IpIHsKICAgICAgICBlZGl0b3IuZGlzYWJsZUVkaXRpbmcoKTsKICAgICAgICBpZiAoIWVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgICAgICBuZWVkRmFrZUFubm90YXRpb24ucHVzaChlZGl0b3IpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChlZGl0b3Iuc2VyaWFsaXplKCkgIT09IG51bGwpIHsKICAgICAgICAgIGNoYW5nZWRBbm5vdGF0aW9ucy5zZXQoZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQsIGVkaXRvcik7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzZXRBbm5vdGF0aW9ucy5zZXQoZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQsIGVkaXRvcik7CiAgICAgICAgfQogICAgICAgIHRoaXMuZ2V0RWRpdGFibGVBbm5vdGF0aW9uKGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKT8uc2hvdygpOwogICAgICAgIGVkaXRvci5yZW1vdmUoKTsKICAgICAgfQogICAgICBjb25zdCBlZGl0YWJsZXMgPSBhbm5vdGF0aW9uTGF5ZXIuZ2V0RWRpdGFibGVBbm5vdGF0aW9ucygpOwogICAgICBmb3IgKGNvbnN0IGVkaXRhYmxlIG9mIGVkaXRhYmxlcykgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGlkCiAgICAgICAgfSA9IGVkaXRhYmxlLmRhdGE7CiAgICAgICAgaWYgKHRoaXMuI3VpTWFuYWdlci5pc0RlbGV0ZWRBbm5vdGF0aW9uRWxlbWVudChpZCkpIHsKICAgICAgICAgIGVkaXRhYmxlLnVwZGF0ZUVkaXRlZCh7CiAgICAgICAgICAgIGRlbGV0ZWQ6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGxldCBlZGl0b3IgPSByZXNldEFubm90YXRpb25zLmdldChpZCk7CiAgICAgICAgaWYgKGVkaXRvcikgewogICAgICAgICAgZWRpdG9yLnJlc2V0QW5ub3RhdGlvbkVsZW1lbnQoZWRpdGFibGUpOwogICAgICAgICAgZWRpdG9yLnNob3coZmFsc2UpOwogICAgICAgICAgZWRpdGFibGUuc2hvdygpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGVkaXRvciA9IGNoYW5nZWRBbm5vdGF0aW9ucy5nZXQoaWQpOwogICAgICAgIGlmIChlZGl0b3IpIHsKICAgICAgICAgIHRoaXMuI3VpTWFuYWdlci5hZGRDaGFuZ2VkRXhpc3RpbmdBbm5vdGF0aW9uKGVkaXRvcik7CiAgICAgICAgICBpZiAoZWRpdG9yLnJlbmRlckFubm90YXRpb25FbGVtZW50KGVkaXRhYmxlKSkgewogICAgICAgICAgICBlZGl0b3Iuc2hvdyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVkaXRhYmxlLnNob3coKTsKICAgICAgfQogICAgfQogICAgdGhpcy4jY2xlYW51cCgpOwogICAgaWYgKHRoaXMuaXNFbXB0eSkgewogICAgICB0aGlzLmRpdi5oaWRkZW4gPSB0cnVlOwogICAgfQogICAgY29uc3QgewogICAgICBjbGFzc0xpc3QKICAgIH0gPSB0aGlzLmRpdjsKICAgIGZvciAoY29uc3QgZWRpdG9yVHlwZSBvZiBfQW5ub3RhdGlvbkVkaXRvckxheWVyLiNlZGl0b3JUeXBlcy52YWx1ZXMoKSkgewogICAgICBjbGFzc0xpc3QucmVtb3ZlKGAke2VkaXRvclR5cGUuX3R5cGV9RWRpdGluZ2ApOwogICAgfQogICAgdGhpcy5kaXNhYmxlVGV4dFNlbGVjdGlvbigpOwogICAgdGhpcy50b2dnbGVBbm5vdGF0aW9uTGF5ZXJQb2ludGVyRXZlbnRzKHRydWUpOwogICAgYW5ub3RhdGlvbkxheWVyPy51cGRhdGVGYWtlQW5ub3RhdGlvbnMobmVlZEZha2VBbm5vdGF0aW9uKTsKICAgIHRoaXMuI2lzRGlzYWJsaW5nID0gZmFsc2U7CiAgfQogIGdldEVkaXRhYmxlQW5ub3RhdGlvbihpZCkgewogICAgcmV0dXJuIHRoaXMuI2Fubm90YXRpb25MYXllcj8uZ2V0RWRpdGFibGVBbm5vdGF0aW9uKGlkKSB8fCBudWxsOwogIH0KICBzZXRBY3RpdmVFZGl0b3IoZWRpdG9yKSB7CiAgICBjb25zdCBjdXJyZW50QWN0aXZlID0gdGhpcy4jdWlNYW5hZ2VyLmdldEFjdGl2ZSgpOwogICAgaWYgKGN1cnJlbnRBY3RpdmUgPT09IGVkaXRvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiN1aU1hbmFnZXIuc2V0QWN0aXZlRWRpdG9yKGVkaXRvcik7CiAgfQogIGVuYWJsZVRleHRTZWxlY3Rpb24oKSB7CiAgICB0aGlzLmRpdi50YWJJbmRleCA9IC0xOwogICAgaWYgKHRoaXMuI3RleHRMYXllcj8uZGl2ICYmICF0aGlzLiN0ZXh0U2VsZWN0aW9uQUMpIHsKICAgICAgdGhpcy4jdGV4dFNlbGVjdGlvbkFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgICBjb25zdCBzaWduYWwgPSB0aGlzLiN1aU1hbmFnZXIuY29tYmluZWRTaWduYWwodGhpcy4jdGV4dFNlbGVjdGlvbkFDKTsKICAgICAgdGhpcy4jdGV4dExheWVyLmRpdi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHRoaXMuI3RleHRMYXllclBvaW50ZXJEb3duLmJpbmQodGhpcyksIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIHRoaXMuI3RleHRMYXllci5kaXYuY2xhc3NMaXN0LmFkZCgiaGlnaGxpZ2h0aW5nIik7CiAgICB9CiAgfQogIGRpc2FibGVUZXh0U2VsZWN0aW9uKCkgewogICAgdGhpcy5kaXYudGFiSW5kZXggPSAwOwogICAgaWYgKHRoaXMuI3RleHRMYXllcj8uZGl2ICYmIHRoaXMuI3RleHRTZWxlY3Rpb25BQykgewogICAgICB0aGlzLiN0ZXh0U2VsZWN0aW9uQUMuYWJvcnQoKTsKICAgICAgdGhpcy4jdGV4dFNlbGVjdGlvbkFDID0gbnVsbDsKICAgICAgdGhpcy4jdGV4dExheWVyLmRpdi5jbGFzc0xpc3QucmVtb3ZlKCJoaWdobGlnaHRpbmciKTsKICAgIH0KICB9CiAgI3RleHRMYXllclBvaW50ZXJEb3duKGV2ZW50KSB7CiAgICB0aGlzLiN1aU1hbmFnZXIudW5zZWxlY3RBbGwoKTsKICAgIGNvbnN0IHsKICAgICAgdGFyZ2V0CiAgICB9ID0gZXZlbnQ7CiAgICBpZiAodGFyZ2V0ID09PSB0aGlzLiN0ZXh0TGF5ZXIuZGl2IHx8ICh0YXJnZXQuZ2V0QXR0cmlidXRlKCJyb2xlIikgPT09ICJpbWciIHx8IHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoImVuZE9mQ29udGVudCIpKSAmJiB0aGlzLiN0ZXh0TGF5ZXIuZGl2LmNvbnRhaW5zKHRhcmdldCkpIHsKICAgICAgY29uc3QgewogICAgICAgIGlzTWFjCiAgICAgIH0gPSB1dGlsX0ZlYXR1cmVUZXN0LnBsYXRmb3JtOwogICAgICBpZiAoZXZlbnQuYnV0dG9uICE9PSAwIHx8IGV2ZW50LmN0cmxLZXkgJiYgaXNNYWMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcy4jdWlNYW5hZ2VyLnNob3dBbGxFZGl0b3JzKCJoaWdobGlnaHQiLCB0cnVlLCB0cnVlKTsKICAgICAgdGhpcy4jdGV4dExheWVyLmRpdi5jbGFzc0xpc3QuYWRkKCJmcmVlIik7CiAgICAgIHRoaXMudG9nZ2xlRHJhd2luZygpOwogICAgICBIaWdobGlnaHRFZGl0b3Iuc3RhcnRIaWdobGlnaHRpbmcodGhpcywgdGhpcy4jdWlNYW5hZ2VyLmRpcmVjdGlvbiA9PT0gImx0ciIsIHsKICAgICAgICB0YXJnZXQ6IHRoaXMuI3RleHRMYXllci5kaXYsCiAgICAgICAgeDogZXZlbnQueCwKICAgICAgICB5OiBldmVudC55CiAgICAgIH0pOwogICAgICB0aGlzLiN0ZXh0TGF5ZXIuZGl2LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsICgpID0+IHsKICAgICAgICB0aGlzLiN0ZXh0TGF5ZXIuZGl2LmNsYXNzTGlzdC5yZW1vdmUoImZyZWUiKTsKICAgICAgICB0aGlzLnRvZ2dsZURyYXdpbmcodHJ1ZSk7CiAgICAgIH0sIHsKICAgICAgICBvbmNlOiB0cnVlLAogICAgICAgIHNpZ25hbDogdGhpcy4jdWlNYW5hZ2VyLl9zaWduYWwKICAgICAgfSk7CiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICB9CiAgfQogIGVuYWJsZUNsaWNrKCkgewogICAgaWYgKHRoaXMuI2NsaWNrQUMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY2xpY2tBQyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI3VpTWFuYWdlci5jb21iaW5lZFNpZ25hbCh0aGlzLiNjbGlja0FDKTsKICAgIHRoaXMuZGl2LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgdGhpcy5wb2ludGVyZG93bi5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBjb25zdCBwb2ludGVydXAgPSB0aGlzLnBvaW50ZXJ1cC5iaW5kKHRoaXMpOwogICAgdGhpcy5kaXYuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgcG9pbnRlcnVwLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0aGlzLmRpdi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyY2FuY2VsIiwgcG9pbnRlcnVwLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgfQogIGRpc2FibGVDbGljaygpIHsKICAgIHRoaXMuI2NsaWNrQUM/LmFib3J0KCk7CiAgICB0aGlzLiNjbGlja0FDID0gbnVsbDsKICB9CiAgYXR0YWNoKGVkaXRvcikgewogICAgdGhpcy4jZWRpdG9ycy5zZXQoZWRpdG9yLmlkLCBlZGl0b3IpOwogICAgY29uc3QgewogICAgICBhbm5vdGF0aW9uRWxlbWVudElkCiAgICB9ID0gZWRpdG9yOwogICAgaWYgKGFubm90YXRpb25FbGVtZW50SWQgJiYgdGhpcy4jdWlNYW5hZ2VyLmlzRGVsZXRlZEFubm90YXRpb25FbGVtZW50KGFubm90YXRpb25FbGVtZW50SWQpKSB7CiAgICAgIHRoaXMuI3VpTWFuYWdlci5yZW1vdmVEZWxldGVkQW5ub3RhdGlvbkVsZW1lbnQoZWRpdG9yKTsKICAgIH0KICB9CiAgZGV0YWNoKGVkaXRvcikgewogICAgdGhpcy4jZWRpdG9ycy5kZWxldGUoZWRpdG9yLmlkKTsKICAgIHRoaXMuI2FjY2Vzc2liaWxpdHlNYW5hZ2VyPy5yZW1vdmVQb2ludGVySW5UZXh0TGF5ZXIoZWRpdG9yLmNvbnRlbnREaXYpOwogICAgaWYgKCF0aGlzLiNpc0Rpc2FibGluZyAmJiBlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICB0aGlzLiN1aU1hbmFnZXIuYWRkRGVsZXRlZEFubm90YXRpb25FbGVtZW50KGVkaXRvcik7CiAgICB9CiAgfQogIHJlbW92ZShlZGl0b3IpIHsKICAgIHRoaXMuZGV0YWNoKGVkaXRvcik7CiAgICB0aGlzLiN1aU1hbmFnZXIucmVtb3ZlRWRpdG9yKGVkaXRvcik7CiAgICBlZGl0b3IuZGl2LnJlbW92ZSgpOwogICAgZWRpdG9yLmlzQXR0YWNoZWRUb0RPTSA9IGZhbHNlOwogIH0KICBjaGFuZ2VQYXJlbnQoZWRpdG9yKSB7CiAgICBpZiAoZWRpdG9yLnBhcmVudCA9PT0gdGhpcykgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZWRpdG9yLnBhcmVudCAmJiBlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICB0aGlzLiN1aU1hbmFnZXIuYWRkRGVsZXRlZEFubm90YXRpb25FbGVtZW50KGVkaXRvcik7CiAgICAgIEFubm90YXRpb25FZGl0b3IuZGVsZXRlQW5ub3RhdGlvbkVsZW1lbnQoZWRpdG9yKTsKICAgICAgZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQgPSBudWxsOwogICAgfQogICAgdGhpcy5hdHRhY2goZWRpdG9yKTsKICAgIGVkaXRvci5wYXJlbnQ/LmRldGFjaChlZGl0b3IpOwogICAgZWRpdG9yLnNldFBhcmVudCh0aGlzKTsKICAgIGlmIChlZGl0b3IuZGl2ICYmIGVkaXRvci5pc0F0dGFjaGVkVG9ET00pIHsKICAgICAgZWRpdG9yLmRpdi5yZW1vdmUoKTsKICAgICAgdGhpcy5kaXYuYXBwZW5kKGVkaXRvci5kaXYpOwogICAgfQogIH0KICBhZGQoZWRpdG9yKSB7CiAgICBpZiAoZWRpdG9yLnBhcmVudCA9PT0gdGhpcyAmJiBlZGl0b3IuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuY2hhbmdlUGFyZW50KGVkaXRvcik7CiAgICB0aGlzLiN1aU1hbmFnZXIuYWRkRWRpdG9yKGVkaXRvcik7CiAgICB0aGlzLmF0dGFjaChlZGl0b3IpOwogICAgaWYgKCFlZGl0b3IuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIGNvbnN0IGRpdiA9IGVkaXRvci5yZW5kZXIoKTsKICAgICAgdGhpcy5kaXYuYXBwZW5kKGRpdik7CiAgICAgIGVkaXRvci5pc0F0dGFjaGVkVG9ET00gPSB0cnVlOwogICAgfQogICAgZWRpdG9yLmZpeEFuZFNldFBvc2l0aW9uKCk7CiAgICBlZGl0b3Iub25jZUFkZGVkKCF0aGlzLiNpc0VuYWJsaW5nKTsKICAgIHRoaXMuI3VpTWFuYWdlci5hZGRUb0Fubm90YXRpb25TdG9yYWdlKGVkaXRvcik7CiAgICBlZGl0b3IuX3JlcG9ydFRlbGVtZXRyeShlZGl0b3IudGVsZW1ldHJ5SW5pdGlhbERhdGEpOwogIH0KICBtb3ZlRWRpdG9ySW5ET00oZWRpdG9yKSB7CiAgICBpZiAoIWVkaXRvci5pc0F0dGFjaGVkVG9ET00pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBhY3RpdmVFbGVtZW50CiAgICB9ID0gZG9jdW1lbnQ7CiAgICBpZiAoZWRpdG9yLmRpdi5jb250YWlucyhhY3RpdmVFbGVtZW50KSAmJiAhdGhpcy4jZWRpdG9yRm9jdXNUaW1lb3V0SWQpIHsKICAgICAgZWRpdG9yLl9mb2N1c0V2ZW50c0FsbG93ZWQgPSBmYWxzZTsKICAgICAgdGhpcy4jZWRpdG9yRm9jdXNUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLiNlZGl0b3JGb2N1c1RpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgaWYgKCFlZGl0b3IuZGl2LmNvbnRhaW5zKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpKSB7CiAgICAgICAgICBlZGl0b3IuZGl2LmFkZEV2ZW50TGlzdGVuZXIoImZvY3VzaW4iLCAoKSA9PiB7CiAgICAgICAgICAgIGVkaXRvci5fZm9jdXNFdmVudHNBbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgb25jZTogdHJ1ZSwKICAgICAgICAgICAgc2lnbmFsOiB0aGlzLiN1aU1hbmFnZXIuX3NpZ25hbAogICAgICAgICAgfSk7CiAgICAgICAgICBhY3RpdmVFbGVtZW50LmZvY3VzKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVkaXRvci5fZm9jdXNFdmVudHNBbGxvd2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0sIDApOwogICAgfQogICAgZWRpdG9yLl9zdHJ1Y3RUcmVlUGFyZW50SWQgPSB0aGlzLiNhY2Nlc3NpYmlsaXR5TWFuYWdlcj8ubW92ZUVsZW1lbnRJbkRPTSh0aGlzLmRpdiwgZWRpdG9yLmRpdiwgZWRpdG9yLmNvbnRlbnREaXYsIHRydWUpOwogIH0KICBhZGRPclJlYnVpbGQoZWRpdG9yKSB7CiAgICBpZiAoZWRpdG9yLm5lZWRzVG9CZVJlYnVpbHQoKSkgewogICAgICBlZGl0b3IucGFyZW50IHx8PSB0aGlzOwogICAgICBlZGl0b3IucmVidWlsZCgpOwogICAgICBlZGl0b3Iuc2hvdygpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5hZGQoZWRpdG9yKTsKICAgIH0KICB9CiAgYWRkVW5kb2FibGVFZGl0b3IoZWRpdG9yKSB7CiAgICBjb25zdCBjbWQgPSAoKSA9PiBlZGl0b3IuX3VpTWFuYWdlci5yZWJ1aWxkKGVkaXRvcik7CiAgICBjb25zdCB1bmRvID0gKCkgPT4gewogICAgICBlZGl0b3IucmVtb3ZlKCk7CiAgICB9OwogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZCwKICAgICAgdW5kbywKICAgICAgbXVzdEV4ZWM6IGZhbHNlCiAgICB9KTsKICB9CiAgZ2V0RWRpdG9yQnlVSUQodWlkKSB7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNlZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgIGlmIChlZGl0b3IudWlkID09PSB1aWQpIHsKICAgICAgICByZXR1cm4gZWRpdG9yOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgZ2V0TmV4dElkKCkgewogICAgcmV0dXJuIHRoaXMuI3VpTWFuYWdlci5nZXRJZCgpOwogIH0KICBnZXQgI2N1cnJlbnRFZGl0b3JUeXBlKCkgewogICAgcmV0dXJuIF9Bbm5vdGF0aW9uRWRpdG9yTGF5ZXIuI2VkaXRvclR5cGVzLmdldCh0aGlzLiN1aU1hbmFnZXIuZ2V0TW9kZSgpKTsKICB9CiAgY29tYmluZWRTaWduYWwoYWMpIHsKICAgIHJldHVybiB0aGlzLiN1aU1hbmFnZXIuY29tYmluZWRTaWduYWwoYWMpOwogIH0KICAjY3JlYXRlTmV3RWRpdG9yKHBhcmFtcykgewogICAgY29uc3QgZWRpdG9yVHlwZSA9IHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlOwogICAgcmV0dXJuIGVkaXRvclR5cGUgPyBuZXcgZWRpdG9yVHlwZS5wcm90b3R5cGUuY29uc3RydWN0b3IocGFyYW1zKSA6IG51bGw7CiAgfQogIGNhbkNyZWF0ZU5ld0VtcHR5RWRpdG9yKCkgewogICAgcmV0dXJuIHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlPy5jYW5DcmVhdGVOZXdFbXB0eUVkaXRvcigpOwogIH0KICBhc3luYyBwYXN0ZUVkaXRvcihvcHRpb25zLCBwYXJhbXMpIHsKICAgIHRoaXMudXBkYXRlVG9vbGJhcihvcHRpb25zKTsKICAgIGF3YWl0IHRoaXMuI3VpTWFuYWdlci51cGRhdGVNb2RlKG9wdGlvbnMubW9kZSk7CiAgICBjb25zdCB7CiAgICAgIG9mZnNldFgsCiAgICAgIG9mZnNldFkKICAgIH0gPSB0aGlzLiNnZXRDZW50ZXJQb2ludCgpOwogICAgY29uc3QgaWQgPSB0aGlzLmdldE5leHRJZCgpOwogICAgY29uc3QgZWRpdG9yID0gdGhpcy4jY3JlYXRlTmV3RWRpdG9yKHsKICAgICAgcGFyZW50OiB0aGlzLAogICAgICBpZCwKICAgICAgeDogb2Zmc2V0WCwKICAgICAgeTogb2Zmc2V0WSwKICAgICAgdWlNYW5hZ2VyOiB0aGlzLiN1aU1hbmFnZXIsCiAgICAgIGlzQ2VudGVyZWQ6IHRydWUsCiAgICAgIC4uLnBhcmFtcwogICAgfSk7CiAgICBpZiAoZWRpdG9yKSB7CiAgICAgIHRoaXMuYWRkKGVkaXRvcik7CiAgICB9CiAgfQogIGFzeW5jIGRlc2VyaWFsaXplKGRhdGEpIHsKICAgIHJldHVybiBhd2FpdCBfQW5ub3RhdGlvbkVkaXRvckxheWVyLiNlZGl0b3JUeXBlcy5nZXQoZGF0YS5hbm5vdGF0aW9uVHlwZSA/PyBkYXRhLmFubm90YXRpb25FZGl0b3JUeXBlKT8uZGVzZXJpYWxpemUoZGF0YSwgdGhpcywgdGhpcy4jdWlNYW5hZ2VyKSB8fCBudWxsOwogIH0KICBjcmVhdGVBbmRBZGROZXdFZGl0b3IoZXZlbnQsIGlzQ2VudGVyZWQsIGRhdGEgPSB7fSkgewogICAgY29uc3QgaWQgPSB0aGlzLmdldE5leHRJZCgpOwogICAgY29uc3QgZWRpdG9yID0gdGhpcy4jY3JlYXRlTmV3RWRpdG9yKHsKICAgICAgcGFyZW50OiB0aGlzLAogICAgICBpZCwKICAgICAgeDogZXZlbnQub2Zmc2V0WCwKICAgICAgeTogZXZlbnQub2Zmc2V0WSwKICAgICAgdWlNYW5hZ2VyOiB0aGlzLiN1aU1hbmFnZXIsCiAgICAgIGlzQ2VudGVyZWQsCiAgICAgIC4uLmRhdGEKICAgIH0pOwogICAgaWYgKGVkaXRvcikgewogICAgICB0aGlzLmFkZChlZGl0b3IpOwogICAgfQogICAgcmV0dXJuIGVkaXRvcjsKICB9CiAgZ2V0IGJvdW5kaW5nQ2xpZW50UmVjdCgpIHsKICAgIHJldHVybiB0aGlzLmRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB9CiAgI2dldENlbnRlclBvaW50KCkgewogICAgY29uc3QgewogICAgICB4LAogICAgICB5LAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gdGhpcy5ib3VuZGluZ0NsaWVudFJlY3Q7CiAgICBjb25zdCB0bFggPSBNYXRoLm1heCgwLCB4KTsKICAgIGNvbnN0IHRsWSA9IE1hdGgubWF4KDAsIHkpOwogICAgY29uc3QgYnJYID0gTWF0aC5taW4od2luZG93LmlubmVyV2lkdGgsIHggKyB3aWR0aCk7CiAgICBjb25zdCBiclkgPSBNYXRoLm1pbih3aW5kb3cuaW5uZXJIZWlnaHQsIHkgKyBoZWlnaHQpOwogICAgY29uc3QgY2VudGVyWCA9ICh0bFggKyBiclgpIC8gMiAtIHg7CiAgICBjb25zdCBjZW50ZXJZID0gKHRsWSArIGJyWSkgLyAyIC0geTsKICAgIGNvbnN0IFtvZmZzZXRYLCBvZmZzZXRZXSA9IHRoaXMudmlld3BvcnQucm90YXRpb24gJSAxODAgPT09IDAgPyBbY2VudGVyWCwgY2VudGVyWV0gOiBbY2VudGVyWSwgY2VudGVyWF07CiAgICByZXR1cm4gewogICAgICBvZmZzZXRYLAogICAgICBvZmZzZXRZCiAgICB9OwogIH0KICBhZGROZXdFZGl0b3IoZGF0YSA9IHt9KSB7CiAgICB0aGlzLmNyZWF0ZUFuZEFkZE5ld0VkaXRvcih0aGlzLiNnZXRDZW50ZXJQb2ludCgpLCB0cnVlLCBkYXRhKTsKICB9CiAgc2V0U2VsZWN0ZWQoZWRpdG9yKSB7CiAgICB0aGlzLiN1aU1hbmFnZXIuc2V0U2VsZWN0ZWQoZWRpdG9yKTsKICB9CiAgdG9nZ2xlU2VsZWN0ZWQoZWRpdG9yKSB7CiAgICB0aGlzLiN1aU1hbmFnZXIudG9nZ2xlU2VsZWN0ZWQoZWRpdG9yKTsKICB9CiAgdW5zZWxlY3QoZWRpdG9yKSB7CiAgICB0aGlzLiN1aU1hbmFnZXIudW5zZWxlY3QoZWRpdG9yKTsKICB9CiAgcG9pbnRlcnVwKGV2ZW50KSB7CiAgICBjb25zdCB7CiAgICAgIGlzTWFjCiAgICB9ID0gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybTsKICAgIGlmIChldmVudC5idXR0b24gIT09IDAgfHwgZXZlbnQuY3RybEtleSAmJiBpc01hYykgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnQudGFyZ2V0ICE9PSB0aGlzLmRpdikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI2hhZFBvaW50ZXJEb3duKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2hhZFBvaW50ZXJEb3duID0gZmFsc2U7CiAgICBpZiAodGhpcy4jY3VycmVudEVkaXRvclR5cGU/LmlzRHJhd2VyICYmIHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlLnN1cHBvcnRNdWx0aXBsZURyYXdpbmdzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy4jYWxsb3dDbGljaykgewogICAgICB0aGlzLiNhbGxvd0NsaWNrID0gdHJ1ZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY3VycmVudE1vZGUgPSB0aGlzLiN1aU1hbmFnZXIuZ2V0TW9kZSgpOwogICAgaWYgKGN1cnJlbnRNb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5TVEFNUCB8fCBjdXJyZW50TW9kZSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuU0lHTkFUVVJFKSB7CiAgICAgIHRoaXMuI3VpTWFuYWdlci51bnNlbGVjdEFsbCgpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmNyZWF0ZUFuZEFkZE5ld0VkaXRvcihldmVudCwgZmFsc2UpOwogIH0KICBwb2ludGVyZG93bihldmVudCkgewogICAgaWYgKHRoaXMuI3VpTWFuYWdlci5nZXRNb2RlKCkgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLkhJR0hMSUdIVCkgewogICAgICB0aGlzLmVuYWJsZVRleHRTZWxlY3Rpb24oKTsKICAgIH0KICAgIGlmICh0aGlzLiNoYWRQb2ludGVyRG93bikgewogICAgICB0aGlzLiNoYWRQb2ludGVyRG93biA9IGZhbHNlOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGlzTWFjCiAgICB9ID0gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybTsKICAgIGlmIChldmVudC5idXR0b24gIT09IDAgfHwgZXZlbnQuY3RybEtleSAmJiBpc01hYykgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnQudGFyZ2V0ICE9PSB0aGlzLmRpdikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNoYWRQb2ludGVyRG93biA9IHRydWU7CiAgICBpZiAodGhpcy4jY3VycmVudEVkaXRvclR5cGU/LmlzRHJhd2VyKSB7CiAgICAgIHRoaXMuc3RhcnREcmF3aW5nU2Vzc2lvbihldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuI3VpTWFuYWdlci5nZXRBY3RpdmUoKTsKICAgIHRoaXMuI2FsbG93Q2xpY2sgPSAhZWRpdG9yIHx8IGVkaXRvci5pc0VtcHR5KCk7CiAgfQogIHN0YXJ0RHJhd2luZ1Nlc3Npb24oZXZlbnQpIHsKICAgIHRoaXMuZGl2LmZvY3VzKHsKICAgICAgcHJldmVudFNjcm9sbDogdHJ1ZQogICAgfSk7CiAgICBpZiAodGhpcy4jZHJhd2luZ0FDKSB7CiAgICAgIHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlLnN0YXJ0RHJhd2luZyh0aGlzLCB0aGlzLiN1aU1hbmFnZXIsIGZhbHNlLCBldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3VpTWFuYWdlci5zZXRDdXJyZW50RHJhd2luZ1Nlc3Npb24odGhpcyk7CiAgICB0aGlzLiNkcmF3aW5nQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiN1aU1hbmFnZXIuY29tYmluZWRTaWduYWwodGhpcy4jZHJhd2luZ0FDKTsKICAgIHRoaXMuZGl2LmFkZEV2ZW50TGlzdGVuZXIoImJsdXIiLCAoewogICAgICByZWxhdGVkVGFyZ2V0CiAgICB9KSA9PiB7CiAgICAgIGlmIChyZWxhdGVkVGFyZ2V0ICYmICF0aGlzLmRpdi5jb250YWlucyhyZWxhdGVkVGFyZ2V0KSkgewogICAgICAgIHRoaXMuI2ZvY3VzZWRFbGVtZW50ID0gbnVsbDsKICAgICAgICB0aGlzLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlLnN0YXJ0RHJhd2luZyh0aGlzLCB0aGlzLiN1aU1hbmFnZXIsIGZhbHNlLCBldmVudCk7CiAgfQogIHBhdXNlKG9uKSB7CiAgICBpZiAob24pIHsKICAgICAgY29uc3QgewogICAgICAgIGFjdGl2ZUVsZW1lbnQKICAgICAgfSA9IGRvY3VtZW50OwogICAgICBpZiAodGhpcy5kaXYuY29udGFpbnMoYWN0aXZlRWxlbWVudCkpIHsKICAgICAgICB0aGlzLiNmb2N1c2VkRWxlbWVudCA9IGFjdGl2ZUVsZW1lbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI2ZvY3VzZWRFbGVtZW50KSB7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuI2ZvY3VzZWRFbGVtZW50Py5mb2N1cygpOwogICAgICAgIHRoaXMuI2ZvY3VzZWRFbGVtZW50ID0gbnVsbDsKICAgICAgfSwgMCk7CiAgICB9CiAgfQogIGVuZERyYXdpbmdTZXNzaW9uKGlzQWJvcnRlZCA9IGZhbHNlKSB7CiAgICBpZiAoIXRoaXMuI2RyYXdpbmdBQykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHRoaXMuI3VpTWFuYWdlci5zZXRDdXJyZW50RHJhd2luZ1Nlc3Npb24obnVsbCk7CiAgICB0aGlzLiNkcmF3aW5nQUMuYWJvcnQoKTsKICAgIHRoaXMuI2RyYXdpbmdBQyA9IG51bGw7CiAgICB0aGlzLiNmb2N1c2VkRWxlbWVudCA9IG51bGw7CiAgICByZXR1cm4gdGhpcy4jY3VycmVudEVkaXRvclR5cGUuZW5kRHJhd2luZyhpc0Fib3J0ZWQpOwogIH0KICBmaW5kTmV3UGFyZW50KGVkaXRvciwgeCwgeSkgewogICAgY29uc3QgbGF5ZXIgPSB0aGlzLiN1aU1hbmFnZXIuZmluZFBhcmVudCh4LCB5KTsKICAgIGlmIChsYXllciA9PT0gbnVsbCB8fCBsYXllciA9PT0gdGhpcykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBsYXllci5jaGFuZ2VQYXJlbnQoZWRpdG9yKTsKICAgIHJldHVybiB0cnVlOwogIH0KICBjb21taXRPclJlbW92ZSgpIHsKICAgIGlmICh0aGlzLiNkcmF3aW5nQUMpIHsKICAgICAgdGhpcy5lbmREcmF3aW5nU2Vzc2lvbigpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgb25TY2FsZUNoYW5naW5nKCkgewogICAgaWYgKCF0aGlzLiNkcmF3aW5nQUMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY3VycmVudEVkaXRvclR5cGUub25TY2FsZUNoYW5naW5nV2hlbkRyYXdpbmcodGhpcyk7CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICBpZiAodGhpcy4jdWlNYW5hZ2VyLmdldEFjdGl2ZSgpPy5wYXJlbnQgPT09IHRoaXMpIHsKICAgICAgdGhpcy4jdWlNYW5hZ2VyLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICAgIHRoaXMuI3VpTWFuYWdlci5zZXRBY3RpdmVFZGl0b3IobnVsbCk7CiAgICB9CiAgICBpZiAodGhpcy4jZWRpdG9yRm9jdXNUaW1lb3V0SWQpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuI2VkaXRvckZvY3VzVGltZW91dElkKTsKICAgICAgdGhpcy4jZWRpdG9yRm9jdXNUaW1lb3V0SWQgPSBudWxsOwogICAgfQogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jZWRpdG9ycy52YWx1ZXMoKSkgewogICAgICB0aGlzLiNhY2Nlc3NpYmlsaXR5TWFuYWdlcj8ucmVtb3ZlUG9pbnRlckluVGV4dExheWVyKGVkaXRvci5jb250ZW50RGl2KTsKICAgICAgZWRpdG9yLnNldFBhcmVudChudWxsKTsKICAgICAgZWRpdG9yLmlzQXR0YWNoZWRUb0RPTSA9IGZhbHNlOwogICAgICBlZGl0b3IuZGl2LnJlbW92ZSgpOwogICAgfQogICAgdGhpcy5kaXYgPSBudWxsOwogICAgdGhpcy4jZWRpdG9ycy5jbGVhcigpOwogICAgdGhpcy4jdWlNYW5hZ2VyLnJlbW92ZUxheWVyKHRoaXMpOwogIH0KICAjY2xlYW51cCgpIHsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2VkaXRvcnMudmFsdWVzKCkpIHsKICAgICAgaWYgKGVkaXRvci5pc0VtcHR5KCkpIHsKICAgICAgICBlZGl0b3IucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0KICB9CiAgcmVuZGVyKHsKICAgIHZpZXdwb3J0CiAgfSkgewogICAgdGhpcy52aWV3cG9ydCA9IHZpZXdwb3J0OwogICAgc2V0TGF5ZXJEaW1lbnNpb25zKHRoaXMuZGl2LCB2aWV3cG9ydCk7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiN1aU1hbmFnZXIuZ2V0RWRpdG9ycyh0aGlzLnBhZ2VJbmRleCkpIHsKICAgICAgdGhpcy5hZGQoZWRpdG9yKTsKICAgICAgZWRpdG9yLnJlYnVpbGQoKTsKICAgIH0KICAgIHRoaXMudXBkYXRlTW9kZSgpOwogIH0KICB1cGRhdGUoewogICAgdmlld3BvcnQKICB9KSB7CiAgICB0aGlzLiN1aU1hbmFnZXIuY29tbWl0T3JSZW1vdmUoKTsKICAgIHRoaXMuI2NsZWFudXAoKTsKICAgIGNvbnN0IG9sZFJvdGF0aW9uID0gdGhpcy52aWV3cG9ydC5yb3RhdGlvbjsKICAgIGNvbnN0IHJvdGF0aW9uID0gdmlld3BvcnQucm90YXRpb247CiAgICB0aGlzLnZpZXdwb3J0ID0gdmlld3BvcnQ7CiAgICBzZXRMYXllckRpbWVuc2lvbnModGhpcy5kaXYsIHsKICAgICAgcm90YXRpb24KICAgIH0pOwogICAgaWYgKG9sZFJvdGF0aW9uICE9PSByb3RhdGlvbikgewogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNlZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgICAgZWRpdG9yLnJvdGF0ZShyb3RhdGlvbik7CiAgICAgIH0KICAgIH0KICB9CiAgZ2V0IHBhZ2VEaW1lbnNpb25zKCkgewogICAgY29uc3QgewogICAgICBwYWdlV2lkdGgsCiAgICAgIHBhZ2VIZWlnaHQKICAgIH0gPSB0aGlzLnZpZXdwb3J0LnJhd0RpbXM7CiAgICByZXR1cm4gW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF07CiAgfQogIGdldCBzY2FsZSgpIHsKICAgIHJldHVybiB0aGlzLiN1aU1hbmFnZXIudmlld1BhcmFtZXRlcnMucmVhbFNjYWxlOwogIH0KfTsKdmFyIERyYXdMYXllciA9IGNsYXNzIF9EcmF3TGF5ZXIgewogICNwYXJlbnQgPSBudWxsOwogICNtYXBwaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjdG9VcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHN0YXRpYyAjaWQgPSAwOwogIGNvbnN0cnVjdG9yKHsKICAgIHBhZ2VJbmRleAogIH0pIHsKICAgIHRoaXMucGFnZUluZGV4ID0gcGFnZUluZGV4OwogIH0KICBzZXRQYXJlbnQocGFyZW50KSB7CiAgICBpZiAoIXRoaXMuI3BhcmVudCkgewogICAgICB0aGlzLiNwYXJlbnQgPSBwYXJlbnQ7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiNwYXJlbnQgIT09IHBhcmVudCkgewogICAgICBpZiAodGhpcy4jbWFwcGluZy5zaXplID4gMCkgewogICAgICAgIGZvciAoY29uc3Qgcm9vdDIgb2YgdGhpcy4jbWFwcGluZy52YWx1ZXMoKSkgewogICAgICAgICAgcm9vdDIucmVtb3ZlKCk7CiAgICAgICAgICBwYXJlbnQuYXBwZW5kKHJvb3QyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy4jcGFyZW50ID0gcGFyZW50OwogICAgfQogIH0KICBzdGF0aWMgZ2V0IF9zdmdGYWN0b3J5KCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX3N2Z0ZhY3RvcnkiLCBuZXcgRE9NU1ZHRmFjdG9yeSgpKTsKICB9CiAgc3RhdGljICNzZXRCb3goZWxlbWVudCwgW3gsIHksIHdpZHRoLCBoZWlnaHRdKSB7CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gZWxlbWVudDsKICAgIHN0eWxlLnRvcCA9IGAkezEwMCAqIHl9JWA7CiAgICBzdHlsZS5sZWZ0ID0gYCR7MTAwICogeH0lYDsKICAgIHN0eWxlLndpZHRoID0gYCR7MTAwICogd2lkdGh9JWA7CiAgICBzdHlsZS5oZWlnaHQgPSBgJHsxMDAgKiBoZWlnaHR9JWA7CiAgfQogICNjcmVhdGVTVkcoKSB7CiAgICBjb25zdCBzdmcgPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZSgxLCAxLCB0cnVlKTsKICAgIHRoaXMuI3BhcmVudC5hcHBlbmQoc3ZnKTsKICAgIHN2Zy5zZXRBdHRyaWJ1dGUoImFyaWEtaGlkZGVuIiwgdHJ1ZSk7CiAgICByZXR1cm4gc3ZnOwogIH0KICAjY3JlYXRlQ2xpcFBhdGgoZGVmcywgcGF0aElkKSB7CiAgICBjb25zdCBjbGlwUGF0aCA9IF9EcmF3TGF5ZXIuX3N2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiKTsKICAgIGRlZnMuYXBwZW5kKGNsaXBQYXRoKTsKICAgIGNvbnN0IGNsaXBQYXRoSWQgPSBgY2xpcF8ke3BhdGhJZH1gOwogICAgY2xpcFBhdGguc2V0QXR0cmlidXRlKCJpZCIsIGNsaXBQYXRoSWQpOwogICAgY2xpcFBhdGguc2V0QXR0cmlidXRlKCJjbGlwUGF0aFVuaXRzIiwgIm9iamVjdEJvdW5kaW5nQm94Iik7CiAgICBjb25zdCBjbGlwUGF0aFVzZSA9IF9EcmF3TGF5ZXIuX3N2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgidXNlIik7CiAgICBjbGlwUGF0aC5hcHBlbmQoY2xpcFBhdGhVc2UpOwogICAgY2xpcFBhdGhVc2Uuc2V0QXR0cmlidXRlKCJocmVmIiwgYCMke3BhdGhJZH1gKTsKICAgIGNsaXBQYXRoVXNlLmNsYXNzTGlzdC5hZGQoImNsaXAiKTsKICAgIHJldHVybiBjbGlwUGF0aElkOwogIH0KICAjdXBkYXRlUHJvcGVydGllcyhlbGVtZW50LCBwcm9wZXJ0aWVzKSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwcm9wZXJ0aWVzKSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgfQogIGRyYXcocHJvcGVydGllcywgaXNQYXRoVXBkYXRhYmxlID0gZmFsc2UsIGhhc0NsaXAgPSBmYWxzZSkgewogICAgY29uc3QgaWQgPSBfRHJhd0xheWVyLiNpZCsrOwogICAgY29uc3Qgcm9vdDIgPSB0aGlzLiNjcmVhdGVTVkcoKTsKICAgIGNvbnN0IGRlZnMgPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoImRlZnMiKTsKICAgIHJvb3QyLmFwcGVuZChkZWZzKTsKICAgIGNvbnN0IHBhdGggPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInBhdGgiKTsKICAgIGRlZnMuYXBwZW5kKHBhdGgpOwogICAgY29uc3QgcGF0aElkID0gYHBhdGhfcCR7dGhpcy5wYWdlSW5kZXh9XyR7aWR9YDsKICAgIHBhdGguc2V0QXR0cmlidXRlKCJpZCIsIHBhdGhJZCk7CiAgICBwYXRoLnNldEF0dHJpYnV0ZSgidmVjdG9yLWVmZmVjdCIsICJub24tc2NhbGluZy1zdHJva2UiKTsKICAgIGlmIChpc1BhdGhVcGRhdGFibGUpIHsKICAgICAgdGhpcy4jdG9VcGRhdGUuc2V0KGlkLCBwYXRoKTsKICAgIH0KICAgIGNvbnN0IGNsaXBQYXRoSWQgPSBoYXNDbGlwID8gdGhpcy4jY3JlYXRlQ2xpcFBhdGgoZGVmcywgcGF0aElkKSA6IG51bGw7CiAgICBjb25zdCB1c2UgPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInVzZSIpOwogICAgcm9vdDIuYXBwZW5kKHVzZSk7CiAgICB1c2Uuc2V0QXR0cmlidXRlKCJocmVmIiwgYCMke3BhdGhJZH1gKTsKICAgIHRoaXMudXBkYXRlUHJvcGVydGllcyhyb290MiwgcHJvcGVydGllcyk7CiAgICB0aGlzLiNtYXBwaW5nLnNldChpZCwgcm9vdDIpOwogICAgcmV0dXJuIHsKICAgICAgaWQsCiAgICAgIGNsaXBQYXRoSWQ6IGB1cmwoIyR7Y2xpcFBhdGhJZH0pYAogICAgfTsKICB9CiAgZHJhd091dGxpbmUocHJvcGVydGllcywgbXVzdFJlbW92ZVNlbGZJbnRlcnNlY3Rpb25zKSB7CiAgICBjb25zdCBpZCA9IF9EcmF3TGF5ZXIuI2lkKys7CiAgICBjb25zdCByb290MiA9IHRoaXMuI2NyZWF0ZVNWRygpOwogICAgY29uc3QgZGVmcyA9IF9EcmF3TGF5ZXIuX3N2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgiZGVmcyIpOwogICAgcm9vdDIuYXBwZW5kKGRlZnMpOwogICAgY29uc3QgcGF0aCA9IF9EcmF3TGF5ZXIuX3N2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgicGF0aCIpOwogICAgZGVmcy5hcHBlbmQocGF0aCk7CiAgICBjb25zdCBwYXRoSWQgPSBgcGF0aF9wJHt0aGlzLnBhZ2VJbmRleH1fJHtpZH1gOwogICAgcGF0aC5zZXRBdHRyaWJ1dGUoImlkIiwgcGF0aElkKTsKICAgIHBhdGguc2V0QXR0cmlidXRlKCJ2ZWN0b3ItZWZmZWN0IiwgIm5vbi1zY2FsaW5nLXN0cm9rZSIpOwogICAgbGV0IG1hc2tJZDsKICAgIGlmIChtdXN0UmVtb3ZlU2VsZkludGVyc2VjdGlvbnMpIHsKICAgICAgY29uc3QgbWFzayA9IF9EcmF3TGF5ZXIuX3N2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgibWFzayIpOwogICAgICBkZWZzLmFwcGVuZChtYXNrKTsKICAgICAgbWFza0lkID0gYG1hc2tfcCR7dGhpcy5wYWdlSW5kZXh9XyR7aWR9YDsKICAgICAgbWFzay5zZXRBdHRyaWJ1dGUoImlkIiwgbWFza0lkKTsKICAgICAgbWFzay5zZXRBdHRyaWJ1dGUoIm1hc2tVbml0cyIsICJvYmplY3RCb3VuZGluZ0JveCIpOwogICAgICBjb25zdCByZWN0ID0gX0RyYXdMYXllci5fc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJyZWN0Iik7CiAgICAgIG1hc2suYXBwZW5kKHJlY3QpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgid2lkdGgiLCAiMSIpOwogICAgICByZWN0LnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgIjEiKTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoImZpbGwiLCAid2hpdGUiKTsKICAgICAgY29uc3QgdXNlID0gX0RyYXdMYXllci5fc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJ1c2UiKTsKICAgICAgbWFzay5hcHBlbmQodXNlKTsKICAgICAgdXNlLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGAjJHtwYXRoSWR9YCk7CiAgICAgIHVzZS5zZXRBdHRyaWJ1dGUoInN0cm9rZSIsICJub25lIik7CiAgICAgIHVzZS5zZXRBdHRyaWJ1dGUoImZpbGwiLCAiYmxhY2siKTsKICAgICAgdXNlLnNldEF0dHJpYnV0ZSgiZmlsbC1ydWxlIiwgIm5vbnplcm8iKTsKICAgICAgdXNlLmNsYXNzTGlzdC5hZGQoIm1hc2siKTsKICAgIH0KICAgIGNvbnN0IHVzZTEgPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInVzZSIpOwogICAgcm9vdDIuYXBwZW5kKHVzZTEpOwogICAgdXNlMS5zZXRBdHRyaWJ1dGUoImhyZWYiLCBgIyR7cGF0aElkfWApOwogICAgaWYgKG1hc2tJZCkgewogICAgICB1c2UxLnNldEF0dHJpYnV0ZSgibWFzayIsIGB1cmwoIyR7bWFza0lkfSlgKTsKICAgIH0KICAgIGNvbnN0IHVzZTIgPSB1c2UxLmNsb25lTm9kZSgpOwogICAgcm9vdDIuYXBwZW5kKHVzZTIpOwogICAgdXNlMS5jbGFzc0xpc3QuYWRkKCJtYWluT3V0bGluZSIpOwogICAgdXNlMi5jbGFzc0xpc3QuYWRkKCJzZWNvbmRhcnlPdXRsaW5lIik7CiAgICB0aGlzLnVwZGF0ZVByb3BlcnRpZXMocm9vdDIsIHByb3BlcnRpZXMpOwogICAgdGhpcy4jbWFwcGluZy5zZXQoaWQsIHJvb3QyKTsKICAgIHJldHVybiBpZDsKICB9CiAgZmluYWxpemVEcmF3KGlkLCBwcm9wZXJ0aWVzKSB7CiAgICB0aGlzLiN0b1VwZGF0ZS5kZWxldGUoaWQpOwogICAgdGhpcy51cGRhdGVQcm9wZXJ0aWVzKGlkLCBwcm9wZXJ0aWVzKTsKICB9CiAgdXBkYXRlUHJvcGVydGllcyhlbGVtZW50T3JJZCwgcHJvcGVydGllcykgewogICAgaWYgKCFwcm9wZXJ0aWVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgcm9vdDogcm9vdDIsCiAgICAgIGJib3gsCiAgICAgIHJvb3RDbGFzcywKICAgICAgcGF0aAogICAgfSA9IHByb3BlcnRpZXM7CiAgICBjb25zdCBlbGVtZW50ID0gdHlwZW9mIGVsZW1lbnRPcklkID09PSAibnVtYmVyIiA/IHRoaXMuI21hcHBpbmcuZ2V0KGVsZW1lbnRPcklkKSA6IGVsZW1lbnRPcklkOwogICAgaWYgKCFlbGVtZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChyb290MikgewogICAgICB0aGlzLiN1cGRhdGVQcm9wZXJ0aWVzKGVsZW1lbnQsIHJvb3QyKTsKICAgIH0KICAgIGlmIChiYm94KSB7CiAgICAgIF9EcmF3TGF5ZXIuI3NldEJveChlbGVtZW50LCBiYm94KTsKICAgIH0KICAgIGlmIChyb290Q2xhc3MpIHsKICAgICAgY29uc3QgewogICAgICAgIGNsYXNzTGlzdAogICAgICB9ID0gZWxlbWVudDsKICAgICAgZm9yIChjb25zdCBbY2xhc3NOYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMocm9vdENsYXNzKSkgewogICAgICAgIGNsYXNzTGlzdC50b2dnbGUoY2xhc3NOYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChwYXRoKSB7CiAgICAgIGNvbnN0IGRlZnMgPSBlbGVtZW50LmZpcnN0RWxlbWVudENoaWxkOwogICAgICBjb25zdCBwYXRoRWxlbWVudCA9IGRlZnMuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICAgIHRoaXMuI3VwZGF0ZVByb3BlcnRpZXMocGF0aEVsZW1lbnQsIHBhdGgpOwogICAgfQogIH0KICB1cGRhdGVQYXJlbnQoaWQsIGxheWVyKSB7CiAgICBpZiAobGF5ZXIgPT09IHRoaXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgcm9vdDIgPSB0aGlzLiNtYXBwaW5nLmdldChpZCk7CiAgICBpZiAoIXJvb3QyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxheWVyLiNwYXJlbnQuYXBwZW5kKHJvb3QyKTsKICAgIHRoaXMuI21hcHBpbmcuZGVsZXRlKGlkKTsKICAgIGxheWVyLiNtYXBwaW5nLnNldChpZCwgcm9vdDIpOwogIH0KICByZW1vdmUoaWQpIHsKICAgIHRoaXMuI3RvVXBkYXRlLmRlbGV0ZShpZCk7CiAgICBpZiAodGhpcy4jcGFyZW50ID09PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI21hcHBpbmcuZ2V0KGlkKS5yZW1vdmUoKTsKICAgIHRoaXMuI21hcHBpbmcuZGVsZXRlKGlkKTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI3BhcmVudCA9IG51bGw7CiAgICBmb3IgKGNvbnN0IHJvb3QyIG9mIHRoaXMuI21hcHBpbmcudmFsdWVzKCkpIHsKICAgICAgcm9vdDIucmVtb3ZlKCk7CiAgICB9CiAgICB0aGlzLiNtYXBwaW5nLmNsZWFyKCk7CiAgICB0aGlzLiN0b1VwZGF0ZS5jbGVhcigpOwogIH0KfTsKewogIGdsb2JhbFRoaXMuX3BkZmpzVGVzdGluZ1V0aWxzID0gewogICAgSGlnaGxpZ2h0T3V0bGluZXIKICB9Owp9Cmdsb2JhbFRoaXMucGRmanNMaWIgPSB7CiAgQWJvcnRFeGNlcHRpb24sCiAgQW5ub3RhdGlvbkVkaXRvckxheWVyLAogIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLAogIEFubm90YXRpb25FZGl0b3JUeXBlLAogIEFubm90YXRpb25FZGl0b3JVSU1hbmFnZXIsCiAgQW5ub3RhdGlvbkxheWVyLAogIEFubm90YXRpb25Nb2RlLAogIEFubm90YXRpb25UeXBlLAogIGFwcGx5T3BhY2l0eSwKICBidWlsZCwKICBDb2xvclBpY2tlciwKICBjcmVhdGVWYWxpZEFic29sdXRlVXJsLAogIENTU0NvbnN0YW50cywKICBET01TVkdGYWN0b3J5LAogIERyYXdMYXllciwKICBGZWF0dXJlVGVzdDogdXRpbF9GZWF0dXJlVGVzdCwKICBmZXRjaERhdGEsCiAgZmluZENvbnRyYXN0Q29sb3IsCiAgZ2V0RG9jdW1lbnQsCiAgZ2V0RmlsZW5hbWVGcm9tVXJsLAogIGdldFBkZkZpbGVuYW1lRnJvbVVybCwKICBnZXRSR0IsCiAgZ2V0VXVpZCwKICBnZXRYZmFQYWdlVmlld3BvcnQsCiAgR2xvYmFsV29ya2VyT3B0aW9ucywKICBJbWFnZUtpbmQ6IHV0aWxfSW1hZ2VLaW5kLAogIEludmFsaWRQREZFeGNlcHRpb24sCiAgaXNEYXRhU2NoZW1lLAogIGlzUGRmRmlsZSwKICBpc1ZhbGlkRXhwbGljaXREZXN0LAogIE1hdGhDbGFtcCwKICBub0NvbnRleHRNZW51LAogIG5vcm1hbGl6ZVVuaWNvZGUsCiAgT1BTLAogIE91dHB1dFNjYWxlLAogIFBhc3N3b3JkUmVzcG9uc2VzLAogIFBERkRhdGFSYW5nZVRyYW5zcG9ydCwKICBQREZEYXRlU3RyaW5nLAogIFBERldvcmtlciwKICBQZXJtaXNzaW9uRmxhZywKICBQaXhlbHNQZXJJbmNoLAogIFJlbmRlcmluZ0NhbmNlbGxlZEV4Y2VwdGlvbiwKICByZW5kZXJSaWNoVGV4dCwKICBSZXNwb25zZUV4Y2VwdGlvbiwKICBzZXRMYXllckRpbWVuc2lvbnMsCiAgc2hhZG93LAogIFNpZ25hdHVyZUV4dHJhY3RvciwKICBzdG9wRXZlbnQsCiAgU3VwcG9ydGVkSW1hZ2VNaW1lVHlwZXMsCiAgVGV4dExheWVyLAogIFRvdWNoTWFuYWdlciwKICB1cGRhdGVVcmxIYXNoLAogIFV0aWwsCiAgVmVyYm9zaXR5TGV2ZWwsCiAgdmVyc2lvbiwKICBYZmFMYXllcgp9OwoKLy8gc3JjL2RhdGEvc3Vic2NyaXB0aW9ucy50cwp2YXIgU1VCU0NSSVBUSU9OX1BBVFRFUk5TID0gewogIC8vID09PSBTVFJFQU1JTkcgVklERU8gJiBUViA9PT0KICBuZXRmbGl4OiB7IHJlZ2V4OiAvbmV0ZmxpeC9pLCBuYW1lOiAiTmV0ZmxpeCIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL25ldGZsaXguY29tIiB9LAogIGh1bHU6IHsgcmVnZXg6IC9odWx1L2ksIG5hbWU6ICJIdWx1IiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaHVsdS5jb20iIH0sCiAgZGlzbmV5X3BsdXM6IHsgcmVnZXg6IC9kaXNuZXlcK3xkaXNuZXkgcGx1cy9pLCBuYW1lOiAiRGlzbmV5KyIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Rpc25leXBsdXMuY29tIiB9LAogIGhib19tYXg6IHsgcmVnZXg6IC9oYm8gbWF4fGhib21heHxtYXhcLmNvbS9pLCBuYW1lOiAiTWF4IChIQk8pIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWF4LmNvbSIgfSwKICBhbWF6b25fcHJpbWVfdmlkZW86IHsgcmVnZXg6IC9wcmltZSB2aWRlby9pLCBuYW1lOiAiUHJpbWUgVmlkZW8iLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9wcmltZXZpZGVvLmNvbSIgfSwKICB5b3V0dWJlX3ByZW1pdW06IHsgcmVnZXg6IC95b3V0dWJlIGRpc3RpbmN0fGdvb2dsZSBcKnlvdXR1YmUvaSwgbmFtZTogIllvdVR1YmUgUHJlbWl1bSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3lvdXR1YmUuY29tIiB9LAogIGFwcGxlX3R2OiB7IHJlZ2V4OiAvYXBwbGVcLmNvbVwvYmlsbHxhcHBsZSB0di9pLCBuYW1lOiAiQXBwbGUgVFYrIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYXBwbGUuY29tIiB9LAogIHBlYWNvY2s6IHsgcmVnZXg6IC9wZWFjb2NrL2ksIG5hbWU6ICJQZWFjb2NrIFRWIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGVhY29ja3R2LmNvbSIgfSwKICBwYXJhbW91bnRfcGx1czogeyByZWdleDogL3BhcmFtb3VudFwrfGNicyBpbnRlcmFjdGl2ZS9pLCBuYW1lOiAiUGFyYW1vdW50KyIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BhcmFtb3VudHBsdXMuY29tIiB9LAogIHNsaW5nX3R2OiB7IHJlZ2V4OiAvc2xpbmcgdHZ8c2xpbmdcLmNvbS9pLCBuYW1lOiAiU2xpbmcgVFYiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zbGluZy5jb20iIH0sCiAgZnVib190djogeyByZWdleDogL2Z1Ym8vaSwgbmFtZTogIkZ1Ym9UViIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Z1Ym8udHYiIH0sCiAgZGlzY292ZXJ5X3BsdXM6IHsgcmVnZXg6IC9kaXNjb3ZlcnlcK3xkaXNjb3ZlcnkgcGx1cy9pLCBuYW1lOiAiRGlzY292ZXJ5KyIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Rpc2NvdmVyeXBsdXMuY29tIiB9LAogIGNydW5jaHlyb2xsOiB7IHJlZ2V4OiAvY3J1bmNoeXJvbGwvaSwgbmFtZTogIkNydW5jaHlyb2xsIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY3J1bmNoeXJvbGwuY29tIiB9LAogIGZ1bmltYXRpb246IHsgcmVnZXg6IC9mdW5pbWF0aW9uL2ksIG5hbWU6ICJGdW5pbWF0aW9uIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZnVuaW1hdGlvbi5jb20iIH0sCiAgZXNwbl9wbHVzOiB7IHJlZ2V4OiAvZXNwblwrfGVzcG4gbWFnYXppbmUvaSwgbmFtZTogIkVTUE4rIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGx1cy5lc3BuLmNvbSIgfSwKICBkYXpuOiB7IHJlZ2V4OiAvZGF6bi9pLCBuYW1lOiAiREFaTiIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Rhem4uY29tIiB9LAogIHN0YXJ6OiB7IHJlZ2V4OiAvc3RhcnovaSwgbmFtZTogIlN0YXJ6IiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3RhcnouY29tIiB9LAogIHNob3d0aW1lOiB7IHJlZ2V4OiAvc2hvd3RpbWUvaSwgbmFtZTogIlNob3d0aW1lIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc2hvLmNvbSIgfSwKICBicml0Ym94OiB7IHJlZ2V4OiAvYnJpdGJveC9pLCBuYW1lOiAiQnJpdEJveCIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2JyaXRib3guY29tIiB9LAogIGFjb3JuX3R2OiB7IHJlZ2V4OiAvYWNvcm4gdHYvaSwgbmFtZTogIkFjb3JuIFRWIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYWNvcm4udHYiIH0sCiAgcGhpbF90djogeyByZWdleDogL3BoaWxvL2ksIG5hbWU6ICJQaGlsbyIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BoaWxvLmNvbSIgfSwKICB2aWtpOiB7IHJlZ2V4OiAvdmlraS9pLCBuYW1lOiAiUmFrdXRlbiBWaWtpIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdmlraS5jb20iIH0sCiAgdHViaTogeyByZWdleDogL3R1YmkvaSwgbmFtZTogIlR1YmkiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90dWJpdHYuY29tIiB9LAogIHBsdXRvX3R2OiB7IHJlZ2V4OiAvcGx1dG8gdHYvaSwgbmFtZTogIlBsdXRvIFRWIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGx1dG8udHYiIH0sCiAgcGxleDogeyByZWdleDogL3BsZXgvaSwgbmFtZTogIlBsZXgiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9wbGV4LnR2IiB9LAogIGN1cmlvc2l0eV9zdHJlYW06IHsgcmVnZXg6IC9jdXJpb3NpdHlzdHJlYW0vaSwgbmFtZTogIkN1cmlvc2l0eVN0cmVhbSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2N1cmlvc2l0eXN0cmVhbS5jb20iIH0sCiAgbmVidWxhOiB7IHJlZ2V4OiAvbmVidWxhL2ksIG5hbWU6ICJOZWJ1bGEiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uZWJ1bGEuYXBwIiB9LAogIGZsb2F0cGxhbmU6IHsgcmVnZXg6IC9mbG9hdHBsYW5lL2ksIG5hbWU6ICJGbG9hdHBsYW5lIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZmxvYXRwbGFuZS5jb20iIH0sCiAgbXViaTogeyByZWdleDogL211YmkvaSwgbmFtZTogIk1VQkkiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9tdWJpLmNvbSIgfSwKICBjcml0ZXJpb246IHsgcmVnZXg6IC9jcml0ZXJpb24gY2hhbm5lbC9pLCBuYW1lOiAiQ3JpdGVyaW9uIENoYW5uZWwiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jcml0ZXJpb25jaGFubmVsLmNvbSIgfSwKICBzaHVkZGVyOiB7IHJlZ2V4OiAvc2h1ZGRlci9pLCBuYW1lOiAiU2h1ZGRlciIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3NodWRkZXIuY29tIiB9LAogIGFtY19wbHVzOiB7IHJlZ2V4OiAvYW1jXCsvaSwgbmFtZTogIkFNQysiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hbWNwbHVzLmNvbSIgfSwKICBiZXRfcGx1czogeyByZWdleDogL2JldFwrL2ksIG5hbWU6ICJCRVQrIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYmV0LnBsdXMiIH0sCiAgYWxsYmxrOiB7IHJlZ2V4OiAvYWxsYmxrL2ksIG5hbWU6ICJBTExCTEsiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hbGxibGsudHYiIH0sCiAgaG9vcGxhOiB7IHJlZ2V4OiAvaG9vcGxhL2ksIG5hbWU6ICJIb29wbGEiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ob29wbGFkaWdpdGFsLmNvbSIgfSwKICBrYW5vcHk6IHsgcmVnZXg6IC9rYW5vcHkvaSwgbmFtZTogIkthbm9weSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2thbm9weS5jb20iIH0sCiAgcmVkYm94OiB7IHJlZ2V4OiAvcmVkYm94L2ksIG5hbWU6ICJSZWRib3giLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9yZWRib3guY29tIiB9LAogIHZ1ZHU6IHsgcmVnZXg6IC92dWR1L2ksIG5hbWU6ICJWdWR1IiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdnVkdS5jb20iIH0sCiAgZ29vZ2xlX3BsYXlfbW92aWVzOiB7IHJlZ2V4OiAvZ29vZ2xlIHBsYXkgbW92aWVzL2ksIG5hbWU6ICJHb29nbGUgUGxheSBNb3ZpZXMiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9wbGF5Lmdvb2dsZS5jb20iIH0sCiAgLy8gPT09IE1VU0lDICYgQVVESU8gPT09CiAgc3BvdGlmeTogeyByZWdleDogL3Nwb3RpZnkvaSwgbmFtZTogIlNwb3RpZnkiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3BvdGlmeS5jb20iIH0sCiAgYXBwbGVfbXVzaWM6IHsgcmVnZXg6IC9hcHBsZVwuY29tXC9iaWxsfGFwcGxlIG11c2ljL2ksIG5hbWU6ICJBcHBsZSBNdXNpYyIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9tdXNpYy5hcHBsZS5jb20iIH0sCiAgYW1hem9uX211c2ljOiB7IHJlZ2V4OiAvYW1hem9uIG11c2ljfGFtem4gbXVzaWMvaSwgbmFtZTogIkFtYXpvbiBNdXNpYyIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9tdXNpYy5hbWF6b24uY29tIiB9LAogIHBhbmRvcmE6IHsgcmVnZXg6IC9wYW5kb3JhL2ksIG5hbWU6ICJQYW5kb3JhIiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BhbmRvcmEuY29tIiB9LAogIHRpZGFsOiB7IHJlZ2V4OiAvdGlkYWwvaSwgbmFtZTogIlRpZGFsIiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3RpZGFsLmNvbSIgfSwKICBzb3VuZGNsb3VkOiB7IHJlZ2V4OiAvc291bmRjbG91ZC9pLCBuYW1lOiAiU291bmRDbG91ZCIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zb3VuZGNsb3VkLmNvbSIgfSwKICBkZWV6ZXI6IHsgcmVnZXg6IC9kZWV6ZXIvaSwgbmFtZTogIkRlZXplciIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kZWV6ZXIuY29tIiB9LAogIHNpcml1c3htOiB7IHJlZ2V4OiAvc2lyaXVzeG18c3htL2ksIG5hbWU6ICJTaXJpdXNYTSIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zaXJpdXN4bS5jb20iIH0sCiAgYXVkaWJsZTogeyByZWdleDogL2F1ZGlibGUvaSwgbmFtZTogIkF1ZGlibGUiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYXVkaWJsZS5jb20iIH0sCiAgaWhlYXJ0cmFkaW86IHsgcmVnZXg6IC9paGVhcnRyYWRpby9pLCBuYW1lOiAiaUhlYXJ0UmFkaW8iLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaWhlYXJ0LmNvbSIgfSwKICB0dW5laW46IHsgcmVnZXg6IC90dW5laW4vaSwgbmFtZTogIlR1bmVJbiIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90dW5laW4uY29tIiB9LAogIHFvYnV6OiB7IHJlZ2V4OiAvcW9idXovaSwgbmFtZTogIlFvYnV6IiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3FvYnV6LmNvbSIgfSwKICBuYXBzdGVyOiB7IHJlZ2V4OiAvbmFwc3Rlci9pLCBuYW1lOiAiTmFwc3RlciIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uYXBzdGVyLmNvbSIgfSwKICBiYW5kY2FtcDogeyByZWdleDogL2JhbmRjYW1wL2ksIG5hbWU6ICJCYW5kY2FtcCIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9iYW5kY2FtcC5jb20iIH0sCiAgbGFzdGZtOiB7IHJlZ2V4OiAvbGFzdFwuZm0vaSwgbmFtZTogIkxhc3QuZm0iLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbGFzdC5mbSIgfSwKICBzcGxpY2U6IHsgcmVnZXg6IC9zcGxpY2UvaSwgbmFtZTogIlNwbGljZSIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zcGxpY2UuY29tIiB9LAogIGVwaWRlbWljX3NvdW5kOiB7IHJlZ2V4OiAvZXBpZGVtaWMgc291bmQvaSwgbmFtZTogIkVwaWRlbWljIFNvdW5kIiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2VwaWRlbWljc291bmQuY29tIiB9LAogIGFydGxpc3Q6IHsgcmVnZXg6IC9hcnRsaXN0L2ksIG5hbWU6ICJBcnRsaXN0IiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2FydGxpc3QuaW8iIH0sCiAgbXVzaWNiZWQ6IHsgcmVnZXg6IC9tdXNpY2JlZC9pLCBuYW1lOiAiTXVzaWNiZWQiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbXVzaWNiZWQuY29tIiB9LAogIC8vID09PSBHQU1JTkcgPT09CiAgeGJveF9nYW1lX3Bhc3M6IHsgcmVnZXg6IC9taWNyb3NvZnRcKnhib3h8eGJveCBnYW1lIHBhc3MvaSwgbmFtZTogIlhib3ggR2FtZSBQYXNzIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS94Ym94LmNvbSIgfSwKICBwbGF5c3RhdGlvbl9wbHVzOiB7IHJlZ2V4OiAvc29ueXxwbGF5c3RhdGlvbi9pLCBuYW1lOiAiUGxheVN0YXRpb24gUGx1cyIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGxheXN0YXRpb24uY29tIiB9LAogIG5pbnRlbmRvX29ubGluZTogeyByZWdleDogL25pbnRlbmRvL2ksIG5hbWU6ICJOaW50ZW5kbyBTd2l0Y2ggT25saW5lIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uaW50ZW5kby5jb20iIH0sCiAgc3RlYW06IHsgcmVnZXg6IC9zdGVhbSBnYW1lc3xzdGVhbXBvd2VyZWQvaSwgbmFtZTogIlN0ZWFtIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zdGVhbXBvd2VyZWQuY29tIiB9LAogIGVhX3BsYXk6IHsgcmVnZXg6IC9lYSBwbGF5fGVsZWN0cm9uaWMgYXJ0cy9pLCBuYW1lOiAiRUEgUGxheSIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZWEuY29tIiB9LAogIHViaXNvZnRfcGx1czogeyByZWdleDogL3ViaXNvZnQvaSwgbmFtZTogIlViaXNvZnQrIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS91Ymlzb2Z0LmNvbSIgfSwKICByb2Jsb3g6IHsgcmVnZXg6IC9yb2Jsb3gvaSwgbmFtZTogIlJvYmxveCBQcmVtaXVtIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9yb2Jsb3guY29tIiB9LAogIHR3aXRjaDogeyByZWdleDogL3R3aXRjaC9pLCBuYW1lOiAiVHdpdGNoIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90d2l0Y2gudHYiIH0sCiAgZGlzY29yZF9uaXRybzogeyByZWdleDogL2Rpc2NvcmQvaSwgbmFtZTogIkRpc2NvcmQgTml0cm8iLCBjYXRlZ29yeTogIkdhbWluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Rpc2NvcmQuY29tIiB9LAogIGh1bWJsZV9idW5kbGU6IHsgcmVnZXg6IC9odW1ibGUgYnVuZGxlL2ksIG5hbWU6ICJIdW1ibGUgQnVuZGxlIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9odW1ibGVidW5kbGUuY29tIiB9LAogIGdlZm9yY2Vfbm93OiB7IHJlZ2V4OiAvbnZpZGlhfGdlZm9yY2UvaSwgbmFtZTogIkdlRm9yY2UgTm93IiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9udmlkaWEuY29tIiB9LAogIGFwcGxlX2FyY2FkZTogeyByZWdleDogL2FwcGxlXC5jb21cL2JpbGx8YXBwbGUgYXJjYWRlL2ksIG5hbWU6ICJBcHBsZSBBcmNhZGUiLCBjYXRlZ29yeTogIkdhbWluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2FwcGxlLmNvbSIgfSwKICBnb29nbGVfcGxheV9wYXNzOiB7IHJlZ2V4OiAvZ29vZ2xlIHBsYXkgcGFzcy9pLCBuYW1lOiAiR29vZ2xlIFBsYXkgUGFzcyIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGxheS5nb29nbGUuY29tIiB9LAogIG1pbmVjcmFmdF9yZWFsbXM6IHsgcmVnZXg6IC9tb2phbmd8bWluZWNyYWZ0L2ksIG5hbWU6ICJNaW5lY3JhZnQgUmVhbG1zIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9taW5lY3JhZnQubmV0IiB9LAogIGZvcnRuaXRlX2NyZXc6IHsgcmVnZXg6IC9lcGljIGdhbWVzfGZvcnRuaXRlL2ksIG5hbWU6ICJGb3J0bml0ZSBDcmV3IiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9mb3J0bml0ZS5jb20iIH0sCiAgLy8gPT09IFNPRlRXQVJFICYgU0FBUyA9PT0KICBhZG9iZV9jYzogeyByZWdleDogL2Fkb2JlfGNyZWF0aXZlIGNsb3VkL2ksIG5hbWU6ICJBZG9iZSBDcmVhdGl2ZSBDbG91ZCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hZG9iZS5jb20iIH0sCiAgbWljcm9zb2Z0XzM2NTogeyByZWdleDogL21pY3Jvc29mdFwqMzY1fG1zZnQgXCozNjUvaSwgbmFtZTogIk1pY3Jvc29mdCAzNjUiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vb2ZmaWNlLmNvbSIgfSwKICBnb29nbGVfd29ya3NwYWNlOiB7IHJlZ2V4OiAvZ29vZ2xlIFwqZ3N1aXRlfGdvb2dsZSBcKndvcmtzcGFjZS9pLCBuYW1lOiAiR29vZ2xlIFdvcmtzcGFjZSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS93b3Jrc3BhY2UuZ29vZ2xlLmNvbSIgfSwKICBkcm9wYm94OiB7IHJlZ2V4OiAvZHJvcGJveC9pLCBuYW1lOiAiRHJvcGJveCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kcm9wYm94LmNvbSIgfSwKICB6b29tOiB7IHJlZ2V4OiAvem9vbVwudXMvaSwgbmFtZTogIlpvb20iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vem9vbS51cyIgfSwKICBzbGFjazogeyByZWdleDogL3NsYWNrL2ksIG5hbWU6ICJTbGFjayIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zbGFjay5jb20iIH0sCiAgbm90aW9uOiB7IHJlZ2V4OiAvbm90aW9uL2ksIG5hbWU6ICJOb3Rpb24iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbm90aW9uLnNvIiB9LAogIGV2ZXJub3RlOiB7IHJlZ2V4OiAvZXZlcm5vdGUvaSwgbmFtZTogIkV2ZXJub3RlIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2V2ZXJub3RlLmNvbSIgfSwKICB0cmVsbG86IHsgcmVnZXg6IC90cmVsbG8vaSwgbmFtZTogIlRyZWxsbyIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90cmVsbG8uY29tIiB9LAogIGFzYW5hOiB7IHJlZ2V4OiAvYXNhbmEvaSwgbmFtZTogIkFzYW5hIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2FzYW5hLmNvbSIgfSwKICBtb25kYXlfY29tOiB7IHJlZ2V4OiAvbW9uZGF5XC5jb20vaSwgbmFtZTogIk1vbmRheS5jb20iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbW9uZGF5LmNvbSIgfSwKICBjbGlja3VwOiB7IHJlZ2V4OiAvY2xpY2t1cC9pLCBuYW1lOiAiQ2xpY2tVcCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jbGlja3VwLmNvbSIgfSwKICBhaXJ0YWJsZTogeyByZWdleDogL2FpcnRhYmxlL2ksIG5hbWU6ICJBaXJ0YWJsZSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9haXJ0YWJsZS5jb20iIH0sCiAgZmlnbWE6IHsgcmVnZXg6IC9maWdtYS9pLCBuYW1lOiAiRmlnbWEiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZmlnbWEuY29tIiB9LAogIGNhbnZhOiB7IHJlZ2V4OiAvY2FudmEvaSwgbmFtZTogIkNhbnZhIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NhbnZhLmNvbSIgfSwKICBnaXRodWI6IHsgcmVnZXg6IC9naXRodWIvaSwgbmFtZTogIkdpdEh1YiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9naXRodWIuY29tIiB9LAogIGdpdGxhYjogeyByZWdleDogL2dpdGxhYi9pLCBuYW1lOiAiR2l0TGFiIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2dpdGxhYi5jb20iIH0sCiAgaGVyb2t1OiB7IHJlZ2V4OiAvaGVyb2t1L2ksIG5hbWU6ICJIZXJva3UiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaGVyb2t1LmNvbSIgfSwKICBkaWdpdGFsb2NlYW46IHsgcmVnZXg6IC9kaWdpdGFsb2NlYW4vaSwgbmFtZTogIkRpZ2l0YWxPY2VhbiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kaWdpdGFsb2NlYW4uY29tIiB9LAogIGF3czogeyByZWdleDogL2F3c3xhbWF6b24gd2ViIHNlcnZpY2VzL2ksIG5hbWU6ICJBV1MiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYXdzLmFtYXpvbi5jb20iIH0sCiAgdmVyY2VsOiB7IHJlZ2V4OiAvdmVyY2VsL2ksIG5hbWU6ICJWZXJjZWwiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdmVyY2VsLmNvbSIgfSwKICBuZXRsaWZ5OiB7IHJlZ2V4OiAvbmV0bGlmeS9pLCBuYW1lOiAiTmV0bGlmeSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uZXRsaWZ5LmNvbSIgfSwKICB3ZWJmbG93OiB7IHJlZ2V4OiAvd2ViZmxvdy9pLCBuYW1lOiAiV2ViZmxvdyIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS93ZWJmbG93LmNvbSIgfSwKICBzcXVhcmVzcGFjZTogeyByZWdleDogL3NxdWFyZXNwYWNlL2ksIG5hbWU6ICJTcXVhcmVzcGFjZSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zcXVhcmVzcGFjZS5jb20iIH0sCiAgd2l4OiB7IHJlZ2V4OiAvd2l4XC5jb20vaSwgbmFtZTogIldpeCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS93aXguY29tIiB9LAogIHdvcmRwcmVzczogeyByZWdleDogL3dvcmRwcmVzcy9pLCBuYW1lOiAiV29yZFByZXNzIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3dvcmRwcmVzcy5jb20iIH0sCiAgYmx1ZWhvc3Q6IHsgcmVnZXg6IC9ibHVlaG9zdC9pLCBuYW1lOiAiQmx1ZWhvc3QiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYmx1ZWhvc3QuY29tIiB9LAogIGNoYXRncHQ6IHsgcmVnZXg6IC9vcGVuYWl8Y2hhdGdwdC9pLCBuYW1lOiAiQ2hhdEdQVCBQbHVzIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL29wZW5haS5jb20iIH0sCiAgbWlkam91cm5leTogeyByZWdleDogL21pZGpvdXJuZXkvaSwgbmFtZTogIk1pZGpvdXJuZXkiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWlkam91cm5leS5jb20iIH0sCiAgamFzcGVyOiB7IHJlZ2V4OiAvamFzcGVyXC5haS9pLCBuYW1lOiAiSmFzcGVyIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2phc3Blci5haSIgfSwKICBjb3B5X2FpOiB7IHJlZ2V4OiAvY29weVwuYWkvaSwgbmFtZTogIkNvcHkuYWkiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY29weS5haSIgfSwKICBncmFtbWFybHk6IHsgcmVnZXg6IC9ncmFtbWFybHkvaSwgbmFtZTogIkdyYW1tYXJseSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ncmFtbWFybHkuY29tIiB9LAogIGxhc3RwYXNzOiB7IHJlZ2V4OiAvbGFzdHBhc3MvaSwgbmFtZTogIkxhc3RQYXNzIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2xhc3RwYXNzLmNvbSIgfSwKICBvbmVwYXNzd29yZDogeyByZWdleDogLzFwYXNzd29yZC9pLCBuYW1lOiAiMVBhc3N3b3JkIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tLzFwYXNzd29yZC5jb20iIH0sCiAgZGFzaGxhbmU6IHsgcmVnZXg6IC9kYXNobGFuZS9pLCBuYW1lOiAiRGFzaGxhbmUiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZGFzaGxhbmUuY29tIiB9LAogIG5vcmR2cG46IHsgcmVnZXg6IC9ub3JkdnBuL2ksIG5hbWU6ICJOb3JkVlBOIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL25vcmR2cG4uY29tIiB9LAogIGV4cHJlc3N2cG46IHsgcmVnZXg6IC9leHByZXNzdnBuL2ksIG5hbWU6ICJFeHByZXNzVlBOIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2V4cHJlc3N2cG4uY29tIiB9LAogIHN1cmZzaGFyazogeyByZWdleDogL3N1cmZzaGFyay9pLCBuYW1lOiAiU3VyZnNoYXJrIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3N1cmZzaGFyay5jb20iIH0sCiAgcHJvdG9uOiB7IHJlZ2V4OiAvcHJvdG9uIG1haWx8cHJvdG9udnBuL2ksIG5hbWU6ICJQcm90b24iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcHJvdG9uLm1lIiB9LAogIGFkb2JlX2Fjcm9iYXQ6IHsgcmVnZXg6IC9hY3JvYmF0L2ksIG5hbWU6ICJBZG9iZSBBY3JvYmF0IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Fkb2JlLmNvbSIgfSwKICBkb2N1c2lnbjogeyByZWdleDogL2RvY3VzaWduL2ksIG5hbWU6ICJEb2N1U2lnbiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kb2N1c2lnbi5jb20iIH0sCiAgbGlua2VkaW5fcHJlbWl1bTogeyByZWdleDogL2xpbmtlZGluL2ksIG5hbWU6ICJMaW5rZWRJbiBQcmVtaXVtIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2xpbmtlZGluLmNvbSIgfSwKICB0d2l0dGVyX2JsdWU6IHsgcmVnZXg6IC90d2l0dGVyIGJsdWV8eCBwcmVtaXVtL2ksIG5hbWU6ICJYIFByZW1pdW0iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdHdpdHRlci5jb20iIH0sCiAgbWVkaXVtOiB7IHJlZ2V4OiAvbWVkaXVtL2ksIG5hbWU6ICJNZWRpdW0gTWVtYmVyc2hpcCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9tZWRpdW0uY29tIiB9LAogIC8vID09PSBTSE9QUElORyAmIERFTElWRVJZID09PQogIGFtYXpvbl9wcmltZTogeyByZWdleDogL2Ftem4gcHJpbWV8YW1hem9uIHByaW1lL2ksIG5hbWU6ICJBbWF6b24gUHJpbWUiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYW1hem9uLmNvbSIgfSwKICB3YWxtYXJ0X3BsdXM6IHsgcmVnZXg6IC93YWxtYXJ0XCsvaSwgbmFtZTogIldhbG1hcnQrIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3dhbG1hcnQuY29tIiB9LAogIGluc3RhY2FydDogeyByZWdleDogL2luc3RhY2FydC9pLCBuYW1lOiAiSW5zdGFjYXJ0KyIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9pbnN0YWNhcnQuY29tIiB9LAogIHNoaXB0OiB7IHJlZ2V4OiAvc2hpcHQvaSwgbmFtZTogIlNoaXB0IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3NoaXB0LmNvbSIgfSwKICBkb29yZGFzaDogeyByZWdleDogL2Rvb3JkYXNofGRhc2hwYXNzL2ksIG5hbWU6ICJEYXNoUGFzcyIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kb29yZGFzaC5jb20iIH0sCiAgdWJlcl9lYXRzOiB7IHJlZ2V4OiAvdWJlciBwYXNzfHViZXIgb25lL2ksIG5hbWU6ICJVYmVyIE9uZSIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS91YmVyLmNvbSIgfSwKICBncnViaHViOiB7IHJlZ2V4OiAvZ3J1Ymh1Yi9pLCBuYW1lOiAiR3J1Ymh1YisiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZ3J1Ymh1Yi5jb20iIH0sCiAgcG9zdG1hdGVzOiB7IHJlZ2V4OiAvcG9zdG1hdGVzL2ksIG5hbWU6ICJQb3N0bWF0ZXMgVW5saW1pdGVkIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Bvc3RtYXRlcy5jb20iIH0sCiAgY29zdGNvOiB7IHJlZ2V4OiAvY29zdGNvL2ksIG5hbWU6ICJDb3N0Y28gTWVtYmVyc2hpcCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jb3N0Y28uY29tIiB9LAogIHNhbXNfY2x1YjogeyByZWdleDogL3NhbXMgY2x1Yi9pLCBuYW1lOiAiU2FtJ3MgQ2x1YiIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zYW1zY2x1Yi5jb20iIH0sCiAgYmpfd2hvbGVzYWxlOiB7IHJlZ2V4OiAvYmpzIHdob2xlc2FsZS9pLCBuYW1lOiAiQkoncyBXaG9sZXNhbGUiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYmpzLmNvbSIgfSwKICB0aHJpdmVfbWFya2V0OiB7IHJlZ2V4OiAvdGhyaXZlIG1hcmtldC9pLCBuYW1lOiAiVGhyaXZlIE1hcmtldCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90aHJpdmVtYXJrZXQuY29tIiB9LAogIGNoZXd5OiB7IHJlZ2V4OiAvY2hld3kvaSwgbmFtZTogIkNoZXd5IEF1dG9zaGlwIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NoZXd5LmNvbSIgfSwKICBzdGl0Y2hfZml4OiB7IHJlZ2V4OiAvc3RpdGNoIGZpeC9pLCBuYW1lOiAiU3RpdGNoIEZpeCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zdGl0Y2hmaXguY29tIiB9LAogIHJlbnRfdGhlX3J1bndheTogeyByZWdleDogL3JlbnQgdGhlIHJ1bndheS9pLCBuYW1lOiAiUmVudCB0aGUgUnVud2F5IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3JlbnR0aGVydW53YXkuY29tIiB9LAogIGZhYmxldGljczogeyByZWdleDogL2ZhYmxldGljcy9pLCBuYW1lOiAiRmFibGV0aWNzIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2ZhYmxldGljcy5jb20iIH0sCiAgc2F2YWdlX3hfZmVudHk6IHsgcmVnZXg6IC9zYXZhZ2UgeCBmZW50eS9pLCBuYW1lOiAiU2F2YWdlIFggRmVudHkiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc2F2YWdleC5jb20iIH0sCiAgZG9sbGFyX3NoYXZlX2NsdWI6IHsgcmVnZXg6IC9kb2xsYXIgc2hhdmUvaSwgbmFtZTogIkRvbGxhciBTaGF2ZSBDbHViIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2RvbGxhcnNoYXZlY2x1Yi5jb20iIH0sCiAgaGFycnlfczogeyByZWdleDogL2hhcnJ5cy9pLCBuYW1lOiAiSGFycnkncyIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9oYXJyeXMuY29tIiB9LAogIHF1aXA6IHsgcmVnZXg6IC9nZXRxdWlwfHF1aXAvaSwgbmFtZTogIlF1aXAiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZ2V0cXVpcC5jb20iIH0sCiAgLy8gPT09IFNVQlNDUklQVElPTiBCT1hFUyA9PT0KICBoZWxsb2ZyZXNoOiB7IHJlZ2V4OiAvaGVsbG9mcmVzaC9pLCBuYW1lOiAiSGVsbG9GcmVzaCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9oZWxsb2ZyZXNoLmNvbSIgfSwKICBibHVlX2Fwcm9uOiB7IHJlZ2V4OiAvYmx1ZSBhcHJvbi9pLCBuYW1lOiAiQmx1ZSBBcHJvbiIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ibHVlYXByb24uY29tIiB9LAogIGhvbWVfY2hlZjogeyByZWdleDogL2hvbWUgY2hlZi9pLCBuYW1lOiAiSG9tZSBDaGVmIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2hvbWVjaGVmLmNvbSIgfSwKICBzdW5fYmFza2V0OiB7IHJlZ2V4OiAvc3VuIGJhc2tldC9pLCBuYW1lOiAiU3VuIEJhc2tldCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zdW5iYXNrZXQuY29tIiB9LAogIGRhaWx5X2hhcnZlc3Q6IHsgcmVnZXg6IC9kYWlseSBoYXJ2ZXN0L2ksIG5hbWU6ICJEYWlseSBIYXJ2ZXN0IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2RhaWx5LWhhcnZlc3QuY29tIiB9LAogIGZyZXNobHk6IHsgcmVnZXg6IC9mcmVzaGx5L2ksIG5hbWU6ICJGcmVzaGx5IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2ZyZXNobHkuY29tIiB9LAogIGZhY3Rvcl9tZWFsczogeyByZWdleDogL2ZhY3Rvcjc1fGZhY3RvciBtZWFscy9pLCBuYW1lOiAiRmFjdG9yXyIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9mYWN0b3I3NS5jb20iIH0sCiAgYnV0Y2hlcl9ib3g6IHsgcmVnZXg6IC9idXRjaGVyYm94L2ksIG5hbWU6ICJCdXRjaGVyQm94IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2J1dGNoZXJib3guY29tIiB9LAogIGJhcmtib3g6IHsgcmVnZXg6IC9iYXJrYm94L2ksIG5hbWU6ICJCYXJrQm94IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Jhcmtib3guY29tIiB9LAogIGlwc3k6IHsgcmVnZXg6IC9pcHN5L2ksIG5hbWU6ICJJcHN5IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2lwc3kuY29tIiB9LAogIGJpcmNoYm94OiB7IHJlZ2V4OiAvYmlyY2hib3gvaSwgbmFtZTogIkJpcmNoYm94IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2JpcmNoYm94LmNvbSIgfSwKICBmYWJmaXRmdW46IHsgcmVnZXg6IC9mYWJmaXRmdW4vaSwgbmFtZTogIkZhYkZpdEZ1biIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9mYWJmaXRmdW4uY29tIiB9LAogIGFsbHVyZV9iZWF1dHk6IHsgcmVnZXg6IC9hbGx1cmUgYmVhdXR5L2ksIG5hbWU6ICJBbGx1cmUgQmVhdXR5IEJveCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hbGx1cmUuY29tIiB9LAogIHNjZW50YmlyZDogeyByZWdleDogL3NjZW50YmlyZC9pLCBuYW1lOiAiU2NlbnRiaXJkIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3NjZW50YmlyZC5jb20iIH0sCiAgYm9va19vZl90aGVfbW9udGg6IHsgcmVnZXg6IC9ib29rIG9mIHRoZSBtb250aC9pLCBuYW1lOiAiQm9vayBvZiB0aGUgTW9udGgiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYm9va29mdGhlbW9udGguY29tIiB9LAogIGxvb3RfY3JhdGU6IHsgcmVnZXg6IC9sb290IGNyYXRlL2ksIG5hbWU6ICJMb290IENyYXRlIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2xvb3RjcmF0ZS5jb20iIH0sCiAgYmVzcG9rZV9wb3N0OiB7IHJlZ2V4OiAvYmVzcG9rZSBwb3N0L2ksIG5hbWU6ICJCZXNwb2tlIFBvc3QiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYmVzcG9rZXBvc3QuY29tIiB9LAogIGtpd2ljbzogeyByZWdleDogL2tpd2ljby9pLCBuYW1lOiAiS2l3aUNvIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2tpd2ljby5jb20iIH0sCiAgLy8gPT09IEhFQUxUSCAmIEZJVE5FU1MgPT09CiAgcGxhbmV0X2ZpdG5lc3M6IHsgcmVnZXg6IC9wbGFuZXQgZml0L2ksIG5hbWU6ICJQbGFuZXQgRml0bmVzcyIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGxhbmV0Zml0bmVzcy5jb20iIH0sCiAgZ29sZF9zX2d5bTogeyByZWdleDogL2dvbGQnP3MgZ3ltL2ksIG5hbWU6ICJHb2xkJ3MgR3ltIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9nb2xkc2d5bS5jb20iIH0sCiAgbGFfZml0bmVzczogeyByZWdleDogL2xhIGZpdG5lc3MvaSwgbmFtZTogIkxBIEZpdG5lc3MiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2xhZml0bmVzcy5jb20iIH0sCiAgYW55dGltZV9maXRuZXNzOiB7IHJlZ2V4OiAvYW55dGltZSBmaXRuZXNzL2ksIG5hbWU6ICJBbnl0aW1lIEZpdG5lc3MiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2FueXRpbWVmaXRuZXNzLmNvbSIgfSwKICBjcnVuY2hfZml0bmVzczogeyByZWdleDogL2NydW5jaCBmaXRuZXNzL2ksIG5hbWU6ICJDcnVuY2ggRml0bmVzcyIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY3J1bmNoLmNvbSIgfSwKICBlcXVpbm94OiB7IHJlZ2V4OiAvZXF1aW5veC9pLCBuYW1lOiAiRXF1aW5veCIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZXF1aW5veC5jb20iIH0sCiAgbGlmZXRpbWVfZml0bmVzczogeyByZWdleDogL2xpZmV0aW1lIGZpdC9pLCBuYW1lOiAiTGlmZSBUaW1lIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9saWZldGltZS5saWZlIiB9LAogIG9yYW5nZV90aGVvcnk6IHsgcmVnZXg6IC9vcmFuZ2V0aGVvcnkvaSwgbmFtZTogIk9yYW5nZXRoZW9yeSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vb3JhbmdldGhlb3J5LmNvbSIgfSwKICBzb3VsY3ljbGU6IHsgcmVnZXg6IC9zb3VsY3ljbGUvaSwgbmFtZTogIlNvdWxDeWNsZSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc291bC1jeWNsZS5jb20iIH0sCiAgcGVsb3RvbjogeyByZWdleDogL3BlbG90b24vaSwgbmFtZTogIlBlbG90b24iLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL29uZXBlbG90b24uY29tIiB9LAogIHRvbmFsOiB7IHJlZ2V4OiAvdG9uYWwvaSwgbmFtZTogIlRvbmFsIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90b25hbC5jb20iIH0sCiAgbWlycm9yOiB7IHJlZ2V4OiAvbWlycm9yL2ksIG5hbWU6ICJNaXJyb3IiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21pcnJvci5jbyIgfSwKICBmaXRiaXQ6IHsgcmVnZXg6IC9maXRiaXQvaSwgbmFtZTogIkZpdGJpdCBQcmVtaXVtIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9maXRiaXQuY29tIiB9LAogIHdob29wOiB7IHJlZ2V4OiAvd2hvb3AvaSwgbmFtZTogIldIT09QIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS93aG9vcC5jb20iIH0sCiAgb3VyYV9yaW5nOiB7IHJlZ2V4OiAvb3VyYSByaW5nL2ksIG5hbWU6ICJPdXJhIFJpbmciLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL291cmFyaW5nLmNvbSIgfSwKICBhcHBfZml0bmVzc19wYWw6IHsgcmVnZXg6IC9teWZpdG5lc3NwYWwvaSwgbmFtZTogIk15Rml0bmVzc1BhbCIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbXlmaXRuZXNzcGFsLmNvbSIgfSwKICBzdHJhdmE6IHsgcmVnZXg6IC9zdHJhdmEvaSwgbmFtZTogIlN0cmF2YSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3RyYXZhLmNvbSIgfSwKICBjYWxtOiB7IHJlZ2V4OiAvY2FsbVwuY29tL2ksIG5hbWU6ICJDYWxtIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jYWxtLmNvbSIgfSwKICBoZWFkc3BhY2U6IHsgcmVnZXg6IC9oZWFkc3BhY2UvaSwgbmFtZTogIkhlYWRzcGFjZSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaGVhZHNwYWNlLmNvbSIgfSwKICBub29tOiB7IHJlZ2V4OiAvbm9vbS9pLCBuYW1lOiAiTm9vbSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbm9vbS5jb20iIH0sCiAgd2VpZ2h0X3dhdGNoZXJzOiB7IHJlZ2V4OiAvd3cgaW50ZXJuYXRpb25hbHx3ZWlnaHQgd2F0Y2hlcnMvaSwgbmFtZTogIldlaWdodFdhdGNoZXJzIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS93ZWlnaHR3YXRjaGVycy5jb20iIH0sCiAgYmV0dGVyaGVscDogeyByZWdleDogL2JldHRlcmhlbHAvaSwgbmFtZTogIkJldHRlckhlbHAiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2JldHRlcmhlbHAuY29tIiB9LAogIHRhbGtzcGFjZTogeyByZWdleDogL3RhbGtzcGFjZS9pLCBuYW1lOiAiVGFsa3NwYWNlIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90YWxrc3BhY2UuY29tIiB9LAogIHJ1bWJsZV9ib3hpbmc6IHsgcmVnZXg6IC9ydW1ibGUgYm94aW5nL2ksIG5hbWU6ICJSdW1ibGUiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3J1bWJsZWJveGluZ2d5bS5jb20iIH0sCiAgY3ljbGViYXI6IHsgcmVnZXg6IC9jeWNsZWJhci9pLCBuYW1lOiAiQ3ljbGVCYXIiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2N5Y2xlYmFyLmNvbSIgfSwKICBwdXJlX2JhcnJlOiB7IHJlZ2V4OiAvcHVyZSBiYXJyZS9pLCBuYW1lOiAiUHVyZSBCYXJyZSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcHVyZWJhcnJlLmNvbSIgfSwKICBjbHViX3BpbGF0ZXM6IHsgcmVnZXg6IC9jbHViIHBpbGF0ZXMvaSwgbmFtZTogIkNsdWIgUGlsYXRlcyIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY2x1YnBpbGF0ZXMuY29tIiB9LAogIC8vID09PSBORVdTICYgTUFHQVpJTkVTID09PQogIG55dGltZXM6IHsgcmVnZXg6IC9ueXRpbWVzfG5ldyB5b3JrIHRpbWVzL2ksIG5hbWU6ICJOWSBUaW1lcyIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL255dGltZXMuY29tIiB9LAogIHdhc2hpbmd0b25fcG9zdDogeyByZWdleDogL3dhc2hwb3N0fHdhc2hpbmd0b24gcG9zdC9pLCBuYW1lOiAiV2FzaGluZ3RvbiBQb3N0IiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd2FzaGluZ3RvbnBvc3QuY29tIiB9LAogIHdzajogeyByZWdleDogL3dzanx3YWxsIHN0cmVldCBqb3VybmFsL2ksIG5hbWU6ICJXYWxsIFN0cmVldCBKb3VybmFsIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd3NqLmNvbSIgfSwKICBlY29ub21pc3Q6IHsgcmVnZXg6IC9lY29ub21pc3QvaSwgbmFtZTogIlRoZSBFY29ub21pc3QiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9lY29ub21pc3QuY29tIiB9LAogIGJsb29tYmVyZzogeyByZWdleDogL2Jsb29tYmVyZy9pLCBuYW1lOiAiQmxvb21iZXJnIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYmxvb21iZXJnLmNvbSIgfSwKICBmaW5hbmNpYWxfdGltZXM6IHsgcmVnZXg6IC9maW5hbmNpYWwgdGltZXMvaSwgbmFtZTogIkZpbmFuY2lhbCBUaW1lcyIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Z0LmNvbSIgfSwKICB0aGVfYXRsYW50aWM6IHsgcmVnZXg6IC90aGUgYXRsYW50aWMvaSwgbmFtZTogIlRoZSBBdGxhbnRpYyIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3RoZWF0bGFudGljLmNvbSIgfSwKICBuZXdfeW9ya2VyOiB7IHJlZ2V4OiAvbmV3IHlvcmtlci9pLCBuYW1lOiAiVGhlIE5ldyBZb3JrZXIiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uZXd5b3JrZXIuY29tIiB9LAogIHdpcmVkOiB7IHJlZ2V4OiAvd2lyZWQvaSwgbmFtZTogIldpcmVkIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd2lyZWQuY29tIiB9LAogIG5hdGdlbzogeyByZWdleDogL25hdC4qZ2VvfG5hdGlvbmFsIGdlb2dyYXBoaWMvaSwgbmFtZTogIk5hdGlvbmFsIEdlb2dyYXBoaWMiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uYXRpb25hbGdlb2dyYXBoaWMuY29tIiB9LAogIHRpbWVfbWFnOiB7IHJlZ2V4OiAvdGltZSBtYWdhemluZS9pLCBuYW1lOiAiVElNRSIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3RpbWUuY29tIiB9LAogIGZvcmJlczogeyByZWdleDogL2ZvcmJlcy9pLCBuYW1lOiAiRm9yYmVzIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZm9yYmVzLmNvbSIgfSwKICBidXNpbmVzc19pbnNpZGVyOiB7IHJlZ2V4OiAvYnVzaW5lc3MgaW5zaWRlci9pLCBuYW1lOiAiQnVzaW5lc3MgSW5zaWRlciIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2J1c2luZXNzaW5zaWRlci5jb20iIH0sCiAgaGJyOiB7IHJlZ2V4OiAvaGFydmFyZCBidXNpbmVzcy9pLCBuYW1lOiAiSEJSIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaGJyLm9yZyIgfSwKICBzdWJzdGFjazogeyByZWdleDogL3N1YnN0YWNrL2ksIG5hbWU6ICJTdWJzdGFjayIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3N1YnN0YWNrLmNvbSIgfSwKICBtZWRpdW1fbWVtYmVyc2hpcDogeyByZWdleDogL21lZGl1bS9pLCBuYW1lOiAiTWVkaXVtIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWVkaXVtLmNvbSIgfSwKICBtb3JuaW5nX2JyZXc6IHsgcmVnZXg6IC9tb3JuaW5nIGJyZXcvaSwgbmFtZTogIk1vcm5pbmcgQnJldyIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21vcm5pbmdicmV3LmNvbSIgfSwKICBheGlvczogeyByZWdleDogL2F4aW9zL2ksIG5hbWU6ICJBeGlvcyIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2F4aW9zLmNvbSIgfSwKICB0aGVfZ3VhcmRpYW46IHsgcmVnZXg6IC9ndWFyZGlhbiBuZXdzL2ksIG5hbWU6ICJUaGUgR3VhcmRpYW4iLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90aGVndWFyZGlhbi5jb20iIH0sCiAgdXNhdG9kYXk6IHsgcmVnZXg6IC91c2EgdG9kYXkvaSwgbmFtZTogIlVTQSBUb2RheSIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3VzYXRvZGF5LmNvbSIgfSwKICAvLyA9PT0gREFUSU5HICYgU09DSUFMID09PQogIHRpbmRlcjogeyByZWdleDogL3RpbmRlci9pLCBuYW1lOiAiVGluZGVyIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3RpbmRlci5jb20iIH0sCiAgYnVtYmxlOiB7IHJlZ2V4OiAvYnVtYmxlL2ksIG5hbWU6ICJCdW1ibGUiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYnVtYmxlLmNvbSIgfSwKICBoaW5nZTogeyByZWdleDogL2hpbmdlL2ksIG5hbWU6ICJIaW5nZSIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9oaW5nZS5jbyIgfSwKICBtYXRjaF9jb206IHsgcmVnZXg6IC9tYXRjaFwuY29tL2ksIG5hbWU6ICJNYXRjaC5jb20iLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWF0Y2guY29tIiB9LAogIG9rY3VwaWQ6IHsgcmVnZXg6IC9va2N1cGlkL2ksIG5hbWU6ICJPa0N1cGlkIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL29rY3VwaWQuY29tIiB9LAogIGdyaW5kcjogeyByZWdleDogL2dyaW5kci9pLCBuYW1lOiAiR3JpbmRyIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2dyaW5kci5jb20iIH0sCiAgZWhhcm1vbnk6IHsgcmVnZXg6IC9laGFybW9ueS9pLCBuYW1lOiAiZUhhcm1vbnkiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZWhhcm1vbnkuY29tIiB9LAogIHBsZW50eV9vZl9maXNoOiB7IHJlZ2V4OiAvcG9mfHBsZW50eW9mZmlzaC9pLCBuYW1lOiAiUGxlbnR5IG9mIEZpc2giLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcG9mLmNvbSIgfSwKICByYXlhOiB7IHJlZ2V4OiAvcmF5YS9pLCBuYW1lOiAiUmF5YSIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiIiB9LAogIGNvZmZlZV9tZWV0c19iYWdlbDogeyByZWdleDogL2NvZmZlZSBtZWV0cyBiYWdlbC9pLCBuYW1lOiAiQ29mZmVlIE1lZXRzIEJhZ2VsIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NvZmZlZW1lZXRzYmFnZWwuY29tIiB9LAogIGJhZG9vOiB7IHJlZ2V4OiAvYmFkb28vaSwgbmFtZTogIkJhZG9vIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2JhZG9vLmNvbSIgfSwKICAvLyA9PT0gVVRJTElUSUVTICYgVEVMRUNPTSA9PT0KICB4ZmluaXR5OiB7IHJlZ2V4OiAvY29tY2FzdHx4ZmluaXR5L2ksIG5hbWU6ICJYZmluaXR5IiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS94ZmluaXR5LmNvbSIgfSwKICBhdHQ6IHsgcmVnZXg6IC9hdCZ0L2ksIG5hbWU6ICJBVCZUIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hdHQuY29tIiB9LAogIHZlcml6b246IHsgcmVnZXg6IC92ZXJpem9uL2ksIG5hbWU6ICJWZXJpem9uIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS92ZXJpem9uLmNvbSIgfSwKICB0X21vYmlsZTogeyByZWdleDogL3QtbW9iaWxlL2ksIG5hbWU6ICJULU1vYmlsZSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdC1tb2JpbGUuY29tIiB9LAogIHNwZWN0cnVtOiB7IHJlZ2V4OiAvc3BlY3RydW0vaSwgbmFtZTogIlNwZWN0cnVtIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zcGVjdHJ1bS5jb20iIH0sCiAgY294OiB7IHJlZ2V4OiAvY294IGNvbW0vaSwgbmFtZTogIkNveCIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY294LmNvbSIgfSwKICBvcHRpbXVtOiB7IHJlZ2V4OiAvb3B0aW11bS9pLCBuYW1lOiAiT3B0aW11bSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vb3B0aW11bS5uZXQiIH0sCiAgY2VudHVyeWxpbms6IHsgcmVnZXg6IC9jZW50dXJ5bGluay9pLCBuYW1lOiAiQ2VudHVyeUxpbmsiLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NlbnR1cnlsaW5rLmNvbSIgfSwKICBmcm9udGllcjogeyByZWdleDogL2Zyb250aWVyL2ksIG5hbWU6ICJGcm9udGllciIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZnJvbnRpZXIuY29tIiB9LAogIG1pbnRfbW9iaWxlOiB7IHJlZ2V4OiAvbWludCBtb2JpbGUvaSwgbmFtZTogIk1pbnQgTW9iaWxlIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9taW50bW9iaWxlLmNvbSIgfSwKICB2aXNpYmxlOiB7IHJlZ2V4OiAvdmlzaWJsZS9pLCBuYW1lOiAiVmlzaWJsZSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdmlzaWJsZS5jb20iIH0sCiAgY3JpY2tldF93aXJlbGVzczogeyByZWdleDogL2NyaWNrZXQvaSwgbmFtZTogIkNyaWNrZXQgV2lyZWxlc3MiLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NyaWNrZXR3aXJlbGVzcy5jb20iIH0sCiAgbWV0cm9fYnlfdG1vYmlsZTogeyByZWdleDogL21ldHJvcGNzfG1ldHJvIGJ5IHQtbW9iaWxlL2ksIG5hbWU6ICJNZXRybyBieSBULU1vYmlsZSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWV0cm9ieXQtbW9iaWxlLmNvbSIgfSwKICBib29zdF9tb2JpbGU6IHsgcmVnZXg6IC9ib29zdCBtb2JpbGUvaSwgbmFtZTogIkJvb3N0IE1vYmlsZSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYm9vc3Rtb2JpbGUuY29tIiB9LAogIGdvb2dsZV9maTogeyByZWdleDogL2dvb2dsZSBmaS9pLCBuYW1lOiAiR29vZ2xlIEZpIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9maS5nb29nbGUuY29tIiB9LAogIHN0YXJsaW5rOiB7IHJlZ2V4OiAvc3RhcmxpbmsvaSwgbmFtZTogIlN0YXJsaW5rIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zdGFybGluay5jb20iIH0sCiAgLy8gPT09IElOU1VSQU5DRSAmIEZJTkFOQ0UgPT09CiAgbGVtb25hZGU6IHsgcmVnZXg6IC9sZW1vbmFkZSBpbmMvaSwgbmFtZTogIkxlbW9uYWRlIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2xlbW9uYWRlLmNvbSIgfSwKICBnZWljbzogeyByZWdleDogL2dlaWNvL2ksIG5hbWU6ICJHRUlDTyIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9nZWljby5jb20iIH0sCiAgcHJvZ3Jlc3NpdmU6IHsgcmVnZXg6IC9wcm9ncmVzc2l2ZS9pLCBuYW1lOiAiUHJvZ3Jlc3NpdmUiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcHJvZ3Jlc3NpdmUuY29tIiB9LAogIHN0YXRlX2Zhcm06IHsgcmVnZXg6IC9zdGF0ZSBmYXJtL2ksIG5hbWU6ICJTdGF0ZSBGYXJtIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3N0YXRlZmFybS5jb20iIH0sCiAgYWxsc3RhdGU6IHsgcmVnZXg6IC9hbGxzdGF0ZS9pLCBuYW1lOiAiQWxsc3RhdGUiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYWxsc3RhdGUuY29tIiB9LAogIGxpYmVydHlfbXV0dWFsOiB7IHJlZ2V4OiAvbGliZXJ0eSBtdXR1YWwvaSwgbmFtZTogIkxpYmVydHkgTXV0dWFsIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2xpYmVydHltdXR1YWwuY29tIiB9LAogIHVzYWE6IHsgcmVnZXg6IC91c2FhL2ksIG5hbWU6ICJVU0FBIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3VzYWEuY29tIiB9LAogIGNoYXNlX3NhcHBoaXJlOiB7IHJlZ2V4OiAvY2hhc2Ugc2FwcGhpcmUvaSwgbmFtZTogIkNoYXNlIFNhcHBoaXJlIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NoYXNlLmNvbSIgfSwKICBhbWV4X3BsYXRpbnVtOiB7IHJlZ2V4OiAvYW1leCBwbGF0aW51bS9pLCBuYW1lOiAiQW1leCBQbGF0aW51bSIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hbWVyaWNhbmV4cHJlc3MuY29tIiB9LAogIHJvYmluaG9vZF9nb2xkOiB7IHJlZ2V4OiAvcm9iaW5ob29kL2ksIG5hbWU6ICJSb2Jpbmhvb2QgR29sZCIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9yb2Jpbmhvb2QuY29tIiB9LAogIGNvaW5iYXNlX29uZTogeyByZWdleDogL2NvaW5iYXNlL2ksIG5hbWU6ICJDb2luYmFzZSBPbmUiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY29pbmJhc2UuY29tIiB9LAogIGFjb3JuczogeyByZWdleDogL2Fjb3Jucy9pLCBuYW1lOiAiQWNvcm5zIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Fjb3Jucy5jb20iIH0sCiAgc3Rhc2g6IHsgcmVnZXg6IC9zdGFzaC9pLCBuYW1lOiAiU3Rhc2giLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3Rhc2guY29tIiB9LAogIFlOQUI6IHsgcmVnZXg6IC95bmFiL2ksIG5hbWU6ICJZTkFCIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3luYWIuY29tIiB9LAogIG1vbmFyY2hfbW9uZXk6IHsgcmVnZXg6IC9tb25hcmNoIG1vbmV5L2ksIG5hbWU6ICJNb25hcmNoIE1vbmV5IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21vbmFyY2htb25leS5jb20iIH0sCiAgY29waWxvdF9tb25leTogeyByZWdleDogL2NvcGlsb3QgbW9uZXkvaSwgbmFtZTogIkNvcGlsb3QiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY29waWxvdC5tb25leSIgfSwKICByb2NrZXRfbW9uZXk6IHsgcmVnZXg6IC9yb2NrZXQgbW9uZXkvaSwgbmFtZTogIlJvY2tldCBNb25leSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9yb2NrZXRtb25leS5jb20iIH0sCiAgY3JlZGl0X2thcm1hOiB7IHJlZ2V4OiAvY3JlZGl0IGthcm1hL2ksIG5hbWU6ICJDcmVkaXQgS2FybWEiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY3JlZGl0a2FybWEuY29tIiB9LAogIGxpZmVfbG9jazogeyByZWdleDogL2xpZmVsb2NrfG5vcnRvbi9pLCBuYW1lOiAiTm9ydG9uIExpZmVMb2NrIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL25vcnRvbi5jb20iIH0sCiAgZXhwZXJpYW46IHsgcmVnZXg6IC9leHBlcmlhbi9pLCBuYW1lOiAiRXhwZXJpYW4iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZXhwZXJpYW4uY29tIiB9LAogIGVxdWlmYXg6IHsgcmVnZXg6IC9lcXVpZmF4L2ksIG5hbWU6ICJFcXVpZmF4IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2VxdWlmYXguY29tIiB9LAogIHRyYW5zdW5pb246IHsgcmVnZXg6IC90cmFuc3VuaW9uL2ksIG5hbWU6ICJUcmFuc1VuaW9uIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3RyYW5zdW5pb24uY29tIiB9LAogIC8vID09PSBVU0VSIFJFUVVFU1RFRCAvIEFERElUSU9OQUwgPT09CiAgYXV0b3BpbG90OiB7IHJlZ2V4OiAvYXV0b3BpbG90L2ksIG5hbWU6ICJBdXRvcGlsb3QiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYXV0b3BpbG90aHEuY29tIiB9LAogIHBpcGVmbGFyZTogeyByZWdleDogL3BpcGVmbGFyZS9pLCBuYW1lOiAiUGlwZUZsYXJlIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BpcGVmbGFyZS5pbyIgfSwKICBpZnR0dDogeyByZWdleDogL2lmdHR0L2ksIG5hbWU6ICJJRlRUVCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9pZnR0dC5jb20iIH0sCiAgZWxhc3RpY19lbWFpbDogeyByZWdleDogL2VsYXN0aWNlbWFpbC9pLCBuYW1lOiAiRWxhc3RpYyBFbWFpbCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9lbGFzdGljZW1haWwuY29tIiB9LAogIGdlY2tvYm9hcmQ6IHsgcmVnZXg6IC9nZWNrb2JvYXJkL2ksIG5hbWU6ICJHZWNrb2JvYXJkIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2dlY2tvYm9hcmQuY29tIiB9LAogIGNvbnRhY3R1YWxseTogeyByZWdleDogL2NvbnRhY3R1YWxseS9pLCBuYW1lOiAiQ29udGFjdHVhbGx5IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NvbnRhY3R1YWxseS5jb20iIH0sCiAgdW5pdHk6IHsgcmVnZXg6IC91bml0eS9pLCBuYW1lOiAiVW5pdHkiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdW5pdHkuY29tIiB9LAogIGJpdGx5OiB7IHJlZ2V4OiAvYml0bHkvaSwgbmFtZTogIkJpdGx5IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2JpdGx5LmNvbSIgfSwKICBnb2RhZGR5OiB7IHJlZ2V4OiAvZ29kYWRkeS9pLCBuYW1lOiAiR29EYWRkeSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9nb2RhZGR5LmNvbSIgfSwKICBuYW1lY2hlYXA6IHsgcmVnZXg6IC9uYW1lLT9jaGVhcC9pLCBuYW1lOiAiTmFtZWNoZWFwIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL25hbWVjaGVhcC5jb20iIH0KfTsKCi8vIHNyYy9KdXN0Q2FuY2VsLnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgUERGX0pTX1ZFUlNJT04gPSAiNS40LjUzMCI7Ckdsb2JhbFdvcmtlck9wdGlvbnMud29ya2VyU3JjID0gYGh0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL3BkZi5qcy8ke1BERl9KU19WRVJTSU9OfS9wZGYud29ya2VyLm1pbi5tanNgOwp2YXIgQ09MT1JTID0gewogIHByaW1hcnk6ICIjNTZDNTk2IiwKICBwcmltYXJ5RGFyazogIiMzYWE4N2IiLAogIGJnOiAiI0ZBRkFGQSIsCiAgY2FyZDogIiNGRkZGRkYiLAogIHRleHRNYWluOiAiIzFBMUExQSIsCiAgdGV4dFNlY29uZGFyeTogIiM5Q0EzQUYiLAogIGJvcmRlcjogIiNGM0Y0RjYiLAogIGlucHV0Qmc6ICIjRjlGQUZCIiwKICBhY2NlbnRMaWdodDogIiNFNkY3RjAiLAogIGJsdWU6ICIjNUQ5Q0VDIiwKICB5ZWxsb3c6ICIjRjU5RTBCIiwKICByZWQ6ICIjRkY2QjZCIiwKICBvcmFuZ2U6ICIjRjI5OTRBIiwKICBvcmFuZ2VMaWdodDogIiNGRkY3RUQiLAogIHB1cnBsZTogIiM4QjVDRjYiLAogIGdvbGQ6ICIjRjU5RTBCIiwKICB0ZWFsOiAiIzE0QjhBNiIKfTsKdmFyIERFRkFVTFRfUFJPRklMRSA9IHsKICB1cGxvYWRlZEZpbGU6IG51bGwsCiAgZmlsZU5hbWU6IG51bGwsCiAgZmlsZVR5cGU6IG51bGwsCiAgbWFudWFsU3Vic2NyaXB0aW9uczogW10sCiAgdG90YWxNb250aGx5U3BlbmQ6IDAsCiAgdmlld0ZpbHRlcjogImFsbCIsCiAgaXNBbmFseXppbmc6IGZhbHNlLAogIGFuYWx5c2lzQ29tcGxldGU6IGZhbHNlCn07CnZhciBTQU1QTEVfUFJPRklMRSA9IHsKICAuLi5ERUZBVUxUX1BST0ZJTEUsCiAgbWFudWFsU3Vic2NyaXB0aW9uczogWwogICAgewogICAgICBpZDogInNhbXBsZS11bmtub3duIiwKICAgICAgc2VydmljZTogIlVua25vd24gVHJhbnNhY3Rpb24iLAogICAgICBtb250aGx5Q29zdDogMjQuOTksCiAgICAgIHN0YXR1czogInVua25vd24iLAogICAgICBjYXRlZ29yeTogIk90aGVyIiwKICAgICAgb3JpZ2luYWxEZXNjcmlwdGlvbjogIlBPUyBERUJJVCAtIDA0MjkgLSBSRUNVUlJJTkcgUEFZTUVOVCA4ODIxOSIKICAgIH0KICBdLAogIHRvdGFsTW9udGhseVNwZW5kOiAyNC45OSwKICBhbmFseXNpc0NvbXBsZXRlOiB0cnVlCn07CnZhciBTVE9SQUdFX0tFWSA9ICJKVVNUX0NBTkNFTF9EQVRBIjsKdmFyIFNVQlNDUklQVElPTl9DQVRFR09SSUVTID0gWwogICJFbnRlcnRhaW5tZW50IiwKICAiTXVzaWMiLAogICJTb2Z0d2FyZSIsCiAgIkhlYWx0aCAmIEZpdG5lc3MiLAogICJTaG9wcGluZyIsCiAgIlV0aWxpdGllcyIsCiAgIk5ld3MiLAogICJPdGhlciIKXTsKdmFyIGxvYWRTYXZlZERhdGEgPSAoKSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHNhdmVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVkpOwogICAgaWYgKHNhdmVkKSB7CiAgICAgIGNvbnN0IHsgZGF0YSwgdGltZXN0YW1wIH0gPSBKU09OLnBhcnNlKHNhdmVkKTsKICAgICAgaWYgKCgoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHRpbWVzdGFtcCkgLyAoMWUzICogNjAgKiA2MCkgPCA0OCkgewogICAgICAgIHJldHVybiBkYXRhOwogICAgICB9CiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oU1RPUkFHRV9LRVkpOwogIH0KICByZXR1cm4gbnVsbDsKfTsKdmFyIHNhdmVEYXRhID0gKGRhdGEpID0+IHsKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RPUkFHRV9LRVksIEpTT04uc3RyaW5naWZ5KHsgZGF0YSwgdGltZXN0YW1wOiAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLmdldFRpbWUoKSB9KSk7CiAgfSBjYXRjaCAoZSkgewogIH0KfTsKdmFyIHBhcnNlVGV4dEZvclN1YnNjcmlwdGlvbnMgPSAodGV4dCkgPT4gewogIGNvbnN0IGxpbmVzID0gdGV4dC5zcGxpdCgvXHI/XG4vKTsKICBjb25zdCBmb3VuZFN1YnNjcmlwdGlvbnMgPSB7fTsKICBsaW5lcy5mb3JFYWNoKChsaW5lLCBpbmRleCkgPT4gewogICAgaWYgKGxpbmUubGVuZ3RoIDwgNSkgcmV0dXJuOwogICAgY29uc3QgbG93ZXJMaW5lID0gbGluZS50b0xvd2VyQ2FzZSgpOwogICAgT2JqZWN0LnZhbHVlcyhTVUJTQ1JJUFRJT05fUEFUVEVSTlMpLmZvckVhY2goKHBhdHRlcm4pID0+IHsKICAgICAgaWYgKHBhdHRlcm4ucmVnZXgudGVzdChsb3dlckxpbmUpKSB7CiAgICAgICAgY29uc3QgcHJpY2VNYXRjaCA9IGxpbmUubWF0Y2goLyhcZCtcLlxkezJ9KS8pOwogICAgICAgIGxldCBjb3N0ID0gMDsKICAgICAgICBpZiAocHJpY2VNYXRjaCkgewogICAgICAgICAgY29zdCA9IHBhcnNlRmxvYXQocHJpY2VNYXRjaFswXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChwYXR0ZXJuLm5hbWUgPT09ICJOZXRmbGl4IikgY29zdCA9IDE1LjQ5OwogICAgICAgICAgaWYgKHBhdHRlcm4ubmFtZSA9PT0gIlNwb3RpZnkiKSBjb3N0ID0gMTEuOTk7CiAgICAgICAgICBpZiAocGF0dGVybi5uYW1lID09PSAiQ2hhdEdQVCIpIGNvc3QgPSAyMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBmb3VuZFN1YnNjcmlwdGlvbnNbcGF0dGVybi5uYW1lXTsKICAgICAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgICAgIGV4aXN0aW5nLmNvdW50ID0gKGV4aXN0aW5nLmNvdW50IHx8IDEpICsgMTsKICAgICAgICAgIGlmIChleGlzdGluZy5tb250aGx5Q29zdCA9PT0gMCAmJiBjb3N0ID4gMCkgZXhpc3RpbmcubW9udGhseUNvc3QgPSBjb3N0OwogICAgICAgICAgaWYgKGxpbmUubGVuZ3RoID4gKGV4aXN0aW5nLm9yaWdpbmFsRGVzY3JpcHRpb24/Lmxlbmd0aCB8fCAwKSkgewogICAgICAgICAgICBleGlzdGluZy5vcmlnaW5hbERlc2NyaXB0aW9uID0gbGluZS50cmltKCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvdW5kU3Vic2NyaXB0aW9uc1twYXR0ZXJuLm5hbWVdID0gewogICAgICAgICAgICBpZDogYHN1Yi0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gLAogICAgICAgICAgICBzZXJ2aWNlOiBwYXR0ZXJuLm5hbWUsCiAgICAgICAgICAgIG1vbnRobHlDb3N0OiBjb3N0ID4gMCA/IGNvc3QgOiAwLAogICAgICAgICAgICBzdGF0dXM6ICJjb25maXJtZWRfc3Vic2NyaXB0aW9uIiwKICAgICAgICAgICAgLy8gRGVmYXVsdCBzdGF0dXMgLSBhc3N1bWUgcmVnZXggbWF0Y2ggaXMgY29uZmlybWVkCiAgICAgICAgICAgIGNhdGVnb3J5OiBwYXR0ZXJuLmNhdGVnb3J5LAogICAgICAgICAgICBsb2dvOiBwYXR0ZXJuLmxvZ28sCiAgICAgICAgICAgIG9yaWdpbmFsRGVzY3JpcHRpb246IGxpbmUudHJpbSgpLAogICAgICAgICAgICBjbGVhbkRlc2NyaXB0aW9uOiBgJHtwYXR0ZXJuLmNhdGVnb3J5fSBzdWJzY3JpcHRpb25gLAogICAgICAgICAgICAvLyBHZW5lcmljIGRlc2NyaXB0aW9uIGZvciBub3cKICAgICAgICAgICAgY291bnQ6IDEKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9KTsKICByZXR1cm4gT2JqZWN0LnZhbHVlcyhmb3VuZFN1YnNjcmlwdGlvbnMpOwp9Owp2YXIgZXh0cmFjdFRleHRGcm9tUERGID0gYXN5bmMgKGZpbGVEYXRhKSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHBkZiA9IGF3YWl0IGdldERvY3VtZW50KHsgZGF0YTogZmlsZURhdGEgfSkucHJvbWlzZTsKICAgIGxldCBmdWxsVGV4dCA9ICIiOwogICAgaWYgKHBkZi5udW1QYWdlcyA9PT0gMCkgewogICAgICByZXR1cm4geyB0ZXh0OiAiIiwgZXJyb3I6ICJQREYgaGFzIG5vIHBhZ2VzLiIgfTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHBkZi5udW1QYWdlczsgaSsrKSB7CiAgICAgIGNvbnN0IHBhZ2UgPSBhd2FpdCBwZGYuZ2V0UGFnZShpKTsKICAgICAgY29uc3QgdGV4dENvbnRlbnQgPSBhd2FpdCBwYWdlLmdldFRleHRDb250ZW50KCk7CiAgICAgIGxldCBsYXN0WSA9IC0xOwogICAgICBsZXQgcGFnZVRleHQgPSAiIjsKICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHRleHRDb250ZW50Lml0ZW1zKSB7CiAgICAgICAgaWYgKGxhc3RZICE9PSAtMSAmJiBNYXRoLmFicyhpdGVtLnRyYW5zZm9ybVs1XSAtIGxhc3RZKSA+IDUpIHsKICAgICAgICAgIHBhZ2VUZXh0ICs9ICJcbiI7CiAgICAgICAgfSBlbHNlIGlmIChwYWdlVGV4dC5sZW5ndGggPiAwICYmICFwYWdlVGV4dC5lbmRzV2l0aCgiXG4iKSkgewogICAgICAgICAgcGFnZVRleHQgKz0gIiAiOwogICAgICAgIH0KICAgICAgICBwYWdlVGV4dCArPSBpdGVtLnN0cjsKICAgICAgICBsYXN0WSA9IGl0ZW0udHJhbnNmb3JtWzVdOwogICAgICB9CiAgICAgIGZ1bGxUZXh0ICs9IHBhZ2VUZXh0ICsgIlxuIjsKICAgIH0KICAgIHJldHVybiB7IHRleHQ6IGZ1bGxUZXh0IH07CiAgfSBjYXRjaCAoZSkgewogICAgY29uc29sZS5lcnJvcigiUERGIFBhcnNlIEVycm9yIiwgZSk7CiAgICByZXR1cm4geyB0ZXh0OiAiIiwgZXJyb3I6IGU/Lm1lc3NhZ2UgfHwgIlVua25vd24gUERGIHBhcnNpbmcgZXJyb3IiIH07CiAgfQp9Owp2YXIgV0FMTF9PRl9TQVZJTkdTX0RBVEEgPSBbCiAgeyBpZDogMSwgbmFtZTogIkFsZXggTS4iLCBzYXZlZDogIiQ0MjAveXIiLCB0ZXh0OiAiRm9yZ290IEkgd2FzIHBheWluZyBmb3IgQWRvYmUgQU5EIENhbnZhLiBDYW5jZWxsZWQgaW1tZWRpYXRlbHkuIiwgc291cmNlOiAidHdpdHRlciIgfSwKICB7IGlkOiAyLCBuYW1lOiAiU2FyYWggSy4iLCBzYXZlZDogIiQxLDIwMC95ciIsIHRleHQ6ICJGb3VuZCBhIGd5bSBtZW1iZXJzaGlwIGZyb20gMjAxOSBydW5uaW5nIG9uIG15IG9sZCBjYXJkLiIsIHNvdXJjZTogInR3aXR0ZXIiIH0sCiAgeyBpZDogMywgbmFtZTogIk1pa2UgUi4iLCBzYXZlZDogIiQxNTYveXIiLCB0ZXh0OiAiTmV0ZmxpeCArIEh1bHUgKyBEaXNuZXkrIGJ1bmRsZSBzYXZlZCBtZSAkMTMvbW8uIiwgc291cmNlOiAidHdpdHRlciIgfSwKICB7IGlkOiA0LCBuYW1lOiAiSmFzbWluZSIsIHNhdmVkOiAiJDg5MC95ciIsIHRleHQ6ICJBbmFseXNpcyB0b29rIDMwIHNlY29uZHMuIFNhdmVkIGVub3VnaCBmb3IgYSBmbGlnaHQgdG8gVG9reW8uIiwgc291cmNlOiAidHdpdHRlciIgfQpdOwp2YXIgQU5BTFlTSVNfU1RFUFMgPSBbCiAgIkNvbm5lY3RpbmcgdG8gc2VjdXJlIGxvY2FsIHByb2Nlc3Nvci4uLiIsCiAgIlNjYW5uaW5nIHRyYW5zYWN0aW9uIGhpc3RvcnkuLi4iLAogICJJZGVudGlmeWluZyByZWN1cnJpbmcgcGF0dGVybnMuLi4iLAogICJDYWxjdWxhdGluZyBwb3RlbnRpYWwgc2F2aW5ncy4uLiIsCiAgIkZpbmFsaXppbmcgeW91ciByZXBvcnQuLi4iCl07CnZhciB0cmFja0V2ZW50ID0gKGV2ZW50LCBkYXRhID0ge30pID0+IHsKICB0cnkgewogICAgY29uc3Qgc2VydmVyVXJsID0gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lID09PSAibG9jYWxob3N0IiA/ICIiIDogImh0dHBzOi8vanVzdC1jYW5jZWwtaXQub25yZW5kZXIuY29tIjsKICAgIGZldGNoKGAke3NlcnZlclVybH0vYXBpL3RyYWNrYCwgewogICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXZlbnQsIGRhdGEgfSkKICAgIH0pLmNhdGNoKCgpID0+IHsKICAgIH0pOwogIH0gY2F0Y2ggewogIH0KfTsKdmFyIFNoYXJlQnV0dG9uID0gKHsgc2F2aW5ncyB9KSA9PiB7CiAgY29uc3QgdGV4dCA9IGBKdXN0IHNhdmVkICQke3NhdmluZ3MudG9GaXhlZCgwKX0veXIgd2l0aCBqdXN0LWNhbmNlbC1pdC5vbnJlbmRlci5jb20gXHV7MUY5MkZ9IFNjYW4geW91ciBiYW5rIHN0YXRlbWVudCB0byBmaW5kIHN1YnNjcmlwdGlvbnMgeW91IGZvcmdvdCBhYm91dC5gOwogIGNvbnN0IHVybCA9IGBodHRwczovL3R3aXR0ZXIuY29tL2ludGVudC90d2VldD90ZXh0PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHRleHQpfWA7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgImEiLAogICAgewogICAgICBocmVmOiB1cmwsCiAgICAgIHRhcmdldDogIl9ibGFuayIsCiAgICAgIHJlbDogIm5vb3BlbmVyIG5vcmVmZXJyZXIiLAogICAgICBvbkNsaWNrOiAoKSA9PiB0cmFja0V2ZW50KCJzaGFyZV9jbGljayIsIHsgc2F2aW5ncyB9KSwKICAgICAgc3R5bGU6IHsKICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgIGdhcDogOCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjMURBMUYyIiwKICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICBwYWRkaW5nOiAiMTJweCAyNHB4IiwKICAgICAgICBib3JkZXJSYWRpdXM6IDMwLAogICAgICAgIHRleHREZWNvcmF0aW9uOiAibm9uZSIsCiAgICAgICAgZm9udFdlaWdodDogNzAwLAogICAgICAgIGZvbnRTaXplOiAxNSwKICAgICAgICB0cmFuc2l0aW9uOiAidHJhbnNmb3JtIDAuMnMiLAogICAgICAgIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgyOSwgMTYxLCAyNDIsIDAuMykiCiAgICAgIH0sCiAgICAgIG9uTW91c2VPdmVyOiAoZSkgPT4gZS5jdXJyZW50VGFyZ2V0LnN0eWxlLnRyYW5zZm9ybSA9ICJzY2FsZSgxLjAyKSIsCiAgICAgIG9uTW91c2VPdXQ6IChlKSA9PiBlLmN1cnJlbnRUYXJnZXQuc3R5bGUudHJhbnNmb3JtID0gInNjYWxlKDEpIiwKICAgICAgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdmciLCB7IHdpZHRoOiAiMTgiLCBoZWlnaHQ6ICIxOCIsIHZpZXdCb3g6ICIwIDAgMjQgMjQiLCBmaWxsOiAiY3VycmVudENvbG9yIiwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInBhdGgiLCB7IGQ6ICJNMjMuOTUzIDQuNTdhMTAgMTAgMCAwMS0yLjgyNS43NzUgNC45NTggNC45NTggMCAwMDIuMTYzLTIuNzIzYy0uOTUxLjU1NS0yLjAwNS45NTktMy4xMjcgMS4xODRhNC45MiA0LjkyIDAgMDAtOC4zODQgNC40ODJDNy42OSA4LjA5NSA0LjA2NyA2LjEzIDEuNjQgMy4xNjJhNC44MjIgNC44MjIgMCAwMC0uNjY2IDIuNDc1YzAgMS43MS44NyAzLjIxMyAyLjE4OCA0LjA5NmE0LjkwNCA0LjkwNCAwIDAxLTIuMjI4LS42MTZ2LjA2YTQuOTIzIDQuOTIzIDAgMDAzLjk0NiA0LjgyNyA0Ljk5NiA0Ljk5NiAwIDAxLTIuMjEyLjA4NSA0LjkzNiA0LjkzNiAwIDAwNC42MDQgMy40MTcgOS44NjcgOS44NjcgMCAwMS02LjEwMiAyLjEwNWMtLjM5IDAtLjc3OS0uMDIzLTEuMTctLjA2N2ExMy45OTUgMTMuOTk1IDAgMDA3LjU1NyAyLjIwOWM5LjA1MyAwIDEzLjk5OC03LjQ5NiAxMy45OTgtMTMuOTg1IDAtLjIxIDAtLjQyLS4wMTUtLjYzQTkuOTM1IDkuOTM1IDAgMDAyNCA0LjU5eiIgfSkgfSksCiAgICAgICAgIlNoYXJlIHlvdXIgc2F2aW5ncyIKICAgICAgXQogICAgfQogICk7Cn07CmZ1bmN0aW9uIEp1c3RDYW5jZWwoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICBjb25zdCBbcHJvZmlsZSwgc2V0UHJvZmlsZV0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoKCkgPT4gewogICAgaWYgKHR5cGVvZiBzZXNzaW9uU3RvcmFnZSAhPT0gInVuZGVmaW5lZCIgJiYgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgiSlVTVF9DQU5DRUxfRk9SQ0VfUkVTRVQiKSkgewogICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCJKVVNUX0NBTkNFTF9GT1JDRV9SRVNFVCIpOwogICAgICBjb25zb2xlLmxvZygiW0p1c3QgQ2FuY2VsXSBGb3JjZWQgcmVzZXQgLSByZXR1cm5pbmcgdG8gbGFuZGluZyBwYWdlLiIpOwogICAgICByZXR1cm4gREVGQVVMVF9QUk9GSUxFOwogICAgfQogICAgY29uc3Qgc2F2ZWQgPSBsb2FkU2F2ZWREYXRhKCk7CiAgICBpZiAoc2F2ZWQpIHJldHVybiBzYXZlZDsKICAgIGlmICh0eXBlb2YgbG9jYWxTdG9yYWdlICE9PSAidW5kZWZpbmVkIiAmJiAhbG9jYWxTdG9yYWdlLmdldEl0ZW0oIkpVU1RfQ0FOQ0VMX1NFRU5fU0FNUExFIikpIHsKICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkpVU1RfQ0FOQ0VMX1NFRU5fU0FNUExFIiwgInRydWUiKTsKICAgICAgcmV0dXJuIFNBTVBMRV9QUk9GSUxFOwogICAgfQogICAgcmV0dXJuIERFRkFVTFRfUFJPRklMRTsKICB9KTsKICBjb25zdCBbc2hvd01hbnVhbElucHV0LCBzZXRTaG93TWFudWFsSW5wdXRdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbbWFudWFsU2VydmljZSwgc2V0TWFudWFsU2VydmljZV0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFttYW51YWxDb3N0LCBzZXRNYW51YWxDb3N0XSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW21hbnVhbENhdGVnb3J5LCBzZXRNYW51YWxDYXRlZ29yeV0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoIk90aGVyIik7CiAgY29uc3QgW2RyYWdBY3RpdmUsIHNldERyYWdBY3RpdmVdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbYW5hbHlzaXNTdGVwLCBzZXRBbmFseXNpc1N0ZXBdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKEFOQUxZU0lTX1NURVBTWzBdKTsKICAoMCwgaW1wb3J0X3JlYWN0My51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChwcm9maWxlLmFuYWx5c2lzQ29tcGxldGUgPT09IGZhbHNlICYmIHByb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oU1RPUkFHRV9LRVkpOwogICAgfQogIH0sIFtwcm9maWxlLmFuYWx5c2lzQ29tcGxldGVdKTsKICAoMCwgaW1wb3J0X3JlYWN0My51c2VFZmZlY3QpKCgpID0+IHsKICAgIHNhdmVEYXRhKHByb2ZpbGUpOwogIH0sIFtwcm9maWxlXSk7CiAgY29uc3QgaGFuZGxlRHJhZyA9IChlKSA9PiB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgaWYgKGUudHlwZSA9PT0gImRyYWdlbnRlciIgfHwgZS50eXBlID09PSAiZHJhZ292ZXIiKSB7CiAgICAgIHNldERyYWdBY3RpdmUodHJ1ZSk7CiAgICB9IGVsc2UgaWYgKGUudHlwZSA9PT0gImRyYWdsZWF2ZSIpIHsKICAgICAgc2V0RHJhZ0FjdGl2ZShmYWxzZSk7CiAgICB9CiAgfTsKICBjb25zdCBwcm9jZXNzRmlsZSA9IGFzeW5jIChmaWxlKSA9PiB7CiAgICBzZXRQcm9maWxlKChwKSA9PiAoeyAuLi5wLCBpc0FuYWx5emluZzogdHJ1ZSwgYW5hbHlzaXNDb21wbGV0ZTogZmFsc2UsIGZpbGVOYW1lOiBmaWxlLm5hbWUsIGZpbGVUeXBlOiBmaWxlLnR5cGUuaW5jbHVkZXMoInBkZiIpID8gInBkZiIgOiAiY3N2IiwgdXBsb2FkZWRGaWxlOiBVUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpIH0pKTsKICAgIHNldEFuYWx5c2lzU3RlcCgiUmVhZGluZyBmaWxlLi4uIik7CiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocikgPT4gc2V0VGltZW91dChyLCAxNTAwKSk7CiAgICBsZXQgY29udGVudCA9ICIiOwogICAgbGV0IGV4dHJhY3Rpb25FcnJvciA9ICIiOwogICAgaWYgKGZpbGUudHlwZS5pbmNsdWRlcygicGRmIikpIHsKICAgICAgc2V0QW5hbHlzaXNTdGVwKCJFeHRyYWN0aW5nIHRleHQgZnJvbSBQREYuLi4iKTsKICAgICAgY29uc3QgYXJyYXlCdWZmZXIgPSBhd2FpdCBmaWxlLmFycmF5QnVmZmVyKCk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV4dHJhY3RUZXh0RnJvbVBERihhcnJheUJ1ZmZlcik7CiAgICAgIGNvbnRlbnQgPSByZXN1bHQudGV4dDsKICAgICAgZXh0cmFjdGlvbkVycm9yID0gcmVzdWx0LmVycm9yIHx8ICIiOwogICAgfSBlbHNlIHsKICAgICAgY29udGVudCA9IGF3YWl0IGZpbGUudGV4dCgpOwogICAgfQogICAgc2V0QW5hbHlzaXNTdGVwKCJJZGVudGlmeWluZyBwYXR0ZXJucy4uLiIpOwogICAgYXdhaXQgbmV3IFByb21pc2UoKHIpID0+IHNldFRpbWVvdXQociwgMTUwMCkpOwogICAgc2V0QW5hbHlzaXNTdGVwKCJDYWxjdWxhdGluZyBwb3RlbnRpYWwgc2F2aW5ncy4uLiIpOwogICAgYXdhaXQgbmV3IFByb21pc2UoKHIpID0+IHNldFRpbWVvdXQociwgMTUwMCkpOwogICAgY29uc3QgbmV3U3Vic2NyaXB0aW9ucyA9IHBhcnNlVGV4dEZvclN1YnNjcmlwdGlvbnMoY29udGVudCk7CiAgICBzZXRQcm9maWxlKChwKSA9PiB7CiAgICAgIGNvbnN0IG1lcmdlZE1hcCA9IHt9OwogICAgICBwLm1hbnVhbFN1YnNjcmlwdGlvbnMuZm9yRWFjaCgoc3ViKSA9PiB7CiAgICAgICAgbWVyZ2VkTWFwW3N1Yi5zZXJ2aWNlLnRvTG93ZXJDYXNlKCldID0gc3ViOwogICAgICB9KTsKICAgICAgbmV3U3Vic2NyaXB0aW9ucy5mb3JFYWNoKChuZXdTdWIpID0+IHsKICAgICAgICBjb25zdCBrZXkgPSBuZXdTdWIuc2VydmljZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmICghbWVyZ2VkTWFwW2tleV0pIHsKICAgICAgICAgIG1lcmdlZE1hcFtrZXldID0gbmV3U3ViOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgY29uc3QgbWVyZ2VkTGlzdCA9IE9iamVjdC52YWx1ZXMobWVyZ2VkTWFwKTsKICAgICAgY29uc3QgbmV3VG90YWwgPSBtZXJnZWRMaXN0LnJlZHVjZSgoc3VtLCBzKSA9PiBzdW0gKyBzLm1vbnRobHlDb3N0LCAwKTsKICAgICAgcmV0dXJuIHsKICAgICAgICAuLi5wLAogICAgICAgIG1hbnVhbFN1YnNjcmlwdGlvbnM6IG1lcmdlZExpc3QsCiAgICAgICAgdG90YWxNb250aGx5U3BlbmQ6IG5ld1RvdGFsLAogICAgICAgIGlzQW5hbHl6aW5nOiBmYWxzZSwKICAgICAgICBhbmFseXNpc0NvbXBsZXRlOiB0cnVlLAogICAgICAgIGV4dHJhY3RlZFRleHQ6IGNvbnRlbnQsCiAgICAgICAgcGFyc2luZ0Vycm9yOiBleHRyYWN0aW9uRXJyb3IKICAgICAgfTsKICAgIH0pOwogICAgdHJhY2tFdmVudCgiYW5hbHlzaXNfY29tcGxldGUiLCB7IGZpbGVOYW1lOiBmaWxlLm5hbWUsIHN1YnNjcmlwdGlvbkNvdW50OiBuZXdTdWJzY3JpcHRpb25zLmxlbmd0aCB9KTsKICB9OwogIGNvbnN0IGhhbmRsZURyb3AgPSAoZSkgPT4gewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIHNldERyYWdBY3RpdmUoZmFsc2UpOwogICAgaWYgKGUuZGF0YVRyYW5zZmVyLmZpbGVzICYmIGUuZGF0YVRyYW5zZmVyLmZpbGVzWzBdKSB7CiAgICAgIHByb2Nlc3NGaWxlKGUuZGF0YVRyYW5zZmVyLmZpbGVzWzBdKTsKICAgIH0KICB9OwogIGNvbnN0IGhhbmRsZUZpbGVDaGFuZ2UgPSAoZSkgPT4gewogICAgaWYgKGUudGFyZ2V0LmZpbGVzICYmIGUudGFyZ2V0LmZpbGVzWzBdKSB7CiAgICAgIHByb2Nlc3NGaWxlKGUudGFyZ2V0LmZpbGVzWzBdKTsKICAgIH0KICB9OwogIGNvbnN0IGFkZE1hbnVhbFN1YnNjcmlwdGlvbiA9ICgpID0+IHsKICAgIGlmICghbWFudWFsU2VydmljZSB8fCAhbWFudWFsQ29zdCkgcmV0dXJuOwogICAgY29uc3QgY29zdCA9IHBhcnNlRmxvYXQobWFudWFsQ29zdC5yZXBsYWNlKCIkIiwgIiIpKTsKICAgIGlmIChpc05hTihjb3N0KSkgcmV0dXJuOwogICAgY29uc3QgbmV3SXRlbSA9IHsKICAgICAgaWQ6IGBtYW51YWwtJHtEYXRlLm5vdygpfWAsCiAgICAgIHNlcnZpY2U6IG1hbnVhbFNlcnZpY2UsCiAgICAgIG1vbnRobHlDb3N0OiBjb3N0LAogICAgICBzdGF0dXM6ICJrZWVwaW5nIiwKICAgICAgLy8gRGVmYXVsdAogICAgICBjYXRlZ29yeTogbWFudWFsQ2F0ZWdvcnkKICAgIH07CiAgICBzZXRQcm9maWxlKChwKSA9PiAoewogICAgICAuLi5wLAogICAgICBtYW51YWxTdWJzY3JpcHRpb25zOiBbbmV3SXRlbSwgLi4ucC5tYW51YWxTdWJzY3JpcHRpb25zXSwKICAgICAgdG90YWxNb250aGx5U3BlbmQ6IHAudG90YWxNb250aGx5U3BlbmQgKyBuZXdJdGVtLm1vbnRobHlDb3N0CiAgICB9KSk7CiAgICBzZXRNYW51YWxTZXJ2aWNlKCIiKTsKICAgIHNldE1hbnVhbENvc3QoIiIpOwogICAgc2V0U2hvd01hbnVhbElucHV0KGZhbHNlKTsKICAgIHRyYWNrRXZlbnQoIm1hbnVhbF9hZGQiLCB7IHNlcnZpY2U6IG1hbnVhbFNlcnZpY2UgfSk7CiAgfTsKICBjb25zdCB1cGRhdGVTdGF0dXMgPSAoaWQsIHN0YXR1cykgPT4gewogICAgc2V0UHJvZmlsZSgocCkgPT4gKHsKICAgICAgLi4ucCwKICAgICAgbWFudWFsU3Vic2NyaXB0aW9uczogcC5tYW51YWxTdWJzY3JpcHRpb25zLm1hcCgKICAgICAgICAocykgPT4gcy5pZCA9PT0gaWQgPyB7IC4uLnMsIHN0YXR1cyB9IDogcwogICAgICApCiAgICB9KSk7CiAgfTsKICBjb25zdCByZW1vdmVTdWJzY3JpcHRpb24gPSAoaWQpID0+IHsKICAgIGNvbnN0IHN1YiA9IHByb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9ucy5maW5kKChzKSA9PiBzLmlkID09PSBpZCk7CiAgICBpZiAoc3ViKSB7CiAgICAgIHNldFByb2ZpbGUoKHApID0+ICh7CiAgICAgICAgLi4ucCwKICAgICAgICBtYW51YWxTdWJzY3JpcHRpb25zOiBwLm1hbnVhbFN1YnNjcmlwdGlvbnMuZmlsdGVyKChzKSA9PiBzLmlkICE9PSBpZCksCiAgICAgICAgdG90YWxNb250aGx5U3BlbmQ6IHAudG90YWxNb250aGx5U3BlbmQgLSBzdWIubW9udGhseUNvc3QKICAgICAgfSkpOwogICAgfQogIH07CiAgY29uc3QgZ2V0RmlsdGVyZWRTdWJzY3JpcHRpb25zID0gKCkgPT4gewogICAgY29uc3QgdmFsaWRTdWJzID0gcHJvZmlsZS5tYW51YWxTdWJzY3JpcHRpb25zLmZpbHRlcigocykgPT4gcy5tb250aGx5Q29zdCA+IDApOwogICAgaWYgKHByb2ZpbGUudmlld0ZpbHRlciA9PT0gImFsbCIpIHJldHVybiB2YWxpZFN1YnM7CiAgICBpZiAocHJvZmlsZS52aWV3RmlsdGVyID09PSAiYXBwcm92ZWQiKSB7CiAgICAgIHJldHVybiB2YWxpZFN1YnMuZmlsdGVyKChzKSA9PiBzLnN0YXR1cyA9PT0gImtlZXBpbmciKTsKICAgIH0KICAgIGlmIChwcm9maWxlLnZpZXdGaWx0ZXIgPT09ICJjb25maXJtZWRfc3Vic2NyaXB0aW9uIikgewogICAgICByZXR1cm4gdmFsaWRTdWJzLmZpbHRlcigKICAgICAgICAocykgPT4gcy5zdGF0dXMgPT09ICJjb25maXJtZWRfc3Vic2NyaXB0aW9uIiB8fCBzLnN0YXR1cyA9PT0gImNhbmNlbGxpbmciCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gdmFsaWRTdWJzLmZpbHRlcigocykgPT4gcy5zdGF0dXMgPT09IHByb2ZpbGUudmlld0ZpbHRlcik7CiAgfTsKICBjb25zdCByZXNldEFuYWx5c2lzID0gKCkgPT4gewogICAgY29uc29sZS5sb2coIltKdXN0IENhbmNlbF0gUmVzZXR0aW5nIGFsbCBkYXRhLi4uIik7CiAgICB0cnkgewogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShTVE9SQUdFX0tFWSk7CiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJKVVNUX0NBTkNFTF9EQVRBIik7CiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oIkpVU1RfQ0FOQ0VMX0ZPUkNFX1JFU0VUIiwgInRydWUiKTsKICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25zb2xlLmVycm9yKCJbSnVzdCBDYW5jZWxdIFJlc2V0IGZhaWxlZDoiLCBlKTsKICAgICAgc2V0UHJvZmlsZSh7CiAgICAgICAgLi4uREVGQVVMVF9QUk9GSUxFLAogICAgICAgIGFuYWx5c2lzQ29tcGxldGU6IGZhbHNlLAogICAgICAgIG1hbnVhbFN1YnNjcmlwdGlvbnM6IFtdLAogICAgICAgIHRvdGFsTW9udGhseVNwZW5kOiAwCiAgICAgIH0pOwogICAgfQogIH07CiAgY29uc3Qgc3RhdHVzQ291bnRzID0gKDAsIGltcG9ydF9yZWFjdDMudXNlTWVtbykoKCkgPT4gewogICAgY29uc3Qgc3VicyA9IHByb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9uczsKICAgIHJldHVybiB7CiAgICAgIGNvbmZpcm1lZDogc3Vicy5maWx0ZXIoKHMpID0+IHMuc3RhdHVzID09PSAiY29uZmlybWVkX3N1YnNjcmlwdGlvbiIgfHwgcy5zdGF0dXMgPT09ICJjYW5jZWxsaW5nIikubGVuZ3RoLAogICAgICBhcHByb3ZlZDogc3Vicy5maWx0ZXIoKHMpID0+IHMuc3RhdHVzID09PSAia2VlcGluZyIpLmxlbmd0aCwKICAgICAgcmVqZWN0ZWQ6IHN1YnMuZmlsdGVyKChzKSA9PiBzLnN0YXR1cyA9PT0gIm5vdF9zdWJzY3JpcHRpb24iKS5sZW5ndGgsCiAgICAgIHVua25vd246IHN1YnMuZmlsdGVyKChzKSA9PiBzLnN0YXR1cyA9PT0gInVua25vd24iIHx8IHMuc3RhdHVzID09PSAiaW52ZXN0aWdhdGluZyIpLmxlbmd0aAogICAgfTsKICB9LCBbcHJvZmlsZS5tYW51YWxTdWJzY3JpcHRpb25zXSk7CiAgY29uc3QgcG90ZW50aWFsU2F2aW5ncyA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZU1lbW8pKCgpID0+IHsKICAgIHJldHVybiBwcm9maWxlLm1hbnVhbFN1YnNjcmlwdGlvbnMuZmlsdGVyKChzKSA9PiBzLnN0YXR1cyA9PT0gImNhbmNlbGxpbmciKS5yZWR1Y2UoKHN1bSwgcykgPT4gc3VtICsgcy5tb250aGx5Q29zdCwgMCk7CiAgfSwgW3Byb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9uc10pOwogIGlmIChwcm9maWxlLmlzQW5hbHl6aW5nKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogNDAsIGRpc3BsYXk6ICJmbGV4IiwgZmxleERpcmVjdGlvbjogImNvbHVtbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIG1pbkhlaWdodDogNDAwIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUmVmcmVzaEN3LCB7IHNpemU6IDQ4LCBjbGFzc05hbWU6ICJzcGluIiwgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBtYXJnaW5Cb3R0b206IDMyLCBhbmltYXRpb246ICJzcGluIDFzIGxpbmVhciBpbmZpbml0ZSIgfSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDIiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IGFuYWx5c2lzU3RlcCB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBtYXhXaWR0aDogNDAwIH0sIGNoaWxkcmVuOiAiVGhpcyB1c3VhbGx5IHRha2VzIGFib3V0IDEwLTIwIHNlY29uZHMuIFdlJ3JlIHByb2Nlc3NpbmcgeW91ciBzdGF0ZW1lbnQgbG9jYWxseS4iIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAyMDAsIGhlaWdodDogNCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYm9yZGVyLCBib3JkZXJSYWRpdXM6IDIsIG1hcmdpblRvcDogMjQsIG92ZXJmbG93OiAiaGlkZGVuIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBoZWlnaHQ6ICIxMDAlIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwgYW5pbWF0aW9uOiAicHJvZ3Jlc3MgMnMgZWFzZS1pbi1vdXQgaW5maW5pdGUiLCB0cmFuc2Zvcm1PcmlnaW46ICJsZWZ0IiB9IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGAKICAgICAgICAgIEBrZXlmcmFtZXMgc3BpbiB7IDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0gMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gfQogICAgICAgICAgQGtleWZyYW1lcyBwcm9ncmVzcyB7IDAlIHsgdHJhbnNmb3JtOiBzY2FsZVgoMCk7IH0gNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVgoMC43KTsgfSAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVgoMSk7IH0gfQogICAgICAgIGAgfSkKICAgIF0gfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBtYXhXaWR0aDogODAwLCBtYXJnaW46ICIwIGF1dG8iLCBwYWRkaW5nOiAiMjBweCIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBmb250RmFtaWx5OiAnIkludGVyIiwgc2Fucy1zZXJpZicsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIG1hcmdpbkJvdHRvbTogMzIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDQwLCBoZWlnaHQ6IDQwLCBib3JkZXJSYWRpdXM6IDEwLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGNvbG9yOiAid2hpdGUiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKERvbGxhclNpZ24sIHsgc2l6ZTogMjQgfSkgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgxIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjIsIGZvbnRXZWlnaHQ6IDgwMCwgbWFyZ2luOiAwLCBsZXR0ZXJTcGFjaW5nOiAiLTAuNXB4IiB9LCBjaGlsZHJlbjogIkp1c3QgQ2FuY2VsIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW46IDAgfSwgY2hpbGRyZW46ICJGaW5kIGFuZCBjYW5jZWwgdW53YW50ZWQgc3Vic2NyaXB0aW9ucyIgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgcHJvZmlsZS5tYW51YWxTdWJzY3JpcHRpb25zLmxlbmd0aCA+IDAgJiYgIXByb2ZpbGUuYW5hbHlzaXNDb21wbGV0ZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRQcm9maWxlKChwKSA9PiAoeyAuLi5wLCBhbmFseXNpc0NvbXBsZXRlOiB0cnVlIH0pKSwgc3R5bGU6IHsKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgcGFkZGluZzogIjhweCAxMnB4IiwKICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsCiAgICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgZm9udFdlaWdodDogNTAwCiAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJyb3dSaWdodCwgeyBzaXplOiAxNCwgc3R5bGU6IHsgdHJhbnNmb3JtOiAicm90YXRlKDE4MGRlZykiIH0gfSksCiAgICAgICAgICAiIEJhY2sgdG8gRGFzaGJvYXJkIgogICAgICAgIF0gfSksCiAgICAgICAgKHByb2ZpbGUuYW5hbHlzaXNDb21wbGV0ZSB8fCBwcm9maWxlLm1hbnVhbFN1YnNjcmlwdGlvbnMubGVuZ3RoID4gMCkgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogcmVzZXRBbmFseXNpcywgc3R5bGU6IHsKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgcGFkZGluZzogIjhweCAxMnB4IiwKICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsCiAgICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgZm9udFdlaWdodDogNTAwCiAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUm90YXRlQ2N3LCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgIiBTdGFydCBPdmVyIgogICAgICAgIF0gfSkKICAgICAgXSB9KQogICAgXSB9KSwKICAgICFwcm9maWxlLmFuYWx5c2lzQ29tcGxldGUgPyAoCiAgICAgIC8vIExhbmRpbmcgVmlldyAtIFVwbG9hZCBvciBNYW51YWwgRW50cnkKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBhbmltYXRpb246ICJmYWRlSW4gMC41cyBlYXNlLW91dCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgIGJvcmRlclJhZGl1czogMjQsCiAgICAgICAgcGFkZGluZzogNDAsCiAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjAzKSIsCiAgICAgICAgdGV4dEFsaWduOiAiY2VudGVyIgogICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgyIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjgsIGZvbnRXZWlnaHQ6IDgwMCwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogIlN0b3AgcGF5aW5nIGZvciB3aGF0IHlvdSBkb24ndCB1c2UuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJwIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luQm90dG9tOiAzMiwgbGluZUhlaWdodDogMS41LCBtYXhXaWR0aDogNTAwLCBtYXJnaW46ICIwIGF1dG8gMzJweCIgfSwgY2hpbGRyZW46ICJVcGxvYWQgeW91ciBiYW5rIHN0YXRlbWVudCAoUERGIG9yIENTVikgdG8gaW5zdGFudGx5IGlkZW50aWZ5IHJlY3VycmluZyBzdWJzY3JpcHRpb25zLCBvciBlbnRlciB0aGVtIG1hbnVhbGx5IHRvIHRyYWNrIHlvdXIgc2F2aW5ncy4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uRHJhZ0VudGVyOiBoYW5kbGVEcmFnLAogICAgICAgICAgICBvbkRyYWdMZWF2ZTogaGFuZGxlRHJhZywKICAgICAgICAgICAgb25EcmFnT3ZlcjogaGFuZGxlRHJhZywKICAgICAgICAgICAgb25Ecm9wOiBoYW5kbGVEcm9wLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIGJvcmRlcjogYDJweCBkYXNoZWQgJHtkcmFnQWN0aXZlID8gQ09MT1JTLnByaW1hcnkgOiBDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBkcmFnQWN0aXZlID8gQ09MT1JTLmFjY2VudExpZ2h0IDogQ09MT1JTLmlucHV0QmcsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxNiwKICAgICAgICAgICAgICBwYWRkaW5nOiAiNDBweCAyMHB4IiwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMnMiLAogICAgICAgICAgICAgIHBvc2l0aW9uOiAicmVsYXRpdmUiLAogICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIgogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB0eXBlOiAiZmlsZSIsCiAgICAgICAgICAgICAgICAgIG11bHRpcGxlOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgb25DaGFuZ2U6IGhhbmRsZUZpbGVDaGFuZ2UsCiAgICAgICAgICAgICAgICAgIGFjY2VwdDogIi5jc3YsLnBkZiIsCiAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB0b3A6IDAsIGxlZnQ6IDAsIHdpZHRoOiAiMTAwJSIsIGhlaWdodDogIjEwMCUiLCBvcGFjaXR5OiAwLCBjdXJzb3I6ICJwb2ludGVyIiB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiA2NCwgaGVpZ2h0OiA2NCwgbWFyZ2luOiAiMCBhdXRvIDE2cHgiLCBib3JkZXJSYWRpdXM6ICI1MCUiLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgYm94U2hhZG93OiAiMCAycHggOHB4IHJnYmEoMCwwLDAsMC4wNSkiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFVwbG9hZCwgeyBzaXplOiAzMiwgY29sb3I6IENPTE9SUy5wcmltYXJ5IH0pIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDYwMCwgZm9udFNpemU6IDE2LCBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46ICJDbGljayB0byB1cGxvYWQgb3IgZHJhZyAmIGRyb3AiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQmFuayBzdGF0ZW1lbnRzIChQREYpIG9yIENTViBleHBvcnRzIHN1cHBvcnRlZCIgfSkKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxNiwgbWFyZ2luOiAiMzJweCAwIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBoZWlnaHQ6IDEsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmJvcmRlciwgZmxleDogMSB9IH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogIk9SIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgaGVpZ2h0OiAxLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5ib3JkZXIsIGZsZXg6IDEgfSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIHNldFByb2ZpbGUoKHApID0+ICh7IC4uLnAsIGFuYWx5c2lzQ29tcGxldGU6IHRydWUgfSkpOwogICAgICAgICAgICAgIHNldFNob3dNYW51YWxJbnB1dCh0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgICAgIHBhZGRpbmc6ICIxNHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnRleHRNYWluLAogICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgIGZvbnRTaXplOiAxNSwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICBnYXA6IDgKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFBlbkxpbmUsIHsgc2l6ZTogMTggfSksCiAgICAgICAgICAgICAgIiBFbnRlciBzdWJzY3JpcHRpb25zIG1hbnVhbGx5IgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgicCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMTYsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFNoaWVsZCwgeyBzaXplOiAxMiB9KSwKICAgICAgICAgICIgWW91ciBkYXRhIGlzIHByb2Nlc3NlZCBsb2NhbGx5IGFuZCBuZXZlciBsZWF2ZXMgeW91ciBkZXZpY2UuIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiA0MCwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDMiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxOCwgZm9udFdlaWdodDogNzAwLCBtYXJnaW5Cb3R0b206IDIwIH0sIGNoaWxkcmVuOiAiSm9pbiB0aG91c2FuZHMgc2F2aW5nIG1vbmV5IGV2ZXJ5IGRheSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBXQUxMX09GX1NBVklOR1NfREFUQS5tYXAoKGl0ZW0pID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgcGFkZGluZzogMTYsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgdGV4dEFsaWduOiAibGVmdCIsCiAgICAgICAgICAgIGJveFNoYWRvdzogIjAgMnB4IDhweCByZ2JhKDAsMCwwLDAuMDIpIgogICAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogMjgsIGhlaWdodDogMjgsIGJvcmRlclJhZGl1czogIjUwJSIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAgfSwgY2hpbGRyZW46IGl0ZW0ubmFtZS5jaGFyQXQoMCkgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogaXRlbS5uYW1lIH0pCiAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6ICIjRTZGN0YwIiwgY29sb3I6ICIjMDQ3ODU3IiwgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA3MDAsIHBhZGRpbmc6ICIycHggOHB4IiwgYm9yZGVyUmFkaXVzOiAxMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIlNhdmVkICIsCiAgICAgICAgICAgICAgICBpdGVtLnNhdmVkCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgicCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGxpbmVIZWlnaHQ6IDEuNCwgbWFyZ2luOiAwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgJyInLAogICAgICAgICAgICAgIGl0ZW0udGV4dCwKICAgICAgICAgICAgICAnIicKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9LCBpdGVtLmlkKSkgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkgfSkKICAgICkgOiAoCiAgICAgIC8vIERhc2hib2FyZCBWaWV3CiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGFuaW1hdGlvbjogInNsaWRlVXAgMC40cyBlYXNlLW91dCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIiLCBnYXA6IDE2LCBtYXJnaW5Cb3R0b206IDI0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyNCwgYm9yZGVyUmFkaXVzOiAyNCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwgY29sb3I6ICJ3aGl0ZSIsIGJveFNoYWRvdzogIjAgOHB4IDE2cHggcmdiYSg4NiwgMTk3LCAxNTAsIDAuMjUpIiwgdGV4dEFsaWduOiAiY2VudGVyIiwgcG9zaXRpb246ICJyZWxhdGl2ZSIsIG92ZXJmbG93OiAiaGlkZGVuIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogInJlbGF0aXZlIiwgekluZGV4OiAyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgb3BhY2l0eTogMC45LCBtYXJnaW5Cb3R0b206IDgsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAiMXB4IiB9LCBjaGlsZHJlbjogIlRvdGFsIEFubnVhbCBTcGVuZCIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMTYsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDQ4LCBmb250V2VpZ2h0OiA5MDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgICAocHJvZmlsZS50b3RhbE1vbnRobHlTcGVuZCAqIDEyKS50b0ZpeGVkKDApLAogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjQsIGZvbnRXZWlnaHQ6IDYwMCwgb3BhY2l0eTogMC44IH0sIGNoaWxkcmVuOiAiL3lyIiB9KQogICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU2hhcmVCdXR0b24sIHsgc2F2aW5nczogcHJvZmlsZS50b3RhbE1vbnRobHlTcGVuZCAqIDEyIH0pCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB0b3A6IC01MCwgcmlnaHQ6IC01MCwgd2lkdGg6IDIwMCwgaGVpZ2h0OiAyMDAsIGJvcmRlclJhZGl1czogIjUwJSIsIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgb3BhY2l0eTogMC4xIH0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGJvdHRvbTogLTUwLCBsZWZ0OiAtNTAsIHdpZHRoOiAxNTAsIGhlaWdodDogMTUwLCBib3JkZXJSYWRpdXM6ICI1MCUiLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIG9wYWNpdHk6IDAuMSB9IH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEsIHBhZGRpbmc6IDIwLCBib3JkZXJSYWRpdXM6IDE2LCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJNb250aGx5IFNwZW5kIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjQsIGZvbnRXZWlnaHQ6IDgwMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgcHJvZmlsZS50b3RhbE1vbnRobHlTcGVuZC50b0ZpeGVkKDApCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxLCBwYWRkaW5nOiAyMCwgYm9yZGVyUmFkaXVzOiAxNiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQWN0aXZlIFN1YnMiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI0LCBmb250V2VpZ2h0OiA4MDAgfSwgY2hpbGRyZW46IHByb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9ucy5sZW5ndGggfSkKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCwgbWFyZ2luQm90dG9tOiAyMCwgb3ZlcmZsb3dYOiAiYXV0byIsIHBhZGRpbmdCb3R0b206IDQgfSwgY2hpbGRyZW46IFsiYWxsIiwgImNvbmZpcm1lZF9zdWJzY3JpcHRpb24iLCAiYXBwcm92ZWQiLCAibm90X3N1YnNjcmlwdGlvbiIsICJ1bmtub3duIl0ubWFwKChmaWx0ZXIpID0+IHsKICAgICAgICAgIGNvbnN0IGNvdW50ID0gZmlsdGVyID09PSAiYWxsIiA/IHByb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9ucy5sZW5ndGggOiBmaWx0ZXIgPT09ICJjb25maXJtZWRfc3Vic2NyaXB0aW9uIiA/IHN0YXR1c0NvdW50cy5jb25maXJtZWQgOiBmaWx0ZXIgPT09ICJhcHByb3ZlZCIgPyBzdGF0dXNDb3VudHMuYXBwcm92ZWQgOiBmaWx0ZXIgPT09ICJub3Rfc3Vic2NyaXB0aW9uIiA/IHN0YXR1c0NvdW50cy5yZWplY3RlZCA6IHN0YXR1c0NvdW50cy51bmtub3duOwogICAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldFByb2ZpbGUoKHApID0+ICh7IC4uLnAsIHZpZXdGaWx0ZXI6IGZpbHRlciB9KSksCiAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTZweCIsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDIwLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICBib3JkZXI6IHByb2ZpbGUudmlld0ZpbHRlciA9PT0gZmlsdGVyID8gYDFweCBzb2xpZCB0cmFuc3BhcmVudGAgOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBwcm9maWxlLnZpZXdGaWx0ZXIgPT09IGZpbHRlciA/IENPTE9SUy50ZXh0TWFpbiA6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICBjb2xvcjogcHJvZmlsZS52aWV3RmlsdGVyID09PSBmaWx0ZXIgPyAid2hpdGUiIDogQ09MT1JTLnRleHRTZWNvbmRhcnksCiAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlOiAibm93cmFwIiwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4ycyIsCiAgICAgICAgICAgICAgICBtaW5XaWR0aDogZmlsdGVyID09PSAiYWxsIiA/IDYwIDogMTIwLAogICAgICAgICAgICAgICAgLy8gTWFrZSBvdGhlciBwaWxscyBtb3JlIGNvbnNpc3RlbnQKICAgICAgICAgICAgICAgIHRleHRBbGlnbjogImNlbnRlciIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICBmaWx0ZXIgPT09ICJhbGwiID8gIkFsbCIgOiBmaWx0ZXIgPT09ICJjb25maXJtZWRfc3Vic2NyaXB0aW9uIiA/ICJTdWJzY3JpcHRpb25zIiA6IGZpbHRlciA9PT0gImFwcHJvdmVkIiA/ICJBcHByb3ZlZCIgOiBmaWx0ZXIgPT09ICJub3Rfc3Vic2NyaXB0aW9uIiA/ICJOb3QgU3Vic2NyaXB0aW9ucyIgOiAiRG9uJ3QgS25vdyIsCiAgICAgICAgICAgICAgICBmaWx0ZXIgIT09ICJhbGwiICYmIGNvdW50ID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBtYXJnaW5MZWZ0OiA2LCBvcGFjaXR5OiAwLjcsIGZvbnRTaXplOiAxMiB9LCBjaGlsZHJlbjogY291bnQgfSkKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZpbHRlcgogICAgICAgICAgKTsKICAgICAgICB9KSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLCBnYXA6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBnZXRGaWx0ZXJlZFN1YnNjcmlwdGlvbnMoKS5tYXAoKHN1YiwgaW5kZXgpID0+IHN1Yi5zdGF0dXMgPT09ICJjb25maXJtZWRfc3Vic2NyaXB0aW9uIiB8fCBzdWIuc3RhdHVzID09PSAia2VlcGluZyIgfHwgc3ViLnN0YXR1cyA9PT0gImNhbmNlbGxpbmciID8gKAogICAgICAgICAgICAvLyBTaW1wbGlmaWVkIFJvdyBmb3IgQ29uZmlybWVkIFN1YnNjcmlwdGlvbnMKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgICAgICAgICAgICBwYWRkaW5nOiAiMTZweCAyNHB4IiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgYm94U2hhZG93OiAiMCAxcHggMnB4IHJnYmEoMCwwLDAsMC4wMikiCiAgICAgICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxNiwgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250V2VpZ2h0OiA1MDAsIGZvbnRTaXplOiAxNCwgbWluV2lkdGg6IDIwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgIGluZGV4ICsgMSwKICAgICAgICAgICAgICAgICAgIi4iCiAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGZvbnRTaXplOiAxNiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogc3ViLnNlcnZpY2UgfSkKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMjQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgZm9udFNpemU6IDE1LCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgICAgKHN1Yi5tb250aGx5Q29zdCAqIDEyKS50b0ZpeGVkKDApLAogICAgICAgICAgICAgICAgICAiL3lyIgogICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiAxMiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiByZW1vdmVTdWJzY3JpcHRpb24oc3ViLmlkKSwKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjhweCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjRkVFMkUyIiwKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICIjRUY0NDQ0IiwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjJzIgogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAiRGVsZXRlIiwKICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRyYXNoMiwgeyBzaXplOiAxNiB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB1cGRhdGVTdGF0dXMoc3ViLmlkLCAia2VlcGluZyIpLAogICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIiNmM2Y0ZjYiLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiM0YjU1NjMiLAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMnMiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICJNYXJrIGFzIGFwcHJvdmVkIiwKICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENoZWNrLCB7IHNpemU6IDE4IH0pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVN0YXR1cyhzdWIuaWQsICJjYW5jZWxsaW5nIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKGBodHRwczovL3d3dy5nb29nbGUuY29tL3NlYXJjaD9xPWhvdytkbytpK2NhbmNlbCtteStzdWJzY3JpcHRpb24rdG8rJHtzdWIuc2VydmljZX1gLCAiX2JsYW5rIik7CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiNnB4IDEycHgiLAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxMywKICAgICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgICAgIkNhbmNlbCAiLAogICAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFycm93UmlnaHQsIHsgc2l6ZTogMTQgfSkKICAgICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSwgc3ViLmlkKQogICAgICAgICAgKSA6ICgKICAgICAgICAgICAgLy8gRGV0YWlsZWQgQ2FyZCBmb3IgSW52ZXN0aWdhdGlvbgogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgICAgIHBhZGRpbmc6IDI0LAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICBib3hTaGFkb3c6ICIwIDJweCA0cHggcmdiYSgwLDAsMCwwLjAyKSIsCiAgICAgICAgICAgICAgbWFyZ2luQm90dG9tOiAxNgogICAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMTAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiByZW1vdmVTdWJzY3JpcHRpb24oc3ViLmlkKSwKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjZweCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjRkVFMkUyIiwKICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICIjRUY0NDQ0IiwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjJzIiwKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luUmlnaHQ6IDQKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogIkRlbGV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUcmFzaDIsIHsgc2l6ZTogMTQgfSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogODAwLCBmb250U2l6ZTogMTYsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAiMC41cHgiLCBjb2xvcjogIiMxMTEiIH0sIGNoaWxkcmVuOiBzdWIuc2VydmljZSB9KSwKICAgICAgICAgICAgICAgICAgc3ViLmNvdW50ICYmIHN1Yi5jb3VudCA+IDEgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjRTVFN0VCIiwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiMzNzQxNTEiLAogICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxMiwKICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjJweCA4cHgiLAogICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTIKICAgICAgICAgICAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAieCIsCiAgICAgICAgICAgICAgICAgICAgc3ViLmNvdW50CiAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA4MDAsIGZvbnRTaXplOiAxNiwgY29sb3I6ICIjMTExIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICAgIHN1Yi5tb250aGx5Q29zdC50b0ZpeGVkKDApLAogICAgICAgICAgICAgICAgICAiL21vbnRobHkiCiAgICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6ICIjNEI1NTYzIiwgbWFyZ2luQm90dG9tOiA0LCBmb250RmFtaWx5OiAibW9ub3NwYWNlIiB9LCBjaGlsZHJlbjogc3ViLm9yaWdpbmFsRGVzY3JpcHRpb24gfHwgc3ViLnNlcnZpY2UgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiAiIzZCNzI4MCIsIGZvbnRTdHlsZTogIml0YWxpYyIsIG1hcmdpbkJvdHRvbTogMjAgfSwgY2hpbGRyZW46IHN1Yi5jbGVhbkRlc2NyaXB0aW9uIHx8IGAke3N1Yi5jYXRlZ29yeX0gc3Vic2NyaXB0aW9uYCB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gdXBkYXRlU3RhdHVzKHN1Yi5pZCwgImNvbmZpcm1lZF9zdWJzY3JpcHRpb24iKSwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjhweCAxNnB4IiwKICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICIjMjU2M0VCIiwKICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDE0LAogICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwLAogICAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImJhY2tncm91bmQgMC4ycyIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAiU3Vic2NyaXB0aW9uIgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB1cGRhdGVTdGF0dXMoc3ViLmlkLCAibm90X3N1YnNjcmlwdGlvbiIpLAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IDE2cHgiLAogICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAiMXB4IHNvbGlkICNEMUQ1REIiLAogICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHN1Yi5zdGF0dXMgPT09ICJub3Rfc3Vic2NyaXB0aW9uIiA/ICIjRjNGNEY2IiA6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiMzNzQxNTEiLAogICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDE0LAogICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogIk5vdCBhIHN1YnNjcmlwdGlvbiIKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gdXBkYXRlU3RhdHVzKHN1Yi5pZCwgInVua25vd24iKSwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjhweCAxNnB4IiwKICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogIjFweCBzb2xpZCAjRDFENURCIiwKICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBzdWIuc3RhdHVzID09PSAidW5rbm93biIgPyAiI0YzRjRGNiIgOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICIjMzc0MTUxIiwKICAgICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxNCwKICAgICAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDUwMAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46ICJEb24ndCBrbm93IgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0sIHN1Yi5pZCkKICAgICAgICAgICkpLAogICAgICAgICAgZ2V0RmlsdGVyZWRTdWJzY3JpcHRpb25zKCkubGVuZ3RoID09PSAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6IDQwLCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiAiXHV7MUY5Mzd9XHUyMDBEXHUyNjQyXHVGRTBGIiB9KSwKICAgICAgICAgICAgIk5vIHN1YnNjcmlwdGlvbnMgZm91bmQgaW4gdGhpcyBjYXRlZ29yeS4iLAogICAgICAgICAgICBwcm9maWxlLmZpbGVUeXBlID09PSAicGRmIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDIwLCBwYWRkaW5nOiAxMCwgYmFja2dyb3VuZDogIiNmNWY1ZjUiLCBib3JkZXJSYWRpdXM6IDgsIGZvbnRTaXplOiAxMSwgdGV4dEFsaWduOiAibGVmdCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiAiRGVidWc6IFJhdyBUZXh0IEV4dHJhY3RlZCIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicHJlIiwgeyBzdHlsZTogeyB3aGl0ZVNwYWNlOiAicHJlLXdyYXAiLCBtYXhIZWlnaHQ6IDEwMCwgb3ZlcmZsb3c6ICJhdXRvIiwgbWFyZ2luVG9wOiA1IH0sIGNoaWxkcmVuOiBwcm9maWxlLnBhcnNpbmdFcnJvciA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnJlZCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgIlx1MjZBMFx1RkUwRiBFcnJvcjogIiwKICAgICAgICAgICAgICAgIHByb2ZpbGUucGFyc2luZ0Vycm9yCiAgICAgICAgICAgICAgXSB9KSA6IHByb2ZpbGUuZXh0cmFjdGVkVGV4dCA/IHByb2ZpbGUuZXh0cmFjdGVkVGV4dCA6ICIoSWYgdGhpcyBhcmVhIGlzIGVtcHR5LCBQREYgcGFyc2luZyBmYWlsZWQgb3Igbm8gdGV4dCB3YXMgZm91bmQuIENoZWNrIHRoZSBjb25zb2xlIGZvciB3b3JrZXIgbG9hZCBlcnJvcnMuKSIgfSkKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEyLCBtYXJnaW5Ub3A6IDggfSwgY2hpbGRyZW46ICFzaG93TWFudWFsSW5wdXQgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0U2hvd01hbnVhbElucHV0KHRydWUpLCBzdHlsZTogewogICAgICAgICAgICAgIGZsZXg6IDEsCiAgICAgICAgICAgICAgcGFkZGluZzogIjE2cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IGRhc2hlZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGdhcDogOAogICAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGx1cywgeyBzaXplOiAxOCB9KSwKICAgICAgICAgICAgICAiIEFkZCBzdWJzY3JpcHRpb24gbWFudWFsbHkiCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldFByb2ZpbGUoKHApID0+ICh7IC4uLnAsIGFuYWx5c2lzQ29tcGxldGU6IGZhbHNlIH0pKSwgc3R5bGU6IHsKICAgICAgICAgICAgICBmbGV4OiAxLAogICAgICAgICAgICAgIHBhZGRpbmc6ICIxNnB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDE2LAogICAgICAgICAgICAgIGJvcmRlcjogYDFweCBkYXNoZWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICBnYXA6IDgKICAgICAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEZpbGVUZXh0LCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgICAgICIgQWRkIG1vcmUgZG9jdW1lbnRzIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogMjAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsIGJvcmRlclJhZGl1czogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA2MDAsIG1hcmdpbkJvdHRvbTogMTIgfSwgY2hpbGRyZW46ICJBZGQgU3Vic2NyaXB0aW9uIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogMTIsIG1hcmdpbkJvdHRvbTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJTZXJ2aWNlIE5hbWUgKGUuZy4gTmV0ZmxpeCkiLAogICAgICAgICAgICAgICAgICB2YWx1ZTogbWFudWFsU2VydmljZSwKICAgICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRNYW51YWxTZXJ2aWNlKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjEwcHggMTRweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBvdXRsaW5lOiAibm9uZSIgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiTW9udGhseSBDb3N0IChlLmcuIDE1Ljk5KSIsCiAgICAgICAgICAgICAgICAgIHZhbHVlOiBtYW51YWxDb3N0LAogICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldE1hbnVhbENvc3QoZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiMTBweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIG91dGxpbmU6ICJub25lIiB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBTVUJTQ1JJUFRJT05fQ0FURUdPUklFUy5zbGljZSgwLCA0KS5tYXAoKGNhdCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRNYW51YWxDYXRlZ29yeShjYXQpLCBzdHlsZTogewogICAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTJweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAyMCwKICAgICAgICAgICAgICBmb250U2l6ZTogMTIsCiAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBtYW51YWxDYXRlZ29yeSA9PT0gY2F0ID8gQ09MT1JTLnRleHRNYWluIDogIndoaXRlIiwKICAgICAgICAgICAgICBjb2xvcjogbWFudWFsQ2F0ZWdvcnkgPT09IGNhdCA/ICJ3aGl0ZSIgOiBDT0xPUlMudGV4dE1haW4KICAgICAgICAgICAgfSwgY2hpbGRyZW46IGNhdCB9LCBjYXQpKSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogImZsZXgtZW5kIiwgZ2FwOiA4LCBtYXJnaW5Ub3A6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TWFudWFsSW5wdXQoZmFsc2UpLCBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE2cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGN1cnNvcjogInBvaW50ZXIiIH0sIGNoaWxkcmVuOiAiQ2FuY2VsIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGFkZE1hbnVhbFN1YnNjcmlwdGlvbiwgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwgY29sb3I6ICJ3aGl0ZSIsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJBZGQgU3Vic2NyaXB0aW9uIiB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICApLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDYwLCBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIHBhZGRpbmdUb3A6IDMyLCBwYWRkaW5nQm90dG9tOiAyMCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZmxleFdyYXA6ICJ3cmFwIiwgZ2FwOiAyMCB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMjQgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gIm1haWx0bzpoZWxsb0BqdXN0Y2FuY2VsLmlvIiwgc3R5bGU6IHsgYmFja2dyb3VuZDogIm5vbmUiLCBib3JkZXI6ICJub25lIiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTQsIGN1cnNvcjogInBvaW50ZXIiLCBwYWRkaW5nOiAwIH0sIGNoaWxkcmVuOiAiRmVlZGJhY2siIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gd2luZG93Lm9wZW4oImh0dHBzOi8vZ2l0aHViLmNvbS9qaHQyNDMvanVzdF9jYW5jZWwiLCAiX2JsYW5rIiksIHN0eWxlOiB7IGJhY2tncm91bmQ6ICJub25lIiwgYm9yZGVyOiAibm9uZSIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDE0LCBjdXJzb3I6ICJwb2ludGVyIiwgcGFkZGluZzogMCB9LCBjaGlsZHJlbjogIlNvdXJjZSBDb2RlIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IHJlc2V0QW5hbHlzaXMsIHN0eWxlOiB7IGJhY2tncm91bmQ6ICJub25lIiwgYm9yZGVyOiAibm9uZSIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDE0LCBjdXJzb3I6ICJwb2ludGVyIiwgcGFkZGluZzogMCB9LCBjaGlsZHJlbjogIlJlZnJlc2ggRGF0YSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBhbGVydCgiRG9uYXRpb25zIGNvbWluZyBzb29uISIpLCBzdHlsZTogeyBiYWNrZ3JvdW5kOiAibm9uZSIsIGJvcmRlcjogIm5vbmUiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxNCwgY3Vyc29yOiAicG9pbnRlciIsIHBhZGRpbmc6IDAgfSwgY2hpbGRyZW46ICJEb25hdGUiIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgIlx4QTkgIiwKICAgICAgICAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLmdldEZ1bGxZZWFyKCksCiAgICAgICAgIiBKdXN0IENhbmNlbC4gTG9jYWwtZmlyc3QgcHJpdmFjeS4iCiAgICAgIF0gfSkKICAgIF0gfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGAKICAgICAgICBAa2V5ZnJhbWVzIGZhZGVJbiB7IGZyb20geyBvcGFjaXR5OiAwOyB9IHRvIHsgb3BhY2l0eTogMTsgfSB9CiAgICAgICAgQGtleWZyYW1lcyBzbGlkZVVwIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgyMHB4KTsgb3BhY2l0eTogMDsgfSB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfSB9CiAgICAgIGAgfSkKICBdIH0pOwp9CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZTIgPSBfX3RvRVNNKHJlcXVpcmVfanN4X3J1bnRpbWUoKSwgMSk7CnZhciBFcnJvckJvdW5kYXJ5ID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3Q0LmRlZmF1bHQuQ29tcG9uZW50IHsKICBjb25zdHJ1Y3Rvcihwcm9wcykgewogICAgc3VwZXIocHJvcHMpOwogICAgdGhpcy5zdGF0ZSA9IHsgaGFzRXJyb3I6IGZhbHNlIH07CiAgfQogIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IpIHsKICAgIHJldHVybiB7IGhhc0Vycm9yOiB0cnVlLCBlcnJvciB9OwogIH0KICBjb21wb25lbnREaWRDYXRjaChlcnJvciwgZXJyb3JJbmZvKSB7CiAgICBjb25zb2xlLmVycm9yKCJXaWRnZXQgRXJyb3IgQm91bmRhcnkgY2F1Z2h0IGVycm9yOiIsIGVycm9yLCBlcnJvckluZm8pOwogICAgdHJ5IHsKICAgICAgZmV0Y2goIi9hcGkvdHJhY2siLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZXZlbnQ6ICJjcmFzaCIsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGVycm9yOiBlcnJvcj8ubWVzc2FnZSB8fCAiVW5rbm93biBlcnJvciIsCiAgICAgICAgICAgIHN0YWNrOiBlcnJvcj8uc3RhY2ssCiAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8/LmNvbXBvbmVudFN0YWNrCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goKGUpID0+IGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byByZXBvcnQgY3Jhc2giLCBlKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLnN0YXRlLmhhc0Vycm9yKSB7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogMjAsIHRleHRBbGlnbjogImNlbnRlciIsIGZvbnRGYW1pbHk6ICJzYW5zLXNlcmlmIiwgY29sb3I6ICIjREMyNjI2Iiwgd29yZEJyZWFrOiAiYnJlYWstd29yZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IGNoaWxkcmVuOiAiU29tZXRoaW5nIHdlbnQgd3JvbmcuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgicCIsIHsgY2hpbGRyZW46ICJQbGVhc2UgdHJ5IHJlZnJlc2hpbmcgdGhlIHBhZ2UuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRldGFpbHMiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMTAsIHRleHRBbGlnbjogImxlZnQiLCBmb250U2l6ZTogIjEycHgiLCBjb2xvcjogIiM2NjYiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3VtbWFyeSIsIHsgY2hpbGRyZW46ICJEZWJ1ZyBFcnJvciBEZXRhaWxzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgicHJlIiwgeyBzdHlsZTogeyB3aGl0ZVNwYWNlOiAicHJlLXdyYXAiLCBiYWNrZ3JvdW5kOiAiI2Y1ZjVmNSIsIHBhZGRpbmc6IDEwLCBib3JkZXJSYWRpdXM6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgdGhpcy5zdGF0ZS5lcnJvcj8udG9TdHJpbmcoKSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJyIiwge30pLAogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy5zdGFjawogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuOwogIH0KfTsKdmFyIGdldEh5ZHJhdGlvbkRhdGEgPSAoKSA9PiB7CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFN0YXJ0aW5nIGh5ZHJhdGlvbiBjaGVjay4uLiIpOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFdpbmRvdyBpcyB1bmRlZmluZWQiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc3Qgb2EgPSB3aW5kb3cub3BlbmFpOwogIGlmICghb2EpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSB3aW5kb3cub3BlbmFpIG5vdCBmb3VuZCwgcmVuZGVyaW5nIHdpdGggZGVmYXVsdHMiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgZm91bmQ6IiwgT2JqZWN0LmtleXMob2EpKTsKICBjb25zdCBjYW5kaWRhdGVzID0gWwogICAgb2EudG9vbE91dHB1dCwKICAgIG9hLnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCwKICAgIG9hLnRvb2xJbnB1dAogIF07CiAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIEZvdW5kIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgIH0KICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIE5vIGRhdGEgZm91bmQgaW4gYW55IGNhbmRpZGF0ZSBzb3VyY2UiKTsKICByZXR1cm4ge307Cn07CmNvbnNvbGUubG9nKCJbTWFpbl0gSnVzdCBDYW5jZWwgbWFpbi50c3ggbG9hZGluZy4uLiIpOwpmdW5jdGlvbiBBcHAoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoSnVzdENhbmNlbCwgeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pOwp9CnZhciBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgianVzdC1jYW5jZWwtcm9vdCIpIHx8IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0cmF2ZWwtY2hlY2tsaXN0LXJvb3QiKTsKaWYgKCFjb250YWluZXIpIHsKICB0aHJvdyBuZXcgRXJyb3IoImp1c3QtY2FuY2VsLXJvb3QgZWxlbWVudCBub3QgZm91bmQiKTsKfQp2YXIgcm9vdCA9ICgwLCBpbXBvcnRfY2xpZW50LmNyZWF0ZVJvb3QpKGNvbnRhaW5lcik7CnZhciByZW5kZXJBcHAgPSAoZGF0YSkgPT4gewogIHJvb3QucmVuZGVyKAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoaW1wb3J0X3JlYWN0NC5kZWZhdWx0LlN0cmljdE1vZGUsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEVycm9yQm91bmRhcnksIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEFwcCwgeyBpbml0aWFsRGF0YTogZGF0YSB9LCBEYXRlLm5vdygpKSB9KSB9KQogICk7Cn07CnZhciBpbml0aWFsRGF0YSA9IGdldEh5ZHJhdGlvbkRhdGEoKTsKcmVuZGVyQXBwKGluaXRpYWxEYXRhKTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm9wZW5haTpzZXRfZ2xvYmFscyIsIChldikgPT4gewogIGNvbnN0IGdsb2JhbHMgPSBldj8uZGV0YWlsPy5nbG9iYWxzOwogIGlmIChnbG9iYWxzKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTGF0ZSBldmVudCByZWNlaXZlZDoiLCBnbG9iYWxzKTsKICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICAgIGdsb2JhbHMudG9vbE91dHB1dCwKICAgICAgZ2xvYmFscy5zdHJ1Y3R1cmVkQ29udGVudCwKICAgICAgZ2xvYmFscy5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnRvb2xJbnB1dAogICAgXTsKICAgIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHsKICAgICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gUmUtcmVuZGVyaW5nIHdpdGggbGF0ZSBkYXRhOiIsIGNhbmRpZGF0ZSk7CiAgICAgICAgcmVuZGVyQXBwKGNhbmRpZGF0ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQp9KTsKLyohIEJ1bmRsZWQgbGljZW5zZSBpbmZvcm1hdGlvbjoKCnJlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnNjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKICAoKioKICAgKiBDaGVja3MgaWYgYW4gZXZlbnQgaXMgc3VwcG9ydGVkIGluIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBlbnZpcm9ubWVudC4KICAgKgogICAqIE5PVEU6IFRoaXMgd2lsbCBub3Qgd29yayBjb3JyZWN0bHkgZm9yIG5vbi1nZW5lcmljIGV2ZW50cyBzdWNoIGFzIGBjaGFuZ2VgLAogICAqIGByZXNldGAsIGBsb2FkYCwgYGVycm9yYCwgYW5kIGBzZWxlY3RgLgogICAqCiAgICogQm9ycm93cyBmcm9tIE1vZGVybml6ci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVTdWZmaXggRXZlbnQgbmFtZSwgZS5nLiAiY2xpY2siLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZC4KICAgKiBAaW50ZXJuYWwKICAgKiBAbGljZW5zZSBNb2Rlcm5penIgMy4wLjBwcmUgKEN1c3RvbSBCdWlsZCkgfCBNSVQKICAgKikKCnJlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Fycm93LXJpZ2h0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9kb2xsYXItc2lnbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2ZpbGUtdGV4dC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3Blbi1saW5lLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGx1cy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlZnJlc2gtY3cuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yb3RhdGUtY2N3LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2hpZWxkLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJhc2gtMi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3VwbG9hZC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2x1Y2lkZS1yZWFjdC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoqLwo=";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[Just Cancel] Failed to load:', err);
          const root = document.getElementById('just-cancel-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load subscription analyzer</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>

</html>