<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Just Cancel — Find and cancel unwanted subscriptions</title>
  <meta name="description"
    content="A local-first, privacy-focused tool to scan your bank statements and identify recurring subscriptions you no longer need." />
  <meta property="og:title" content="Just Cancel — Stop paying for what you don't use" />
  <meta property="og:description"
    content="Scan your bank statements safely and locally to find and cancel unwanted subscriptions." />
  <meta name="keywords"
    content="cancel subscriptions, subscription manager, financial health, saving money, bank statement scanner" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #FAFAFA;
      color: #1A1A1A;
      -webkit-font-smoothing: antialiased;
    }

    #just-cancel-root {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    @media print {
      .no-print {
        display: none !important;
      }

      body {
        background: white;
      }
    }
  </style>
</head>

<body>
  <div id="just-cancel-root"></div>
  <!-- 
      Load script via import() to avoid HTML parser issues with inline code
    -->






















































































  
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fY29weVByb3BzID0gKHRvLCBmcm9tLCBleGNlcHQsIGRlc2MpID0+IHsKICBpZiAoZnJvbSAmJiB0eXBlb2YgZnJvbSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20gPT09ICJmdW5jdGlvbiIpIHsKICAgIGZvciAobGV0IGtleSBvZiBfX2dldE93blByb3BOYW1lcyhmcm9tKSkKICAgICAgaWYgKCFfX2hhc093blByb3AuY2FsbCh0bywga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8sIGtleSwgeyBnZXQ6ICgpID0+IGZyb21ba2V5XSwgZW51bWVyYWJsZTogIShkZXNjID0gX19nZXRPd25Qcm9wRGVzYyhmcm9tLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzsKfTsKdmFyIF9fdG9FU00gPSAobW9kLCBpc05vZGVNb2RlLCB0YXJnZXQpID0+ICh0YXJnZXQgPSBtb2QgIT0gbnVsbCA/IF9fY3JlYXRlKF9fZ2V0UHJvdG9PZihtb2QpKSA6IHt9LCBfX2NvcHlQcm9wcygKICAvLyBJZiB0aGUgaW1wb3J0ZXIgaXMgaW4gbm9kZSBjb21wYXRpYmlsaXR5IG1vZGUgb3IgdGhpcyBpcyBub3QgYW4gRVNNCiAgLy8gZmlsZSB0aGF0IGhhcyBiZWVuIGNvbnZlcnRlZCB0byBhIENvbW1vbkpTIGZpbGUgdXNpbmcgYSBCYWJlbC0KICAvLyBjb21wYXRpYmxlIHRyYW5zZm9ybSAoaS5lLiAiX19lc01vZHVsZSIgaGFzIG5vdCBiZWVuIHNldCksIHRoZW4gc2V0CiAgLy8gImRlZmF1bHQiIHRvIHRoZSBDb21tb25KUyAibW9kdWxlLmV4cG9ydHMiIGZvciBub2RlIGNvbXBhdGliaWxpdHkuCiAgaXNOb2RlTW9kZSB8fCAhbW9kIHx8ICFtb2QuX19lc01vZHVsZSA/IF9fZGVmUHJvcCh0YXJnZXQsICJkZWZhdWx0IiwgeyB2YWx1ZTogbW9kLCBlbnVtZXJhYmxlOiB0cnVlIH0pIDogdGFyZ2V0LAogIG1vZAopKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFZlcnNpb24gPSAiMTguMy4xIjsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSB7CiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSB7CiAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgIGlzQmF0Y2hpbmdMZWdhY3k6IGZhbHNlLAogICAgICAgICAgZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZSA9IGZ1bmN0aW9uKHN0YWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gIiI7CiAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gY3VycmVudEV4dHJhU3RhY2tGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICBpZiAoaW1wbCkgewogICAgICAgICAgICAgIHN0YWNrICs9IGltcGwoKSB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLAogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMihmb3JtYXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoIndhcm4iLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0LCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdCArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50ID0ge307CiAgICAgICAgZnVuY3Rpb24gd2Fybk5vb3AocHVibGljSW5zdGFuY2UsIGNhbGxlck5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9jb25zdHJ1Y3RvciA9IHB1YmxpY0luc3RhbmNlLmNvbnN0cnVjdG9yOwogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IF9jb25zdHJ1Y3RvciAmJiAoX2NvbnN0cnVjdG9yLmRpc3BsYXlOYW1lIHx8IF9jb25zdHJ1Y3Rvci5uYW1lKSB8fCAiUmVhY3RDbGFzcyI7CiAgICAgICAgICAgIHZhciB3YXJuaW5nS2V5ID0gY29tcG9uZW50TmFtZSArICIuIiArIGNhbGxlck5hbWU7CiAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXJyb3IoIkNhbid0IGNhbGwgJXMgb24gYSBjb21wb25lbnQgdGhhdCBpcyBub3QgeWV0IG1vdW50ZWQuIFRoaXMgaXMgYSBuby1vcCwgYnV0IGl0IG1pZ2h0IGluZGljYXRlIGEgYnVnIGluIHlvdXIgYXBwbGljYXRpb24uIEluc3RlYWQsIGFzc2lnbiB0byBgdGhpcy5zdGF0ZWAgZGlyZWN0bHkgb3IgZGVmaW5lIGEgYHN0YXRlID0ge307YCBjbGFzcyBwcm9wZXJ0eSB3aXRoIHRoZSBkZXNpcmVkIHN0YXRlIGluIHRoZSAlcyBjb21wb25lbnQuIiwgY2FsbGVyTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudFt3YXJuaW5nS2V5XSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdE5vb3BVcGRhdGVRdWV1ZSA9IHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQ2hlY2tzIHdoZXRoZXIgb3Igbm90IHRoaXMgY29tcG9zaXRlIGNvbXBvbmVudCBpcyBtb3VudGVkLgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2Ugd2Ugd2FudCB0byB0ZXN0LgogICAgICAgICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBtb3VudGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgKiBAcHJvdGVjdGVkCiAgICAgICAgICAgKiBAZmluYWwKICAgICAgICAgICAqLwogICAgICAgICAgaXNNb3VudGVkOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBGb3JjZXMgYW4gdXBkYXRlLiBUaGlzIHNob3VsZCBvbmx5IGJlIGludm9rZWQgd2hlbiBpdCBpcyBrbm93biB3aXRoCiAgICAgICAgICAgKiBjZXJ0YWludHkgdGhhdCB3ZSBhcmUgKipub3QqKiBpbiBhIERPTSB0cmFuc2FjdGlvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBZb3UgbWF5IHdhbnQgdG8gY2FsbCB0aGlzIHdoZW4geW91IGtub3cgdGhhdCBzb21lIGRlZXBlciBhc3BlY3Qgb2YgdGhlCiAgICAgICAgICAgKiBjb21wb25lbnQncyBzdGF0ZSBoYXMgY2hhbmdlZCBidXQgYHNldFN0YXRlYCB3YXMgbm90IGNhbGxlZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGlzIHdpbGwgbm90IGludm9rZSBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCwgYnV0IGl0IHdpbGwgaW52b2tlCiAgICAgICAgICAgKiBgY29tcG9uZW50V2lsbFVwZGF0ZWAgYW5kIGBjb21wb25lbnREaWRVcGRhdGVgLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVGb3JjZVVwZGF0ZTogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFJlcGxhY2VzIGFsbCBvZiB0aGUgc3RhdGUuIEFsd2F5cyB1c2UgdGhpcyBvciBgc2V0U3RhdGVgIHRvIG11dGF0ZSBzdGF0ZS4KICAgICAgICAgICAqIFlvdSBzaG91bGQgdHJlYXQgYHRoaXMuc3RhdGVgIGFzIGltbXV0YWJsZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGVyZSBpcyBubyBndWFyYW50ZWUgdGhhdCBgdGhpcy5zdGF0ZWAgd2lsbCBiZSBpbW1lZGlhdGVseSB1cGRhdGVkLCBzbwogICAgICAgICAgICogYWNjZXNzaW5nIGB0aGlzLnN0YXRlYCBhZnRlciBjYWxsaW5nIHRoaXMgbWV0aG9kIG1heSByZXR1cm4gdGhlIG9sZCB2YWx1ZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb21wbGV0ZVN0YXRlIE5leHQgc3RhdGUuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBjYWxsZXJOYW1lIG5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UsIGNvbXBsZXRlU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBTZXRzIGEgc3Vic2V0IG9mIHRoZSBzdGF0ZS4gVGhpcyBvbmx5IGV4aXN0cyBiZWNhdXNlIF9wZW5kaW5nU3RhdGUgaXMKICAgICAgICAgICAqIGludGVybmFsLiBUaGlzIHByb3ZpZGVzIGEgbWVyZ2luZyBzdHJhdGVneSB0aGF0IGlzIG5vdCBhdmFpbGFibGUgdG8gZGVlcAogICAgICAgICAgICogcHJvcGVydGllcyB3aGljaCBpcyBjb25mdXNpbmcuIFRPRE86IEV4cG9zZSBwZW5kaW5nU3RhdGUgb3IgZG9uJ3QgdXNlIGl0CiAgICAgICAgICAgKiBkdXJpbmcgdGhlIG1lcmdlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHBhcnRpYWxTdGF0ZSBOZXh0IHBhcnRpYWwgc3RhdGUgdG8gYmUgbWVyZ2VkIHdpdGggc3RhdGUuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBOYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVTZXRTdGF0ZTogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJzZXRTdGF0ZSIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIGFzc2lnbiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGVtcHR5T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eU9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIENvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50ID0ge307CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uKHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAiZnVuY3Rpb24iICYmIHBhcnRpYWxTdGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0U3RhdGUoLi4uKTogdGFrZXMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcyB0byB1cGRhdGUgb3IgYSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFuIG9iamVjdCBvZiBzdGF0ZSB2YXJpYWJsZXMuIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKHRoaXMsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5mb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZUZvcmNlVXBkYXRlKHRoaXMsIGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBkZXByZWNhdGVkQVBJcyA9IHsKICAgICAgICAgICAgaXNNb3VudGVkOiBbImlzTW91bnRlZCIsICJJbnN0ZWFkLCBtYWtlIHN1cmUgdG8gY2xlYW4gdXAgc3Vic2NyaXB0aW9ucyBhbmQgcGVuZGluZyByZXF1ZXN0cyBpbiBjb21wb25lbnRXaWxsVW5tb3VudCB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4iXSwKICAgICAgICAgICAgcmVwbGFjZVN0YXRlOiBbInJlcGxhY2VTdGF0ZSIsICJSZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIHNldFN0YXRlIGluc3RlYWQgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzLzMyMzYpLiJdCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyA9IGZ1bmN0aW9uKG1ldGhvZE5hbWUsIGluZm8yKSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShDb21wb25lbnQucHJvdG90eXBlLCBtZXRob2ROYW1lLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdhcm4yKCIlcyguLi4pIGlzIGRlcHJlY2F0ZWQgaW4gcGxhaW4gSmF2YVNjcmlwdCBSZWFjdCBjbGFzc2VzLiAlcyIsIGluZm8yWzBdLCBpbmZvMlsxXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgZm9yICh2YXIgZm5OYW1lIGluIGRlcHJlY2F0ZWRBUElzKSB7CiAgICAgICAgICAgIGlmIChkZXByZWNhdGVkQVBJcy5oYXNPd25Qcm9wZXJ0eShmbk5hbWUpKSB7CiAgICAgICAgICAgICAgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nKGZuTmFtZSwgZGVwcmVjYXRlZEFQSXNbZm5OYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50RHVtbXkoKSB7CiAgICAgICAgfQogICAgICAgIENvbXBvbmVudER1bW15LnByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgZnVuY3Rpb24gUHVyZUNvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1cmVDb21wb25lbnRQcm90b3R5cGUgPSBQdXJlQ29tcG9uZW50LnByb3RvdHlwZSA9IG5ldyBDb21wb25lbnREdW1teSgpOwogICAgICAgIHB1cmVDb21wb25lbnRQcm90b3R5cGUuY29uc3RydWN0b3IgPSBQdXJlQ29tcG9uZW50OwogICAgICAgIGFzc2lnbihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBPYmplY3Quc2VhbChyZWZPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5KGEpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duLCBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biwgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYGtleWAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ0tleSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nUmVmLmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcucmVmID09PSAic3RyaW5nIiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50ICYmIGNvbmZpZy5fX3NlbGYgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IGNvbmZpZy5fX3NlbGYpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBUaGlzIGNhc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uLiBXZSBhc2sgeW91IHRvIG1hbnVhbGx5IGZpeCB0aGlzIGNhc2UgYnkgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGNvbXBvbmVudE5hbWUsIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc291cmNlIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQzKHR5cGUsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgIHZhciBzZWxmID0gbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBudWxsOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZiA9IGNvbmZpZy5fX3NlbGYgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zZWxmOwogICAgICAgICAgICBzb3VyY2UgPSBjb25maWcuX19zb3VyY2UgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zb3VyY2U7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGNoaWxkQXJyYXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gdHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoa2V5IHx8IHJlZikgewogICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgIlVua25vd24iIDogdHlwZTsKICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVmKSB7CiAgICAgICAgICAgICAgICBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZiwgc291cmNlLCBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lQW5kUmVwbGFjZUtleShvbGRFbGVtZW50LCBuZXdLZXkpIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gUmVhY3RFbGVtZW50KG9sZEVsZW1lbnQudHlwZSwgbmV3S2V5LCBvbGRFbGVtZW50LnJlZiwgb2xkRWxlbWVudC5fc2VsZiwgb2xkRWxlbWVudC5fc291cmNlLCBvbGRFbGVtZW50Ll9vd25lciwgb2xkRWxlbWVudC5wcm9wcyk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50KGVsZW1lbnQsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8IGVsZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LmNsb25lRWxlbWVudCguLi4pOiBUaGUgYXJndW1lbnQgbXVzdCBiZSBhIFJlYWN0IGVsZW1lbnQsIGJ1dCB5b3UgcGFzc2VkICIgKyBlbGVtZW50ICsgIi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbih7fSwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICB2YXIgc2VsZiA9IGVsZW1lbnQuX3NlbGY7CiAgICAgICAgICB2YXIgc291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIG93bmVyID0gUmVhY3RDdXJyZW50T3duZXIuY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlICYmIGVsZW1lbnQudHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgICBkZWZhdWx0UHJvcHMgPSBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgaWYgKGNvbmZpZ1twcm9wTmFtZV0gPT09IHZvaWQgMCAmJiBkZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudChlbGVtZW50LnR5cGUsIGtleSwgcmVmLCBzZWxmLCBzb3VyY2UsIG93bmVyLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50KG9iamVjdCkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiICYmIG9iamVjdCAhPT0gbnVsbCAmJiBvYmplY3QuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRTsKICAgICAgICB9CiAgICAgICAgdmFyIFNFUEFSQVRPUiA9ICIuIjsKICAgICAgICB2YXIgU1VCU0VQQVJBVE9SID0gIjoiOwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZTIoa2V5KSB7CiAgICAgICAgICB2YXIgZXNjYXBlUmVnZXggPSAvWz06XS9nOwogICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICI9IjogIj0wIiwKICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVzY2FwZWRTdHJpbmcgPSBrZXkucmVwbGFjZShlc2NhcGVSZWdleCwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIGVzY2FwZXJMb29rdXBbbWF0Y2hdOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gIiQiICsgZXNjYXBlZFN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXggPSAvXC8rL2c7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEtleShlbGVtZW50LCBpbmRleCkgewogICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAib2JqZWN0IiAmJiBlbGVtZW50ICE9PSBudWxsICYmIGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlc2NhcGUyKCIiICsgZWxlbWVudC5rZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZGV4LnRvU3RyaW5nKDM2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwSW50b0FycmF5KGNoaWxkcmVuLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmFtZVNvRmFyLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgY2hpbGRyZW47CiAgICAgICAgICBpZiAodHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIGNoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnZva2VDYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7CiAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkcmVuLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGludm9rZUNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfY2hpbGQgPSBjaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG1hcHBlZENoaWxkID0gY2FsbGJhY2soX2NoaWxkKTsKICAgICAgICAgICAgdmFyIGNoaWxkS2V5ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiArIGdldEVsZW1lbnRLZXkoX2NoaWxkLCAwKSA6IG5hbWVTb0ZhcjsKICAgICAgICAgICAgaWYgKGlzQXJyYXkobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgdmFyIGVzY2FwZWRDaGlsZEtleSA9ICIiOwogICAgICAgICAgICAgIGlmIChjaGlsZEtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlc2NhcGVkQ2hpbGRLZXkgPSBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoY2hpbGRLZXkpICsgIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXBJbnRvQXJyYXkobWFwcGVkQ2hpbGQsIGFycmF5LCBlc2NhcGVkQ2hpbGRLZXksICIiLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXBwZWRDaGlsZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50KG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1hcHBlZENoaWxkLmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkID0gY2xvbmVBbmRSZXBsYWNlS2V5KAogICAgICAgICAgICAgICAgICBtYXBwZWRDaGlsZCwKICAgICAgICAgICAgICAgICAgLy8gS2VlcCBib3RoIHRoZSAobWFwcGVkKSBhbmQgb2xkIGtleXMgaWYgdGhleSBkaWZmZXIsIGp1c3QgYXMKICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2VBbGxDaGlsZHJlbiB1c2VkIHRvIGRvIGZvciBvYmplY3RzIGFzIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgIGVzY2FwZWRQcmVmaXggKyAvLyAkRmxvd0ZpeE1lIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFJlYWN0LlBvcnRhbCBkb2Vzbid0IGhhdmUgYSBrZXkKICAgICAgICAgICAgICAgICAgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpID8gKAogICAgICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgZXhpc3RpbmcgZWxlbWVudCdzIGtleSBjYW4gYmUgYSBudW1iZXIKICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaW50ZXJuYWwvc2FmZS1zdHJpbmctY29lcmNpb24KICAgICAgICAgICAgICAgICAgICBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoIiIgKyBtYXBwZWRDaGlsZC5rZXkpICsgIi8iCiAgICAgICAgICAgICAgICAgICkgOiAiIikgKyBjaGlsZEtleQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJyYXkucHVzaChtYXBwZWRDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICB2YXIgbmV4dE5hbWU7CiAgICAgICAgICB2YXIgc3VidHJlZUNvdW50ID0gMDsKICAgICAgICAgIHZhciBuZXh0TmFtZVByZWZpeCA9IG5hbWVTb0ZhciA9PT0gIiIgPyBTRVBBUkFUT1IgOiBuYW1lU29GYXIgKyBTVUJTRVBBUkFUT1I7CiAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGkpOwogICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmFibGVDaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuID09PSBpdGVyYWJsZUNoaWxkcmVuLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNYXBzKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjIoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGl0ZXJhYmxlQ2hpbGRyZW4pOwogICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgIHZhciBpaSA9IDA7CiAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgY2hpbGQgPSBzdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGlpKyspOwogICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuU3RyaW5nID0gU3RyaW5nKGNoaWxkcmVuKTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZHJlblN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNoaWxkcmVuKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRyZW5TdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1YnRyZWVDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIHJlc3VsdCwgIiIsICIiLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGNoaWxkLCBjb3VudCsrKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY291bnRDaGlsZHJlbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIG4gPSAwOwogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBuKys7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JFYWNoQ2hpbGRyZW4oY2hpbGRyZW4sIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCkgewogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3JFYWNoRnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZm9yRWFjaENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0b0FycmF5KGNoaWxkcmVuKSB7CiAgICAgICAgICByZXR1cm4gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbmx5Q2hpbGQoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnQoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuQ2hpbGRyZW4ub25seSBleHBlY3RlZCB0byByZWNlaXZlIGEgc2luZ2xlIFJlYWN0IGVsZW1lbnQgY2hpbGQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbnRleHQoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgLy8gQXMgYSB3b3JrYXJvdW5kIHRvIHN1cHBvcnQgbXVsdGlwbGUgY29uY3VycmVudCByZW5kZXJlcnMsIHdlIGNhdGVnb3JpemUKICAgICAgICAgICAgLy8gc29tZSByZW5kZXJlcnMgYXMgcHJpbWFyeSBhbmQgb3RoZXJzIGFzIHNlY29uZGFyeS4gV2Ugb25seSBleHBlY3QKICAgICAgICAgICAgLy8gdGhlcmUgdG8gYmUgdHdvIGNvbmN1cnJlbnQgcmVuZGVyZXJzIGF0IG1vc3Q6IFJlYWN0IE5hdGl2ZSAocHJpbWFyeSkgYW5kCiAgICAgICAgICAgIC8vIEZhYnJpYyAoc2Vjb25kYXJ5KTsgUmVhY3QgRE9NIChwcmltYXJ5KSBhbmQgUmVhY3QgQVJUIChzZWNvbmRhcnkpLgogICAgICAgICAgICAvLyBTZWNvbmRhcnkgcmVuZGVyZXJzIHN0b3JlIHRoZWlyIGNvbnRleHQgdmFsdWVzIG9uIHNlcGFyYXRlIGZpZWxkcy4KICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICBfY3VycmVudFZhbHVlMjogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICAvLyBVc2VkIHRvIHRyYWNrIGhvdyBtYW55IGNvbmN1cnJlbnQgcmVuZGVyZXJzIHRoaXMgY29udGV4dCBjdXJyZW50bHkKICAgICAgICAgICAgLy8gc3VwcG9ydHMgd2l0aGluIGluIGEgc2luZ2xlIHJlbmRlcmVyLiBTdWNoIGFzIHBhcmFsbGVsIHNlcnZlciByZW5kZXJpbmcuCiAgICAgICAgICAgIF90aHJlYWRDb3VudDogMCwKICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGNpcmN1bGFyCiAgICAgICAgICAgIFByb3ZpZGVyOiBudWxsLAogICAgICAgICAgICBDb25zdW1lcjogbnVsbCwKICAgICAgICAgICAgLy8gQWRkIHRoZXNlIHRvIHVzZSBzYW1lIGhpZGRlbiBjbGFzcyBpbiBWTSBhcyBTZXJ2ZXJDb250ZXh0CiAgICAgICAgICAgIF9kZWZhdWx0VmFsdWU6IG51bGwsCiAgICAgICAgICAgIF9nbG9iYWxOYW1lOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgY29udGV4dC5Qcm92aWRlciA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BST1ZJREVSX1RZUEUsCiAgICAgICAgICAgIF9jb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgQ29uc3VtZXIgPSB7CiAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDb25zdW1lciwgewogICAgICAgICAgICAgIFByb3ZpZGVyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQuQ29uc3VtZXIuUHJvdmlkZXI+IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LlByb3ZpZGVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LlByb3ZpZGVyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX1Byb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSBfUHJvdmlkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfY3VycmVudFZhbHVlOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZSkgewogICAgICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBfY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlMiA9IF9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX3RocmVhZENvdW50OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfdGhyZWFkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fdGhyZWFkQ291bnQgPSBfdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBDb25zdW1lcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycykgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLkNvbnN1bWVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Db25zdW1lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5kaXNwbGF5TmFtZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuMigiU2V0dGluZyBgZGlzcGxheU5hbWVgIG9uIENvbnRleHQuQ29uc3VtZXIgaGFzIG5vIGVmZmVjdC4gWW91IHNob3VsZCBzZXQgaXQgZGlyZWN0bHkgb24gdGhlIGNvbnRleHQgd2l0aCBDb250ZXh0LmRpc3BsYXlOYW1lID0gJyVzJy4iLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29udGV4dC5Db25zdW1lciA9IENvbnN1bWVyOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSBudWxsOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIyID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgIH0KICAgICAgICB2YXIgVW5pbml0aWFsaXplZCA9IC0xOwogICAgICAgIHZhciBQZW5kaW5nID0gMDsKICAgICAgICB2YXIgUmVzb2x2ZWQgPSAxOwogICAgICAgIHZhciBSZWplY3RlZCA9IDI7CiAgICAgICAgZnVuY3Rpb24gbGF6eUluaXRpYWxpemVyKHBheWxvYWQpIHsKICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgdmFyIGN0b3IgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IGN0b3IoKTsKICAgICAgICAgICAgdGhlbmFibGUudGhlbihmdW5jdGlvbihtb2R1bGVPYmplY3QyKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUGVuZGluZyB8fCBwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fc3RhdHVzID0gUmVzb2x2ZWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fcmVzdWx0ID0gbW9kdWxlT2JqZWN0MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVqZWN0ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3N0YXR1cyA9IFJlamVjdGVkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3Jlc3VsdCA9IGVycm9yMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBwYXlsb2FkOwogICAgICAgICAgICAgIHBlbmRpbmcuX3N0YXR1cyA9IFBlbmRpbmc7CiAgICAgICAgICAgICAgcGVuZGluZy5fcmVzdWx0ID0gdGhlbmFibGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFJlc29sdmVkKSB7CiAgICAgICAgICAgIHZhciBtb2R1bGVPYmplY3QgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobW9kdWxlT2JqZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSlcblxuRGlkIHlvdSBhY2NpZGVudGFsbHkgcHV0IGN1cmx5IGJyYWNlcyBhcm91bmQgdGhlIGltcG9ydD8iLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCEoImRlZmF1bHQiIGluIG1vZHVsZU9iamVjdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSkiLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kdWxlT2JqZWN0LmRlZmF1bHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhenkoY3RvcikgewogICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgIC8vIFdlIHVzZSB0aGVzZSBmaWVsZHMgdG8gc3RvcmUgdGhlIHJlc3VsdC4KICAgICAgICAgICAgX3N0YXR1czogVW5pbml0aWFsaXplZCwKICAgICAgICAgICAgX3Jlc3VsdDogY3RvcgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBsYXp5VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0xBWllfVFlQRSwKICAgICAgICAgICAgX3BheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgIF9pbml0OiBsYXp5SW5pdGlhbGl6ZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGxhenlUeXBlLCB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3RGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5sYXp5KC4uLik6IEl0IGlzIG5vdCBzdXBwb3J0ZWQgdG8gYXNzaWduIGBkZWZhdWx0UHJvcHNgIHRvIGEgbGF6eSBjb21wb25lbnQgaW1wb3J0LiBFaXRoZXIgc3BlY2lmeSB0aGVtIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgZGVmaW5lZCwgb3IgY3JlYXRlIGEgd3JhcHBpbmcgY29tcG9uZW50IGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gbmV3RGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJkZWZhdWx0UHJvcHMiLCB7CiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHByb3BUeXBlczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb3BUeXBlczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld1Byb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgcHJvcFR5cGVzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIHByb3BUeXBlcyA9IG5ld1Byb3BUeXBlczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAicHJvcFR5cGVzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXp5VHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yd2FyZFJlZjMocmVuZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCAmJiByZW5kZXIuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSkgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCByZWNlaXZlZCBhIGBtZW1vYCBjb21wb25lbnQuIEluc3RlYWQgb2YgZm9yd2FyZFJlZihtZW1vKC4uLikpLCB1c2UgbWVtbyhmb3J3YXJkUmVmKC4uLikpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgd2FzIGdpdmVuICVzLiIsIHJlbmRlciA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiByZW5kZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgYWNjZXB0IGV4YWN0bHkgdHdvIHBhcmFtZXRlcnM6IHByb3BzIGFuZCByZWYuICVzIiwgcmVuZGVyLmxlbmd0aCA9PT0gMSA/ICJEaWQgeW91IGZvcmdldCB0byB1c2UgdGhlIHJlZiBwYXJhbWV0ZXI/IiA6ICJBbnkgYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSB1bmRlZmluZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChyZW5kZXIuZGVmYXVsdFByb3BzICE9IG51bGwgfHwgcmVuZGVyLnByb3BUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFLAogICAgICAgICAgICByZW5kZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghcmVuZGVyLm5hbWUgJiYgIXJlbmRlci5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICByZW5kZXIuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gVGhpcyBuZWVkcyB0byBpbmNsdWRlIGFsbCBwb3NzaWJsZSBtb2R1bGUgcmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICAvLyB0eXBlcyBzdXBwb3J0ZWQgYnkgYW55IEZsaWdodCBjb25maWd1cmF0aW9uIGFueXdoZXJlIHNpbmNlCiAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAvLyB3aXRoLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFIHx8IHR5cGUuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lbW8odHlwZSwgY29tcGFyZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSkgewogICAgICAgICAgICAgIGVycm9yKCJtZW1vOiBUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIGNvbXBvbmVudC4gSW5zdGVhZCByZWNlaXZlZDogJXMiLCB0eXBlID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9NRU1PX1RZUEUsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGNvbXBhcmU6IGNvbXBhcmUgPT09IHZvaWQgMCA/IG51bGwgOiBjb21wYXJlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXR5cGUubmFtZSAmJiAhdHlwZS5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICB0eXBlLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlRGlzcGF0Y2hlcigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlQ29udGV4dChDb250ZXh0KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb250ZXh0Ll9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgcmVhbENvbnRleHQgPSBDb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICAgIGlmIChyZWFsQ29udGV4dC5Db25zdW1lciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LkNvbnN1bWVyKSBpcyBub3Qgc3VwcG9ydGVkLCBtYXkgY2F1c2UgYnVncywgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFsQ29udGV4dC5Qcm92aWRlciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LlByb3ZpZGVyKSBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDb250ZXh0KENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTdGF0ZTIoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZjIoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRWZmZWN0MihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZU1lbW8yKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VUcmFuc2l0aW9uKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJZCgpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUlkKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgfQogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHguc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudDIpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQyLnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhcyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB5b3VyIGNvZGUgYXQgIiArIGZpbGVOYW1lICsgIjoiICsgbGluZU51bWJlciArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhlbGVtZW50UHJvcHMpIHsKICAgICAgICAgIGlmIChlbGVtZW50UHJvcHMgIT09IG51bGwgJiYgZWxlbWVudFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKGVsZW1lbnRQcm9wcy5fX3NvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpIHsKICAgICAgICAgIHZhciBpbmZvMiA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgaWYgKCFpbmZvMikgewogICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5hbWUpIHsKICAgICAgICAgICAgICBpbmZvMiA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5mbzI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQobm9kZSkpIHsKICAgICAgICAgICAgaWYgKG5vZGUuX3N0b3JlKSB7CiAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChub2RlKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKGl0ZXJhdG9yRm4gIT09IG5vZGUuZW50cmllcykgewogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICB3aGlsZSAoIShzdGVwID0gaXRlcmF0b3IubmV4dCgpKS5kb25lKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoc3RlcC52YWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSk7CiAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICBpbmZvMiArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhwcm9wcyk7CiAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgaW5mbzIgKz0gc291cmNlSW5mbzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbmZvMiArPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdHlwZVN0cmluZzsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkodHlwZSkpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgaW5mbzIgPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5jcmVhdGVFbGVtZW50OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbzIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGFyZ3VtZW50c1tpXSwgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbih0eXBlKSB7CiAgICAgICAgICB2YXIgdmFsaWRhdGVkRmFjdG9yeSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbi5iaW5kKG51bGwsIHR5cGUpOwogICAgICAgICAgdmFsaWRhdGVkRmFjdG9yeS50eXBlID0gdHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gdHJ1ZTsKICAgICAgICAgICAgICB3YXJuMigiUmVhY3QuY3JlYXRlRmFjdG9yeSgpIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBDb25zaWRlciB1c2luZyBKU1ggb3IgdXNlIFJlYWN0LmNyZWF0ZUVsZW1lbnQoKSBkaXJlY3RseSBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh2YWxpZGF0ZWRGYWN0b3J5LCAidHlwZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgd2FybjIoIkZhY3RvcnkudHlwZSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdGhlIGNsYXNzIGRpcmVjdGx5IGJlZm9yZSBwYXNzaW5nIGl0IHRvIGNyZWF0ZUZhY3RvcnkuIik7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgInR5cGUiLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiB0eXBlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsaWRhdGVkRmFjdG9yeTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVFbGVtZW50V2l0aFZhbGlkYXRpb24oZWxlbWVudCwgcHJvcHMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IGNsb25lRWxlbWVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCBuZXdFbGVtZW50LnR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMobmV3RWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzY29wZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSBmYWxzZTsKICAgICAgICB2YXIgZW5xdWV1ZVRhc2tJbXBsID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVGFzayh0YXNrKSB7CiAgICAgICAgICBpZiAoZW5xdWV1ZVRhc2tJbXBsID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIHJlcXVpcmVTdHJpbmcgPSAoInJlcXVpcmUiICsgTWF0aC5yYW5kb20oKSkuc2xpY2UoMCwgNyk7CiAgICAgICAgICAgICAgdmFyIG5vZGVSZXF1aXJlID0gbW9kdWxlICYmIG1vZHVsZVtyZXF1aXJlU3RyaW5nXTsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBub2RlUmVxdWlyZS5jYWxsKG1vZHVsZSwgInRpbWVycyIpLnNldEltbWVkaWF0ZTsKICAgICAgICAgICAgfSBjYXRjaCAoX2VycikgewogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3QgaGF2ZSBhIE1lc3NhZ2VDaGFubmVsIGltcGxlbWVudGF0aW9uLCBzbyBlbnF1ZXVpbmcgdGFza3MgdmlhIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pIHdpbGwgZmFpbC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUgYXQgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3VlcyBpZiB5b3UgZW5jb3VudGVyIHRoaXMgd2FybmluZy4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh2b2lkIDApOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnF1ZXVlVGFza0ltcGwodGFzayk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RTY29wZURlcHRoID0gMDsKICAgICAgICB2YXIgZGlkV2Fybk5vQXdhaXRBY3QgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBhY3QoY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByZXZBY3RTY29wZURlcHRoID0gYWN0U2NvcGVEZXB0aDsKICAgICAgICAgICAgYWN0U2NvcGVEZXB0aCsrOwogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldklzQmF0Y2hpbmdMZWdhY3kgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSB0cnVlOwogICAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgaWYgKCFwcmV2SXNCYXRjaGluZ0xlZ2FjeSAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSkgewogICAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5kaWRTY2hlZHVsZUxlZ2FjeVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHByZXZJc0JhdGNoaW5nTGVnYWN5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgICAgIHZhciB3YXNBd2FpdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIHRoZW5hYmxlID0gewogICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgIHdhc0F3YWl0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGVuYWJsZVJlc3VsdC50aGVuKGZ1bmN0aW9uKHJldHVyblZhbHVlMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZTIsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5Ob0F3YWl0QWN0ICYmIHR5cGVvZiBQcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghd2FzQXdhaXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2Fybk5vQXdhaXRBY3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBjYWxsZWQgYWN0KGFzeW5jICgpID0+IC4uLikgd2l0aG91dCBhd2FpdC4gVGhpcyBjb3VsZCBsZWFkIHRvIHVuZXhwZWN0ZWQgdGVzdGluZyBiZWhhdmlvdXIsIGludGVybGVhdmluZyBtdWx0aXBsZSBhY3QgY2FsbHMgYW5kIG1peGluZyB0aGVpciBzY29wZXMuIFlvdSBzaG91bGQgLSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKTsiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhlbmFibGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlID0gcmVzdWx0OwogICAgICAgICAgICAgIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKTsKICAgICAgICAgICAgICBpZiAoYWN0U2NvcGVEZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIF9xdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoX3F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUoX3F1ZXVlKTsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIF90aGVuYWJsZTIgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcmV0dXJuIF90aGVuYWJsZTI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEFjdFNjb3BlKHByZXZBY3RTY29wZURlcHRoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmV2QWN0U2NvcGVEZXB0aCAhPT0gYWN0U2NvcGVEZXB0aCAtIDEpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHNlZW0gdG8gaGF2ZSBvdmVybGFwcGluZyBhY3QoKSBjYWxscywgdGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBCZSBzdXJlIHRvIGF3YWl0IHByZXZpb3VzIGFjdCgpIGNhbGxzIGJlZm9yZSBtYWtpbmcgYSBuZXcgb25lLiAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhY3RTY29wZURlcHRoID0gcHJldkFjdFNjb3BlRGVwdGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlVGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmx1c2hBY3RRdWV1ZShxdWV1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmx1c2hpbmcpIHsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKHRydWUpOwogICAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgcXVldWUgPSBxdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUVsZW1lbnQkMSA9IGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY2xvbmVFbGVtZW50JDEgPSBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3RvcnlXaXRoVmFsaWRhdGlvbjsKICAgICAgICB2YXIgQ2hpbGRyZW4gPSB7CiAgICAgICAgICBtYXA6IG1hcENoaWxkcmVuLAogICAgICAgICAgZm9yRWFjaDogZm9yRWFjaENoaWxkcmVuLAogICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICB0b0FycmF5LAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW47CiAgICAgICAgZXhwb3J0cy5Db21wb25lbnQgPSBDb21wb25lbnQ7CiAgICAgICAgZXhwb3J0cy5GcmFnbWVudCA9IFJFQUNUX0ZSQUdNRU5UX1RZUEU7CiAgICAgICAgZXhwb3J0cy5Qcm9maWxlciA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgZXhwb3J0cy5QdXJlQ29tcG9uZW50ID0gUHVyZUNvbXBvbmVudDsKICAgICAgICBleHBvcnRzLlN0cmljdE1vZGUgPSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOwogICAgICAgIGV4cG9ydHMuU3VzcGVuc2UgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgIGV4cG9ydHMuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQgPSBSZWFjdFNoYXJlZEludGVybmFsczsKICAgICAgICBleHBvcnRzLmFjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLmNsb25lRWxlbWVudCA9IGNsb25lRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlQ29udGV4dCA9IGNyZWF0ZUNvbnRleHQ7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRmFjdG9yeSA9IGNyZWF0ZUZhY3Rvcnk7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVSZWYgPSBjcmVhdGVSZWY7CiAgICAgICAgZXhwb3J0cy5mb3J3YXJkUmVmID0gZm9yd2FyZFJlZjM7CiAgICAgICAgZXhwb3J0cy5pc1ZhbGlkRWxlbWVudCA9IGlzVmFsaWRFbGVtZW50OwogICAgICAgIGV4cG9ydHMubGF6eSA9IGxhenk7CiAgICAgICAgZXhwb3J0cy5tZW1vID0gbWVtbzsKICAgICAgICBleHBvcnRzLnN0YXJ0VHJhbnNpdGlvbiA9IHN0YXJ0VHJhbnNpdGlvbjsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2FjdCA9IGFjdDsKICAgICAgICBleHBvcnRzLnVzZUNhbGxiYWNrID0gdXNlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDsKICAgICAgICBleHBvcnRzLnVzZURlYnVnVmFsdWUgPSB1c2VEZWJ1Z1ZhbHVlOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QyOwogICAgICAgIGV4cG9ydHMudXNlSWQgPSB1c2VJZDsKICAgICAgICBleHBvcnRzLnVzZUltcGVyYXRpdmVIYW5kbGUgPSB1c2VJbXBlcmF0aXZlSGFuZGxlOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTWVtbyA9IHVzZU1lbW8yOwogICAgICAgIGV4cG9ydHMudXNlUmVkdWNlciA9IHVzZVJlZHVjZXI7CiAgICAgICAgZXhwb3J0cy51c2VSZWYgPSB1c2VSZWYyOwogICAgICAgIGV4cG9ydHMudXNlU3RhdGUgPSB1c2VTdGF0ZTI7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlOwogICAgICAgIGV4cG9ydHMudXNlVHJhbnNpdGlvbiA9IHVzZVRyYW5zaXRpb247CiAgICAgICAgZXhwb3J0cy52ZXJzaW9uID0gUmVhY3RWZXJzaW9uOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9zY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9zY2hlZHVsZXJfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY2hlZHVsZXJEZWJ1Z2dpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlUHJvZmlsaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGZyYW1lWWllbGRNcyA9IDU7CiAgICAgICAgZnVuY3Rpb24gcHVzaChoZWFwLCBub2RlKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBoZWFwLmxlbmd0aDsKICAgICAgICAgIGhlYXAucHVzaChub2RlKTsKICAgICAgICAgIHNpZnRVcChoZWFwLCBub2RlLCBpbmRleCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlZWsoaGVhcCkgewogICAgICAgICAgcmV0dXJuIGhlYXAubGVuZ3RoID09PSAwID8gbnVsbCA6IGhlYXBbMF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChoZWFwKSB7CiAgICAgICAgICBpZiAoaGVhcC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3QgPSBoZWFwWzBdOwogICAgICAgICAgdmFyIGxhc3QgPSBoZWFwLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QgIT09IGZpcnN0KSB7CiAgICAgICAgICAgIGhlYXBbMF0gPSBsYXN0OwogICAgICAgICAgICBzaWZ0RG93bihoZWFwLCBsYXN0LCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdFVwKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4IC0gMSA+Pj4gMTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShwYXJlbnQsIG5vZGUpID4gMCkgewogICAgICAgICAgICAgIGhlYXBbcGFyZW50SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHBhcmVudDsKICAgICAgICAgICAgICBpbmRleCA9IHBhcmVudEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0RG93bihoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgdmFyIGhhbGZMZW5ndGggPSBsZW5ndGggPj4+IDE7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBoYWxmTGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0SW5kZXggPSAoaW5kZXggKyAxKSAqIDIgLSAxOwogICAgICAgICAgICB2YXIgbGVmdCA9IGhlYXBbbGVmdEluZGV4XTsKICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBoZWFwW3JpZ2h0SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShsZWZ0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBsZWZ0OwogICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbGVmdEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICAgICAgICAgIHZhciBkaWZmID0gYS5zb3J0SW5kZXggLSBiLnNvcnRJbmRleDsKICAgICAgICAgIHJldHVybiBkaWZmICE9PSAwID8gZGlmZiA6IGEuaWQgLSBiLmlkOwogICAgICAgIH0KICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSAxOwogICAgICAgIHZhciBVc2VyQmxvY2tpbmdQcmlvcml0eSA9IDI7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSA0OwogICAgICAgIHZhciBJZGxlUHJpb3JpdHkgPSA1OwogICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrLCBtcykgewogICAgICAgIH0KICAgICAgICB2YXIgaGFzUGVyZm9ybWFuY2VOb3cgPSB0eXBlb2YgcGVyZm9ybWFuY2UgPT09ICJvYmplY3QiICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgaWYgKGhhc1BlcmZvcm1hbmNlTm93KSB7CiAgICAgICAgICB2YXIgbG9jYWxQZXJmb3JtYW5jZSA9IHBlcmZvcm1hbmNlOwogICAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGxvY2FsUGVyZm9ybWFuY2Uubm93KCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgbG9jYWxEYXRlID0gRGF0ZTsKICAgICAgICAgIHZhciBpbml0aWFsVGltZSA9IGxvY2FsRGF0ZS5ub3coKTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUubm93KCkgLSBpbml0aWFsVGltZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBtYXhTaWduZWQzMUJpdEludCA9IDEwNzM3NDE4MjM7CiAgICAgICAgdmFyIElNTUVESUFURV9QUklPUklUWV9USU1FT1VUID0gLTE7CiAgICAgICAgdmFyIFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVCA9IDI1MDsKICAgICAgICB2YXIgTk9STUFMX1BSSU9SSVRZX1RJTUVPVVQgPSA1ZTM7CiAgICAgICAgdmFyIExPV19QUklPUklUWV9USU1FT1VUID0gMWU0OwogICAgICAgIHZhciBJRExFX1BSSU9SSVRZX1RJTUVPVVQgPSBtYXhTaWduZWQzMUJpdEludDsKICAgICAgICB2YXIgdGFza1F1ZXVlID0gW107CiAgICAgICAgdmFyIHRpbWVyUXVldWUgPSBbXTsKICAgICAgICB2YXIgdGFza0lkQ291bnRlciA9IDE7CiAgICAgICAgdmFyIGN1cnJlbnRUYXNrID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGxvY2FsU2V0VGltZW91dCA9IHR5cGVvZiBzZXRUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gc2V0VGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsQ2xlYXJUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IG51bGw7CiAgICAgICAgdmFyIGxvY2FsU2V0SW1tZWRpYXRlID0gdHlwZW9mIHNldEltbWVkaWF0ZSAhPT0gInVuZGVmaW5lZCIgPyBzZXRJbW1lZGlhdGUgOiBudWxsOwogICAgICAgIHZhciBpc0lucHV0UGVuZGluZyA9IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nICE9PSB2b2lkIDAgJiYgbmF2aWdhdG9yLnNjaGVkdWxpbmcuaXNJbnB1dFBlbmRpbmcgIT09IHZvaWQgMCA/IG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nLmJpbmQobmF2aWdhdG9yLnNjaGVkdWxpbmcpIDogbnVsbDsKICAgICAgICBmdW5jdGlvbiBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgdGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgd2hpbGUgKHRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0aW1lci5jYWxsYmFjayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aW1lci5zdGFydFRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICBwb3AodGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgdGltZXIuc29ydEluZGV4ID0gdGltZXIuZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIHRpbWVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lb3V0KGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaWYgKHBlZWsodGFza1F1ZXVlKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgIGlmIChmaXJzdFRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgZmlyc3RUaW1lci5zdGFydFRpbWUgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoV29yayhoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxpbmcpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGFzayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgICAgICBtYXJrVGFza0Vycm9yZWQoY3VycmVudFRhc2ssIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgY3VycmVudFRhc2suaXNRdWV1ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGluaXRpYWxUaW1lMjsKICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrKHRhc2tRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRhc2sgIT09IG51bGwgJiYgIWVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZykgewogICAgICAgICAgICBpZiAoY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPiBjdXJyZW50VGltZSAmJiAoIWhhc1RpbWVSZW1haW5pbmcgfHwgc2hvdWxkWWllbGRUb0hvc3QoKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjdXJyZW50VGFzay5jYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRUYXNrLnByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgY29udGludWF0aW9uQ2FsbGJhY2sgPSBjYWxsYmFjayhkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0KTsKICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBjb250aW51YXRpb25DYWxsYmFjazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrKHRhc2tRdWV1ZSkpIHsKICAgICAgICAgICAgICAgICAgcG9wKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gcGVlayh0YXNrUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrKHRpbWVyUXVldWUpOwogICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eShwcmlvcml0eUxldmVsLCBldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHZhciBwcmlvcml0eUxldmVsOwogICAgICAgICAgc3dpdGNoIChjdXJyZW50UHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfd3JhcENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgIHZhciBzdGFydFRpbWUyOwogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAib2JqZWN0IiAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiICYmIGRlbGF5ID4gMCkgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZSArIGRlbGF5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElETEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gTE9XX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGltZW91dCA9IE5PUk1BTF9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gc3RhcnRUaW1lMiArIHRpbWVvdXQ7CiAgICAgICAgICB2YXIgbmV3VGFzayA9IHsKICAgICAgICAgICAgaWQ6IHRhc2tJZENvdW50ZXIrKywKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lMiwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgIHNvcnRJbmRleDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gc3RhcnRUaW1lMjsKICAgICAgICAgICAgcHVzaCh0aW1lclF1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKHBlZWsodGFza1F1ZXVlKSA9PT0gbnVsbCAmJiBuZXdUYXNrID09PSBwZWVrKHRpbWVyUXVldWUpKSB7CiAgICAgICAgICAgICAgaWYgKGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQpIHsKICAgICAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgc3RhcnRUaW1lMiAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIG5ld1Rhc2spOwogICAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkICYmICFpc1BlcmZvcm1pbmdXb3JrKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ld1Rhc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uKCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbigpIHsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlKCkgewogICAgICAgICAgcmV0dXJuIHBlZWsodGFza1F1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sodGFzaykgewogICAgICAgICAgdGFzay5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB2YXIgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIHZhciBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgIHZhciBzdGFydFRpbWUgPSAtMTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRZaWVsZFRvSG9zdCgpIHsKICAgICAgICAgIHZhciB0aW1lRWxhcHNlZCA9IGV4cG9ydHMudW5zdGFibGVfbm93KCkgLSBzdGFydFRpbWU7CiAgICAgICAgICBpZiAodGltZUVsYXBzZWQgPCBmcmFtZUludGVydmFsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UGFpbnQoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlRnJhbWVSYXRlKGZwcykgewogICAgICAgICAgaWYgKGZwcyA8IDAgfHwgZnBzID4gMTI1KSB7CiAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oImZvcmNlRnJhbWVSYXRlIHRha2VzIGEgcG9zaXRpdmUgaW50IGJldHdlZW4gMCBhbmQgMTI1LCBmb3JjaW5nIGZyYW1lIHJhdGVzIGhpZ2hlciB0aGFuIDEyNSBmcHMgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZnBzID4gMCkgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gTWF0aC5mbG9vcigxZTMgLyBmcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNjaGVkdWxlZEhvc3RDYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICBzdGFydFRpbWUgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgdmFyIGhhc1RpbWVSZW1haW5pbmcgPSB0cnVlOwogICAgICAgICAgICB2YXIgaGFzTW9yZVdvcmsgPSB0cnVlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGhhc01vcmVXb3JrID0gc2NoZWR1bGVkSG9zdENhbGxiYWNrKGhhc1RpbWVSZW1haW5pbmcsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAoaGFzTW9yZVdvcmspIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICBpZiAodHlwZW9mIGxvY2FsU2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldEltbWVkaWF0ZShwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICB2YXIgcG9ydCA9IGNoYW5uZWwucG9ydDI7CiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvcnQucG9zdE1lc3NhZ2UobnVsbCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldFRpbWVvdXQocGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0Q2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgaWYgKCFpc01lc3NhZ2VMb29wUnVubmluZykgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0VGltZW91dChjYWxsYmFjaywgbXMpIHsKICAgICAgICAgIHRhc2tUaW1lb3V0SUQgPSBsb2NhbFNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGV4cG9ydHMudW5zdGFibGVfbm93KCkpOwogICAgICAgICAgfSwgbXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxIb3N0VGltZW91dCgpIHsKICAgICAgICAgIGxvY2FsQ2xlYXJUaW1lb3V0KHRhc2tUaW1lb3V0SUQpOwogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zdGFibGVfcmVxdWVzdFBhaW50ID0gcmVxdWVzdFBhaW50OwogICAgICAgIHZhciB1bnN0YWJsZV9Qcm9maWxpbmcgPSBudWxsOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSWRsZVByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0xvd1ByaW9yaXR5ID0gTG93UHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfUHJvZmlsaW5nID0gdW5zdGFibGVfUHJvZmlsaW5nOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NhbmNlbENhbGxiYWNrID0gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZm9yY2VGcmFtZVJhdGUgPSBmb3JjZUZyYW1lUmF0ZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsID0gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZSA9IHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfbmV4dCA9IHVuc3RhYmxlX25leHQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9wYXVzZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVxdWVzdFBhaW50ID0gdW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcnVuV2l0aFByaW9yaXR5ID0gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayA9IHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zaG91bGRZaWVsZCA9IHNob3VsZFlpZWxkVG9Ib3N0OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfd3JhcENhbGxiYWNrID0gdW5zdGFibGVfd3JhcENhbGxiYWNrOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcwp2YXIgcmVxdWlyZV9zY2hlZHVsZXIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QtZG9tL2Nqcy9yZWFjdC1kb20uZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZG9tX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3QzID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0My5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKICAgICAgICB2YXIgc3VwcHJlc3NXYXJuaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2V0U3VwcHJlc3NXYXJuaW5nKG5ld1N1cHByZXNzV2FybmluZykgewogICAgICAgICAgewogICAgICAgICAgICBzdXBwcmVzc1dhcm5pbmcgPSBuZXdTdXBwcmVzc1dhcm5pbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm4yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoIndhcm4iLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXN1cHByZXNzV2FybmluZykgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdCwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0KTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIEZ1bmN0aW9uQ29tcG9uZW50ID0gMDsKICAgICAgICB2YXIgQ2xhc3NDb21wb25lbnQgPSAxOwogICAgICAgIHZhciBJbmRldGVybWluYXRlQ29tcG9uZW50ID0gMjsKICAgICAgICB2YXIgSG9zdFJvb3QgPSAzOwogICAgICAgIHZhciBIb3N0UG9ydGFsID0gNDsKICAgICAgICB2YXIgSG9zdENvbXBvbmVudCA9IDU7CiAgICAgICAgdmFyIEhvc3RUZXh0ID0gNjsKICAgICAgICB2YXIgRnJhZ21lbnQyID0gNzsKICAgICAgICB2YXIgTW9kZSA9IDg7CiAgICAgICAgdmFyIENvbnRleHRDb25zdW1lciA9IDk7CiAgICAgICAgdmFyIENvbnRleHRQcm92aWRlciA9IDEwOwogICAgICAgIHZhciBGb3J3YXJkUmVmID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00gPSAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgYXR0cmlidXRlIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBhdHRyaWJ1dGVOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFN0cmluZ0NvZXJjaW9uKHZhbHVlLCBwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIHByb3AgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBDU1MgcHJvcGVydHkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHByb3BOYW1lLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIEhUTUwgbWFya3VwIHVzZXMgYSB2YWx1ZSBvZiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJGb3JtIGZpZWxkIHZhbHVlcyAodmFsdWUsIGNoZWNrZWQsIGRlZmF1bHRWYWx1ZSwgb3IgZGVmYXVsdENoZWNrZWQgcHJvcHMpIG11c3QgYmUgc3RyaW5ncywgbm90ICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVTRVJWRUQgPSAwOwogICAgICAgIHZhciBTVFJJTkcgPSAxOwogICAgICAgIHZhciBCT09MRUFOSVNIX1NUUklORyA9IDI7CiAgICAgICAgdmFyIEJPT0xFQU4gPSAzOwogICAgICAgIHZhciBPVkVSTE9BREVEX0JPT0xFQU4gPSA0OwogICAgICAgIHZhciBOVU1FUklDID0gNTsKICAgICAgICB2YXIgUE9TSVRJVkVfTlVNRVJJQyA9IDY7CiAgICAgICAgdmFyIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgPSAiOkEtWl9hLXpcXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9DSEFSID0gQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJcXC0uMC05XFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICAgICAgdmFyIFZBTElEX0FUVFJJQlVURV9OQU1FX1JFR0VYID0gbmV3IFJlZ0V4cCgiXlsiICsgQVRUUklCVVRFX05BTUVfU1RBUlRfQ0hBUiArICJdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciBpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlID0ge307CiAgICAgICAgdmFyIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGlzQXR0cmlidXRlTmFtZVNhZmUoYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsaWRhdGVkQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGUsIGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWC50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZVthdHRyaWJ1dGVOYW1lXSA9IHRydWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBuYW1lOiBgJXNgIiwgYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUubGVuZ3RoID4gMiAmJiAobmFtZVswXSA9PT0gIm8iIHx8IG5hbWVbMF0gPT09ICJPIikgJiYgKG5hbWVbMV0gPT09ICJuIiB8fCBuYW1lWzFdID09PSAiTiIpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICBjYXNlICJzeW1ib2wiOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBjYXNlICJib29sZWFuIjogewogICAgICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIXByb3BlcnR5SW5mby5hY2NlcHRzQm9vbGVhbnM7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBwcmVmaXgyID0gbmFtZS50b0xvd2VyQ2FzZSgpLnNsaWNlKDAsIDUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHByZWZpeDIgIT09ICJkYXRhLSIgJiYgcHJlZml4MiAhPT0gImFyaWEtIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgc3dpdGNoIChwcm9wZXJ0eUluZm8udHlwZSkgewogICAgICAgICAgICAgIGNhc2UgQk9PTEVBTjoKICAgICAgICAgICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSBPVkVSTE9BREVEX0JPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICAgIGNhc2UgTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSk7CiAgICAgICAgICAgICAgY2FzZSBQT1NJVElWRV9OVU1FUklDOgogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA8IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHJvcGVydHlJbmZvKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBwcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KG5hbWUpID8gcHJvcGVydGllc1tuYW1lXSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFByb3BlcnR5SW5mb1JlY29yZChuYW1lLCB0eXBlLCBtdXN0VXNlUHJvcGVydHksIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSwgc2FuaXRpemVVUkwyLCByZW1vdmVFbXB0eVN0cmluZykgewogICAgICAgICAgdGhpcy5hY2NlcHRzQm9vbGVhbnMgPSB0eXBlID09PSBCT09MRUFOSVNIX1NUUklORyB8fCB0eXBlID09PSBCT09MRUFOIHx8IHR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTjsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IGF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIHRoaXMubXVzdFVzZVByb3BlcnR5ID0gbXVzdFVzZVByb3BlcnR5OwogICAgICAgICAgdGhpcy5wcm9wZXJ0eU5hbWUgPSBuYW1lOwogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuc2FuaXRpemVVUkwgPSBzYW5pdGl6ZVVSTDI7CiAgICAgICAgICB0aGlzLnJlbW92ZUVtcHR5U3RyaW5nID0gcmVtb3ZlRW1wdHlTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJlc2VydmVkUHJvcHMgPSBbCiAgICAgICAgICAiY2hpbGRyZW4iLAogICAgICAgICAgImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIC8vIFRPRE86IFRoaXMgcHJldmVudHMgdGhlIGFzc2lnbm1lbnQgb2YgZGVmYXVsdFZhbHVlIHRvIHJlZ3VsYXIKICAgICAgICAgIC8vIGVsZW1lbnRzIChub3QganVzdCBpbnB1dHMpLiBOb3cgdGhhdCBSZWFjdERPTUlucHV0IGFzc2lnbnMgdG8gdGhlCiAgICAgICAgICAvLyBkZWZhdWx0VmFsdWUgcHJvcGVydHkgLS0gZG8gd2UgbmVlZCB0aGlzPwogICAgICAgICAgImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICAiZGVmYXVsdENoZWNrZWQiLAogICAgICAgICAgImlubmVySFRNTCIsCiAgICAgICAgICAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciLAogICAgICAgICAgInN0eWxlIgogICAgICAgIF07CiAgICAgICAgcmVzZXJ2ZWRQcm9wcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBSRVNFUlZFRCwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgW1siYWNjZXB0Q2hhcnNldCIsICJhY2NlcHQtY2hhcnNldCJdLCBbImNsYXNzTmFtZSIsICJjbGFzcyJdLCBbImh0bWxGb3IiLCAiZm9yIl0sIFsiaHR0cEVxdWl2IiwgImh0dHAtZXF1aXYiXV0uZm9yRWFjaChmdW5jdGlvbihfcmVmKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IF9yZWZbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmWzFdOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJjb250ZW50RWRpdGFibGUiLCAiZHJhZ2dhYmxlIiwgInNwZWxsQ2hlY2siLCAidmFsdWUiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbImF1dG9SZXZlcnNlIiwgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLCAiZm9jdXNhYmxlIiwgInByZXNlcnZlQWxwaGEiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOSVNIX1NUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICAiYXN5bmMiLAogICAgICAgICAgLy8gTm90ZTogdGhlcmUgaXMgYSBzcGVjaWFsIGNhc2UgdGhhdCBwcmV2ZW50cyBpdCBmcm9tIGJlaW5nIHdyaXR0ZW4gdG8gdGhlIERPTQogICAgICAgICAgLy8gb24gdGhlIGNsaWVudCBzaWRlIGJlY2F1c2UgdGhlIGJyb3dzZXJzIGFyZSBpbmNvbnNpc3RlbnQuIEluc3RlYWQgd2UgY2FsbCBmb2N1cygpLgogICAgICAgICAgImF1dG9Gb2N1cyIsCiAgICAgICAgICAiYXV0b1BsYXkiLAogICAgICAgICAgImNvbnRyb2xzIiwKICAgICAgICAgICJkZWZhdWx0IiwKICAgICAgICAgICJkZWZlciIsCiAgICAgICAgICAiZGlzYWJsZWQiLAogICAgICAgICAgImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgICJkaXNhYmxlUmVtb3RlUGxheWJhY2siLAogICAgICAgICAgImZvcm1Ob1ZhbGlkYXRlIiwKICAgICAgICAgICJoaWRkZW4iLAogICAgICAgICAgImxvb3AiLAogICAgICAgICAgIm5vTW9kdWxlIiwKICAgICAgICAgICJub1ZhbGlkYXRlIiwKICAgICAgICAgICJvcGVuIiwKICAgICAgICAgICJwbGF5c0lubGluZSIsCiAgICAgICAgICAicmVhZE9ubHkiLAogICAgICAgICAgInJlcXVpcmVkIiwKICAgICAgICAgICJyZXZlcnNlZCIsCiAgICAgICAgICAic2NvcGVkIiwKICAgICAgICAgICJzZWFtbGVzcyIsCiAgICAgICAgICAvLyBNaWNyb2RhdGEKICAgICAgICAgICJpdGVtU2NvcGUiCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBCT09MRUFOLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjaGVja2VkIiwKICAgICAgICAgIC8vIE5vdGU6IGBvcHRpb24uc2VsZWN0ZWRgIGlzIG5vdCB1cGRhdGVkIGlmIGBzZWxlY3QubXVsdGlwbGVgIGlzCiAgICAgICAgICAvLyBkaXNhYmxlZCB3aXRoIGByZW1vdmVBdHRyaWJ1dGVgLiBXZSBoYXZlIHNwZWNpYWwgbG9naWMgZm9yIGhhbmRsaW5nIHRoaXMuCiAgICAgICAgICAibXVsdGlwbGUiLAogICAgICAgICAgIm11dGVkIiwKICAgICAgICAgICJzZWxlY3RlZCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgdHJ1ZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2FwdHVyZSIsCiAgICAgICAgICAiZG93bmxvYWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE9WRVJMT0FERURfQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNvbHMiLAogICAgICAgICAgInJvd3MiLAogICAgICAgICAgInNpemUiLAogICAgICAgICAgInNwYW4iCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFBPU0lUSVZFX05VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsicm93U3BhbiIsICJzdGFydCJdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIE5VTUVSSUMsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIENBTUVMSVpFID0gL1tcLVw6XShbYS16XSkvZzsKICAgICAgICB2YXIgY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW5bMV0udG9VcHBlckNhc2UoKTsKICAgICAgICB9OwogICAgICAgIFsKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IiwKICAgICAgICAgICJhbGlnbm1lbnQtYmFzZWxpbmUiLAogICAgICAgICAgImFyYWJpYy1mb3JtIiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCIsCiAgICAgICAgICAiY2FwLWhlaWdodCIsCiAgICAgICAgICAiY2xpcC1wYXRoIiwKICAgICAgICAgICJjbGlwLXJ1bGUiLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24tZmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItcHJvZmlsZSIsCiAgICAgICAgICAiY29sb3ItcmVuZGVyaW5nIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSIsCiAgICAgICAgICAiZW5hYmxlLWJhY2tncm91bmQiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1ydWxlIiwKICAgICAgICAgICJmbG9vZC1jb2xvciIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSIsCiAgICAgICAgICAiZm9udC1mYW1pbHkiLAogICAgICAgICAgImZvbnQtc2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplLWFkanVzdCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIiwKICAgICAgICAgICJmb250LXN0eWxlIiwKICAgICAgICAgICJmb250LXZhcmlhbnQiLAogICAgICAgICAgImZvbnQtd2VpZ2h0IiwKICAgICAgICAgICJnbHlwaC1uYW1lIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi1ob3Jpem9udGFsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiLAogICAgICAgICAgImhvcml6LW9yaWdpbi14IiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciIsCiAgICAgICAgICAibWFya2VyLWVuZCIsCiAgICAgICAgICAibWFya2VyLW1pZCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIiwKICAgICAgICAgICJwYWludC1vcmRlciIsCiAgICAgICAgICAicGFub3NlLTEiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IiwKICAgICAgICAgICJzaGFwZS1yZW5kZXJpbmciLAogICAgICAgICAgInN0b3AtY29sb3IiLAogICAgICAgICAgInN0b3Atb3BhY2l0eSIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS13aWR0aCIsCiAgICAgICAgICAidGV4dC1hbmNob3IiLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIiwKICAgICAgICAgICJ1bmljb2RlLXJhbmdlIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iLAogICAgICAgICAgInYtYWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1oYW5naW5nIiwKICAgICAgICAgICJ2LWlkZW9ncmFwaGljIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCIsCiAgICAgICAgICAidmVydC1hZHYteSIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teSIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiLAogICAgICAgICAgInhtbG5zOnhsaW5rIiwKICAgICAgICAgICJ4LWhlaWdodCIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhsaW5rOmFjdHVhdGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiLAogICAgICAgICAgInhsaW5rOnJvbGUiLAogICAgICAgICAgInhsaW5rOnNob3ciLAogICAgICAgICAgInhsaW5rOnRpdGxlIiwKICAgICAgICAgICJ4bGluazp0eXBlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgInhtbDpiYXNlIiwKICAgICAgICAgICJ4bWw6bGFuZyIsCiAgICAgICAgICAieG1sOnNwYWNlIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlTmFtZS5yZXBsYWNlKENBTUVMSVpFLCBjYXBpdGFsaXplKTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZSIsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInRhYkluZGV4IiwgImNyb3NzT3JpZ2luIl0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW2F0dHJpYnV0ZU5hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciB4bGlua0hyZWYgPSAieGxpbmtIcmVmIjsKICAgICAgICBwcm9wZXJ0aWVzW3hsaW5rSHJlZl0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgInhsaW5rSHJlZiIsCiAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgInhsaW5rOmhyZWYiLAogICAgICAgICAgImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICBmYWxzZQogICAgICAgICk7CiAgICAgICAgWyJzcmMiLCAiaHJlZiIsICJhY3Rpb24iLCAiZm9ybUFjdGlvbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGlzSmF2YVNjcmlwdFByb3RvY29sID0gL15bXHUwMDAwLVx1MDAxRiBdKmpbXHJcblx0XSphW1xyXG5cdF0qdltcclxuXHRdKmFbXHJcblx0XSpzW1xyXG5cdF0qY1tcclxuXHRdKnJbXHJcblx0XSppW1xyXG5cdF0qcFtcclxuXHRdKnRbXHJcblx0XSpcOi9pOwogICAgICAgIHZhciBkaWRXYXJuID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2FuaXRpemVVUkwodXJsKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybiAmJiBpc0phdmFTY3JpcHRQcm90b2NvbC50ZXN0KHVybCkpIHsKICAgICAgICAgICAgICBkaWRXYXJuID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiQSBmdXR1cmUgdmVyc2lvbiBvZiBSZWFjdCB3aWxsIGJsb2NrIGphdmFzY3JpcHQ6IFVSTHMgYXMgYSBzZWN1cml0eSBwcmVjYXV0aW9uLiBVc2UgZXZlbnQgaGFuZGxlcnMgaW5zdGVhZCBpZiB5b3UgY2FuLiBJZiB5b3UgbmVlZCB0byBnZW5lcmF0ZSB1bnNhZmUgSFRNTCB0cnkgdXNpbmcgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgaW5zdGVhZC4gUmVhY3Qgd2FzIHBhc3NlZCAlcy4iLCBKU09OLnN0cmluZ2lmeSh1cmwpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWYWx1ZUZvclByb3BlcnR5KG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlOYW1lID0gcHJvcGVydHlJbmZvLnByb3BlcnR5TmFtZTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZVtwcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTCgiIiArIGV4cGVjdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZTsKICAgICAgICAgICAgICB2YXIgc3RyaW5nVmFsdWUgPSBudWxsOwogICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiICsgZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgZXhwZWN0ZWQsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHJpbmdWYWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1ZhbHVlID09PSBudWxsID8gZXhwZWN0ZWQgOiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmluZ1ZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUobm9kZSwgbmFtZSwgZXhwZWN0ZWQsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNBdHRyaWJ1dGVOYW1lU2FmZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW5vZGUuaGFzQXR0cmlidXRlKG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbihleHBlY3RlZCwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCB2YWx1ZSwgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBnZXRQcm9wZXJ0eUluZm8obmFtZSk7CiAgICAgICAgICBpZiAoc2hvdWxkSWdub3JlQXR0cmlidXRlKG5hbWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyB8fCBwcm9wZXJ0eUluZm8gPT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgX2F0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoX2F0dHJpYnV0ZU5hbWUsICIiICsgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbXVzdFVzZVByb3BlcnR5ID0gcHJvcGVydHlJbmZvLm11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIGlmIChtdXN0VXNlUHJvcGVydHkpIHsKICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gcHJvcGVydHlJbmZvLnR5cGU7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdHlwZSA9PT0gQk9PTEVBTiA/IGZhbHNlIDogIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZVtwcm9wZXJ0eU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlTmFtZXNwYWNlID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlVmFsdWU7CiAgICAgICAgICAgIGlmIChfdHlwZSA9PT0gQk9PTEVBTiB8fCBfdHlwZSA9PT0gT1ZFUkxPQURFRF9CT09MRUFOICYmIHZhbHVlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24odmFsdWUsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0cmlidXRlVmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnNhbml0aXplVVJMKSB7CiAgICAgICAgICAgICAgICBzYW5pdGl6ZVVSTChhdHRyaWJ1dGVWYWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU5hbWVzcGFjZSkgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlTlMoYXR0cmlidXRlTmFtZXNwYWNlLCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2TG9nCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGluZm86IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2RXJyb3IKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXA6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBFbmQKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoImRpc2FibGVkRGVwdGggZmVsbCBiZWxvdyB6ZXJvLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geC5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbi5jYWxsKEZha2UucHJvdG90eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoY3Rvciwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGN0b3IsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgb3duZXIgPSBmaWJlci5fZGVidWdPd25lciA/IGZpYmVyLl9kZWJ1Z093bmVyLnR5cGUgOiBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGZpYmVyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIkxhenkiKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUucmVuZGVyKTsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGluZm8yID0gIiI7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaW5mbzIgKz0gZGVzY3JpYmVGaWJlcihub2RlKTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gaW5mbzI7CiAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeC5tZXNzYWdlICsgIlxuIiArIHguc3RhY2s7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFdyYXBwZWROYW1lKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgaWYgKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwbGF5TmFtZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb25OYW1lICE9PSAiIiA/IHdyYXBwZXJOYW1lICsgIigiICsgZnVuY3Rpb25OYW1lICsgIikiIDogd3JhcHBlck5hbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8ICJDb250ZXh0IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS50YWcgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGFuIHVuZXhwZWN0ZWQgb2JqZWN0IGluIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSgpLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiRnJhZ21lbnQiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiUHJvZmlsZXIiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdHJpY3RNb2RlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2UiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlTGlzdCI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgdmFyIHByb3ZpZGVyID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShwcm92aWRlci5fY29udGV4dCkgKyAiLlByb3ZpZGVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUkMShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBpbm5lclR5cGUuZGlzcGxheU5hbWUgfHwgaW5uZXJUeXBlLm5hbWUgfHwgIiI7CiAgICAgICAgICByZXR1cm4gb3V0ZXJUeXBlLmRpc3BsYXlOYW1lIHx8IChmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHROYW1lJDEodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJDYWNoZSI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUkMShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICBjYXNlIERlaHlkcmF0ZWRGcmFnbWVudDoKICAgICAgICAgICAgICByZXR1cm4gIkRlaHlkcmF0ZWRGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDI6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudCA9IG51bGw7CiAgICAgICAgdmFyIGlzUmVuZGVyaW5nID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG93bmVyID0gY3VycmVudC5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKGN1cnJlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEN1cnJlbnRGaWJlcigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudCA9IGZpYmVyOwogICAgICAgICAgICBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXIoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1JlbmRlcmluZyhyZW5kZXJpbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSByZW5kZXJpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VG9TdHJpbmdWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgIGNhc2UgInVuZGVmaW5lZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBoYXNSZWFkT25seVZhbHVlID0gewogICAgICAgICAgYnV0dG9uOiB0cnVlLAogICAgICAgICAgY2hlY2tib3g6IHRydWUsCiAgICAgICAgICBpbWFnZTogdHJ1ZSwKICAgICAgICAgIGhpZGRlbjogdHJ1ZSwKICAgICAgICAgIHJhZGlvOiB0cnVlLAogICAgICAgICAgcmVzZXQ6IHRydWUsCiAgICAgICAgICBzdWJtaXQ6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHModGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoaGFzUmVhZE9ubHlWYWx1ZVtwcm9wcy50eXBlXSB8fCBwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5vbklucHV0IHx8IHByb3BzLnJlYWRPbmx5IHx8IHByb3BzLmRpc2FibGVkIHx8IHByb3BzLnZhbHVlID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGB2YWx1ZWAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRWYWx1ZWAuIE90aGVyd2lzZSwgc2V0IGVpdGhlciBgb25DaGFuZ2VgIG9yIGByZWFkT25seWAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEocHJvcHMub25DaGFuZ2UgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMuY2hlY2tlZCA9PSBudWxsKSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcHJvdmlkZWQgYSBgY2hlY2tlZGAgcHJvcCB0byBhIGZvcm0gZmllbGQgd2l0aG91dCBhbiBgb25DaGFuZ2VgIGhhbmRsZXIuIFRoaXMgd2lsbCByZW5kZXIgYSByZWFkLW9ubHkgZmllbGQuIElmIHRoZSBmaWVsZCBzaG91bGQgYmUgbXV0YWJsZSB1c2UgYGRlZmF1bHRDaGVja2VkYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NoZWNrYWJsZShlbGVtKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW0udHlwZTsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAodHlwZSA9PT0gImNoZWNrYm94IiB8fCB0eXBlID09PSAicmFkaW8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhY2tlcihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5fdmFsdWVUcmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIG5vZGUuX3ZhbHVlVHJhY2tlciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gIiI7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ2hlY2thYmxlKG5vZGUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS5jaGVja2VkID8gInRydWUiIDogImZhbHNlIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2tWYWx1ZU9uTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWVGaWVsZCA9IGlzQ2hlY2thYmxlKG5vZGUpID8gImNoZWNrZWQiIDogInZhbHVlIjsKICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihub2RlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgdmFsdWVGaWVsZCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbihub2RlW3ZhbHVlRmllbGRdKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSAiIiArIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICBpZiAobm9kZS5oYXNPd25Qcm9wZXJ0eSh2YWx1ZUZpZWxkKSB8fCB0eXBlb2YgZGVzY3JpcHRvciA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGRlc2NyaXB0b3IuZ2V0ICE9PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBkZXNjcmlwdG9yLnNldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0MiA9IGRlc2NyaXB0b3IuZ2V0LCBzZXQyID0gZGVzY3JpcHRvci5zZXQ7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldDIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgICAgc2V0Mi5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgdmFsdWVGaWVsZCwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjcmlwdG9yLmVudW1lcmFibGUKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIHRyYWNrZXIgPSB7CiAgICAgICAgICAgIGdldFZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0Zvcm1GaWVsZFZhbHVlU3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VmFsdWUgPSAiIiArIHZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wVHJhY2tpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGRldGFjaFRyYWNrZXIobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIG5vZGVbdmFsdWVGaWVsZF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdHJhY2tlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhY2sobm9kZSkgewogICAgICAgICAgaWYgKGdldFRyYWNrZXIobm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gdHJhY2tWYWx1ZU9uTm9kZShub2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlVmFsdWVJZkNoYW5nZWQobm9kZSkgewogICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFja2VyID0gZ2V0VHJhY2tlcihub2RlKTsKICAgICAgICAgIGlmICghdHJhY2tlcikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0VmFsdWUgPSB0cmFja2VyLmdldFZhbHVlKCk7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gZ2V0VmFsdWVGcm9tTm9kZShub2RlKTsKICAgICAgICAgIGlmIChuZXh0VmFsdWUgIT09IGxhc3RWYWx1ZSkgewogICAgICAgICAgICB0cmFja2VyLnNldFZhbHVlKG5leHRWYWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50KGRvYykgewogICAgICAgICAgZG9jID0gZG9jIHx8ICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiID8gZG9jdW1lbnQgOiB2b2lkIDApOwogICAgICAgICAgaWYgKHR5cGVvZiBkb2MgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGRvYy5hY3RpdmVFbGVtZW50IHx8IGRvYy5ib2R5OwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gZG9jLmJvZHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkNoZWNrZWREZWZhdWx0Q2hlY2tlZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0NvbnRyb2xsZWQocHJvcHMpIHsKICAgICAgICAgIHZhciB1c2VzQ2hlY2tlZCA9IHByb3BzLnR5cGUgPT09ICJjaGVja2JveCIgfHwgcHJvcHMudHlwZSA9PT0gInJhZGlvIjsKICAgICAgICAgIHJldHVybiB1c2VzQ2hlY2tlZCA/IHByb3BzLmNoZWNrZWQgIT0gbnVsbCA6IHByb3BzLnZhbHVlICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGNoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzLkNoaWxkcmVuLmZvckVhY2gocHJvcHMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBjaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZENoaWxkKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCBpbmZlciB0aGUgb3B0aW9uIHZhbHVlIG9mIGNvbXBsZXggY2hpbGRyZW4uIFBhc3MgYSBgdmFsdWVgIHByb3Agb3IgdXNlIGEgcGxhaW4gc3RyaW5nIGFzIGNoaWxkcmVuIHRvIDxvcHRpb24+LiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRJbm5lckhUTUwpIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRJbm5lckhUTUwgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUGFzcyBhIGB2YWx1ZWAgcHJvcCBpZiB5b3Ugc2V0IGRhbmdlcm91c2x5SW5uZXJIVE1MIHNvIFJlYWN0IGtub3dzIHdoaWNoIHZhbHVlIHNob3VsZCBiZSBzZWxlY3RlZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLnNlbGVjdGVkICE9IG51bGwgJiYgIWRpZFdhcm5TZWxlY3RlZFNldE9uT3B0aW9uKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVzZSB0aGUgYGRlZmF1bHRWYWx1ZWAgb3IgYHZhbHVlYCBwcm9wcyBvbiA8c2VsZWN0PiBpbnN0ZWFkIG9mIHNldHRpbmcgYHNlbGVjdGVkYCBvbiA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICBkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgidmFsdWUiLCB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BzLnZhbHVlKSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgICAgdmFyIG93bmVyTmFtZSA9IGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCk7CiAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlUHJvcE5hbWVzID0gWyJ2YWx1ZSIsICJkZWZhdWx0VmFsdWUiXTsKICAgICAgICBmdW5jdGlvbiBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJzZWxlY3QiLCBwcm9wcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVQcm9wTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcHJvcE5hbWUgPSB2YWx1ZVByb3BOYW1lc1tpXTsKICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcHJvcE5hbWVJc0FycmF5ID0gaXNBcnJheShwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zKG5vZGUsIG11bHRpcGxlLCBwcm9wVmFsdWUsIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgdmFyIG9wdGlvbnMyID0gbm9kZS5vcHRpb25zOwogICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlcyA9IHByb3BWYWx1ZTsKICAgICAgICAgICAgdmFyIHNlbGVjdGVkVmFsdWUgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWxlY3RlZFZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVbIiQiICsgc2VsZWN0ZWRWYWx1ZXNbaV1dID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgb3B0aW9uczIubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkID0gc2VsZWN0ZWRWYWx1ZS5oYXNPd25Qcm9wZXJ0eSgiJCIgKyBvcHRpb25zMltfaV0udmFsdWUpOwogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaV0uc2VsZWN0ZWQgIT09IHNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zMltfaV0uc2VsZWN0ZWQgPSBzZWxlY3RlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNlbGVjdGVkICYmIHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3NlbGVjdGVkVmFsdWUgPSB0b1N0cmluZyhnZXRUb1N0cmluZ1ZhbHVlKHByb3BWYWx1ZSkpOwogICAgICAgICAgICB2YXIgZGVmYXVsdFNlbGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgX2kyID0gMDsgX2kyIDwgb3B0aW9uczIubGVuZ3RoOyBfaTIrKykgewogICAgICAgICAgICAgIGlmIChvcHRpb25zMltfaTJdLnZhbHVlID09PSBfc2VsZWN0ZWRWYWx1ZSkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2kyXS5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2V0RGVmYXVsdFNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uZGVmYXVsdFNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCA9PT0gbnVsbCAmJiAhb3B0aW9uczJbX2kyXS5kaXNhYmxlZCkgewogICAgICAgICAgICAgICAgZGVmYXVsdFNlbGVjdGVkID0gb3B0aW9uczJbX2kyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRlZmF1bHRTZWxlY3RlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZC5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0V3JhcHBlclN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tTZWxlY3RQcm9wVHlwZXMocHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlID0gewogICAgICAgICAgICB3YXNNdWx0aXBsZTogISFwcm9wcy5tdWx0aXBsZQogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9PSB2b2lkIDAgJiYgcHJvcHMuZGVmYXVsdFZhbHVlICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSQxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlNlbGVjdCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIHZhbHVlIHByb3AsIG9yIHRoZSBkZWZhdWx0VmFsdWUgcHJvcCwgYnV0IG5vdCBib3RoKS4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBzZWxlY3QgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgbm9kZS5tdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5kZWZhdWx0VmFsdWUsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0VXBkYXRlV3JhcHBlcihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHdhc011bHRpcGxlID0gbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlOwogICAgICAgICAgbm9kZS5fd3JhcHBlclN0YXRlLndhc011bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfSBlbHNlIGlmICh3YXNNdWx0aXBsZSAhPT0gISFwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGVPcHRpb25zKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCBwcm9wcy5tdWx0aXBsZSA/IFtdIDogIiIsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9ucyhub2RlLCAhIXByb3BzLm11bHRpcGxlLCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblZhbERlZmF1bHRWYWwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UHJvcHMkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIGRvZXMgbm90IG1ha2Ugc2Vuc2Ugb24gPHRleHRhcmVhPi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBob3N0UHJvcHMgPSBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIjx0ZXh0YXJlYT4gY2FuIG9ubHkgaGF2ZSBhdCBtb3N0IG9uZSBjaGlsZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjaGlsZHJlbiA9IGNoaWxkcmVuWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gY2hpbGRyZW47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZSA9IHsKICAgICAgICAgICAgaW5pdGlhbFZhbHVlOiBnZXRUb1N0cmluZ1ZhbHVlKGluaXRpYWxWYWx1ZSkKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgZGVmYXVsdFZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICBpZiAobmV3VmFsdWUgIT09IG5vZGUudmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsICYmIG5vZGUuZGVmYXVsdFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgIG5vZGUuZGVmYXVsdFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChkZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMyhlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gbm9kZS50ZXh0Q29udGVudDsKICAgICAgICAgIGlmICh0ZXh0Q29udGVudCA9PT0gbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICBpZiAodGV4dENvbnRlbnQgIT09ICIiICYmIHRleHRDb250ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IHRleHRDb250ZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGVsZW1lbnQsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIEhUTUxfTkFNRVNQQUNFID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiOwogICAgICAgIHZhciBNQVRIX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk4L01hdGgvTWF0aE1MIjsKICAgICAgICB2YXIgU1ZHX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJzdmciOgogICAgICAgICAgICAgIHJldHVybiBTVkdfTkFNRVNQQUNFOwogICAgICAgICAgICBjYXNlICJtYXRoIjoKICAgICAgICAgICAgICByZXR1cm4gTUFUSF9OQU1FU1BBQ0U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnROYW1lc3BhY2UsIHR5cGUpIHsKICAgICAgICAgIGlmIChwYXJlbnROYW1lc3BhY2UgPT0gbnVsbCB8fCBwYXJlbnROYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09PSBTVkdfTkFNRVNQQUNFICYmIHR5cGUgPT09ICJmb3JlaWduT2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gSFRNTF9OQU1FU1BBQ0U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFyZW50TmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbiA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgTVNBcHAgIT09ICJ1bmRlZmluZWQiICYmIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihhcmcwLCBhcmcxLCBhcmcyLCBhcmczKSB7CiAgICAgICAgICAgICAgTVNBcHAuZXhlY1Vuc2FmZUxvY2FsRnVuY3Rpb24oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuYyhhcmcwLCBhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHJldXNhYmxlU1ZHQ29udGFpbmVyOwogICAgICAgIHZhciBzZXRJbm5lckhUTUwgPSBjcmVhdGVNaWNyb3NvZnRVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKG5vZGUsIGh0bWwpIHsKICAgICAgICAgIGlmIChub2RlLm5hbWVzcGFjZVVSSSA9PT0gU1ZHX05BTUVTUEFDRSkgewogICAgICAgICAgICBpZiAoISgiaW5uZXJIVE1MIiBpbiBub2RlKSkgewogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyID0gcmV1c2FibGVTVkdDb250YWluZXIgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgcmV1c2FibGVTVkdDb250YWluZXIuaW5uZXJIVE1MID0gIjxzdmc+IiArIGh0bWwudmFsdWVPZigpLnRvU3RyaW5nKCkgKyAiPC9zdmc+IjsKICAgICAgICAgICAgICB2YXIgc3ZnTm9kZSA9IHJldXNhYmxlU1ZHQ29udGFpbmVyLmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVDaGlsZChub2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAoc3ZnTm9kZS5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBub2RlLmFwcGVuZENoaWxkKHN2Z05vZGUuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIH0pOwogICAgICAgIHZhciBFTEVNRU5UX05PREUgPSAxOwogICAgICAgIHZhciBURVhUX05PREUgPSAzOwogICAgICAgIHZhciBDT01NRU5UX05PREUgPSA4OwogICAgICAgIHZhciBET0NVTUVOVF9OT0RFID0gOTsKICAgICAgICB2YXIgRE9DVU1FTlRfRlJBR01FTlRfTk9ERSA9IDExOwogICAgICAgIHZhciBzZXRUZXh0Q29udGVudCA9IGZ1bmN0aW9uKG5vZGUsIHRleHQpIHsKICAgICAgICAgIGlmICh0ZXh0KSB7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAmJiBmaXJzdENoaWxkID09PSBub2RlLmxhc3RDaGlsZCAmJiBmaXJzdENoaWxkLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnRleHRDb250ZW50ID0gdGV4dDsKICAgICAgICB9OwogICAgICAgIHZhciBzaG9ydGhhbmRUb0xvbmdoYW5kID0gewogICAgICAgICAgYW5pbWF0aW9uOiBbImFuaW1hdGlvbkRlbGF5IiwgImFuaW1hdGlvbkRpcmVjdGlvbiIsICJhbmltYXRpb25EdXJhdGlvbiIsICJhbmltYXRpb25GaWxsTW9kZSIsICJhbmltYXRpb25JdGVyYXRpb25Db3VudCIsICJhbmltYXRpb25OYW1lIiwgImFuaW1hdGlvblBsYXlTdGF0ZSIsICJhbmltYXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgYmFja2dyb3VuZDogWyJiYWNrZ3JvdW5kQXR0YWNobWVudCIsICJiYWNrZ3JvdW5kQ2xpcCIsICJiYWNrZ3JvdW5kQ29sb3IiLCAiYmFja2dyb3VuZEltYWdlIiwgImJhY2tncm91bmRPcmlnaW4iLCAiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIiwgImJhY2tncm91bmRSZXBlYXQiLCAiYmFja2dyb3VuZFNpemUiXSwKICAgICAgICAgIGJhY2tncm91bmRQb3NpdGlvbjogWyJiYWNrZ3JvdW5kUG9zaXRpb25YIiwgImJhY2tncm91bmRQb3NpdGlvblkiXSwKICAgICAgICAgIGJvcmRlcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiLCAiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJSaWdodFN0eWxlIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wQ29sb3IiLCAiYm9yZGVyVG9wU3R5bGUiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckJsb2NrRW5kOiBbImJvcmRlckJsb2NrRW5kQ29sb3IiLCAiYm9yZGVyQmxvY2tFbmRTdHlsZSIsICJib3JkZXJCbG9ja0VuZFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja1N0YXJ0OiBbImJvcmRlckJsb2NrU3RhcnRDb2xvciIsICJib3JkZXJCbG9ja1N0YXJ0U3R5bGUiLCAiYm9yZGVyQmxvY2tTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCb3R0b206IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiXSwKICAgICAgICAgIGJvcmRlckNvbG9yOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclRvcENvbG9yIl0sCiAgICAgICAgICBib3JkZXJJbWFnZTogWyJib3JkZXJJbWFnZU91dHNldCIsICJib3JkZXJJbWFnZVJlcGVhdCIsICJib3JkZXJJbWFnZVNsaWNlIiwgImJvcmRlckltYWdlU291cmNlIiwgImJvcmRlckltYWdlV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZUVuZDogWyJib3JkZXJJbmxpbmVFbmRDb2xvciIsICJib3JkZXJJbmxpbmVFbmRTdHlsZSIsICJib3JkZXJJbmxpbmVFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVySW5saW5lU3RhcnQ6IFsiYm9yZGVySW5saW5lU3RhcnRDb2xvciIsICJib3JkZXJJbmxpbmVTdGFydFN0eWxlIiwgImJvcmRlcklubGluZVN0YXJ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlckxlZnQ6IFsiYm9yZGVyTGVmdENvbG9yIiwgImJvcmRlckxlZnRTdHlsZSIsICJib3JkZXJMZWZ0V2lkdGgiXSwKICAgICAgICAgIGJvcmRlclJhZGl1czogWyJib3JkZXJCb3R0b21MZWZ0UmFkaXVzIiwgImJvcmRlckJvdHRvbVJpZ2h0UmFkaXVzIiwgImJvcmRlclRvcExlZnRSYWRpdXMiLCAiYm9yZGVyVG9wUmlnaHRSYWRpdXMiXSwKICAgICAgICAgIGJvcmRlclJpZ2h0OiBbImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJTdHlsZTogWyJib3JkZXJCb3R0b21TdHlsZSIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJUb3BTdHlsZSJdLAogICAgICAgICAgYm9yZGVyVG9wOiBbImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJXaWR0aDogWyJib3JkZXJCb3R0b21XaWR0aCIsICJib3JkZXJMZWZ0V2lkdGgiLCAiYm9yZGVyUmlnaHRXaWR0aCIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgY29sdW1uUnVsZTogWyJjb2x1bW5SdWxlQ29sb3IiLCAiY29sdW1uUnVsZVN0eWxlIiwgImNvbHVtblJ1bGVXaWR0aCJdLAogICAgICAgICAgY29sdW1uczogWyJjb2x1bW5Db3VudCIsICJjb2x1bW5XaWR0aCJdLAogICAgICAgICAgZmxleDogWyJmbGV4QmFzaXMiLCAiZmxleEdyb3ciLCAiZmxleFNocmluayJdLAogICAgICAgICAgZmxleEZsb3c6IFsiZmxleERpcmVjdGlvbiIsICJmbGV4V3JhcCJdLAogICAgICAgICAgZm9udDogWyJmb250RmFtaWx5IiwgImZvbnRGZWF0dXJlU2V0dGluZ3MiLCAiZm9udEtlcm5pbmciLCAiZm9udExhbmd1YWdlT3ZlcnJpZGUiLCAiZm9udFNpemUiLCAiZm9udFNpemVBZGp1c3QiLCAiZm9udFN0cmV0Y2giLCAiZm9udFN0eWxlIiwgImZvbnRWYXJpYW50IiwgImZvbnRWYXJpYW50QWx0ZXJuYXRlcyIsICJmb250VmFyaWFudENhcHMiLCAiZm9udFZhcmlhbnRFYXN0QXNpYW4iLCAiZm9udFZhcmlhbnRMaWdhdHVyZXMiLCAiZm9udFZhcmlhbnROdW1lcmljIiwgImZvbnRWYXJpYW50UG9zaXRpb24iLCAiZm9udFdlaWdodCIsICJsaW5lSGVpZ2h0Il0sCiAgICAgICAgICBmb250VmFyaWFudDogWyJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIl0sCiAgICAgICAgICBnYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZDogWyJncmlkQXV0b0NvbHVtbnMiLCAiZ3JpZEF1dG9GbG93IiwgImdyaWRBdXRvUm93cyIsICJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGdyaWRBcmVhOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0IiwgImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uOiBbImdyaWRDb2x1bW5FbmQiLCAiZ3JpZENvbHVtblN0YXJ0Il0sCiAgICAgICAgICBncmlkQ29sdW1uR2FwOiBbImNvbHVtbkdhcCJdLAogICAgICAgICAgZ3JpZEdhcDogWyJjb2x1bW5HYXAiLCAicm93R2FwIl0sCiAgICAgICAgICBncmlkUm93OiBbImdyaWRSb3dFbmQiLCAiZ3JpZFJvd1N0YXJ0Il0sCiAgICAgICAgICBncmlkUm93R2FwOiBbInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFRlbXBsYXRlOiBbImdyaWRUZW1wbGF0ZUFyZWFzIiwgImdyaWRUZW1wbGF0ZUNvbHVtbnMiLCAiZ3JpZFRlbXBsYXRlUm93cyJdLAogICAgICAgICAgbGlzdFN0eWxlOiBbImxpc3RTdHlsZUltYWdlIiwgImxpc3RTdHlsZVBvc2l0aW9uIiwgImxpc3RTdHlsZVR5cGUiXSwKICAgICAgICAgIG1hcmdpbjogWyJtYXJnaW5Cb3R0b20iLCAibWFyZ2luTGVmdCIsICJtYXJnaW5SaWdodCIsICJtYXJnaW5Ub3AiXSwKICAgICAgICAgIG1hcmtlcjogWyJtYXJrZXJFbmQiLCAibWFya2VyTWlkIiwgIm1hcmtlclN0YXJ0Il0sCiAgICAgICAgICBtYXNrOiBbIm1hc2tDbGlwIiwgIm1hc2tDb21wb3NpdGUiLCAibWFza0ltYWdlIiwgIm1hc2tNb2RlIiwgIm1hc2tPcmlnaW4iLCAibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIiwgIm1hc2tSZXBlYXQiLCAibWFza1NpemUiXSwKICAgICAgICAgIG1hc2tQb3NpdGlvbjogWyJtYXNrUG9zaXRpb25YIiwgIm1hc2tQb3NpdGlvblkiXSwKICAgICAgICAgIG91dGxpbmU6IFsib3V0bGluZUNvbG9yIiwgIm91dGxpbmVTdHlsZSIsICJvdXRsaW5lV2lkdGgiXSwKICAgICAgICAgIG92ZXJmbG93OiBbIm92ZXJmbG93WCIsICJvdmVyZmxvd1kiXSwKICAgICAgICAgIHBhZGRpbmc6IFsicGFkZGluZ0JvdHRvbSIsICJwYWRkaW5nTGVmdCIsICJwYWRkaW5nUmlnaHQiLCAicGFkZGluZ1RvcCJdLAogICAgICAgICAgcGxhY2VDb250ZW50OiBbImFsaWduQ29udGVudCIsICJqdXN0aWZ5Q29udGVudCJdLAogICAgICAgICAgcGxhY2VJdGVtczogWyJhbGlnbkl0ZW1zIiwgImp1c3RpZnlJdGVtcyJdLAogICAgICAgICAgcGxhY2VTZWxmOiBbImFsaWduU2VsZiIsICJqdXN0aWZ5U2VsZiJdLAogICAgICAgICAgdGV4dERlY29yYXRpb246IFsidGV4dERlY29yYXRpb25Db2xvciIsICJ0ZXh0RGVjb3JhdGlvbkxpbmUiLCAidGV4dERlY29yYXRpb25TdHlsZSJdLAogICAgICAgICAgdGV4dEVtcGhhc2lzOiBbInRleHRFbXBoYXNpc0NvbG9yIiwgInRleHRFbXBoYXNpc1N0eWxlIl0sCiAgICAgICAgICB0cmFuc2l0aW9uOiBbInRyYW5zaXRpb25EZWxheSIsICJ0cmFuc2l0aW9uRHVyYXRpb24iLCAidHJhbnNpdGlvblByb3BlcnR5IiwgInRyYW5zaXRpb25UaW1pbmdGdW5jdGlvbiJdLAogICAgICAgICAgd29yZFdyYXA6IFsib3ZlcmZsb3dXcmFwIl0KICAgICAgICB9OwogICAgICAgIHZhciBpc1VuaXRsZXNzTnVtYmVyID0gewogICAgICAgICAgYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQ6IHRydWUsCiAgICAgICAgICBhc3BlY3RSYXRpbzogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlT3V0c2V0OiB0cnVlLAogICAgICAgICAgYm9yZGVySW1hZ2VTbGljZTogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlV2lkdGg6IHRydWUsCiAgICAgICAgICBib3hGbGV4OiB0cnVlLAogICAgICAgICAgYm94RmxleEdyb3VwOiB0cnVlLAogICAgICAgICAgYm94T3JkaW5hbEdyb3VwOiB0cnVlLAogICAgICAgICAgY29sdW1uQ291bnQ6IHRydWUsCiAgICAgICAgICBjb2x1bW5zOiB0cnVlLAogICAgICAgICAgZmxleDogdHJ1ZSwKICAgICAgICAgIGZsZXhHcm93OiB0cnVlLAogICAgICAgICAgZmxleFBvc2l0aXZlOiB0cnVlLAogICAgICAgICAgZmxleFNocmluazogdHJ1ZSwKICAgICAgICAgIGZsZXhOZWdhdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhPcmRlcjogdHJ1ZSwKICAgICAgICAgIGdyaWRBcmVhOiB0cnVlLAogICAgICAgICAgZ3JpZFJvdzogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dFbmQ6IHRydWUsCiAgICAgICAgICBncmlkUm93U3BhbjogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3dTdGFydDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uRW5kOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblNwYW46IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uU3RhcnQ6IHRydWUsCiAgICAgICAgICBmb250V2VpZ2h0OiB0cnVlLAogICAgICAgICAgbGluZUNsYW1wOiB0cnVlLAogICAgICAgICAgbGluZUhlaWdodDogdHJ1ZSwKICAgICAgICAgIG9wYWNpdHk6IHRydWUsCiAgICAgICAgICBvcmRlcjogdHJ1ZSwKICAgICAgICAgIG9ycGhhbnM6IHRydWUsCiAgICAgICAgICB0YWJTaXplOiB0cnVlLAogICAgICAgICAgd2lkb3dzOiB0cnVlLAogICAgICAgICAgekluZGV4OiB0cnVlLAogICAgICAgICAgem9vbTogdHJ1ZSwKICAgICAgICAgIC8vIFNWRy1yZWxhdGVkIHByb3BlcnRpZXMKICAgICAgICAgIGZpbGxPcGFjaXR5OiB0cnVlLAogICAgICAgICAgZmxvb2RPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3RvcE9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRydWUsCiAgICAgICAgICBzdHJva2VEYXNob2Zmc2V0OiB0cnVlLAogICAgICAgICAgc3Ryb2tlTWl0ZXJsaW1pdDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU9wYWNpdHk6IHRydWUsCiAgICAgICAgICBzdHJva2VXaWR0aDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcHJlZml4S2V5KHByZWZpeDIsIGtleSkgewogICAgICAgICAgcmV0dXJuIHByZWZpeDIgKyBrZXkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc3Vic3RyaW5nKDEpOwogICAgICAgIH0KICAgICAgICB2YXIgcHJlZml4ZXMgPSBbIldlYmtpdCIsICJtcyIsICJNb3oiLCAiTyJdOwogICAgICAgIE9iamVjdC5rZXlzKGlzVW5pdGxlc3NOdW1iZXIpLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgcHJlZml4ZXMuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbih7CiAgICAgICAgICBtZW51aXRlbTogdHJ1ZQogICAgICAgIH0sIG9taXR0ZWRDbG9zZVRhZ3MpOwogICAgICAgIHZhciBIVE1MID0gIl9faHRtbCI7CiAgICAgICAgZnVuY3Rpb24gYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKSB7CiAgICAgICAgICBpZiAoIXByb3BzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2b2lkRWxlbWVudFRhZ3NbdGFnXSkgewogICAgICAgICAgICBpZiAocHJvcHMuY2hpbGRyZW4gIT0gbnVsbCB8fCBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHRhZyArICIgaXMgYSB2b2lkIGVsZW1lbnQgdGFnIGFuZCBtdXN0IG5laXRoZXIgaGF2ZSBgY2hpbGRyZW5gIG5vciB1c2UgYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IHNldCBvbmUgb2YgYGNoaWxkcmVuYCBvciBgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09ICJvYmplY3QiIHx8ICEoSFRNTCBpbiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCkpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTGAgbXVzdCBiZSBpbiB0aGUgZm9ybSBge19faHRtbDogLi4ufWAuIFBsZWFzZSB2aXNpdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGFuZ2Vyb3VzbHktc2V0LWlubmVyLWh0bWwgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFwcm9wcy5zdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmcgJiYgcHJvcHMuY29udGVudEVkaXRhYmxlICYmIHByb3BzLmNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgYGNvbnRlbnRFZGl0YWJsZWAgYW5kIGNvbnRhaW5zIGBjaGlsZHJlbmAgbWFuYWdlZCBieSBSZWFjdC4gSXQgaXMgbm93IHlvdXIgcmVzcG9uc2liaWxpdHkgdG8gZ3VhcmFudGVlIHRoYXQgbm9uZSBvZiB0aG9zZSBub2RlcyBhcmUgdW5leHBlY3RlZGx5IG1vZGlmaWVkIG9yIGR1cGxpY2F0ZWQuIFRoaXMgaXMgcHJvYmFibHkgbm90IGludGVudGlvbmFsLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcHMuc3R5bGUgIT0gbnVsbCAmJiB0eXBlb2YgcHJvcHMuc3R5bGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBzdHlsZWAgcHJvcCBleHBlY3RzIGEgbWFwcGluZyBmcm9tIHN0eWxlIHByb3BlcnRpZXMgdG8gdmFsdWVzLCBub3QgYSBzdHJpbmcuIEZvciBleGFtcGxlLCBzdHlsZT17e21hcmdpblJpZ2h0OiBzcGFjaW5nICsgJ2VtJ319IHdoZW4gdXNpbmcgSlNYLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0N1c3RvbUNvbXBvbmVudCh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgaWYgKHRhZ05hbWUuaW5kZXhPZigiLSIpID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnTmFtZSkgewogICAgICAgICAgICBjYXNlICJhbm5vdGF0aW9uLXhtbCI6CiAgICAgICAgICAgIGNhc2UgImNvbG9yLXByb2ZpbGUiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2Utc3JjIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXVyaSI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS1mb3JtYXQiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtbmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm1pc3NpbmctZ2x5cGgiOgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBvc3NpYmxlU3RhbmRhcmROYW1lcyA9IHsKICAgICAgICAgIC8vIEhUTUwKICAgICAgICAgIGFjY2VwdDogImFjY2VwdCIsCiAgICAgICAgICBhY2NlcHRjaGFyc2V0OiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICAiYWNjZXB0LWNoYXJzZXQiOiAiYWNjZXB0Q2hhcnNldCIsCiAgICAgICAgICBhY2Nlc3NrZXk6ICJhY2Nlc3NLZXkiLAogICAgICAgICAgYWN0aW9uOiAiYWN0aW9uIiwKICAgICAgICAgIGFsbG93ZnVsbHNjcmVlbjogImFsbG93RnVsbFNjcmVlbiIsCiAgICAgICAgICBhbHQ6ICJhbHQiLAogICAgICAgICAgYXM6ICJhcyIsCiAgICAgICAgICBhc3luYzogImFzeW5jIiwKICAgICAgICAgIGF1dG9jYXBpdGFsaXplOiAiYXV0b0NhcGl0YWxpemUiLAogICAgICAgICAgYXV0b2NvbXBsZXRlOiAiYXV0b0NvbXBsZXRlIiwKICAgICAgICAgIGF1dG9jb3JyZWN0OiAiYXV0b0NvcnJlY3QiLAogICAgICAgICAgYXV0b2ZvY3VzOiAiYXV0b0ZvY3VzIiwKICAgICAgICAgIGF1dG9wbGF5OiAiYXV0b1BsYXkiLAogICAgICAgICAgYXV0b3NhdmU6ICJhdXRvU2F2ZSIsCiAgICAgICAgICBjYXB0dXJlOiAiY2FwdHVyZSIsCiAgICAgICAgICBjZWxscGFkZGluZzogImNlbGxQYWRkaW5nIiwKICAgICAgICAgIGNlbGxzcGFjaW5nOiAiY2VsbFNwYWNpbmciLAogICAgICAgICAgY2hhbGxlbmdlOiAiY2hhbGxlbmdlIiwKICAgICAgICAgIGNoYXJzZXQ6ICJjaGFyU2V0IiwKICAgICAgICAgIGNoZWNrZWQ6ICJjaGVja2VkIiwKICAgICAgICAgIGNoaWxkcmVuOiAiY2hpbGRyZW4iLAogICAgICAgICAgY2l0ZTogImNpdGUiLAogICAgICAgICAgY2xhc3M6ICJjbGFzc05hbWUiLAogICAgICAgICAgY2xhc3NpZDogImNsYXNzSUQiLAogICAgICAgICAgY2xhc3NuYW1lOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNvbHM6ICJjb2xzIiwKICAgICAgICAgIGNvbHNwYW46ICJjb2xTcGFuIiwKICAgICAgICAgIGNvbnRlbnQ6ICJjb250ZW50IiwKICAgICAgICAgIGNvbnRlbnRlZGl0YWJsZTogImNvbnRlbnRFZGl0YWJsZSIsCiAgICAgICAgICBjb250ZXh0bWVudTogImNvbnRleHRNZW51IiwKICAgICAgICAgIGNvbnRyb2xzOiAiY29udHJvbHMiLAogICAgICAgICAgY29udHJvbHNsaXN0OiAiY29udHJvbHNMaXN0IiwKICAgICAgICAgIGNvb3JkczogImNvb3JkcyIsCiAgICAgICAgICBjcm9zc29yaWdpbjogImNyb3NzT3JpZ2luIiwKICAgICAgICAgIGRhbmdlcm91c2x5c2V0aW5uZXJodG1sOiAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLAogICAgICAgICAgZGF0YTogImRhdGEiLAogICAgICAgICAgZGF0ZXRpbWU6ICJkYXRlVGltZSIsCiAgICAgICAgICBkZWZhdWx0OiAiZGVmYXVsdCIsCiAgICAgICAgICBkZWZhdWx0Y2hlY2tlZDogImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgIGRlZmF1bHR2YWx1ZTogImRlZmF1bHRWYWx1ZSIsCiAgICAgICAgICBkZWZlcjogImRlZmVyIiwKICAgICAgICAgIGRpcjogImRpciIsCiAgICAgICAgICBkaXNhYmxlZDogImRpc2FibGVkIiwKICAgICAgICAgIGRpc2FibGVwaWN0dXJlaW5waWN0dXJlOiAiZGlzYWJsZVBpY3R1cmVJblBpY3R1cmUiLAogICAgICAgICAgZGlzYWJsZXJlbW90ZXBsYXliYWNrOiAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgIGRvd25sb2FkOiAiZG93bmxvYWQiLAogICAgICAgICAgZHJhZ2dhYmxlOiAiZHJhZ2dhYmxlIiwKICAgICAgICAgIGVuY3R5cGU6ICJlbmNUeXBlIiwKICAgICAgICAgIGVudGVya2V5aGludDogImVudGVyS2V5SGludCIsCiAgICAgICAgICBmb3I6ICJodG1sRm9yIiwKICAgICAgICAgIGZvcm06ICJmb3JtIiwKICAgICAgICAgIGZvcm1tZXRob2Q6ICJmb3JtTWV0aG9kIiwKICAgICAgICAgIGZvcm1hY3Rpb246ICJmb3JtQWN0aW9uIiwKICAgICAgICAgIGZvcm1lbmN0eXBlOiAiZm9ybUVuY1R5cGUiLAogICAgICAgICAgZm9ybW5vdmFsaWRhdGU6ICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICBmb3JtdGFyZ2V0OiAiZm9ybVRhcmdldCIsCiAgICAgICAgICBmcmFtZWJvcmRlcjogImZyYW1lQm9yZGVyIiwKICAgICAgICAgIGhlYWRlcnM6ICJoZWFkZXJzIiwKICAgICAgICAgIGhlaWdodDogImhlaWdodCIsCiAgICAgICAgICBoaWRkZW46ICJoaWRkZW4iLAogICAgICAgICAgaGlnaDogImhpZ2giLAogICAgICAgICAgaHJlZjogImhyZWYiLAogICAgICAgICAgaHJlZmxhbmc6ICJocmVmTGFuZyIsCiAgICAgICAgICBodG1sZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBodHRwZXF1aXY6ICJodHRwRXF1aXYiLAogICAgICAgICAgImh0dHAtZXF1aXYiOiAiaHR0cEVxdWl2IiwKICAgICAgICAgIGljb246ICJpY29uIiwKICAgICAgICAgIGlkOiAiaWQiLAogICAgICAgICAgaW1hZ2VzaXplczogImltYWdlU2l6ZXMiLAogICAgICAgICAgaW1hZ2VzcmNzZXQ6ICJpbWFnZVNyY1NldCIsCiAgICAgICAgICBpbm5lcmh0bWw6ICJpbm5lckhUTUwiLAogICAgICAgICAgaW5wdXRtb2RlOiAiaW5wdXRNb2RlIiwKICAgICAgICAgIGludGVncml0eTogImludGVncml0eSIsCiAgICAgICAgICBpczogImlzIiwKICAgICAgICAgIGl0ZW1pZDogIml0ZW1JRCIsCiAgICAgICAgICBpdGVtcHJvcDogIml0ZW1Qcm9wIiwKICAgICAgICAgIGl0ZW1yZWY6ICJpdGVtUmVmIiwKICAgICAgICAgIGl0ZW1zY29wZTogIml0ZW1TY29wZSIsCiAgICAgICAgICBpdGVtdHlwZTogIml0ZW1UeXBlIiwKICAgICAgICAgIGtleXBhcmFtczogImtleVBhcmFtcyIsCiAgICAgICAgICBrZXl0eXBlOiAia2V5VHlwZSIsCiAgICAgICAgICBraW5kOiAia2luZCIsCiAgICAgICAgICBsYWJlbDogImxhYmVsIiwKICAgICAgICAgIGxhbmc6ICJsYW5nIiwKICAgICAgICAgIGxpc3Q6ICJsaXN0IiwKICAgICAgICAgIGxvb3A6ICJsb29wIiwKICAgICAgICAgIGxvdzogImxvdyIsCiAgICAgICAgICBtYW5pZmVzdDogIm1hbmlmZXN0IiwKICAgICAgICAgIG1hcmdpbndpZHRoOiAibWFyZ2luV2lkdGgiLAogICAgICAgICAgbWFyZ2luaGVpZ2h0OiAibWFyZ2luSGVpZ2h0IiwKICAgICAgICAgIG1heDogIm1heCIsCiAgICAgICAgICBtYXhsZW5ndGg6ICJtYXhMZW5ndGgiLAogICAgICAgICAgbWVkaWE6ICJtZWRpYSIsCiAgICAgICAgICBtZWRpYWdyb3VwOiAibWVkaWFHcm91cCIsCiAgICAgICAgICBtZXRob2Q6ICJtZXRob2QiLAogICAgICAgICAgbWluOiAibWluIiwKICAgICAgICAgIG1pbmxlbmd0aDogIm1pbkxlbmd0aCIsCiAgICAgICAgICBtdWx0aXBsZTogIm11bHRpcGxlIiwKICAgICAgICAgIG11dGVkOiAibXV0ZWQiLAogICAgICAgICAgbmFtZTogIm5hbWUiLAogICAgICAgICAgbm9tb2R1bGU6ICJub01vZHVsZSIsCiAgICAgICAgICBub25jZTogIm5vbmNlIiwKICAgICAgICAgIG5vdmFsaWRhdGU6ICJub1ZhbGlkYXRlIiwKICAgICAgICAgIG9wZW46ICJvcGVuIiwKICAgICAgICAgIG9wdGltdW06ICJvcHRpbXVtIiwKICAgICAgICAgIHBhdHRlcm46ICJwYXR0ZXJuIiwKICAgICAgICAgIHBsYWNlaG9sZGVyOiAicGxhY2Vob2xkZXIiLAogICAgICAgICAgcGxheXNpbmxpbmU6ICJwbGF5c0lubGluZSIsCiAgICAgICAgICBwb3N0ZXI6ICJwb3N0ZXIiLAogICAgICAgICAgcHJlbG9hZDogInByZWxvYWQiLAogICAgICAgICAgcHJvZmlsZTogInByb2ZpbGUiLAogICAgICAgICAgcmFkaW9ncm91cDogInJhZGlvR3JvdXAiLAogICAgICAgICAgcmVhZG9ubHk6ICJyZWFkT25seSIsCiAgICAgICAgICByZWZlcnJlcnBvbGljeTogInJlZmVycmVyUG9saWN5IiwKICAgICAgICAgIHJlbDogInJlbCIsCiAgICAgICAgICByZXF1aXJlZDogInJlcXVpcmVkIiwKICAgICAgICAgIHJldmVyc2VkOiAicmV2ZXJzZWQiLAogICAgICAgICAgcm9sZTogInJvbGUiLAogICAgICAgICAgcm93czogInJvd3MiLAogICAgICAgICAgcm93c3BhbjogInJvd1NwYW4iLAogICAgICAgICAgc2FuZGJveDogInNhbmRib3giLAogICAgICAgICAgc2NvcGU6ICJzY29wZSIsCiAgICAgICAgICBzY29wZWQ6ICJzY29wZWQiLAogICAgICAgICAgc2Nyb2xsaW5nOiAic2Nyb2xsaW5nIiwKICAgICAgICAgIHNlYW1sZXNzOiAic2VhbWxlc3MiLAogICAgICAgICAgc2VsZWN0ZWQ6ICJzZWxlY3RlZCIsCiAgICAgICAgICBzaGFwZTogInNoYXBlIiwKICAgICAgICAgIHNpemU6ICJzaXplIiwKICAgICAgICAgIHNpemVzOiAic2l6ZXMiLAogICAgICAgICAgc3BhbjogInNwYW4iLAogICAgICAgICAgc3BlbGxjaGVjazogInNwZWxsQ2hlY2siLAogICAgICAgICAgc3JjOiAic3JjIiwKICAgICAgICAgIHNyY2RvYzogInNyY0RvYyIsCiAgICAgICAgICBzcmNsYW5nOiAic3JjTGFuZyIsCiAgICAgICAgICBzcmNzZXQ6ICJzcmNTZXQiLAogICAgICAgICAgc3RhcnQ6ICJzdGFydCIsCiAgICAgICAgICBzdGVwOiAic3RlcCIsCiAgICAgICAgICBzdHlsZTogInN0eWxlIiwKICAgICAgICAgIHN1bW1hcnk6ICJzdW1tYXJ5IiwKICAgICAgICAgIHRhYmluZGV4OiAidGFiSW5kZXgiLAogICAgICAgICAgdGFyZ2V0OiAidGFyZ2V0IiwKICAgICAgICAgIHRpdGxlOiAidGl0bGUiLAogICAgICAgICAgdHlwZTogInR5cGUiLAogICAgICAgICAgdXNlbWFwOiAidXNlTWFwIiwKICAgICAgICAgIHZhbHVlOiAidmFsdWUiLAogICAgICAgICAgd2lkdGg6ICJ3aWR0aCIsCiAgICAgICAgICB3bW9kZTogIndtb2RlIiwKICAgICAgICAgIHdyYXA6ICJ3cmFwIiwKICAgICAgICAgIC8vIFNWRwogICAgICAgICAgYWJvdXQ6ICJhYm91dCIsCiAgICAgICAgICBhY2NlbnRoZWlnaHQ6ICJhY2NlbnRIZWlnaHQiLAogICAgICAgICAgImFjY2VudC1oZWlnaHQiOiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgIGFjY3VtdWxhdGU6ICJhY2N1bXVsYXRlIiwKICAgICAgICAgIGFkZGl0aXZlOiAiYWRkaXRpdmUiLAogICAgICAgICAgYWxpZ25tZW50YmFzZWxpbmU6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIjogImFsaWdubWVudEJhc2VsaW5lIiwKICAgICAgICAgIGFsbG93cmVvcmRlcjogImFsbG93UmVvcmRlciIsCiAgICAgICAgICBhbHBoYWJldGljOiAiYWxwaGFiZXRpYyIsCiAgICAgICAgICBhbXBsaXR1ZGU6ICJhbXBsaXR1ZGUiLAogICAgICAgICAgYXJhYmljZm9ybTogImFyYWJpY0Zvcm0iLAogICAgICAgICAgImFyYWJpYy1mb3JtIjogImFyYWJpY0Zvcm0iLAogICAgICAgICAgYXNjZW50OiAiYXNjZW50IiwKICAgICAgICAgIGF0dHJpYnV0ZW5hbWU6ICJhdHRyaWJ1dGVOYW1lIiwKICAgICAgICAgIGF0dHJpYnV0ZXR5cGU6ICJhdHRyaWJ1dGVUeXBlIiwKICAgICAgICAgIGF1dG9yZXZlcnNlOiAiYXV0b1JldmVyc2UiLAogICAgICAgICAgYXppbXV0aDogImF6aW11dGgiLAogICAgICAgICAgYmFzZWZyZXF1ZW5jeTogImJhc2VGcmVxdWVuY3kiLAogICAgICAgICAgYmFzZWxpbmVzaGlmdDogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgImJhc2VsaW5lLXNoaWZ0IjogImJhc2VsaW5lU2hpZnQiLAogICAgICAgICAgYmFzZXByb2ZpbGU6ICJiYXNlUHJvZmlsZSIsCiAgICAgICAgICBiYm94OiAiYmJveCIsCiAgICAgICAgICBiZWdpbjogImJlZ2luIiwKICAgICAgICAgIGJpYXM6ICJiaWFzIiwKICAgICAgICAgIGJ5OiAiYnkiLAogICAgICAgICAgY2FsY21vZGU6ICJjYWxjTW9kZSIsCiAgICAgICAgICBjYXBoZWlnaHQ6ICJjYXBIZWlnaHQiLAogICAgICAgICAgImNhcC1oZWlnaHQiOiAiY2FwSGVpZ2h0IiwKICAgICAgICAgIGNsaXA6ICJjbGlwIiwKICAgICAgICAgIGNsaXBwYXRoOiAiY2xpcFBhdGgiLAogICAgICAgICAgImNsaXAtcGF0aCI6ICJjbGlwUGF0aCIsCiAgICAgICAgICBjbGlwcGF0aHVuaXRzOiAiY2xpcFBhdGhVbml0cyIsCiAgICAgICAgICBjbGlwcnVsZTogImNsaXBSdWxlIiwKICAgICAgICAgICJjbGlwLXJ1bGUiOiAiY2xpcFJ1bGUiLAogICAgICAgICAgY29sb3I6ICJjb2xvciIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb246ICJjb2xvckludGVycG9sYXRpb24iLAogICAgICAgICAgImNvbG9yLWludGVycG9sYXRpb24iOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgIGNvbG9yaW50ZXJwb2xhdGlvbmZpbHRlcnM6ICJjb2xvckludGVycG9sYXRpb25GaWx0ZXJzIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICBjb2xvcnByb2ZpbGU6ICJjb2xvclByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgIGNvbG9ycmVuZGVyaW5nOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyI6ICJjb2xvclJlbmRlcmluZyIsCiAgICAgICAgICBjb250ZW50c2NyaXB0dHlwZTogImNvbnRlbnRTY3JpcHRUeXBlIiwKICAgICAgICAgIGNvbnRlbnRzdHlsZXR5cGU6ICJjb250ZW50U3R5bGVUeXBlIiwKICAgICAgICAgIGN1cnNvcjogImN1cnNvciIsCiAgICAgICAgICBjeDogImN4IiwKICAgICAgICAgIGN5OiAiY3kiLAogICAgICAgICAgZDogImQiLAogICAgICAgICAgZGF0YXR5cGU6ICJkYXRhdHlwZSIsCiAgICAgICAgICBkZWNlbGVyYXRlOiAiZGVjZWxlcmF0ZSIsCiAgICAgICAgICBkZXNjZW50OiAiZGVzY2VudCIsCiAgICAgICAgICBkaWZmdXNlY29uc3RhbnQ6ICJkaWZmdXNlQ29uc3RhbnQiLAogICAgICAgICAgZGlyZWN0aW9uOiAiZGlyZWN0aW9uIiwKICAgICAgICAgIGRpc3BsYXk6ICJkaXNwbGF5IiwKICAgICAgICAgIGRpdmlzb3I6ICJkaXZpc29yIiwKICAgICAgICAgIGRvbWluYW50YmFzZWxpbmU6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgICJkb21pbmFudC1iYXNlbGluZSI6ICJkb21pbmFudEJhc2VsaW5lIiwKICAgICAgICAgIGR1cjogImR1ciIsCiAgICAgICAgICBkeDogImR4IiwKICAgICAgICAgIGR5OiAiZHkiLAogICAgICAgICAgZWRnZW1vZGU6ICJlZGdlTW9kZSIsCiAgICAgICAgICBlbGV2YXRpb246ICJlbGV2YXRpb24iLAogICAgICAgICAgZW5hYmxlYmFja2dyb3VuZDogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIjogImVuYWJsZUJhY2tncm91bmQiLAogICAgICAgICAgZW5kOiAiZW5kIiwKICAgICAgICAgIGV4cG9uZW50OiAiZXhwb25lbnQiLAogICAgICAgICAgZXh0ZXJuYWxyZXNvdXJjZXNyZXF1aXJlZDogImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICAgICAgICAgZmlsbDogImZpbGwiLAogICAgICAgICAgZmlsbG9wYWNpdHk6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICAiZmlsbC1vcGFjaXR5IjogImZpbGxPcGFjaXR5IiwKICAgICAgICAgIGZpbGxydWxlOiAiZmlsbFJ1bGUiLAogICAgICAgICAgImZpbGwtcnVsZSI6ICJmaWxsUnVsZSIsCiAgICAgICAgICBmaWx0ZXI6ICJmaWx0ZXIiLAogICAgICAgICAgZmlsdGVycmVzOiAiZmlsdGVyUmVzIiwKICAgICAgICAgIGZpbHRlcnVuaXRzOiAiZmlsdGVyVW5pdHMiLAogICAgICAgICAgZmxvb2RvcGFjaXR5OiAiZmxvb2RPcGFjaXR5IiwKICAgICAgICAgICJmbG9vZC1vcGFjaXR5IjogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICBmbG9vZGNvbG9yOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiOiAiZmxvb2RDb2xvciIsCiAgICAgICAgICBmb2N1c2FibGU6ICJmb2N1c2FibGUiLAogICAgICAgICAgZm9udGZhbWlseTogImZvbnRGYW1pbHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IjogImZvbnRGYW1pbHkiLAogICAgICAgICAgZm9udHNpemU6ICJmb250U2l6ZSIsCiAgICAgICAgICAiZm9udC1zaXplIjogImZvbnRTaXplIiwKICAgICAgICAgIGZvbnRzaXplYWRqdXN0OiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiOiAiZm9udFNpemVBZGp1c3QiLAogICAgICAgICAgZm9udHN0cmV0Y2g6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHJldGNoIjogImZvbnRTdHJldGNoIiwKICAgICAgICAgIGZvbnRzdHlsZTogImZvbnRTdHlsZSIsCiAgICAgICAgICAiZm9udC1zdHlsZSI6ICJmb250U3R5bGUiLAogICAgICAgICAgZm9udHZhcmlhbnQ6ICJmb250VmFyaWFudCIsCiAgICAgICAgICAiZm9udC12YXJpYW50IjogImZvbnRWYXJpYW50IiwKICAgICAgICAgIGZvbnR3ZWlnaHQ6ICJmb250V2VpZ2h0IiwKICAgICAgICAgICJmb250LXdlaWdodCI6ICJmb250V2VpZ2h0IiwKICAgICAgICAgIGZvcm1hdDogImZvcm1hdCIsCiAgICAgICAgICBmcm9tOiAiZnJvbSIsCiAgICAgICAgICBmeDogImZ4IiwKICAgICAgICAgIGZ5OiAiZnkiLAogICAgICAgICAgZzE6ICJnMSIsCiAgICAgICAgICBnMjogImcyIiwKICAgICAgICAgIGdseXBobmFtZTogImdseXBoTmFtZSIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSI6ICJnbHlwaE5hbWUiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbmhvcml6b250YWw6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCI6ICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgICAgICAgICBnbHlwaG9yaWVudGF0aW9udmVydGljYWw6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLXZlcnRpY2FsIjogImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgICAgICAgICBnbHlwaHJlZjogImdseXBoUmVmIiwKICAgICAgICAgIGdyYWRpZW50dHJhbnNmb3JtOiAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICAgICAgICAgZ3JhZGllbnR1bml0czogImdyYWRpZW50VW5pdHMiLAogICAgICAgICAgaGFuZ2luZzogImhhbmdpbmciLAogICAgICAgICAgaG9yaXphZHZ4OiAiaG9yaXpBZHZYIiwKICAgICAgICAgICJob3Jpei1hZHYteCI6ICJob3JpekFkdlgiLAogICAgICAgICAgaG9yaXpvcmlnaW54OiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCI6ICJob3Jpek9yaWdpblgiLAogICAgICAgICAgaWRlb2dyYXBoaWM6ICJpZGVvZ3JhcGhpYyIsCiAgICAgICAgICBpbWFnZXJlbmRlcmluZzogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgICJpbWFnZS1yZW5kZXJpbmciOiAiaW1hZ2VSZW5kZXJpbmciLAogICAgICAgICAgaW4yOiAiaW4yIiwKICAgICAgICAgIGluOiAiaW4iLAogICAgICAgICAgaW5saXN0OiAiaW5saXN0IiwKICAgICAgICAgIGludGVyY2VwdDogImludGVyY2VwdCIsCiAgICAgICAgICBrMTogImsxIiwKICAgICAgICAgIGsyOiAiazIiLAogICAgICAgICAgazM6ICJrMyIsCiAgICAgICAgICBrNDogIms0IiwKICAgICAgICAgIGs6ICJrIiwKICAgICAgICAgIGtlcm5lbG1hdHJpeDogImtlcm5lbE1hdHJpeCIsCiAgICAgICAgICBrZXJuZWx1bml0bGVuZ3RoOiAia2VybmVsVW5pdExlbmd0aCIsCiAgICAgICAgICBrZXJuaW5nOiAia2VybmluZyIsCiAgICAgICAgICBrZXlwb2ludHM6ICJrZXlQb2ludHMiLAogICAgICAgICAga2V5c3BsaW5lczogImtleVNwbGluZXMiLAogICAgICAgICAga2V5dGltZXM6ICJrZXlUaW1lcyIsCiAgICAgICAgICBsZW5ndGhhZGp1c3Q6ICJsZW5ndGhBZGp1c3QiLAogICAgICAgICAgbGV0dGVyc3BhY2luZzogImxldHRlclNwYWNpbmciLAogICAgICAgICAgImxldHRlci1zcGFjaW5nIjogImxldHRlclNwYWNpbmciLAogICAgICAgICAgbGlnaHRpbmdjb2xvcjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgImxpZ2h0aW5nLWNvbG9yIjogImxpZ2h0aW5nQ29sb3IiLAogICAgICAgICAgbGltaXRpbmdjb25lYW5nbGU6ICJsaW1pdGluZ0NvbmVBbmdsZSIsCiAgICAgICAgICBsb2NhbDogImxvY2FsIiwKICAgICAgICAgIG1hcmtlcmVuZDogIm1hcmtlckVuZCIsCiAgICAgICAgICAibWFya2VyLWVuZCI6ICJtYXJrZXJFbmQiLAogICAgICAgICAgbWFya2VyaGVpZ2h0OiAibWFya2VySGVpZ2h0IiwKICAgICAgICAgIG1hcmtlcm1pZDogIm1hcmtlck1pZCIsCiAgICAgICAgICAibWFya2VyLW1pZCI6ICJtYXJrZXJNaWQiLAogICAgICAgICAgbWFya2Vyc3RhcnQ6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICAibWFya2VyLXN0YXJ0IjogIm1hcmtlclN0YXJ0IiwKICAgICAgICAgIG1hcmtlcnVuaXRzOiAibWFya2VyVW5pdHMiLAogICAgICAgICAgbWFya2Vyd2lkdGg6ICJtYXJrZXJXaWR0aCIsCiAgICAgICAgICBtYXNrOiAibWFzayIsCiAgICAgICAgICBtYXNrY29udGVudHVuaXRzOiAibWFza0NvbnRlbnRVbml0cyIsCiAgICAgICAgICBtYXNrdW5pdHM6ICJtYXNrVW5pdHMiLAogICAgICAgICAgbWF0aGVtYXRpY2FsOiAibWF0aGVtYXRpY2FsIiwKICAgICAgICAgIG1vZGU6ICJtb2RlIiwKICAgICAgICAgIG51bW9jdGF2ZXM6ICJudW1PY3RhdmVzIiwKICAgICAgICAgIG9mZnNldDogIm9mZnNldCIsCiAgICAgICAgICBvcGFjaXR5OiAib3BhY2l0eSIsCiAgICAgICAgICBvcGVyYXRvcjogIm9wZXJhdG9yIiwKICAgICAgICAgIG9yZGVyOiAib3JkZXIiLAogICAgICAgICAgb3JpZW50OiAib3JpZW50IiwKICAgICAgICAgIG9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iLAogICAgICAgICAgb3JpZ2luOiAib3JpZ2luIiwKICAgICAgICAgIG92ZXJmbG93OiAib3ZlcmZsb3ciLAogICAgICAgICAgb3ZlcmxpbmVwb3NpdGlvbjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXBvc2l0aW9uIjogIm92ZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgb3ZlcmxpbmV0aGlja25lc3M6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAib3ZlcmxpbmUtdGhpY2tuZXNzIjogIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHBhaW50b3JkZXI6ICJwYWludE9yZGVyIiwKICAgICAgICAgICJwYWludC1vcmRlciI6ICJwYWludE9yZGVyIiwKICAgICAgICAgIHBhbm9zZTE6ICJwYW5vc2UxIiwKICAgICAgICAgICJwYW5vc2UtMSI6ICJwYW5vc2UxIiwKICAgICAgICAgIHBhdGhsZW5ndGg6ICJwYXRoTGVuZ3RoIiwKICAgICAgICAgIHBhdHRlcm5jb250ZW50dW5pdHM6ICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAgICAgICAgIHBhdHRlcm50cmFuc2Zvcm06ICJwYXR0ZXJuVHJhbnNmb3JtIiwKICAgICAgICAgIHBhdHRlcm51bml0czogInBhdHRlcm5Vbml0cyIsCiAgICAgICAgICBwb2ludGVyZXZlbnRzOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICAicG9pbnRlci1ldmVudHMiOiAicG9pbnRlckV2ZW50cyIsCiAgICAgICAgICBwb2ludHM6ICJwb2ludHMiLAogICAgICAgICAgcG9pbnRzYXR4OiAicG9pbnRzQXRYIiwKICAgICAgICAgIHBvaW50c2F0eTogInBvaW50c0F0WSIsCiAgICAgICAgICBwb2ludHNhdHo6ICJwb2ludHNBdFoiLAogICAgICAgICAgcHJlZml4OiAicHJlZml4IiwKICAgICAgICAgIHByZXNlcnZlYWxwaGE6ICJwcmVzZXJ2ZUFscGhhIiwKICAgICAgICAgIHByZXNlcnZlYXNwZWN0cmF0aW86ICJwcmVzZXJ2ZUFzcGVjdFJhdGlvIiwKICAgICAgICAgIHByaW1pdGl2ZXVuaXRzOiAicHJpbWl0aXZlVW5pdHMiLAogICAgICAgICAgcHJvcGVydHk6ICJwcm9wZXJ0eSIsCiAgICAgICAgICByOiAiciIsCiAgICAgICAgICByYWRpdXM6ICJyYWRpdXMiLAogICAgICAgICAgcmVmeDogInJlZlgiLAogICAgICAgICAgcmVmeTogInJlZlkiLAogICAgICAgICAgcmVuZGVyaW5naW50ZW50OiAicmVuZGVyaW5nSW50ZW50IiwKICAgICAgICAgICJyZW5kZXJpbmctaW50ZW50IjogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICByZXBlYXRjb3VudDogInJlcGVhdENvdW50IiwKICAgICAgICAgIHJlcGVhdGR1cjogInJlcGVhdER1ciIsCiAgICAgICAgICByZXF1aXJlZGV4dGVuc2lvbnM6ICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICAgICAgICAgcmVxdWlyZWRmZWF0dXJlczogInJlcXVpcmVkRmVhdHVyZXMiLAogICAgICAgICAgcmVzb3VyY2U6ICJyZXNvdXJjZSIsCiAgICAgICAgICByZXN0YXJ0OiAicmVzdGFydCIsCiAgICAgICAgICByZXN1bHQ6ICJyZXN1bHQiLAogICAgICAgICAgcmVzdWx0czogInJlc3VsdHMiLAogICAgICAgICAgcm90YXRlOiAicm90YXRlIiwKICAgICAgICAgIHJ4OiAicngiLAogICAgICAgICAgcnk6ICJyeSIsCiAgICAgICAgICBzY2FsZTogInNjYWxlIiwKICAgICAgICAgIHNlY3VyaXR5OiAic2VjdXJpdHkiLAogICAgICAgICAgc2VlZDogInNlZWQiLAogICAgICAgICAgc2hhcGVyZW5kZXJpbmc6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIjogInNoYXBlUmVuZGVyaW5nIiwKICAgICAgICAgIHNsb3BlOiAic2xvcGUiLAogICAgICAgICAgc3BhY2luZzogInNwYWNpbmciLAogICAgICAgICAgc3BlY3VsYXJjb25zdGFudDogInNwZWN1bGFyQ29uc3RhbnQiLAogICAgICAgICAgc3BlY3VsYXJleHBvbmVudDogInNwZWN1bGFyRXhwb25lbnQiLAogICAgICAgICAgc3BlZWQ6ICJzcGVlZCIsCiAgICAgICAgICBzcHJlYWRtZXRob2Q6ICJzcHJlYWRNZXRob2QiLAogICAgICAgICAgc3RhcnRvZmZzZXQ6ICJzdGFydE9mZnNldCIsCiAgICAgICAgICBzdGRkZXZpYXRpb246ICJzdGREZXZpYXRpb24iLAogICAgICAgICAgc3RlbWg6ICJzdGVtaCIsCiAgICAgICAgICBzdGVtdjogInN0ZW12IiwKICAgICAgICAgIHN0aXRjaHRpbGVzOiAic3RpdGNoVGlsZXMiLAogICAgICAgICAgc3RvcGNvbG9yOiAic3RvcENvbG9yIiwKICAgICAgICAgICJzdG9wLWNvbG9yIjogInN0b3BDb2xvciIsCiAgICAgICAgICBzdG9wb3BhY2l0eTogInN0b3BPcGFjaXR5IiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiOiAic3RvcE9wYWNpdHkiLAogICAgICAgICAgc3RyaWtldGhyb3VnaHBvc2l0aW9uOiAic3RyaWtldGhyb3VnaFBvc2l0aW9uIiwKICAgICAgICAgICJzdHJpa2V0aHJvdWdoLXBvc2l0aW9uIjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICBzdHJpa2V0aHJvdWdodGhpY2tuZXNzOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC10aGlja25lc3MiOiAic3RyaWtldGhyb3VnaFRoaWNrbmVzcyIsCiAgICAgICAgICBzdHJpbmc6ICJzdHJpbmciLAogICAgICAgICAgc3Ryb2tlOiAic3Ryb2tlIiwKICAgICAgICAgIHN0cm9rZWRhc2hhcnJheTogInN0cm9rZURhc2hhcnJheSIsCiAgICAgICAgICAic3Ryb2tlLWRhc2hhcnJheSI6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgc3Ryb2tlZGFzaG9mZnNldDogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgInN0cm9rZS1kYXNob2Zmc2V0IjogInN0cm9rZURhc2hvZmZzZXQiLAogICAgICAgICAgc3Ryb2tlbGluZWNhcDogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lY2FwIjogInN0cm9rZUxpbmVjYXAiLAogICAgICAgICAgc3Ryb2tlbGluZWpvaW46ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVqb2luIjogInN0cm9rZUxpbmVqb2luIiwKICAgICAgICAgIHN0cm9rZW1pdGVybGltaXQ6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgICJzdHJva2UtbWl0ZXJsaW1pdCI6ICJzdHJva2VNaXRlcmxpbWl0IiwKICAgICAgICAgIHN0cm9rZXdpZHRoOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgInN0cm9rZS13aWR0aCI6ICJzdHJva2VXaWR0aCIsCiAgICAgICAgICBzdHJva2VvcGFjaXR5OiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICAic3Ryb2tlLW9wYWNpdHkiOiAic3Ryb2tlT3BhY2l0eSIsCiAgICAgICAgICBzdXBwcmVzc2NvbnRlbnRlZGl0YWJsZXdhcm5pbmc6ICJzdXBwcmVzc0NvbnRlbnRFZGl0YWJsZVdhcm5pbmciLAogICAgICAgICAgc3VwcHJlc3NoeWRyYXRpb253YXJuaW5nOiAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgIHN1cmZhY2VzY2FsZTogInN1cmZhY2VTY2FsZSIsCiAgICAgICAgICBzeXN0ZW1sYW5ndWFnZTogInN5c3RlbUxhbmd1YWdlIiwKICAgICAgICAgIHRhYmxldmFsdWVzOiAidGFibGVWYWx1ZXMiLAogICAgICAgICAgdGFyZ2V0eDogInRhcmdldFgiLAogICAgICAgICAgdGFyZ2V0eTogInRhcmdldFkiLAogICAgICAgICAgdGV4dGFuY2hvcjogInRleHRBbmNob3IiLAogICAgICAgICAgInRleHQtYW5jaG9yIjogInRleHRBbmNob3IiLAogICAgICAgICAgdGV4dGRlY29yYXRpb246ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICAidGV4dC1kZWNvcmF0aW9uIjogInRleHREZWNvcmF0aW9uIiwKICAgICAgICAgIHRleHRsZW5ndGg6ICJ0ZXh0TGVuZ3RoIiwKICAgICAgICAgIHRleHRyZW5kZXJpbmc6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgICJ0ZXh0LXJlbmRlcmluZyI6ICJ0ZXh0UmVuZGVyaW5nIiwKICAgICAgICAgIHRvOiAidG8iLAogICAgICAgICAgdHJhbnNmb3JtOiAidHJhbnNmb3JtIiwKICAgICAgICAgIHR5cGVvZjogInR5cGVvZiIsCiAgICAgICAgICB1MTogInUxIiwKICAgICAgICAgIHUyOiAidTIiLAogICAgICAgICAgdW5kZXJsaW5lcG9zaXRpb246ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICAidW5kZXJsaW5lLXBvc2l0aW9uIjogInVuZGVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIHVuZGVybGluZXRoaWNrbmVzczogInVuZGVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICAidW5kZXJsaW5lLXRoaWNrbmVzcyI6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgdW5pY29kZTogInVuaWNvZGUiLAogICAgICAgICAgdW5pY29kZWJpZGk6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICAidW5pY29kZS1iaWRpIjogInVuaWNvZGVCaWRpIiwKICAgICAgICAgIHVuaWNvZGVyYW5nZTogInVuaWNvZGVSYW5nZSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSI6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgdW5pdHNwZXJlbTogInVuaXRzUGVyRW0iLAogICAgICAgICAgInVuaXRzLXBlci1lbSI6ICJ1bml0c1BlckVtIiwKICAgICAgICAgIHVuc2VsZWN0YWJsZTogInVuc2VsZWN0YWJsZSIsCiAgICAgICAgICB2YWxwaGFiZXRpYzogInZBbHBoYWJldGljIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiOiAidkFscGhhYmV0aWMiLAogICAgICAgICAgdmFsdWVzOiAidmFsdWVzIiwKICAgICAgICAgIHZlY3RvcmVmZmVjdDogInZlY3RvckVmZmVjdCIsCiAgICAgICAgICAidmVjdG9yLWVmZmVjdCI6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgdmVyc2lvbjogInZlcnNpb24iLAogICAgICAgICAgdmVydGFkdnk6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICAidmVydC1hZHYteSI6ICJ2ZXJ0QWR2WSIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueDogInZlcnRPcmlnaW5YIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi14IjogInZlcnRPcmlnaW5YIiwKICAgICAgICAgIHZlcnRvcmlnaW55OiAidmVydE9yaWdpblkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiOiAidmVydE9yaWdpblkiLAogICAgICAgICAgdmhhbmdpbmc6ICJ2SGFuZ2luZyIsCiAgICAgICAgICAidi1oYW5naW5nIjogInZIYW5naW5nIiwKICAgICAgICAgIHZpZGVvZ3JhcGhpYzogInZJZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyI6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgdmlld2JveDogInZpZXdCb3giLAogICAgICAgICAgdmlld3RhcmdldDogInZpZXdUYXJnZXQiLAogICAgICAgICAgdmlzaWJpbGl0eTogInZpc2liaWxpdHkiLAogICAgICAgICAgdm1hdGhlbWF0aWNhbDogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgInYtbWF0aGVtYXRpY2FsIjogInZNYXRoZW1hdGljYWwiLAogICAgICAgICAgdm9jYWI6ICJ2b2NhYiIsCiAgICAgICAgICB3aWR0aHM6ICJ3aWR0aHMiLAogICAgICAgICAgd29yZHNwYWNpbmc6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICAid29yZC1zcGFjaW5nIjogIndvcmRTcGFjaW5nIiwKICAgICAgICAgIHdyaXRpbmdtb2RlOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgIndyaXRpbmctbW9kZSI6ICJ3cml0aW5nTW9kZSIsCiAgICAgICAgICB4MTogIngxIiwKICAgICAgICAgIHgyOiAieDIiLAogICAgICAgICAgeDogIngiLAogICAgICAgICAgeGNoYW5uZWxzZWxlY3RvcjogInhDaGFubmVsU2VsZWN0b3IiLAogICAgICAgICAgeGhlaWdodDogInhIZWlnaHQiLAogICAgICAgICAgIngtaGVpZ2h0IjogInhIZWlnaHQiLAogICAgICAgICAgeGxpbmthY3R1YXRlOiAieGxpbmtBY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphY3R1YXRlIjogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICB4bGlua2FyY3JvbGU6ICJ4bGlua0FyY3JvbGUiLAogICAgICAgICAgInhsaW5rOmFyY3JvbGUiOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgIHhsaW5raHJlZjogInhsaW5rSHJlZiIsCiAgICAgICAgICAieGxpbms6aHJlZiI6ICJ4bGlua0hyZWYiLAogICAgICAgICAgeGxpbmtyb2xlOiAieGxpbmtSb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIjogInhsaW5rUm9sZSIsCiAgICAgICAgICB4bGlua3Nob3c6ICJ4bGlua1Nob3ciLAogICAgICAgICAgInhsaW5rOnNob3ciOiAieGxpbmtTaG93IiwKICAgICAgICAgIHhsaW5rdGl0bGU6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgICJ4bGluazp0aXRsZSI6ICJ4bGlua1RpdGxlIiwKICAgICAgICAgIHhsaW5rdHlwZTogInhsaW5rVHlwZSIsCiAgICAgICAgICAieGxpbms6dHlwZSI6ICJ4bGlua1R5cGUiLAogICAgICAgICAgeG1sYmFzZTogInhtbEJhc2UiLAogICAgICAgICAgInhtbDpiYXNlIjogInhtbEJhc2UiLAogICAgICAgICAgeG1sbGFuZzogInhtbExhbmciLAogICAgICAgICAgInhtbDpsYW5nIjogInhtbExhbmciLAogICAgICAgICAgeG1sbnM6ICJ4bWxucyIsCiAgICAgICAgICAieG1sOnNwYWNlIjogInhtbFNwYWNlIiwKICAgICAgICAgIHhtbG5zeGxpbms6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgICJ4bWxuczp4bGluayI6ICJ4bWxuc1hsaW5rIiwKICAgICAgICAgIHhtbHNwYWNlOiAieG1sU3BhY2UiLAogICAgICAgICAgeTE6ICJ5MSIsCiAgICAgICAgICB5MjogInkyIiwKICAgICAgICAgIHk6ICJ5IiwKICAgICAgICAgIHljaGFubmVsc2VsZWN0b3I6ICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHo6ICJ6IiwKICAgICAgICAgIHpvb21hbmRwYW46ICJ6b29tQW5kUGFuIgogICAgICAgIH07CiAgICAgICAgdmFyIGFyaWFQcm9wZXJ0aWVzID0gewogICAgICAgICAgImFyaWEtY3VycmVudCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtZGVzY3JpcHRpb24iOiAwLAogICAgICAgICAgImFyaWEtZGV0YWlscyI6IDAsCiAgICAgICAgICAiYXJpYS1kaXNhYmxlZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaGlkZGVuIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1pbnZhbGlkIjogMCwKICAgICAgICAgIC8vIHN0YXRlCiAgICAgICAgICAiYXJpYS1rZXlzaG9ydGN1dHMiOiAwLAogICAgICAgICAgImFyaWEtbGFiZWwiOiAwLAogICAgICAgICAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgIC8vIFdpZGdldCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1hdXRvY29tcGxldGUiOiAwLAogICAgICAgICAgImFyaWEtY2hlY2tlZCI6IDAsCiAgICAgICAgICAiYXJpYS1leHBhbmRlZCI6IDAsCiAgICAgICAgICAiYXJpYS1oYXNwb3B1cCI6IDAsCiAgICAgICAgICAiYXJpYS1sZXZlbCI6IDAsCiAgICAgICAgICAiYXJpYS1tb2RhbCI6IDAsCiAgICAgICAgICAiYXJpYS1tdWx0aWxpbmUiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlzZWxlY3RhYmxlIjogMCwKICAgICAgICAgICJhcmlhLW9yaWVudGF0aW9uIjogMCwKICAgICAgICAgICJhcmlhLXBsYWNlaG9sZGVyIjogMCwKICAgICAgICAgICJhcmlhLXByZXNzZWQiOiAwLAogICAgICAgICAgImFyaWEtcmVhZG9ubHkiOiAwLAogICAgICAgICAgImFyaWEtcmVxdWlyZWQiOiAwLAogICAgICAgICAgImFyaWEtc2VsZWN0ZWQiOiAwLAogICAgICAgICAgImFyaWEtc29ydCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1heCI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW1pbiI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZW5vdyI6IDAsCiAgICAgICAgICAiYXJpYS12YWx1ZXRleHQiOiAwLAogICAgICAgICAgLy8gTGl2ZSBSZWdpb24gQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXRvbWljIjogMCwKICAgICAgICAgICJhcmlhLWJ1c3kiOiAwLAogICAgICAgICAgImFyaWEtbGl2ZSI6IDAsCiAgICAgICAgICAiYXJpYS1yZWxldmFudCI6IDAsCiAgICAgICAgICAvLyBEcmFnLWFuZC1Ecm9wIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWRyb3BlZmZlY3QiOiAwLAogICAgICAgICAgImFyaWEtZ3JhYmJlZCI6IDAsCiAgICAgICAgICAvLyBSZWxhdGlvbnNoaXAgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYWN0aXZlZGVzY2VuZGFudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xjb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1jb2xzcGFuIjogMCwKICAgICAgICAgICJhcmlhLWNvbnRyb2xzIjogMCwKICAgICAgICAgICJhcmlhLWRlc2NyaWJlZGJ5IjogMCwKICAgICAgICAgICJhcmlhLWVycm9ybWVzc2FnZSI6IDAsCiAgICAgICAgICAiYXJpYS1mbG93dG8iOiAwLAogICAgICAgICAgImFyaWEtbGFiZWxsZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1vd25zIjogMCwKICAgICAgICAgICJhcmlhLXBvc2luc2V0IjogMCwKICAgICAgICAgICJhcmlhLXJvd2NvdW50IjogMCwKICAgICAgICAgICJhcmlhLXJvd2luZGV4IjogMCwKICAgICAgICAgICJhcmlhLXJvd3NwYW4iOiAwLAogICAgICAgICAgImFyaWEtc2V0c2l6ZSI6IDAKICAgICAgICB9OwogICAgICAgIHZhciB3YXJuZWRQcm9wZXJ0aWVzID0ge307CiAgICAgICAgdmFyIHJBUklBID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgdmFyIHJBUklBQ2FtZWwgPSBuZXcgUmVnRXhwKCJeKGFyaWEpW0EtWl1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0eSh0YWdOYW1lLCBuYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMsIG5hbWUpICYmIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUFDYW1lbC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGFyaWFOYW1lID0gImFyaWEtIiArIG5hbWUuc2xpY2UoNCkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICB2YXIgY29ycmVjdE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShhcmlhTmFtZSkgPyBhcmlhTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3ROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIEFSSUEgYXR0cmlidXRlcyBmb2xsb3cgdGhlIHBhdHRlcm4gYXJpYS0qIGFuZCBtdXN0IGJlIGxvd2VyY2FzZS4iLCBuYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuYW1lICE9PSBjb3JyZWN0TmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgY29ycmVjdE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGFyaWFQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IGxvd2VyQ2FzZWROYW1lIDogbnVsbDsKICAgICAgICAgICAgICBpZiAoc3RhbmRhcmROYW1lID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gc3RhbmRhcmROYW1lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVW5rbm93biBBUklBIGF0dHJpYnV0ZSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW52YWxpZFByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSh0eXBlLCBrZXkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgaW52YWxpZFByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gaW52YWxpZFByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmIChpbnZhbGlkUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhcmlhIHByb3BzICVzIG9uIDwlcz4gdGFnLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWFyaWEtcHJvcHMiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JbnZhbGlkQVJJQVByb3BzKHR5cGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZU51bGwgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZSAhPT0gImlucHV0IiAmJiB0eXBlICE9PSAidGV4dGFyZWEiICYmIHR5cGUgIT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcyAhPSBudWxsICYmIHByb3BzLnZhbHVlID09PSBudWxsICYmICFkaWRXYXJuVmFsdWVOdWxsKSB7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlTnVsbCA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiICYmIHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiYHZhbHVlYCBwcm9wIG9uIGAlc2Agc2hvdWxkIG5vdCBiZSBudWxsLiBDb25zaWRlciB1c2luZyBhbiBlbXB0eSBhcnJheSB3aGVuIGBtdWx0aXBsZWAgaXMgc2V0IHRvIGB0cnVlYCB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgc3RyaW5nIHRvIGNsZWFyIHRoZSBjb21wb25lbnQgb3IgYHVuZGVmaW5lZGAgZm9yIHVuY29udHJvbGxlZCBjb21wb25lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyQxID0ge307CiAgICAgICAgICB2YXIgRVZFTlRfTkFNRV9SRUdFWCA9IC9eb24uLzsKICAgICAgICAgIHZhciBJTlZBTElEX0VWRU5UX05BTUVfUkVHRVggPSAvXm9uW15BLVpdLzsKICAgICAgICAgIHZhciByQVJJQSQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKS1bIiArIEFUVFJJQlVURV9OQU1FX0NIQVIgKyAiXSokIik7CiAgICAgICAgICB2YXIgckFSSUFDYW1lbCQxID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0eSQxID0gZnVuY3Rpb24odGFnTmFtZSwgbmFtZSwgdmFsdWUsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwod2FybmVkUHJvcGVydGllcyQxLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gIm9uZm9jdXNpbiIgfHwgbG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3Vzb3V0IikgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCB1c2VzIG9uRm9jdXMgYW5kIG9uQmx1ciBpbnN0ZWFkIG9mIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dC4gQWxsIFJlYWN0IGV2ZW50cyBhcmUgbm9ybWFsaXplZCB0byBidWJibGUsIHNvIG9uRm9jdXNJbiBhbmQgb25Gb2N1c091dCBhcmUgbm90IG5lZWRlZC9zdXBwb3J0ZWQgYnkgUmVhY3QuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnRSZWdpc3RyeSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyID0gZXZlbnRSZWdpc3RyeS5yZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLCBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMiA9IGV2ZW50UmVnaXN0cnkucG9zc2libGVSZWdpc3RyYXRpb25OYW1lczsKICAgICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llczIuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSA/IHBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXMyW2xvd2VyQ2FzZWROYW1lXSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBJdCB3aWxsIGJlIGlnbm9yZWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKEVWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIGlmIChJTlZBTElEX0VWRU5UX05BTUVfUkVHRVgudGVzdChuYW1lKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgZXZlbnQgaGFuZGxlciBwcm9wZXJ0eSBgJXNgLiBSZWFjdCBldmVudHMgdXNlIHRoZSBjYW1lbENhc2UgbmFtaW5nIGNvbnZlbnRpb24sIGZvciBleGFtcGxlIGBvbkNsaWNrYC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAockFSSUEkMS50ZXN0KG5hbWUpIHx8IHJBUklBQ2FtZWwkMS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiaW5uZXJodG1sIikgewogICAgICAgICAgICAgIGVycm9yKCJEaXJlY3RseSBzZXR0aW5nIHByb3BlcnR5IGBpbm5lckhUTUxgIGlzIG5vdCBwZXJtaXR0ZWQuIEZvciBtb3JlIGluZm9ybWF0aW9uLCBsb29rdXAgZG9jdW1lbnRhdGlvbiBvbiBgZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgLiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxvd2VyQ2FzZWROYW1lID09PSAiYXJpYSIpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGBhcmlhYCBhdHRyaWJ1dGUgaXMgcmVzZXJ2ZWQgZm9yIGZ1dHVyZSB1c2UgaW4gUmVhY3QuIFBhc3MgaW5kaXZpZHVhbCBgYXJpYS1gIGF0dHJpYnV0ZXMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlzIiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYSBgJXNgIGZvciBhIHN0cmluZyBhdHRyaWJ1dGUgYGlzYC4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgdHlwZW9mIHZhbHVlKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiICYmIGlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBOYU4gZm9yIHRoZSBgJXNgIGF0dHJpYnV0ZS4gSWYgdGhpcyBpcyBleHBlY3RlZCwgY2FzdCB0aGUgdmFsdWUgdG8gYSBzdHJpbmcuIiwgbmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgICB2YXIgaXNSZXNlcnZlZCA9IHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gUkVTRVJWRUQ7CiAgICAgICAgICAgIGlmIChwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgRE9NIHByb3BlcnR5IGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKCFpc1Jlc2VydmVkICYmIG5hbWUgIT09IGxvd2VyQ2FzZWROYW1lKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGRvZXMgbm90IHJlY29nbml6ZSB0aGUgYCVzYCBwcm9wIG9uIGEgRE9NIGVsZW1lbnQuIElmIHlvdSBpbnRlbnRpb25hbGx5IHdhbnQgaXQgdG8gYXBwZWFyIGluIHRoZSBET00gYXMgYSBjdXN0b20gYXR0cmlidXRlLCBzcGVsbCBpdCBhcyBsb3dlcmNhc2UgYCVzYCBpbnN0ZWFkLiBJZiB5b3UgYWNjaWRlbnRhbGx5IHBhc3NlZCBpdCBmcm9tIGEgcGFyZW50IGNvbXBvbmVudCwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBlbGVtZW50LiIsIG5hbWUsIGxvd2VyQ2FzZWROYW1lKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiAmJiBzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCdSZWNlaXZlZCBgJXNgIGZvciBhIG5vbi1ib29sZWFuIGF0dHJpYnV0ZSBgJXNgLlxuXG5JZiB5b3Ugd2FudCB0byB3cml0ZSBpdCB0byB0aGUgRE9NLCBwYXNzIGEgc3RyaW5nIGluc3RlYWQ6ICVzPSIlcyIgb3IgJXM9e3ZhbHVlLnRvU3RyaW5nKCl9LlxuXG5JZiB5b3UgdXNlZCB0byBjb25kaXRpb25hbGx5IG9taXQgaXQgd2l0aCAlcz17Y29uZGl0aW9uICYmIHZhbHVlfSwgcGFzcyAlcz17Y29uZGl0aW9uID8gdmFsdWUgOiB1bmRlZmluZWR9IGluc3RlYWQuJywgdmFsdWUsIG5hbWUsIG5hbWUsIHZhbHVlLCBuYW1lLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNSZXNlcnZlZCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRSZW1vdmVBdHRyaWJ1dGVXaXRoV2FybmluZyhuYW1lLCB2YWx1ZSwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHZhbHVlID09PSAiZmFsc2UiIHx8IHZhbHVlID09PSAidHJ1ZSIpICYmIHByb3BlcnR5SW5mbyAhPT0gbnVsbCAmJiBwcm9wZXJ0eUluZm8udHlwZSA9PT0gQk9PTEVBTikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCB0aGUgc3RyaW5nIGAlc2AgZm9yIHRoZSBib29sZWFuIGF0dHJpYnV0ZSBgJXNgLiAlcyBEaWQgeW91IG1lYW4gJXM9eyVzfT8iLCB2YWx1ZSwgbmFtZSwgdmFsdWUgPT09ICJmYWxzZSIgPyAiVGhlIGJyb3dzZXIgd2lsbCBpbnRlcnByZXQgaXQgYXMgYSB0cnV0aHkgdmFsdWUuIiA6ICdBbHRob3VnaCB0aGlzIHdvcmtzLCBpdCB3aWxsIG5vdCB3b3JrIGFzIGV4cGVjdGVkIGlmIHlvdSBwYXNzIHRoZSBzdHJpbmcgImZhbHNlIi4nLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVW5rbm93blByb3BlcnRpZXMgPSBmdW5jdGlvbih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5rbm93blByb3BzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gdmFsaWRhdGVQcm9wZXJ0eSQxKHR5cGUsIGtleSwgcHJvcHNba2V5XSwgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgICAgICAgICB1bmtub3duUHJvcHMucHVzaChrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdW5rbm93blByb3BTdHJpbmcgPSB1bmtub3duUHJvcHMubWFwKGZ1bmN0aW9uKHByb3ApIHsKICAgICAgICAgICAgICByZXR1cm4gImAiICsgcHJvcCArICJgIjsKICAgICAgICAgICAgfSkuam9pbigiLCAiKTsKICAgICAgICAgICAgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZSBmb3IgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSBpdCBmcm9tIHRoZSBlbGVtZW50LCBvciBwYXNzIGEgc3RyaW5nIG9yIG51bWJlciB2YWx1ZSB0byBrZWVwIGl0IGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodW5rbm93blByb3BzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCB2YWx1ZXMgZm9yIHByb3BzICVzIG9uIDwlcz4gdGFnLiBFaXRoZXIgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCB0aGVtIGluIHRoZSBET00uIEZvciBkZXRhaWxzLCBzZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2F0dHJpYnV0ZS1iZWhhdmlvciAiLCB1bmtub3duUHJvcFN0cmluZywgdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5Vbmtub3duUHJvcGVydGllcyh0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSk7CiAgICAgICAgfQogICAgICAgIHZhciBJU19FVkVOVF9IQU5ETEVfTk9OX01BTkFHRURfTk9ERSA9IDE7CiAgICAgICAgdmFyIElTX05PTl9ERUxFR0FURUQgPSAxIDw8IDE7CiAgICAgICAgdmFyIElTX0NBUFRVUkVfUEhBU0UgPSAxIDw8IDI7CiAgICAgICAgdmFyIFNIT1VMRF9OT1RfUFJPQ0VTU19QT0xZRklMTF9FVkVOVF9QTFVHSU5TID0gSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgfCBJU19OT05fREVMRUdBVEVEIHwgSVNfQ0FQVFVSRV9QSEFTRTsKICAgICAgICB2YXIgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gZXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVwbGF5aW5nRXZlbnQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50UmVwbGF5aW5nRXZlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgY3VycmVudGx5IHJlcGxheWluZyBldmVudCB0byBub3QgYmUgbnVsbC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFJlcGxheWluZ0V2ZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZXBsYXlpbmdFdmVudChldmVudCkgewogICAgICAgICAgcmV0dXJuIGV2ZW50ID09PSBjdXJyZW50UmVwbGF5aW5nRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbmF0aXZlRXZlbnQudGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LnNyY0VsZW1lbnQgfHwgd2luZG93OwogICAgICAgICAgaWYgKHRhcmdldC5jb3JyZXNwb25kaW5nVXNlRWxlbWVudCkgewogICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGFyZ2V0Lm5vZGVUeXBlID09PSBURVhUX05PREUgPyB0YXJnZXQucGFyZW50Tm9kZSA6IHRhcmdldDsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc3RvcmVJbXBsID0gbnVsbDsKICAgICAgICB2YXIgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgaW50ZXJuYWxJbnN0YW5jZSA9IGdldEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0KTsKICAgICAgICAgIGlmICghaW50ZXJuYWxJbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHJlc3RvcmVJbXBsICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0UmVzdG9yZUltcGxlbWVudGF0aW9uKCkgbmVlZHMgdG8gYmUgY2FsbGVkIHRvIGhhbmRsZSBhIHRhcmdldCBmb3IgY29udHJvbGxlZCBldmVudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gaW50ZXJuYWxJbnN0YW5jZS5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAoc3RhdGVOb2RlKSB7CiAgICAgICAgICAgIHZhciBfcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICAgIHJlc3RvcmVJbXBsKGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlLCBpbnRlcm5hbEluc3RhbmNlLnR5cGUsIF9wcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihpbXBsKSB7CiAgICAgICAgICByZXN0b3JlSW1wbCA9IGltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KSB7CiAgICAgICAgICBpZiAocmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICBpZiAocmVzdG9yZVF1ZXVlKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlLnB1c2godGFyZ2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN0b3JlUXVldWUgPSBbdGFyZ2V0XTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdG9yZVRhcmdldCA9IHRhcmdldDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbmVlZHNTdGF0ZVJlc3RvcmUoKSB7CiAgICAgICAgICByZXR1cm4gcmVzdG9yZVRhcmdldCAhPT0gbnVsbCB8fCByZXN0b3JlUXVldWUgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCkgewogICAgICAgICAgaWYgKCFyZXN0b3JlVGFyZ2V0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXQgPSByZXN0b3JlVGFyZ2V0OwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldHMgPSByZXN0b3JlUXVldWU7CiAgICAgICAgICByZXN0b3JlVGFyZ2V0ID0gbnVsbDsKICAgICAgICAgIHJlc3RvcmVRdWV1ZSA9IG51bGw7CiAgICAgICAgICByZXN0b3JlU3RhdGVPZlRhcmdldCh0YXJnZXQpOwogICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldHMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZWRUYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQocXVldWVkVGFyZ2V0c1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJhdGNoZWRVcGRhdGVzSW1wbCA9IGZ1bmN0aW9uKGZuLCBib29ra2VlcGluZykgewogICAgICAgICAgcmV0dXJuIGZuKGJvb2trZWVwaW5nKTsKICAgICAgICB9OwogICAgICAgIHZhciBmbHVzaFN5bmNJbXBsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmaW5pc2hFdmVudEhhbmRsZXIoKSB7CiAgICAgICAgICB2YXIgY29udHJvbGxlZENvbXBvbmVudHNIYXZlUGVuZGluZ1VwZGF0ZXMgPSBuZWVkc1N0YXRlUmVzdG9yZSgpOwogICAgICAgICAgaWYgKGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0ltcGwoKTsKICAgICAgICAgICAgcmVzdG9yZVN0YXRlSWZOZWVkZWQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMoZm4sIGEsIGIpIHsKICAgICAgICAgIGlmIChpc0luc2lkZUV2ZW50SGFuZGxlcikgewogICAgICAgICAgICByZXR1cm4gZm4oYSwgYik7CiAgICAgICAgICB9CiAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gYmF0Y2hlZFVwZGF0ZXNJbXBsKGZuLCBhLCBiKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgICAgIGZpbmlzaEV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKF9iYXRjaGVkVXBkYXRlc0ltcGwsIF9kaXNjcmV0ZVVwZGF0ZXNJbXBsLCBfZmx1c2hTeW5jSW1wbCkgewogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXNJbXBsID0gX2JhdGNoZWRVcGRhdGVzSW1wbDsKICAgICAgICAgIGZsdXNoU3luY0ltcGwgPSBfZmx1c2hTeW5jSW1wbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbnRlcmFjdGl2ZSh0YWcpIHsKICAgICAgICAgIHJldHVybiB0YWcgPT09ICJidXR0b24iIHx8IHRhZyA9PT0gImlucHV0IiB8fCB0YWcgPT09ICJzZWxlY3QiIHx8IHRhZyA9PT0gInRleHRhcmVhIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUHJldmVudE1vdXNlRXZlbnQobmFtZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICBjYXNlICJvbkNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25DbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbkRvdWJsZUNsaWNrIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGlja0NhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93biI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VEb3duQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZU1vdmVDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZVVwQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VFbnRlciI6CiAgICAgICAgICAgICAgcmV0dXJuICEhKHByb3BzLmRpc2FibGVkICYmIGlzSW50ZXJhY3RpdmUodHlwZSkpOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXIoaW5zdCwgcmVnaXN0cmF0aW9uTmFtZSkgewogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGluc3Quc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wcyA9IGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUoc3RhdGVOb2RlKTsKICAgICAgICAgIGlmIChwcm9wcyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lciA9IHByb3BzW3JlZ2lzdHJhdGlvbk5hbWVdOwogICAgICAgICAgaWYgKHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGluc3QudHlwZSwgcHJvcHMpKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGxpc3RlbmVyICYmIHR5cGVvZiBsaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGAiICsgcmVnaXN0cmF0aW9uTmFtZSArICJgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCIgKyB0eXBlb2YgbGlzdGVuZXIgKyAiYCB0eXBlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3B0aW9ucywgInBhc3NpdmUiLCB7CiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGZ1bmNBcmdzKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kOwogICAgICAgIHsKICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRpc3BhdGNoRXZlbnQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZG9jdW1lbnQuY3JlYXRlRXZlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZha2VOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicmVhY3QiKTsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCA9IGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFja0RldihuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhlIGBkb2N1bWVudGAgZ2xvYmFsIHdhcyBkZWZpbmVkIHdoZW4gUmVhY3Qgd2FzIGluaXRpYWxpemVkLCBidXQgaXMgbm90IGRlZmluZWQgYW55bW9yZS4gVGhpcyBjYW4gaGFwcGVuIGluIGEgdGVzdCBlbnZpcm9ubWVudCBpZiBhIGNvbXBvbmVudCBzY2hlZHVsZXMgYW4gdXBkYXRlIGZyb20gYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrLCBidXQgdGhlIHRlc3QgaGFzIGFscmVhZHkgZmluaXNoZWQgcnVubmluZy4gVG8gc29sdmUgdGhpcywgeW91IGNhbiBlaXRoZXIgdW5tb3VudCB0aGUgY29tcG9uZW50IGF0IHRoZSBlbmQgb2YgeW91ciB0ZXN0IChhbmQgZW5zdXJlIHRoYXQgYW55IGFzeW5jaHJvbm91cyBvcGVyYXRpb25zIGdldCBjYW5jZWxlZCBpbiBgY29tcG9uZW50V2lsbFVubW91bnRgKSwgb3IgeW91IGNhbiBjaGFuZ2UgdGhlIHRlc3QgaXRzZWxmIHRvIGJlIGFzeW5jaHJvbm91cy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudCIpOwogICAgICAgICAgICAgIHZhciBkaWRDYWxsID0gZmFsc2U7CiAgICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgd2luZG93RXZlbnQgPSB3aW5kb3cuZXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50RGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iod2luZG93LCAiZXZlbnQiKTsKICAgICAgICAgICAgICBmdW5jdGlvbiByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpIHsKICAgICAgICAgICAgICAgIGZha2VOb2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0VHlwZSwgY2FsbENhbGxiYWNrMiwgZmFsc2UpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuZXZlbnQgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgiZXZlbnQiKSkgewogICAgICAgICAgICAgICAgICB3aW5kb3cuZXZlbnQgPSB3aW5kb3dFdmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZ1bmNBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAzKTsKICAgICAgICAgICAgICBmdW5jdGlvbiBjYWxsQ2FsbGJhY2syKCkgewogICAgICAgICAgICAgICAgZGlkQ2FsbCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXN0b3JlQWZ0ZXJEaXNwYXRjaCgpOwogICAgICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICAgICAgICBkaWRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgIHZhciBkaWRTZXRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBpc0Nyb3NzT3JpZ2luRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVXaW5kb3dFcnJvcihldmVudCkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gZXZlbnQuZXJyb3I7CiAgICAgICAgICAgICAgICBkaWRTZXRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IyID09PSBudWxsICYmIGV2ZW50LmNvbG5vID09PSAwICYmIGV2ZW50LmxpbmVubyA9PT0gMCkgewogICAgICAgICAgICAgICAgICBpc0Nyb3NzT3JpZ2luRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIHR5cGVvZiBlcnJvcjIgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChpbm5lcikgewogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXZ0VHlwZSA9ICJyZWFjdC0iICsgKG5hbWUgPyBuYW1lIDogImludm9rZWd1YXJkZWRjYWxsYmFjayIpOwogICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBmYWtlTm9kZS5hZGRFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICBldnQuaW5pdEV2ZW50KGV2dFR5cGUsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgZmFrZU5vZGUuZGlzcGF0Y2hFdmVudChldnQpOwogICAgICAgICAgICAgIGlmICh3aW5kb3dFdmVudERlc2NyaXB0b3IpIHsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3csICJldmVudCIsIHdpbmRvd0V2ZW50RGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkaWRDYWxsICYmIGRpZEVycm9yKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFNldEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcihgQW4gZXJyb3Igd2FzIHRocm93biBpbnNpZGUgb25lIG9mIHlvdXIgY29tcG9uZW50cywgYnV0IFJlYWN0IGRvZXNuJ3Qga25vdyB3aGF0IGl0IHdhcy4gVGhpcyBpcyBsaWtlbHkgZHVlIHRvIGJyb3dzZXIgZmxha2luZXNzLiBSZWFjdCBkb2VzIGl0cyBiZXN0IHRvIHByZXNlcnZlIHRoZSAiUGF1c2Ugb24gZXhjZXB0aW9ucyIgYmVoYXZpb3Igb2YgdGhlIERldlRvb2xzLCB3aGljaCByZXF1aXJlcyBzb21lIERFVi1tb2RlIG9ubHkgdHJpY2tzLiBJdCdzIHBvc3NpYmxlIHRoYXQgdGhlc2UgZG9uJ3Qgd29yayBpbiB5b3VyIGJyb3dzZXIuIFRyeSB0cmlnZ2VyaW5nIHRoZSBlcnJvciBpbiBwcm9kdWN0aW9uIG1vZGUsIG9yIHN3aXRjaGluZyB0byBhIG1vZGVybiBicm93c2VyLiBJZiB5b3Ugc3VzcGVjdCB0aGF0IHRoaXMgaXMgYWN0dWFsbHkgYW4gaXNzdWUgd2l0aCBSZWFjdCwgcGxlYXNlIGZpbGUgYW4gaXNzdWUuYCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3Jvc3NPcmlnaW5FcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIkEgY3Jvc3Mtb3JpZ2luIGVycm9yIHdhcyB0aHJvd24uIFJlYWN0IGRvZXNuJ3QgaGF2ZSBhY2Nlc3MgdG8gdGhlIGFjdHVhbCBlcnJvciBvYmplY3QgaW4gZGV2ZWxvcG1lbnQuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY3Jvc3NvcmlnaW4tZXJyb3IgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm9uRXJyb3IoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoImVycm9yIiwgaGFuZGxlV2luZG93RXJyb3IpOwogICAgICAgICAgICAgIGlmICghZGlkQ2FsbCkgewogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIHJldHVybiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tQcm9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxID0gaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbDsKICAgICAgICB2YXIgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICB2YXIgcmVwb3J0ZXIgPSB7CiAgICAgICAgICBvbkVycm9yOiBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgICAgICBjYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGludm9rZUd1YXJkZWRDYWxsYmFjayhuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrSW1wbCQxLmFwcGx5KHJlcG9ydGVyLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tBbmRDYXRjaEZpcnN0RXJyb3IobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpIHsKICAgICAgICAgICAgdmFyIGVycm9yMiA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgaWYgKCFoYXNSZXRocm93RXJyb3IpIHsKICAgICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgIHJldGhyb3dFcnJvciA9IGVycm9yMjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRocm93Q2F1Z2h0RXJyb3IoKSB7CiAgICAgICAgICBpZiAoaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSByZXRocm93RXJyb3I7CiAgICAgICAgICAgIGhhc1JldGhyb3dFcnJvciA9IGZhbHNlOwogICAgICAgICAgICByZXRocm93RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc0NhdWdodEVycm9yKCkgewogICAgICAgICAgcmV0dXJuIGhhc0Vycm9yOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjYXVnaHRFcnJvcjsKICAgICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gZXJyb3IyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjbGVhckNhdWdodEVycm9yIHdhcyBjYWxsZWQgYnV0IG5vIGVycm9yIHdhcyBjYXB0dXJlZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0KGtleSkgewogICAgICAgICAgcmV0dXJuIGtleS5fcmVhY3RJbnRlcm5hbHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhcyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldChrZXksIHZhbHVlKSB7CiAgICAgICAgICBrZXkuX3JlYWN0SW50ZXJuYWxzID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBOb0ZsYWdzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBQZXJmb3JtZWRXb3JrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQbGFjZW1lbnQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBVcGRhdGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBDaGlsZERlbGV0aW9uID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgQ29udGVudFJlc2V0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMgogICAgICAgICk7CiAgICAgICAgdmFyIENhbGxiYWNrID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBEaWRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIEZvcmNlQ2xpZW50UmVuZGVyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAqLwogICAgICAgICAgMjU2CiAgICAgICAgKTsKICAgICAgICB2YXIgUmVmID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBTbmFwc2hvdCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwNDgKICAgICAgICApOwogICAgICAgIHZhciBIeWRyYXRpbmcgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBWaXNpYmlsaXR5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBTdG9yZUNvbnNpc3RlbmN5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Mzg0CiAgICAgICAgKTsKICAgICAgICB2YXIgTGlmZWN5Y2xlRWZmZWN0TWFzayA9IFBhc3NpdmUgfCBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmIHwgSHlkcmF0aW5nIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgTGF5b3V0TWFzayA9IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmIHwgVmlzaWJpbGl0eTsKICAgICAgICB2YXIgUGFzc2l2ZU1hc2sgPSBQYXNzaXZlIHwgQ2hpbGREZWxldGlvbjsKICAgICAgICB2YXIgU3RhdGljTWFzayA9IExheW91dFN0YXRpYyB8IFBhc3NpdmVTdGF0aWMgfCBSZWZTdGF0aWM7CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGZpYmVyOwogICAgICAgICAgaWYgKCFmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgdmFyIG5leHROb2RlID0gbm9kZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIG5vZGUgPSBuZXh0Tm9kZTsKICAgICAgICAgICAgICBpZiAoKG5vZGUuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIG5lYXJlc3RNb3VudGVkID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5leHROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5leHROb2RlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnJldHVybikgewogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICByZXR1cm4gbmVhcmVzdE1vdW50ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250YWluZXJGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RSb290ID8gZmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gOiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZpYmVyTW91bnRlZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpID09PSBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNNb3VudGVkKGNvbXBvbmVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgICBpZiAob3duZXIgIT09IG51bGwgJiYgb3duZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gb3duZXJGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKCFpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgaXNNb3VudGVkIGluc2lkZSBpdHMgcmVuZGVyKCkgZnVuY3Rpb24uIHJlbmRlcigpIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiBJdCBzaG91bGQgbmV2ZXIgYWNjZXNzIHNvbWV0aGluZyB0aGF0IHJlcXVpcmVzIHN0YWxlIGRhdGEgZnJvbSB0aGUgcHJldmlvdXMgcmVuZGVyLCBzdWNoIGFzIHJlZnMuIE1vdmUgdGhpcyBsb2dpYyB0byBjb21wb25lbnREaWRNb3VudCBhbmQgY29tcG9uZW50RGlkVXBkYXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lckZpYmVyKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW5zdGFuY2UuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFob29rLnN1cHBvcnRzRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbih7fSwgaW50ZXJuYWxzLCB7CiAgICAgICAgICAgICAgICBnZXRMYW5lTGFiZWxNYXAsCiAgICAgICAgICAgICAgICBpbmplY3RQcm9maWxpbmdIb29rcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlbmRlcmVySUQgPSBob29rLmluamVjdChpbnRlcm5hbHMpOwogICAgICAgICAgICBpbmplY3RlZEhvb2sgPSBob29rOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcy4iLCBlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaG9vay5jaGVja0RDRSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25TY2hlZHVsZVJvb3Qocm9vdDMsIGNoaWxkcmVuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblNjaGVkdWxlRmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBjaGlsZHJlbik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFJvb3Qocm9vdDMsIGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IChyb290My5jdXJyZW50LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIpIHsKICAgICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCBzY2hlZHVsZXJQcmlvcml0eSwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIHZvaWQgMCwgZGlkRXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Qb3N0Q29tbWl0Um9vdChyb290MykgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbkNvbW1pdFVubW91bnQoZmliZXIpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyVW5tb3VudChyZW5kZXJlcklELCBmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKG5ld0lzU3RyaWN0TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHVuc3RhYmxlX3lpZWxkVmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB1bnN0YWJsZV9zZXREaXNhYmxlWWllbGRWYWx1ZShuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIHNldFN1cHByZXNzV2FybmluZyhuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5zZXRTdHJpY3RNb2RlKHJlbmRlcmVySUQsIG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluamVjdFByb2ZpbGluZ0hvb2tzKHByb2ZpbGluZ0hvb2tzKSB7CiAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gcHJvZmlsaW5nSG9va3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVMYWJlbE1hcCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaW5kZXgyID0gMDsgaW5kZXgyIDwgVG90YWxMYW5lczsgaW5kZXgyKyspIHsKICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBnZXRMYWJlbEZvckxhbmUobGFuZSk7CiAgICAgICAgICAgICAgbWFwLnNldChsYW5lLCBsYWJlbCk7CiAgICAgICAgICAgICAgbGFuZSAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkKGZpYmVyLCB0aHJvd25WYWx1ZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZmliZXIsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlcllpZWxkZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJZaWVsZGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclNjaGVkdWxlZChsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29uY3VycmVudE1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBQcm9maWxlTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdExlZ2FjeU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgU3RyaWN0RWZmZWN0c01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgY2x6MzIgPSBNYXRoLmNsejMyID8gTWF0aC5jbHozMiA6IGNsejMyRmFsbGJhY2s7CiAgICAgICAgdmFyIGxvZyA9IE1hdGgubG9nOwogICAgICAgIHZhciBMTjIgPSBNYXRoLkxOMjsKICAgICAgICBmdW5jdGlvbiBjbHozMkZhbGxiYWNrKHgpIHsKICAgICAgICAgIHZhciBhc1VpbnQgPSB4ID4+PiAwOwogICAgICAgICAgaWYgKGFzVWludCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gMzI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMzEgLSAobG9nKGFzVWludCkgLyBMTjIgfCAwKSB8IDA7CiAgICAgICAgfQogICAgICAgIHZhciBUb3RhbExhbmVzID0gMzE7CiAgICAgICAgdmFyIE5vTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgTm9MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgU3luY0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdExhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MTk0MjQwCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTggPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4MTkyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEwID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMxMDcyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjYyMTQ0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTI0Mjg4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEzMDAyMzQyNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4Mzg4NjA4CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmU0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY3MTA4ODY0CiAgICAgICAgKTsKICAgICAgICB2YXIgU29tZVJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgdmFyIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAqLwogICAgICAgICAgMTM0MjE3NzI4CiAgICAgICAgKTsKICAgICAgICB2YXIgTm9uSWRsZUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjg0MzU0NTUKICAgICAgICApOwogICAgICAgIHZhciBJZGxlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NgogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTM2ODcwOTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgT2Zmc2NyZWVuTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDczNzQxODI0CiAgICAgICAgKTsKICAgICAgICBmdW5jdGlvbiBnZXRMYWJlbEZvckxhbmUobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobGFuZSAmIFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJTeW5jIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91c0h5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJbnB1dENvbnRpbnVvdXMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdEh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHRIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdExhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb25IeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFuc2l0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFJldHJ5TGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlJldHJ5IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlNlbGVjdGl2ZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBPZmZzY3JlZW5MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJPZmZzY3JlZW4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb1RpbWVzdGFtcCA9IC0xOwogICAgICAgIHZhciBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgdmFyIG5leHRSZXRyeUxhbmUgPSBSZXRyeUxhbmUxOwogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKGxhbmVzKSB7CiAgICAgICAgICBzd2l0Y2ggKGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRMYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBsYW5lcyAmIFRyYW5zaXRpb25MYW5lczsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgUmV0cnlMYW5lczsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSWRsZUxhbmU7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiU2hvdWxkIGhhdmUgZm91bmQgbWF0Y2hpbmcgbGFuZXMuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBsYW5lczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dExhbmVzKHJvb3QzLCB3aXBMYW5lcykgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChwZW5kaW5nTGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgbm9uSWRsZVBlbmRpbmdMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIE5vbklkbGVMYW5lczsKICAgICAgICAgIGlmIChub25JZGxlUGVuZGluZ0xhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBub25JZGxlVW5ibG9ja2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICBpZiAobm9uSWRsZVVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbm9uSWRsZVBpbmdlZExhbmVzID0gbm9uSWRsZVBlbmRpbmdMYW5lcyAmIHBpbmdlZExhbmVzOwogICAgICAgICAgICAgIGlmIChub25JZGxlUGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKG5vbklkbGVQaW5nZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5ibG9ja2VkTGFuZXMgPSBwZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmICh1bmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAocGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0TGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod2lwTGFuZXMgIT09IE5vTGFuZXMgJiYgd2lwTGFuZXMgIT09IG5leHRMYW5lcyAmJiAvLyBJZiB3ZSBhbHJlYWR5IHN1c3BlbmRlZCB3aXRoIGEgZGVsYXksIHRoZW4gaW50ZXJydXB0aW5nIGlzIGZpbmUuIERvbid0CiAgICAgICAgICAvLyBib3RoZXIgd2FpdGluZyB1bnRpbCB0aGUgcm9vdCBpcyBjb21wbGV0ZS4KICAgICAgICAgICh3aXBMYW5lcyAmIHN1c3BlbmRlZExhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgbmV4dExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKG5leHRMYW5lcyk7CiAgICAgICAgICAgIHZhciB3aXBMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZSh3aXBMYW5lcyk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBUZXN0cyB3aGV0aGVyIHRoZSBuZXh0IGxhbmUgaXMgZXF1YWwgb3IgbG93ZXIgcHJpb3JpdHkgdGhhbiB0aGUgd2lwCiAgICAgICAgICAgICAgLy8gb25lLiBUaGlzIHdvcmtzIGJlY2F1c2UgdGhlIGJpdHMgZGVjcmVhc2UgaW4gcHJpb3JpdHkgYXMgeW91IGdvIGxlZnQuCiAgICAgICAgICAgICAgbmV4dExhbmUgPj0gd2lwTGFuZSB8fCAvLyBEZWZhdWx0IHByaW9yaXR5IHVwZGF0ZXMgc2hvdWxkIG5vdCBpbnRlcnJ1cHQgdHJhbnNpdGlvbiB1cGRhdGVzLiBUaGUKICAgICAgICAgICAgICAvLyBvbmx5IGRpZmZlcmVuY2UgYmV0d2VlbiBkZWZhdWx0IHVwZGF0ZXMgYW5kIHRyYW5zaXRpb24gdXBkYXRlcyBpcyB0aGF0CiAgICAgICAgICAgICAgLy8gZGVmYXVsdCB1cGRhdGVzIGRvIG5vdCBzdXBwb3J0IHJlZnJlc2ggdHJhbnNpdGlvbnMuCiAgICAgICAgICAgICAgbmV4dExhbmUgPT09IERlZmF1bHRMYW5lICYmICh3aXBMYW5lICYgVHJhbnNpdGlvbkxhbmVzKSAhPT0gTm9MYW5lcwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICByZXR1cm4gd2lwTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgobmV4dExhbmVzICYgSW5wdXRDb250aW51b3VzTGFuZSkgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dExhbmVzIHw9IHBlbmRpbmdMYW5lcyAmIERlZmF1bHRMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICBpZiAoZW50YW5nbGVkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBuZXh0TGFuZXMgJiBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICAgIG5leHRMYW5lcyB8PSBlbnRhbmdsZW1lbnRzW2luZGV4Ml07CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0TGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vc3RSZWNlbnRFdmVudFRpbWUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICB2YXIgbW9zdFJlY2VudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBldmVudFRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChldmVudFRpbWUgPiBtb3N0UmVjZW50RXZlbnRUaW1lKSB7CiAgICAgICAgICAgICAgbW9zdFJlY2VudEV2ZW50VGltZSA9IGV2ZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHN3aXRjaCAobGFuZSkgewogICAgICAgICAgICBjYXNlIFN5bmNMYW5lOgogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyAyNTA7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyA1ZTM7CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMToKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNDoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhcnZlZExhbmVzQXNFeHBpcmVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lc1tpbmRleDJdOwogICAgICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgICAgaWYgKChsYW5lICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzIHx8IChsYW5lICYgcGluZ2VkTGFuZXMpICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGlyYXRpb25UaW1lIDw9IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzIHw9IGxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290MykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKSB7CiAgICAgICAgICB2YXIgZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5PZmZzY3JlZW5MYW5lOwogICAgICAgICAgaWYgKGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIE9mZnNjcmVlbkxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNTeW5jTGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNMYW5lKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNOb25JZGxlV29yayhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIE5vbklkbGVMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVJldHJpZXMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBSZXRyeUxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKGxhbmVzKSB7CiAgICAgICAgICB2YXIgVXJnZW50TGFuZXMgPSBTeW5jTGFuZSB8IElucHV0Q29udGludW91c0xhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBVcmdlbnRMYW5lcykgPT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIFN5bmNEZWZhdWx0TGFuZXMgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRIeWRyYXRpb25MYW5lIHwgRGVmYXVsdExhbmU7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0RlZmF1bHRMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgcm9vdDMuZXhwaXJlZExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUcmFuc2l0aW9uTGFuZShsYW5lKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0VHJhbnNpdGlvbkxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRSZXRyeUxhbmUoKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IG5leHRSZXRyeUxhbmU7CiAgICAgICAgICBuZXh0UmV0cnlMYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0UmV0cnlMYW5lICYgUmV0cnlMYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGxhbmVzICYgLWxhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gMzEgLSBjbHozMihsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0luZGV4KGxhbmUpIHsKICAgICAgICAgIHJldHVybiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1NvbWVMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiAoYSAmIGIpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1N1YnNldE9mTGFuZXMoc2V0Miwgc3Vic2V0KSB7CiAgICAgICAgICByZXR1cm4gKHNldDIgJiBzdWJzZXQpID09PSBzdWJzZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lcmdlTGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgfCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVMYW5lcyhzZXQyLCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiBzZXQyICYgfnN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0TGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgJiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lVG9MYW5lcyhsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyUHJpb3JpdHlMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSBOb0xhbmUgJiYgYSA8IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTGFuZU1hcChpbml0aWFsKSB7CiAgICAgICAgICB2YXIgbGFuZU1hcCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBUb3RhbExhbmVzOyBpKyspIHsKICAgICAgICAgICAgbGFuZU1hcC5wdXNoKGluaXRpYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmVNYXA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290VXBkYXRlZChyb290MywgdXBkYXRlTGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgfD0gdXBkYXRlTGFuZTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBJZGxlTGFuZSkgewogICAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleCh1cGRhdGVMYW5lKTsKICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IGV2ZW50VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyB8PSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzICY9IH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzIHw9IHJvb3QzLnN1c3BlbmRlZExhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKSB7CiAgICAgICAgICB2YXIgbm9Mb25nZXJQZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXMgJiB+cmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLm11dGFibGVSZWFkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5lbnRhbmdsZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBub0xvbmdlclBlbmRpbmdMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gPSBOb0xhbmVzOwogICAgICAgICAgICBldmVudFRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBlbnRhbmdsZWRMYW5lcykgewogICAgICAgICAgdmFyIHJvb3RFbnRhbmdsZWRMYW5lcyA9IHJvb3QzLmVudGFuZ2xlZExhbmVzIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdEVudGFuZ2xlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIElzIHRoaXMgb25lIG9mIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgbGFuZSAmIGVudGFuZ2xlZExhbmVzIHwgLy8gSXMgdGhpcyBsYW5lIHRyYW5zaXRpdmVseSBlbnRhbmdsZWQgd2l0aCB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSAmIGVudGFuZ2xlZExhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcmVuZGVyTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBsYW5lOwogICAgICAgICAgc3dpdGNoIChyZW5kZXJMYW5lKSB7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICBsYW5lID0gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICBsYW5lID0gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgbGFuZSA9IFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYW5lID0gTm9MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChsYW5lICYgKHJvb3QzLnN1c3BlbmRlZExhbmVzIHwgcmVuZGVyTGFuZXMyKSkgIT09IE5vTGFuZSkgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICB1cGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKCFpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHJvb3QzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXA7CiAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgIW1lbW9pemVkVXBkYXRlcnMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyYW5zaXRpb25zRm9yTGFuZXMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRGlzY3JldGVFdmVudFByaW9yaXR5ID0gU3luY0xhbmU7CiAgICAgICAgdmFyIENvbnRpbnVvdXNFdmVudFByaW9yaXR5ID0gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICB2YXIgRGVmYXVsdEV2ZW50UHJpb3JpdHkgPSBEZWZhdWx0TGFuZTsKICAgICAgICB2YXIgSWRsZUV2ZW50UHJpb3JpdHkgPSBJZGxlTGFuZTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShuZXdQcmlvcml0eSkgewogICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gbmV3UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bldpdGhQcmlvcml0eShwcmlvcml0eSwgZm4pIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJpb3JpdHk7CiAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJldmlvdXNQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAhPT0gMCAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb3dlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgPT09IDAgfHwgYSA+IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lc1RvRXZlbnRQcmlvcml0eShsYW5lcykgewogICAgICAgICAgdmFyIGxhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKTsKICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSwgbGFuZSkpIHsKICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5jbHVkZXNOb25JZGxlV29yayhsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpIHsKICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSByb290My5jdXJyZW50Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gY3VycmVudFN0YXRlLmlzRGVoeWRyYXRlZDsKICAgICAgICB9CiAgICAgICAgdmFyIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uID0gZm47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcikgewogICAgICAgICAgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihmbikgewogICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5JDE7CiAgICAgICAgZnVuY3Rpb24gc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGZuKSB7CiAgICAgICAgICBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHk7CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgdmFyIHF1ZXVlZERpc2NyZXRlRXZlbnRzID0gW107CiAgICAgICAgdmFyIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgdmFyIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkUG9pbnRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMgPSBbXTsKICAgICAgICB2YXIgZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzID0gWwogICAgICAgICAgIm1vdXNlZG93biIsCiAgICAgICAgICAibW91c2V1cCIsCiAgICAgICAgICAidG91Y2hjYW5jZWwiLAogICAgICAgICAgInRvdWNoZW5kIiwKICAgICAgICAgICJ0b3VjaHN0YXJ0IiwKICAgICAgICAgICJhdXhjbGljayIsCiAgICAgICAgICAiZGJsY2xpY2siLAogICAgICAgICAgInBvaW50ZXJjYW5jZWwiLAogICAgICAgICAgInBvaW50ZXJkb3duIiwKICAgICAgICAgICJwb2ludGVydXAiLAogICAgICAgICAgImRyYWdlbmQiLAogICAgICAgICAgImRyYWdzdGFydCIsCiAgICAgICAgICAiZHJvcCIsCiAgICAgICAgICAiY29tcG9zaXRpb25lbmQiLAogICAgICAgICAgImNvbXBvc2l0aW9uc3RhcnQiLAogICAgICAgICAgImtleWRvd24iLAogICAgICAgICAgImtleXByZXNzIiwKICAgICAgICAgICJrZXl1cCIsCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgInRleHRJbnB1dCIsCiAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGNhbWVsQ2FzZQogICAgICAgICAgImNvcHkiLAogICAgICAgICAgImN1dCIsCiAgICAgICAgICAicGFzdGUiLAogICAgICAgICAgImNsaWNrIiwKICAgICAgICAgICJjaGFuZ2UiLAogICAgICAgICAgImNvbnRleHRtZW51IiwKICAgICAgICAgICJyZXNldCIsCiAgICAgICAgICAic3VibWl0IgogICAgICAgIF07CiAgICAgICAgZnVuY3Rpb24gaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGV2ZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIGRpc2NyZXRlUmVwbGF5YWJsZUV2ZW50cy5pbmRleE9mKGV2ZW50VHlwZSkgPiAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBibG9ja2VkT24sCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSwKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncywKICAgICAgICAgICAgbmF0aXZlRXZlbnQsCiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnM6IFt0YXJnZXRDb250YWluZXJdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOiB7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5kZWxldGUocG9pbnRlcklkKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZGVsZXRlKF9wb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoZXhpc3RpbmdRdWV1ZWRFdmVudCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChleGlzdGluZ1F1ZXVlZEV2ZW50ID09PSBudWxsIHx8IGV4aXN0aW5nUXVldWVkRXZlbnQubmF0aXZlRXZlbnQgIT09IG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IGNyZWF0ZVF1ZXVlZFJlcGxheWFibGVFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMiA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoX2ZpYmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oX2ZpYmVyMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBxdWV1ZWRFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGV4aXN0aW5nUXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncyB8PSBldmVudFN5c3RlbUZsYWdzOwogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBleGlzdGluZ1F1ZXVlZEV2ZW50LnRhcmdldENvbnRhaW5lcnM7CiAgICAgICAgICBpZiAodGFyZ2V0Q29udGFpbmVyICE9PSBudWxsICYmIHRhcmdldENvbnRhaW5lcnMuaW5kZXhPZih0YXJnZXRDb250YWluZXIpID09PSAtMSkgewogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnB1c2godGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGlzdGluZ1F1ZXVlZEV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjogewogICAgICAgICAgICAgIHZhciBmb2N1c0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZEZvY3VzLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBmb2N1c0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIGRyYWdFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZERyYWcsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGRyYWdFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjogewogICAgICAgICAgICAgIHZhciBtb3VzZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZE1vdXNlLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBtb3VzZUV2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IHBvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlcnMuc2V0KHBvaW50ZXJJZCwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVycy5nZXQocG9pbnRlcklkKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBwb2ludGVyRXZlbnQpKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkMiA9IF9wb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5zZXQoX3BvaW50ZXJJZDIsIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkUG9pbnRlckNhcHR1cmVzLmdldChfcG9pbnRlcklkMikgfHwgbnVsbCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgX3BvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocXVldWVkVGFyZ2V0LnRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHF1ZXVlZFRhcmdldC5wcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgdXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSgpOwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHsKICAgICAgICAgICAgYmxvY2tlZE9uOiBudWxsLAogICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIHByaW9yaXR5OiB1cGRhdGVQcmlvcml0eQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KHVwZGF0ZVByaW9yaXR5LCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbaV0ucHJpb3JpdHkpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zcGxpY2UoaSwgMCwgcXVldWVkVGFyZ2V0KTsKICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJzID0gcXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIHdoaWxlICh0YXJnZXRDb250YWluZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcnNbMF07CiAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChxdWV1ZWRFdmVudC5kb21FdmVudE5hbWUsIHF1ZXVlZEV2ZW50LmV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgcXVldWVkRXZlbnQubmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHF1ZXVlZEV2ZW50Lm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50Q2xvbmUgPSBuZXcgbmF0aXZlRXZlbnQuY29uc3RydWN0b3IobmF0aXZlRXZlbnQudHlwZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgICAgc2V0UmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnRDbG9uZSk7CiAgICAgICAgICAgICAgICBuYXRpdmVFdmVudC50YXJnZXQuZGlzcGF0Y2hFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIHJlc2V0UmVwbGF5aW5nRXZlbnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlcjMgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKG5leHRCbG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVycy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcChxdWV1ZWRFdmVudCwga2V5LCBtYXApIHsKICAgICAgICAgIGlmIChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSkgewogICAgICAgICAgICBtYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcGxheVVuYmxvY2tlZEV2ZW50cygpIHsKICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICAgIGlmIChxdWV1ZWRGb2N1cyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEZvY3VzKSkgewogICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRHJhZyAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZERyYWcpKSB7CiAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkTW91c2UpKSB7CiAgICAgICAgICAgIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2goYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudCwgdW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0KSB7CiAgICAgICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IHRydWU7CiAgICAgICAgICAgICAgU2NoZWR1bGVyLnVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2soU2NoZWR1bGVyLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5LCByZXBsYXlVbmJsb2NrZWRFdmVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldHJ5SWZCbG9ja2VkT24odW5ibG9ja2VkKSB7CiAgICAgICAgICBpZiAocXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRGlzY3JldGVFdmVudHNbMF0sIHVuYmxvY2tlZCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcXVldWVkRGlzY3JldGVFdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcXVldWVkRXZlbnQgPSBxdWV1ZWREaXNjcmV0ZUV2ZW50c1tpXTsKICAgICAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEZvY3VzLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERyYWcsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZE1vdXNlLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVuYmxvY2sgPSBmdW5jdGlvbihxdWV1ZWRFdmVudDIpIHsKICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRFdmVudDIsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9OwogICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5mb3JFYWNoKHVuYmxvY2spOwogICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tfaV07CiAgICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID09PSB1bmJsb2NrZWQpIHsKICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBuZXh0RXhwbGljaXRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbMF07CiAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KG5leHRFeHBsaWNpdFRhcmdldCk7CiAgICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zaGlmdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgX2VuYWJsZWQgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIHNldEVuYWJsZWQoZW5hYmxlZCkgewogICAgICAgICAgX2VuYWJsZWQgPSAhIWVuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRW5hYmxlZCgpIHsKICAgICAgICAgIHJldHVybiBfZW5hYmxlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpIHsKICAgICAgICAgIHZhciBldmVudFByaW9yaXR5ID0gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpOwogICAgICAgICAgdmFyIGxpc3RlbmVyV3JhcHBlcjsKICAgICAgICAgIHN3aXRjaCAoZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaERpc2NyZXRlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcldyYXBwZXIuYmluZChudWxsLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRGlzY3JldGVFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShDb250aW51b3VzRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmICghX2VuYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRXaXRoRW5hYmxlQ2FwdHVyZVBoYXNlU2VsZWN0aXZlSHlkcmF0aW9uV2l0aG91dERpc2NyZXRlRXZlbnRSZXBsYXkoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgYmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgaWYgKGJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSAmJiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICB3aGlsZSAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCByZXR1cm5fdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5leHRCbG9ja2VkT24gPT09IGJsb2NrZWRPbikgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJsb2NrZWRPbiA9IG5leHRCbG9ja2VkT247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCBudWxsLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgdGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gdGFyZ2V0SW5zdCkgewogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRQcmlvcml0eShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiY2xvc2UiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImludmFsaWQiOgogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgICAgY2FzZSAicGxheSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZG93biI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgIGNhc2UgInJhdGVjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJyZXNldCI6CiAgICAgICAgICAgIGNhc2UgInJlc2l6ZSI6CiAgICAgICAgICAgIGNhc2UgInNlZWtlZCI6CiAgICAgICAgICAgIGNhc2UgInN1Ym1pdCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hlbmQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaHN0YXJ0IjoKICAgICAgICAgICAgY2FzZSAidm9sdW1lY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAiY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25zdGFydCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb251cGRhdGUiOgogICAgICAgICAgICBjYXNlICJiZWZvcmVibHVyIjoKICAgICAgICAgICAgY2FzZSAiYWZ0ZXJibHVyIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlaW5wdXQiOgogICAgICAgICAgICBjYXNlICJibHVyIjoKICAgICAgICAgICAgY2FzZSAiZnVsbHNjcmVlbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImZvY3VzIjoKICAgICAgICAgICAgY2FzZSAiaGFzaGNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInBvcHN0YXRlIjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAic2VsZWN0c3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgIGNhc2UgInRvZ2dsZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgIndoZWVsIjoKICAgICAgICAgICAgY2FzZSAibW91c2VlbnRlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbGVhdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyZW50ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVybGVhdmUiOgogICAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgY2FzZSAibWVzc2FnZSI6IHsKICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHkgPSBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCgpOwogICAgICAgICAgICAgIHN3aXRjaCAoc2NoZWR1bGVyUHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcikgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lciwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lciwgewogICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIsIHBhc3NpdmUpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIsIHsKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICAgICAgfQogICAgICAgIHZhciByb290MiA9IG51bGw7CiAgICAgICAgdmFyIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgcm9vdDIgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IGdldFRleHQoKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldCgpIHsKICAgICAgICAgIHJvb3QyID0gbnVsbDsKICAgICAgICAgIHN0YXJ0VGV4dCA9IG51bGw7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhKCkgewogICAgICAgICAgaWYgKGZhbGxiYWNrVGV4dCkgewogICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgICAgdmFyIHN0YXJ0VmFsdWUgPSBzdGFydFRleHQ7CiAgICAgICAgICB2YXIgc3RhcnRMZW5ndGggPSBzdGFydFZhbHVlLmxlbmd0aDsKICAgICAgICAgIHZhciBlbmQ7CiAgICAgICAgICB2YXIgZW5kVmFsdWUgPSBnZXRUZXh0KCk7CiAgICAgICAgICB2YXIgZW5kTGVuZ3RoID0gZW5kVmFsdWUubGVuZ3RoOwogICAgICAgICAgZm9yIChzdGFydCA9IDA7IHN0YXJ0IDwgc3RhcnRMZW5ndGg7IHN0YXJ0KyspIHsKICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRdICE9PSBlbmRWYWx1ZVtzdGFydF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG1pbkVuZCA9IHN0YXJ0TGVuZ3RoIC0gc3RhcnQ7CiAgICAgICAgICBmb3IgKGVuZCA9IDE7IGVuZCA8PSBtaW5FbmQ7IGVuZCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0TGVuZ3RoIC0gZW5kXSAhPT0gZW5kVmFsdWVbZW5kTGVuZ3RoIC0gZW5kXSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2xpY2VUYWlsID0gZW5kID4gMSA/IDEgLSBlbmQgOiB2b2lkIDA7CiAgICAgICAgICBmYWxsYmFja1RleHQgPSBlbmRWYWx1ZS5zbGljZShzdGFydCwgc2xpY2VUYWlsKTsKICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRleHQoKSB7CiAgICAgICAgICBpZiAoInZhbHVlIiBpbiByb290MikgewogICAgICAgICAgICByZXR1cm4gcm9vdDIudmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcm9vdDIudGV4dENvbnRlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBjaGFyQ29kZTsKICAgICAgICAgIHZhciBrZXlDb2RlID0gbmF0aXZlRXZlbnQua2V5Q29kZTsKICAgICAgICAgIGlmICgiY2hhckNvZGUiIGluIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gbmF0aXZlRXZlbnQuY2hhckNvZGU7CiAgICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMCAmJiBrZXlDb2RlID09PSAxMykgewogICAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0ga2V5Q29kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA9PT0gMTApIHsKICAgICAgICAgICAgY2hhckNvZGUgPSAxMzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjaGFyQ29kZSA+PSAzMiB8fCBjaGFyQ29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlKCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZSgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlU3ludGhldGljRXZlbnQoSW50ZXJmYWNlKSB7CiAgICAgICAgICBmdW5jdGlvbiBTeW50aGV0aWNCYXNlRXZlbnQocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHRoaXMuX3JlYWN0TmFtZSA9IHJlYWN0TmFtZTsKICAgICAgICAgICAgdGhpcy5fdGFyZ2V0SW5zdCA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHJlYWN0RXZlbnRUeXBlOwogICAgICAgICAgICB0aGlzLm5hdGl2ZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9wcm9wTmFtZSBpbiBJbnRlcmZhY2UpIHsKICAgICAgICAgICAgICBpZiAoIUludGVyZmFjZS5oYXNPd25Qcm9wZXJ0eShfcHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZSA9IEludGVyZmFjZVtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIGlmIChub3JtYWxpemUpIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5vcm1hbGl6ZShuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5hdGl2ZUV2ZW50W19wcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJldmVudGVkID0gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCAhPSBudWxsID8gbmF0aXZlRXZlbnQuZGVmYXVsdFByZXZlbnRlZCA6IG5hdGl2ZUV2ZW50LnJldHVyblZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgaWYgKGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgYXNzaWduKFN5bnRoZXRpY0Jhc2VFdmVudC5wcm90b3R5cGUsIHsKICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgaWYgKCFldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5jYW5jZWxCdWJibGUgIT09ICJ1bmtub3duIikgewogICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogV2UgcmVsZWFzZSBhbGwgZGlzcGF0Y2hlZCBgU3ludGhldGljRXZlbnRgcyBhZnRlciBlYWNoIGV2ZW50IGxvb3AsIGFkZGluZwogICAgICAgICAgICAgKiB0aGVtIGJhY2sgaW50byB0aGUgcG9vbC4gVGhpcyBhbGxvd3MgYSB3YXkgdG8gaG9sZCBvbnRvIGEgcmVmZXJlbmNlIHRoYXQKICAgICAgICAgICAgICogd29uJ3QgYmUgYWRkZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcGVyc2lzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDaGVja3MgaWYgdGhpcyBldmVudCBzaG91bGQgYmUgcmVsZWFzZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgc2hvdWxkIG5vdCBiZSByZWxlYXNlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNQZXJzaXN0ZW50OiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gU3ludGhldGljQmFzZUV2ZW50OwogICAgICAgIH0KICAgICAgICB2YXIgRXZlbnRJbnRlcmZhY2UgPSB7CiAgICAgICAgICBldmVudFBoYXNlOiAwLAogICAgICAgICAgYnViYmxlczogMCwKICAgICAgICAgIGNhbmNlbGFibGU6IDAsCiAgICAgICAgICB0aW1lU3RhbXA6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBldmVudC50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiAwLAogICAgICAgICAgaXNUcnVzdGVkOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgU3ludGhldGljRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFVJRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB2aWV3OiAwLAogICAgICAgICAgZGV0YWlsOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1VJRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChVSUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WDsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICB2YXIgbGFzdE1vdXNlRXZlbnQ7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW1vdmUiKSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IGV2ZW50LnNjcmVlblggLSBsYXN0TW91c2VFdmVudC5zY3JlZW5YOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gMDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTW91c2VFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgc2NyZWVuWDogMCwKICAgICAgICAgIHNjcmVlblk6IDAsCiAgICAgICAgICBjbGllbnRYOiAwLAogICAgICAgICAgY2xpZW50WTogMCwKICAgICAgICAgIHBhZ2VYOiAwLAogICAgICAgICAgcGFnZVk6IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgYnV0dG9uOiAwLAogICAgICAgICAgYnV0dG9uczogMCwKICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC5yZWxhdGVkVGFyZ2V0ID09PSB2b2lkIDApIHJldHVybiBldmVudC5mcm9tRWxlbWVudCA9PT0gZXZlbnQuc3JjRWxlbWVudCA/IGV2ZW50LnRvRWxlbWVudCA6IGV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICByZXR1cm4gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRYIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpOwogICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WDsKICAgICAgICAgIH0sCiAgICAgICAgICBtb3ZlbWVudFk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmICgibW92ZW1lbnRZIiBpbiBldmVudCkgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5tb3ZlbWVudFk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY01vdXNlRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChNb3VzZUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRHJhZ0V2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkYXRhVHJhbnNmZXI6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljRHJhZ0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRHJhZ0V2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRm9jdXNFdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNGb2N1c0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRm9jdXNFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgYW5pbWF0aW9uTmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNBbmltYXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBjbGlwYm9hcmREYXRhOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImNsaXBib2FyZERhdGEiIGluIGV2ZW50ID8gZXZlbnQuY2xpcGJvYXJkRGF0YSA6IHdpbmRvdy5jbGlwYm9hcmREYXRhOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNDbGlwYm9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENsaXBib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGE6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBTeW50aGV0aWNJbnB1dEV2ZW50ID0gU3ludGhldGljQ29tcG9zaXRpb25FdmVudDsKICAgICAgICB2YXIgbm9ybWFsaXplS2V5ID0gewogICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgIFNwYWNlYmFyOiAiICIsCiAgICAgICAgICBMZWZ0OiAiQXJyb3dMZWZ0IiwKICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICBSaWdodDogIkFycm93UmlnaHQiLAogICAgICAgICAgRG93bjogIkFycm93RG93biIsCiAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgV2luOiAiT1MiLAogICAgICAgICAgTWVudTogIkNvbnRleHRNZW51IiwKICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBTY3JvbGw6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgIE1velByaW50YWJsZUtleTogIlVuaWRlbnRpZmllZCIKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2xhdGVUb0tleSA9IHsKICAgICAgICAgICI4IjogIkJhY2tzcGFjZSIsCiAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgIjEyIjogIkNsZWFyIiwKICAgICAgICAgICIxMyI6ICJFbnRlciIsCiAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgIjE3IjogIkNvbnRyb2wiLAogICAgICAgICAgIjE4IjogIkFsdCIsCiAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgIjIwIjogIkNhcHNMb2NrIiwKICAgICAgICAgICIyNyI6ICJFc2NhcGUiLAogICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgIjMzIjogIlBhZ2VVcCIsCiAgICAgICAgICAiMzQiOiAiUGFnZURvd24iLAogICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAiMzYiOiAiSG9tZSIsCiAgICAgICAgICAiMzciOiAiQXJyb3dMZWZ0IiwKICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICIzOSI6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgICI0MCI6ICJBcnJvd0Rvd24iLAogICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAiNDYiOiAiRGVsZXRlIiwKICAgICAgICAgICIxMTIiOiAiRjEiLAogICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAiMTE0IjogIkYzIiwKICAgICAgICAgICIxMTUiOiAiRjQiLAogICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAiMTE3IjogIkY2IiwKICAgICAgICAgICIxMTgiOiAiRjciLAogICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAiMTIwIjogIkY5IiwKICAgICAgICAgICIxMjEiOiAiRjEwIiwKICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICIxMjMiOiAiRjEyIiwKICAgICAgICAgICIxNDQiOiAiTnVtTG9jayIsCiAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgIjIyNCI6ICJNZXRhIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5rZXkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5vcm1hbGl6ZUtleVtuYXRpdmVFdmVudC5rZXldIHx8IG5hdGl2ZUV2ZW50LmtleTsKICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5ZG93biIgfHwgbmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBtb2RpZmllcktleVRvUHJvcCA9IHsKICAgICAgICAgIEFsdDogImFsdEtleSIsCiAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICBNZXRhOiAibWV0YUtleSIsCiAgICAgICAgICBTaGlmdDogInNoaWZ0S2V5IgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW9kaWZpZXJTdGF0ZUdldHRlcihrZXlBcmcpIHsKICAgICAgICAgIHZhciBzeW50aGV0aWNFdmVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKGtleUFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5UHJvcCA9IG1vZGlmaWVyS2V5VG9Qcm9wW2tleUFyZ107CiAgICAgICAgICByZXR1cm4ga2V5UHJvcCA/ICEhbmF0aXZlRXZlbnRba2V5UHJvcF0gOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRNb2RpZmllclN0YXRlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbW9kaWZpZXJTdGF0ZUdldHRlcjsKICAgICAgICB9CiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGtleTogZ2V0RXZlbnRLZXksCiAgICAgICAgICBjb2RlOiAwLAogICAgICAgICAgbG9jYXRpb246IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBhbHRLZXk6IDAsCiAgICAgICAgICBtZXRhS2V5OiAwLAogICAgICAgICAgcmVwZWF0OiAwLAogICAgICAgICAgbG9jYWxlOiAwLAogICAgICAgICAgZ2V0TW9kaWZpZXJTdGF0ZTogZ2V0RXZlbnRNb2RpZmllclN0YXRlLAogICAgICAgICAgLy8gTGVnYWN5IEludGVyZmFjZQogICAgICAgICAgY2hhckNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIGtleUNvZGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5ZG93biIgfHwgZXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSwKICAgICAgICAgIHdoaWNoOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljS2V5Ym9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEtleWJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBQb2ludGVyRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24oe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHBvaW50ZXJJZDogMCwKICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgcHJlc3N1cmU6IDAsCiAgICAgICAgICB0YW5nZW50aWFsUHJlc3N1cmU6IDAsCiAgICAgICAgICB0aWx0WDogMCwKICAgICAgICAgIHRpbHRZOiAwLAogICAgICAgICAgdHdpc3Q6IDAsCiAgICAgICAgICBwb2ludGVyVHlwZTogMCwKICAgICAgICAgIGlzUHJpbWFyeTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNQb2ludGVyRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChQb2ludGVyRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBUb3VjaEV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB0b3VjaGVzOiAwLAogICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgIGNoYW5nZWRUb3VjaGVzOiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUb3VjaEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVG91Y2hFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHByb3BlcnR5TmFtZTogMCwKICAgICAgICAgIGVsYXBzZWRUaW1lOiAwLAogICAgICAgICAgcHNldWRvRWxlbWVudDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChUcmFuc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBXaGVlbEV2ZW50SW50ZXJmYWNlID0gYXNzaWduKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkZWx0YVg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFYIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWCA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVhgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAocmlnaHQgaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWCIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVggOiAwCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImRlbHRhWSIgaW4gZXZlbnQgPyBldmVudC5kZWx0YVkgOiAoCiAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFZYCBmb3IgV2Via2l0IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVkgOiAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YWAgZm9yIElFPDkgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgICAid2hlZWxEZWx0YSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YSA6IDAKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFaOiAwLAogICAgICAgICAgLy8gQnJvd3NlcnMgd2l0aG91dCAiZGVsdGFNb2RlIiBpcyByZXBvcnRpbmcgaW4gcmF3IHdoZWVsIGRlbHRhIHdoZXJlIG9uZQogICAgICAgICAgLy8gbm90Y2ggb24gdGhlIHNjcm9sbCBpcyBhbHdheXMgKy8tIDEyMCwgcm91Z2hseSBlcXVpdmFsZW50IHRvIHBpeGVscy4KICAgICAgICAgIC8vIEEgZ29vZCBhcHByb3hpbWF0aW9uIG9mIERPTV9ERUxUQV9MSU5FICgxKSBpcyA1JSBvZiB2aWV3cG9ydCBzaXplIG9yCiAgICAgICAgICAvLyB+NDAgcGl4ZWxzLCBmb3IgRE9NX0RFTFRBX1NDUkVFTiAoMikgaXQgaXMgODcuNSUgb2Ygdmlld3BvcnQgc2l6ZS4KICAgICAgICAgIGRlbHRhTW9kZTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNXaGVlbEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoV2hlZWxFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEVORF9LRVlDT0RFUyA9IFs5LCAxMywgMjcsIDMyXTsKICAgICAgICB2YXIgU1RBUlRfS0VZQ09ERSA9IDIyOTsKICAgICAgICB2YXIgY2FuVXNlQ29tcG9zaXRpb25FdmVudCA9IGNhblVzZURPTSAmJiAiQ29tcG9zaXRpb25FdmVudCIgaW4gd2luZG93OwogICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgIGlmIChjYW5Vc2VET00gJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQpIHsKICAgICAgICAgIGRvY3VtZW50TW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNhblVzZVRleHRJbnB1dEV2ZW50ID0gY2FuVXNlRE9NICYmICJUZXh0RXZlbnQiIGluIHdpbmRvdyAmJiAhZG9jdW1lbnRNb2RlOwogICAgICAgIHZhciB1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSA9IGNhblVzZURPTSAmJiAoIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgfHwgZG9jdW1lbnRNb2RlICYmIGRvY3VtZW50TW9kZSA+IDggJiYgZG9jdW1lbnRNb2RlIDw9IDExKTsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgIHZhciBTUEFDRUJBUl9DSEFSID0gU3RyaW5nLmZyb21DaGFyQ29kZShTUEFDRUJBUl9DT0RFKTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uRW5kIiwgWyJjb21wb3NpdGlvbmVuZCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblN0YXJ0IiwgWyJjb21wb3NpdGlvbnN0YXJ0IiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NwYWNlS2V5cHJlc3MgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIChuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50LmFsdEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5KSAmJiAvLyBjdHJsS2V5ICYmIGFsdEtleSBpcyBlcXVpdmFsZW50IHRvIEFsdEdyLCBhbmQgaXMgbm90IGEgY29tbWFuZC4KICAgICAgICAgICEobmF0aXZlRXZlbnQuY3RybEtleSAmJiBuYXRpdmVFdmVudC5hbHRLZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25VcGRhdGUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICByZXR1cm4gRU5EX0tFWUNPREVTLmluZGV4T2YobmF0aXZlRXZlbnQua2V5Q29kZSkgIT09IC0xOwogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQua2V5Q29kZSAhPT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gbmF0aXZlRXZlbnQuZGV0YWlsOwogICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgcmV0dXJuIGRldGFpbC5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgfQogICAgICAgIHZhciBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlOwogICAgICAgICAgdmFyIGZhbGxiYWNrRGF0YTsKICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGlmICghaXNDb21wb3NpbmcgJiYgZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvblN0YXJ0IikgewogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrRGF0YSA9IGdldERhdGEoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljQ29tcG9zaXRpb25FdmVudChldmVudFR5cGUsIGRvbUV2ZW50TmFtZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0RhdGEpIHsKICAgICAgICAgICAgICBldmVudC5kYXRhID0gZmFsbGJhY2tEYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjdXN0b21EYXRhID0gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1c3RvbURhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICB2YXIgd2hpY2ggPSBuYXRpdmVFdmVudC53aGljaDsKICAgICAgICAgICAgICBpZiAod2hpY2ggIT09IFNQQUNFQkFSX0NPREUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoYXNTcGFjZUtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjb21wb3NpdGlvbmVuZCIgfHwgIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgJiYgaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoIWlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmNoYXIgJiYgbmF0aXZlRXZlbnQuY2hhci5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXRpdmVFdmVudC53aGljaCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShuYXRpdmVFdmVudC53aGljaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSA/IG51bGwgOiBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGNoYXJzOwogICAgICAgICAgaWYgKGNhblVzZVRleHRJbnB1dEV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFjaGFycykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgIm9uQmVmb3JlSW5wdXQiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC5kYXRhID0gY2hhcnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgIGNvbG9yOiB0cnVlLAogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgImRhdGV0aW1lLWxvY2FsIjogdHJ1ZSwKICAgICAgICAgIGVtYWlsOiB0cnVlLAogICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgc2VhcmNoOiB0cnVlLAogICAgICAgICAgdGVsOiB0cnVlLAogICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRydWUsCiAgICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpc1RleHRJbnB1dEVsZW1lbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewogICAgICAgICAgICByZXR1cm4gISFzdXBwb3J0ZWRJbnB1dFR5cGVzW2VsZW0udHlwZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICBpZiAoIWNhblVzZURPTSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnROYW1lID0gIm9uIiArIGV2ZW50TmFtZVN1ZmZpeDsKICAgICAgICAgIHZhciBpc1N1cHBvcnRlZCA9IGV2ZW50TmFtZSBpbiBkb2N1bWVudDsKICAgICAgICAgIGlmICghaXNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoZXZlbnROYW1lLCAicmV0dXJuOyIpOwogICAgICAgICAgICBpc1N1cHBvcnRlZCA9IHR5cGVvZiBlbGVtZW50W2V2ZW50TmFtZV0gPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXNTdXBwb3J0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDEoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ2hhbmdlIiwgWyJjaGFuZ2UiLCAiY2xpY2siLCAiZm9jdXNpbiIsICJmb2N1c291dCIsICJpbnB1dCIsICJrZXlkb3duIiwgImtleXVwIiwgInNlbGVjdGlvbmNoYW5nZSJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGluc3QsIG5hdGl2ZUV2ZW50LCB0YXJnZXQpIHsKICAgICAgICAgIGVucXVldWVTdGF0ZVJlc3RvcmUodGFyZ2V0KTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoaW5zdCwgIm9uQ2hhbmdlIik7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvbkNoYW5nZSIsICJjaGFuZ2UiLCBudWxsLCBuYXRpdmVFdmVudCwgdGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFVzZUNoYW5nZUV2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lID09PSAic2VsZWN0IiB8fCBub2RlTmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJmaWxlIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoUXVldWUgPSBbXTsKICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBhY3RpdmVFbGVtZW50SW5zdCwgbmF0aXZlRXZlbnQsIGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KSk7CiAgICAgICAgICBiYXRjaGVkVXBkYXRlcyhydW5FdmVudEluQmF0Y2gsIGRpc3BhdGNoUXVldWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBydW5FdmVudEluQmF0Y2goZGlzcGF0Y2hRdWV1ZSkgewogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgMCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCk7CiAgICAgICAgICBpZiAodXBkYXRlVmFsdWVJZkNoYW5nZWQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgaWYgKGNhblVzZURPTSkgewogICAgICAgICAgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gaXNFdmVudFN1cHBvcnRlZCgiaW5wdXQiKSAmJiAoIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPiA5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgYWN0aXZlRWxlbWVudCA9IHRhcmdldDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuYXR0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCkgewogICAgICAgICAgaWYgKCFhY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuZGV0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlUHJvcGVydHlDaGFuZ2UobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5wcm9wZXJ0eU5hbWUgIT09ICJ2YWx1ZSIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldEluc3RJZlZhbHVlQ2hhbmdlZChhY3RpdmVFbGVtZW50SW5zdCkpIHsKICAgICAgICAgICAgbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3VzaW4iKSB7CiAgICAgICAgICAgIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCk7CiAgICAgICAgICAgIHN0YXJ0V2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSh0YXJnZXQsIHRhcmdldEluc3QpOwogICAgICAgICAgfSBlbHNlIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJzZWxlY3Rpb25jaGFuZ2UiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleXVwIiB8fCBkb21FdmVudE5hbWUgPT09ICJrZXlkb3duIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2xpY2tFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gImNoZWNrYm94IiB8fCBlbGVtLnR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2xpY2tFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjbGljayIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0T3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJpbnB1dCIgfHwgZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVDb250cm9sbGVkSW5wdXRCbHVyKG5vZGUpIHsKICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZTsKICAgICAgICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmNvbnRyb2xsZWQgfHwgbm9kZS50eXBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCAibnVtYmVyIiwgbm9kZS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgdmFyIGdldFRhcmdldEluc3RGdW5jLCBoYW5kbGVFdmVudEZ1bmM7CiAgICAgICAgICBpZiAoc2hvdWxkVXNlQ2hhbmdlRXZlbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBpZiAoaXNJbnB1dEV2ZW50U3VwcG9ydGVkKSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMgPSBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkVXNlQ2xpY2tFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldFRhcmdldEluc3RGdW5jKSB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gZ2V0VGFyZ2V0SW5zdEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYW5kbGVFdmVudEZ1bmMpIHsKICAgICAgICAgICAgaGFuZGxlRXZlbnRGdW5jKGRvbUV2ZW50TmFtZSwgdGFyZ2V0Tm9kZSwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNvdXQiKSB7CiAgICAgICAgICAgIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIodGFyZ2V0Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDIoKSB7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvbk1vdXNlRW50ZXIiLCBbIm1vdXNlb3V0IiwgIm1vdXNlb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VMZWF2ZSIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Qb2ludGVyRW50ZXIiLCBbInBvaW50ZXJvdXQiLCAicG9pbnRlcm92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJMZWF2ZSIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBpc092ZXJFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3ZlciIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiOwogICAgICAgICAgdmFyIGlzT3V0RXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCI7CiAgICAgICAgICBpZiAoaXNPdmVyRXZlbnQgJiYgIWlzUmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIHZhciByZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgaWYgKHJlbGF0ZWQpIHsKICAgICAgICAgICAgICBpZiAoZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocmVsYXRlZCkgfHwgaXNDb250YWluZXJNYXJrZWRBc1Jvb3QocmVsYXRlZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNPdXRFdmVudCAmJiAhaXNPdmVyRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdpbjsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudFRhcmdldC53aW5kb3cgPT09IG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHdpbiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGRvYyA9IG5hdGl2ZUV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChkb2MpIHsKICAgICAgICAgICAgICB3aW4gPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aW4gPSB3aW5kb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tOwogICAgICAgICAgdmFyIHRvOwogICAgICAgICAgaWYgKGlzT3V0RXZlbnQpIHsKICAgICAgICAgICAgdmFyIF9yZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC50b0VsZW1lbnQ7CiAgICAgICAgICAgIGZyb20gPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0byA9IF9yZWxhdGVkID8gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoX3JlbGF0ZWQpIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0byk7CiAgICAgICAgICAgICAgaWYgKHRvICE9PSBuZWFyZXN0TW91bnRlZCB8fCB0by50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgdG8udGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgdG8gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbSA9IG51bGw7CiAgICAgICAgICAgIHRvID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcm9tID09PSB0bykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgIHZhciBsZWF2ZUV2ZW50VHlwZSA9ICJvbk1vdXNlTGVhdmUiOwogICAgICAgICAgdmFyIGVudGVyRXZlbnRUeXBlID0gIm9uTW91c2VFbnRlciI7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlUHJlZml4ID0gIm1vdXNlIjsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciIpIHsKICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICBsZWF2ZUV2ZW50VHlwZSA9ICJvblBvaW50ZXJMZWF2ZSI7CiAgICAgICAgICAgIGVudGVyRXZlbnRUeXBlID0gIm9uUG9pbnRlckVudGVyIjsKICAgICAgICAgICAgZXZlbnRUeXBlUHJlZml4ID0gInBvaW50ZXIiOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb21Ob2RlID0gZnJvbSA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZShmcm9tKTsKICAgICAgICAgIHZhciB0b05vZGUgPSB0byA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZSh0byk7CiAgICAgICAgICB2YXIgbGVhdmUgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGxlYXZlRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAibGVhdmUiLCBmcm9tLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgbGVhdmUudGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICBsZWF2ZS5yZWxhdGVkVGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVUYXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG5hdGl2ZVRhcmdldEluc3QgPT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bywgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZW50ZXJFdmVudC50YXJnZXQgPSB0b05vZGU7CiAgICAgICAgICAgIGVudGVyRXZlbnQucmVsYXRlZFRhcmdldCA9IGZyb21Ob2RlOwogICAgICAgICAgICBlbnRlciA9IGVudGVyRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlLCBlbnRlciwgZnJvbSwgdG8pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpcyh4LCB5KSB7CiAgICAgICAgICByZXR1cm4geCA9PT0geSAmJiAoeCAhPT0gMCB8fCAxIC8geCA9PT0gMSAvIHkpIHx8IHggIT09IHggJiYgeSAhPT0geTsKICAgICAgICB9CiAgICAgICAgdmFyIG9iamVjdElzID0gdHlwZW9mIE9iamVjdC5pcyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5pcyA6IGlzOwogICAgICAgIGZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgICAgICAgICBpZiAob2JqZWN0SXMob2JqQSwgb2JqQikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIG9iakEgIT09ICJvYmplY3QiIHx8IG9iakEgPT09IG51bGwgfHwgdHlwZW9mIG9iakIgIT09ICJvYmplY3QiIHx8IG9iakIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICAgICAgICAgIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50S2V5ID0ga2V5c0FbaV07CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBjdXJyZW50S2V5KSB8fCAhb2JqZWN0SXMob2JqQVtjdXJyZW50S2V5XSwgb2JqQltjdXJyZW50S2V5XSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMZWFmTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTaWJsaW5nTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQocm9vdDMsIG9mZnNldCkgewogICAgICAgICAgdmFyIG5vZGUgPSBnZXRMZWFmTm9kZShyb290Myk7CiAgICAgICAgICB2YXIgbm9kZVN0YXJ0ID0gMDsKICAgICAgICAgIHZhciBub2RlRW5kID0gMDsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBub2RlRW5kID0gbm9kZVN0YXJ0ICsgbm9kZS50ZXh0Q29udGVudC5sZW5ndGg7CiAgICAgICAgICAgICAgaWYgKG5vZGVTdGFydCA8PSBvZmZzZXQgJiYgbm9kZUVuZCA+PSBvZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIG5vZGUsCiAgICAgICAgICAgICAgICAgIG9mZnNldDogb2Zmc2V0IC0gbm9kZVN0YXJ0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlU3RhcnQgPSBub2RlRW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBnZXRMZWFmTm9kZShnZXRTaWJsaW5nTm9kZShub2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE9mZnNldHMob3V0ZXJOb2RlKSB7CiAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IG91dGVyTm9kZS5vd25lckRvY3VtZW50OwogICAgICAgICAgdmFyIHdpbiA9IG93bmVyRG9jdW1lbnQgJiYgb3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbiAmJiB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbiB8fCBzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhbmNob3JOb2RlID0gc2VsZWN0aW9uLmFuY2hvck5vZGUsIGFuY2hvck9mZnNldCA9IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsIGZvY3VzTm9kZSA9IHNlbGVjdGlvbi5mb2N1c05vZGUsIGZvY3VzT2Zmc2V0ID0gc2VsZWN0aW9uLmZvY3VzT2Zmc2V0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5jaG9yTm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgZm9jdXNOb2RlLm5vZGVUeXBlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRNb2Rlcm5PZmZzZXRzRnJvbVBvaW50cyhvdXRlck5vZGUsIGFuY2hvck5vZGUsIGFuY2hvck9mZnNldCwgZm9jdXNOb2RlLCBmb2N1c09mZnNldCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBzdGFydCA9IC0xOwogICAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluQW5jaG9yID0gMDsKICAgICAgICAgIHZhciBpbmRleFdpdGhpbkZvY3VzID0gMDsKICAgICAgICAgIHZhciBub2RlID0gb3V0ZXJOb2RlOwogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBudWxsOwogICAgICAgICAgb3V0ZXI6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBuZXh0ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gYW5jaG9yTm9kZSAmJiAoYW5jaG9yT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbGVuZ3RoICsgYW5jaG9yT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZm9jdXNOb2RlICYmIChmb2N1c09mZnNldCA9PT0gMCB8fCBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpKSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGggKyBmb2N1c09mZnNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgICAgbGVuZ3RoICs9IG5vZGUubm9kZVZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChuZXh0ID0gbm9kZS5maXJzdENoaWxkKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG91dGVyTm9kZSkgewogICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBhbmNob3JOb2RlICYmICsraW5kZXhXaXRoaW5BbmNob3IgPT09IGFuY2hvck9mZnNldCkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBmb2N1c05vZGUgJiYgKytpbmRleFdpdGhpbkZvY3VzID09PSBmb2N1c09mZnNldCkgewogICAgICAgICAgICAgICAgZW5kID0gbGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLm5leHRTaWJsaW5nKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xIHx8IGVuZCA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgZW5kCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRPZmZzZXRzKG5vZGUsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBkb2MgPSBub2RlLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gZG9jICYmIGRvYy5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICBpZiAoIXdpbi5nZXRTZWxlY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIHZhciBsZW5ndGggPSBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgIHZhciBzdGFydCA9IE1hdGgubWluKG9mZnNldHMuc3RhcnQsIGxlbmd0aCk7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQgPT09IHZvaWQgMCA/IHN0YXJ0IDogTWF0aC5taW4ob2Zmc2V0cy5lbmQsIGxlbmd0aCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbi5leHRlbmQgJiYgc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgdmFyIHRlbXAgPSBlbmQ7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgICBzdGFydCA9IHRlbXA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIHN0YXJ0KTsKICAgICAgICAgIHZhciBlbmRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIGVuZCk7CiAgICAgICAgICBpZiAoc3RhcnRNYXJrZXIgJiYgZW5kTWFya2VyKSB7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMSAmJiBzZWxlY3Rpb24uYW5jaG9yTm9kZSA9PT0gc3RhcnRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uYW5jaG9yT2Zmc2V0ID09PSBzdGFydE1hcmtlci5vZmZzZXQgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZSA9PT0gZW5kTWFya2VyLm5vZGUgJiYgc2VsZWN0aW9uLmZvY3VzT2Zmc2V0ID09PSBlbmRNYXJrZXIub2Zmc2V0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByYW5nZSA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICByYW5nZS5zZXRTdGFydChzdGFydE1hcmtlci5ub2RlLCBzdGFydE1hcmtlci5vZmZzZXQpOwogICAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7CiAgICAgICAgICAgIGlmIChzdGFydCA+IGVuZCkgewogICAgICAgICAgICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZSk7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmV4dGVuZChlbmRNYXJrZXIubm9kZSwgZW5kTWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUpIHsKICAgICAgICAgIGlmICghb3V0ZXJOb2RlIHx8ICFpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUgPT09IGlubmVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShvdXRlck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0Tm9kZShpbm5lck5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiBjb250YWluc05vZGUob3V0ZXJOb2RlLCBpbm5lck5vZGUucGFyZW50Tm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCJjb250YWlucyIgaW4gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBvdXRlck5vZGUuY29udGFpbnMoaW5uZXJOb2RlKTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiAhIShvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24oaW5uZXJOb2RlKSAmIDE2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNJbkRvY3VtZW50KG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUub3duZXJEb2N1bWVudCAmJiBjb250YWluc05vZGUobm9kZS5vd25lckRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgbm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2FtZU9yaWdpbkZyYW1lKGlmcmFtZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBpZnJhbWUuY29udGVudFdpbmRvdy5sb2NhdGlvbi5ocmVmID09PSAic3RyaW5nIjsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnREZWVwKCkgewogICAgICAgICAgdmFyIHdpbiA9IHdpbmRvdzsKICAgICAgICAgIHZhciBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCgpOwogICAgICAgICAgd2hpbGUgKGVsZW1lbnQgaW5zdGFuY2VvZiB3aW4uSFRNTElGcmFtZUVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKGlzU2FtZU9yaWdpbkZyYW1lKGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgd2luID0gZWxlbWVudC5jb250ZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KHdpbi5kb2N1bWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0gJiYgZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgKG5vZGVOYW1lID09PSAiaW5wdXQiICYmIChlbGVtLnR5cGUgPT09ICJ0ZXh0IiB8fCBlbGVtLnR5cGUgPT09ICJzZWFyY2giIHx8IGVsZW0udHlwZSA9PT0gInRlbCIgfHwgZWxlbS50eXBlID09PSAidXJsIiB8fCBlbGVtLnR5cGUgPT09ICJwYXNzd29yZCIpIHx8IG5vZGVOYW1lID09PSAidGV4dGFyZWEiIHx8IGVsZW0uY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb25JbmZvcm1hdGlvbigpIHsKICAgICAgICAgIHZhciBmb2N1c2VkRWxlbSA9IGdldEFjdGl2ZUVsZW1lbnREZWVwKCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBmb2N1c2VkRWxlbSwKICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2U6IGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhmb2N1c2VkRWxlbSkgPyBnZXRTZWxlY3Rpb24oZm9jdXNlZEVsZW0pIDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVNlbGVjdGlvbihwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uKSB7CiAgICAgICAgICB2YXIgY3VyRm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgdmFyIHByaW9yRm9jdXNlZEVsZW0gPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLmZvY3VzZWRFbGVtOwogICAgICAgICAgdmFyIHByaW9yU2VsZWN0aW9uUmFuZ2UgPSBwcmlvclNlbGVjdGlvbkluZm9ybWF0aW9uLnNlbGVjdGlvblJhbmdlOwogICAgICAgICAgaWYgKGN1ckZvY3VzZWRFbGVtICE9PSBwcmlvckZvY3VzZWRFbGVtICYmIGlzSW5Eb2N1bWVudChwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICBpZiAocHJpb3JTZWxlY3Rpb25SYW5nZSAhPT0gbnVsbCAmJiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgICBzZXRTZWxlY3Rpb24ocHJpb3JGb2N1c2VkRWxlbSwgcHJpb3JTZWxlY3Rpb25SYW5nZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9ycyA9IFtdOwogICAgICAgICAgICB2YXIgYW5jZXN0b3IgPSBwcmlvckZvY3VzZWRFbGVtOwogICAgICAgICAgICB3aGlsZSAoYW5jZXN0b3IgPSBhbmNlc3Rvci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKHsKICAgICAgICAgICAgICAgICAgZWxlbWVudDogYW5jZXN0b3IsCiAgICAgICAgICAgICAgICAgIGxlZnQ6IGFuY2VzdG9yLnNjcm9sbExlZnQsCiAgICAgICAgICAgICAgICAgIHRvcDogYW5jZXN0b3Iuc2Nyb2xsVG9wCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmlvckZvY3VzZWRFbGVtLmZvY3VzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYW5jZXN0b3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGluZm8yID0gYW5jZXN0b3JzW2ldOwogICAgICAgICAgICAgIGluZm8yLmVsZW1lbnQuc2Nyb2xsTGVmdCA9IGluZm8yLmxlZnQ7CiAgICAgICAgICAgICAgaW5mbzIuZWxlbWVudC5zY3JvbGxUb3AgPSBpbmZvMi50b3A7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uKGlucHV0KSB7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uOwogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gewogICAgICAgICAgICAgIHN0YXJ0OiBpbnB1dC5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBlbmQ6IGlucHV0LnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gZ2V0T2Zmc2V0cyhpbnB1dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2VsZWN0aW9uIHx8IHsKICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgIGVuZDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uKGlucHV0LCBvZmZzZXRzKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSBvZmZzZXRzLnN0YXJ0OwogICAgICAgICAgdmFyIGVuZCA9IG9mZnNldHMuZW5kOwogICAgICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uRW5kID0gTWF0aC5taW4oZW5kLCBpbnB1dC52YWx1ZS5sZW5ndGgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0T2Zmc2V0cyhpbnB1dCwgb2Zmc2V0cyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBjYW5Vc2VET00gJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uU2VsZWN0IiwgWyJmb2N1c291dCIsICJjb250ZXh0bWVudSIsICJkcmFnZW5kIiwgImZvY3VzaW4iLCAia2V5ZG93biIsICJrZXl1cCIsICJtb3VzZWRvd24iLCAibW91c2V1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbiQxKG5vZGUpIHsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGFuY2hvck5vZGU6IHNlbGVjdGlvbi5hbmNob3JOb2RlLAogICAgICAgICAgICAgIGFuY2hvck9mZnNldDogc2VsZWN0aW9uLmFuY2hvck9mZnNldCwKICAgICAgICAgICAgICBmb2N1c05vZGU6IHNlbGVjdGlvbi5mb2N1c05vZGUsCiAgICAgICAgICAgICAgZm9jdXNPZmZzZXQ6IHNlbGVjdGlvbi5mb2N1c09mZnNldAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldERvY3VtZW50KGV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG1vdXNlRG93biB8fCBhY3RpdmVFbGVtZW50JDEgPT0gbnVsbCB8fCBhY3RpdmVFbGVtZW50JDEgIT09IGdldEFjdGl2ZUVsZW1lbnQoZG9jKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbiQxKGFjdGl2ZUVsZW1lbnQkMSk7CiAgICAgICAgICBpZiAoIWxhc3RTZWxlY3Rpb24gfHwgIXNoYWxsb3dFcXVhbChsYXN0U2VsZWN0aW9uLCBjdXJyZW50U2VsZWN0aW9uKSkgewogICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyhhY3RpdmVFbGVtZW50SW5zdCQxLCAib25TZWxlY3QiKTsKICAgICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50KCJvblNlbGVjdCIsICJzZWxlY3QiLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGV2ZW50LnRhcmdldCA9IGFjdGl2ZUVsZW1lbnQkMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSB0YXJnZXRJbnN0ID8gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KSA6IHdpbmRvdzsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIGlmIChpc1RleHRJbnB1dEVsZW1lbnQodGFyZ2V0Tm9kZSkgfHwgdGFyZ2V0Tm9kZS5jb250ZW50RWRpdGFibGUgPT09ICJ0cnVlIikgewogICAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gdGFyZ2V0Tm9kZTsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudCQxID0gbnVsbDsKICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSB0cnVlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNldXAiOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgICBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICAgIGlmIChza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYWtlUHJlZml4TWFwKHN0eWxlUHJvcCwgZXZlbnROYW1lKSB7CiAgICAgICAgICB2YXIgcHJlZml4ZXMyID0ge307CiAgICAgICAgICBwcmVmaXhlczJbc3R5bGVQcm9wLnRvTG93ZXJDYXNlKCldID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBwcmVmaXhlczJbIldlYmtpdCIgKyBzdHlsZVByb3BdID0gIndlYmtpdCIgKyBldmVudE5hbWU7CiAgICAgICAgICBwcmVmaXhlczJbIk1veiIgKyBzdHlsZVByb3BdID0gIm1veiIgKyBldmVudE5hbWU7CiAgICAgICAgICByZXR1cm4gcHJlZml4ZXMyOwogICAgICAgIH0KICAgICAgICB2YXIgdmVuZG9yUHJlZml4ZXMgPSB7CiAgICAgICAgICBhbmltYXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25FbmQiKSwKICAgICAgICAgIGFuaW1hdGlvbml0ZXJhdGlvbjogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvbkl0ZXJhdGlvbiIpLAogICAgICAgICAgYW5pbWF0aW9uc3RhcnQ6IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25TdGFydCIpLAogICAgICAgICAgdHJhbnNpdGlvbmVuZDogbWFrZVByZWZpeE1hcCgiVHJhbnNpdGlvbiIsICJUcmFuc2l0aW9uRW5kIikKICAgICAgICB9OwogICAgICAgIHZhciBwcmVmaXhlZEV2ZW50TmFtZXMgPSB7fTsKICAgICAgICB2YXIgc3R5bGUgPSB7fTsKICAgICAgICBpZiAoY2FuVXNlRE9NKSB7CiAgICAgICAgICBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlOwogICAgICAgICAgaWYgKCEoIkFuaW1hdGlvbkV2ZW50IiBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25lbmQuYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uaXRlcmF0aW9uLmFuaW1hdGlvbjsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbnN0YXJ0LmFuaW1hdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKCJUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLnRyYW5zaXRpb25lbmQudHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoZXZlbnROYW1lKSB7CiAgICAgICAgICBpZiAocHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdOwogICAgICAgICAgfSBlbHNlIGlmICghdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZWZpeE1hcCA9IHZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV07CiAgICAgICAgICBmb3IgKHZhciBzdHlsZVByb3AgaW4gcHJlZml4TWFwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXhNYXAuaGFzT3duUHJvcGVydHkoc3R5bGVQcm9wKSAmJiBzdHlsZVByb3AgaW4gc3R5bGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0gPSBwcmVmaXhNYXBbc3R5bGVQcm9wXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTsKICAgICAgICB9CiAgICAgICAgdmFyIEFOSU1BVElPTl9FTkQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uZW5kIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9JVEVSQVRJT04gPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uaXRlcmF0aW9uIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9TVEFSVCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25zdGFydCIpOwogICAgICAgIHZhciBUUkFOU0lUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJ0cmFuc2l0aW9uZW5kIik7CiAgICAgICAgdmFyIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB2YXIgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMgPSBbImFib3J0IiwgImF1eENsaWNrIiwgImNhbmNlbCIsICJjYW5QbGF5IiwgImNhblBsYXlUaHJvdWdoIiwgImNsaWNrIiwgImNsb3NlIiwgImNvbnRleHRNZW51IiwgImNvcHkiLCAiY3V0IiwgImRyYWciLCAiZHJhZ0VuZCIsICJkcmFnRW50ZXIiLCAiZHJhZ0V4aXQiLCAiZHJhZ0xlYXZlIiwgImRyYWdPdmVyIiwgImRyYWdTdGFydCIsICJkcm9wIiwgImR1cmF0aW9uQ2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImdvdFBvaW50ZXJDYXB0dXJlIiwgImlucHV0IiwgImludmFsaWQiLCAia2V5RG93biIsICJrZXlQcmVzcyIsICJrZXlVcCIsICJsb2FkIiwgImxvYWRlZERhdGEiLCAibG9hZGVkTWV0YWRhdGEiLCAibG9hZFN0YXJ0IiwgImxvc3RQb2ludGVyQ2FwdHVyZSIsICJtb3VzZURvd24iLCAibW91c2VNb3ZlIiwgIm1vdXNlT3V0IiwgIm1vdXNlT3ZlciIsICJtb3VzZVVwIiwgInBhc3RlIiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwb2ludGVyQ2FuY2VsIiwgInBvaW50ZXJEb3duIiwgInBvaW50ZXJNb3ZlIiwgInBvaW50ZXJPdXQiLCAicG9pbnRlck92ZXIiLCAicG9pbnRlclVwIiwgInByb2dyZXNzIiwgInJhdGVDaGFuZ2UiLCAicmVzZXQiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VibWl0IiwgInN1c3BlbmQiLCAidGltZVVwZGF0ZSIsICJ0b3VjaENhbmNlbCIsICJ0b3VjaEVuZCIsICJ0b3VjaFN0YXJ0IiwgInZvbHVtZUNoYW5nZSIsICJzY3JvbGwiLCAidG9nZ2xlIiwgInRvdWNoTW92ZSIsICJ3YWl0aW5nIiwgIndoZWVsIl07CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSkgewogICAgICAgICAgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuc2V0KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWFjdE5hbWUsIFtkb21FdmVudE5hbWVdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudHMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBzaW1wbGVFdmVudFBsdWdpbkV2ZW50c1tpXTsKICAgICAgICAgICAgdmFyIGRvbUV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2YXIgY2FwaXRhbGl6ZWRFdmVudCA9IGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZXZlbnROYW1lLnNsaWNlKDEpOwogICAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgIm9uIiArIGNhcGl0YWxpemVkRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fRU5ELCAib25BbmltYXRpb25FbmQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX0lURVJBVElPTiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9TVEFSVCwgIm9uQW5pbWF0aW9uU3RhcnQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImRibGNsaWNrIiwgIm9uRG91YmxlQ2xpY2siKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3VzaW4iLCAib25Gb2N1cyIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNvdXQiLCAib25CbHVyIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KFRSQU5TSVRJT05fRU5ELCAib25UcmFuc2l0aW9uRW5kIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgcmVhY3ROYW1lID0gdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuZ2V0KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICBpZiAocmVhY3ROYW1lID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0V2ZW50OwogICAgICAgICAgdmFyIHJlYWN0RXZlbnRUeXBlID0gZG9tRXZlbnROYW1lOwogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIGlmIChnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNLZXlib2FyZEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJmb2N1cyI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImJsdXIiOwogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuYnV0dG9uID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0RyYWdFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RvdWNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0VORDoKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fSVRFUkFUSU9OOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9TVEFSVDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNBbmltYXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUUkFOU0lUSU9OX0VORDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVUlFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1doZWVsRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljQ2xpcGJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY2N1bXVsYXRlVGFyZ2V0T25seSA9ICFpbkNhcHR1cmVQaGFzZSAmJiAvLyBUT0RPOiBpZGVhbGx5LCB3ZSdkIGV2ZW50dWFsbHkgYWRkIGFsbCBldmVudHMgZnJvbQogICAgICAgICAgICAvLyBub25EZWxlZ2F0ZWRFdmVudHMgbGlzdCBpbiBET01QbHVnaW5FdmVudFN5c3RlbS4KICAgICAgICAgICAgLy8gVGhlbiB3ZSBjYW4gcmVtb3ZlIHRoaXMgc3BlY2lhbCBsaXN0LgogICAgICAgICAgICAvLyBUaGlzIGlzIGEgYnJlYWtpbmcgY2hhbmdlIHRoYXQgY2FuIHdhaXQgdW50aWwgUmVhY3QgMTguCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSA9PT0gInNjcm9sbCI7CiAgICAgICAgICAgIHZhciBfbGlzdGVuZXJzID0gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnQudHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5KTsKICAgICAgICAgICAgaWYgKF9saXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBfZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50OiBfZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IF9saXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50cygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDIoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQxKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzKCk7CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB2YXIgc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucyA9IChldmVudFN5c3RlbUZsYWdzICYgU0hPVUxEX05PVF9QUk9DRVNTX1BPTFlGSUxMX0VWRU5UX1BMVUdJTlMpID09PSAwOwogICAgICAgICAgaWYgKHNob3VsZFByb2Nlc3NQb2x5ZmlsbFBsdWdpbnMpIHsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBtZWRpYUV2ZW50VHlwZXMgPSBbImFib3J0IiwgImNhbnBsYXkiLCAiY2FucGxheXRocm91Z2giLCAiZHVyYXRpb25jaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAibG9hZGVkZGF0YSIsICJsb2FkZWRtZXRhZGF0YSIsICJsb2Fkc3RhcnQiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInByb2dyZXNzIiwgInJhdGVjaGFuZ2UiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VzcGVuZCIsICJ0aW1ldXBkYXRlIiwgInZvbHVtZWNoYW5nZSIsICJ3YWl0aW5nIl07CiAgICAgICAgdmFyIG5vbkRlbGVnYXRlZEV2ZW50cyA9IG5ldyBTZXQoWyJjYW5jZWwiLCAiY2xvc2UiLCAiaW52YWxpZCIsICJsb2FkIiwgInNjcm9sbCIsICJ0b2dnbGUiXS5jb25jYXQobWVkaWFFdmVudFR5cGVzKSk7CiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lciwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0OwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyLCB2b2lkIDAsIGV2ZW50KTsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZUl0ZW1zSW5PcmRlcihldmVudCwgZGlzcGF0Y2hMaXN0ZW5lcnMsIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNJbnN0YW5jZTsKICAgICAgICAgIGlmIChpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICB2YXIgX2Rpc3BhdGNoTGlzdGVuZXJzJGkgPSBkaXNwYXRjaExpc3RlbmVyc1tpXSwgaW5zdGFuY2UgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5pbnN0YW5jZSwgY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmN1cnJlbnRUYXJnZXQsIGxpc3RlbmVyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBwcmV2aW91c0luc3RhbmNlICYmIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lciwgY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgX2xpc3RlbmVyLCBfY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IF9pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaFF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGxpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgpIGNhbGwgZm9yICIlcyIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0S2V5ID0gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgIGlmICghbGlzdGVuZXJTZXQuaGFzKGxpc3RlbmVyU2V0S2V5KSkgewogICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBsaXN0ZW5lclNldC5hZGQobGlzdGVuZXJTZXRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgdGFyZ2V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCkgY2FsbCBmb3IgIiVzIiBpbiB0aGUgYnViYmxlIHBoYXNlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRTeXN0ZW1GbGFncyA9IDA7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ZW5pbmdNYXJrZXIgPSAiX3JlYWN0TGlzdGVuaW5nIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZmFsc2UsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCB0cnVlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIGZhbHNlLCBvd25lckRvY3VtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIGlzRGVmZXJyZWRMaXN0ZW5lckZvckxlZ2FjeUZCU3VwcG9ydCkgewogICAgICAgICAgdmFyIGxpc3RlbmVyID0gY3JlYXRlRXZlbnRMaXN0ZW5lcldyYXBwZXJXaXRoUHJpb3JpdHkodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgdmFyIGlzUGFzc2l2ZUxpc3RlbmVyID0gdm9pZCAwOwogICAgICAgICAgaWYgKHBhc3NpdmVCcm93c2VyRXZlbnRzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJ0b3VjaHN0YXJ0IiB8fCBkb21FdmVudE5hbWUgPT09ICJ0b3VjaG1vdmUiIHx8IGRvbUV2ZW50TmFtZSA9PT0gIndoZWVsIikgewogICAgICAgICAgICAgIGlzUGFzc2l2ZUxpc3RlbmVyID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgdmFyIHVuc3Vic2NyaWJlTGlzdGVuZXI7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBpZiAoaXNQYXNzaXZlTGlzdGVuZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBncmFuZENvbnRhaW5lciA9PT0gdGFyZ2V0Q29udGFpbmVyIHx8IGdyYW5kQ29udGFpbmVyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgJiYgZ3JhbmRDb250YWluZXIucGFyZW50Tm9kZSA9PT0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgYW5jZXN0b3JJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGlmICgoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFKSA9PT0gMCAmJiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX05PTl9ERUxFR0FURUQpID09PSAwKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJOb2RlID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICBtYWluTG9vcDogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBub2RlVGFnID0gbm9kZS50YWc7CiAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFJvb3QgfHwgbm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihjb250YWluZXIyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kTm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChncmFuZE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZFRhZyA9IGdyYW5kTm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRUYWcgPT09IEhvc3RSb290IHx8IGdyYW5kVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZENvbnRhaW5lciA9IGdyYW5kTm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZ3JhbmROb2RlID0gZ3JhbmROb2RlLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvbnRhaW5lcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUYWcgPSBwYXJlbnROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHBhcmVudFRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBhbmNlc3Rvckluc3QgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWUgbWFpbkxvb3A7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcjIgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hFdmVudHNGb3JQbHVnaW5zKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIGFuY2VzdG9ySW5zdCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgbGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICBsaXN0ZW5lciwKICAgICAgICAgICAgY3VycmVudFRhcmdldAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUsIG5hdGl2ZUV2ZW50VHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5LCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICE9PSBudWxsID8gcmVhY3ROYW1lICsgIkNhcHR1cmUiIDogbnVsbDsKICAgICAgICAgIHZhciByZWFjdEV2ZW50TmFtZSA9IGluQ2FwdHVyZVBoYXNlID8gY2FwdHVyZU5hbWUgOiByZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHZhciBsYXN0SG9zdENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMi5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTIudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RIb3N0Q29tcG9uZW50ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChyZWFjdEV2ZW50TmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0RXZlbnROYW1lKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGxpc3RlbmVyLCBsYXN0SG9zdENvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWNjdW11bGF0ZVRhcmdldE9ubHkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgKyAiQ2FwdHVyZSI7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMyA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UzLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMy50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJ1YmJsZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50KGluc3QpIHsKICAgICAgICAgIGlmIChpbnN0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZG8gewogICAgICAgICAgICBpbnN0ID0gaW5zdC5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlIChpbnN0ICYmIGluc3QudGFnICE9PSBIb3N0Q29tcG9uZW50KTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGluc3RBLCBpbnN0QikgewogICAgICAgICAgdmFyIG5vZGVBID0gaW5zdEE7CiAgICAgICAgICB2YXIgbm9kZUIgPSBpbnN0QjsKICAgICAgICAgIHZhciBkZXB0aEEgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEEgPSBub2RlQTsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgICBkZXB0aEErKzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZXB0aEIgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEIgPSBub2RlQjsgdGVtcEI7IHRlbXBCID0gZ2V0UGFyZW50KHRlbXBCKSkgewogICAgICAgICAgICBkZXB0aEIrKzsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEEgLSBkZXB0aEIgPiAwKSB7CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgZGVwdGhBLS07CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZGVwdGhCIC0gZGVwdGhBID4gMCkgewogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICAgIGRlcHRoQi0tOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoID0gZGVwdGhBOwogICAgICAgICAgd2hpbGUgKGRlcHRoLS0pIHsKICAgICAgICAgICAgaWYgKG5vZGVBID09PSBub2RlQiB8fCBub2RlQiAhPT0gbnVsbCAmJiBub2RlQSA9PT0gbm9kZUIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVBOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZXZlbnQsIHRhcmdldCwgY29tbW9uLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBldmVudC5fcmVhY3ROYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0OwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBpbnN0YW5jZSwgYWx0ZXJuYXRlID0gX2luc3RhbmNlNC5hbHRlcm5hdGUsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTQuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2U0LnRhZzsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUgPT09IGNvbW1vbikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBidWJibGVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGVudGVyRXZlbnQsIGZyb20sIHRvKSB7CiAgICAgICAgICB2YXIgY29tbW9uID0gZnJvbSAmJiB0byA/IGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGZyb20sIHRvKSA6IG51bGw7CiAgICAgICAgICBpZiAoZnJvbSAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20sIGNvbW1vbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRvICE9PSBudWxsICYmIGVudGVyRXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBlbnRlckV2ZW50LCB0bywgY29tbW9uLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lICsgIl9fIiArIChjYXB0dXJlID8gImNhcHR1cmUiIDogImJ1YmJsZSIpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgPSAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiOwogICAgICAgIHZhciBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgPSAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIjsKICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgQVVUT0ZPQ1VTID0gImF1dG9Gb2N1cyI7CiAgICAgICAgdmFyIENISUxEUkVOID0gImNoaWxkcmVuIjsKICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgIHZhciBIVE1MJDEgPSAiX19odG1sIjsKICAgICAgICB2YXIgd2FybmVkVW5rbm93blRhZ3M7CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgdmFyIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZTsKICAgICAgICB2YXIgd2FybkZvckV4dHJhQXR0cmlidXRlczsKICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgIHZhciBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nOwogICAgICAgIHZhciBub3JtYWxpemVIVE1MOwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzID0gewogICAgICAgICAgICAvLyBUaGVyZSBhcmUgd29ya2luZyBwb2x5ZmlsbHMgZm9yIDxkaWFsb2c+LiBMZXQgcGVvcGxlIHVzZSBpdC4KICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAvLyBFbGVjdHJvbiBzaGlwcyBhIGN1c3RvbSA8d2Vidmlldz4gdGFnIHRvIGRpc3BsYXkgZXh0ZXJuYWwgd2ViIGNvbnRlbnQgaW4KICAgICAgICAgICAgLy8gYW4gaXNvbGF0ZWQgZnJhbWUgYW5kIHByb2Nlc3MuCiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAvLyBpcyBvZnRlbiB1c2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgogICAgICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvd2Vidmlldy10YWcKICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQgPSBmdW5jdGlvbih0eXBlLCBwcm9wcykgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCB7CiAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00gJiYgIWRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZSA9IGZ1bmN0aW9uKHByb3BOYW1lLCBzZXJ2ZXJWYWx1ZSwgY2xpZW50VmFsdWUpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VmFsdWUgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VmFsdWUpOwogICAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKHNlcnZlclZhbHVlKTsKICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9PT0gbm9ybWFsaXplZENsaWVudFZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIlByb3AgYCVzYCBkaWQgbm90IG1hdGNoLiBTZXJ2ZXI6ICVzIENsaWVudDogJXMiLCBwcm9wTmFtZSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZFNlcnZlclZhbHVlKSwgSlNPTi5zdHJpbmdpZnkobm9ybWFsaXplZENsaWVudFZhbHVlKSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckV4dHJhQXR0cmlidXRlcyA9IGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWVzKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICBuYW1lcy5wdXNoKG5hbWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXJyb3IoIkV4dHJhIGF0dHJpYnV0ZXMgZnJvbSB0aGUgc2VydmVyOiAlcyIsIG5hbWVzKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbihyZWdpc3RyYXRpb25OYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICBpZiAobGlzdGVuZXIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYGZhbHNlYC5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCVzYCB0eXBlLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHR5cGVvZiBsaXN0ZW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBub3JtYWxpemVIVE1MID0gZnVuY3Rpb24ocGFyZW50LCBodG1sKSB7CiAgICAgICAgICAgIHZhciB0ZXN0RWxlbWVudCA9IHBhcmVudC5uYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFID8gcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudChwYXJlbnQudGFnTmFtZSkgOiBwYXJlbnQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50TlMocGFyZW50Lm5hbWVzcGFjZVVSSSwgcGFyZW50LnRhZ05hbWUpOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICByZXR1cm4gdGVzdEVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCA9IC9cclxuPy9nOwogICAgICAgIHZhciBOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVggPSAvXHUwMDAwfFx1RkZGRC9nOwogICAgICAgIGZ1bmN0aW9uIG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShtYXJrdXApIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tIdG1sU3RyaW5nQ29lcmNpb24obWFya3VwKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXJrdXBTdHJpbmcgPSB0eXBlb2YgbWFya3VwID09PSAic3RyaW5nIiA/IG1hcmt1cCA6ICIiICsgbWFya3VwOwogICAgICAgICAgcmV0dXJuIG1hcmt1cFN0cmluZy5yZXBsYWNlKE5PUk1BTElaRV9ORVdMSU5FU19SRUdFWCwgIlxuIikucmVwbGFjZShOT1JNQUxJWkVfTlVMTF9BTkRfUkVQTEFDRU1FTlRfUkVHRVgsICIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHNlcnZlclRleHQsIGNsaWVudFRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHZhciBub3JtYWxpemVkQ2xpZW50VGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShjbGllbnRUZXh0KTsKICAgICAgICAgIHZhciBub3JtYWxpemVkU2VydmVyVGV4dCA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJUZXh0KTsKICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVGV4dCA9PT0gbm9ybWFsaXplZENsaWVudFRleHQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCdUZXh0IGNvbnRlbnQgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAiJXMiIENsaWVudDogIiVzIicsIG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0LCBub3JtYWxpemVkQ2xpZW50VGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSAmJiBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGV4dCBjb250ZW50IGRvZXMgbm90IG1hdGNoIHNlcnZlci1yZW5kZXJlZCBIVE1MLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQobm9kZSkgewogICAgICAgICAgbm9kZS5vbmNsaWNrID0gbm9vcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgbmV4dFByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFRleHRDb250ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVwZGF0ZVBheWxvYWQubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgdmFyIHByb3BLZXkgPSB1cGRhdGVQYXlsb2FkW2ldOwogICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBwcm9wVmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50Myh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQsIHBhcmVudE5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgdmFyIGRvbUVsZW1lbnQ7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlVVJJID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgbmFtZXNwYWNlVVJJID0gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgdHlwZSAhPT0gdHlwZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiPCVzIC8+IGlzIHVzaW5nIGluY29ycmVjdCBjYXNpbmcuIFVzZSBQYXNjYWxDYXNlIGZvciBSZWFjdCBjb21wb25lbnRzLCBvciBsb3dlcmNhc2UgZm9yIEhUTUwgZWxlbWVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlID09PSAic2NyaXB0IikgewogICAgICAgICAgICAgIHZhciBkaXYgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIGRpdi5pbm5lckhUTUwgPSAiPHNjcmlwdD48XC9zY3JpcHQ+IjsKICAgICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGRpdi5maXJzdENoaWxkOwogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBkaXYucmVtb3ZlQ2hpbGQoZmlyc3RDaGlsZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3BzLmlzID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSwgewogICAgICAgICAgICAgICAgaXM6IHByb3BzLmlzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlKTsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gInNlbGVjdCIpIHsKICAgICAgICAgICAgICAgIHZhciBub2RlID0gZG9tRWxlbWVudDsKICAgICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgICBub2RlLm11bHRpcGxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuc2l6ZSkgewogICAgICAgICAgICAgICAgICBub2RlLnNpemUgPSBwcm9wcy5zaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZVVSSSwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9tRWxlbWVudCkgPT09ICJbb2JqZWN0IEhUTUxVbmtub3duRWxlbWVudF0iICYmICFoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFVua25vd25UYWdzLCB0eXBlKSkgewogICAgICAgICAgICAgICAgd2FybmVkVW5rbm93blRhZ3NbdHlwZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSB0YWcgPCVzPiBpcyB1bnJlY29nbml6ZWQgaW4gdGhpcyBicm93c2VyLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgUmVhY3QgY29tcG9uZW50LCBzdGFydCBpdHMgbmFtZSB3aXRoIGFuIHVwcGVyY2FzZSBsZXR0ZXIuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUodGV4dCwgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiBnZXRPd25lckRvY3VtZW50RnJvbVJvb3RDb250YWluZXIocm9vdENvbnRhaW5lckVsZW1lbnQpLmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ2aWRlbyI6CiAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lZGlhRXZlbnRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudChtZWRpYUV2ZW50VHlwZXNbaV0sIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcyk7CiAgICAgICAgICBzZXRJbml0aWFsRE9NUHJvcGVydGllcyh0YWcsIGRvbUVsZW1lbnQsIHJvb3RDb250YWluZXJFbGVtZW50LCBwcm9wcywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIGZhbHNlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMyhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgbGFzdFJhd1Byb3BzLCBuZXh0UmF3UHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgdmFyIGxhc3RQcm9wczsKICAgICAgICAgIHZhciBuZXh0UHJvcHM7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGxhc3RSYXdQcm9wczsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBuZXh0UmF3UHJvcHM7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsYXN0UHJvcHMub25DbGljayAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgbmV4dFByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCBuZXh0UHJvcHMpOwogICAgICAgICAgdmFyIHByb3BLZXk7CiAgICAgICAgICB2YXIgc3R5bGVOYW1lOwogICAgICAgICAgdmFyIHN0eWxlVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbGFzdFByb3BzKSB7CiAgICAgICAgICAgIGlmIChuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgIWxhc3RQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBsYXN0UHJvcHNbcHJvcEtleV0gPT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHZhciBsYXN0U3R5bGUgPSBsYXN0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFN0eWxlKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdFN0eWxlLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCB8fCBwcm9wS2V5ID09PSBDSElMRFJFTikgOwogICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IG5leHRQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgdmFyIGxhc3RQcm9wID0gbGFzdFByb3BzICE9IG51bGwgPyBsYXN0UHJvcHNbcHJvcEtleV0gOiB2b2lkIDA7CiAgICAgICAgICAgIGlmICghbmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8IG5leHRQcm9wID09PSBsYXN0UHJvcCB8fCBuZXh0UHJvcCA9PSBudWxsICYmIGxhc3RQcm9wID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChsYXN0UHJvcCkgewogICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbGFzdFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkgJiYgKCFuZXh0UHJvcCB8fCAhbmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gIiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmIGxhc3RQcm9wW3N0eWxlTmFtZV0gIT09IG5leHRQcm9wW3N0eWxlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gbmV4dFByb3Bbc3R5bGVOYW1lXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZC5wdXNoKHByb3BLZXksIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSBuZXh0UHJvcDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIGxhc3RIdG1sID0gbGFzdFByb3AgPyBsYXN0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdEh0bWwgIT09IG5leHRIdG1sKSB7CiAgICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkICYmIGxhc3RQcm9wICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVNob3J0aGFuZFByb3BlcnR5Q29sbGlzaW9uSW5EZXYoc3R5bGVVcGRhdGVzLCBuZXh0UHJvcHNbU1RZTEVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2goU1RZTEUsIHN0eWxlVXBkYXRlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzKSB7CiAgICAgICAgICBpZiAodGFnID09PSAiaW5wdXQiICYmIG5leHRSYXdQcm9wcy50eXBlID09PSAicmFkaW8iICYmIG5leHRSYXdQcm9wcy5uYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlQ2hlY2tlZChkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdhc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlcihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdXBkYXRlV3JhcHBlciQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcG9zdFVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcHJvcE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgaWYgKCFwb3NzaWJsZVN0YW5kYXJkTmFtZXMuaGFzT3duUHJvcGVydHkobG93ZXJDYXNlZE5hbWUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBvc3NpYmxlU3RhbmRhcmROYW1lc1tsb3dlckNhc2VkTmFtZV0gfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIHJhd1Byb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJFbGVtZW50LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWc7CiAgICAgICAgICB2YXIgZXh0cmFBdHRyaWJ1dGVOYW1lczsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2FuY2VsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2xvc2UiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaWZyYW1lIjoKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgY2FzZSAiZW1iZWQiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNvdXJjZSI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW1nIjoKICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICBjYXNlICJsaW5rIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImxvYWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydFZhbGlkUHJvcHModGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGRvbUVsZW1lbnQuYXR0cmlidXRlczsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGF0dHJpYnV0ZXMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVzW19pXS5uYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgc3dpdGNoIChuYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlICJ2YWx1ZSI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY2hlY2tlZCI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAic2VsZWN0ZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuYWRkKGF0dHJpYnV0ZXNbX2ldLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBudWxsOwogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiByYXdQcm9wcykgewogICAgICAgICAgICBpZiAoIXJhd1Byb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gcmF3UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5leHRQcm9wID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09ICIiICsgbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChkb21FbGVtZW50LnRleHRDb250ZW50LCBuZXh0UHJvcCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtDSElMRFJFTiwgIiIgKyBuZXh0UHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZFdhcm5EZXYgJiYgdHJ1ZSAmJiAvLyBDb252aW5jZSBGbG93IHdlJ3ZlIGNhbGN1bGF0ZWQgaXQgKGl0J3MgREVWLW9ubHkgaW4gdGhpcyBtZXRob2QuKQogICAgICAgICAgICB0eXBlb2YgaXNDdXN0b21Db21wb25lbnRUYWcgPT09ICJib29sZWFuIikgewogICAgICAgICAgICAgIHZhciBzZXJ2ZXJWYWx1ZSA9IHZvaWQgMDsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gaXNDdXN0b21Db21wb25lbnRUYWcgJiYgZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCA/IG51bGwgOiBnZXRQcm9wZXJ0eUluZm8ocHJvcEtleSk7CiAgICAgICAgICAgICAgaWYgKHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSA9PT0gdHJ1ZSkgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyB8fCAvLyBDb250cm9sbGVkIGF0dHJpYnV0ZXMgYXJlIG5vdCB2YWxpZGF0ZWQKICAgICAgICAgICAgICAvLyBUT0RPOiBPbmx5IGlnbm9yZSB0aGVtIG9uIGNvbnRyb2xsZWQgdGFncy4KICAgICAgICAgICAgICBwcm9wS2V5ID09PSAidmFsdWUiIHx8IHByb3BLZXkgPT09ICJjaGVja2VkIiB8fCBwcm9wS2V5ID09PSAic2VsZWN0ZWQiKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICAgIHZhciBzZXJ2ZXJIVE1MID0gZG9tRWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICAgICAgICB2YXIgbmV4dEh0bWwgPSBuZXh0UHJvcCA/IG5leHRQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWRIVE1MID0gbm9ybWFsaXplSFRNTChkb21FbGVtZW50LCBuZXh0SHRtbCk7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZEhUTUwgIT09IHNlcnZlckhUTUwpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVySFRNTCwgZXhwZWN0ZWRIVE1MKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkpOwogICAgICAgICAgICAgICAgaWYgKGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkU3R5bGUgPSBjcmVhdGVEYW5nZXJvdXNTdHJpbmdGb3JTdHlsZXMobmV4dFByb3ApOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGRvbUVsZW1lbnQuZ2V0QXR0cmlidXRlKCJzdHlsZSIpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRTdHlsZSAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIGV4cGVjdGVkU3R5bGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiAhZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydCkgewogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSkgewogICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFzaG91bGRJZ25vcmVBdHRyaWJ1dGUocHJvcEtleSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgJiYgIXNob3VsZFJlbW92ZUF0dHJpYnV0ZShwcm9wS2V5LCBuZXh0UHJvcCwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykpIHsKICAgICAgICAgICAgICAgIHZhciBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIG93bk5hbWVzcGFjZSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0YWcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChvd25OYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhbmRhcmROYW1lID0gZ2V0UG9zc2libGVTdGFuZGFyZE5hbWUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSAhPT0gbnVsbCAmJiBzdGFuZGFyZE5hbWUgIT09IHByb3BLZXkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBkb250V2FybkN1c3RvbUVsZW1lbnQgPSBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0OwogICAgICAgICAgICAgICAgaWYgKCFkb250V2FybkN1c3RvbUVsZW1lbnQgJiYgbmV4dFByb3AgIT09IHNlcnZlclZhbHVlICYmICFpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSAtIFNob3VsZCBiZSBpbmZlcnJlZCBhcyBub3QgdW5kZWZpbmVkLgogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5zaXplID4gMCAmJiByYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMoZXh0cmFBdHRyaWJ1dGVOYW1lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlcihkb21FbGVtZW50LCByYXdQcm9wcywgdHJ1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByYXdQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlUGF5bG9hZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0Tm9kZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIGlzRGlmZmVyZW50ID0gdGV4dE5vZGUubm9kZVZhbHVlICE9PSB0ZXh0OwogICAgICAgICAgcmV0dXJuIGlzRGlmZmVyZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgPCVzPiBpbiA8JXM+LiIsIGNoaWxkLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgY2hpbGQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gdGhlIHRleHQgbm9kZSAiJXMiIGluIDwlcz4uJywgY2hpbGQubm9kZVZhbHVlLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Tm9kZSwgdGFnLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIDwlcz4gaW4gPCVzPi4iLCB0YWcsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnROb2RlLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0ZXh0ID09PSAiIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcignRXhwZWN0ZWQgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIG1hdGNoaW5nIHRleHQgbm9kZSBmb3IgIiVzIiBpbiA8JXM+LicsIHRleHQsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMyhkb21FbGVtZW50LCB0YWcsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQyKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHZhciB1cGRhdGVkQW5jZXN0b3JJbmZvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgc3BlY2lhbFRhZ3MgPSBbImFkZHJlc3MiLCAiYXBwbGV0IiwgImFyZWEiLCAiYXJ0aWNsZSIsICJhc2lkZSIsICJiYXNlIiwgImJhc2Vmb250IiwgImJnc291bmQiLCAiYmxvY2txdW90ZSIsICJib2R5IiwgImJyIiwgImJ1dHRvbiIsICJjYXB0aW9uIiwgImNlbnRlciIsICJjb2wiLCAiY29sZ3JvdXAiLCAiZGQiLCAiZGV0YWlscyIsICJkaXIiLCAiZGl2IiwgImRsIiwgImR0IiwgImVtYmVkIiwgImZpZWxkc2V0IiwgImZpZ2NhcHRpb24iLCAiZmlndXJlIiwgImZvb3RlciIsICJmb3JtIiwgImZyYW1lIiwgImZyYW1lc2V0IiwgImgxIiwgImgyIiwgImgzIiwgImg0IiwgImg1IiwgImg2IiwgImhlYWQiLCAiaGVhZGVyIiwgImhncm91cCIsICJociIsICJodG1sIiwgImlmcmFtZSIsICJpbWciLCAiaW5wdXQiLCAiaXNpbmRleCIsICJsaSIsICJsaW5rIiwgImxpc3RpbmciLCAibWFpbiIsICJtYXJxdWVlIiwgIm1lbnUiLCAibWVudWl0ZW0iLCAibWV0YSIsICJuYXYiLCAibm9lbWJlZCIsICJub2ZyYW1lcyIsICJub3NjcmlwdCIsICJvYmplY3QiLCAib2wiLCAicCIsICJwYXJhbSIsICJwbGFpbnRleHQiLCAicHJlIiwgInNjcmlwdCIsICJzZWN0aW9uIiwgInNlbGVjdCIsICJzb3VyY2UiLCAic3R5bGUiLCAic3VtbWFyeSIsICJ0YWJsZSIsICJ0Ym9keSIsICJ0ZCIsICJ0ZW1wbGF0ZSIsICJ0ZXh0YXJlYSIsICJ0Zm9vdCIsICJ0aCIsICJ0aGVhZCIsICJ0aXRsZSIsICJ0ciIsICJ0cmFjayIsICJ1bCIsICJ3YnIiLCAieG1wIl07CiAgICAgICAgICB2YXIgaW5TY29wZVRhZ3MgPSBbCiAgICAgICAgICAgICJhcHBsZXQiLAogICAgICAgICAgICAiY2FwdGlvbiIsCiAgICAgICAgICAgICJodG1sIiwKICAgICAgICAgICAgInRhYmxlIiwKICAgICAgICAgICAgInRkIiwKICAgICAgICAgICAgInRoIiwKICAgICAgICAgICAgIm1hcnF1ZWUiLAogICAgICAgICAgICAib2JqZWN0IiwKICAgICAgICAgICAgInRlbXBsYXRlIiwKICAgICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc3ludGF4Lmh0bWwjaHRtbC1pbnRlZ3JhdGlvbi1wb2ludAogICAgICAgICAgICAvLyBUT0RPOiBEaXN0aW5ndWlzaCBieSBuYW1lc3BhY2UgaGVyZSAtLSBmb3IgPHRpdGxlPiwgaW5jbHVkaW5nIGl0IGhlcmUKICAgICAgICAgICAgLy8gZXJycyBvbiB0aGUgc2lkZSBvZiBmZXdlciB3YXJuaW5ncwogICAgICAgICAgICAiZm9yZWlnbk9iamVjdCIsCiAgICAgICAgICAgICJkZXNjIiwKICAgICAgICAgICAgInRpdGxlIgogICAgICAgICAgXTsKICAgICAgICAgIHZhciBidXR0b25TY29wZVRhZ3MgPSBpblNjb3BlVGFncy5jb25jYXQoWyJidXR0b24iXSk7CiAgICAgICAgICB2YXIgaW1wbGllZEVuZFRhZ3MgPSBbImRkIiwgImR0IiwgImxpIiwgIm9wdGlvbiIsICJvcHRncm91cCIsICJwIiwgInJwIiwgInJ0Il07CiAgICAgICAgICB2YXIgZW1wdHlBbmNlc3RvckluZm8gPSB7CiAgICAgICAgICAgIGN1cnJlbnQ6IG51bGwsCiAgICAgICAgICAgIGZvcm1UYWc6IG51bGwsCiAgICAgICAgICAgIGFUYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBidXR0b25UYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBub2JyVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgcFRhZ0luQnV0dG9uU2NvcGU6IG51bGwsCiAgICAgICAgICAgIGxpc3RJdGVtVGFnQXV0b2Nsb3Npbmc6IG51bGwsCiAgICAgICAgICAgIGRsSXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKG9sZEluZm8sIHRhZykgewogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gYXNzaWduKHt9LCBvbGRJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGluZm8yID0gewogICAgICAgICAgICAgIHRhZwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoaW5TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGJ1dHRvblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3BlY2lhbFRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSAmJiB0YWcgIT09ICJhZGRyZXNzIiAmJiB0YWcgIT09ICJkaXYiICYmIHRhZyAhPT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmN1cnJlbnQgPSBpbmZvMjsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gImZvcm0iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmZvcm1UYWcgPSBpbmZvMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBpbmZvMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYnV0dG9uIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gIm5vYnIiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImxpIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImRkIiB8fCB0YWcgPT09ICJkdCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvMjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpc1RhZ1ZhbGlkV2l0aFBhcmVudCA9IGZ1bmN0aW9uKHRhZywgcGFyZW50VGFnKSB7CiAgICAgICAgICAgIHN3aXRjaCAocGFyZW50VGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIm9wdGdyb3VwIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0Z3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0aCIgfHwgdGFnID09PSAidGQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0ciIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjb2wiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0YWJsZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiY2FwdGlvbiIgfHwgdGFnID09PSAiY29sZ3JvdXAiIHx8IHRhZyA9PT0gInRib2R5IiB8fCB0YWcgPT09ICJ0Zm9vdCIgfHwgdGFnID09PSAidGhlYWQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJiYXNlIiB8fCB0YWcgPT09ICJiYXNlZm9udCIgfHwgdGFnID09PSAiYmdzb3VuZCIgfHwgdGFnID09PSAibGluayIgfHwgdGFnID09PSAibWV0YSIgfHwgdGFnID09PSAidGl0bGUiIHx8IHRhZyA9PT0gIm5vc2NyaXB0IiB8fCB0YWcgPT09ICJub2ZyYW1lcyIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImhlYWQiIHx8IHRhZyA9PT0gImJvZHkiIHx8IHRhZyA9PT0gImZyYW1lc2V0IjsKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiZnJhbWUiOwogICAgICAgICAgICAgIGNhc2UgIiNkb2N1bWVudCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaHRtbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgIT09ICJoMSIgJiYgcGFyZW50VGFnICE9PSAiaDIiICYmIHBhcmVudFRhZyAhPT0gImgzIiAmJiBwYXJlbnRUYWcgIT09ICJoNCIgJiYgcGFyZW50VGFnICE9PSAiaDUiICYmIHBhcmVudFRhZyAhPT0gImg2IjsKICAgICAgICAgICAgICBjYXNlICJycCI6CiAgICAgICAgICAgICAgY2FzZSAicnQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGltcGxpZWRFbmRUYWdzLmluZGV4T2YocGFyZW50VGFnKSA9PT0gLTE7CiAgICAgICAgICAgICAgY2FzZSAiYm9keSI6CiAgICAgICAgICAgICAgY2FzZSAiY2FwdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAiY29sIjoKICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZyYW1lIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICBjYXNlICJ0aCI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgPT0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEludmFsaWRBbmNlc3RvckZvclRhZyA9IGZ1bmN0aW9uKHRhZywgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiYWRkcmVzcyI6CiAgICAgICAgICAgICAgY2FzZSAiYXJ0aWNsZSI6CiAgICAgICAgICAgICAgY2FzZSAiYXNpZGUiOgogICAgICAgICAgICAgIGNhc2UgImJsb2NrcXVvdGUiOgogICAgICAgICAgICAgIGNhc2UgImNlbnRlciI6CiAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBjYXNlICJkaXIiOgogICAgICAgICAgICAgIGNhc2UgImRpdiI6CiAgICAgICAgICAgICAgY2FzZSAiZGwiOgogICAgICAgICAgICAgIGNhc2UgImZpZWxkc2V0IjoKICAgICAgICAgICAgICBjYXNlICJmaWdjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJmaWd1cmUiOgogICAgICAgICAgICAgIGNhc2UgImZvb3RlciI6CiAgICAgICAgICAgICAgY2FzZSAiaGVhZGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZ3JvdXAiOgogICAgICAgICAgICAgIGNhc2UgIm1haW4iOgogICAgICAgICAgICAgIGNhc2UgIm1lbnUiOgogICAgICAgICAgICAgIGNhc2UgIm5hdiI6CiAgICAgICAgICAgICAgY2FzZSAib2wiOgogICAgICAgICAgICAgIGNhc2UgInAiOgogICAgICAgICAgICAgIGNhc2UgInNlY3Rpb24iOgogICAgICAgICAgICAgIGNhc2UgInN1bW1hcnkiOgogICAgICAgICAgICAgIGNhc2UgInVsIjoKICAgICAgICAgICAgICBjYXNlICJwcmUiOgogICAgICAgICAgICAgIGNhc2UgImxpc3RpbmciOgogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICBjYXNlICJociI6CiAgICAgICAgICAgICAgY2FzZSAieG1wIjoKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiZm9ybSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmZvcm1UYWcgfHwgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImxpIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJkZCI6CiAgICAgICAgICAgICAgY2FzZSAiZHQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImEiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZTsKICAgICAgICAgICAgICBjYXNlICJub2JyIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRpZFdhcm4kMSA9IHt9OwogICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oY2hpbGRUYWcsIGNoaWxkVGV4dCwgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIGFuY2VzdG9ySW5mbyA9IGFuY2VzdG9ySW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbzsKICAgICAgICAgICAgdmFyIHBhcmVudEluZm8gPSBhbmNlc3RvckluZm8uY3VycmVudDsKICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudEluZm8gJiYgcGFyZW50SW5mby50YWc7CiAgICAgICAgICAgIGlmIChjaGlsZFRleHQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZFRhZyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nOiB3aGVuIGNoaWxkVGV4dCBpcyBwYXNzZWQsIGNoaWxkVGFnIHNob3VsZCBiZSBudWxsIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkVGFnID0gIiN0ZXh0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW52YWxpZFBhcmVudCA9IGlzVGFnVmFsaWRXaXRoUGFyZW50KGNoaWxkVGFnLCBwYXJlbnRUYWcpID8gbnVsbCA6IHBhcmVudEluZm87CiAgICAgICAgICAgIHZhciBpbnZhbGlkQW5jZXN0b3IgPSBpbnZhbGlkUGFyZW50ID8gbnVsbCA6IGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcoY2hpbGRUYWcsIGFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50T3JBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgfHwgaW52YWxpZEFuY2VzdG9yOwogICAgICAgICAgICBpZiAoIWludmFsaWRQYXJlbnRPckFuY2VzdG9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvclRhZyA9IGludmFsaWRQYXJlbnRPckFuY2VzdG9yLnRhZzsKICAgICAgICAgICAgdmFyIHdhcm5LZXkgPSAhIWludmFsaWRQYXJlbnQgKyAifCIgKyBjaGlsZFRhZyArICJ8IiArIGFuY2VzdG9yVGFnOwogICAgICAgICAgICBpZiAoZGlkV2FybiQxW3dhcm5LZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm4kMVt3YXJuS2V5XSA9IHRydWU7CiAgICAgICAgICAgIHZhciB0YWdEaXNwbGF5TmFtZSA9IGNoaWxkVGFnOwogICAgICAgICAgICB2YXIgd2hpdGVzcGFjZUluZm8gPSAiIjsKICAgICAgICAgICAgaWYgKGNoaWxkVGFnID09PSAiI3RleHQiKSB7CiAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdChjaGlsZFRleHQpKSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJUZXh0IG5vZGVzIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiV2hpdGVzcGFjZSB0ZXh0IG5vZGVzIjsKICAgICAgICAgICAgICAgIHdoaXRlc3BhY2VJbmZvID0gIiBNYWtlIHN1cmUgeW91IGRvbid0IGhhdmUgYW55IGV4dHJhIHdoaXRlc3BhY2UgYmV0d2VlbiB0YWdzIG9uIGVhY2ggbGluZSBvZiB5b3VyIHNvdXJjZSBjb2RlLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIjwiICsgY2hpbGRUYWcgKyAiPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGludmFsaWRQYXJlbnQpIHsKICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICBpZiAoYW5jZXN0b3JUYWcgPT09ICJ0YWJsZSIgJiYgY2hpbGRUYWcgPT09ICJ0ciIpIHsKICAgICAgICAgICAgICAgIGluZm8yICs9ICIgQWRkIGEgPHRib2R5PiwgPHRoZWFkPiBvciA8dGZvb3Q+IHRvIHlvdXIgY29kZSB0byBtYXRjaCB0aGUgRE9NIHRyZWUgZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGNoaWxkIG9mIDwlcz4uJXMlcyIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZywgd2hpdGVzcGFjZUluZm8sIGluZm8yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBkZXNjZW5kYW50IG9mIDwlcz4uIiwgdGFnRGlzcGxheU5hbWUsIGFuY2VzdG9yVGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDEgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgU1VTUEVOU0VfU1RBUlRfREFUQSA9ICIkIjsKICAgICAgICB2YXIgU1VTUEVOU0VfRU5EX0RBVEEgPSAiLyQiOwogICAgICAgIHZhciBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgPSAiJD8iOwogICAgICAgIHZhciBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBID0gIiQhIjsKICAgICAgICB2YXIgU1RZTEUkMSA9ICJzdHlsZSI7CiAgICAgICAgdmFyIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgIHZhciBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250ZXh0KHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlOwogICAgICAgICAgdmFyIG5vZGVUeXBlID0gcm9vdENvbnRhaW5lckluc3RhbmNlLm5vZGVUeXBlOwogICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICBjYXNlIERPQ1VNRU5UX05PREU6CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfRlJBR01FTlRfTk9ERTogewogICAgICAgICAgICAgIHR5cGUgPSBub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/ICIjZG9jdW1lbnQiIDogIiNmcmFnbWVudCI7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcm9vdENvbnRhaW5lckluc3RhbmNlLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSByb290MyA/IHJvb3QzLm5hbWVzcGFjZVVSSSA6IGdldENoaWxkTmFtZXNwYWNlKG51bGwsICIiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSBub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckluc3RhbmNlLnBhcmVudE5vZGUgOiByb290Q29udGFpbmVySW5zdGFuY2U7CiAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IGNvbnRhaW5lcjIubmFtZXNwYWNlVVJJIHx8IG51bGw7CiAgICAgICAgICAgICAgdHlwZSA9IGNvbnRhaW5lcjIudGFnTmFtZTsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShvd25OYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB2YWxpZGF0ZWRUYWcgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKG51bGwsIHZhbGlkYXRlZFRhZyk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZEhvc3RDb250ZXh0KHBhcmVudEhvc3RDb250ZXh0LCB0eXBlLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudEhvc3RDb250ZXh0RGV2ID0gcGFyZW50SG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnRIb3N0Q29udGV4dERldi5uYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhwYXJlbnRIb3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUZvckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gaXNFbmFibGVkKCk7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCk7CiAgICAgICAgICB2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgc2V0RW5hYmxlZChmYWxzZSk7CiAgICAgICAgICByZXR1cm4gYWN0aXZlSW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0QWZ0ZXJDb21taXQoY29udGFpbmVySW5mbykgewogICAgICAgICAgcmVzdG9yZVNlbGVjdGlvbihzZWxlY3Rpb25JbmZvcm1hdGlvbik7CiAgICAgICAgICBzZXRFbmFibGVkKGV2ZW50c0VuYWJsZWQpOwogICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKHR5cGUsIG51bGwsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgc3RyaW5nID0gIiIgKyBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgb3duQW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCBzdHJpbmcsIG93bkFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRvbUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50Myh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBwYXJlbnROYW1lc3BhY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXR1cm4gISFwcm9wcy5hdXRvRm9jdXM7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiAhPT0gdHlwZW9mIG9sZFByb3BzLmNoaWxkcmVuICYmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlID09PSAidGV4dGFyZWEiIHx8IHR5cGUgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgdGV4dCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0Tm9kZSk7CiAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCkgewogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgIGlmIChjdXJyZW50RXZlbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRQcmlvcml0eShjdXJyZW50RXZlbnQudHlwZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIGNhbmNlbFRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBub1RpbWVvdXQgPSAtMTsKICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgIHZhciBzY2hlZHVsZU1pY3JvdGFzayA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gImZ1bmN0aW9uIiA/IHF1ZXVlTWljcm90YXNrIDogdHlwZW9mIGxvY2FsUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGxvY2FsUHJvbWlzZS5yZXNvbHZlKG51bGwpLnRoZW4oY2FsbGJhY2spLmNhdGNoKGhhbmRsZUVycm9ySW5OZXh0VGljayk7CiAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvckluTmV4dFRpY2soZXJyb3IyKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZSwgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuYXV0b0ZvY3VzKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAiaW1nIjogewogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuc3JjID0gbmV3UHJvcHMuc3JjOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWN0Um9vdENvbnRhaW5lciA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIGlmICgocmVhY3RSb290Q29udGFpbmVyID09PSBudWxsIHx8IHJlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwKSAmJiBwYXJlbnROb2RlLm9uY2xpY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQocGFyZW50Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUoY29udGFpbmVyMiwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbmV4dE5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMi5wYXJlbnROb2RlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZTIgPSBpbnN0YW5jZS5zdHlsZTsKICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUyLnNldFByb3BlcnR5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGUyLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlKSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZUluc3RhbmNlKGluc3RhbmNlLCBwcm9wcykgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZVByb3AgPSBwcm9wc1tTVFlMRSQxXTsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gc3R5bGVQcm9wICE9PSB2b2lkIDAgJiYgc3R5bGVQcm9wICE9PSBudWxsICYmIHN0eWxlUHJvcC5oYXNPd25Qcm9wZXJ0eSgiZGlzcGxheSIpID8gc3R5bGVQcm9wLmRpc3BsYXkgOiBudWxsOwogICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi50ZXh0Q29udGVudCA9ICIiOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUudG9Mb3dlckNhc2UoKSAhPT0gaW5zdGFuY2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShpbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQgPT09ICIiIHx8IGluc3RhbmNlLm5vZGVUeXBlICE9PSBURVhUX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBkYXRhc2V0ID0gaW5zdGFuY2UubmV4dFNpYmxpbmcgJiYgaW5zdGFuY2UubmV4dFNpYmxpbmcuZGF0YXNldDsKICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgICAgZGlnZXN0ID0gZGF0YXNldC5kZ3N0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGRhdGFzZXQubXNnOwogICAgICAgICAgICAgIHN0YWNrID0gZGF0YXNldC5zdGNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICBkaWdlc3QsCiAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoaW5zdGFuY2UsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RSZXRyeSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZShub2RlKSB7CiAgICAgICAgICBmb3IgKDsgbm9kZSAhPSBudWxsOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZURhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShpbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudENvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBpbnN0YW5jZSk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGluc3RhbmNlLCBwcm9wcyk7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHRJbnN0YW5jZSk7CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRUZXh0KHRleHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZS5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldEluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50VHlwZSAhPT0gImhlYWQiICYmIHBhcmVudFR5cGUgIT09ICJib2R5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICBpZiAocGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgaHlkcmF0aW9uLiBUaGUgc2VydmVyIEhUTUwgd2FzIHJlcGxhY2VkIHdpdGggY2xpZW50IGNvbnRlbnQgaW4gPCVzPi4iLCBwYXJlbnRDb250YWluZXIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVQb3J0YWxNb3VudChwb3J0YWxJbnN0YW5jZSkgewogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZG9tS2V5ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsUHJvcHNLZXkgPSAiX19yZWFjdFByb3BzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXkgPSAiX19yZWFjdENvbnRhaW5lciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleSA9ICJfX3JlYWN0TGlzdGVuZXJzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5ID0gIl9fcmVhY3RIYW5kbGVzJCIgKyByYW5kb21LZXk7CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxQcm9wc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSA9IGhvc3RJbnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29udGFpbmVyQXNSb290KGhvc3RSb290LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gaG9zdFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVubWFya0NvbnRhaW5lckFzUm9vdChub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250YWluZXJNYXJrZWRBc1Jvb3Qobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0Tm9kZSkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSB0YXJnZXROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBwYXJlbnROb2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldIHx8IHBhcmVudE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHRhcmdldEluc3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0LmNoaWxkICE9PSBudWxsIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgIHdoaWxlIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRTdXNwZW5zZUluc3QgPSBzdXNwZW5zZUluc3RhbmNlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFN1c3BlbnNlSW5zdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgaW5zdCA9IG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gfHwgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQgfHwgaW5zdC50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZ2V0Tm9kZUZyb21JbnN0YW5jZTogSW52YWxpZCBhcmd1bWVudC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZVtpbnRlcm5hbFByb3BzS2V5XSB8fCBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsUHJvcHNLZXldID0gcHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGlmIChlbGVtZW50TGlzdGVuZXJTZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRMaXN0ZW5lclNldDsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMyID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXMyKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgdmFyIGZpYmVyU3RhY2s7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJyZW50OiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgRmliZXIgcG9wcGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlU3RhY2tbaW5kZXhdOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleC0tOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBjdXJzb3IuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQ7CiAgICAgICAgewogICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBlbXB0eUNvbnRleHRPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgfQogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB2YXIgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihmYWxzZSk7CiAgICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyICYmIGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBtYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPSB1bm1hc2tlZENvbnRleHQ7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gdHlwZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICghY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICBjb250ZXh0W2tleV0gPSB1bm1hc2tlZENvbnRleHRba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDb250ZXh0Q2hhbmdlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250ZXh0UHJvdmlkZXIodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICByZXR1cm4gY2hpbGRDb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY2hpbGRDb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjb250ZXh0IGZvdW5kIG9uIHN0YWNrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHR5cGUsIHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0ID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgaWYgKCEoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcykpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKSArICcuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJyArIGNvbnRleHRLZXkgKyAnIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcGFyZW50Q29udGV4dCwgY2hpbGRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgfHwgZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgICBwcmV2aW91c0NvbnRleHQgPSBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBkaWRDaGFuZ2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKCFpbnN0YW5jZSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gaGF2ZSBhbiBpbnN0YW5jZSBieSB0aGlzIHBvaW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRDaGFuZ2UpIHsKICAgICAgICAgICAgICB2YXIgbWVyZ2VkQ29udGV4dCA9IHByb2Nlc3NDaGlsZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBwcmV2aW91c0NvbnRleHQpOwogICAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0ID0gbWVyZ2VkQ29udGV4dDsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZXJnZWRDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGaWJlck1vdW50ZWQoZmliZXIpIHx8IGZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHN1YnRyZWUgcGFyZW50IHRvIGJlIGEgbW91bnRlZCBjbGFzcyBjb21wb25lbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5jb250ZXh0OwogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gbm9kZS50eXBlOwogICAgICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnN0YXRlTm9kZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9IHdoaWxlIChub2RlICE9PSBudWxsKTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGb3VuZCB1bmV4cGVjdGVkIGRldGFjaGVkIHN1YnRyZWUgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTGVnYWN5Um9vdCA9IDA7CiAgICAgICAgdmFyIENvbmN1cnJlbnRSb290ID0gMTsKICAgICAgICB2YXIgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICB2YXIgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaWYgKHN5bmNRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBzeW5jUXVldWUgPSBbY2FsbGJhY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3luY1F1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gdHJ1ZTsKICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpIHsKICAgICAgICAgIGlmIChpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MpIHsKICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrcygpIHsKICAgICAgICAgIGlmICghaXNGbHVzaGluZ1N5bmNRdWV1ZSAmJiBzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IHRydWU7CiAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzVXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgaXNTeW5jID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBzeW5jUXVldWU7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2soaXNTeW5jKTsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3luY1F1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgaWYgKHN5bmNRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3luY1F1ZXVlID0gc3luY1F1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayhJbW1lZGlhdGVQcmlvcml0eSwgZmx1c2hTeW5jQ2FsbGJhY2tzKTsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlUHJpb3JpdHkpOwogICAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBmb3JrU3RhY2sgPSBbXTsKICAgICAgICB2YXIgZm9ya1N0YWNrSW5kZXggPSAwOwogICAgICAgIHZhciB0cmVlRm9ya1Byb3ZpZGVyID0gbnVsbDsKICAgICAgICB2YXIgdHJlZUZvcmtDb3VudCA9IDA7CiAgICAgICAgdmFyIGlkU3RhY2sgPSBbXTsKICAgICAgICB2YXIgaWRTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUNvbnRleHRQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0SWQgPSAxOwogICAgICAgIHZhciB0cmVlQ29udGV4dE92ZXJmbG93ID0gIiI7CiAgICAgICAgZnVuY3Rpb24gaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgcmV0dXJuICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JrZWQpICE9PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGb3Jrc0F0TGV2ZWwod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiB0cmVlRm9ya0NvdW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmVlSWQoKSB7CiAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGlkID0gaWRXaXRoTGVhZGluZ0JpdCAmIH5nZXRMZWFkaW5nQml0KGlkV2l0aExlYWRpbmdCaXQpOwogICAgICAgICAgcmV0dXJuIGlkLnRvU3RyaW5nKDMyKSArIG92ZXJmbG93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCB0b3RhbENoaWxkcmVuKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleCsrXSA9IHRyZWVGb3JrQ291bnQ7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya1Byb3ZpZGVyOwogICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHRyZWVGb3JrQ291bnQgPSB0b3RhbENoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbiwgaW5kZXgyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4KytdID0gdHJlZUNvbnRleHRQcm92aWRlcjsKICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgYmFzZUlkV2l0aExlYWRpbmdCaXQgPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgdmFyIGJhc2VPdmVyZmxvdyA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICB2YXIgYmFzZUxlbmd0aCA9IGdldEJpdExlbmd0aChiYXNlSWRXaXRoTGVhZGluZ0JpdCkgLSAxOwogICAgICAgICAgdmFyIGJhc2VJZCA9IGJhc2VJZFdpdGhMZWFkaW5nQml0ICYgfigxIDw8IGJhc2VMZW5ndGgpOwogICAgICAgICAgdmFyIHNsb3QgPSBpbmRleDIgKyAxOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIGJhc2VMZW5ndGg7CiAgICAgICAgICBpZiAobGVuZ3RoID4gMzApIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mT3ZlcmZsb3dCaXRzID0gYmFzZUxlbmd0aCAtIGJhc2VMZW5ndGggJSA1OwogICAgICAgICAgICB2YXIgbmV3T3ZlcmZsb3dCaXRzID0gKDEgPDwgbnVtYmVyT2ZPdmVyZmxvd0JpdHMpIC0gMTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93ID0gKGJhc2VJZCAmIG5ld092ZXJmbG93Qml0cykudG9TdHJpbmcoMzIpOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUlkID0gYmFzZUlkID4+IG51bWJlck9mT3ZlcmZsb3dCaXRzOwogICAgICAgICAgICB2YXIgcmVzdE9mQmFzZUxlbmd0aCA9IGJhc2VMZW5ndGggLSBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkxlbmd0aCA9IGdldEJpdExlbmd0aCh0b3RhbENoaWxkcmVuKSArIHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciByZXN0T2ZOZXdCaXRzID0gc2xvdCA8PCByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgaWQgPSByZXN0T2ZOZXdCaXRzIHwgcmVzdE9mQmFzZUlkOwogICAgICAgICAgICB2YXIgb3ZlcmZsb3cgPSBuZXdPdmVyZmxvdyArIGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgcmVzdE9mTGVuZ3RoIHwgaWQ7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBvdmVyZmxvdzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXdCaXRzID0gc2xvdCA8PCBiYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgX2lkID0gbmV3Qml0cyB8IGJhc2VJZDsKICAgICAgICAgICAgdmFyIF9vdmVyZmxvdyA9IGJhc2VPdmVyZmxvdzsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IDEgPDwgbGVuZ3RoIHwgX2lkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gX292ZXJmbG93OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gMTsKICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IDA7CiAgICAgICAgICAgIHB1c2hUcmVlRm9yayh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcywgc2xvdEluZGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Qml0TGVuZ3RoKG51bWJlcikgewogICAgICAgICAgcmV0dXJuIDMyIC0gY2x6MzIobnVtYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZGluZ0JpdChpZCkgewogICAgICAgICAgcmV0dXJuIDEgPDwgZ2V0Qml0TGVuZ3RoKGlkKSAtIDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHRQcm92aWRlciAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiB0cmVlQ29udGV4dElkLAogICAgICAgICAgICAgIG92ZXJmbG93OiB0cmVlQ29udGV4dE92ZXJmbG93CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuZGVkQ29udGV4dCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dElkID0gc3VzcGVuZGVkQ29udGV4dC5pZDsKICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBzdXNwZW5kZWRDb250ZXh0Lm92ZXJmbG93OwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmTm90SHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gYmUgaHlkcmF0aW5nLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgIHZhciBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB2YXIgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB2YXIgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuSWZIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGluZykgewogICAgICAgICAgICAgIGVycm9yKCJXZSBzaG91bGQgbm90IGJlIGh5ZHJhdGluZyBoZXJlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhIGJ1Zy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIsIHN1c3BlbnNlSW5zdGFuY2UsIHRyZWVDb250ZXh0KSB7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dChmaWJlciwgdHJlZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnR5cGUsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yREVWKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIF9wcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfcGFyZW50SW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKSBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wczIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3RleHQyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjYW5IeWRyYXRlSW5zdGFuY2UobmV4dEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHRleHRJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIHRyZWVDb250ZXh0OiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICByZXRyeUxhbmU6IE9mZnNjcmVlbkxhbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFN0YXRlID0gc3VzcGVuc2VTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBmaWJlci5jaGlsZCA9IGRlaHlkcmF0ZWRGcmFnbWVudDsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmIChmaWJlci5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSHlkcmF0aW9uIGZhaWxlZCBiZWNhdXNlIHRoZSBpbml0aWFsIFVJIGRvZXMgbm90IG1hdGNoIHdoYXQgd2FzIHJlbmRlcmVkIG9uIHRoZSBzZXJ2ZXIuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgcHJldkh5ZHJhdGlvblBhcmVudEZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlIHx8ICF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciwgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoZmliZXIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRXYXJuSWZNaXNtYXRjaERldiA9ICFkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCBmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBmaWJlciwgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlMgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHBhcmVudC50YWcgIT09IEhvc3RSb290ICYmIHBhcmVudC50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBIb3N0Um9vdCAmJiAoZmliZXIudGFnICE9PSBIb3N0Q29tcG9uZW50IHx8IHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKGZpYmVyLnR5cGUpICYmICFzaG91bGRTZXRUZXh0Q29udGVudChmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcikgewogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoaHlkcmF0aW9uRXJyb3JzKTsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgTm9UcmFuc2l0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMS50cmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICByZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIHJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBmaW5kU3RyaWN0Um9vdCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBtYXliZVN0cmljdFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heWJlU3RyaWN0Um9vdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQyKSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBzZXQyLmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheS5zb3J0KCkuam9pbigiLCAiKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczMgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjIoImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjIoImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczUgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4yKCJjb21wb25lbnRXaWxsVXBkYXRlIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxVcGRhdGUgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBzdHJpY3RSb290ID0gZmluZFN0cmljdFJvb3QoZmliZXIpOwogICAgICAgICAgICBpZiAoc3RyaWN0Um9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgIGlmIChmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsIHx8IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzRm9yUm9vdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5zZXQoc3RyaWN0Um9vdCwgd2FybmluZ3NGb3JSb290KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZm9yRWFjaChmdW5jdGlvbihmaWJlckFycmF5LCBzdHJpY3RSb290KSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaXJzdEZpYmVyID0gZmliZXJBcnJheVswXTsKICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGZpYmVyQXJyYXkuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKHVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpcnN0RmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkxlZ2FjeSBjb250ZXh0IEFQSSBoYXMgYmVlbiBkZXRlY3RlZCB3aXRoaW4gYSBzdHJpY3QtbW9kZSB0cmVlLlxuXG5UaGUgb2xkIEFQSSB3aWxsIGJlIHN1cHBvcnRlZCBpbiBhbGwgMTYueCByZWxlYXNlcywgYnV0IGFwcGxpY2F0aW9ucyB1c2luZyBpdCBzaG91bGQgbWlncmF0ZSB0byB0aGUgbmV3IHZlcnNpb24uXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlc1xuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5kaXNjYXJkUGVuZGluZ1dhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZzsKICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgIHZhciB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZC5fc3RvcmUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdCBDb21wb25lbnQgaW4gd2FybkZvck1pc3NpbmdLZXkgc2hvdWxkIGhhdmUgYSBfc3RvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZWFjdENsYXNzKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLnByb3RvdHlwZSAmJiB0eXBlLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQyLCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgbWl4ZWRSZWYgPSBlbGVtZW50LnJlZjsKICAgICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChyZXR1cm5GaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSB8fCB3YXJuQWJvdXRTdHJpbmdSZWZzKSAmJiAvLyBXZSB3YXJuIGluIFJlYWN0RWxlbWVudC5qcyBpZiBvd25lciBhbmQgc2VsZiBhcmUgZXF1YWwgZm9yIHN0cmluZyByZWZzCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSB0aGVzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24KICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fc2VsZiAmJiBlbGVtZW50Ll9vd25lci5zdGF0ZU5vZGUgIT09IGVsZW1lbnQuX3NlbGYpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzIgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgJiYgLy8gV2lsbCBhbHJlYWR5IHdhcm4gd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcyIKICAgICAgICAgICAgICAhKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIWlzUmVhY3RDbGFzcyhlbGVtZW50LnR5cGUpKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoc29tZVN0cmluZ1JlZikgYnV0IG5vIG93bmVyIHdhcyBzZXQiCiAgICAgICAgICAgICAgZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0OwogICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICAgIGlmIChvd25lckZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdCA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBvd25lciBmb3Igc3RyaW5nIHJlZiAiICsgbWl4ZWRSZWYgKyAiLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRJbnN0ID0gaW5zdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50Mi5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDIucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQyLnJlZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IHJlc29sdmVkSW5zdC5yZWZzOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWZzW3N0cmluZ1JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaXhlZFJlZiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVmIHRvIGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nLCBhbiBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlUmVmKCksIG9yIG51bGwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoIiArIG1peGVkUmVmICsgIikgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBmdW5jdGlvbiBjb21wb25lbnRcbjIuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgY29tcG9uZW50IHRoYXQgd2FzIG5vdCBjcmVhdGVkIGluc2lkZSBhIGNvbXBvbmVudCdzIHJlbmRlciBtZXRob2RcbjMuIFlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBsb2FkZWRcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVmcy1tdXN0LWhhdmUtb3duZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZFN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRTdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9ucyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQuIFRoaXMgbWF5IGhhcHBlbiBpZiB5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5KGxhenlUeXBlKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlUeXBlLl9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5VHlwZS5faW5pdDsKICAgICAgICAgIHJldHVybiBpbml0KHBheWxvYWQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDaGlsZFJlY29uY2lsZXIoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZFRvRGVsZXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NoaWxkLmtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmluZGV4LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZCA9IGV4aXN0aW5nQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUZpYmVyKGZpYmVyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgICAgY2xvbmUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gRm9ya2VkOwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gbmV3RmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50Mi5pbmRleDsKICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPCBsYXN0UGxhY2VkSW5kZXgpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50MiwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50MiwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY3VycmVudDIsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY3VycmVudDIudHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDIsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50MiwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDIsIGVsZW1lbnQpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDIsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLnRhZyAhPT0gSG9zdFBvcnRhbCB8fCBjdXJyZW50Mi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudDIuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQyLCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50MiwgZnJhZ21lbnQsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLnRhZyAhPT0gRnJhZ21lbnQyKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmcmFnbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50MiwgZnJhZ21lbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCgiIiArIG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDIgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkMyA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgICBfY3JlYXRlZDMucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBvbGRGaWJlciAhPT0gbnVsbCA/IG9sZEZpYmVyLmtleSA6IG51bGw7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgb2xkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBvbGRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBtYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBtYXRjaGVkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMiwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIzID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjMsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiIHx8IGNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5KGNoaWxkLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBjaGlsZC5rZXk7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChrbm93bktleXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWtub3duS2V5cy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvcigiRW5jb3VudGVyZWQgdHdvIGNoaWxkcmVuIHdpdGggdGhlIHNhbWUga2V5LCBgJXNgLiBLZXlzIHNob3VsZCBiZSB1bmlxdWUgc28gdGhhdCBjb21wb25lbnRzIG1haW50YWluIHRoZWlyIGlkZW50aXR5IGFjcm9zcyB1cGRhdGVzLiBOb24tdW5pcXVlIGtleXMgbWF5IGNhdXNlIGNoaWxkcmVuIHRvIGJlIGR1cGxpY2F0ZWQgYW5kL29yIG9taXR0ZWQgXHUyMDE0IHRoZSBiZWhhdmlvciBpcyB1bnN1cHBvcnRlZCBhbmQgY291bGQgY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24uIiwga2V5KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBjaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBjaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZEtleShpbml0KHBheWxvYWQpLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBrbm93bktleXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGRyZW4sIGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIga25vd25LZXlzID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXdDaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIG9sZEZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBsYXN0UGxhY2VkSW5kZXggPSAwOwogICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgdmFyIG5leHRPbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3SWR4ID09PSBuZXdDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXIyID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjIua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyMi5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczIgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBvYmplY3QgaXMgbm90IGFuIGl0ZXJhYmxlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAvLyAkRmxvd0ZpeE1lIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IHRvU3RyaW5nVGFnCiAgICAgICAgICAgICAgbmV3Q2hpbGRyZW5JdGVyYWJsZVtTeW1ib2wudG9TdHJpbmdUYWddID09PSAiR2VuZXJhdG9yIikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZW5lcmF0b3JzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVc2luZyBHZW5lcmF0b3JzIGFzIGNoaWxkcmVuIGlzIHVuc3VwcG9ydGVkIGFuZCB3aWxsIGxpa2VseSB5aWVsZCB1bmV4cGVjdGVkIHJlc3VsdHMgYmVjYXVzZSBlbnVtZXJhdGluZyBhIGdlbmVyYXRvciBtdXRhdGVzIGl0LiBZb3UgbWF5IGNvbnZlcnQgaXQgdG8gYW4gYXJyYXkgd2l0aCBgQXJyYXkuZnJvbSgpYCBvciB0aGUgYFsuLi5zcHJlYWRdYCBvcGVyYXRvciBiZWZvcmUgcmVuZGVyaW5nLiBLZWVwIGluIG1pbmQgeW91IG1pZ2h0IG5lZWQgdG8gcG9seWZpbGwgdGhlc2UgZmVhdHVyZXMgZm9yIG9sZGVyIGJyb3dzZXJzLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbkl0ZXJhYmxlLmVudHJpZXMgPT09IGl0ZXJhdG9yRm4pIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgICAgaWYgKF9uZXdDaGlsZHJlbikgewogICAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpOwogICAgICAgICAgICAgICAgZm9yICg7ICFfc3RlcC5kb25lOyBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gX3N0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBpdGVyYWJsZSBvYmplY3QgcHJvdmlkZWQgbm8gaXRlcmF0b3IuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgZm9yICg7IG9sZEZpYmVyICE9PSBudWxsICYmICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RlcC5kb25lKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIzID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIzLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczMgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzMyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjQgPSB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyNCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyNC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXI0LmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyNCwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZDIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzNCA9IG5ld0lkeDsKICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudEZpcnN0Q2hpbGQgIT09IG51bGwgJiYgY3VycmVudEZpcnN0Q2hpbGQudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50Rmlyc3RDaGlsZCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQodGV4dENvbnRlbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gRnJhZ21lbnQyKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzLmNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgICAgIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhjaGlsZCwgZWxlbWVudCkgfHwgLy8gTGF6eSB0eXBlcyBzaG91bGQgcmVjb25jaWxlIHRoZWlyIHJlc29sdmVkIHR5cGUuCiAgICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgICAgIC8vIGl0IGRvZXNuJ3QgcmVzdXNwZW5kLiBTbyB3ZSBjYW4ndCBsZXQgdGhlIGNhbGwgYmVsb3cgc3VzcGVuZC4KICAgICAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY2hpbGQudHlwZSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2V4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGNoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2V4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChlbGVtZW50LnByb3BzLmNoaWxkcmVuLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcywgZWxlbWVudC5rZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkNCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIF9jcmVhdGVkNC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkNDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgcG9ydGFsLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gcG9ydGFsLmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gSG9zdFBvcnRhbCAmJiBjaGlsZC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA9PT0gcG9ydGFsLmNvbnRhaW5lckluZm8gJiYgY2hpbGQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uID09PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50ID0gdHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCAmJiBuZXdDaGlsZC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFICYmIG5ld0NoaWxkLmtleSA9PT0gbnVsbDsKICAgICAgICAgICAgaWYgKGlzVW5rZXllZFRvcExldmVsRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczIocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5KG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuQXJyYXkocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkl0ZXJhdG9yKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsICIiICsgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkRmliZXJzMjsKICAgICAgICB9CiAgICAgICAgdmFyIHJlY29uY2lsZUNoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKHRydWUpOwogICAgICAgIHZhciBtb3VudENoaWxkRmliZXJzID0gQ2hpbGRSZWNvbmNpbGVyKGZhbHNlKTsKICAgICAgICBmdW5jdGlvbiBjbG9uZUNoaWxkRmliZXJzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgIT09IGN1cnJlbnQyLmNoaWxkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVzdW1pbmcgd29yayBub3QgeWV0IGltcGxlbWVudGVkLiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudENoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRDaGlsZC5zaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnRDaGlsZC5zaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnNpYmxpbmcgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIGN1cnJlbnRDaGlsZC5wZW5kaW5nUHJvcHMpOwogICAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9CiAgICAgICAgICBuZXdDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRXb3JrSW5Qcm9ncmVzcyhjaGlsZCwgbGFuZXMpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZUN1cnNvciA9IGNyZWF0ZUN1cnNvcihudWxsKTsKICAgICAgICB2YXIgcmVuZGVyZXJTaWdpbDsKICAgICAgICB7CiAgICAgICAgICByZW5kZXJlclNpZ2lsID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgdmFyIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IG51bGw7CiAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hQcm92aWRlcihwcm92aWRlckZpYmVyLCBjb250ZXh0LCBuZXh0VmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcHVzaCh2YWx1ZUN1cnNvciwgY29udGV4dC5fY3VycmVudFZhbHVlLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gbmV4dFZhbHVlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gdm9pZCAwICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gbnVsbCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHJlbmRlcmVyU2lnaWwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJEZXRlY3RlZCBtdWx0aXBsZSByZW5kZXJlcnMgY29uY3VycmVudGx5IHJlbmRlcmluZyB0aGUgc2FtZSBjb250ZXh0IHByb3ZpZGVyLiBUaGlzIGlzIGN1cnJlbnRseSB1bnN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gcmVuZGVyZXJTaWdpbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BQcm92aWRlcihjb250ZXh0LCBwcm92aWRlckZpYmVyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFZhbHVlID0gdmFsdWVDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHBvcCh2YWx1ZUN1cnNvciwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChwYXJlbnQsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHBhcmVudDsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBub2RlLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhub2RlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhbHRlcm5hdGUgIT09IG51bGwgJiYgIWlzU3Vic2V0T2ZMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobm9kZSAhPT0gcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByb3BhZ2F0aW9uIHJvb3Qgd2hlbiBzY2hlZHVsaW5nIGNvbnRleHQgd29yay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgZmliZXIucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXh0RmliZXIgPSB2b2lkIDA7CiAgICAgICAgICAgIHZhciBsaXN0ID0gZmliZXIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICBpZiAobGlzdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIHZhciBkZXBlbmRlbmN5ID0gbGlzdC5maXJzdENvbnRleHQ7CiAgICAgICAgICAgICAgd2hpbGUgKGRlcGVuZGVuY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChkZXBlbmRlbmN5LmNvbnRleHQgPT09IGNvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgc2hhcmVkUXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKGZpYmVyLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgbGlzdC5sYW5lcyA9IG1lcmdlTGFuZXMobGlzdC5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXBlbmRlbmN5ID0gZGVwZW5kZW5jeS5uZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnR5cGUgPT09IHdvcmtJblByb2dyZXNzMi50eXBlID8gbnVsbCA6IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9IGVsc2UgaWYgKGZpYmVyLnRhZyA9PT0gRGVoeWRyYXRlZEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudFN1c3BlbnNlID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBqdXN0IGNhbWUgZnJvbSBhIHBhcmVudCBzbyB3ZSBtdXN0IGhhdmUgaGFkIGEgcGFyZW50LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZS5sYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50U3VzcGVuc2UubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9hbHRlcm5hdGUgPSBwYXJlbnRTdXNwZW5zZS5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKF9hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9hbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKF9hbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50U3VzcGVuc2UsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgd2hpbGUgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5leHRGaWJlciA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBuZXh0RmliZXIuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gc2libGluZzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IG5leHRGaWJlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB2YXIgZGVwZW5kZW5jaWVzID0gd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llczsKICAgICAgICAgIGlmIChkZXBlbmRlbmNpZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBmaXJzdENvbnRleHQgPSBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIGlmIChmaXJzdENvbnRleHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKGRlcGVuZGVuY2llcy5sYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYWRDb250ZXh0KGNvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYpIHsKICAgICAgICAgICAgICBlcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgIGlmIChsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPT09IGNvbnRleHQpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY29udGV4dEl0ZW0gPSB7CiAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICBtZW1vaXplZFZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChsYXN0Q29udGV4dERlcGVuZGVuY3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29udGV4dCBjYW4gb25seSBiZSByZWFkIHdoaWxlIFJlYWN0IGlzIHJlbmRlcmluZy4gSW4gY2xhc3NlcywgeW91IGNhbiByZWFkIGl0IGluIHRoZSByZW5kZXIgbWV0aG9kIG9yIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gSW4gZnVuY3Rpb24gY29tcG9uZW50cywgeW91IGNhbiByZWFkIGl0IGRpcmVjdGx5IGluIHRoZSBmdW5jdGlvbiBib2R5LCBidXQgbm90IGluc2lkZSBIb29rcyBsaWtlIHVzZVJlZHVjZXIoKSBvciB1c2VNZW1vKCkuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGNvbnRleHRJdGVtOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyLmRlcGVuZGVuY2llcyA9IHsKICAgICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjb250ZXh0SXRlbQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbGFzdENvbnRleHREZXBlbmRlbmN5Lm5leHQgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgY29uY3VycmVudFF1ZXVlcyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcyA9IFtxdWV1ZV07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzLnB1c2gocXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKGNvbmN1cnJlbnRRdWV1ZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25jdXJyZW50UXVldWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gY29uY3VycmVudFF1ZXVlc1tpXTsKICAgICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkVXBkYXRlID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIGZpcnN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIHZhciBsYXN0UGVuZGluZ1VwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAobGFzdFBlbmRpbmdVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0UGVuZGluZ1VwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICAgIGxhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBmaXJzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBsYXN0SW50ZXJsZWF2ZWRVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlQW5kRWFnZXJseUJhaWxvdXQoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSkgewogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVuc2FmZV9tYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdCA9IG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290OwogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KHNvdXJjZUZpYmVyLCBsYW5lKSB7CiAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoc291cmNlRmliZXIubGFuZXMsIGxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlID09PSBudWxsICYmIChzb3VyY2VGaWJlci5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IHNvdXJjZUZpYmVyOwogICAgICAgICAgdmFyIHBhcmVudCA9IHNvdXJjZUZpYmVyLnJldHVybjsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcGFyZW50LmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudC5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgYWx0ZXJuYXRlID0gcGFyZW50LmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKChwYXJlbnQuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHZhciByb290MyA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFVwZGF0ZVN0YXRlID0gMDsKICAgICAgICB2YXIgUmVwbGFjZVN0YXRlID0gMTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGUgPSAyOwogICAgICAgIHZhciBDYXB0dXJlVXBkYXRlID0gMzsKICAgICAgICB2YXIgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZTsKICAgICAgICB2YXIgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemVVcGRhdGVRdWV1ZShmaWJlcikgewogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBiYXNlU3RhdGU6IGZpYmVyLm1lbW9pemVkU3RhdGUsCiAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIHNoYXJlZDogewogICAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWZmZWN0czogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5maXJzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY2xvbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSB7CiAgICAgICAgICAgIGV2ZW50VGltZSwKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgdGFnOiBVcGRhdGVTdGF0ZSwKICAgICAgICAgICAgcGF5bG9hZDogbnVsbCwKICAgICAgICAgICAgY2FsbGJhY2s6IG51bGwsCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID09PSBzaGFyZWRRdWV1ZSAmJiAhZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSkgewogICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgKHNldFN0YXRlLCByZXBsYWNlU3RhdGUsIG9yIGZvcmNlVXBkYXRlKSB3YXMgc2NoZWR1bGVkIGZyb20gaW5zaWRlIGFuIHVwZGF0ZSBmdW5jdGlvbi4gVXBkYXRlIGZ1bmN0aW9ucyBzaG91bGQgYmUgcHVyZSwgd2l0aCB6ZXJvIHNpZGUtZWZmZWN0cy4gQ29uc2lkZXIgdXNpbmcgY29tcG9uZW50RGlkVXBkYXRlIG9yIGEgY2FsbGJhY2suIik7CiAgICAgICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoKSkgewogICAgICAgICAgICB2YXIgcGVuZGluZyA9IHNoYXJlZFF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgIHJldHVybiB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHNoYXJlZFF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNoYXJlZFF1ZXVlID0gdXBkYXRlUXVldWUuc2hhcmVkOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBzaGFyZWRRdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgc2hhcmVkUXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGNhcHR1cmVkVXBkYXRlKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50Mi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgaWYgKHF1ZXVlID09PSBjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICB2YXIgbmV3Rmlyc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdMYXN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZmlyc3RCYXNlVXBkYXRlID0gcXVldWUuZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgIGlmIChmaXJzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZS5ldmVudFRpbWUsCiAgICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlLmxhbmUsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgICAgIG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3QubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZSA9IHsKICAgICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudFF1ZXVlLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogbmV3Rmlyc3QsCiAgICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbmV3TGFzdCwKICAgICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUubmV4dCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3RhdGVGcm9tVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgcXVldWUsIHVwZGF0ZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMsIGluc3RhbmNlKSB7CiAgICAgICAgICBzd2l0Y2ggKHVwZGF0ZS50YWcpIHsKICAgICAgICAgICAgY2FzZSBSZXBsYWNlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dFN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGF5bG9hZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENhcHR1cmVVcGRhdGU6IHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBVcGRhdGVTdGF0ZTogewogICAgICAgICAgICAgIHZhciBfcGF5bG9hZCA9IHVwZGF0ZS5wYXlsb2FkOwogICAgICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfcGF5bG9hZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBlbnRlckRpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwYXJ0aWFsU3RhdGUgPSBfcGF5bG9hZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGFzc2lnbih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRm9yY2VVcGRhdGU6IHsKICAgICAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgcHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHZhciBjdXJyZW50TGFzdEJhc2VVcGRhdGUgPSBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSAhPT0gbGFzdEJhc2VVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IHF1ZXVlLmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdGaXJzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3TGFzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlRXZlbnRUaW1lID0gdXBkYXRlLmV2ZW50VGltZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lczIsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBuZXdTdGF0ZSwgcHJvcHMsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHVwZGF0ZS5jYWxsYmFjazsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiAvLyBJZiB0aGUgdXBkYXRlIHdhcyBhbHJlYWR5IGNvbW1pdHRlZCwgd2Ugc2hvdWxkIG5vdCBxdWV1ZSBpdHMKICAgICAgICAgICAgICAgIC8vIGNhbGxiYWNrIGFnYWluLgogICAgICAgICAgICAgICAgdXBkYXRlLmxhbmUgIT09IE5vTGFuZSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3RzID0gcXVldWUuZWZmZWN0czsKICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZS5lZmZlY3RzID0gW3VwZGF0ZV07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cy5wdXNoKHVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIF9sYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgICAgICAgdmFyIF9maXJzdFBlbmRpbmdVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBudWxsOwogICAgICAgICAgICAgICAgICB1cGRhdGUgPSBfZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gbmV3Rmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuc2hhcmVkLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5ld0xhbmVzID0gbWVyZ2VMYW5lcyhuZXdMYW5lcywgaW50ZXJsZWF2ZWQubGFuZSk7CiAgICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKG5ld0xhbmVzKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbmV3TGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYXJndW1lbnQgcGFzc2VkIGFzIGNhbGxiYWNrLiBFeHBlY3RlZCBhIGZ1bmN0aW9uLiBJbnN0ZWFkICIgKyAoInJlY2VpdmVkOiAiICsgY2FsbGJhY2spKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrLmNhbGwoY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCkgewogICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHsKICAgICAgICAgIHJldHVybiBoYXNGb3JjZVVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFF1ZXVlLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIGVmZmVjdHMgPSBmaW5pc2hlZFF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICBmaW5pc2hlZFF1ZXVlLmVmZmVjdHMgPSBudWxsOwogICAgICAgICAgaWYgKGVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGVmZmVjdHNbaV07CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZWZmZWN0LmNhbGxiYWNrOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZWZmZWN0LmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTk9fQ09OVEVYVCA9IHt9OwogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IkMSA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgY29udGV4dEZpYmVyU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVkQ29udGV4dChjKSB7CiAgICAgICAgICBpZiAoYyA9PT0gTk9fQ09OVEVYVCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRhaW5lcigpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gcm9vdEluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRhaW5lcihmaWJlciwgbmV4dFJvb3RJbnN0YW5jZSkgewogICAgICAgICAgcHVzaChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIE5PX0NPTlRFWFQsIGZpYmVyKTsKICAgICAgICAgIHZhciBuZXh0Um9vdENvbnRleHQgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIG5leHRSb290Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGFpbmVyKGZpYmVyKSB7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgcG9wKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RDb250ZXh0KCkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBnZXRDaGlsZEhvc3RDb250ZXh0KGNvbnRleHQsIGZpYmVyLnR5cGUpOwogICAgICAgICAgaWYgKGNvbnRleHQgPT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgaWYgKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBEZWZhdWx0U3VzcGVuc2VDb250ZXh0ID0gMDsKICAgICAgICB2YXIgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgPSAxOwogICAgICAgIHZhciBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQgPSAxOwogICAgICAgIHZhciBGb3JjZVN1c3BlbnNlRmFsbGJhY2sgPSAyOwogICAgICAgIHZhciBzdXNwZW5zZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKERlZmF1bHRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgIGZ1bmN0aW9uIGhhc1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBmbGFnKSB7CiAgICAgICAgICByZXR1cm4gKHBhcmVudENvbnRleHQgJiBmbGFnKSAhPT0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzaGFsbG93Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayB8IHNoYWxsb3dDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIHN1YnRyZWVDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCB8IHN1YnRyZWVDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3VzcGVuc2VDb250ZXh0KGZpYmVyLCBuZXdDb250ZXh0KSB7CiAgICAgICAgICBwdXNoKHN1c3BlbnNlU3RhY2tDdXJzb3IsIG5ld0NvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wU3VzcGVuc2VDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICBwb3Aoc3VzcGVuc2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDYXB0dXJlU3VzcGVuc2Uod29ya0luUHJvZ3Jlc3MyLCBoYXNJbnZpc2libGVQYXJlbnQpIHsKICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXh0U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kRmlyc3RTdXNwZW5kZWQocm93KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJvdzsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoZGVoeWRyYXRlZCA9PT0gbnVsbCB8fCBpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKGRlaHlkcmF0ZWQpIHx8IGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGRlaHlkcmF0ZWQpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50ICYmIC8vIHJldmVhbE9yZGVyIHVuZGVmaW5lZCBjYW4ndCBiZSB0cnVzdGVkIGJlY2F1c2UgaXQgZG9uJ3QKICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB3aGV0aGVyIGl0IHN1c3BlbmRlZCBvciBub3QuCiAgICAgICAgICAgIG5vZGUubWVtb2l6ZWRQcm9wcy5yZXZlYWxPcmRlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmQgPSAobm9kZS5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcm93KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gcm93KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEhhc0VmZmVjdCA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5zZXJ0aW9uID0gKAogICAgICAgICAgLyogICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgTGF5b3V0ID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlJDEgPSAoCiAgICAgICAgICAvKiAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NTb3VyY2VzID0gW107CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzc1ZlcnNpb25zKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzc1NvdXJjZXNbaV07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtdXRhYmxlU291cmNlLl93b3JrSW5Qcm9ncmVzc1ZlcnNpb25QcmltYXJ5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTXV0YWJsZVNvdXJjZUZvckh5ZHJhdGlvbihyb290MywgbXV0YWJsZVNvdXJjZSkgewogICAgICAgICAgdmFyIGdldFZlcnNpb24gPSBtdXRhYmxlU291cmNlLl9nZXRWZXJzaW9uOwogICAgICAgICAgdmFyIHZlcnNpb24yID0gZ2V0VmVyc2lvbihtdXRhYmxlU291cmNlLl9zb3VyY2UpOwogICAgICAgICAgaWYgKHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb24yXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEucHVzaChtdXRhYmxlU291cmNlLCB2ZXJzaW9uMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3Q7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBnbG9iYWxDbGllbnRJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBSRV9SRU5ERVJfTElNSVQgPSAyNTsKICAgICAgICB2YXIgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgIHZhciBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50SG9va1R5cGVzRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9va05hbWUgPSBjdXJyZW50SG9va05hbWVJbkRldjsKICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IFtob29rTmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzRGV2LnB1c2goaG9va05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldisrOwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXZbaG9va1R5cGVzVXBkYXRlSW5kZXhEZXZdICE9PSBob29rTmFtZSkgewogICAgICAgICAgICAgICAgd2Fybk9uSG9va01pc21hdGNoSW5EZXYoaG9va05hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkZXBzICE9PSB2b2lkIDAgJiYgZGVwcyAhPT0gbnVsbCAmJiAhaXNBcnJheShkZXBzKSkgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IHRoYXQgaXMgbm90IGFuIGFycmF5IChpbnN0ZWFkLCByZWNlaXZlZCBgJXNgKS4gV2hlbiBzcGVjaWZpZWQsIHRoZSBmaW5hbCBhcmd1bWVudCBtdXN0IGJlIGFuIGFycmF5LiIsIGN1cnJlbnRIb29rTmFtZUluRGV2LCB0eXBlb2YgZGVwcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uSG9va01pc21hdGNoSW5EZXYoY3VycmVudEhvb2tOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxKTsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFibGUgPSAiIjsKICAgICAgICAgICAgICAgIHZhciBzZWNvbmRDb2x1bW5TdGFydCA9IDMwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gaG9va1R5cGVzVXBkYXRlSW5kZXhEZXY7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgb2xkSG9va05hbWUgPSBob29rVHlwZXNEZXZbaV07CiAgICAgICAgICAgICAgICAgIHZhciBuZXdIb29rTmFtZSA9IGkgPT09IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID8gY3VycmVudEhvb2tOYW1lIDogb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHZhciByb3cgPSBpICsgMSArICIuICIgKyBvbGRIb29rTmFtZTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdy5sZW5ndGggPCBzZWNvbmRDb2x1bW5TdGFydCkgewogICAgICAgICAgICAgICAgICAgIHJvdyArPSAiICI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm93ICs9IG5ld0hvb2tOYW1lICsgIlxuIjsKICAgICAgICAgICAgICAgICAgdGFibGUgKz0gcm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGhhcyBkZXRlY3RlZCBhIGNoYW5nZSBpbiB0aGUgb3JkZXIgb2YgSG9va3MgY2FsbGVkIGJ5ICVzLiBUaGlzIHdpbGwgbGVhZCB0byBidWdzIGFuZCBlcnJvcnMgaWYgbm90IGZpeGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgcmVhZCB0aGUgUnVsZXMgb2YgSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ydWxlcy1vZi1ob29rc1xuXG4gICBQcmV2aW91cyByZW5kZXIgICAgICAgICAgICBOZXh0IHJlbmRlclxuICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4lcyAgIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXlxuIiwgY29tcG9uZW50TmFtZSwgdGFibGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd0ludmFsaWRIb29rRXJyb3IoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJldkRlcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IGR1cmluZyB0aGlzIHJlbmRlciwgYnV0IG5vdCBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4gRXZlbiB0aG91Z2ggdGhlIGZpbmFsIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBpdHMgdHlwZSBjYW5ub3QgY2hhbmdlIGJldHdlZW4gcmVuZGVycy4iLCBjdXJyZW50SG9va05hbWVJbkRldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmV4dERlcHMubGVuZ3RoICE9PSBwcmV2RGVwcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGZpbmFsIGFyZ3VtZW50IHBhc3NlZCB0byAlcyBjaGFuZ2VkIHNpemUgYmV0d2VlbiByZW5kZXJzLiBUaGUgb3JkZXIgYW5kIHNpemUgb2YgdGhpcyBhcnJheSBtdXN0IHJlbWFpbiBjb25zdGFudC5cblxuUHJldmlvdXM6ICVzXG5JbmNvbWluZzogJXMiLCBjdXJyZW50SG9va05hbWVJbkRldiwgIlsiICsgcHJldkRlcHMuam9pbigiLCAiKSArICJdIiwgIlsiICsgbmV4dERlcHMuam9pbigiLCAiKSArICJdIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJldkRlcHMubGVuZ3RoICYmIGkgPCBuZXh0RGVwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAob2JqZWN0SXMobmV4dERlcHNbaV0sIHByZXZEZXBzW2ldKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgc2Vjb25kQXJnLCBuZXh0UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHJlbmRlckxhbmVzID0gbmV4dFJlbmRlckxhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5fZGVidWdIb29rVHlwZXMgOiBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGN1cnJlbnQyICE9PSBudWxsICYmIGN1cnJlbnQyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuID0gQ29tcG9uZW50KHByb3BzLCBzZWNvbmRBcmcpOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcykgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZSZVJlbmRlcnMgPSAwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgICAgIGlmIChudW1iZXJPZlJlUmVuZGVycyA+PSBSRV9SRU5ERVJfTElNSVQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG9vIG1hbnkgcmUtcmVuZGVycy4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgcmVuZGVycyB0byBwcmV2ZW50IGFuIGluZmluaXRlIGxvb3AuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bWJlck9mUmVSZW5kZXJzICs9IDE7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgICAgfSB3aGlsZSAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzKTsKICAgICAgICAgIH0KICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gaG9va1R5cGVzRGV2OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFJlbmRlclRvb0Zld0hvb2tzID0gY3VycmVudEhvb2sgIT09IG51bGwgJiYgY3VycmVudEhvb2submV4dCAhPT0gbnVsbDsKICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgKGN1cnJlbnQyLmZsYWdzICYgU3RhdGljTWFzaykgIT09ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTdGF0aWNNYXNrKSAmJiAvLyBEaXNhYmxlIHRoaXMgd2FybmluZyBpbiBsZWdhY3kgbW9kZSwgYmVjYXVzZSBsZWdhY3kgU3VzcGVuc2UgaXMgd2VpcmQKICAgICAgICAgICAgLy8gYW5kIGNyZWF0ZXMgZmFsc2UgcG9zaXRpdmVzLiBUbyBtYWtlIHRoaXMgd29yayBpbiBsZWdhY3kgbW9kZSwgd2UnZAogICAgICAgICAgICAvLyBuZWVkIHRvIG1hcmsgZmliZXJzIHRoYXQgY29tbWl0IGluIGFuIGluY29tcGxldGUgc3RhdGUsIHNvbWVob3cuIEZvcgogICAgICAgICAgICAvLyBub3cgSSdsbCBkaXNhYmxlIHRoZSB3YXJuaW5nIHRoYXQgbW9zdCBvZiB0aGUgYnVncyB0aGF0IHdvdWxkIHRyaWdnZXIKICAgICAgICAgICAgLy8gaXQgYXJlIGVpdGhlciBleGNsdXNpdmUgdG8gY29uY3VycmVudCBtb2RlIG9yIGV4aXN0IGluIGJvdGguCiAgICAgICAgICAgIChjdXJyZW50Mi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgUmVhY3QgZXJyb3I6IEV4cGVjdGVkIHN0YXRpYyBmbGFnIHdhcyBtaXNzaW5nLiBQbGVhc2Ugbm90aWZ5IHRoZSBSZWFjdCB0ZWFtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBpZiAoZGlkUmVuZGVyVG9vRmV3SG9va3MpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZW5kZXJlZCBmZXdlciBob29rcyB0aGFuIGV4cGVjdGVkLiBUaGlzIG1heSBiZSBjYXVzZWQgYnkgYW4gYWNjaWRlbnRhbCBlYXJseSByZXR1cm4gc3RhdGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RpZFJlbmRlcklkSG9vaygpIHsKICAgICAgICAgIHZhciBkaWRSZW5kZXJJZEhvb2sgPSBsb2NhbElkQ291bnRlciAhPT0gMDsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgIHJldHVybiBkaWRSZW5kZXJJZEhvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhaWxvdXRIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH4oTW91bnRQYXNzaXZlRGV2IHwgTW91bnRMYXlvdXREZXYgfCBQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudDIubGFuZXMgPSByZW1vdmVMYW5lcyhjdXJyZW50Mi5sYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhvb2tzQWZ0ZXJUaHJvdygpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBob29rID0gaG9vay5uZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHsKICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVN0YXRlOiBudWxsLAogICAgICAgICAgICBiYXNlUXVldWU6IG51bGwsCiAgICAgICAgICAgIHF1ZXVlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBob29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQgPSBob29rOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBjdXJyZW50SG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV4dFdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG5leHRDdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgbW9yZSBob29rcyB0aGFuIGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgICB2YXIgbmV3SG9vayA9IHsKICAgICAgICAgICAgICBtZW1vaXplZFN0YXRlOiBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudEhvb2suYmFzZVN0YXRlLAogICAgICAgICAgICAgIGJhc2VRdWV1ZTogY3VycmVudEhvb2suYmFzZVF1ZXVlLAogICAgICAgICAgICAgIHF1ZXVlOiBjdXJyZW50SG9vay5xdWV1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXdIb29rOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gbmV3SG9vazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGxhc3RFZmZlY3Q6IG51bGwsCiAgICAgICAgICAgIHN0b3JlczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFzaWNTdGF0ZVJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIgPyBhY3Rpb24oc3RhdGUpIDogYWN0aW9uOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIGluaXRpYWxTdGF0ZTsKICAgICAgICAgIGlmIChpbml0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlID0gaW5pdChpbml0aWFsQXJnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXRpYWxBcmc7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBob29rLmJhc2VTdGF0ZSA9IGluaXRpYWxTdGF0ZTsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICBkaXNwYXRjaDogbnVsbCwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkUmVkdWNlcjogcmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZQogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hSZWR1Y2VyQWN0aW9uLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gY3VycmVudEhvb2s7CiAgICAgICAgICB2YXIgYmFzZVF1ZXVlID0gY3VycmVudDIuYmFzZVF1ZXVlOwogICAgICAgICAgdmFyIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgYmFzZUZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmdGaXJzdCA9IHBlbmRpbmdRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIGJhc2VRdWV1ZS5uZXh0ID0gcGVuZGluZ0ZpcnN0OwogICAgICAgICAgICAgIHBlbmRpbmdRdWV1ZS5uZXh0ID0gYmFzZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIuYmFzZVF1ZXVlICE9PSBiYXNlUXVldWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBlcnJvcjogRXhwZWN0ZWQgd29yay1pbi1wcm9ncmVzcyBxdWV1ZSB0byBiZSBhIGNsb25lLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50Mi5iYXNlUXVldWUgPSBiYXNlUXVldWUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJhc2VRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3QgPSBiYXNlUXVldWUubmV4dDsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY3VycmVudDIuYmFzZVN0YXRlOwogICAgICAgICAgICB2YXIgbmV3QmFzZVN0YXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VRdWV1ZUxhc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHJlbmRlckxhbmVzLCB1cGRhdGVMYW5lKSkgewogICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUZpcnN0ID0gbmV3QmFzZVF1ZXVlTGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBlYWdlclN0YXRlOiB1cGRhdGUuZWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QgPSBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBfY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlLmhhc0VhZ2VyU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSB1cGRhdGUuZWFnZXJTdGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHJlZHVjZXIobmV3U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwgJiYgdXBkYXRlICE9PSBmaXJzdCk7CiAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gbmV3QmFzZVF1ZXVlRmlyc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3QmFzZVN0YXRlOwogICAgICAgICAgICBob29rLmJhc2VRdWV1ZSA9IG5ld0Jhc2VRdWV1ZUxhc3Q7CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IGxhc3RJbnRlcmxlYXZlZDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBpbnRlcmxlYXZlZExhbmUgPSBpbnRlcmxlYXZlZC5sYW5lOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGludGVybGVhdmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIGludGVybGVhdmVkID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaDsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgcXVldWUuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXIgPSByZWR1Y2VyOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICB2YXIgbGFzdFJlbmRlclBoYXNlVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChsYXN0UmVuZGVyUGhhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgIHZhciBmaXJzdFJlbmRlclBoYXNlVXBkYXRlID0gbGFzdFJlbmRlclBoYXNlVXBkYXRlLm5leHQ7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUpOwogICAgICAgICAgICBpZiAoIW9iamVjdElzKG5ld1N0YXRlLCBob29rLm1lbW9pemVkU3RhdGUpKSB7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFtuZXdTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudE11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU11dGFibGVTb3VyY2Uoc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90OwogICAgICAgICAgdmFyIGlzSHlkcmF0aW5nMiA9IGdldElzSHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcyKSB7CiAgICAgICAgICAgIGlmIChnZXRTZXJ2ZXJTbmFwc2hvdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNaXNzaW5nIGdldFNlcnZlclNuYXBzaG90LCB3aGljaCBpcyByZXF1aXJlZCBmb3Igc2VydmVyLXJlbmRlcmVkIGNvbnRlbnQuIFdpbGwgcmV2ZXJ0IHRvIGNsaWVudCByZW5kZXJpbmcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gZ2V0U2VydmVyU25hcHNob3QoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0U25hcHNob3QgIT09IGdldFNlcnZlclNuYXBzaG90KCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U2VydmVyU25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBhIHdvcmstaW4tcHJvZ3Jlc3Mgcm9vdC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpbnN0ID0gewogICAgICAgICAgICB2YWx1ZTogbmV4dFNuYXBzaG90LAogICAgICAgICAgICBnZXRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBpbnN0OwogICAgICAgICAgbW91bnRFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgIHZhciBjYWNoZWRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXh0U25hcHNob3QsIGNhY2hlZFNuYXBzaG90KSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldlNuYXBzaG90ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHNuYXBzaG90Q2hhbmdlZCA9ICFvYmplY3RJcyhwcmV2U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICBpZiAoc25hcHNob3RDaGFuZ2VkKSB7CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gaG9vay5xdWV1ZTsKICAgICAgICAgIHVwZGF0ZUVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgIGlmIChpbnN0LmdldFNuYXBzaG90ICE9PSBnZXRTbmFwc2hvdCB8fCBzbmFwc2hvdENoYW5nZWQgfHwgLy8gQ2hlY2sgaWYgdGhlIHN1c2JjcmliZSBmdW5jdGlvbiBjaGFuZ2VkLiBXZSBjYW4gc2F2ZSBzb21lIG1lbW9yeSBieQogICAgICAgICAgLy8gY2hlY2tpbmcgd2hldGhlciB3ZSBzY2hlZHVsZWQgYSBzdWJzY3JpcHRpb24gZWZmZWN0IGFib3ZlLgogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzSG9vay5tZW1vaXplZFN0YXRlLnRhZyAmIEhhc0VmZmVjdCkgewogICAgICAgICAgICBmaWJlci5mbGFncyB8PSBQYXNzaXZlOwogICAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dFNuYXBzaG90OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgcmVuZGVyZWRTbmFwc2hvdCkgewogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICAgIHZhciBjaGVjayA9IHsKICAgICAgICAgICAgZ2V0U25hcHNob3QsCiAgICAgICAgICAgIHZhbHVlOiByZW5kZXJlZFNuYXBzaG90CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChjb21wb25lbnRVcGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKTsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS51cGRhdGVRdWV1ZSA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHN0b3JlcyA9IGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlczsKICAgICAgICAgICAgaWYgKHN0b3JlcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RvcmVzLnB1c2goY2hlY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0b3JlSW5zdGFuY2UoZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpIHsKICAgICAgICAgIGluc3QudmFsdWUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICBpbnN0LmdldFNuYXBzaG90ID0gZ2V0U25hcHNob3Q7CiAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdWJzY3JpYmVUb1N0b3JlKGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHZhciBoYW5kbGVTdG9yZUNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSkgewogICAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlKGhhbmRsZVN0b3JlQ2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgICB2YXIgbGF0ZXN0R2V0U25hcHNob3QgPSBpbnN0LmdldFNuYXBzaG90OwogICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGluc3QudmFsdWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbGF0ZXN0R2V0U25hcHNob3QoKTsKICAgICAgICAgICAgcmV0dXJuICFvYmplY3RJcyhwcmV2VmFsdWUsIG5leHRWYWx1ZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcikgewogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5pdGlhbFN0YXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGluaXRpYWxTdGF0ZSgpOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGU7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IGJhc2ljU3RhdGVSZWR1Y2VyLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRTdGF0ZTogaW5pdGlhbFN0YXRlCiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFNldFN0YXRlLmJpbmQobnVsbCwgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSwgcXVldWUpOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEVmZmVjdCh0YWcsIGNyZWF0ZSwgZGVzdHJveSwgZGVwcykgewogICAgICAgICAgdmFyIGVmZmVjdCA9IHsKICAgICAgICAgICAgdGFnLAogICAgICAgICAgICBjcmVhdGUsCiAgICAgICAgICAgIGRlc3Ryb3ksCiAgICAgICAgICAgIGRlcHMsCiAgICAgICAgICAgIC8vIENpcmN1bGFyCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgIGxhc3RFZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgICBlZmZlY3QubmV4dCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlZmZlY3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50UmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX3JlZjIgPSB7CiAgICAgICAgICAgICAgY3VycmVudDogaW5pdGlhbFZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IF9yZWYyOwogICAgICAgICAgICByZXR1cm4gX3JlZjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICByZXR1cm4gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgdm9pZCAwLCBuZXh0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBkZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2RWZmZWN0ID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgZGVzdHJveSA9IHByZXZFZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldkVmZmVjdC5kZXBzOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChNb3VudFBhc3NpdmVEZXYgfCBQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChQYXNzaXZlLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0KGNyZWF0ZSwgcmVmKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgcmVmQ2FsbGJhY2sgPSByZWY7CiAgICAgICAgICAgIHZhciBfaW5zdCA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZDYWxsYmFjayhfaW5zdCk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVmICE9PSBudWxsICYmIHJlZiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciByZWZPYmplY3QgPSByZWY7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXJlZk9iamVjdC5oYXNPd25Qcm9wZXJ0eSgiY3VycmVudCIpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIGZpcnN0IGFyZ3VtZW50IHRvIGVpdGhlciBiZSBhIHJlZiBjYWxsYmFjayBvciBSZWFjdC5jcmVhdGVSZWYoKSBvYmplY3QuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsICJhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMocmVmT2JqZWN0KS5qb2luKCIsICIpICsgIn0iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0MiA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IF9pbnN0MjsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJlZk9iamVjdC5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3JlYXRlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBzZWNvbmQgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBoYW5kbGUuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNyZWF0ZSAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUgOiAibnVsbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0LmJpbmQobnVsbCwgY3JlYXRlLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICB9CiAgICAgICAgdmFyIHVwZGF0ZURlYnVnVmFsdWUgPSBtb3VudERlYnVnVmFsdWU7CiAgICAgICAgZnVuY3Rpb24gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtuZXh0VmFsdWUsIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBuZXh0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW8obmV4dENyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldlN0YXRlWzFdOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHJlc29sdmVkQ3VycmVudEhvb2sgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSByZXNvbHZlZEN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIHNob3VsZERlZmVyVmFsdWUgPSAhaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMocmVuZGVyTGFuZXMpOwogICAgICAgICAgaWYgKHNob3VsZERlZmVyVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyh2YWx1ZSwgcHJldlZhbHVlKSkgewogICAgICAgICAgICAgIHZhciBkZWZlcnJlZExhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGRlZmVycmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJldlZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVN0YXRlKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzZXRQZW5kaW5nLCBjYWxsYmFjaywgb3B0aW9uczIpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoaGlnaGVyRXZlbnRQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5LCBDb250aW51b3VzRXZlbnRQcmlvcml0eSkpOwogICAgICAgICAgc2V0UGVuZGluZyh0cnVlKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0UGVuZGluZyhmYWxzZSk7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMigiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX21vdW50U3RhdGUgPSBtb3VudFN0YXRlKGZhbHNlKSwgaXNQZW5kaW5nID0gX21vdW50U3RhdGVbMF0sIHNldFBlbmRpbmcgPSBfbW91bnRTdGF0ZVsxXTsKICAgICAgICAgIHZhciBzdGFydCA9IHN0YXJ0VHJhbnNpdGlvbi5iaW5kKG51bGwsIHNldFBlbmRpbmcpOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gc3RhcnQ7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3JlcmVuZGVyU3RhdGUgPSByZXJlbmRlclN0YXRlKCksIGlzUGVuZGluZyA9IF9yZXJlbmRlclN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIHZhciBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSByb290My5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdmFyIGlkOwogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgIHZhciBsb2NhbElkID0gbG9jYWxJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWYgKGxvY2FsSWQgPiAwKSB7CiAgICAgICAgICAgICAgaWQgKz0gIkgiICsgbG9jYWxJZC50b1N0cmluZygzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgKz0gIjoiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGdsb2JhbENsaWVudElkID0gZ2xvYmFsQ2xpZW50SWRDb3VudGVyKys7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJyIiArIGdsb2JhbENsaWVudElkLnRvU3RyaW5nKDMyKSArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGlkOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaWQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoUmVkdWNlckFjdGlvbihmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hTZXRTdGF0ZShmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoZmliZXIubGFuZXMgPT09IE5vTGFuZXMgJiYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCBhbHRlcm5hdGUubGFuZXMgPT09IE5vTGFuZXMpKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RSZW5kZXJlZFJlZHVjZXIgPSBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyOwogICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcXVldWUubGFzdFJlbmRlcmVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBlYWdlclN0YXRlID0gbGFzdFJlbmRlcmVkUmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmVhZ2VyU3RhdGUgPSBlYWdlclN0YXRlOwogICAgICAgICAgICAgICAgICBpZiAob2JqZWN0SXMoZWFnZXJTdGF0ZSwgY3VycmVudFN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICByZXR1cm4gZmliZXIgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgdmFyIHBlbmRpbmcgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSkgewogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBxdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENvbnRleHRPbmx5RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIHJlYWRDb250ZXh0LAogICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUNvbnRleHQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZHVjZXI6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlYnVnVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgfTsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybkludmFsaWRDb250ZXh0QWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkludmFsaWRIb29rQWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudE11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbm93JDEgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBjb21taXRUaW1lID0gMDsKICAgICAgICB2YXIgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlSXNOZXN0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzeW5jTmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gbmVzdGVkVXBkYXRlU2NoZWR1bGVkOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tbWl0VGltZSgpIHsKICAgICAgICAgIHJldHVybiBjb21taXRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRDb21taXRUaW1lKCkgewogICAgICAgICAgY29tbWl0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UHJvZmlsZXJUaW1lcihmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgaWYgKGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA8IDApIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZmliZXIsIG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgIGlmIChwcm9maWxlclN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwcm9maWxlclN0YXJ0VGltZTsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgICAgZmliZXIuc2VsZkJhc2VEdXJhdGlvbiA9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAobGF5b3V0RWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIGxheW91dEVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHBhc3NpdmVFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydExheW91dEVmZmVjdFRpbWVyKCkgewogICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXJBY3R1YWxEdXJhdGlvbihmaWJlcikgewogICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIGJhc2VQcm9wcykgewogICAgICAgICAgaWYgKENvbXBvbmVudCAmJiBDb21wb25lbnQuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbih7fSwgYmFzZVByb3BzKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2VQcm9wczsKICAgICAgICB9CiAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suaGFzKGtleSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suYWRkKGtleSk7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZSwgcGFydGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9wcm9jZXNzQ2hpbGRDb250ZXh0IGlzIG5vdCBhdmFpbGFibGUgaW4gUmVhY3QgMTYrLiBUaGlzIGxpa2VseSBtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgYSBSZWFjdCAxNSB0cmVlIGluc2lkZSBhIFJlYWN0IDE2IHRyZWUgdXNpbmcgdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIsIHdoaWNoIGlzbid0IHN1cHBvcnRlZC4gVHJ5IHRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoIHRvIFJlYWN0RE9NLmNyZWF0ZVBvcnRhbCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmZyZWV6ZShmYWtlSW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVtb2l6ZWRTdGF0ZSA9IHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCA/IHByZXZTdGF0ZSA6IGFzc2lnbih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5sYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjbGFzc0NvbXBvbmVudFVwZGF0ZXIgPSB7CiAgICAgICAgICBpc01vdW50ZWQsCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldChpbnN0KTsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSBwYXlsb2FkOwogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayhjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZVJlcGxhY2VTdGF0ZTogZnVuY3Rpb24oaW5zdCwgcGF5bG9hZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gUmVwbGFjZVN0YXRlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihpbnN0LCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzLnNob3VsZENvbXBvbmVudFVwZGF0ZSgpOiBSZXR1cm5lZCB1bmRlZmluZWQgaW5zdGVhZCBvZiBhIGJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsKG9sZFByb3BzLCBuZXdQcm9wcykgfHwgIXNoYWxsb3dFcXVhbChvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgdmFyIHJlbmRlclByZXNlbnQgPSBpbnN0YW5jZS5yZW5kZXI7CiAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiB0eXBlb2YgY3Rvci5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IGRpZCB5b3UgYWNjaWRlbnRhbGx5IHJldHVybiBhbiBvYmplY3QgZnJvbSB0aGUgY29uc3RydWN0b3I/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgJiYgIWluc3RhbmNlLmdldEluaXRpYWxTdGF0ZS5pc1JlYWN0Q2xhc3NBcHByb3ZlZCAmJiAhaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0SW5pdGlhbFN0YXRlIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldERlZmF1bHRQcm9wcyAmJiAhaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgZGVmYXVsdFByb3BzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BUeXBlcykgewogICAgICAgICAgICAgIGVycm9yKCJwcm9wVHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgcHJvcFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdG9yLmNoaWxkQ29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNoaWxkQ29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSBpbnN0ZWFkXG5cbi5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgd2l0aCBzdGF0aWMgY29udGV4dFR5cGUgaW5zdGVhZC5cblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlICYmIGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWNsYXJlcyBib3RoIGNvbnRleHRUeXBlcyBhbmQgY29udGV4dFR5cGUgc3RhdGljIHByb3BlcnRpZXMuIFRoZSBsZWdhY3kgY29udGV4dFR5cGVzIHByb3BlcnR5IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRTaG91bGRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRTaG91bGRVcGRhdGUoKS4gRGlkIHlvdSBtZWFuIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpPyBUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ICYmIHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkuIHNob3VsZENvbXBvbmVudFVwZGF0ZSBzaG91bGQgbm90IGJlIHVzZWQgd2hlbiBleHRlbmRpbmcgUmVhY3QuUHVyZUNvbXBvbmVudC4gUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJBIHB1cmUgY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkVW5tb3VudCgpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFVubW91bnQoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFJlY2VpdmVQcm9wcygpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBJZiB5b3UgbWVhbnQgdG8gdXBkYXRlIHRoZSBzdGF0ZSBpbiByZXNwb25zZSB0byBjaGFuZ2luZyBwcm9wcywgdXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgcnVuIHNpZGUtZWZmZWN0cyBvciBtdXRhdGlvbnMgYWZ0ZXIgUmVhY3QgaGFzIHVwZGF0ZWQgdGhlIFVJLCB1c2UgY29tcG9uZW50RGlkVXBkYXRlKCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTXV0YXRlZFByb3BzID0gaW5zdGFuY2UucHJvcHMgIT09IG5ld1Byb3BzOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IHZvaWQgMCAmJiBoYXNNdXRhdGVkUHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICFkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgc2hvdWxkIGJlIHVzZWQgd2l0aCBjb21wb25lbnREaWRVcGRhdGUoKS4gVGhpcyBjb21wb25lbnQgZGVmaW5lcyBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIG9ubHkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBpcyBkZWZpbmVkIGFzIGEgc3RhdGljIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGFuIGluc3RhbmNlIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChfc3RhdGUgJiYgKHR5cGVvZiBfc3RhdGUgIT09ICJvYmplY3QiIHx8IGlzQXJyYXkoX3N0YXRlKSkpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuc3RhdGU6IG11c3QgYmUgc2V0IHRvIGFuIG9iamVjdCBvciBudWxsIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldENoaWxkQ29udGV4dCgpOiBjaGlsZENvbnRleHRUeXBlcyBtdXN0IGJlIGRlZmluZWQgaW4gb3JkZXIgdG8gdXNlIGdldENoaWxkQ29udGV4dCgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICBpbnN0YW5jZS51cGRhdGVyID0gY2xhc3NDb21wb25lbnRVcGRhdGVyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgc2V0KGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgewogICAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RJbnRlcm5hbEluc3RhbmNlID0gZmFrZUludGVybmFsSW5zdGFuY2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBwcm9wcykgewogICAgICAgICAgdmFyIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoImNvbnRleHRUeXBlIiBpbiBjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIGlzVmFsaWQgPSAoCiAgICAgICAgICAgICAgICAvLyBBbGxvdyBudWxsIGZvciBjb25kaXRpb25hbCBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgY29udGV4dFR5cGUgPT09IG51bGwgfHwgY29udGV4dFR5cGUgIT09IHZvaWQgMCAmJiBjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFICYmIGNvbnRleHRUeXBlLl9jb250ZXh0ID09PSB2b2lkIDAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCAmJiAhZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9ICIiOwogICAgICAgICAgICAgICAgaWYgKGNvbnRleHRUeXBlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byB1bmRlZmluZWQuIFRoaXMgY2FuIGJlIGNhdXNlZCBieSBhIHR5cG8gb3IgYnkgbWl4aW5nIHVwIG5hbWVkIGFuZCBkZWZhdWx0IGltcG9ydHMuIFRoaXMgY2FuIGFsc28gaGFwcGVuIGR1ZSB0byBhIGNpcmN1bGFyIGRlcGVuZGVuY3ksIHNvIHRyeSBtb3ZpbmcgdGhlIGNyZWF0ZUNvbnRleHQoKSBjYWxsIHRvIGEgc2VwYXJhdGUgZmlsZS4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dFR5cGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYSAiICsgdHlwZW9mIGNvbnRleHRUeXBlICsgIi4iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Qcm92aWRlciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLl9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuQ29uc3VtZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMoY29udGV4dFR5cGUpLmpvaW4oIiwgIikgKyAifS4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlZmluZXMgYW4gaW52YWxpZCBjb250ZXh0VHlwZS4gY29udGV4dFR5cGUgc2hvdWxkIHBvaW50IHRvIHRoZSBDb250ZXh0IG9iamVjdCByZXR1cm5lZCBieSBSZWFjdC5jcmVhdGVDb250ZXh0KCkuJXMiLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIsIGFkZGVuZHVtKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IGN0b3IuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGNvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgICAgY29udGV4dCA9IGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID8gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgOiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBuZXcgY3Rvcihwcm9wcywgY29udGV4dCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGUgIT09IG51bGwgJiYgaW5zdGFuY2Uuc3RhdGUgIT09IHZvaWQgMCA/IGluc3RhbmNlLnN0YXRlIDogbnVsbDsKICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBzdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCJgJXNgIHVzZXMgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYnV0IGl0cyBpbml0aWFsIHN0YXRlIGlzICVzLiBUaGlzIGlzIG5vdCByZWNvbW1lbmRlZC4gSW5zdGVhZCwgZGVmaW5lIHRoZSBpbml0aWFsIHN0YXRlIGJ5IGFzc2lnbmluZyBhbiBvYmplY3QgdG8gYHRoaXMuc3RhdGVgIGluIHRoZSBjb25zdHJ1Y3RvciBvZiBgJXNgLiBUaGlzIGVuc3VyZXMgdGhhdCBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBhcmd1bWVudHMgaGF2ZSBhIGNvbnNpc3RlbnQgc2hhcGUuIiwgY29tcG9uZW50TmFtZSwgaW5zdGFuY2Uuc3RhdGUgPT09IG51bGwgPyAibnVsbCIgOiAidW5kZWZpbmVkIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbE1vdW50TmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxVcGRhdGVOYW1lID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gImNvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsTW91bnROYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJjb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsVXBkYXRlTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICB2YXIgbmV3QXBpTmFtZSA9IHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiA/ICJnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSIgOiAiZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuaGFzKF9jb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmFkZChfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbnNhZmUgbGVnYWN5IGxpZmVjeWNsZXMgd2lsbCBub3QgYmUgY2FsbGVkIGZvciBjb21wb25lbnRzIHVzaW5nIG5ldyBjb21wb25lbnQgQVBJcy5cblxuJXMgdXNlcyAlcyBidXQgYWxzbyBjb250YWlucyB0aGUgZm9sbG93aW5nIGxlZ2FjeSBsaWZlY3ljbGVzOiVzJXMlc1xuXG5UaGUgYWJvdmUgbGlmZWN5Y2xlcyBzaG91bGQgYmUgcmVtb3ZlZC4gTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTpcbmh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMiLCBfY29tcG9uZW50TmFtZSwgbmV3QXBpTmFtZSwgZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsTW91bnROYW1lIDogIiIsIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lIDogIiIsIGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxVcGRhdGVOYW1lIDogIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzTGVnYWN5Q29udGV4dENvbnN1bWVyKSB7CiAgICAgICAgICAgIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgY29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2xkU3RhdGUgIT09IGluc3RhbmNlLnN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbE1vdW50KCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IG9sZFN0YXRlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xhc3NDb21wb25lbnRVcGRhdGVyLmVucXVldWVSZXBsYWNlU3RhdGUoaW5zdGFuY2UsIGluc3RhbmNlLnN0YXRlLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5yZWZzID0ge307CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBJdCBpcyBub3QgcmVjb21tZW5kZWQgdG8gYXNzaWduIHByb3BzIGRpcmVjdGx5IHRvIHN0YXRlIGJlY2F1c2UgdXBkYXRlcyB0byBwcm9wcyB3b24ndCBiZSByZWZsZWN0ZWQgaW4gc3RhdGUuIEluIG1vc3QgY2FzZXMsIGl0IGlzIGJldHRlciB0byB1c2UgcHJvcHMgZGlyZWN0bHkuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3Mod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsTW91bnQod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG9sZFByb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMgJiYgb2xkU3RhdGUgPT09IG5ld1N0YXRlICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpICYmICFjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyRmxhZ3MyID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gX2ZpYmVyRmxhZ3MyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBuZXh0Q29udGV4dDsKICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID8gdW5yZXNvbHZlZE9sZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyh3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50Mi5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB8fCAvLyBUT0RPOiBJbiBzb21lIGNhc2VzLCB3ZSdsbCBlbmQgdXAgY2hlY2tpbmcgaWYgY29udGV4dCBoYXMgY2hhbmdlZCB0d2ljZSwKICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgIC8vIGJ1dCBJJ20gbG9hdGggdG8gcmVmYWN0b3IgdGhpcyBmdW5jdGlvbi4gVGhpcyBvbmx5IGhhcHBlbnMgZm9yIG1lbW9pemVkCiAgICAgICAgICAvLyBjb21wb25lbnRzIHNvIGl0J3Mgbm90IHRoYXQgY29tbW9uLgogICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDIubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgc3RhY2s6IGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChzb3VyY2UpLAogICAgICAgICAgICBkaWdlc3Q6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWUodmFsdWUsIGRpZ2VzdCwgc3RhY2spIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICBkaWdlc3Q6IGRpZ2VzdCAhPSBudWxsID8gZGlnZXN0IDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2dDYXB0dXJlZEVycm9yKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGxvZ0Vycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiI7CiAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU1lc3NhZ2U7CiAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuVmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Vycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiUmVhY3Qgd2lsbCB0cnkgdG8gcmVjcmVhdGUgdGhpcyBjb21wb25lbnQgdHJlZSBmcm9tIHNjcmF0Y2ggIiArICgidXNpbmcgdGhlIGVycm9yIGJvdW5kYXJ5IHlvdSBwcm92aWRlZCwgIiArIGVycm9yQm91bmRhcnlOYW1lICsgIi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oY29tYmluZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCQxID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG9uVW5jYXVnaHRFcnJvcihlcnJvcjIpOwogICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPSBmaWJlci50eXBlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvcjsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IkMSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IkMTIsIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUoZmliZXIubGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogRXJyb3IgYm91bmRhcmllcyBzaG91bGQgaW1wbGVtZW50IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpLiBJbiB0aGF0IG1ldGhvZCwgcmV0dXJuIGEgc3RhdGUgdXBkYXRlIHRvIGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBvciBmYWxsYmFjayBVSS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwJDEoKTsKICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICBpZiAodGhyZWFkSURzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgdGhyZWFkSURzLmFkZChsYW5lcyk7CiAgICAgICAgICAgIHZhciBwaW5nID0gcGluZ1N1c3BlbmRlZFJvb3QuYmluZChudWxsLCByb290Mywgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZS50aGVuKHBpbmcsIHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlID0gdXBkYXRlUXVldWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgdmFyIHRhZyA9IHNvdXJjZUZpYmVyLnRhZzsKICAgICAgICAgIGlmICgoc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmICh0YWcgPT09IEZ1bmN0aW9uQ29tcG9uZW50IHx8IHRhZyA9PT0gRm9yd2FyZFJlZiB8fCB0YWcgPT09IFNpbXBsZU1lbW9Db21wb25lbnQpKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gY3VycmVudFNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gY3VycmVudFNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gY3VycmVudFNvdXJjZS5sYW5lczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgJiYgc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgaWYgKChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSA9PT0gcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2U7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgJj0gfihMaWZlY3ljbGVFZmZlY3RNYXNrIHwgSW5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlRmliZXIgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZUZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnRhZyA9IEluY29tcGxldGVDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlVXBkYXRlKHNvdXJjZUZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmxhbmVzID0gcm9vdFJlbmRlckxhbmVzOwogICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93RXhjZXB0aW9uKHJvb3QzLCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHZhbHVlLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHZhbHVlOwogICAgICAgICAgICByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU3luY0xhbmUocm9vdFJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHVuY2F1Z2h0U3VzcGVuc2VFcnJvciA9IG5ldyBFcnJvcigiQSBjb21wb25lbnQgc3VzcGVuZGVkIHdoaWxlIHJlc3BvbmRpbmcgdG8gc3luY2hyb25vdXMgaW5wdXQuIFRoaXMgd2lsbCBjYXVzZSB0aGUgVUkgdG8gYmUgcmVwbGFjZWQgd2l0aCBhIGxvYWRpbmcgaW5kaWNhdG9yLiBUbyBmaXgsIHVwZGF0ZXMgdGhhdCBzdXNwZW5kIHNob3VsZCBiZSB3cmFwcGVkIHdpdGggc3RhcnRUcmFuc2l0aW9uLiIpOwogICAgICAgICAgICAgIHZhbHVlID0gdW5jYXVnaHRTdXNwZW5zZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIHZhciBfc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICBpZiAoX3N1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICgoX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShfc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IoY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICByZW5kZXJEaWRFcnJvcih2YWx1ZSk7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfZXJyb3JJbmZvLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MgJiYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgdmFyIF9sYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIF91cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgZXJyb3JJbmZvLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF91cGRhdGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAod29ya0luUHJvZ3Jlc3MyICE9PSBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuZGVkQ2FjaGUoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEJhZENsYXNzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXI7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXIgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDIuY2hpbGQsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IENvbXBvbmVudC5yZW5kZXI7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpICYmIENvbXBvbmVudC5jb21wYXJlID09PSBudWxsICYmIC8vIFNpbXBsZU1lbW9Db21wb25lbnQgY29kZXBhdGggZG9lc24ndCByZXNvbHZlIG91dGVyIHByb3BzIGVpdGhlci4KICAgICAgICAgICAgQ29tcG9uZW50LmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gU2ltcGxlTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVzb2x2ZWRUeXBlLCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gbWVtbyBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKENvbXBvbmVudC50eXBlLCBudWxsLCBuZXh0UHJvcHMsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBfaW5uZXJQcm9wVHlwZXMgPSBfdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChfaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgIF9pbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoX3R5cGUpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnRDaGlsZC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgY29tcGFyZSA9IENvbXBvbmVudC5jb21wYXJlOwogICAgICAgICAgICBjb21wYXJlID0gY29tcGFyZSAhPT0gbnVsbCA/IGNvbXBhcmUgOiBzaGFsbG93RXF1YWw7CiAgICAgICAgICAgIGlmIChjb21wYXJlKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50Mi5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgbmV4dFByb3BzKTsKICAgICAgICAgIG5ld0NoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIG91dGVyTWVtb1R5cGUgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgICAgaWYgKG91dGVyTWVtb1R5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBvdXRlck1lbW9UeXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgKFNpbXBsZU1lbW9Db21wb25lbnQgaGFzIG5vIGRlZmF1bHRQcm9wcykKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG91dGVyTWVtb1R5cGUpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQyLnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZiAmJiAvLyBQcmV2ZW50IGJhaWxvdXQgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQuCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID09PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBuZXh0UHJvcHMgPSBwcmV2UHJvcHM7CiAgICAgICAgICAgICAgaWYgKCFjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50MiwgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGN1cnJlbnQyLmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFN0YXRlIDogbnVsbDsKICAgICAgICAgIGlmIChuZXh0UHJvcHMubW9kZSA9PT0gImhpZGRlbiIgfHwgZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIE9mZnNjcmVlbkxhbmUpKSB7CiAgICAgICAgICAgICAgdmFyIHNwYXduZWRDYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXh0QmFzZUxhbmVzOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2QmFzZUxhbmVzID0gcHJldlN0YXRlLmJhc2VMYW5lczsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZCYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IG5leHRCYXNlTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IHNwYXduZWRDYWNoZVBvb2wsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgbmV4dEJhc2VMYW5lcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUyID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTI7CiAgICAgICAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lczIgPSBwcmV2U3RhdGUgIT09IG51bGwgPyBwcmV2U3RhdGUuYmFzZUxhbmVzIDogcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHN1YnRyZWVSZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3N1YnRyZWVSZW5kZXJMYW5lczsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZTdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgX3N1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvZmlsZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsICYmIHJlZiAhPT0gbnVsbCB8fCBjdXJyZW50MiAhPT0gbnVsbCAmJiBjdXJyZW50Mi5yZWYgIT09IHJlZikgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZlN0YXRpYzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoc2hvdWxkRXJyb3Iod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIGNhc2UgZmFsc2U6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciB0ZW1wSW5zdGFuY2UgPSBuZXcgY3Rvcih3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcywgX2luc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gdGVtcEluc3RhbmNlLnN0YXRlOwogICAgICAgICAgICAgICAgX2luc3RhbmNlLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKF9pbnN0YW5jZSwgc3RhdGUsIG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgdHJ1ZTogewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gbmV3IEVycm9yKCJTaW11bGF0ZWQgZXJyb3IgY29taW5nIGZyb20gRGV2VG9vbHMiKTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgd29ya0luUHJvZ3Jlc3MyKSwgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGU7CiAgICAgICAgICBpZiAoaW5zdGFuY2UgPT09IG51bGwpIHsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VW5pdE9mV29yayA9IGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgJiYgaW5zdC5wcm9wcyAhPT0gbmV4dFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSXQgbG9va3MgbGlrZSAlcyBpcyByZWFzc2lnbmluZyBpdHMgb3duIGB0aGlzLnByb3BzYCB3aGlsZSByZW5kZXJpbmcuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgY2FuIGxlYWQgdG8gY29uZnVzaW5nIGJ1Z3MuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJhIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRVbml0T2ZXb3JrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGRpZENhcHR1cmVFcnJvciA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmICghc2hvdWxkVXBkYXRlICYmICFkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgaWYgKGRpZENhcHR1cmVFcnJvciAmJiB0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwgJiYgZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAocm9vdDMucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLnBlbmRpbmdDb250ZXh0LCByb290My5wZW5kaW5nQ29udGV4dCAhPT0gcm9vdDMuY29udGV4dCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJvb3QzLmNvbnRleHQpIHsKICAgICAgICAgICAgcHVzaFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRleHQsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBjdXJyZW50IGZpYmVyLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcHJldkNoaWxkcmVuID0gcHJldlN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV4dFByb3BzLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGlmIChwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgIHZhciBvdmVycmlkZVN0YXRlID0gewogICAgICAgICAgICAgIGVsZW1lbnQ6IG5leHRDaGlsZHJlbiwKICAgICAgICAgICAgICBpc0RlaHlkcmF0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGNhY2hlOiBuZXh0U3RhdGUuY2FjaGUsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbmV4dFN0YXRlLnBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXMsCiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG5leHRTdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcuIEJlY2F1c2UgdGhlIGVycm9yIGhhcHBlbmVkIG91dHNpZGUgb2YgYSBTdXNwZW5zZSBib3VuZGFyeSwgdGhlIGVudGlyZSByb290IHdpbGwgc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0Q2hpbGRyZW4gIT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHZhciBfcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhpcyByb290IHJlY2VpdmVkIGFuIGVhcmx5IHVwZGF0ZSwgYmVmb3JlIGFueXRoaW5nIHdhcyBhYmxlIGh5ZHJhdGUuIFN3aXRjaGVkIHRoZSBlbnRpcmUgcm9vdCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgX3JlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVudGVySHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBtb3VudENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgIHZhciBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICAgIG5vZGUuZmxhZ3MgPSBub2RlLmZsYWdzICYgflBsYWNlbWVudCB8IEh5ZHJhdGluZzsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIGlmIChuZXh0Q2hpbGRyZW4gPT09IHByZXZDaGlsZHJlbikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBudWxsOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBpc0RpcmVjdFRleHRDaGlsZCA9IHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIG5leHRQcm9wcyk7CiAgICAgICAgICBpZiAoaXNEaXJlY3RUZXh0Q2hpbGQpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSBpZiAocHJldlByb3BzICE9PSBudWxsICYmIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByZXZQcm9wcykpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENvbnRlbnRSZXNldDsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZWYoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudExhenlDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IGVsZW1lbnRUeXBlOwogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgdmFyIENvbXBvbmVudCA9IGluaXQocGF5bG9hZCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFRhZyA9IHdvcmtJblByb2dyZXNzMi50YWcgPSByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpOwogICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgc3dpdGNoIChyZXNvbHZlZFRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRm9yd2FyZFJlZihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkUHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlTWVtb0NvbXBvbmVudCgKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICBDb21wb25lbnQsCiAgICAgICAgICAgICAgICByZXNvbHZlRGVmYXVsdFByb3BzKENvbXBvbmVudC50eXBlLCByZXNvbHZlZFByb3BzKSwKICAgICAgICAgICAgICAgIC8vIFRoZSBpbm5lciB0eXBlIGNhbiBoYXZlIGRlZmF1bHRzIHRvbwogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoaW50ID0gIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQgIT09IG51bGwgJiYgdHlwZW9mIENvbXBvbmVudCA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICBoaW50ID0gIiBEaWQgeW91IHdyYXAgYSBjb21wb25lbnQgaW4gUmVhY3QubGF6eSgpIG1vcmUgdGhhbiBvbmNlPyI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQuIFJlY2VpdmVkIGEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvOiAiICsgQ29tcG9uZW50ICsgIi4gIiArICgiTGF6eSBlbGVtZW50IHR5cGUgbXVzdCByZXNvbHZlIHRvIGEgY2xhc3Mgb3IgZnVuY3Rpb24uIiArIGhpbnQpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBmYWxzZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgdHlwZW9mIENvbXBvbmVudC5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gaGF2ZSBhIHJlbmRlciBtZXRob2QsIGJ1dCBkb2Vzbid0IGV4dGVuZCBSZWFjdC5Db21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IHRvIGNhdXNlIGVycm9ycy4gQ2hhbmdlICVzIHRvIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIFJ1biB0aGVzZSBjaGVja3MgaW4gcHJvZHVjdGlvbiBvbmx5IGlmIHRoZSBmbGFnIGlzIG9mZi4KICAgICAgICAgICAgLy8gRXZlbnR1YWxseSB3ZSdsbCBkZWxldGUgdGhpcyBicmFuY2ggYWx0b2dldGhlci4KICAgICAgICAgICAgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUucmVuZGVyID09PSAiZnVuY3Rpb24iICYmIHZhbHVlLiQkdHlwZW9mID09PSB2b2lkIDAKICAgICAgICAgICkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMiA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSA8JXMgLz4gY29tcG9uZW50IGFwcGVhcnMgdG8gYmUgYSBmdW5jdGlvbiBjb21wb25lbnQgdGhhdCByZXR1cm5zIGEgY2xhc3MgaW5zdGFuY2UuIENoYW5nZSAlcyB0byBhIGNsYXNzIHRoYXQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQgaW5zdGVhZC4gSWYgeW91IGNhbid0IHVzZSBhIGNsYXNzIHRyeSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBvbiB0aGUgZnVuY3Rpb24gYXMgYSB3b3JrYXJvdW5kLiBgJXMucHJvdG90eXBlID0gUmVhY3QuQ29tcG9uZW50LnByb3RvdHlwZWAuIERvbid0IHVzZSBhbiBhcnJvdyBmdW5jdGlvbiBzaW5jZSBpdCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYG5ld2AgYnkgUmVhY3QuIiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gdmFsdWUuc3RhdGUgIT09IG51bGwgJiYgdmFsdWUuc3RhdGUgIT09IHZvaWQgMCA/IHZhbHVlLnN0YXRlIDogbnVsbDsKICAgICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHZhbHVlKTsKICAgICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IEZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4obnVsbCwgd29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQpIHsKICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmNoaWxkQ29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogY2hpbGRDb250ZXh0VHlwZXMgY2Fubm90IGJlIGRlZmluZWQgb24gYSBmdW5jdGlvbiBjb21wb25lbnQuIiwgQ29tcG9uZW50LmRpc3BsYXlOYW1lIHx8IENvbXBvbmVudC5uYW1lIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvMiArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBvd25lck5hbWUgfHwgIiI7CiAgICAgICAgICAgICAgdmFyIGRlYnVnU291cmNlID0gd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICBpZiAoZGVidWdTb3VyY2UpIHsKICAgICAgICAgICAgICAgIHdhcm5pbmdLZXkgPSBkZWJ1Z1NvdXJjZS5maWxlTmFtZSArICI6IiArIGRlYnVnU291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMuIEF0dGVtcHRzIHRvIGFjY2VzcyB0aGlzIHJlZiB3aWxsIGZhaWwuIERpZCB5b3UgbWVhbiB0byB1c2UgUmVhY3QuZm9yd2FyZFJlZigpPyVzIiwgaW5mbzIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IFN1cHBvcnQgZm9yIGRlZmF1bHRQcm9wcyB3aWxsIGJlIHJlbW92ZWQgZnJvbSBmdW5jdGlvbiBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTMgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIiwgX2NvbXBvbmVudE5hbWUzKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50LmNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWU0ID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogRnVuY3Rpb24gY29tcG9uZW50cyBkbyBub3Qgc3VwcG9ydCBjb250ZXh0VHlwZS4iLCBfY29tcG9uZW50TmFtZTQpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lNF0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgU1VTUEVOREVEX01BUktFUiA9IHsKICAgICAgICAgIGRlaHlkcmF0ZWQ6IG51bGwsCiAgICAgICAgICB0cmVlQ29udGV4dDogbnVsbCwKICAgICAgICAgIHJldHJ5TGFuZTogTm9MYW5lCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgY2FjaGVQb29sOiBnZXRTdXNwZW5kZWRDYWNoZSgpLAogICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNhY2hlUG9vbCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBiYXNlTGFuZXM6IG1lcmdlTGFuZXMocHJldk9mZnNjcmVlblN0YXRlLmJhc2VMYW5lcywgcmVuZGVyTGFuZXMyKSwKICAgICAgICAgICAgY2FjaGVQb29sLAogICAgICAgICAgICB0cmFuc2l0aW9uczogcHJldk9mZnNjcmVlblN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiByZW1vdmVMYW5lcyhjdXJyZW50Mi5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkU3VzcGVuZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvd0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChkaWRTdXNwZW5kIHx8IHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50MikpIHsKICAgICAgICAgICAgc2hvd0ZhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5EaWRDYXB0dXJlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBkZWh5ZHJhdGVkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBmYWxsYmFja0ZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZGVoeWRyYXRlZCA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgIGlmIChfZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIF9kZWh5ZHJhdGVkLCBwcmV2U3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgX25leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuLCBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdGF0ZSA9IGN1cnJlbnQyLmNoaWxkLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5tZW1vaXplZFN0YXRlID0gcHJldk9mZnNjcmVlblN0YXRlID09PSBudWxsID8gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgOiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLmNoaWxkTGFuZXMgPSBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50MiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4yID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzID0gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4yLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gX3ByaW1hcnlDaGlsZEZyYWdtZW50MzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKG9mZnNjcmVlblByb3BzLCBtb2RlLCBOb0xhbmVzLCBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Miwgb2Zmc2NyZWVuUHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQyLmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IFtjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50XTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBJbiBsZWdhY3kgbW9kZSwgd2UgY29tbWl0IHRoZSBwcmltYXJ5IHRyZWUgYXMgaWYgaXQgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICAgIC8vIGNvbXBsZXRlZCwgZXZlbiB0aG91Z2ggaXQncyBpbiBhbiBpbmNvbnNpc3RlbnQgc3RhdGUuCiAgICAgICAgICAgIChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gTWFrZSBzdXJlIHdlJ3JlIG9uIHRoZSBzZWNvbmQgcGFzcywgaS5lLiB0aGUgcHJpbWFyeSBjaGlsZCBmcmFnbWVudCB3YXMKICAgICAgICAgICAgLy8gYWxyZWFkeSBjbG9uZWQuIEluIGxlZ2FjeSBtb2RlLCB0aGUgb25seSBjYXNlIHdoZXJlIHRoaXMgaXNuJ3QgdHJ1ZSBpcwogICAgICAgICAgICAvLyB3aGVuIERldlRvb2xzIGZvcmNlcyB1cyB0byBkaXNwbGF5IGEgZmFsbGJhY2s7IHdlIHNraXAgdGhlIGZpcnN0IHJlbmRlcgogICAgICAgICAgICAvLyBwYXNzIGVudGlyZWx5IGFuZCBnbyBzdHJhaWdodCB0byByZW5kZXJpbmcgdGhlIGZhbGxiYWNrLiAoSW4gQ29uY3VycmVudAogICAgICAgICAgICAvLyBNb2RlLCBTdXNwZW5zZUxpc3QgY2FuIGFsc28gdHJpZ2dlciB0aGlzIHNjZW5hcmlvLCBidXQgdGhpcyBpcyBhIGxlZ2FjeS0KICAgICAgICAgICAgLy8gb25seSBjb2RlcGF0aC4pCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50CiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnBlbmRpbmdQcm9wcyA9IHByaW1hcnlDaGlsZFByb3BzOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgcHJpbWFyeUNoaWxkUHJvcHMpOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50LCBmYWxsYmFja0NoaWxkcmVuKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICBpZiAocmVjb3ZlcmFibGVFcnJvciAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIGZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyTW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIGZpYmVyTW9kZSk7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgZmliZXJNb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50Mi5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaHlkcmF0ZSBTdXNwZW5zZSBpbiBsZWdhY3kgbW9kZS4gU3dpdGNoIGZyb20gUmVhY3RET00uaHlkcmF0ZShlbGVtZW50LCBjb250YWluZXIpIHRvIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikucmVuZGVyKGVsZW1lbnQpIG9yIHJlbW92ZSB0aGUgU3VzcGVuc2UgY29tcG9uZW50cyBmcm9tIHRoZSBzZXJ2ZXIgcmVuZGVyZWQgY29tcG9uZW50cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhTeW5jTGFuZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKERlZmF1bHRIeWRyYXRpb25MYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBkaWRTdXNwZW5kLCBuZXh0UHJvcHMsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCFkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgIHdhcm5JZkh5ZHJhdGluZygpOwogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoCiAgICAgICAgICAgICAgICBjdXJyZW50MiwKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMiwKICAgICAgICAgICAgICAgIC8vIFRPRE86IFdoZW4gd2UgZGVsZXRlIGxlZ2FjeSBtb2RlLCB3ZSBzaG91bGQgbWFrZSB0aGlzIGVycm9yIGFyZ3VtZW50CiAgICAgICAgICAgICAgICAvLyByZXF1aXJlZCDigJQgZXZlcnkgY29uY3VycmVudCBtb2RlIHBhdGggdGhhdCBjYXVzZXMgaHlkcmF0aW9uIHRvCiAgICAgICAgICAgICAgICAvLyBkZS1vcHQgdG8gY2xpZW50IHJlbmRlcmluZyBzaG91bGQgaGF2ZSBhbiBlcnJvciBtZXNzYWdlLgogICAgICAgICAgICAgICAgbnVsbAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCwgbWVzc2FnZSwgc3RhY2s7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIF9nZXRTdXNwZW5zZUluc3RhbmNlRiA9IGdldFN1c3BlbnNlSW5zdGFuY2VGYWxsYmFja0Vycm9yRGV0YWlscyhzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGRpZ2VzdCA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5kaWdlc3Q7CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICBzdGFjayA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5zdGFjazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICBpZiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoIlRoZSBzZXJ2ZXIgY291bGQgbm90IGZpbmlzaCB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LCBsaWtlbHkgZHVlIHRvIGFuIGVycm9yIGR1cmluZyBzZXJ2ZXIgcmVuZGVyaW5nLiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUoZXJyb3IyLCBkaWdlc3QsIHN0YWNrKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBjYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzQ29udGV4dENoYW5nZWQyID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIGN1cnJlbnQyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICBpZiAoZGlkUmVjZWl2ZVVwZGF0ZSB8fCBoYXNDb250ZXh0Q2hhbmdlZDIpIHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lID0gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGlmIChhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBOb0xhbmUgJiYgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lOwogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShjdXJyZW50MiwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgY3VycmVudDIsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhpcyBTdXNwZW5zZSBib3VuZGFyeSByZWNlaXZlZCBhbiB1cGRhdGUgYmVmb3JlIGl0IGZpbmlzaGVkIGh5ZHJhdGluZy4gVGhpcyBjYXVzZWQgdGhlIGJvdW5kYXJ5IHRvIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiBUaGUgdXN1YWwgd2F5IHRvIGZpeCB0aGlzIGlzIHRvIHdyYXAgdGhlIG9yaWdpbmFsIHVwZGF0ZSBpbiBzdGFydFRyYW5zaXRpb24uIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKHN1c3BlbnNlSW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeS5iaW5kKG51bGwsIGN1cnJlbnQyKTsKICAgICAgICAgICAgICByZWdpc3RlclN1c3BlbnNlSW5zdGFuY2VSZXRyeShzdXNwZW5zZUluc3RhbmNlLCByZXRyeSk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZS50cmVlQ29udGV4dCk7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZTIgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZyB0aGlzIFN1c3BlbnNlIGJvdW5kYXJ5LiBTd2l0Y2hlZCB0byBjbGllbnQgcmVuZGVyaW5nLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZTIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDIuY2hpbGQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tBZnRlclJldHJ5V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuLCBuZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50NCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIoZmliZXIsIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KSB7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGZpcnN0Q2hpbGQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaXJzdENoaWxkOwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZExhc3RDb250ZW50Um93KGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciByb3cgPSBmaXJzdENoaWxkOwogICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChyb3cgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRSb3cgPSByb3cuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFJvdyAhPT0gbnVsbCAmJiBmaW5kRmlyc3RTdXNwZW5kZWQoY3VycmVudFJvdykgPT09IG51bGwpIHsKICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdyA9IHJvdzsKICAgICAgICAgICAgfQogICAgICAgICAgICByb3cgPSByb3cuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXN0Q29udGVudFJvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmV2ZWFsT3JkZXIgIT09IHZvaWQgMCAmJiByZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJ0b2dldGhlciIgJiYgIWRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyW3JldmVhbE9yZGVyXSA9IHRydWU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXZlYWxPcmRlciA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAocmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBVc2UgbG93ZXJjYXNlICIlcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZCI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkIjogewogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHZhbGlkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBSZWFjdCB1c2VzIHRoZSAtcyBzdWZmaXggaW4gdGhlIHNwZWxsaW5nLiBVc2UgIiVzcyIgaW5zdGVhZC4nLCByZXZlYWxPcmRlciwgcmV2ZWFsT3JkZXIudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignJXMgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gdm9pZCAwICYmICFkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0pIHsKICAgICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09ICJjb2xsYXBzZWQiICYmIHRhaWxNb2RlICE9PSAiaGlkZGVuIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgdGFpbCBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gImNvbGxhcHNlZCIgb3IgImhpZGRlbiI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJzxTdXNwZW5zZUxpc3QgdGFpbD0iJXMiIC8+IGlzIG9ubHkgdmFsaWQgaWYgcmV2ZWFsT3JkZXIgaXMgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIi4gRGlkIHlvdSBtZWFuIHRvIHNwZWNpZnkgcmV2ZWFsT3JkZXI9ImZvcndhcmRzIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0TmVzdGVkQ2hpbGQoY2hpbGRTbG90LCBpbmRleDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzQW5BcnJheSA9IGlzQXJyYXkoY2hpbGRTbG90KTsKICAgICAgICAgICAgdmFyIGlzSXRlcmFibGUgPSAhaXNBbkFycmF5ICYmIHR5cGVvZiBnZXRJdGVyYXRvckZuKGNoaWxkU2xvdCkgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgZXJyb3IoIkEgbmVzdGVkICVzIHdhcyBwYXNzZWQgdG8gcm93ICMlcyBpbiA8U3VzcGVuc2VMaXN0IC8+LiBXcmFwIGl0IGluIGFuIGFkZGl0aW9uYWwgU3VzcGVuc2VMaXN0IHRvIGNvbmZpZ3VyZSBpdHMgcmV2ZWFsT3JkZXI6IDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPiAuLi4gPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+eyVzfTwvU3VzcGVuc2VMaXN0PiAuLi4gPC9TdXNwZW5zZUxpc3Q+IiwgdHlwZSwgaW5kZXgyLCB0eXBlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKGNoaWxkcmVuLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4gIT09IHZvaWQgMCAmJiBjaGlsZHJlbiAhPT0gbnVsbCAmJiBjaGlsZHJlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheShjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkcmVuW2ldLCBpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbkl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuSXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBfaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKHN0ZXAudmFsdWUsIF9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBfaSsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0Egc2luZ2xlIHJvdyB3YXMgcGFzc2VkIHRvIGEgPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0iJXMiIC8+LiBUaGlzIGlzIG5vdCB1c2VmdWwgc2luY2UgaXQgbmVlZHMgbXVsdGlwbGUgcm93cy4gRGlkIHlvdSBtZWFuIHRvIHBhc3MgbXVsdGlwbGUgY2hpbGRyZW4gb3IgYW4gYXJyYXk/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUod29ya0luUHJvZ3Jlc3MyLCBpc0JhY2t3YXJkcywgdGFpbCwgbGFzdENvbnRlbnRSb3csIHRhaWxNb2RlKSB7CiAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHsKICAgICAgICAgICAgICBpc0JhY2t3YXJkcywKICAgICAgICAgICAgICByZW5kZXJpbmc6IG51bGwsCiAgICAgICAgICAgICAgcmVuZGVyaW5nU3RhcnRUaW1lOiAwLAogICAgICAgICAgICAgIGxhc3Q6IGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmlzQmFja3dhcmRzID0gaXNCYWNrd2FyZHM7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IDA7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSBsYXN0Q29udGVudFJvdzsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWxNb2RlID0gdGFpbE1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJldmVhbE9yZGVyID0gbmV4dFByb3BzLnJldmVhbE9yZGVyOwogICAgICAgICAgdmFyIHRhaWxNb2RlID0gbmV4dFByb3BzLnRhaWw7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4obmV3Q2hpbGRyZW4sIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG91bGRGb3JjZUZhbGxiYWNrID0gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgIGlmIChzaG91bGRGb3JjZUZhbGxiYWNrKSB7CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gY3VycmVudDIgIT09IG51bGwgJiYgKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBmaW5kTGFzdENvbnRlbnRSb3cod29ya0luUHJvZ3Jlc3MyLmNoaWxkKTsKICAgICAgICAgICAgICAgIHZhciB0YWlsOwogICAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZW50Um93ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0YWlsID0gbGFzdENvbnRlbnRSb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgX3RhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcm93OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIHJvdy5zaWJsaW5nID0gX3RhaWw7CiAgICAgICAgICAgICAgICAgIF90YWlsID0gcm93OwogICAgICAgICAgICAgICAgICByb3cgPSBuZXh0Um93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIF90YWlsLAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjogewogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyB0YWlsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdm9pZCAwCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHByb3ZpZGVyVHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIGNvbnRleHQgPSBwcm92aWRlclR5cGUuX2NvbnRleHQ7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBuZXdQcm9wcy52YWx1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoInZhbHVlIiBpbiBuZXdQcm9wcykpIHsKICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGB2YWx1ZWAgcHJvcCBpcyByZXF1aXJlZCBmb3IgdGhlIGA8Q29udGV4dC5Qcm92aWRlcj5gLiBEaWQgeW91IG1pc3NwZWxsIGl0IG9yIGZvcmdldCB0byBwYXNzIGl0PyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvdmlkZXJQcm9wVHlwZXMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChwcm92aWRlclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3ZpZGVyUHJvcFR5cGVzLCBuZXdQcm9wcywgInByb3AiLCAiQ29udGV4dC5Qcm92aWRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IG9sZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhvbGRWYWx1ZSwgbmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUHJvcHMuY2hpbGRyZW4gPT09IG5ld1Byb3BzLmNoaWxkcmVuICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dC5fY29udGV4dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IGNvbnRleHQuQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQ+IGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZW5kZXIyID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuZGVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbnRleHQgY29uc3VtZXIgd2FzIHJlbmRlcmVkIHdpdGggbXVsdGlwbGUgY2hpbGRyZW4sIG9yIGEgY2hpbGQgdGhhdCBpc24ndCBhIGZ1bmN0aW9uLiBBIGNvbnRleHQgY29uc3VtZXIgZXhwZWN0cyBhIHNpbmdsZSBjaGlsZCB0aGF0IGlzIGEgZnVuY3Rpb24uIElmIHlvdSBkaWQgcGFzcyBhIGZ1bmN0aW9uLCBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gdHJhaWxpbmcgb3IgbGVhZGluZyB3aGl0ZXNwYWNlIGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5ld0NoaWxkcmVuID0gcmVuZGVyMihuZXdWYWx1ZSk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpIHsKICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudDIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMpOwogICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW91bnRGaWJlcihjdXJyZW50Miwgb2xkV29ya0luUHJvZ3Jlc3MsIG5ld1dvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc3dhcCB0aGUgcm9vdCBmaWJlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50Mi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBvbGRXb3JrSW5Qcm9ncmVzcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5pbmRleCA9IG9sZFdvcmtJblByb2dyZXNzLmluZGV4OwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nID0gb2xkV29ya0luUHJvZ3Jlc3Muc2libGluZzsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmV0dXJuID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZWYgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgICAgICAgIGlmIChvbGRXb3JrSW5Qcm9ncmVzcyA9PT0gcmV0dXJuRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5jaGlsZCA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBwcmV2U2libGluZyA9IHJldHVybkZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBwYXJlbnQgdG8gaGF2ZSBhIGNoaWxkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAocHJldlNpYmxpbmcuc2libGluZyAhPT0gb2xkV29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgIHByZXZTaWJsaW5nID0gcHJldlNpYmxpbmcuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByZXZpb3VzIHNpYmxpbmcuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZTaWJsaW5nLnNpYmxpbmcgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2N1cnJlbnQyXTsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHVwZGF0ZUxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZSh1cGRhdGVMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjogewogICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGhhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZExhbmVzID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lczsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgcHJpbWFyeUNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IChjdXJyZW50Mi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciBfaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuX2RlYnVnTmVlZHNSZW1vdW50ICYmIGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbW91bnRGaWJlcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5rZXksIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciB8fCBudWxsLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgd29ya0luUHJvZ3Jlc3MyLmxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IGhhc0NvbnRleHRDaGFuZ2VkKCkgfHwgLy8gRm9yY2UgYSByZS1yZW5kZXIgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQ6CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlICE9PSBjdXJyZW50Mi50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ICYmIC8vIElmIHRoaXMgaXMgdGhlIHNlY29uZCBwYXNzIG9mIGFuIGVycm9yIG9yIHN1c3BlbnNlIGJvdW5kYXJ5LCB0aGVyZQogICAgICAgICAgICAgIC8vIG1heSBub3QgYmUgd29yayBzY2hlZHVsZWQgb24gYGN1cnJlbnRgLCBzbyB3ZSBjaGVjayBmb3IgdGhpcyBmbGFnLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY3VycmVudDIuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IHdvcmtJblByb2dyZXNzMi5pbmRleDsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IGdldEZvcmtzQXRMZXZlbCgpOwogICAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExhenlDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gQ29tcG9uZW50ID8gdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wcyhDb21wb25lbnQsIHVucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50ID8gX3VucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoX0NvbXBvbmVudCwgX3VucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQsIF9yZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IHR5cGUgPyBfdW5yZXNvbHZlZFByb3BzMiA6IHJlc29sdmVEZWZhdWx0UHJvcHModHlwZSwgX3VucmVzb2x2ZWRQcm9wczIpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIF9yZXNvbHZlZFByb3BzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZyYWdtZW50MjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJhZ21lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNb2RlKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVByb2ZpbGVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0UHJvdmlkZXIoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNvbnRleHRDb25zdW1lcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3R5cGUyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhfdHlwZTIsIF91bnJlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBfdHlwZTIucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgX3Jlc29sdmVkUHJvcHMzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShfdHlwZTIpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIF90eXBlMiwgX3Jlc29sdmVkUHJvcHMzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wcyhfQ29tcG9uZW50MiwgX3VucmVzb2x2ZWRQcm9wczQpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEluY29tcGxldGVDbGFzc0NvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCBfQ29tcG9uZW50MiwgX3Jlc29sdmVkUHJvcHM0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXBwZW5kQWxsQ2hpbGRyZW47CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb250YWluZXI7CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb21wb25lbnQkMTsKICAgICAgICB2YXIgdXBkYXRlSG9zdFRleHQkMTsKICAgICAgICB7CiAgICAgICAgICBhcHBlbmRBbGxDaGlsZHJlbiA9IGZ1bmN0aW9uKHBhcmVudCwgd29ya0luUHJvZ3Jlc3MyLCBuZWVkc1Zpc2liaWxpdHlUb2dnbGUsIGlzSGlkZGVuKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lciA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50JDEgPSBmdW5jdGlvbihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gcHJlcGFyZVVwZGF0ZShpbnN0YW5jZSwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdFRleHQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgICAgaWYgKG9sZFRleHQgIT09IG5ld1RleHQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlclN0YXRlLnRhaWxNb2RlKSB7CiAgICAgICAgICAgIGNhc2UgImhpZGRlbiI6IHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBsYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlICh0YWlsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHRhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYXN0VGFpbE5vZGUgPSB0YWlsTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhaWxOb2RlID0gdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhc3RUYWlsTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgIHZhciBfdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBfbGFzdFRhaWxOb2RlID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoX3RhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoX3RhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlID0gX3RhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3RhaWxOb2RlID0gX3RhaWxOb2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChfbGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1JlbmRlcmVkQVRhaWxGYWxsYmFjayAmJiByZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2xhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYnViYmxlUHJvcGVydGllcyhjb21wbGV0ZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZGlkQmFpbG91dCA9IGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlICE9PSBudWxsICYmIGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlLmNoaWxkID09PSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoIWRpZEJhaWxvdXQpIHsKICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIHRyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoY2hpbGQubGFuZXMsIGNoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHRyZWVCYXNlRHVyYXRpb24gKz0gY2hpbGQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IHRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQubGFuZXMsIF9jaGlsZC5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBfY2hpbGQucmV0dXJuID0gY29tcGxldGVkV29yazsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIF90cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHZhciBfY2hpbGQyID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQyLmxhbmVzLCBfY2hpbGQyLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMi5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfdHJlZUJhc2VEdXJhdGlvbiArPSBfY2hpbGQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICBfY2hpbGQyID0gX2NoaWxkMi5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24gPSBfdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkMyA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkMy5sYW5lcywgX2NoaWxkMy5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgX2NoaWxkMy5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkMyA9IF9jaGlsZDMuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yay5zdWJ0cmVlRmxhZ3MgfD0gc3VidHJlZUZsYWdzOwogICAgICAgICAgfQogICAgICAgICAgY29tcGxldGVkV29yay5jaGlsZExhbmVzID0gbmV3Q2hpbGRMYW5lczsKICAgICAgICAgIHJldHVybiBkaWRCYWlsb3V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSkgewogICAgICAgICAgaWYgKGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSAmJiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgd2FybklmVW5oeWRyYXRlZFRhaWxOb2Rlcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlciB8IEluY29tcGxldGUgfCBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCAmJiBuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIXdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkEgZGVoeWRyYXRlZCBzdXNwZW5zZSBjb21wb25lbnQgd2FzIGNvbXBsZXRlZCB3aXRob3V0IGEgaHlkcmF0ZWQgbm9kZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaXNUaW1lZE91dFN1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2lzVGltZWRPdXRTdXNwZW5zZSA9IG5leHRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKF9pc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChfcHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IF9wcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVdvcmsoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcG9wVHJlZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQyOgogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyUm9vdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGlmIChmaWJlclJvb3QucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5jb250ZXh0ID0gZmliZXJSb290LnBlbmRpbmdDb250ZXh0OwogICAgICAgICAgICAgICAgZmliZXJSb290LnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyID09PSBudWxsIHx8IGN1cnJlbnQyLmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgaWYgKHdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBjbGllbnQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgIXByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQgfHwgLy8gQ2hlY2sgaWYgd2UgcmV2ZXJ0ZWQgdG8gY2xpZW50IHJlbmRlcmluZyAoZS5nLiBkdWUgdG8gYW4gZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpICE9PSBOb0ZsYWdzCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgICAgICAgICB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCQxKGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLnJlZiAhPT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFuZXdQcm9wcykgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4oaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMiwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBpZiAoZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oaW5zdGFuY2UsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IG5ld1Byb3BzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEoY3VycmVudDIsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VGV4dCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICAgIHZhciBfY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICAgIHZhciBfd2FzSHlkcmF0ZWQyID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCB8fCBjdXJyZW50Mi5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIGN1cnJlbnQyLm1lbW9pemVkU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGggPSBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQyLCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dERpZFRpbWVvdXQgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIHByZXZEaWRUaW1lb3V0ID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQgIT09IHByZXZEaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5GaWJlcjIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5GaWJlcjIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCA9IGN1cnJlbnQyID09PSBudWxsICYmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy51bnN0YWJsZV9hdm9pZFRoaXNGYWxsYmFjayAhPT0gdHJ1ZSB8fCAhZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCB8fCBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZXBhcmVQb3J0YWxNb3VudCh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoX0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRBbHJlYWR5ID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZFRhaWwgPSByZW5kZXJTdGF0ZS5yZW5kZXJpbmc7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkVGFpbCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgY2Fubm90QmVTdXNwZW5kZWQgPSByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSAmJiAoY3VycmVudDIgPT09IG51bGwgfHwgKGN1cnJlbnQyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpOwogICAgICAgICAgICAgICAgICBpZiAoIWNhbm5vdEJlU3VzcGVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGhlbmFibGVzID0gc3VzcGVuZGVkLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VGhlbmFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbmV3VGhlbmFibGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjaykpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsICYmIG5vdygpID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IFNvbWVSZXRyeUxhbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJlbmRlcmVkVGFpbCk7CiAgICAgICAgICAgICAgICAgIGlmIChfc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfbmV3VGhlbmFibGVzID0gX3N1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX25ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gX25ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLnRhaWwgPT09IG51bGwgJiYgcmVuZGVyU3RhdGUudGFpbE1vZGUgPT09ICJoaWRkZW4iICYmICFyZW5kZXJlZFRhaWwuYWx0ZXJuYXRlICYmICFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHRpbWUgaXQgdG9vayB0byByZW5kZXIgbGFzdCByb3cgaXMgZ3JlYXRlciB0aGFuIHRoZSByZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAvLyB0aW1lIHdlIGhhdmUgdG8gcmVuZGVyLiBTbyByZW5kZXJpbmcgb25lIG1vcmUgcm93IHdvdWxkIGxpa2VseQogICAgICAgICAgICAgICAgICAgIC8vIGV4Y2VlZCBpdC4KICAgICAgICAgICAgICAgICAgICBub3coKSAqIDIgLSByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgJiYgcmVuZGVyTGFuZXMyICE9PSBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyZWRUYWlsLnNpYmxpbmcgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSByZW5kZXJTdGF0ZS5sYXN0OwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLnNpYmxpbmcgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBuZXh0OwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG5leHQuc2libGluZzsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IG5vdygpOwogICAgICAgICAgICAgICAgbmV4dC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgdmFyIG5leHRJc0hpZGRlbiA9IF9uZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZTdGF0ZSA9IGN1cnJlbnQyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgcHJldklzSGlkZGVuID0gX3ByZXZTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2SXNIaWRkZW4gIT09IG5leHRJc0hpZGRlbiAmJiAvLyBMZWdhY3lIaWRkZW4gZG9lc24ndCBkbyBhbnkgaGlkaW5nIOKAlCBpdCBvbmx5IHByZS1yZW5kZXJzLgogICAgICAgICAgICAgICAgIWVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFuZXh0SXNIaWRkZW4gfHwgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoc3VidHJlZVJlbmRlckxhbmVzLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyAmIChQbGFjZW1lbnQgfCBVcGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kV29yayhjdXJyZW50Miwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIHZhciBfZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKChfZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSAhPT0gTm9GbGFncyAmJiAoX2ZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IF9mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRocmV3IGluIG5ld2x5IG1vdW50ZWQgZGVoeWRyYXRlZCBjb21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9mbGFnczIgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKF9mbGFnczIgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MyICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwb3BQcm92aWRlcihjb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQyLCBpbnRlcnJ1cHRlZFdvcmssIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcG9wVHJlZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgIHN3aXRjaCAoaW50ZXJydXB0ZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgaWYgKGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGludGVycnVwdGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgUG9zc2libHlXZWFrU2V0ID0gdHlwZW9mIFdlYWtTZXQgPT09ICJmdW5jdGlvbiIgPyBXZWFrU2V0IDogU2V0OwogICAgICAgIHZhciBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlcG9ydFVuY2F1Z2h0RXJyb3JJbkRFVihlcnJvcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNhbGxDb21wb25lbnRXaWxsVW5tb3VudFdpdGhUaW1lciA9IGZ1bmN0aW9uKGN1cnJlbnQyLCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBjdXJyZW50Mi5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCwgY3VycmVudDIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIoY3VycmVudDIsIGluc3RhbmNlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50MiwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5QXR0YWNoUmVmKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoY3VycmVudDIpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciByZWYgPSBjdXJyZW50Mi5yZWY7CiAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyAmJiBjdXJyZW50Mi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxEZXN0cm95KGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IHByZXBhcmVGb3JDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpOwogICAgICAgICAgdmFyIHNob3VsZEZpcmUgPSBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXI7CiAgICAgICAgICBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRmlyZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2JlZ2luKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgQmVmb3JlTXV0YXRpb25NYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoKGZsYWdzICYgU25hcHNob3QpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHNuYXBzaG90ID0gaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IHByZXZQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlkV2FyblNldCA9IGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5TZXQuYWRkKGZpbmlzaGVkV29yay50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpOiBBIHNuYXBzaG90IHZhbHVlIChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUgPSBzbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChmbGFncywgZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjcmVhdGUgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZSgpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCAmJiB0eXBlb2YgZGVzdHJveSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQgbnVsbC4gSWYgeW91ciBlZmZlY3QgZG9lcyBub3QgcmVxdWlyZSBjbGVhbiB1cCwgcmV0dXJuIHVuZGVmaW5lZCAob3Igbm90aGluZykuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZXN0cm95LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQ6ICIgKyBkZXN0cm95OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgbXVzdCBub3QgcmV0dXJuIGFueXRoaW5nIGJlc2lkZXMgYSBmdW5jdGlvbiwgd2hpY2ggaXMgdXNlZCBmb3IgY2xlYW4tdXAuJXMiLCBob29rTmFtZSwgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLmlkLCBvblBvc3RDb21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUub25Qb3N0Q29tbWl0OwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGUgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUG9zdENvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUG9zdENvbW1pdChpZCwgcGhhc2UsIHBhc3NpdmVFZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIoZmluaXNoZWRSb290LCBjdXJyZW50MiwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzKGZpbmlzaGVkV29yay50eXBlLCBjdXJyZW50Mi5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZFVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSwgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSwgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIHVwZGF0ZSBxdWV1ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgdXBkYXRlUXVldWUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgX3VwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKF91cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLmNoaWxkLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgICAgICBfaW5zdGFuY2UgPSBnZXRQdWJsaWNJbnN0YW5jZShmaW5pc2hlZFdvcmsuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgICAgICBfaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBfdXBkYXRlUXVldWUsIF9pbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlMiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgPT09IG51bGwgJiYgZmluaXNoZWRXb3JrLmZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICBjb21taXRNb3VudChfaW5zdGFuY2UyLCB0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIF9maW5pc2hlZFdvcmskbWVtb2l6ZTIgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcywgb25Db21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUyLm9uQ29tbWl0LCBvblJlbmRlciA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25SZW5kZXI7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgIHZhciBjb21taXRUaW1lMiA9IGdldENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICAgICAgdmFyIHBoYXNlID0gY3VycmVudDIgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgb25SZW5kZXIoZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMuaWQsIHBoYXNlLCBmaW5pc2hlZFdvcmsuYWN0dWFsRHVyYXRpb24sIGZpbmlzaGVkV29yay50cmVlQmFzZUR1cmF0aW9uLCBmaW5pc2hlZFdvcmsuYWN0dWFsU3RhcnRUaW1lLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25Db21taXQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIG9uQ29tbWl0KGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZWZmZWN0RHVyYXRpb24sIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaW5pc2hlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QzLmVmZmVjdER1cmF0aW9uICs9IGVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uICs9IGVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgY29tbWl0U3VzcGVuc2VIeWRyYXRpb25DYWxsYmFja3MoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBUcmFjaW5nTWFya2VyQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFJlZikgewogICAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihub2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KG5vZGUsIG5vZGUucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgc2FmZWx5QXR0YWNoUmVmKG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihmaW5pc2hlZFdvcmssIGlzSGlkZGVuKSB7CiAgICAgICAgICB2YXIgaG9zdFN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVJbnN0YW5jZShub2RlLnN0YXRlTm9kZSwgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzLCBub2RlLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgobm9kZS50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gTGVnYWN5SGlkZGVuQ29tcG9uZW50KSAmJiBub2RlLm1lbW9pemVkU3RhdGUgIT09IG51bGwgJiYgbm9kZSAhPT0gZmluaXNoZWRXb3JrKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciByZWYgPSBmaW5pc2hlZFdvcmsucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBpbnN0YW5jZVRvVXNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgcmV0VmFsOwogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXRWYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmV0dXJuIHZhbHVlIGZyb20gYSBjYWxsYmFjayByZWYgaW4gJXMuIEEgY2FsbGJhY2sgcmVmIHNob3VsZCBub3QgcmV0dXJuIGEgZnVuY3Rpb24uIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFyZWYuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZWYgb2JqZWN0IHByb3ZpZGVkIGZvciAlcy4gVXNlIGVpdGhlciBhIHJlZi1zZXR0ZXIgZnVuY3Rpb24gb3IgUmVhY3QuY3JlYXRlUmVmKCkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBpbnN0YW5jZVRvVXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyTXV0YXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5yZXR1cm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGFsdGVybmF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRldGFjaERlbGV0ZWRJbnN0YW5jZShob3N0SW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UGFyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0hvc3RQYXJlbnQocGFyZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgZmliZXIudGFnID09PSBIb3N0Um9vdCB8fCBmaWJlci50YWcgPT09IEhvc3RQb3J0YWw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RTaWJsaW5nKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgc2libGluZ3M6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGUucmV0dXJuKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBub2RlLnRhZyAhPT0gSG9zdFRleHQgJiYgbm9kZS50YWcgIT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGQgPT09IG51bGwgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEobm9kZS5mbGFncyAmIFBsYWNlbWVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChwYXJlbnQpOwogICAgICAgICAgICAgICAgcGFyZW50RmliZXIuZmxhZ3MgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJlZm9yZSA9IGdldEhvc3RTaWJsaW5nKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKGZpbmlzaGVkV29yaywgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHZhciBfcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgdmFyIF9iZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIoZmluaXNoZWRXb3JrLCBfYmVmb3JlLCBfcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob3N0IHBhcmVudCBmaWJlci4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZShwYXJlbnQsIHN0YXRlTm9kZSwgYmVmb3JlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGNoaWxkLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIHdoaWxlIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGQocGFyZW50LCBzdGF0ZU5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFBvcnRhbCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICB2YXIgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCByZXR1cm5GaWJlciwgZGVsZXRlZEZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgZmluZFBhcmVudDogd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50LnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0UGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRldGFjaEZpYmVyTXV0YXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIHBhcmVudCkgewogICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBjaGlsZCk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgb25Db21taXRVbm1vdW50KGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICBzd2l0Y2ggKGRlbGV0ZWRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2SG9zdFBhcmVudCA9IGhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBwcmV2SG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5RnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIF9wcmV2SG9zdFBhcmVudElzQ29udGFpbmVyID0gaG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBfcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGRlbGV0ZWRGaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgX2VmZmVjdCA9IGVmZmVjdCwgZGVzdHJveSA9IF9lZmZlY3QuZGVzdHJveSwgdGFnID0gX2VmZmVjdC50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGFnICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgodGFnICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWxldGVkRmliZXIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICBkZWxldGVkRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IGRlbGV0ZWRGaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlQ2FsbGJhY2soZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VIeWRyYXRpb25DYWxsYmFja3MoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG5ld1N0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50MiA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gcHJldlN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgd2FrZWFibGVzID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB2YXIgcmV0cnlDYWNoZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChyZXRyeUNhY2hlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPSBuZXcgUG9zc2libHlXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FrZWFibGVzLmZvckVhY2goZnVuY3Rpb24od2FrZWFibGUpIHsKICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXNvbHZlUmV0cnlXYWtlYWJsZS5iaW5kKG51bGwsIGZpbmlzaGVkV29yaywgd2FrZWFibGUpOwogICAgICAgICAgICAgIGlmICghcmV0cnlDYWNoZS5oYXMod2FrZWFibGUpKSB7CiAgICAgICAgICAgICAgICByZXRyeUNhY2hlLmFkZCh3YWtlYWJsZSk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChpblByb2dyZXNzTGFuZXMgIT09IG51bGwgJiYgaW5Qcm9ncmVzc1Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMoaW5Qcm9ncmVzc1Jvb3QsIGluUHJvZ3Jlc3NMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCJFeHBlY3RlZCBmaW5pc2hlZCByb290IGFuZCBsYW5lcyB0byBiZSBzZXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3YWtlYWJsZS50aGVuKHJldHJ5LCByZXRyeSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290Myk7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIHBhcmVudEZpYmVyLCBsYW5lcykgewogICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHBhcmVudEZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGRlbGV0aW9uc1tpXTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjaGlsZFRvRGVsZXRlLCBwYXJlbnRGaWJlciwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RGVidWdGaWJlciA9IGdldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgaWYgKHBhcmVudEZpYmVyLnN1YnRyZWVGbGFncyAmIE11dGF0aW9uTWFzaykgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRGaWJlci5jaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNoaWxkKTsKICAgICAgICAgICAgICBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGNoaWxkLCByb290Myk7CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldkRlYnVnRmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaywgcm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQyLCBjdXJyZW50Mi5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50MiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDIsIGN1cnJlbnQyLnJldHVybik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICByZXNldFRleHRDb250ZW50KGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAoX2luc3RhbmNlNCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDIgIT09IG51bGwgPyBjdXJyZW50Mi5tZW1vaXplZFByb3BzIDogbmV3UHJvcHM7CiAgICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaW5pc2hlZFdvcmsudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGUoX2luc3RhbmNlNCwgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyBzaG91bGQgaGF2ZSBhIHRleHQgbm9kZSBpbml0aWFsaXplZC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIG9sZFRleHQgPSBjdXJyZW50MiAhPT0gbnVsbCA/IGN1cnJlbnQyLm1lbW9pemVkUHJvcHMgOiBuZXdUZXh0OwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdFRleHRVcGRhdGUodGV4dEluc3RhbmNlLCBvbGRUZXh0LCBuZXdUZXh0KTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZSb290U3RhdGUgPSBjdXJyZW50Mi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmV2Um9vdFN0YXRlLmlzRGVoeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0SHlkcmF0ZWRDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkZpYmVyID0gZmluaXNoZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIGlmIChvZmZzY3JlZW5GaWJlci5mbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5JbnN0YW5jZSA9IG9mZnNjcmVlbkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IG9mZnNjcmVlbkZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBuZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIG9mZnNjcmVlbkluc3RhbmNlLmlzSGlkZGVuID0gaXNIaWRkZW47CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZSAhPT0gbnVsbCAmJiBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKCF3YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdFN1c3BlbnNlQ2FsbGJhY2soZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfd2FzSGlkZGVuID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZW1vdmUgdGhpcyBkZWFkIGZsYWcKICAgICAgICAgICAgICAgIGZpbmlzaGVkV29yay5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgX3dhc0hpZGRlbjsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFZpc2liaWxpdHkpIHsKICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuSW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIF9uZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIF9pc0hpZGRlbiA9IF9uZXdTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5Cb3VuZGFyeSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5JbnN0YW5jZS5pc0hpZGRlbiA9IF9pc0hpZGRlbjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKF9pc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgIGlmICghX3dhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaWYgKChvZmZzY3JlZW5Cb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG9mZnNjcmVlbkJvdW5kYXJ5OwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuQ2hpbGQgPSBvZmZzY3JlZW5Cb3VuZGFyeS5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG9mZnNjcmVlbkNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG9mZnNjcmVlbkNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4ob2Zmc2NyZWVuQ2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihvZmZzY3JlZW5Cb3VuZGFyeSwgX2lzSGlkZGVuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBmbGFncyA9IGZpbmlzaGVkV29yay5mbGFnczsKICAgICAgICAgIGlmIChmbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluaXNoZWRXb3JrLmZsYWdzICY9IH5QbGFjZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmxhZ3MgJiBIeWRyYXRpbmcpIHsKICAgICAgICAgICAgZmluaXNoZWRXb3JrLmZsYWdzICY9IH5IeWRyYXRpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IChzdWJ0cmVlUm9vdC5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgJiYgaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gZmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gaXNIaWRkZW4gfHwgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgIGlmIChuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICB2YXIgd2FzSGlkZGVuID0gY3VycmVudDIgIT09IG51bGwgJiYgY3VycmVudDIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gd2FzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gbmV3T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuICYmICFwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICAgIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBmaXJzdENoaWxkOwogICAgICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbigKICAgICAgICAgICAgICAgICAgICBjaGlsZCwKICAgICAgICAgICAgICAgICAgICAvLyBOZXcgcm9vdDsgYnViYmxlIGJhY2sgdXAgdG8gaGVyZSBhbmQgc3RvcC4KICAgICAgICAgICAgICAgICAgICByb290MywKICAgICAgICAgICAgICAgICAgICBjb21taXR0ZWRMYW5lcwogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXI7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MgJiYgZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgTGF5b3V0TWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihyb290MywgY3VycmVudDIsIGZpYmVyLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKHJvb3QzLCBmaWJlciwgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzKGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2JlZ2luKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKG5leHRFZmZlY3QuZmxhZ3MgJiBDaGlsZERlbGV0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBmaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpYmVyVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlclRvRGVsZXRlOwogICAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGZpYmVyVG9EZWxldGUsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkQ2hpbGQgPSBwcmV2aW91c0ZpYmVyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0ZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkU2libGluZyA9IGRldGFjaGVkQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZCA9IGRldGFjaGVkU2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRldGFjaGVkQ2hpbGQgIT09IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGRlbGV0ZWRTdWJ0cmVlUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRJbnNpZGVEZWxldGVkVHJlZU9uRmliZXIoZmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfY29tcGxldGUoZGVsZXRlZFN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhmaWJlcik7CiAgICAgICAgICAgICAgaWYgKGZpYmVyID09PSBkZWxldGVkU3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSByZXR1cm5GaWJlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRJbnNpZGVEZWxldGVkVHJlZU9uRmliZXIoY3VycmVudDIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHN3aXRjaCAoY3VycmVudDIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihjdXJyZW50Mik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUxheW91dEVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENPTVBPTkVOVF9UWVBFID0gMDsKICAgICAgICB2YXIgSEFTX1BTRVVET19DTEFTU19UWVBFID0gMTsKICAgICAgICB2YXIgUk9MRV9UWVBFID0gMjsKICAgICAgICB2YXIgVEVTVF9OQU1FX1RZUEUgPSAzOwogICAgICAgIHZhciBURVhUX1RZUEUgPSA0OwogICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5mb3IpIHsKICAgICAgICAgIHZhciBzeW1ib2xGb3IgPSBTeW1ib2wuZm9yOwogICAgICAgICAgQ09NUE9ORU5UX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLmNvbXBvbmVudCIpOwogICAgICAgICAgSEFTX1BTRVVET19DTEFTU19UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5oYXNfcHNldWRvX2NsYXNzIik7CiAgICAgICAgICBST0xFX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnJvbGUiKTsKICAgICAgICAgIFRFU1RfTkFNRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXN0X2lkIik7CiAgICAgICAgICBURVhUX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnRleHQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbW1pdEhvb2tzID0gW107CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290JDEoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbW1pdEhvb2tzLmZvckVhY2goZnVuY3Rpb24oY29tbWl0SG9vaykgewogICAgICAgICAgICAgIHJldHVybiBjb21taXRIb29rKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICBmdW5jdGlvbiBpc0xlZ2FjeUFjdEVudmlyb25tZW50KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgPSAoCiAgICAgICAgICAgICAgLy8gJEZsb3dFeHBlY3RlZEVycm9yIOKAkyBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgZ2xvYmFsCiAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIGplc3RJc0RlZmluZWQgPSB0eXBlb2YgamVzdCAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIHJldHVybiBqZXN0SXNEZWZpbmVkICYmIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAhPT0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGN1cnJlbnQgdGVzdGluZyBlbnZpcm9ubWVudCBpcyBub3QgY29uZmlndXJlZCB0byBzdXBwb3J0IGFjdCguLi4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNlaWwyID0gTWF0aC5jZWlsOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRPd25lciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZywgUmVhY3RDdXJyZW50QWN0UXVldWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEJhdGNoZWRDb250ZXh0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFJlbmRlckNvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFJvb3RJblByb2dyZXNzID0gMDsKICAgICAgICB2YXIgUm9vdEZhdGFsRXJyb3JlZCA9IDE7CiAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZCA9IDM7CiAgICAgICAgdmFyIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgPSA0OwogICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICB2YXIgUm9vdERpZE5vdENvbXBsZXRlID0gNjsKICAgICAgICB2YXIgZXhlY3V0aW9uQ29udGV4dCA9IE5vQ29udGV4dDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOb0xhbmVzKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gMDsKICAgICAgICB2YXIgRkFMTEJBQ0tfVEhST1RUTEVfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICB2YXIgUkVOREVSX1RJTUVPVVRfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lID0gbm93KCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgdmFyIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICB2YXIgTkVTVEVEX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgIHZhciByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub3coKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3coKTsKICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcikgewogICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbikgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TGFuZSA9IGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCk7CiAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UmV0cnlMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2xhaW1OZXh0UmV0cnlMYW5lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICBlcnJvcigidXNlSW5zZXJ0aW9uRWZmZWN0IG11c3Qgbm90IHNjaGVkdWxlIHVwZGF0ZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9MYW5lcyAmJiByb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKGxhbmUgPT09IFN5bmNMYW5lICYmIGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIFRyZWF0IGBhY3RgIGFzIGlmIGl0J3MgaW5zaWRlIGBiYXRjaGVkVXBkYXRlc2AsIGV2ZW4gaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgY3VycmVudDIgPSByb290My5jdXJyZW50OwogICAgICAgICAgY3VycmVudDIubGFuZXMgPSBsYW5lOwogICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBvdXRkYXRlZCBkZWZlclJlbmRlclBoYXNlVXBkYXRlVG9OZXh0QmF0Y2ggZXhwZXJpbWVudC4gV2UKICAgICAgICAgICAgLy8gZGVjaWRlZCBub3QgdG8gZW5hYmxlIGl0LgogICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPSByb290My5jYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9PT0gbmV3Q2FsbGJhY2tQcmlvcml0eSAmJiAvLyBTcGVjaWFsIGNhc2UgcmVsYXRlZCB0byBgYWN0YC4gSWYgdGhlIGN1cnJlbnRseSBzY2hlZHVsZWQgdGFzayBpcyBhCiAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgIC8vIG9uIHRoZSBgYWN0YCBxdWV1ZS4KICAgICAgICAgICEoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsICYmIGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlID09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ICE9PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNjaGVkdWxlZCBjYWxsYmFjayB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2skMShleGlzdGluZ0NhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgICAgaWYgKG5ld0NhbGxiYWNrUHJpb3JpdHkgPT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2socGVyZm9ybVN5bmNXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQucHVzaChmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICBzd2l0Y2ggKGxhbmVzVG9FdmVudFByaW9yaXR5KG5leHRMYW5lcykpIHsKICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gbmV3Q2FsbGJhY2tQcmlvcml0eTsKICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290KHJvb3QzLCBkaWRUaW1lb3V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICBpZiAoZGlkRmx1c2hQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICBpZiAocm9vdDMuY2FsbGJhY2tOb2RlICE9PSBvcmlnaW5hbENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFRpbWVTbGljZSA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpICYmICFpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWRpZFRpbWVvdXQ7CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHNob3VsZFRpbWVTbGljZSA/IHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgOiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbGFuZXMgPSBlcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZW5kZXJXYXNDb25jdXJyZW50ID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJXYXNDb25jdXJyZW50ICYmICFpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSkgewogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgICAgIGlmIChfZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgX2Vycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgX2ZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgPT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3QuYmluZChudWxsLCByb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgdmFyIGVycm9yc0Zyb21GaXJzdEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzOwogICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgcm9vdFdvcmtJblByb2dyZXNzLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ID0gd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgaWYgKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGl0U3RhdHVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9ycykgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMucHVzaC5hcHBseSh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgZXJyb3JzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICBjYXNlIFJvb3RJblByb2dyZXNzOgogICAgICAgICAgICBjYXNlIFJvb3RGYXRhbEVycm9yZWQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RFcnJvcmVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgJiYgLy8gZG8gbm90IGRlbGF5IGlmIHdlJ3JlIGluc2lkZSBhbiBhY3QoKSBzY29wZQogICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1zVW50aWxUaW1lb3V0ID0gZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSArIEZBTExCQUNLX1RIUk9UVExFX01TIC0gbm93KCk7CiAgICAgICAgICAgICAgICBpZiAobXNVbnRpbFRpbWVvdXQgPiAxMCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dExhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhzdXNwZW5kZWRMYW5lcywgbGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk6IHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZU1zID0gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93KCkgLSBldmVudFRpbWVNczsKICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgaWYgKF9tc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIF9tc1VudGlsVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcm9vdCBleGl0IHN0YXR1cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IG5vZGUudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgaWYgKGNoZWNrcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoZWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0U25hcHNob3QgPSBjaGVjay5nZXRTbmFwc2hvdDsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRWYWx1ZSA9IGNoZWNrLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKGdldFNuYXBzaG90KCksIHJlbmRlcmVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyk7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3luY05lc3RlZFVwZGF0ZUZsYWcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgbm90IGFscmVhZHkgYmUgd29ya2luZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5pc2hlZFdvcmsgPSByb290My5jdXJyZW50LmFsdGVybmF0ZTsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbWVyZ2VMYW5lcyhsYW5lcywgU3luY0xhbmUpKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMkMShmbiwgYSkgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQmF0Y2hlZENvbnRleHQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZm4oYSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzY3JldGVVcGRhdGVzKGZuLCBhLCBiLCBjLCBkKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHJldHVybiBmbihhLCBiLCBjLCBkKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jKGZuKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwgJiYgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMudGFnID09PSBMZWdhY3lSb290ICYmIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5UmVuZGVyaW5nKCkgewogICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFJlbmRlckxhbmVzKGZpYmVyLCBsYW5lcykgewogICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhzdWJ0cmVlUmVuZGVyTGFuZXMsIGxhbmVzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUmVuZGVyTGFuZXMoZmliZXIpIHsKICAgICAgICAgIHN1YnRyZWVSZW5kZXJMYW5lcyA9IHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gcm9vdDMudGltZW91dEhhbmRsZTsKICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgICAgY2FuY2VsVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJydXB0ZWRXb3JrID0gd29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gaW50ZXJydXB0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDIsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICB2YXIgcm9vdFdvcmtJblByb2dyZXNzID0gY3JlYXRlV29ya0luUHJvZ3Jlc3Mocm9vdDMuY3VycmVudCwgbnVsbCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgICBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yKHJvb3QzLCB0aHJvd25WYWx1ZSkgewogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgICAgICByZXNldEhvb2tzQWZ0ZXJUaHJvdygpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoZXJyb3JlZFdvcmsgPT09IG51bGwgfHwgZXJyb3JlZFdvcmsucmV0dXJuID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEZhdGFsRXJyb3JlZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZXJyb3JlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGVycm9yZWRXb3JrLCB0cnVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgICAgIGlmICh0aHJvd25WYWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdGhyb3duVmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB0aHJvd25WYWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGVycm9yZWRXb3JrLCB3YWtlYWJsZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudEVycm9yZWQoZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93RXhjZXB0aW9uKHJvb3QzLCBlcnJvcmVkV29yay5yZXR1cm4sIGVycm9yZWRXb3JrLCB0aHJvd25WYWx1ZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGNvbXBsZXRlVW5pdE9mV29yayhlcnJvcmVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKHlldEFub3RoZXJUaHJvd25WYWx1ZSkgewogICAgICAgICAgICAgIHRocm93blZhbHVlID0geWV0QW5vdGhlclRocm93blZhbHVlOwogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyA9PT0gZXJyb3JlZFdvcmsgJiYgZXJyb3JlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gZXJyb3JlZFdvcmsucmV0dXJuOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBlcnJvcmVkV29yazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQ7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChwcmV2RGlzcGF0Y2hlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BEaXNwYXRjaGVyKHByZXZEaXNwYXRjaGVyKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0VGltZU9mRmFsbGJhY2soKSB7CiAgICAgICAgICBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gbm93KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobGFuZSkgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gbWVyZ2VMYW5lcyhsYW5lLCB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290U3VzcGVuZGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCkgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSBudWxsICYmIChpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcykgfHwgaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcykpKSB7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEod29ya0luUHJvZ3Jlc3NSb290LCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgIT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RFcnJvcmVkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckhhc05vdFN1c3BlbmRlZFlldCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BTeW5jKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCBhbiBpbmNvbXBsZXRlIHJvb3QuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wU3luYygpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSByb290MyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd29ya0xvb3BDb25jdXJyZW50KCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gY2F0Y2ggKHRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCAmJiAhc2hvdWxkWWllbGQoKSkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50MiA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHVuaXRPZldvcmspOwogICAgICAgICAgdmFyIG5leHQ7CiAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQyLCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIHVuaXRPZldvcmsubWVtb2l6ZWRQcm9wcyA9IHVuaXRPZldvcmsucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjb21wbGV0ZWRXb3JrID0gdW5pdE9mV29yazsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQyID0gY29tcGxldGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGNvbXBsZXRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQyLCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0ID0gdW53aW5kV29yayhjdXJyZW50MiwgY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKF9uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gX25leHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RGlkTm90Q29tcGxldGU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHNpYmxpbmdGaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yayA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICB9IHdoaWxlIChjb21wbGV0ZWRXb3JrICE9PSBudWxsKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCByZW5kZXJQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0gd2hpbGUgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKTsKICAgICAgICAgIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3QzLmZpbmlzaGVkTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicm9vdC5maW5pc2hlZExhbmVzIHNob3VsZCBub3QgYmUgZW1wdHkgZHVyaW5nIGEgY29tbWl0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gcm9vdDMuY3VycmVudCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgdGhlIHNhbWUgdHJlZSBhcyBiZWZvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyB8fCAoZmluaXNoZWRXb3JrLmZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IHRyYW5zaXRpb25zOwogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1YnRyZWVIYXNFZmZlY3RzID0gKGZpbmlzaGVkV29yay5zdWJ0cmVlRmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoc3VidHJlZUhhc0VmZmVjdHMgfHwgcm9vdEhhc0VmZmVjdCkgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVjb3JkQ29tbWl0VGltZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxdWVzdFBhaW50KCk7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICBpZiAocm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBsYW5lczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcm9vdERpZEhhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihyb290My5jdXJyZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCByZW5kZXJQcmlvcml0eUxldmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcm9vdDMubWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY292ZXJhYmxlRXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSByZWNvdmVyYWJsZUVycm9yc1tpXTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgIHZhciBkaWdlc3QgPSByZWNvdmVyYWJsZUVycm9yLmRpZ2VzdDsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IocmVjb3ZlcmFibGVFcnJvci52YWx1ZSwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICBkaWdlc3QKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzLCBTeW5jTGFuZSkgJiYgcm9vdDMudGFnICE9PSBMZWdhY3lSb290KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gcm9vdFdpdGhOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gcm9vdDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdHkgPSBsb3dlckV2ZW50UHJpb3JpdHkoRGVmYXVsdEV2ZW50UHJpb3JpdHksIHJlbmRlclByaW9yaXR5KTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICByZXR1cm4gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMucHVzaChmaWJlcik7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFuc2l0aW9ucyA9IHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnM7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXM7CiAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZsdXNoIHBhc3NpdmUgZWZmZWN0cyB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCByb290My5jdXJyZW50LCBsYW5lcywgdHJhbnNpdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvZmlsZXJFZmZlY3RzID0gcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHM7CiAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlciA9IHByb2ZpbGVyRWZmZWN0c1tpXTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKHJvb3QzLCBfZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSByb290My5jdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtpbnN0YW5jZV0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKCFoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuY2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qocm9vdEZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IyKSB7CiAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IyLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKHJvb3RGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3Ioc291cmNlRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVwb3J0VW5jYXVnaHRFcnJvckluREVWKGVycm9yJDEpOwogICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qoc291cmNlRmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIgPSBuZWFyZXN0TW91bnRlZEFuY2VzdG9yOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3QoZmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogQXR0ZW1wdGVkIHRvIGNhcHR1cmUgYSBjb21taXQgcGhhc2UgZXJyb3IgaW5zaWRlIGEgZGV0YWNoZWQgdHJlZS4gVGhpcyBpbmRpY2F0ZXMgYSBidWcgaW4gUmVhY3QuIExpa2VseSBjYXVzZXMgaW5jbHVkZSBkZWxldGluZyB0aGUgc2FtZSBmaWJlciBtb3JlIHRoYW4gb25jZSwgY29tbWl0dGluZyBhbiBhbHJlYWR5LWZpbmlzaGVkIHRyZWUsIG9yIGFuIGluY29uc2lzdGVudCByZXR1cm4gcG9pbnRlci5cblxuRXJyb3IgbWVzc2FnZTpcblxuJXMiLCBlcnJvciQxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGluZ1N1c3BlbmRlZFJvb3Qocm9vdDMsIHdha2VhYmxlLCBwaW5nZWRMYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5IHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgJiYgaW5jbHVkZXNPbmx5UmV0cmllcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcykgJiYgbm93KCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHJlcXVlc3RSZXRyeUxhbmUoYm91bmRhcnlGaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShib3VuZGFyeUZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZXRyeUNhY2hlOwogICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpuZCh0aW1lRWxhcHNlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWVFbGFwc2VkIDwgMTIwID8gMTIwIDogdGltZUVsYXBzZWQgPCA0ODAgPyA0ODAgOiB0aW1lRWxhcHNlZCA8IDEwODAgPyAxMDgwIDogdGltZUVsYXBzZWQgPCAxOTIwID8gMTkyMCA6IHRpbWVFbGFwc2VkIDwgM2UzID8gM2UzIDogdGltZUVsYXBzZWQgPCA0MzIwID8gNDMyMCA6IGNlaWwyKHRpbWVFbGFwc2VkIC8gMTk2MCkgKiAxOTYwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0Zvck5lc3RlZFVwZGF0ZXMoKSB7CiAgICAgICAgICBpZiAobmVzdGVkVXBkYXRlQ291bnQgPiBORVNURURfVVBEQVRFX0xJTUlUKSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNYXhpbXVtIHVwZGF0ZSBkZXB0aCBleGNlZWRlZC4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSBjb21wb25lbnQgcmVwZWF0ZWRseSBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgY29tcG9uZW50V2lsbFVwZGF0ZSBvciBjb21wb25lbnREaWRVcGRhdGUuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIG5lc3RlZCB1cGRhdGVzIHRvIHByZXZlbnQgaW5maW5pdGUgbG9vcHMuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPiBORVNURURfUEFTU0lWRV9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICAgIGVycm9yKCJNYXhpbXVtIHVwZGF0ZSBkZXB0aCBleGNlZWRlZC4gVGhpcyBjYW4gaGFwcGVuIHdoZW4gYSBjb21wb25lbnQgY2FsbHMgc2V0U3RhdGUgaW5zaWRlIHVzZUVmZmVjdCwgYnV0IHVzZUVmZmVjdCBlaXRoZXIgZG9lc24ndCBoYXZlIGEgZGVwZW5kZW5jeSBhcnJheSwgb3Igb25lIG9mIHRoZSBkZXBlbmRlbmNpZXMgY2hhbmdlcyBvbiBldmVyeSByZW5kZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hSZW5kZXJQaGFzZVN0cmljdE1vZGVXYXJuaW5nc0luREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nKCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihmaWJlciwgaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgaWYgKGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudFBhc3NpdmVEZXYsIGludm9rZVBhc3NpdmVFZmZlY3RVbm1vdW50SW5ERVYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRMYXlvdXREZXYsIGludm9rZUxheW91dEVmZmVjdE1vdW50SW5ERVYpOwogICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGludm9rZUVmZmVjdHNJbkRldihmaXJzdENoaWxkLCBmaWJlckZsYWdzLCBpbnZva2VFZmZlY3RGbikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudDIgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgc3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICB3aGlsZSAoY3VycmVudDIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeVN1YnRyZWVGbGFnID0gY3VycmVudDIuc3VidHJlZUZsYWdzICYgZmliZXJGbGFnczsKICAgICAgICAgICAgICBpZiAoY3VycmVudDIgIT09IHN1YnRyZWVSb290ICYmIGN1cnJlbnQyLmNoaWxkICE9PSBudWxsICYmIHByaW1hcnlTdWJ0cmVlRmxhZyAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgY3VycmVudDIgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKChjdXJyZW50Mi5mbGFncyAmIGZpYmVyRmxhZ3MpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIGludm9rZUVmZmVjdEZuKGN1cnJlbnQyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Mi5zaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQyID0gY3VycmVudDIuc2libGluZzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQyID0gc3VidHJlZVJvb3QgPSBjdXJyZW50Mi5yZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGFnID0gZmliZXIudGFnOwogICAgICAgICAgICBpZiAodGFnICE9PSBJbmRldGVybWluYXRlQ29tcG9uZW50ICYmIHRhZyAhPT0gSG9zdFJvb3QgJiYgdGFnICE9PSBDbGFzc0NvbXBvbmVudCAmJiB0YWcgIT09IEZ1bmN0aW9uQ29tcG9uZW50ICYmIHRhZyAhPT0gRm9yd2FyZFJlZiAmJiB0YWcgIT09IE1lbW9Db21wb25lbnQgJiYgdGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlJlYWN0Q29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtjb21wb25lbnROYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbid0IHBlcmZvcm0gYSBSZWFjdCBzdGF0ZSB1cGRhdGUgb24gYSBjb21wb25lbnQgdGhhdCBoYXNuJ3QgbW91bnRlZCB5ZXQuIFRoaXMgaW5kaWNhdGVzIHRoYXQgeW91IGhhdmUgYSBzaWRlLWVmZmVjdCBpbiB5b3VyIHJlbmRlciBmdW5jdGlvbiB0aGF0IGFzeW5jaHJvbm91c2x5IGxhdGVyIGNhbGxzIHRyaWVzIHRvIHVwZGF0ZSB0aGUgY29tcG9uZW50LiBNb3ZlIHRoaXMgd29yayB0byB1c2VFZmZlY3QgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJlZ2luV29yayQxOwogICAgICAgIHsKICAgICAgICAgIHZhciBkdW1teUZpYmVyID0gbnVsbDsKICAgICAgICAgIGJlZ2luV29yayQxID0gZnVuY3Rpb24oY3VycmVudDIsIHVuaXRPZldvcmssIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSA9IGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKGR1bW15RmliZXIsIHVuaXRPZldvcmspOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBiZWdpbldvcmsoY3VycmVudDIsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgfSBjYXRjaCAob3JpZ2luYWxFcnJvcikgewogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgfHwgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgb3JpZ2luYWxFcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgcmVzZXRIb29rc0FmdGVyVGhyb3coKTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDIsIHVuaXRPZldvcmspOwogICAgICAgICAgICAgIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHVuaXRPZldvcmssIG9yaWdpbmFsV29ya0luUHJvZ3Jlc3NDb3B5KTsKICAgICAgICAgICAgICBpZiAodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGJlZ2luV29yaywgbnVsbCwgY3VycmVudDIsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICAgICAgdmFyIHJlcGxheUVycm9yID0gY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXBsYXlFcnJvciA9PT0gIm9iamVjdCIgJiYgcmVwbGF5RXJyb3IgIT09IG51bGwgJiYgcmVwbGF5RXJyb3IuX3N1cHByZXNzTG9nZ2luZyAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiAhb3JpZ2luYWxFcnJvci5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQ7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmICFnZXRJc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlSW5ERVYoKSkgewogICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJpbmdDb21wb25lbnROYW1lID0gd29ya0luUHJvZ3Jlc3MgJiYgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzcykgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICB2YXIgZGVkdXBlS2V5ID0gcmVuZGVyaW5nQ29tcG9uZW50TmFtZTsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQuaGFzKGRlZHVwZUtleSkpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQuYWRkKGRlZHVwZUtleSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNldFN0YXRlQ29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IHVwZGF0ZSBhIGNvbXBvbmVudCAoYCVzYCkgd2hpbGUgcmVuZGVyaW5nIGEgZGlmZmVyZW50IGNvbXBvbmVudCAoYCVzYCkuIFRvIGxvY2F0ZSB0aGUgYmFkIHNldFN0YXRlKCkgY2FsbCBpbnNpZGUgYCVzYCwgZm9sbG93IHRoZSBzdGFjayB0cmFjZSBhcyBkZXNjcmliZWQgaW4gaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NldHN0YXRlLWluLXJlbmRlciIsIHNldFN0YXRlQ29tcG9uZW50TmFtZSwgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSwgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IHVwZGF0ZSBkdXJpbmcgYW4gZXhpc3Rpbmcgc3RhdGUgdHJhbnNpdGlvbiAoc3VjaCBhcyB3aXRoaW4gYHJlbmRlcmApLiBSZW5kZXIgbWV0aG9kcyBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZS4iKTsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmZvckVhY2goZnVuY3Rpb24oc2NoZWR1bGluZ0ZpYmVyKSB7CiAgICAgICAgICAgICAgICBhZGRGaWJlclRvTGFuZXNNYXAocm9vdDMsIHNjaGVkdWxpbmdGaWJlciwgbGFuZXMpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmYWtlQWN0Q2FsbGJhY2tOb2RlID0ge307CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFjayQxKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudDsKICAgICAgICAgICAgaWYgKGFjdFF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWN0UXVldWUucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgICAgcmV0dXJuIGZha2VBY3RDYWxsYmFja05vZGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNjaGVkdWxlQ2FsbGJhY2socHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbmNlbENhbGxiYWNrJDEoY2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2tOb2RlID09PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjYW5jZWxDYWxsYmFjayhjYWxsYmFja05vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgIGlmICghaXNDb25jdXJyZW50QWN0RW52aXJvbm1lbnQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWlzTGVnYWN5QWN0RW52aXJvbm1lbnQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXhlY3V0aW9uQ29udGV4dCAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmaWJlci50YWcgIT09IEZ1bmN0aW9uQ29tcG9uZW50ICYmIGZpYmVyLnRhZyAhPT0gRm9yd2FyZFJlZiAmJiBmaWJlci50YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgdG8gJXMgaW5zaWRlIGEgdGVzdCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IGNhdXNlcyBSZWFjdCBzdGF0ZSB1cGRhdGVzIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpcmUgZXZlbnRzIHRoYXQgdXBkYXRlIHN0YXRlICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdXNwZW5zZVJlc29sdXRpb25Ob3RXcmFwcGVkV2l0aEFjdERFVihyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgc3VzcGVuZGVkIHJlc291cmNlIGZpbmlzaGVkIGxvYWRpbmcgaW5zaWRlIGEgdGVzdCwgYnV0IHRoZSBldmVudCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IHJlc29sdmVzIHN1c3BlbmRlZCBkYXRhIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpbmlzaCBsb2FkaW5nIHN1c3BlbmRlZCBkYXRhICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoaXNSdW5uaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGlzUnVubmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlc29sdmVGYW1pbHkgPSBudWxsOwogICAgICAgIHZhciBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICB2YXIgc2V0UmVmcmVzaEhhbmRsZXIgPSBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc29sdmVGYW1pbHkgPSBoYW5kbGVyOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KHR5cGUpOwogICAgICAgICAgICBpZiAoZmFtaWx5ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAodHlwZSAhPT0gbnVsbCAmJiB0eXBlICE9PSB2b2lkIDAgJiYgdHlwZW9mIHR5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlbmRlciA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgICBpZiAodHlwZS5yZW5kZXIgIT09IGN1cnJlbnRSZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHN5bnRoZXRpY1R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUsCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyOiBjdXJyZW50UmVuZGVyCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlLmRpc3BsYXlOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBzeW50aGV0aWNUeXBlLmRpc3BsYXlOYW1lID0gdHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gc3ludGhldGljVHlwZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoZmliZXIsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZUeXBlID0gZmliZXIuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHZhciBuZXh0VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgdmFyIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gZmFsc2U7CiAgICAgICAgICAgIHZhciAkJHR5cGVvZk5leHRUeXBlID0gdHlwZW9mIG5leHRUeXBlID09PSAib2JqZWN0IiAmJiBuZXh0VHlwZSAhPT0gbnVsbCA/IG5leHRUeXBlLiQkdHlwZW9mIDogbnVsbDsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRUeXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRUeXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6IHsKICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTUVNT19UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc0NvbXBhcmVGYW1pbGllcykgewogICAgICAgICAgICAgIHZhciBwcmV2RmFtaWx5ID0gcmVzb2x2ZUZhbWlseShwcmV2VHlwZSk7CiAgICAgICAgICAgICAgaWYgKHByZXZGYW1pbHkgIT09IHZvaWQgMCAmJiBwcmV2RmFtaWx5ID09PSByZXNvbHZlRmFtaWx5KG5leHRUeXBlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBXZWFrU2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmFpbGVkQm91bmRhcmllcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhaWxlZEJvdW5kYXJpZXMuYWRkKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlUmVmcmVzaCA9IGZ1bmN0aW9uKHJvb3QzLCB1cGRhdGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHN0YWxlRmFtaWxpZXMgPSB1cGRhdGUuc3RhbGVGYW1pbGllcywgdXBkYXRlZEZhbWlsaWVzID0gdXBkYXRlLnVwZGF0ZWRGYW1pbGllczsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBzY2hlZHVsZVJvb3QgPSBmdW5jdGlvbihyb290MywgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocm9vdDMuY29udGV4dCAhPT0gZW1wdHlDb250ZXh0T2JqZWN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihlbGVtZW50LCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShmaWJlciwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGUsIGNoaWxkID0gZmliZXIuY2hpbGQsIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nLCB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICB2YXIgY2FuZGlkYXRlVHlwZSA9IG51bGw7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhbmRpZGF0ZVR5cGUgPSB0eXBlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlc29sdmVGYW1pbHkgdG8gYmUgc2V0IGR1cmluZyBob3QgcmVsb2FkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZWVkc1JlbmRlciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkoY2FuZGlkYXRlVHlwZSk7CiAgICAgICAgICAgICAgaWYgKGZhbWlseSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhbGVGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1cGRhdGVkRmFtaWxpZXMuaGFzKGZhbWlseSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBmaWJlci5fZGVidWdOZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQgfHwgbmVlZHNSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3QgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAoX3Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihfcm9vdCwgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCAmJiAhbmVlZHNSZW1vdW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShjaGlsZCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoc2libGluZywgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIGZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHR5cGVzID0gbmV3IFNldChmYW1pbGllcy5tYXAoZnVuY3Rpb24oZmFtaWx5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIHJldHVybiBob3N0SW5zdGFuY2VzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGZpYmVyLCB0eXBlcywgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGlkTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZXMuaGFzKGNhbmRpZGF0ZVR5cGUpKSB7CiAgICAgICAgICAgICAgICBkaWRNYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRNYXRjaCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGNoaWxkLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHNpYmxpbmcsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmaW5kQ2hpbGRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICBpZiAoZm91bmRIb3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byByZWFjaCByb290IGZpcnN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIGZvdW5kSG9zdEluc3RhbmNlcyA9IHRydWU7CiAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kSG9zdEluc3RhbmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc0JhZE1hcFBvbHlmaWxsOwogICAgICAgIHsKICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gZmFsc2U7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbm9uRXh0ZW5zaWJsZU9iamVjdCA9IE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh7fSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbbm9uRXh0ZW5zaWJsZU9iamVjdCwgbnVsbF1dKTsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW25vbkV4dGVuc2libGVPYmplY3RdKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFzQmFkTWFwUG9seWZpbGwgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgIHRoaXMuZWxlbWVudFR5cGUgPSBudWxsOwogICAgICAgICAgdGhpcy50eXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMucmV0dXJuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2hpbGQgPSBudWxsOwogICAgICAgICAgdGhpcy5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgdGhpcy5yZWYgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICB0aGlzLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgdGhpcy51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB0aGlzLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgdGhpcy5tb2RlID0gbW9kZTsKICAgICAgICAgIHRoaXMuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgdGhpcy5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnNlbGZCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnRyZWVCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZGVidWdTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdOZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fZGVidWdIb29rVHlwZXMgPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc0JhZE1hcFBvbHlmaWxsICYmIHR5cGVvZiBPYmplY3QucHJldmVudEV4dGVuc2lvbnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBPYmplY3QucHJldmVudEV4dGVuc2lvbnModGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUZpYmVyID0gZnVuY3Rpb24odGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2ltcGxlRnVuY3Rpb25Db21wb25lbnQodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iICYmICFzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSAmJiB0eXBlLmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpID8gQ2xhc3NDb21wb25lbnQgOiBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoQ29tcG9uZW50ICE9PSB2b2lkIDAgJiYgQ29tcG9uZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciAkJHR5cGVvZiA9IENvbXBvbmVudC4kJHR5cGVvZjsKICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIEZvcndhcmRSZWY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUpIHsKICAgICAgICAgICAgICByZXR1cm4gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSBjdXJyZW50Mi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiA9IGNyZWF0ZUZpYmVyKGN1cnJlbnQyLnRhZywgcGVuZGluZ1Byb3BzLCBjdXJyZW50Mi5rZXksIGN1cnJlbnQyLm1vZGUpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPSBjdXJyZW50Mi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50Mi50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3VycmVudDIuc3RhdGVOb2RlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZSA9IGN1cnJlbnQyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgPSBjdXJyZW50Mi5fZGVidWdPd25lcjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gY3VycmVudDIuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBjdXJyZW50MjsKICAgICAgICAgICAgY3VycmVudDIuYWx0ZXJuYXRlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50Mi50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gY3VycmVudDIuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50Mi5jaGlsZExhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDIubGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnREZXBlbmRlbmNpZXMgPSBjdXJyZW50Mi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICBmaXJzdENvbnRleHQ6IGN1cnJlbnREZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNpYmxpbmcgPSBjdXJyZW50Mi5zaWJsaW5nOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmluZGV4ID0gY3VycmVudDIuaW5kZXg7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucmVmID0gY3VycmVudDIucmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnQyLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IGN1cnJlbnQyLl9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcoY3VycmVudDIudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcoY3VycmVudDIudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWY6CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQyLnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0V29ya0luUHJvZ3Jlc3Mod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSBTdGF0aWNNYXNrIHwgUGxhY2VtZW50OwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50MiA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IGN1cnJlbnQyLmNoaWxkTGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQyLmxhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50Mi5jaGlsZDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gY3VycmVudDIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY3VycmVudDIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDIudHlwZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnREZXBlbmRlbmNpZXMgPSBjdXJyZW50Mi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBjdXJyZW50RGVwZW5kZW5jaWVzID09PSBudWxsID8gbnVsbCA6IHsKICAgICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgICBmaXJzdENvbnRleHQ6IGN1cnJlbnREZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnQyLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gPSBjdXJyZW50Mi50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVIb3N0Um9vdEZpYmVyKHRhZywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlKSB7CiAgICAgICAgICB2YXIgbW9kZTsKICAgICAgICAgIGlmICh0YWcgPT09IENvbmN1cnJlbnRSb290KSB7CiAgICAgICAgICAgIG1vZGUgPSBDb25jdXJyZW50TW9kZTsKICAgICAgICAgICAgaWYgKGlzU3RyaWN0TW9kZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0TGVnYWN5TW9kZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbW9kZSA9IE5vTW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICBtb2RlIHw9IFByb2ZpbGVNb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyKEhvc3RSb290LCBudWxsLCBudWxsLCBtb2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBmaWJlclRhZyA9IEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRUeXBlID0gdHlwZTsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpZiAoc2hvdWxkQ29uc3RydWN0JDEodHlwZSkpIHsKICAgICAgICAgICAgICBmaWJlclRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcocmVzb2x2ZWRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGZpYmVyVGFnID0gSG9zdENvbXBvbmVudDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGdldFRhZzogc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GUkFHTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KHBlbmRpbmdQcm9wcy5jaGlsZHJlbiwgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgICAgZmliZXJUYWcgPSBNb2RlOwogICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RFZmZlY3RzTW9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZShwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlTGlzdChwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfT0ZGU0NSRUVOX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tT2Zmc2NyZWVuKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TQ09QRV9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ0FDSEVfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1RSQUNJTkdfTUFSS0VSX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9ERUJVR19UUkFDSU5HX01PREVfVFlQRToKICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9WSURFUl9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IENvbnRleHRDb25zdW1lcjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IEZvcndhcmRSZWY7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IExhenlDb21wb25lbnQ7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpbmZvMiArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBvd25lciA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGluZm8yICs9ICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgdHlwZSBpcyBpbnZhbGlkOiBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgIiArICgiYnV0IGdvdDogIiArICh0eXBlID09IG51bGwgPyB0eXBlIDogdHlwZW9mIHR5cGUpICsgIi4iICsgaW5mbzIpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKGZpYmVyVGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IHR5cGU7CiAgICAgICAgICBmaWJlci50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBvd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIG93bmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IGVsZW1lbnQucHJvcHM7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEZyYWdtZW50MiwgZWxlbWVudHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1Byb2ZpbGVyIG11c3Qgc3BlY2lmeSBhbiAiaWQiIG9mIHR5cGUgYHN0cmluZ2AgYXMgYSBwcm9wLiBSZWNlaXZlZCB0aGUgdHlwZSBgJXNgIGluc3RlYWQuJywgdHlwZW9mIHBlbmRpbmdQcm9wcy5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFByb2ZpbGVyLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSB8IFByb2ZpbGVNb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgICBlZmZlY3REdXJhdGlvbjogMCwKICAgICAgICAgICAgICBwYXNzaXZlRWZmZWN0RHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VMaXN0Q29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKE9mZnNjcmVlbkNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9PRkZTQ1JFRU5fVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkSW5zdGFuY2UgPSB7CiAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHByaW1hcnlDaGlsZEluc3RhbmNlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UZXh0KGNvbnRlbnQsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0VGV4dCwgY29udGVudCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9ICJERUxFVEVEIjsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KGRlaHlkcmF0ZWROb2RlKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihEZWh5ZHJhdGVkRnJhZ21lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBkZWh5ZHJhdGVkTm9kZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RQb3J0YWwsIHBlbmRpbmdQcm9wcywgcG9ydGFsLmtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICBjb250YWluZXJJbmZvOiBwb3J0YWwuY29udGFpbmVySW5mbywKICAgICAgICAgICAgcGVuZGluZ0NoaWxkcmVuOiBudWxsLAogICAgICAgICAgICAvLyBVc2VkIGJ5IHBlcnNpc3RlbnQgdXBkYXRlcwogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogcG9ydGFsLmltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgaWYgKHRhcmdldCA9PT0gbnVsbCkgewogICAgICAgICAgICB0YXJnZXQgPSBjcmVhdGVGaWJlcihJbmRldGVybWluYXRlQ29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0LnRhZyA9IHNvdXJjZS50YWc7CiAgICAgICAgICB0YXJnZXQua2V5ID0gc291cmNlLmtleTsKICAgICAgICAgIHRhcmdldC5lbGVtZW50VHlwZSA9IHNvdXJjZS5lbGVtZW50VHlwZTsKICAgICAgICAgIHRhcmdldC50eXBlID0gc291cmNlLnR5cGU7CiAgICAgICAgICB0YXJnZXQuc3RhdGVOb2RlID0gc291cmNlLnN0YXRlTm9kZTsKICAgICAgICAgIHRhcmdldC5yZXR1cm4gPSBzb3VyY2UucmV0dXJuOwogICAgICAgICAgdGFyZ2V0LmNoaWxkID0gc291cmNlLmNoaWxkOwogICAgICAgICAgdGFyZ2V0LnNpYmxpbmcgPSBzb3VyY2Uuc2libGluZzsKICAgICAgICAgIHRhcmdldC5pbmRleCA9IHNvdXJjZS5pbmRleDsKICAgICAgICAgIHRhcmdldC5yZWYgPSBzb3VyY2UucmVmOwogICAgICAgICAgdGFyZ2V0LnBlbmRpbmdQcm9wcyA9IHNvdXJjZS5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRQcm9wcyA9IHNvdXJjZS5tZW1vaXplZFByb3BzOwogICAgICAgICAgdGFyZ2V0LnVwZGF0ZVF1ZXVlID0gc291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkU3RhdGUgPSBzb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHRhcmdldC5kZXBlbmRlbmNpZXMgPSBzb3VyY2UuZGVwZW5kZW5jaWVzOwogICAgICAgICAgdGFyZ2V0Lm1vZGUgPSBzb3VyY2UubW9kZTsKICAgICAgICAgIHRhcmdldC5mbGFncyA9IHNvdXJjZS5mbGFnczsKICAgICAgICAgIHRhcmdldC5zdWJ0cmVlRmxhZ3MgPSBzb3VyY2Uuc3VidHJlZUZsYWdzOwogICAgICAgICAgdGFyZ2V0LmRlbGV0aW9ucyA9IHNvdXJjZS5kZWxldGlvbnM7CiAgICAgICAgICB0YXJnZXQubGFuZXMgPSBzb3VyY2UubGFuZXM7CiAgICAgICAgICB0YXJnZXQuY2hpbGRMYW5lcyA9IHNvdXJjZS5jaGlsZExhbmVzOwogICAgICAgICAgdGFyZ2V0LmFsdGVybmF0ZSA9IHNvdXJjZS5hbHRlcm5hdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxEdXJhdGlvbiA9IHNvdXJjZS5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbFN0YXJ0VGltZSA9IHNvdXJjZS5hY3R1YWxTdGFydFRpbWU7CiAgICAgICAgICAgIHRhcmdldC5zZWxmQmFzZUR1cmF0aW9uID0gc291cmNlLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC50cmVlQmFzZUR1cmF0aW9uID0gc291cmNlLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQuX2RlYnVnU291cmNlID0gc291cmNlLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHRhcmdldC5fZGVidWdPd25lciA9IHNvdXJjZS5fZGVidWdPd25lcjsKICAgICAgICAgIHRhcmdldC5fZGVidWdOZWVkc1JlbW91bnQgPSBzb3VyY2UuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z0hvb2tUeXBlcyA9IHNvdXJjZS5fZGVidWdIb29rVHlwZXM7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lckluZm8gPSBjb250YWluZXJJbmZvOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgdGhpcy5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGluZ0NhY2hlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHRoaXMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHRoaXMuZXZlbnRUaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmV4cGlyYXRpb25UaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9UaW1lc3RhbXApOwogICAgICAgICAgdGhpcy5wZW5kaW5nTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZXhwaXJlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMubXV0YWJsZVJlYWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlbWVudHMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5pZGVudGlmaWVyUHJlZml4ID0gaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHRoaXMub25SZWNvdmVyYWJsZUVycm9yID0gb25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm1lbW9pemVkVXBkYXRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHRoaXMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgVG90YWxMYW5lczsgX2krKykgewogICAgICAgICAgICAgIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAucHVzaCgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgQ29uY3VycmVudFJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZVJvb3QoKSIgOiAiY3JlYXRlUm9vdCgpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTGVnYWN5Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlKCkiIDogInJlbmRlcigpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciByb290MyA9IG5ldyBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB2YXIgdW5pbml0aWFsaXplZEZpYmVyID0gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSk7CiAgICAgICAgICByb290My5jdXJyZW50ID0gdW5pbml0aWFsaXplZEZpYmVyOwogICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IHJvb3QzOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2luaXRpYWxTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBoeWRyYXRlMiwKICAgICAgICAgICAgICBjYWNoZTogbnVsbCwKICAgICAgICAgICAgICAvLyBub3QgZW5hYmxlZCB5ZXQKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbCwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5tZW1vaXplZFN0YXRlID0gX2luaXRpYWxTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh1bmluaXRpYWxpemVkRmliZXIpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsKGNoaWxkcmVuLCBjb250YWluZXJJbmZvLCBpbXBsZW1lbnRhdGlvbikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihrZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3cgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IFBvcnRhbAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfUE9SVEFMX1RZUEUsCiAgICAgICAgICAgIGtleToga2V5ID09IG51bGwgPyBudWxsIDogIiIgKyBrZXksCiAgICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgICBjb250YWluZXJJbmZvLAogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgaWYgKCFwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGdldChwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgQ29tcG9uZW50LCBwYXJlbnRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnQsIG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0KGNvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhjb21wb25lbnQpLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgYXBwZWFycyB0byBub3QgYmUgYSBSZWFjdENvbXBvbmVudC4gS2V5czogIiArIGtleXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhvc3RGaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGhvc3RGaWJlcik7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggaXMgaW5zaWRlIFN0cmljdE1vZGUuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBkZXByZWNhdGVkIGluIFN0cmljdE1vZGUuICVzIHdhcyBwYXNzZWQgYW4gaW5zdGFuY2Ugb2YgJXMgd2hpY2ggcmVuZGVycyBTdHJpY3RNb2RlIGNoaWxkcmVuLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIocHJldmlvdXNGaWJlcik7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGFpbmVyKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaW5pdGlhbENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgY2FsbGJhY2ssIGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvciwgdHJhbnNpdGlvbkNhbGxiYWNrcykgewogICAgICAgICAgdmFyIGh5ZHJhdGUyID0gdHJ1ZTsKICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgcm9vdDMuY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKG51bGwpOwogICAgICAgICAgdmFyIGN1cnJlbnQyID0gcm9vdDMuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwgPyBjYWxsYmFjayA6IG51bGw7CiAgICAgICAgICBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgY29udGFpbmVyMiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBvblNjaGVkdWxlUm9vdChjb250YWluZXIyLCBlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50JDEgPSBjb250YWluZXIyLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50JDEpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuY29udGV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb250YWluZXIyLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wZW5kaW5nQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiBjdXJyZW50ICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyB0cmlnZ2VyaW5nIG5lc3RlZCBjb21wb25lbnQgdXBkYXRlcyBmcm9tIHJlbmRlciBpcyBub3QgYWxsb3dlZC4gSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIG5lc3RlZCB1cGRhdGVzIGluIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50KSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgfTsKICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQkMSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgY3VycmVudCQxLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNSb290SW5zdGFuY2UoY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGNvbnRhaW5lckZpYmVyID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgaWYgKCFjb250YWluZXJGaWJlci5jaGlsZCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoY29udGFpbmVyRmliZXIuY2hpbGQudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgIHZhciBsYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290Myk7CiAgICAgICAgICAgICAgICBmbHVzaFJvb3Qocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByb290NCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgaWYgKHJvb3Q0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290NCwgZmliZXIsIFN5bmNMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBTeW5jTGFuZTsKICAgICAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCAmJiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBoaWdoZXJQcmlvcml0eUxhbmUoc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUpIHsKICAgICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoYWx0ZXJuYXRlLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHMoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkRXJyb3JJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRXJyb3IoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRFcnJvckltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkU3VzcGVuZEltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU3VzcGVuZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZFN1c3BlbmRJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wcyA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBzY2hlZHVsZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIHNldEVycm9ySGFuZGxlciA9IG51bGw7CiAgICAgICAgdmFyIHNldFN1c3BlbnNlSGFuZGxlciA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlSW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgaW5kZXgyKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBwYXRoW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24oe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBwYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5KHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShrZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aERlbGV0ZUltcGwob2JqW2tleV0sIHBhdGgsIGluZGV4MiArIDEpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhEZWxldGUgPSBmdW5jdGlvbihvYmosIHBhdGgpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoRGVsZXRlSW1wbChvYmosIHBhdGgsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZUltcGwgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgsIGluZGV4MikgewogICAgICAgICAgICB2YXIgb2xkS2V5ID0gb2xkUGF0aFtpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gb2xkUGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbmV3S2V5ID0gbmV3UGF0aFtpbmRleDJdOwogICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICBpZiAoaXNBcnJheSh1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uob2xkS2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlZFtvbGRLZXldID0gY29weVdpdGhSZW5hbWVJbXBsKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBudW1iZXIgb3Igc3RyaW5nIGlzIGZpbmUgaGVyZQogICAgICAgICAgICAgICAgb2JqW29sZEtleV0sCiAgICAgICAgICAgICAgICBvbGRQYXRoLAogICAgICAgICAgICAgICAgbmV3UGF0aCwKICAgICAgICAgICAgICAgIGluZGV4MiArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZSA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBpZiAob2xkUGF0aC5sZW5ndGggIT09IG5ld1BhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgd2FybjIoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyBvZiB0aGUgc2FtZSBsZW5ndGgiKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdQYXRoLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG9sZFBhdGhbaV0gIT09IG5ld1BhdGhbaV0pIHsKICAgICAgICAgICAgICAgICAgd2FybjIoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyB0byBiZSB0aGUgc2FtZSBleGNlcHQgZm9yIHRoZSBkZWVwZXN0IGtleSIpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFJlbmFtZUltcGwob2JqLCBvbGRQYXRoLCBuZXdQYXRoLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXRJbXBsID0gZnVuY3Rpb24ob2JqLCBwYXRoLCBpbmRleDIsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChpbmRleDIgPj0gcGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IHBhdGhbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbih7fSwgb2JqKTsKICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhTZXRJbXBsKG9ialtrZXldLCBwYXRoLCBpbmRleDIgKyAxLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFNldCA9IGZ1bmN0aW9uKG9iaiwgcGF0aCwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoU2V0SW1wbChvYmosIHBhdGgsIDAsIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEhvb2sgPSBmdW5jdGlvbihmaWJlciwgaWQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb29rMiA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50SG9vazIgIT09IG51bGwgJiYgaWQgPiAwKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2syID0gY3VycmVudEhvb2syLm5leHQ7CiAgICAgICAgICAgICAgaWQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY3VycmVudEhvb2syOwogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhTZXQoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aERlbGV0ZShob29rLm1lbW9pemVkU3RhdGUsIHBhdGgpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhSZW5hbWUoaG9vay5tZW1vaXplZFN0YXRlLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24oe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzID0gZnVuY3Rpb24oZmliZXIsIHBhdGgsIHZhbHVlKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoU2V0KGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoRGVsZXRlKGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoID0gZnVuY3Rpb24oZmliZXIsIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhSZW5hbWUoZmliZXIubWVtb2l6ZWRQcm9wcywgb2xkUGF0aCwgbmV3UGF0aCk7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2NoZWR1bGVVcGRhdGUgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNldEVycm9ySGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZEVycm9ySW1wbCkgewogICAgICAgICAgICBzaG91bGRFcnJvckltcGwgPSBuZXdTaG91bGRFcnJvckltcGw7CiAgICAgICAgICB9OwogICAgICAgICAgc2V0U3VzcGVuc2VIYW5kbGVyID0gZnVuY3Rpb24obmV3U2hvdWxkU3VzcGVuZEltcGwpIHsKICAgICAgICAgICAgc2hvdWxkU3VzcGVuZEltcGwgPSBuZXdTaG91bGRTdXNwZW5kSW1wbDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbXB0eUZpbmRGaWJlckJ5SG9zdEluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyRm9yRGV2VG9vbHMoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0SW50b0RldlRvb2xzKGRldlRvb2xzQ29uZmlnKSB7CiAgICAgICAgICB2YXIgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgPSBkZXZUb29sc0NvbmZpZy5maW5kRmliZXJCeUhvc3RJbnN0YW5jZTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICByZXR1cm4gaW5qZWN0SW50ZXJuYWxzKHsKICAgICAgICAgICAgYnVuZGxlVHlwZTogZGV2VG9vbHNDb25maWcuYnVuZGxlVHlwZSwKICAgICAgICAgICAgdmVyc2lvbjogZGV2VG9vbHNDb25maWcudmVyc2lvbiwKICAgICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogZGV2VG9vbHNDb25maWcucmVuZGVyZXJQYWNrYWdlTmFtZSwKICAgICAgICAgICAgcmVuZGVyZXJDb25maWc6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyQ29uZmlnLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHMsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCwKICAgICAgICAgICAgc2V0RXJyb3JIYW5kbGVyLAogICAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIsCiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlLAogICAgICAgICAgICBjdXJyZW50RGlzcGF0Y2hlclJlZjogUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIsCiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyLAogICAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgfHwgZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZSwKICAgICAgICAgICAgLy8gUmVhY3QgUmVmcmVzaAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUmVmcmVzaCwKICAgICAgICAgICAgc2NoZWR1bGVSb290LAogICAgICAgICAgICBzZXRSZWZyZXNoSGFuZGxlciwKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBhcHBlbmQgb3duZXIgc3RhY2tzIHRvIGVycm9yIG1lc3NhZ2VzIGluIERFViBtb2RlLgogICAgICAgICAgICBnZXRDdXJyZW50RmliZXI6IGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzLAogICAgICAgICAgICAvLyBFbmFibGVzIERldlRvb2xzIHRvIGRldGVjdCByZWNvbmNpbGVyIHZlcnNpb24gcmF0aGVyIHRoYW4gcmVuZGVyZXIgdmVyc2lvbgogICAgICAgICAgICAvLyB3aGljaCBtYXkgbm90IG1hdGNoIGZvciB0aGlyZCBwYXJ0eSByZW5kZXJlcnMuCiAgICAgICAgICAgIHJlY29uY2lsZXJWZXJzaW9uOiBSZWFjdFZlcnNpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvciA9IHR5cGVvZiByZXBvcnRFcnJvciA9PT0gImZ1bmN0aW9uIiA/ICgKICAgICAgICAgIC8vIEluIG1vZGVybiBicm93c2VycywgcmVwb3J0RXJyb3Igd2lsbCBkaXNwYXRjaCBhbiBlcnJvciBldmVudCwKICAgICAgICAgIC8vIGVtdWxhdGluZyBhbiB1bmNhdWdodCBKYXZhU2NyaXB0IGVycm9yLgogICAgICAgICAgcmVwb3J0RXJyb3IKICAgICAgICApIDogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBSZWFjdERPTVJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUucmVuZGVyID0gUmVhY3RET01Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVwZGF0ZSBhbiB1bm1vdW50ZWQgcm9vdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IGRvZXMgbm90IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZENvbnRhaW5lcihhcmd1bWVudHNbMV0pKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBjb250YWluZXIgdG8gdGhlIHNlY29uZCBhcmd1bWVudCBvZiByb290LnJlbmRlciguLi4pLiBZb3UgZG9uJ3QgbmVlZCB0byBwYXNzIGl0IGFnYWluIHNpbmNlIHlvdSBhbHJlYWR5IHBhc3NlZCBpdCB0byBjcmVhdGUgdGhlIHJvb3QuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIHNlY29uZCBhcmd1bWVudCB0byByb290LnJlbmRlciguLi4pIGJ1dCBpdCBvbmx5IGFjY2VwdHMgb25lIGFyZ3VtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhyb290My5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlLnBhcmVudE5vZGUgIT09IGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoZSByb290IGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIHJvb3QudW5tb3VudCgpIHRvIGVtcHR5IGEgcm9vdCdzIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbiwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgIH07CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bm1vdW50ID0gUmVhY3RET01Sb290LnByb3RvdHlwZS51bm1vdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnQoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCBhIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkF0dGVtcHRlZCB0byBzeW5jaHJvbm91c2x5IHVubW91bnQgYSByb290IHdoaWxlIFJlYWN0IHdhcyBhbHJlYWR5IHJlbmRlcmluZy4gUmVhY3QgY2Fubm90IGZpbmlzaCB1bm1vdW50aW5nIHRoZSByb290IHVudGlsIHRoZSBjdXJyZW50IHJlbmRlciBoYXMgY29tcGxldGVkLCB3aGljaCBtYXkgbGVhZCB0byBhIHJhY2UgY29uZGl0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKG51bGwsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjcmVhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpOwogICAgICAgICAgdmFyIGlzU3RyaWN0TW9kZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gbnVsbDsKICAgICAgICAgIGlmIChvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczIuaHlkcmF0ZSkgewogICAgICAgICAgICAgICAgd2FybjIoImh5ZHJhdGUgdGhyb3VnaCBjcmVhdGVSb290IGlzIGRlcHJlY2F0ZWQuIFVzZSBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uczIgPT09ICJvYmplY3QiICYmIG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBKU1ggZWxlbWVudCB0byBjcmVhdGVSb290LiBZb3UgcHJvYmFibHkgbWVhbnQgdG8gY2FsbCByb290LnJlbmRlciBpbnN0ZWFkLiBFeGFtcGxlIHVzYWdlOlxuXG4gIGxldCByb290ID0gY3JlYXRlUm9vdChkb21Db250YWluZXIpO1xuICByb290LnJlbmRlcig8QXBwIC8+KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyYW5zaXRpb25DYWxsYmFja3MgPSBvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVDb250YWluZXIoY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIG51bGwsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTVJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5zdGFibGVfc2NoZWR1bGVIeWRyYXRpb24gPSBzY2hlZHVsZUh5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoeWRyYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoIk11c3QgcHJvdmlkZSBpbml0aWFsIGNoaWxkcmVuIGFzIHNlY29uZCBhcmd1bWVudCB0byBoeWRyYXRlUm9vdC4gRXhhbXBsZSB1c2FnZTogaHlkcmF0ZVJvb3QoZG9tQ29udGFpbmVyLCA8QXBwIC8+KSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIgIT0gbnVsbCA/IG9wdGlvbnMyIDogbnVsbDsKICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlcyA9IG9wdGlvbnMyICE9IG51bGwgJiYgb3B0aW9uczIuaHlkcmF0ZWRTb3VyY2VzIHx8IG51bGw7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhjb250YWluZXIyKTsKICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG11dGFibGVTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSBtdXRhYmxlU291cmNlc1tpXTsKICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gcGFzc2VkIHRvIGNyZWF0ZVJvb3QoKSBiZWZvcmUuIEluc3RlYWQsIGNhbGwgcm9vdC5yZW5kZXIoKSBvbiB0aGUgZXhpc3Rpbmcgcm9vdCBpbnN0ZWFkIGlmIHlvdSB3YW50IHRvIHVwZGF0ZSBpdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgdG9wTGV2ZWxVcGRhdGVXYXJuaW5nczsKICAgICAgICB7CiAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzID0gZnVuY3Rpb24oY29udGFpbmVyMikgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyICYmIGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGlzIGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUgdG8gZW1wdHkgYSBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKHJvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCkpOwogICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQgJiYgIWlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKCFjb250YWluZXIyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcE9uUmVjb3ZlcmFibGVFcnJvcigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgaWYgKGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcigKICAgICAgICAgICAgICBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoKTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3RTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIyLmxhc3RDaGlsZCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKF9yb290KTsKICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3QoX3Jvb3QuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhfcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIF9yb290OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgdHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4sIGNvbnRhaW5lcjIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyhjb250YWluZXIyKTsKICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjaywgInJlbmRlciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIHZhciByb290MzsKICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgIHJvb3QzID0gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGZvcmNlSHlkcmF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluZERPTU5vZGUoY29tcG9uZW50T3JFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZERPTU5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoImZpbmRET01Ob2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lciQzLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyOwogICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50Lm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5oeWRyYXRlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIGh5ZHJhdGVSb290KGNvbnRhaW5lciwgZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcihlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00ucmVuZGVyIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBjcmVhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlcigpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnJlbmRlcihlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCA9PSBudWxsIHx8ICFoYXMocGFyZW50Q29tcG9uZW50KSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBhcmVudENvbXBvbmVudCBtdXN0IGJlIGEgdmFsaWQgUmVhY3QgQ29tcG9uZW50Iik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gU3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSS4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QudW5tb3VudCgpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QgPSByb290RWwgJiYgIWdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKTsKICAgICAgICAgICAgICBpZiAocmVuZGVyZWRCeURpZmZlcmVudFJlYWN0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBhbm90aGVyIGNvcHkgb2YgUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBudWxsLCBjb250YWluZXIyLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBudWxsOwogICAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9yb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEoX3Jvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKF9yb290RWwpKTsKICAgICAgICAgICAgICB2YXIgaXNDb250YWluZXJSZWFjdFJvb3QgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyLnBhcmVudE5vZGUpICYmICEhY29udGFpbmVyMi5wYXJlbnROb2RlLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBSZWFjdCBhbmQgaXMgbm90IGEgdG9wLWxldmVsIGNvbnRhaW5lci4gJXMiLCBpc0NvbnRhaW5lclJlYWN0Um9vdCA/ICJZb3UgbWF5IGhhdmUgYWNjaWRlbnRhbGx5IHBhc3NlZCBpbiBhIFJlYWN0IHJvb3Qgbm9kZSBpbnN0ZWFkIG9mIGl0cyBjb250YWluZXIuIiA6ICJJbnN0ZWFkLCBoYXZlIHRoZSBwYXJlbnQgY29tcG9uZW50IHVwZGF0ZSBpdHMgc3RhdGUgYW5kIHJlcmVuZGVyIGluIG9yZGVyIHRvIHJlbW92ZSB0aGlzIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMSk7CiAgICAgICAgc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocnVuV2l0aFByaW9yaXR5KTsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIE1hcCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIE1hcCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBNYXAucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIE1hcC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0ICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgU2V0IGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIFNldC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5jbGVhciAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkZXBlbmRzIG9uIE1hcCBhbmQgU2V0IGJ1aWx0LWluIHR5cGVzLiBNYWtlIHN1cmUgdGhhdCB5b3UgbG9hZCBhIHBvbHlmaWxsIGluIG9sZGVyIGJyb3dzZXJzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtcG9seWZpbGxzIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihyZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMpOwogICAgICAgIHNldEJhdGNoaW5nSW1wbGVtZW50YXRpb24oYmF0Y2hlZFVwZGF0ZXMkMSwgZGlzY3JldGVVcGRhdGVzLCBmbHVzaFN5bmMpOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbCQxKGNoaWxkcmVuLCBjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVQb3J0YWwoY2hpbGRyZW4sIGNvbnRhaW5lcjIsIG51bGwsIGtleSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIEludGVybmFscyA9IHsKICAgICAgICAgIHVzaW5nQ2xpZW50RW50cnlQb2ludDogZmFsc2UsCiAgICAgICAgICAvLyBLZWVwIGluIHN5bmMgd2l0aCBSZWFjdFRlc3RVdGlscy5qcy4KICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgZm9yIGJldHRlciBtaW5pZmljYXRpb24uCiAgICAgICAgICBFdmVudHM6IFtnZXRJbnN0YW5jZUZyb21Ob2RlLCBnZXROb2RlRnJvbUluc3RhbmNlLCBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlLCBlbnF1ZXVlU3RhdGVSZXN0b3JlLCByZXN0b3JlU3RhdGVJZk5lZWRlZCwgYmF0Y2hlZFVwZGF0ZXMkMV0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QkMShjb250YWluZXIyLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBjcmVhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVJvb3QkMShjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGh5ZHJhdGVSb290IGZyb20gInJlYWN0LWRvbSIgd2hpY2ggaXMgbm90IHN1cHBvcnRlZC4gWW91IHNob3VsZCBpbnN0ZWFkIGltcG9ydCBpdCBmcm9tICJyZWFjdC1kb20vY2xpZW50Ii4nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMkMShmbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNBbHJlYWR5UmVuZGVyaW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiZmx1c2hTeW5jIHdhcyBjYWxsZWQgZnJvbSBpbnNpZGUgYSBsaWZlY3ljbGUgbWV0aG9kLiBSZWFjdCBjYW5ub3QgZmx1c2ggd2hlbiBSZWFjdCBpcyBhbHJlYWR5IHJlbmRlcmluZy4gQ29uc2lkZXIgbW92aW5nIHRoaXMgY2FsbCB0byBhIHNjaGVkdWxlciB0YXNrIG9yIG1pY3JvIHRhc2suIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmbHVzaFN5bmMoZm4pOwogICAgICAgIH0KICAgICAgICB2YXIgZm91bmREZXZUb29scyA9IGluamVjdEludG9EZXZUb29scyh7CiAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUsCiAgICAgICAgICBidW5kbGVUeXBlOiAxLAogICAgICAgICAgdmVyc2lvbjogUmVhY3RWZXJzaW9uLAogICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogInJlYWN0LWRvbSIKICAgICAgICB9KTsKICAgICAgICB7CiAgICAgICAgICBpZiAoIWZvdW5kRGV2VG9vbHMgJiYgY2FuVXNlRE9NICYmIHdpbmRvdy50b3AgPT09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpID4gLTEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJFZGdlIikgPT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpIHsKICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgaWYgKC9eKGh0dHBzP3xmaWxlKTokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCIlY0Rvd25sb2FkIHRoZSBSZWFjdCBEZXZUb29scyBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIiArIChwcm90b2NvbCA9PT0gImZpbGU6IiA/ICJcbllvdSBtaWdodCBuZWVkIHRvIHVzZSBhIGxvY2FsIEhUVFAgc2VydmVyIChpbnN0ZWFkIG9mIGZpbGU6Ly8pOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMtZmFxIiA6ICIiKSwgImZvbnQtd2VpZ2h0OmJvbGQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IEludGVybmFsczsKICAgICAgICBleHBvcnRzLmNyZWF0ZVBvcnRhbCA9IGNyZWF0ZVBvcnRhbCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLmZpbmRET01Ob2RlID0gZmluZERPTU5vZGU7CiAgICAgICAgZXhwb3J0cy5mbHVzaFN5bmMgPSBmbHVzaFN5bmMkMTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBoeWRyYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9iYXRjaGVkVXBkYXRlcyA9IGJhdGNoZWRVcGRhdGVzJDE7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciA9IHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMKdmFyIHJlcXVpcmVfcmVhY3RfZG9tID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGNoZWNrRENFKCk7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMKdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2xpZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgbSA9IHJlcXVpcmVfcmVhY3RfZG9tKCk7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gbS5jcmVhdGVSb290OwogICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gbS5oeWRyYXRlUm9vdDsKICAgIH0gZWxzZSB7CiAgICAgIGkgPSBtLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBmdW5jdGlvbihjLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5jcmVhdGVSb290KGMsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGZ1bmN0aW9uKGMsIGgsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmh5ZHJhdGVSb290KGMsIGgsIG8pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHZhciBpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgdmFyIFJlYWN0MyA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gUmVhY3QzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdCkgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0LCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdCArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGdldFdyYXBwZWROYW1lKHR5cGUsIHR5cGUucmVuZGVyLCAiRm9yd2FyZFJlZiIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24gPSBPYmplY3QuYXNzaWduOwogICAgICAgIHZhciBkaXNhYmxlZERlcHRoID0gMDsKICAgICAgICB2YXIgcHJldkxvZzsKICAgICAgICB2YXIgcHJldkluZm87CiAgICAgICAgdmFyIHByZXZXYXJuOwogICAgICAgIHZhciBwcmV2RXJyb3I7CiAgICAgICAgdmFyIHByZXZHcm91cDsKICAgICAgICB2YXIgcHJldkdyb3VwQ29sbGFwc2VkOwogICAgICAgIHZhciBwcmV2R3JvdXBFbmQ7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZWRMb2coKSB7CiAgICAgICAgfQogICAgICAgIGRpc2FibGVkTG9nLl9fcmVhY3REaXNhYmxlZExvZyA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gZGlzYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgcHJldkxvZyA9IGNvbnNvbGUubG9nOwogICAgICAgICAgICAgIHByZXZJbmZvID0gY29uc29sZS5pbmZvOwogICAgICAgICAgICAgIHByZXZXYXJuID0gY29uc29sZS53YXJuOwogICAgICAgICAgICAgIHByZXZFcnJvciA9IGNvbnNvbGUuZXJyb3I7CiAgICAgICAgICAgICAgcHJldkdyb3VwID0gY29uc29sZS5ncm91cDsKICAgICAgICAgICAgICBwcmV2R3JvdXBDb2xsYXBzZWQgPSBjb25zb2xlLmdyb3VwQ29sbGFwc2VkOwogICAgICAgICAgICAgIHByZXZHcm91cEVuZCA9IGNvbnNvbGUuZ3JvdXBFbmQ7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkaXNhYmxlZExvZywKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBpbmZvOiBwcm9wcywKICAgICAgICAgICAgICAgIGxvZzogcHJvcHMsCiAgICAgICAgICAgICAgICB3YXJuOiBwcm9wcywKICAgICAgICAgICAgICAgIGVycm9yOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBwcm9wcywKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBwcm9wcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbmFibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBkaXNhYmxlZERlcHRoLS07CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BzID0gewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjb25zb2xlLCB7CiAgICAgICAgICAgICAgICBsb2c6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldldhcm4KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24oe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2R3JvdXBDb2xsYXBzZWQKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IGFzc2lnbih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4LnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIGRpc2FibGVMb2dzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgdmFyIEZha2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRmFrZS5wcm90b3R5cGUsICJwcm9wcyIsIHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAib2JqZWN0IiAmJiBSZWZsZWN0LmNvbnN0cnVjdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgUmVmbGVjdC5jb25zdHJ1Y3QoRmFrZSwgW10pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeCkgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoc2FtcGxlKSB7CiAgICAgICAgICAgIGlmIChzYW1wbGUgJiYgY29udHJvbCAmJiB0eXBlb2Ygc2FtcGxlLnN0YWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHZhciBzYW1wbGVMaW5lcyA9IHNhbXBsZS5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgY29udHJvbExpbmVzID0gY29udHJvbC5zdGFjay5zcGxpdCgiXG4iKTsKICAgICAgICAgICAgICB2YXIgcyA9IHNhbXBsZUxpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgdmFyIGMgPSBjb250cm9sTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCAmJiBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAoOyBzID49IDEgJiYgYyA+PSAwOyBzLS0sIGMtLSkgewogICAgICAgICAgICAgICAgaWYgKHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgaWYgKHMgIT09IDEgfHwgYyAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHMtLTsKICAgICAgICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChjIDwgMCB8fCBzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZnJhbWUgPSAiXG4iICsgc2FtcGxlTGluZXNbc10ucmVwbGFjZSgiIGF0IG5ldyAiLCAiIGF0ICIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4uZGlzcGxheU5hbWUgJiYgX2ZyYW1lLmluY2x1ZGVzKCI8YW5vbnltb3VzPiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2ZyYW1lID0gX2ZyYW1lLnJlcGxhY2UoIjxhbm9ueW1vdXM+IiwgZm4uZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgX2ZyYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mcmFtZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChzID49IDEgJiYgYyA+PSAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4KSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhcyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXI7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bjsKICAgICAgICB2YXIgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd247CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gc2VsZikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSksIGNvbmZpZy5yZWYpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAia2V5IiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGByZWZgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqc3hERVYodHlwZSwgY29uZmlnLCBtYXliZUtleSwgc291cmNlLCBzZWxmKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgICB2YXIgcmVmID0gbnVsbDsKICAgICAgICAgICAgaWYgKG1heWJlS2V5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1heWJlS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBtYXliZUtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZywgc2VsZik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbzIgPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKCFpbmZvMikgewogICAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvMiA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWVsZW1lbnQuX3N0b3JlIHx8IGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCB8fCBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvID0gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKTsKICAgICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgICB2YXIgY2hpbGRPd25lciA9ICIiOwogICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50Ll9vd25lciAmJiBlbGVtZW50Ll9vd25lciAhPT0gUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgY2hpbGRPd25lciA9ICIgSXQgd2FzIHBhc3NlZCBhIGNoaWxkIGZyb20gIiArIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShlbGVtZW50Ll9vd25lci50eXBlKSArICIuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpOwogICAgICAgICAgICBlcnJvcignRWFjaCBjaGlsZCBpbiBhIGxpc3Qgc2hvdWxkIGhhdmUgYSB1bmlxdWUgImtleSIgcHJvcC4lcyVzIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicsIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8sIGNoaWxkT3duZXIpOwogICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUNoaWxkS2V5cyhub2RlLCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoY2hpbGQsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkRWxlbWVudChub2RlKSkgewogICAgICAgICAgICAgIGlmIChub2RlLl9zdG9yZSkgewogICAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZSkgewogICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudChzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRLZXlTcHJlYWQgPSB7fTsKICAgICAgICBmdW5jdGlvbiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBpc1N0YXRpY0NoaWxkcmVuLCBzb3VyY2UsIHNlbGYpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5mbzIgPSAiIjsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgaW5mbzIgKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvMiArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmZvMiArPSBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHR5cGVTdHJpbmc7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAibnVsbCI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHR5cGUpKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgICAgaW5mbzIgPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IGV4cG9ydCBhIEpTWCBsaXRlcmFsIGluc3RlYWQgb2YgYSBjb21wb25lbnQ/IjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9IHR5cGVvZiB0eXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiB0eXBlIGlzIGludmFsaWQgLS0gZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpIGJ1dCBnb3Q6ICVzLiVzIiwgdHlwZVN0cmluZywgaW5mbzIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganN4REVWKHR5cGUsIHByb3BzLCBrZXksIHNvdXJjZSwgc2VsZik7CiAgICAgICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsaWRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlmIChpc1N0YXRpY0NoaWxkcmVuKSB7CiAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuW2ldLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiBTdGF0aWMgY2hpbGRyZW4gc2hvdWxkIGFsd2F5cyBiZSBhbiBhcnJheS4gWW91IGFyZSBsaWtlbHkgZXhwbGljaXRseSBjYWxsaW5nIFJlYWN0LmpzeHMgb3IgUmVhY3QuanN4REVWLiBVc2UgdGhlIEJhYmVsIHRyYW5zZm9ybSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhjaGlsZHJlbiwgdHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChwcm9wcywgImtleSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcHMpLmZpbHRlcihmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBrICE9PSAia2V5IjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIGJlZm9yZUV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAie2tleTogc29tZUtleSwgIiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie2tleTogc29tZUtleX0iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhZnRlckV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAieyIgKyBrZXlzLmpvaW4oIjogLi4uLCAiKSArICI6IC4uLn0iIDogInt9IjsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0EgcHJvcHMgb2JqZWN0IGNvbnRhaW5pbmcgYSAia2V5IiBwcm9wIGlzIGJlaW5nIHNwcmVhZCBpbnRvIEpTWDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyB7Li4ucHJvcHN9IC8+XG5SZWFjdCBrZXlzIG11c3QgYmUgcGFzc2VkIGRpcmVjdGx5IHRvIEpTWCB3aXRob3V0IHVzaW5nIHNwcmVhZDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyBrZXk9e3NvbWVLZXl9IHsuLi5wcm9wc30gLz4nLCBiZWZvcmVFeGFtcGxlLCBjb21wb25lbnROYW1lLCBhZnRlckV4YW1wbGUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljKHR5cGUsIHByb3BzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBqc3hXaXRoVmFsaWRhdGlvbkR5bmFtaWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIganN4MyA9IGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYzsKICAgICAgICB2YXIganN4czMgPSBqc3hXaXRoVmFsaWRhdGlvblN0YXRpYzsKICAgICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgICBleHBvcnRzLmpzeCA9IGpzeDM7CiAgICAgICAgZXhwb3J0cy5qc3hzID0ganN4czM7CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcwp2YXIgcmVxdWlyZV9qc3hfcnVudGltZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvanN4LXJ1bnRpbWUuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9qc3hfcnVudGltZV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9yZWFjdDQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfY2xpZW50ID0gX190b0VTTShyZXF1aXJlX2NsaWVudCgpLCAxKTsKCi8vIHNyYy9KdXN0Q2FuY2VsLnRzeAp2YXIgaW1wb3J0X3JlYWN0MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vc2hhcmVkL3NyYy91dGlscy5qcwp2YXIgdG9LZWJhYkNhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgIiQxLSQyIikudG9Mb3dlckNhc2UoKTsKdmFyIHRvQ2FtZWxDYXNlID0gKHN0cmluZykgPT4gc3RyaW5nLnJlcGxhY2UoCiAgL14oW0EtWl0pfFtccy1fXSsoXHcpL2csCiAgKG1hdGNoLCBwMSwgcDIpID0+IHAyID8gcDIudG9VcHBlckNhc2UoKSA6IHAxLnRvTG93ZXJDYXNlKCkKKTsKdmFyIHRvUGFzY2FsQ2FzZSA9IChzdHJpbmcpID0+IHsKICBjb25zdCBjYW1lbENhc2UgPSB0b0NhbWVsQ2FzZShzdHJpbmcpOwogIHJldHVybiBjYW1lbENhc2UuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBjYW1lbENhc2Uuc2xpY2UoMSk7Cn07CnZhciBtZXJnZUNsYXNzZXMgPSAoLi4uY2xhc3NlcykgPT4gY2xhc3Nlcy5maWx0ZXIoKGNsYXNzTmFtZSwgaW5kZXgsIGFycmF5KSA9PiB7CiAgcmV0dXJuIEJvb2xlYW4oY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUudHJpbSgpICE9PSAiIiAmJiBhcnJheS5pbmRleE9mKGNsYXNzTmFtZSkgPT09IGluZGV4Owp9KS5qb2luKCIgIikudHJpbSgpOwp2YXIgaGFzQTExeVByb3AgPSAocHJvcHMpID0+IHsKICBmb3IgKGNvbnN0IHByb3AgaW4gcHJvcHMpIHsKICAgIGlmIChwcm9wLnN0YXJ0c1dpdGgoImFyaWEtIikgfHwgcHJvcCA9PT0gInJvbGUiIHx8IHByb3AgPT09ICJ0aXRsZSIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzCnZhciBpbXBvcnRfcmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzCnZhciBkZWZhdWx0QXR0cmlidXRlcyA9IHsKICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwKICB3aWR0aDogMjQsCiAgaGVpZ2h0OiAyNCwKICB2aWV3Qm94OiAiMCAwIDI0IDI0IiwKICBmaWxsOiAibm9uZSIsCiAgc3Ryb2tlOiAiY3VycmVudENvbG9yIiwKICBzdHJva2VXaWR0aDogMiwKICBzdHJva2VMaW5lY2FwOiAicm91bmQiLAogIHN0cm9rZUxpbmVqb2luOiAicm91bmQiCn07CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanMKdmFyIEljb24gPSAoMCwgaW1wb3J0X3JlYWN0LmZvcndhcmRSZWYpKAogICh7CiAgICBjb2xvciA9ICJjdXJyZW50Q29sb3IiLAogICAgc2l6ZSA9IDI0LAogICAgc3Ryb2tlV2lkdGggPSAyLAogICAgYWJzb2x1dGVTdHJva2VXaWR0aCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgY2hpbGRyZW4sCiAgICBpY29uTm9kZSwKICAgIC4uLnJlc3QKICB9LCByZWYpID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkoCiAgICAic3ZnIiwKICAgIHsKICAgICAgcmVmLAogICAgICAuLi5kZWZhdWx0QXR0cmlidXRlcywKICAgICAgd2lkdGg6IHNpemUsCiAgICAgIGhlaWdodDogc2l6ZSwKICAgICAgc3Ryb2tlOiBjb2xvciwKICAgICAgc3Ryb2tlV2lkdGg6IGFic29sdXRlU3Ryb2tlV2lkdGggPyBOdW1iZXIoc3Ryb2tlV2lkdGgpICogMjQgLyBOdW1iZXIoc2l6ZSkgOiBzdHJva2VXaWR0aCwKICAgICAgY2xhc3NOYW1lOiBtZXJnZUNsYXNzZXMoImx1Y2lkZSIsIGNsYXNzTmFtZSksCiAgICAgIC4uLiFjaGlsZHJlbiAmJiAhaGFzQTExeVByb3AocmVzdCkgJiYgeyAiYXJpYS1oaWRkZW4iOiAidHJ1ZSIgfSwKICAgICAgLi4ucmVzdAogICAgfSwKICAgIFsKICAgICAgLi4uaWNvbk5vZGUubWFwKChbdGFnLCBhdHRyc10pID0+ICgwLCBpbXBvcnRfcmVhY3QuY3JlYXRlRWxlbWVudCkodGFnLCBhdHRycykpLAogICAgICAuLi5BcnJheS5pc0FycmF5KGNoaWxkcmVuKSA/IGNoaWxkcmVuIDogW2NoaWxkcmVuXQogICAgXQogICkKKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgY3JlYXRlTHVjaWRlSWNvbiA9IChpY29uTmFtZSwgaWNvbk5vZGUpID0+IHsKICBjb25zdCBDb21wb25lbnQgPSAoMCwgaW1wb3J0X3JlYWN0Mi5mb3J3YXJkUmVmKSgKICAgICh7IGNsYXNzTmFtZSwgLi4ucHJvcHMgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0Mi5jcmVhdGVFbGVtZW50KShJY29uLCB7CiAgICAgIHJlZiwKICAgICAgaWNvbk5vZGUsCiAgICAgIGNsYXNzTmFtZTogbWVyZ2VDbGFzc2VzKAogICAgICAgIGBsdWNpZGUtJHt0b0tlYmFiQ2FzZSh0b1Bhc2NhbENhc2UoaWNvbk5hbWUpKX1gLAogICAgICAgIGBsdWNpZGUtJHtpY29uTmFtZX1gLAogICAgICAgIGNsYXNzTmFtZQogICAgICApLAogICAgICAuLi5wcm9wcwogICAgfSkKICApOwogIENvbXBvbmVudC5kaXNwbGF5TmFtZSA9IHRvUGFzY2FsQ2FzZShpY29uTmFtZSk7CiAgcmV0dXJuIENvbXBvbmVudDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctcmlnaHQuanMKdmFyIF9faWNvbk5vZGUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIm0xMiA1IDcgNy03IDciLCBrZXk6ICJ4cXV6NGMiIH1dCl07CnZhciBBcnJvd1JpZ2h0ID0gY3JlYXRlTHVjaWRlSWNvbigiYXJyb3ctcmlnaHQiLCBfX2ljb25Ob2RlKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanMKdmFyIF9faWNvbk5vZGUyID0gW1sicGF0aCIsIHsgZDogIk0yMCA2IDkgMTdsLTUtNSIsIGtleTogIjFnbWYyYyIgfV1dOwp2YXIgQ2hlY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJjaGVjayIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZG9sbGFyLXNpZ24uanMKdmFyIF9faWNvbk5vZGUzID0gWwogIFsibGluZSIsIHsgeDE6ICIxMiIsIHgyOiAiMTIiLCB5MTogIjIiLCB5MjogIjIyIiwga2V5OiAiN2VxeXFoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTcgNUg5LjVhMy41IDMuNSAwIDAgMCAwIDdoNWEzLjUgMy41IDAgMCAxIDAgN0g2Iiwga2V5OiAiMWIwcDRzIiB9XQpdOwp2YXIgRG9sbGFyU2lnbiA9IGNyZWF0ZUx1Y2lkZUljb24oImRvbGxhci1zaWduIiwgX19pY29uTm9kZTMpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9maWxlLXRleHQuanMKdmFyIF9faWNvbk5vZGU0ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDIyYTIgMiAwIDAgMS0yLTJWNGEyIDIgMCAwIDEgMi0yaDhhMi40IDIuNCAwIDAgMSAxLjcwNC43MDZsMy41ODggMy41ODhBMi40IDIuNCAwIDAgMSAyMCA4djEyYTIgMiAwIDAgMS0yIDJ6IiwKICAgICAga2V5OiAiMW9lZmo2IgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTE0IDJ2NWExIDEgMCAwIDAgMSAxaDUiLCBrZXk6ICJ3ZnNncnoiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMCA5SDgiLCBrZXk6ICJiMW1ybHIiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNiAxM0g4Iiwga2V5OiAidDRlMDAyIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTYgMTdIOCIsIGtleTogInoxdWgzYSIgfV0KXTsKdmFyIEZpbGVUZXh0ID0gY3JlYXRlTHVjaWRlSWNvbigiZmlsZS10ZXh0IiwgX19pY29uTm9kZTQpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ob3VzZS5qcwp2YXIgX19pY29uTm9kZTUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE1IDIxdi04YTEgMSAwIDAgMC0xLTFoLTRhMSAxIDAgMCAwLTEgMXY4Iiwga2V5OiAiNXd3bHI1IiB9XSwKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMyAxMGEyIDIgMCAwIDEgLjcwOS0xLjUyOGw3LTZhMiAyIDAgMCAxIDIuNTgyIDBsNyA2QTIgMiAwIDAgMSAyMSAxMHY5YTIgMiAwIDAgMS0yIDJINWEyIDIgMCAwIDEtMi0yeiIsCiAgICAgIGtleTogInI2bnNzMSIKICAgIH0KICBdCl07CnZhciBIb3VzZSA9IGNyZWF0ZUx1Y2lkZUljb24oImhvdXNlIiwgX19pY29uTm9kZTUpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wZW4tbGluZS5qcwp2YXIgX19pY29uTm9kZTYgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEzIDIxaDgiLCBrZXk6ICIxanNuNWkiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMS4xNzQgNi44MTJhMSAxIDAgMCAwLTMuOTg2LTMuOTg3TDMuODQyIDE2LjE3NGEyIDIgMCAwIDAtLjUuODNsLTEuMzIxIDQuMzUyYS41LjUgMCAwIDAgLjYyMy42MjJsNC4zNTMtMS4zMmEyIDIgMCAwIDAgLjgzLS40OTd6IiwKICAgICAga2V5OiAiMWE4dXN1IgogICAgfQogIF0KXTsKdmFyIFBlbkxpbmUgPSBjcmVhdGVMdWNpZGVJY29uKCJwZW4tbGluZSIsIF9faWNvbk5vZGU2KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGx1cy5qcwp2YXIgX19pY29uTm9kZTcgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiA1djE0Iiwga2V5OiAiczY5OWxlIiB9XQpdOwp2YXIgUGx1cyA9IGNyZWF0ZUx1Y2lkZUljb24oInBsdXMiLCBfX2ljb25Ob2RlNyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlZnJlc2gtY3cuanMKdmFyIF9faWNvbk5vZGU4ID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDEyYTkgOSAwIDAgMSA5LTkgOS43NSA5Ljc1IDAgMCAxIDYuNzQgMi43NEwyMSA4Iiwga2V5OiAidjloNXZjIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMjEgM3Y1aC01Iiwga2V5OiAiMXE3dG8wIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMjEgMTJhOSA5IDAgMCAxLTkgOSA5Ljc1IDkuNzUgMCAwIDEtNi43NC0yLjc0TDMgMTYiLCBrZXk6ICIzdWlmbDMiIH1dLAogIFsicGF0aCIsIHsgZDogIk04IDE2SDN2NSIsIGtleTogIjFjdjY3OCIgfV0KXTsKdmFyIFJlZnJlc2hDdyA9IGNyZWF0ZUx1Y2lkZUljb24oInJlZnJlc2gtY3ciLCBfX2ljb25Ob2RlOCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NoaWVsZC5qcwp2YXIgX19pY29uTm9kZTkgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIwIDEzYzAgNS0zLjUgNy41LTcuNjYgOC45NWExIDEgMCAwIDEtLjY3LS4wMUM3LjUgMjAuNSA0IDE4IDQgMTNWNmExIDEgMCAwIDEgMS0xYzIgMCA0LjUtMS4yIDYuMjQtMi43MmExLjE3IDEuMTcgMCAwIDEgMS41MiAwQzE0LjUxIDMuODEgMTcgNSAxOSA1YTEgMSAwIDAgMSAxIDF6IiwKICAgICAga2V5OiAib2VsNDF5IgogICAgfQogIF0KXTsKdmFyIFNoaWVsZCA9IGNyZWF0ZUx1Y2lkZUljb24oInNoaWVsZCIsIF9faWNvbk5vZGU5KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJhc2gtMi5qcwp2YXIgX19pY29uTm9kZTEwID0gWwogIFsicGF0aCIsIHsgZDogIk0xMCAxMXY2Iiwga2V5OiAibmNvMG9tIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTQgMTF2NiIsIGtleTogIm91dHYxdSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTE5IDZ2MTRhMiAyIDAgMCAxLTIgMkg3YTIgMiAwIDAgMS0yLTJWNiIsIGtleTogIm1peXRyYyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgNmgxOCIsIGtleTogImQwd20waiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTggNlY0YTIgMiAwIDAgMSAyLTJoNGEyIDIgMCAwIDEgMiAydjIiLCBrZXk6ICJlNzkxamkiIH1dCl07CnZhciBUcmFzaDIgPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmFzaC0yIiwgX19pY29uTm9kZTEwKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdXBsb2FkLmpzCnZhciBfX2ljb25Ob2RlMTEgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDN2MTIiLCBrZXk6ICIxeDBqNXMiIH1dLAogIFsicGF0aCIsIHsgZDogIm0xNyA4LTUtNS01IDUiLCBrZXk6ICI3cTk3cjgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yMSAxNXY0YTIgMiAwIDAgMS0yIDJINWEyIDIgMCAwIDEtMi0ydi00Iiwga2V5OiAiaWg3bjNoIiB9XQpdOwp2YXIgVXBsb2FkID0gY3JlYXRlTHVjaWRlSWNvbigidXBsb2FkIiwgX19pY29uTm9kZTExKTsKCi8vIG5vZGVfbW9kdWxlcy9wZGZqcy1kaXN0L2J1aWxkL3BkZi5tanMKdmFyIF9fd2VicGFja19yZXF1aXJlX18gPSB7fTsKKCgpID0+IHsKICBfX3dlYnBhY2tfcmVxdWlyZV9fLmQgPSAoZXhwb3J0cywgZGVmaW5pdGlvbikgPT4gewogICAgZm9yICh2YXIga2V5IGluIGRlZmluaXRpb24pIHsKICAgICAgaWYgKF9fd2VicGFja19yZXF1aXJlX18ubyhkZWZpbml0aW9uLCBrZXkpICYmICFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywga2V5KSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBrZXksIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBkZWZpbml0aW9uW2tleV0gfSk7CiAgICAgIH0KICAgIH0KICB9Owp9KSgpOwooKCkgPT4gewogIF9fd2VicGFja19yZXF1aXJlX18ubyA9IChvYmosIHByb3ApID0+IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwp9KSgpOwp2YXIgaXNOb2RlSlMgPSB0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgcHJvY2VzcyArICIiID09PSAiW29iamVjdCBwcm9jZXNzXSIgJiYgIXByb2Nlc3MudmVyc2lvbnMubncgJiYgIShwcm9jZXNzLnZlcnNpb25zLmVsZWN0cm9uICYmIHByb2Nlc3MudHlwZSAmJiBwcm9jZXNzLnR5cGUgIT09ICJicm93c2VyIik7CnZhciBGT05UX0lERU5USVRZX01BVFJJWCA9IFsxZS0zLCAwLCAwLCAxZS0zLCAwLCAwXTsKdmFyIExJTkVfRkFDVE9SID0gMS4zNTsKdmFyIExJTkVfREVTQ0VOVF9GQUNUT1IgPSAwLjM1Owp2YXIgQkFTRUxJTkVfRkFDVE9SID0gTElORV9ERVNDRU5UX0ZBQ1RPUiAvIExJTkVfRkFDVE9SOwp2YXIgUmVuZGVyaW5nSW50ZW50RmxhZyA9IHsKICBBTlk6IDEsCiAgRElTUExBWTogMiwKICBQUklOVDogNCwKICBTQVZFOiA4LAogIEFOTk9UQVRJT05TX0ZPUk1TOiAxNiwKICBBTk5PVEFUSU9OU19TVE9SQUdFOiAzMiwKICBBTk5PVEFUSU9OU19ESVNBQkxFOiA2NCwKICBJU19FRElUSU5HOiAxMjgsCiAgT1BMSVNUOiAyNTYKfTsKdmFyIEFubm90YXRpb25Nb2RlID0gewogIERJU0FCTEU6IDAsCiAgRU5BQkxFOiAxLAogIEVOQUJMRV9GT1JNUzogMiwKICBFTkFCTEVfU1RPUkFHRTogMwp9Owp2YXIgQW5ub3RhdGlvbkVkaXRvclByZWZpeCA9ICJwZGZqc19pbnRlcm5hbF9lZGl0b3JfIjsKdmFyIEFubm90YXRpb25FZGl0b3JUeXBlID0gewogIERJU0FCTEU6IC0xLAogIE5PTkU6IDAsCiAgRlJFRVRFWFQ6IDMsCiAgSElHSExJR0hUOiA5LAogIFNUQU1QOiAxMywKICBJTks6IDE1LAogIFBPUFVQOiAxNiwKICBTSUdOQVRVUkU6IDEwMSwKICBDT01NRU5UOiAxMDIKfTsKdmFyIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlID0gewogIFJFU0laRTogMSwKICBDUkVBVEU6IDIsCiAgRlJFRVRFWFRfU0laRTogMTEsCiAgRlJFRVRFWFRfQ09MT1I6IDEyLAogIEZSRUVURVhUX09QQUNJVFk6IDEzLAogIElOS19DT0xPUjogMjEsCiAgSU5LX1RISUNLTkVTUzogMjIsCiAgSU5LX09QQUNJVFk6IDIzLAogIEhJR0hMSUdIVF9DT0xPUjogMzEsCiAgSElHSExJR0hUX1RISUNLTkVTUzogMzIsCiAgSElHSExJR0hUX0ZSRUU6IDMzLAogIEhJR0hMSUdIVF9TSE9XX0FMTDogMzQsCiAgRFJBV19TVEVQOiA0MQp9Owp2YXIgUGVybWlzc2lvbkZsYWcgPSB7CiAgUFJJTlQ6IDQsCiAgTU9ESUZZX0NPTlRFTlRTOiA4LAogIENPUFk6IDE2LAogIE1PRElGWV9BTk5PVEFUSU9OUzogMzIsCiAgRklMTF9JTlRFUkFDVElWRV9GT1JNUzogMjU2LAogIENPUFlfRk9SX0FDQ0VTU0lCSUxJVFk6IDUxMiwKICBBU1NFTUJMRTogMTAyNCwKICBQUklOVF9ISUdIX1FVQUxJVFk6IDIwNDgKfTsKdmFyIE1lc2hGaWd1cmVUeXBlID0gewogIFRSSUFOR0xFUzogMSwKICBMQVRUSUNFOiAyLAogIFBBVENIOiAzCn07CnZhciBUZXh0UmVuZGVyaW5nTW9kZSA9IHsKICBGSUxMOiAwLAogIFNUUk9LRTogMSwKICBGSUxMX1NUUk9LRTogMiwKICBJTlZJU0lCTEU6IDMsCiAgRklMTF9BRERfVE9fUEFUSDogNCwKICBTVFJPS0VfQUREX1RPX1BBVEg6IDUsCiAgRklMTF9TVFJPS0VfQUREX1RPX1BBVEg6IDYsCiAgQUREX1RPX1BBVEg6IDcsCiAgRklMTF9TVFJPS0VfTUFTSzogMywKICBBRERfVE9fUEFUSF9GTEFHOiA0Cn07CnZhciB1dGlsX0ltYWdlS2luZCA9IHsKICBHUkFZU0NBTEVfMUJQUDogMSwKICBSR0JfMjRCUFA6IDIsCiAgUkdCQV8zMkJQUDogMwp9Owp2YXIgQW5ub3RhdGlvblR5cGUgPSB7CiAgVEVYVDogMSwKICBMSU5LOiAyLAogIEZSRUVURVhUOiAzLAogIExJTkU6IDQsCiAgU1FVQVJFOiA1LAogIENJUkNMRTogNiwKICBQT0xZR09OOiA3LAogIFBPTFlMSU5FOiA4LAogIEhJR0hMSUdIVDogOSwKICBVTkRFUkxJTkU6IDEwLAogIFNRVUlHR0xZOiAxMSwKICBTVFJJS0VPVVQ6IDEyLAogIFNUQU1QOiAxMywKICBDQVJFVDogMTQsCiAgSU5LOiAxNSwKICBQT1BVUDogMTYsCiAgRklMRUFUVEFDSE1FTlQ6IDE3LAogIFNPVU5EOiAxOCwKICBNT1ZJRTogMTksCiAgV0lER0VUOiAyMCwKICBTQ1JFRU46IDIxLAogIFBSSU5URVJNQVJLOiAyMiwKICBUUkFQTkVUOiAyMywKICBXQVRFUk1BUks6IDI0LAogIFRIUkVFRDogMjUsCiAgUkVEQUNUOiAyNgp9Owp2YXIgQW5ub3RhdGlvbkJvcmRlclN0eWxlVHlwZSA9IHsKICBTT0xJRDogMSwKICBEQVNIRUQ6IDIsCiAgQkVWRUxFRDogMywKICBJTlNFVDogNCwKICBVTkRFUkxJTkU6IDUKfTsKdmFyIFZlcmJvc2l0eUxldmVsID0gewogIEVSUk9SUzogMCwKICBXQVJOSU5HUzogMSwKICBJTkZPUzogNQp9Owp2YXIgT1BTID0gewogIGRlcGVuZGVuY3k6IDEsCiAgc2V0TGluZVdpZHRoOiAyLAogIHNldExpbmVDYXA6IDMsCiAgc2V0TGluZUpvaW46IDQsCiAgc2V0TWl0ZXJMaW1pdDogNSwKICBzZXREYXNoOiA2LAogIHNldFJlbmRlcmluZ0ludGVudDogNywKICBzZXRGbGF0bmVzczogOCwKICBzZXRHU3RhdGU6IDksCiAgc2F2ZTogMTAsCiAgcmVzdG9yZTogMTEsCiAgdHJhbnNmb3JtOiAxMiwKICBtb3ZlVG86IDEzLAogIGxpbmVUbzogMTQsCiAgY3VydmVUbzogMTUsCiAgY3VydmVUbzI6IDE2LAogIGN1cnZlVG8zOiAxNywKICBjbG9zZVBhdGg6IDE4LAogIHJlY3RhbmdsZTogMTksCiAgc3Ryb2tlOiAyMCwKICBjbG9zZVN0cm9rZTogMjEsCiAgZmlsbDogMjIsCiAgZW9GaWxsOiAyMywKICBmaWxsU3Ryb2tlOiAyNCwKICBlb0ZpbGxTdHJva2U6IDI1LAogIGNsb3NlRmlsbFN0cm9rZTogMjYsCiAgY2xvc2VFT0ZpbGxTdHJva2U6IDI3LAogIGVuZFBhdGg6IDI4LAogIGNsaXA6IDI5LAogIGVvQ2xpcDogMzAsCiAgYmVnaW5UZXh0OiAzMSwKICBlbmRUZXh0OiAzMiwKICBzZXRDaGFyU3BhY2luZzogMzMsCiAgc2V0V29yZFNwYWNpbmc6IDM0LAogIHNldEhTY2FsZTogMzUsCiAgc2V0TGVhZGluZzogMzYsCiAgc2V0Rm9udDogMzcsCiAgc2V0VGV4dFJlbmRlcmluZ01vZGU6IDM4LAogIHNldFRleHRSaXNlOiAzOSwKICBtb3ZlVGV4dDogNDAsCiAgc2V0TGVhZGluZ01vdmVUZXh0OiA0MSwKICBzZXRUZXh0TWF0cml4OiA0MiwKICBuZXh0TGluZTogNDMsCiAgc2hvd1RleHQ6IDQ0LAogIHNob3dTcGFjZWRUZXh0OiA0NSwKICBuZXh0TGluZVNob3dUZXh0OiA0NiwKICBuZXh0TGluZVNldFNwYWNpbmdTaG93VGV4dDogNDcsCiAgc2V0Q2hhcldpZHRoOiA0OCwKICBzZXRDaGFyV2lkdGhBbmRCb3VuZHM6IDQ5LAogIHNldFN0cm9rZUNvbG9yU3BhY2U6IDUwLAogIHNldEZpbGxDb2xvclNwYWNlOiA1MSwKICBzZXRTdHJva2VDb2xvcjogNTIsCiAgc2V0U3Ryb2tlQ29sb3JOOiA1MywKICBzZXRGaWxsQ29sb3I6IDU0LAogIHNldEZpbGxDb2xvck46IDU1LAogIHNldFN0cm9rZUdyYXk6IDU2LAogIHNldEZpbGxHcmF5OiA1NywKICBzZXRTdHJva2VSR0JDb2xvcjogNTgsCiAgc2V0RmlsbFJHQkNvbG9yOiA1OSwKICBzZXRTdHJva2VDTVlLQ29sb3I6IDYwLAogIHNldEZpbGxDTVlLQ29sb3I6IDYxLAogIHNoYWRpbmdGaWxsOiA2MiwKICBiZWdpbklubGluZUltYWdlOiA2MywKICBiZWdpbkltYWdlRGF0YTogNjQsCiAgZW5kSW5saW5lSW1hZ2U6IDY1LAogIHBhaW50WE9iamVjdDogNjYsCiAgbWFya1BvaW50OiA2NywKICBtYXJrUG9pbnRQcm9wczogNjgsCiAgYmVnaW5NYXJrZWRDb250ZW50OiA2OSwKICBiZWdpbk1hcmtlZENvbnRlbnRQcm9wczogNzAsCiAgZW5kTWFya2VkQ29udGVudDogNzEsCiAgYmVnaW5Db21wYXQ6IDcyLAogIGVuZENvbXBhdDogNzMsCiAgcGFpbnRGb3JtWE9iamVjdEJlZ2luOiA3NCwKICBwYWludEZvcm1YT2JqZWN0RW5kOiA3NSwKICBiZWdpbkdyb3VwOiA3NiwKICBlbmRHcm91cDogNzcsCiAgYmVnaW5Bbm5vdGF0aW9uOiA4MCwKICBlbmRBbm5vdGF0aW9uOiA4MSwKICBwYWludEltYWdlTWFza1hPYmplY3Q6IDgzLAogIHBhaW50SW1hZ2VNYXNrWE9iamVjdEdyb3VwOiA4NCwKICBwYWludEltYWdlWE9iamVjdDogODUsCiAgcGFpbnRJbmxpbmVJbWFnZVhPYmplY3Q6IDg2LAogIHBhaW50SW5saW5lSW1hZ2VYT2JqZWN0R3JvdXA6IDg3LAogIHBhaW50SW1hZ2VYT2JqZWN0UmVwZWF0OiA4OCwKICBwYWludEltYWdlTWFza1hPYmplY3RSZXBlYXQ6IDg5LAogIHBhaW50U29saWRDb2xvckltYWdlTWFzazogOTAsCiAgY29uc3RydWN0UGF0aDogOTEsCiAgc2V0U3Ryb2tlVHJhbnNwYXJlbnQ6IDkyLAogIHNldEZpbGxUcmFuc3BhcmVudDogOTMsCiAgcmF3RmlsbFBhdGg6IDk0Cn07CnZhciBEcmF3T1BTID0gewogIG1vdmVUbzogMCwKICBsaW5lVG86IDEsCiAgY3VydmVUbzogMiwKICBxdWFkcmF0aWNDdXJ2ZVRvOiAzLAogIGNsb3NlUGF0aDogNAp9Owp2YXIgUGFzc3dvcmRSZXNwb25zZXMgPSB7CiAgTkVFRF9QQVNTV09SRDogMSwKICBJTkNPUlJFQ1RfUEFTU1dPUkQ6IDIKfTsKdmFyIHZlcmJvc2l0eSA9IFZlcmJvc2l0eUxldmVsLldBUk5JTkdTOwpmdW5jdGlvbiBzZXRWZXJib3NpdHlMZXZlbChsZXZlbCkgewogIGlmIChOdW1iZXIuaXNJbnRlZ2VyKGxldmVsKSkgewogICAgdmVyYm9zaXR5ID0gbGV2ZWw7CiAgfQp9CmZ1bmN0aW9uIGdldFZlcmJvc2l0eUxldmVsKCkgewogIHJldHVybiB2ZXJib3NpdHk7Cn0KZnVuY3Rpb24gaW5mbyhtc2cpIHsKICBpZiAodmVyYm9zaXR5ID49IFZlcmJvc2l0eUxldmVsLklORk9TKSB7CiAgICBjb25zb2xlLmluZm8oYEluZm86ICR7bXNnfWApOwogIH0KfQpmdW5jdGlvbiB3YXJuKG1zZykgewogIGlmICh2ZXJib3NpdHkgPj0gVmVyYm9zaXR5TGV2ZWwuV0FSTklOR1MpIHsKICAgIGNvbnNvbGUud2FybihgV2FybmluZzogJHttc2d9YCk7CiAgfQp9CmZ1bmN0aW9uIHVucmVhY2hhYmxlKG1zZykgewogIHRocm93IG5ldyBFcnJvcihtc2cpOwp9CmZ1bmN0aW9uIGFzc2VydChjb25kLCBtc2cpIHsKICBpZiAoIWNvbmQpIHsKICAgIHVucmVhY2hhYmxlKG1zZyk7CiAgfQp9CmZ1bmN0aW9uIF9pc1ZhbGlkUHJvdG9jb2wodXJsKSB7CiAgc3dpdGNoICh1cmw/LnByb3RvY29sKSB7CiAgICBjYXNlICJodHRwOiI6CiAgICBjYXNlICJodHRwczoiOgogICAgY2FzZSAiZnRwOiI6CiAgICBjYXNlICJtYWlsdG86IjoKICAgIGNhc2UgInRlbDoiOgogICAgICByZXR1cm4gdHJ1ZTsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBmYWxzZTsKICB9Cn0KZnVuY3Rpb24gY3JlYXRlVmFsaWRBYnNvbHV0ZVVybCh1cmwsIGJhc2VVcmwgPSBudWxsLCBvcHRpb25zID0gbnVsbCkgewogIGlmICghdXJsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIHVybCA9PT0gInN0cmluZyIpIHsKICAgIGlmIChvcHRpb25zLmFkZERlZmF1bHRQcm90b2NvbCAmJiB1cmwuc3RhcnRzV2l0aCgid3d3LiIpKSB7CiAgICAgIGNvbnN0IGRvdHMgPSB1cmwubWF0Y2goL1wuL2cpOwogICAgICBpZiAoZG90cz8ubGVuZ3RoID49IDIpIHsKICAgICAgICB1cmwgPSBgaHR0cDovLyR7dXJsfWA7CiAgICAgIH0KICAgIH0KICAgIGlmIChvcHRpb25zLnRyeUNvbnZlcnRFbmNvZGluZykgewogICAgICB0cnkgewogICAgICAgIHVybCA9IHN0cmluZ1RvVVRGOFN0cmluZyh1cmwpOwogICAgICB9IGNhdGNoIHsKICAgICAgfQogICAgfQogIH0KICBjb25zdCBhYnNvbHV0ZVVybCA9IGJhc2VVcmwgPyBVUkwucGFyc2UodXJsLCBiYXNlVXJsKSA6IFVSTC5wYXJzZSh1cmwpOwogIHJldHVybiBfaXNWYWxpZFByb3RvY29sKGFic29sdXRlVXJsKSA/IGFic29sdXRlVXJsIDogbnVsbDsKfQpmdW5jdGlvbiB1cGRhdGVVcmxIYXNoKHVybCwgaGFzaCwgYWxsb3dSZWwgPSBmYWxzZSkgewogIGNvbnN0IHJlcyA9IFVSTC5wYXJzZSh1cmwpOwogIGlmIChyZXMpIHsKICAgIHJlcy5oYXNoID0gaGFzaDsKICAgIHJldHVybiByZXMuaHJlZjsKICB9CiAgaWYgKGFsbG93UmVsICYmIGNyZWF0ZVZhbGlkQWJzb2x1dGVVcmwodXJsLCAiaHR0cDovL2V4YW1wbGUuY29tIikpIHsKICAgIHJldHVybiB1cmwuc3BsaXQoIiMiLCAxKVswXSArIGAke2hhc2ggPyBgIyR7aGFzaH1gIDogIiJ9YDsKICB9CiAgcmV0dXJuICIiOwp9CmZ1bmN0aW9uIHNoYWRvdyhvYmosIHByb3AsIHZhbHVlLCBub25TZXJpYWxpemFibGUgPSBmYWxzZSkgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIHByb3AsIHsKICAgIHZhbHVlLAogICAgZW51bWVyYWJsZTogIW5vblNlcmlhbGl6YWJsZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIHdyaXRhYmxlOiBmYWxzZQogIH0pOwogIHJldHVybiB2YWx1ZTsKfQp2YXIgQmFzZUV4Y2VwdGlvbiA9IGZ1bmN0aW9uIEJhc2VFeGNlcHRpb25DbG9zdXJlKCkgewogIGZ1bmN0aW9uIEJhc2VFeGNlcHRpb24yKG1lc3NhZ2UsIG5hbWUpIHsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogIH0KICBCYXNlRXhjZXB0aW9uMi5wcm90b3R5cGUgPSBuZXcgRXJyb3IoKTsKICBCYXNlRXhjZXB0aW9uMi5jb25zdHJ1Y3RvciA9IEJhc2VFeGNlcHRpb24yOwogIHJldHVybiBCYXNlRXhjZXB0aW9uMjsKfSgpOwp2YXIgUGFzc3dvcmRFeGNlcHRpb24gPSBjbGFzcyBleHRlbmRzIEJhc2VFeGNlcHRpb24gewogIGNvbnN0cnVjdG9yKG1zZywgY29kZSkgewogICAgc3VwZXIobXNnLCAiUGFzc3dvcmRFeGNlcHRpb24iKTsKICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgfQp9Owp2YXIgVW5rbm93bkVycm9yRXhjZXB0aW9uID0gY2xhc3MgZXh0ZW5kcyBCYXNlRXhjZXB0aW9uIHsKICBjb25zdHJ1Y3Rvcihtc2csIGRldGFpbHMpIHsKICAgIHN1cGVyKG1zZywgIlVua25vd25FcnJvckV4Y2VwdGlvbiIpOwogICAgdGhpcy5kZXRhaWxzID0gZGV0YWlsczsKICB9Cn07CnZhciBJbnZhbGlkUERGRXhjZXB0aW9uID0gY2xhc3MgZXh0ZW5kcyBCYXNlRXhjZXB0aW9uIHsKICBjb25zdHJ1Y3Rvcihtc2cpIHsKICAgIHN1cGVyKG1zZywgIkludmFsaWRQREZFeGNlcHRpb24iKTsKICB9Cn07CnZhciBSZXNwb25zZUV4Y2VwdGlvbiA9IGNsYXNzIGV4dGVuZHMgQmFzZUV4Y2VwdGlvbiB7CiAgY29uc3RydWN0b3IobXNnLCBzdGF0dXMsIG1pc3NpbmcpIHsKICAgIHN1cGVyKG1zZywgIlJlc3BvbnNlRXhjZXB0aW9uIik7CiAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgIHRoaXMubWlzc2luZyA9IG1pc3Npbmc7CiAgfQp9Owp2YXIgRm9ybWF0RXJyb3IgPSBjbGFzcyBleHRlbmRzIEJhc2VFeGNlcHRpb24gewogIGNvbnN0cnVjdG9yKG1zZykgewogICAgc3VwZXIobXNnLCAiRm9ybWF0RXJyb3IiKTsKICB9Cn07CnZhciBBYm9ydEV4Y2VwdGlvbiA9IGNsYXNzIGV4dGVuZHMgQmFzZUV4Y2VwdGlvbiB7CiAgY29uc3RydWN0b3IobXNnKSB7CiAgICBzdXBlcihtc2csICJBYm9ydEV4Y2VwdGlvbiIpOwogIH0KfTsKZnVuY3Rpb24gYnl0ZXNUb1N0cmluZyhieXRlcykgewogIGlmICh0eXBlb2YgYnl0ZXMgIT09ICJvYmplY3QiIHx8IGJ5dGVzPy5sZW5ndGggPT09IHZvaWQgMCkgewogICAgdW5yZWFjaGFibGUoIkludmFsaWQgYXJndW1lbnQgZm9yIGJ5dGVzVG9TdHJpbmciKTsKICB9CiAgY29uc3QgbGVuZ3RoID0gYnl0ZXMubGVuZ3RoOwogIGNvbnN0IE1BWF9BUkdVTUVOVF9DT1VOVCA9IDgxOTI7CiAgaWYgKGxlbmd0aCA8IE1BWF9BUkdVTUVOVF9DT1VOVCkgewogICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgYnl0ZXMpOwogIH0KICBjb25zdCBzdHJCdWYgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSBNQVhfQVJHVU1FTlRfQ09VTlQpIHsKICAgIGNvbnN0IGNodW5rRW5kID0gTWF0aC5taW4oaSArIE1BWF9BUkdVTUVOVF9DT1VOVCwgbGVuZ3RoKTsKICAgIGNvbnN0IGNodW5rID0gYnl0ZXMuc3ViYXJyYXkoaSwgY2h1bmtFbmQpOwogICAgc3RyQnVmLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBjaHVuaykpOwogIH0KICByZXR1cm4gc3RyQnVmLmpvaW4oIiIpOwp9CmZ1bmN0aW9uIHN0cmluZ1RvQnl0ZXMoc3RyKSB7CiAgaWYgKHR5cGVvZiBzdHIgIT09ICJzdHJpbmciKSB7CiAgICB1bnJlYWNoYWJsZSgiSW52YWxpZCBhcmd1bWVudCBmb3Igc3RyaW5nVG9CeXRlcyIpOwogIH0KICBjb25zdCBsZW5ndGggPSBzdHIubGVuZ3RoOwogIGNvbnN0IGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICBieXRlc1tpXSA9IHN0ci5jaGFyQ29kZUF0KGkpICYgMjU1OwogIH0KICByZXR1cm4gYnl0ZXM7Cn0KZnVuY3Rpb24gc3RyaW5nMzIodmFsdWUpIHsKICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSh2YWx1ZSA+PiAyNCAmIDI1NSwgdmFsdWUgPj4gMTYgJiAyNTUsIHZhbHVlID4+IDggJiAyNTUsIHZhbHVlICYgMjU1KTsKfQpmdW5jdGlvbiBpc0xpdHRsZUVuZGlhbigpIHsKICBjb25zdCBidWZmZXI4ID0gbmV3IFVpbnQ4QXJyYXkoNCk7CiAgYnVmZmVyOFswXSA9IDE7CiAgY29uc3QgdmlldzMyID0gbmV3IFVpbnQzMkFycmF5KGJ1ZmZlcjguYnVmZmVyLCAwLCAxKTsKICByZXR1cm4gdmlldzMyWzBdID09PSAxOwp9CmZ1bmN0aW9uIGlzRXZhbFN1cHBvcnRlZCgpIHsKICB0cnkgewogICAgbmV3IEZ1bmN0aW9uKCIiKTsKICAgIHJldHVybiB0cnVlOwogIH0gY2F0Y2ggewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQp2YXIgdXRpbF9GZWF0dXJlVGVzdCA9IGNsYXNzIHsKICBzdGF0aWMgZ2V0IGlzTGl0dGxlRW5kaWFuKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaXNMaXR0bGVFbmRpYW4iLCBpc0xpdHRsZUVuZGlhbigpKTsKICB9CiAgc3RhdGljIGdldCBpc0V2YWxTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc0V2YWxTdXBwb3J0ZWQiLCBpc0V2YWxTdXBwb3J0ZWQoKSk7CiAgfQogIHN0YXRpYyBnZXQgaXNPZmZzY3JlZW5DYW52YXNTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRlZCIsIHR5cGVvZiBPZmZzY3JlZW5DYW52YXMgIT09ICJ1bmRlZmluZWQiKTsKICB9CiAgc3RhdGljIGdldCBpc0ltYWdlRGVjb2RlclN1cHBvcnRlZCgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzSW1hZ2VEZWNvZGVyU3VwcG9ydGVkIiwgdHlwZW9mIEltYWdlRGVjb2RlciAhPT0gInVuZGVmaW5lZCIpOwogIH0KICBzdGF0aWMgZ2V0IGlzRmxvYXQxNkFycmF5U3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaXNGbG9hdDE2QXJyYXlTdXBwb3J0ZWQiLCB0eXBlb2YgRmxvYXQxNkFycmF5ICE9PSAidW5kZWZpbmVkIik7CiAgfQogIHN0YXRpYyBnZXQgaXNTYW5pdGl6ZXJTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc1Nhbml0aXplclN1cHBvcnRlZCIsIHR5cGVvZiBTYW5pdGl6ZXIgIT09ICJ1bmRlZmluZWQiKTsKICB9CiAgc3RhdGljIGdldCBwbGF0Zm9ybSgpIHsKICAgIGNvbnN0IHsKICAgICAgcGxhdGZvcm0sCiAgICAgIHVzZXJBZ2VudAogICAgfSA9IG5hdmlnYXRvcjsKICAgIHJldHVybiBzaGFkb3codGhpcywgInBsYXRmb3JtIiwgewogICAgICBpc0FuZHJvaWQ6IHVzZXJBZ2VudC5pbmNsdWRlcygiQW5kcm9pZCIpLAogICAgICBpc0xpbnV4OiBwbGF0Zm9ybS5pbmNsdWRlcygiTGludXgiKSwKICAgICAgaXNNYWM6IHBsYXRmb3JtLmluY2x1ZGVzKCJNYWMiKSwKICAgICAgaXNXaW5kb3dzOiBwbGF0Zm9ybS5pbmNsdWRlcygiV2luIiksCiAgICAgIGlzRmlyZWZveDogdXNlckFnZW50LmluY2x1ZGVzKCJGaXJlZm94IikKICAgIH0pOwogIH0KICBzdGF0aWMgZ2V0IGlzQ1NTUm91bmRTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc0NTU1JvdW5kU3VwcG9ydGVkIiwgZ2xvYmFsVGhpcy5DU1M/LnN1cHBvcnRzPy4oIndpZHRoOiByb3VuZCgxLjVweCwgMXB4KSIpKTsKICB9Cn07CnZhciBoZXhOdW1iZXJzID0gQXJyYXkuZnJvbShBcnJheSgyNTYpLmtleXMoKSwgKG4pID0+IG4udG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICIwIikpOwp2YXIgVXRpbCA9IGNsYXNzIHsKICBzdGF0aWMgbWFrZUhleENvbG9yKHIsIGcsIGIpIHsKICAgIHJldHVybiBgIyR7aGV4TnVtYmVyc1tyXX0ke2hleE51bWJlcnNbZ119JHtoZXhOdW1iZXJzW2JdfWA7CiAgfQogIHN0YXRpYyBkb21NYXRyaXhUb1RyYW5zZm9ybShkbSkgewogICAgcmV0dXJuIFtkbS5hLCBkbS5iLCBkbS5jLCBkbS5kLCBkbS5lLCBkbS5mXTsKICB9CiAgc3RhdGljIHNjYWxlTWluTWF4KHRyYW5zZm9ybSwgbWluTWF4KSB7CiAgICBsZXQgdGVtcDsKICAgIGlmICh0cmFuc2Zvcm1bMF0pIHsKICAgICAgaWYgKHRyYW5zZm9ybVswXSA8IDApIHsKICAgICAgICB0ZW1wID0gbWluTWF4WzBdOwogICAgICAgIG1pbk1heFswXSA9IG1pbk1heFsyXTsKICAgICAgICBtaW5NYXhbMl0gPSB0ZW1wOwogICAgICB9CiAgICAgIG1pbk1heFswXSAqPSB0cmFuc2Zvcm1bMF07CiAgICAgIG1pbk1heFsyXSAqPSB0cmFuc2Zvcm1bMF07CiAgICAgIGlmICh0cmFuc2Zvcm1bM10gPCAwKSB7CiAgICAgICAgdGVtcCA9IG1pbk1heFsxXTsKICAgICAgICBtaW5NYXhbMV0gPSBtaW5NYXhbM107CiAgICAgICAgbWluTWF4WzNdID0gdGVtcDsKICAgICAgfQogICAgICBtaW5NYXhbMV0gKj0gdHJhbnNmb3JtWzNdOwogICAgICBtaW5NYXhbM10gKj0gdHJhbnNmb3JtWzNdOwogICAgfSBlbHNlIHsKICAgICAgdGVtcCA9IG1pbk1heFswXTsKICAgICAgbWluTWF4WzBdID0gbWluTWF4WzFdOwogICAgICBtaW5NYXhbMV0gPSB0ZW1wOwogICAgICB0ZW1wID0gbWluTWF4WzJdOwogICAgICBtaW5NYXhbMl0gPSBtaW5NYXhbM107CiAgICAgIG1pbk1heFszXSA9IHRlbXA7CiAgICAgIGlmICh0cmFuc2Zvcm1bMV0gPCAwKSB7CiAgICAgICAgdGVtcCA9IG1pbk1heFsxXTsKICAgICAgICBtaW5NYXhbMV0gPSBtaW5NYXhbM107CiAgICAgICAgbWluTWF4WzNdID0gdGVtcDsKICAgICAgfQogICAgICBtaW5NYXhbMV0gKj0gdHJhbnNmb3JtWzFdOwogICAgICBtaW5NYXhbM10gKj0gdHJhbnNmb3JtWzFdOwogICAgICBpZiAodHJhbnNmb3JtWzJdIDwgMCkgewogICAgICAgIHRlbXAgPSBtaW5NYXhbMF07CiAgICAgICAgbWluTWF4WzBdID0gbWluTWF4WzJdOwogICAgICAgIG1pbk1heFsyXSA9IHRlbXA7CiAgICAgIH0KICAgICAgbWluTWF4WzBdICo9IHRyYW5zZm9ybVsyXTsKICAgICAgbWluTWF4WzJdICo9IHRyYW5zZm9ybVsyXTsKICAgIH0KICAgIG1pbk1heFswXSArPSB0cmFuc2Zvcm1bNF07CiAgICBtaW5NYXhbMV0gKz0gdHJhbnNmb3JtWzVdOwogICAgbWluTWF4WzJdICs9IHRyYW5zZm9ybVs0XTsKICAgIG1pbk1heFszXSArPSB0cmFuc2Zvcm1bNV07CiAgfQogIHN0YXRpYyB0cmFuc2Zvcm0obTEsIG0yKSB7CiAgICByZXR1cm4gW20xWzBdICogbTJbMF0gKyBtMVsyXSAqIG0yWzFdLCBtMVsxXSAqIG0yWzBdICsgbTFbM10gKiBtMlsxXSwgbTFbMF0gKiBtMlsyXSArIG0xWzJdICogbTJbM10sIG0xWzFdICogbTJbMl0gKyBtMVszXSAqIG0yWzNdLCBtMVswXSAqIG0yWzRdICsgbTFbMl0gKiBtMls1XSArIG0xWzRdLCBtMVsxXSAqIG0yWzRdICsgbTFbM10gKiBtMls1XSArIG0xWzVdXTsKICB9CiAgc3RhdGljIG11bHRpcGx5QnlET01NYXRyaXgobSwgbWQpIHsKICAgIHJldHVybiBbbVswXSAqIG1kLmEgKyBtWzJdICogbWQuYiwgbVsxXSAqIG1kLmEgKyBtWzNdICogbWQuYiwgbVswXSAqIG1kLmMgKyBtWzJdICogbWQuZCwgbVsxXSAqIG1kLmMgKyBtWzNdICogbWQuZCwgbVswXSAqIG1kLmUgKyBtWzJdICogbWQuZiArIG1bNF0sIG1bMV0gKiBtZC5lICsgbVszXSAqIG1kLmYgKyBtWzVdXTsKICB9CiAgc3RhdGljIGFwcGx5VHJhbnNmb3JtKHAsIG0sIHBvcyA9IDApIHsKICAgIGNvbnN0IHAwID0gcFtwb3NdOwogICAgY29uc3QgcDEgPSBwW3BvcyArIDFdOwogICAgcFtwb3NdID0gcDAgKiBtWzBdICsgcDEgKiBtWzJdICsgbVs0XTsKICAgIHBbcG9zICsgMV0gPSBwMCAqIG1bMV0gKyBwMSAqIG1bM10gKyBtWzVdOwogIH0KICBzdGF0aWMgYXBwbHlUcmFuc2Zvcm1Ub0JlemllcihwLCB0cmFuc2Zvcm0sIHBvcyA9IDApIHsKICAgIGNvbnN0IG0wID0gdHJhbnNmb3JtWzBdOwogICAgY29uc3QgbTEgPSB0cmFuc2Zvcm1bMV07CiAgICBjb25zdCBtMiA9IHRyYW5zZm9ybVsyXTsKICAgIGNvbnN0IG0zID0gdHJhbnNmb3JtWzNdOwogICAgY29uc3QgbTQgPSB0cmFuc2Zvcm1bNF07CiAgICBjb25zdCBtNSA9IHRyYW5zZm9ybVs1XTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjsgaSArPSAyKSB7CiAgICAgIGNvbnN0IHBJID0gcFtwb3MgKyBpXTsKICAgICAgY29uc3QgcEkxID0gcFtwb3MgKyBpICsgMV07CiAgICAgIHBbcG9zICsgaV0gPSBwSSAqIG0wICsgcEkxICogbTIgKyBtNDsKICAgICAgcFtwb3MgKyBpICsgMV0gPSBwSSAqIG0xICsgcEkxICogbTMgKyBtNTsKICAgIH0KICB9CiAgc3RhdGljIGFwcGx5SW52ZXJzZVRyYW5zZm9ybShwLCBtKSB7CiAgICBjb25zdCBwMCA9IHBbMF07CiAgICBjb25zdCBwMSA9IHBbMV07CiAgICBjb25zdCBkID0gbVswXSAqIG1bM10gLSBtWzFdICogbVsyXTsKICAgIHBbMF0gPSAocDAgKiBtWzNdIC0gcDEgKiBtWzJdICsgbVsyXSAqIG1bNV0gLSBtWzRdICogbVszXSkgLyBkOwogICAgcFsxXSA9ICgtcDAgKiBtWzFdICsgcDEgKiBtWzBdICsgbVs0XSAqIG1bMV0gLSBtWzVdICogbVswXSkgLyBkOwogIH0KICBzdGF0aWMgYXhpYWxBbGlnbmVkQm91bmRpbmdCb3gocmVjdCwgdHJhbnNmb3JtLCBvdXRwdXQpIHsKICAgIGNvbnN0IG0wID0gdHJhbnNmb3JtWzBdOwogICAgY29uc3QgbTEgPSB0cmFuc2Zvcm1bMV07CiAgICBjb25zdCBtMiA9IHRyYW5zZm9ybVsyXTsKICAgIGNvbnN0IG0zID0gdHJhbnNmb3JtWzNdOwogICAgY29uc3QgbTQgPSB0cmFuc2Zvcm1bNF07CiAgICBjb25zdCBtNSA9IHRyYW5zZm9ybVs1XTsKICAgIGNvbnN0IHIwID0gcmVjdFswXTsKICAgIGNvbnN0IHIxID0gcmVjdFsxXTsKICAgIGNvbnN0IHIyID0gcmVjdFsyXTsKICAgIGNvbnN0IHIzID0gcmVjdFszXTsKICAgIGxldCBhMCA9IG0wICogcjAgKyBtNDsKICAgIGxldCBhMiA9IGEwOwogICAgbGV0IGExID0gbTAgKiByMiArIG00OwogICAgbGV0IGEzID0gYTE7CiAgICBsZXQgYjAgPSBtMyAqIHIxICsgbTU7CiAgICBsZXQgYjIgPSBiMDsKICAgIGxldCBiMSA9IG0zICogcjMgKyBtNTsKICAgIGxldCBiMyA9IGIxOwogICAgaWYgKG0xICE9PSAwIHx8IG0yICE9PSAwKSB7CiAgICAgIGNvbnN0IG0xcjAgPSBtMSAqIHIwOwogICAgICBjb25zdCBtMXIyID0gbTEgKiByMjsKICAgICAgY29uc3QgbTJyMSA9IG0yICogcjE7CiAgICAgIGNvbnN0IG0ycjMgPSBtMiAqIHIzOwogICAgICBhMCArPSBtMnIxOwogICAgICBhMyArPSBtMnIxOwogICAgICBhMSArPSBtMnIzOwogICAgICBhMiArPSBtMnIzOwogICAgICBiMCArPSBtMXIwOwogICAgICBiMyArPSBtMXIwOwogICAgICBiMSArPSBtMXIyOwogICAgICBiMiArPSBtMXIyOwogICAgfQogICAgb3V0cHV0WzBdID0gTWF0aC5taW4ob3V0cHV0WzBdLCBhMCwgYTEsIGEyLCBhMyk7CiAgICBvdXRwdXRbMV0gPSBNYXRoLm1pbihvdXRwdXRbMV0sIGIwLCBiMSwgYjIsIGIzKTsKICAgIG91dHB1dFsyXSA9IE1hdGgubWF4KG91dHB1dFsyXSwgYTAsIGExLCBhMiwgYTMpOwogICAgb3V0cHV0WzNdID0gTWF0aC5tYXgob3V0cHV0WzNdLCBiMCwgYjEsIGIyLCBiMyk7CiAgfQogIHN0YXRpYyBpbnZlcnNlVHJhbnNmb3JtKG0pIHsKICAgIGNvbnN0IGQgPSBtWzBdICogbVszXSAtIG1bMV0gKiBtWzJdOwogICAgcmV0dXJuIFttWzNdIC8gZCwgLW1bMV0gLyBkLCAtbVsyXSAvIGQsIG1bMF0gLyBkLCAobVsyXSAqIG1bNV0gLSBtWzRdICogbVszXSkgLyBkLCAobVs0XSAqIG1bMV0gLSBtWzVdICogbVswXSkgLyBkXTsKICB9CiAgc3RhdGljIHNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKG1hdHJpeCwgb3V0cHV0KSB7CiAgICBjb25zdCBtMCA9IG1hdHJpeFswXTsKICAgIGNvbnN0IG0xID0gbWF0cml4WzFdOwogICAgY29uc3QgbTIgPSBtYXRyaXhbMl07CiAgICBjb25zdCBtMyA9IG1hdHJpeFszXTsKICAgIGNvbnN0IGEgPSBtMCAqKiAyICsgbTEgKiogMjsKICAgIGNvbnN0IGIgPSBtMCAqIG0yICsgbTEgKiBtMzsKICAgIGNvbnN0IGMgPSBtMiAqKiAyICsgbTMgKiogMjsKICAgIGNvbnN0IGZpcnN0ID0gKGEgKyBjKSAvIDI7CiAgICBjb25zdCBzZWNvbmQgPSBNYXRoLnNxcnQoZmlyc3QgKiogMiAtIChhICogYyAtIGIgKiogMikpOwogICAgb3V0cHV0WzBdID0gTWF0aC5zcXJ0KGZpcnN0ICsgc2Vjb25kIHx8IDEpOwogICAgb3V0cHV0WzFdID0gTWF0aC5zcXJ0KGZpcnN0IC0gc2Vjb25kIHx8IDEpOwogIH0KICBzdGF0aWMgbm9ybWFsaXplUmVjdChyZWN0KSB7CiAgICBjb25zdCByID0gcmVjdC5zbGljZSgwKTsKICAgIGlmIChyZWN0WzBdID4gcmVjdFsyXSkgewogICAgICByWzBdID0gcmVjdFsyXTsKICAgICAgclsyXSA9IHJlY3RbMF07CiAgICB9CiAgICBpZiAocmVjdFsxXSA+IHJlY3RbM10pIHsKICAgICAgclsxXSA9IHJlY3RbM107CiAgICAgIHJbM10gPSByZWN0WzFdOwogICAgfQogICAgcmV0dXJuIHI7CiAgfQogIHN0YXRpYyBpbnRlcnNlY3QocmVjdDEsIHJlY3QyKSB7CiAgICBjb25zdCB4TG93ID0gTWF0aC5tYXgoTWF0aC5taW4ocmVjdDFbMF0sIHJlY3QxWzJdKSwgTWF0aC5taW4ocmVjdDJbMF0sIHJlY3QyWzJdKSk7CiAgICBjb25zdCB4SGlnaCA9IE1hdGgubWluKE1hdGgubWF4KHJlY3QxWzBdLCByZWN0MVsyXSksIE1hdGgubWF4KHJlY3QyWzBdLCByZWN0MlsyXSkpOwogICAgaWYgKHhMb3cgPiB4SGlnaCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHlMb3cgPSBNYXRoLm1heChNYXRoLm1pbihyZWN0MVsxXSwgcmVjdDFbM10pLCBNYXRoLm1pbihyZWN0MlsxXSwgcmVjdDJbM10pKTsKICAgIGNvbnN0IHlIaWdoID0gTWF0aC5taW4oTWF0aC5tYXgocmVjdDFbMV0sIHJlY3QxWzNdKSwgTWF0aC5tYXgocmVjdDJbMV0sIHJlY3QyWzNdKSk7CiAgICBpZiAoeUxvdyA+IHlIaWdoKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIFt4TG93LCB5TG93LCB4SGlnaCwgeUhpZ2hdOwogIH0KICBzdGF0aWMgcG9pbnRCb3VuZGluZ0JveCh4LCB5LCBtaW5NYXgpIHsKICAgIG1pbk1heFswXSA9IE1hdGgubWluKG1pbk1heFswXSwgeCk7CiAgICBtaW5NYXhbMV0gPSBNYXRoLm1pbihtaW5NYXhbMV0sIHkpOwogICAgbWluTWF4WzJdID0gTWF0aC5tYXgobWluTWF4WzJdLCB4KTsKICAgIG1pbk1heFszXSA9IE1hdGgubWF4KG1pbk1heFszXSwgeSk7CiAgfQogIHN0YXRpYyByZWN0Qm91bmRpbmdCb3goeDAsIHkwLCB4MSwgeTEsIG1pbk1heCkgewogICAgbWluTWF4WzBdID0gTWF0aC5taW4obWluTWF4WzBdLCB4MCwgeDEpOwogICAgbWluTWF4WzFdID0gTWF0aC5taW4obWluTWF4WzFdLCB5MCwgeTEpOwogICAgbWluTWF4WzJdID0gTWF0aC5tYXgobWluTWF4WzJdLCB4MCwgeDEpOwogICAgbWluTWF4WzNdID0gTWF0aC5tYXgobWluTWF4WzNdLCB5MCwgeTEpOwogIH0KICBzdGF0aWMgI2dldEV4dHJlbXVtT25DdXJ2ZSh4MCwgeDEsIHgyLCB4MywgeTAsIHkxLCB5MiwgeTMsIHQsIG1pbk1heCkgewogICAgaWYgKHQgPD0gMCB8fCB0ID49IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbXQgPSAxIC0gdDsKICAgIGNvbnN0IHR0ID0gdCAqIHQ7CiAgICBjb25zdCB0dHQgPSB0dCAqIHQ7CiAgICBjb25zdCB4ID0gbXQgKiAobXQgKiAobXQgKiB4MCArIDMgKiB0ICogeDEpICsgMyAqIHR0ICogeDIpICsgdHR0ICogeDM7CiAgICBjb25zdCB5ID0gbXQgKiAobXQgKiAobXQgKiB5MCArIDMgKiB0ICogeTEpICsgMyAqIHR0ICogeTIpICsgdHR0ICogeTM7CiAgICBtaW5NYXhbMF0gPSBNYXRoLm1pbihtaW5NYXhbMF0sIHgpOwogICAgbWluTWF4WzFdID0gTWF0aC5taW4obWluTWF4WzFdLCB5KTsKICAgIG1pbk1heFsyXSA9IE1hdGgubWF4KG1pbk1heFsyXSwgeCk7CiAgICBtaW5NYXhbM10gPSBNYXRoLm1heChtaW5NYXhbM10sIHkpOwogIH0KICBzdGF0aWMgI2dldEV4dHJlbXVtKHgwLCB4MSwgeDIsIHgzLCB5MCwgeTEsIHkyLCB5MywgYSwgYiwgYywgbWluTWF4KSB7CiAgICBpZiAoTWF0aC5hYnMoYSkgPCAxZS0xMikgewogICAgICBpZiAoTWF0aC5hYnMoYikgPj0gMWUtMTIpIHsKICAgICAgICB0aGlzLiNnZXRFeHRyZW11bU9uQ3VydmUoeDAsIHgxLCB4MiwgeDMsIHkwLCB5MSwgeTIsIHkzLCAtYyAvIGIsIG1pbk1heCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgZGVsdGEgPSBiICoqIDIgLSA0ICogYyAqIGE7CiAgICBpZiAoZGVsdGEgPCAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHNxcnREZWx0YSA9IE1hdGguc3FydChkZWx0YSk7CiAgICBjb25zdCBhMiA9IDIgKiBhOwogICAgdGhpcy4jZ2V0RXh0cmVtdW1PbkN1cnZlKHgwLCB4MSwgeDIsIHgzLCB5MCwgeTEsIHkyLCB5MywgKC1iICsgc3FydERlbHRhKSAvIGEyLCBtaW5NYXgpOwogICAgdGhpcy4jZ2V0RXh0cmVtdW1PbkN1cnZlKHgwLCB4MSwgeDIsIHgzLCB5MCwgeTEsIHkyLCB5MywgKC1iIC0gc3FydERlbHRhKSAvIGEyLCBtaW5NYXgpOwogIH0KICBzdGF0aWMgYmV6aWVyQm91bmRpbmdCb3goeDAsIHkwLCB4MSwgeTEsIHgyLCB5MiwgeDMsIHkzLCBtaW5NYXgpIHsKICAgIG1pbk1heFswXSA9IE1hdGgubWluKG1pbk1heFswXSwgeDAsIHgzKTsKICAgIG1pbk1heFsxXSA9IE1hdGgubWluKG1pbk1heFsxXSwgeTAsIHkzKTsKICAgIG1pbk1heFsyXSA9IE1hdGgubWF4KG1pbk1heFsyXSwgeDAsIHgzKTsKICAgIG1pbk1heFszXSA9IE1hdGgubWF4KG1pbk1heFszXSwgeTAsIHkzKTsKICAgIHRoaXMuI2dldEV4dHJlbXVtKHgwLCB4MSwgeDIsIHgzLCB5MCwgeTEsIHkyLCB5MywgMyAqICgteDAgKyAzICogKHgxIC0geDIpICsgeDMpLCA2ICogKHgwIC0gMiAqIHgxICsgeDIpLCAzICogKHgxIC0geDApLCBtaW5NYXgpOwogICAgdGhpcy4jZ2V0RXh0cmVtdW0oeDAsIHgxLCB4MiwgeDMsIHkwLCB5MSwgeTIsIHkzLCAzICogKC15MCArIDMgKiAoeTEgLSB5MikgKyB5MyksIDYgKiAoeTAgLSAyICogeTEgKyB5MiksIDMgKiAoeTEgLSB5MCksIG1pbk1heCk7CiAgfQp9OwpmdW5jdGlvbiBzdHJpbmdUb1VURjhTdHJpbmcoc3RyKSB7CiAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChlc2NhcGUoc3RyKSk7Cn0KdmFyIE5vcm1hbGl6ZVJlZ2V4ID0gbnVsbDsKdmFyIE5vcm1hbGl6YXRpb25NYXAgPSBudWxsOwpmdW5jdGlvbiBub3JtYWxpemVVbmljb2RlKHN0cikgewogIGlmICghTm9ybWFsaXplUmVnZXgpIHsKICAgIE5vcm1hbGl6ZVJlZ2V4ID0gLyhbXHUwMGEwXHUwMGI1XHUwMzdlXHUwZWIzXHUyMDAwLVx1MjAwYVx1MjAyZlx1MjEyNlx1ZmIwMC1cdWZiMDRcdWZiMDZcdWZiMjAtXHVmYjM2XHVmYjM4LVx1ZmIzY1x1ZmIzZVx1ZmI0MC1cdWZiNDFcdWZiNDMtXHVmYjQ0XHVmYjQ2LVx1ZmJhMVx1ZmJhNC1cdWZiYTlcdWZiYWUtXHVmYmIxXHVmYmQzLVx1ZmJkY1x1ZmJkZS1cdWZiZTdcdWZiZWEtXHVmYmY4XHVmYmZjLVx1ZmJmZFx1ZmMwMC1cdWZjNWRcdWZjNjQtXHVmY2YxXHVmY2Y1LVx1ZmQzZFx1ZmQ4OFx1ZmRmNFx1ZmRmYS1cdWZkZmJcdWZlNzFcdWZlNzdcdWZlNzlcdWZlN2JcdWZlN2RdKyl8KFx1ZmIwNSspL2d1OwogICAgTm9ybWFsaXphdGlvbk1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbIlx1RkIwNSIsICJcdTAxN0Z0Il1dKTsKICB9CiAgcmV0dXJuIHN0ci5yZXBsYWNlQWxsKE5vcm1hbGl6ZVJlZ2V4LCAoXywgcDEsIHAyKSA9PiBwMSA/IHAxLm5vcm1hbGl6ZSgiTkZLQyIpIDogTm9ybWFsaXphdGlvbk1hcC5nZXQocDIpKTsKfQpmdW5jdGlvbiBnZXRVdWlkKCkgewogIGlmICh0eXBlb2YgY3J5cHRvLnJhbmRvbVVVSUQgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBjcnlwdG8ucmFuZG9tVVVJRCgpOwogIH0KICBjb25zdCBidWYgPSBuZXcgVWludDhBcnJheSgzMik7CiAgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhidWYpOwogIHJldHVybiBieXRlc1RvU3RyaW5nKGJ1Zik7Cn0KdmFyIEFubm90YXRpb25QcmVmaXggPSAicGRmanNfaW50ZXJuYWxfaWRfIjsKZnVuY3Rpb24gX2lzVmFsaWRFeHBsaWNpdERlc3QodmFsaWRSZWYsIHZhbGlkTmFtZSwgZGVzdCkgewogIGlmICghQXJyYXkuaXNBcnJheShkZXN0KSB8fCBkZXN0Lmxlbmd0aCA8IDIpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3QgW3BhZ2UsIHpvb20sIC4uLmFyZ3NdID0gZGVzdDsKICBpZiAoIXZhbGlkUmVmKHBhZ2UpICYmICFOdW1iZXIuaXNJbnRlZ2VyKHBhZ2UpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmICghdmFsaWROYW1lKHpvb20pKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IGFyZ3NMZW4gPSBhcmdzLmxlbmd0aDsKICBsZXQgYWxsb3dOdWxsID0gdHJ1ZTsKICBzd2l0Y2ggKHpvb20ubmFtZSkgewogICAgY2FzZSAiWFlaIjoKICAgICAgaWYgKGFyZ3NMZW4gPCAyIHx8IGFyZ3NMZW4gPiAzKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGJyZWFrOwogICAgY2FzZSAiRml0IjoKICAgIGNhc2UgIkZpdEIiOgogICAgICByZXR1cm4gYXJnc0xlbiA9PT0gMDsKICAgIGNhc2UgIkZpdEgiOgogICAgY2FzZSAiRml0QkgiOgogICAgY2FzZSAiRml0ViI6CiAgICBjYXNlICJGaXRCViI6CiAgICAgIGlmIChhcmdzTGVuID4gMSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBicmVhazsKICAgIGNhc2UgIkZpdFIiOgogICAgICBpZiAoYXJnc0xlbiAhPT0gNCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBhbGxvd051bGwgPSBmYWxzZTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZvciAoY29uc3QgYXJnIG9mIGFyZ3MpIHsKICAgIGlmICh0eXBlb2YgYXJnID09PSAibnVtYmVyIiB8fCBhbGxvd051bGwgJiYgYXJnID09PSBudWxsKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBNYXRoQ2xhbXAodiwgbWluLCBtYXgpIHsKICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgodiwgbWluKSwgbWF4KTsKfQpmdW5jdGlvbiB0b0Jhc2U2NFV0aWwoYXJyKSB7CiAgaWYgKFVpbnQ4QXJyYXkucHJvdG90eXBlLnRvQmFzZTY0KSB7CiAgICByZXR1cm4gYXJyLnRvQmFzZTY0KCk7CiAgfQogIHJldHVybiBidG9hKGJ5dGVzVG9TdHJpbmcoYXJyKSk7Cn0KZnVuY3Rpb24gZnJvbUJhc2U2NFV0aWwoc3RyKSB7CiAgaWYgKFVpbnQ4QXJyYXkuZnJvbUJhc2U2NCkgewogICAgcmV0dXJuIFVpbnQ4QXJyYXkuZnJvbUJhc2U2NChzdHIpOwogIH0KICByZXR1cm4gc3RyaW5nVG9CeXRlcyhhdG9iKHN0cikpOwp9CmlmICh0eXBlb2YgUHJvbWlzZS50cnkgIT09ICJmdW5jdGlvbiIpIHsKICBQcm9taXNlLnRyeSA9IGZ1bmN0aW9uKGZuLCAuLi5hcmdzKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgcmVzb2x2ZShmbiguLi5hcmdzKSk7CiAgICB9KTsKICB9Owp9CmlmICh0eXBlb2YgTWF0aC5zdW1QcmVjaXNlICE9PSAiZnVuY3Rpb24iKSB7CiAgTWF0aC5zdW1QcmVjaXNlID0gZnVuY3Rpb24obnVtYmVycykgewogICAgcmV0dXJuIG51bWJlcnMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCk7CiAgfTsKfQp2YXIgWGZhVGV4dCA9IGNsYXNzIF9YZmFUZXh0IHsKICBzdGF0aWMgdGV4dENvbnRlbnQoeGZhKSB7CiAgICBjb25zdCBpdGVtcyA9IFtdOwogICAgY29uc3Qgb3V0cHV0ID0gewogICAgICBpdGVtcywKICAgICAgc3R5bGVzOiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKQogICAgfTsKICAgIGZ1bmN0aW9uIHdhbGsobm9kZSkgewogICAgICBpZiAoIW5vZGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbGV0IHN0ciA9IG51bGw7CiAgICAgIGNvbnN0IG5hbWUgPSBub2RlLm5hbWU7CiAgICAgIGlmIChuYW1lID09PSAiI3RleHQiKSB7CiAgICAgICAgc3RyID0gbm9kZS52YWx1ZTsKICAgICAgfSBlbHNlIGlmICghX1hmYVRleHQuc2hvdWxkQnVpbGRUZXh0KG5hbWUpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgaWYgKG5vZGU/LmF0dHJpYnV0ZXM/LnRleHRDb250ZW50KSB7CiAgICAgICAgc3RyID0gbm9kZS5hdHRyaWJ1dGVzLnRleHRDb250ZW50OwogICAgICB9IGVsc2UgaWYgKG5vZGUudmFsdWUpIHsKICAgICAgICBzdHIgPSBub2RlLnZhbHVlOwogICAgICB9CiAgICAgIGlmIChzdHIgIT09IG51bGwpIHsKICAgICAgICBpdGVtcy5wdXNoKHsKICAgICAgICAgIHN0cgogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghbm9kZS5jaGlsZHJlbikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIG5vZGUuY2hpbGRyZW4pIHsKICAgICAgICB3YWxrKGNoaWxkKTsKICAgICAgfQogICAgfQogICAgd2Fsayh4ZmEpOwogICAgcmV0dXJuIG91dHB1dDsKICB9CiAgc3RhdGljIHNob3VsZEJ1aWxkVGV4dChuYW1lKSB7CiAgICByZXR1cm4gIShuYW1lID09PSAidGV4dGFyZWEiIHx8IG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gIm9wdGlvbiIgfHwgbmFtZSA9PT0gInNlbGVjdCIpOwogIH0KfTsKdmFyIFhmYUxheWVyID0gY2xhc3MgewogIHN0YXRpYyBzZXR1cFN0b3JhZ2UoaHRtbCwgaWQsIGVsZW1lbnQsIHN0b3JhZ2UsIGludGVudCkgewogICAgY29uc3Qgc3RvcmVkRGF0YSA9IHN0b3JhZ2UuZ2V0VmFsdWUoaWQsIHsKICAgICAgdmFsdWU6IG51bGwKICAgIH0pOwogICAgc3dpdGNoIChlbGVtZW50Lm5hbWUpIHsKICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgIGlmIChzdG9yZWREYXRhLnZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICBodG1sLnRleHRDb250ZW50ID0gc3RvcmVkRGF0YS52YWx1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGludGVudCA9PT0gInByaW50IikgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGh0bWwuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCAoZXZlbnQpID0+IHsKICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgdmFsdWU6IGV2ZW50LnRhcmdldC52YWx1ZQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICBpZiAoZWxlbWVudC5hdHRyaWJ1dGVzLnR5cGUgPT09ICJyYWRpbyIgfHwgZWxlbWVudC5hdHRyaWJ1dGVzLnR5cGUgPT09ICJjaGVja2JveCIpIHsKICAgICAgICAgIGlmIChzdG9yZWREYXRhLnZhbHVlID09PSBlbGVtZW50LmF0dHJpYnV0ZXMueGZhT24pIHsKICAgICAgICAgICAgaHRtbC5zZXRBdHRyaWJ1dGUoImNoZWNrZWQiLCB0cnVlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RvcmVkRGF0YS52YWx1ZSA9PT0gZWxlbWVudC5hdHRyaWJ1dGVzLnhmYU9mZikgewogICAgICAgICAgICBodG1sLnJlbW92ZUF0dHJpYnV0ZSgiY2hlY2tlZCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGludGVudCA9PT0gInByaW50IikgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGh0bWwuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogZXZlbnQudGFyZ2V0LmNoZWNrZWQgPyBldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCJ4ZmFPbiIpIDogZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgieGZhT2ZmIikKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHN0b3JlZERhdGEudmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaHRtbC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgc3RvcmVkRGF0YS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW50ZW50ID09PSAicHJpbnQiKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaHRtbC5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsIChldmVudCkgPT4gewogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWU6IGV2ZW50LnRhcmdldC52YWx1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICBpZiAoc3RvcmVkRGF0YS52YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgaHRtbC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgc3RvcmVkRGF0YS52YWx1ZSk7CiAgICAgICAgICBmb3IgKGNvbnN0IG9wdGlvbiBvZiBlbGVtZW50LmNoaWxkcmVuKSB7CiAgICAgICAgICAgIGlmIChvcHRpb24uYXR0cmlidXRlcy52YWx1ZSA9PT0gc3RvcmVkRGF0YS52YWx1ZSkgewogICAgICAgICAgICAgIG9wdGlvbi5hdHRyaWJ1dGVzLnNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb24uYXR0cmlidXRlcy5oYXNPd25Qcm9wZXJ0eSgic2VsZWN0ZWQiKSkgewogICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb24uYXR0cmlidXRlcy5zZWxlY3RlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sLmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICBjb25zdCBvcHRpb25zID0gZXZlbnQudGFyZ2V0Lm9wdGlvbnM7CiAgICAgICAgICBjb25zdCB2YWx1ZSA9IG9wdGlvbnMuc2VsZWN0ZWRJbmRleCA9PT0gLTEgPyAiIiA6IG9wdGlvbnNbb3B0aW9ucy5zZWxlY3RlZEluZGV4XS52YWx1ZTsKICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgdmFsdWUKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICBzdGF0aWMgc2V0QXR0cmlidXRlcyh7CiAgICBodG1sLAogICAgZWxlbWVudCwKICAgIHN0b3JhZ2UgPSBudWxsLAogICAgaW50ZW50LAogICAgbGlua1NlcnZpY2UKICB9KSB7CiAgICBjb25zdCB7CiAgICAgIGF0dHJpYnV0ZXMKICAgIH0gPSBlbGVtZW50OwogICAgY29uc3QgaXNIVE1MQW5jaG9yRWxlbWVudCA9IGh0bWwgaW5zdGFuY2VvZiBIVE1MQW5jaG9yRWxlbWVudDsKICAgIGlmIChhdHRyaWJ1dGVzLnR5cGUgPT09ICJyYWRpbyIpIHsKICAgICAgYXR0cmlidXRlcy5uYW1lID0gYCR7YXR0cmlidXRlcy5uYW1lfS0ke2ludGVudH1gOwogICAgfQogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoYXR0cmlidXRlcykpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgaHRtbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWx1ZS5qb2luKCIgIikpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZGF0YUlkIjoKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgImlkIjoKICAgICAgICAgIGh0bWwuc2V0QXR0cmlidXRlKCJkYXRhLWVsZW1lbnQtaWQiLCB2YWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICBPYmplY3QuYXNzaWduKGh0bWwuc3R5bGUsIHZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInRleHRDb250ZW50IjoKICAgICAgICAgIGh0bWwudGV4dENvbnRlbnQgPSB2YWx1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAoIWlzSFRNTEFuY2hvckVsZW1lbnQgfHwga2V5ICE9PSAiaHJlZiIgJiYga2V5ICE9PSAibmV3V2luZG93IikgewogICAgICAgICAgICBodG1sLnNldEF0dHJpYnV0ZShrZXksIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGlzSFRNTEFuY2hvckVsZW1lbnQpIHsKICAgICAgbGlua1NlcnZpY2UuYWRkTGlua0F0dHJpYnV0ZXMoaHRtbCwgYXR0cmlidXRlcy5ocmVmLCBhdHRyaWJ1dGVzLm5ld1dpbmRvdyk7CiAgICB9CiAgICBpZiAoc3RvcmFnZSAmJiBhdHRyaWJ1dGVzLmRhdGFJZCkgewogICAgICB0aGlzLnNldHVwU3RvcmFnZShodG1sLCBhdHRyaWJ1dGVzLmRhdGFJZCwgZWxlbWVudCwgc3RvcmFnZSk7CiAgICB9CiAgfQogIHN0YXRpYyByZW5kZXIocGFyYW1ldGVycykgewogICAgY29uc3Qgc3RvcmFnZSA9IHBhcmFtZXRlcnMuYW5ub3RhdGlvblN0b3JhZ2U7CiAgICBjb25zdCBsaW5rU2VydmljZSA9IHBhcmFtZXRlcnMubGlua1NlcnZpY2U7CiAgICBjb25zdCByb290MiA9IHBhcmFtZXRlcnMueGZhSHRtbDsKICAgIGNvbnN0IGludGVudCA9IHBhcmFtZXRlcnMuaW50ZW50IHx8ICJkaXNwbGF5IjsKICAgIGNvbnN0IHJvb3RIdG1sID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChyb290Mi5uYW1lKTsKICAgIGlmIChyb290Mi5hdHRyaWJ1dGVzKSB7CiAgICAgIHRoaXMuc2V0QXR0cmlidXRlcyh7CiAgICAgICAgaHRtbDogcm9vdEh0bWwsCiAgICAgICAgZWxlbWVudDogcm9vdDIsCiAgICAgICAgaW50ZW50LAogICAgICAgIGxpbmtTZXJ2aWNlCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgaXNOb3RGb3JSaWNoVGV4dCA9IGludGVudCAhPT0gInJpY2hUZXh0IjsKICAgIGNvbnN0IHJvb3REaXYgPSBwYXJhbWV0ZXJzLmRpdjsKICAgIHJvb3REaXYuYXBwZW5kKHJvb3RIdG1sKTsKICAgIGlmIChwYXJhbWV0ZXJzLnZpZXdwb3J0KSB7CiAgICAgIGNvbnN0IHRyYW5zZm9ybSA9IGBtYXRyaXgoJHtwYXJhbWV0ZXJzLnZpZXdwb3J0LnRyYW5zZm9ybS5qb2luKCIsIil9KWA7CiAgICAgIHJvb3REaXYuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgfQogICAgaWYgKGlzTm90Rm9yUmljaFRleHQpIHsKICAgICAgcm9vdERpdi5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgInhmYUxheWVyIHhmYUZvbnQiKTsKICAgIH0KICAgIGNvbnN0IHRleHREaXZzID0gW107CiAgICBpZiAocm9vdDIuY2hpbGRyZW4ubGVuZ3RoID09PSAwKSB7CiAgICAgIGlmIChyb290Mi52YWx1ZSkgewogICAgICAgIGNvbnN0IG5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShyb290Mi52YWx1ZSk7CiAgICAgICAgcm9vdEh0bWwuYXBwZW5kKG5vZGUpOwogICAgICAgIGlmIChpc05vdEZvclJpY2hUZXh0ICYmIFhmYVRleHQuc2hvdWxkQnVpbGRUZXh0KHJvb3QyLm5hbWUpKSB7CiAgICAgICAgICB0ZXh0RGl2cy5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHRleHREaXZzCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBzdGFjayA9IFtbcm9vdDIsIC0xLCByb290SHRtbF1dOwogICAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgW3BhcmVudCwgaSwgaHRtbF0gPSBzdGFjay5hdCgtMSk7CiAgICAgIGlmIChpICsgMSA9PT0gcGFyZW50LmNoaWxkcmVuLmxlbmd0aCkgewogICAgICAgIHN0YWNrLnBvcCgpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGNoaWxkID0gcGFyZW50LmNoaWxkcmVuWysrc3RhY2suYXQoLTEpWzFdXTsKICAgICAgaWYgKGNoaWxkID09PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgewogICAgICAgIG5hbWUKICAgICAgfSA9IGNoaWxkOwogICAgICBpZiAobmFtZSA9PT0gIiN0ZXh0IikgewogICAgICAgIGNvbnN0IG5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjaGlsZC52YWx1ZSk7CiAgICAgICAgdGV4dERpdnMucHVzaChub2RlKTsKICAgICAgICBodG1sLmFwcGVuZChub2RlKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBjaGlsZEh0bWwgPSBjaGlsZD8uYXR0cmlidXRlcz8ueG1sbnMgPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoY2hpbGQuYXR0cmlidXRlcy54bWxucywgbmFtZSkgOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG5hbWUpOwogICAgICBodG1sLmFwcGVuZChjaGlsZEh0bWwpOwogICAgICBpZiAoY2hpbGQuYXR0cmlidXRlcykgewogICAgICAgIHRoaXMuc2V0QXR0cmlidXRlcyh7CiAgICAgICAgICBodG1sOiBjaGlsZEh0bWwsCiAgICAgICAgICBlbGVtZW50OiBjaGlsZCwKICAgICAgICAgIHN0b3JhZ2UsCiAgICAgICAgICBpbnRlbnQsCiAgICAgICAgICBsaW5rU2VydmljZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChjaGlsZC5jaGlsZHJlbj8ubGVuZ3RoID4gMCkgewogICAgICAgIHN0YWNrLnB1c2goW2NoaWxkLCAtMSwgY2hpbGRIdG1sXSk7CiAgICAgIH0gZWxzZSBpZiAoY2hpbGQudmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY2hpbGQudmFsdWUpOwogICAgICAgIGlmIChpc05vdEZvclJpY2hUZXh0ICYmIFhmYVRleHQuc2hvdWxkQnVpbGRUZXh0KG5hbWUpKSB7CiAgICAgICAgICB0ZXh0RGl2cy5wdXNoKG5vZGUpOwogICAgICAgIH0KICAgICAgICBjaGlsZEh0bWwuYXBwZW5kKG5vZGUpOwogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IGVsIG9mIHJvb3REaXYucXVlcnlTZWxlY3RvckFsbCgiLnhmYU5vbkludGVyYWN0aXZlIGlucHV0LCAueGZhTm9uSW50ZXJhY3RpdmUgdGV4dGFyZWEiKSkgewogICAgICBlbC5zZXRBdHRyaWJ1dGUoInJlYWRPbmx5IiwgdHJ1ZSk7CiAgICB9CiAgICByZXR1cm4gewogICAgICB0ZXh0RGl2cwogICAgfTsKICB9CiAgc3RhdGljIHVwZGF0ZShwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCB0cmFuc2Zvcm0gPSBgbWF0cml4KCR7cGFyYW1ldGVycy52aWV3cG9ydC50cmFuc2Zvcm0uam9pbigiLCIpfSlgOwogICAgcGFyYW1ldGVycy5kaXYuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgcGFyYW1ldGVycy5kaXYuaGlkZGVuID0gZmFsc2U7CiAgfQp9Owp2YXIgU1ZHX05TID0gImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIjsKdmFyIFBpeGVsc1BlckluY2ggPSBjbGFzcyB7CiAgc3RhdGljIENTUyA9IDk2OwogIHN0YXRpYyBQREYgPSA3MjsKICBzdGF0aWMgUERGX1RPX0NTU19VTklUUyA9IHRoaXMuQ1NTIC8gdGhpcy5QREY7Cn07CmFzeW5jIGZ1bmN0aW9uIGZldGNoRGF0YSh1cmwsIHR5cGUgPSAidGV4dCIpIHsKICBpZiAoaXNWYWxpZEZldGNoVXJsKHVybCwgZG9jdW1lbnQuYmFzZVVSSSkpIHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTsKICAgIGlmICghcmVzcG9uc2Uub2spIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3BvbnNlLnN0YXR1c1RleHQpOwogICAgfQogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgImFycmF5YnVmZmVyIjoKICAgICAgICByZXR1cm4gcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTsKICAgICAgY2FzZSAiYmxvYiI6CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJsb2IoKTsKICAgICAgY2FzZSAianNvbiI6CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKICAgIH0KICAgIHJldHVybiByZXNwb25zZS50ZXh0KCk7CiAgfQogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICByZXF1ZXN0Lm9wZW4oIkdFVCIsIHVybCwgdHJ1ZSk7CiAgICByZXF1ZXN0LnJlc3BvbnNlVHlwZSA9IHR5cGU7CiAgICByZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9ICgpID0+IHsKICAgICAgaWYgKHJlcXVlc3QucmVhZHlTdGF0ZSAhPT0gWE1MSHR0cFJlcXVlc3QuRE9ORSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAocmVxdWVzdC5zdGF0dXMgPT09IDIwMCB8fCByZXF1ZXN0LnN0YXR1cyA9PT0gMCkgewogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSAiYXJyYXlidWZmZXIiOgogICAgICAgICAgY2FzZSAiYmxvYiI6CiAgICAgICAgICBjYXNlICJqc29uIjoKICAgICAgICAgICAgcmVzb2x2ZShyZXF1ZXN0LnJlc3BvbnNlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzcG9uc2VUZXh0KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgcmVqZWN0KG5ldyBFcnJvcihyZXF1ZXN0LnN0YXR1c1RleHQpKTsKICAgIH07CiAgICByZXF1ZXN0LnNlbmQobnVsbCk7CiAgfSk7Cn0KdmFyIFBhZ2VWaWV3cG9ydCA9IGNsYXNzIF9QYWdlVmlld3BvcnQgewogIGNvbnN0cnVjdG9yKHsKICAgIHZpZXdCb3gsCiAgICB1c2VyVW5pdCwKICAgIHNjYWxlLAogICAgcm90YXRpb24sCiAgICBvZmZzZXRYID0gMCwKICAgIG9mZnNldFkgPSAwLAogICAgZG9udEZsaXAgPSBmYWxzZQogIH0pIHsKICAgIHRoaXMudmlld0JveCA9IHZpZXdCb3g7CiAgICB0aGlzLnVzZXJVbml0ID0gdXNlclVuaXQ7CiAgICB0aGlzLnNjYWxlID0gc2NhbGU7CiAgICB0aGlzLnJvdGF0aW9uID0gcm90YXRpb247CiAgICB0aGlzLm9mZnNldFggPSBvZmZzZXRYOwogICAgdGhpcy5vZmZzZXRZID0gb2Zmc2V0WTsKICAgIHNjYWxlICo9IHVzZXJVbml0OwogICAgY29uc3QgY2VudGVyWCA9ICh2aWV3Qm94WzJdICsgdmlld0JveFswXSkgLyAyOwogICAgY29uc3QgY2VudGVyWSA9ICh2aWV3Qm94WzNdICsgdmlld0JveFsxXSkgLyAyOwogICAgbGV0IHJvdGF0ZUEsIHJvdGF0ZUIsIHJvdGF0ZUMsIHJvdGF0ZUQ7CiAgICByb3RhdGlvbiAlPSAzNjA7CiAgICBpZiAocm90YXRpb24gPCAwKSB7CiAgICAgIHJvdGF0aW9uICs9IDM2MDsKICAgIH0KICAgIHN3aXRjaCAocm90YXRpb24pIHsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcm90YXRlQSA9IC0xOwogICAgICAgIHJvdGF0ZUIgPSAwOwogICAgICAgIHJvdGF0ZUMgPSAwOwogICAgICAgIHJvdGF0ZUQgPSAxOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDkwOgogICAgICAgIHJvdGF0ZUEgPSAwOwogICAgICAgIHJvdGF0ZUIgPSAxOwogICAgICAgIHJvdGF0ZUMgPSAxOwogICAgICAgIHJvdGF0ZUQgPSAwOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI3MDoKICAgICAgICByb3RhdGVBID0gMDsKICAgICAgICByb3RhdGVCID0gLTE7CiAgICAgICAgcm90YXRlQyA9IC0xOwogICAgICAgIHJvdGF0ZUQgPSAwOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDA6CiAgICAgICAgcm90YXRlQSA9IDE7CiAgICAgICAgcm90YXRlQiA9IDA7CiAgICAgICAgcm90YXRlQyA9IDA7CiAgICAgICAgcm90YXRlRCA9IC0xOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiUGFnZVZpZXdwb3J0OiBJbnZhbGlkIHJvdGF0aW9uLCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgOTAgZGVncmVlcy4iKTsKICAgIH0KICAgIGlmIChkb250RmxpcCkgewogICAgICByb3RhdGVDID0gLXJvdGF0ZUM7CiAgICAgIHJvdGF0ZUQgPSAtcm90YXRlRDsKICAgIH0KICAgIGxldCBvZmZzZXRDYW52YXNYLCBvZmZzZXRDYW52YXNZOwogICAgbGV0IHdpZHRoLCBoZWlnaHQ7CiAgICBpZiAocm90YXRlQSA9PT0gMCkgewogICAgICBvZmZzZXRDYW52YXNYID0gTWF0aC5hYnMoY2VudGVyWSAtIHZpZXdCb3hbMV0pICogc2NhbGUgKyBvZmZzZXRYOwogICAgICBvZmZzZXRDYW52YXNZID0gTWF0aC5hYnMoY2VudGVyWCAtIHZpZXdCb3hbMF0pICogc2NhbGUgKyBvZmZzZXRZOwogICAgICB3aWR0aCA9ICh2aWV3Qm94WzNdIC0gdmlld0JveFsxXSkgKiBzY2FsZTsKICAgICAgaGVpZ2h0ID0gKHZpZXdCb3hbMl0gLSB2aWV3Qm94WzBdKSAqIHNjYWxlOwogICAgfSBlbHNlIHsKICAgICAgb2Zmc2V0Q2FudmFzWCA9IE1hdGguYWJzKGNlbnRlclggLSB2aWV3Qm94WzBdKSAqIHNjYWxlICsgb2Zmc2V0WDsKICAgICAgb2Zmc2V0Q2FudmFzWSA9IE1hdGguYWJzKGNlbnRlclkgLSB2aWV3Qm94WzFdKSAqIHNjYWxlICsgb2Zmc2V0WTsKICAgICAgd2lkdGggPSAodmlld0JveFsyXSAtIHZpZXdCb3hbMF0pICogc2NhbGU7CiAgICAgIGhlaWdodCA9ICh2aWV3Qm94WzNdIC0gdmlld0JveFsxXSkgKiBzY2FsZTsKICAgIH0KICAgIHRoaXMudHJhbnNmb3JtID0gW3JvdGF0ZUEgKiBzY2FsZSwgcm90YXRlQiAqIHNjYWxlLCByb3RhdGVDICogc2NhbGUsIHJvdGF0ZUQgKiBzY2FsZSwgb2Zmc2V0Q2FudmFzWCAtIHJvdGF0ZUEgKiBzY2FsZSAqIGNlbnRlclggLSByb3RhdGVDICogc2NhbGUgKiBjZW50ZXJZLCBvZmZzZXRDYW52YXNZIC0gcm90YXRlQiAqIHNjYWxlICogY2VudGVyWCAtIHJvdGF0ZUQgKiBzY2FsZSAqIGNlbnRlclldOwogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgfQogIGdldCByYXdEaW1zKCkgewogICAgY29uc3QgZGltcyA9IHRoaXMudmlld0JveDsKICAgIHJldHVybiBzaGFkb3codGhpcywgInJhd0RpbXMiLCB7CiAgICAgIHBhZ2VXaWR0aDogZGltc1syXSAtIGRpbXNbMF0sCiAgICAgIHBhZ2VIZWlnaHQ6IGRpbXNbM10gLSBkaW1zWzFdLAogICAgICBwYWdlWDogZGltc1swXSwKICAgICAgcGFnZVk6IGRpbXNbMV0KICAgIH0pOwogIH0KICBjbG9uZSh7CiAgICBzY2FsZSA9IHRoaXMuc2NhbGUsCiAgICByb3RhdGlvbiA9IHRoaXMucm90YXRpb24sCiAgICBvZmZzZXRYID0gdGhpcy5vZmZzZXRYLAogICAgb2Zmc2V0WSA9IHRoaXMub2Zmc2V0WSwKICAgIGRvbnRGbGlwID0gZmFsc2UKICB9ID0ge30pIHsKICAgIHJldHVybiBuZXcgX1BhZ2VWaWV3cG9ydCh7CiAgICAgIHZpZXdCb3g6IHRoaXMudmlld0JveC5zbGljZSgpLAogICAgICB1c2VyVW5pdDogdGhpcy51c2VyVW5pdCwKICAgICAgc2NhbGUsCiAgICAgIHJvdGF0aW9uLAogICAgICBvZmZzZXRYLAogICAgICBvZmZzZXRZLAogICAgICBkb250RmxpcAogICAgfSk7CiAgfQogIGNvbnZlcnRUb1ZpZXdwb3J0UG9pbnQoeCwgeSkgewogICAgY29uc3QgcCA9IFt4LCB5XTsKICAgIFV0aWwuYXBwbHlUcmFuc2Zvcm0ocCwgdGhpcy50cmFuc2Zvcm0pOwogICAgcmV0dXJuIHA7CiAgfQogIGNvbnZlcnRUb1ZpZXdwb3J0UmVjdGFuZ2xlKHJlY3QpIHsKICAgIGNvbnN0IHRvcExlZnQgPSBbcmVjdFswXSwgcmVjdFsxXV07CiAgICBVdGlsLmFwcGx5VHJhbnNmb3JtKHRvcExlZnQsIHRoaXMudHJhbnNmb3JtKTsKICAgIGNvbnN0IGJvdHRvbVJpZ2h0ID0gW3JlY3RbMl0sIHJlY3RbM11dOwogICAgVXRpbC5hcHBseVRyYW5zZm9ybShib3R0b21SaWdodCwgdGhpcy50cmFuc2Zvcm0pOwogICAgcmV0dXJuIFt0b3BMZWZ0WzBdLCB0b3BMZWZ0WzFdLCBib3R0b21SaWdodFswXSwgYm90dG9tUmlnaHRbMV1dOwogIH0KICBjb252ZXJ0VG9QZGZQb2ludCh4LCB5KSB7CiAgICBjb25zdCBwID0gW3gsIHldOwogICAgVXRpbC5hcHBseUludmVyc2VUcmFuc2Zvcm0ocCwgdGhpcy50cmFuc2Zvcm0pOwogICAgcmV0dXJuIHA7CiAgfQp9Owp2YXIgUmVuZGVyaW5nQ2FuY2VsbGVkRXhjZXB0aW9uID0gY2xhc3MgZXh0ZW5kcyBCYXNlRXhjZXB0aW9uIHsKICBjb25zdHJ1Y3Rvcihtc2csIGV4dHJhRGVsYXkgPSAwKSB7CiAgICBzdXBlcihtc2csICJSZW5kZXJpbmdDYW5jZWxsZWRFeGNlcHRpb24iKTsKICAgIHRoaXMuZXh0cmFEZWxheSA9IGV4dHJhRGVsYXk7CiAgfQp9OwpmdW5jdGlvbiBpc0RhdGFTY2hlbWUodXJsKSB7CiAgY29uc3QgaWkgPSB1cmwubGVuZ3RoOwogIGxldCBpID0gMDsKICB3aGlsZSAoaSA8IGlpICYmIHVybFtpXS50cmltKCkgPT09ICIiKSB7CiAgICBpKys7CiAgfQogIHJldHVybiB1cmwuc3Vic3RyaW5nKGksIGkgKyA1KS50b0xvd2VyQ2FzZSgpID09PSAiZGF0YToiOwp9CmZ1bmN0aW9uIGlzUGRmRmlsZShmaWxlbmFtZSkgewogIHJldHVybiB0eXBlb2YgZmlsZW5hbWUgPT09ICJzdHJpbmciICYmIC9cLnBkZiQvaS50ZXN0KGZpbGVuYW1lKTsKfQpmdW5jdGlvbiBnZXRGaWxlbmFtZUZyb21VcmwodXJsKSB7CiAgW3VybF0gPSB1cmwuc3BsaXQoL1sjP10vLCAxKTsKICByZXR1cm4gdXJsLnN1YnN0cmluZyh1cmwubGFzdEluZGV4T2YoIi8iKSArIDEpOwp9CmZ1bmN0aW9uIGdldFBkZkZpbGVuYW1lRnJvbVVybCh1cmwsIGRlZmF1bHRGaWxlbmFtZSA9ICJkb2N1bWVudC5wZGYiKSB7CiAgaWYgKHR5cGVvZiB1cmwgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZGVmYXVsdEZpbGVuYW1lOwogIH0KICBpZiAoaXNEYXRhU2NoZW1lKHVybCkpIHsKICAgIHdhcm4oJ2dldFBkZkZpbGVuYW1lRnJvbVVybDogaWdub3JlICJkYXRhOiItVVJMIGZvciBwZXJmb3JtYW5jZSByZWFzb25zLicpOwogICAgcmV0dXJuIGRlZmF1bHRGaWxlbmFtZTsKICB9CiAgY29uc3QgZ2V0VVJMID0gKHVybFN0cmluZykgPT4gewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBVUkwodXJsU3RyaW5nKTsKICAgIH0gY2F0Y2ggewogICAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKGRlY29kZVVSSUNvbXBvbmVudCh1cmxTdHJpbmcpKTsKICAgICAgfSBjYXRjaCB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBuZXcgVVJMKHVybFN0cmluZywgImh0dHBzOi8vZm9vLmJhciIpOwogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBVUkwoZGVjb2RlVVJJQ29tcG9uZW50KHVybFN0cmluZyksICJodHRwczovL2Zvby5iYXIiKTsKICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIGNvbnN0IG5ld1VSTCA9IGdldFVSTCh1cmwpOwogIGlmICghbmV3VVJMKSB7CiAgICByZXR1cm4gZGVmYXVsdEZpbGVuYW1lOwogIH0KICBjb25zdCBkZWNvZGUgPSAobmFtZSkgPT4gewogICAgdHJ5IHsKICAgICAgbGV0IGRlY29kZWQgPSBkZWNvZGVVUklDb21wb25lbnQobmFtZSk7CiAgICAgIGlmIChkZWNvZGVkLmluY2x1ZGVzKCIvIikpIHsKICAgICAgICBkZWNvZGVkID0gZGVjb2RlZC5zcGxpdCgiLyIpLmF0KC0xKTsKICAgICAgICBpZiAoZGVjb2RlZC50ZXN0KC9eXC5wZGYkL2kpKSB7CiAgICAgICAgICByZXR1cm4gZGVjb2RlZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlY29kZWQ7CiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgfTsKICBjb25zdCBwZGZSZWdleCA9IC9cLnBkZiQvaTsKICBjb25zdCBmaWxlbmFtZSA9IG5ld1VSTC5wYXRobmFtZS5zcGxpdCgiLyIpLmF0KC0xKTsKICBpZiAocGRmUmVnZXgudGVzdChmaWxlbmFtZSkpIHsKICAgIHJldHVybiBkZWNvZGUoZmlsZW5hbWUpOwogIH0KICBpZiAobmV3VVJMLnNlYXJjaFBhcmFtcy5zaXplID4gMCkgewogICAgY29uc3QgdmFsdWVzID0gQXJyYXkuZnJvbShuZXdVUkwuc2VhcmNoUGFyYW1zLnZhbHVlcygpKS5yZXZlcnNlKCk7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAocGRmUmVnZXgudGVzdCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZGVjb2RlKHZhbHVlKTsKICAgICAgfQogICAgfQogICAgY29uc3Qga2V5cyA9IEFycmF5LmZyb20obmV3VVJMLnNlYXJjaFBhcmFtcy5rZXlzKCkpLnJldmVyc2UoKTsKICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgaWYgKHBkZlJlZ2V4LnRlc3Qoa2V5KSkgewogICAgICAgIHJldHVybiBkZWNvZGUoa2V5KTsKICAgICAgfQogICAgfQogIH0KICBpZiAobmV3VVJMLmhhc2gpIHsKICAgIGNvbnN0IHJlRmlsZW5hbWUgPSAvW14vPyM9XStcLnBkZlxiKD8hLipcLnBkZlxiKS9pOwogICAgY29uc3QgaGFzaEZpbGVuYW1lID0gcmVGaWxlbmFtZS5leGVjKG5ld1VSTC5oYXNoKTsKICAgIGlmIChoYXNoRmlsZW5hbWUpIHsKICAgICAgcmV0dXJuIGRlY29kZShoYXNoRmlsZW5hbWVbMF0pOwogICAgfQogIH0KICByZXR1cm4gZGVmYXVsdEZpbGVuYW1lOwp9CnZhciBTdGF0VGltZXIgPSBjbGFzcyB7CiAgc3RhcnRlZCA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogIHRpbWVzID0gW107CiAgdGltZShuYW1lKSB7CiAgICBpZiAobmFtZSBpbiB0aGlzLnN0YXJ0ZWQpIHsKICAgICAgd2FybihgVGltZXIgaXMgYWxyZWFkeSBydW5uaW5nIGZvciAke25hbWV9YCk7CiAgICB9CiAgICB0aGlzLnN0YXJ0ZWRbbmFtZV0gPSBEYXRlLm5vdygpOwogIH0KICB0aW1lRW5kKG5hbWUpIHsKICAgIGlmICghKG5hbWUgaW4gdGhpcy5zdGFydGVkKSkgewogICAgICB3YXJuKGBUaW1lciBoYXMgbm90IGJlZW4gc3RhcnRlZCBmb3IgJHtuYW1lfWApOwogICAgfQogICAgdGhpcy50aW1lcy5wdXNoKHsKICAgICAgbmFtZSwKICAgICAgc3RhcnQ6IHRoaXMuc3RhcnRlZFtuYW1lXSwKICAgICAgZW5kOiBEYXRlLm5vdygpCiAgICB9KTsKICAgIGRlbGV0ZSB0aGlzLnN0YXJ0ZWRbbmFtZV07CiAgfQogIHRvU3RyaW5nKCkgewogICAgY29uc3Qgb3V0QnVmID0gW107CiAgICBsZXQgbG9uZ2VzdCA9IDA7CiAgICBmb3IgKGNvbnN0IHsKICAgICAgbmFtZQogICAgfSBvZiB0aGlzLnRpbWVzKSB7CiAgICAgIGxvbmdlc3QgPSBNYXRoLm1heChuYW1lLmxlbmd0aCwgbG9uZ2VzdCk7CiAgICB9CiAgICBmb3IgKGNvbnN0IHsKICAgICAgbmFtZSwKICAgICAgc3RhcnQsCiAgICAgIGVuZAogICAgfSBvZiB0aGlzLnRpbWVzKSB7CiAgICAgIG91dEJ1Zi5wdXNoKGAke25hbWUucGFkRW5kKGxvbmdlc3QpfSAke2VuZCAtIHN0YXJ0fW1zCmApOwogICAgfQogICAgcmV0dXJuIG91dEJ1Zi5qb2luKCIiKTsKICB9Cn07CmZ1bmN0aW9uIGlzVmFsaWRGZXRjaFVybCh1cmwsIGJhc2VVcmwpIHsKICBjb25zdCByZXMgPSBiYXNlVXJsID8gVVJMLnBhcnNlKHVybCwgYmFzZVVybCkgOiBVUkwucGFyc2UodXJsKTsKICByZXR1cm4gcmVzPy5wcm90b2NvbCA9PT0gImh0dHA6IiB8fCByZXM/LnByb3RvY29sID09PSAiaHR0cHM6IjsKfQpmdW5jdGlvbiBub0NvbnRleHRNZW51KGUpIHsKICBlLnByZXZlbnREZWZhdWx0KCk7Cn0KZnVuY3Rpb24gc3RvcEV2ZW50KGUpIHsKICBlLnByZXZlbnREZWZhdWx0KCk7CiAgZS5zdG9wUHJvcGFnYXRpb24oKTsKfQpmdW5jdGlvbiBkZXByZWNhdGVkKGRldGFpbHMpIHsKICBjb25zb2xlLmxvZygiRGVwcmVjYXRlZCBBUEkgdXNhZ2U6ICIgKyBkZXRhaWxzKTsKfQp2YXIgUERGRGF0ZVN0cmluZyA9IGNsYXNzIHsKICBzdGF0aWMgI3JlZ2V4OwogIHN0YXRpYyB0b0RhdGVPYmplY3QoaW5wdXQpIHsKICAgIGlmIChpbnB1dCBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgcmV0dXJuIGlucHV0OwogICAgfQogICAgaWYgKCFpbnB1dCB8fCB0eXBlb2YgaW5wdXQgIT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdGhpcy4jcmVnZXggfHw9IG5ldyBSZWdFeHAoIl5EOihcXGR7NH0pKFxcZHsyfSk/KFxcZHsyfSk/KFxcZHsyfSk/KFxcZHsyfSk/KFxcZHsyfSk/KFtafCt8LV0pPyhcXGR7Mn0pPyc/KFxcZHsyfSk/Jz8iKTsKICAgIGNvbnN0IG1hdGNoZXMgPSB0aGlzLiNyZWdleC5leGVjKGlucHV0KTsKICAgIGlmICghbWF0Y2hlcykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHllYXIgPSBwYXJzZUludChtYXRjaGVzWzFdLCAxMCk7CiAgICBsZXQgbW9udGggPSBwYXJzZUludChtYXRjaGVzWzJdLCAxMCk7CiAgICBtb250aCA9IG1vbnRoID49IDEgJiYgbW9udGggPD0gMTIgPyBtb250aCAtIDEgOiAwOwogICAgbGV0IGRheSA9IHBhcnNlSW50KG1hdGNoZXNbM10sIDEwKTsKICAgIGRheSA9IGRheSA+PSAxICYmIGRheSA8PSAzMSA/IGRheSA6IDE7CiAgICBsZXQgaG91ciA9IHBhcnNlSW50KG1hdGNoZXNbNF0sIDEwKTsKICAgIGhvdXIgPSBob3VyID49IDAgJiYgaG91ciA8PSAyMyA/IGhvdXIgOiAwOwogICAgbGV0IG1pbnV0ZSA9IHBhcnNlSW50KG1hdGNoZXNbNV0sIDEwKTsKICAgIG1pbnV0ZSA9IG1pbnV0ZSA+PSAwICYmIG1pbnV0ZSA8PSA1OSA/IG1pbnV0ZSA6IDA7CiAgICBsZXQgc2Vjb25kID0gcGFyc2VJbnQobWF0Y2hlc1s2XSwgMTApOwogICAgc2Vjb25kID0gc2Vjb25kID49IDAgJiYgc2Vjb25kIDw9IDU5ID8gc2Vjb25kIDogMDsKICAgIGNvbnN0IHVuaXZlcnNhbFRpbWVSZWxhdGlvbiA9IG1hdGNoZXNbN10gfHwgIloiOwogICAgbGV0IG9mZnNldEhvdXIgPSBwYXJzZUludChtYXRjaGVzWzhdLCAxMCk7CiAgICBvZmZzZXRIb3VyID0gb2Zmc2V0SG91ciA+PSAwICYmIG9mZnNldEhvdXIgPD0gMjMgPyBvZmZzZXRIb3VyIDogMDsKICAgIGxldCBvZmZzZXRNaW51dGUgPSBwYXJzZUludChtYXRjaGVzWzldLCAxMCkgfHwgMDsKICAgIG9mZnNldE1pbnV0ZSA9IG9mZnNldE1pbnV0ZSA+PSAwICYmIG9mZnNldE1pbnV0ZSA8PSA1OSA/IG9mZnNldE1pbnV0ZSA6IDA7CiAgICBpZiAodW5pdmVyc2FsVGltZVJlbGF0aW9uID09PSAiLSIpIHsKICAgICAgaG91ciArPSBvZmZzZXRIb3VyOwogICAgICBtaW51dGUgKz0gb2Zmc2V0TWludXRlOwogICAgfSBlbHNlIGlmICh1bml2ZXJzYWxUaW1lUmVsYXRpb24gPT09ICIrIikgewogICAgICBob3VyIC09IG9mZnNldEhvdXI7CiAgICAgIG1pbnV0ZSAtPSBvZmZzZXRNaW51dGU7CiAgICB9CiAgICByZXR1cm4gbmV3IERhdGUoRGF0ZS5VVEMoeWVhciwgbW9udGgsIGRheSwgaG91ciwgbWludXRlLCBzZWNvbmQpKTsKICB9Cn07CmZ1bmN0aW9uIGdldFhmYVBhZ2VWaWV3cG9ydCh4ZmFQYWdlLCB7CiAgc2NhbGUgPSAxLAogIHJvdGF0aW9uID0gMAp9KSB7CiAgY29uc3QgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0geGZhUGFnZS5hdHRyaWJ1dGVzLnN0eWxlOwogIGNvbnN0IHZpZXdCb3ggPSBbMCwgMCwgcGFyc2VJbnQod2lkdGgpLCBwYXJzZUludChoZWlnaHQpXTsKICByZXR1cm4gbmV3IFBhZ2VWaWV3cG9ydCh7CiAgICB2aWV3Qm94LAogICAgdXNlclVuaXQ6IDEsCiAgICBzY2FsZSwKICAgIHJvdGF0aW9uCiAgfSk7Cn0KZnVuY3Rpb24gZ2V0UkdCKGNvbG9yKSB7CiAgaWYgKGNvbG9yLnN0YXJ0c1dpdGgoIiMiKSkgewogICAgY29uc3QgY29sb3JSR0IgPSBwYXJzZUludChjb2xvci5zbGljZSgxKSwgMTYpOwogICAgcmV0dXJuIFsoY29sb3JSR0IgJiAxNjcxMTY4MCkgPj4gMTYsIChjb2xvclJHQiAmIDY1MjgwKSA+PiA4LCBjb2xvclJHQiAmIDI1NV07CiAgfQogIGlmIChjb2xvci5zdGFydHNXaXRoKCJyZ2IoIikpIHsKICAgIHJldHVybiBjb2xvci5zbGljZSg0LCAtMSkuc3BsaXQoIiwiKS5tYXAoKHgpID0+IHBhcnNlSW50KHgpKTsKICB9CiAgaWYgKGNvbG9yLnN0YXJ0c1dpdGgoInJnYmEoIikpIHsKICAgIHJldHVybiBjb2xvci5zbGljZSg1LCAtMSkuc3BsaXQoIiwiKS5tYXAoKHgpID0+IHBhcnNlSW50KHgpKS5zbGljZSgwLCAzKTsKICB9CiAgd2FybihgTm90IGEgdmFsaWQgY29sb3IgZm9ybWF0OiAiJHtjb2xvcn0iYCk7CiAgcmV0dXJuIFswLCAwLCAwXTsKfQpmdW5jdGlvbiBnZXRDb2xvclZhbHVlcyhjb2xvcnMpIHsKICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogIHNwYW4uc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogIHNwYW4uc3R5bGUuY29sb3JTY2hlbWUgPSAib25seSBsaWdodCI7CiAgZG9jdW1lbnQuYm9keS5hcHBlbmQoc3Bhbik7CiAgZm9yIChjb25zdCBuYW1lIG9mIGNvbG9ycy5rZXlzKCkpIHsKICAgIHNwYW4uc3R5bGUuY29sb3IgPSBuYW1lOwogICAgY29uc3QgY29tcHV0ZWRDb2xvciA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHNwYW4pLmNvbG9yOwogICAgY29sb3JzLnNldChuYW1lLCBnZXRSR0IoY29tcHV0ZWRDb2xvcikpOwogIH0KICBzcGFuLnJlbW92ZSgpOwp9CmZ1bmN0aW9uIGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KSB7CiAgY29uc3QgewogICAgYSwKICAgIGIsCiAgICBjLAogICAgZCwKICAgIGUsCiAgICBmCiAgfSA9IGN0eC5nZXRUcmFuc2Zvcm0oKTsKICByZXR1cm4gW2EsIGIsIGMsIGQsIGUsIGZdOwp9CmZ1bmN0aW9uIGdldEN1cnJlbnRUcmFuc2Zvcm1JbnZlcnNlKGN0eCkgewogIGNvbnN0IHsKICAgIGEsCiAgICBiLAogICAgYywKICAgIGQsCiAgICBlLAogICAgZgogIH0gPSBjdHguZ2V0VHJhbnNmb3JtKCkuaW52ZXJ0U2VsZigpOwogIHJldHVybiBbYSwgYiwgYywgZCwgZSwgZl07Cn0KZnVuY3Rpb24gc2V0TGF5ZXJEaW1lbnNpb25zKGRpdiwgdmlld3BvcnQsIG11c3RGbGlwID0gZmFsc2UsIG11c3RSb3RhdGUgPSB0cnVlKSB7CiAgaWYgKHZpZXdwb3J0IGluc3RhbmNlb2YgUGFnZVZpZXdwb3J0KSB7CiAgICBjb25zdCB7CiAgICAgIHBhZ2VXaWR0aCwKICAgICAgcGFnZUhlaWdodAogICAgfSA9IHZpZXdwb3J0LnJhd0RpbXM7CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gZGl2OwogICAgY29uc3QgdXNlUm91bmQgPSB1dGlsX0ZlYXR1cmVUZXN0LmlzQ1NTUm91bmRTdXBwb3J0ZWQ7CiAgICBjb25zdCB3ID0gYHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikgKiAke3BhZ2VXaWR0aH1weGAsIGggPSBgdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSAqICR7cGFnZUhlaWdodH1weGA7CiAgICBjb25zdCB3aWR0aFN0ciA9IHVzZVJvdW5kID8gYHJvdW5kKGRvd24sICR7d30sIHZhcigtLXNjYWxlLXJvdW5kLXgpKWAgOiBgY2FsYygke3d9KWAsIGhlaWdodFN0ciA9IHVzZVJvdW5kID8gYHJvdW5kKGRvd24sICR7aH0sIHZhcigtLXNjYWxlLXJvdW5kLXkpKWAgOiBgY2FsYygke2h9KWA7CiAgICBpZiAoIW11c3RGbGlwIHx8IHZpZXdwb3J0LnJvdGF0aW9uICUgMTgwID09PSAwKSB7CiAgICAgIHN0eWxlLndpZHRoID0gd2lkdGhTdHI7CiAgICAgIHN0eWxlLmhlaWdodCA9IGhlaWdodFN0cjsKICAgIH0gZWxzZSB7CiAgICAgIHN0eWxlLndpZHRoID0gaGVpZ2h0U3RyOwogICAgICBzdHlsZS5oZWlnaHQgPSB3aWR0aFN0cjsKICAgIH0KICB9CiAgaWYgKG11c3RSb3RhdGUpIHsKICAgIGRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbWFpbi1yb3RhdGlvbiIsIHZpZXdwb3J0LnJvdGF0aW9uKTsKICB9Cn0KdmFyIE91dHB1dFNjYWxlID0gY2xhc3MgX091dHB1dFNjYWxlIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIGNvbnN0IHsKICAgICAgcGl4ZWxSYXRpbwogICAgfSA9IF9PdXRwdXRTY2FsZTsKICAgIHRoaXMuc3ggPSBwaXhlbFJhdGlvOwogICAgdGhpcy5zeSA9IHBpeGVsUmF0aW87CiAgfQogIGdldCBzY2FsZWQoKSB7CiAgICByZXR1cm4gdGhpcy5zeCAhPT0gMSB8fCB0aGlzLnN5ICE9PSAxOwogIH0KICBnZXQgc3ltbWV0cmljKCkgewogICAgcmV0dXJuIHRoaXMuc3ggPT09IHRoaXMuc3k7CiAgfQogIGxpbWl0Q2FudmFzKHdpZHRoLCBoZWlnaHQsIG1heFBpeGVscywgbWF4RGltLCBjYXBBcmVhRmFjdG9yID0gLTEpIHsKICAgIGxldCBtYXhBcmVhU2NhbGUgPSBJbmZpbml0eSwgbWF4V2lkdGhTY2FsZSA9IEluZmluaXR5LCBtYXhIZWlnaHRTY2FsZSA9IEluZmluaXR5OwogICAgbWF4UGl4ZWxzID0gX091dHB1dFNjYWxlLmNhcFBpeGVscyhtYXhQaXhlbHMsIGNhcEFyZWFGYWN0b3IpOwogICAgaWYgKG1heFBpeGVscyA+IDApIHsKICAgICAgbWF4QXJlYVNjYWxlID0gTWF0aC5zcXJ0KG1heFBpeGVscyAvICh3aWR0aCAqIGhlaWdodCkpOwogICAgfQogICAgaWYgKG1heERpbSAhPT0gLTEpIHsKICAgICAgbWF4V2lkdGhTY2FsZSA9IG1heERpbSAvIHdpZHRoOwogICAgICBtYXhIZWlnaHRTY2FsZSA9IG1heERpbSAvIGhlaWdodDsKICAgIH0KICAgIGNvbnN0IG1heFNjYWxlID0gTWF0aC5taW4obWF4QXJlYVNjYWxlLCBtYXhXaWR0aFNjYWxlLCBtYXhIZWlnaHRTY2FsZSk7CiAgICBpZiAodGhpcy5zeCA+IG1heFNjYWxlIHx8IHRoaXMuc3kgPiBtYXhTY2FsZSkgewogICAgICB0aGlzLnN4ID0gbWF4U2NhbGU7CiAgICAgIHRoaXMuc3kgPSBtYXhTY2FsZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHN0YXRpYyBnZXQgcGl4ZWxSYXRpbygpIHsKICAgIHJldHVybiBnbG9iYWxUaGlzLmRldmljZVBpeGVsUmF0aW8gfHwgMTsKICB9CiAgc3RhdGljIGNhcFBpeGVscyhtYXhQaXhlbHMsIGNhcEFyZWFGYWN0b3IpIHsKICAgIGlmIChjYXBBcmVhRmFjdG9yID49IDApIHsKICAgICAgY29uc3Qgd2luUGl4ZWxzID0gTWF0aC5jZWlsKHdpbmRvdy5zY3JlZW4uYXZhaWxXaWR0aCAqIHdpbmRvdy5zY3JlZW4uYXZhaWxIZWlnaHQgKiB0aGlzLnBpeGVsUmF0aW8gKiogMiAqICgxICsgY2FwQXJlYUZhY3RvciAvIDEwMCkpOwogICAgICByZXR1cm4gbWF4UGl4ZWxzID4gMCA/IE1hdGgubWluKG1heFBpeGVscywgd2luUGl4ZWxzKSA6IHdpblBpeGVsczsKICAgIH0KICAgIHJldHVybiBtYXhQaXhlbHM7CiAgfQp9Owp2YXIgU3VwcG9ydGVkSW1hZ2VNaW1lVHlwZXMgPSBbImltYWdlL2FwbmciLCAiaW1hZ2UvYXZpZiIsICJpbWFnZS9ibXAiLCAiaW1hZ2UvZ2lmIiwgImltYWdlL2pwZWciLCAiaW1hZ2UvcG5nIiwgImltYWdlL3N2Zyt4bWwiLCAiaW1hZ2Uvd2VicCIsICJpbWFnZS94LWljb24iXTsKdmFyIENvbG9yU2NoZW1lID0gY2xhc3MgewogIHN0YXRpYyBnZXQgaXNEYXJrTW9kZSgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzRGFya01vZGUiLCAhIXdpbmRvdz8ubWF0Y2hNZWRpYT8uKCIocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIikubWF0Y2hlcyk7CiAgfQp9Owp2YXIgQ1NTQ29uc3RhbnRzID0gY2xhc3MgewogIHN0YXRpYyBnZXQgY29tbWVudEZvcmVncm91bmRDb2xvcigpIHsKICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoImNvbW1lbnQiLCAic2lkZWJhciIpOwogICAgY29uc3QgewogICAgICBzdHlsZQogICAgfSA9IGVsZW1lbnQ7CiAgICBzdHlsZS53aWR0aCA9IHN0eWxlLmhlaWdodCA9ICIwIjsKICAgIHN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBzdHlsZS5jb2xvciA9ICJ2YXIoLS1jb21tZW50LWZnLWNvbG9yKSI7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZChlbGVtZW50KTsKICAgIGNvbnN0IHsKICAgICAgY29sb3IKICAgIH0gPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KTsKICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJjb21tZW50Rm9yZWdyb3VuZENvbG9yIiwgZ2V0UkdCKGNvbG9yKSk7CiAgfQp9OwpmdW5jdGlvbiBhcHBseU9wYWNpdHkociwgZywgYiwgb3BhY2l0eSkgewogIG9wYWNpdHkgPSBNYXRoLm1pbihNYXRoLm1heChvcGFjaXR5ID8/IDEsIDApLCAxKTsKICBjb25zdCB3aGl0ZSA9IDI1NSAqICgxIC0gb3BhY2l0eSk7CiAgciA9IE1hdGgucm91bmQociAqIG9wYWNpdHkgKyB3aGl0ZSk7CiAgZyA9IE1hdGgucm91bmQoZyAqIG9wYWNpdHkgKyB3aGl0ZSk7CiAgYiA9IE1hdGgucm91bmQoYiAqIG9wYWNpdHkgKyB3aGl0ZSk7CiAgcmV0dXJuIFtyLCBnLCBiXTsKfQpmdW5jdGlvbiBSR0JUb0hTTChyZ2IsIG91dHB1dCkgewogIGNvbnN0IHIgPSByZ2JbMF0gLyAyNTU7CiAgY29uc3QgZyA9IHJnYlsxXSAvIDI1NTsKICBjb25zdCBiID0gcmdiWzJdIC8gMjU1OwogIGNvbnN0IG1heCA9IE1hdGgubWF4KHIsIGcsIGIpOwogIGNvbnN0IG1pbiA9IE1hdGgubWluKHIsIGcsIGIpOwogIGNvbnN0IGwgPSAobWF4ICsgbWluKSAvIDI7CiAgaWYgKG1heCA9PT0gbWluKSB7CiAgICBvdXRwdXRbMF0gPSBvdXRwdXRbMV0gPSAwOwogIH0gZWxzZSB7CiAgICBjb25zdCBkID0gbWF4IC0gbWluOwogICAgb3V0cHV0WzFdID0gbCA8IDAuNSA/IGQgLyAobWF4ICsgbWluKSA6IGQgLyAoMiAtIG1heCAtIG1pbik7CiAgICBzd2l0Y2ggKG1heCkgewogICAgICBjYXNlIHI6CiAgICAgICAgb3V0cHV0WzBdID0gKChnIC0gYikgLyBkICsgKGcgPCBiID8gNiA6IDApKSAqIDYwOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIGc6CiAgICAgICAgb3V0cHV0WzBdID0gKChiIC0gcikgLyBkICsgMikgKiA2MDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBiOgogICAgICAgIG91dHB1dFswXSA9ICgociAtIGcpIC8gZCArIDQpICogNjA7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIG91dHB1dFsyXSA9IGw7Cn0KZnVuY3Rpb24gSFNMVG9SR0IoaHNsLCBvdXRwdXQpIHsKICBjb25zdCBoID0gaHNsWzBdOwogIGNvbnN0IHMgPSBoc2xbMV07CiAgY29uc3QgbCA9IGhzbFsyXTsKICBjb25zdCBjID0gKDEgLSBNYXRoLmFicygyICogbCAtIDEpKSAqIHM7CiAgY29uc3QgeCA9IGMgKiAoMSAtIE1hdGguYWJzKGggLyA2MCAlIDIgLSAxKSk7CiAgY29uc3QgbSA9IGwgLSBjIC8gMjsKICBzd2l0Y2ggKE1hdGguZmxvb3IoaCAvIDYwKSkgewogICAgY2FzZSAwOgogICAgICBvdXRwdXRbMF0gPSBjICsgbTsKICAgICAgb3V0cHV0WzFdID0geCArIG07CiAgICAgIG91dHB1dFsyXSA9IG07CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOgogICAgICBvdXRwdXRbMF0gPSB4ICsgbTsKICAgICAgb3V0cHV0WzFdID0gYyArIG07CiAgICAgIG91dHB1dFsyXSA9IG07CiAgICAgIGJyZWFrOwogICAgY2FzZSAyOgogICAgICBvdXRwdXRbMF0gPSBtOwogICAgICBvdXRwdXRbMV0gPSBjICsgbTsKICAgICAgb3V0cHV0WzJdID0geCArIG07CiAgICAgIGJyZWFrOwogICAgY2FzZSAzOgogICAgICBvdXRwdXRbMF0gPSBtOwogICAgICBvdXRwdXRbMV0gPSB4ICsgbTsKICAgICAgb3V0cHV0WzJdID0gYyArIG07CiAgICAgIGJyZWFrOwogICAgY2FzZSA0OgogICAgICBvdXRwdXRbMF0gPSB4ICsgbTsKICAgICAgb3V0cHV0WzFdID0gbTsKICAgICAgb3V0cHV0WzJdID0gYyArIG07CiAgICAgIGJyZWFrOwogICAgY2FzZSA1OgogICAgY2FzZSA2OgogICAgICBvdXRwdXRbMF0gPSBjICsgbTsKICAgICAgb3V0cHV0WzFdID0gbTsKICAgICAgb3V0cHV0WzJdID0geCArIG07CiAgICAgIGJyZWFrOwogIH0KfQpmdW5jdGlvbiBjb21wdXRlTHVtaW5hbmNlKHgpIHsKICByZXR1cm4geCA8PSAwLjAzOTI4ID8geCAvIDEyLjkyIDogKCh4ICsgMC4wNTUpIC8gMS4wNTUpICoqIDIuNDsKfQpmdW5jdGlvbiBjb250cmFzdFJhdGlvKGhzbDEsIGhzbDIsIG91dHB1dCkgewogIEhTTFRvUkdCKGhzbDEsIG91dHB1dCk7CiAgb3V0cHV0Lm1hcChjb21wdXRlTHVtaW5hbmNlKTsKICBjb25zdCBsdW0xID0gMC4yMTI2ICogb3V0cHV0WzBdICsgMC43MTUyICogb3V0cHV0WzFdICsgMC4wNzIyICogb3V0cHV0WzJdOwogIEhTTFRvUkdCKGhzbDIsIG91dHB1dCk7CiAgb3V0cHV0Lm1hcChjb21wdXRlTHVtaW5hbmNlKTsKICBjb25zdCBsdW0yID0gMC4yMTI2ICogb3V0cHV0WzBdICsgMC43MTUyICogb3V0cHV0WzFdICsgMC4wNzIyICogb3V0cHV0WzJdOwogIHJldHVybiBsdW0xID4gbHVtMiA/IChsdW0xICsgMC4wNSkgLyAobHVtMiArIDAuMDUpIDogKGx1bTIgKyAwLjA1KSAvIChsdW0xICsgMC4wNSk7Cn0KdmFyIGNvbnRyYXN0Q2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwpmdW5jdGlvbiBmaW5kQ29udHJhc3RDb2xvcihiYXNlQ29sb3IsIGZpeGVkQ29sb3IpIHsKICBjb25zdCBrZXkgPSBiYXNlQ29sb3JbMF0gKyBiYXNlQ29sb3JbMV0gKiAyNTYgKyBiYXNlQ29sb3JbMl0gKiA2NTUzNiArIGZpeGVkQ29sb3JbMF0gKiAxNjc3NzIxNiArIGZpeGVkQ29sb3JbMV0gKiA0Mjk0OTY3Mjk2ICsgZml4ZWRDb2xvclsyXSAqIDEwOTk1MTE2Mjc3NzY7CiAgbGV0IGNhY2hlZFZhbHVlID0gY29udHJhc3RDYWNoZS5nZXQoa2V5KTsKICBpZiAoY2FjaGVkVmFsdWUpIHsKICAgIHJldHVybiBjYWNoZWRWYWx1ZTsKICB9CiAgY29uc3QgYXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KDkpOwogIGNvbnN0IG91dHB1dCA9IGFycmF5LnN1YmFycmF5KDAsIDMpOwogIGNvbnN0IGJhc2VIU0wgPSBhcnJheS5zdWJhcnJheSgzLCA2KTsKICBSR0JUb0hTTChiYXNlQ29sb3IsIGJhc2VIU0wpOwogIGNvbnN0IGZpeGVkSFNMID0gYXJyYXkuc3ViYXJyYXkoNiwgOSk7CiAgUkdCVG9IU0woZml4ZWRDb2xvciwgZml4ZWRIU0wpOwogIGNvbnN0IGlzRml4ZWRDb2xvckRhcmsgPSBmaXhlZEhTTFsyXSA8IDAuNTsKICBjb25zdCBtaW5Db250cmFzdCA9IGlzRml4ZWRDb2xvckRhcmsgPyAxMiA6IDQuNTsKICBiYXNlSFNMWzJdID0gaXNGaXhlZENvbG9yRGFyayA/IE1hdGguc3FydChiYXNlSFNMWzJdKSA6IDEgLSBNYXRoLnNxcnQoMSAtIGJhc2VIU0xbMl0pOwogIGlmIChjb250cmFzdFJhdGlvKGJhc2VIU0wsIGZpeGVkSFNMLCBvdXRwdXQpIDwgbWluQ29udHJhc3QpIHsKICAgIGxldCBzdGFydCwgZW5kOwogICAgaWYgKGlzRml4ZWRDb2xvckRhcmspIHsKICAgICAgc3RhcnQgPSBiYXNlSFNMWzJdOwogICAgICBlbmQgPSAxOwogICAgfSBlbHNlIHsKICAgICAgc3RhcnQgPSAwOwogICAgICBlbmQgPSBiYXNlSFNMWzJdOwogICAgfQogICAgY29uc3QgUFJFQ0lTSU9OID0gNWUtMzsKICAgIHdoaWxlIChlbmQgLSBzdGFydCA+IFBSRUNJU0lPTikgewogICAgICBjb25zdCBtaWQgPSBiYXNlSFNMWzJdID0gKHN0YXJ0ICsgZW5kKSAvIDI7CiAgICAgIGlmIChpc0ZpeGVkQ29sb3JEYXJrID09PSBjb250cmFzdFJhdGlvKGJhc2VIU0wsIGZpeGVkSFNMLCBvdXRwdXQpIDwgbWluQ29udHJhc3QpIHsKICAgICAgICBzdGFydCA9IG1pZDsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmQgPSBtaWQ7CiAgICAgIH0KICAgIH0KICAgIGJhc2VIU0xbMl0gPSBpc0ZpeGVkQ29sb3JEYXJrID8gZW5kIDogc3RhcnQ7CiAgfQogIEhTTFRvUkdCKGJhc2VIU0wsIG91dHB1dCk7CiAgY2FjaGVkVmFsdWUgPSBVdGlsLm1ha2VIZXhDb2xvcihNYXRoLnJvdW5kKG91dHB1dFswXSAqIDI1NSksIE1hdGgucm91bmQob3V0cHV0WzFdICogMjU1KSwgTWF0aC5yb3VuZChvdXRwdXRbMl0gKiAyNTUpKTsKICBjb250cmFzdENhY2hlLnNldChrZXksIGNhY2hlZFZhbHVlKTsKICByZXR1cm4gY2FjaGVkVmFsdWU7Cn0KZnVuY3Rpb24gcmVuZGVyUmljaFRleHQoewogIGh0bWwsCiAgZGlyLAogIGNsYXNzTmFtZQp9LCBjb250YWluZXIyKSB7CiAgY29uc3QgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgaWYgKHR5cGVvZiBodG1sID09PSAic3RyaW5nIikgewogICAgY29uc3QgcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsKICAgIHAuZGlyID0gZGlyIHx8ICJhdXRvIjsKICAgIGNvbnN0IGxpbmVzID0gaHRtbC5zcGxpdCgvKD86XHJcbj98XG4pLyk7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBsaW5lcy5sZW5ndGg7IGkgPCBpaTsgKytpKSB7CiAgICAgIGNvbnN0IGxpbmUgPSBsaW5lc1tpXTsKICAgICAgcC5hcHBlbmQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobGluZSkpOwogICAgICBpZiAoaSA8IGlpIC0gMSkgewogICAgICAgIHAuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJyIikpOwogICAgICB9CiAgICB9CiAgICBmcmFnbWVudC5hcHBlbmQocCk7CiAgfSBlbHNlIHsKICAgIFhmYUxheWVyLnJlbmRlcih7CiAgICAgIHhmYUh0bWw6IGh0bWwsCiAgICAgIGRpdjogZnJhZ21lbnQsCiAgICAgIGludGVudDogInJpY2hUZXh0IgogICAgfSk7CiAgfQogIGZyYWdtZW50LmZpcnN0RWxlbWVudENoaWxkLmNsYXNzTGlzdC5hZGQoInJpY2hUZXh0IiwgY2xhc3NOYW1lKTsKICBjb250YWluZXIyLmFwcGVuZChmcmFnbWVudCk7Cn0KZnVuY3Rpb24gbWFrZVBhdGhGcm9tRHJhd09QUyhkYXRhKSB7CiAgY29uc3QgcGF0aCA9IG5ldyBQYXRoMkQoKTsKICBpZiAoIWRhdGEpIHsKICAgIHJldHVybiBwYXRoOwogIH0KICBmb3IgKGxldCBpID0gMCwgaWkgPSBkYXRhLmxlbmd0aDsgaSA8IGlpOyApIHsKICAgIHN3aXRjaCAoZGF0YVtpKytdKSB7CiAgICAgIGNhc2UgRHJhd09QUy5tb3ZlVG86CiAgICAgICAgcGF0aC5tb3ZlVG8oZGF0YVtpKytdLCBkYXRhW2krK10pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIERyYXdPUFMubGluZVRvOgogICAgICAgIHBhdGgubGluZVRvKGRhdGFbaSsrXSwgZGF0YVtpKytdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBEcmF3T1BTLmN1cnZlVG86CiAgICAgICAgcGF0aC5iZXppZXJDdXJ2ZVRvKGRhdGFbaSsrXSwgZGF0YVtpKytdLCBkYXRhW2krK10sIGRhdGFbaSsrXSwgZGF0YVtpKytdLCBkYXRhW2krK10pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIERyYXdPUFMucXVhZHJhdGljQ3VydmVUbzoKICAgICAgICBwYXRoLnF1YWRyYXRpY0N1cnZlVG8oZGF0YVtpKytdLCBkYXRhW2krK10sIGRhdGFbaSsrXSwgZGF0YVtpKytdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBEcmF3T1BTLmNsb3NlUGF0aDoKICAgICAgICBwYXRoLmNsb3NlUGF0aCgpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHdhcm4oYFVucmVjb2duaXplZCBkcmF3aW5nIHBhdGggb3BlcmF0b3I6ICR7ZGF0YVtpIC0gMV19YCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiBwYXRoOwp9CnZhciBFZGl0b3JUb29sYmFyID0gY2xhc3MgX0VkaXRvclRvb2xiYXIgewogICN0b29sYmFyID0gbnVsbDsKICAjY29sb3JQaWNrZXIgPSBudWxsOwogICNlZGl0b3I7CiAgI2J1dHRvbnMgPSBudWxsOwogICNhbHRUZXh0ID0gbnVsbDsKICAjY29tbWVudCA9IG51bGw7CiAgI2NvbW1lbnRCdXR0b25EaXZpZGVyID0gbnVsbDsKICAjc2lnbmF0dXJlRGVzY3JpcHRpb25CdXR0b24gPSBudWxsOwogIHN0YXRpYyAjbDEwblJlbW92ZSA9IG51bGw7CiAgY29uc3RydWN0b3IoZWRpdG9yKSB7CiAgICB0aGlzLiNlZGl0b3IgPSBlZGl0b3I7CiAgICBfRWRpdG9yVG9vbGJhci4jbDEwblJlbW92ZSB8fD0gT2JqZWN0LmZyZWV6ZSh7CiAgICAgIGZyZWV0ZXh0OiAicGRmanMtZWRpdG9yLXJlbW92ZS1mcmVldGV4dC1idXR0b24iLAogICAgICBoaWdobGlnaHQ6ICJwZGZqcy1lZGl0b3ItcmVtb3ZlLWhpZ2hsaWdodC1idXR0b24iLAogICAgICBpbms6ICJwZGZqcy1lZGl0b3ItcmVtb3ZlLWluay1idXR0b24iLAogICAgICBzdGFtcDogInBkZmpzLWVkaXRvci1yZW1vdmUtc3RhbXAtYnV0dG9uIiwKICAgICAgc2lnbmF0dXJlOiAicGRmanMtZWRpdG9yLXJlbW92ZS1zaWduYXR1cmUtYnV0dG9uIgogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IGVkaXRUb29sYmFyID0gdGhpcy4jdG9vbGJhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZWRpdFRvb2xiYXIuY2xhc3NMaXN0LmFkZCgiZWRpdFRvb2xiYXIiLCAiaGlkZGVuIik7CiAgICBlZGl0VG9vbGJhci5zZXRBdHRyaWJ1dGUoInJvbGUiLCAidG9vbGJhciIpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy4jZWRpdG9yLl91aU1hbmFnZXIuX3NpZ25hbDsKICAgIGlmIChzaWduYWwgaW5zdGFuY2VvZiBBYm9ydFNpZ25hbCAmJiAhc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgZWRpdFRvb2xiYXIuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBlZGl0VG9vbGJhci5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIF9FZGl0b3JUb29sYmFyLiNwb2ludGVyRG93biwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGJ1dHRvbnMgPSB0aGlzLiNidXR0b25zID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBidXR0b25zLmNsYXNzTmFtZSA9ICJidXR0b25zIjsKICAgIGVkaXRUb29sYmFyLmFwcGVuZChidXR0b25zKTsKICAgIGNvbnN0IHBvc2l0aW9uID0gdGhpcy4jZWRpdG9yLnRvb2xiYXJQb3NpdGlvbjsKICAgIGlmIChwb3NpdGlvbikgewogICAgICBjb25zdCB7CiAgICAgICAgc3R5bGUKICAgICAgfSA9IGVkaXRUb29sYmFyOwogICAgICBjb25zdCB4ID0gdGhpcy4jZWRpdG9yLl91aU1hbmFnZXIuZGlyZWN0aW9uID09PSAibHRyIiA/IDEgLSBwb3NpdGlvblswXSA6IHBvc2l0aW9uWzBdOwogICAgICBzdHlsZS5pbnNldElubGluZUVuZCA9IGAkezEwMCAqIHh9JWA7CiAgICAgIHN0eWxlLnRvcCA9IGBjYWxjKCR7MTAwICogcG9zaXRpb25bMV19JSArIHZhcigtLWVkaXRvci10b29sYmFyLXZlcnQtb2Zmc2V0KSlgOwogICAgfQogICAgcmV0dXJuIGVkaXRUb29sYmFyOwogIH0KICBnZXQgZGl2KCkgewogICAgcmV0dXJuIHRoaXMuI3Rvb2xiYXI7CiAgfQogIHN0YXRpYyAjcG9pbnRlckRvd24oZSkgewogICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICB9CiAgI2ZvY3VzSW4oZSkgewogICAgdGhpcy4jZWRpdG9yLl9mb2N1c0V2ZW50c0FsbG93ZWQgPSBmYWxzZTsKICAgIHN0b3BFdmVudChlKTsKICB9CiAgI2ZvY3VzT3V0KGUpIHsKICAgIHRoaXMuI2VkaXRvci5fZm9jdXNFdmVudHNBbGxvd2VkID0gdHJ1ZTsKICAgIHN0b3BFdmVudChlKTsKICB9CiAgI2FkZExpc3RlbmVyc1RvRWxlbWVudChlbGVtZW50KSB7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5fc2lnbmFsOwogICAgaWYgKCEoc2lnbmFsIGluc3RhbmNlb2YgQWJvcnRTaWduYWwpIHx8IHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXNpbiIsIHRoaXMuI2ZvY3VzSW4uYmluZCh0aGlzKSwgewogICAgICBjYXB0dXJlOiB0cnVlLAogICAgICBzaWduYWwKICAgIH0pOwogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJmb2N1c291dCIsIHRoaXMuI2ZvY3VzT3V0LmJpbmQodGhpcyksIHsKICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaGlkZSgpIHsKICAgIHRoaXMuI3Rvb2xiYXIuY2xhc3NMaXN0LmFkZCgiaGlkZGVuIik7CiAgICB0aGlzLiNjb2xvclBpY2tlcj8uaGlkZURyb3Bkb3duKCk7CiAgfQogIHNob3coKSB7CiAgICB0aGlzLiN0b29sYmFyLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgdGhpcy4jYWx0VGV4dD8uc2hvd24oKTsKICAgIHRoaXMuI2NvbW1lbnQ/LnNob3duKCk7CiAgfQogIGFkZERlbGV0ZUJ1dHRvbigpIHsKICAgIGNvbnN0IHsKICAgICAgZWRpdG9yVHlwZSwKICAgICAgX3VpTWFuYWdlcgogICAgfSA9IHRoaXMuI2VkaXRvcjsKICAgIGNvbnN0IGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgYnV0dG9uLmNsYXNzTGlzdC5hZGQoImJhc2ljIiwgImRlbGV0ZUJ1dHRvbiIpOwogICAgYnV0dG9uLnRhYkluZGV4ID0gMDsKICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIF9FZGl0b3JUb29sYmFyLiNsMTBuUmVtb3ZlW2VkaXRvclR5cGVdKTsKICAgIGlmICh0aGlzLiNhZGRMaXN0ZW5lcnNUb0VsZW1lbnQoYnV0dG9uKSkgewogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZSkgPT4gewogICAgICAgIF91aU1hbmFnZXIuZGVsZXRlKCk7CiAgICAgIH0sIHsKICAgICAgICBzaWduYWw6IF91aU1hbmFnZXIuX3NpZ25hbAogICAgICB9KTsKICAgIH0KICAgIHRoaXMuI2J1dHRvbnMuYXBwZW5kKGJ1dHRvbik7CiAgfQogIGdldCAjZGl2aWRlcigpIHsKICAgIGNvbnN0IGRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdmlkZXIuY2xhc3NOYW1lID0gImRpdmlkZXIiOwogICAgcmV0dXJuIGRpdmlkZXI7CiAgfQogIGFzeW5jIGFkZEFsdFRleHQoYWx0VGV4dCkgewogICAgY29uc3QgYnV0dG9uID0gYXdhaXQgYWx0VGV4dC5yZW5kZXIoKTsKICAgIHRoaXMuI2FkZExpc3RlbmVyc1RvRWxlbWVudChidXR0b24pOwogICAgdGhpcy4jYnV0dG9ucy5hcHBlbmQoYnV0dG9uLCB0aGlzLiNkaXZpZGVyKTsKICAgIHRoaXMuI2FsdFRleHQgPSBhbHRUZXh0OwogIH0KICBhZGRDb21tZW50KGNvbW1lbnQsIGJlZm9yZUVsZW1lbnQgPSBudWxsKSB7CiAgICBpZiAodGhpcy4jY29tbWVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBidXR0b24gPSBjb21tZW50LnJlbmRlckZvclRvb2xiYXIoKTsKICAgIGlmICghYnV0dG9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FkZExpc3RlbmVyc1RvRWxlbWVudChidXR0b24pOwogICAgY29uc3QgZGl2aWRlciA9IHRoaXMuI2NvbW1lbnRCdXR0b25EaXZpZGVyID0gdGhpcy4jZGl2aWRlcjsKICAgIGlmICghYmVmb3JlRWxlbWVudCkgewogICAgICB0aGlzLiNidXR0b25zLmFwcGVuZChidXR0b24sIGRpdmlkZXIpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jYnV0dG9ucy5pbnNlcnRCZWZvcmUoYnV0dG9uLCBiZWZvcmVFbGVtZW50KTsKICAgICAgdGhpcy4jYnV0dG9ucy5pbnNlcnRCZWZvcmUoZGl2aWRlciwgYmVmb3JlRWxlbWVudCk7CiAgICB9CiAgICB0aGlzLiNjb21tZW50ID0gY29tbWVudDsKICAgIGNvbW1lbnQudG9vbGJhciA9IHRoaXM7CiAgfQogIGFkZENvbG9yUGlja2VyKGNvbG9yUGlja2VyKSB7CiAgICBpZiAodGhpcy4jY29sb3JQaWNrZXIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29sb3JQaWNrZXIgPSBjb2xvclBpY2tlcjsKICAgIGNvbnN0IGJ1dHRvbiA9IGNvbG9yUGlja2VyLnJlbmRlckJ1dHRvbigpOwogICAgdGhpcy4jYWRkTGlzdGVuZXJzVG9FbGVtZW50KGJ1dHRvbik7CiAgICB0aGlzLiNidXR0b25zLmFwcGVuZChidXR0b24sIHRoaXMuI2RpdmlkZXIpOwogIH0KICBhc3luYyBhZGRFZGl0U2lnbmF0dXJlQnV0dG9uKHNpZ25hdHVyZU1hbmFnZXIpIHsKICAgIGNvbnN0IGJ1dHRvbiA9IHRoaXMuI3NpZ25hdHVyZURlc2NyaXB0aW9uQnV0dG9uID0gYXdhaXQgc2lnbmF0dXJlTWFuYWdlci5yZW5kZXJFZGl0QnV0dG9uKHRoaXMuI2VkaXRvcik7CiAgICB0aGlzLiNhZGRMaXN0ZW5lcnNUb0VsZW1lbnQoYnV0dG9uKTsKICAgIHRoaXMuI2J1dHRvbnMuYXBwZW5kKGJ1dHRvbiwgdGhpcy4jZGl2aWRlcik7CiAgfQogIHJlbW92ZUJ1dHRvbihuYW1lKSB7CiAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgY2FzZSAiY29tbWVudCI6CiAgICAgICAgdGhpcy4jY29tbWVudD8ucmVtb3ZlVG9vbGJhckNvbW1lbnRCdXR0b24oKTsKICAgICAgICB0aGlzLiNjb21tZW50ID0gbnVsbDsKICAgICAgICB0aGlzLiNjb21tZW50QnV0dG9uRGl2aWRlcj8ucmVtb3ZlKCk7CiAgICAgICAgdGhpcy4jY29tbWVudEJ1dHRvbkRpdmlkZXIgPSBudWxsOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICBhc3luYyBhZGRCdXR0b24obmFtZSwgdG9vbCkgewogICAgc3dpdGNoIChuYW1lKSB7CiAgICAgIGNhc2UgImNvbG9yUGlja2VyIjoKICAgICAgICBpZiAodG9vbCkgewogICAgICAgICAgdGhpcy5hZGRDb2xvclBpY2tlcih0b29sKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImFsdFRleHQiOgogICAgICAgIGlmICh0b29sKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLmFkZEFsdFRleHQodG9vbCk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJlZGl0U2lnbmF0dXJlIjoKICAgICAgICBpZiAodG9vbCkgewogICAgICAgICAgYXdhaXQgdGhpcy5hZGRFZGl0U2lnbmF0dXJlQnV0dG9uKHRvb2wpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSAiZGVsZXRlIjoKICAgICAgICB0aGlzLmFkZERlbGV0ZUJ1dHRvbigpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJjb21tZW50IjoKICAgICAgICBpZiAodG9vbCkgewogICAgICAgICAgdGhpcy5hZGRDb21tZW50KHRvb2wpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgIH0KICB9CiAgYXN5bmMgYWRkQnV0dG9uQmVmb3JlKG5hbWUsIHRvb2wsIGJlZm9yZVNlbGVjdG9yKSB7CiAgICBpZiAoIXRvb2wgJiYgbmFtZSA9PT0gImNvbW1lbnQiKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGJlZm9yZUVsZW1lbnQgPSB0aGlzLiNidXR0b25zLnF1ZXJ5U2VsZWN0b3IoYmVmb3JlU2VsZWN0b3IpOwogICAgaWYgKCFiZWZvcmVFbGVtZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChuYW1lID09PSAiY29tbWVudCIpIHsKICAgICAgdGhpcy5hZGRDb21tZW50KHRvb2wsIGJlZm9yZUVsZW1lbnQpOwogICAgfQogIH0KICB1cGRhdGVFZGl0U2lnbmF0dXJlQnV0dG9uKGRlc2NyaXB0aW9uKSB7CiAgICBpZiAodGhpcy4jc2lnbmF0dXJlRGVzY3JpcHRpb25CdXR0b24pIHsKICAgICAgdGhpcy4jc2lnbmF0dXJlRGVzY3JpcHRpb25CdXR0b24udGl0bGUgPSBkZXNjcmlwdGlvbjsKICAgIH0KICB9CiAgcmVtb3ZlKCkgewogICAgdGhpcy4jdG9vbGJhci5yZW1vdmUoKTsKICAgIHRoaXMuI2NvbG9yUGlja2VyPy5kZXN0cm95KCk7CiAgICB0aGlzLiNjb2xvclBpY2tlciA9IG51bGw7CiAgfQp9Owp2YXIgRmxvYXRpbmdUb29sYmFyID0gY2xhc3MgewogICNidXR0b25zID0gbnVsbDsKICAjdG9vbGJhciA9IG51bGw7CiAgI3VpTWFuYWdlcjsKICBjb25zdHJ1Y3Rvcih1aU1hbmFnZXIpIHsKICAgIHRoaXMuI3VpTWFuYWdlciA9IHVpTWFuYWdlcjsKICB9CiAgI3JlbmRlcigpIHsKICAgIGNvbnN0IGVkaXRUb29sYmFyID0gdGhpcy4jdG9vbGJhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZWRpdFRvb2xiYXIuY2xhc3NOYW1lID0gImVkaXRUb29sYmFyIjsKICAgIGVkaXRUb29sYmFyLnNldEF0dHJpYnV0ZSgicm9sZSIsICJ0b29sYmFyIik7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiN1aU1hbmFnZXIuX3NpZ25hbDsKICAgIGlmIChzaWduYWwgaW5zdGFuY2VvZiBBYm9ydFNpZ25hbCAmJiAhc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgZWRpdFRvb2xiYXIuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgYnV0dG9ucyA9IHRoaXMuI2J1dHRvbnMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGJ1dHRvbnMuY2xhc3NOYW1lID0gImJ1dHRvbnMiOwogICAgZWRpdFRvb2xiYXIuYXBwZW5kKGJ1dHRvbnMpOwogICAgaWYgKHRoaXMuI3VpTWFuYWdlci5oYXNDb21tZW50TWFuYWdlcigpKSB7CiAgICAgIHRoaXMuI21ha2VCdXR0b24oImNvbW1lbnRCdXR0b24iLCBgcGRmanMtY29tbWVudC1mbG9hdGluZy1idXR0b25gLCAicGRmanMtY29tbWVudC1mbG9hdGluZy1idXR0b24tbGFiZWwiLCAoKSA9PiB7CiAgICAgICAgdGhpcy4jdWlNYW5hZ2VyLmNvbW1lbnRTZWxlY3Rpb24oImZsb2F0aW5nX2J1dHRvbiIpOwogICAgICB9KTsKICAgIH0KICAgIHRoaXMuI21ha2VCdXR0b24oImhpZ2hsaWdodEJ1dHRvbiIsIGBwZGZqcy1oaWdobGlnaHQtZmxvYXRpbmctYnV0dG9uMWAsICJwZGZqcy1oaWdobGlnaHQtZmxvYXRpbmctYnV0dG9uLWxhYmVsIiwgKCkgPT4gewogICAgICB0aGlzLiN1aU1hbmFnZXIuaGlnaGxpZ2h0U2VsZWN0aW9uKCJmbG9hdGluZ19idXR0b24iKTsKICAgIH0pOwogICAgcmV0dXJuIGVkaXRUb29sYmFyOwogIH0KICAjZ2V0TGFzdFBvaW50KGJveGVzLCBpc0xUUikgewogICAgbGV0IGxhc3RZID0gMDsKICAgIGxldCBsYXN0WCA9IDA7CiAgICBmb3IgKGNvbnN0IGJveCBvZiBib3hlcykgewogICAgICBjb25zdCB5ID0gYm94LnkgKyBib3guaGVpZ2h0OwogICAgICBpZiAoeSA8IGxhc3RZKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgeCA9IGJveC54ICsgKGlzTFRSID8gYm94LndpZHRoIDogMCk7CiAgICAgIGlmICh5ID4gbGFzdFkpIHsKICAgICAgICBsYXN0WCA9IHg7CiAgICAgICAgbGFzdFkgPSB5OwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChpc0xUUikgewogICAgICAgIGlmICh4ID4gbGFzdFgpIHsKICAgICAgICAgIGxhc3RYID0geDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoeCA8IGxhc3RYKSB7CiAgICAgICAgbGFzdFggPSB4OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW2lzTFRSID8gMSAtIGxhc3RYIDogbGFzdFgsIGxhc3RZXTsKICB9CiAgc2hvdyhwYXJlbnQsIGJveGVzLCBpc0xUUikgewogICAgY29uc3QgW3gsIHldID0gdGhpcy4jZ2V0TGFzdFBvaW50KGJveGVzLCBpc0xUUik7CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gdGhpcy4jdG9vbGJhciB8fD0gdGhpcy4jcmVuZGVyKCk7CiAgICBwYXJlbnQuYXBwZW5kKHRoaXMuI3Rvb2xiYXIpOwogICAgc3R5bGUuaW5zZXRJbmxpbmVFbmQgPSBgJHsxMDAgKiB4fSVgOwogICAgc3R5bGUudG9wID0gYGNhbGMoJHsxMDAgKiB5fSUgKyB2YXIoLS1lZGl0b3ItdG9vbGJhci12ZXJ0LW9mZnNldCkpYDsKICB9CiAgaGlkZSgpIHsKICAgIHRoaXMuI3Rvb2xiYXIucmVtb3ZlKCk7CiAgfQogICNtYWtlQnV0dG9uKGJ1dHRvbkNsYXNzLCBsMTBuSWQsIGxhYmVsTDEwbklkLCBjbGlja0hhbmRsZXIpIHsKICAgIGNvbnN0IGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgYnV0dG9uLmNsYXNzTGlzdC5hZGQoImJhc2ljIiwgYnV0dG9uQ2xhc3MpOwogICAgYnV0dG9uLnRhYkluZGV4ID0gMDsKICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIGwxMG5JZCk7CiAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgYnV0dG9uLmFwcGVuZChzcGFuKTsKICAgIHNwYW4uY2xhc3NOYW1lID0gInZpc3VhbGx5SGlkZGVuIjsKICAgIHNwYW4uc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCBsYWJlbEwxMG5JZCk7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiN1aU1hbmFnZXIuX3NpZ25hbDsKICAgIGlmIChzaWduYWwgaW5zdGFuY2VvZiBBYm9ydFNpZ25hbCAmJiAhc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51Iiwgbm9Db250ZXh0TWVudSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgY2xpY2tIYW5kbGVyLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgfQogICAgdGhpcy4jYnV0dG9ucy5hcHBlbmQoYnV0dG9uKTsKICB9Cn07CmZ1bmN0aW9uIGJpbmRFdmVudHMob2JqLCBlbGVtZW50LCBuYW1lcykgewogIGZvciAoY29uc3QgbmFtZSBvZiBuYW1lcykgewogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIG9ialtuYW1lXS5iaW5kKG9iaikpOwogIH0KfQp2YXIgQ3VycmVudFBvaW50ZXJzID0gY2xhc3MgX0N1cnJlbnRQb2ludGVycyB7CiAgc3RhdGljICNwb2ludGVySWQgPSBOYU47CiAgc3RhdGljICNwb2ludGVySWRzID0gbnVsbDsKICBzdGF0aWMgI21vdmVUaW1lc3RhbXAgPSBOYU47CiAgc3RhdGljICNwb2ludGVyVHlwZSA9IG51bGw7CiAgc3RhdGljIGluaXRpYWxpemVBbmRBZGRQb2ludGVySWQocG9pbnRlcklkKSB7CiAgICAoX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlcklkcyB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSkuYWRkKHBvaW50ZXJJZCk7CiAgfQogIHN0YXRpYyBzZXRQb2ludGVyKHBvaW50ZXJUeXBlLCBwb2ludGVySWQpIHsKICAgIF9DdXJyZW50UG9pbnRlcnMuI3BvaW50ZXJJZCB8fD0gcG9pbnRlcklkOwogICAgX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlclR5cGUgPz89IHBvaW50ZXJUeXBlOwogIH0KICBzdGF0aWMgc2V0VGltZVN0YW1wKHRpbWVTdGFtcCkgewogICAgX0N1cnJlbnRQb2ludGVycy4jbW92ZVRpbWVzdGFtcCA9IHRpbWVTdGFtcDsKICB9CiAgc3RhdGljIGlzU2FtZVBvaW50ZXJJZChwb2ludGVySWQpIHsKICAgIHJldHVybiBfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVySWQgPT09IHBvaW50ZXJJZDsKICB9CiAgc3RhdGljIGlzU2FtZVBvaW50ZXJJZE9yUmVtb3ZlKHBvaW50ZXJJZCkgewogICAgaWYgKF9DdXJyZW50UG9pbnRlcnMuI3BvaW50ZXJJZCA9PT0gcG9pbnRlcklkKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlcklkcz8uZGVsZXRlKHBvaW50ZXJJZCk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHN0YXRpYyBpc1NhbWVQb2ludGVyVHlwZShwb2ludGVyVHlwZSkgewogICAgcmV0dXJuIF9DdXJyZW50UG9pbnRlcnMuI3BvaW50ZXJUeXBlID09PSBwb2ludGVyVHlwZTsKICB9CiAgc3RhdGljIGlzSW5pdGlhbGl6ZWRBbmREaWZmZXJlbnRQb2ludGVyVHlwZShwb2ludGVyVHlwZSkgewogICAgcmV0dXJuIF9DdXJyZW50UG9pbnRlcnMuI3BvaW50ZXJUeXBlICE9PSBudWxsICYmICFfQ3VycmVudFBvaW50ZXJzLmlzU2FtZVBvaW50ZXJUeXBlKHBvaW50ZXJUeXBlKTsKICB9CiAgc3RhdGljIGlzU2FtZVRpbWVTdGFtcCh0aW1lU3RhbXApIHsKICAgIHJldHVybiBfQ3VycmVudFBvaW50ZXJzLiNtb3ZlVGltZXN0YW1wID09PSB0aW1lU3RhbXA7CiAgfQogIHN0YXRpYyBpc1VzaW5nTXVsdGlwbGVQb2ludGVycygpIHsKICAgIHJldHVybiBfQ3VycmVudFBvaW50ZXJzLiNwb2ludGVySWRzPy5zaXplID49IDE7CiAgfQogIHN0YXRpYyBjbGVhclBvaW50ZXJUeXBlKCkgewogICAgX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlclR5cGUgPSBudWxsOwogIH0KICBzdGF0aWMgY2xlYXJQb2ludGVySWRzKCkgewogICAgX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlcklkID0gTmFOOwogICAgX0N1cnJlbnRQb2ludGVycy4jcG9pbnRlcklkcyA9IG51bGw7CiAgfQogIHN0YXRpYyBjbGVhclRpbWVTdGFtcCgpIHsKICAgIF9DdXJyZW50UG9pbnRlcnMuI21vdmVUaW1lc3RhbXAgPSBOYU47CiAgfQp9Owp2YXIgSWRNYW5hZ2VyID0gY2xhc3MgewogICNpZCA9IDA7CiAgZ2V0IGlkKCkgewogICAgcmV0dXJuIGAke0Fubm90YXRpb25FZGl0b3JQcmVmaXh9JHt0aGlzLiNpZCsrfWA7CiAgfQp9Owp2YXIgSW1hZ2VNYW5hZ2VyID0gY2xhc3MgX0ltYWdlTWFuYWdlciB7CiAgI2Jhc2VJZCA9IGdldFV1aWQoKTsKICAjaWQgPSAwOwogICNjYWNoZSA9IG51bGw7CiAgc3RhdGljIGdldCBfaXNTVkdGaXR0aW5nQ2FudmFzKCkgewogICAgY29uc3Qgc3ZnID0gYGRhdGE6aW1hZ2Uvc3ZnK3htbDtjaGFyc2V0PVVURi04LDxzdmcgdmlld0JveD0iMCAwIDEgMSIgd2lkdGg9IjEiIGhlaWdodD0iMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxIiBzdHlsZT0iZmlsbDpyZWQ7Ii8+PC9zdmc+YDsKICAgIGNvbnN0IGNhbnZhcyA9IG5ldyBPZmZzY3JlZW5DYW52YXMoMSwgMyk7CiAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgIHdpbGxSZWFkRnJlcXVlbnRseTogdHJ1ZQogICAgfSk7CiAgICBjb25zdCBpbWFnZSA9IG5ldyBJbWFnZSgpOwogICAgaW1hZ2Uuc3JjID0gc3ZnOwogICAgY29uc3QgcHJvbWlzZSA9IGltYWdlLmRlY29kZSgpLnRoZW4oKCkgPT4gewogICAgICBjdHguZHJhd0ltYWdlKGltYWdlLCAwLCAwLCAxLCAxLCAwLCAwLCAxLCAzKTsKICAgICAgcmV0dXJuIG5ldyBVaW50MzJBcnJheShjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIDEsIDEpLmRhdGEuYnVmZmVyKVswXSA9PT0gMDsKICAgIH0pOwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2lzU1ZHRml0dGluZ0NhbnZhcyIsIHByb21pc2UpOwogIH0KICBhc3luYyAjZ2V0KGtleSwgcmF3RGF0YSkgewogICAgdGhpcy4jY2FjaGUgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBsZXQgZGF0YSA9IHRoaXMuI2NhY2hlLmdldChrZXkpOwogICAgaWYgKGRhdGEgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAoZGF0YT8uYml0bWFwKSB7CiAgICAgIGRhdGEucmVmQ291bnRlciArPSAxOwogICAgICByZXR1cm4gZGF0YTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGRhdGEgfHw9IHsKICAgICAgICBiaXRtYXA6IG51bGwsCiAgICAgICAgaWQ6IGBpbWFnZV8ke3RoaXMuI2Jhc2VJZH1fJHt0aGlzLiNpZCsrfWAsCiAgICAgICAgcmVmQ291bnRlcjogMCwKICAgICAgICBpc1N2ZzogZmFsc2UKICAgICAgfTsKICAgICAgbGV0IGltYWdlOwogICAgICBpZiAodHlwZW9mIHJhd0RhdGEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgZGF0YS51cmwgPSByYXdEYXRhOwogICAgICAgIGltYWdlID0gYXdhaXQgZmV0Y2hEYXRhKHJhd0RhdGEsICJibG9iIik7CiAgICAgIH0gZWxzZSBpZiAocmF3RGF0YSBpbnN0YW5jZW9mIEZpbGUpIHsKICAgICAgICBpbWFnZSA9IGRhdGEuZmlsZSA9IHJhd0RhdGE7CiAgICAgIH0gZWxzZSBpZiAocmF3RGF0YSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICBpbWFnZSA9IHJhd0RhdGE7CiAgICAgIH0KICAgICAgaWYgKGltYWdlLnR5cGUgPT09ICJpbWFnZS9zdmcreG1sIikgewogICAgICAgIGNvbnN0IG11c3RSZW1vdmVBc3BlY3RSYXRpb1Byb21pc2UgPSBfSW1hZ2VNYW5hZ2VyLl9pc1NWR0ZpdHRpbmdDYW52YXM7CiAgICAgICAgY29uc3QgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgY29uc3QgaW1hZ2VFbGVtZW50ID0gbmV3IEltYWdlKCk7CiAgICAgICAgY29uc3QgaW1hZ2VQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgaW1hZ2VFbGVtZW50Lm9ubG9hZCA9ICgpID0+IHsKICAgICAgICAgICAgZGF0YS5iaXRtYXAgPSBpbWFnZUVsZW1lbnQ7CiAgICAgICAgICAgIGRhdGEuaXNTdmcgPSB0cnVlOwogICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICB9OwogICAgICAgICAgZmlsZVJlYWRlci5vbmxvYWQgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IGRhdGEuc3ZnVXJsID0gZmlsZVJlYWRlci5yZXN1bHQ7CiAgICAgICAgICAgIGltYWdlRWxlbWVudC5zcmMgPSBhd2FpdCBtdXN0UmVtb3ZlQXNwZWN0UmF0aW9Qcm9taXNlID8gYCR7dXJsfSNzdmdWaWV3KHByZXNlcnZlQXNwZWN0UmF0aW8obm9uZSkpYCA6IHVybDsKICAgICAgICAgIH07CiAgICAgICAgICBpbWFnZUVsZW1lbnQub25lcnJvciA9IGZpbGVSZWFkZXIub25lcnJvciA9IHJlamVjdDsKICAgICAgICB9KTsKICAgICAgICBmaWxlUmVhZGVyLnJlYWRBc0RhdGFVUkwoaW1hZ2UpOwogICAgICAgIGF3YWl0IGltYWdlUHJvbWlzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhLmJpdG1hcCA9IGF3YWl0IGNyZWF0ZUltYWdlQml0bWFwKGltYWdlKTsKICAgICAgfQogICAgICBkYXRhLnJlZkNvdW50ZXIgPSAxOwogICAgfSBjYXRjaCAoZSkgewogICAgICB3YXJuKGUpOwogICAgICBkYXRhID0gbnVsbDsKICAgIH0KICAgIHRoaXMuI2NhY2hlLnNldChrZXksIGRhdGEpOwogICAgaWYgKGRhdGEpIHsKICAgICAgdGhpcy4jY2FjaGUuc2V0KGRhdGEuaWQsIGRhdGEpOwogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfQogIGFzeW5jIGdldEZyb21GaWxlKGZpbGUpIHsKICAgIGNvbnN0IHsKICAgICAgbGFzdE1vZGlmaWVkLAogICAgICBuYW1lLAogICAgICBzaXplLAogICAgICB0eXBlCiAgICB9ID0gZmlsZTsKICAgIHJldHVybiB0aGlzLiNnZXQoYCR7bGFzdE1vZGlmaWVkfV8ke25hbWV9XyR7c2l6ZX1fJHt0eXBlfWAsIGZpbGUpOwogIH0KICBhc3luYyBnZXRGcm9tVXJsKHVybCkgewogICAgcmV0dXJuIHRoaXMuI2dldCh1cmwsIHVybCk7CiAgfQogIGFzeW5jIGdldEZyb21CbG9iKGlkLCBibG9iUHJvbWlzZSkgewogICAgY29uc3QgYmxvYiA9IGF3YWl0IGJsb2JQcm9taXNlOwogICAgcmV0dXJuIHRoaXMuI2dldChpZCwgYmxvYik7CiAgfQogIGFzeW5jIGdldEZyb21JZChpZCkgewogICAgdGhpcy4jY2FjaGUgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBjb25zdCBkYXRhID0gdGhpcy4jY2FjaGUuZ2V0KGlkKTsKICAgIGlmICghZGF0YSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmIChkYXRhLmJpdG1hcCkgewogICAgICBkYXRhLnJlZkNvdW50ZXIgKz0gMTsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9CiAgICBpZiAoZGF0YS5maWxlKSB7CiAgICAgIHJldHVybiB0aGlzLmdldEZyb21GaWxlKGRhdGEuZmlsZSk7CiAgICB9CiAgICBpZiAoZGF0YS5ibG9iUHJvbWlzZSkgewogICAgICBjb25zdCB7CiAgICAgICAgYmxvYlByb21pc2UKICAgICAgfSA9IGRhdGE7CiAgICAgIGRlbGV0ZSBkYXRhLmJsb2JQcm9taXNlOwogICAgICByZXR1cm4gdGhpcy5nZXRGcm9tQmxvYihkYXRhLmlkLCBibG9iUHJvbWlzZSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5nZXRGcm9tVXJsKGRhdGEudXJsKTsKICB9CiAgZ2V0RnJvbUNhbnZhcyhpZCwgY2FudmFzKSB7CiAgICB0aGlzLiNjYWNoZSB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGxldCBkYXRhID0gdGhpcy4jY2FjaGUuZ2V0KGlkKTsKICAgIGlmIChkYXRhPy5iaXRtYXApIHsKICAgICAgZGF0YS5yZWZDb3VudGVyICs9IDE7CiAgICAgIHJldHVybiBkYXRhOwogICAgfQogICAgY29uc3Qgb2Zmc2NyZWVuID0gbmV3IE9mZnNjcmVlbkNhbnZhcyhjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOwogICAgY29uc3QgY3R4ID0gb2Zmc2NyZWVuLmdldENvbnRleHQoIjJkIik7CiAgICBjdHguZHJhd0ltYWdlKGNhbnZhcywgMCwgMCk7CiAgICBkYXRhID0gewogICAgICBiaXRtYXA6IG9mZnNjcmVlbi50cmFuc2ZlclRvSW1hZ2VCaXRtYXAoKSwKICAgICAgaWQ6IGBpbWFnZV8ke3RoaXMuI2Jhc2VJZH1fJHt0aGlzLiNpZCsrfWAsCiAgICAgIHJlZkNvdW50ZXI6IDEsCiAgICAgIGlzU3ZnOiBmYWxzZQogICAgfTsKICAgIHRoaXMuI2NhY2hlLnNldChpZCwgZGF0YSk7CiAgICB0aGlzLiNjYWNoZS5zZXQoZGF0YS5pZCwgZGF0YSk7CiAgICByZXR1cm4gZGF0YTsKICB9CiAgZ2V0U3ZnVXJsKGlkKSB7CiAgICBjb25zdCBkYXRhID0gdGhpcy4jY2FjaGUuZ2V0KGlkKTsKICAgIGlmICghZGF0YT8uaXNTdmcpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICByZXR1cm4gZGF0YS5zdmdVcmw7CiAgfQogIGRlbGV0ZUlkKGlkKSB7CiAgICB0aGlzLiNjYWNoZSB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLiNjYWNoZS5nZXQoaWQpOwogICAgaWYgKCFkYXRhKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGRhdGEucmVmQ291bnRlciAtPSAxOwogICAgaWYgKGRhdGEucmVmQ291bnRlciAhPT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGJpdG1hcAogICAgfSA9IGRhdGE7CiAgICBpZiAoIWRhdGEudXJsICYmICFkYXRhLmZpbGUpIHsKICAgICAgY29uc3QgY2FudmFzID0gbmV3IE9mZnNjcmVlbkNhbnZhcyhiaXRtYXAud2lkdGgsIGJpdG1hcC5oZWlnaHQpOwogICAgICBjb25zdCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiYml0bWFwcmVuZGVyZXIiKTsKICAgICAgY3R4LnRyYW5zZmVyRnJvbUltYWdlQml0bWFwKGJpdG1hcCk7CiAgICAgIGRhdGEuYmxvYlByb21pc2UgPSBjYW52YXMuY29udmVydFRvQmxvYigpOwogICAgfQogICAgYml0bWFwLmNsb3NlPy4oKTsKICAgIGRhdGEuYml0bWFwID0gbnVsbDsKICB9CiAgaXNWYWxpZElkKGlkKSB7CiAgICByZXR1cm4gaWQuc3RhcnRzV2l0aChgaW1hZ2VfJHt0aGlzLiNiYXNlSWR9X2ApOwogIH0KfTsKdmFyIENvbW1hbmRNYW5hZ2VyID0gY2xhc3MgewogICNjb21tYW5kcyA9IFtdOwogICNsb2NrZWQgPSBmYWxzZTsKICAjbWF4U2l6ZTsKICAjcG9zaXRpb24gPSAtMTsKICBjb25zdHJ1Y3RvcihtYXhTaXplID0gMTI4KSB7CiAgICB0aGlzLiNtYXhTaXplID0gbWF4U2l6ZTsKICB9CiAgYWRkKHsKICAgIGNtZCwKICAgIHVuZG8sCiAgICBwb3N0LAogICAgbXVzdEV4ZWMsCiAgICB0eXBlID0gTmFOLAogICAgb3ZlcndyaXRlSWZTYW1lVHlwZSA9IGZhbHNlLAogICAga2VlcFVuZG8gPSBmYWxzZQogIH0pIHsKICAgIGlmIChtdXN0RXhlYykgewogICAgICBjbWQoKTsKICAgIH0KICAgIGlmICh0aGlzLiNsb2NrZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc2F2ZSA9IHsKICAgICAgY21kLAogICAgICB1bmRvLAogICAgICBwb3N0LAogICAgICB0eXBlCiAgICB9OwogICAgaWYgKHRoaXMuI3Bvc2l0aW9uID09PSAtMSkgewogICAgICBpZiAodGhpcy4jY29tbWFuZHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuI2NvbW1hbmRzLmxlbmd0aCA9IDA7CiAgICAgIH0KICAgICAgdGhpcy4jcG9zaXRpb24gPSAwOwogICAgICB0aGlzLiNjb21tYW5kcy5wdXNoKHNhdmUpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAob3ZlcndyaXRlSWZTYW1lVHlwZSAmJiB0aGlzLiNjb21tYW5kc1t0aGlzLiNwb3NpdGlvbl0udHlwZSA9PT0gdHlwZSkgewogICAgICBpZiAoa2VlcFVuZG8pIHsKICAgICAgICBzYXZlLnVuZG8gPSB0aGlzLiNjb21tYW5kc1t0aGlzLiNwb3NpdGlvbl0udW5kbzsKICAgICAgfQogICAgICB0aGlzLiNjb21tYW5kc1t0aGlzLiNwb3NpdGlvbl0gPSBzYXZlOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBuZXh0ID0gdGhpcy4jcG9zaXRpb24gKyAxOwogICAgaWYgKG5leHQgPT09IHRoaXMuI21heFNpemUpIHsKICAgICAgdGhpcy4jY29tbWFuZHMuc3BsaWNlKDAsIDEpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jcG9zaXRpb24gPSBuZXh0OwogICAgICBpZiAobmV4dCA8IHRoaXMuI2NvbW1hbmRzLmxlbmd0aCkgewogICAgICAgIHRoaXMuI2NvbW1hbmRzLnNwbGljZShuZXh0KTsKICAgICAgfQogICAgfQogICAgdGhpcy4jY29tbWFuZHMucHVzaChzYXZlKTsKICB9CiAgdW5kbygpIHsKICAgIGlmICh0aGlzLiNwb3NpdGlvbiA9PT0gLTEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jbG9ja2VkID0gdHJ1ZTsKICAgIGNvbnN0IHsKICAgICAgdW5kbywKICAgICAgcG9zdAogICAgfSA9IHRoaXMuI2NvbW1hbmRzW3RoaXMuI3Bvc2l0aW9uXTsKICAgIHVuZG8oKTsKICAgIHBvc3Q/LigpOwogICAgdGhpcy4jbG9ja2VkID0gZmFsc2U7CiAgICB0aGlzLiNwb3NpdGlvbiAtPSAxOwogIH0KICByZWRvKCkgewogICAgaWYgKHRoaXMuI3Bvc2l0aW9uIDwgdGhpcy4jY29tbWFuZHMubGVuZ3RoIC0gMSkgewogICAgICB0aGlzLiNwb3NpdGlvbiArPSAxOwogICAgICB0aGlzLiNsb2NrZWQgPSB0cnVlOwogICAgICBjb25zdCB7CiAgICAgICAgY21kLAogICAgICAgIHBvc3QKICAgICAgfSA9IHRoaXMuI2NvbW1hbmRzW3RoaXMuI3Bvc2l0aW9uXTsKICAgICAgY21kKCk7CiAgICAgIHBvc3Q/LigpOwogICAgICB0aGlzLiNsb2NrZWQgPSBmYWxzZTsKICAgIH0KICB9CiAgaGFzU29tZXRoaW5nVG9VbmRvKCkgewogICAgcmV0dXJuIHRoaXMuI3Bvc2l0aW9uICE9PSAtMTsKICB9CiAgaGFzU29tZXRoaW5nVG9SZWRvKCkgewogICAgcmV0dXJuIHRoaXMuI3Bvc2l0aW9uIDwgdGhpcy4jY29tbWFuZHMubGVuZ3RoIC0gMTsKICB9CiAgY2xlYW5UeXBlKHR5cGUpIHsKICAgIGlmICh0aGlzLiNwb3NpdGlvbiA9PT0gLTEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChsZXQgaSA9IHRoaXMuI3Bvc2l0aW9uOyBpID49IDA7IGktLSkgewogICAgICBpZiAodGhpcy4jY29tbWFuZHNbaV0udHlwZSAhPT0gdHlwZSkgewogICAgICAgIHRoaXMuI2NvbW1hbmRzLnNwbGljZShpICsgMSwgdGhpcy4jcG9zaXRpb24gLSBpKTsKICAgICAgICB0aGlzLiNwb3NpdGlvbiA9IGk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICB0aGlzLiNjb21tYW5kcy5sZW5ndGggPSAwOwogICAgdGhpcy4jcG9zaXRpb24gPSAtMTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI2NvbW1hbmRzID0gbnVsbDsKICB9Cn07CnZhciBLZXlib2FyZE1hbmFnZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY2FsbGJhY2tzKSB7CiAgICB0aGlzLmJ1ZmZlciA9IFtdOwogICAgdGhpcy5jYWxsYmFja3MgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5hbGxLZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGNvbnN0IHsKICAgICAgaXNNYWMKICAgIH0gPSB1dGlsX0ZlYXR1cmVUZXN0LnBsYXRmb3JtOwogICAgZm9yIChjb25zdCBba2V5cywgY2FsbGJhY2ssIG9wdGlvbnMgPSB7fV0gb2YgY2FsbGJhY2tzKSB7CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHsKICAgICAgICBjb25zdCBpc01hY0tleSA9IGtleS5zdGFydHNXaXRoKCJtYWMrIik7CiAgICAgICAgaWYgKGlzTWFjICYmIGlzTWFjS2V5KSB7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrcy5zZXQoa2V5LnNsaWNlKDQpLCB7CiAgICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgICBvcHRpb25zCiAgICAgICAgICB9KTsKICAgICAgICAgIHRoaXMuYWxsS2V5cy5hZGQoa2V5LnNwbGl0KCIrIikuYXQoLTEpKTsKICAgICAgICB9IGVsc2UgaWYgKCFpc01hYyAmJiAhaXNNYWNLZXkpIHsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tzLnNldChrZXksIHsKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIG9wdGlvbnMKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5hbGxLZXlzLmFkZChrZXkuc3BsaXQoIisiKS5hdCgtMSkpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAjc2VyaWFsaXplKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQuYWx0S2V5KSB7CiAgICAgIHRoaXMuYnVmZmVyLnB1c2goImFsdCIpOwogICAgfQogICAgaWYgKGV2ZW50LmN0cmxLZXkpIHsKICAgICAgdGhpcy5idWZmZXIucHVzaCgiY3RybCIpOwogICAgfQogICAgaWYgKGV2ZW50Lm1ldGFLZXkpIHsKICAgICAgdGhpcy5idWZmZXIucHVzaCgibWV0YSIpOwogICAgfQogICAgaWYgKGV2ZW50LnNoaWZ0S2V5KSB7CiAgICAgIHRoaXMuYnVmZmVyLnB1c2goInNoaWZ0Iik7CiAgICB9CiAgICB0aGlzLmJ1ZmZlci5wdXNoKGV2ZW50LmtleSk7CiAgICBjb25zdCBzdHIgPSB0aGlzLmJ1ZmZlci5qb2luKCIrIik7CiAgICB0aGlzLmJ1ZmZlci5sZW5ndGggPSAwOwogICAgcmV0dXJuIHN0cjsKICB9CiAgZXhlYyhzZWxmLCBldmVudCkgewogICAgaWYgKCF0aGlzLmFsbEtleXMuaGFzKGV2ZW50LmtleSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgaW5mbzIgPSB0aGlzLmNhbGxiYWNrcy5nZXQodGhpcy4jc2VyaWFsaXplKGV2ZW50KSk7CiAgICBpZiAoIWluZm8yKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgY2FsbGJhY2ssCiAgICAgIG9wdGlvbnM6IHsKICAgICAgICBidWJibGVzID0gZmFsc2UsCiAgICAgICAgYXJncyA9IFtdLAogICAgICAgIGNoZWNrZXIgPSBudWxsCiAgICAgIH0KICAgIH0gPSBpbmZvMjsKICAgIGlmIChjaGVja2VyICYmICFjaGVja2VyKHNlbGYsIGV2ZW50KSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjYWxsYmFjay5iaW5kKHNlbGYsIC4uLmFyZ3MsIGV2ZW50KSgpOwogICAgaWYgKCFidWJibGVzKSB7CiAgICAgIHN0b3BFdmVudChldmVudCk7CiAgICB9CiAgfQp9Owp2YXIgQ29sb3JNYW5hZ2VyID0gY2xhc3MgX0NvbG9yTWFuYWdlciB7CiAgc3RhdGljIF9jb2xvcnNNYXBwaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoW1siQ2FudmFzVGV4dCIsIFswLCAwLCAwXV0sIFsiQ2FudmFzIiwgWzI1NSwgMjU1LCAyNTVdXV0pOwogIGdldCBfY29sb3JzKCkgewogICAgY29uc3QgY29sb3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoW1siQ2FudmFzVGV4dCIsIG51bGxdLCBbIkNhbnZhcyIsIG51bGxdXSk7CiAgICBnZXRDb2xvclZhbHVlcyhjb2xvcnMpOwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2NvbG9ycyIsIGNvbG9ycyk7CiAgfQogIGNvbnZlcnQoY29sb3IpIHsKICAgIGNvbnN0IHJnYiA9IGdldFJHQihjb2xvcik7CiAgICBpZiAoIXdpbmRvdy5tYXRjaE1lZGlhKCIoZm9yY2VkLWNvbG9yczogYWN0aXZlKSIpLm1hdGNoZXMpIHsKICAgICAgcmV0dXJuIHJnYjsKICAgIH0KICAgIGZvciAoY29uc3QgW25hbWUsIFJHQl0gb2YgdGhpcy5fY29sb3JzKSB7CiAgICAgIGlmIChSR0IuZXZlcnkoKHgsIGkpID0+IHggPT09IHJnYltpXSkpIHsKICAgICAgICByZXR1cm4gX0NvbG9yTWFuYWdlci5fY29sb3JzTWFwcGluZy5nZXQobmFtZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZ2I7CiAgfQogIGdldEhleENvZGUobmFtZSkgewogICAgY29uc3QgcmdiID0gdGhpcy5fY29sb3JzLmdldChuYW1lKTsKICAgIGlmICghcmdiKSB7CiAgICAgIHJldHVybiBuYW1lOwogICAgfQogICAgcmV0dXJuIFV0aWwubWFrZUhleENvbG9yKC4uLnJnYik7CiAgfQp9Owp2YXIgQW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlciA9IGNsYXNzIF9Bbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyIHsKICAjYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICNhY3RpdmVFZGl0b3IgPSBudWxsOwogICNhbGxFZGl0YWJsZUFubm90YXRpb25zID0gbnVsbDsKICAjYWxsRWRpdG9ycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI2FsbExheWVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI2FsdFRleHRNYW5hZ2VyID0gbnVsbDsKICAjYW5ub3RhdGlvblN0b3JhZ2UgPSBudWxsOwogICNjaGFuZ2VkRXhpc3RpbmdBbm5vdGF0aW9ucyA9IG51bGw7CiAgI2NvbW1hbmRNYW5hZ2VyID0gbmV3IENvbW1hbmRNYW5hZ2VyKCk7CiAgI2NvbW1lbnRNYW5hZ2VyID0gbnVsbDsKICAjY29weVBhc3RlQUMgPSBudWxsOwogICNjdXJyZW50RHJhd2luZ1Nlc3Npb24gPSBudWxsOwogICNjdXJyZW50UGFnZUluZGV4ID0gMDsKICAjZGVsZXRlZEFubm90YXRpb25zRWxlbWVudElkcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgI2RyYWdnaW5nRWRpdG9ycyA9IG51bGw7CiAgI2VkaXRvclR5cGVzID0gbnVsbDsKICAjZWRpdG9yc1RvUmVzY2FsZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgX2VkaXRvclVuZG9CYXIgPSBudWxsOwogICNlbmFibGVIaWdobGlnaHRGbG9hdGluZ0J1dHRvbiA9IGZhbHNlOwogICNlbmFibGVVcGRhdGVkQWRkSW1hZ2UgPSBmYWxzZTsKICAjZW5hYmxlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZSA9IGZhbHNlOwogICNmaWx0ZXJGYWN0b3J5ID0gbnVsbDsKICAjZm9jdXNNYWluQ29udGFpbmVyVGltZW91dElkID0gbnVsbDsKICAjZm9jdXNNYW5hZ2VyQUMgPSBudWxsOwogICNoaWdobGlnaHRDb2xvcnMgPSBudWxsOwogICNoaWdobGlnaHRXaGVuU2hpZnRVcCA9IGZhbHNlOwogICNmbG9hdGluZ1Rvb2xiYXIgPSBudWxsOwogICNpZE1hbmFnZXIgPSBuZXcgSWRNYW5hZ2VyKCk7CiAgI2lzRW5hYmxlZCA9IGZhbHNlOwogICNpc1BvaW50ZXJEb3duID0gZmFsc2U7CiAgI2lzV2FpdGluZyA9IGZhbHNlOwogICNrZXlib2FyZE1hbmFnZXJBQyA9IG51bGw7CiAgI2xhc3RBY3RpdmVFbGVtZW50ID0gbnVsbDsKICAjbWFpbkhpZ2hsaWdodENvbG9yUGlja2VyID0gbnVsbDsKICAjbWlzc2luZ0NhbnZhc2VzID0gbnVsbDsKICAjbWxNYW5hZ2VyID0gbnVsbDsKICAjbW9kZSA9IEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkU7CiAgI3NlbGVjdGVkRWRpdG9ycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgI3NlbGVjdGVkVGV4dE5vZGUgPSBudWxsOwogICNzaWduYXR1cmVNYW5hZ2VyID0gbnVsbDsKICAjcGFnZUNvbG9ycyA9IG51bGw7CiAgI3Nob3dBbGxTdGF0ZXMgPSBudWxsOwogICNwZGZEb2N1bWVudCA9IG51bGw7CiAgI3ByZXZpb3VzU3RhdGVzID0gewogICAgaXNFZGl0aW5nOiBmYWxzZSwKICAgIGlzRW1wdHk6IHRydWUsCiAgICBoYXNTb21ldGhpbmdUb1VuZG86IGZhbHNlLAogICAgaGFzU29tZXRoaW5nVG9SZWRvOiBmYWxzZSwKICAgIGhhc1NlbGVjdGVkRWRpdG9yOiBmYWxzZSwKICAgIGhhc1NlbGVjdGVkVGV4dDogZmFsc2UKICB9OwogICN0cmFuc2xhdGlvbiA9IFswLCAwXTsKICAjdHJhbnNsYXRpb25UaW1lb3V0SWQgPSBudWxsOwogICNjb250YWluZXIgPSBudWxsOwogICN2aWV3ZXIgPSBudWxsOwogICN2aWV3ZXJBbGVydCA9IG51bGw7CiAgI3VwZGF0ZU1vZGVDYXBhYmlsaXR5ID0gbnVsbDsKICBzdGF0aWMgVFJBTlNMQVRFX1NNQUxMID0gMTsKICBzdGF0aWMgVFJBTlNMQVRFX0JJRyA9IDEwOwogIHN0YXRpYyBnZXQgX2tleWJvYXJkTWFuYWdlcigpIHsKICAgIGNvbnN0IHByb3RvID0gX0Fubm90YXRpb25FZGl0b3JVSU1hbmFnZXIucHJvdG90eXBlOwogICAgY29uc3QgYXJyb3dDaGVja2VyID0gKHNlbGYpID0+IHNlbGYuI2NvbnRhaW5lci5jb250YWlucyhkb2N1bWVudC5hY3RpdmVFbGVtZW50KSAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50LnRhZ05hbWUgIT09ICJCVVRUT04iICYmIHNlbGYuaGFzU29tZXRoaW5nVG9Db250cm9sKCk7CiAgICBjb25zdCB0ZXh0SW5wdXRDaGVja2VyID0gKF9zZWxmLCB7CiAgICAgIHRhcmdldDogZWwKICAgIH0pID0+IHsKICAgICAgaWYgKGVsIGluc3RhbmNlb2YgSFRNTElucHV0RWxlbWVudCkgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIHR5cGUKICAgICAgICB9ID0gZWw7CiAgICAgICAgcmV0dXJuIHR5cGUgIT09ICJ0ZXh0IiAmJiB0eXBlICE9PSAibnVtYmVyIjsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgICBjb25zdCBzbWFsbCA9IHRoaXMuVFJBTlNMQVRFX1NNQUxMOwogICAgY29uc3QgYmlnID0gdGhpcy5UUkFOU0xBVEVfQklHOwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2tleWJvYXJkTWFuYWdlciIsIG5ldyBLZXlib2FyZE1hbmFnZXIoW1tbImN0cmwrYSIsICJtYWMrbWV0YSthIl0sIHByb3RvLnNlbGVjdEFsbCwgewogICAgICBjaGVja2VyOiB0ZXh0SW5wdXRDaGVja2VyCiAgICB9XSwgW1siY3RybCt6IiwgIm1hYyttZXRhK3oiXSwgcHJvdG8udW5kbywgewogICAgICBjaGVja2VyOiB0ZXh0SW5wdXRDaGVja2VyCiAgICB9XSwgW1siY3RybCt5IiwgImN0cmwrc2hpZnQreiIsICJtYWMrbWV0YStzaGlmdCt6IiwgImN0cmwrc2hpZnQrWiIsICJtYWMrbWV0YStzaGlmdCtaIl0sIHByb3RvLnJlZG8sIHsKICAgICAgY2hlY2tlcjogdGV4dElucHV0Q2hlY2tlcgogICAgfV0sIFtbIkJhY2tzcGFjZSIsICJhbHQrQmFja3NwYWNlIiwgImN0cmwrQmFja3NwYWNlIiwgInNoaWZ0K0JhY2tzcGFjZSIsICJtYWMrQmFja3NwYWNlIiwgIm1hYythbHQrQmFja3NwYWNlIiwgIm1hYytjdHJsK0JhY2tzcGFjZSIsICJEZWxldGUiLCAiY3RybCtEZWxldGUiLCAic2hpZnQrRGVsZXRlIiwgIm1hYytEZWxldGUiXSwgcHJvdG8uZGVsZXRlLCB7CiAgICAgIGNoZWNrZXI6IHRleHRJbnB1dENoZWNrZXIKICAgIH1dLCBbWyJFbnRlciIsICJtYWMrRW50ZXIiXSwgcHJvdG8uYWRkTmV3RWRpdG9yRnJvbUtleWJvYXJkLCB7CiAgICAgIGNoZWNrZXI6IChzZWxmLCB7CiAgICAgICAgdGFyZ2V0OiBlbAogICAgICB9KSA9PiAhKGVsIGluc3RhbmNlb2YgSFRNTEJ1dHRvbkVsZW1lbnQpICYmIHNlbGYuI2NvbnRhaW5lci5jb250YWlucyhlbCkgJiYgIXNlbGYuaXNFbnRlckhhbmRsZWQKICAgIH1dLCBbWyIgIiwgIm1hYysgIl0sIHByb3RvLmFkZE5ld0VkaXRvckZyb21LZXlib2FyZCwgewogICAgICBjaGVja2VyOiAoc2VsZiwgewogICAgICAgIHRhcmdldDogZWwKICAgICAgfSkgPT4gIShlbCBpbnN0YW5jZW9mIEhUTUxCdXR0b25FbGVtZW50KSAmJiBzZWxmLiNjb250YWluZXIuY29udGFpbnMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkKICAgIH1dLCBbWyJFc2NhcGUiLCAibWFjK0VzY2FwZSJdLCBwcm90by51bnNlbGVjdEFsbF0sIFtbIkFycm93TGVmdCIsICJtYWMrQXJyb3dMZWZ0Il0sIHByb3RvLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycywgewogICAgICBhcmdzOiBbLXNtYWxsLCAwXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siY3RybCtBcnJvd0xlZnQiLCAibWFjK3NoaWZ0K0Fycm93TGVmdCJdLCBwcm90by50cmFuc2xhdGVTZWxlY3RlZEVkaXRvcnMsIHsKICAgICAgYXJnczogWy1iaWcsIDBdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJBcnJvd1JpZ2h0IiwgIm1hYytBcnJvd1JpZ2h0Il0sIHByb3RvLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycywgewogICAgICBhcmdzOiBbc21hbGwsIDBdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJjdHJsK0Fycm93UmlnaHQiLCAibWFjK3NoaWZ0K0Fycm93UmlnaHQiXSwgcHJvdG8udHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzLCB7CiAgICAgIGFyZ3M6IFtiaWcsIDBdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJBcnJvd1VwIiwgIm1hYytBcnJvd1VwIl0sIHByb3RvLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycywgewogICAgICBhcmdzOiBbMCwgLXNtYWxsXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siY3RybCtBcnJvd1VwIiwgIm1hYytzaGlmdCtBcnJvd1VwIl0sIHByb3RvLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycywgewogICAgICBhcmdzOiBbMCwgLWJpZ10sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbIkFycm93RG93biIsICJtYWMrQXJyb3dEb3duIl0sIHByb3RvLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycywgewogICAgICBhcmdzOiBbMCwgc21hbGxdLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJjdHJsK0Fycm93RG93biIsICJtYWMrc2hpZnQrQXJyb3dEb3duIl0sIHByb3RvLnRyYW5zbGF0ZVNlbGVjdGVkRWRpdG9ycywgewogICAgICBhcmdzOiBbMCwgYmlnXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XV0pKTsKICB9CiAgY29uc3RydWN0b3IoY29udGFpbmVyMiwgdmlld2VyLCB2aWV3ZXJBbGVydCwgYWx0VGV4dE1hbmFnZXIsIGNvbW1lbnRNYW5hZ2VyLCBzaWduYXR1cmVNYW5hZ2VyLCBldmVudEJ1cywgcGRmRG9jdW1lbnQsIHBhZ2VDb2xvcnMsIGhpZ2hsaWdodENvbG9ycywgZW5hYmxlSGlnaGxpZ2h0RmxvYXRpbmdCdXR0b24sIGVuYWJsZVVwZGF0ZWRBZGRJbWFnZSwgZW5hYmxlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZSwgbWxNYW5hZ2VyLCBlZGl0b3JVbmRvQmFyLCBzdXBwb3J0c1BpbmNoVG9ab29tKSB7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLl9zaWduYWwgPSB0aGlzLiNhYm9ydENvbnRyb2xsZXIuc2lnbmFsOwogICAgdGhpcy4jY29udGFpbmVyID0gY29udGFpbmVyMjsKICAgIHRoaXMuI3ZpZXdlciA9IHZpZXdlcjsKICAgIHRoaXMuI3ZpZXdlckFsZXJ0ID0gdmlld2VyQWxlcnQ7CiAgICB0aGlzLiNhbHRUZXh0TWFuYWdlciA9IGFsdFRleHRNYW5hZ2VyOwogICAgdGhpcy4jY29tbWVudE1hbmFnZXIgPSBjb21tZW50TWFuYWdlcjsKICAgIHRoaXMuI3NpZ25hdHVyZU1hbmFnZXIgPSBzaWduYXR1cmVNYW5hZ2VyOwogICAgdGhpcy4jcGRmRG9jdW1lbnQgPSBwZGZEb2N1bWVudDsKICAgIHRoaXMuX2V2ZW50QnVzID0gZXZlbnRCdXM7CiAgICBldmVudEJ1cy5fb24oImVkaXRpbmdhY3Rpb24iLCB0aGlzLm9uRWRpdGluZ0FjdGlvbi5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBldmVudEJ1cy5fb24oInBhZ2VjaGFuZ2luZyIsIHRoaXMub25QYWdlQ2hhbmdpbmcuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgZXZlbnRCdXMuX29uKCJzY2FsZWNoYW5naW5nIiwgdGhpcy5vblNjYWxlQ2hhbmdpbmcuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgZXZlbnRCdXMuX29uKCJyb3RhdGlvbmNoYW5naW5nIiwgdGhpcy5vblJvdGF0aW9uQ2hhbmdpbmcuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgZXZlbnRCdXMuX29uKCJzZXRwcmVmZXJlbmNlIiwgdGhpcy5vblNldFByZWZlcmVuY2UuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgZXZlbnRCdXMuX29uKCJzd2l0Y2hhbm5vdGF0aW9uZWRpdG9ycGFyYW1zIiwgKGV2dCkgPT4gdGhpcy51cGRhdGVQYXJhbXMoZXZ0LnR5cGUsIGV2dC52YWx1ZSksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsICgpID0+IHsKICAgICAgdGhpcy4jaXNQb2ludGVyRG93biA9IHRydWU7CiAgICB9LCB7CiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgKCkgPT4gewogICAgICB0aGlzLiNpc1BvaW50ZXJEb3duID0gZmFsc2U7CiAgICB9LCB7CiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0aGlzLiNhZGRTZWxlY3Rpb25MaXN0ZW5lcigpOwogICAgdGhpcy4jYWRkRHJhZ0FuZERyb3BMaXN0ZW5lcnMoKTsKICAgIHRoaXMuI2FkZEtleWJvYXJkTWFuYWdlcigpOwogICAgdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UgPSBwZGZEb2N1bWVudC5hbm5vdGF0aW9uU3RvcmFnZTsKICAgIHRoaXMuI2ZpbHRlckZhY3RvcnkgPSBwZGZEb2N1bWVudC5maWx0ZXJGYWN0b3J5OwogICAgdGhpcy4jcGFnZUNvbG9ycyA9IHBhZ2VDb2xvcnM7CiAgICB0aGlzLiNoaWdobGlnaHRDb2xvcnMgPSBoaWdobGlnaHRDb2xvcnMgfHwgbnVsbDsKICAgIHRoaXMuI2VuYWJsZUhpZ2hsaWdodEZsb2F0aW5nQnV0dG9uID0gZW5hYmxlSGlnaGxpZ2h0RmxvYXRpbmdCdXR0b247CiAgICB0aGlzLiNlbmFibGVVcGRhdGVkQWRkSW1hZ2UgPSBlbmFibGVVcGRhdGVkQWRkSW1hZ2U7CiAgICB0aGlzLiNlbmFibGVOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlID0gZW5hYmxlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZTsKICAgIHRoaXMuI21sTWFuYWdlciA9IG1sTWFuYWdlciB8fCBudWxsOwogICAgdGhpcy52aWV3UGFyYW1ldGVycyA9IHsKICAgICAgcmVhbFNjYWxlOiBQaXhlbHNQZXJJbmNoLlBERl9UT19DU1NfVU5JVFMsCiAgICAgIHJvdGF0aW9uOiAwCiAgICB9OwogICAgdGhpcy5pc1NoaWZ0S2V5RG93biA9IGZhbHNlOwogICAgdGhpcy5fZWRpdG9yVW5kb0JhciA9IGVkaXRvclVuZG9CYXIgfHwgbnVsbDsKICAgIHRoaXMuX3N1cHBvcnRzUGluY2hUb1pvb20gPSBzdXBwb3J0c1BpbmNoVG9ab29tICE9PSBmYWxzZTsKICAgIGNvbW1lbnRNYW5hZ2VyPy5zZXRTaWRlYmFyVWlNYW5hZ2VyKHRoaXMpOwogIH0KICBkZXN0cm95KCkgewogICAgdGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHk/LnJlc29sdmUoKTsKICAgIHRoaXMuI3VwZGF0ZU1vZGVDYXBhYmlsaXR5ID0gbnVsbDsKICAgIHRoaXMuI2Fib3J0Q29udHJvbGxlcj8uYWJvcnQoKTsKICAgIHRoaXMuI2Fib3J0Q29udHJvbGxlciA9IG51bGw7CiAgICB0aGlzLl9zaWduYWwgPSBudWxsOwogICAgZm9yIChjb25zdCBsYXllciBvZiB0aGlzLiNhbGxMYXllcnMudmFsdWVzKCkpIHsKICAgICAgbGF5ZXIuZGVzdHJveSgpOwogICAgfQogICAgdGhpcy4jYWxsTGF5ZXJzLmNsZWFyKCk7CiAgICB0aGlzLiNhbGxFZGl0b3JzLmNsZWFyKCk7CiAgICB0aGlzLiNlZGl0b3JzVG9SZXNjYWxlLmNsZWFyKCk7CiAgICB0aGlzLiNtaXNzaW5nQ2FudmFzZXM/LmNsZWFyKCk7CiAgICB0aGlzLiNhY3RpdmVFZGl0b3IgPSBudWxsOwogICAgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzLmNsZWFyKCk7CiAgICB0aGlzLiNjb21tYW5kTWFuYWdlci5kZXN0cm95KCk7CiAgICB0aGlzLiNhbHRUZXh0TWFuYWdlcj8uZGVzdHJveSgpOwogICAgdGhpcy4jY29tbWVudE1hbmFnZXI/LmRlc3Ryb3koKTsKICAgIHRoaXMuI3NpZ25hdHVyZU1hbmFnZXI/LmRlc3Ryb3koKTsKICAgIHRoaXMuI2Zsb2F0aW5nVG9vbGJhcj8uaGlkZSgpOwogICAgdGhpcy4jZmxvYXRpbmdUb29sYmFyID0gbnVsbDsKICAgIHRoaXMuI21haW5IaWdobGlnaHRDb2xvclBpY2tlcj8uZGVzdHJveSgpOwogICAgdGhpcy4jbWFpbkhpZ2hsaWdodENvbG9yUGlja2VyID0gbnVsbDsKICAgIHRoaXMuI2FsbEVkaXRhYmxlQW5ub3RhdGlvbnMgPSBudWxsOwogICAgaWYgKHRoaXMuI2ZvY3VzTWFpbkNvbnRhaW5lclRpbWVvdXRJZCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy4jZm9jdXNNYWluQ29udGFpbmVyVGltZW91dElkKTsKICAgICAgdGhpcy4jZm9jdXNNYWluQ29udGFpbmVyVGltZW91dElkID0gbnVsbDsKICAgIH0KICAgIGlmICh0aGlzLiN0cmFuc2xhdGlvblRpbWVvdXRJZCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy4jdHJhbnNsYXRpb25UaW1lb3V0SWQpOwogICAgICB0aGlzLiN0cmFuc2xhdGlvblRpbWVvdXRJZCA9IG51bGw7CiAgICB9CiAgICB0aGlzLl9lZGl0b3JVbmRvQmFyPy5kZXN0cm95KCk7CiAgICB0aGlzLiNwZGZEb2N1bWVudCA9IG51bGw7CiAgfQogIGNvbWJpbmVkU2lnbmFsKGFjKSB7CiAgICByZXR1cm4gQWJvcnRTaWduYWwuYW55KFt0aGlzLl9zaWduYWwsIGFjLnNpZ25hbF0pOwogIH0KICBnZXQgbWxNYW5hZ2VyKCkgewogICAgcmV0dXJuIHRoaXMuI21sTWFuYWdlcjsKICB9CiAgZ2V0IHVzZU5ld0FsdFRleHRGbG93KCkgewogICAgcmV0dXJuIHRoaXMuI2VuYWJsZVVwZGF0ZWRBZGRJbWFnZTsKICB9CiAgZ2V0IHVzZU5ld0FsdFRleHRXaGVuQWRkaW5nSW1hZ2UoKSB7CiAgICByZXR1cm4gdGhpcy4jZW5hYmxlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZTsKICB9CiAgZ2V0IGhjbUZpbHRlcigpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImhjbUZpbHRlciIsIHRoaXMuI3BhZ2VDb2xvcnMgPyB0aGlzLiNmaWx0ZXJGYWN0b3J5LmFkZEhDTUZpbHRlcih0aGlzLiNwYWdlQ29sb3JzLmZvcmVncm91bmQsIHRoaXMuI3BhZ2VDb2xvcnMuYmFja2dyb3VuZCkgOiAibm9uZSIpOwogIH0KICBnZXQgZGlyZWN0aW9uKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiZGlyZWN0aW9uIiwgZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLiNjb250YWluZXIpLmRpcmVjdGlvbik7CiAgfQogIGdldCBfaGlnaGxpZ2h0Q29sb3JzKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2hpZ2hsaWdodENvbG9ycyIsIHRoaXMuI2hpZ2hsaWdodENvbG9ycyA/IG5ldyBNYXAodGhpcy4jaGlnaGxpZ2h0Q29sb3JzLnNwbGl0KCIsIikubWFwKChwYWlyKSA9PiB7CiAgICAgIHBhaXIgPSBwYWlyLnNwbGl0KCI9IikubWFwKCh4KSA9PiB4LnRyaW0oKSk7CiAgICAgIHBhaXJbMV0gPSBwYWlyWzFdLnRvVXBwZXJDYXNlKCk7CiAgICAgIHJldHVybiBwYWlyOwogICAgfSkpIDogbnVsbCk7CiAgfQogIGdldCBoaWdobGlnaHRDb2xvcnMoKSB7CiAgICBjb25zdCB7CiAgICAgIF9oaWdobGlnaHRDb2xvcnMKICAgIH0gPSB0aGlzOwogICAgaWYgKCFfaGlnaGxpZ2h0Q29sb3JzKSB7CiAgICAgIHJldHVybiBzaGFkb3codGhpcywgImhpZ2hsaWdodENvbG9ycyIsIG51bGwpOwogICAgfQogICAgY29uc3QgbWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGhhc0hDTSA9ICEhdGhpcy4jcGFnZUNvbG9yczsKICAgIGZvciAoY29uc3QgW25hbWUsIGNvbG9yXSBvZiBfaGlnaGxpZ2h0Q29sb3JzKSB7CiAgICAgIGNvbnN0IGlzTmFtZUZvckhDTSA9IG5hbWUuZW5kc1dpdGgoIl9IQ00iKTsKICAgICAgaWYgKGhhc0hDTSAmJiBpc05hbWVGb3JIQ00pIHsKICAgICAgICBtYXAuc2V0KG5hbWUucmVwbGFjZSgiX0hDTSIsICIiKSwgY29sb3IpOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghaGFzSENNICYmICFpc05hbWVGb3JIQ00pIHsKICAgICAgICBtYXAuc2V0KG5hbWUsIGNvbG9yKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaGlnaGxpZ2h0Q29sb3JzIiwgbWFwKTsKICB9CiAgZ2V0IGhpZ2hsaWdodENvbG9yTmFtZXMoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJoaWdobGlnaHRDb2xvck5hbWVzIiwgdGhpcy5oaWdobGlnaHRDb2xvcnMgPyBuZXcgTWFwKEFycmF5LmZyb20odGhpcy5oaWdobGlnaHRDb2xvcnMsIChlKSA9PiBlLnJldmVyc2UoKSkpIDogbnVsbCk7CiAgfQogIGdldE5vbkhDTUNvbG9yKGNvbG9yKSB7CiAgICBpZiAoIXRoaXMuX2hpZ2hsaWdodENvbG9ycykgewogICAgICByZXR1cm4gY29sb3I7CiAgICB9CiAgICBjb25zdCBjb2xvck5hbWUgPSB0aGlzLmhpZ2hsaWdodENvbG9yTmFtZXMuZ2V0KGNvbG9yKTsKICAgIHJldHVybiB0aGlzLl9oaWdobGlnaHRDb2xvcnMuZ2V0KGNvbG9yTmFtZSkgfHwgY29sb3I7CiAgfQogIGdldE5vbkhDTUNvbG9yTmFtZShjb2xvcikgewogICAgcmV0dXJuIHRoaXMuaGlnaGxpZ2h0Q29sb3JOYW1lcy5nZXQoY29sb3IpIHx8IGNvbG9yOwogIH0KICBzZXRDdXJyZW50RHJhd2luZ1Nlc3Npb24obGF5ZXIpIHsKICAgIGlmIChsYXllcikgewogICAgICB0aGlzLnVuc2VsZWN0QWxsKCk7CiAgICAgIHRoaXMuZGlzYWJsZVVzZXJTZWxlY3QodHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmRpc2FibGVVc2VyU2VsZWN0KGZhbHNlKTsKICAgIH0KICAgIHRoaXMuI2N1cnJlbnREcmF3aW5nU2Vzc2lvbiA9IGxheWVyOwogIH0KICBzZXRNYWluSGlnaGxpZ2h0Q29sb3JQaWNrZXIoY29sb3JQaWNrZXIpIHsKICAgIHRoaXMuI21haW5IaWdobGlnaHRDb2xvclBpY2tlciA9IGNvbG9yUGlja2VyOwogIH0KICBlZGl0QWx0VGV4dChlZGl0b3IsIGZpcnN0VGltZSA9IGZhbHNlKSB7CiAgICB0aGlzLiNhbHRUZXh0TWFuYWdlcj8uZWRpdEFsdFRleHQodGhpcywgZWRpdG9yLCBmaXJzdFRpbWUpOwogIH0KICBoYXNDb21tZW50TWFuYWdlcigpIHsKICAgIHJldHVybiAhIXRoaXMuI2NvbW1lbnRNYW5hZ2VyOwogIH0KICBlZGl0Q29tbWVudChlZGl0b3IsIHBvc1gsIHBvc1ksIG9wdGlvbnMpIHsKICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy5zaG93RGlhbG9nKHRoaXMsIGVkaXRvciwgcG9zWCwgcG9zWSwgb3B0aW9ucyk7CiAgfQogIHNlbGVjdENvbW1lbnQocGFnZUluZGV4LCB1aWQpIHsKICAgIGNvbnN0IGxheWVyID0gdGhpcy4jYWxsTGF5ZXJzLmdldChwYWdlSW5kZXgpOwogICAgY29uc3QgZWRpdG9yID0gbGF5ZXI/LmdldEVkaXRvckJ5VUlEKHVpZCk7CiAgICBlZGl0b3I/LnRvZ2dsZUNvbW1lbnQodHJ1ZSwgdHJ1ZSk7CiAgfQogIHVwZGF0ZUNvbW1lbnQoZWRpdG9yKSB7CiAgICB0aGlzLiNjb21tZW50TWFuYWdlcj8udXBkYXRlQ29tbWVudChlZGl0b3IuZ2V0RGF0YSgpKTsKICB9CiAgdXBkYXRlUG9wdXBDb2xvcihlZGl0b3IpIHsKICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy51cGRhdGVQb3B1cENvbG9yKGVkaXRvcik7CiAgfQogIHJlbW92ZUNvbW1lbnQoZWRpdG9yKSB7CiAgICB0aGlzLiNjb21tZW50TWFuYWdlcj8ucmVtb3ZlQ29tbWVudHMoW2VkaXRvci51aWRdKTsKICB9CiAgdG9nZ2xlQ29tbWVudChlZGl0b3IsIGlzU2VsZWN0ZWQsIHZpc2liaWxpdHkgPSB2b2lkIDApIHsKICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy50b2dnbGVDb21tZW50UG9wdXAoZWRpdG9yLCBpc1NlbGVjdGVkLCB2aXNpYmlsaXR5KTsKICB9CiAgbWFrZUNvbW1lbnRDb2xvcihjb2xvciwgb3BhY2l0eSkgewogICAgcmV0dXJuIGNvbG9yICYmIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy5tYWtlQ29tbWVudENvbG9yKGNvbG9yLCBvcGFjaXR5KSB8fCBudWxsOwogIH0KICBnZXRDb21tZW50RGlhbG9nRWxlbWVudCgpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50TWFuYWdlcj8uZGlhbG9nRWxlbWVudCB8fCBudWxsOwogIH0KICBhc3luYyB3YWl0Rm9yRWRpdG9yc1JlbmRlcmVkKHBhZ2VOdW1iZXIpIHsKICAgIGlmICh0aGlzLiNhbGxMYXllcnMuaGFzKHBhZ2VOdW1iZXIgLSAxKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHJlc29sdmUsCiAgICAgIHByb21pc2UKICAgIH0gPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIGNvbnN0IG9uRWRpdG9yc1JlbmRlcmVkID0gKGV2dCkgPT4gewogICAgICBpZiAoZXZ0LnBhZ2VOdW1iZXIgPT09IHBhZ2VOdW1iZXIpIHsKICAgICAgICB0aGlzLl9ldmVudEJ1cy5fb2ZmKCJlZGl0b3JzcmVuZGVyZWQiLCBvbkVkaXRvcnNSZW5kZXJlZCk7CiAgICAgICAgcmVzb2x2ZSgpOwogICAgICB9CiAgICB9OwogICAgdGhpcy5fZXZlbnRCdXMub24oImVkaXRvcnNyZW5kZXJlZCIsIG9uRWRpdG9yc1JlbmRlcmVkKTsKICAgIGF3YWl0IHByb21pc2U7CiAgfQogIGdldFNpZ25hdHVyZShlZGl0b3IpIHsKICAgIHRoaXMuI3NpZ25hdHVyZU1hbmFnZXI/LmdldFNpZ25hdHVyZSh7CiAgICAgIHVpTWFuYWdlcjogdGhpcywKICAgICAgZWRpdG9yCiAgICB9KTsKICB9CiAgZ2V0IHNpZ25hdHVyZU1hbmFnZXIoKSB7CiAgICByZXR1cm4gdGhpcy4jc2lnbmF0dXJlTWFuYWdlcjsKICB9CiAgc3dpdGNoVG9Nb2RlKG1vZGUsIGNhbGxiYWNrKSB7CiAgICB0aGlzLl9ldmVudEJ1cy5vbigiYW5ub3RhdGlvbmVkaXRvcm1vZGVjaGFuZ2VkIiwgY2FsbGJhY2ssIHsKICAgICAgb25jZTogdHJ1ZSwKICAgICAgc2lnbmFsOiB0aGlzLl9zaWduYWwKICAgIH0pOwogICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goInNob3dhbm5vdGF0aW9uZWRpdG9ydWkiLCB7CiAgICAgIHNvdXJjZTogdGhpcywKICAgICAgbW9kZQogICAgfSk7CiAgfQogIHNldFByZWZlcmVuY2UobmFtZSwgdmFsdWUpIHsKICAgIHRoaXMuX2V2ZW50QnVzLmRpc3BhdGNoKCJzZXRwcmVmZXJlbmNlIiwgewogICAgICBzb3VyY2U6IHRoaXMsCiAgICAgIG5hbWUsCiAgICAgIHZhbHVlCiAgICB9KTsKICB9CiAgb25TZXRQcmVmZXJlbmNlKHsKICAgIG5hbWUsCiAgICB2YWx1ZQogIH0pIHsKICAgIHN3aXRjaCAobmFtZSkgewogICAgICBjYXNlICJlbmFibGVOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlIjoKICAgICAgICB0aGlzLiNlbmFibGVOZXdBbHRUZXh0V2hlbkFkZGluZ0ltYWdlID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIG9uUGFnZUNoYW5naW5nKHsKICAgIHBhZ2VOdW1iZXIKICB9KSB7CiAgICB0aGlzLiNjdXJyZW50UGFnZUluZGV4ID0gcGFnZU51bWJlciAtIDE7CiAgfQogIGZvY3VzTWFpbkNvbnRhaW5lcigpIHsKICAgIHRoaXMuI2NvbnRhaW5lci5mb2N1cygpOwogIH0KICBmaW5kUGFyZW50KHgsIHkpIHsKICAgIGZvciAoY29uc3QgbGF5ZXIgb2YgdGhpcy4jYWxsTGF5ZXJzLnZhbHVlcygpKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICB4OiBsYXllclgsCiAgICAgICAgeTogbGF5ZXJZLAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9ID0gbGF5ZXIuZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBpZiAoeCA+PSBsYXllclggJiYgeCA8PSBsYXllclggKyB3aWR0aCAmJiB5ID49IGxheWVyWSAmJiB5IDw9IGxheWVyWSArIGhlaWdodCkgewogICAgICAgIHJldHVybiBsYXllcjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGRpc2FibGVVc2VyU2VsZWN0KHZhbHVlID0gZmFsc2UpIHsKICAgIHRoaXMuI3ZpZXdlci5jbGFzc0xpc3QudG9nZ2xlKCJub1VzZXJTZWxlY3QiLCB2YWx1ZSk7CiAgfQogIGFkZFNob3VsZFJlc2NhbGUoZWRpdG9yKSB7CiAgICB0aGlzLiNlZGl0b3JzVG9SZXNjYWxlLmFkZChlZGl0b3IpOwogIH0KICByZW1vdmVTaG91bGRSZXNjYWxlKGVkaXRvcikgewogICAgdGhpcy4jZWRpdG9yc1RvUmVzY2FsZS5kZWxldGUoZWRpdG9yKTsKICB9CiAgb25TY2FsZUNoYW5naW5nKHsKICAgIHNjYWxlCiAgfSkgewogICAgdGhpcy5jb21taXRPclJlbW92ZSgpOwogICAgdGhpcy52aWV3UGFyYW1ldGVycy5yZWFsU2NhbGUgPSBzY2FsZSAqIFBpeGVsc1BlckluY2guUERGX1RPX0NTU19VTklUUzsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2VkaXRvcnNUb1Jlc2NhbGUpIHsKICAgICAgZWRpdG9yLm9uU2NhbGVDaGFuZ2luZygpOwogICAgfQogICAgdGhpcy4jY3VycmVudERyYXdpbmdTZXNzaW9uPy5vblNjYWxlQ2hhbmdpbmcoKTsKICB9CiAgb25Sb3RhdGlvbkNoYW5naW5nKHsKICAgIHBhZ2VzUm90YXRpb24KICB9KSB7CiAgICB0aGlzLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICB0aGlzLnZpZXdQYXJhbWV0ZXJzLnJvdGF0aW9uID0gcGFnZXNSb3RhdGlvbjsKICB9CiAgI2dldEFuY2hvckVsZW1lbnRGb3JTZWxlY3Rpb24oewogICAgYW5jaG9yTm9kZQogIH0pIHsKICAgIHJldHVybiBhbmNob3JOb2RlLm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSA/IGFuY2hvck5vZGUucGFyZW50RWxlbWVudCA6IGFuY2hvck5vZGU7CiAgfQogICNnZXRMYXllckZvclRleHRMYXllcih0ZXh0TGF5ZXIpIHsKICAgIGNvbnN0IHsKICAgICAgY3VycmVudExheWVyCiAgICB9ID0gdGhpczsKICAgIGlmIChjdXJyZW50TGF5ZXIuaGFzVGV4dExheWVyKHRleHRMYXllcikpIHsKICAgICAgcmV0dXJuIGN1cnJlbnRMYXllcjsKICAgIH0KICAgIGZvciAoY29uc3QgbGF5ZXIgb2YgdGhpcy4jYWxsTGF5ZXJzLnZhbHVlcygpKSB7CiAgICAgIGlmIChsYXllci5oYXNUZXh0TGF5ZXIodGV4dExheWVyKSkgewogICAgICAgIHJldHVybiBsYXllcjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGhpZ2hsaWdodFNlbGVjdGlvbihtZXRob2RPZkNyZWF0aW9uID0gIiIsIGNvbW1lbnQgPSBmYWxzZSkgewogICAgY29uc3Qgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7CiAgICBpZiAoIXNlbGVjdGlvbiB8fCBzZWxlY3Rpb24uaXNDb2xsYXBzZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBhbmNob3JOb2RlLAogICAgICBhbmNob3JPZmZzZXQsCiAgICAgIGZvY3VzTm9kZSwKICAgICAgZm9jdXNPZmZzZXQKICAgIH0gPSBzZWxlY3Rpb247CiAgICBjb25zdCB0ZXh0ID0gc2VsZWN0aW9uLnRvU3RyaW5nKCk7CiAgICBjb25zdCBhbmNob3JFbGVtZW50ID0gdGhpcy4jZ2V0QW5jaG9yRWxlbWVudEZvclNlbGVjdGlvbihzZWxlY3Rpb24pOwogICAgY29uc3QgdGV4dExheWVyID0gYW5jaG9yRWxlbWVudC5jbG9zZXN0KCIudGV4dExheWVyIik7CiAgICBjb25zdCBib3hlcyA9IHRoaXMuZ2V0U2VsZWN0aW9uQm94ZXModGV4dExheWVyKTsKICAgIGlmICghYm94ZXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2VsZWN0aW9uLmVtcHR5KCk7CiAgICBjb25zdCBsYXllciA9IHRoaXMuI2dldExheWVyRm9yVGV4dExheWVyKHRleHRMYXllcik7CiAgICBjb25zdCBpc05vbmVNb2RlID0gdGhpcy4jbW9kZSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORTsKICAgIGNvbnN0IGNhbGxiYWNrID0gKCkgPT4gewogICAgICBjb25zdCBlZGl0b3IgPSBsYXllcj8uY3JlYXRlQW5kQWRkTmV3RWRpdG9yKHsKICAgICAgICB4OiAwLAogICAgICAgIHk6IDAKICAgICAgfSwgZmFsc2UsIHsKICAgICAgICBtZXRob2RPZkNyZWF0aW9uLAogICAgICAgIGJveGVzLAogICAgICAgIGFuY2hvck5vZGUsCiAgICAgICAgYW5jaG9yT2Zmc2V0LAogICAgICAgIGZvY3VzTm9kZSwKICAgICAgICBmb2N1c09mZnNldCwKICAgICAgICB0ZXh0CiAgICAgIH0pOwogICAgICBpZiAoaXNOb25lTW9kZSkgewogICAgICAgIHRoaXMuc2hvd0FsbEVkaXRvcnMoImhpZ2hsaWdodCIsIHRydWUsIHRydWUpOwogICAgICB9CiAgICAgIGlmIChjb21tZW50KSB7CiAgICAgICAgZWRpdG9yPy5lZGl0Q29tbWVudCgpOwogICAgICB9CiAgICB9OwogICAgaWYgKGlzTm9uZU1vZGUpIHsKICAgICAgdGhpcy5zd2l0Y2hUb01vZGUoQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hULCBjYWxsYmFjayk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNhbGxiYWNrKCk7CiAgfQogIGNvbW1lbnRTZWxlY3Rpb24obWV0aG9kT2ZDcmVhdGlvbiA9ICIiKSB7CiAgICB0aGlzLmhpZ2hsaWdodFNlbGVjdGlvbihtZXRob2RPZkNyZWF0aW9uLCB0cnVlKTsKICB9CiAgI2Rpc3BsYXlGbG9hdGluZ1Rvb2xiYXIoKSB7CiAgICBjb25zdCBzZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTsKICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5pc0NvbGxhcHNlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBhbmNob3JFbGVtZW50ID0gdGhpcy4jZ2V0QW5jaG9yRWxlbWVudEZvclNlbGVjdGlvbihzZWxlY3Rpb24pOwogICAgY29uc3QgdGV4dExheWVyID0gYW5jaG9yRWxlbWVudC5jbG9zZXN0KCIudGV4dExheWVyIik7CiAgICBjb25zdCBib3hlcyA9IHRoaXMuZ2V0U2VsZWN0aW9uQm94ZXModGV4dExheWVyKTsKICAgIGlmICghYm94ZXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jZmxvYXRpbmdUb29sYmFyIHx8PSBuZXcgRmxvYXRpbmdUb29sYmFyKHRoaXMpOwogICAgdGhpcy4jZmxvYXRpbmdUb29sYmFyLnNob3codGV4dExheWVyLCBib3hlcywgdGhpcy5kaXJlY3Rpb24gPT09ICJsdHIiKTsKICB9CiAgZ2V0QW5kUmVtb3ZlRGF0YUZyb21Bbm5vdGF0aW9uU3RvcmFnZShhbm5vdGF0aW9uSWQpIHsKICAgIGlmICghdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCBrZXkgPSBgJHtBbm5vdGF0aW9uRWRpdG9yUHJlZml4fSR7YW5ub3RhdGlvbklkfWA7CiAgICBjb25zdCBzdG9yZWRWYWx1ZSA9IHRoaXMuI2Fubm90YXRpb25TdG9yYWdlLmdldFJhd1ZhbHVlKGtleSk7CiAgICBpZiAoc3RvcmVkVmFsdWUpIHsKICAgICAgdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UucmVtb3ZlKGtleSk7CiAgICB9CiAgICByZXR1cm4gc3RvcmVkVmFsdWU7CiAgfQogIGFkZFRvQW5ub3RhdGlvblN0b3JhZ2UoZWRpdG9yKSB7CiAgICBpZiAoIWVkaXRvci5pc0VtcHR5KCkgJiYgdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UgJiYgIXRoaXMuI2Fubm90YXRpb25TdG9yYWdlLmhhcyhlZGl0b3IuaWQpKSB7CiAgICAgIHRoaXMuI2Fubm90YXRpb25TdG9yYWdlLnNldFZhbHVlKGVkaXRvci5pZCwgZWRpdG9yKTsKICAgIH0KICB9CiAgYTExeUFsZXJ0KG1lc3NhZ2VJZCwgYXJncyA9IG51bGwpIHsKICAgIGNvbnN0IHZpZXdlckFsZXJ0ID0gdGhpcy4jdmlld2VyQWxlcnQ7CiAgICBpZiAoIXZpZXdlckFsZXJ0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZpZXdlckFsZXJ0LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgbWVzc2FnZUlkKTsKICAgIGlmIChhcmdzKSB7CiAgICAgIHZpZXdlckFsZXJ0LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWFyZ3MiLCBKU09OLnN0cmluZ2lmeShhcmdzKSk7CiAgICB9IGVsc2UgewogICAgICB2aWV3ZXJBbGVydC5yZW1vdmVBdHRyaWJ1dGUoImRhdGEtbDEwbi1hcmdzIik7CiAgICB9CiAgfQogICNzZWxlY3Rpb25DaGFuZ2UoKSB7CiAgICBjb25zdCBzZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTsKICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5pc0NvbGxhcHNlZCkgewogICAgICBpZiAodGhpcy4jc2VsZWN0ZWRUZXh0Tm9kZSkgewogICAgICAgIHRoaXMuI2Zsb2F0aW5nVG9vbGJhcj8uaGlkZSgpOwogICAgICAgIHRoaXMuI3NlbGVjdGVkVGV4dE5vZGUgPSBudWxsOwogICAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgICAgIGhhc1NlbGVjdGVkVGV4dDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGFuY2hvck5vZGUKICAgIH0gPSBzZWxlY3Rpb247CiAgICBpZiAoYW5jaG9yTm9kZSA9PT0gdGhpcy4jc2VsZWN0ZWRUZXh0Tm9kZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBhbmNob3JFbGVtZW50ID0gdGhpcy4jZ2V0QW5jaG9yRWxlbWVudEZvclNlbGVjdGlvbihzZWxlY3Rpb24pOwogICAgY29uc3QgdGV4dExheWVyID0gYW5jaG9yRWxlbWVudC5jbG9zZXN0KCIudGV4dExheWVyIik7CiAgICBpZiAoIXRleHRMYXllcikgewogICAgICBpZiAodGhpcy4jc2VsZWN0ZWRUZXh0Tm9kZSkgewogICAgICAgIHRoaXMuI2Zsb2F0aW5nVG9vbGJhcj8uaGlkZSgpOwogICAgICAgIHRoaXMuI3NlbGVjdGVkVGV4dE5vZGUgPSBudWxsOwogICAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgICAgIGhhc1NlbGVjdGVkVGV4dDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNmbG9hdGluZ1Rvb2xiYXI/LmhpZGUoKTsKICAgIHRoaXMuI3NlbGVjdGVkVGV4dE5vZGUgPSBhbmNob3JOb2RlOwogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICBoYXNTZWxlY3RlZFRleHQ6IHRydWUKICAgIH0pOwogICAgaWYgKHRoaXMuI21vZGUgIT09IEFubm90YXRpb25FZGl0b3JUeXBlLkhJR0hMSUdIVCAmJiB0aGlzLiNtb2RlICE9PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5OT05FKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiNtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQpIHsKICAgICAgdGhpcy5zaG93QWxsRWRpdG9ycygiaGlnaGxpZ2h0IiwgdHJ1ZSwgdHJ1ZSk7CiAgICB9CiAgICB0aGlzLiNoaWdobGlnaHRXaGVuU2hpZnRVcCA9IHRoaXMuaXNTaGlmdEtleURvd247CiAgICBpZiAoIXRoaXMuaXNTaGlmdEtleURvd24pIHsKICAgICAgY29uc3QgYWN0aXZlTGF5ZXIgPSB0aGlzLiNtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQgPyB0aGlzLiNnZXRMYXllckZvclRleHRMYXllcih0ZXh0TGF5ZXIpIDogbnVsbDsKICAgICAgYWN0aXZlTGF5ZXI/LnRvZ2dsZURyYXdpbmcoKTsKICAgICAgaWYgKHRoaXMuI2lzUG9pbnRlckRvd24pIHsKICAgICAgICBjb25zdCBhYyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgICBjb25zdCBzaWduYWwgPSB0aGlzLmNvbWJpbmVkU2lnbmFsKGFjKTsKICAgICAgICBjb25zdCBwb2ludGVydXAgPSAoZSkgPT4gewogICAgICAgICAgaWYgKGUudHlwZSA9PT0gInBvaW50ZXJ1cCIgJiYgZS5idXR0b24gIT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYWMuYWJvcnQoKTsKICAgICAgICAgIGFjdGl2ZUxheWVyPy50b2dnbGVEcmF3aW5nKHRydWUpOwogICAgICAgICAgaWYgKGUudHlwZSA9PT0gInBvaW50ZXJ1cCIpIHsKICAgICAgICAgICAgdGhpcy4jb25TZWxlY3RFbmQoIm1haW5fdG9vbGJhciIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHBvaW50ZXJ1cCwgewogICAgICAgICAgc2lnbmFsCiAgICAgICAgfSk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImJsdXIiLCBwb2ludGVydXAsIHsKICAgICAgICAgIHNpZ25hbAogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGFjdGl2ZUxheWVyPy50b2dnbGVEcmF3aW5nKHRydWUpOwogICAgICAgIHRoaXMuI29uU2VsZWN0RW5kKCJtYWluX3Rvb2xiYXIiKTsKICAgICAgfQogICAgfQogIH0KICAjb25TZWxlY3RFbmQobWV0aG9kT2ZDcmVhdGlvbiA9ICIiKSB7CiAgICBpZiAodGhpcy4jbW9kZSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hUKSB7CiAgICAgIHRoaXMuaGlnaGxpZ2h0U2VsZWN0aW9uKG1ldGhvZE9mQ3JlYXRpb24pOwogICAgfSBlbHNlIGlmICh0aGlzLiNlbmFibGVIaWdobGlnaHRGbG9hdGluZ0J1dHRvbikgewogICAgICB0aGlzLiNkaXNwbGF5RmxvYXRpbmdUb29sYmFyKCk7CiAgICB9CiAgfQogICNhZGRTZWxlY3Rpb25MaXN0ZW5lcigpIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInNlbGVjdGlvbmNoYW5nZSIsIHRoaXMuI3NlbGVjdGlvbkNoYW5nZS5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbDogdGhpcy5fc2lnbmFsCiAgICB9KTsKICB9CiAgI2FkZEZvY3VzTWFuYWdlcigpIHsKICAgIGlmICh0aGlzLiNmb2N1c01hbmFnZXJBQykgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNmb2N1c01hbmFnZXJBQyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuY29tYmluZWRTaWduYWwodGhpcy4jZm9jdXNNYW5hZ2VyQUMpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImZvY3VzIiwgdGhpcy5mb2N1cy5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIHRoaXMuYmx1ci5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgfQogICNyZW1vdmVGb2N1c01hbmFnZXIoKSB7CiAgICB0aGlzLiNmb2N1c01hbmFnZXJBQz8uYWJvcnQoKTsKICAgIHRoaXMuI2ZvY3VzTWFuYWdlckFDID0gbnVsbDsKICB9CiAgYmx1cigpIHsKICAgIHRoaXMuaXNTaGlmdEtleURvd24gPSBmYWxzZTsKICAgIGlmICh0aGlzLiNoaWdobGlnaHRXaGVuU2hpZnRVcCkgewogICAgICB0aGlzLiNoaWdobGlnaHRXaGVuU2hpZnRVcCA9IGZhbHNlOwogICAgICB0aGlzLiNvblNlbGVjdEVuZCgibWFpbl90b29sYmFyIik7CiAgICB9CiAgICBpZiAoIXRoaXMuaGFzU2VsZWN0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgYWN0aXZlRWxlbWVudAogICAgfSA9IGRvY3VtZW50OwogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzKSB7CiAgICAgIGlmIChlZGl0b3IuZGl2LmNvbnRhaW5zKGFjdGl2ZUVsZW1lbnQpKSB7CiAgICAgICAgdGhpcy4jbGFzdEFjdGl2ZUVsZW1lbnQgPSBbZWRpdG9yLCBhY3RpdmVFbGVtZW50XTsKICAgICAgICBlZGl0b3IuX2ZvY3VzRXZlbnRzQWxsb3dlZCA9IGZhbHNlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQogIGZvY3VzKCkgewogICAgaWYgKCF0aGlzLiNsYXN0QWN0aXZlRWxlbWVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBbbGFzdEVkaXRvciwgbGFzdEFjdGl2ZUVsZW1lbnRdID0gdGhpcy4jbGFzdEFjdGl2ZUVsZW1lbnQ7CiAgICB0aGlzLiNsYXN0QWN0aXZlRWxlbWVudCA9IG51bGw7CiAgICBsYXN0QWN0aXZlRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJmb2N1c2luIiwgKCkgPT4gewogICAgICBsYXN0RWRpdG9yLl9mb2N1c0V2ZW50c0FsbG93ZWQgPSB0cnVlOwogICAgfSwgewogICAgICBvbmNlOiB0cnVlLAogICAgICBzaWduYWw6IHRoaXMuX3NpZ25hbAogICAgfSk7CiAgICBsYXN0QWN0aXZlRWxlbWVudC5mb2N1cygpOwogIH0KICAjYWRkS2V5Ym9hcmRNYW5hZ2VyKCkgewogICAgaWYgKHRoaXMuI2tleWJvYXJkTWFuYWdlckFDKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2tleWJvYXJkTWFuYWdlckFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5jb21iaW5lZFNpZ25hbCh0aGlzLiNrZXlib2FyZE1hbmFnZXJBQyk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMua2V5ZG93bi5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigia2V5dXAiLCB0aGlzLmtleXVwLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICB9CiAgI3JlbW92ZUtleWJvYXJkTWFuYWdlcigpIHsKICAgIHRoaXMuI2tleWJvYXJkTWFuYWdlckFDPy5hYm9ydCgpOwogICAgdGhpcy4ja2V5Ym9hcmRNYW5hZ2VyQUMgPSBudWxsOwogIH0KICAjYWRkQ29weVBhc3RlTGlzdGVuZXJzKCkgewogICAgaWYgKHRoaXMuI2NvcHlQYXN0ZUFDKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvcHlQYXN0ZUFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5jb21iaW5lZFNpZ25hbCh0aGlzLiNjb3B5UGFzdGVBQyk7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJjb3B5IiwgdGhpcy5jb3B5LmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImN1dCIsIHRoaXMuY3V0LmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInBhc3RlIiwgdGhpcy5wYXN0ZS5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgfQogICNyZW1vdmVDb3B5UGFzdGVMaXN0ZW5lcnMoKSB7CiAgICB0aGlzLiNjb3B5UGFzdGVBQz8uYWJvcnQoKTsKICAgIHRoaXMuI2NvcHlQYXN0ZUFDID0gbnVsbDsKICB9CiAgI2FkZERyYWdBbmREcm9wTGlzdGVuZXJzKCkgewogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5fc2lnbmFsOwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZHJhZ292ZXIiLCB0aGlzLmRyYWdPdmVyLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImRyb3AiLCB0aGlzLmRyb3AuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogIH0KICBhZGRFZGl0TGlzdGVuZXJzKCkgewogICAgdGhpcy4jYWRkS2V5Ym9hcmRNYW5hZ2VyKCk7CiAgICB0aGlzLnNldEVkaXRpbmdTdGF0ZSh0cnVlKTsKICB9CiAgcmVtb3ZlRWRpdExpc3RlbmVycygpIHsKICAgIHRoaXMuI3JlbW92ZUtleWJvYXJkTWFuYWdlcigpOwogICAgdGhpcy5zZXRFZGl0aW5nU3RhdGUoZmFsc2UpOwogIH0KICBkcmFnT3ZlcihldmVudCkgewogICAgZm9yIChjb25zdCB7CiAgICAgIHR5cGUKICAgIH0gb2YgZXZlbnQuZGF0YVRyYW5zZmVyLml0ZW1zKSB7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yVHlwZSBvZiB0aGlzLiNlZGl0b3JUeXBlcykgewogICAgICAgIGlmIChlZGl0b3JUeXBlLmlzSGFuZGxpbmdNaW1lRm9yUGFzdGluZyh0eXBlKSkgewogICAgICAgICAgZXZlbnQuZGF0YVRyYW5zZmVyLmRyb3BFZmZlY3QgPSAiY29weSI7CiAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBkcm9wKGV2ZW50KSB7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZXZlbnQuZGF0YVRyYW5zZmVyLml0ZW1zKSB7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yVHlwZSBvZiB0aGlzLiNlZGl0b3JUeXBlcykgewogICAgICAgIGlmIChlZGl0b3JUeXBlLmlzSGFuZGxpbmdNaW1lRm9yUGFzdGluZyhpdGVtLnR5cGUpKSB7CiAgICAgICAgICBlZGl0b3JUeXBlLnBhc3RlKGl0ZW0sIHRoaXMuY3VycmVudExheWVyKTsKICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGNvcHkoZXZlbnQpIHsKICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICB0aGlzLiNhY3RpdmVFZGl0b3I/LmNvbW1pdE9yUmVtb3ZlKCk7CiAgICBpZiAoIXRoaXMuaGFzU2VsZWN0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGVkaXRvcnMgPSBbXTsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI3NlbGVjdGVkRWRpdG9ycykgewogICAgICBjb25zdCBzZXJpYWxpemVkID0gZWRpdG9yLnNlcmlhbGl6ZSh0cnVlKTsKICAgICAgaWYgKHNlcmlhbGl6ZWQpIHsKICAgICAgICBlZGl0b3JzLnB1c2goc2VyaWFsaXplZCk7CiAgICAgIH0KICAgIH0KICAgIGlmIChlZGl0b3JzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBldmVudC5jbGlwYm9hcmREYXRhLnNldERhdGEoImFwcGxpY2F0aW9uL3BkZmpzIiwgSlNPTi5zdHJpbmdpZnkoZWRpdG9ycykpOwogIH0KICBjdXQoZXZlbnQpIHsKICAgIHRoaXMuY29weShldmVudCk7CiAgICB0aGlzLmRlbGV0ZSgpOwogIH0KICBhc3luYyBwYXN0ZShldmVudCkgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IHsKICAgICAgY2xpcGJvYXJkRGF0YQogICAgfSA9IGV2ZW50OwogICAgZm9yIChjb25zdCBpdGVtIG9mIGNsaXBib2FyZERhdGEuaXRlbXMpIHsKICAgICAgZm9yIChjb25zdCBlZGl0b3JUeXBlIG9mIHRoaXMuI2VkaXRvclR5cGVzKSB7CiAgICAgICAgaWYgKGVkaXRvclR5cGUuaXNIYW5kbGluZ01pbWVGb3JQYXN0aW5nKGl0ZW0udHlwZSkpIHsKICAgICAgICAgIGVkaXRvclR5cGUucGFzdGUoaXRlbSwgdGhpcy5jdXJyZW50TGF5ZXIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgbGV0IGRhdGEgPSBjbGlwYm9hcmREYXRhLmdldERhdGEoImFwcGxpY2F0aW9uL3BkZmpzIik7CiAgICBpZiAoIWRhdGEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdHJ5IHsKICAgICAgZGF0YSA9IEpTT04ucGFyc2UoZGF0YSk7CiAgICB9IGNhdGNoIChleCkgewogICAgICB3YXJuKGBwYXN0ZTogIiR7ZXgubWVzc2FnZX0iLmApOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy51bnNlbGVjdEFsbCgpOwogICAgY29uc3QgbGF5ZXIgPSB0aGlzLmN1cnJlbnRMYXllcjsKICAgIHRyeSB7CiAgICAgIGNvbnN0IG5ld0VkaXRvcnMgPSBbXTsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgZGF0YSkgewogICAgICAgIGNvbnN0IGRlc2VyaWFsaXplZEVkaXRvciA9IGF3YWl0IGxheWVyLmRlc2VyaWFsaXplKGVkaXRvcik7CiAgICAgICAgaWYgKCFkZXNlcmlhbGl6ZWRFZGl0b3IpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbmV3RWRpdG9ycy5wdXNoKGRlc2VyaWFsaXplZEVkaXRvcik7CiAgICAgIH0KICAgICAgY29uc3QgY21kID0gKCkgPT4gewogICAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIG5ld0VkaXRvcnMpIHsKICAgICAgICAgIHRoaXMuI2FkZEVkaXRvclRvTGF5ZXIoZWRpdG9yKTsKICAgICAgICB9CiAgICAgICAgdGhpcy4jc2VsZWN0RWRpdG9ycyhuZXdFZGl0b3JzKTsKICAgICAgfTsKICAgICAgY29uc3QgdW5kbyA9ICgpID0+IHsKICAgICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBuZXdFZGl0b3JzKSB7CiAgICAgICAgICBlZGl0b3IucmVtb3ZlKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICB0aGlzLmFkZENvbW1hbmRzKHsKICAgICAgICBjbWQsCiAgICAgICAgdW5kbywKICAgICAgICBtdXN0RXhlYzogdHJ1ZQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgIHdhcm4oYHBhc3RlOiAiJHtleC5tZXNzYWdlfSIuYCk7CiAgICB9CiAgfQogIGtleWRvd24oZXZlbnQpIHsKICAgIGlmICghdGhpcy5pc1NoaWZ0S2V5RG93biAmJiBldmVudC5rZXkgPT09ICJTaGlmdCIpIHsKICAgICAgdGhpcy5pc1NoaWZ0S2V5RG93biA9IHRydWU7CiAgICB9CiAgICBpZiAodGhpcy4jbW9kZSAhPT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORSAmJiAhdGhpcy5pc0VkaXRvckhhbmRsaW5nS2V5Ym9hcmQpIHsKICAgICAgX0Fubm90YXRpb25FZGl0b3JVSU1hbmFnZXIuX2tleWJvYXJkTWFuYWdlci5leGVjKHRoaXMsIGV2ZW50KTsKICAgIH0KICB9CiAga2V5dXAoZXZlbnQpIHsKICAgIGlmICh0aGlzLmlzU2hpZnRLZXlEb3duICYmIGV2ZW50LmtleSA9PT0gIlNoaWZ0IikgewogICAgICB0aGlzLmlzU2hpZnRLZXlEb3duID0gZmFsc2U7CiAgICAgIGlmICh0aGlzLiNoaWdobGlnaHRXaGVuU2hpZnRVcCkgewogICAgICAgIHRoaXMuI2hpZ2hsaWdodFdoZW5TaGlmdFVwID0gZmFsc2U7CiAgICAgICAgdGhpcy4jb25TZWxlY3RFbmQoIm1haW5fdG9vbGJhciIpOwogICAgICB9CiAgICB9CiAgfQogIG9uRWRpdGluZ0FjdGlvbih7CiAgICBuYW1lCiAgfSkgewogICAgc3dpdGNoIChuYW1lKSB7CiAgICAgIGNhc2UgInVuZG8iOgogICAgICBjYXNlICJyZWRvIjoKICAgICAgY2FzZSAiZGVsZXRlIjoKICAgICAgY2FzZSAic2VsZWN0QWxsIjoKICAgICAgICB0aGlzW25hbWVdKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImhpZ2hsaWdodFNlbGVjdGlvbiI6CiAgICAgICAgdGhpcy5oaWdobGlnaHRTZWxlY3Rpb24oImNvbnRleHRfbWVudSIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJjb21tZW50U2VsZWN0aW9uIjoKICAgICAgICB0aGlzLmNvbW1lbnRTZWxlY3Rpb24oImNvbnRleHRfbWVudSIpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICAjZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoZGV0YWlscykgewogICAgY29uc3QgaGFzQ2hhbmdlZCA9IE9iamVjdC5lbnRyaWVzKGRldGFpbHMpLnNvbWUoKFtrZXksIHZhbHVlXSkgPT4gdGhpcy4jcHJldmlvdXNTdGF0ZXNba2V5XSAhPT0gdmFsdWUpOwogICAgaWYgKGhhc0NoYW5nZWQpIHsKICAgICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goImFubm90YXRpb25lZGl0b3JzdGF0ZXNjaGFuZ2VkIiwgewogICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICBkZXRhaWxzOiBPYmplY3QuYXNzaWduKHRoaXMuI3ByZXZpb3VzU3RhdGVzLCBkZXRhaWxzKQogICAgICB9KTsKICAgICAgaWYgKHRoaXMuI21vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLkhJR0hMSUdIVCAmJiBkZXRhaWxzLmhhc1NlbGVjdGVkRWRpdG9yID09PSBmYWxzZSkgewogICAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlVUkoW1tBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfRlJFRSwgdHJ1ZV1dKTsKICAgICAgfQogICAgfQogIH0KICAjZGlzcGF0Y2hVcGRhdGVVSShkZXRhaWxzKSB7CiAgICB0aGlzLl9ldmVudEJ1cy5kaXNwYXRjaCgiYW5ub3RhdGlvbmVkaXRvcnBhcmFtc2NoYW5nZWQiLCB7CiAgICAgIHNvdXJjZTogdGhpcywKICAgICAgZGV0YWlscwogICAgfSk7CiAgfQogIHNldEVkaXRpbmdTdGF0ZShpc0VkaXRpbmcpIHsKICAgIGlmIChpc0VkaXRpbmcpIHsKICAgICAgdGhpcy4jYWRkRm9jdXNNYW5hZ2VyKCk7CiAgICAgIHRoaXMuI2FkZENvcHlQYXN0ZUxpc3RlbmVycygpOwogICAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgICAgaXNFZGl0aW5nOiB0aGlzLiNtb2RlICE9PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5OT05FLAogICAgICAgIGlzRW1wdHk6IHRoaXMuI2lzRW1wdHkoKSwKICAgICAgICBoYXNTb21ldGhpbmdUb1VuZG86IHRoaXMuI2NvbW1hbmRNYW5hZ2VyLmhhc1NvbWV0aGluZ1RvVW5kbygpLAogICAgICAgIGhhc1NvbWV0aGluZ1RvUmVkbzogdGhpcy4jY29tbWFuZE1hbmFnZXIuaGFzU29tZXRoaW5nVG9SZWRvKCksCiAgICAgICAgaGFzU2VsZWN0ZWRFZGl0b3I6IGZhbHNlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jcmVtb3ZlRm9jdXNNYW5hZ2VyKCk7CiAgICAgIHRoaXMuI3JlbW92ZUNvcHlQYXN0ZUxpc3RlbmVycygpOwogICAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgICAgaXNFZGl0aW5nOiBmYWxzZQogICAgICB9KTsKICAgICAgdGhpcy5kaXNhYmxlVXNlclNlbGVjdChmYWxzZSk7CiAgICB9CiAgfQogIHJlZ2lzdGVyRWRpdG9yVHlwZXModHlwZXMpIHsKICAgIGlmICh0aGlzLiNlZGl0b3JUeXBlcykgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNlZGl0b3JUeXBlcyA9IHR5cGVzOwogICAgZm9yIChjb25zdCBlZGl0b3JUeXBlIG9mIHRoaXMuI2VkaXRvclR5cGVzKSB7CiAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlVUkoZWRpdG9yVHlwZS5kZWZhdWx0UHJvcGVydGllc1RvVXBkYXRlKTsKICAgIH0KICB9CiAgZ2V0SWQoKSB7CiAgICByZXR1cm4gdGhpcy4jaWRNYW5hZ2VyLmlkOwogIH0KICBnZXQgY3VycmVudExheWVyKCkgewogICAgcmV0dXJuIHRoaXMuI2FsbExheWVycy5nZXQodGhpcy4jY3VycmVudFBhZ2VJbmRleCk7CiAgfQogIGdldExheWVyKHBhZ2VJbmRleCkgewogICAgcmV0dXJuIHRoaXMuI2FsbExheWVycy5nZXQocGFnZUluZGV4KTsKICB9CiAgZ2V0IGN1cnJlbnRQYWdlSW5kZXgoKSB7CiAgICByZXR1cm4gdGhpcy4jY3VycmVudFBhZ2VJbmRleDsKICB9CiAgYWRkTGF5ZXIobGF5ZXIpIHsKICAgIHRoaXMuI2FsbExheWVycy5zZXQobGF5ZXIucGFnZUluZGV4LCBsYXllcik7CiAgICBpZiAodGhpcy4jaXNFbmFibGVkKSB7CiAgICAgIGxheWVyLmVuYWJsZSgpOwogICAgfSBlbHNlIHsKICAgICAgbGF5ZXIuZGlzYWJsZSgpOwogICAgfQogIH0KICByZW1vdmVMYXllcihsYXllcikgewogICAgdGhpcy4jYWxsTGF5ZXJzLmRlbGV0ZShsYXllci5wYWdlSW5kZXgpOwogIH0KICBhc3luYyB1cGRhdGVNb2RlKG1vZGUsIGVkaXRJZCA9IG51bGwsIGlzRnJvbVVzZXIgPSBmYWxzZSwgaXNGcm9tS2V5Ym9hcmQgPSBmYWxzZSwgbXVzdEVudGVySW5FZGl0TW9kZSA9IGZhbHNlLCBlZGl0Q29tbWVudCA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy4jbW9kZSA9PT0gbW9kZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHkpIHsKICAgICAgYXdhaXQgdGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHkucHJvbWlzZTsKICAgICAgaWYgKCF0aGlzLiN1cGRhdGVNb2RlQ2FwYWJpbGl0eSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgdGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIHRoaXMuI2N1cnJlbnREcmF3aW5nU2Vzc2lvbj8uY29tbWl0T3JSZW1vdmUoKTsKICAgIGlmICh0aGlzLiNtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5QT1BVUCkgewogICAgICB0aGlzLiNjb21tZW50TWFuYWdlcj8uaGlkZVNpZGViYXIoKTsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy5kZXN0cm95UG9wdXAoKTsKICAgIHRoaXMuI21vZGUgPSBtb2RlOwogICAgaWYgKG1vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkUpIHsKICAgICAgdGhpcy5zZXRFZGl0aW5nU3RhdGUoZmFsc2UpOwogICAgICB0aGlzLiNkaXNhYmxlQWxsKCk7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2FsbEVkaXRvcnMudmFsdWVzKCkpIHsKICAgICAgICBlZGl0b3IuaGlkZVN0YW5kYWxvbmVDb21tZW50QnV0dG9uKCk7CiAgICAgIH0KICAgICAgdGhpcy5fZWRpdG9yVW5kb0Jhcj8uaGlkZSgpOwogICAgICB0aGlzLnRvZ2dsZUNvbW1lbnQobnVsbCk7CiAgICAgIHRoaXMuI3VwZGF0ZU1vZGVDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9ycy52YWx1ZXMoKSkgewogICAgICBlZGl0b3IuYWRkU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKTsKICAgIH0KICAgIGlmIChtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5TSUdOQVRVUkUpIHsKICAgICAgYXdhaXQgdGhpcy4jc2lnbmF0dXJlTWFuYWdlcj8ubG9hZFNpZ25hdHVyZXMoKTsKICAgIH0KICAgIGlmIChpc0Zyb21Vc2VyKSB7CiAgICAgIEN1cnJlbnRQb2ludGVycy5jbGVhclBvaW50ZXJUeXBlKCk7CiAgICB9CiAgICB0aGlzLnNldEVkaXRpbmdTdGF0ZSh0cnVlKTsKICAgIGF3YWl0IHRoaXMuI2VuYWJsZUFsbCgpOwogICAgdGhpcy51bnNlbGVjdEFsbCgpOwogICAgZm9yIChjb25zdCBsYXllciBvZiB0aGlzLiNhbGxMYXllcnMudmFsdWVzKCkpIHsKICAgICAgbGF5ZXIudXBkYXRlTW9kZShtb2RlKTsKICAgIH0KICAgIGlmIChtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5QT1BVUCkgewogICAgICB0aGlzLiNhbGxFZGl0YWJsZUFubm90YXRpb25zIHx8PSBhd2FpdCB0aGlzLiNwZGZEb2N1bWVudC5nZXRBbm5vdGF0aW9uc0J5VHlwZShuZXcgU2V0KHRoaXMuI2VkaXRvclR5cGVzLm1hcCgoZWRpdG9yQ2xhc3MpID0+IGVkaXRvckNsYXNzLl9lZGl0b3JUeXBlKSkpOwogICAgICBjb25zdCBlbGVtZW50SWRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgY29uc3QgYWxsQ29tbWVudHMgPSBbXTsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9ycy52YWx1ZXMoKSkgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGFubm90YXRpb25FbGVtZW50SWQsCiAgICAgICAgICBoYXNDb21tZW50LAogICAgICAgICAgZGVsZXRlZAogICAgICAgIH0gPSBlZGl0b3I7CiAgICAgICAgaWYgKGFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgICAgIGVsZW1lbnRJZHMuYWRkKGFubm90YXRpb25FbGVtZW50SWQpOwogICAgICAgIH0KICAgICAgICBpZiAoaGFzQ29tbWVudCAmJiAhZGVsZXRlZCkgewogICAgICAgICAgYWxsQ29tbWVudHMucHVzaChlZGl0b3IuZ2V0RGF0YSgpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBhbm5vdGF0aW9uIG9mIHRoaXMuI2FsbEVkaXRhYmxlQW5ub3RhdGlvbnMpIHsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBpZCwKICAgICAgICAgIHBvcHVwUmVmLAogICAgICAgICAgY29udGVudHNPYmoKICAgICAgICB9ID0gYW5ub3RhdGlvbjsKICAgICAgICBpZiAocG9wdXBSZWYgJiYgY29udGVudHNPYmo/LnN0ciAmJiAhZWxlbWVudElkcy5oYXMoaWQpICYmICF0aGlzLiNkZWxldGVkQW5ub3RhdGlvbnNFbGVtZW50SWRzLmhhcyhpZCkpIHsKICAgICAgICAgIGFsbENvbW1lbnRzLnB1c2goYW5ub3RhdGlvbik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyPy5zaG93U2lkZWJhcihhbGxDb21tZW50cyk7CiAgICB9CiAgICBpZiAoIWVkaXRJZCkgewogICAgICBpZiAoaXNGcm9tS2V5Ym9hcmQpIHsKICAgICAgICB0aGlzLmFkZE5ld0VkaXRvckZyb21LZXlib2FyZCgpOwogICAgICB9CiAgICAgIHRoaXMuI3VwZGF0ZU1vZGVDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9ycy52YWx1ZXMoKSkgewogICAgICBpZiAoZWRpdG9yLnVpZCA9PT0gZWRpdElkKSB7CiAgICAgICAgdGhpcy5zZXRTZWxlY3RlZChlZGl0b3IpOwogICAgICAgIGlmIChlZGl0Q29tbWVudCkgewogICAgICAgICAgZWRpdG9yLmVkaXRDb21tZW50KCk7CiAgICAgICAgfSBlbHNlIGlmIChtdXN0RW50ZXJJbkVkaXRNb2RlKSB7CiAgICAgICAgICBlZGl0b3IuZW50ZXJJbkVkaXRNb2RlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVkaXRvci5mb2N1cygpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBlZGl0b3IudW5zZWxlY3QoKTsKICAgICAgfQogICAgfQogICAgdGhpcy4jdXBkYXRlTW9kZUNhcGFiaWxpdHkucmVzb2x2ZSgpOwogIH0KICBhZGROZXdFZGl0b3JGcm9tS2V5Ym9hcmQoKSB7CiAgICBpZiAodGhpcy5jdXJyZW50TGF5ZXIuY2FuQ3JlYXRlTmV3RW1wdHlFZGl0b3IoKSkgewogICAgICB0aGlzLmN1cnJlbnRMYXllci5hZGROZXdFZGl0b3IoKTsKICAgIH0KICB9CiAgdXBkYXRlVG9vbGJhcihvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucy5tb2RlID09PSB0aGlzLiNtb2RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2V2ZW50QnVzLmRpc3BhdGNoKCJzd2l0Y2hhbm5vdGF0aW9uZWRpdG9ybW9kZSIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICAuLi5vcHRpb25zCiAgICB9KTsKICB9CiAgdXBkYXRlUGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgICBpZiAoIXRoaXMuI2VkaXRvclR5cGVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN3aXRjaCAodHlwZSkgewogICAgICBjYXNlIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkNSRUFURToKICAgICAgICB0aGlzLmN1cnJlbnRMYXllci5hZGROZXdFZGl0b3IodmFsdWUpOwogICAgICAgIHJldHVybjsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfU0hPV19BTEw6CiAgICAgICAgdGhpcy5fZXZlbnRCdXMuZGlzcGF0Y2goInJlcG9ydHRlbGVtZXRyeSIsIHsKICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgIGRldGFpbHM6IHsKICAgICAgICAgICAgdHlwZTogImVkaXRpbmciLAogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgdHlwZTogImhpZ2hsaWdodCIsCiAgICAgICAgICAgICAgYWN0aW9uOiAidG9nZ2xlX3Zpc2liaWxpdHkiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAodGhpcy4jc2hvd0FsbFN0YXRlcyB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSkuc2V0KHR5cGUsIHZhbHVlKTsKICAgICAgICB0aGlzLnNob3dBbGxFZGl0b3JzKCJoaWdobGlnaHQiLCB2YWx1ZSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBpZiAodGhpcy5oYXNTZWxlY3Rpb24pIHsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzKSB7CiAgICAgICAgZWRpdG9yLnVwZGF0ZVBhcmFtcyh0eXBlLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yVHlwZSBvZiB0aGlzLiNlZGl0b3JUeXBlcykgewogICAgICAgIGVkaXRvclR5cGUudXBkYXRlRGVmYXVsdFBhcmFtcyh0eXBlLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0KICB9CiAgc2hvd0FsbEVkaXRvcnModHlwZSwgdmlzaWJsZSwgdXBkYXRlQnV0dG9uID0gZmFsc2UpIHsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2FsbEVkaXRvcnMudmFsdWVzKCkpIHsKICAgICAgaWYgKGVkaXRvci5lZGl0b3JUeXBlID09PSB0eXBlKSB7CiAgICAgICAgZWRpdG9yLnNob3codmlzaWJsZSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHN0YXRlID0gdGhpcy4jc2hvd0FsbFN0YXRlcz8uZ2V0KEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9TSE9XX0FMTCkgPz8gdHJ1ZTsKICAgIGlmIChzdGF0ZSAhPT0gdmlzaWJsZSkgewogICAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVVJKFtbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX1NIT1dfQUxMLCB2aXNpYmxlXV0pOwogICAgfQogIH0KICBlbmFibGVXYWl0aW5nKG11c3RXYWl0ID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLiNpc1dhaXRpbmcgPT09IG11c3RXYWl0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2lzV2FpdGluZyA9IG11c3RXYWl0OwogICAgZm9yIChjb25zdCBsYXllciBvZiB0aGlzLiNhbGxMYXllcnMudmFsdWVzKCkpIHsKICAgICAgaWYgKG11c3RXYWl0KSB7CiAgICAgICAgbGF5ZXIuZGlzYWJsZUNsaWNrKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGF5ZXIuZW5hYmxlQ2xpY2soKTsKICAgICAgfQogICAgICBsYXllci5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgid2FpdGluZyIsIG11c3RXYWl0KTsKICAgIH0KICB9CiAgYXN5bmMgI2VuYWJsZUFsbCgpIHsKICAgIGlmICghdGhpcy4jaXNFbmFibGVkKSB7CiAgICAgIHRoaXMuI2lzRW5hYmxlZCA9IHRydWU7CiAgICAgIGNvbnN0IHByb21pc2VzID0gW107CiAgICAgIGZvciAoY29uc3QgbGF5ZXIgb2YgdGhpcy4jYWxsTGF5ZXJzLnZhbHVlcygpKSB7CiAgICAgICAgcHJvbWlzZXMucHVzaChsYXllci5lbmFibGUoKSk7CiAgICAgIH0KICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpOwogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgICAgZWRpdG9yLmVuYWJsZSgpOwogICAgICB9CiAgICB9CiAgfQogICNkaXNhYmxlQWxsKCkgewogICAgdGhpcy51bnNlbGVjdEFsbCgpOwogICAgaWYgKHRoaXMuI2lzRW5hYmxlZCkgewogICAgICB0aGlzLiNpc0VuYWJsZWQgPSBmYWxzZTsKICAgICAgZm9yIChjb25zdCBsYXllciBvZiB0aGlzLiNhbGxMYXllcnMudmFsdWVzKCkpIHsKICAgICAgICBsYXllci5kaXNhYmxlKCk7CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9ycy52YWx1ZXMoKSkgewogICAgICAgIGVkaXRvci5kaXNhYmxlKCk7CiAgICAgIH0KICAgIH0KICB9CiAgKmdldEVkaXRvcnMocGFnZUluZGV4KSB7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgIGlmIChlZGl0b3IucGFnZUluZGV4ID09PSBwYWdlSW5kZXgpIHsKICAgICAgICB5aWVsZCBlZGl0b3I7CiAgICAgIH0KICAgIH0KICB9CiAgZ2V0RWRpdG9yKGlkKSB7CiAgICByZXR1cm4gdGhpcy4jYWxsRWRpdG9ycy5nZXQoaWQpOwogIH0KICBhZGRFZGl0b3IoZWRpdG9yKSB7CiAgICB0aGlzLiNhbGxFZGl0b3JzLnNldChlZGl0b3IuaWQsIGVkaXRvcik7CiAgfQogIHJlbW92ZUVkaXRvcihlZGl0b3IpIHsKICAgIGlmIChlZGl0b3IuZGl2LmNvbnRhaW5zKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpKSB7CiAgICAgIGlmICh0aGlzLiNmb2N1c01haW5Db250YWluZXJUaW1lb3V0SWQpIHsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy4jZm9jdXNNYWluQ29udGFpbmVyVGltZW91dElkKTsKICAgICAgfQogICAgICB0aGlzLiNmb2N1c01haW5Db250YWluZXJUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLmZvY3VzTWFpbkNvbnRhaW5lcigpOwogICAgICAgIHRoaXMuI2ZvY3VzTWFpbkNvbnRhaW5lclRpbWVvdXRJZCA9IG51bGw7CiAgICAgIH0sIDApOwogICAgfQogICAgdGhpcy4jYWxsRWRpdG9ycy5kZWxldGUoZWRpdG9yLmlkKTsKICAgIGlmIChlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICB0aGlzLiNtaXNzaW5nQ2FudmFzZXM/LmRlbGV0ZShlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgICB9CiAgICB0aGlzLnVuc2VsZWN0KGVkaXRvcik7CiAgICBpZiAoIWVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkIHx8ICF0aGlzLiNkZWxldGVkQW5ub3RhdGlvbnNFbGVtZW50SWRzLmhhcyhlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCkpIHsKICAgICAgdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2U/LnJlbW92ZShlZGl0b3IuaWQpOwogICAgfQogIH0KICBhZGREZWxldGVkQW5ub3RhdGlvbkVsZW1lbnQoZWRpdG9yKSB7CiAgICB0aGlzLiNkZWxldGVkQW5ub3RhdGlvbnNFbGVtZW50SWRzLmFkZChlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgICB0aGlzLmFkZENoYW5nZWRFeGlzdGluZ0Fubm90YXRpb24oZWRpdG9yKTsKICAgIGVkaXRvci5kZWxldGVkID0gdHJ1ZTsKICB9CiAgaXNEZWxldGVkQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgcmV0dXJuIHRoaXMuI2RlbGV0ZWRBbm5vdGF0aW9uc0VsZW1lbnRJZHMuaGFzKGFubm90YXRpb25FbGVtZW50SWQpOwogIH0KICByZW1vdmVEZWxldGVkQW5ub3RhdGlvbkVsZW1lbnQoZWRpdG9yKSB7CiAgICB0aGlzLiNkZWxldGVkQW5ub3RhdGlvbnNFbGVtZW50SWRzLmRlbGV0ZShlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgICB0aGlzLnJlbW92ZUNoYW5nZWRFeGlzdGluZ0Fubm90YXRpb24oZWRpdG9yKTsKICAgIGVkaXRvci5kZWxldGVkID0gZmFsc2U7CiAgfQogICNhZGRFZGl0b3JUb0xheWVyKGVkaXRvcikgewogICAgY29uc3QgbGF5ZXIgPSB0aGlzLiNhbGxMYXllcnMuZ2V0KGVkaXRvci5wYWdlSW5kZXgpOwogICAgaWYgKGxheWVyKSB7CiAgICAgIGxheWVyLmFkZE9yUmVidWlsZChlZGl0b3IpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5hZGRFZGl0b3IoZWRpdG9yKTsKICAgICAgdGhpcy5hZGRUb0Fubm90YXRpb25TdG9yYWdlKGVkaXRvcik7CiAgICB9CiAgfQogIHNldEFjdGl2ZUVkaXRvcihlZGl0b3IpIHsKICAgIGlmICh0aGlzLiNhY3RpdmVFZGl0b3IgPT09IGVkaXRvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNhY3RpdmVFZGl0b3IgPSBlZGl0b3I7CiAgICBpZiAoZWRpdG9yKSB7CiAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlVUkoZWRpdG9yLnByb3BlcnRpZXNUb1VwZGF0ZSk7CiAgICB9CiAgfQogIGdldCAjbGFzdFNlbGVjdGVkRWRpdG9yKCkgewogICAgbGV0IGVkID0gbnVsbDsKICAgIGZvciAoZWQgb2YgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzKSB7CiAgICB9CiAgICByZXR1cm4gZWQ7CiAgfQogIHVwZGF0ZVVJKGVkaXRvcikgewogICAgaWYgKHRoaXMuI2xhc3RTZWxlY3RlZEVkaXRvciA9PT0gZWRpdG9yKSB7CiAgICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlVUkoZWRpdG9yLnByb3BlcnRpZXNUb1VwZGF0ZSk7CiAgICB9CiAgfQogIHVwZGF0ZVVJRm9yRGVmYXVsdFByb3BlcnRpZXMoZWRpdG9yVHlwZSkgewogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVVSShlZGl0b3JUeXBlLmRlZmF1bHRQcm9wZXJ0aWVzVG9VcGRhdGUpOwogIH0KICB0b2dnbGVTZWxlY3RlZChlZGl0b3IpIHsKICAgIGlmICh0aGlzLiNzZWxlY3RlZEVkaXRvcnMuaGFzKGVkaXRvcikpIHsKICAgICAgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzLmRlbGV0ZShlZGl0b3IpOwogICAgICBlZGl0b3IudW5zZWxlY3QoKTsKICAgICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICAgIGhhc1NlbGVjdGVkRWRpdG9yOiB0aGlzLmhhc1NlbGVjdGlvbgogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzLmFkZChlZGl0b3IpOwogICAgZWRpdG9yLnNlbGVjdCgpOwogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVVSShlZGl0b3IucHJvcGVydGllc1RvVXBkYXRlKTsKICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgaGFzU2VsZWN0ZWRFZGl0b3I6IHRydWUKICAgIH0pOwogIH0KICBzZXRTZWxlY3RlZChlZGl0b3IpIHsKICAgIHRoaXMudXBkYXRlVG9vbGJhcih7CiAgICAgIG1vZGU6IGVkaXRvci5tb2RlLAogICAgICBlZGl0SWQ6IGVkaXRvci51aWQKICAgIH0pOwogICAgdGhpcy4jY3VycmVudERyYXdpbmdTZXNzaW9uPy5jb21taXRPclJlbW92ZSgpOwogICAgZm9yIChjb25zdCBlZCBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgICAgaWYgKGVkICE9PSBlZGl0b3IpIHsKICAgICAgICBlZC51bnNlbGVjdCgpOwogICAgICB9CiAgICB9CiAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuY2xlYXIoKTsKICAgIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy5hZGQoZWRpdG9yKTsKICAgIGVkaXRvci5zZWxlY3QoKTsKICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlVUkoZWRpdG9yLnByb3BlcnRpZXNUb1VwZGF0ZSk7CiAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgIGhhc1NlbGVjdGVkRWRpdG9yOiB0cnVlCiAgICB9KTsKICB9CiAgaXNTZWxlY3RlZChlZGl0b3IpIHsKICAgIHJldHVybiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuaGFzKGVkaXRvcik7CiAgfQogIGdldCBmaXJzdFNlbGVjdGVkRWRpdG9yKCkgewogICAgcmV0dXJuIHRoaXMuI3NlbGVjdGVkRWRpdG9ycy52YWx1ZXMoKS5uZXh0KCkudmFsdWU7CiAgfQogIHVuc2VsZWN0KGVkaXRvcikgewogICAgZWRpdG9yLnVuc2VsZWN0KCk7CiAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuZGVsZXRlKGVkaXRvcik7CiAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgIGhhc1NlbGVjdGVkRWRpdG9yOiB0aGlzLmhhc1NlbGVjdGlvbgogICAgfSk7CiAgfQogIGdldCBoYXNTZWxlY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy4jc2VsZWN0ZWRFZGl0b3JzLnNpemUgIT09IDA7CiAgfQogIGdldCBpc0VudGVySGFuZGxlZCgpIHsKICAgIHJldHVybiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuc2l6ZSA9PT0gMSAmJiB0aGlzLmZpcnN0U2VsZWN0ZWRFZGl0b3IuaXNFbnRlckhhbmRsZWQ7CiAgfQogIHVuZG8oKSB7CiAgICB0aGlzLiNjb21tYW5kTWFuYWdlci51bmRvKCk7CiAgICB0aGlzLiNkaXNwYXRjaFVwZGF0ZVN0YXRlcyh7CiAgICAgIGhhc1NvbWV0aGluZ1RvVW5kbzogdGhpcy4jY29tbWFuZE1hbmFnZXIuaGFzU29tZXRoaW5nVG9VbmRvKCksCiAgICAgIGhhc1NvbWV0aGluZ1RvUmVkbzogdHJ1ZSwKICAgICAgaXNFbXB0eTogdGhpcy4jaXNFbXB0eSgpCiAgICB9KTsKICAgIHRoaXMuX2VkaXRvclVuZG9CYXI/LmhpZGUoKTsKICB9CiAgcmVkbygpIHsKICAgIHRoaXMuI2NvbW1hbmRNYW5hZ2VyLnJlZG8oKTsKICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgaGFzU29tZXRoaW5nVG9VbmRvOiB0cnVlLAogICAgICBoYXNTb21ldGhpbmdUb1JlZG86IHRoaXMuI2NvbW1hbmRNYW5hZ2VyLmhhc1NvbWV0aGluZ1RvUmVkbygpLAogICAgICBpc0VtcHR5OiB0aGlzLiNpc0VtcHR5KCkKICAgIH0pOwogIH0KICBhZGRDb21tYW5kcyhwYXJhbXMpIHsKICAgIHRoaXMuI2NvbW1hbmRNYW5hZ2VyLmFkZChwYXJhbXMpOwogICAgdGhpcy4jZGlzcGF0Y2hVcGRhdGVTdGF0ZXMoewogICAgICBoYXNTb21ldGhpbmdUb1VuZG86IHRydWUsCiAgICAgIGhhc1NvbWV0aGluZ1RvUmVkbzogZmFsc2UsCiAgICAgIGlzRW1wdHk6IHRoaXMuI2lzRW1wdHkoKQogICAgfSk7CiAgfQogIGNsZWFuVW5kb1N0YWNrKHR5cGUpIHsKICAgIHRoaXMuI2NvbW1hbmRNYW5hZ2VyLmNsZWFuVHlwZSh0eXBlKTsKICB9CiAgI2lzRW1wdHkoKSB7CiAgICBpZiAodGhpcy4jYWxsRWRpdG9ycy5zaXplID09PSAwKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuI2FsbEVkaXRvcnMuc2l6ZSA9PT0gMSkgewogICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNhbGxFZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgICAgcmV0dXJuIGVkaXRvci5pc0VtcHR5KCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgZGVsZXRlKCkgewogICAgdGhpcy5jb21taXRPclJlbW92ZSgpOwogICAgY29uc3QgZHJhd2luZ0VkaXRvciA9IHRoaXMuY3VycmVudExheWVyPy5lbmREcmF3aW5nU2Vzc2lvbih0cnVlKTsKICAgIGlmICghdGhpcy5oYXNTZWxlY3Rpb24gJiYgIWRyYXdpbmdFZGl0b3IpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgZWRpdG9ycyA9IGRyYXdpbmdFZGl0b3IgPyBbZHJhd2luZ0VkaXRvcl0gOiBbLi4udGhpcy4jc2VsZWN0ZWRFZGl0b3JzXTsKICAgIGNvbnN0IGNtZCA9ICgpID0+IHsKICAgICAgdGhpcy5fZWRpdG9yVW5kb0Jhcj8uc2hvdyh1bmRvLCBlZGl0b3JzLmxlbmd0aCA9PT0gMSA/IGVkaXRvcnNbMF0uZWRpdG9yVHlwZSA6IGVkaXRvcnMubGVuZ3RoKTsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgZWRpdG9ycykgewogICAgICAgIGVkaXRvci5yZW1vdmUoKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHVuZG8gPSAoKSA9PiB7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGVkaXRvcnMpIHsKICAgICAgICB0aGlzLiNhZGRFZGl0b3JUb0xheWVyKGVkaXRvcik7CiAgICAgIH0KICAgIH07CiAgICB0aGlzLmFkZENvbW1hbmRzKHsKICAgICAgY21kLAogICAgICB1bmRvLAogICAgICBtdXN0RXhlYzogdHJ1ZQogICAgfSk7CiAgfQogIGNvbW1pdE9yUmVtb3ZlKCkgewogICAgdGhpcy4jYWN0aXZlRWRpdG9yPy5jb21taXRPclJlbW92ZSgpOwogIH0KICBoYXNTb21ldGhpbmdUb0NvbnRyb2woKSB7CiAgICByZXR1cm4gdGhpcy4jYWN0aXZlRWRpdG9yIHx8IHRoaXMuaGFzU2VsZWN0aW9uOwogIH0KICAjc2VsZWN0RWRpdG9ycyhlZGl0b3JzKSB7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgICAgZWRpdG9yLnVuc2VsZWN0KCk7CiAgICB9CiAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuY2xlYXIoKTsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGVkaXRvcnMpIHsKICAgICAgaWYgKGVkaXRvci5pc0VtcHR5KCkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuYWRkKGVkaXRvcik7CiAgICAgIGVkaXRvci5zZWxlY3QoKTsKICAgIH0KICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgaGFzU2VsZWN0ZWRFZGl0b3I6IHRoaXMuaGFzU2VsZWN0aW9uCiAgICB9KTsKICB9CiAgc2VsZWN0QWxsKCkgewogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jc2VsZWN0ZWRFZGl0b3JzKSB7CiAgICAgIGVkaXRvci5jb21taXQoKTsKICAgIH0KICAgIHRoaXMuI3NlbGVjdEVkaXRvcnModGhpcy4jYWxsRWRpdG9ycy52YWx1ZXMoKSk7CiAgfQogIHVuc2VsZWN0QWxsKCkgewogICAgaWYgKHRoaXMuI2FjdGl2ZUVkaXRvcikgewogICAgICB0aGlzLiNhY3RpdmVFZGl0b3IuY29tbWl0T3JSZW1vdmUoKTsKICAgICAgaWYgKHRoaXMuI21vZGUgIT09IEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLiNjdXJyZW50RHJhd2luZ1Nlc3Npb24/LmNvbW1pdE9yUmVtb3ZlKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLmhhc1NlbGVjdGlvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgICAgZWRpdG9yLnVuc2VsZWN0KCk7CiAgICB9CiAgICB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuY2xlYXIoKTsKICAgIHRoaXMuI2Rpc3BhdGNoVXBkYXRlU3RhdGVzKHsKICAgICAgaGFzU2VsZWN0ZWRFZGl0b3I6IGZhbHNlCiAgICB9KTsKICB9CiAgdHJhbnNsYXRlU2VsZWN0ZWRFZGl0b3JzKHgsIHksIG5vQ29tbWl0ID0gZmFsc2UpIHsKICAgIGlmICghbm9Db21taXQpIHsKICAgICAgdGhpcy5jb21taXRPclJlbW92ZSgpOwogICAgfQogICAgaWYgKCF0aGlzLmhhc1NlbGVjdGlvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiN0cmFuc2xhdGlvblswXSArPSB4OwogICAgdGhpcy4jdHJhbnNsYXRpb25bMV0gKz0geTsKICAgIGNvbnN0IFt0b3RhbFgsIHRvdGFsWV0gPSB0aGlzLiN0cmFuc2xhdGlvbjsKICAgIGNvbnN0IGVkaXRvcnMgPSBbLi4udGhpcy4jc2VsZWN0ZWRFZGl0b3JzXTsKICAgIGNvbnN0IFRJTUVfVE9fV0FJVCA9IDFlMzsKICAgIGlmICh0aGlzLiN0cmFuc2xhdGlvblRpbWVvdXRJZCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy4jdHJhbnNsYXRpb25UaW1lb3V0SWQpOwogICAgfQogICAgdGhpcy4jdHJhbnNsYXRpb25UaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGhpcy4jdHJhbnNsYXRpb25UaW1lb3V0SWQgPSBudWxsOwogICAgICB0aGlzLiN0cmFuc2xhdGlvblswXSA9IHRoaXMuI3RyYW5zbGF0aW9uWzFdID0gMDsKICAgICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgICAgY21kOiAoKSA9PiB7CiAgICAgICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBlZGl0b3JzKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiNhbGxFZGl0b3JzLmhhcyhlZGl0b3IuaWQpKSB7CiAgICAgICAgICAgICAgZWRpdG9yLnRyYW5zbGF0ZUluUGFnZSh0b3RhbFgsIHRvdGFsWSk7CiAgICAgICAgICAgICAgZWRpdG9yLnRyYW5zbGF0aW9uRG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICB1bmRvOiAoKSA9PiB7CiAgICAgICAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBlZGl0b3JzKSB7CiAgICAgICAgICAgIGlmICh0aGlzLiNhbGxFZGl0b3JzLmhhcyhlZGl0b3IuaWQpKSB7CiAgICAgICAgICAgICAgZWRpdG9yLnRyYW5zbGF0ZUluUGFnZSgtdG90YWxYLCAtdG90YWxZKTsKICAgICAgICAgICAgICBlZGl0b3IudHJhbnNsYXRpb25Eb25lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG11c3RFeGVjOiBmYWxzZQogICAgICB9KTsKICAgIH0sIFRJTUVfVE9fV0FJVCk7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBlZGl0b3JzKSB7CiAgICAgIGVkaXRvci50cmFuc2xhdGVJblBhZ2UoeCwgeSk7CiAgICAgIGVkaXRvci50cmFuc2xhdGlvbkRvbmUoKTsKICAgIH0KICB9CiAgc2V0VXBEcmFnU2Vzc2lvbigpIHsKICAgIGlmICghdGhpcy5oYXNTZWxlY3Rpb24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5kaXNhYmxlVXNlclNlbGVjdCh0cnVlKTsKICAgIHRoaXMuI2RyYWdnaW5nRWRpdG9ycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNzZWxlY3RlZEVkaXRvcnMpIHsKICAgICAgdGhpcy4jZHJhZ2dpbmdFZGl0b3JzLnNldChlZGl0b3IsIHsKICAgICAgICBzYXZlZFg6IGVkaXRvci54LAogICAgICAgIHNhdmVkWTogZWRpdG9yLnksCiAgICAgICAgc2F2ZWRQYWdlSW5kZXg6IGVkaXRvci5wYWdlSW5kZXgsCiAgICAgICAgbmV3WDogMCwKICAgICAgICBuZXdZOiAwLAogICAgICAgIG5ld1BhZ2VJbmRleDogLTEKICAgICAgfSk7CiAgICB9CiAgfQogIGVuZERyYWdTZXNzaW9uKCkgewogICAgaWYgKCF0aGlzLiNkcmFnZ2luZ0VkaXRvcnMpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5kaXNhYmxlVXNlclNlbGVjdChmYWxzZSk7CiAgICBjb25zdCBtYXAgPSB0aGlzLiNkcmFnZ2luZ0VkaXRvcnM7CiAgICB0aGlzLiNkcmFnZ2luZ0VkaXRvcnMgPSBudWxsOwogICAgbGV0IG11c3RCZUFkZGVkSW5VbmRvU3RhY2sgPSBmYWxzZTsKICAgIGZvciAoY29uc3QgW3sKICAgICAgeCwKICAgICAgeSwKICAgICAgcGFnZUluZGV4CiAgICB9LCB2YWx1ZV0gb2YgbWFwKSB7CiAgICAgIHZhbHVlLm5ld1ggPSB4OwogICAgICB2YWx1ZS5uZXdZID0geTsKICAgICAgdmFsdWUubmV3UGFnZUluZGV4ID0gcGFnZUluZGV4OwogICAgICBtdXN0QmVBZGRlZEluVW5kb1N0YWNrIHx8PSB4ICE9PSB2YWx1ZS5zYXZlZFggfHwgeSAhPT0gdmFsdWUuc2F2ZWRZIHx8IHBhZ2VJbmRleCAhPT0gdmFsdWUuc2F2ZWRQYWdlSW5kZXg7CiAgICB9CiAgICBpZiAoIW11c3RCZUFkZGVkSW5VbmRvU3RhY2spIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3QgbW92ZSA9IChlZGl0b3IsIHgsIHksIHBhZ2VJbmRleCkgPT4gewogICAgICBpZiAodGhpcy4jYWxsRWRpdG9ycy5oYXMoZWRpdG9yLmlkKSkgewogICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuI2FsbExheWVycy5nZXQocGFnZUluZGV4KTsKICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICBlZGl0b3IuX3NldFBhcmVudEFuZFBvc2l0aW9uKHBhcmVudCwgeCwgeSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVkaXRvci5wYWdlSW5kZXggPSBwYWdlSW5kZXg7CiAgICAgICAgICBlZGl0b3IueCA9IHg7CiAgICAgICAgICBlZGl0b3IueSA9IHk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZDogKCkgPT4gewogICAgICAgIGZvciAoY29uc3QgW2VkaXRvciwgewogICAgICAgICAgbmV3WCwKICAgICAgICAgIG5ld1ksCiAgICAgICAgICBuZXdQYWdlSW5kZXgKICAgICAgICB9XSBvZiBtYXApIHsKICAgICAgICAgIG1vdmUoZWRpdG9yLCBuZXdYLCBuZXdZLCBuZXdQYWdlSW5kZXgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdW5kbzogKCkgPT4gewogICAgICAgIGZvciAoY29uc3QgW2VkaXRvciwgewogICAgICAgICAgc2F2ZWRYLAogICAgICAgICAgc2F2ZWRZLAogICAgICAgICAgc2F2ZWRQYWdlSW5kZXgKICAgICAgICB9XSBvZiBtYXApIHsKICAgICAgICAgIG1vdmUoZWRpdG9yLCBzYXZlZFgsIHNhdmVkWSwgc2F2ZWRQYWdlSW5kZXgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgbXVzdEV4ZWM6IHRydWUKICAgIH0pOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGRyYWdTZWxlY3RlZEVkaXRvcnModHgsIHR5KSB7CiAgICBpZiAoIXRoaXMuI2RyYWdnaW5nRWRpdG9ycykgewogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNkcmFnZ2luZ0VkaXRvcnMua2V5cygpKSB7CiAgICAgIGVkaXRvci5kcmFnKHR4LCB0eSk7CiAgICB9CiAgfQogIHJlYnVpbGQoZWRpdG9yKSB7CiAgICBpZiAoZWRpdG9yLnBhcmVudCA9PT0gbnVsbCkgewogICAgICBjb25zdCBwYXJlbnQgPSB0aGlzLmdldExheWVyKGVkaXRvci5wYWdlSW5kZXgpOwogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgcGFyZW50LmNoYW5nZVBhcmVudChlZGl0b3IpOwogICAgICAgIHBhcmVudC5hZGRPclJlYnVpbGQoZWRpdG9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFkZEVkaXRvcihlZGl0b3IpOwogICAgICAgIHRoaXMuYWRkVG9Bbm5vdGF0aW9uU3RvcmFnZShlZGl0b3IpOwogICAgICAgIGVkaXRvci5yZWJ1aWxkKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVkaXRvci5wYXJlbnQuYWRkT3JSZWJ1aWxkKGVkaXRvcik7CiAgICB9CiAgfQogIGdldCBpc0VkaXRvckhhbmRsaW5nS2V5Ym9hcmQoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRBY3RpdmUoKT8uc2hvdWxkR2V0S2V5Ym9hcmRFdmVudHMoKSB8fCB0aGlzLiNzZWxlY3RlZEVkaXRvcnMuc2l6ZSA9PT0gMSAmJiB0aGlzLmZpcnN0U2VsZWN0ZWRFZGl0b3Iuc2hvdWxkR2V0S2V5Ym9hcmRFdmVudHMoKTsKICB9CiAgaXNBY3RpdmUoZWRpdG9yKSB7CiAgICByZXR1cm4gdGhpcy4jYWN0aXZlRWRpdG9yID09PSBlZGl0b3I7CiAgfQogIGdldEFjdGl2ZSgpIHsKICAgIHJldHVybiB0aGlzLiNhY3RpdmVFZGl0b3I7CiAgfQogIGdldE1vZGUoKSB7CiAgICByZXR1cm4gdGhpcy4jbW9kZTsKICB9CiAgaXNFZGl0aW5nTW9kZSgpIHsKICAgIHJldHVybiB0aGlzLiNtb2RlICE9PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5OT05FOwogIH0KICBnZXQgaW1hZ2VNYW5hZ2VyKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaW1hZ2VNYW5hZ2VyIiwgbmV3IEltYWdlTWFuYWdlcigpKTsKICB9CiAgZ2V0U2VsZWN0aW9uQm94ZXModGV4dExheWVyKSB7CiAgICBpZiAoIXRleHRMYXllcikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gc2VsZWN0aW9uLnJhbmdlQ291bnQ7IGkgPCBpaTsgaSsrKSB7CiAgICAgIGlmICghdGV4dExheWVyLmNvbnRhaW5zKHNlbGVjdGlvbi5nZXRSYW5nZUF0KGkpLmNvbW1vbkFuY2VzdG9yQ29udGFpbmVyKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHg6IGxheWVyWCwKICAgICAgeTogbGF5ZXJZLAogICAgICB3aWR0aDogcGFyZW50V2lkdGgsCiAgICAgIGhlaWdodDogcGFyZW50SGVpZ2h0CiAgICB9ID0gdGV4dExheWVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgbGV0IHJvdGF0b3I7CiAgICBzd2l0Y2ggKHRleHRMYXllci5nZXRBdHRyaWJ1dGUoImRhdGEtbWFpbi1yb3RhdGlvbiIpKSB7CiAgICAgIGNhc2UgIjkwIjoKICAgICAgICByb3RhdG9yID0gKHgsIHksIHcsIGgpID0+ICh7CiAgICAgICAgICB4OiAoeSAtIGxheWVyWSkgLyBwYXJlbnRIZWlnaHQsCiAgICAgICAgICB5OiAxIC0gKHggKyB3IC0gbGF5ZXJYKSAvIHBhcmVudFdpZHRoLAogICAgICAgICAgd2lkdGg6IGggLyBwYXJlbnRIZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IHcgLyBwYXJlbnRXaWR0aAogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICIxODAiOgogICAgICAgIHJvdGF0b3IgPSAoeCwgeSwgdywgaCkgPT4gKHsKICAgICAgICAgIHg6IDEgLSAoeCArIHcgLSBsYXllclgpIC8gcGFyZW50V2lkdGgsCiAgICAgICAgICB5OiAxIC0gKHkgKyBoIC0gbGF5ZXJZKSAvIHBhcmVudEhlaWdodCwKICAgICAgICAgIHdpZHRoOiB3IC8gcGFyZW50V2lkdGgsCiAgICAgICAgICBoZWlnaHQ6IGggLyBwYXJlbnRIZWlnaHQKICAgICAgICB9KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiMjcwIjoKICAgICAgICByb3RhdG9yID0gKHgsIHksIHcsIGgpID0+ICh7CiAgICAgICAgICB4OiAxIC0gKHkgKyBoIC0gbGF5ZXJZKSAvIHBhcmVudEhlaWdodCwKICAgICAgICAgIHk6ICh4IC0gbGF5ZXJYKSAvIHBhcmVudFdpZHRoLAogICAgICAgICAgd2lkdGg6IGggLyBwYXJlbnRIZWlnaHQsCiAgICAgICAgICBoZWlnaHQ6IHcgLyBwYXJlbnRXaWR0aAogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHJvdGF0b3IgPSAoeCwgeSwgdywgaCkgPT4gKHsKICAgICAgICAgIHg6ICh4IC0gbGF5ZXJYKSAvIHBhcmVudFdpZHRoLAogICAgICAgICAgeTogKHkgLSBsYXllclkpIC8gcGFyZW50SGVpZ2h0LAogICAgICAgICAgd2lkdGg6IHcgLyBwYXJlbnRXaWR0aCwKICAgICAgICAgIGhlaWdodDogaCAvIHBhcmVudEhlaWdodAogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgfQogICAgY29uc3QgYm94ZXMgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHNlbGVjdGlvbi5yYW5nZUNvdW50OyBpIDwgaWk7IGkrKykgewogICAgICBjb25zdCByYW5nZSA9IHNlbGVjdGlvbi5nZXRSYW5nZUF0KGkpOwogICAgICBpZiAocmFuZ2UuY29sbGFwc2VkKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgZm9yIChjb25zdCB7CiAgICAgICAgeCwKICAgICAgICB5LAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9IG9mIHJhbmdlLmdldENsaWVudFJlY3RzKCkpIHsKICAgICAgICBpZiAod2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgYm94ZXMucHVzaChyb3RhdG9yKHgsIHksIHdpZHRoLCBoZWlnaHQpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGJveGVzLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBib3hlczsKICB9CiAgYWRkQ2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbih7CiAgICBhbm5vdGF0aW9uRWxlbWVudElkLAogICAgaWQKICB9KSB7CiAgICAodGhpcy4jY2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbnMgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpLnNldChhbm5vdGF0aW9uRWxlbWVudElkLCBpZCk7CiAgfQogIHJlbW92ZUNoYW5nZWRFeGlzdGluZ0Fubm90YXRpb24oewogICAgYW5ub3RhdGlvbkVsZW1lbnRJZAogIH0pIHsKICAgIHRoaXMuI2NoYW5nZWRFeGlzdGluZ0Fubm90YXRpb25zPy5kZWxldGUoYW5ub3RhdGlvbkVsZW1lbnRJZCk7CiAgfQogIHJlbmRlckFubm90YXRpb25FbGVtZW50KGFubm90YXRpb24pIHsKICAgIGNvbnN0IGVkaXRvcklkID0gdGhpcy4jY2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbnM/LmdldChhbm5vdGF0aW9uLmRhdGEuaWQpOwogICAgaWYgKCFlZGl0b3JJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBlZGl0b3IgPSB0aGlzLiNhbm5vdGF0aW9uU3RvcmFnZS5nZXRSYXdWYWx1ZShlZGl0b3JJZCk7CiAgICBpZiAoIWVkaXRvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jbW9kZSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuTk9ORSAmJiAhZWRpdG9yLmhhc0JlZW5Nb2RpZmllZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBlZGl0b3IucmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbik7CiAgfQogIHNldE1pc3NpbmdDYW52YXMoYW5ub3RhdGlvbklkLCBhbm5vdGF0aW9uRWxlbWVudElkLCBjYW52YXMpIHsKICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuI21pc3NpbmdDYW52YXNlcz8uZ2V0KGFubm90YXRpb25JZCk7CiAgICBpZiAoIWVkaXRvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBlZGl0b3Iuc2V0Q2FudmFzKGFubm90YXRpb25FbGVtZW50SWQsIGNhbnZhcyk7CiAgICB0aGlzLiNtaXNzaW5nQ2FudmFzZXMuZGVsZXRlKGFubm90YXRpb25JZCk7CiAgfQogIGFkZE1pc3NpbmdDYW52YXMoYW5ub3RhdGlvbklkLCBlZGl0b3IpIHsKICAgICh0aGlzLiNtaXNzaW5nQ2FudmFzZXMgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpLnNldChhbm5vdGF0aW9uSWQsIGVkaXRvcik7CiAgfQp9Owp2YXIgQWx0VGV4dCA9IGNsYXNzIF9BbHRUZXh0IHsKICAjYWx0VGV4dCA9IG51bGw7CiAgI2FsdFRleHREZWNvcmF0aXZlID0gZmFsc2U7CiAgI2FsdFRleHRCdXR0b24gPSBudWxsOwogICNhbHRUZXh0QnV0dG9uTGFiZWwgPSBudWxsOwogICNhbHRUZXh0VG9vbHRpcCA9IG51bGw7CiAgI2FsdFRleHRUb29sdGlwVGltZW91dCA9IG51bGw7CiAgI2FsdFRleHRXYXNGcm9tS2V5Qm9hcmQgPSBmYWxzZTsKICAjYmFkZ2UgPSBudWxsOwogICNlZGl0b3IgPSBudWxsOwogICNndWVzc2VkVGV4dCA9IG51bGw7CiAgI3RleHRXaXRoRGlzY2xhaW1lciA9IG51bGw7CiAgI3VzZU5ld0FsdFRleHRGbG93ID0gZmFsc2U7CiAgc3RhdGljICNsMTBuTmV3QnV0dG9uID0gbnVsbDsKICBzdGF0aWMgX2wxMG4gPSBudWxsOwogIGNvbnN0cnVjdG9yKGVkaXRvcikgewogICAgdGhpcy4jZWRpdG9yID0gZWRpdG9yOwogICAgdGhpcy4jdXNlTmV3QWx0VGV4dEZsb3cgPSBlZGl0b3IuX3VpTWFuYWdlci51c2VOZXdBbHRUZXh0RmxvdzsKICAgIF9BbHRUZXh0LiNsMTBuTmV3QnV0dG9uIHx8PSBPYmplY3QuZnJlZXplKHsKICAgICAgYWRkZWQ6ICJwZGZqcy1lZGl0b3ItbmV3LWFsdC10ZXh0LWFkZGVkLWJ1dHRvbiIsCiAgICAgICJhZGRlZC1sYWJlbCI6ICJwZGZqcy1lZGl0b3ItbmV3LWFsdC10ZXh0LWFkZGVkLWJ1dHRvbi1sYWJlbCIsCiAgICAgIG1pc3Npbmc6ICJwZGZqcy1lZGl0b3ItbmV3LWFsdC10ZXh0LW1pc3NpbmctYnV0dG9uIiwKICAgICAgIm1pc3NpbmctbGFiZWwiOiAicGRmanMtZWRpdG9yLW5ldy1hbHQtdGV4dC1taXNzaW5nLWJ1dHRvbi1sYWJlbCIsCiAgICAgIHJldmlldzogInBkZmpzLWVkaXRvci1uZXctYWx0LXRleHQtdG8tcmV2aWV3LWJ1dHRvbiIsCiAgICAgICJyZXZpZXctbGFiZWwiOiAicGRmanMtZWRpdG9yLW5ldy1hbHQtdGV4dC10by1yZXZpZXctYnV0dG9uLWxhYmVsIgogICAgfSk7CiAgfQogIHN0YXRpYyBpbml0aWFsaXplKGwxMG4pIHsKICAgIF9BbHRUZXh0Ll9sMTBuID8/PSBsMTBuOwogIH0KICBhc3luYyByZW5kZXIoKSB7CiAgICBjb25zdCBhbHRUZXh0ID0gdGhpcy4jYWx0VGV4dEJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgYWx0VGV4dC5jbGFzc05hbWUgPSAiYWx0VGV4dCI7CiAgICBhbHRUZXh0LnRhYkluZGV4ID0gIjAiOwogICAgY29uc3QgbGFiZWwgPSB0aGlzLiNhbHRUZXh0QnV0dG9uTGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICBhbHRUZXh0LmFwcGVuZChsYWJlbCk7CiAgICBpZiAodGhpcy4jdXNlTmV3QWx0VGV4dEZsb3cpIHsKICAgICAgYWx0VGV4dC5jbGFzc0xpc3QuYWRkKCJuZXciKTsKICAgICAgYWx0VGV4dC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIF9BbHRUZXh0LiNsMTBuTmV3QnV0dG9uLm1pc3NpbmcpOwogICAgICBsYWJlbC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIF9BbHRUZXh0LiNsMTBuTmV3QnV0dG9uWyJtaXNzaW5nLWxhYmVsIl0pOwogICAgfSBlbHNlIHsKICAgICAgYWx0VGV4dC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1lZGl0b3ItYWx0LXRleHQtYnV0dG9uIik7CiAgICAgIGxhYmVsLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLWVkaXRvci1hbHQtdGV4dC1idXR0b24tbGFiZWwiKTsKICAgIH0KICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI2VkaXRvci5fdWlNYW5hZ2VyLl9zaWduYWw7CiAgICBhbHRUZXh0LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51Iiwgbm9Db250ZXh0TWVudSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgYWx0VGV4dC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIChldmVudCkgPT4gZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGNvbnN0IG9uQ2xpY2sgPSAoZXZlbnQpID0+IHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgdGhpcy4jZWRpdG9yLl91aU1hbmFnZXIuZWRpdEFsdFRleHQodGhpcy4jZWRpdG9yKTsKICAgICAgaWYgKHRoaXMuI3VzZU5ld0FsdFRleHRGbG93KSB7CiAgICAgICAgdGhpcy4jZWRpdG9yLl9yZXBvcnRUZWxlbWV0cnkoewogICAgICAgICAgYWN0aW9uOiAicGRmanMuaW1hZ2UuYWx0X3RleHQuaW1hZ2Vfc3RhdHVzX2xhYmVsX2NsaWNrZWQiLAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBsYWJlbDogdGhpcy4jbGFiZWwKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIGFsdFRleHQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBvbkNsaWNrLCB7CiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBhbHRUZXh0LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCAoZXZlbnQpID0+IHsKICAgICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gYWx0VGV4dCAmJiBldmVudC5rZXkgPT09ICJFbnRlciIpIHsKICAgICAgICB0aGlzLiNhbHRUZXh0V2FzRnJvbUtleUJvYXJkID0gdHJ1ZTsKICAgICAgICBvbkNsaWNrKGV2ZW50KTsKICAgICAgfQogICAgfSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgYXdhaXQgdGhpcy4jc2V0U3RhdGUoKTsKICAgIHJldHVybiBhbHRUZXh0OwogIH0KICBnZXQgI2xhYmVsKCkgewogICAgcmV0dXJuIHRoaXMuI2FsdFRleHQgJiYgImFkZGVkIiB8fCB0aGlzLiNhbHRUZXh0ID09PSBudWxsICYmIHRoaXMuZ3Vlc3NlZFRleHQgJiYgInJldmlldyIgfHwgIm1pc3NpbmciOwogIH0KICBmaW5pc2goKSB7CiAgICBpZiAoIXRoaXMuI2FsdFRleHRCdXR0b24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jYWx0VGV4dEJ1dHRvbi5mb2N1cyh7CiAgICAgIGZvY3VzVmlzaWJsZTogdGhpcy4jYWx0VGV4dFdhc0Zyb21LZXlCb2FyZAogICAgfSk7CiAgICB0aGlzLiNhbHRUZXh0V2FzRnJvbUtleUJvYXJkID0gZmFsc2U7CiAgfQogIGlzRW1wdHkoKSB7CiAgICBpZiAodGhpcy4jdXNlTmV3QWx0VGV4dEZsb3cpIHsKICAgICAgcmV0dXJuIHRoaXMuI2FsdFRleHQgPT09IG51bGw7CiAgICB9CiAgICByZXR1cm4gIXRoaXMuI2FsdFRleHQgJiYgIXRoaXMuI2FsdFRleHREZWNvcmF0aXZlOwogIH0KICBoYXNEYXRhKCkgewogICAgaWYgKHRoaXMuI3VzZU5ld0FsdFRleHRGbG93KSB7CiAgICAgIHJldHVybiB0aGlzLiNhbHRUZXh0ICE9PSBudWxsIHx8ICEhdGhpcy4jZ3Vlc3NlZFRleHQ7CiAgICB9CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5KCk7CiAgfQogIGdldCBndWVzc2VkVGV4dCgpIHsKICAgIHJldHVybiB0aGlzLiNndWVzc2VkVGV4dDsKICB9CiAgYXN5bmMgc2V0R3Vlc3NlZFRleHQoZ3Vlc3NlZFRleHQpIHsKICAgIGlmICh0aGlzLiNhbHRUZXh0ICE9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2d1ZXNzZWRUZXh0ID0gZ3Vlc3NlZFRleHQ7CiAgICB0aGlzLiN0ZXh0V2l0aERpc2NsYWltZXIgPSBhd2FpdCBfQWx0VGV4dC5fbDEwbi5nZXQoInBkZmpzLWVkaXRvci1uZXctYWx0LXRleHQtZ2VuZXJhdGVkLWFsdC10ZXh0LXdpdGgtZGlzY2xhaW1lciIsIHsKICAgICAgZ2VuZXJhdGVkQWx0VGV4dDogZ3Vlc3NlZFRleHQKICAgIH0pOwogICAgdGhpcy4jc2V0U3RhdGUoKTsKICB9CiAgdG9nZ2xlQWx0VGV4dEJhZGdlKHZpc2liaWxpdHkgPSBmYWxzZSkgewogICAgaWYgKCF0aGlzLiN1c2VOZXdBbHRUZXh0RmxvdyB8fCB0aGlzLiNhbHRUZXh0KSB7CiAgICAgIHRoaXMuI2JhZGdlPy5yZW1vdmUoKTsKICAgICAgdGhpcy4jYmFkZ2UgPSBudWxsOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI2JhZGdlKSB7CiAgICAgIGNvbnN0IGJhZGdlID0gdGhpcy4jYmFkZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgYmFkZ2UuY2xhc3NOYW1lID0gIm5vQWx0VGV4dEJhZGdlIjsKICAgICAgdGhpcy4jZWRpdG9yLmRpdi5hcHBlbmQoYmFkZ2UpOwogICAgfQogICAgdGhpcy4jYmFkZ2UuY2xhc3NMaXN0LnRvZ2dsZSgiaGlkZGVuIiwgIXZpc2liaWxpdHkpOwogIH0KICBzZXJpYWxpemUoaXNGb3JDb3B5aW5nKSB7CiAgICBsZXQgYWx0VGV4dCA9IHRoaXMuI2FsdFRleHQ7CiAgICBpZiAoIWlzRm9yQ29weWluZyAmJiB0aGlzLiNndWVzc2VkVGV4dCA9PT0gYWx0VGV4dCkgewogICAgICBhbHRUZXh0ID0gdGhpcy4jdGV4dFdpdGhEaXNjbGFpbWVyOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgYWx0VGV4dCwKICAgICAgZGVjb3JhdGl2ZTogdGhpcy4jYWx0VGV4dERlY29yYXRpdmUsCiAgICAgIGd1ZXNzZWRUZXh0OiB0aGlzLiNndWVzc2VkVGV4dCwKICAgICAgdGV4dFdpdGhEaXNjbGFpbWVyOiB0aGlzLiN0ZXh0V2l0aERpc2NsYWltZXIKICAgIH07CiAgfQogIGdldCBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgYWx0VGV4dDogdGhpcy4jYWx0VGV4dCwKICAgICAgZGVjb3JhdGl2ZTogdGhpcy4jYWx0VGV4dERlY29yYXRpdmUKICAgIH07CiAgfQogIHNldCBkYXRhKHsKICAgIGFsdFRleHQsCiAgICBkZWNvcmF0aXZlLAogICAgZ3Vlc3NlZFRleHQsCiAgICB0ZXh0V2l0aERpc2NsYWltZXIsCiAgICBjYW5jZWwgPSBmYWxzZQogIH0pIHsKICAgIGlmIChndWVzc2VkVGV4dCkgewogICAgICB0aGlzLiNndWVzc2VkVGV4dCA9IGd1ZXNzZWRUZXh0OwogICAgICB0aGlzLiN0ZXh0V2l0aERpc2NsYWltZXIgPSB0ZXh0V2l0aERpc2NsYWltZXI7CiAgICB9CiAgICBpZiAodGhpcy4jYWx0VGV4dCA9PT0gYWx0VGV4dCAmJiB0aGlzLiNhbHRUZXh0RGVjb3JhdGl2ZSA9PT0gZGVjb3JhdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIWNhbmNlbCkgewogICAgICB0aGlzLiNhbHRUZXh0ID0gYWx0VGV4dDsKICAgICAgdGhpcy4jYWx0VGV4dERlY29yYXRpdmUgPSBkZWNvcmF0aXZlOwogICAgfQogICAgdGhpcy4jc2V0U3RhdGUoKTsKICB9CiAgdG9nZ2xlKGVuYWJsZWQgPSBmYWxzZSkgewogICAgaWYgKCF0aGlzLiNhbHRUZXh0QnV0dG9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghZW5hYmxlZCAmJiB0aGlzLiNhbHRUZXh0VG9vbHRpcFRpbWVvdXQpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCk7CiAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCA9IG51bGw7CiAgICB9CiAgICB0aGlzLiNhbHRUZXh0QnV0dG9uLmRpc2FibGVkID0gIWVuYWJsZWQ7CiAgfQogIHNob3duKCkgewogICAgdGhpcy4jZWRpdG9yLl9yZXBvcnRUZWxlbWV0cnkoewogICAgICBhY3Rpb246ICJwZGZqcy5pbWFnZS5hbHRfdGV4dC5pbWFnZV9zdGF0dXNfbGFiZWxfZGlzcGxheWVkIiwKICAgICAgZGF0YTogewogICAgICAgIGxhYmVsOiB0aGlzLiNsYWJlbAogICAgICB9CiAgICB9KTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI2FsdFRleHRCdXR0b24/LnJlbW92ZSgpOwogICAgdGhpcy4jYWx0VGV4dEJ1dHRvbiA9IG51bGw7CiAgICB0aGlzLiNhbHRUZXh0QnV0dG9uTGFiZWwgPSBudWxsOwogICAgdGhpcy4jYWx0VGV4dFRvb2x0aXAgPSBudWxsOwogICAgdGhpcy4jYmFkZ2U/LnJlbW92ZSgpOwogICAgdGhpcy4jYmFkZ2UgPSBudWxsOwogIH0KICBhc3luYyAjc2V0U3RhdGUoKSB7CiAgICBjb25zdCBidXR0b24gPSB0aGlzLiNhbHRUZXh0QnV0dG9uOwogICAgaWYgKCFidXR0b24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI3VzZU5ld0FsdFRleHRGbG93KSB7CiAgICAgIGJ1dHRvbi5jbGFzc0xpc3QudG9nZ2xlKCJkb25lIiwgISF0aGlzLiNhbHRUZXh0KTsKICAgICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0FsdFRleHQuI2wxMG5OZXdCdXR0b25bdGhpcy4jbGFiZWxdKTsKICAgICAgdGhpcy4jYWx0VGV4dEJ1dHRvbkxhYmVsPy5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIF9BbHRUZXh0LiNsMTBuTmV3QnV0dG9uW2Ake3RoaXMuI2xhYmVsfS1sYWJlbGBdKTsKICAgICAgaWYgKCF0aGlzLiNhbHRUZXh0KSB7CiAgICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXA/LnJlbW92ZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCF0aGlzLiNhbHRUZXh0ICYmICF0aGlzLiNhbHRUZXh0RGVjb3JhdGl2ZSkgewogICAgICAgIGJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKCJkb25lIik7CiAgICAgICAgdGhpcy4jYWx0VGV4dFRvb2x0aXA/LnJlbW92ZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBidXR0b24uY2xhc3NMaXN0LmFkZCgiZG9uZSIpOwogICAgICBidXR0b24uc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCAicGRmanMtZWRpdG9yLWFsdC10ZXh0LWVkaXQtYnV0dG9uIik7CiAgICB9CiAgICBsZXQgdG9vbHRpcCA9IHRoaXMuI2FsdFRleHRUb29sdGlwOwogICAgaWYgKCF0b29sdGlwKSB7CiAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwID0gdG9vbHRpcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgdG9vbHRpcC5jbGFzc05hbWUgPSAidG9vbHRpcCI7CiAgICAgIHRvb2x0aXAuc2V0QXR0cmlidXRlKCJyb2xlIiwgInRvb2x0aXAiKTsKICAgICAgdG9vbHRpcC5pZCA9IGBhbHQtdGV4dC10b29sdGlwLSR7dGhpcy4jZWRpdG9yLmlkfWA7CiAgICAgIGNvbnN0IERFTEFZX1RPX1NIT1dfVE9PTFRJUCA9IDEwMDsKICAgICAgY29uc3Qgc2lnbmFsID0gdGhpcy4jZWRpdG9yLl91aU1hbmFnZXIuX3NpZ25hbDsKICAgICAgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgKCkgPT4gewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLiNhbHRUZXh0VG9vbHRpcFRpbWVvdXQpOwogICAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCA9IG51bGw7CiAgICAgIH0sIHsKICAgICAgICBvbmNlOiB0cnVlCiAgICAgIH0pOwogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigibW91c2VlbnRlciIsICgpID0+IHsKICAgICAgICB0aGlzLiNhbHRUZXh0VG9vbHRpcFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCA9IG51bGw7CiAgICAgICAgICB0aGlzLiNhbHRUZXh0VG9vbHRpcC5jbGFzc0xpc3QuYWRkKCJzaG93Iik7CiAgICAgICAgICB0aGlzLiNlZGl0b3IuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgICAgICAgIGFjdGlvbjogImFsdF90ZXh0X3Rvb2x0aXAiCiAgICAgICAgICB9KTsKICAgICAgICB9LCBERUxBWV9UT19TSE9XX1RPT0xUSVApOwogICAgICB9LCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigibW91c2VsZWF2ZSIsICgpID0+IHsKICAgICAgICBpZiAodGhpcy4jYWx0VGV4dFRvb2x0aXBUaW1lb3V0KSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy4jYWx0VGV4dFRvb2x0aXBUaW1lb3V0KTsKICAgICAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwVGltZW91dCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHRoaXMuI2FsdFRleHRUb29sdGlwPy5jbGFzc0xpc3QucmVtb3ZlKCJzaG93Iik7CiAgICAgIH0sIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICB9CiAgICBpZiAodGhpcy4jYWx0VGV4dERlY29yYXRpdmUpIHsKICAgICAgdG9vbHRpcC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1lZGl0b3ItYWx0LXRleHQtZGVjb3JhdGl2ZS10b29sdGlwIik7CiAgICB9IGVsc2UgewogICAgICB0b29sdGlwLnJlbW92ZUF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIik7CiAgICAgIHRvb2x0aXAudGV4dENvbnRlbnQgPSB0aGlzLiNhbHRUZXh0OwogICAgfQogICAgaWYgKCF0b29sdGlwLnBhcmVudE5vZGUpIHsKICAgICAgYnV0dG9uLmFwcGVuZCh0b29sdGlwKTsKICAgIH0KICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLiNlZGl0b3IuZ2V0RWxlbWVudEZvckFsdFRleHQoKTsKICAgIGVsZW1lbnQ/LnNldEF0dHJpYnV0ZSgiYXJpYS1kZXNjcmliZWRieSIsIHRvb2x0aXAuaWQpOwogIH0KfTsKdmFyIENvbW1lbnQgPSBjbGFzcyB7CiAgI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uID0gbnVsbDsKICAjY29tbWVudFRvb2xiYXJCdXR0b24gPSBudWxsOwogICNjb21tZW50V2FzRnJvbUtleUJvYXJkID0gZmFsc2U7CiAgI2VkaXRvciA9IG51bGw7CiAgI2luaXRpYWxUZXh0ID0gbnVsbDsKICAjcmljaFRleHQgPSBudWxsOwogICN0ZXh0ID0gbnVsbDsKICAjZGF0ZSA9IG51bGw7CiAgI2RlbGV0ZWQgPSBmYWxzZTsKICAjcG9wdXBQb3NpdGlvbiA9IG51bGw7CiAgY29uc3RydWN0b3IoZWRpdG9yKSB7CiAgICB0aGlzLiNlZGl0b3IgPSBlZGl0b3I7CiAgfQogIHJlbmRlckZvclRvb2xiYXIoKSB7CiAgICBjb25zdCBidXR0b24gPSB0aGlzLiNjb21tZW50VG9vbGJhckJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgYnV0dG9uLmNsYXNzTmFtZSA9ICJjb21tZW50IjsKICAgIHJldHVybiB0aGlzLiNyZW5kZXIoYnV0dG9uLCBmYWxzZSk7CiAgfQogIHJlbmRlckZvclN0YW5kYWxvbmUoKSB7CiAgICBjb25zdCBidXR0b24gPSB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJ1dHRvbiIpOwogICAgYnV0dG9uLmNsYXNzTmFtZSA9ICJhbm5vdGF0aW9uQ29tbWVudEJ1dHRvbiI7CiAgICBjb25zdCBwb3NpdGlvbiA9IHRoaXMuI2VkaXRvci5jb21tZW50QnV0dG9uUG9zaXRpb247CiAgICBpZiAocG9zaXRpb24pIHsKICAgICAgY29uc3QgewogICAgICAgIHN0eWxlCiAgICAgIH0gPSBidXR0b247CiAgICAgIHN0eWxlLmluc2V0SW5saW5lRW5kID0gYGNhbGMoJHsxMDAgKiAodGhpcy4jZWRpdG9yLl91aU1hbmFnZXIuZGlyZWN0aW9uID09PSAibHRyIiA/IDEgLSBwb3NpdGlvblswXSA6IHBvc2l0aW9uWzBdKX0lIC0gdmFyKC0tY29tbWVudC1idXR0b24tZGltKSlgOwogICAgICBzdHlsZS50b3AgPSBgY2FsYygkezEwMCAqIHBvc2l0aW9uWzFdfSUgLSB2YXIoLS1jb21tZW50LWJ1dHRvbi1kaW0pKWA7CiAgICAgIGNvbnN0IGNvbG9yID0gdGhpcy4jZWRpdG9yLmNvbW1lbnRCdXR0b25Db2xvcjsKICAgICAgaWYgKGNvbG9yKSB7CiAgICAgICAgc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3I7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLiNyZW5kZXIoYnV0dG9uLCB0cnVlKTsKICB9CiAgZm9jdXNCdXR0b24oKSB7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgKHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uID8/IHRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uKT8uZm9jdXMoKTsKICAgIH0sIDApOwogIH0KICBvblVwZGF0ZWRDb2xvcigpIHsKICAgIGlmICghdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY29sb3IgPSB0aGlzLiNlZGl0b3IuY29tbWVudEJ1dHRvbkNvbG9yOwogICAgaWYgKGNvbG9yKSB7CiAgICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yOwogICAgfQogICAgdGhpcy4jZWRpdG9yLl91aU1hbmFnZXIudXBkYXRlUG9wdXBDb2xvcih0aGlzLiNlZGl0b3IpOwogIH0KICBnZXQgY29tbWVudEJ1dHRvbldpZHRoKCkgewogICAgcmV0dXJuICh0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbj8uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggPz8gMCkgLyB0aGlzLiNlZGl0b3IucGFyZW50LmJvdW5kaW5nQ2xpZW50UmVjdC53aWR0aDsKICB9CiAgZ2V0IGNvbW1lbnRQb3B1cFBvc2l0aW9uSW5MYXllcigpIHsKICAgIGlmICh0aGlzLiNwb3B1cFBvc2l0aW9uKSB7CiAgICAgIHJldHVybiB0aGlzLiNwb3B1cFBvc2l0aW9uOwogICAgfQogICAgaWYgKCF0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgeCwKICAgICAgeSwKICAgICAgaGVpZ2h0CiAgICB9ID0gdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCB7CiAgICAgIHg6IHBhcmVudFgsCiAgICAgIHk6IHBhcmVudFksCiAgICAgIHdpZHRoOiBwYXJlbnRXaWR0aCwKICAgICAgaGVpZ2h0OiBwYXJlbnRIZWlnaHQKICAgIH0gPSB0aGlzLiNlZGl0b3IucGFyZW50LmJvdW5kaW5nQ2xpZW50UmVjdDsKICAgIHJldHVybiBbKHggLSBwYXJlbnRYKSAvIHBhcmVudFdpZHRoLCAoeSArIGhlaWdodCAtIHBhcmVudFkpIC8gcGFyZW50SGVpZ2h0XTsKICB9CiAgc2V0IGNvbW1lbnRQb3B1cFBvc2l0aW9uSW5MYXllcihwb3MpIHsKICAgIHRoaXMuI3BvcHVwUG9zaXRpb24gPSBwb3M7CiAgfQogIGhhc0RlZmF1bHRQb3B1cFBvc2l0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuI3BvcHVwUG9zaXRpb24gPT09IG51bGw7CiAgfQogIHJlbW92ZVN0YW5kYWxvbmVDb21tZW50QnV0dG9uKCkgewogICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24/LnJlbW92ZSgpOwogICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24gPSBudWxsOwogIH0KICByZW1vdmVUb29sYmFyQ29tbWVudEJ1dHRvbigpIHsKICAgIHRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uPy5yZW1vdmUoKTsKICAgIHRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uID0gbnVsbDsKICB9CiAgc2V0Q29tbWVudEJ1dHRvblN0YXRlcyh7CiAgICBzZWxlY3RlZCwKICAgIGhhc1BvcHVwCiAgfSkgewogICAgaWYgKCF0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbi5jbGFzc0xpc3QudG9nZ2xlKCJzZWxlY3RlZCIsIHNlbGVjdGVkKTsKICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uLmFyaWFFeHBhbmRlZCA9IGhhc1BvcHVwOwogIH0KICAjcmVuZGVyKGNvbW1lbnQsIGlzU3RhbmRhbG9uZSkgewogICAgaWYgKCF0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5oYXNDb21tZW50TWFuYWdlcigpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29tbWVudC50YWJJbmRleCA9ICIwIjsKICAgIGNvbW1lbnQuYXJpYUhhc1BvcHVwID0gImRpYWxvZyI7CiAgICBpZiAoaXNTdGFuZGFsb25lKSB7CiAgICAgIGNvbW1lbnQuYXJpYUNvbnRyb2xzID0gImNvbW1lbnRQb3B1cCI7CiAgICAgIGNvbW1lbnQuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCAicGRmanMtc2hvdy1jb21tZW50LWJ1dHRvbiIpOwogICAgfSBlbHNlIHsKICAgICAgY29tbWVudC5hcmlhQ29udHJvbHNFbGVtZW50cyA9IFt0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5nZXRDb21tZW50RGlhbG9nRWxlbWVudCgpXTsKICAgICAgY29tbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1lZGl0b3ItYWRkLWNvbW1lbnQtYnV0dG9uIik7CiAgICB9CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5fc2lnbmFsOwogICAgaWYgKCEoc2lnbmFsIGluc3RhbmNlb2YgQWJvcnRTaWduYWwpIHx8IHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgIHJldHVybiBjb21tZW50OwogICAgfQogICAgY29tbWVudC5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIG5vQ29udGV4dE1lbnUsIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGlmIChpc1N0YW5kYWxvbmUpIHsKICAgICAgY29tbWVudC5hZGRFdmVudExpc3RlbmVyKCJmb2N1c2luIiwgKGUpID0+IHsKICAgICAgICB0aGlzLiNlZGl0b3IuX2ZvY3VzRXZlbnRzQWxsb3dlZCA9IGZhbHNlOwogICAgICAgIHN0b3BFdmVudChlKTsKICAgICAgfSwgewogICAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBjb21tZW50LmFkZEV2ZW50TGlzdGVuZXIoImZvY3Vzb3V0IiwgKGUpID0+IHsKICAgICAgICB0aGlzLiNlZGl0b3IuX2ZvY3VzRXZlbnRzQWxsb3dlZCA9IHRydWU7CiAgICAgICAgc3RvcEV2ZW50KGUpOwogICAgICB9LCB7CiAgICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICB9CiAgICBjb21tZW50LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgKGV2ZW50KSA9PiBldmVudC5zdG9wUHJvcGFnYXRpb24oKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgY29uc3Qgb25DbGljayA9IChldmVudCkgPT4gewogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICBpZiAoY29tbWVudCA9PT0gdGhpcy4jY29tbWVudFRvb2xiYXJCdXR0b24pIHsKICAgICAgICB0aGlzLmVkaXQoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiNlZGl0b3IudG9nZ2xlQ29tbWVudCh0cnVlKTsKICAgICAgfQogICAgfTsKICAgIGNvbW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBvbkNsaWNrLCB7CiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBjb21tZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCAoZXZlbnQpID0+IHsKICAgICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gY29tbWVudCAmJiBldmVudC5rZXkgPT09ICJFbnRlciIpIHsKICAgICAgICB0aGlzLiNjb21tZW50V2FzRnJvbUtleUJvYXJkID0gdHJ1ZTsKICAgICAgICBvbkNsaWNrKGV2ZW50KTsKICAgICAgfQogICAgfSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgY29tbWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZW50ZXIiLCAoKSA9PiB7CiAgICAgIHRoaXMuI2VkaXRvci50b2dnbGVDb21tZW50KGZhbHNlLCB0cnVlKTsKICAgIH0sIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGNvbW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmxlYXZlIiwgKCkgPT4gewogICAgICB0aGlzLiNlZGl0b3IudG9nZ2xlQ29tbWVudChmYWxzZSwgZmFsc2UpOwogICAgfSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgcmV0dXJuIGNvbW1lbnQ7CiAgfQogIGVkaXQob3B0aW9ucykgewogICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLmNvbW1lbnRQb3B1cFBvc2l0aW9uSW5MYXllcjsKICAgIGxldCBwb3NYLCBwb3NZOwogICAgaWYgKHBvc2l0aW9uKSB7CiAgICAgIFtwb3NYLCBwb3NZXSA9IHBvc2l0aW9uOwogICAgfSBlbHNlIHsKICAgICAgW3Bvc1gsIHBvc1ldID0gdGhpcy4jZWRpdG9yLmNvbW1lbnRCdXR0b25Qb3NpdGlvbjsKICAgICAgY29uc3QgewogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodCwKICAgICAgICB4LAogICAgICAgIHkKICAgICAgfSA9IHRoaXMuI2VkaXRvcjsKICAgICAgcG9zWCA9IHggKyBwb3NYICogd2lkdGg7CiAgICAgIHBvc1kgPSB5ICsgcG9zWSAqIGhlaWdodDsKICAgIH0KICAgIGNvbnN0IHBhcmVudERpbWVuc2lvbnMgPSB0aGlzLiNlZGl0b3IucGFyZW50LmJvdW5kaW5nQ2xpZW50UmVjdDsKICAgIGNvbnN0IHsKICAgICAgeDogcGFyZW50WCwKICAgICAgeTogcGFyZW50WSwKICAgICAgd2lkdGg6IHBhcmVudFdpZHRoLAogICAgICBoZWlnaHQ6IHBhcmVudEhlaWdodAogICAgfSA9IHBhcmVudERpbWVuc2lvbnM7CiAgICB0aGlzLiNlZGl0b3IuX3VpTWFuYWdlci5lZGl0Q29tbWVudCh0aGlzLiNlZGl0b3IsIHBhcmVudFggKyBwb3NYICogcGFyZW50V2lkdGgsIHBhcmVudFkgKyBwb3NZICogcGFyZW50SGVpZ2h0LCB7CiAgICAgIC4uLm9wdGlvbnMsCiAgICAgIHBhcmVudERpbWVuc2lvbnMKICAgIH0pOwogIH0KICBmaW5pc2goKSB7CiAgICBpZiAoIXRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnRUb29sYmFyQnV0dG9uLmZvY3VzKHsKICAgICAgZm9jdXNWaXNpYmxlOiB0aGlzLiNjb21tZW50V2FzRnJvbUtleUJvYXJkCiAgICB9KTsKICAgIHRoaXMuI2NvbW1lbnRXYXNGcm9tS2V5Qm9hcmQgPSBmYWxzZTsKICB9CiAgaXNEZWxldGVkKCkgewogICAgcmV0dXJuIHRoaXMuI2RlbGV0ZWQgfHwgdGhpcy4jdGV4dCA9PT0gIiI7CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy4jdGV4dCA9PT0gbnVsbDsKICB9CiAgaGFzQmVlbkVkaXRlZCgpIHsKICAgIHJldHVybiB0aGlzLmlzRGVsZXRlZCgpIHx8IHRoaXMuI3RleHQgIT09IHRoaXMuI2luaXRpYWxUZXh0OwogIH0KICBzZXJpYWxpemUoKSB7CiAgICByZXR1cm4gdGhpcy5kYXRhOwogIH0KICBnZXQgZGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIHRleHQ6IHRoaXMuI3RleHQsCiAgICAgIHJpY2hUZXh0OiB0aGlzLiNyaWNoVGV4dCwKICAgICAgZGF0ZTogdGhpcy4jZGF0ZSwKICAgICAgZGVsZXRlZDogdGhpcy5pc0RlbGV0ZWQoKQogICAgfTsKICB9CiAgc2V0IGRhdGEodGV4dCkgewogICAgaWYgKHRleHQgIT09IHRoaXMuI3RleHQpIHsKICAgICAgdGhpcy4jcmljaFRleHQgPSBudWxsOwogICAgfQogICAgaWYgKHRleHQgPT09IG51bGwpIHsKICAgICAgdGhpcy4jdGV4dCA9ICIiOwogICAgICB0aGlzLiNkZWxldGVkID0gdHJ1ZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jdGV4dCA9IHRleHQ7CiAgICB0aGlzLiNkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CiAgICB0aGlzLiNkZWxldGVkID0gZmFsc2U7CiAgfQogIHNldEluaXRpYWxUZXh0KHRleHQsIHJpY2hUZXh0ID0gbnVsbCkgewogICAgdGhpcy4jaW5pdGlhbFRleHQgPSB0ZXh0OwogICAgdGhpcy5kYXRhID0gdGV4dDsKICAgIHRoaXMuI2RhdGUgPSBudWxsOwogICAgdGhpcy4jcmljaFRleHQgPSByaWNoVGV4dDsKICB9CiAgc2hvd24oKSB7CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLiNjb21tZW50VG9vbGJhckJ1dHRvbj8ucmVtb3ZlKCk7CiAgICB0aGlzLiNjb21tZW50VG9vbGJhckJ1dHRvbiA9IG51bGw7CiAgICB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbj8ucmVtb3ZlKCk7CiAgICB0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbiA9IG51bGw7CiAgICB0aGlzLiN0ZXh0ID0gIiI7CiAgICB0aGlzLiNyaWNoVGV4dCA9IG51bGw7CiAgICB0aGlzLiNkYXRlID0gbnVsbDsKICAgIHRoaXMuI2VkaXRvciA9IG51bGw7CiAgICB0aGlzLiNjb21tZW50V2FzRnJvbUtleUJvYXJkID0gZmFsc2U7CiAgICB0aGlzLiNkZWxldGVkID0gZmFsc2U7CiAgfQp9Owp2YXIgVG91Y2hNYW5hZ2VyID0gY2xhc3MgX1RvdWNoTWFuYWdlciB7CiAgI2NvbnRhaW5lcjsKICAjaXNQaW5jaGluZyA9IGZhbHNlOwogICNpc1BpbmNoaW5nU3RvcHBlZCA9IG51bGw7CiAgI2lzUGluY2hpbmdEaXNhYmxlZDsKICAjb25QaW5jaFN0YXJ0OwogICNvblBpbmNoaW5nOwogICNvblBpbmNoRW5kOwogICNwb2ludGVyRG93bkFDID0gbnVsbDsKICAjc2lnbmFsOwogICN0b3VjaEluZm8gPSBudWxsOwogICN0b3VjaE1hbmFnZXJBQzsKICAjdG91Y2hNb3ZlQUMgPSBudWxsOwogIGNvbnN0cnVjdG9yKHsKICAgIGNvbnRhaW5lcjogY29udGFpbmVyMiwKICAgIGlzUGluY2hpbmdEaXNhYmxlZCA9IG51bGwsCiAgICBpc1BpbmNoaW5nU3RvcHBlZCA9IG51bGwsCiAgICBvblBpbmNoU3RhcnQgPSBudWxsLAogICAgb25QaW5jaGluZyA9IG51bGwsCiAgICBvblBpbmNoRW5kID0gbnVsbCwKICAgIHNpZ25hbAogIH0pIHsKICAgIHRoaXMuI2NvbnRhaW5lciA9IGNvbnRhaW5lcjI7CiAgICB0aGlzLiNpc1BpbmNoaW5nU3RvcHBlZCA9IGlzUGluY2hpbmdTdG9wcGVkOwogICAgdGhpcy4jaXNQaW5jaGluZ0Rpc2FibGVkID0gaXNQaW5jaGluZ0Rpc2FibGVkOwogICAgdGhpcy4jb25QaW5jaFN0YXJ0ID0gb25QaW5jaFN0YXJ0OwogICAgdGhpcy4jb25QaW5jaGluZyA9IG9uUGluY2hpbmc7CiAgICB0aGlzLiNvblBpbmNoRW5kID0gb25QaW5jaEVuZDsKICAgIHRoaXMuI3RvdWNoTWFuYWdlckFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgdGhpcy4jc2lnbmFsID0gQWJvcnRTaWduYWwuYW55KFtzaWduYWwsIHRoaXMuI3RvdWNoTWFuYWdlckFDLnNpZ25hbF0pOwogICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaHN0YXJ0IiwgdGhpcy4jb25Ub3VjaFN0YXJ0LmJpbmQodGhpcyksIHsKICAgICAgcGFzc2l2ZTogZmFsc2UsCiAgICAgIHNpZ25hbDogdGhpcy4jc2lnbmFsCiAgICB9KTsKICB9CiAgZ2V0IE1JTl9UT1VDSF9ESVNUQU5DRV9UT19QSU5DSCgpIHsKICAgIHJldHVybiAzNSAvIE91dHB1dFNjYWxlLnBpeGVsUmF0aW87CiAgfQogICNvblRvdWNoU3RhcnQoZXZ0KSB7CiAgICBpZiAodGhpcy4jaXNQaW5jaGluZ0Rpc2FibGVkPy4oKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZ0LnRvdWNoZXMubGVuZ3RoID09PSAxKSB7CiAgICAgIGlmICh0aGlzLiNwb2ludGVyRG93bkFDKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHBvaW50ZXJEb3duQUMgPSB0aGlzLiNwb2ludGVyRG93bkFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgICBjb25zdCBzaWduYWwgPSBBYm9ydFNpZ25hbC5hbnkoW3RoaXMuI3NpZ25hbCwgcG9pbnRlckRvd25BQy5zaWduYWxdKTsKICAgICAgY29uc3QgY29udGFpbmVyMiA9IHRoaXMuI2NvbnRhaW5lcjsKICAgICAgY29uc3Qgb3B0cyA9IHsKICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgIHNpZ25hbCwKICAgICAgICBwYXNzaXZlOiBmYWxzZQogICAgICB9OwogICAgICBjb25zdCBjYW5jZWxQb2ludGVyRG93biA9IChlKSA9PiB7CiAgICAgICAgaWYgKGUucG9pbnRlclR5cGUgPT09ICJ0b3VjaCIpIHsKICAgICAgICAgIHRoaXMuI3BvaW50ZXJEb3duQUM/LmFib3J0KCk7CiAgICAgICAgICB0aGlzLiNwb2ludGVyRG93bkFDID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnRhaW5lcjIuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmRvd24iLCAoZSkgPT4gewogICAgICAgIGlmIChlLnBvaW50ZXJUeXBlID09PSAidG91Y2giKSB7CiAgICAgICAgICBzdG9wRXZlbnQoZSk7CiAgICAgICAgICBjYW5jZWxQb2ludGVyRG93bihlKTsKICAgICAgICB9CiAgICAgIH0sIG9wdHMpOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIGNhbmNlbFBvaW50ZXJEb3duLCBvcHRzKTsKICAgICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyY2FuY2VsIiwgY2FuY2VsUG9pbnRlckRvd24sIG9wdHMpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI3RvdWNoTW92ZUFDKSB7CiAgICAgIHRoaXMuI3RvdWNoTW92ZUFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgICBjb25zdCBzaWduYWwgPSBBYm9ydFNpZ25hbC5hbnkoW3RoaXMuI3NpZ25hbCwgdGhpcy4jdG91Y2hNb3ZlQUMuc2lnbmFsXSk7CiAgICAgIGNvbnN0IGNvbnRhaW5lcjIgPSB0aGlzLiNjb250YWluZXI7CiAgICAgIGNvbnN0IG9wdCA9IHsKICAgICAgICBzaWduYWwsCiAgICAgICAgY2FwdHVyZTogZmFsc2UsCiAgICAgICAgcGFzc2l2ZTogZmFsc2UKICAgICAgfTsKICAgICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaG1vdmUiLCB0aGlzLiNvblRvdWNoTW92ZS5iaW5kKHRoaXMpLCBvcHQpOwogICAgICBjb25zdCBvblRvdWNoRW5kID0gdGhpcy4jb25Ub3VjaEVuZC5iaW5kKHRoaXMpOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInRvdWNoZW5kIiwgb25Ub3VjaEVuZCwgb3B0KTsKICAgICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaGNhbmNlbCIsIG9uVG91Y2hFbmQsIG9wdCk7CiAgICAgIG9wdC5jYXB0dXJlID0gdHJ1ZTsKICAgICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHN0b3BFdmVudCwgb3B0KTsKICAgICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybW92ZSIsIHN0b3BFdmVudCwgb3B0KTsKICAgICAgY29udGFpbmVyMi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyY2FuY2VsIiwgc3RvcEV2ZW50LCBvcHQpOwogICAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHN0b3BFdmVudCwgb3B0KTsKICAgICAgdGhpcy4jb25QaW5jaFN0YXJ0Py4oKTsKICAgIH0KICAgIHN0b3BFdmVudChldnQpOwogICAgaWYgKGV2dC50b3VjaGVzLmxlbmd0aCAhPT0gMiB8fCB0aGlzLiNpc1BpbmNoaW5nU3RvcHBlZD8uKCkpIHsKICAgICAgdGhpcy4jdG91Y2hJbmZvID0gbnVsbDsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IFt0b3VjaDAsIHRvdWNoMV0gPSBldnQudG91Y2hlczsKICAgIGlmICh0b3VjaDAuaWRlbnRpZmllciA+IHRvdWNoMS5pZGVudGlmaWVyKSB7CiAgICAgIFt0b3VjaDAsIHRvdWNoMV0gPSBbdG91Y2gxLCB0b3VjaDBdOwogICAgfQogICAgdGhpcy4jdG91Y2hJbmZvID0gewogICAgICB0b3VjaDBYOiB0b3VjaDAuc2NyZWVuWCwKICAgICAgdG91Y2gwWTogdG91Y2gwLnNjcmVlblksCiAgICAgIHRvdWNoMVg6IHRvdWNoMS5zY3JlZW5YLAogICAgICB0b3VjaDFZOiB0b3VjaDEuc2NyZWVuWQogICAgfTsKICB9CiAgI29uVG91Y2hNb3ZlKGV2dCkgewogICAgaWYgKCF0aGlzLiN0b3VjaEluZm8gfHwgZXZ0LnRvdWNoZXMubGVuZ3RoICE9PSAyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN0b3BFdmVudChldnQpOwogICAgbGV0IFt0b3VjaDAsIHRvdWNoMV0gPSBldnQudG91Y2hlczsKICAgIGlmICh0b3VjaDAuaWRlbnRpZmllciA+IHRvdWNoMS5pZGVudGlmaWVyKSB7CiAgICAgIFt0b3VjaDAsIHRvdWNoMV0gPSBbdG91Y2gxLCB0b3VjaDBdOwogICAgfQogICAgY29uc3QgewogICAgICBzY3JlZW5YOiBzY3JlZW4wWCwKICAgICAgc2NyZWVuWTogc2NyZWVuMFkKICAgIH0gPSB0b3VjaDA7CiAgICBjb25zdCB7CiAgICAgIHNjcmVlblg6IHNjcmVlbjFYLAogICAgICBzY3JlZW5ZOiBzY3JlZW4xWQogICAgfSA9IHRvdWNoMTsKICAgIGNvbnN0IHRvdWNoSW5mbyA9IHRoaXMuI3RvdWNoSW5mbzsKICAgIGNvbnN0IHsKICAgICAgdG91Y2gwWDogcFRvdWNoMFgsCiAgICAgIHRvdWNoMFk6IHBUb3VjaDBZLAogICAgICB0b3VjaDFYOiBwVG91Y2gxWCwKICAgICAgdG91Y2gxWTogcFRvdWNoMVkKICAgIH0gPSB0b3VjaEluZm87CiAgICBjb25zdCBwcmV2R2FwWCA9IHBUb3VjaDFYIC0gcFRvdWNoMFg7CiAgICBjb25zdCBwcmV2R2FwWSA9IHBUb3VjaDFZIC0gcFRvdWNoMFk7CiAgICBjb25zdCBjdXJyR2FwWCA9IHNjcmVlbjFYIC0gc2NyZWVuMFg7CiAgICBjb25zdCBjdXJyR2FwWSA9IHNjcmVlbjFZIC0gc2NyZWVuMFk7CiAgICBjb25zdCBkaXN0YW5jZSA9IE1hdGguaHlwb3QoY3VyckdhcFgsIGN1cnJHYXBZKSB8fCAxOwogICAgY29uc3QgcERpc3RhbmNlID0gTWF0aC5oeXBvdChwcmV2R2FwWCwgcHJldkdhcFkpIHx8IDE7CiAgICBpZiAoIXRoaXMuI2lzUGluY2hpbmcgJiYgTWF0aC5hYnMocERpc3RhbmNlIC0gZGlzdGFuY2UpIDw9IF9Ub3VjaE1hbmFnZXIuTUlOX1RPVUNIX0RJU1RBTkNFX1RPX1BJTkNIKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRvdWNoSW5mby50b3VjaDBYID0gc2NyZWVuMFg7CiAgICB0b3VjaEluZm8udG91Y2gwWSA9IHNjcmVlbjBZOwogICAgdG91Y2hJbmZvLnRvdWNoMVggPSBzY3JlZW4xWDsKICAgIHRvdWNoSW5mby50b3VjaDFZID0gc2NyZWVuMVk7CiAgICBpZiAoIXRoaXMuI2lzUGluY2hpbmcpIHsKICAgICAgdGhpcy4jaXNQaW5jaGluZyA9IHRydWU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IG9yaWdpbiA9IFsoc2NyZWVuMFggKyBzY3JlZW4xWCkgLyAyLCAoc2NyZWVuMFkgKyBzY3JlZW4xWSkgLyAyXTsKICAgIHRoaXMuI29uUGluY2hpbmc/LihvcmlnaW4sIHBEaXN0YW5jZSwgZGlzdGFuY2UpOwogIH0KICAjb25Ub3VjaEVuZChldnQpIHsKICAgIGlmIChldnQudG91Y2hlcy5sZW5ndGggPj0gMikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jdG91Y2hNb3ZlQUMpIHsKICAgICAgdGhpcy4jdG91Y2hNb3ZlQUMuYWJvcnQoKTsKICAgICAgdGhpcy4jdG91Y2hNb3ZlQUMgPSBudWxsOwogICAgICB0aGlzLiNvblBpbmNoRW5kPy4oKTsKICAgIH0KICAgIGlmICghdGhpcy4jdG91Y2hJbmZvKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN0b3BFdmVudChldnQpOwogICAgdGhpcy4jdG91Y2hJbmZvID0gbnVsbDsKICAgIHRoaXMuI2lzUGluY2hpbmcgPSBmYWxzZTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI3RvdWNoTWFuYWdlckFDPy5hYm9ydCgpOwogICAgdGhpcy4jdG91Y2hNYW5hZ2VyQUMgPSBudWxsOwogICAgdGhpcy4jcG9pbnRlckRvd25BQz8uYWJvcnQoKTsKICAgIHRoaXMuI3BvaW50ZXJEb3duQUMgPSBudWxsOwogIH0KfTsKdmFyIEFubm90YXRpb25FZGl0b3IgPSBjbGFzcyBfQW5ub3RhdGlvbkVkaXRvciB7CiAgI2FjY2Vzc2liaWxpdHlEYXRhID0gbnVsbDsKICAjYWxsUmVzaXplckRpdnMgPSBudWxsOwogICNhbHRUZXh0ID0gbnVsbDsKICAjY29tbWVudCA9IG51bGw7CiAgI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uID0gbnVsbDsKICAjZGlzYWJsZWQgPSBmYWxzZTsKICAjZHJhZ1BvaW50ZXJJZCA9IG51bGw7CiAgI2RyYWdQb2ludGVyVHlwZSA9ICIiOwogICNyZXNpemVyc0RpdiA9IG51bGw7CiAgI2xhc3RQb2ludGVyQ29vcmRzID0gbnVsbDsKICAjc2F2ZWREaW1lbnNpb25zID0gbnVsbDsKICAjZmFrZUFubm90YXRpb24gPSBudWxsOwogICNmb2N1c0FDID0gbnVsbDsKICAjZm9jdXNlZFJlc2l6ZXJOYW1lID0gIiI7CiAgI2hhc0JlZW5DbGlja2VkID0gZmFsc2U7CiAgI2luaXRpYWxSZWN0ID0gbnVsbDsKICAjaXNFZGl0aW5nID0gZmFsc2U7CiAgI2lzSW5FZGl0TW9kZSA9IGZhbHNlOwogICNpc1Jlc2l6ZXJFbmFibGVkRm9yS2V5Ym9hcmQgPSBmYWxzZTsKICAjbW92ZUluRE9NVGltZW91dCA9IG51bGw7CiAgI3ByZXZEcmFnWCA9IDA7CiAgI3ByZXZEcmFnWSA9IDA7CiAgI3RlbGVtZXRyeVRpbWVvdXRzID0gbnVsbDsKICAjdG91Y2hNYW5hZ2VyID0gbnVsbDsKICBpc1NlbGVjdGVkID0gZmFsc2U7CiAgX2lzQ29weSA9IGZhbHNlOwogIF9lZGl0VG9vbGJhciA9IG51bGw7CiAgX2luaXRpYWxPcHRpb25zID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgX2luaXRpYWxEYXRhID0gbnVsbDsKICBfaXNWaXNpYmxlID0gdHJ1ZTsKICBfdWlNYW5hZ2VyID0gbnVsbDsKICBfZm9jdXNFdmVudHNBbGxvd2VkID0gdHJ1ZTsKICBzdGF0aWMgX2wxMG4gPSBudWxsOwogIHN0YXRpYyBfbDEwblJlc2l6ZXIgPSBudWxsOwogICNpc0RyYWdnYWJsZSA9IGZhbHNlOwogICN6SW5kZXggPSBfQW5ub3RhdGlvbkVkaXRvci5fekluZGV4Kys7CiAgc3RhdGljIF9ib3JkZXJMaW5lV2lkdGggPSAtMTsKICBzdGF0aWMgX2NvbG9yTWFuYWdlciA9IG5ldyBDb2xvck1hbmFnZXIoKTsKICBzdGF0aWMgX3pJbmRleCA9IDE7CiAgc3RhdGljIF90ZWxlbWV0cnlUaW1lb3V0ID0gMWUzOwogIHN0YXRpYyBnZXQgX3Jlc2l6ZXJLZXlib2FyZE1hbmFnZXIoKSB7CiAgICBjb25zdCByZXNpemUgPSBfQW5ub3RhdGlvbkVkaXRvci5wcm90b3R5cGUuX3Jlc2l6ZVdpdGhLZXlib2FyZDsKICAgIGNvbnN0IHNtYWxsID0gQW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlci5UUkFOU0xBVEVfU01BTEw7CiAgICBjb25zdCBiaWcgPSBBbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyLlRSQU5TTEFURV9CSUc7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfcmVzaXplcktleWJvYXJkTWFuYWdlciIsIG5ldyBLZXlib2FyZE1hbmFnZXIoW1tbIkFycm93TGVmdCIsICJtYWMrQXJyb3dMZWZ0Il0sIHJlc2l6ZSwgewogICAgICBhcmdzOiBbLXNtYWxsLCAwXQogICAgfV0sIFtbImN0cmwrQXJyb3dMZWZ0IiwgIm1hYytzaGlmdCtBcnJvd0xlZnQiXSwgcmVzaXplLCB7CiAgICAgIGFyZ3M6IFstYmlnLCAwXQogICAgfV0sIFtbIkFycm93UmlnaHQiLCAibWFjK0Fycm93UmlnaHQiXSwgcmVzaXplLCB7CiAgICAgIGFyZ3M6IFtzbWFsbCwgMF0KICAgIH1dLCBbWyJjdHJsK0Fycm93UmlnaHQiLCAibWFjK3NoaWZ0K0Fycm93UmlnaHQiXSwgcmVzaXplLCB7CiAgICAgIGFyZ3M6IFtiaWcsIDBdCiAgICB9XSwgW1siQXJyb3dVcCIsICJtYWMrQXJyb3dVcCJdLCByZXNpemUsIHsKICAgICAgYXJnczogWzAsIC1zbWFsbF0KICAgIH1dLCBbWyJjdHJsK0Fycm93VXAiLCAibWFjK3NoaWZ0K0Fycm93VXAiXSwgcmVzaXplLCB7CiAgICAgIGFyZ3M6IFswLCAtYmlnXQogICAgfV0sIFtbIkFycm93RG93biIsICJtYWMrQXJyb3dEb3duIl0sIHJlc2l6ZSwgewogICAgICBhcmdzOiBbMCwgc21hbGxdCiAgICB9XSwgW1siY3RybCtBcnJvd0Rvd24iLCAibWFjK3NoaWZ0K0Fycm93RG93biJdLCByZXNpemUsIHsKICAgICAgYXJnczogWzAsIGJpZ10KICAgIH1dLCBbWyJFc2NhcGUiLCAibWFjK0VzY2FwZSJdLCBfQW5ub3RhdGlvbkVkaXRvci5wcm90b3R5cGUuX3N0b3BSZXNpemluZ1dpdGhLZXlib2FyZF1dKSk7CiAgfQogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHRoaXMucGFyZW50ID0gcGFyYW1ldGVycy5wYXJlbnQ7CiAgICB0aGlzLmlkID0gcGFyYW1ldGVycy5pZDsKICAgIHRoaXMud2lkdGggPSB0aGlzLmhlaWdodCA9IG51bGw7CiAgICB0aGlzLnBhZ2VJbmRleCA9IHBhcmFtZXRlcnMucGFyZW50LnBhZ2VJbmRleDsKICAgIHRoaXMubmFtZSA9IHBhcmFtZXRlcnMubmFtZTsKICAgIHRoaXMuZGl2ID0gbnVsbDsKICAgIHRoaXMuX3VpTWFuYWdlciA9IHBhcmFtZXRlcnMudWlNYW5hZ2VyOwogICAgdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkID0gbnVsbDsKICAgIHRoaXMuX3dpbGxLZWVwQXNwZWN0UmF0aW8gPSBmYWxzZTsKICAgIHRoaXMuX2luaXRpYWxPcHRpb25zLmlzQ2VudGVyZWQgPSBwYXJhbWV0ZXJzLmlzQ2VudGVyZWQ7CiAgICB0aGlzLl9zdHJ1Y3RUcmVlUGFyZW50SWQgPSBudWxsOwogICAgdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkID0gcGFyYW1ldGVycy5hbm5vdGF0aW9uRWxlbWVudElkIHx8IG51bGw7CiAgICB0aGlzLmNyZWF0aW9uRGF0ZSA9IHBhcmFtZXRlcnMuY3JlYXRpb25EYXRlIHx8IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogICAgdGhpcy5tb2RpZmljYXRpb25EYXRlID0gcGFyYW1ldGVycy5tb2RpZmljYXRpb25EYXRlIHx8IG51bGw7CiAgICB0aGlzLmNhbkFkZENvbW1lbnQgPSB0cnVlOwogICAgY29uc3QgewogICAgICByb3RhdGlvbiwKICAgICAgcmF3RGltczogewogICAgICAgIHBhZ2VXaWR0aCwKICAgICAgICBwYWdlSGVpZ2h0LAogICAgICAgIHBhZ2VYLAogICAgICAgIHBhZ2VZCiAgICAgIH0KICAgIH0gPSB0aGlzLnBhcmVudC52aWV3cG9ydDsKICAgIHRoaXMucm90YXRpb24gPSByb3RhdGlvbjsKICAgIHRoaXMucGFnZVJvdGF0aW9uID0gKDM2MCArIHJvdGF0aW9uIC0gdGhpcy5fdWlNYW5hZ2VyLnZpZXdQYXJhbWV0ZXJzLnJvdGF0aW9uKSAlIDM2MDsKICAgIHRoaXMucGFnZURpbWVuc2lvbnMgPSBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XTsKICAgIHRoaXMucGFnZVRyYW5zbGF0aW9uID0gW3BhZ2VYLCBwYWdlWV07CiAgICBjb25zdCBbd2lkdGgsIGhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICB0aGlzLnggPSBwYXJhbWV0ZXJzLnggLyB3aWR0aDsKICAgIHRoaXMueSA9IHBhcmFtZXRlcnMueSAvIGhlaWdodDsKICAgIHRoaXMuaXNBdHRhY2hlZFRvRE9NID0gZmFsc2U7CiAgICB0aGlzLmRlbGV0ZWQgPSBmYWxzZTsKICB9CiAgZ2V0IGVkaXRvclR5cGUoKSB7CiAgICByZXR1cm4gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLmNvbnN0cnVjdG9yLl90eXBlOwogIH0KICBnZXQgbW9kZSgpIHsKICAgIHJldHVybiBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3IuX2VkaXRvclR5cGU7CiAgfQogIHN0YXRpYyBnZXQgaXNEcmF3ZXIoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHN0YXRpYyBnZXQgX2RlZmF1bHRMaW5lQ29sb3IoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfZGVmYXVsdExpbmVDb2xvciIsIHRoaXMuX2NvbG9yTWFuYWdlci5nZXRIZXhDb2RlKCJDYW52YXNUZXh0IikpOwogIH0KICBzdGF0aWMgZGVsZXRlQW5ub3RhdGlvbkVsZW1lbnQoZWRpdG9yKSB7CiAgICBjb25zdCBmYWtlRWRpdG9yID0gbmV3IEZha2VFZGl0b3IoewogICAgICBpZDogZWRpdG9yLnBhcmVudC5nZXROZXh0SWQoKSwKICAgICAgcGFyZW50OiBlZGl0b3IucGFyZW50LAogICAgICB1aU1hbmFnZXI6IGVkaXRvci5fdWlNYW5hZ2VyCiAgICB9KTsKICAgIGZha2VFZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCA9IGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkOwogICAgZmFrZUVkaXRvci5kZWxldGVkID0gdHJ1ZTsKICAgIGZha2VFZGl0b3IuX3VpTWFuYWdlci5hZGRUb0Fubm90YXRpb25TdG9yYWdlKGZha2VFZGl0b3IpOwogIH0KICBzdGF0aWMgaW5pdGlhbGl6ZShsMTBuLCBfdWlNYW5hZ2VyKSB7CiAgICBfQW5ub3RhdGlvbkVkaXRvci5fbDEwbiA/Pz0gbDEwbjsKICAgIF9Bbm5vdGF0aW9uRWRpdG9yLl9sMTBuUmVzaXplciB8fD0gT2JqZWN0LmZyZWV6ZSh7CiAgICAgIHRvcExlZnQ6ICJwZGZqcy1lZGl0b3ItcmVzaXplci10b3AtbGVmdCIsCiAgICAgIHRvcE1pZGRsZTogInBkZmpzLWVkaXRvci1yZXNpemVyLXRvcC1taWRkbGUiLAogICAgICB0b3BSaWdodDogInBkZmpzLWVkaXRvci1yZXNpemVyLXRvcC1yaWdodCIsCiAgICAgIG1pZGRsZVJpZ2h0OiAicGRmanMtZWRpdG9yLXJlc2l6ZXItbWlkZGxlLXJpZ2h0IiwKICAgICAgYm90dG9tUmlnaHQ6ICJwZGZqcy1lZGl0b3ItcmVzaXplci1ib3R0b20tcmlnaHQiLAogICAgICBib3R0b21NaWRkbGU6ICJwZGZqcy1lZGl0b3ItcmVzaXplci1ib3R0b20tbWlkZGxlIiwKICAgICAgYm90dG9tTGVmdDogInBkZmpzLWVkaXRvci1yZXNpemVyLWJvdHRvbS1sZWZ0IiwKICAgICAgbWlkZGxlTGVmdDogInBkZmpzLWVkaXRvci1yZXNpemVyLW1pZGRsZS1sZWZ0IgogICAgfSk7CiAgICBpZiAoX0Fubm90YXRpb25FZGl0b3IuX2JvcmRlckxpbmVXaWR0aCAhPT0gLTEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc3R5bGUgPSBnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7CiAgICBfQW5ub3RhdGlvbkVkaXRvci5fYm9yZGVyTGluZVdpZHRoID0gcGFyc2VGbG9hdChzdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCItLW91dGxpbmUtd2lkdGgiKSkgfHwgMDsKICB9CiAgc3RhdGljIHVwZGF0ZURlZmF1bHRQYXJhbXMoX3R5cGUsIF92YWx1ZSkgewogIH0KICBzdGF0aWMgZ2V0IGRlZmF1bHRQcm9wZXJ0aWVzVG9VcGRhdGUoKSB7CiAgICByZXR1cm4gW107CiAgfQogIHN0YXRpYyBpc0hhbmRsaW5nTWltZUZvclBhc3RpbmcobWltZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBzdGF0aWMgcGFzdGUoaXRlbSwgcGFyZW50KSB7CiAgICB1bnJlYWNoYWJsZSgiTm90IGltcGxlbWVudGVkIik7CiAgfQogIGdldCBwcm9wZXJ0aWVzVG9VcGRhdGUoKSB7CiAgICByZXR1cm4gW107CiAgfQogIGdldCBfaXNEcmFnZ2FibGUoKSB7CiAgICByZXR1cm4gdGhpcy4jaXNEcmFnZ2FibGU7CiAgfQogIHNldCBfaXNEcmFnZ2FibGUodmFsdWUpIHsKICAgIHRoaXMuI2lzRHJhZ2dhYmxlID0gdmFsdWU7CiAgICB0aGlzLmRpdj8uY2xhc3NMaXN0LnRvZ2dsZSgiZHJhZ2dhYmxlIiwgdmFsdWUpOwogIH0KICBnZXQgdWlkKCkgewogICAgcmV0dXJuIHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCB8fCB0aGlzLmlkOwogIH0KICBnZXQgaXNFbnRlckhhbmRsZWQoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgY2VudGVyKCkgewogICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhZ2VEaW1lbnNpb25zOwogICAgc3dpdGNoICh0aGlzLnBhcmVudFJvdGF0aW9uKSB7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgdGhpcy54IC09IHRoaXMuaGVpZ2h0ICogcGFnZUhlaWdodCAvIChwYWdlV2lkdGggKiAyKTsKICAgICAgICB0aGlzLnkgKz0gdGhpcy53aWR0aCAqIHBhZ2VXaWR0aCAvIChwYWdlSGVpZ2h0ICogMik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHRoaXMueCArPSB0aGlzLndpZHRoIC8gMjsKICAgICAgICB0aGlzLnkgKz0gdGhpcy5oZWlnaHQgLyAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI3MDoKICAgICAgICB0aGlzLnggKz0gdGhpcy5oZWlnaHQgKiBwYWdlSGVpZ2h0IC8gKHBhZ2VXaWR0aCAqIDIpOwogICAgICAgIHRoaXMueSAtPSB0aGlzLndpZHRoICogcGFnZVdpZHRoIC8gKHBhZ2VIZWlnaHQgKiAyKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aGlzLnggLT0gdGhpcy53aWR0aCAvIDI7CiAgICAgICAgdGhpcy55IC09IHRoaXMuaGVpZ2h0IC8gMjsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICB9CiAgYWRkQ29tbWFuZHMocGFyYW1zKSB7CiAgICB0aGlzLl91aU1hbmFnZXIuYWRkQ29tbWFuZHMocGFyYW1zKTsKICB9CiAgZ2V0IGN1cnJlbnRMYXllcigpIHsKICAgIHJldHVybiB0aGlzLl91aU1hbmFnZXIuY3VycmVudExheWVyOwogIH0KICBzZXRJbkJhY2tncm91bmQoKSB7CiAgICB0aGlzLmRpdi5zdHlsZS56SW5kZXggPSAwOwogIH0KICBzZXRJbkZvcmVncm91bmQoKSB7CiAgICB0aGlzLmRpdi5zdHlsZS56SW5kZXggPSB0aGlzLiN6SW5kZXg7CiAgfQogIHNldFBhcmVudChwYXJlbnQpIHsKICAgIGlmIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgdGhpcy5wYWdlSW5kZXggPSBwYXJlbnQucGFnZUluZGV4OwogICAgICB0aGlzLnBhZ2VEaW1lbnNpb25zID0gcGFyZW50LnBhZ2VEaW1lbnNpb25zOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jc3RvcFJlc2l6aW5nKCk7CiAgICAgIHRoaXMuI2Zha2VBbm5vdGF0aW9uPy5yZW1vdmUoKTsKICAgICAgdGhpcy4jZmFrZUFubm90YXRpb24gPSBudWxsOwogICAgfQogICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgfQogIGZvY3VzaW4oZXZlbnQpIHsKICAgIGlmICghdGhpcy5fZm9jdXNFdmVudHNBbGxvd2VkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy4jaGFzQmVlbkNsaWNrZWQpIHsKICAgICAgdGhpcy5wYXJlbnQuc2V0U2VsZWN0ZWQodGhpcyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNoYXNCZWVuQ2xpY2tlZCA9IGZhbHNlOwogICAgfQogIH0KICBmb2N1c291dChldmVudCkgewogICAgaWYgKCF0aGlzLl9mb2N1c0V2ZW50c0FsbG93ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLmlzQXR0YWNoZWRUb0RPTSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB0YXJnZXQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwogICAgaWYgKHRhcmdldD8uY2xvc2VzdChgIyR7dGhpcy5pZH1gKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgaWYgKCF0aGlzLnBhcmVudD8uaXNNdWx0aXBsZVNlbGVjdGlvbikgewogICAgICB0aGlzLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICB9CiAgfQogIGNvbW1pdE9yUmVtb3ZlKCkgewogICAgaWYgKHRoaXMuaXNFbXB0eSgpKSB7CiAgICAgIHRoaXMucmVtb3ZlKCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmNvbW1pdCgpOwogICAgfQogIH0KICBjb21taXQoKSB7CiAgICBpZiAoIXRoaXMuaXNJbkVkaXRNb2RlKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5hZGRUb0Fubm90YXRpb25TdG9yYWdlKCk7CiAgfQogIGFkZFRvQW5ub3RhdGlvblN0b3JhZ2UoKSB7CiAgICB0aGlzLl91aU1hbmFnZXIuYWRkVG9Bbm5vdGF0aW9uU3RvcmFnZSh0aGlzKTsKICB9CiAgc2V0QXQoeCwgeSwgdHgsIHR5KSB7CiAgICBjb25zdCBbd2lkdGgsIGhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICBbdHgsIHR5XSA9IHRoaXMuc2NyZWVuVG9QYWdlVHJhbnNsYXRpb24odHgsIHR5KTsKICAgIHRoaXMueCA9ICh4ICsgdHgpIC8gd2lkdGg7CiAgICB0aGlzLnkgPSAoeSArIHR5KSAvIGhlaWdodDsKICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICB9CiAgX21vdmVBZnRlclBhc3RlKGJhc2VYLCBiYXNlWSkgewogICAgY29uc3QgW3BhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdID0gdGhpcy5wYXJlbnREaW1lbnNpb25zOwogICAgdGhpcy5zZXRBdChiYXNlWCAqIHBhcmVudFdpZHRoLCBiYXNlWSAqIHBhcmVudEhlaWdodCwgdGhpcy53aWR0aCAqIHBhcmVudFdpZHRoLCB0aGlzLmhlaWdodCAqIHBhcmVudEhlaWdodCk7CiAgICB0aGlzLl9vblRyYW5zbGF0ZWQoKTsKICB9CiAgI3RyYW5zbGF0ZShbd2lkdGgsIGhlaWdodF0sIHgsIHkpIHsKICAgIFt4LCB5XSA9IHRoaXMuc2NyZWVuVG9QYWdlVHJhbnNsYXRpb24oeCwgeSk7CiAgICB0aGlzLnggKz0geCAvIHdpZHRoOwogICAgdGhpcy55ICs9IHkgLyBoZWlnaHQ7CiAgICB0aGlzLl9vblRyYW5zbGF0aW5nKHRoaXMueCwgdGhpcy55KTsKICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICB9CiAgdHJhbnNsYXRlKHgsIHkpIHsKICAgIHRoaXMuI3RyYW5zbGF0ZSh0aGlzLnBhcmVudERpbWVuc2lvbnMsIHgsIHkpOwogIH0KICB0cmFuc2xhdGVJblBhZ2UoeCwgeSkgewogICAgdGhpcy4jaW5pdGlhbFJlY3QgfHw9IFt0aGlzLngsIHRoaXMueSwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHRdOwogICAgdGhpcy4jdHJhbnNsYXRlKHRoaXMucGFnZURpbWVuc2lvbnMsIHgsIHkpOwogICAgdGhpcy5kaXYuc2Nyb2xsSW50b1ZpZXcoewogICAgICBibG9jazogIm5lYXJlc3QiCiAgICB9KTsKICB9CiAgdHJhbnNsYXRpb25Eb25lKCkgewogICAgdGhpcy5fb25UcmFuc2xhdGVkKHRoaXMueCwgdGhpcy55KTsKICB9CiAgZHJhZyh0eCwgdHkpIHsKICAgIHRoaXMuI2luaXRpYWxSZWN0IHx8PSBbdGhpcy54LCB0aGlzLnksIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0XTsKICAgIGNvbnN0IHsKICAgICAgZGl2LAogICAgICBwYXJlbnREaW1lbnNpb25zOiBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0KICAgIH0gPSB0aGlzOwogICAgdGhpcy54ICs9IHR4IC8gcGFyZW50V2lkdGg7CiAgICB0aGlzLnkgKz0gdHkgLyBwYXJlbnRIZWlnaHQ7CiAgICBpZiAodGhpcy5wYXJlbnQgJiYgKHRoaXMueCA8IDAgfHwgdGhpcy54ID4gMSB8fCB0aGlzLnkgPCAwIHx8IHRoaXMueSA+IDEpKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICB4OiB4MiwKICAgICAgICB5OiB5MgogICAgICB9ID0gdGhpcy5kaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGlmICh0aGlzLnBhcmVudC5maW5kTmV3UGFyZW50KHRoaXMsIHgyLCB5MikpIHsKICAgICAgICB0aGlzLnggLT0gTWF0aC5mbG9vcih0aGlzLngpOwogICAgICAgIHRoaXMueSAtPSBNYXRoLmZsb29yKHRoaXMueSk7CiAgICAgIH0KICAgIH0KICAgIGxldCB7CiAgICAgIHgsCiAgICAgIHkKICAgIH0gPSB0aGlzOwogICAgY29uc3QgW2J4LCBieV0gPSB0aGlzLmdldEJhc2VUcmFuc2xhdGlvbigpOwogICAgeCArPSBieDsKICAgIHkgKz0gYnk7CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gZGl2OwogICAgc3R5bGUubGVmdCA9IGAkeygxMDAgKiB4KS50b0ZpeGVkKDIpfSVgOwogICAgc3R5bGUudG9wID0gYCR7KDEwMCAqIHkpLnRvRml4ZWQoMil9JWA7CiAgICB0aGlzLl9vblRyYW5zbGF0aW5nKHgsIHkpOwogICAgZGl2LnNjcm9sbEludG9WaWV3KHsKICAgICAgYmxvY2s6ICJuZWFyZXN0IgogICAgfSk7CiAgfQogIF9vblRyYW5zbGF0aW5nKHgsIHkpIHsKICB9CiAgX29uVHJhbnNsYXRlZCh4LCB5KSB7CiAgfQogIGdldCBfaGFzQmVlbk1vdmVkKCkgewogICAgcmV0dXJuICEhdGhpcy4jaW5pdGlhbFJlY3QgJiYgKHRoaXMuI2luaXRpYWxSZWN0WzBdICE9PSB0aGlzLnggfHwgdGhpcy4jaW5pdGlhbFJlY3RbMV0gIT09IHRoaXMueSk7CiAgfQogIGdldCBfaGFzQmVlblJlc2l6ZWQoKSB7CiAgICByZXR1cm4gISF0aGlzLiNpbml0aWFsUmVjdCAmJiAodGhpcy4jaW5pdGlhbFJlY3RbMl0gIT09IHRoaXMud2lkdGggfHwgdGhpcy4jaW5pdGlhbFJlY3RbM10gIT09IHRoaXMuaGVpZ2h0KTsKICB9CiAgZ2V0QmFzZVRyYW5zbGF0aW9uKCkgewogICAgY29uc3QgW3BhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdID0gdGhpcy5wYXJlbnREaW1lbnNpb25zOwogICAgY29uc3QgewogICAgICBfYm9yZGVyTGluZVdpZHRoCiAgICB9ID0gX0Fubm90YXRpb25FZGl0b3I7CiAgICBjb25zdCB4ID0gX2JvcmRlckxpbmVXaWR0aCAvIHBhcmVudFdpZHRoOwogICAgY29uc3QgeSA9IF9ib3JkZXJMaW5lV2lkdGggLyBwYXJlbnRIZWlnaHQ7CiAgICBzd2l0Y2ggKHRoaXMucm90YXRpb24pIHsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXR1cm4gWy14LCB5XTsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcmV0dXJuIFt4LCB5XTsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmV0dXJuIFt4LCAteV07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIFsteCwgLXldOwogICAgfQogIH0KICBnZXQgX211c3RGaXhQb3NpdGlvbigpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBmaXhBbmRTZXRQb3NpdGlvbihyb3RhdGlvbiA9IHRoaXMucm90YXRpb24pIHsKICAgIGNvbnN0IHsKICAgICAgZGl2OiB7CiAgICAgICAgc3R5bGUKICAgICAgfSwKICAgICAgcGFnZURpbWVuc2lvbnM6IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdCiAgICB9ID0gdGhpczsKICAgIGxldCB7CiAgICAgIHgsCiAgICAgIHksCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgd2lkdGggKj0gcGFnZVdpZHRoOwogICAgaGVpZ2h0ICo9IHBhZ2VIZWlnaHQ7CiAgICB4ICo9IHBhZ2VXaWR0aDsKICAgIHkgKj0gcGFnZUhlaWdodDsKICAgIGlmICh0aGlzLl9tdXN0Rml4UG9zaXRpb24pIHsKICAgICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICAgIGNhc2UgMDoKICAgICAgICAgIHggPSBNYXRoQ2xhbXAoeCwgMCwgcGFnZVdpZHRoIC0gd2lkdGgpOwogICAgICAgICAgeSA9IE1hdGhDbGFtcCh5LCAwLCBwYWdlSGVpZ2h0IC0gaGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgOTA6CiAgICAgICAgICB4ID0gTWF0aENsYW1wKHgsIDAsIHBhZ2VXaWR0aCAtIGhlaWdodCk7CiAgICAgICAgICB5ID0gTWF0aENsYW1wKHksIHdpZHRoLCBwYWdlSGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMTgwOgogICAgICAgICAgeCA9IE1hdGhDbGFtcCh4LCB3aWR0aCwgcGFnZVdpZHRoKTsKICAgICAgICAgIHkgPSBNYXRoQ2xhbXAoeSwgaGVpZ2h0LCBwYWdlSGVpZ2h0KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjcwOgogICAgICAgICAgeCA9IE1hdGhDbGFtcCh4LCBoZWlnaHQsIHBhZ2VXaWR0aCk7CiAgICAgICAgICB5ID0gTWF0aENsYW1wKHksIDAsIHBhZ2VIZWlnaHQgLSB3aWR0aCk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgdGhpcy54ID0geCAvPSBwYWdlV2lkdGg7CiAgICB0aGlzLnkgPSB5IC89IHBhZ2VIZWlnaHQ7CiAgICBjb25zdCBbYngsIGJ5XSA9IHRoaXMuZ2V0QmFzZVRyYW5zbGF0aW9uKCk7CiAgICB4ICs9IGJ4OwogICAgeSArPSBieTsKICAgIHN0eWxlLmxlZnQgPSBgJHsoMTAwICogeCkudG9GaXhlZCgyKX0lYDsKICAgIHN0eWxlLnRvcCA9IGAkeygxMDAgKiB5KS50b0ZpeGVkKDIpfSVgOwogICAgdGhpcy5tb3ZlSW5ET00oKTsKICB9CiAgc3RhdGljICNyb3RhdGVQb2ludCh4LCB5LCBhbmdsZSkgewogICAgc3dpdGNoIChhbmdsZSkgewogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbeSwgLXhdOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXR1cm4gWy14LCAteV07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiBbLXksIHhdOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbeCwgeV07CiAgICB9CiAgfQogIHNjcmVlblRvUGFnZVRyYW5zbGF0aW9uKHgsIHkpIHsKICAgIHJldHVybiBfQW5ub3RhdGlvbkVkaXRvci4jcm90YXRlUG9pbnQoeCwgeSwgdGhpcy5wYXJlbnRSb3RhdGlvbik7CiAgfQogIHBhZ2VUcmFuc2xhdGlvblRvU2NyZWVuKHgsIHkpIHsKICAgIHJldHVybiBfQW5ub3RhdGlvbkVkaXRvci4jcm90YXRlUG9pbnQoeCwgeSwgMzYwIC0gdGhpcy5wYXJlbnRSb3RhdGlvbik7CiAgfQogICNnZXRSb3RhdGlvbk1hdHJpeChyb3RhdGlvbikgewogICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICBjYXNlIDkwOiB7CiAgICAgICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhZ2VEaW1lbnNpb25zOwogICAgICAgIHJldHVybiBbMCwgLXBhZ2VXaWR0aCAvIHBhZ2VIZWlnaHQsIHBhZ2VIZWlnaHQgLyBwYWdlV2lkdGgsIDBdOwogICAgICB9CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiBbLTEsIDAsIDAsIC0xXTsKICAgICAgY2FzZSAyNzA6IHsKICAgICAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFnZURpbWVuc2lvbnM7CiAgICAgICAgcmV0dXJuIFswLCBwYWdlV2lkdGggLyBwYWdlSGVpZ2h0LCAtcGFnZUhlaWdodCAvIHBhZ2VXaWR0aCwgMF07CiAgICAgIH0KICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gWzEsIDAsIDAsIDFdOwogICAgfQogIH0KICBnZXQgcGFyZW50U2NhbGUoKSB7CiAgICByZXR1cm4gdGhpcy5fdWlNYW5hZ2VyLnZpZXdQYXJhbWV0ZXJzLnJlYWxTY2FsZTsKICB9CiAgZ2V0IHBhcmVudFJvdGF0aW9uKCkgewogICAgcmV0dXJuICh0aGlzLl91aU1hbmFnZXIudmlld1BhcmFtZXRlcnMucm90YXRpb24gKyB0aGlzLnBhZ2VSb3RhdGlvbikgJSAzNjA7CiAgfQogIGdldCBwYXJlbnREaW1lbnNpb25zKCkgewogICAgY29uc3QgewogICAgICBwYXJlbnRTY2FsZSwKICAgICAgcGFnZURpbWVuc2lvbnM6IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdCiAgICB9ID0gdGhpczsKICAgIHJldHVybiBbcGFnZVdpZHRoICogcGFyZW50U2NhbGUsIHBhZ2VIZWlnaHQgKiBwYXJlbnRTY2FsZV07CiAgfQogIHNldERpbXMoKSB7CiAgICBjb25zdCB7CiAgICAgIGRpdjogewogICAgICAgIHN0eWxlCiAgICAgIH0sCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgc3R5bGUud2lkdGggPSBgJHsoMTAwICogd2lkdGgpLnRvRml4ZWQoMil9JWA7CiAgICBzdHlsZS5oZWlnaHQgPSBgJHsoMTAwICogaGVpZ2h0KS50b0ZpeGVkKDIpfSVgOwogIH0KICBnZXRJbml0aWFsVHJhbnNsYXRpb24oKSB7CiAgICByZXR1cm4gWzAsIDBdOwogIH0KICAjY3JlYXRlUmVzaXplcnMoKSB7CiAgICBpZiAodGhpcy4jcmVzaXplcnNEaXYpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jcmVzaXplcnNEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHRoaXMuI3Jlc2l6ZXJzRGl2LmNsYXNzTGlzdC5hZGQoInJlc2l6ZXJzIik7CiAgICBjb25zdCBjbGFzc2VzID0gdGhpcy5fd2lsbEtlZXBBc3BlY3RSYXRpbyA/IFsidG9wTGVmdCIsICJ0b3BSaWdodCIsICJib3R0b21SaWdodCIsICJib3R0b21MZWZ0Il0gOiBbInRvcExlZnQiLCAidG9wTWlkZGxlIiwgInRvcFJpZ2h0IiwgIm1pZGRsZVJpZ2h0IiwgImJvdHRvbVJpZ2h0IiwgImJvdHRvbU1pZGRsZSIsICJib3R0b21MZWZ0IiwgIm1pZGRsZUxlZnQiXTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuX3VpTWFuYWdlci5fc2lnbmFsOwogICAgZm9yIChjb25zdCBuYW1lIG9mIGNsYXNzZXMpIHsKICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHRoaXMuI3Jlc2l6ZXJzRGl2LmFwcGVuZChkaXYpOwogICAgICBkaXYuY2xhc3NMaXN0LmFkZCgicmVzaXplciIsIG5hbWUpOwogICAgICBkaXYuc2V0QXR0cmlidXRlKCJkYXRhLXJlc2l6ZXItbmFtZSIsIG5hbWUpOwogICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmRvd24iLCB0aGlzLiNyZXNpemVyUG9pbnRlcmRvd24uYmluZCh0aGlzLCBuYW1lKSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51Iiwgbm9Db250ZXh0TWVudSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgZGl2LnRhYkluZGV4ID0gLTE7CiAgICB9CiAgICB0aGlzLmRpdi5wcmVwZW5kKHRoaXMuI3Jlc2l6ZXJzRGl2KTsKICB9CiAgI3Jlc2l6ZXJQb2ludGVyZG93bihuYW1lLCBldmVudCkgewogICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIGNvbnN0IHsKICAgICAgaXNNYWMKICAgIH0gPSB1dGlsX0ZlYXR1cmVUZXN0LnBsYXRmb3JtOwogICAgaWYgKGV2ZW50LmJ1dHRvbiAhPT0gMCB8fCBldmVudC5jdHJsS2V5ICYmIGlzTWFjKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FsdFRleHQ/LnRvZ2dsZShmYWxzZSk7CiAgICBjb25zdCBzYXZlZERyYWdnYWJsZSA9IHRoaXMuX2lzRHJhZ2dhYmxlOwogICAgdGhpcy5faXNEcmFnZ2FibGUgPSBmYWxzZTsKICAgIHRoaXMuI2xhc3RQb2ludGVyQ29vcmRzID0gW2V2ZW50LnNjcmVlblgsIGV2ZW50LnNjcmVlblldOwogICAgY29uc3QgYWMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLl91aU1hbmFnZXIuY29tYmluZWRTaWduYWwoYWMpOwogICAgdGhpcy5wYXJlbnQudG9nZ2xlUG9pbnRlckV2ZW50cyhmYWxzZSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcm1vdmUiLCB0aGlzLiNyZXNpemVyUG9pbnRlcm1vdmUuYmluZCh0aGlzLCBuYW1lKSwgewogICAgICBwYXNzaXZlOiB0cnVlLAogICAgICBjYXB0dXJlOiB0cnVlLAogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRvdWNobW92ZSIsIHN0b3BFdmVudCwgewogICAgICBwYXNzaXZlOiBmYWxzZSwKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJjb250ZXh0bWVudSIsIG5vQ29udGV4dE1lbnUsIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuI3NhdmVkRGltZW5zaW9ucyA9IHsKICAgICAgc2F2ZWRYOiB0aGlzLngsCiAgICAgIHNhdmVkWTogdGhpcy55LAogICAgICBzYXZlZFdpZHRoOiB0aGlzLndpZHRoLAogICAgICBzYXZlZEhlaWdodDogdGhpcy5oZWlnaHQKICAgIH07CiAgICBjb25zdCBzYXZlZFBhcmVudEN1cnNvciA9IHRoaXMucGFyZW50LmRpdi5zdHlsZS5jdXJzb3I7CiAgICBjb25zdCBzYXZlZEN1cnNvciA9IHRoaXMuZGl2LnN0eWxlLmN1cnNvcjsKICAgIHRoaXMuZGl2LnN0eWxlLmN1cnNvciA9IHRoaXMucGFyZW50LmRpdi5zdHlsZS5jdXJzb3IgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShldmVudC50YXJnZXQpLmN1cnNvcjsKICAgIGNvbnN0IHBvaW50ZXJVcENhbGxiYWNrID0gKCkgPT4gewogICAgICBhYy5hYm9ydCgpOwogICAgICB0aGlzLnBhcmVudC50b2dnbGVQb2ludGVyRXZlbnRzKHRydWUpOwogICAgICB0aGlzLiNhbHRUZXh0Py50b2dnbGUodHJ1ZSk7CiAgICAgIHRoaXMuX2lzRHJhZ2dhYmxlID0gc2F2ZWREcmFnZ2FibGU7CiAgICAgIHRoaXMucGFyZW50LmRpdi5zdHlsZS5jdXJzb3IgPSBzYXZlZFBhcmVudEN1cnNvcjsKICAgICAgdGhpcy5kaXYuc3R5bGUuY3Vyc29yID0gc2F2ZWRDdXJzb3I7CiAgICAgIHRoaXMuI2FkZFJlc2l6ZVRvVW5kb1N0YWNrKCk7CiAgICB9OwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHBvaW50ZXJVcENhbGxiYWNrLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIHBvaW50ZXJVcENhbGxiYWNrLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgfQogICNyZXNpemUoeCwgeSwgd2lkdGgsIGhlaWdodCkgewogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICB0aGlzLnggPSB4OwogICAgdGhpcy55ID0geTsKICAgIHRoaXMuc2V0RGltcygpOwogICAgdGhpcy5maXhBbmRTZXRQb3NpdGlvbigpOwogICAgdGhpcy5fb25SZXNpemVkKCk7CiAgfQogIF9vblJlc2l6ZWQoKSB7CiAgfQogICNhZGRSZXNpemVUb1VuZG9TdGFjaygpIHsKICAgIGlmICghdGhpcy4jc2F2ZWREaW1lbnNpb25zKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgc2F2ZWRYLAogICAgICBzYXZlZFksCiAgICAgIHNhdmVkV2lkdGgsCiAgICAgIHNhdmVkSGVpZ2h0CiAgICB9ID0gdGhpcy4jc2F2ZWREaW1lbnNpb25zOwogICAgdGhpcy4jc2F2ZWREaW1lbnNpb25zID0gbnVsbDsKICAgIGNvbnN0IG5ld1ggPSB0aGlzLng7CiAgICBjb25zdCBuZXdZID0gdGhpcy55OwogICAgY29uc3QgbmV3V2lkdGggPSB0aGlzLndpZHRoOwogICAgY29uc3QgbmV3SGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CiAgICBpZiAobmV3WCA9PT0gc2F2ZWRYICYmIG5ld1kgPT09IHNhdmVkWSAmJiBuZXdXaWR0aCA9PT0gc2F2ZWRXaWR0aCAmJiBuZXdIZWlnaHQgPT09IHNhdmVkSGVpZ2h0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICBjbWQ6IHRoaXMuI3Jlc2l6ZS5iaW5kKHRoaXMsIG5ld1gsIG5ld1ksIG5ld1dpZHRoLCBuZXdIZWlnaHQpLAogICAgICB1bmRvOiB0aGlzLiNyZXNpemUuYmluZCh0aGlzLCBzYXZlZFgsIHNhdmVkWSwgc2F2ZWRXaWR0aCwgc2F2ZWRIZWlnaHQpLAogICAgICBtdXN0RXhlYzogdHJ1ZQogICAgfSk7CiAgfQogIHN0YXRpYyBfcm91bmQoeCkgewogICAgcmV0dXJuIE1hdGgucm91bmQoeCAqIDFlNCkgLyAxZTQ7CiAgfQogICNyZXNpemVyUG9pbnRlcm1vdmUobmFtZSwgZXZlbnQpIHsKICAgIGNvbnN0IFtwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgIGNvbnN0IHNhdmVkWCA9IHRoaXMueDsKICAgIGNvbnN0IHNhdmVkWSA9IHRoaXMueTsKICAgIGNvbnN0IHNhdmVkV2lkdGggPSB0aGlzLndpZHRoOwogICAgY29uc3Qgc2F2ZWRIZWlnaHQgPSB0aGlzLmhlaWdodDsKICAgIGNvbnN0IG1pbldpZHRoID0gX0Fubm90YXRpb25FZGl0b3IuTUlOX1NJWkUgLyBwYXJlbnRXaWR0aDsKICAgIGNvbnN0IG1pbkhlaWdodCA9IF9Bbm5vdGF0aW9uRWRpdG9yLk1JTl9TSVpFIC8gcGFyZW50SGVpZ2h0OwogICAgY29uc3Qgcm90YXRpb25NYXRyaXggPSB0aGlzLiNnZXRSb3RhdGlvbk1hdHJpeCh0aGlzLnJvdGF0aW9uKTsKICAgIGNvbnN0IHRyYW5zZiA9ICh4LCB5KSA9PiBbcm90YXRpb25NYXRyaXhbMF0gKiB4ICsgcm90YXRpb25NYXRyaXhbMl0gKiB5LCByb3RhdGlvbk1hdHJpeFsxXSAqIHggKyByb3RhdGlvbk1hdHJpeFszXSAqIHldOwogICAgY29uc3QgaW52Um90YXRpb25NYXRyaXggPSB0aGlzLiNnZXRSb3RhdGlvbk1hdHJpeCgzNjAgLSB0aGlzLnJvdGF0aW9uKTsKICAgIGNvbnN0IGludlRyYW5zZiA9ICh4LCB5KSA9PiBbaW52Um90YXRpb25NYXRyaXhbMF0gKiB4ICsgaW52Um90YXRpb25NYXRyaXhbMl0gKiB5LCBpbnZSb3RhdGlvbk1hdHJpeFsxXSAqIHggKyBpbnZSb3RhdGlvbk1hdHJpeFszXSAqIHldOwogICAgbGV0IGdldFBvaW50OwogICAgbGV0IGdldE9wcG9zaXRlOwogICAgbGV0IGlzRGlhZ29uYWwgPSBmYWxzZTsKICAgIGxldCBpc0hvcml6b250YWwgPSBmYWxzZTsKICAgIHN3aXRjaCAobmFtZSkgewogICAgICBjYXNlICJ0b3BMZWZ0IjoKICAgICAgICBpc0RpYWdvbmFsID0gdHJ1ZTsKICAgICAgICBnZXRQb2ludCA9ICh3LCBoKSA9PiBbMCwgMF07CiAgICAgICAgZ2V0T3Bwb3NpdGUgPSAodywgaCkgPT4gW3csIGhdOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJ0b3BNaWRkbGUiOgogICAgICAgIGdldFBvaW50ID0gKHcsIGgpID0+IFt3IC8gMiwgMF07CiAgICAgICAgZ2V0T3Bwb3NpdGUgPSAodywgaCkgPT4gW3cgLyAyLCBoXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAidG9wUmlnaHQiOgogICAgICAgIGlzRGlhZ29uYWwgPSB0cnVlOwogICAgICAgIGdldFBvaW50ID0gKHcsIGgpID0+IFt3LCAwXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbMCwgaF07CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIm1pZGRsZVJpZ2h0IjoKICAgICAgICBpc0hvcml6b250YWwgPSB0cnVlOwogICAgICAgIGdldFBvaW50ID0gKHcsIGgpID0+IFt3LCBoIC8gMl07CiAgICAgICAgZ2V0T3Bwb3NpdGUgPSAodywgaCkgPT4gWzAsIGggLyAyXTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAiYm90dG9tUmlnaHQiOgogICAgICAgIGlzRGlhZ29uYWwgPSB0cnVlOwogICAgICAgIGdldFBvaW50ID0gKHcsIGgpID0+IFt3LCBoXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbMCwgMF07CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgImJvdHRvbU1pZGRsZSI6CiAgICAgICAgZ2V0UG9pbnQgPSAodywgaCkgPT4gW3cgLyAyLCBoXTsKICAgICAgICBnZXRPcHBvc2l0ZSA9ICh3LCBoKSA9PiBbdyAvIDIsIDBdOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJib3R0b21MZWZ0IjoKICAgICAgICBpc0RpYWdvbmFsID0gdHJ1ZTsKICAgICAgICBnZXRQb2ludCA9ICh3LCBoKSA9PiBbMCwgaF07CiAgICAgICAgZ2V0T3Bwb3NpdGUgPSAodywgaCkgPT4gW3csIDBdOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJtaWRkbGVMZWZ0IjoKICAgICAgICBpc0hvcml6b250YWwgPSB0cnVlOwogICAgICAgIGdldFBvaW50ID0gKHcsIGgpID0+IFswLCBoIC8gMl07CiAgICAgICAgZ2V0T3Bwb3NpdGUgPSAodywgaCkgPT4gW3csIGggLyAyXTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGNvbnN0IHBvaW50ID0gZ2V0UG9pbnQoc2F2ZWRXaWR0aCwgc2F2ZWRIZWlnaHQpOwogICAgY29uc3Qgb3Bwb3NpdGVQb2ludCA9IGdldE9wcG9zaXRlKHNhdmVkV2lkdGgsIHNhdmVkSGVpZ2h0KTsKICAgIGxldCB0cmFuc2ZPcHBvc2l0ZVBvaW50ID0gdHJhbnNmKC4uLm9wcG9zaXRlUG9pbnQpOwogICAgY29uc3Qgb3Bwb3NpdGVYID0gX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKHNhdmVkWCArIHRyYW5zZk9wcG9zaXRlUG9pbnRbMF0pOwogICAgY29uc3Qgb3Bwb3NpdGVZID0gX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKHNhdmVkWSArIHRyYW5zZk9wcG9zaXRlUG9pbnRbMV0pOwogICAgbGV0IHJhdGlvWCA9IDE7CiAgICBsZXQgcmF0aW9ZID0gMTsKICAgIGxldCBkZWx0YVgsIGRlbHRhWTsKICAgIGlmICghZXZlbnQuZnJvbUtleWJvYXJkKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBzY3JlZW5YLAogICAgICAgIHNjcmVlblkKICAgICAgfSA9IGV2ZW50OwogICAgICBjb25zdCBbbGFzdFNjcmVlblgsIGxhc3RTY3JlZW5ZXSA9IHRoaXMuI2xhc3RQb2ludGVyQ29vcmRzOwogICAgICBbZGVsdGFYLCBkZWx0YVldID0gdGhpcy5zY3JlZW5Ub1BhZ2VUcmFuc2xhdGlvbihzY3JlZW5YIC0gbGFzdFNjcmVlblgsIHNjcmVlblkgLSBsYXN0U2NyZWVuWSk7CiAgICAgIHRoaXMuI2xhc3RQb2ludGVyQ29vcmRzWzBdID0gc2NyZWVuWDsKICAgICAgdGhpcy4jbGFzdFBvaW50ZXJDb29yZHNbMV0gPSBzY3JlZW5ZOwogICAgfSBlbHNlIHsKICAgICAgKHsKICAgICAgICBkZWx0YVgsCiAgICAgICAgZGVsdGFZCiAgICAgIH0gPSBldmVudCk7CiAgICB9CiAgICBbZGVsdGFYLCBkZWx0YVldID0gaW52VHJhbnNmKGRlbHRhWCAvIHBhcmVudFdpZHRoLCBkZWx0YVkgLyBwYXJlbnRIZWlnaHQpOwogICAgaWYgKGlzRGlhZ29uYWwpIHsKICAgICAgY29uc3Qgb2xkRGlhZyA9IE1hdGguaHlwb3Qoc2F2ZWRXaWR0aCwgc2F2ZWRIZWlnaHQpOwogICAgICByYXRpb1ggPSByYXRpb1kgPSBNYXRoLm1heChNYXRoLm1pbihNYXRoLmh5cG90KG9wcG9zaXRlUG9pbnRbMF0gLSBwb2ludFswXSAtIGRlbHRhWCwgb3Bwb3NpdGVQb2ludFsxXSAtIHBvaW50WzFdIC0gZGVsdGFZKSAvIG9sZERpYWcsIDEgLyBzYXZlZFdpZHRoLCAxIC8gc2F2ZWRIZWlnaHQpLCBtaW5XaWR0aCAvIHNhdmVkV2lkdGgsIG1pbkhlaWdodCAvIHNhdmVkSGVpZ2h0KTsKICAgIH0gZWxzZSBpZiAoaXNIb3Jpem9udGFsKSB7CiAgICAgIHJhdGlvWCA9IE1hdGhDbGFtcChNYXRoLmFicyhvcHBvc2l0ZVBvaW50WzBdIC0gcG9pbnRbMF0gLSBkZWx0YVgpLCBtaW5XaWR0aCwgMSkgLyBzYXZlZFdpZHRoOwogICAgfSBlbHNlIHsKICAgICAgcmF0aW9ZID0gTWF0aENsYW1wKE1hdGguYWJzKG9wcG9zaXRlUG9pbnRbMV0gLSBwb2ludFsxXSAtIGRlbHRhWSksIG1pbkhlaWdodCwgMSkgLyBzYXZlZEhlaWdodDsKICAgIH0KICAgIGNvbnN0IG5ld1dpZHRoID0gX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKHNhdmVkV2lkdGggKiByYXRpb1gpOwogICAgY29uc3QgbmV3SGVpZ2h0ID0gX0Fubm90YXRpb25FZGl0b3IuX3JvdW5kKHNhdmVkSGVpZ2h0ICogcmF0aW9ZKTsKICAgIHRyYW5zZk9wcG9zaXRlUG9pbnQgPSB0cmFuc2YoLi4uZ2V0T3Bwb3NpdGUobmV3V2lkdGgsIG5ld0hlaWdodCkpOwogICAgY29uc3QgbmV3WCA9IG9wcG9zaXRlWCAtIHRyYW5zZk9wcG9zaXRlUG9pbnRbMF07CiAgICBjb25zdCBuZXdZID0gb3Bwb3NpdGVZIC0gdHJhbnNmT3Bwb3NpdGVQb2ludFsxXTsKICAgIHRoaXMuI2luaXRpYWxSZWN0IHx8PSBbdGhpcy54LCB0aGlzLnksIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0XTsKICAgIHRoaXMud2lkdGggPSBuZXdXaWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gbmV3SGVpZ2h0OwogICAgdGhpcy54ID0gbmV3WDsKICAgIHRoaXMueSA9IG5ld1k7CiAgICB0aGlzLnNldERpbXMoKTsKICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICAgIHRoaXMuX29uUmVzaXppbmcoKTsKICB9CiAgX29uUmVzaXppbmcoKSB7CiAgfQogIGFsdFRleHRGaW5pc2goKSB7CiAgICB0aGlzLiNhbHRUZXh0Py5maW5pc2goKTsKICB9CiAgZ2V0IHRvb2xiYXJCdXR0b25zKCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGFzeW5jIGFkZEVkaXRUb29sYmFyKCkgewogICAgaWYgKHRoaXMuX2VkaXRUb29sYmFyIHx8IHRoaXMuI2lzSW5FZGl0TW9kZSkgewogICAgICByZXR1cm4gdGhpcy5fZWRpdFRvb2xiYXI7CiAgICB9CiAgICB0aGlzLl9lZGl0VG9vbGJhciA9IG5ldyBFZGl0b3JUb29sYmFyKHRoaXMpOwogICAgdGhpcy5kaXYuYXBwZW5kKHRoaXMuX2VkaXRUb29sYmFyLnJlbmRlcigpKTsKICAgIGNvbnN0IHsKICAgICAgdG9vbGJhckJ1dHRvbnMKICAgIH0gPSB0aGlzOwogICAgaWYgKHRvb2xiYXJCdXR0b25zKSB7CiAgICAgIGZvciAoY29uc3QgW25hbWUsIHRvb2xdIG9mIHRvb2xiYXJCdXR0b25zKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fZWRpdFRvb2xiYXIuYWRkQnV0dG9uKG5hbWUsIHRvb2wpOwogICAgICB9CiAgICB9CiAgICBpZiAoIXRoaXMuaGFzQ29tbWVudCkgewogICAgICB0aGlzLl9lZGl0VG9vbGJhci5hZGRCdXR0b24oImNvbW1lbnQiLCB0aGlzLmFkZENvbW1lbnRCdXR0b24oKSk7CiAgICB9CiAgICB0aGlzLl9lZGl0VG9vbGJhci5hZGRCdXR0b24oImRlbGV0ZSIpOwogICAgcmV0dXJuIHRoaXMuX2VkaXRUb29sYmFyOwogIH0KICBhZGRDb21tZW50QnV0dG9uSW5Ub29sYmFyKCkgewogICAgdGhpcy5fZWRpdFRvb2xiYXI/LmFkZEJ1dHRvbkJlZm9yZSgiY29tbWVudCIsIHRoaXMuYWRkQ29tbWVudEJ1dHRvbigpLCAiLmRlbGV0ZUJ1dHRvbiIpOwogIH0KICByZW1vdmVDb21tZW50QnV0dG9uRnJvbVRvb2xiYXIoKSB7CiAgICB0aGlzLl9lZGl0VG9vbGJhcj8ucmVtb3ZlQnV0dG9uKCJjb21tZW50Iik7CiAgfQogIHJlbW92ZUVkaXRUb29sYmFyKCkgewogICAgdGhpcy5fZWRpdFRvb2xiYXI/LnJlbW92ZSgpOwogICAgdGhpcy5fZWRpdFRvb2xiYXIgPSBudWxsOwogICAgdGhpcy4jYWx0VGV4dD8uZGVzdHJveSgpOwogIH0KICBhZGRDb250YWluZXIoY29udGFpbmVyMikgewogICAgY29uc3QgZWRpdFRvb2xiYXJEaXYgPSB0aGlzLl9lZGl0VG9vbGJhcj8uZGl2OwogICAgaWYgKGVkaXRUb29sYmFyRGl2KSB7CiAgICAgIGVkaXRUb29sYmFyRGl2LmJlZm9yZShjb250YWluZXIyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZGl2LmFwcGVuZChjb250YWluZXIyKTsKICAgIH0KICB9CiAgZ2V0Q2xpZW50RGltZW5zaW9ucygpIHsKICAgIHJldHVybiB0aGlzLmRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB9CiAgY3JlYXRlQWx0VGV4dCgpIHsKICAgIGlmICghdGhpcy4jYWx0VGV4dCkgewogICAgICBBbHRUZXh0LmluaXRpYWxpemUoX0Fubm90YXRpb25FZGl0b3IuX2wxMG4pOwogICAgICB0aGlzLiNhbHRUZXh0ID0gbmV3IEFsdFRleHQodGhpcyk7CiAgICAgIGlmICh0aGlzLiNhY2Nlc3NpYmlsaXR5RGF0YSkgewogICAgICAgIHRoaXMuI2FsdFRleHQuZGF0YSA9IHRoaXMuI2FjY2Vzc2liaWxpdHlEYXRhOwogICAgICAgIHRoaXMuI2FjY2Vzc2liaWxpdHlEYXRhID0gbnVsbDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuI2FsdFRleHQ7CiAgfQogIGdldCBhbHRUZXh0RGF0YSgpIHsKICAgIHJldHVybiB0aGlzLiNhbHRUZXh0Py5kYXRhOwogIH0KICBzZXQgYWx0VGV4dERhdGEoZGF0YSkgewogICAgaWYgKCF0aGlzLiNhbHRUZXh0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FsdFRleHQuZGF0YSA9IGRhdGE7CiAgfQogIGdldCBndWVzc2VkQWx0VGV4dCgpIHsKICAgIHJldHVybiB0aGlzLiNhbHRUZXh0Py5ndWVzc2VkVGV4dDsKICB9CiAgYXN5bmMgc2V0R3Vlc3NlZEFsdFRleHQodGV4dCkgewogICAgYXdhaXQgdGhpcy4jYWx0VGV4dD8uc2V0R3Vlc3NlZFRleHQodGV4dCk7CiAgfQogIHNlcmlhbGl6ZUFsdFRleHQoaXNGb3JDb3B5aW5nKSB7CiAgICByZXR1cm4gdGhpcy4jYWx0VGV4dD8uc2VyaWFsaXplKGlzRm9yQ29weWluZyk7CiAgfQogIGhhc0FsdFRleHQoKSB7CiAgICByZXR1cm4gISF0aGlzLiNhbHRUZXh0ICYmICF0aGlzLiNhbHRUZXh0LmlzRW1wdHkoKTsKICB9CiAgaGFzQWx0VGV4dERhdGEoKSB7CiAgICByZXR1cm4gdGhpcy4jYWx0VGV4dD8uaGFzRGF0YSgpID8/IGZhbHNlOwogIH0KICBmb2N1c0NvbW1lbnRCdXR0b24oKSB7CiAgICB0aGlzLiNjb21tZW50Py5mb2N1c0J1dHRvbigpOwogIH0KICBhZGRDb21tZW50QnV0dG9uKCkgewogICAgcmV0dXJuIHRoaXMuY2FuQWRkQ29tbWVudCA/IHRoaXMuI2NvbW1lbnQgfHw9IG5ldyBDb21tZW50KHRoaXMpIDogbnVsbDsKICB9CiAgYWRkU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKSB7CiAgICBpZiAoIXRoaXMuX3VpTWFuYWdlci5oYXNDb21tZW50TWFuYWdlcigpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiNjb21tZW50U3RhbmRhbG9uZUJ1dHRvbikgewogICAgICBpZiAodGhpcy5fdWlNYW5hZ2VyLmlzRWRpdGluZ01vZGUoKSkgewogICAgICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy5oYXNDb21tZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uID0gdGhpcy4jY29tbWVudC5yZW5kZXJGb3JTdGFuZGFsb25lKCk7CiAgICB0aGlzLmRpdi5hcHBlbmQodGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24pOwogIH0KICByZW1vdmVTdGFuZGFsb25lQ29tbWVudEJ1dHRvbigpIHsKICAgIHRoaXMuI2NvbW1lbnQucmVtb3ZlU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKTsKICAgIHRoaXMuI2NvbW1lbnRTdGFuZGFsb25lQnV0dG9uID0gbnVsbDsKICB9CiAgaGlkZVN0YW5kYWxvbmVDb21tZW50QnV0dG9uKCkgewogICAgdGhpcy4jY29tbWVudFN0YW5kYWxvbmVCdXR0b24/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogIH0KICBnZXQgY29tbWVudCgpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YTogewogICAgICAgIHJpY2hUZXh0LAogICAgICAgIHRleHQsCiAgICAgICAgZGF0ZSwKICAgICAgICBkZWxldGVkCiAgICAgIH0KICAgIH0gPSB0aGlzLiNjb21tZW50OwogICAgcmV0dXJuIHsKICAgICAgdGV4dCwKICAgICAgcmljaFRleHQsCiAgICAgIGRhdGUsCiAgICAgIGRlbGV0ZWQsCiAgICAgIGNvbG9yOiB0aGlzLmdldE5vbkhDTUNvbG9yKCksCiAgICAgIG9wYWNpdHk6IHRoaXMub3BhY2l0eSA/PyAxCiAgICB9OwogIH0KICBzZXQgY29tbWVudCh0ZXh0KSB7CiAgICB0aGlzLiNjb21tZW50IHx8PSBuZXcgQ29tbWVudCh0aGlzKTsKICAgIHRoaXMuI2NvbW1lbnQuZGF0YSA9IHRleHQ7CiAgICBpZiAodGhpcy5oYXNDb21tZW50KSB7CiAgICAgIHRoaXMucmVtb3ZlQ29tbWVudEJ1dHRvbkZyb21Ub29sYmFyKCk7CiAgICAgIHRoaXMuYWRkU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKTsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLnVwZGF0ZUNvbW1lbnQodGhpcyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmFkZENvbW1lbnRCdXR0b25JblRvb2xiYXIoKTsKICAgICAgdGhpcy5yZW1vdmVTdGFuZGFsb25lQ29tbWVudEJ1dHRvbigpOwogICAgICB0aGlzLl91aU1hbmFnZXIucmVtb3ZlQ29tbWVudCh0aGlzKTsKICAgIH0KICB9CiAgc2V0Q29tbWVudERhdGEoewogICAgY29tbWVudCwKICAgIHBvcHVwUmVmLAogICAgcmljaFRleHQKICB9KSB7CiAgICBpZiAoIXBvcHVwUmVmKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnQgfHw9IG5ldyBDb21tZW50KHRoaXMpOwogICAgdGhpcy4jY29tbWVudC5zZXRJbml0aWFsVGV4dChjb21tZW50LCByaWNoVGV4dCk7CiAgICBpZiAoIXRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBzdG9yZWREYXRhID0gdGhpcy5fdWlNYW5hZ2VyLmdldEFuZFJlbW92ZURhdGFGcm9tQW5ub3RhdGlvblN0b3JhZ2UodGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKTsKICAgIGlmIChzdG9yZWREYXRhKSB7CiAgICAgIHRoaXMudXBkYXRlRnJvbUFubm90YXRpb25MYXllcihzdG9yZWREYXRhKTsKICAgIH0KICB9CiAgZ2V0IGhhc0VkaXRlZENvbW1lbnQoKSB7CiAgICByZXR1cm4gdGhpcy4jY29tbWVudD8uaGFzQmVlbkVkaXRlZCgpOwogIH0KICBnZXQgaGFzRGVsZXRlZENvbW1lbnQoKSB7CiAgICByZXR1cm4gdGhpcy4jY29tbWVudD8uaXNEZWxldGVkKCk7CiAgfQogIGdldCBoYXNDb21tZW50KCkgewogICAgcmV0dXJuICEhdGhpcy4jY29tbWVudCAmJiAhdGhpcy4jY29tbWVudC5pc0VtcHR5KCkgJiYgIXRoaXMuI2NvbW1lbnQuaXNEZWxldGVkKCk7CiAgfQogIGFzeW5jIGVkaXRDb21tZW50KG9wdGlvbnMpIHsKICAgIHRoaXMuI2NvbW1lbnQgfHw9IG5ldyBDb21tZW50KHRoaXMpOwogICAgdGhpcy4jY29tbWVudC5lZGl0KG9wdGlvbnMpOwogIH0KICB0b2dnbGVDb21tZW50KGlzU2VsZWN0ZWQsIHZpc2liaWxpdHkgPSB2b2lkIDApIHsKICAgIGlmICh0aGlzLmhhc0NvbW1lbnQpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLnRvZ2dsZUNvbW1lbnQodGhpcywgaXNTZWxlY3RlZCwgdmlzaWJpbGl0eSk7CiAgICB9CiAgfQogIHNldFNlbGVjdGVkQ29tbWVudEJ1dHRvbihzZWxlY3RlZCkgewogICAgdGhpcy4jY29tbWVudC5zZXRTZWxlY3RlZEJ1dHRvbihzZWxlY3RlZCk7CiAgfQogIGFkZENvbW1lbnQoc2VyaWFsaXplZCkgewogICAgaWYgKHRoaXMuaGFzRWRpdGVkQ29tbWVudCkgewogICAgICBjb25zdCBERUZBVUxUX1BPUFVQX1dJRFRIID0gMTgwOwogICAgICBjb25zdCBERUZBVUxUX1BPUFVQX0hFSUdIVCA9IDEwMDsKICAgICAgY29uc3QgWywgLCAsIHRyWV0gPSBzZXJpYWxpemVkLnJlY3Q7CiAgICAgIGNvbnN0IFtwYWdlV2lkdGhdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgICAgY29uc3QgW3BhZ2VYXSA9IHRoaXMucGFnZVRyYW5zbGF0aW9uOwogICAgICBjb25zdCBibFggPSBwYWdlWCArIHBhZ2VXaWR0aCArIDE7CiAgICAgIGNvbnN0IGJsWSA9IHRyWSAtIERFRkFVTFRfUE9QVVBfSEVJR0hUOwogICAgICBjb25zdCB0clggPSBibFggKyBERUZBVUxUX1BPUFVQX1dJRFRIOwogICAgICBzZXJpYWxpemVkLnBvcHVwID0gewogICAgICAgIGNvbnRlbnRzOiB0aGlzLmNvbW1lbnQudGV4dCwKICAgICAgICBkZWxldGVkOiB0aGlzLmNvbW1lbnQuZGVsZXRlZCwKICAgICAgICByZWN0OiBbYmxYLCBibFksIHRyWCwgdHJZXQogICAgICB9OwogICAgfQogIH0KICB1cGRhdGVGcm9tQW5ub3RhdGlvbkxheWVyKHsKICAgIHBvcHVwOiB7CiAgICAgIGNvbnRlbnRzLAogICAgICBkZWxldGVkCiAgICB9CiAgfSkgewogICAgdGhpcy4jY29tbWVudC5kYXRhID0gZGVsZXRlZCA/IG51bGwgOiBjb250ZW50czsKICB9CiAgZ2V0IHBhcmVudEJvdW5kaW5nQ2xpZW50UmVjdCgpIHsKICAgIHJldHVybiB0aGlzLnBhcmVudC5ib3VuZGluZ0NsaWVudFJlY3Q7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IGRpdiA9IHRoaXMuZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXYuc2V0QXR0cmlidXRlKCJkYXRhLWVkaXRvci1yb3RhdGlvbiIsICgzNjAgLSB0aGlzLnJvdGF0aW9uKSAlIDM2MCk7CiAgICBkaXYuY2xhc3NOYW1lID0gdGhpcy5uYW1lOwogICAgZGl2LnNldEF0dHJpYnV0ZSgiaWQiLCB0aGlzLmlkKTsKICAgIGRpdi50YWJJbmRleCA9IHRoaXMuI2Rpc2FibGVkID8gLTEgOiAwOwogICAgZGl2LnNldEF0dHJpYnV0ZSgicm9sZSIsICJhcHBsaWNhdGlvbiIpOwogICAgaWYgKHRoaXMuZGVmYXVsdEwxMG5JZCkgewogICAgICBkaXYuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCB0aGlzLmRlZmF1bHRMMTBuSWQpOwogICAgfQogICAgaWYgKCF0aGlzLl9pc1Zpc2libGUpIHsKICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogICAgfQogICAgdGhpcy5zZXRJbkZvcmVncm91bmQoKTsKICAgIHRoaXMuI2FkZEZvY3VzTGlzdGVuZXJzKCk7CiAgICBjb25zdCBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICBpZiAodGhpcy5wYXJlbnRSb3RhdGlvbiAlIDE4MCAhPT0gMCkgewogICAgICBkaXYuc3R5bGUubWF4V2lkdGggPSBgJHsoMTAwICogcGFyZW50SGVpZ2h0IC8gcGFyZW50V2lkdGgpLnRvRml4ZWQoMil9JWA7CiAgICAgIGRpdi5zdHlsZS5tYXhIZWlnaHQgPSBgJHsoMTAwICogcGFyZW50V2lkdGggLyBwYXJlbnRIZWlnaHQpLnRvRml4ZWQoMil9JWA7CiAgICB9CiAgICBjb25zdCBbdHgsIHR5XSA9IHRoaXMuZ2V0SW5pdGlhbFRyYW5zbGF0aW9uKCk7CiAgICB0aGlzLnRyYW5zbGF0ZSh0eCwgdHkpOwogICAgYmluZEV2ZW50cyh0aGlzLCBkaXYsIFsia2V5ZG93biIsICJwb2ludGVyZG93biIsICJkYmxjbGljayJdKTsKICAgIGlmICh0aGlzLmlzUmVzaXphYmxlICYmIHRoaXMuX3VpTWFuYWdlci5fc3VwcG9ydHNQaW5jaFRvWm9vbSkgewogICAgICB0aGlzLiN0b3VjaE1hbmFnZXIgfHw9IG5ldyBUb3VjaE1hbmFnZXIoewogICAgICAgIGNvbnRhaW5lcjogZGl2LAogICAgICAgIGlzUGluY2hpbmdEaXNhYmxlZDogKCkgPT4gIXRoaXMuaXNTZWxlY3RlZCwKICAgICAgICBvblBpbmNoU3RhcnQ6IHRoaXMuI3RvdWNoUGluY2hTdGFydENhbGxiYWNrLmJpbmQodGhpcyksCiAgICAgICAgb25QaW5jaGluZzogdGhpcy4jdG91Y2hQaW5jaENhbGxiYWNrLmJpbmQodGhpcyksCiAgICAgICAgb25QaW5jaEVuZDogdGhpcy4jdG91Y2hQaW5jaEVuZENhbGxiYWNrLmJpbmQodGhpcyksCiAgICAgICAgc2lnbmFsOiB0aGlzLl91aU1hbmFnZXIuX3NpZ25hbAogICAgICB9KTsKICAgIH0KICAgIHRoaXMuYWRkU3RhbmRhbG9uZUNvbW1lbnRCdXR0b24oKTsKICAgIHRoaXMuX3VpTWFuYWdlci5fZWRpdG9yVW5kb0Jhcj8uaGlkZSgpOwogICAgcmV0dXJuIGRpdjsKICB9CiAgI3RvdWNoUGluY2hTdGFydENhbGxiYWNrKCkgewogICAgdGhpcy4jc2F2ZWREaW1lbnNpb25zID0gewogICAgICBzYXZlZFg6IHRoaXMueCwKICAgICAgc2F2ZWRZOiB0aGlzLnksCiAgICAgIHNhdmVkV2lkdGg6IHRoaXMud2lkdGgsCiAgICAgIHNhdmVkSGVpZ2h0OiB0aGlzLmhlaWdodAogICAgfTsKICAgIHRoaXMuI2FsdFRleHQ/LnRvZ2dsZShmYWxzZSk7CiAgICB0aGlzLnBhcmVudC50b2dnbGVQb2ludGVyRXZlbnRzKGZhbHNlKTsKICB9CiAgI3RvdWNoUGluY2hDYWxsYmFjayhfb3JpZ2luLCBwcmV2RGlzdGFuY2UsIGRpc3RhbmNlKSB7CiAgICBjb25zdCBzbG93RG93bkZhY3RvciA9IDAuNzsKICAgIGxldCBmYWN0b3IgPSBzbG93RG93bkZhY3RvciAqIChkaXN0YW5jZSAvIHByZXZEaXN0YW5jZSkgKyAxIC0gc2xvd0Rvd25GYWN0b3I7CiAgICBpZiAoZmFjdG9yID09PSAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHJvdGF0aW9uTWF0cml4ID0gdGhpcy4jZ2V0Um90YXRpb25NYXRyaXgodGhpcy5yb3RhdGlvbik7CiAgICBjb25zdCB0cmFuc2YgPSAoeCwgeSkgPT4gW3JvdGF0aW9uTWF0cml4WzBdICogeCArIHJvdGF0aW9uTWF0cml4WzJdICogeSwgcm90YXRpb25NYXRyaXhbMV0gKiB4ICsgcm90YXRpb25NYXRyaXhbM10gKiB5XTsKICAgIGNvbnN0IFtwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0XSA9IHRoaXMucGFyZW50RGltZW5zaW9uczsKICAgIGNvbnN0IHNhdmVkWCA9IHRoaXMueDsKICAgIGNvbnN0IHNhdmVkWSA9IHRoaXMueTsKICAgIGNvbnN0IHNhdmVkV2lkdGggPSB0aGlzLndpZHRoOwogICAgY29uc3Qgc2F2ZWRIZWlnaHQgPSB0aGlzLmhlaWdodDsKICAgIGNvbnN0IG1pbldpZHRoID0gX0Fubm90YXRpb25FZGl0b3IuTUlOX1NJWkUgLyBwYXJlbnRXaWR0aDsKICAgIGNvbnN0IG1pbkhlaWdodCA9IF9Bbm5vdGF0aW9uRWRpdG9yLk1JTl9TSVpFIC8gcGFyZW50SGVpZ2h0OwogICAgZmFjdG9yID0gTWF0aC5tYXgoTWF0aC5taW4oZmFjdG9yLCAxIC8gc2F2ZWRXaWR0aCwgMSAvIHNhdmVkSGVpZ2h0KSwgbWluV2lkdGggLyBzYXZlZFdpZHRoLCBtaW5IZWlnaHQgLyBzYXZlZEhlaWdodCk7CiAgICBjb25zdCBuZXdXaWR0aCA9IF9Bbm5vdGF0aW9uRWRpdG9yLl9yb3VuZChzYXZlZFdpZHRoICogZmFjdG9yKTsKICAgIGNvbnN0IG5ld0hlaWdodCA9IF9Bbm5vdGF0aW9uRWRpdG9yLl9yb3VuZChzYXZlZEhlaWdodCAqIGZhY3Rvcik7CiAgICBpZiAobmV3V2lkdGggPT09IHNhdmVkV2lkdGggJiYgbmV3SGVpZ2h0ID09PSBzYXZlZEhlaWdodCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNpbml0aWFsUmVjdCB8fD0gW3NhdmVkWCwgc2F2ZWRZLCBzYXZlZFdpZHRoLCBzYXZlZEhlaWdodF07CiAgICBjb25zdCB0cmFuc2ZDZW50ZXJQb2ludCA9IHRyYW5zZihzYXZlZFdpZHRoIC8gMiwgc2F2ZWRIZWlnaHQgLyAyKTsKICAgIGNvbnN0IGNlbnRlclggPSBfQW5ub3RhdGlvbkVkaXRvci5fcm91bmQoc2F2ZWRYICsgdHJhbnNmQ2VudGVyUG9pbnRbMF0pOwogICAgY29uc3QgY2VudGVyWSA9IF9Bbm5vdGF0aW9uRWRpdG9yLl9yb3VuZChzYXZlZFkgKyB0cmFuc2ZDZW50ZXJQb2ludFsxXSk7CiAgICBjb25zdCBuZXdUcmFuc2ZDZW50ZXJQb2ludCA9IHRyYW5zZihuZXdXaWR0aCAvIDIsIG5ld0hlaWdodCAvIDIpOwogICAgdGhpcy54ID0gY2VudGVyWCAtIG5ld1RyYW5zZkNlbnRlclBvaW50WzBdOwogICAgdGhpcy55ID0gY2VudGVyWSAtIG5ld1RyYW5zZkNlbnRlclBvaW50WzFdOwogICAgdGhpcy53aWR0aCA9IG5ld1dpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBuZXdIZWlnaHQ7CiAgICB0aGlzLnNldERpbXMoKTsKICAgIHRoaXMuZml4QW5kU2V0UG9zaXRpb24oKTsKICAgIHRoaXMuX29uUmVzaXppbmcoKTsKICB9CiAgI3RvdWNoUGluY2hFbmRDYWxsYmFjaygpIHsKICAgIHRoaXMuI2FsdFRleHQ/LnRvZ2dsZSh0cnVlKTsKICAgIHRoaXMucGFyZW50LnRvZ2dsZVBvaW50ZXJFdmVudHModHJ1ZSk7CiAgICB0aGlzLiNhZGRSZXNpemVUb1VuZG9TdGFjaygpOwogIH0KICBwb2ludGVyZG93bihldmVudCkgewogICAgY29uc3QgewogICAgICBpc01hYwogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICBpZiAoZXZlbnQuYnV0dG9uICE9PSAwIHx8IGV2ZW50LmN0cmxLZXkgJiYgaXNNYWMpIHsKICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jaGFzQmVlbkNsaWNrZWQgPSB0cnVlOwogICAgaWYgKHRoaXMuX2lzRHJhZ2dhYmxlKSB7CiAgICAgIHRoaXMuI3NldFVwRHJhZ1Nlc3Npb24oZXZlbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNzZWxlY3RPblBvaW50ZXJFdmVudChldmVudCk7CiAgfQogICNzZWxlY3RPblBvaW50ZXJFdmVudChldmVudCkgewogICAgY29uc3QgewogICAgICBpc01hYwogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICBpZiAoZXZlbnQuY3RybEtleSAmJiAhaXNNYWMgfHwgZXZlbnQuc2hpZnRLZXkgfHwgZXZlbnQubWV0YUtleSAmJiBpc01hYykgewogICAgICB0aGlzLnBhcmVudC50b2dnbGVTZWxlY3RlZCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucGFyZW50LnNldFNlbGVjdGVkKHRoaXMpOwogICAgfQogIH0KICAjc2V0VXBEcmFnU2Vzc2lvbihldmVudCkgewogICAgY29uc3QgewogICAgICBpc1NlbGVjdGVkCiAgICB9ID0gdGhpczsKICAgIHRoaXMuX3VpTWFuYWdlci5zZXRVcERyYWdTZXNzaW9uKCk7CiAgICBsZXQgaGFzRHJhZ2dpbmdTdGFydGVkID0gZmFsc2U7CiAgICBjb25zdCBhYyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuX3VpTWFuYWdlci5jb21iaW5lZFNpZ25hbChhYyk7CiAgICBjb25zdCBvcHRzID0gewogICAgICBjYXB0dXJlOiB0cnVlLAogICAgICBwYXNzaXZlOiBmYWxzZSwKICAgICAgc2lnbmFsCiAgICB9OwogICAgY29uc3QgY2FuY2VsRHJhZyA9IChlKSA9PiB7CiAgICAgIGFjLmFib3J0KCk7CiAgICAgIHRoaXMuI2RyYWdQb2ludGVySWQgPSBudWxsOwogICAgICB0aGlzLiNoYXNCZWVuQ2xpY2tlZCA9IGZhbHNlOwogICAgICBpZiAoIXRoaXMuX3VpTWFuYWdlci5lbmREcmFnU2Vzc2lvbigpKSB7CiAgICAgICAgdGhpcy4jc2VsZWN0T25Qb2ludGVyRXZlbnQoZSk7CiAgICAgIH0KICAgICAgaWYgKGhhc0RyYWdnaW5nU3RhcnRlZCkgewogICAgICAgIHRoaXMuX29uU3RvcERyYWdnaW5nKCk7CiAgICAgIH0KICAgIH07CiAgICBpZiAoaXNTZWxlY3RlZCkgewogICAgICB0aGlzLiNwcmV2RHJhZ1ggPSBldmVudC5jbGllbnRYOwogICAgICB0aGlzLiNwcmV2RHJhZ1kgPSBldmVudC5jbGllbnRZOwogICAgICB0aGlzLiNkcmFnUG9pbnRlcklkID0gZXZlbnQucG9pbnRlcklkOwogICAgICB0aGlzLiNkcmFnUG9pbnRlclR5cGUgPSBldmVudC5wb2ludGVyVHlwZTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJtb3ZlIiwgKGUpID0+IHsKICAgICAgICBpZiAoIWhhc0RyYWdnaW5nU3RhcnRlZCkgewogICAgICAgICAgaGFzRHJhZ2dpbmdTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuX3VpTWFuYWdlci50b2dnbGVDb21tZW50KHRoaXMsIHRydWUsIGZhbHNlKTsKICAgICAgICAgIHRoaXMuX29uU3RhcnREcmFnZ2luZygpOwogICAgICAgIH0KICAgICAgICBjb25zdCB7CiAgICAgICAgICBjbGllbnRYOiB4LAogICAgICAgICAgY2xpZW50WTogeSwKICAgICAgICAgIHBvaW50ZXJJZAogICAgICAgIH0gPSBlOwogICAgICAgIGlmIChwb2ludGVySWQgIT09IHRoaXMuI2RyYWdQb2ludGVySWQpIHsKICAgICAgICAgIHN0b3BFdmVudChlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgW3R4LCB0eV0gPSB0aGlzLnNjcmVlblRvUGFnZVRyYW5zbGF0aW9uKHggLSB0aGlzLiNwcmV2RHJhZ1gsIHkgLSB0aGlzLiNwcmV2RHJhZ1kpOwogICAgICAgIHRoaXMuI3ByZXZEcmFnWCA9IHg7CiAgICAgICAgdGhpcy4jcHJldkRyYWdZID0geTsKICAgICAgICB0aGlzLl91aU1hbmFnZXIuZHJhZ1NlbGVjdGVkRWRpdG9ycyh0eCwgdHkpOwogICAgICB9LCBvcHRzKTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRvdWNobW92ZSIsIHN0b3BFdmVudCwgb3B0cyk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIChlKSA9PiB7CiAgICAgICAgaWYgKGUucG9pbnRlclR5cGUgPT09IHRoaXMuI2RyYWdQb2ludGVyVHlwZSkgewogICAgICAgICAgaWYgKHRoaXMuI3RvdWNoTWFuYWdlciB8fCBlLmlzUHJpbWFyeSkgewogICAgICAgICAgICBjYW5jZWxEcmFnKGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdG9wRXZlbnQoZSk7CiAgICAgIH0sIG9wdHMpOwogICAgfQogICAgY29uc3QgcG9pbnRlclVwQ2FsbGJhY2sgPSAoZSkgPT4gewogICAgICBpZiAoIXRoaXMuI2RyYWdQb2ludGVySWQgfHwgdGhpcy4jZHJhZ1BvaW50ZXJJZCA9PT0gZS5wb2ludGVySWQpIHsKICAgICAgICBjYW5jZWxEcmFnKGUpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzdG9wRXZlbnQoZSk7CiAgICB9OwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHBvaW50ZXJVcENhbGxiYWNrLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIHBvaW50ZXJVcENhbGxiYWNrLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgfQogIF9vblN0YXJ0RHJhZ2dpbmcoKSB7CiAgfQogIF9vblN0b3BEcmFnZ2luZygpIHsKICB9CiAgbW92ZUluRE9NKCkgewogICAgaWYgKHRoaXMuI21vdmVJbkRPTVRpbWVvdXQpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuI21vdmVJbkRPTVRpbWVvdXQpOwogICAgfQogICAgdGhpcy4jbW92ZUluRE9NVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aGlzLiNtb3ZlSW5ET01UaW1lb3V0ID0gbnVsbDsKICAgICAgdGhpcy5wYXJlbnQ/Lm1vdmVFZGl0b3JJbkRPTSh0aGlzKTsKICAgIH0sIDApOwogIH0KICBfc2V0UGFyZW50QW5kUG9zaXRpb24ocGFyZW50LCB4LCB5KSB7CiAgICBwYXJlbnQuY2hhbmdlUGFyZW50KHRoaXMpOwogICAgdGhpcy54ID0geDsKICAgIHRoaXMueSA9IHk7CiAgICB0aGlzLmZpeEFuZFNldFBvc2l0aW9uKCk7CiAgICB0aGlzLl9vblRyYW5zbGF0ZWQoKTsKICB9CiAgZ2V0UmVjdCh0eCwgdHksIHJvdGF0aW9uID0gdGhpcy5yb3RhdGlvbikgewogICAgY29uc3Qgc2NhbGUgPSB0aGlzLnBhcmVudFNjYWxlOwogICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhZ2VEaW1lbnNpb25zOwogICAgY29uc3QgW3BhZ2VYLCBwYWdlWV0gPSB0aGlzLnBhZ2VUcmFuc2xhdGlvbjsKICAgIGNvbnN0IHNoaWZ0WCA9IHR4IC8gc2NhbGU7CiAgICBjb25zdCBzaGlmdFkgPSB0eSAvIHNjYWxlOwogICAgY29uc3QgeCA9IHRoaXMueCAqIHBhZ2VXaWR0aDsKICAgIGNvbnN0IHkgPSB0aGlzLnkgKiBwYWdlSGVpZ2h0OwogICAgY29uc3Qgd2lkdGggPSB0aGlzLndpZHRoICogcGFnZVdpZHRoOwogICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKiBwYWdlSGVpZ2h0OwogICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIFt4ICsgc2hpZnRYICsgcGFnZVgsIHBhZ2VIZWlnaHQgLSB5IC0gc2hpZnRZIC0gaGVpZ2h0ICsgcGFnZVksIHggKyBzaGlmdFggKyB3aWR0aCArIHBhZ2VYLCBwYWdlSGVpZ2h0IC0geSAtIHNoaWZ0WSArIHBhZ2VZXTsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXR1cm4gW3ggKyBzaGlmdFkgKyBwYWdlWCwgcGFnZUhlaWdodCAtIHkgKyBzaGlmdFggKyBwYWdlWSwgeCArIHNoaWZ0WSArIGhlaWdodCArIHBhZ2VYLCBwYWdlSGVpZ2h0IC0geSArIHNoaWZ0WCArIHdpZHRoICsgcGFnZVldOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXR1cm4gW3ggLSBzaGlmdFggLSB3aWR0aCArIHBhZ2VYLCBwYWdlSGVpZ2h0IC0geSArIHNoaWZ0WSArIHBhZ2VZLCB4IC0gc2hpZnRYICsgcGFnZVgsIHBhZ2VIZWlnaHQgLSB5ICsgc2hpZnRZICsgaGVpZ2h0ICsgcGFnZVldOwogICAgICBjYXNlIDI3MDoKICAgICAgICByZXR1cm4gW3ggLSBzaGlmdFkgLSBoZWlnaHQgKyBwYWdlWCwgcGFnZUhlaWdodCAtIHkgLSBzaGlmdFggLSB3aWR0aCArIHBhZ2VZLCB4IC0gc2hpZnRZICsgcGFnZVgsIHBhZ2VIZWlnaHQgLSB5IC0gc2hpZnRYICsgcGFnZVldOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCByb3RhdGlvbiIpOwogICAgfQogIH0KICBnZXRSZWN0SW5DdXJyZW50Q29vcmRzKHJlY3QsIHBhZ2VIZWlnaHQpIHsKICAgIGNvbnN0IFt4MSwgeTEsIHgyLCB5Ml0gPSByZWN0OwogICAgY29uc3Qgd2lkdGggPSB4MiAtIHgxOwogICAgY29uc3QgaGVpZ2h0ID0geTIgLSB5MTsKICAgIHN3aXRjaCAodGhpcy5yb3RhdGlvbikgewogICAgICBjYXNlIDA6CiAgICAgICAgcmV0dXJuIFt4MSwgcGFnZUhlaWdodCAtIHkyLCB3aWR0aCwgaGVpZ2h0XTsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXR1cm4gW3gxLCBwYWdlSGVpZ2h0IC0geTEsIGhlaWdodCwgd2lkdGhdOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXR1cm4gW3gyLCBwYWdlSGVpZ2h0IC0geTEsIHdpZHRoLCBoZWlnaHRdOwogICAgICBjYXNlIDI3MDoKICAgICAgICByZXR1cm4gW3gyLCBwYWdlSGVpZ2h0IC0geTIsIGhlaWdodCwgd2lkdGhdOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCByb3RhdGlvbiIpOwogICAgfQogIH0KICBnZXRQREZSZWN0KCkgewogICAgcmV0dXJuIHRoaXMuZ2V0UmVjdCgwLCAwKTsKICB9CiAgZ2V0Tm9uSENNQ29sb3IoKSB7CiAgICByZXR1cm4gdGhpcy5jb2xvciAmJiBfQW5ub3RhdGlvbkVkaXRvci5fY29sb3JNYW5hZ2VyLmNvbnZlcnQodGhpcy5fdWlNYW5hZ2VyLmdldE5vbkhDTUNvbG9yKHRoaXMuY29sb3IpKTsKICB9CiAgb25VcGRhdGVkQ29sb3IoKSB7CiAgICB0aGlzLiNjb21tZW50Py5vblVwZGF0ZWRDb2xvcigpOwogIH0KICBnZXREYXRhKCkgewogICAgY29uc3QgewogICAgICBjb21tZW50OiB7CiAgICAgICAgdGV4dDogc3RyLAogICAgICAgIGNvbG9yLAogICAgICAgIGRhdGUsCiAgICAgICAgb3BhY2l0eSwKICAgICAgICBkZWxldGVkLAogICAgICAgIHJpY2hUZXh0CiAgICAgIH0sCiAgICAgIHVpZDogaWQsCiAgICAgIHBhZ2VJbmRleCwKICAgICAgY3JlYXRpb25EYXRlLAogICAgICBtb2RpZmljYXRpb25EYXRlCiAgICB9ID0gdGhpczsKICAgIHJldHVybiB7CiAgICAgIGlkLAogICAgICBwYWdlSW5kZXgsCiAgICAgIHJlY3Q6IHRoaXMuZ2V0UERGUmVjdCgpLAogICAgICByaWNoVGV4dCwKICAgICAgY29udGVudHNPYmo6IHsKICAgICAgICBzdHIKICAgICAgfSwKICAgICAgY3JlYXRpb25EYXRlLAogICAgICBtb2RpZmljYXRpb25EYXRlOiBkYXRlIHx8IG1vZGlmaWNhdGlvbkRhdGUsCiAgICAgIHBvcHVwUmVmOiAhZGVsZXRlZCwKICAgICAgY29sb3IsCiAgICAgIG9wYWNpdHkKICAgIH07CiAgfQogIG9uY2VBZGRlZChmb2N1cykgewogIH0KICBpc0VtcHR5KCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBlbmFibGVFZGl0TW9kZSgpIHsKICAgIGlmICh0aGlzLmlzSW5FZGl0TW9kZSgpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRoaXMucGFyZW50LnNldEVkaXRpbmdTdGF0ZShmYWxzZSk7CiAgICB0aGlzLiNpc0luRWRpdE1vZGUgPSB0cnVlOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGRpc2FibGVFZGl0TW9kZSgpIHsKICAgIGlmICghdGhpcy5pc0luRWRpdE1vZGUoKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0aGlzLnBhcmVudC5zZXRFZGl0aW5nU3RhdGUodHJ1ZSk7CiAgICB0aGlzLiNpc0luRWRpdE1vZGUgPSBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH0KICBpc0luRWRpdE1vZGUoKSB7CiAgICByZXR1cm4gdGhpcy4jaXNJbkVkaXRNb2RlOwogIH0KICBzaG91bGRHZXRLZXlib2FyZEV2ZW50cygpIHsKICAgIHJldHVybiB0aGlzLiNpc1Jlc2l6ZXJFbmFibGVkRm9yS2V5Ym9hcmQ7CiAgfQogIG5lZWRzVG9CZVJlYnVpbHQoKSB7CiAgICByZXR1cm4gdGhpcy5kaXYgJiYgIXRoaXMuaXNBdHRhY2hlZFRvRE9NOwogIH0KICBnZXQgaXNPblNjcmVlbigpIHsKICAgIGNvbnN0IHsKICAgICAgdG9wLAogICAgICBsZWZ0LAogICAgICBib3R0b20sCiAgICAgIHJpZ2h0CiAgICB9ID0gdGhpcy5nZXRDbGllbnREaW1lbnNpb25zKCk7CiAgICBjb25zdCB7CiAgICAgIGlubmVySGVpZ2h0LAogICAgICBpbm5lcldpZHRoCiAgICB9ID0gd2luZG93OwogICAgcmV0dXJuIGxlZnQgPCBpbm5lcldpZHRoICYmIHJpZ2h0ID4gMCAmJiB0b3AgPCBpbm5lckhlaWdodCAmJiBib3R0b20gPiAwOwogIH0KICAjYWRkRm9jdXNMaXN0ZW5lcnMoKSB7CiAgICBpZiAodGhpcy4jZm9jdXNBQyB8fCAhdGhpcy5kaXYpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jZm9jdXNBQyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuX3VpTWFuYWdlci5jb21iaW5lZFNpZ25hbCh0aGlzLiNmb2N1c0FDKTsKICAgIHRoaXMuZGl2LmFkZEV2ZW50TGlzdGVuZXIoImZvY3VzaW4iLCB0aGlzLmZvY3VzaW4uYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgdGhpcy5kaXYuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXNvdXQiLCB0aGlzLmZvY3Vzb3V0LmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICB9CiAgcmVidWlsZCgpIHsKICAgIHRoaXMuI2FkZEZvY3VzTGlzdGVuZXJzKCk7CiAgfQogIHJvdGF0ZShfYW5nbGUpIHsKICB9CiAgcmVzaXplKCkgewogIH0KICBzZXJpYWxpemVEZWxldGVkKCkgewogICAgcmV0dXJuIHsKICAgICAgaWQ6IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCwKICAgICAgZGVsZXRlZDogdHJ1ZSwKICAgICAgcGFnZUluZGV4OiB0aGlzLnBhZ2VJbmRleCwKICAgICAgcG9wdXBSZWY6IHRoaXMuX2luaXRpYWxEYXRhPy5wb3B1cFJlZiB8fCAiIgogICAgfTsKICB9CiAgc2VyaWFsaXplKGlzRm9yQ29weWluZyA9IGZhbHNlLCBjb250ZXh0ID0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgYW5ub3RhdGlvblR5cGU6IHRoaXMubW9kZSwKICAgICAgcGFnZUluZGV4OiB0aGlzLnBhZ2VJbmRleCwKICAgICAgcmVjdDogdGhpcy5nZXRQREZSZWN0KCksCiAgICAgIHJvdGF0aW9uOiB0aGlzLnJvdGF0aW9uLAogICAgICBzdHJ1Y3RUcmVlUGFyZW50SWQ6IHRoaXMuX3N0cnVjdFRyZWVQYXJlbnRJZCwKICAgICAgcG9wdXBSZWY6IHRoaXMuX2luaXRpYWxEYXRhPy5wb3B1cFJlZiB8fCAiIgogICAgfTsKICB9CiAgc3RhdGljIGFzeW5jIGRlc2VyaWFsaXplKGRhdGEsIHBhcmVudCwgdWlNYW5hZ2VyKSB7CiAgICBjb25zdCBlZGl0b3IgPSBuZXcgdGhpcy5wcm90b3R5cGUuY29uc3RydWN0b3IoewogICAgICBwYXJlbnQsCiAgICAgIGlkOiBwYXJlbnQuZ2V0TmV4dElkKCksCiAgICAgIHVpTWFuYWdlciwKICAgICAgYW5ub3RhdGlvbkVsZW1lbnRJZDogZGF0YS5hbm5vdGF0aW9uRWxlbWVudElkLAogICAgICBjcmVhdGlvbkRhdGU6IGRhdGEuY3JlYXRpb25EYXRlLAogICAgICBtb2RpZmljYXRpb25EYXRlOiBkYXRhLm1vZGlmaWNhdGlvbkRhdGUKICAgIH0pOwogICAgZWRpdG9yLnJvdGF0aW9uID0gZGF0YS5yb3RhdGlvbjsKICAgIGVkaXRvci4jYWNjZXNzaWJpbGl0eURhdGEgPSBkYXRhLmFjY2Vzc2liaWxpdHlEYXRhOwogICAgZWRpdG9yLl9pc0NvcHkgPSBkYXRhLmlzQ29weSB8fCBmYWxzZTsKICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gZWRpdG9yLnBhZ2VEaW1lbnNpb25zOwogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gZWRpdG9yLmdldFJlY3RJbkN1cnJlbnRDb29yZHMoZGF0YS5yZWN0LCBwYWdlSGVpZ2h0KTsKICAgIGVkaXRvci54ID0geCAvIHBhZ2VXaWR0aDsKICAgIGVkaXRvci55ID0geSAvIHBhZ2VIZWlnaHQ7CiAgICBlZGl0b3Iud2lkdGggPSB3aWR0aCAvIHBhZ2VXaWR0aDsKICAgIGVkaXRvci5oZWlnaHQgPSBoZWlnaHQgLyBwYWdlSGVpZ2h0OwogICAgcmV0dXJuIGVkaXRvcjsKICB9CiAgZ2V0IGhhc0JlZW5Nb2RpZmllZCgpIHsKICAgIHJldHVybiAhIXRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCAmJiAodGhpcy5kZWxldGVkIHx8IHRoaXMuc2VyaWFsaXplKCkgIT09IG51bGwpOwogIH0KICByZW1vdmUoKSB7CiAgICB0aGlzLiNmb2N1c0FDPy5hYm9ydCgpOwogICAgdGhpcy4jZm9jdXNBQyA9IG51bGw7CiAgICBpZiAoIXRoaXMuaXNFbXB0eSgpKSB7CiAgICAgIHRoaXMuY29tbWl0KCk7CiAgICB9CiAgICBpZiAodGhpcy5wYXJlbnQpIHsKICAgICAgdGhpcy5wYXJlbnQucmVtb3ZlKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLnJlbW92ZUVkaXRvcih0aGlzKTsKICAgIH0KICAgIHRoaXMuaGlkZUNvbW1lbnRQb3B1cCgpOwogICAgaWYgKHRoaXMuI21vdmVJbkRPTVRpbWVvdXQpIHsKICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuI21vdmVJbkRPTVRpbWVvdXQpOwogICAgICB0aGlzLiNtb3ZlSW5ET01UaW1lb3V0ID0gbnVsbDsKICAgIH0KICAgIHRoaXMuI3N0b3BSZXNpemluZygpOwogICAgdGhpcy5yZW1vdmVFZGl0VG9vbGJhcigpOwogICAgaWYgKHRoaXMuI3RlbGVtZXRyeVRpbWVvdXRzKSB7CiAgICAgIGZvciAoY29uc3QgdGltZW91dCBvZiB0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cy52YWx1ZXMoKSkgewogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgfQogICAgICB0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cyA9IG51bGw7CiAgICB9CiAgICB0aGlzLnBhcmVudCA9IG51bGw7CiAgICB0aGlzLiN0b3VjaE1hbmFnZXI/LmRlc3Ryb3koKTsKICAgIHRoaXMuI3RvdWNoTWFuYWdlciA9IG51bGw7CiAgICB0aGlzLiNmYWtlQW5ub3RhdGlvbj8ucmVtb3ZlKCk7CiAgICB0aGlzLiNmYWtlQW5ub3RhdGlvbiA9IG51bGw7CiAgfQogIGdldCBpc1Jlc2l6YWJsZSgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgbWFrZVJlc2l6YWJsZSgpIHsKICAgIGlmICh0aGlzLmlzUmVzaXphYmxlKSB7CiAgICAgIHRoaXMuI2NyZWF0ZVJlc2l6ZXJzKCk7CiAgICAgIHRoaXMuI3Jlc2l6ZXJzRGl2LmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgfQogIH0KICBnZXQgdG9vbGJhclBvc2l0aW9uKCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGdldCBjb21tZW50QnV0dG9uUG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fdWlNYW5hZ2VyLmRpcmVjdGlvbiA9PT0gImx0ciIgPyBbMSwgMF0gOiBbMCwgMF07CiAgfQogIGdldCBjb21tZW50QnV0dG9uUG9zaXRpb25JblBhZ2UoKSB7CiAgICBjb25zdCB7CiAgICAgIGNvbW1lbnRCdXR0b25Qb3NpdGlvbjogW3Bvc1gsIHBvc1ldCiAgICB9ID0gdGhpczsKICAgIGNvbnN0IFtibFgsIGJsWSwgdHJYLCB0clldID0gdGhpcy5nZXRQREZSZWN0KCk7CiAgICByZXR1cm4gW19Bbm5vdGF0aW9uRWRpdG9yLl9yb3VuZChibFggKyAodHJYIC0gYmxYKSAqIHBvc1gpLCBfQW5ub3RhdGlvbkVkaXRvci5fcm91bmQoYmxZICsgKHRyWSAtIGJsWSkgKiAoMSAtIHBvc1kpKV07CiAgfQogIGdldCBjb21tZW50QnV0dG9uQ29sb3IoKSB7CiAgICByZXR1cm4gdGhpcy5fdWlNYW5hZ2VyLm1ha2VDb21tZW50Q29sb3IodGhpcy5nZXROb25IQ01Db2xvcigpLCB0aGlzLm9wYWNpdHkpOwogIH0KICBnZXQgY29tbWVudFBvcHVwUG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy4jY29tbWVudC5jb21tZW50UG9wdXBQb3NpdGlvbkluTGF5ZXI7CiAgfQogIHNldCBjb21tZW50UG9wdXBQb3NpdGlvbihwb3MpIHsKICAgIHRoaXMuI2NvbW1lbnQuY29tbWVudFBvcHVwUG9zaXRpb25JbkxheWVyID0gcG9zOwogIH0KICBoYXNEZWZhdWx0UG9wdXBQb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50Lmhhc0RlZmF1bHRQb3B1cFBvc2l0aW9uKCk7CiAgfQogIGdldCBjb21tZW50QnV0dG9uV2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy4jY29tbWVudC5jb21tZW50QnV0dG9uV2lkdGg7CiAgfQogIGdldCBlbGVtZW50QmVmb3JlUG9wdXAoKSB7CiAgICByZXR1cm4gdGhpcy5kaXY7CiAgfQogIHNldENvbW1lbnRCdXR0b25TdGF0ZXMob3B0aW9ucykgewogICAgdGhpcy4jY29tbWVudD8uc2V0Q29tbWVudEJ1dHRvblN0YXRlcyhvcHRpb25zKTsKICB9CiAga2V5ZG93bihldmVudCkgewogICAgaWYgKCF0aGlzLmlzUmVzaXphYmxlIHx8IGV2ZW50LnRhcmdldCAhPT0gdGhpcy5kaXYgfHwgZXZlbnQua2V5ICE9PSAiRW50ZXIiKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX3VpTWFuYWdlci5zZXRTZWxlY3RlZCh0aGlzKTsKICAgIHRoaXMuI3NhdmVkRGltZW5zaW9ucyA9IHsKICAgICAgc2F2ZWRYOiB0aGlzLngsCiAgICAgIHNhdmVkWTogdGhpcy55LAogICAgICBzYXZlZFdpZHRoOiB0aGlzLndpZHRoLAogICAgICBzYXZlZEhlaWdodDogdGhpcy5oZWlnaHQKICAgIH07CiAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMuI3Jlc2l6ZXJzRGl2LmNoaWxkcmVuOwogICAgaWYgKCF0aGlzLiNhbGxSZXNpemVyRGl2cykgewogICAgICB0aGlzLiNhbGxSZXNpemVyRGl2cyA9IEFycmF5LmZyb20oY2hpbGRyZW4pOwogICAgICBjb25zdCBib3VuZFJlc2l6ZXJLZXlkb3duID0gdGhpcy4jcmVzaXplcktleWRvd24uYmluZCh0aGlzKTsKICAgICAgY29uc3QgYm91bmRSZXNpemVyQmx1ciA9IHRoaXMuI3Jlc2l6ZXJCbHVyLmJpbmQodGhpcyk7CiAgICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuX3VpTWFuYWdlci5fc2lnbmFsOwogICAgICBmb3IgKGNvbnN0IGRpdiBvZiB0aGlzLiNhbGxSZXNpemVyRGl2cykgewogICAgICAgIGNvbnN0IG5hbWUgPSBkaXYuZ2V0QXR0cmlidXRlKCJkYXRhLXJlc2l6ZXItbmFtZSIpOwogICAgICAgIGRpdi5zZXRBdHRyaWJ1dGUoInJvbGUiLCAic3BpbmJ1dHRvbiIpOwogICAgICAgIGRpdi5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgYm91bmRSZXNpemVyS2V5ZG93biwgewogICAgICAgICAgc2lnbmFsCiAgICAgICAgfSk7CiAgICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoImJsdXIiLCBib3VuZFJlc2l6ZXJCbHVyLCB7CiAgICAgICAgICBzaWduYWwKICAgICAgICB9KTsKICAgICAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXMiLCB0aGlzLiNyZXNpemVyRm9jdXMuYmluZCh0aGlzLCBuYW1lKSwgewogICAgICAgICAgc2lnbmFsCiAgICAgICAgfSk7CiAgICAgICAgZGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0Fubm90YXRpb25FZGl0b3IuX2wxMG5SZXNpemVyW25hbWVdKTsKICAgICAgfQogICAgfQogICAgY29uc3QgZmlyc3QgPSB0aGlzLiNhbGxSZXNpemVyRGl2c1swXTsKICAgIGxldCBmaXJzdFBvc2l0aW9uID0gMDsKICAgIGZvciAoY29uc3QgZGl2IG9mIGNoaWxkcmVuKSB7CiAgICAgIGlmIChkaXYgPT09IGZpcnN0KSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgZmlyc3RQb3NpdGlvbisrOwogICAgfQogICAgY29uc3QgbmV4dEZpcnN0UG9zaXRpb24gPSAoMzYwIC0gdGhpcy5yb3RhdGlvbiArIHRoaXMucGFyZW50Um90YXRpb24pICUgMzYwIC8gOTAgKiAodGhpcy4jYWxsUmVzaXplckRpdnMubGVuZ3RoIC8gNCk7CiAgICBpZiAobmV4dEZpcnN0UG9zaXRpb24gIT09IGZpcnN0UG9zaXRpb24pIHsKICAgICAgaWYgKG5leHRGaXJzdFBvc2l0aW9uIDwgZmlyc3RQb3NpdGlvbikgewogICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBmaXJzdFBvc2l0aW9uIC0gbmV4dEZpcnN0UG9zaXRpb247IGkyKyspIHsKICAgICAgICAgIHRoaXMuI3Jlc2l6ZXJzRGl2LmFwcGVuZCh0aGlzLiNyZXNpemVyc0Rpdi5maXJzdEVsZW1lbnRDaGlsZCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG5leHRGaXJzdFBvc2l0aW9uID4gZmlyc3RQb3NpdGlvbikgewogICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBuZXh0Rmlyc3RQb3NpdGlvbiAtIGZpcnN0UG9zaXRpb247IGkyKyspIHsKICAgICAgICAgIHRoaXMuI3Jlc2l6ZXJzRGl2LmZpcnN0RWxlbWVudENoaWxkLmJlZm9yZSh0aGlzLiNyZXNpemVyc0Rpdi5sYXN0RWxlbWVudENoaWxkKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IGkgPSAwOwogICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIGNoaWxkcmVuKSB7CiAgICAgICAgY29uc3QgZGl2ID0gdGhpcy4jYWxsUmVzaXplckRpdnNbaSsrXTsKICAgICAgICBjb25zdCBuYW1lID0gZGl2LmdldEF0dHJpYnV0ZSgiZGF0YS1yZXNpemVyLW5hbWUiKTsKICAgICAgICBjaGlsZC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIF9Bbm5vdGF0aW9uRWRpdG9yLl9sMTBuUmVzaXplcltuYW1lXSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI3NldFJlc2l6ZXJUYWJJbmRleCgwKTsKICAgIHRoaXMuI2lzUmVzaXplckVuYWJsZWRGb3JLZXlib2FyZCA9IHRydWU7CiAgICB0aGlzLiNyZXNpemVyc0Rpdi5maXJzdEVsZW1lbnRDaGlsZC5mb2N1cyh7CiAgICAgIGZvY3VzVmlzaWJsZTogdHJ1ZQogICAgfSk7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgfQogICNyZXNpemVyS2V5ZG93bihldmVudCkgewogICAgX0Fubm90YXRpb25FZGl0b3IuX3Jlc2l6ZXJLZXlib2FyZE1hbmFnZXIuZXhlYyh0aGlzLCBldmVudCk7CiAgfQogICNyZXNpemVyQmx1cihldmVudCkgewogICAgaWYgKHRoaXMuI2lzUmVzaXplckVuYWJsZWRGb3JLZXlib2FyZCAmJiBldmVudC5yZWxhdGVkVGFyZ2V0Py5wYXJlbnROb2RlICE9PSB0aGlzLiNyZXNpemVyc0RpdikgewogICAgICB0aGlzLiNzdG9wUmVzaXppbmcoKTsKICAgIH0KICB9CiAgI3Jlc2l6ZXJGb2N1cyhuYW1lKSB7CiAgICB0aGlzLiNmb2N1c2VkUmVzaXplck5hbWUgPSB0aGlzLiNpc1Jlc2l6ZXJFbmFibGVkRm9yS2V5Ym9hcmQgPyBuYW1lIDogIiI7CiAgfQogICNzZXRSZXNpemVyVGFiSW5kZXgodmFsdWUpIHsKICAgIGlmICghdGhpcy4jYWxsUmVzaXplckRpdnMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChjb25zdCBkaXYgb2YgdGhpcy4jYWxsUmVzaXplckRpdnMpIHsKICAgICAgZGl2LnRhYkluZGV4ID0gdmFsdWU7CiAgICB9CiAgfQogIF9yZXNpemVXaXRoS2V5Ym9hcmQoeCwgeSkgewogICAgaWYgKCF0aGlzLiNpc1Jlc2l6ZXJFbmFibGVkRm9yS2V5Ym9hcmQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jcmVzaXplclBvaW50ZXJtb3ZlKHRoaXMuI2ZvY3VzZWRSZXNpemVyTmFtZSwgewogICAgICBkZWx0YVg6IHgsCiAgICAgIGRlbHRhWTogeSwKICAgICAgZnJvbUtleWJvYXJkOiB0cnVlCiAgICB9KTsKICB9CiAgI3N0b3BSZXNpemluZygpIHsKICAgIHRoaXMuI2lzUmVzaXplckVuYWJsZWRGb3JLZXlib2FyZCA9IGZhbHNlOwogICAgdGhpcy4jc2V0UmVzaXplclRhYkluZGV4KC0xKTsKICAgIHRoaXMuI2FkZFJlc2l6ZVRvVW5kb1N0YWNrKCk7CiAgfQogIF9zdG9wUmVzaXppbmdXaXRoS2V5Ym9hcmQoKSB7CiAgICB0aGlzLiNzdG9wUmVzaXppbmcoKTsKICAgIHRoaXMuZGl2LmZvY3VzKCk7CiAgfQogIHNlbGVjdCgpIHsKICAgIGlmICh0aGlzLmlzU2VsZWN0ZWQgJiYgdGhpcy5fZWRpdFRvb2xiYXIpIHsKICAgICAgdGhpcy5fZWRpdFRvb2xiYXIuc2hvdygpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmlzU2VsZWN0ZWQgPSB0cnVlOwogICAgdGhpcy5tYWtlUmVzaXphYmxlKCk7CiAgICB0aGlzLmRpdj8uY2xhc3NMaXN0LmFkZCgic2VsZWN0ZWRFZGl0b3IiKTsKICAgIGlmICghdGhpcy5fZWRpdFRvb2xiYXIpIHsKICAgICAgdGhpcy5hZGRFZGl0VG9vbGJhcigpLnRoZW4oKCkgPT4gewogICAgICAgIGlmICh0aGlzLmRpdj8uY2xhc3NMaXN0LmNvbnRhaW5zKCJzZWxlY3RlZEVkaXRvciIpKSB7CiAgICAgICAgICB0aGlzLl9lZGl0VG9vbGJhcj8uc2hvdygpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2VkaXRUb29sYmFyPy5zaG93KCk7CiAgICB0aGlzLiNhbHRUZXh0Py50b2dnbGVBbHRUZXh0QmFkZ2UoZmFsc2UpOwogIH0KICBmb2N1cygpIHsKICAgIGlmICh0aGlzLmRpdiAmJiAhdGhpcy5kaXYuY29udGFpbnMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkpIHsKICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmRpdj8uZm9jdXMoewogICAgICAgIHByZXZlbnRTY3JvbGw6IHRydWUKICAgICAgfSksIDApOwogICAgfQogIH0KICB1bnNlbGVjdCgpIHsKICAgIGlmICghdGhpcy5pc1NlbGVjdGVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuaXNTZWxlY3RlZCA9IGZhbHNlOwogICAgdGhpcy4jcmVzaXplcnNEaXY/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogICAgdGhpcy5kaXY/LmNsYXNzTGlzdC5yZW1vdmUoInNlbGVjdGVkRWRpdG9yIik7CiAgICBpZiAodGhpcy5kaXY/LmNvbnRhaW5zKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpKSB7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5jdXJyZW50TGF5ZXIuZGl2LmZvY3VzKHsKICAgICAgICBwcmV2ZW50U2Nyb2xsOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fZWRpdFRvb2xiYXI/LmhpZGUoKTsKICAgIHRoaXMuI2FsdFRleHQ/LnRvZ2dsZUFsdFRleHRCYWRnZSh0cnVlKTsKICAgIHRoaXMuaGlkZUNvbW1lbnRQb3B1cCgpOwogIH0KICBoaWRlQ29tbWVudFBvcHVwKCkgewogICAgaWYgKHRoaXMuaGFzQ29tbWVudCkgewogICAgICB0aGlzLl91aU1hbmFnZXIudG9nZ2xlQ29tbWVudChudWxsKTsKICAgIH0KICB9CiAgdXBkYXRlUGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgfQogIGRpc2FibGVFZGl0aW5nKCkgewogIH0KICBlbmFibGVFZGl0aW5nKCkgewogIH0KICBnZXQgY2FuQ2hhbmdlQ29udGVudCgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZW50ZXJJbkVkaXRNb2RlKCkgewogICAgaWYgKCF0aGlzLmNhbkNoYW5nZUNvbnRlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5lbmFibGVFZGl0TW9kZSgpOwogICAgdGhpcy5kaXYuZm9jdXMoKTsKICB9CiAgZGJsY2xpY2soZXZlbnQpIHsKICAgIGlmIChldmVudC50YXJnZXQubm9kZU5hbWUgPT09ICJCVVRUT04iKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuZW50ZXJJbkVkaXRNb2RlKCk7CiAgICB0aGlzLnBhcmVudC51cGRhdGVUb29sYmFyKHsKICAgICAgbW9kZTogdGhpcy5jb25zdHJ1Y3Rvci5fZWRpdG9yVHlwZSwKICAgICAgZWRpdElkOiB0aGlzLnVpZAogICAgfSk7CiAgfQogIGdldEVsZW1lbnRGb3JBbHRUZXh0KCkgewogICAgcmV0dXJuIHRoaXMuZGl2OwogIH0KICBnZXQgY29udGVudERpdigpIHsKICAgIHJldHVybiB0aGlzLmRpdjsKICB9CiAgZ2V0IGlzRWRpdGluZygpIHsKICAgIHJldHVybiB0aGlzLiNpc0VkaXRpbmc7CiAgfQogIHNldCBpc0VkaXRpbmcodmFsdWUpIHsKICAgIHRoaXMuI2lzRWRpdGluZyA9IHZhbHVlOwogICAgaWYgKCF0aGlzLnBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodmFsdWUpIHsKICAgICAgdGhpcy5wYXJlbnQuc2V0U2VsZWN0ZWQodGhpcyk7CiAgICAgIHRoaXMucGFyZW50LnNldEFjdGl2ZUVkaXRvcih0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucGFyZW50LnNldEFjdGl2ZUVkaXRvcihudWxsKTsKICAgIH0KICB9CiAgc3RhdGljIGdldCBNSU5fU0laRSgpIHsKICAgIHJldHVybiAxNjsKICB9CiAgc3RhdGljIGNhbkNyZWF0ZU5ld0VtcHR5RWRpdG9yKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGdldCB0ZWxlbWV0cnlJbml0aWFsRGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIGFjdGlvbjogImFkZGVkIgogICAgfTsKICB9CiAgZ2V0IHRlbGVtZXRyeUZpbmFsRGF0YSgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBfcmVwb3J0VGVsZW1ldHJ5KGRhdGEsIG11c3RXYWl0ID0gZmFsc2UpIHsKICAgIGlmIChtdXN0V2FpdCkgewogICAgICB0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cyB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgY29uc3QgewogICAgICAgIGFjdGlvbgogICAgICB9ID0gZGF0YTsKICAgICAgbGV0IHRpbWVvdXQgPSB0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cy5nZXQoYWN0aW9uKTsKICAgICAgaWYgKHRpbWVvdXQpIHsKICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgIH0KICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuX3JlcG9ydFRlbGVtZXRyeShkYXRhKTsKICAgICAgICB0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cy5kZWxldGUoYWN0aW9uKTsKICAgICAgICBpZiAodGhpcy4jdGVsZW1ldHJ5VGltZW91dHMuc2l6ZSA9PT0gMCkgewogICAgICAgICAgdGhpcy4jdGVsZW1ldHJ5VGltZW91dHMgPSBudWxsOwogICAgICAgIH0KICAgICAgfSwgX0Fubm90YXRpb25FZGl0b3IuX3RlbGVtZXRyeVRpbWVvdXQpOwogICAgICB0aGlzLiN0ZWxlbWV0cnlUaW1lb3V0cy5zZXQoYWN0aW9uLCB0aW1lb3V0KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgZGF0YS50eXBlIHx8PSB0aGlzLmVkaXRvclR5cGU7CiAgICB0aGlzLl91aU1hbmFnZXIuX2V2ZW50QnVzLmRpc3BhdGNoKCJyZXBvcnR0ZWxlbWV0cnkiLCB7CiAgICAgIHNvdXJjZTogdGhpcywKICAgICAgZGV0YWlsczogewogICAgICAgIHR5cGU6ICJlZGl0aW5nIiwKICAgICAgICBkYXRhCiAgICAgIH0KICAgIH0pOwogIH0KICBzaG93KHZpc2libGUgPSB0aGlzLl9pc1Zpc2libGUpIHsKICAgIHRoaXMuZGl2LmNsYXNzTGlzdC50b2dnbGUoImhpZGRlbiIsICF2aXNpYmxlKTsKICAgIHRoaXMuX2lzVmlzaWJsZSA9IHZpc2libGU7CiAgfQogIGVuYWJsZSgpIHsKICAgIGlmICh0aGlzLmRpdikgewogICAgICB0aGlzLmRpdi50YWJJbmRleCA9IDA7CiAgICB9CiAgICB0aGlzLiNkaXNhYmxlZCA9IGZhbHNlOwogIH0KICBkaXNhYmxlKCkgewogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHRoaXMuZGl2LnRhYkluZGV4ID0gLTE7CiAgICB9CiAgICB0aGlzLiNkaXNhYmxlZCA9IHRydWU7CiAgfQogIHVwZGF0ZUZha2VBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uTGF5ZXIpIHsKICAgIGlmICghdGhpcy4jZmFrZUFubm90YXRpb24gJiYgIXRoaXMuZGVsZXRlZCkgewogICAgICB0aGlzLiNmYWtlQW5ub3RhdGlvbiA9IGFubm90YXRpb25MYXllci5hZGRGYWtlQW5ub3RhdGlvbih0aGlzKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuZGVsZXRlZCkgewogICAgICB0aGlzLiNmYWtlQW5ub3RhdGlvbi5yZW1vdmUoKTsKICAgICAgdGhpcy4jZmFrZUFubm90YXRpb24gPSBudWxsOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5oYXNFZGl0ZWRDb21tZW50IHx8IHRoaXMuX2hhc0JlZW5Nb3ZlZCB8fCB0aGlzLl9oYXNCZWVuUmVzaXplZCkgewogICAgICB0aGlzLiNmYWtlQW5ub3RhdGlvbi51cGRhdGVFZGl0ZWQoewogICAgICAgIHJlY3Q6IHRoaXMuZ2V0UERGUmVjdCgpLAogICAgICAgIHBvcHVwOiB0aGlzLmNvbW1lbnQKICAgICAgfSk7CiAgICB9CiAgfQogIHJlbmRlckFubm90YXRpb25FbGVtZW50KGFubm90YXRpb24pIHsKICAgIGlmICh0aGlzLmRlbGV0ZWQpIHsKICAgICAgYW5ub3RhdGlvbi5oaWRlKCk7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgbGV0IGNvbnRlbnQgPSBhbm5vdGF0aW9uLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCIuYW5ub3RhdGlvbkNvbnRlbnQiKTsKICAgIGlmICghY29udGVudCkgewogICAgICBjb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGNvbnRlbnQuY2xhc3NMaXN0LmFkZCgiYW5ub3RhdGlvbkNvbnRlbnQiLCB0aGlzLmVkaXRvclR5cGUpOwogICAgICBhbm5vdGF0aW9uLmNvbnRhaW5lci5wcmVwZW5kKGNvbnRlbnQpOwogICAgfSBlbHNlIGlmIChjb250ZW50Lm5vZGVOYW1lID09PSAiQ0FOVkFTIikgewogICAgICBjb25zdCBjYW52YXMgPSBjb250ZW50OwogICAgICBjb250ZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGNvbnRlbnQuY2xhc3NMaXN0LmFkZCgiYW5ub3RhdGlvbkNvbnRlbnQiLCB0aGlzLmVkaXRvclR5cGUpOwogICAgICBjYW52YXMuYmVmb3JlKGNvbnRlbnQpOwogICAgfQogICAgcmV0dXJuIGNvbnRlbnQ7CiAgfQogIHJlc2V0QW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbikgewogICAgY29uc3QgewogICAgICBmaXJzdEVsZW1lbnRDaGlsZAogICAgfSA9IGFubm90YXRpb24uY29udGFpbmVyOwogICAgaWYgKGZpcnN0RWxlbWVudENoaWxkPy5ub2RlTmFtZSA9PT0gIkRJViIgJiYgZmlyc3RFbGVtZW50Q2hpbGQuY2xhc3NMaXN0LmNvbnRhaW5zKCJhbm5vdGF0aW9uQ29udGVudCIpKSB7CiAgICAgIGZpcnN0RWxlbWVudENoaWxkLnJlbW92ZSgpOwogICAgfQogIH0KfTsKdmFyIEZha2VFZGl0b3IgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FZGl0b3IgewogIGNvbnN0cnVjdG9yKHBhcmFtcykgewogICAgc3VwZXIocGFyYW1zKTsKICAgIHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCA9IHBhcmFtcy5hbm5vdGF0aW9uRWxlbWVudElkOwogICAgdGhpcy5kZWxldGVkID0gdHJ1ZTsKICB9CiAgc2VyaWFsaXplKCkgewogICAgcmV0dXJuIHRoaXMuc2VyaWFsaXplRGVsZXRlZCgpOwogIH0KfTsKdmFyIFNFRUQgPSAzMjg1Mzc3NTIwOwp2YXIgTUFTS19ISUdIID0gNDI5NDkwMTc2MDsKdmFyIE1BU0tfTE9XID0gNjU1MzU7CnZhciBNdXJtdXJIYXNoM182NCA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihzZWVkKSB7CiAgICB0aGlzLmgxID0gc2VlZCA/IHNlZWQgJiA0Mjk0OTY3Mjk1IDogU0VFRDsKICAgIHRoaXMuaDIgPSBzZWVkID8gc2VlZCAmIDQyOTQ5NjcyOTUgOiBTRUVEOwogIH0KICB1cGRhdGUoaW5wdXQpIHsKICAgIGxldCBkYXRhLCBsZW5ndGg7CiAgICBpZiAodHlwZW9mIGlucHV0ID09PSAic3RyaW5nIikgewogICAgICBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQubGVuZ3RoICogMik7CiAgICAgIGxlbmd0aCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGlucHV0Lmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBjb25zdCBjb2RlID0gaW5wdXQuY2hhckNvZGVBdChpKTsKICAgICAgICBpZiAoY29kZSA8PSAyNTUpIHsKICAgICAgICAgIGRhdGFbbGVuZ3RoKytdID0gY29kZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0YVtsZW5ndGgrK10gPSBjb2RlID4+PiA4OwogICAgICAgICAgZGF0YVtsZW5ndGgrK10gPSBjb2RlICYgMjU1OwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoaW5wdXQpKSB7CiAgICAgIGRhdGEgPSBpbnB1dC5zbGljZSgpOwogICAgICBsZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGF0YSBmb3JtYXQsIG11c3QgYmUgYSBzdHJpbmcgb3IgVHlwZWRBcnJheS4iKTsKICAgIH0KICAgIGNvbnN0IGJsb2NrQ291bnRzID0gbGVuZ3RoID4+IDI7CiAgICBjb25zdCB0YWlsTGVuZ3RoID0gbGVuZ3RoIC0gYmxvY2tDb3VudHMgKiA0OwogICAgY29uc3QgZGF0YVVpbnQzMiA9IG5ldyBVaW50MzJBcnJheShkYXRhLmJ1ZmZlciwgMCwgYmxvY2tDb3VudHMpOwogICAgbGV0IGsxID0gMCwgazIgPSAwOwogICAgbGV0IGgxID0gdGhpcy5oMSwgaDIgPSB0aGlzLmgyOwogICAgY29uc3QgQzEgPSAzNDMyOTE4MzUzLCBDMiA9IDQ2MTg0NTkwNzsKICAgIGNvbnN0IEMxX0xPVyA9IEMxICYgTUFTS19MT1csIEMyX0xPVyA9IEMyICYgTUFTS19MT1c7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2NrQ291bnRzOyBpKyspIHsKICAgICAgaWYgKGkgJiAxKSB7CiAgICAgICAgazEgPSBkYXRhVWludDMyW2ldOwogICAgICAgIGsxID0gazEgKiBDMSAmIE1BU0tfSElHSCB8IGsxICogQzFfTE9XICYgTUFTS19MT1c7CiAgICAgICAgazEgPSBrMSA8PCAxNSB8IGsxID4+PiAxNzsKICAgICAgICBrMSA9IGsxICogQzIgJiBNQVNLX0hJR0ggfCBrMSAqIEMyX0xPVyAmIE1BU0tfTE9XOwogICAgICAgIGgxIF49IGsxOwogICAgICAgIGgxID0gaDEgPDwgMTMgfCBoMSA+Pj4gMTk7CiAgICAgICAgaDEgPSBoMSAqIDUgKyAzODY0MjkyMTk2OwogICAgICB9IGVsc2UgewogICAgICAgIGsyID0gZGF0YVVpbnQzMltpXTsKICAgICAgICBrMiA9IGsyICogQzEgJiBNQVNLX0hJR0ggfCBrMiAqIEMxX0xPVyAmIE1BU0tfTE9XOwogICAgICAgIGsyID0gazIgPDwgMTUgfCBrMiA+Pj4gMTc7CiAgICAgICAgazIgPSBrMiAqIEMyICYgTUFTS19ISUdIIHwgazIgKiBDMl9MT1cgJiBNQVNLX0xPVzsKICAgICAgICBoMiBePSBrMjsKICAgICAgICBoMiA9IGgyIDw8IDEzIHwgaDIgPj4+IDE5OwogICAgICAgIGgyID0gaDIgKiA1ICsgMzg2NDI5MjE5NjsKICAgICAgfQogICAgfQogICAgazEgPSAwOwogICAgc3dpdGNoICh0YWlsTGVuZ3RoKSB7CiAgICAgIGNhc2UgMzoKICAgICAgICBrMSBePSBkYXRhW2Jsb2NrQ291bnRzICogNCArIDJdIDw8IDE2OwogICAgICBjYXNlIDI6CiAgICAgICAgazEgXj0gZGF0YVtibG9ja0NvdW50cyAqIDQgKyAxXSA8PCA4OwogICAgICBjYXNlIDE6CiAgICAgICAgazEgXj0gZGF0YVtibG9ja0NvdW50cyAqIDRdOwogICAgICAgIGsxID0gazEgKiBDMSAmIE1BU0tfSElHSCB8IGsxICogQzFfTE9XICYgTUFTS19MT1c7CiAgICAgICAgazEgPSBrMSA8PCAxNSB8IGsxID4+PiAxNzsKICAgICAgICBrMSA9IGsxICogQzIgJiBNQVNLX0hJR0ggfCBrMSAqIEMyX0xPVyAmIE1BU0tfTE9XOwogICAgICAgIGlmIChibG9ja0NvdW50cyAmIDEpIHsKICAgICAgICAgIGgxIF49IGsxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBoMiBePSBrMTsKICAgICAgICB9CiAgICB9CiAgICB0aGlzLmgxID0gaDE7CiAgICB0aGlzLmgyID0gaDI7CiAgfQogIGhleGRpZ2VzdCgpIHsKICAgIGxldCBoMSA9IHRoaXMuaDEsIGgyID0gdGhpcy5oMjsKICAgIGgxIF49IGgyID4+PiAxOwogICAgaDEgPSBoMSAqIDM5ODE4MDY3OTcgJiBNQVNLX0hJR0ggfCBoMSAqIDM2MDQ1ICYgTUFTS19MT1c7CiAgICBoMiA9IGgyICogNDI4MzU0MzUxMSAmIE1BU0tfSElHSCB8ICgoaDIgPDwgMTYgfCBoMSA+Pj4gMTYpICogMjk1MDE2Mzc5NyAmIE1BU0tfSElHSCkgPj4+IDE2OwogICAgaDEgXj0gaDIgPj4+IDE7CiAgICBoMSA9IGgxICogNDQ0OTg0NDAzICYgTUFTS19ISUdIIHwgaDEgKiA2MDQ5OSAmIE1BU0tfTE9XOwogICAgaDIgPSBoMiAqIDMzMDE4ODIzNjYgJiBNQVNLX0hJR0ggfCAoKGgyIDw8IDE2IHwgaDEgPj4+IDE2KSAqIDMxMjA0Mzc4OTMgJiBNQVNLX0hJR0gpID4+PiAxNjsKICAgIGgxIF49IGgyID4+PiAxOwogICAgcmV0dXJuIChoMSA+Pj4gMCkudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDgsICIwIikgKyAoaDIgPj4+IDApLnRvU3RyaW5nKDE2KS5wYWRTdGFydCg4LCAiMCIpOwogIH0KfTsKdmFyIFNlcmlhbGl6YWJsZUVtcHR5ID0gT2JqZWN0LmZyZWV6ZSh7CiAgbWFwOiBudWxsLAogIGhhc2g6ICIiLAogIHRyYW5zZmVyOiB2b2lkIDAKfSk7CnZhciBBbm5vdGF0aW9uU3RvcmFnZSA9IGNsYXNzIHsKICAjbW9kaWZpZWQgPSBmYWxzZTsKICAjbW9kaWZpZWRJZHMgPSBudWxsOwogICNlZGl0b3JzTWFwID0gbnVsbDsKICAjc3RvcmFnZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3RydWN0b3IoKSB7CiAgICB0aGlzLm9uU2V0TW9kaWZpZWQgPSBudWxsOwogICAgdGhpcy5vblJlc2V0TW9kaWZpZWQgPSBudWxsOwogICAgdGhpcy5vbkFubm90YXRpb25FZGl0b3IgPSBudWxsOwogIH0KICBnZXRWYWx1ZShrZXksIGRlZmF1bHRWYWx1ZSkgewogICAgY29uc3QgdmFsdWUgPSB0aGlzLiNzdG9yYWdlLmdldChrZXkpOwogICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KICAgIHJldHVybiBPYmplY3QuYXNzaWduKGRlZmF1bHRWYWx1ZSwgdmFsdWUpOwogIH0KICBnZXRSYXdWYWx1ZShrZXkpIHsKICAgIHJldHVybiB0aGlzLiNzdG9yYWdlLmdldChrZXkpOwogIH0KICByZW1vdmUoa2V5KSB7CiAgICBjb25zdCBzdG9yZWRWYWx1ZSA9IHRoaXMuI3N0b3JhZ2UuZ2V0KGtleSk7CiAgICBpZiAoc3RvcmVkVmFsdWUgPT09IHZvaWQgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc3RvcmVkVmFsdWUgaW5zdGFuY2VvZiBBbm5vdGF0aW9uRWRpdG9yKSB7CiAgICAgIHRoaXMuI2VkaXRvcnNNYXAuZGVsZXRlKHN0b3JlZFZhbHVlLmFubm90YXRpb25FbGVtZW50SWQpOwogICAgfQogICAgdGhpcy4jc3RvcmFnZS5kZWxldGUoa2V5KTsKICAgIGlmICh0aGlzLiNzdG9yYWdlLnNpemUgPT09IDApIHsKICAgICAgdGhpcy5yZXNldE1vZGlmaWVkKCk7CiAgICB9CiAgICBpZiAodHlwZW9mIHRoaXMub25Bbm5vdGF0aW9uRWRpdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy4jc3RvcmFnZS52YWx1ZXMoKSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFubm90YXRpb25FZGl0b3IpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5vbkFubm90YXRpb25FZGl0b3IobnVsbCk7CiAgICB9CiAgfQogIHNldFZhbHVlKGtleSwgdmFsdWUpIHsKICAgIGNvbnN0IG9iaiA9IHRoaXMuI3N0b3JhZ2UuZ2V0KGtleSk7CiAgICBsZXQgbW9kaWZpZWQgPSBmYWxzZTsKICAgIGlmIChvYmogIT09IHZvaWQgMCkgewogICAgICBmb3IgKGNvbnN0IFtlbnRyeSwgdmFsXSBvZiBPYmplY3QuZW50cmllcyh2YWx1ZSkpIHsKICAgICAgICBpZiAob2JqW2VudHJ5XSAhPT0gdmFsKSB7CiAgICAgICAgICBtb2RpZmllZCA9IHRydWU7CiAgICAgICAgICBvYmpbZW50cnldID0gdmFsOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgbW9kaWZpZWQgPSB0cnVlOwogICAgICB0aGlzLiNzdG9yYWdlLnNldChrZXksIHZhbHVlKTsKICAgIH0KICAgIGlmIChtb2RpZmllZCkgewogICAgICB0aGlzLiNzZXRNb2RpZmllZCgpOwogICAgfQogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5ub3RhdGlvbkVkaXRvcikgewogICAgICAodGhpcy4jZWRpdG9yc01hcCB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSkuc2V0KHZhbHVlLmFubm90YXRpb25FbGVtZW50SWQsIHZhbHVlKTsKICAgICAgaWYgKHR5cGVvZiB0aGlzLm9uQW5ub3RhdGlvbkVkaXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMub25Bbm5vdGF0aW9uRWRpdG9yKHZhbHVlLmNvbnN0cnVjdG9yLl90eXBlKTsKICAgICAgfQogICAgfQogIH0KICBoYXMoa2V5KSB7CiAgICByZXR1cm4gdGhpcy4jc3RvcmFnZS5oYXMoa2V5KTsKICB9CiAgZ2V0IHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy4jc3RvcmFnZS5zaXplOwogIH0KICAjc2V0TW9kaWZpZWQoKSB7CiAgICBpZiAoIXRoaXMuI21vZGlmaWVkKSB7CiAgICAgIHRoaXMuI21vZGlmaWVkID0gdHJ1ZTsKICAgICAgaWYgKHR5cGVvZiB0aGlzLm9uU2V0TW9kaWZpZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aGlzLm9uU2V0TW9kaWZpZWQoKTsKICAgICAgfQogICAgfQogIH0KICByZXNldE1vZGlmaWVkKCkgewogICAgaWYgKHRoaXMuI21vZGlmaWVkKSB7CiAgICAgIHRoaXMuI21vZGlmaWVkID0gZmFsc2U7CiAgICAgIGlmICh0eXBlb2YgdGhpcy5vblJlc2V0TW9kaWZpZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aGlzLm9uUmVzZXRNb2RpZmllZCgpOwogICAgICB9CiAgICB9CiAgfQogIGdldCBwcmludCgpIHsKICAgIHJldHVybiBuZXcgUHJpbnRBbm5vdGF0aW9uU3RvcmFnZSh0aGlzKTsKICB9CiAgZ2V0IHNlcmlhbGl6YWJsZSgpIHsKICAgIGlmICh0aGlzLiNzdG9yYWdlLnNpemUgPT09IDApIHsKICAgICAgcmV0dXJuIFNlcmlhbGl6YWJsZUVtcHR5OwogICAgfQogICAgY29uc3QgbWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgaGFzaCA9IG5ldyBNdXJtdXJIYXNoM182NCgpLCB0cmFuc2ZlciA9IFtdOwogICAgY29uc3QgY29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgbGV0IGhhc0JpdG1hcCA9IGZhbHNlOwogICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIHRoaXMuI3N0b3JhZ2UpIHsKICAgICAgY29uc3Qgc2VyaWFsaXplZCA9IHZhbCBpbnN0YW5jZW9mIEFubm90YXRpb25FZGl0b3IgPyB2YWwuc2VyaWFsaXplKGZhbHNlLCBjb250ZXh0KSA6IHZhbDsKICAgICAgaWYgKHNlcmlhbGl6ZWQpIHsKICAgICAgICBtYXAuc2V0KGtleSwgc2VyaWFsaXplZCk7CiAgICAgICAgaGFzaC51cGRhdGUoYCR7a2V5fToke0pTT04uc3RyaW5naWZ5KHNlcmlhbGl6ZWQpfWApOwogICAgICAgIGhhc0JpdG1hcCB8fD0gISFzZXJpYWxpemVkLmJpdG1hcDsKICAgICAgfQogICAgfQogICAgaWYgKGhhc0JpdG1hcCkgewogICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIG1hcC52YWx1ZXMoKSkgewogICAgICAgIGlmICh2YWx1ZS5iaXRtYXApIHsKICAgICAgICAgIHRyYW5zZmVyLnB1c2godmFsdWUuYml0bWFwKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBtYXAuc2l6ZSA+IDAgPyB7CiAgICAgIG1hcCwKICAgICAgaGFzaDogaGFzaC5oZXhkaWdlc3QoKSwKICAgICAgdHJhbnNmZXIKICAgIH0gOiBTZXJpYWxpemFibGVFbXB0eTsKICB9CiAgZ2V0IGVkaXRvclN0YXRzKCkgewogICAgbGV0IHN0YXRzID0gbnVsbDsKICAgIGNvbnN0IHR5cGVUb0VkaXRvciA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBsZXQgbnVtYmVyT2ZFZGl0ZWRDb21tZW50cyA9IDA7CiAgICBsZXQgbnVtYmVyT2ZEZWxldGVkQ29tbWVudHMgPSAwOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiB0aGlzLiNzdG9yYWdlLnZhbHVlcygpKSB7CiAgICAgIGlmICghKHZhbHVlIGluc3RhbmNlb2YgQW5ub3RhdGlvbkVkaXRvcikpIHsKICAgICAgICBpZiAodmFsdWUucG9wdXApIHsKICAgICAgICAgIGlmICh2YWx1ZS5wb3B1cC5kZWxldGVkKSB7CiAgICAgICAgICAgIG51bWJlck9mRGVsZXRlZENvbW1lbnRzICs9IDE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBudW1iZXJPZkVkaXRlZENvbW1lbnRzICs9IDE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICh2YWx1ZS5pc0NvbW1lbnREZWxldGVkKSB7CiAgICAgICAgbnVtYmVyT2ZEZWxldGVkQ29tbWVudHMgKz0gMTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZS5oYXNFZGl0ZWRDb21tZW50KSB7CiAgICAgICAgbnVtYmVyT2ZFZGl0ZWRDb21tZW50cyArPSAxOwogICAgICB9CiAgICAgIGNvbnN0IGVkaXRvclN0YXRzID0gdmFsdWUudGVsZW1ldHJ5RmluYWxEYXRhOwogICAgICBpZiAoIWVkaXRvclN0YXRzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgewogICAgICAgIHR5cGUKICAgICAgfSA9IGVkaXRvclN0YXRzOwogICAgICBpZiAoIXR5cGVUb0VkaXRvci5oYXModHlwZSkpIHsKICAgICAgICB0eXBlVG9FZGl0b3Iuc2V0KHR5cGUsIE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZSkuY29uc3RydWN0b3IpOwogICAgICB9CiAgICAgIHN0YXRzIHx8PSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgY29uc3QgbWFwID0gc3RhdHNbdHlwZV0gfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsXSBvZiBPYmplY3QuZW50cmllcyhlZGl0b3JTdGF0cykpIHsKICAgICAgICBpZiAoa2V5ID09PSAidHlwZSIpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBsZXQgY291bnRlcnMgPSBtYXAuZ2V0KGtleSk7CiAgICAgICAgaWYgKCFjb3VudGVycykgewogICAgICAgICAgY291bnRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgbWFwLnNldChrZXksIGNvdW50ZXJzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY291bnQgPSBjb3VudGVycy5nZXQodmFsKSA/PyAwOwogICAgICAgIGNvdW50ZXJzLnNldCh2YWwsIGNvdW50ICsgMSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChudW1iZXJPZkRlbGV0ZWRDb21tZW50cyA+IDAgfHwgbnVtYmVyT2ZFZGl0ZWRDb21tZW50cyA+IDApIHsKICAgICAgc3RhdHMgfHw9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBzdGF0cy5jb21tZW50cyA9IHsKICAgICAgICBkZWxldGVkOiBudW1iZXJPZkRlbGV0ZWRDb21tZW50cywKICAgICAgICBlZGl0ZWQ6IG51bWJlck9mRWRpdGVkQ29tbWVudHMKICAgICAgfTsKICAgIH0KICAgIGlmICghc3RhdHMpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBmb3IgKGNvbnN0IFt0eXBlLCBlZGl0b3JdIG9mIHR5cGVUb0VkaXRvcikgewogICAgICBzdGF0c1t0eXBlXSA9IGVkaXRvci5jb21wdXRlVGVsZW1ldHJ5RmluYWxEYXRhKHN0YXRzW3R5cGVdKTsKICAgIH0KICAgIHJldHVybiBzdGF0czsKICB9CiAgcmVzZXRNb2RpZmllZElkcygpIHsKICAgIHRoaXMuI21vZGlmaWVkSWRzID0gbnVsbDsKICB9CiAgdXBkYXRlRWRpdG9yKGFubm90YXRpb25JZCwgZGF0YSkgewogICAgY29uc3QgdmFsdWUgPSB0aGlzLiNlZGl0b3JzTWFwPy5nZXQoYW5ub3RhdGlvbklkKTsKICAgIGlmICh2YWx1ZSkgewogICAgICB2YWx1ZS51cGRhdGVGcm9tQW5ub3RhdGlvbkxheWVyKGRhdGEpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgZ2V0RWRpdG9yKGFubm90YXRpb25JZCkgewogICAgcmV0dXJuIHRoaXMuI2VkaXRvcnNNYXA/LmdldChhbm5vdGF0aW9uSWQpIHx8IG51bGw7CiAgfQogIGdldCBtb2RpZmllZElkcygpIHsKICAgIGlmICh0aGlzLiNtb2RpZmllZElkcykgewogICAgICByZXR1cm4gdGhpcy4jbW9kaWZpZWRJZHM7CiAgICB9CiAgICBjb25zdCBpZHMgPSBbXTsKICAgIGlmICh0aGlzLiNlZGl0b3JzTWFwKSB7CiAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdGhpcy4jZWRpdG9yc01hcC52YWx1ZXMoKSkgewogICAgICAgIGlmICghdmFsdWUuc2VyaWFsaXplKCkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZHMucHVzaCh2YWx1ZS5hbm5vdGF0aW9uRWxlbWVudElkKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMuI21vZGlmaWVkSWRzID0gewogICAgICBpZHM6IG5ldyBTZXQoaWRzKSwKICAgICAgaGFzaDogaWRzLmpvaW4oIiwiKQogICAgfTsKICB9CiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy4jc3RvcmFnZS5lbnRyaWVzKCk7CiAgfQp9Owp2YXIgUHJpbnRBbm5vdGF0aW9uU3RvcmFnZSA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvblN0b3JhZ2UgewogICNzZXJpYWxpemFibGU7CiAgY29uc3RydWN0b3IocGFyZW50KSB7CiAgICBzdXBlcigpOwogICAgY29uc3QgewogICAgICBtYXAsCiAgICAgIGhhc2gsCiAgICAgIHRyYW5zZmVyCiAgICB9ID0gcGFyZW50LnNlcmlhbGl6YWJsZTsKICAgIGNvbnN0IGNsb25lID0gc3RydWN0dXJlZENsb25lKG1hcCwgdHJhbnNmZXIgPyB7CiAgICAgIHRyYW5zZmVyCiAgICB9IDogbnVsbCk7CiAgICB0aGlzLiNzZXJpYWxpemFibGUgPSB7CiAgICAgIG1hcDogY2xvbmUsCiAgICAgIGhhc2gsCiAgICAgIHRyYW5zZmVyCiAgICB9OwogIH0KICBnZXQgcHJpbnQoKSB7CiAgICB1bnJlYWNoYWJsZSgiU2hvdWxkIG5vdCBjYWxsIFByaW50QW5ub3RhdGlvblN0b3JhZ2UucHJpbnQiKTsKICB9CiAgZ2V0IHNlcmlhbGl6YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLiNzZXJpYWxpemFibGU7CiAgfQogIGdldCBtb2RpZmllZElkcygpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgIm1vZGlmaWVkSWRzIiwgewogICAgICBpZHM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgICAgIGhhc2g6ICIiCiAgICB9KTsKICB9Cn07CnZhciBGb250TG9hZGVyID0gY2xhc3MgewogICNzeXN0ZW1Gb250cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgY29uc3RydWN0b3IoewogICAgb3duZXJEb2N1bWVudCA9IGdsb2JhbFRoaXMuZG9jdW1lbnQsCiAgICBzdHlsZUVsZW1lbnQgPSBudWxsCiAgfSkgewogICAgdGhpcy5fZG9jdW1lbnQgPSBvd25lckRvY3VtZW50OwogICAgdGhpcy5uYXRpdmVGb250RmFjZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgdGhpcy5zdHlsZUVsZW1lbnQgPSBudWxsOwogICAgdGhpcy5sb2FkaW5nUmVxdWVzdHMgPSBbXTsKICAgIHRoaXMubG9hZFRlc3RGb250SWQgPSAwOwogIH0KICBhZGROYXRpdmVGb250RmFjZShuYXRpdmVGb250RmFjZSkgewogICAgdGhpcy5uYXRpdmVGb250RmFjZXMuYWRkKG5hdGl2ZUZvbnRGYWNlKTsKICAgIHRoaXMuX2RvY3VtZW50LmZvbnRzLmFkZChuYXRpdmVGb250RmFjZSk7CiAgfQogIHJlbW92ZU5hdGl2ZUZvbnRGYWNlKG5hdGl2ZUZvbnRGYWNlKSB7CiAgICB0aGlzLm5hdGl2ZUZvbnRGYWNlcy5kZWxldGUobmF0aXZlRm9udEZhY2UpOwogICAgdGhpcy5fZG9jdW1lbnQuZm9udHMuZGVsZXRlKG5hdGl2ZUZvbnRGYWNlKTsKICB9CiAgaW5zZXJ0UnVsZShydWxlKSB7CiAgICBpZiAoIXRoaXMuc3R5bGVFbGVtZW50KSB7CiAgICAgIHRoaXMuc3R5bGVFbGVtZW50ID0gdGhpcy5fZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgdGhpcy5fZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0uYXBwZW5kKHRoaXMuc3R5bGVFbGVtZW50KTsKICAgIH0KICAgIGNvbnN0IHN0eWxlU2hlZXQgPSB0aGlzLnN0eWxlRWxlbWVudC5zaGVldDsKICAgIHN0eWxlU2hlZXQuaW5zZXJ0UnVsZShydWxlLCBzdHlsZVNoZWV0LmNzc1J1bGVzLmxlbmd0aCk7CiAgfQogIGNsZWFyKCkgewogICAgZm9yIChjb25zdCBuYXRpdmVGb250RmFjZSBvZiB0aGlzLm5hdGl2ZUZvbnRGYWNlcykgewogICAgICB0aGlzLl9kb2N1bWVudC5mb250cy5kZWxldGUobmF0aXZlRm9udEZhY2UpOwogICAgfQogICAgdGhpcy5uYXRpdmVGb250RmFjZXMuY2xlYXIoKTsKICAgIHRoaXMuI3N5c3RlbUZvbnRzLmNsZWFyKCk7CiAgICBpZiAodGhpcy5zdHlsZUVsZW1lbnQpIHsKICAgICAgdGhpcy5zdHlsZUVsZW1lbnQucmVtb3ZlKCk7CiAgICAgIHRoaXMuc3R5bGVFbGVtZW50ID0gbnVsbDsKICAgIH0KICB9CiAgYXN5bmMgbG9hZFN5c3RlbUZvbnQoewogICAgc3lzdGVtRm9udEluZm86IGluZm8yLAogICAgZGlzYWJsZUZvbnRGYWNlLAogICAgX2luc3BlY3RGb250CiAgfSkgewogICAgaWYgKCFpbmZvMiB8fCB0aGlzLiNzeXN0ZW1Gb250cy5oYXMoaW5mbzIubG9hZGVkTmFtZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgYXNzZXJ0KCFkaXNhYmxlRm9udEZhY2UsICJsb2FkU3lzdGVtRm9udCBzaG91bGRuJ3QgYmUgY2FsbGVkIHdoZW4gYGRpc2FibGVGb250RmFjZWAgaXMgc2V0LiIpOwogICAgaWYgKHRoaXMuaXNGb250TG9hZGluZ0FQSVN1cHBvcnRlZCkgewogICAgICBjb25zdCB7CiAgICAgICAgbG9hZGVkTmFtZSwKICAgICAgICBzcmMsCiAgICAgICAgc3R5bGUKICAgICAgfSA9IGluZm8yOwogICAgICBjb25zdCBmb250RmFjZSA9IG5ldyBGb250RmFjZShsb2FkZWROYW1lLCBzcmMsIHN0eWxlKTsKICAgICAgdGhpcy5hZGROYXRpdmVGb250RmFjZShmb250RmFjZSk7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgZm9udEZhY2UubG9hZCgpOwogICAgICAgIHRoaXMuI3N5c3RlbUZvbnRzLmFkZChsb2FkZWROYW1lKTsKICAgICAgICBfaW5zcGVjdEZvbnQ/LihpbmZvMik7CiAgICAgIH0gY2F0Y2ggewogICAgICAgIHdhcm4oYENhbm5vdCBsb2FkIHN5c3RlbSBmb250OiAke2luZm8yLmJhc2VGb250TmFtZX0sIGluc3RhbGxpbmcgaXQgY291bGQgaGVscCB0byBpbXByb3ZlIFBERiByZW5kZXJpbmcuYCk7CiAgICAgICAgdGhpcy5yZW1vdmVOYXRpdmVGb250RmFjZShmb250RmFjZSk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgdW5yZWFjaGFibGUoIk5vdCBpbXBsZW1lbnRlZDogbG9hZFN5c3RlbUZvbnQgd2l0aG91dCB0aGUgRm9udCBMb2FkaW5nIEFQSS4iKTsKICB9CiAgYXN5bmMgYmluZChmb250KSB7CiAgICBpZiAoZm9udC5hdHRhY2hlZCB8fCBmb250Lm1pc3NpbmdGaWxlICYmICFmb250LnN5c3RlbUZvbnRJbmZvKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvbnQuYXR0YWNoZWQgPSB0cnVlOwogICAgaWYgKGZvbnQuc3lzdGVtRm9udEluZm8pIHsKICAgICAgYXdhaXQgdGhpcy5sb2FkU3lzdGVtRm9udChmb250KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuaXNGb250TG9hZGluZ0FQSVN1cHBvcnRlZCkgewogICAgICBjb25zdCBuYXRpdmVGb250RmFjZSA9IGZvbnQuY3JlYXRlTmF0aXZlRm9udEZhY2UoKTsKICAgICAgaWYgKG5hdGl2ZUZvbnRGYWNlKSB7CiAgICAgICAgdGhpcy5hZGROYXRpdmVGb250RmFjZShuYXRpdmVGb250RmFjZSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IG5hdGl2ZUZvbnRGYWNlLmxvYWRlZDsKICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgd2FybihgRmFpbGVkIHRvIGxvYWQgZm9udCAnJHtuYXRpdmVGb250RmFjZS5mYW1pbHl9JzogJyR7ZXh9Jy5gKTsKICAgICAgICAgIGZvbnQuZGlzYWJsZUZvbnRGYWNlID0gdHJ1ZTsKICAgICAgICAgIHRocm93IGV4OwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBydWxlID0gZm9udC5jcmVhdGVGb250RmFjZVJ1bGUoKTsKICAgIGlmIChydWxlKSB7CiAgICAgIHRoaXMuaW5zZXJ0UnVsZShydWxlKTsKICAgICAgaWYgKHRoaXMuaXNTeW5jRm9udExvYWRpbmdTdXBwb3J0ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBjb25zdCByZXF1ZXN0ID0gdGhpcy5fcXVldWVMb2FkaW5nQ2FsbGJhY2socmVzb2x2ZSk7CiAgICAgICAgdGhpcy5fcHJlcGFyZUZvbnRMb2FkRXZlbnQoZm9udCwgcmVxdWVzdCk7CiAgICAgIH0pOwogICAgfQogIH0KICBnZXQgaXNGb250TG9hZGluZ0FQSVN1cHBvcnRlZCgpIHsKICAgIGNvbnN0IGhhc0ZvbnRzID0gISF0aGlzLl9kb2N1bWVudD8uZm9udHM7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc0ZvbnRMb2FkaW5nQVBJU3VwcG9ydGVkIiwgaGFzRm9udHMpOwogIH0KICBnZXQgaXNTeW5jRm9udExvYWRpbmdTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJpc1N5bmNGb250TG9hZGluZ1N1cHBvcnRlZCIsIGlzTm9kZUpTIHx8IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm0uaXNGaXJlZm94KTsKICB9CiAgX3F1ZXVlTG9hZGluZ0NhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICBmdW5jdGlvbiBjb21wbGV0ZVJlcXVlc3QoKSB7CiAgICAgIGFzc2VydCghcmVxdWVzdC5kb25lLCAiY29tcGxldGVSZXF1ZXN0KCkgY2Fubm90IGJlIGNhbGxlZCB0d2ljZS4iKTsKICAgICAgcmVxdWVzdC5kb25lID0gdHJ1ZTsKICAgICAgd2hpbGUgKGxvYWRpbmdSZXF1ZXN0cy5sZW5ndGggPiAwICYmIGxvYWRpbmdSZXF1ZXN0c1swXS5kb25lKSB7CiAgICAgICAgY29uc3Qgb3RoZXJSZXF1ZXN0ID0gbG9hZGluZ1JlcXVlc3RzLnNoaWZ0KCk7CiAgICAgICAgc2V0VGltZW91dChvdGhlclJlcXVlc3QuY2FsbGJhY2ssIDApOwogICAgICB9CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGxvYWRpbmdSZXF1ZXN0cwogICAgfSA9IHRoaXM7CiAgICBjb25zdCByZXF1ZXN0ID0gewogICAgICBkb25lOiBmYWxzZSwKICAgICAgY29tcGxldGU6IGNvbXBsZXRlUmVxdWVzdCwKICAgICAgY2FsbGJhY2sKICAgIH07CiAgICBsb2FkaW5nUmVxdWVzdHMucHVzaChyZXF1ZXN0KTsKICAgIHJldHVybiByZXF1ZXN0OwogIH0KICBnZXQgX2xvYWRUZXN0Rm9udCgpIHsKICAgIGNvbnN0IHRlc3RGb250ID0gYXRvYigiVDFSVVR3QUxBSUFBQXdBd1EwWkdJREh0Wmc0QUFBT1lBQUFBZ1VaR1ZFMWxrelp3QUFBRUhBQUFBQnhIUkVWR0FCUUFGUUFBQkRnQUFBQWVUMU12TWxZTll3a0FBQUVnQUFBQVlHTnRZWEFCRFFMVUFBQUNOQUFBQVVKb1pXRmsveFZGRFFBQUFMd0FBQUEyYUdobFlRZGtBK29BQUFEMEFBQUFKR2h0ZEhnRDZBQUFBQUFFV0FBQUFBWnRZWGh3QUFKUUFBQUFBUmdBQUFBR2JtRnRaVmptZEg0QUFBR0FBQUFBc1hCdmMzVC9oZ0F6QUFBRGVBQUFBQ0FBQVFBQUFBRUFBTFpSRnNSZkR6ejFBQXNENkFBQUFBRE9CT1RMQUFBQUFNNEtIRHdBQUFBQUErZ0RJUUFBQUFnQUFnQUFBQUFBQUFBQkFBQURJUUFBQUZvRDZBQUFBQUFENkFBQkFBQUFBQUFBQUFBQUFBQUFBQUFBQVFBQVVBQUFBZ0FBQUFRRDZBSDBBQVVBQUFLS0Fyd0FBQUNNQW9vQ3ZBQUFBZUFBTVFFQ0FBQUNBQVlKQUFBQUFBQUFBQUFBQVFBQUFBQUFBQUFBQUFBQUFGQm1SV1FBd0FBdUFDNERJUDg0QUZvRElRQUFBQUFBQVFBQUFBQUFBQUFBQUNBQUlBQUJBQUFBRGdDdUFBRUFBQUFBQUFBQUFRQUFBQUVBQUFBQUFBRUFBUUFBQUFFQUFBQUFBQUlBQVFBQUFBRUFBQUFBQUFNQUFRQUFBQUVBQUFBQUFBUUFBUUFBQUFFQUFBQUFBQVVBQVFBQUFBRUFBQUFBQUFZQUFRQUFBQU1BQVFRSkFBQUFBZ0FCQUFNQUFRUUpBQUVBQWdBQkFBTUFBUVFKQUFJQUFnQUJBQU1BQVFRSkFBTUFBZ0FCQUFNQUFRUUpBQVFBQWdBQkFBTUFBUVFKQUFVQUFnQUJBQU1BQVFRSkFBWUFBZ0FCV0FCWUFBQUFBQUFBQXdBQUFBTUFBQUFjQUFFQUFBQUFBRHdBQXdBQkFBQUFIQUFFQUNBQUFBQUVBQVFBQVFBQUFDNy8vd0FBQUM3Ly8vL1RBQUVBQUFBQUFBQUJCZ0FBQVFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFFQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU1BQUFBQUFBRC9nd0F5QUFBQUFRQUFBQUFBQUFBQUFBQUFBQUFBQUFBQkFBUUVBQUVCQVFKWUFBRUJBU0g0RHdENEd3SEVBdmdjQS9nWEJJd01BWXVMK256NXRRWGtENWozQ0JMbkVRQUNBUUVCSVZoWVdGaFlXRmhZV0ZoWVdGaFlXRmhZV0ZoWVdGaFlXRmhZV0ZoWVdGaFlBQUFCQVFBQUR3QUNBUUVFRS90M0RvdjZmQUg2ZkFUK2ZQcDgrbndIRG9zTUN2bTFDdm0xREF6NmZCUUFBQUFBQUFBQkFBQUFBTW1KYnpFQUFBQUF6Z1RqRlFBQUFBRE9CT1FwQUFFQUFBQUFBQUFBREFBVUFBUUFBQUFCQUFBQUFnQUJBQUFBQUFBQUFBQUQ2QUFBQUFBQUFBPT0iKTsKICAgIHJldHVybiBzaGFkb3codGhpcywgIl9sb2FkVGVzdEZvbnQiLCB0ZXN0Rm9udCk7CiAgfQogIF9wcmVwYXJlRm9udExvYWRFdmVudChmb250LCByZXF1ZXN0KSB7CiAgICBmdW5jdGlvbiBpbnQzMihkYXRhMiwgb2Zmc2V0KSB7CiAgICAgIHJldHVybiBkYXRhMi5jaGFyQ29kZUF0KG9mZnNldCkgPDwgMjQgfCBkYXRhMi5jaGFyQ29kZUF0KG9mZnNldCArIDEpIDw8IDE2IHwgZGF0YTIuY2hhckNvZGVBdChvZmZzZXQgKyAyKSA8PCA4IHwgZGF0YTIuY2hhckNvZGVBdChvZmZzZXQgKyAzKSAmIDI1NTsKICAgIH0KICAgIGZ1bmN0aW9uIHNwbGljZVN0cmluZyhzLCBvZmZzZXQsIHJlbW92ZSwgaW5zZXJ0KSB7CiAgICAgIGNvbnN0IGNodW5rMSA9IHMuc3Vic3RyaW5nKDAsIG9mZnNldCk7CiAgICAgIGNvbnN0IGNodW5rMiA9IHMuc3Vic3RyaW5nKG9mZnNldCArIHJlbW92ZSk7CiAgICAgIHJldHVybiBjaHVuazEgKyBpbnNlcnQgKyBjaHVuazI7CiAgICB9CiAgICBsZXQgaSwgaWk7CiAgICBjb25zdCBjYW52YXMgPSB0aGlzLl9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgIGNhbnZhcy53aWR0aCA9IDE7CiAgICBjYW52YXMuaGVpZ2h0ID0gMTsKICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgbGV0IGNhbGxlZCA9IDA7CiAgICBmdW5jdGlvbiBpc0ZvbnRSZWFkeShuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoKytjYWxsZWQgPiAzMCkgewogICAgICAgIHdhcm4oIkxvYWQgdGVzdCBmb250IG5ldmVyIGxvYWRlZC4iKTsKICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjdHguZm9udCA9ICIzMHB4ICIgKyBuYW1lOwogICAgICBjdHguZmlsbFRleHQoIi4iLCAwLCAyMCk7CiAgICAgIGNvbnN0IGltYWdlRGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgMSwgMSk7CiAgICAgIGlmIChpbWFnZURhdGEuZGF0YVszXSA+IDApIHsKICAgICAgICBjYWxsYmFjaygpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzZXRUaW1lb3V0KGlzRm9udFJlYWR5LmJpbmQobnVsbCwgbmFtZSwgY2FsbGJhY2spKTsKICAgIH0KICAgIGNvbnN0IGxvYWRUZXN0Rm9udElkID0gYGx0JHtEYXRlLm5vdygpfSR7dGhpcy5sb2FkVGVzdEZvbnRJZCsrfWA7CiAgICBsZXQgZGF0YSA9IHRoaXMuX2xvYWRUZXN0Rm9udDsKICAgIGNvbnN0IENPTU1FTlRfT0ZGU0VUID0gOTc2OwogICAgZGF0YSA9IHNwbGljZVN0cmluZyhkYXRhLCBDT01NRU5UX09GRlNFVCwgbG9hZFRlc3RGb250SWQubGVuZ3RoLCBsb2FkVGVzdEZvbnRJZCk7CiAgICBjb25zdCBDRkZfQ0hFQ0tTVU1fT0ZGU0VUID0gMTY7CiAgICBjb25zdCBYWFhYX1ZBTFVFID0gMTQ4MjE4NDc5MjsKICAgIGxldCBjaGVja3N1bSA9IGludDMyKGRhdGEsIENGRl9DSEVDS1NVTV9PRkZTRVQpOwogICAgZm9yIChpID0gMCwgaWkgPSBsb2FkVGVzdEZvbnRJZC5sZW5ndGggLSAzOyBpIDwgaWk7IGkgKz0gNCkgewogICAgICBjaGVja3N1bSA9IGNoZWNrc3VtIC0gWFhYWF9WQUxVRSArIGludDMyKGxvYWRUZXN0Rm9udElkLCBpKSB8IDA7CiAgICB9CiAgICBpZiAoaSA8IGxvYWRUZXN0Rm9udElkLmxlbmd0aCkgewogICAgICBjaGVja3N1bSA9IGNoZWNrc3VtIC0gWFhYWF9WQUxVRSArIGludDMyKGxvYWRUZXN0Rm9udElkICsgIlhYWCIsIGkpIHwgMDsKICAgIH0KICAgIGRhdGEgPSBzcGxpY2VTdHJpbmcoZGF0YSwgQ0ZGX0NIRUNLU1VNX09GRlNFVCwgNCwgc3RyaW5nMzIoY2hlY2tzdW0pKTsKICAgIGNvbnN0IHVybCA9IGB1cmwoZGF0YTpmb250L29wZW50eXBlO2Jhc2U2NCwke2J0b2EoZGF0YSl9KTtgOwogICAgY29uc3QgcnVsZSA9IGBAZm9udC1mYWNlIHtmb250LWZhbWlseToiJHtsb2FkVGVzdEZvbnRJZH0iO3NyYzoke3VybH19YDsKICAgIHRoaXMuaW5zZXJ0UnVsZShydWxlKTsKICAgIGNvbnN0IGRpdiA9IHRoaXMuX2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgZGl2LnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsKICAgIGRpdi5zdHlsZS53aWR0aCA9IGRpdi5zdHlsZS5oZWlnaHQgPSAiMTBweCI7CiAgICBkaXYuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgZGl2LnN0eWxlLnRvcCA9IGRpdi5zdHlsZS5sZWZ0ID0gIjBweCI7CiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgW2ZvbnQubG9hZGVkTmFtZSwgbG9hZFRlc3RGb250SWRdKSB7CiAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLl9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgIHNwYW4udGV4dENvbnRlbnQgPSAiSGkiOwogICAgICBzcGFuLnN0eWxlLmZvbnRGYW1pbHkgPSBuYW1lOwogICAgICBkaXYuYXBwZW5kKHNwYW4pOwogICAgfQogICAgdGhpcy5fZG9jdW1lbnQuYm9keS5hcHBlbmQoZGl2KTsKICAgIGlzRm9udFJlYWR5KGxvYWRUZXN0Rm9udElkLCAoKSA9PiB7CiAgICAgIGRpdi5yZW1vdmUoKTsKICAgICAgcmVxdWVzdC5jb21wbGV0ZSgpOwogICAgfSk7CiAgfQp9Owp2YXIgRm9udEZhY2VPYmplY3QgPSBjbGFzcyB7CiAgI2ZvbnREYXRhOwogIGNvbnN0cnVjdG9yKHRyYW5zbGF0ZWREYXRhLCBpbnNwZWN0Rm9udCA9IG51bGwsIGV4dHJhLCBjaGFyUHJvY09wZXJhdG9yTGlzdCkgewogICAgdGhpcy5jb21waWxlZEdseXBocyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy4jZm9udERhdGEgPSB0cmFuc2xhdGVkRGF0YTsKICAgIHRoaXMuX2luc3BlY3RGb250ID0gaW5zcGVjdEZvbnQ7CiAgICBpZiAoZXh0cmEpIHsKICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBleHRyYSk7CiAgICB9CiAgICBpZiAoY2hhclByb2NPcGVyYXRvckxpc3QpIHsKICAgICAgdGhpcy5jaGFyUHJvY09wZXJhdG9yTGlzdCA9IGNoYXJQcm9jT3BlcmF0b3JMaXN0OwogICAgfQogIH0KICBjcmVhdGVOYXRpdmVGb250RmFjZSgpIHsKICAgIGlmICghdGhpcy5kYXRhIHx8IHRoaXMuZGlzYWJsZUZvbnRGYWNlKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgbGV0IG5hdGl2ZUZvbnRGYWNlOwogICAgaWYgKCF0aGlzLmNzc0ZvbnRJbmZvKSB7CiAgICAgIG5hdGl2ZUZvbnRGYWNlID0gbmV3IEZvbnRGYWNlKHRoaXMubG9hZGVkTmFtZSwgdGhpcy5kYXRhLCB7fSk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBjc3MgPSB7CiAgICAgICAgd2VpZ2h0OiB0aGlzLmNzc0ZvbnRJbmZvLmZvbnRXZWlnaHQKICAgICAgfTsKICAgICAgaWYgKHRoaXMuY3NzRm9udEluZm8uaXRhbGljQW5nbGUpIHsKICAgICAgICBjc3Muc3R5bGUgPSBgb2JsaXF1ZSAke3RoaXMuY3NzRm9udEluZm8uaXRhbGljQW5nbGV9ZGVnYDsKICAgICAgfQogICAgICBuYXRpdmVGb250RmFjZSA9IG5ldyBGb250RmFjZSh0aGlzLmNzc0ZvbnRJbmZvLmZvbnRGYW1pbHksIHRoaXMuZGF0YSwgY3NzKTsKICAgIH0KICAgIHRoaXMuX2luc3BlY3RGb250Py4odGhpcyk7CiAgICByZXR1cm4gbmF0aXZlRm9udEZhY2U7CiAgfQogIGNyZWF0ZUZvbnRGYWNlUnVsZSgpIHsKICAgIGlmICghdGhpcy5kYXRhIHx8IHRoaXMuZGlzYWJsZUZvbnRGYWNlKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgdXJsID0gYHVybChkYXRhOiR7dGhpcy5taW1ldHlwZX07YmFzZTY0LCR7dG9CYXNlNjRVdGlsKHRoaXMuZGF0YSl9KTtgOwogICAgbGV0IHJ1bGU7CiAgICBpZiAoIXRoaXMuY3NzRm9udEluZm8pIHsKICAgICAgcnVsZSA9IGBAZm9udC1mYWNlIHtmb250LWZhbWlseToiJHt0aGlzLmxvYWRlZE5hbWV9IjtzcmM6JHt1cmx9fWA7CiAgICB9IGVsc2UgewogICAgICBsZXQgY3NzID0gYGZvbnQtd2VpZ2h0OiAke3RoaXMuY3NzRm9udEluZm8uZm9udFdlaWdodH07YDsKICAgICAgaWYgKHRoaXMuY3NzRm9udEluZm8uaXRhbGljQW5nbGUpIHsKICAgICAgICBjc3MgKz0gYGZvbnQtc3R5bGU6IG9ibGlxdWUgJHt0aGlzLmNzc0ZvbnRJbmZvLml0YWxpY0FuZ2xlfWRlZztgOwogICAgICB9CiAgICAgIHJ1bGUgPSBgQGZvbnQtZmFjZSB7Zm9udC1mYW1pbHk6IiR7dGhpcy5jc3NGb250SW5mby5mb250RmFtaWx5fSI7JHtjc3N9c3JjOiR7dXJsfX1gOwogICAgfQogICAgdGhpcy5faW5zcGVjdEZvbnQ/Lih0aGlzLCB1cmwpOwogICAgcmV0dXJuIHJ1bGU7CiAgfQogIGdldFBhdGhHZW5lcmF0b3Iob2JqcywgY2hhcmFjdGVyKSB7CiAgICBpZiAodGhpcy5jb21waWxlZEdseXBoc1tjaGFyYWN0ZXJdICE9PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIHRoaXMuY29tcGlsZWRHbHlwaHNbY2hhcmFjdGVyXTsKICAgIH0KICAgIGNvbnN0IG9iaklkID0gdGhpcy5sb2FkZWROYW1lICsgIl9wYXRoXyIgKyBjaGFyYWN0ZXI7CiAgICBsZXQgY21kczsKICAgIHRyeSB7CiAgICAgIGNtZHMgPSBvYmpzLmdldChvYmpJZCk7CiAgICB9IGNhdGNoIChleCkgewogICAgICB3YXJuKGBnZXRQYXRoR2VuZXJhdG9yIC0gaWdub3JpbmcgY2hhcmFjdGVyOiAiJHtleH0iLmApOwogICAgfQogICAgY29uc3QgcGF0aCA9IG1ha2VQYXRoRnJvbURyYXdPUFMoY21kcz8ucGF0aCk7CiAgICBpZiAoIXRoaXMuZm9udEV4dHJhUHJvcGVydGllcykgewogICAgICBvYmpzLmRlbGV0ZShvYmpJZCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb21waWxlZEdseXBoc1tjaGFyYWN0ZXJdID0gcGF0aDsKICB9CiAgZ2V0IGJsYWNrKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmJsYWNrOwogIH0KICBnZXQgYm9sZCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5ib2xkOwogIH0KICBnZXQgZGlzYWJsZUZvbnRGYWNlKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmRpc2FibGVGb250RmFjZSA/PyBmYWxzZTsKICB9CiAgc2V0IGRpc2FibGVGb250RmFjZSh2YWx1ZSkgewogICAgc2hhZG93KHRoaXMsICJkaXNhYmxlRm9udEZhY2UiLCAhIXZhbHVlKTsKICB9CiAgZ2V0IGZvbnRFeHRyYVByb3BlcnRpZXMoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuZm9udEV4dHJhUHJvcGVydGllcyA/PyBmYWxzZTsKICB9CiAgZ2V0IGlzSW52YWxpZFBERmpzRm9udCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5pc0ludmFsaWRQREZqc0ZvbnQ7CiAgfQogIGdldCBpc1R5cGUzRm9udCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5pc1R5cGUzRm9udDsKICB9CiAgZ2V0IGl0YWxpYygpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5pdGFsaWM7CiAgfQogIGdldCBtaXNzaW5nRmlsZSgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5taXNzaW5nRmlsZTsKICB9CiAgZ2V0IHJlbWVhc3VyZSgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5yZW1lYXN1cmU7CiAgfQogIGdldCB2ZXJ0aWNhbCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS52ZXJ0aWNhbDsKICB9CiAgZ2V0IGFzY2VudCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5hc2NlbnQ7CiAgfQogIGdldCBkZWZhdWx0V2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuZGVmYXVsdFdpZHRoOwogIH0KICBnZXQgZGVzY2VudCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5kZXNjZW50OwogIH0KICBnZXQgYmJveCgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5iYm94OwogIH0KICBzZXQgYmJveChiYm94KSB7CiAgICBzaGFkb3codGhpcywgImJib3giLCBiYm94KTsKICB9CiAgZ2V0IGZvbnRNYXRyaXgoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuZm9udE1hdHJpeDsKICB9CiAgZ2V0IGZhbGxiYWNrTmFtZSgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5mYWxsYmFja05hbWU7CiAgfQogIGdldCBsb2FkZWROYW1lKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmxvYWRlZE5hbWU7CiAgfQogIGdldCBtaW1ldHlwZSgpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5taW1ldHlwZTsKICB9CiAgZ2V0IG5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEubmFtZTsKICB9CiAgZ2V0IGRhdGEoKSB7CiAgICByZXR1cm4gdGhpcy4jZm9udERhdGEuZGF0YTsKICB9CiAgY2xlYXJEYXRhKCkgewogICAgdGhpcy4jZm9udERhdGEuY2xlYXJEYXRhKCk7CiAgfQogIGdldCBjc3NGb250SW5mbygpIHsKICAgIHJldHVybiB0aGlzLiNmb250RGF0YS5jc3NGb250SW5mbzsKICB9CiAgZ2V0IHN5c3RlbUZvbnRJbmZvKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLnN5c3RlbUZvbnRJbmZvOwogIH0KICBnZXQgZGVmYXVsdFZNZXRyaWNzKCkgewogICAgcmV0dXJuIHRoaXMuI2ZvbnREYXRhLmRlZmF1bHRWTWV0cmljczsKICB9Cn07CnZhciBDc3NGb250SW5mbyA9IGNsYXNzIF9Dc3NGb250SW5mbyB7CiAgI2J1ZmZlcjsKICAjdmlldzsKICAjZGVjb2RlcjsKICBzdGF0aWMgc3RyaW5ncyA9IFsiZm9udEZhbWlseSIsICJmb250V2VpZ2h0IiwgIml0YWxpY0FuZ2xlIl07CiAgc3RhdGljIHdyaXRlKGluZm8yKSB7CiAgICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICBjb25zdCBlbmNvZGVkU3RyaW5ncyA9IHt9OwogICAgbGV0IHN0cmluZ3NMZW5ndGggPSAwOwogICAgZm9yIChjb25zdCBwcm9wIG9mIF9Dc3NGb250SW5mby5zdHJpbmdzKSB7CiAgICAgIGNvbnN0IGVuY29kZWQgPSBlbmNvZGVyLmVuY29kZShpbmZvMltwcm9wXSk7CiAgICAgIGVuY29kZWRTdHJpbmdzW3Byb3BdID0gZW5jb2RlZDsKICAgICAgc3RyaW5nc0xlbmd0aCArPSA0ICsgZW5jb2RlZC5sZW5ndGg7CiAgICB9CiAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoc3RyaW5nc0xlbmd0aCk7CiAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyKTsKICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgZm9yIChjb25zdCBwcm9wIG9mIF9Dc3NGb250SW5mby5zdHJpbmdzKSB7CiAgICAgIGNvbnN0IGVuY29kZWQgPSBlbmNvZGVkU3RyaW5nc1twcm9wXTsKICAgICAgY29uc3QgbGVuZ3RoID0gZW5jb2RlZC5sZW5ndGg7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgbGVuZ3RoKTsKICAgICAgZGF0YS5zZXQoZW5jb2RlZCwgb2Zmc2V0ICsgNCk7CiAgICAgIG9mZnNldCArPSA0ICsgbGVuZ3RoOwogICAgfQogICAgYXNzZXJ0KG9mZnNldCA9PT0gYnVmZmVyLmJ5dGVMZW5ndGgsICJDc3NGb250SW5mby53cml0ZTogQnVmZmVyIG92ZXJmbG93Iik7CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICBjb25zdHJ1Y3RvcihidWZmZXIpIHsKICAgIHRoaXMuI2J1ZmZlciA9IGJ1ZmZlcjsKICAgIHRoaXMuI3ZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy4jYnVmZmVyKTsKICAgIHRoaXMuI2RlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICB9CiAgI3JlYWRTdHJpbmcoaW5kZXgpIHsKICAgIGFzc2VydChpbmRleCA8IF9Dc3NGb250SW5mby5zdHJpbmdzLmxlbmd0aCwgIkludmFsaWQgc3RyaW5nIGluZGV4Iik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXg7IGkrKykgewogICAgICBvZmZzZXQgKz0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KSArIDQ7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgcmV0dXJuIHRoaXMuI2RlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgbGVuZ3RoKSk7CiAgfQogIGdldCBmb250RmFtaWx5KCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMCk7CiAgfQogIGdldCBmb250V2VpZ2h0KCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMSk7CiAgfQogIGdldCBpdGFsaWNBbmdsZSgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkU3RyaW5nKDIpOwogIH0KfTsKdmFyIFN5c3RlbUZvbnRJbmZvID0gY2xhc3MgX1N5c3RlbUZvbnRJbmZvIHsKICAjYnVmZmVyOwogICN2aWV3OwogICNkZWNvZGVyOwogIHN0YXRpYyBzdHJpbmdzID0gWyJjc3MiLCAibG9hZGVkTmFtZSIsICJiYXNlRm9udE5hbWUiLCAic3JjIl07CiAgc3RhdGljIHdyaXRlKGluZm8yKSB7CiAgICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICBjb25zdCBlbmNvZGVkU3RyaW5ncyA9IHt9OwogICAgbGV0IHN0cmluZ3NMZW5ndGggPSAwOwogICAgZm9yIChjb25zdCBwcm9wIG9mIF9TeXN0ZW1Gb250SW5mby5zdHJpbmdzKSB7CiAgICAgIGNvbnN0IGVuY29kZWQgPSBlbmNvZGVyLmVuY29kZShpbmZvMltwcm9wXSk7CiAgICAgIGVuY29kZWRTdHJpbmdzW3Byb3BdID0gZW5jb2RlZDsKICAgICAgc3RyaW5nc0xlbmd0aCArPSA0ICsgZW5jb2RlZC5sZW5ndGg7CiAgICB9CiAgICBzdHJpbmdzTGVuZ3RoICs9IDQ7CiAgICBsZXQgZW5jb2RlZFN0eWxlU3R5bGUsIGVuY29kZWRTdHlsZVdlaWdodCwgbGVuZ3RoRXN0aW1hdGUgPSAxICsgc3RyaW5nc0xlbmd0aDsKICAgIGlmIChpbmZvMi5zdHlsZSkgewogICAgICBlbmNvZGVkU3R5bGVTdHlsZSA9IGVuY29kZXIuZW5jb2RlKGluZm8yLnN0eWxlLnN0eWxlKTsKICAgICAgZW5jb2RlZFN0eWxlV2VpZ2h0ID0gZW5jb2Rlci5lbmNvZGUoaW5mbzIuc3R5bGUud2VpZ2h0KTsKICAgICAgbGVuZ3RoRXN0aW1hdGUgKz0gNCArIGVuY29kZWRTdHlsZVN0eWxlLmxlbmd0aCArIDQgKyBlbmNvZGVkU3R5bGVXZWlnaHQubGVuZ3RoOwogICAgfQogICAgY29uc3QgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGxlbmd0aEVzdGltYXRlKTsKICAgIGNvbnN0IGRhdGEgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgbGV0IG9mZnNldCA9IDA7CiAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBpbmZvMi5ndWVzc0ZhbGxiYWNrID8gMSA6IDApOwogICAgdmlldy5zZXRVaW50MzIob2Zmc2V0LCAwKTsKICAgIG9mZnNldCArPSA0OwogICAgc3RyaW5nc0xlbmd0aCA9IDA7CiAgICBmb3IgKGNvbnN0IHByb3Agb2YgX1N5c3RlbUZvbnRJbmZvLnN0cmluZ3MpIHsKICAgICAgY29uc3QgZW5jb2RlZCA9IGVuY29kZWRTdHJpbmdzW3Byb3BdOwogICAgICBjb25zdCBsZW5ndGggPSBlbmNvZGVkLmxlbmd0aDsKICAgICAgc3RyaW5nc0xlbmd0aCArPSA0ICsgbGVuZ3RoOwogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIGxlbmd0aCk7CiAgICAgIGRhdGEuc2V0KGVuY29kZWQsIG9mZnNldCArIDQpOwogICAgICBvZmZzZXQgKz0gNCArIGxlbmd0aDsKICAgIH0KICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCAtIHN0cmluZ3NMZW5ndGggLSA0LCBzdHJpbmdzTGVuZ3RoKTsKICAgIGlmIChpbmZvMi5zdHlsZSkgewogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIGVuY29kZWRTdHlsZVN0eWxlLmxlbmd0aCk7CiAgICAgIGRhdGEuc2V0KGVuY29kZWRTdHlsZVN0eWxlLCBvZmZzZXQgKyA0KTsKICAgICAgb2Zmc2V0ICs9IDQgKyBlbmNvZGVkU3R5bGVTdHlsZS5sZW5ndGg7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgZW5jb2RlZFN0eWxlV2VpZ2h0Lmxlbmd0aCk7CiAgICAgIGRhdGEuc2V0KGVuY29kZWRTdHlsZVdlaWdodCwgb2Zmc2V0ICsgNCk7CiAgICAgIG9mZnNldCArPSA0ICsgZW5jb2RlZFN0eWxlV2VpZ2h0Lmxlbmd0aDsKICAgIH0KICAgIGFzc2VydChvZmZzZXQgPD0gYnVmZmVyLmJ5dGVMZW5ndGgsICJTdWJzdGl0aW9uSW5mby53cml0ZTogQnVmZmVyIG92ZXJmbG93Iik7CiAgICByZXR1cm4gYnVmZmVyLnRyYW5zZmVyVG9GaXhlZExlbmd0aChvZmZzZXQpOwogIH0KICBjb25zdHJ1Y3RvcihidWZmZXIpIHsKICAgIHRoaXMuI2J1ZmZlciA9IGJ1ZmZlcjsKICAgIHRoaXMuI3ZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy4jYnVmZmVyKTsKICAgIHRoaXMuI2RlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICB9CiAgZ2V0IGd1ZXNzRmFsbGJhY2soKSB7CiAgICByZXR1cm4gdGhpcy4jdmlldy5nZXRVaW50OCgwKSAhPT0gMDsKICB9CiAgI3JlYWRTdHJpbmcoaW5kZXgpIHsKICAgIGFzc2VydChpbmRleCA8IF9TeXN0ZW1Gb250SW5mby5zdHJpbmdzLmxlbmd0aCwgIkludmFsaWQgc3RyaW5nIGluZGV4Iik7CiAgICBsZXQgb2Zmc2V0ID0gNTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXg7IGkrKykgewogICAgICBvZmZzZXQgKz0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KSArIDQ7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgcmV0dXJuIHRoaXMuI2RlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgbGVuZ3RoKSk7CiAgfQogIGdldCBjc3MoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZFN0cmluZygwKTsKICB9CiAgZ2V0IGxvYWRlZE5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZFN0cmluZygxKTsKICB9CiAgZ2V0IGJhc2VGb250TmFtZSgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkU3RyaW5nKDIpOwogIH0KICBnZXQgc3JjKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMyk7CiAgfQogIGdldCBzdHlsZSgpIHsKICAgIGxldCBvZmZzZXQgPSAxOwogICAgb2Zmc2V0ICs9IDQgKyB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgY29uc3Qgc3R5bGVMZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgY29uc3Qgc3R5bGUgPSB0aGlzLiNkZWNvZGVyLmRlY29kZShuZXcgVWludDhBcnJheSh0aGlzLiNidWZmZXIsIG9mZnNldCArIDQsIHN0eWxlTGVuZ3RoKSk7CiAgICBvZmZzZXQgKz0gNCArIHN0eWxlTGVuZ3RoOwogICAgY29uc3Qgd2VpZ2h0TGVuZ3RoID0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKICAgIGNvbnN0IHdlaWdodCA9IHRoaXMuI2RlY29kZXIuZGVjb2RlKG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgd2VpZ2h0TGVuZ3RoKSk7CiAgICByZXR1cm4gewogICAgICBzdHlsZSwKICAgICAgd2VpZ2h0CiAgICB9OwogIH0KfTsKdmFyIEZvbnRJbmZvID0gY2xhc3MgX0ZvbnRJbmZvIHsKICBzdGF0aWMgYm9vbHMgPSBbImJsYWNrIiwgImJvbGQiLCAiZGlzYWJsZUZvbnRGYWNlIiwgImZvbnRFeHRyYVByb3BlcnRpZXMiLCAiaXNJbnZhbGlkUERGanNGb250IiwgImlzVHlwZTNGb250IiwgIml0YWxpYyIsICJtaXNzaW5nRmlsZSIsICJyZW1lYXN1cmUiLCAidmVydGljYWwiXTsKICBzdGF0aWMgbnVtYmVycyA9IFsiYXNjZW50IiwgImRlZmF1bHRXaWR0aCIsICJkZXNjZW50Il07CiAgc3RhdGljIHN0cmluZ3MgPSBbImZhbGxiYWNrTmFtZSIsICJsb2FkZWROYW1lIiwgIm1pbWV0eXBlIiwgIm5hbWUiXTsKICBzdGF0aWMgI09GRlNFVF9OVU1CRVJTID0gTWF0aC5jZWlsKHRoaXMuYm9vbHMubGVuZ3RoICogMiAvIDgpOwogIHN0YXRpYyAjT0ZGU0VUX0JCT1ggPSB0aGlzLiNPRkZTRVRfTlVNQkVSUyArIHRoaXMubnVtYmVycy5sZW5ndGggKiA4OwogIHN0YXRpYyAjT0ZGU0VUX0ZPTlRfTUFUUklYID0gdGhpcy4jT0ZGU0VUX0JCT1ggKyAxICsgMiAqIDQ7CiAgc3RhdGljICNPRkZTRVRfREVGQVVMVF9WTUVUUklDUyA9IHRoaXMuI09GRlNFVF9GT05UX01BVFJJWCArIDEgKyA4ICogNjsKICBzdGF0aWMgI09GRlNFVF9TVFJJTkdTID0gdGhpcy4jT0ZGU0VUX0RFRkFVTFRfVk1FVFJJQ1MgKyAxICsgMiAqIDM7CiAgI2J1ZmZlcjsKICAjZGVjb2RlcjsKICAjdmlldzsKICBjb25zdHJ1Y3Rvcih7CiAgICBkYXRhLAogICAgZXh0cmEKICB9KSB7CiAgICB0aGlzLiNidWZmZXIgPSBkYXRhOwogICAgdGhpcy4jZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpOwogICAgdGhpcy4jdmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLiNidWZmZXIpOwogICAgaWYgKGV4dHJhKSB7CiAgICAgIE9iamVjdC5hc3NpZ24odGhpcywgZXh0cmEpOwogICAgfQogIH0KICAjcmVhZEJvb2xlYW4oaW5kZXgpIHsKICAgIGFzc2VydChpbmRleCA8IF9Gb250SW5mby5ib29scy5sZW5ndGgsICJJbnZhbGlkIGJvb2xlYW4gaW5kZXgiKTsKICAgIGNvbnN0IGJ5dGVPZmZzZXQgPSBNYXRoLmZsb29yKGluZGV4IC8gNCk7CiAgICBjb25zdCBiaXRPZmZzZXQgPSBpbmRleCAqIDIgJSA4OwogICAgY29uc3QgdmFsdWUgPSB0aGlzLiN2aWV3LmdldFVpbnQ4KGJ5dGVPZmZzZXQpID4+IGJpdE9mZnNldCAmIDM7CiAgICByZXR1cm4gdmFsdWUgPT09IDAgPyB2b2lkIDAgOiB2YWx1ZSA9PT0gMjsKICB9CiAgZ2V0IGJsYWNrKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRCb29sZWFuKDApOwogIH0KICBnZXQgYm9sZCgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkQm9vbGVhbigxKTsKICB9CiAgZ2V0IGRpc2FibGVGb250RmFjZSgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkQm9vbGVhbigyKTsKICB9CiAgZ2V0IGZvbnRFeHRyYVByb3BlcnRpZXMoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZEJvb2xlYW4oMyk7CiAgfQogIGdldCBpc0ludmFsaWRQREZqc0ZvbnQoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZEJvb2xlYW4oNCk7CiAgfQogIGdldCBpc1R5cGUzRm9udCgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkQm9vbGVhbig1KTsKICB9CiAgZ2V0IGl0YWxpYygpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkQm9vbGVhbig2KTsKICB9CiAgZ2V0IG1pc3NpbmdGaWxlKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRCb29sZWFuKDcpOwogIH0KICBnZXQgcmVtZWFzdXJlKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRCb29sZWFuKDgpOwogIH0KICBnZXQgdmVydGljYWwoKSB7CiAgICByZXR1cm4gdGhpcy4jcmVhZEJvb2xlYW4oOSk7CiAgfQogICNyZWFkTnVtYmVyKGluZGV4KSB7CiAgICBhc3NlcnQoaW5kZXggPCBfRm9udEluZm8ubnVtYmVycy5sZW5ndGgsICJJbnZhbGlkIG51bWJlciBpbmRleCIpOwogICAgcmV0dXJuIHRoaXMuI3ZpZXcuZ2V0RmxvYXQ2NChfRm9udEluZm8uI09GRlNFVF9OVU1CRVJTICsgaW5kZXggKiA4KTsKICB9CiAgZ2V0IGFzY2VudCgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkTnVtYmVyKDApOwogIH0KICBnZXQgZGVmYXVsdFdpZHRoKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWROdW1iZXIoMSk7CiAgfQogIGdldCBkZXNjZW50KCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWROdW1iZXIoMik7CiAgfQogIGdldCBiYm94KCkgewogICAgbGV0IG9mZnNldCA9IF9Gb250SW5mby4jT0ZGU0VUX0JCT1g7CiAgICBjb25zdCBudW1Db29yZHMgPSB0aGlzLiN2aWV3LmdldFVpbnQ4KG9mZnNldCk7CiAgICBpZiAobnVtQ29vcmRzID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBvZmZzZXQgKz0gMTsKICAgIGNvbnN0IGJib3ggPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgIGJib3gucHVzaCh0aGlzLiN2aWV3LmdldEludDE2KG9mZnNldCwgdHJ1ZSkpOwogICAgICBvZmZzZXQgKz0gMjsKICAgIH0KICAgIHJldHVybiBiYm94OwogIH0KICBnZXQgZm9udE1hdHJpeCgpIHsKICAgIGxldCBvZmZzZXQgPSBfRm9udEluZm8uI09GRlNFVF9GT05UX01BVFJJWDsKICAgIGNvbnN0IG51bVBvaW50cyA9IHRoaXMuI3ZpZXcuZ2V0VWludDgob2Zmc2V0KTsKICAgIGlmIChudW1Qb2ludHMgPT09IDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIG9mZnNldCArPSAxOwogICAgY29uc3QgZm9udE1hdHJpeCA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHsKICAgICAgZm9udE1hdHJpeC5wdXNoKHRoaXMuI3ZpZXcuZ2V0RmxvYXQ2NChvZmZzZXQsIHRydWUpKTsKICAgICAgb2Zmc2V0ICs9IDg7CiAgICB9CiAgICByZXR1cm4gZm9udE1hdHJpeDsKICB9CiAgZ2V0IGRlZmF1bHRWTWV0cmljcygpIHsKICAgIGxldCBvZmZzZXQgPSBfRm9udEluZm8uI09GRlNFVF9ERUZBVUxUX1ZNRVRSSUNTOwogICAgY29uc3QgbnVtTWV0cmljcyA9IHRoaXMuI3ZpZXcuZ2V0VWludDgob2Zmc2V0KTsKICAgIGlmIChudW1NZXRyaWNzID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBvZmZzZXQgKz0gMTsKICAgIGNvbnN0IGRlZmF1bHRWTWV0cmljcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgZGVmYXVsdFZNZXRyaWNzLnB1c2godGhpcy4jdmlldy5nZXRJbnQxNihvZmZzZXQsIHRydWUpKTsKICAgICAgb2Zmc2V0ICs9IDI7CiAgICB9CiAgICByZXR1cm4gZGVmYXVsdFZNZXRyaWNzOwogIH0KICAjcmVhZFN0cmluZyhpbmRleCkgewogICAgYXNzZXJ0KGluZGV4IDwgX0ZvbnRJbmZvLnN0cmluZ3MubGVuZ3RoLCAiSW52YWxpZCBzdHJpbmcgaW5kZXgiKTsKICAgIGxldCBvZmZzZXQgPSBfRm9udEluZm8uI09GRlNFVF9TVFJJTkdTICsgNDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXg7IGkrKykgewogICAgICBvZmZzZXQgKz0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KSArIDQ7CiAgICB9CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgY29uc3Qgc3RyaW5nRGF0YSA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCk7CiAgICBzdHJpbmdEYXRhLnNldChuZXcgVWludDhBcnJheSh0aGlzLiNidWZmZXIsIG9mZnNldCArIDQsIGxlbmd0aCkpOwogICAgcmV0dXJuIHRoaXMuI2RlY29kZXIuZGVjb2RlKHN0cmluZ0RhdGEpOwogIH0KICBnZXQgZmFsbGJhY2tOYW1lKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMCk7CiAgfQogIGdldCBsb2FkZWROYW1lKCkgewogICAgcmV0dXJuIHRoaXMuI3JlYWRTdHJpbmcoMSk7CiAgfQogIGdldCBtaW1ldHlwZSgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkU3RyaW5nKDIpOwogIH0KICBnZXQgbmFtZSgpIHsKICAgIHJldHVybiB0aGlzLiNyZWFkU3RyaW5nKDMpOwogIH0KICBnZXQgZGF0YSgpIHsKICAgIGxldCBvZmZzZXQgPSBfRm9udEluZm8uI09GRlNFVF9TVFJJTkdTOwogICAgY29uc3Qgc3RyaW5nc0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIHN0cmluZ3NMZW5ndGg7CiAgICBjb25zdCBzeXN0ZW1Gb250SW5mb0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIHN5c3RlbUZvbnRJbmZvTGVuZ3RoOwogICAgY29uc3QgY3NzRm9udEluZm9MZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgb2Zmc2V0ICs9IDQgKyBjc3NGb250SW5mb0xlbmd0aDsKICAgIGNvbnN0IGxlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBpZiAobGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkodGhpcy4jYnVmZmVyLCBvZmZzZXQgKyA0LCBsZW5ndGgpOwogIH0KICBjbGVhckRhdGEoKSB7CiAgICBsZXQgb2Zmc2V0ID0gX0ZvbnRJbmZvLiNPRkZTRVRfU1RSSU5HUzsKICAgIGNvbnN0IHN0cmluZ3NMZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgb2Zmc2V0ICs9IDQgKyBzdHJpbmdzTGVuZ3RoOwogICAgY29uc3Qgc3lzdGVtRm9udEluZm9MZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgb2Zmc2V0ICs9IDQgKyBzeXN0ZW1Gb250SW5mb0xlbmd0aDsKICAgIGNvbnN0IGNzc0ZvbnRJbmZvTGVuZ3RoID0gdGhpcy4jdmlldy5nZXRVaW50MzIob2Zmc2V0KTsKICAgIG9mZnNldCArPSA0ICsgY3NzRm9udEluZm9MZW5ndGg7CiAgICBjb25zdCBsZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KHRoaXMuI2J1ZmZlciwgb2Zmc2V0ICsgNCwgbGVuZ3RoKTsKICAgIGRhdGEuZmlsbCgwKTsKICAgIHRoaXMuI3ZpZXcuc2V0VWludDMyKG9mZnNldCwgMCk7CiAgfQogIGdldCBjc3NGb250SW5mbygpIHsKICAgIGxldCBvZmZzZXQgPSBfRm9udEluZm8uI09GRlNFVF9TVFJJTkdTOwogICAgY29uc3Qgc3RyaW5nc0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIHN0cmluZ3NMZW5ndGg7CiAgICBjb25zdCBzeXN0ZW1Gb250SW5mb0xlbmd0aCA9IHRoaXMuI3ZpZXcuZ2V0VWludDMyKG9mZnNldCk7CiAgICBvZmZzZXQgKz0gNCArIHN5c3RlbUZvbnRJbmZvTGVuZ3RoOwogICAgY29uc3QgY3NzRm9udEluZm9MZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgaWYgKGNzc0ZvbnRJbmZvTGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgY3NzRm9udEluZm9EYXRhID0gbmV3IFVpbnQ4QXJyYXkoY3NzRm9udEluZm9MZW5ndGgpOwogICAgY3NzRm9udEluZm9EYXRhLnNldChuZXcgVWludDhBcnJheSh0aGlzLiNidWZmZXIsIG9mZnNldCArIDQsIGNzc0ZvbnRJbmZvTGVuZ3RoKSk7CiAgICByZXR1cm4gbmV3IENzc0ZvbnRJbmZvKGNzc0ZvbnRJbmZvRGF0YS5idWZmZXIpOwogIH0KICBnZXQgc3lzdGVtRm9udEluZm8oKSB7CiAgICBsZXQgb2Zmc2V0ID0gX0ZvbnRJbmZvLiNPRkZTRVRfU1RSSU5HUzsKICAgIGNvbnN0IHN0cmluZ3NMZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgb2Zmc2V0ICs9IDQgKyBzdHJpbmdzTGVuZ3RoOwogICAgY29uc3Qgc3lzdGVtRm9udEluZm9MZW5ndGggPSB0aGlzLiN2aWV3LmdldFVpbnQzMihvZmZzZXQpOwogICAgaWYgKHN5c3RlbUZvbnRJbmZvTGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgc3lzdGVtRm9udEluZm9EYXRhID0gbmV3IFVpbnQ4QXJyYXkoc3lzdGVtRm9udEluZm9MZW5ndGgpOwogICAgc3lzdGVtRm9udEluZm9EYXRhLnNldChuZXcgVWludDhBcnJheSh0aGlzLiNidWZmZXIsIG9mZnNldCArIDQsIHN5c3RlbUZvbnRJbmZvTGVuZ3RoKSk7CiAgICByZXR1cm4gbmV3IFN5c3RlbUZvbnRJbmZvKHN5c3RlbUZvbnRJbmZvRGF0YS5idWZmZXIpOwogIH0KICBzdGF0aWMgd3JpdGUoZm9udCkgewogICAgY29uc3Qgc3lzdGVtRm9udEluZm9CdWZmZXIgPSBmb250LnN5c3RlbUZvbnRJbmZvID8gU3lzdGVtRm9udEluZm8ud3JpdGUoZm9udC5zeXN0ZW1Gb250SW5mbykgOiBudWxsOwogICAgY29uc3QgY3NzRm9udEluZm9CdWZmZXIgPSBmb250LmNzc0ZvbnRJbmZvID8gQ3NzRm9udEluZm8ud3JpdGUoZm9udC5jc3NGb250SW5mbykgOiBudWxsOwogICAgY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgY29uc3QgZW5jb2RlZFN0cmluZ3MgPSB7fTsKICAgIGxldCBzdHJpbmdzTGVuZ3RoID0gMDsKICAgIGZvciAoY29uc3QgcHJvcCBvZiBfRm9udEluZm8uc3RyaW5ncykgewogICAgICBlbmNvZGVkU3RyaW5nc1twcm9wXSA9IGVuY29kZXIuZW5jb2RlKGZvbnRbcHJvcF0pOwogICAgICBzdHJpbmdzTGVuZ3RoICs9IDQgKyBlbmNvZGVkU3RyaW5nc1twcm9wXS5sZW5ndGg7CiAgICB9CiAgICBjb25zdCBsZW5ndGhFc3RpbWF0ZSA9IF9Gb250SW5mby4jT0ZGU0VUX1NUUklOR1MgKyA0ICsgc3RyaW5nc0xlbmd0aCArIDQgKyAoc3lzdGVtRm9udEluZm9CdWZmZXIgPyBzeXN0ZW1Gb250SW5mb0J1ZmZlci5ieXRlTGVuZ3RoIDogMCkgKyA0ICsgKGNzc0ZvbnRJbmZvQnVmZmVyID8gY3NzRm9udEluZm9CdWZmZXIuYnl0ZUxlbmd0aCA6IDApICsgNCArIChmb250LmRhdGEgPyBmb250LmRhdGEubGVuZ3RoIDogMCk7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIobGVuZ3RoRXN0aW1hdGUpOwogICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGNvbnN0IG51bUJvb2xzID0gX0ZvbnRJbmZvLmJvb2xzLmxlbmd0aDsKICAgIGxldCBib29sQnl0ZSA9IDAsIGJvb2xCaXQgPSAwOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1Cb29sczsgaSsrKSB7CiAgICAgIGNvbnN0IHZhbHVlID0gZm9udFtfRm9udEluZm8uYm9vbHNbaV1dOwogICAgICBjb25zdCBiaXRzID0gdmFsdWUgPT09IHZvaWQgMCA/IDAgOiB2YWx1ZSA/IDIgOiAxOwogICAgICBib29sQnl0ZSB8PSBiaXRzIDw8IGJvb2xCaXQ7CiAgICAgIGJvb2xCaXQgKz0gMjsKICAgICAgaWYgKGJvb2xCaXQgPT09IDggfHwgaSA9PT0gbnVtQm9vbHMgLSAxKSB7CiAgICAgICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgYm9vbEJ5dGUpOwogICAgICAgIGJvb2xCeXRlID0gMDsKICAgICAgICBib29sQml0ID0gMDsKICAgICAgfQogICAgfQogICAgYXNzZXJ0KG9mZnNldCA9PT0gX0ZvbnRJbmZvLiNPRkZTRVRfTlVNQkVSUywgIkZvbnRJbmZvLndyaXRlOiBCb29sZWFuIHByb3BlcnRpZXMgb2Zmc2V0IG1pc21hdGNoIik7CiAgICBmb3IgKGNvbnN0IHByb3Agb2YgX0ZvbnRJbmZvLm51bWJlcnMpIHsKICAgICAgdmlldy5zZXRGbG9hdDY0KG9mZnNldCwgZm9udFtwcm9wXSk7CiAgICAgIG9mZnNldCArPSA4OwogICAgfQogICAgYXNzZXJ0KG9mZnNldCA9PT0gX0ZvbnRJbmZvLiNPRkZTRVRfQkJPWCwgIkZvbnRJbmZvLndyaXRlOiBOdW1iZXIgcHJvcGVydGllcyBvZmZzZXQgbWlzbWF0Y2giKTsKICAgIGlmIChmb250LmJib3gpIHsKICAgICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgNCk7CiAgICAgIGZvciAoY29uc3QgY29vcmQgb2YgZm9udC5iYm94KSB7CiAgICAgICAgdmlldy5zZXRJbnQxNihvZmZzZXQsIGNvb3JkLCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gMjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgMCk7CiAgICAgIG9mZnNldCArPSAyICogNDsKICAgIH0KICAgIGFzc2VydChvZmZzZXQgPT09IF9Gb250SW5mby4jT0ZGU0VUX0ZPTlRfTUFUUklYLCAiRm9udEluZm8ud3JpdGU6IEJCb3ggcHJvcGVydGllcyBvZmZzZXQgbWlzbWF0Y2giKTsKICAgIGlmIChmb250LmZvbnRNYXRyaXgpIHsKICAgICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgNik7CiAgICAgIGZvciAoY29uc3QgcG9pbnQgb2YgZm9udC5mb250TWF0cml4KSB7CiAgICAgICAgdmlldy5zZXRGbG9hdDY0KG9mZnNldCwgcG9pbnQsIHRydWUpOwogICAgICAgIG9mZnNldCArPSA4OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCAwKTsKICAgICAgb2Zmc2V0ICs9IDggKiA2OwogICAgfQogICAgYXNzZXJ0KG9mZnNldCA9PT0gX0ZvbnRJbmZvLiNPRkZTRVRfREVGQVVMVF9WTUVUUklDUywgIkZvbnRJbmZvLndyaXRlOiBGb250TWF0cml4IHByb3BlcnRpZXMgb2Zmc2V0IG1pc21hdGNoIik7CiAgICBpZiAoZm9udC5kZWZhdWx0Vk1ldHJpY3MpIHsKICAgICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgMSk7CiAgICAgIGZvciAoY29uc3QgbWV0cmljIG9mIGZvbnQuZGVmYXVsdFZNZXRyaWNzKSB7CiAgICAgICAgdmlldy5zZXRJbnQxNihvZmZzZXQsIG1ldHJpYywgdHJ1ZSk7CiAgICAgICAgb2Zmc2V0ICs9IDI7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZpZXcuc2V0VWludDgob2Zmc2V0KyssIDApOwogICAgICBvZmZzZXQgKz0gMyAqIDI7CiAgICB9CiAgICBhc3NlcnQob2Zmc2V0ID09PSBfRm9udEluZm8uI09GRlNFVF9TVFJJTkdTLCAiRm9udEluZm8ud3JpdGU6IERlZmF1bHRWTWV0cmljcyBwcm9wZXJ0aWVzIG9mZnNldCBtaXNtYXRjaCIpOwogICAgdmlldy5zZXRVaW50MzIoX0ZvbnRJbmZvLiNPRkZTRVRfU1RSSU5HUywgMCk7CiAgICBvZmZzZXQgKz0gNDsKICAgIGZvciAoY29uc3QgcHJvcCBvZiBfRm9udEluZm8uc3RyaW5ncykgewogICAgICBjb25zdCBlbmNvZGVkID0gZW5jb2RlZFN0cmluZ3NbcHJvcF07CiAgICAgIGNvbnN0IGxlbmd0aCA9IGVuY29kZWQubGVuZ3RoOwogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIGxlbmd0aCk7CiAgICAgIGRhdGEuc2V0KGVuY29kZWQsIG9mZnNldCArIDQpOwogICAgICBvZmZzZXQgKz0gNCArIGxlbmd0aDsKICAgIH0KICAgIHZpZXcuc2V0VWludDMyKF9Gb250SW5mby4jT0ZGU0VUX1NUUklOR1MsIG9mZnNldCAtIF9Gb250SW5mby4jT0ZGU0VUX1NUUklOR1MgLSA0KTsKICAgIGlmICghc3lzdGVtRm9udEluZm9CdWZmZXIpIHsKICAgICAgdmlldy5zZXRVaW50MzIob2Zmc2V0LCAwKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBsZW5ndGggPSBzeXN0ZW1Gb250SW5mb0J1ZmZlci5ieXRlTGVuZ3RoOwogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIGxlbmd0aCk7CiAgICAgIGFzc2VydChvZmZzZXQgKyA0ICsgbGVuZ3RoIDw9IGJ1ZmZlci5ieXRlTGVuZ3RoLCAiRm9udEluZm8ud3JpdGU6IEJ1ZmZlciBvdmVyZmxvdyBhdCBzeXN0ZW1Gb250SW5mbyIpOwogICAgICBkYXRhLnNldChuZXcgVWludDhBcnJheShzeXN0ZW1Gb250SW5mb0J1ZmZlciksIG9mZnNldCArIDQpOwogICAgICBvZmZzZXQgKz0gNCArIGxlbmd0aDsKICAgIH0KICAgIGlmICghY3NzRm9udEluZm9CdWZmZXIpIHsKICAgICAgdmlldy5zZXRVaW50MzIob2Zmc2V0LCAwKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBsZW5ndGggPSBjc3NGb250SW5mb0J1ZmZlci5ieXRlTGVuZ3RoOwogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIGxlbmd0aCk7CiAgICAgIGFzc2VydChvZmZzZXQgKyA0ICsgbGVuZ3RoIDw9IGJ1ZmZlci5ieXRlTGVuZ3RoLCAiRm9udEluZm8ud3JpdGU6IEJ1ZmZlciBvdmVyZmxvdyBhdCBjc3NGb250SW5mbyIpOwogICAgICBkYXRhLnNldChuZXcgVWludDhBcnJheShjc3NGb250SW5mb0J1ZmZlciksIG9mZnNldCArIDQpOwogICAgICBvZmZzZXQgKz0gNCArIGxlbmd0aDsKICAgIH0KICAgIGlmIChmb250LmRhdGEgPT09IHZvaWQgMCkgewogICAgICB2aWV3LnNldFVpbnQzMihvZmZzZXQsIDApOwogICAgICBvZmZzZXQgKz0gNDsKICAgIH0gZWxzZSB7CiAgICAgIHZpZXcuc2V0VWludDMyKG9mZnNldCwgZm9udC5kYXRhLmxlbmd0aCk7CiAgICAgIGRhdGEuc2V0KGZvbnQuZGF0YSwgb2Zmc2V0ICsgNCk7CiAgICAgIG9mZnNldCArPSA0ICsgZm9udC5kYXRhLmxlbmd0aDsKICAgIH0KICAgIGFzc2VydChvZmZzZXQgPD0gYnVmZmVyLmJ5dGVMZW5ndGgsICJGb250SW5mby53cml0ZTogQnVmZmVyIG92ZXJmbG93Iik7CiAgICByZXR1cm4gYnVmZmVyLnRyYW5zZmVyVG9GaXhlZExlbmd0aChvZmZzZXQpOwogIH0KfTsKdmFyIFBhdHRlcm5JbmZvID0gY2xhc3MgX1BhdHRlcm5JbmZvIHsKICBzdGF0aWMgI0tJTkQgPSAwOwogIHN0YXRpYyAjSEFTX0JCT1ggPSAxOwogIHN0YXRpYyAjSEFTX0JBQ0tHUk9VTkQgPSAyOwogIHN0YXRpYyAjU0hBRElOR19UWVBFID0gMzsKICBzdGF0aWMgI05fQ09PUkQgPSA0OwogIHN0YXRpYyAjTl9DT0xPUiA9IDg7CiAgc3RhdGljICNOX1NUT1AgPSAxMjsKICBzdGF0aWMgI05fRklHVVJFUyA9IDE2OwogIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgdGhpcy5idWZmZXIgPSBidWZmZXI7CiAgICB0aGlzLnZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTsKICAgIHRoaXMuZGF0YSA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgfQogIHN0YXRpYyB3cml0ZShpcikgewogICAgbGV0IGtpbmQsIGJib3ggPSBudWxsLCBjb29yZHMgPSBbXSwgY29sb3JzID0gW10sIGNvbG9yU3RvcHMgPSBbXSwgZmlndXJlcyA9IFtdLCBzaGFkaW5nVHlwZSA9IG51bGwsIGJhY2tncm91bmQgPSBudWxsOwogICAgc3dpdGNoIChpclswXSkgewogICAgICBjYXNlICJSYWRpYWxBeGlhbCI6CiAgICAgICAga2luZCA9IGlyWzFdID09PSAiYXhpYWwiID8gMSA6IDI7CiAgICAgICAgYmJveCA9IGlyWzJdOwogICAgICAgIGNvbG9yU3RvcHMgPSBpclszXTsKICAgICAgICBpZiAoa2luZCA9PT0gMSkgewogICAgICAgICAgY29vcmRzLnB1c2goLi4uaXJbNF0sIC4uLmlyWzVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29vcmRzLnB1c2goaXJbNF1bMF0sIGlyWzRdWzFdLCBpcls2XSwgaXJbNV1bMF0sIGlyWzVdWzFdLCBpcls3XSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJNZXNoIjoKICAgICAgICBraW5kID0gMzsKICAgICAgICBzaGFkaW5nVHlwZSA9IGlyWzFdOwogICAgICAgIGNvb3JkcyA9IGlyWzJdOwogICAgICAgIGNvbG9ycyA9IGlyWzNdOwogICAgICAgIGZpZ3VyZXMgPSBpcls0XSB8fCBbXTsKICAgICAgICBiYm94ID0gaXJbNl07CiAgICAgICAgYmFja2dyb3VuZCA9IGlyWzddOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgcGF0dGVybiB0eXBlOiAke2lyWzBdfWApOwogICAgfQogICAgY29uc3QgbkNvb3JkID0gTWF0aC5mbG9vcihjb29yZHMubGVuZ3RoIC8gMik7CiAgICBjb25zdCBuQ29sb3IgPSBNYXRoLmZsb29yKGNvbG9ycy5sZW5ndGggLyAzKTsKICAgIGNvbnN0IG5TdG9wID0gY29sb3JTdG9wcy5sZW5ndGg7CiAgICBjb25zdCBuRmlndXJlcyA9IGZpZ3VyZXMubGVuZ3RoOwogICAgbGV0IGZpZ3VyZXNTaXplID0gMDsKICAgIGZvciAoY29uc3QgZmlndXJlIG9mIGZpZ3VyZXMpIHsKICAgICAgZmlndXJlc1NpemUgKz0gMTsKICAgICAgZmlndXJlc1NpemUgPSBNYXRoLmNlaWwoZmlndXJlc1NpemUgLyA0KSAqIDQ7CiAgICAgIGZpZ3VyZXNTaXplICs9IDQgKyBmaWd1cmUuY29vcmRzLmxlbmd0aCAqIDQ7CiAgICAgIGZpZ3VyZXNTaXplICs9IDQgKyBmaWd1cmUuY29sb3JzLmxlbmd0aCAqIDQ7CiAgICAgIGlmIChmaWd1cmUudmVydGljZXNQZXJSb3cgIT09IHZvaWQgMCkgewogICAgICAgIGZpZ3VyZXNTaXplICs9IDQ7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJ5dGVMZW4gPSAyMCArIG5Db29yZCAqIDggKyBuQ29sb3IgKiAzICsgblN0b3AgKiA4ICsgKGJib3ggPyAxNiA6IDApICsgKGJhY2tncm91bmQgPyAzIDogMCkgKyBmaWd1cmVzU2l6ZTsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihieXRlTGVuKTsKICAgIGNvbnN0IGRhdGFWaWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBjb25zdCB1OGRhdGEgPSBuZXcgVWludDhBcnJheShidWZmZXIpOwogICAgZGF0YVZpZXcuc2V0VWludDgoX1BhdHRlcm5JbmZvLiNLSU5ELCBraW5kKTsKICAgIGRhdGFWaWV3LnNldFVpbnQ4KF9QYXR0ZXJuSW5mby4jSEFTX0JCT1gsIGJib3ggPyAxIDogMCk7CiAgICBkYXRhVmlldy5zZXRVaW50OChfUGF0dGVybkluZm8uI0hBU19CQUNLR1JPVU5ELCBiYWNrZ3JvdW5kID8gMSA6IDApOwogICAgZGF0YVZpZXcuc2V0VWludDgoX1BhdHRlcm5JbmZvLiNTSEFESU5HX1RZUEUsIHNoYWRpbmdUeXBlKTsKICAgIGRhdGFWaWV3LnNldFVpbnQzMihfUGF0dGVybkluZm8uI05fQ09PUkQsIG5Db29yZCwgdHJ1ZSk7CiAgICBkYXRhVmlldy5zZXRVaW50MzIoX1BhdHRlcm5JbmZvLiNOX0NPTE9SLCBuQ29sb3IsIHRydWUpOwogICAgZGF0YVZpZXcuc2V0VWludDMyKF9QYXR0ZXJuSW5mby4jTl9TVE9QLCBuU3RvcCwgdHJ1ZSk7CiAgICBkYXRhVmlldy5zZXRVaW50MzIoX1BhdHRlcm5JbmZvLiNOX0ZJR1VSRVMsIG5GaWd1cmVzLCB0cnVlKTsKICAgIGxldCBvZmZzZXQgPSAyMDsKICAgIGNvbnN0IGNvb3Jkc1ZpZXcgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmZlciwgb2Zmc2V0LCBuQ29vcmQgKiAyKTsKICAgIGNvb3Jkc1ZpZXcuc2V0KGNvb3Jkcyk7CiAgICBvZmZzZXQgKz0gbkNvb3JkICogODsKICAgIHU4ZGF0YS5zZXQoY29sb3JzLCBvZmZzZXQpOwogICAgb2Zmc2V0ICs9IG5Db2xvciAqIDM7CiAgICBmb3IgKGNvbnN0IFtwb3MsIGhleF0gb2YgY29sb3JTdG9wcykgewogICAgICBkYXRhVmlldy5zZXRGbG9hdDMyKG9mZnNldCwgcG9zLCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGRhdGFWaWV3LnNldFVpbnQzMihvZmZzZXQsIHBhcnNlSW50KGhleC5zbGljZSgxKSwgMTYpLCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICB9CiAgICBpZiAoYmJveCkgewogICAgICBmb3IgKGNvbnN0IHYgb2YgYmJveCkgewogICAgICAgIGRhdGFWaWV3LnNldEZsb2F0MzIob2Zmc2V0LCB2LCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgfQogICAgfQogICAgaWYgKGJhY2tncm91bmQpIHsKICAgICAgdThkYXRhLnNldChiYWNrZ3JvdW5kLCBvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gMzsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlndXJlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBmaWd1cmUgPSBmaWd1cmVzW2ldOwogICAgICBkYXRhVmlldy5zZXRVaW50OChvZmZzZXQsIGZpZ3VyZS50eXBlKTsKICAgICAgb2Zmc2V0ICs9IDE7CiAgICAgIG9mZnNldCA9IE1hdGguY2VpbChvZmZzZXQgLyA0KSAqIDQ7CiAgICAgIGRhdGFWaWV3LnNldFVpbnQzMihvZmZzZXQsIGZpZ3VyZS5jb29yZHMubGVuZ3RoLCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIGNvbnN0IGZpZ3VyZUNvb3Jkc1ZpZXcgPSBuZXcgSW50MzJBcnJheShidWZmZXIsIG9mZnNldCwgZmlndXJlLmNvb3Jkcy5sZW5ndGgpOwogICAgICBmaWd1cmVDb29yZHNWaWV3LnNldChmaWd1cmUuY29vcmRzKTsKICAgICAgb2Zmc2V0ICs9IGZpZ3VyZS5jb29yZHMubGVuZ3RoICogNDsKICAgICAgZGF0YVZpZXcuc2V0VWludDMyKG9mZnNldCwgZmlndXJlLmNvbG9ycy5sZW5ndGgsIHRydWUpOwogICAgICBvZmZzZXQgKz0gNDsKICAgICAgY29uc3QgY29sb3JzVmlldyA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlciwgb2Zmc2V0LCBmaWd1cmUuY29sb3JzLmxlbmd0aCk7CiAgICAgIGNvbG9yc1ZpZXcuc2V0KGZpZ3VyZS5jb2xvcnMpOwogICAgICBvZmZzZXQgKz0gZmlndXJlLmNvbG9ycy5sZW5ndGggKiA0OwogICAgICBpZiAoZmlndXJlLnZlcnRpY2VzUGVyUm93ICE9PSB2b2lkIDApIHsKICAgICAgICBkYXRhVmlldy5zZXRVaW50MzIob2Zmc2V0LCBmaWd1cmUudmVydGljZXNQZXJSb3csIHRydWUpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYnVmZmVyOwogIH0KICBnZXRJUigpIHsKICAgIGNvbnN0IGRhdGFWaWV3ID0gdGhpcy52aWV3OwogICAgY29uc3Qga2luZCA9IHRoaXMuZGF0YVtfUGF0dGVybkluZm8uI0tJTkRdOwogICAgY29uc3QgaGFzQkJveCA9ICEhdGhpcy5kYXRhW19QYXR0ZXJuSW5mby4jSEFTX0JCT1hdOwogICAgY29uc3QgaGFzQmFja2dyb3VuZCA9ICEhdGhpcy5kYXRhW19QYXR0ZXJuSW5mby4jSEFTX0JBQ0tHUk9VTkRdOwogICAgY29uc3QgbkNvb3JkID0gZGF0YVZpZXcuZ2V0VWludDMyKF9QYXR0ZXJuSW5mby4jTl9DT09SRCwgdHJ1ZSk7CiAgICBjb25zdCBuQ29sb3IgPSBkYXRhVmlldy5nZXRVaW50MzIoX1BhdHRlcm5JbmZvLiNOX0NPTE9SLCB0cnVlKTsKICAgIGNvbnN0IG5TdG9wID0gZGF0YVZpZXcuZ2V0VWludDMyKF9QYXR0ZXJuSW5mby4jTl9TVE9QLCB0cnVlKTsKICAgIGNvbnN0IG5GaWd1cmVzID0gZGF0YVZpZXcuZ2V0VWludDMyKF9QYXR0ZXJuSW5mby4jTl9GSUdVUkVTLCB0cnVlKTsKICAgIGxldCBvZmZzZXQgPSAyMDsKICAgIGNvbnN0IGNvb3JkcyA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5idWZmZXIsIG9mZnNldCwgbkNvb3JkICogMik7CiAgICBvZmZzZXQgKz0gbkNvb3JkICogODsKICAgIGNvbnN0IGNvbG9ycyA9IG5ldyBVaW50OEFycmF5KHRoaXMuYnVmZmVyLCBvZmZzZXQsIG5Db2xvciAqIDMpOwogICAgb2Zmc2V0ICs9IG5Db2xvciAqIDM7CiAgICBjb25zdCBzdG9wcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuU3RvcDsgKytpKSB7CiAgICAgIGNvbnN0IHAgPSBkYXRhVmlldy5nZXRGbG9hdDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBjb25zdCByZ2IgPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgb2Zmc2V0ICs9IDQ7CiAgICAgIHN0b3BzLnB1c2goW3AsIGAjJHtyZ2IudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDYsICIwIil9YF0pOwogICAgfQogICAgbGV0IGJib3ggPSBudWxsOwogICAgaWYgKGhhc0JCb3gpIHsKICAgICAgYmJveCA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7ICsraSkgewogICAgICAgIGJib3gucHVzaChkYXRhVmlldy5nZXRGbG9hdDMyKG9mZnNldCwgdHJ1ZSkpOwogICAgICAgIG9mZnNldCArPSA0OwogICAgICB9CiAgICB9CiAgICBsZXQgYmFja2dyb3VuZCA9IG51bGw7CiAgICBpZiAoaGFzQmFja2dyb3VuZCkgewogICAgICBiYWNrZ3JvdW5kID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5idWZmZXIsIG9mZnNldCwgMyk7CiAgICAgIG9mZnNldCArPSAzOwogICAgfQogICAgY29uc3QgZmlndXJlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuRmlndXJlczsgKytpKSB7CiAgICAgIGNvbnN0IHR5cGUgPSBkYXRhVmlldy5nZXRVaW50OChvZmZzZXQpOwogICAgICBvZmZzZXQgKz0gMTsKICAgICAgb2Zmc2V0ID0gTWF0aC5jZWlsKG9mZnNldCAvIDQpICogNDsKICAgICAgY29uc3QgY29vcmRzTGVuZ3RoID0gZGF0YVZpZXcuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBjb25zdCBmaWd1cmVDb29yZHMgPSBuZXcgSW50MzJBcnJheSh0aGlzLmJ1ZmZlciwgb2Zmc2V0LCBjb29yZHNMZW5ndGgpOwogICAgICBvZmZzZXQgKz0gY29vcmRzTGVuZ3RoICogNDsKICAgICAgY29uc3QgY29sb3JzTGVuZ3RoID0gZGF0YVZpZXcuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSk7CiAgICAgIG9mZnNldCArPSA0OwogICAgICBjb25zdCBmaWd1cmVDb2xvcnMgPSBuZXcgSW50MzJBcnJheSh0aGlzLmJ1ZmZlciwgb2Zmc2V0LCBjb2xvcnNMZW5ndGgpOwogICAgICBvZmZzZXQgKz0gY29sb3JzTGVuZ3RoICogNDsKICAgICAgY29uc3QgZmlndXJlID0gewogICAgICAgIHR5cGUsCiAgICAgICAgY29vcmRzOiBmaWd1cmVDb29yZHMsCiAgICAgICAgY29sb3JzOiBmaWd1cmVDb2xvcnMKICAgICAgfTsKICAgICAgaWYgKHR5cGUgPT09IE1lc2hGaWd1cmVUeXBlLkxBVFRJQ0UpIHsKICAgICAgICBmaWd1cmUudmVydGljZXNQZXJSb3cgPSBkYXRhVmlldy5nZXRVaW50MzIob2Zmc2V0LCB0cnVlKTsKICAgICAgICBvZmZzZXQgKz0gNDsKICAgICAgfQogICAgICBmaWd1cmVzLnB1c2goZmlndXJlKTsKICAgIH0KICAgIGlmIChraW5kID09PSAxKSB7CiAgICAgIHJldHVybiBbIlJhZGlhbEF4aWFsIiwgImF4aWFsIiwgYmJveCwgc3RvcHMsIEFycmF5LmZyb20oY29vcmRzLnNsaWNlKDAsIDIpKSwgQXJyYXkuZnJvbShjb29yZHMuc2xpY2UoMiwgNCkpLCBudWxsLCBudWxsXTsKICAgIH0KICAgIGlmIChraW5kID09PSAyKSB7CiAgICAgIHJldHVybiBbIlJhZGlhbEF4aWFsIiwgInJhZGlhbCIsIGJib3gsIHN0b3BzLCBbY29vcmRzWzBdLCBjb29yZHNbMV1dLCBbY29vcmRzWzNdLCBjb29yZHNbNF1dLCBjb29yZHNbMl0sIGNvb3Jkc1s1XV07CiAgICB9CiAgICBpZiAoa2luZCA9PT0gMykgewogICAgICBjb25zdCBzaGFkaW5nVHlwZSA9IHRoaXMuZGF0YVtfUGF0dGVybkluZm8uI1NIQURJTkdfVFlQRV07CiAgICAgIGxldCBib3VuZHMgPSBudWxsOwogICAgICBpZiAoY29vcmRzLmxlbmd0aCA+IDApIHsKICAgICAgICBsZXQgbWluWCA9IGNvb3Jkc1swXSwgbWF4WCA9IGNvb3Jkc1swXTsKICAgICAgICBsZXQgbWluWSA9IGNvb3Jkc1sxXSwgbWF4WSA9IGNvb3Jkc1sxXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvb3Jkcy5sZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgY29uc3QgeCA9IGNvb3Jkc1tpXSwgeSA9IGNvb3Jkc1tpICsgMV07CiAgICAgICAgICBtaW5YID0gbWluWCA+IHggPyB4IDogbWluWDsKICAgICAgICAgIG1pblkgPSBtaW5ZID4geSA/IHkgOiBtaW5ZOwogICAgICAgICAgbWF4WCA9IG1heFggPCB4ID8geCA6IG1heFg7CiAgICAgICAgICBtYXhZID0gbWF4WSA8IHkgPyB5IDogbWF4WTsKICAgICAgICB9CiAgICAgICAgYm91bmRzID0gW21pblgsIG1pblksIG1heFgsIG1heFldOwogICAgICB9CiAgICAgIHJldHVybiBbIk1lc2giLCBzaGFkaW5nVHlwZSwgY29vcmRzLCBjb2xvcnMsIGZpZ3VyZXMsIGJvdW5kcywgYmJveCwgYmFja2dyb3VuZF07CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHBhdHRlcm4ga2luZDogJHtraW5kfWApOwogIH0KfTsKdmFyIEZvbnRQYXRoSW5mbyA9IGNsYXNzIHsKICBzdGF0aWMgd3JpdGUocGF0aCkgewogICAgbGV0IGRhdGE7CiAgICBsZXQgYnVmZmVyOwogICAgaWYgKHV0aWxfRmVhdHVyZVRlc3QuaXNGbG9hdDE2QXJyYXlTdXBwb3J0ZWQpIHsKICAgICAgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKHBhdGgubGVuZ3RoICogMik7CiAgICAgIGRhdGEgPSBuZXcgRmxvYXQxNkFycmF5KGJ1ZmZlcik7CiAgICB9IGVsc2UgewogICAgICBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIocGF0aC5sZW5ndGggKiA0KTsKICAgICAgZGF0YSA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZmVyKTsKICAgIH0KICAgIGRhdGEuc2V0KHBhdGgpOwogICAgcmV0dXJuIGJ1ZmZlcjsKICB9CiAgI2J1ZmZlcjsKICBjb25zdHJ1Y3RvcihidWZmZXIpIHsKICAgIHRoaXMuI2J1ZmZlciA9IGJ1ZmZlcjsKICB9CiAgZ2V0IHBhdGgoKSB7CiAgICBpZiAodXRpbF9GZWF0dXJlVGVzdC5pc0Zsb2F0MTZBcnJheVN1cHBvcnRlZCkgewogICAgICByZXR1cm4gbmV3IEZsb2F0MTZBcnJheSh0aGlzLiNidWZmZXIpOwogICAgfQogICAgcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkodGhpcy4jYnVmZmVyKTsKICB9Cn07CmZ1bmN0aW9uIGdldFVybFByb3AodmFsKSB7CiAgaWYgKHZhbCBpbnN0YW5jZW9mIFVSTCkgewogICAgcmV0dXJuIHZhbC5ocmVmOwogIH0KICBpZiAodHlwZW9mIHZhbCA9PT0gInN0cmluZyIpIHsKICAgIGlmIChpc05vZGVKUykgewogICAgICByZXR1cm4gdmFsOwogICAgfQogICAgY29uc3QgdXJsID0gVVJMLnBhcnNlKHZhbCwgd2luZG93LmxvY2F0aW9uKTsKICAgIGlmICh1cmwpIHsKICAgICAgcmV0dXJuIHVybC5ocmVmOwogICAgfQogIH0KICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgUERGIHVybCBkYXRhOiBlaXRoZXIgc3RyaW5nIG9yIFVSTC1vYmplY3QgaXMgZXhwZWN0ZWQgaW4gdGhlIHVybCBwcm9wZXJ0eS4iKTsKfQpmdW5jdGlvbiBnZXREYXRhUHJvcCh2YWwpIHsKICBpZiAoaXNOb2RlSlMgJiYgdHlwZW9mIEJ1ZmZlciAhPT0gInVuZGVmaW5lZCIgJiYgdmFsIGluc3RhbmNlb2YgQnVmZmVyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlBsZWFzZSBwcm92aWRlIGJpbmFyeSBkYXRhIGFzIGBVaW50OEFycmF5YCwgcmF0aGVyIHRoYW4gYEJ1ZmZlcmAuIik7CiAgfQogIGlmICh2YWwgaW5zdGFuY2VvZiBVaW50OEFycmF5ICYmIHZhbC5ieXRlTGVuZ3RoID09PSB2YWwuYnVmZmVyLmJ5dGVMZW5ndGgpIHsKICAgIHJldHVybiB2YWw7CiAgfQogIGlmICh0eXBlb2YgdmFsID09PSAic3RyaW5nIikgewogICAgcmV0dXJuIHN0cmluZ1RvQnl0ZXModmFsKTsKICB9CiAgaWYgKHZhbCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IEFycmF5QnVmZmVyLmlzVmlldyh2YWwpIHx8IHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICYmICFpc05hTih2YWw/Lmxlbmd0aCkpIHsKICAgIHJldHVybiBuZXcgVWludDhBcnJheSh2YWwpOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgUERGIGJpbmFyeSBkYXRhOiBlaXRoZXIgVHlwZWRBcnJheSwgc3RyaW5nLCBvciBhcnJheS1saWtlIG9iamVjdCBpcyBleHBlY3RlZCBpbiB0aGUgZGF0YSBwcm9wZXJ0eS4iKTsKfQpmdW5jdGlvbiBnZXRGYWN0b3J5VXJsUHJvcCh2YWwpIHsKICBpZiAodHlwZW9mIHZhbCAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAodmFsLmVuZHNXaXRoKCIvIikpIHsKICAgIHJldHVybiB2YWw7CiAgfQogIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBmYWN0b3J5IHVybDogIiR7dmFsfSIgbXVzdCBpbmNsdWRlIHRyYWlsaW5nIHNsYXNoLmApOwp9CnZhciBpc1JlZlByb3h5ID0gKHYpID0+IHR5cGVvZiB2ID09PSAib2JqZWN0IiAmJiBOdW1iZXIuaXNJbnRlZ2VyKHY/Lm51bSkgJiYgdi5udW0gPj0gMCAmJiBOdW1iZXIuaXNJbnRlZ2VyKHY/LmdlbikgJiYgdi5nZW4gPj0gMDsKdmFyIGlzTmFtZVByb3h5ID0gKHYpID0+IHR5cGVvZiB2ID09PSAib2JqZWN0IiAmJiB0eXBlb2Ygdj8ubmFtZSA9PT0gInN0cmluZyI7CnZhciBpc1ZhbGlkRXhwbGljaXREZXN0ID0gX2lzVmFsaWRFeHBsaWNpdERlc3QuYmluZChudWxsLCBpc1JlZlByb3h5LCBpc05hbWVQcm94eSk7CnZhciBMb29wYmFja1BvcnQgPSBjbGFzcyB7CiAgI2xpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI2RlZmVycmVkID0gUHJvbWlzZS5yZXNvbHZlKCk7CiAgcG9zdE1lc3NhZ2Uob2JqLCB0cmFuc2ZlcikgewogICAgY29uc3QgZXZlbnQgPSB7CiAgICAgIGRhdGE6IHN0cnVjdHVyZWRDbG9uZShvYmosIHRyYW5zZmVyID8gewogICAgICAgIHRyYW5zZmVyCiAgICAgIH0gOiBudWxsKQogICAgfTsKICAgIHRoaXMuI2RlZmVycmVkLnRoZW4oKCkgPT4gewogICAgICBmb3IgKGNvbnN0IFtsaXN0ZW5lcl0gb2YgdGhpcy4jbGlzdGVuZXJzKSB7CiAgICAgICAgbGlzdGVuZXIuY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgIH0pOwogIH0KICBhZGRFdmVudExpc3RlbmVyKG5hbWUsIGxpc3RlbmVyLCBvcHRpb25zID0gbnVsbCkgewogICAgbGV0IHJtQWJvcnQgPSBudWxsOwogICAgaWYgKG9wdGlvbnM/LnNpZ25hbCBpbnN0YW5jZW9mIEFib3J0U2lnbmFsKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBzaWduYWwKICAgICAgfSA9IG9wdGlvbnM7CiAgICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgICAgIHdhcm4oIkxvb3BiYWNrUG9ydCAtIGNhbm5vdCB1c2UgYW4gYGFib3J0ZWRgIHNpZ25hbC4iKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3Qgb25BYm9ydCA9ICgpID0+IHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBsaXN0ZW5lcik7CiAgICAgIHJtQWJvcnQgPSAoKSA9PiBzaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBvbkFib3J0KTsKICAgICAgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0Iiwgb25BYm9ydCk7CiAgICB9CiAgICB0aGlzLiNsaXN0ZW5lcnMuc2V0KGxpc3RlbmVyLCBybUFib3J0KTsKICB9CiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBsaXN0ZW5lcikgewogICAgY29uc3Qgcm1BYm9ydCA9IHRoaXMuI2xpc3RlbmVycy5nZXQobGlzdGVuZXIpOwogICAgcm1BYm9ydD8uKCk7CiAgICB0aGlzLiNsaXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVyKTsKICB9CiAgdGVybWluYXRlKCkgewogICAgZm9yIChjb25zdCBbLCBybUFib3J0XSBvZiB0aGlzLiNsaXN0ZW5lcnMpIHsKICAgICAgcm1BYm9ydD8uKCk7CiAgICB9CiAgICB0aGlzLiNsaXN0ZW5lcnMuY2xlYXIoKTsKICB9Cn07CnZhciBDYWxsYmFja0tpbmQgPSB7CiAgREFUQTogMSwKICBFUlJPUjogMgp9Owp2YXIgU3RyZWFtS2luZCA9IHsKICBDQU5DRUw6IDEsCiAgQ0FOQ0VMX0NPTVBMRVRFOiAyLAogIENMT1NFOiAzLAogIEVOUVVFVUU6IDQsCiAgRVJST1I6IDUsCiAgUFVMTDogNiwKICBQVUxMX0NPTVBMRVRFOiA3LAogIFNUQVJUX0NPTVBMRVRFOiA4Cn07CmZ1bmN0aW9uIG9uRm4oKSB7Cn0KZnVuY3Rpb24gd3JhcFJlYXNvbihleCkgewogIGlmIChleCBpbnN0YW5jZW9mIEFib3J0RXhjZXB0aW9uIHx8IGV4IGluc3RhbmNlb2YgSW52YWxpZFBERkV4Y2VwdGlvbiB8fCBleCBpbnN0YW5jZW9mIFBhc3N3b3JkRXhjZXB0aW9uIHx8IGV4IGluc3RhbmNlb2YgUmVzcG9uc2VFeGNlcHRpb24gfHwgZXggaW5zdGFuY2VvZiBVbmtub3duRXJyb3JFeGNlcHRpb24pIHsKICAgIHJldHVybiBleDsKICB9CiAgaWYgKCEoZXggaW5zdGFuY2VvZiBFcnJvciB8fCB0eXBlb2YgZXggPT09ICJvYmplY3QiICYmIGV4ICE9PSBudWxsKSkgewogICAgdW5yZWFjaGFibGUoJ3dyYXBSZWFzb246IEV4cGVjdGVkICJyZWFzb24iIHRvIGJlIGEgKHBvc3NpYmx5IGNsb25lZCkgRXJyb3IuJyk7CiAgfQogIHN3aXRjaCAoZXgubmFtZSkgewogICAgY2FzZSAiQWJvcnRFeGNlcHRpb24iOgogICAgICByZXR1cm4gbmV3IEFib3J0RXhjZXB0aW9uKGV4Lm1lc3NhZ2UpOwogICAgY2FzZSAiSW52YWxpZFBERkV4Y2VwdGlvbiI6CiAgICAgIHJldHVybiBuZXcgSW52YWxpZFBERkV4Y2VwdGlvbihleC5tZXNzYWdlKTsKICAgIGNhc2UgIlBhc3N3b3JkRXhjZXB0aW9uIjoKICAgICAgcmV0dXJuIG5ldyBQYXNzd29yZEV4Y2VwdGlvbihleC5tZXNzYWdlLCBleC5jb2RlKTsKICAgIGNhc2UgIlJlc3BvbnNlRXhjZXB0aW9uIjoKICAgICAgcmV0dXJuIG5ldyBSZXNwb25zZUV4Y2VwdGlvbihleC5tZXNzYWdlLCBleC5zdGF0dXMsIGV4Lm1pc3NpbmcpOwogICAgY2FzZSAiVW5rbm93bkVycm9yRXhjZXB0aW9uIjoKICAgICAgcmV0dXJuIG5ldyBVbmtub3duRXJyb3JFeGNlcHRpb24oZXgubWVzc2FnZSwgZXguZGV0YWlscyk7CiAgfQogIHJldHVybiBuZXcgVW5rbm93bkVycm9yRXhjZXB0aW9uKGV4Lm1lc3NhZ2UsIGV4LnRvU3RyaW5nKCkpOwp9CnZhciBNZXNzYWdlSGFuZGxlciA9IGNsYXNzIHsKICAjbWVzc2FnZUFDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogIGNvbnN0cnVjdG9yKHNvdXJjZU5hbWUsIHRhcmdldE5hbWUsIGNvbU9iaikgewogICAgdGhpcy5zb3VyY2VOYW1lID0gc291cmNlTmFtZTsKICAgIHRoaXMudGFyZ2V0TmFtZSA9IHRhcmdldE5hbWU7CiAgICB0aGlzLmNvbU9iaiA9IGNvbU9iajsKICAgIHRoaXMuY2FsbGJhY2tJZCA9IDE7CiAgICB0aGlzLnN0cmVhbUlkID0gMTsKICAgIHRoaXMuc3RyZWFtU2lua3MgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMuc3RyZWFtQ29udHJvbGxlcnMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMuY2FsbGJhY2tDYXBhYmlsaXRpZXMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHRoaXMuYWN0aW9uSGFuZGxlciA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgY29tT2JqLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCB0aGlzLiNvbk1lc3NhZ2UuYmluZCh0aGlzKSwgewogICAgICBzaWduYWw6IHRoaXMuI21lc3NhZ2VBQy5zaWduYWwKICAgIH0pOwogIH0KICAjb25NZXNzYWdlKHsKICAgIGRhdGEKICB9KSB7CiAgICBpZiAoZGF0YS50YXJnZXROYW1lICE9PSB0aGlzLnNvdXJjZU5hbWUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGRhdGEuc3RyZWFtKSB7CiAgICAgIHRoaXMuI3Byb2Nlc3NTdHJlYW1NZXNzYWdlKGRhdGEpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZGF0YS5jYWxsYmFjaykgewogICAgICBjb25zdCBjYWxsYmFja0lkID0gZGF0YS5jYWxsYmFja0lkOwogICAgICBjb25zdCBjYXBhYmlsaXR5ID0gdGhpcy5jYWxsYmFja0NhcGFiaWxpdGllc1tjYWxsYmFja0lkXTsKICAgICAgaWYgKCFjYXBhYmlsaXR5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcmVzb2x2ZSBjYWxsYmFjayAke2NhbGxiYWNrSWR9YCk7CiAgICAgIH0KICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tDYXBhYmlsaXRpZXNbY2FsbGJhY2tJZF07CiAgICAgIGlmIChkYXRhLmNhbGxiYWNrID09PSBDYWxsYmFja0tpbmQuREFUQSkgewogICAgICAgIGNhcGFiaWxpdHkucmVzb2x2ZShkYXRhLmRhdGEpOwogICAgICB9IGVsc2UgaWYgKGRhdGEuY2FsbGJhY2sgPT09IENhbGxiYWNrS2luZC5FUlJPUikgewogICAgICAgIGNhcGFiaWxpdHkucmVqZWN0KHdyYXBSZWFzb24oZGF0YS5yZWFzb24pKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgY2FsbGJhY2sgY2FzZSIpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGFjdGlvbiA9IHRoaXMuYWN0aW9uSGFuZGxlcltkYXRhLmFjdGlvbl07CiAgICBpZiAoIWFjdGlvbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gYWN0aW9uIGZyb20gd29ya2VyOiAke2RhdGEuYWN0aW9ufWApOwogICAgfQogICAgaWYgKGRhdGEuY2FsbGJhY2tJZCkgewogICAgICBjb25zdCBzb3VyY2VOYW1lID0gdGhpcy5zb3VyY2VOYW1lLCB0YXJnZXROYW1lID0gZGF0YS5zb3VyY2VOYW1lLCBjb21PYmogPSB0aGlzLmNvbU9iajsKICAgICAgUHJvbWlzZS50cnkoYWN0aW9uLCBkYXRhLmRhdGEpLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgY2FsbGJhY2s6IENhbGxiYWNrS2luZC5EQVRBLAogICAgICAgICAgY2FsbGJhY2tJZDogZGF0YS5jYWxsYmFja0lkLAogICAgICAgICAgZGF0YTogcmVzdWx0CiAgICAgICAgfSk7CiAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgIGNhbGxiYWNrOiBDYWxsYmFja0tpbmQuRVJST1IsCiAgICAgICAgICBjYWxsYmFja0lkOiBkYXRhLmNhbGxiYWNrSWQsCiAgICAgICAgICByZWFzb246IHdyYXBSZWFzb24ocmVhc29uKQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGRhdGEuc3RyZWFtSWQpIHsKICAgICAgdGhpcy4jY3JlYXRlU3RyZWFtU2luayhkYXRhKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgYWN0aW9uKGRhdGEuZGF0YSk7CiAgfQogIG9uKGFjdGlvbk5hbWUsIGhhbmRsZXIpIHsKICAgIGNvbnN0IGFoID0gdGhpcy5hY3Rpb25IYW5kbGVyOwogICAgaWYgKGFoW2FjdGlvbk5hbWVdKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlcmUgaXMgYWxyZWFkeSBhbiBhY3Rpb25OYW1lIGNhbGxlZCAiJHthY3Rpb25OYW1lfSJgKTsKICAgIH0KICAgIGFoW2FjdGlvbk5hbWVdID0gaGFuZGxlcjsKICB9CiAgc2VuZChhY3Rpb25OYW1lLCBkYXRhLCB0cmFuc2ZlcnMpIHsKICAgIHRoaXMuY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgc291cmNlTmFtZTogdGhpcy5zb3VyY2VOYW1lLAogICAgICB0YXJnZXROYW1lOiB0aGlzLnRhcmdldE5hbWUsCiAgICAgIGFjdGlvbjogYWN0aW9uTmFtZSwKICAgICAgZGF0YQogICAgfSwgdHJhbnNmZXJzKTsKICB9CiAgc2VuZFdpdGhQcm9taXNlKGFjdGlvbk5hbWUsIGRhdGEsIHRyYW5zZmVycykgewogICAgY29uc3QgY2FsbGJhY2tJZCA9IHRoaXMuY2FsbGJhY2tJZCsrOwogICAgY29uc3QgY2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5jYWxsYmFja0NhcGFiaWxpdGllc1tjYWxsYmFja0lkXSA9IGNhcGFiaWxpdHk7CiAgICB0cnkgewogICAgICB0aGlzLmNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgc291cmNlTmFtZTogdGhpcy5zb3VyY2VOYW1lLAogICAgICAgIHRhcmdldE5hbWU6IHRoaXMudGFyZ2V0TmFtZSwKICAgICAgICBhY3Rpb246IGFjdGlvbk5hbWUsCiAgICAgICAgY2FsbGJhY2tJZCwKICAgICAgICBkYXRhCiAgICAgIH0sIHRyYW5zZmVycyk7CiAgICB9IGNhdGNoIChleCkgewogICAgICBjYXBhYmlsaXR5LnJlamVjdChleCk7CiAgICB9CiAgICByZXR1cm4gY2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICBzZW5kV2l0aFN0cmVhbShhY3Rpb25OYW1lLCBkYXRhLCBxdWV1ZWluZ1N0cmF0ZWd5LCB0cmFuc2ZlcnMpIHsKICAgIGNvbnN0IHN0cmVhbUlkID0gdGhpcy5zdHJlYW1JZCsrLCBzb3VyY2VOYW1lID0gdGhpcy5zb3VyY2VOYW1lLCB0YXJnZXROYW1lID0gdGhpcy50YXJnZXROYW1lLCBjb21PYmogPSB0aGlzLmNvbU9iajsKICAgIHJldHVybiBuZXcgUmVhZGFibGVTdHJlYW0oewogICAgICBzdGFydDogKGNvbnRyb2xsZXIpID0+IHsKICAgICAgICBjb25zdCBzdGFydENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgICAgICB0aGlzLnN0cmVhbUNvbnRyb2xsZXJzW3N0cmVhbUlkXSA9IHsKICAgICAgICAgIGNvbnRyb2xsZXIsCiAgICAgICAgICBzdGFydENhbGw6IHN0YXJ0Q2FwYWJpbGl0eSwKICAgICAgICAgIHB1bGxDYWxsOiBudWxsLAogICAgICAgICAgY2FuY2VsQ2FsbDogbnVsbCwKICAgICAgICAgIGlzQ2xvc2VkOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgYWN0aW9uOiBhY3Rpb25OYW1lLAogICAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgICBkYXRhLAogICAgICAgICAgZGVzaXJlZFNpemU6IGNvbnRyb2xsZXIuZGVzaXJlZFNpemUKICAgICAgICB9LCB0cmFuc2ZlcnMpOwogICAgICAgIHJldHVybiBzdGFydENhcGFiaWxpdHkucHJvbWlzZTsKICAgICAgfSwKICAgICAgcHVsbDogKGNvbnRyb2xsZXIpID0+IHsKICAgICAgICBjb25zdCBwdWxsQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgICAgIHRoaXMuc3RyZWFtQ29udHJvbGxlcnNbc3RyZWFtSWRdLnB1bGxDYWxsID0gcHVsbENhcGFiaWxpdHk7CiAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLlBVTEwsCiAgICAgICAgICBzdHJlYW1JZCwKICAgICAgICAgIGRlc2lyZWRTaXplOiBjb250cm9sbGVyLmRlc2lyZWRTaXplCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHB1bGxDYXBhYmlsaXR5LnByb21pc2U7CiAgICAgIH0sCiAgICAgIGNhbmNlbDogKHJlYXNvbikgPT4gewogICAgICAgIGFzc2VydChyZWFzb24gaW5zdGFuY2VvZiBFcnJvciwgImNhbmNlbCBtdXN0IGhhdmUgYSB2YWxpZCByZWFzb24iKTsKICAgICAgICBjb25zdCBjYW5jZWxDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICAgICAgdGhpcy5zdHJlYW1Db250cm9sbGVyc1tzdHJlYW1JZF0uY2FuY2VsQ2FsbCA9IGNhbmNlbENhcGFiaWxpdHk7CiAgICAgICAgdGhpcy5zdHJlYW1Db250cm9sbGVyc1tzdHJlYW1JZF0uaXNDbG9zZWQgPSB0cnVlOwogICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5DQU5DRUwsCiAgICAgICAgICBzdHJlYW1JZCwKICAgICAgICAgIHJlYXNvbjogd3JhcFJlYXNvbihyZWFzb24pCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNhbmNlbENhcGFiaWxpdHkucHJvbWlzZTsKICAgICAgfQogICAgfSwgcXVldWVpbmdTdHJhdGVneSk7CiAgfQogICNjcmVhdGVTdHJlYW1TaW5rKGRhdGEpIHsKICAgIGNvbnN0IHN0cmVhbUlkID0gZGF0YS5zdHJlYW1JZCwgc291cmNlTmFtZSA9IHRoaXMuc291cmNlTmFtZSwgdGFyZ2V0TmFtZSA9IGRhdGEuc291cmNlTmFtZSwgY29tT2JqID0gdGhpcy5jb21PYmo7CiAgICBjb25zdCBzZWxmID0gdGhpcywgYWN0aW9uID0gdGhpcy5hY3Rpb25IYW5kbGVyW2RhdGEuYWN0aW9uXTsKICAgIGNvbnN0IHN0cmVhbVNpbmsgPSB7CiAgICAgIGVucXVldWUoY2h1bmssIHNpemUgPSAxLCB0cmFuc2ZlcnMpIHsKICAgICAgICBpZiAodGhpcy5pc0NhbmNlbGxlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBsYXN0RGVzaXJlZFNpemUgPSB0aGlzLmRlc2lyZWRTaXplOwogICAgICAgIHRoaXMuZGVzaXJlZFNpemUgLT0gc2l6ZTsKICAgICAgICBpZiAobGFzdERlc2lyZWRTaXplID4gMCAmJiB0aGlzLmRlc2lyZWRTaXplIDw9IDApIHsKICAgICAgICAgIHRoaXMuc2lua0NhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgICAgICAgIHRoaXMucmVhZHkgPSB0aGlzLnNpbmtDYXBhYmlsaXR5LnByb21pc2U7CiAgICAgICAgfQogICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5FTlFVRVVFLAogICAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgICBjaHVuawogICAgICAgIH0sIHRyYW5zZmVycyk7CiAgICAgIH0sCiAgICAgIGNsb3NlKCkgewogICAgICAgIGlmICh0aGlzLmlzQ2FuY2VsbGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuaXNDYW5jZWxsZWQgPSB0cnVlOwogICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5DTE9TRSwKICAgICAgICAgIHN0cmVhbUlkCiAgICAgICAgfSk7CiAgICAgICAgZGVsZXRlIHNlbGYuc3RyZWFtU2lua3Nbc3RyZWFtSWRdOwogICAgICB9LAogICAgICBlcnJvcihyZWFzb24pIHsKICAgICAgICBhc3NlcnQocmVhc29uIGluc3RhbmNlb2YgRXJyb3IsICJlcnJvciBtdXN0IGhhdmUgYSB2YWxpZCByZWFzb24iKTsKICAgICAgICBpZiAodGhpcy5pc0NhbmNlbGxlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmlzQ2FuY2VsbGVkID0gdHJ1ZTsKICAgICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICBzdHJlYW06IFN0cmVhbUtpbmQuRVJST1IsCiAgICAgICAgICBzdHJlYW1JZCwKICAgICAgICAgIHJlYXNvbjogd3JhcFJlYXNvbihyZWFzb24pCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHNpbmtDYXBhYmlsaXR5OiBQcm9taXNlLndpdGhSZXNvbHZlcnMoKSwKICAgICAgb25QdWxsOiBudWxsLAogICAgICBvbkNhbmNlbDogbnVsbCwKICAgICAgaXNDYW5jZWxsZWQ6IGZhbHNlLAogICAgICBkZXNpcmVkU2l6ZTogZGF0YS5kZXNpcmVkU2l6ZSwKICAgICAgcmVhZHk6IG51bGwKICAgIH07CiAgICBzdHJlYW1TaW5rLnNpbmtDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgIHN0cmVhbVNpbmsucmVhZHkgPSBzdHJlYW1TaW5rLnNpbmtDYXBhYmlsaXR5LnByb21pc2U7CiAgICB0aGlzLnN0cmVhbVNpbmtzW3N0cmVhbUlkXSA9IHN0cmVhbVNpbms7CiAgICBQcm9taXNlLnRyeShhY3Rpb24sIGRhdGEuZGF0YSwgc3RyZWFtU2luaykudGhlbihmdW5jdGlvbigpIHsKICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLlNUQVJUX0NPTVBMRVRFLAogICAgICAgIHN0cmVhbUlkLAogICAgICAgIHN1Y2Nlc3M6IHRydWUKICAgICAgfSk7CiAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLlNUQVJUX0NPTVBMRVRFLAogICAgICAgIHN0cmVhbUlkLAogICAgICAgIHJlYXNvbjogd3JhcFJlYXNvbihyZWFzb24pCiAgICAgIH0pOwogICAgfSk7CiAgfQogICNwcm9jZXNzU3RyZWFtTWVzc2FnZShkYXRhKSB7CiAgICBjb25zdCBzdHJlYW1JZCA9IGRhdGEuc3RyZWFtSWQsIHNvdXJjZU5hbWUgPSB0aGlzLnNvdXJjZU5hbWUsIHRhcmdldE5hbWUgPSBkYXRhLnNvdXJjZU5hbWUsIGNvbU9iaiA9IHRoaXMuY29tT2JqOwogICAgY29uc3Qgc3RyZWFtQ29udHJvbGxlciA9IHRoaXMuc3RyZWFtQ29udHJvbGxlcnNbc3RyZWFtSWRdLCBzdHJlYW1TaW5rID0gdGhpcy5zdHJlYW1TaW5rc1tzdHJlYW1JZF07CiAgICBzd2l0Y2ggKGRhdGEuc3RyZWFtKSB7CiAgICAgIGNhc2UgU3RyZWFtS2luZC5TVEFSVF9DT01QTEVURToKICAgICAgICBpZiAoZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgICBzdHJlYW1Db250cm9sbGVyLnN0YXJ0Q2FsbC5yZXNvbHZlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cmVhbUNvbnRyb2xsZXIuc3RhcnRDYWxsLnJlamVjdCh3cmFwUmVhc29uKGRhdGEucmVhc29uKSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlIFN0cmVhbUtpbmQuUFVMTF9DT01QTEVURToKICAgICAgICBpZiAoZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgICBzdHJlYW1Db250cm9sbGVyLnB1bGxDYWxsLnJlc29sdmUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyZWFtQ29udHJvbGxlci5wdWxsQ2FsbC5yZWplY3Qod3JhcFJlYXNvbihkYXRhLnJlYXNvbikpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSBTdHJlYW1LaW5kLlBVTEw6CiAgICAgICAgaWYgKCFzdHJlYW1TaW5rKSB7CiAgICAgICAgICBjb21PYmoucG9zdE1lc3NhZ2UoewogICAgICAgICAgICBzb3VyY2VOYW1lLAogICAgICAgICAgICB0YXJnZXROYW1lLAogICAgICAgICAgICBzdHJlYW06IFN0cmVhbUtpbmQuUFVMTF9DT01QTEVURSwKICAgICAgICAgICAgc3RyZWFtSWQsCiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJlYW1TaW5rLmRlc2lyZWRTaXplIDw9IDAgJiYgZGF0YS5kZXNpcmVkU2l6ZSA+IDApIHsKICAgICAgICAgIHN0cmVhbVNpbmsuc2lua0NhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgICAgIH0KICAgICAgICBzdHJlYW1TaW5rLmRlc2lyZWRTaXplID0gZGF0YS5kZXNpcmVkU2l6ZTsKICAgICAgICBQcm9taXNlLnRyeShzdHJlYW1TaW5rLm9uUHVsbCB8fCBvbkZuKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgY29tT2JqLnBvc3RNZXNzYWdlKHsKICAgICAgICAgICAgc291cmNlTmFtZSwKICAgICAgICAgICAgdGFyZ2V0TmFtZSwKICAgICAgICAgICAgc3RyZWFtOiBTdHJlYW1LaW5kLlBVTExfQ09NUExFVEUsCiAgICAgICAgICAgIHN0cmVhbUlkLAogICAgICAgICAgICBzdWNjZXNzOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5QVUxMX0NPTVBMRVRFLAogICAgICAgICAgICBzdHJlYW1JZCwKICAgICAgICAgICAgcmVhc29uOiB3cmFwUmVhc29uKHJlYXNvbikKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIFN0cmVhbUtpbmQuRU5RVUVVRToKICAgICAgICBhc3NlcnQoc3RyZWFtQ29udHJvbGxlciwgImVucXVldWUgc2hvdWxkIGhhdmUgc3RyZWFtIGNvbnRyb2xsZXIiKTsKICAgICAgICBpZiAoc3RyZWFtQ29udHJvbGxlci5pc0Nsb3NlZCkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHN0cmVhbUNvbnRyb2xsZXIuY29udHJvbGxlci5lbnF1ZXVlKGRhdGEuY2h1bmspOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIFN0cmVhbUtpbmQuQ0xPU0U6CiAgICAgICAgYXNzZXJ0KHN0cmVhbUNvbnRyb2xsZXIsICJjbG9zZSBzaG91bGQgaGF2ZSBzdHJlYW0gY29udHJvbGxlciIpOwogICAgICAgIGlmIChzdHJlYW1Db250cm9sbGVyLmlzQ2xvc2VkKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgc3RyZWFtQ29udHJvbGxlci5pc0Nsb3NlZCA9IHRydWU7CiAgICAgICAgc3RyZWFtQ29udHJvbGxlci5jb250cm9sbGVyLmNsb3NlKCk7CiAgICAgICAgdGhpcy4jZGVsZXRlU3RyZWFtQ29udHJvbGxlcihzdHJlYW1Db250cm9sbGVyLCBzdHJlYW1JZCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgU3RyZWFtS2luZC5FUlJPUjoKICAgICAgICBhc3NlcnQoc3RyZWFtQ29udHJvbGxlciwgImVycm9yIHNob3VsZCBoYXZlIHN0cmVhbSBjb250cm9sbGVyIik7CiAgICAgICAgc3RyZWFtQ29udHJvbGxlci5jb250cm9sbGVyLmVycm9yKHdyYXBSZWFzb24oZGF0YS5yZWFzb24pKTsKICAgICAgICB0aGlzLiNkZWxldGVTdHJlYW1Db250cm9sbGVyKHN0cmVhbUNvbnRyb2xsZXIsIHN0cmVhbUlkKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBTdHJlYW1LaW5kLkNBTkNFTF9DT01QTEVURToKICAgICAgICBpZiAoZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgICBzdHJlYW1Db250cm9sbGVyLmNhbmNlbENhbGwucmVzb2x2ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHJlYW1Db250cm9sbGVyLmNhbmNlbENhbGwucmVqZWN0KHdyYXBSZWFzb24oZGF0YS5yZWFzb24pKTsKICAgICAgICB9CiAgICAgICAgdGhpcy4jZGVsZXRlU3RyZWFtQ29udHJvbGxlcihzdHJlYW1Db250cm9sbGVyLCBzdHJlYW1JZCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgU3RyZWFtS2luZC5DQU5DRUw6CiAgICAgICAgaWYgKCFzdHJlYW1TaW5rKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF0YVJlYXNvbiA9IHdyYXBSZWFzb24oZGF0YS5yZWFzb24pOwogICAgICAgIFByb21pc2UudHJ5KHN0cmVhbVNpbmsub25DYW5jZWwgfHwgb25GbiwgZGF0YVJlYXNvbikudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5DQU5DRUxfQ09NUExFVEUsCiAgICAgICAgICAgIHN0cmVhbUlkLAogICAgICAgICAgICBzdWNjZXNzOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgIGNvbU9iai5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgIHNvdXJjZU5hbWUsCiAgICAgICAgICAgIHRhcmdldE5hbWUsCiAgICAgICAgICAgIHN0cmVhbTogU3RyZWFtS2luZC5DQU5DRUxfQ09NUExFVEUsCiAgICAgICAgICAgIHN0cmVhbUlkLAogICAgICAgICAgICByZWFzb246IHdyYXBSZWFzb24ocmVhc29uKQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgc3RyZWFtU2luay5zaW5rQ2FwYWJpbGl0eS5yZWplY3QoZGF0YVJlYXNvbik7CiAgICAgICAgc3RyZWFtU2luay5pc0NhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgZGVsZXRlIHRoaXMuc3RyZWFtU2lua3Nbc3RyZWFtSWRdOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBzdHJlYW0gY2FzZSIpOwogICAgfQogIH0KICBhc3luYyAjZGVsZXRlU3RyZWFtQ29udHJvbGxlcihzdHJlYW1Db250cm9sbGVyLCBzdHJlYW1JZCkgewogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFtzdHJlYW1Db250cm9sbGVyLnN0YXJ0Q2FsbD8ucHJvbWlzZSwgc3RyZWFtQ29udHJvbGxlci5wdWxsQ2FsbD8ucHJvbWlzZSwgc3RyZWFtQ29udHJvbGxlci5jYW5jZWxDYWxsPy5wcm9taXNlXSk7CiAgICBkZWxldGUgdGhpcy5zdHJlYW1Db250cm9sbGVyc1tzdHJlYW1JZF07CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLiNtZXNzYWdlQUM/LmFib3J0KCk7CiAgICB0aGlzLiNtZXNzYWdlQUMgPSBudWxsOwogIH0KfTsKdmFyIEJhc2VDYW52YXNGYWN0b3J5ID0gY2xhc3MgewogICNlbmFibGVIV0EgPSBmYWxzZTsKICBjb25zdHJ1Y3Rvcih7CiAgICBlbmFibGVIV0EgPSBmYWxzZQogIH0pIHsKICAgIHRoaXMuI2VuYWJsZUhXQSA9IGVuYWJsZUhXQTsKICB9CiAgY3JlYXRlKHdpZHRoLCBoZWlnaHQpIHsKICAgIGlmICh3aWR0aCA8PSAwIHx8IGhlaWdodCA8PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBjYW52YXMgc2l6ZSIpOwogICAgfQogICAgY29uc3QgY2FudmFzID0gdGhpcy5fY3JlYXRlQ2FudmFzKHdpZHRoLCBoZWlnaHQpOwogICAgcmV0dXJuIHsKICAgICAgY2FudmFzLAogICAgICBjb250ZXh0OiBjYW52YXMuZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgICAgd2lsbFJlYWRGcmVxdWVudGx5OiAhdGhpcy4jZW5hYmxlSFdBCiAgICAgIH0pCiAgICB9OwogIH0KICByZXNldChjYW52YXNBbmRDb250ZXh0LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBpZiAoIWNhbnZhc0FuZENvbnRleHQuY2FudmFzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQ2FudmFzIGlzIG5vdCBzcGVjaWZpZWQiKTsKICAgIH0KICAgIGlmICh3aWR0aCA8PSAwIHx8IGhlaWdodCA8PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBjYW52YXMgc2l6ZSIpOwogICAgfQogICAgY2FudmFzQW5kQ29udGV4dC5jYW52YXMud2lkdGggPSB3aWR0aDsKICAgIGNhbnZhc0FuZENvbnRleHQuY2FudmFzLmhlaWdodCA9IGhlaWdodDsKICB9CiAgZGVzdHJveShjYW52YXNBbmRDb250ZXh0KSB7CiAgICBpZiAoIWNhbnZhc0FuZENvbnRleHQuY2FudmFzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQ2FudmFzIGlzIG5vdCBzcGVjaWZpZWQiKTsKICAgIH0KICAgIGNhbnZhc0FuZENvbnRleHQuY2FudmFzLndpZHRoID0gMDsKICAgIGNhbnZhc0FuZENvbnRleHQuY2FudmFzLmhlaWdodCA9IDA7CiAgICBjYW52YXNBbmRDb250ZXh0LmNhbnZhcyA9IG51bGw7CiAgICBjYW52YXNBbmRDb250ZXh0LmNvbnRleHQgPSBudWxsOwogIH0KICBfY3JlYXRlQ2FudmFzKHdpZHRoLCBoZWlnaHQpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgYF9jcmVhdGVDYW52YXNgIGNhbGxlZC4iKTsKICB9Cn07CnZhciBET01DYW52YXNGYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlQ2FudmFzRmFjdG9yeSB7CiAgY29uc3RydWN0b3IoewogICAgb3duZXJEb2N1bWVudCA9IGdsb2JhbFRoaXMuZG9jdW1lbnQsCiAgICBlbmFibGVIV0EgPSBmYWxzZQogIH0pIHsKICAgIHN1cGVyKHsKICAgICAgZW5hYmxlSFdBCiAgICB9KTsKICAgIHRoaXMuX2RvY3VtZW50ID0gb3duZXJEb2N1bWVudDsKICB9CiAgX2NyZWF0ZUNhbnZhcyh3aWR0aCwgaGVpZ2h0KSB7CiAgICBjb25zdCBjYW52YXMgPSB0aGlzLl9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGhlaWdodDsKICAgIHJldHVybiBjYW52YXM7CiAgfQp9Owp2YXIgQmFzZUNNYXBSZWFkZXJGYWN0b3J5ID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHsKICAgIGJhc2VVcmwgPSBudWxsLAogICAgaXNDb21wcmVzc2VkID0gdHJ1ZQogIH0pIHsKICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7CiAgICB0aGlzLmlzQ29tcHJlc3NlZCA9IGlzQ29tcHJlc3NlZDsKICB9CiAgYXN5bmMgZmV0Y2goewogICAgbmFtZQogIH0pIHsKICAgIGlmICghdGhpcy5iYXNlVXJsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRW5zdXJlIHRoYXQgdGhlIGBjTWFwVXJsYCBhbmQgYGNNYXBQYWNrZWRgIEFQSSBwYXJhbWV0ZXJzIGFyZSBwcm92aWRlZC4iKTsKICAgIH0KICAgIGlmICghbmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkNNYXAgbmFtZSBtdXN0IGJlIHNwZWNpZmllZC4iKTsKICAgIH0KICAgIGNvbnN0IHVybCA9IHRoaXMuYmFzZVVybCArIG5hbWUgKyAodGhpcy5pc0NvbXByZXNzZWQgPyAiLmJjbWFwIiA6ICIiKTsKICAgIHJldHVybiB0aGlzLl9mZXRjaCh1cmwpLnRoZW4oKGNNYXBEYXRhKSA9PiAoewogICAgICBjTWFwRGF0YSwKICAgICAgaXNDb21wcmVzc2VkOiB0aGlzLmlzQ29tcHJlc3NlZAogICAgfSkpLmNhdGNoKChyZWFzb24pID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gbG9hZCAke3RoaXMuaXNDb21wcmVzc2VkID8gImJpbmFyeSAiIDogIiJ9Q01hcCBhdDogJHt1cmx9YCk7CiAgICB9KTsKICB9CiAgYXN5bmMgX2ZldGNoKHVybCkgewogICAgdW5yZWFjaGFibGUoIkFic3RyYWN0IG1ldGhvZCBgX2ZldGNoYCBjYWxsZWQuIik7CiAgfQp9Owp2YXIgRE9NQ01hcFJlYWRlckZhY3RvcnkgPSBjbGFzcyBleHRlbmRzIEJhc2VDTWFwUmVhZGVyRmFjdG9yeSB7CiAgYXN5bmMgX2ZldGNoKHVybCkgewogICAgY29uc3QgZGF0YSA9IGF3YWl0IGZldGNoRGF0YSh1cmwsIHRoaXMuaXNDb21wcmVzc2VkID8gImFycmF5YnVmZmVyIiA6ICJ0ZXh0Iik7CiAgICByZXR1cm4gZGF0YSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyID8gbmV3IFVpbnQ4QXJyYXkoZGF0YSkgOiBzdHJpbmdUb0J5dGVzKGRhdGEpOwogIH0KfTsKdmFyIEJhc2VGaWx0ZXJGYWN0b3J5ID0gY2xhc3MgewogIGFkZEZpbHRlcihtYXBzKSB7CiAgICByZXR1cm4gIm5vbmUiOwogIH0KICBhZGRIQ01GaWx0ZXIoZmdDb2xvciwgYmdDb2xvcikgewogICAgcmV0dXJuICJub25lIjsKICB9CiAgYWRkQWxwaGFGaWx0ZXIobWFwKSB7CiAgICByZXR1cm4gIm5vbmUiOwogIH0KICBhZGRMdW1pbm9zaXR5RmlsdGVyKG1hcCkgewogICAgcmV0dXJuICJub25lIjsKICB9CiAgYWRkSGlnaGxpZ2h0SENNRmlsdGVyKGZpbHRlck5hbWUsIGZnQ29sb3IsIGJnQ29sb3IsIG5ld0ZnQ29sb3IsIG5ld0JnQ29sb3IpIHsKICAgIHJldHVybiAibm9uZSI7CiAgfQogIGRlc3Ryb3koa2VlcEhDTSA9IGZhbHNlKSB7CiAgfQp9Owp2YXIgRE9NRmlsdGVyRmFjdG9yeSA9IGNsYXNzIGV4dGVuZHMgQmFzZUZpbHRlckZhY3RvcnkgewogICNiYXNlVXJsOwogICNfY2FjaGU7CiAgI19kZWZzOwogICNkb2NJZDsKICAjZG9jdW1lbnQ7CiAgI19oY21DYWNoZTsKICAjaWQgPSAwOwogIGNvbnN0cnVjdG9yKHsKICAgIGRvY0lkLAogICAgb3duZXJEb2N1bWVudCA9IGdsb2JhbFRoaXMuZG9jdW1lbnQKICB9KSB7CiAgICBzdXBlcigpOwogICAgdGhpcy4jZG9jSWQgPSBkb2NJZDsKICAgIHRoaXMuI2RvY3VtZW50ID0gb3duZXJEb2N1bWVudDsKICB9CiAgZ2V0ICNjYWNoZSgpIHsKICAgIHJldHVybiB0aGlzLiNfY2FjaGUgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgfQogIGdldCAjaGNtQ2FjaGUoKSB7CiAgICByZXR1cm4gdGhpcy4jX2hjbUNhY2hlIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIH0KICBnZXQgI2RlZnMoKSB7CiAgICBpZiAoIXRoaXMuI19kZWZzKSB7CiAgICAgIGNvbnN0IGRpdiA9IHRoaXMuI2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBjb25zdCB7CiAgICAgICAgc3R5bGUKICAgICAgfSA9IGRpdjsKICAgICAgc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgICBzdHlsZS5jb250YWluID0gInN0cmljdCI7CiAgICAgIHN0eWxlLndpZHRoID0gc3R5bGUuaGVpZ2h0ID0gMDsKICAgICAgc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICBzdHlsZS50b3AgPSBzdHlsZS5sZWZ0ID0gMDsKICAgICAgc3R5bGUuekluZGV4ID0gLTE7CiAgICAgIGNvbnN0IHN2ZyA9IHRoaXMuI2RvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhTVkdfTlMsICJzdmciKTsKICAgICAgc3ZnLnNldEF0dHJpYnV0ZSgid2lkdGgiLCAwKTsKICAgICAgc3ZnLnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgMCk7CiAgICAgIHRoaXMuI19kZWZzID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgImRlZnMiKTsKICAgICAgZGl2LmFwcGVuZChzdmcpOwogICAgICBzdmcuYXBwZW5kKHRoaXMuI19kZWZzKTsKICAgICAgdGhpcy4jZG9jdW1lbnQuYm9keS5hcHBlbmQoZGl2KTsKICAgIH0KICAgIHJldHVybiB0aGlzLiNfZGVmczsKICB9CiAgI2NyZWF0ZVRhYmxlcyhtYXBzKSB7CiAgICBpZiAobWFwcy5sZW5ndGggPT09IDEpIHsKICAgICAgY29uc3QgbWFwUjIgPSBtYXBzWzBdOwogICAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXkoMjU2KTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgICAgIGJ1ZmZlcltpXSA9IG1hcFIyW2ldIC8gMjU1OwogICAgICB9CiAgICAgIGNvbnN0IHRhYmxlID0gYnVmZmVyLmpvaW4oIiwiKTsKICAgICAgcmV0dXJuIFt0YWJsZSwgdGFibGUsIHRhYmxlXTsKICAgIH0KICAgIGNvbnN0IFttYXBSLCBtYXBHLCBtYXBCXSA9IG1hcHM7CiAgICBjb25zdCBidWZmZXJSID0gbmV3IEFycmF5KDI1Nik7CiAgICBjb25zdCBidWZmZXJHID0gbmV3IEFycmF5KDI1Nik7CiAgICBjb25zdCBidWZmZXJCID0gbmV3IEFycmF5KDI1Nik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDI1NjsgaSsrKSB7CiAgICAgIGJ1ZmZlclJbaV0gPSBtYXBSW2ldIC8gMjU1OwogICAgICBidWZmZXJHW2ldID0gbWFwR1tpXSAvIDI1NTsKICAgICAgYnVmZmVyQltpXSA9IG1hcEJbaV0gLyAyNTU7CiAgICB9CiAgICByZXR1cm4gW2J1ZmZlclIuam9pbigiLCIpLCBidWZmZXJHLmpvaW4oIiwiKSwgYnVmZmVyQi5qb2luKCIsIildOwogIH0KICAjY3JlYXRlVXJsKGlkKSB7CiAgICBpZiAodGhpcy4jYmFzZVVybCA9PT0gdm9pZCAwKSB7CiAgICAgIHRoaXMuI2Jhc2VVcmwgPSAiIjsKICAgICAgY29uc3QgdXJsID0gdGhpcy4jZG9jdW1lbnQuVVJMOwogICAgICBpZiAodXJsICE9PSB0aGlzLiNkb2N1bWVudC5iYXNlVVJJKSB7CiAgICAgICAgaWYgKGlzRGF0YVNjaGVtZSh1cmwpKSB7CiAgICAgICAgICB3YXJuKCcjY3JlYXRlVXJsOiBpZ25vcmUgImRhdGE6Ii1VUkwgZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMuJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuI2Jhc2VVcmwgPSB1cGRhdGVVcmxIYXNoKHVybCwgIiIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGB1cmwoJHt0aGlzLiNiYXNlVXJsfSMke2lkfSlgOwogIH0KICBhZGRGaWx0ZXIobWFwcykgewogICAgaWYgKCFtYXBzKSB7CiAgICAgIHJldHVybiAibm9uZSI7CiAgICB9CiAgICBsZXQgdmFsdWUgPSB0aGlzLiNjYWNoZS5nZXQobWFwcyk7CiAgICBpZiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgY29uc3QgW3RhYmxlUiwgdGFibGVHLCB0YWJsZUJdID0gdGhpcy4jY3JlYXRlVGFibGVzKG1hcHMpOwogICAgY29uc3Qga2V5ID0gbWFwcy5sZW5ndGggPT09IDEgPyB0YWJsZVIgOiBgJHt0YWJsZVJ9JHt0YWJsZUd9JHt0YWJsZUJ9YDsKICAgIHZhbHVlID0gdGhpcy4jY2FjaGUuZ2V0KGtleSk7CiAgICBpZiAodmFsdWUpIHsKICAgICAgdGhpcy4jY2FjaGUuc2V0KG1hcHMsIHZhbHVlKTsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgY29uc3QgaWQgPSBgZ18ke3RoaXMuI2RvY0lkfV90cmFuc2Zlcl9tYXBfJHt0aGlzLiNpZCsrfWA7CiAgICBjb25zdCB1cmwgPSB0aGlzLiNjcmVhdGVVcmwoaWQpOwogICAgdGhpcy4jY2FjaGUuc2V0KG1hcHMsIHVybCk7CiAgICB0aGlzLiNjYWNoZS5zZXQoa2V5LCB1cmwpOwogICAgY29uc3QgZmlsdGVyID0gdGhpcy4jY3JlYXRlRmlsdGVyKGlkKTsKICAgIHRoaXMuI2FkZFRyYW5zZmVyTWFwQ29udmVyc2lvbih0YWJsZVIsIHRhYmxlRywgdGFibGVCLCBmaWx0ZXIpOwogICAgcmV0dXJuIHVybDsKICB9CiAgYWRkSENNRmlsdGVyKGZnQ29sb3IsIGJnQ29sb3IpIHsKICAgIGNvbnN0IGtleSA9IGAke2ZnQ29sb3J9LSR7YmdDb2xvcn1gOwogICAgY29uc3QgZmlsdGVyTmFtZSA9ICJiYXNlIjsKICAgIGxldCBpbmZvMiA9IHRoaXMuI2hjbUNhY2hlLmdldChmaWx0ZXJOYW1lKTsKICAgIGlmIChpbmZvMj8ua2V5ID09PSBrZXkpIHsKICAgICAgcmV0dXJuIGluZm8yLnVybDsKICAgIH0KICAgIGlmIChpbmZvMikgewogICAgICBpbmZvMi5maWx0ZXI/LnJlbW92ZSgpOwogICAgICBpbmZvMi5rZXkgPSBrZXk7CiAgICAgIGluZm8yLnVybCA9ICJub25lIjsKICAgICAgaW5mbzIuZmlsdGVyID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIGluZm8yID0gewogICAgICAgIGtleSwKICAgICAgICB1cmw6ICJub25lIiwKICAgICAgICBmaWx0ZXI6IG51bGwKICAgICAgfTsKICAgICAgdGhpcy4jaGNtQ2FjaGUuc2V0KGZpbHRlck5hbWUsIGluZm8yKTsKICAgIH0KICAgIGlmICghZmdDb2xvciB8fCAhYmdDb2xvcikgewogICAgICByZXR1cm4gaW5mbzIudXJsOwogICAgfQogICAgY29uc3QgZmdSR0IgPSB0aGlzLiNnZXRSR0IoZmdDb2xvcik7CiAgICBmZ0NvbG9yID0gVXRpbC5tYWtlSGV4Q29sb3IoLi4uZmdSR0IpOwogICAgY29uc3QgYmdSR0IgPSB0aGlzLiNnZXRSR0IoYmdDb2xvcik7CiAgICBiZ0NvbG9yID0gVXRpbC5tYWtlSGV4Q29sb3IoLi4uYmdSR0IpOwogICAgdGhpcy4jZGVmcy5zdHlsZS5jb2xvciA9ICIiOwogICAgaWYgKGZnQ29sb3IgPT09ICIjMDAwMDAwIiAmJiBiZ0NvbG9yID09PSAiI2ZmZmZmZiIgfHwgZmdDb2xvciA9PT0gYmdDb2xvcikgewogICAgICByZXR1cm4gaW5mbzIudXJsOwogICAgfQogICAgY29uc3QgbWFwID0gbmV3IEFycmF5KDI1Nik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8PSAyNTU7IGkrKykgewogICAgICBjb25zdCB4ID0gaSAvIDI1NTsKICAgICAgbWFwW2ldID0geCA8PSAwLjAzOTI4ID8geCAvIDEyLjkyIDogKCh4ICsgMC4wNTUpIC8gMS4wNTUpICoqIDIuNDsKICAgIH0KICAgIGNvbnN0IHRhYmxlID0gbWFwLmpvaW4oIiwiKTsKICAgIGNvbnN0IGlkID0gYGdfJHt0aGlzLiNkb2NJZH1faGNtX2ZpbHRlcmA7CiAgICBjb25zdCBmaWx0ZXIgPSBpbmZvMi5maWx0ZXIgPSB0aGlzLiNjcmVhdGVGaWx0ZXIoaWQpOwogICAgdGhpcy4jYWRkVHJhbnNmZXJNYXBDb252ZXJzaW9uKHRhYmxlLCB0YWJsZSwgdGFibGUsIGZpbHRlcik7CiAgICB0aGlzLiNhZGRHcmF5Q29udmVyc2lvbihmaWx0ZXIpOwogICAgY29uc3QgZ2V0U3RlcHMgPSAoYywgbikgPT4gewogICAgICBjb25zdCBzdGFydCA9IGZnUkdCW2NdIC8gMjU1OwogICAgICBjb25zdCBlbmQgPSBiZ1JHQltjXSAvIDI1NTsKICAgICAgY29uc3QgYXJyID0gbmV3IEFycmF5KG4gKyAxKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gbjsgaSsrKSB7CiAgICAgICAgYXJyW2ldID0gc3RhcnQgKyBpIC8gbiAqIChlbmQgLSBzdGFydCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFyci5qb2luKCIsIik7CiAgICB9OwogICAgdGhpcy4jYWRkVHJhbnNmZXJNYXBDb252ZXJzaW9uKGdldFN0ZXBzKDAsIDUpLCBnZXRTdGVwcygxLCA1KSwgZ2V0U3RlcHMoMiwgNSksIGZpbHRlcik7CiAgICBpbmZvMi51cmwgPSB0aGlzLiNjcmVhdGVVcmwoaWQpOwogICAgcmV0dXJuIGluZm8yLnVybDsKICB9CiAgYWRkQWxwaGFGaWx0ZXIobWFwKSB7CiAgICBsZXQgdmFsdWUgPSB0aGlzLiNjYWNoZS5nZXQobWFwKTsKICAgIGlmICh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBjb25zdCBbdGFibGVBXSA9IHRoaXMuI2NyZWF0ZVRhYmxlcyhbbWFwXSk7CiAgICBjb25zdCBrZXkgPSBgYWxwaGFfJHt0YWJsZUF9YDsKICAgIHZhbHVlID0gdGhpcy4jY2FjaGUuZ2V0KGtleSk7CiAgICBpZiAodmFsdWUpIHsKICAgICAgdGhpcy4jY2FjaGUuc2V0KG1hcCwgdmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBjb25zdCBpZCA9IGBnXyR7dGhpcy4jZG9jSWR9X2FscGhhX21hcF8ke3RoaXMuI2lkKyt9YDsKICAgIGNvbnN0IHVybCA9IHRoaXMuI2NyZWF0ZVVybChpZCk7CiAgICB0aGlzLiNjYWNoZS5zZXQobWFwLCB1cmwpOwogICAgdGhpcy4jY2FjaGUuc2V0KGtleSwgdXJsKTsKICAgIGNvbnN0IGZpbHRlciA9IHRoaXMuI2NyZWF0ZUZpbHRlcihpZCk7CiAgICB0aGlzLiNhZGRUcmFuc2Zlck1hcEFscGhhQ29udmVyc2lvbih0YWJsZUEsIGZpbHRlcik7CiAgICByZXR1cm4gdXJsOwogIH0KICBhZGRMdW1pbm9zaXR5RmlsdGVyKG1hcCkgewogICAgbGV0IHZhbHVlID0gdGhpcy4jY2FjaGUuZ2V0KG1hcCB8fCAibHVtaW5vc2l0eSIpOwogICAgaWYgKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGxldCB0YWJsZUEsIGtleTsKICAgIGlmIChtYXApIHsKICAgICAgW3RhYmxlQV0gPSB0aGlzLiNjcmVhdGVUYWJsZXMoW21hcF0pOwogICAgICBrZXkgPSBgbHVtaW5vc2l0eV8ke3RhYmxlQX1gOwogICAgfSBlbHNlIHsKICAgICAga2V5ID0gImx1bWlub3NpdHkiOwogICAgfQogICAgdmFsdWUgPSB0aGlzLiNjYWNoZS5nZXQoa2V5KTsKICAgIGlmICh2YWx1ZSkgewogICAgICB0aGlzLiNjYWNoZS5zZXQobWFwLCB2YWx1ZSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGNvbnN0IGlkID0gYGdfJHt0aGlzLiNkb2NJZH1fbHVtaW5vc2l0eV9tYXBfJHt0aGlzLiNpZCsrfWA7CiAgICBjb25zdCB1cmwgPSB0aGlzLiNjcmVhdGVVcmwoaWQpOwogICAgdGhpcy4jY2FjaGUuc2V0KG1hcCwgdXJsKTsKICAgIHRoaXMuI2NhY2hlLnNldChrZXksIHVybCk7CiAgICBjb25zdCBmaWx0ZXIgPSB0aGlzLiNjcmVhdGVGaWx0ZXIoaWQpOwogICAgdGhpcy4jYWRkTHVtaW5vc2l0eUNvbnZlcnNpb24oZmlsdGVyKTsKICAgIGlmIChtYXApIHsKICAgICAgdGhpcy4jYWRkVHJhbnNmZXJNYXBBbHBoYUNvbnZlcnNpb24odGFibGVBLCBmaWx0ZXIpOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9CiAgYWRkSGlnaGxpZ2h0SENNRmlsdGVyKGZpbHRlck5hbWUsIGZnQ29sb3IsIGJnQ29sb3IsIG5ld0ZnQ29sb3IsIG5ld0JnQ29sb3IpIHsKICAgIGNvbnN0IGtleSA9IGAke2ZnQ29sb3J9LSR7YmdDb2xvcn0tJHtuZXdGZ0NvbG9yfS0ke25ld0JnQ29sb3J9YDsKICAgIGxldCBpbmZvMiA9IHRoaXMuI2hjbUNhY2hlLmdldChmaWx0ZXJOYW1lKTsKICAgIGlmIChpbmZvMj8ua2V5ID09PSBrZXkpIHsKICAgICAgcmV0dXJuIGluZm8yLnVybDsKICAgIH0KICAgIGlmIChpbmZvMikgewogICAgICBpbmZvMi5maWx0ZXI/LnJlbW92ZSgpOwogICAgICBpbmZvMi5rZXkgPSBrZXk7CiAgICAgIGluZm8yLnVybCA9ICJub25lIjsKICAgICAgaW5mbzIuZmlsdGVyID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIGluZm8yID0gewogICAgICAgIGtleSwKICAgICAgICB1cmw6ICJub25lIiwKICAgICAgICBmaWx0ZXI6IG51bGwKICAgICAgfTsKICAgICAgdGhpcy4jaGNtQ2FjaGUuc2V0KGZpbHRlck5hbWUsIGluZm8yKTsKICAgIH0KICAgIGlmICghZmdDb2xvciB8fCAhYmdDb2xvcikgewogICAgICByZXR1cm4gaW5mbzIudXJsOwogICAgfQogICAgY29uc3QgW2ZnUkdCLCBiZ1JHQl0gPSBbZmdDb2xvciwgYmdDb2xvcl0ubWFwKHRoaXMuI2dldFJHQi5iaW5kKHRoaXMpKTsKICAgIGxldCBmZ0dyYXkgPSBNYXRoLnJvdW5kKDAuMjEyNiAqIGZnUkdCWzBdICsgMC43MTUyICogZmdSR0JbMV0gKyAwLjA3MjIgKiBmZ1JHQlsyXSk7CiAgICBsZXQgYmdHcmF5ID0gTWF0aC5yb3VuZCgwLjIxMjYgKiBiZ1JHQlswXSArIDAuNzE1MiAqIGJnUkdCWzFdICsgMC4wNzIyICogYmdSR0JbMl0pOwogICAgbGV0IFtuZXdGZ1JHQiwgbmV3QmdSR0JdID0gW25ld0ZnQ29sb3IsIG5ld0JnQ29sb3JdLm1hcCh0aGlzLiNnZXRSR0IuYmluZCh0aGlzKSk7CiAgICBpZiAoYmdHcmF5IDwgZmdHcmF5KSB7CiAgICAgIFtmZ0dyYXksIGJnR3JheSwgbmV3RmdSR0IsIG5ld0JnUkdCXSA9IFtiZ0dyYXksIGZnR3JheSwgbmV3QmdSR0IsIG5ld0ZnUkdCXTsKICAgIH0KICAgIHRoaXMuI2RlZnMuc3R5bGUuY29sb3IgPSAiIjsKICAgIGNvbnN0IGdldFN0ZXBzID0gKGZnLCBiZywgbikgPT4gewogICAgICBjb25zdCBhcnIgPSBuZXcgQXJyYXkoMjU2KTsKICAgICAgY29uc3Qgc3RlcCA9IChiZ0dyYXkgLSBmZ0dyYXkpIC8gbjsKICAgICAgY29uc3QgbmV3U3RhcnQgPSBmZyAvIDI1NTsKICAgICAgY29uc3QgbmV3U3RlcCA9IChiZyAtIGZnKSAvICgyNTUgKiBuKTsKICAgICAgbGV0IHByZXYgPSAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBuOyBpKyspIHsKICAgICAgICBjb25zdCBrID0gTWF0aC5yb3VuZChmZ0dyYXkgKyBpICogc3RlcCk7CiAgICAgICAgY29uc3QgdmFsdWUgPSBuZXdTdGFydCArIGkgKiBuZXdTdGVwOwogICAgICAgIGZvciAobGV0IGogPSBwcmV2OyBqIDw9IGs7IGorKykgewogICAgICAgICAgYXJyW2pdID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHByZXYgPSBrICsgMTsKICAgICAgfQogICAgICBmb3IgKGxldCBpID0gcHJldjsgaSA8IDI1NjsgaSsrKSB7CiAgICAgICAgYXJyW2ldID0gYXJyW3ByZXYgLSAxXTsKICAgICAgfQogICAgICByZXR1cm4gYXJyLmpvaW4oIiwiKTsKICAgIH07CiAgICBjb25zdCBpZCA9IGBnXyR7dGhpcy4jZG9jSWR9X2hjbV8ke2ZpbHRlck5hbWV9X2ZpbHRlcmA7CiAgICBjb25zdCBmaWx0ZXIgPSBpbmZvMi5maWx0ZXIgPSB0aGlzLiNjcmVhdGVGaWx0ZXIoaWQpOwogICAgdGhpcy4jYWRkR3JheUNvbnZlcnNpb24oZmlsdGVyKTsKICAgIHRoaXMuI2FkZFRyYW5zZmVyTWFwQ29udmVyc2lvbihnZXRTdGVwcyhuZXdGZ1JHQlswXSwgbmV3QmdSR0JbMF0sIDUpLCBnZXRTdGVwcyhuZXdGZ1JHQlsxXSwgbmV3QmdSR0JbMV0sIDUpLCBnZXRTdGVwcyhuZXdGZ1JHQlsyXSwgbmV3QmdSR0JbMl0sIDUpLCBmaWx0ZXIpOwogICAgaW5mbzIudXJsID0gdGhpcy4jY3JlYXRlVXJsKGlkKTsKICAgIHJldHVybiBpbmZvMi51cmw7CiAgfQogIGRlc3Ryb3koa2VlcEhDTSA9IGZhbHNlKSB7CiAgICBpZiAoa2VlcEhDTSAmJiB0aGlzLiNfaGNtQ2FjaGU/LnNpemUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jX2RlZnM/LnBhcmVudE5vZGUucGFyZW50Tm9kZS5yZW1vdmUoKTsKICAgIHRoaXMuI19kZWZzID0gbnVsbDsKICAgIHRoaXMuI19jYWNoZT8uY2xlYXIoKTsKICAgIHRoaXMuI19jYWNoZSA9IG51bGw7CiAgICB0aGlzLiNfaGNtQ2FjaGU/LmNsZWFyKCk7CiAgICB0aGlzLiNfaGNtQ2FjaGUgPSBudWxsOwogICAgdGhpcy4jaWQgPSAwOwogIH0KICAjYWRkTHVtaW5vc2l0eUNvbnZlcnNpb24oZmlsdGVyKSB7CiAgICBjb25zdCBmZUNvbG9yTWF0cml4ID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgImZlQ29sb3JNYXRyaXgiKTsKICAgIGZlQ29sb3JNYXRyaXguc2V0QXR0cmlidXRlKCJ0eXBlIiwgIm1hdHJpeCIpOwogICAgZmVDb2xvck1hdHJpeC5zZXRBdHRyaWJ1dGUoInZhbHVlcyIsICIwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwLjMgMC41OSAwLjExIDAgMCIpOwogICAgZmlsdGVyLmFwcGVuZChmZUNvbG9yTWF0cml4KTsKICB9CiAgI2FkZEdyYXlDb252ZXJzaW9uKGZpbHRlcikgewogICAgY29uc3QgZmVDb2xvck1hdHJpeCA9IHRoaXMuI2RvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhTVkdfTlMsICJmZUNvbG9yTWF0cml4Iik7CiAgICBmZUNvbG9yTWF0cml4LnNldEF0dHJpYnV0ZSgidHlwZSIsICJtYXRyaXgiKTsKICAgIGZlQ29sb3JNYXRyaXguc2V0QXR0cmlidXRlKCJ2YWx1ZXMiLCAiMC4yMTI2IDAuNzE1MiAwLjA3MjIgMCAwIDAuMjEyNiAwLjcxNTIgMC4wNzIyIDAgMCAwLjIxMjYgMC43MTUyIDAuMDcyMiAwIDAgMCAwIDAgMSAwIik7CiAgICBmaWx0ZXIuYXBwZW5kKGZlQ29sb3JNYXRyaXgpOwogIH0KICAjY3JlYXRlRmlsdGVyKGlkKSB7CiAgICBjb25zdCBmaWx0ZXIgPSB0aGlzLiNkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoU1ZHX05TLCAiZmlsdGVyIik7CiAgICBmaWx0ZXIuc2V0QXR0cmlidXRlKCJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiLCAic1JHQiIpOwogICAgZmlsdGVyLnNldEF0dHJpYnV0ZSgiaWQiLCBpZCk7CiAgICB0aGlzLiNkZWZzLmFwcGVuZChmaWx0ZXIpOwogICAgcmV0dXJuIGZpbHRlcjsKICB9CiAgI2FwcGVuZEZlRnVuYyhmZUNvbXBvbmVudFRyYW5zZmVyLCBmdW5jLCB0YWJsZSkgewogICAgY29uc3QgZmVGdW5jID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgZnVuYyk7CiAgICBmZUZ1bmMuc2V0QXR0cmlidXRlKCJ0eXBlIiwgImRpc2NyZXRlIik7CiAgICBmZUZ1bmMuc2V0QXR0cmlidXRlKCJ0YWJsZVZhbHVlcyIsIHRhYmxlKTsKICAgIGZlQ29tcG9uZW50VHJhbnNmZXIuYXBwZW5kKGZlRnVuYyk7CiAgfQogICNhZGRUcmFuc2Zlck1hcENvbnZlcnNpb24oclRhYmxlLCBnVGFibGUsIGJUYWJsZSwgZmlsdGVyKSB7CiAgICBjb25zdCBmZUNvbXBvbmVudFRyYW5zZmVyID0gdGhpcy4jZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFNWR19OUywgImZlQ29tcG9uZW50VHJhbnNmZXIiKTsKICAgIGZpbHRlci5hcHBlbmQoZmVDb21wb25lbnRUcmFuc2Zlcik7CiAgICB0aGlzLiNhcHBlbmRGZUZ1bmMoZmVDb21wb25lbnRUcmFuc2ZlciwgImZlRnVuY1IiLCByVGFibGUpOwogICAgdGhpcy4jYXBwZW5kRmVGdW5jKGZlQ29tcG9uZW50VHJhbnNmZXIsICJmZUZ1bmNHIiwgZ1RhYmxlKTsKICAgIHRoaXMuI2FwcGVuZEZlRnVuYyhmZUNvbXBvbmVudFRyYW5zZmVyLCAiZmVGdW5jQiIsIGJUYWJsZSk7CiAgfQogICNhZGRUcmFuc2Zlck1hcEFscGhhQ29udmVyc2lvbihhVGFibGUsIGZpbHRlcikgewogICAgY29uc3QgZmVDb21wb25lbnRUcmFuc2ZlciA9IHRoaXMuI2RvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhTVkdfTlMsICJmZUNvbXBvbmVudFRyYW5zZmVyIik7CiAgICBmaWx0ZXIuYXBwZW5kKGZlQ29tcG9uZW50VHJhbnNmZXIpOwogICAgdGhpcy4jYXBwZW5kRmVGdW5jKGZlQ29tcG9uZW50VHJhbnNmZXIsICJmZUZ1bmNBIiwgYVRhYmxlKTsKICB9CiAgI2dldFJHQihjb2xvcikgewogICAgdGhpcy4jZGVmcy5zdHlsZS5jb2xvciA9IGNvbG9yOwogICAgcmV0dXJuIGdldFJHQihnZXRDb21wdXRlZFN0eWxlKHRoaXMuI2RlZnMpLmdldFByb3BlcnR5VmFsdWUoImNvbG9yIikpOwogIH0KfTsKdmFyIEJhc2VTdGFuZGFyZEZvbnREYXRhRmFjdG9yeSA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcih7CiAgICBiYXNlVXJsID0gbnVsbAogIH0pIHsKICAgIHRoaXMuYmFzZVVybCA9IGJhc2VVcmw7CiAgfQogIGFzeW5jIGZldGNoKHsKICAgIGZpbGVuYW1lCiAgfSkgewogICAgaWYgKCF0aGlzLmJhc2VVcmwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbnN1cmUgdGhhdCB0aGUgYHN0YW5kYXJkRm9udERhdGFVcmxgIEFQSSBwYXJhbWV0ZXIgaXMgcHJvdmlkZWQuIik7CiAgICB9CiAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRm9udCBmaWxlbmFtZSBtdXN0IGJlIHNwZWNpZmllZC4iKTsKICAgIH0KICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmFzZVVybH0ke2ZpbGVuYW1lfWA7CiAgICByZXR1cm4gdGhpcy5fZmV0Y2godXJsKS5jYXRjaCgocmVhc29uKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGxvYWQgZm9udCBkYXRhIGF0OiAke3VybH1gKTsKICAgIH0pOwogIH0KICBhc3luYyBfZmV0Y2godXJsKSB7CiAgICB1bnJlYWNoYWJsZSgiQWJzdHJhY3QgbWV0aG9kIGBfZmV0Y2hgIGNhbGxlZC4iKTsKICB9Cn07CnZhciBET01TdGFuZGFyZEZvbnREYXRhRmFjdG9yeSA9IGNsYXNzIGV4dGVuZHMgQmFzZVN0YW5kYXJkRm9udERhdGFGYWN0b3J5IHsKICBhc3luYyBfZmV0Y2godXJsKSB7CiAgICBjb25zdCBkYXRhID0gYXdhaXQgZmV0Y2hEYXRhKHVybCwgImFycmF5YnVmZmVyIik7CiAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7CiAgfQp9Owp2YXIgQmFzZVdhc21GYWN0b3J5ID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHsKICAgIGJhc2VVcmwgPSBudWxsCiAgfSkgewogICAgdGhpcy5iYXNlVXJsID0gYmFzZVVybDsKICB9CiAgYXN5bmMgZmV0Y2goewogICAgZmlsZW5hbWUKICB9KSB7CiAgICBpZiAoIXRoaXMuYmFzZVVybCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkVuc3VyZSB0aGF0IHRoZSBgd2FzbVVybGAgQVBJIHBhcmFtZXRlciBpcyBwcm92aWRlZC4iKTsKICAgIH0KICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJXYXNtIGZpbGVuYW1lIG11c3QgYmUgc3BlY2lmaWVkLiIpOwogICAgfQogICAgY29uc3QgdXJsID0gYCR7dGhpcy5iYXNlVXJsfSR7ZmlsZW5hbWV9YDsKICAgIHJldHVybiB0aGlzLl9mZXRjaCh1cmwpLmNhdGNoKChyZWFzb24pID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gbG9hZCB3YXNtIGRhdGEgYXQ6ICR7dXJsfWApOwogICAgfSk7CiAgfQogIGFzeW5jIF9mZXRjaCh1cmwpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgYF9mZXRjaGAgY2FsbGVkLiIpOwogIH0KfTsKdmFyIERPTVdhc21GYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlV2FzbUZhY3RvcnkgewogIGFzeW5jIF9mZXRjaCh1cmwpIHsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmZXRjaERhdGEodXJsLCAiYXJyYXlidWZmZXIiKTsKICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhKTsKICB9Cn07CmlmIChpc05vZGVKUykgewogIHdhcm4oIlBsZWFzZSB1c2UgdGhlIGBsZWdhY3lgIGJ1aWxkIGluIE5vZGUuanMgZW52aXJvbm1lbnRzLiIpOwp9CmFzeW5jIGZ1bmN0aW9uIG5vZGVfdXRpbHNfZmV0Y2hEYXRhKHVybCkgewogIGNvbnN0IGZzID0gcHJvY2Vzcy5nZXRCdWlsdGluTW9kdWxlKCJmcyIpOwogIGNvbnN0IGRhdGEgPSBhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh1cmwpOwogIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhKTsKfQp2YXIgTm9kZUZpbHRlckZhY3RvcnkgPSBjbGFzcyBleHRlbmRzIEJhc2VGaWx0ZXJGYWN0b3J5IHsKfTsKdmFyIE5vZGVDYW52YXNGYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlQ2FudmFzRmFjdG9yeSB7CiAgX2NyZWF0ZUNhbnZhcyh3aWR0aCwgaGVpZ2h0KSB7CiAgICBjb25zdCByZXF1aXJlMiA9IHByb2Nlc3MuZ2V0QnVpbHRpbk1vZHVsZSgibW9kdWxlIikuY3JlYXRlUmVxdWlyZShpbXBvcnQubWV0YS51cmwpOwogICAgY29uc3QgY2FudmFzID0gcmVxdWlyZTIoIkBuYXBpLXJzL2NhbnZhcyIpOwogICAgcmV0dXJuIGNhbnZhcy5jcmVhdGVDYW52YXMod2lkdGgsIGhlaWdodCk7CiAgfQp9Owp2YXIgTm9kZUNNYXBSZWFkZXJGYWN0b3J5ID0gY2xhc3MgZXh0ZW5kcyBCYXNlQ01hcFJlYWRlckZhY3RvcnkgewogIGFzeW5jIF9mZXRjaCh1cmwpIHsKICAgIHJldHVybiBub2RlX3V0aWxzX2ZldGNoRGF0YSh1cmwpOwogIH0KfTsKdmFyIE5vZGVTdGFuZGFyZEZvbnREYXRhRmFjdG9yeSA9IGNsYXNzIGV4dGVuZHMgQmFzZVN0YW5kYXJkRm9udERhdGFGYWN0b3J5IHsKICBhc3luYyBfZmV0Y2godXJsKSB7CiAgICByZXR1cm4gbm9kZV91dGlsc19mZXRjaERhdGEodXJsKTsKICB9Cn07CnZhciBOb2RlV2FzbUZhY3RvcnkgPSBjbGFzcyBleHRlbmRzIEJhc2VXYXNtRmFjdG9yeSB7CiAgYXN5bmMgX2ZldGNoKHVybCkgewogICAgcmV0dXJuIG5vZGVfdXRpbHNfZmV0Y2hEYXRhKHVybCk7CiAgfQp9Owp2YXIgRk9SQ0VEX0RFUEVOREVOQ1lfTEFCRUwgPSAiX19mb3JjZWREZXBlbmRlbmN5IjsKdmFyIHsKICBmbG9vciwKICBjZWlsCn0gPSBNYXRoOwpmdW5jdGlvbiBleHBhbmRCQm94KGFycmF5LCBpbmRleCwgbWluWCwgbWluWSwgbWF4WCwgbWF4WSkgewogIGFycmF5W2luZGV4ICogNCArIDBdID0gTWF0aC5taW4oYXJyYXlbaW5kZXggKiA0ICsgMF0sIG1pblgpOwogIGFycmF5W2luZGV4ICogNCArIDFdID0gTWF0aC5taW4oYXJyYXlbaW5kZXggKiA0ICsgMV0sIG1pblkpOwogIGFycmF5W2luZGV4ICogNCArIDJdID0gTWF0aC5tYXgoYXJyYXlbaW5kZXggKiA0ICsgMl0sIG1heFgpOwogIGFycmF5W2luZGV4ICogNCArIDNdID0gTWF0aC5tYXgoYXJyYXlbaW5kZXggKiA0ICsgM10sIG1heFkpOwp9CnZhciBFTVBUWV9CQk9YID0gbmV3IFVpbnQzMkFycmF5KG5ldyBVaW50OEFycmF5KFsyNTUsIDI1NSwgMCwgMF0pLmJ1ZmZlcilbMF07CnZhciBCQm94UmVhZGVyID0gY2xhc3MgewogICNiYm94ZXM7CiAgI2Nvb3JkczsKICBjb25zdHJ1Y3RvcihiYm94ZXMsIGNvb3JkcykgewogICAgdGhpcy4jYmJveGVzID0gYmJveGVzOwogICAgdGhpcy4jY29vcmRzID0gY29vcmRzOwogIH0KICBnZXQgbGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuI2Jib3hlcy5sZW5ndGg7CiAgfQogIGlzRW1wdHkoaSkgewogICAgcmV0dXJuIHRoaXMuI2Jib3hlc1tpXSA9PT0gRU1QVFlfQkJPWDsKICB9CiAgbWluWChpKSB7CiAgICByZXR1cm4gdGhpcy4jY29vcmRzW2kgKiA0ICsgMF0gLyAyNTY7CiAgfQogIG1pblkoaSkgewogICAgcmV0dXJuIHRoaXMuI2Nvb3Jkc1tpICogNCArIDFdIC8gMjU2OwogIH0KICBtYXhYKGkpIHsKICAgIHJldHVybiAodGhpcy4jY29vcmRzW2kgKiA0ICsgMl0gKyAxKSAvIDI1NjsKICB9CiAgbWF4WShpKSB7CiAgICByZXR1cm4gKHRoaXMuI2Nvb3Jkc1tpICogNCArIDNdICsgMSkgLyAyNTY7CiAgfQp9Owp2YXIgZW5zdXJlRGVidWdNZXRhZGF0YSA9IChtYXAsIGtleSkgPT4gewogIGlmICghbWFwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBsZXQgdmFsdWUgPSBtYXAuZ2V0KGtleSk7CiAgaWYgKCF2YWx1ZSkgewogICAgdmFsdWUgPSB7CiAgICAgIGRlcGVuZGVuY2llczogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICAgICAgaXNSZW5kZXJpbmdPcGVyYXRpb246IGZhbHNlCiAgICB9OwogICAgbWFwLnNldChrZXksIHZhbHVlKTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgQ2FudmFzRGVwZW5kZW5jeVRyYWNrZXIgPSBjbGFzcyB7CiAgI3NpbXBsZSA9IHsKICAgIF9fcHJvdG9fXzogbnVsbAogIH07CiAgI2luY3JlbWVudGFsID0gewogICAgX19wcm90b19fOiBudWxsLAogICAgdHJhbnNmb3JtOiBbXSwKICAgIG1vdmVUZXh0OiBbXSwKICAgIHNhbWVMaW5lVGV4dDogW10sCiAgICBbRk9SQ0VEX0RFUEVOREVOQ1lfTEFCRUxdOiBbXQogIH07CiAgI25hbWVkRGVwZW5kZW5jaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjc2F2ZXNTdGFjayA9IFtdOwogICNtYXJrZWRDb250ZW50U3RhY2sgPSBbXTsKICAjYmFzZVRyYW5zZm9ybVN0YWNrID0gW1sxLCAwLCAwLCAxLCAwLCAwXV07CiAgI2NsaXBCb3ggPSBbLUluZmluaXR5LCAtSW5maW5pdHksIEluZmluaXR5LCBJbmZpbml0eV07CiAgI3BlbmRpbmdCQm94ID0gbmV3IEZsb2F0NjRBcnJheShbSW5maW5pdHksIEluZmluaXR5LCAtSW5maW5pdHksIC1JbmZpbml0eV0pOwogICNwZW5kaW5nQkJveElkeCA9IC0xOwogICNwZW5kaW5nRGVwZW5kZW5jaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAjb3BlcmF0aW9ucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI2ZvbnRCQm94VHJ1c3R3b3J0aHkgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNjYW52YXNXaWR0aDsKICAjY2FudmFzSGVpZ2h0OwogICNiYm94ZXNDb29yZHM7CiAgI2Jib3hlczsKICAjZGVidWdNZXRhZGF0YTsKICBjb25zdHJ1Y3RvcihjYW52YXMsIG9wZXJhdGlvbnNDb3VudCwgcmVjb3JkRGVidWdNZXRhZGF0YSA9IGZhbHNlKSB7CiAgICB0aGlzLiNjYW52YXNXaWR0aCA9IGNhbnZhcy53aWR0aDsKICAgIHRoaXMuI2NhbnZhc0hlaWdodCA9IGNhbnZhcy5oZWlnaHQ7CiAgICB0aGlzLiNpbml0aWFsaXplQkJveGVzKG9wZXJhdGlvbnNDb3VudCk7CiAgICBpZiAocmVjb3JkRGVidWdNZXRhZGF0YSkgewogICAgICB0aGlzLiNkZWJ1Z01ldGFkYXRhID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIH0KICB9CiAgZ3Jvd09wZXJhdGlvbnNDb3VudChvcGVyYXRpb25zQ291bnQpIHsKICAgIGlmIChvcGVyYXRpb25zQ291bnQgPj0gdGhpcy4jYmJveGVzLmxlbmd0aCkgewogICAgICB0aGlzLiNpbml0aWFsaXplQkJveGVzKG9wZXJhdGlvbnNDb3VudCwgdGhpcy4jYmJveGVzKTsKICAgIH0KICB9CiAgI2luaXRpYWxpemVCQm94ZXMob3BlcmF0aW9uc0NvdW50LCBvbGRCQm94ZXMpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihvcGVyYXRpb25zQ291bnQgKiA0KTsKICAgIHRoaXMuI2Jib3hlc0Nvb3JkcyA9IG5ldyBVaW50OENsYW1wZWRBcnJheShidWZmZXIpOwogICAgdGhpcy4jYmJveGVzID0gbmV3IFVpbnQzMkFycmF5KGJ1ZmZlcik7CiAgICBpZiAob2xkQkJveGVzICYmIG9sZEJCb3hlcy5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuI2Jib3hlcy5zZXQob2xkQkJveGVzKTsKICAgICAgdGhpcy4jYmJveGVzLmZpbGwoRU1QVFlfQkJPWCwgb2xkQkJveGVzLmxlbmd0aCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNiYm94ZXMuZmlsbChFTVBUWV9CQk9YKTsKICAgIH0KICB9CiAgc2F2ZShvcElkeCkgewogICAgdGhpcy4jc2ltcGxlID0gewogICAgICBfX3Byb3RvX186IHRoaXMuI3NpbXBsZQogICAgfTsKICAgIHRoaXMuI2luY3JlbWVudGFsID0gewogICAgICBfX3Byb3RvX186IHRoaXMuI2luY3JlbWVudGFsLAogICAgICB0cmFuc2Zvcm06IHsKICAgICAgICBfX3Byb3RvX186IHRoaXMuI2luY3JlbWVudGFsLnRyYW5zZm9ybQogICAgICB9LAogICAgICBtb3ZlVGV4dDogewogICAgICAgIF9fcHJvdG9fXzogdGhpcy4jaW5jcmVtZW50YWwubW92ZVRleHQKICAgICAgfSwKICAgICAgc2FtZUxpbmVUZXh0OiB7CiAgICAgICAgX19wcm90b19fOiB0aGlzLiNpbmNyZW1lbnRhbC5zYW1lTGluZVRleHQKICAgICAgfSwKICAgICAgW0ZPUkNFRF9ERVBFTkRFTkNZX0xBQkVMXTogewogICAgICAgIF9fcHJvdG9fXzogdGhpcy4jaW5jcmVtZW50YWxbRk9SQ0VEX0RFUEVOREVOQ1lfTEFCRUxdCiAgICAgIH0KICAgIH07CiAgICB0aGlzLiNjbGlwQm94ID0gewogICAgICBfX3Byb3RvX186IHRoaXMuI2NsaXBCb3gKICAgIH07CiAgICB0aGlzLiNzYXZlc1N0YWNrLnB1c2gob3BJZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlc3RvcmUob3BJZHgpIHsKICAgIGNvbnN0IHByZXZpb3VzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMuI3NpbXBsZSk7CiAgICBpZiAocHJldmlvdXMgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICB0aGlzLiNzaW1wbGUgPSBwcmV2aW91czsKICAgIHRoaXMuI2luY3JlbWVudGFsID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMuI2luY3JlbWVudGFsKTsKICAgIHRoaXMuI2NsaXBCb3ggPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcy4jY2xpcEJveCk7CiAgICBjb25zdCBsYXN0U2F2ZSA9IHRoaXMuI3NhdmVzU3RhY2sucG9wKCk7CiAgICBpZiAobGFzdFNhdmUgIT09IHZvaWQgMCkgewogICAgICBlbnN1cmVEZWJ1Z01ldGFkYXRhKHRoaXMuI2RlYnVnTWV0YWRhdGEsIG9wSWR4KT8uZGVwZW5kZW5jaWVzLmFkZChsYXN0U2F2ZSk7CiAgICAgIHRoaXMuI2Jib3hlc1tvcElkeF0gPSB0aGlzLiNiYm94ZXNbbGFzdFNhdmVdOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZE9wZW5NYXJrZXIoaWR4KSB7CiAgICB0aGlzLiNzYXZlc1N0YWNrLnB1c2goaWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBnZXRPcGVuTWFya2VyKCkgewogICAgaWYgKHRoaXMuI3NhdmVzU3RhY2subGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIHRoaXMuI3NhdmVzU3RhY2suYXQoLTEpOwogIH0KICByZWNvcmRDbG9zZU1hcmtlcihvcElkeCkgewogICAgY29uc3QgbGFzdFNhdmUgPSB0aGlzLiNzYXZlc1N0YWNrLnBvcCgpOwogICAgaWYgKGxhc3RTYXZlICE9PSB2b2lkIDApIHsKICAgICAgZW5zdXJlRGVidWdNZXRhZGF0YSh0aGlzLiNkZWJ1Z01ldGFkYXRhLCBvcElkeCk/LmRlcGVuZGVuY2llcy5hZGQobGFzdFNhdmUpOwogICAgICB0aGlzLiNiYm94ZXNbb3BJZHhdID0gdGhpcy4jYmJveGVzW2xhc3RTYXZlXTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBiZWdpbk1hcmtlZENvbnRlbnQob3BJZHgpIHsKICAgIHRoaXMuI21hcmtlZENvbnRlbnRTdGFjay5wdXNoKG9wSWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBlbmRNYXJrZWRDb250ZW50KG9wSWR4KSB7CiAgICBjb25zdCBsYXN0U2F2ZSA9IHRoaXMuI21hcmtlZENvbnRlbnRTdGFjay5wb3AoKTsKICAgIGlmIChsYXN0U2F2ZSAhPT0gdm9pZCAwKSB7CiAgICAgIGVuc3VyZURlYnVnTWV0YWRhdGEodGhpcy4jZGVidWdNZXRhZGF0YSwgb3BJZHgpPy5kZXBlbmRlbmNpZXMuYWRkKGxhc3RTYXZlKTsKICAgICAgdGhpcy4jYmJveGVzW29wSWR4XSA9IHRoaXMuI2Jib3hlc1tsYXN0U2F2ZV07CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcHVzaEJhc2VUcmFuc2Zvcm0oY3R4KSB7CiAgICB0aGlzLiNiYXNlVHJhbnNmb3JtU3RhY2sucHVzaChVdGlsLm11bHRpcGx5QnlET01NYXRyaXgodGhpcy4jYmFzZVRyYW5zZm9ybVN0YWNrLmF0KC0xKSwgY3R4LmdldFRyYW5zZm9ybSgpKSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcG9wQmFzZVRyYW5zZm9ybSgpIHsKICAgIGlmICh0aGlzLiNiYXNlVHJhbnNmb3JtU3RhY2subGVuZ3RoID4gMSkgewogICAgICB0aGlzLiNiYXNlVHJhbnNmb3JtU3RhY2sucG9wKCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkU2ltcGxlRGF0YShuYW1lLCBpZHgpIHsKICAgIHRoaXMuI3NpbXBsZVtuYW1lXSA9IGlkeDsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRJbmNyZW1lbnRhbERhdGEobmFtZSwgaWR4KSB7CiAgICB0aGlzLiNpbmNyZW1lbnRhbFtuYW1lXS5wdXNoKGlkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVzZXRJbmNyZW1lbnRhbERhdGEobmFtZSwgaWR4KSB7CiAgICB0aGlzLiNpbmNyZW1lbnRhbFtuYW1lXS5sZW5ndGggPSAwOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZE5hbWVkRGF0YShuYW1lLCBpZHgpIHsKICAgIHRoaXMuI25hbWVkRGVwZW5kZW5jaWVzLnNldChuYW1lLCBpZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZFNpbXBsZURhdGFGcm9tTmFtZWQobmFtZSwgZGVwTmFtZSwgZmFsbGJhY2tJZHgpIHsKICAgIHRoaXMuI3NpbXBsZVtuYW1lXSA9IHRoaXMuI25hbWVkRGVwZW5kZW5jaWVzLmdldChkZXBOYW1lKSA/PyBmYWxsYmFja0lkeDsKICB9CiAgcmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeShuYW1lLCBpZHgpIHsKICAgIHRoaXMucmVjb3JkSW5jcmVtZW50YWxEYXRhKEZPUkNFRF9ERVBFTkRFTkNZX0xBQkVMLCBpZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGluaGVyaXRTaW1wbGVEYXRhQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMobmFtZXMpIHsKICAgIGZvciAoY29uc3QgbmFtZSBvZiBuYW1lcykgewogICAgICBpZiAobmFtZSBpbiB0aGlzLiNzaW1wbGUpIHsKICAgICAgICB0aGlzLnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3kobmFtZSwgdGhpcy4jc2ltcGxlW25hbWVdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIGluaGVyaXRQZW5kaW5nRGVwZW5kZW5jaWVzQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMoKSB7CiAgICBmb3IgKGNvbnN0IGRlcCBvZiB0aGlzLiNwZW5kaW5nRGVwZW5kZW5jaWVzKSB7CiAgICAgIHRoaXMucmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeShGT1JDRURfREVQRU5ERU5DWV9MQUJFTCwgZGVwKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZXNldEJCb3goaWR4KSB7CiAgICBpZiAodGhpcy4jcGVuZGluZ0JCb3hJZHggIT09IGlkeCkgewogICAgICB0aGlzLiNwZW5kaW5nQkJveElkeCA9IGlkeDsKICAgICAgdGhpcy4jcGVuZGluZ0JCb3hbMF0gPSBJbmZpbml0eTsKICAgICAgdGhpcy4jcGVuZGluZ0JCb3hbMV0gPSBJbmZpbml0eTsKICAgICAgdGhpcy4jcGVuZGluZ0JCb3hbMl0gPSAtSW5maW5pdHk7CiAgICAgIHRoaXMuI3BlbmRpbmdCQm94WzNdID0gLUluZmluaXR5OwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZENsaXBCb3goaWR4LCBjdHgsIG1pblgsIG1heFgsIG1pblksIG1heFkpIHsKICAgIGNvbnN0IHRyYW5zZm9ybSA9IFV0aWwubXVsdGlwbHlCeURPTU1hdHJpeCh0aGlzLiNiYXNlVHJhbnNmb3JtU3RhY2suYXQoLTEpLCBjdHguZ2V0VHJhbnNmb3JtKCkpOwogICAgY29uc3QgY2xpcEJveCA9IFtJbmZpbml0eSwgSW5maW5pdHksIC1JbmZpbml0eSwgLUluZmluaXR5XTsKICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goW21pblgsIG1pblksIG1heFgsIG1heFldLCB0cmFuc2Zvcm0sIGNsaXBCb3gpOwogICAgY29uc3QgaW50ZXJzZWN0aW9uID0gVXRpbC5pbnRlcnNlY3QodGhpcy4jY2xpcEJveCwgY2xpcEJveCk7CiAgICBpZiAoaW50ZXJzZWN0aW9uKSB7CiAgICAgIHRoaXMuI2NsaXBCb3hbMF0gPSBpbnRlcnNlY3Rpb25bMF07CiAgICAgIHRoaXMuI2NsaXBCb3hbMV0gPSBpbnRlcnNlY3Rpb25bMV07CiAgICAgIHRoaXMuI2NsaXBCb3hbMl0gPSBpbnRlcnNlY3Rpb25bMl07CiAgICAgIHRoaXMuI2NsaXBCb3hbM10gPSBpbnRlcnNlY3Rpb25bM107CiAgICB9IGVsc2UgewogICAgICB0aGlzLiNjbGlwQm94WzBdID0gdGhpcy4jY2xpcEJveFsxXSA9IEluZmluaXR5OwogICAgICB0aGlzLiNjbGlwQm94WzJdID0gdGhpcy4jY2xpcEJveFszXSA9IC1JbmZpbml0eTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRCQm94KGlkeCwgY3R4LCBtaW5YLCBtYXhYLCBtaW5ZLCBtYXhZKSB7CiAgICBjb25zdCBjbGlwQm94ID0gdGhpcy4jY2xpcEJveDsKICAgIGlmIChjbGlwQm94WzBdID09PSBJbmZpbml0eSkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNvbnN0IHRyYW5zZm9ybSA9IFV0aWwubXVsdGlwbHlCeURPTU1hdHJpeCh0aGlzLiNiYXNlVHJhbnNmb3JtU3RhY2suYXQoLTEpLCBjdHguZ2V0VHJhbnNmb3JtKCkpOwogICAgaWYgKGNsaXBCb3hbMF0gPT09IC1JbmZpbml0eSkgewogICAgICBVdGlsLmF4aWFsQWxpZ25lZEJvdW5kaW5nQm94KFttaW5YLCBtaW5ZLCBtYXhYLCBtYXhZXSwgdHJhbnNmb3JtLCB0aGlzLiNwZW5kaW5nQkJveCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY29uc3QgYmJveCA9IFtJbmZpbml0eSwgSW5maW5pdHksIC1JbmZpbml0eSwgLUluZmluaXR5XTsKICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goW21pblgsIG1pblksIG1heFgsIG1heFldLCB0cmFuc2Zvcm0sIGJib3gpOwogICAgdGhpcy4jcGVuZGluZ0JCb3hbMF0gPSBNYXRoLm1pbih0aGlzLiNwZW5kaW5nQkJveFswXSwgTWF0aC5tYXgoYmJveFswXSwgY2xpcEJveFswXSkpOwogICAgdGhpcy4jcGVuZGluZ0JCb3hbMV0gPSBNYXRoLm1pbih0aGlzLiNwZW5kaW5nQkJveFsxXSwgTWF0aC5tYXgoYmJveFsxXSwgY2xpcEJveFsxXSkpOwogICAgdGhpcy4jcGVuZGluZ0JCb3hbMl0gPSBNYXRoLm1heCh0aGlzLiNwZW5kaW5nQkJveFsyXSwgTWF0aC5taW4oYmJveFsyXSwgY2xpcEJveFsyXSkpOwogICAgdGhpcy4jcGVuZGluZ0JCb3hbM10gPSBNYXRoLm1heCh0aGlzLiNwZW5kaW5nQkJveFszXSwgTWF0aC5taW4oYmJveFszXSwgY2xpcEJveFszXSkpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZENoYXJhY3RlckJCb3goaWR4LCBjdHgsIGZvbnQsIHNjYWxlID0gMSwgeCA9IDAsIHkgPSAwLCBnZXRNZWFzdXJlKSB7CiAgICBjb25zdCBmb250QkJveCA9IGZvbnQuYmJveDsKICAgIGxldCBpc0JCb3hUcnVzdHdvcnRoeTsKICAgIGxldCBjb21wdXRlZEJCb3g7CiAgICBpZiAoZm9udEJCb3gpIHsKICAgICAgaXNCQm94VHJ1c3R3b3J0aHkgPSBmb250QkJveFsyXSAhPT0gZm9udEJCb3hbMF0gJiYgZm9udEJCb3hbM10gIT09IGZvbnRCQm94WzFdICYmIHRoaXMuI2ZvbnRCQm94VHJ1c3R3b3J0aHkuZ2V0KGZvbnQpOwogICAgICBpZiAoaXNCQm94VHJ1c3R3b3J0aHkgIT09IGZhbHNlKSB7CiAgICAgICAgY29tcHV0ZWRCQm94ID0gWzAsIDAsIDAsIDBdOwogICAgICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goZm9udEJCb3gsIGZvbnQuZm9udE1hdHJpeCwgY29tcHV0ZWRCQm94KTsKICAgICAgICBpZiAoc2NhbGUgIT09IDEgfHwgeCAhPT0gMCB8fCB5ICE9PSAwKSB7CiAgICAgICAgICBVdGlsLnNjYWxlTWluTWF4KFtzY2FsZSwgMCwgMCwgLXNjYWxlLCB4LCB5XSwgY29tcHV0ZWRCQm94KTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQkJveFRydXN0d29ydGh5KSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5yZWNvcmRCQm94KGlkeCwgY3R4LCBjb21wdXRlZEJCb3hbMF0sIGNvbXB1dGVkQkJveFsyXSwgY29tcHV0ZWRCQm94WzFdLCBjb21wdXRlZEJCb3hbM10pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKCFnZXRNZWFzdXJlKSB7CiAgICAgIHJldHVybiB0aGlzLnJlY29yZEZ1bGxQYWdlQkJveChpZHgpOwogICAgfQogICAgY29uc3QgbWVhc3VyZSA9IGdldE1lYXN1cmUoKTsKICAgIGlmIChmb250QkJveCAmJiBjb21wdXRlZEJCb3ggJiYgaXNCQm94VHJ1c3R3b3J0aHkgPT09IHZvaWQgMCkgewogICAgICBpc0JCb3hUcnVzdHdvcnRoeSA9IGNvbXB1dGVkQkJveFswXSA8PSB4IC0gbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveExlZnQgJiYgY29tcHV0ZWRCQm94WzJdID49IHggKyBtZWFzdXJlLmFjdHVhbEJvdW5kaW5nQm94UmlnaHQgJiYgY29tcHV0ZWRCQm94WzFdIDw9IHkgLSBtZWFzdXJlLmFjdHVhbEJvdW5kaW5nQm94QXNjZW50ICYmIGNvbXB1dGVkQkJveFszXSA+PSB5ICsgbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveERlc2NlbnQ7CiAgICAgIHRoaXMuI2ZvbnRCQm94VHJ1c3R3b3J0aHkuc2V0KGZvbnQsIGlzQkJveFRydXN0d29ydGh5KTsKICAgICAgaWYgKGlzQkJveFRydXN0d29ydGh5KSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmVjb3JkQkJveChpZHgsIGN0eCwgY29tcHV0ZWRCQm94WzBdLCBjb21wdXRlZEJCb3hbMl0sIGNvbXB1dGVkQkJveFsxXSwgY29tcHV0ZWRCQm94WzNdKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXMucmVjb3JkQkJveChpZHgsIGN0eCwgeCAtIG1lYXN1cmUuYWN0dWFsQm91bmRpbmdCb3hMZWZ0LCB4ICsgbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveFJpZ2h0LCB5IC0gbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveEFzY2VudCwgeSArIG1lYXN1cmUuYWN0dWFsQm91bmRpbmdCb3hEZXNjZW50KTsKICB9CiAgcmVjb3JkRnVsbFBhZ2VCQm94KGlkeCkgewogICAgdGhpcy4jcGVuZGluZ0JCb3hbMF0gPSBNYXRoLm1heCgwLCB0aGlzLiNjbGlwQm94WzBdKTsKICAgIHRoaXMuI3BlbmRpbmdCQm94WzFdID0gTWF0aC5tYXgoMCwgdGhpcy4jY2xpcEJveFsxXSk7CiAgICB0aGlzLiNwZW5kaW5nQkJveFsyXSA9IE1hdGgubWluKHRoaXMuI2NhbnZhc1dpZHRoLCB0aGlzLiNjbGlwQm94WzJdKTsKICAgIHRoaXMuI3BlbmRpbmdCQm94WzNdID0gTWF0aC5taW4odGhpcy4jY2FudmFzSGVpZ2h0LCB0aGlzLiNjbGlwQm94WzNdKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBnZXRTaW1wbGVJbmRleChkZXBlbmRlbmN5TmFtZSkgewogICAgcmV0dXJuIHRoaXMuI3NpbXBsZVtkZXBlbmRlbmN5TmFtZV07CiAgfQogIHJlY29yZERlcGVuZGVuY2llcyhpZHgsIGRlcGVuZGVuY3lOYW1lcykgewogICAgY29uc3QgcGVuZGluZ0RlcGVuZGVuY2llcyA9IHRoaXMuI3BlbmRpbmdEZXBlbmRlbmNpZXM7CiAgICBjb25zdCBzaW1wbGUgPSB0aGlzLiNzaW1wbGU7CiAgICBjb25zdCBpbmNyZW1lbnRhbCA9IHRoaXMuI2luY3JlbWVudGFsOwogICAgZm9yIChjb25zdCBuYW1lIG9mIGRlcGVuZGVuY3lOYW1lcykgewogICAgICBpZiAobmFtZSBpbiB0aGlzLiNzaW1wbGUpIHsKICAgICAgICBwZW5kaW5nRGVwZW5kZW5jaWVzLmFkZChzaW1wbGVbbmFtZV0pOwogICAgICB9IGVsc2UgaWYgKG5hbWUgaW4gaW5jcmVtZW50YWwpIHsKICAgICAgICBpbmNyZW1lbnRhbFtuYW1lXS5mb3JFYWNoKHBlbmRpbmdEZXBlbmRlbmNpZXMuYWRkLCBwZW5kaW5nRGVwZW5kZW5jaWVzKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZE5hbWVkRGVwZW5kZW5jeShpZHgsIG5hbWUpIHsKICAgIGlmICh0aGlzLiNuYW1lZERlcGVuZGVuY2llcy5oYXMobmFtZSkpIHsKICAgICAgdGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llcy5hZGQodGhpcy4jbmFtZWREZXBlbmRlbmNpZXMuZ2V0KG5hbWUpKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRPcGVyYXRpb24oaWR4LCBwcmVzZXJ2ZSA9IGZhbHNlKSB7CiAgICB0aGlzLnJlY29yZERlcGVuZGVuY2llcyhpZHgsIFtGT1JDRURfREVQRU5ERU5DWV9MQUJFTF0pOwogICAgaWYgKHRoaXMuI2RlYnVnTWV0YWRhdGEpIHsKICAgICAgY29uc3QgbWV0YWRhdGEgPSBlbnN1cmVEZWJ1Z01ldGFkYXRhKHRoaXMuI2RlYnVnTWV0YWRhdGEsIGlkeCk7CiAgICAgIGNvbnN0IHsKICAgICAgICBkZXBlbmRlbmNpZXMKICAgICAgfSA9IG1ldGFkYXRhOwogICAgICB0aGlzLiNwZW5kaW5nRGVwZW5kZW5jaWVzLmZvckVhY2goZGVwZW5kZW5jaWVzLmFkZCwgZGVwZW5kZW5jaWVzKTsKICAgICAgdGhpcy4jc2F2ZXNTdGFjay5mb3JFYWNoKGRlcGVuZGVuY2llcy5hZGQsIGRlcGVuZGVuY2llcyk7CiAgICAgIHRoaXMuI21hcmtlZENvbnRlbnRTdGFjay5mb3JFYWNoKGRlcGVuZGVuY2llcy5hZGQsIGRlcGVuZGVuY2llcyk7CiAgICAgIGRlcGVuZGVuY2llcy5kZWxldGUoaWR4KTsKICAgICAgbWV0YWRhdGEuaXNSZW5kZXJpbmdPcGVyYXRpb24gPSB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuI3BlbmRpbmdCQm94SWR4ID09PSBpZHgpIHsKICAgICAgY29uc3QgbWluWCA9IGZsb29yKHRoaXMuI3BlbmRpbmdCQm94WzBdICogMjU2IC8gdGhpcy4jY2FudmFzV2lkdGgpOwogICAgICBjb25zdCBtaW5ZID0gZmxvb3IodGhpcy4jcGVuZGluZ0JCb3hbMV0gKiAyNTYgLyB0aGlzLiNjYW52YXNIZWlnaHQpOwogICAgICBjb25zdCBtYXhYID0gY2VpbCh0aGlzLiNwZW5kaW5nQkJveFsyXSAqIDI1NiAvIHRoaXMuI2NhbnZhc1dpZHRoKTsKICAgICAgY29uc3QgbWF4WSA9IGNlaWwodGhpcy4jcGVuZGluZ0JCb3hbM10gKiAyNTYgLyB0aGlzLiNjYW52YXNIZWlnaHQpOwogICAgICBleHBhbmRCQm94KHRoaXMuI2Jib3hlc0Nvb3JkcywgaWR4LCBtaW5YLCBtaW5ZLCBtYXhYLCBtYXhZKTsKICAgICAgZm9yIChjb25zdCBkZXBJZHggb2YgdGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llcykgewogICAgICAgIGlmIChkZXBJZHggIT09IGlkeCkgewogICAgICAgICAgZXhwYW5kQkJveCh0aGlzLiNiYm94ZXNDb29yZHMsIGRlcElkeCwgbWluWCwgbWluWSwgbWF4WCwgbWF4WSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoY29uc3Qgc2F2ZUlkeCBvZiB0aGlzLiNzYXZlc1N0YWNrKSB7CiAgICAgICAgaWYgKHNhdmVJZHggIT09IGlkeCkgewogICAgICAgICAgZXhwYW5kQkJveCh0aGlzLiNiYm94ZXNDb29yZHMsIHNhdmVJZHgsIG1pblgsIG1pblksIG1heFgsIG1heFkpOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKGNvbnN0IHNhdmVJZHggb2YgdGhpcy4jbWFya2VkQ29udGVudFN0YWNrKSB7CiAgICAgICAgaWYgKHNhdmVJZHggIT09IGlkeCkgewogICAgICAgICAgZXhwYW5kQkJveCh0aGlzLiNiYm94ZXNDb29yZHMsIHNhdmVJZHgsIG1pblgsIG1pblksIG1heFgsIG1heFkpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgdGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llcy5jbGVhcigpOwogICAgICAgIHRoaXMuI3BlbmRpbmdCQm94SWR4ID0gLTE7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRTaG93VGV4dE9wZXJhdGlvbihpZHgsIHByZXNlcnZlID0gZmFsc2UpIHsKICAgIGNvbnN0IGRlcHMgPSBBcnJheS5mcm9tKHRoaXMuI3BlbmRpbmdEZXBlbmRlbmNpZXMpOwogICAgdGhpcy5yZWNvcmRPcGVyYXRpb24oaWR4LCBwcmVzZXJ2ZSk7CiAgICB0aGlzLnJlY29yZEluY3JlbWVudGFsRGF0YSgic2FtZUxpbmVUZXh0IiwgaWR4KTsKICAgIGZvciAoY29uc3QgZGVwIG9mIGRlcHMpIHsKICAgICAgdGhpcy5yZWNvcmRJbmNyZW1lbnRhbERhdGEoInNhbWVMaW5lVGV4dCIsIGRlcCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgYmJveFRvQ2xpcEJveERyb3BPcGVyYXRpb24oaWR4LCBwcmVzZXJ2ZSA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy4jcGVuZGluZ0JCb3hJZHggPT09IGlkeCkgewogICAgICB0aGlzLiNwZW5kaW5nQkJveElkeCA9IC0xOwogICAgICB0aGlzLiNjbGlwQm94WzBdID0gTWF0aC5tYXgodGhpcy4jY2xpcEJveFswXSwgdGhpcy4jcGVuZGluZ0JCb3hbMF0pOwogICAgICB0aGlzLiNjbGlwQm94WzFdID0gTWF0aC5tYXgodGhpcy4jY2xpcEJveFsxXSwgdGhpcy4jcGVuZGluZ0JCb3hbMV0pOwogICAgICB0aGlzLiNjbGlwQm94WzJdID0gTWF0aC5taW4odGhpcy4jY2xpcEJveFsyXSwgdGhpcy4jcGVuZGluZ0JCb3hbMl0pOwogICAgICB0aGlzLiNjbGlwQm94WzNdID0gTWF0aC5taW4odGhpcy4jY2xpcEJveFszXSwgdGhpcy4jcGVuZGluZ0JCb3hbM10pOwogICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgdGhpcy4jcGVuZGluZ0RlcGVuZGVuY2llcy5jbGVhcigpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgX3Rha2VQZW5kaW5nRGVwZW5kZW5jaWVzKCkgewogICAgY29uc3QgcGVuZGluZ0RlcGVuZGVuY2llcyA9IHRoaXMuI3BlbmRpbmdEZXBlbmRlbmNpZXM7CiAgICB0aGlzLiNwZW5kaW5nRGVwZW5kZW5jaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIHJldHVybiBwZW5kaW5nRGVwZW5kZW5jaWVzOwogIH0KICBfZXh0cmFjdE9wZXJhdGlvbihpZHgpIHsKICAgIGNvbnN0IG9wZXJhdGlvbiA9IHRoaXMuI29wZXJhdGlvbnMuZ2V0KGlkeCk7CiAgICB0aGlzLiNvcGVyYXRpb25zLmRlbGV0ZShpZHgpOwogICAgcmV0dXJuIG9wZXJhdGlvbjsKICB9CiAgX3B1c2hQZW5kaW5nRGVwZW5kZW5jaWVzKGRlcGVuZGVuY2llcykgewogICAgZm9yIChjb25zdCBkZXAgb2YgZGVwZW5kZW5jaWVzKSB7CiAgICAgIHRoaXMuI3BlbmRpbmdEZXBlbmRlbmNpZXMuYWRkKGRlcCk7CiAgICB9CiAgfQogIHRha2UoKSB7CiAgICB0aGlzLiNmb250QkJveFRydXN0d29ydGh5LmNsZWFyKCk7CiAgICByZXR1cm4gbmV3IEJCb3hSZWFkZXIodGhpcy4jYmJveGVzLCB0aGlzLiNiYm94ZXNDb29yZHMpOwogIH0KICB0YWtlRGVidWdNZXRhZGF0YSgpIHsKICAgIHJldHVybiB0aGlzLiNkZWJ1Z01ldGFkYXRhOwogIH0KfTsKdmFyIENhbnZhc05lc3RlZERlcGVuZGVuY3lUcmFja2VyID0gY2xhc3MgX0NhbnZhc05lc3RlZERlcGVuZGVuY3lUcmFja2VyIHsKICAjZGVwZW5kZW5jeVRyYWNrZXI7CiAgI29wSWR4OwogICNpZ25vcmVCQm94ZXM7CiAgI25lc3RpbmdMZXZlbCA9IDA7CiAgI3NhdmVzTGV2ZWwgPSAwOwogIGNvbnN0cnVjdG9yKGRlcGVuZGVuY3lUcmFja2VyLCBvcElkeCwgaWdub3JlQkJveGVzKSB7CiAgICBpZiAoZGVwZW5kZW5jeVRyYWNrZXIgaW5zdGFuY2VvZiBfQ2FudmFzTmVzdGVkRGVwZW5kZW5jeVRyYWNrZXIgJiYgZGVwZW5kZW5jeVRyYWNrZXIuI2lnbm9yZUJCb3hlcyA9PT0gISFpZ25vcmVCQm94ZXMpIHsKICAgICAgcmV0dXJuIGRlcGVuZGVuY3lUcmFja2VyOwogICAgfQogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIgPSBkZXBlbmRlbmN5VHJhY2tlcjsKICAgIHRoaXMuI29wSWR4ID0gb3BJZHg7CiAgICB0aGlzLiNpZ25vcmVCQm94ZXMgPSAhIWlnbm9yZUJCb3hlczsKICB9CiAgZ3Jvd09wZXJhdGlvbnNDb3VudCgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiVW5yZWFjaGFibGUiKTsKICB9CiAgc2F2ZShvcElkeCkgewogICAgdGhpcy4jc2F2ZXNMZXZlbCsrOwogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIuc2F2ZSh0aGlzLiNvcElkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVzdG9yZShvcElkeCkgewogICAgaWYgKHRoaXMuI3NhdmVzTGV2ZWwgPiAwKSB7CiAgICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlc3RvcmUodGhpcy4jb3BJZHgpOwogICAgICB0aGlzLiNzYXZlc0xldmVsLS07CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkT3Blbk1hcmtlcihpZHgpIHsKICAgIHRoaXMuI25lc3RpbmdMZXZlbCsrOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGdldE9wZW5NYXJrZXIoKSB7CiAgICByZXR1cm4gdGhpcy4jbmVzdGluZ0xldmVsID4gMCA/IHRoaXMuI29wSWR4IDogdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIuZ2V0T3Blbk1hcmtlcigpOwogIH0KICByZWNvcmRDbG9zZU1hcmtlcihpZHgpIHsKICAgIHRoaXMuI25lc3RpbmdMZXZlbC0tOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGJlZ2luTWFya2VkQ29udGVudChvcElkeCkgewogICAgcmV0dXJuIHRoaXM7CiAgfQogIGVuZE1hcmtlZENvbnRlbnQob3BJZHgpIHsKICAgIHJldHVybiB0aGlzOwogIH0KICBwdXNoQmFzZVRyYW5zZm9ybShjdHgpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnB1c2hCYXNlVHJhbnNmb3JtKGN0eCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcG9wQmFzZVRyYW5zZm9ybSgpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnBvcEJhc2VUcmFuc2Zvcm0oKTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRTaW1wbGVEYXRhKG5hbWUsIGlkeCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkU2ltcGxlRGF0YShuYW1lLCB0aGlzLiNvcElkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkSW5jcmVtZW50YWxEYXRhKG5hbWUsIGlkeCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkSW5jcmVtZW50YWxEYXRhKG5hbWUsIHRoaXMuI29wSWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZXNldEluY3JlbWVudGFsRGF0YShuYW1lLCBpZHgpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlc2V0SW5jcmVtZW50YWxEYXRhKG5hbWUsIHRoaXMuI29wSWR4KTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmROYW1lZERhdGEobmFtZSwgaWR4KSB7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkU2ltcGxlRGF0YUZyb21OYW1lZChuYW1lLCBkZXBOYW1lLCBmYWxsYmFja0lkeCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkU2ltcGxlRGF0YUZyb21OYW1lZChuYW1lLCBkZXBOYW1lLCB0aGlzLiNvcElkeCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkRnV0dXJlRm9yY2VkRGVwZW5kZW5jeShuYW1lLCBpZHgpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3kobmFtZSwgdGhpcy4jb3BJZHgpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGluaGVyaXRTaW1wbGVEYXRhQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMobmFtZXMpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLmluaGVyaXRTaW1wbGVEYXRhQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMobmFtZXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIGluaGVyaXRQZW5kaW5nRGVwZW5kZW5jaWVzQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMoKSB7CiAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5pbmhlcml0UGVuZGluZ0RlcGVuZGVuY2llc0FzRnV0dXJlRm9yY2VkRGVwZW5kZW5jaWVzKCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVzZXRCQm94KGlkeCkgewogICAgaWYgKCF0aGlzLiNpZ25vcmVCQm94ZXMpIHsKICAgICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVzZXRCQm94KHRoaXMuI29wSWR4KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRDbGlwQm94KGlkeCwgY3R4LCBtaW5YLCBtYXhYLCBtaW5ZLCBtYXhZKSB7CiAgICBpZiAoIXRoaXMuI2lnbm9yZUJCb3hlcykgewogICAgICB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5yZWNvcmRDbGlwQm94KHRoaXMuI29wSWR4LCBjdHgsIG1pblgsIG1heFgsIG1pblksIG1heFkpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZEJCb3goaWR4LCBjdHgsIG1pblgsIG1heFgsIG1pblksIG1heFkpIHsKICAgIGlmICghdGhpcy4jaWdub3JlQkJveGVzKSB7CiAgICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlY29yZEJCb3godGhpcy4jb3BJZHgsIGN0eCwgbWluWCwgbWF4WCwgbWluWSwgbWF4WSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkQ2hhcmFjdGVyQkJveChpZHgsIGN0eCwgZm9udCwgc2NhbGUsIHgsIHksIGdldE1lYXN1cmUpIHsKICAgIGlmICghdGhpcy4jaWdub3JlQkJveGVzKSB7CiAgICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlY29yZENoYXJhY3RlckJCb3godGhpcy4jb3BJZHgsIGN0eCwgZm9udCwgc2NhbGUsIHgsIHksIGdldE1lYXN1cmUpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZEZ1bGxQYWdlQkJveChpZHgpIHsKICAgIGlmICghdGhpcy4jaWdub3JlQkJveGVzKSB7CiAgICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlY29yZEZ1bGxQYWdlQkJveCh0aGlzLiNvcElkeCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgZ2V0U2ltcGxlSW5kZXgoZGVwZW5kZW5jeU5hbWUpIHsKICAgIHJldHVybiB0aGlzLiNkZXBlbmRlbmN5VHJhY2tlci5nZXRTaW1wbGVJbmRleChkZXBlbmRlbmN5TmFtZSk7CiAgfQogIHJlY29yZERlcGVuZGVuY2llcyhpZHgsIGRlcGVuZGVuY3lOYW1lcykgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkRGVwZW5kZW5jaWVzKHRoaXMuI29wSWR4LCBkZXBlbmRlbmN5TmFtZXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHJlY29yZE5hbWVkRGVwZW5kZW5jeShpZHgsIG5hbWUpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlY29yZE5hbWVkRGVwZW5kZW5jeSh0aGlzLiNvcElkeCwgbmFtZSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgcmVjb3JkT3BlcmF0aW9uKGlkeCkgewogICAgdGhpcy4jZGVwZW5kZW5jeVRyYWNrZXIucmVjb3JkT3BlcmF0aW9uKHRoaXMuI29wSWR4LCB0cnVlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICByZWNvcmRTaG93VGV4dE9wZXJhdGlvbihpZHgpIHsKICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLnJlY29yZFNob3dUZXh0T3BlcmF0aW9uKHRoaXMuI29wSWR4LCB0cnVlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICBiYm94VG9DbGlwQm94RHJvcE9wZXJhdGlvbihpZHgpIHsKICAgIGlmICghdGhpcy4jaWdub3JlQkJveGVzKSB7CiAgICAgIHRoaXMuI2RlcGVuZGVuY3lUcmFja2VyLmJib3hUb0NsaXBCb3hEcm9wT3BlcmF0aW9uKHRoaXMuI29wSWR4LCB0cnVlKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICB0YWtlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJVbnJlYWNoYWJsZSIpOwogIH0KICB0YWtlRGVidWdNZXRhZGF0YSgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiVW5yZWFjaGFibGUiKTsKICB9Cn07CnZhciBEZXBlbmRlbmNpZXMgPSB7CiAgc3Ryb2tlOiBbInBhdGgiLCAidHJhbnNmb3JtIiwgImZpbHRlciIsICJzdHJva2VDb2xvciIsICJzdHJva2VBbHBoYSIsICJsaW5lV2lkdGgiLCAibGluZUNhcCIsICJsaW5lSm9pbiIsICJtaXRlckxpbWl0IiwgImRhc2giXSwKICBmaWxsOiBbInBhdGgiLCAidHJhbnNmb3JtIiwgImZpbHRlciIsICJmaWxsQ29sb3IiLCAiZmlsbEFscGhhIiwgImdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiIsICJTTWFzayJdLAogIGltYWdlWE9iamVjdDogWyJ0cmFuc2Zvcm0iLCAiU01hc2siLCAiZmlsdGVyIiwgImZpbGxBbHBoYSIsICJzdHJva2VBbHBoYSIsICJnbG9iYWxDb21wb3NpdGVPcGVyYXRpb24iXSwKICByYXdGaWxsUGF0aDogWyJmaWx0ZXIiLCAiZmlsbENvbG9yIiwgImZpbGxBbHBoYSJdLAogIHNob3dUZXh0OiBbInRyYW5zZm9ybSIsICJsZWFkaW5nIiwgImNoYXJTcGFjaW5nIiwgIndvcmRTcGFjaW5nIiwgImhTY2FsZSIsICJ0ZXh0UmlzZSIsICJtb3ZlVGV4dCIsICJ0ZXh0TWF0cml4IiwgImZvbnQiLCAiZm9udE9iaiIsICJmaWx0ZXIiLCAiZmlsbENvbG9yIiwgInRleHRSZW5kZXJpbmdNb2RlIiwgIlNNYXNrIiwgImZpbGxBbHBoYSIsICJzdHJva2VBbHBoYSIsICJnbG9iYWxDb21wb3NpdGVPcGVyYXRpb24iLCAic2FtZUxpbmVUZXh0Il0sCiAgdHJhbnNmb3JtOiBbInRyYW5zZm9ybSJdLAogIHRyYW5zZm9ybUFuZEZpbGw6IFsidHJhbnNmb3JtIiwgImZpbGxDb2xvciJdCn07CnZhciBQYXRoVHlwZSA9IHsKICBGSUxMOiAiRmlsbCIsCiAgU1RST0tFOiAiU3Ryb2tlIiwKICBTSEFESU5HOiAiU2hhZGluZyIKfTsKZnVuY3Rpb24gYXBwbHlCb3VuZGluZ0JveChjdHgsIGJib3gpIHsKICBpZiAoIWJib3gpIHsKICAgIHJldHVybjsKICB9CiAgY29uc3Qgd2lkdGggPSBiYm94WzJdIC0gYmJveFswXTsKICBjb25zdCBoZWlnaHQgPSBiYm94WzNdIC0gYmJveFsxXTsKICBjb25zdCByZWdpb24gPSBuZXcgUGF0aDJEKCk7CiAgcmVnaW9uLnJlY3QoYmJveFswXSwgYmJveFsxXSwgd2lkdGgsIGhlaWdodCk7CiAgY3R4LmNsaXAocmVnaW9uKTsKfQp2YXIgQmFzZVNoYWRpbmdQYXR0ZXJuID0gY2xhc3MgewogIGlzTW9kaWZ5aW5nQ3VycmVudFRyYW5zZm9ybSgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZ2V0UGF0dGVybigpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgYGdldFBhdHRlcm5gIGNhbGxlZC4iKTsKICB9Cn07CnZhciBSYWRpYWxBeGlhbFNoYWRpbmdQYXR0ZXJuID0gY2xhc3MgZXh0ZW5kcyBCYXNlU2hhZGluZ1BhdHRlcm4gewogIGNvbnN0cnVjdG9yKElSKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy5fdHlwZSA9IElSWzFdOwogICAgdGhpcy5fYmJveCA9IElSWzJdOwogICAgdGhpcy5fY29sb3JTdG9wcyA9IElSWzNdOwogICAgdGhpcy5fcDAgPSBJUls0XTsKICAgIHRoaXMuX3AxID0gSVJbNV07CiAgICB0aGlzLl9yMCA9IElSWzZdOwogICAgdGhpcy5fcjEgPSBJUls3XTsKICAgIHRoaXMubWF0cml4ID0gbnVsbDsKICB9CiAgaXNPcmlnaW5CYXNlZCgpIHsKICAgIHJldHVybiB0aGlzLl9wMFswXSA9PT0gMCAmJiB0aGlzLl9wMFsxXSA9PT0gMCAmJiAoIXRoaXMuaXNSYWRpYWwoKSB8fCB0aGlzLl9wMVswXSA9PT0gMCAmJiB0aGlzLl9wMVsxXSA9PT0gMCk7CiAgfQogIGlzUmFkaWFsKCkgewogICAgcmV0dXJuIHRoaXMuX3R5cGUgPT09ICJyYWRpYWwiOwogIH0KICBfY3JlYXRlR3JhZGllbnQoY3R4LCB0cmFuc2Zvcm0gPSBudWxsKSB7CiAgICBsZXQgZ3JhZDsKICAgIGxldCBmaXJzdFBvaW50ID0gdGhpcy5fcDA7CiAgICBsZXQgc2Vjb25kUG9pbnQgPSB0aGlzLl9wMTsKICAgIGlmICh0cmFuc2Zvcm0pIHsKICAgICAgZmlyc3RQb2ludCA9IGZpcnN0UG9pbnQuc2xpY2UoKTsKICAgICAgc2Vjb25kUG9pbnQgPSBzZWNvbmRQb2ludC5zbGljZSgpOwogICAgICBVdGlsLmFwcGx5VHJhbnNmb3JtKGZpcnN0UG9pbnQsIHRyYW5zZm9ybSk7CiAgICAgIFV0aWwuYXBwbHlUcmFuc2Zvcm0oc2Vjb25kUG9pbnQsIHRyYW5zZm9ybSk7CiAgICB9CiAgICBpZiAodGhpcy5fdHlwZSA9PT0gImF4aWFsIikgewogICAgICBncmFkID0gY3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KGZpcnN0UG9pbnRbMF0sIGZpcnN0UG9pbnRbMV0sIHNlY29uZFBvaW50WzBdLCBzZWNvbmRQb2ludFsxXSk7CiAgICB9IGVsc2UgaWYgKHRoaXMuX3R5cGUgPT09ICJyYWRpYWwiKSB7CiAgICAgIGxldCByMCA9IHRoaXMuX3IwOwogICAgICBsZXQgcjEgPSB0aGlzLl9yMTsKICAgICAgaWYgKHRyYW5zZm9ybSkgewogICAgICAgIGNvbnN0IHNjYWxlID0gbmV3IEZsb2F0MzJBcnJheSgyKTsKICAgICAgICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKHRyYW5zZm9ybSwgc2NhbGUpOwogICAgICAgIHIwICo9IHNjYWxlWzBdOwogICAgICAgIHIxICo9IHNjYWxlWzBdOwogICAgICB9CiAgICAgIGdyYWQgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoZmlyc3RQb2ludFswXSwgZmlyc3RQb2ludFsxXSwgcjAsIHNlY29uZFBvaW50WzBdLCBzZWNvbmRQb2ludFsxXSwgcjEpOwogICAgfQogICAgZm9yIChjb25zdCBjb2xvclN0b3Agb2YgdGhpcy5fY29sb3JTdG9wcykgewogICAgICBncmFkLmFkZENvbG9yU3RvcChjb2xvclN0b3BbMF0sIGNvbG9yU3RvcFsxXSk7CiAgICB9CiAgICByZXR1cm4gZ3JhZDsKICB9CiAgZ2V0UGF0dGVybihjdHgsIG93bmVyLCBpbnZlcnNlLCBwYXRoVHlwZSkgewogICAgbGV0IHBhdHRlcm47CiAgICBpZiAocGF0aFR5cGUgPT09IFBhdGhUeXBlLlNUUk9LRSB8fCBwYXRoVHlwZSA9PT0gUGF0aFR5cGUuRklMTCkgewogICAgICBpZiAodGhpcy5pc09yaWdpbkJhc2VkKCkpIHsKICAgICAgICBsZXQgdHJhbnNmID0gVXRpbC50cmFuc2Zvcm0oaW52ZXJzZSwgb3duZXIuYmFzZVRyYW5zZm9ybSk7CiAgICAgICAgaWYgKHRoaXMubWF0cml4KSB7CiAgICAgICAgICB0cmFuc2YgPSBVdGlsLnRyYW5zZm9ybSh0cmFuc2YsIHRoaXMubWF0cml4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcHJlY2lzaW9uID0gMWUtMzsKICAgICAgICBjb25zdCBuMSA9IE1hdGguaHlwb3QodHJhbnNmWzBdLCB0cmFuc2ZbMV0pOwogICAgICAgIGNvbnN0IG4yID0gTWF0aC5oeXBvdCh0cmFuc2ZbMl0sIHRyYW5zZlszXSk7CiAgICAgICAgY29uc3QgcHMgPSAodHJhbnNmWzBdICogdHJhbnNmWzJdICsgdHJhbnNmWzFdICogdHJhbnNmWzNdKSAvIChuMSAqIG4yKTsKICAgICAgICBpZiAoTWF0aC5hYnMocHMpIDwgcHJlY2lzaW9uKSB7CiAgICAgICAgICBpZiAodGhpcy5pc1JhZGlhbCgpKSB7CiAgICAgICAgICAgIGlmIChNYXRoLmFicyhuMSAtIG4yKSA8IHByZWNpc2lvbikgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVHcmFkaWVudChjdHgsIHRyYW5zZik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVHcmFkaWVudChjdHgsIHRyYW5zZik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IG93bmVyQkJveCA9IG93bmVyLmN1cnJlbnQuZ2V0Q2xpcHBlZFBhdGhCb3VuZGluZ0JveChwYXRoVHlwZSwgZ2V0Q3VycmVudFRyYW5zZm9ybShjdHgpKSB8fCBbMCwgMCwgMCwgMF07CiAgICAgIGNvbnN0IHdpZHRoID0gTWF0aC5jZWlsKG93bmVyQkJveFsyXSAtIG93bmVyQkJveFswXSkgfHwgMTsKICAgICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5jZWlsKG93bmVyQkJveFszXSAtIG93bmVyQkJveFsxXSkgfHwgMTsKICAgICAgY29uc3QgdG1wQ2FudmFzID0gb3duZXIuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJwYXR0ZXJuIiwgd2lkdGgsIGhlaWdodCk7CiAgICAgIGNvbnN0IHRtcEN0eCA9IHRtcENhbnZhcy5jb250ZXh0OwogICAgICB0bXBDdHguY2xlYXJSZWN0KDAsIDAsIHRtcEN0eC5jYW52YXMud2lkdGgsIHRtcEN0eC5jYW52YXMuaGVpZ2h0KTsKICAgICAgdG1wQ3R4LmJlZ2luUGF0aCgpOwogICAgICB0bXBDdHgucmVjdCgwLCAwLCB0bXBDdHguY2FudmFzLndpZHRoLCB0bXBDdHguY2FudmFzLmhlaWdodCk7CiAgICAgIHRtcEN0eC50cmFuc2xhdGUoLW93bmVyQkJveFswXSwgLW93bmVyQkJveFsxXSk7CiAgICAgIGludmVyc2UgPSBVdGlsLnRyYW5zZm9ybShpbnZlcnNlLCBbMSwgMCwgMCwgMSwgb3duZXJCQm94WzBdLCBvd25lckJCb3hbMV1dKTsKICAgICAgdG1wQ3R4LnRyYW5zZm9ybSguLi5vd25lci5iYXNlVHJhbnNmb3JtKTsKICAgICAgaWYgKHRoaXMubWF0cml4KSB7CiAgICAgICAgdG1wQ3R4LnRyYW5zZm9ybSguLi50aGlzLm1hdHJpeCk7CiAgICAgIH0KICAgICAgYXBwbHlCb3VuZGluZ0JveCh0bXBDdHgsIHRoaXMuX2Jib3gpOwogICAgICB0bXBDdHguZmlsbFN0eWxlID0gdGhpcy5fY3JlYXRlR3JhZGllbnQodG1wQ3R4KTsKICAgICAgdG1wQ3R4LmZpbGwoKTsKICAgICAgcGF0dGVybiA9IGN0eC5jcmVhdGVQYXR0ZXJuKHRtcENhbnZhcy5jYW52YXMsICJuby1yZXBlYXQiKTsKICAgICAgY29uc3QgZG9tTWF0cml4ID0gbmV3IERPTU1hdHJpeChpbnZlcnNlKTsKICAgICAgcGF0dGVybi5zZXRUcmFuc2Zvcm0oZG9tTWF0cml4KTsKICAgIH0gZWxzZSB7CiAgICAgIGFwcGx5Qm91bmRpbmdCb3goY3R4LCB0aGlzLl9iYm94KTsKICAgICAgcGF0dGVybiA9IHRoaXMuX2NyZWF0ZUdyYWRpZW50KGN0eCk7CiAgICB9CiAgICByZXR1cm4gcGF0dGVybjsKICB9Cn07CmZ1bmN0aW9uIGRyYXdUcmlhbmdsZShkYXRhLCBjb250ZXh0LCBwMSwgcDIsIHAzLCBjMSwgYzIsIGMzKSB7CiAgY29uc3QgY29vcmRzID0gY29udGV4dC5jb29yZHMsIGNvbG9ycyA9IGNvbnRleHQuY29sb3JzOwogIGNvbnN0IGJ5dGVzID0gZGF0YS5kYXRhLCByb3dTaXplID0gZGF0YS53aWR0aCAqIDQ7CiAgbGV0IHRtcDsKICBpZiAoY29vcmRzW3AxICsgMV0gPiBjb29yZHNbcDIgKyAxXSkgewogICAgdG1wID0gcDE7CiAgICBwMSA9IHAyOwogICAgcDIgPSB0bXA7CiAgICB0bXAgPSBjMTsKICAgIGMxID0gYzI7CiAgICBjMiA9IHRtcDsKICB9CiAgaWYgKGNvb3Jkc1twMiArIDFdID4gY29vcmRzW3AzICsgMV0pIHsKICAgIHRtcCA9IHAyOwogICAgcDIgPSBwMzsKICAgIHAzID0gdG1wOwogICAgdG1wID0gYzI7CiAgICBjMiA9IGMzOwogICAgYzMgPSB0bXA7CiAgfQogIGlmIChjb29yZHNbcDEgKyAxXSA+IGNvb3Jkc1twMiArIDFdKSB7CiAgICB0bXAgPSBwMTsKICAgIHAxID0gcDI7CiAgICBwMiA9IHRtcDsKICAgIHRtcCA9IGMxOwogICAgYzEgPSBjMjsKICAgIGMyID0gdG1wOwogIH0KICBjb25zdCB4MSA9IChjb29yZHNbcDFdICsgY29udGV4dC5vZmZzZXRYKSAqIGNvbnRleHQuc2NhbGVYOwogIGNvbnN0IHkxID0gKGNvb3Jkc1twMSArIDFdICsgY29udGV4dC5vZmZzZXRZKSAqIGNvbnRleHQuc2NhbGVZOwogIGNvbnN0IHgyID0gKGNvb3Jkc1twMl0gKyBjb250ZXh0Lm9mZnNldFgpICogY29udGV4dC5zY2FsZVg7CiAgY29uc3QgeTIgPSAoY29vcmRzW3AyICsgMV0gKyBjb250ZXh0Lm9mZnNldFkpICogY29udGV4dC5zY2FsZVk7CiAgY29uc3QgeDMgPSAoY29vcmRzW3AzXSArIGNvbnRleHQub2Zmc2V0WCkgKiBjb250ZXh0LnNjYWxlWDsKICBjb25zdCB5MyA9IChjb29yZHNbcDMgKyAxXSArIGNvbnRleHQub2Zmc2V0WSkgKiBjb250ZXh0LnNjYWxlWTsKICBpZiAoeTEgPj0geTMpIHsKICAgIHJldHVybjsKICB9CiAgY29uc3QgYzFyID0gY29sb3JzW2MxXSwgYzFnID0gY29sb3JzW2MxICsgMV0sIGMxYiA9IGNvbG9yc1tjMSArIDJdOwogIGNvbnN0IGMyciA9IGNvbG9yc1tjMl0sIGMyZyA9IGNvbG9yc1tjMiArIDFdLCBjMmIgPSBjb2xvcnNbYzIgKyAyXTsKICBjb25zdCBjM3IgPSBjb2xvcnNbYzNdLCBjM2cgPSBjb2xvcnNbYzMgKyAxXSwgYzNiID0gY29sb3JzW2MzICsgMl07CiAgY29uc3QgbWluWSA9IE1hdGgucm91bmQoeTEpLCBtYXhZID0gTWF0aC5yb3VuZCh5Myk7CiAgbGV0IHhhLCBjYXIsIGNhZywgY2FiOwogIGxldCB4YiwgY2JyLCBjYmcsIGNiYjsKICBmb3IgKGxldCB5ID0gbWluWTsgeSA8PSBtYXhZOyB5KyspIHsKICAgIGlmICh5IDwgeTIpIHsKICAgICAgY29uc3QgazIgPSB5IDwgeTEgPyAwIDogKHkxIC0geSkgLyAoeTEgLSB5Mik7CiAgICAgIHhhID0geDEgLSAoeDEgLSB4MikgKiBrMjsKICAgICAgY2FyID0gYzFyIC0gKGMxciAtIGMycikgKiBrMjsKICAgICAgY2FnID0gYzFnIC0gKGMxZyAtIGMyZykgKiBrMjsKICAgICAgY2FiID0gYzFiIC0gKGMxYiAtIGMyYikgKiBrMjsKICAgIH0gZWxzZSB7CiAgICAgIGxldCBrMjsKICAgICAgaWYgKHkgPiB5MykgewogICAgICAgIGsyID0gMTsKICAgICAgfSBlbHNlIGlmICh5MiA9PT0geTMpIHsKICAgICAgICBrMiA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgazIgPSAoeTIgLSB5KSAvICh5MiAtIHkzKTsKICAgICAgfQogICAgICB4YSA9IHgyIC0gKHgyIC0geDMpICogazI7CiAgICAgIGNhciA9IGMyciAtIChjMnIgLSBjM3IpICogazI7CiAgICAgIGNhZyA9IGMyZyAtIChjMmcgLSBjM2cpICogazI7CiAgICAgIGNhYiA9IGMyYiAtIChjMmIgLSBjM2IpICogazI7CiAgICB9CiAgICBsZXQgazsKICAgIGlmICh5IDwgeTEpIHsKICAgICAgayA9IDA7CiAgICB9IGVsc2UgaWYgKHkgPiB5MykgewogICAgICBrID0gMTsKICAgIH0gZWxzZSB7CiAgICAgIGsgPSAoeTEgLSB5KSAvICh5MSAtIHkzKTsKICAgIH0KICAgIHhiID0geDEgLSAoeDEgLSB4MykgKiBrOwogICAgY2JyID0gYzFyIC0gKGMxciAtIGMzcikgKiBrOwogICAgY2JnID0gYzFnIC0gKGMxZyAtIGMzZykgKiBrOwogICAgY2JiID0gYzFiIC0gKGMxYiAtIGMzYikgKiBrOwogICAgY29uc3QgeDFfID0gTWF0aC5yb3VuZChNYXRoLm1pbih4YSwgeGIpKTsKICAgIGNvbnN0IHgyXyA9IE1hdGgucm91bmQoTWF0aC5tYXgoeGEsIHhiKSk7CiAgICBsZXQgaiA9IHJvd1NpemUgKiB5ICsgeDFfICogNDsKICAgIGZvciAobGV0IHggPSB4MV87IHggPD0geDJfOyB4KyspIHsKICAgICAgayA9ICh4YSAtIHgpIC8gKHhhIC0geGIpOwogICAgICBpZiAoayA8IDApIHsKICAgICAgICBrID0gMDsKICAgICAgfSBlbHNlIGlmIChrID4gMSkgewogICAgICAgIGsgPSAxOwogICAgICB9CiAgICAgIGJ5dGVzW2orK10gPSBjYXIgLSAoY2FyIC0gY2JyKSAqIGsgfCAwOwogICAgICBieXRlc1tqKytdID0gY2FnIC0gKGNhZyAtIGNiZykgKiBrIHwgMDsKICAgICAgYnl0ZXNbaisrXSA9IGNhYiAtIChjYWIgLSBjYmIpICogayB8IDA7CiAgICAgIGJ5dGVzW2orK10gPSAyNTU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGRyYXdGaWd1cmUoZGF0YSwgZmlndXJlLCBjb250ZXh0KSB7CiAgY29uc3QgcHMgPSBmaWd1cmUuY29vcmRzOwogIGNvbnN0IGNzID0gZmlndXJlLmNvbG9yczsKICBsZXQgaSwgaWk7CiAgc3dpdGNoIChmaWd1cmUudHlwZSkgewogICAgY2FzZSBNZXNoRmlndXJlVHlwZS5MQVRUSUNFOgogICAgICBjb25zdCB2ZXJ0aWNlc1BlclJvdyA9IGZpZ3VyZS52ZXJ0aWNlc1BlclJvdzsKICAgICAgY29uc3Qgcm93cyA9IE1hdGguZmxvb3IocHMubGVuZ3RoIC8gdmVydGljZXNQZXJSb3cpIC0gMTsKICAgICAgY29uc3QgY29scyA9IHZlcnRpY2VzUGVyUm93IC0gMTsKICAgICAgZm9yIChpID0gMDsgaSA8IHJvd3M7IGkrKykgewogICAgICAgIGxldCBxID0gaSAqIHZlcnRpY2VzUGVyUm93OwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgY29sczsgaisrLCBxKyspIHsKICAgICAgICAgIGRyYXdUcmlhbmdsZShkYXRhLCBjb250ZXh0LCBwc1txXSwgcHNbcSArIDFdLCBwc1txICsgdmVydGljZXNQZXJSb3ddLCBjc1txXSwgY3NbcSArIDFdLCBjc1txICsgdmVydGljZXNQZXJSb3ddKTsKICAgICAgICAgIGRyYXdUcmlhbmdsZShkYXRhLCBjb250ZXh0LCBwc1txICsgdmVydGljZXNQZXJSb3cgKyAxXSwgcHNbcSArIDFdLCBwc1txICsgdmVydGljZXNQZXJSb3ddLCBjc1txICsgdmVydGljZXNQZXJSb3cgKyAxXSwgY3NbcSArIDFdLCBjc1txICsgdmVydGljZXNQZXJSb3ddKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYnJlYWs7CiAgICBjYXNlIE1lc2hGaWd1cmVUeXBlLlRSSUFOR0xFUzoKICAgICAgZm9yIChpID0gMCwgaWkgPSBwcy5sZW5ndGg7IGkgPCBpaTsgaSArPSAzKSB7CiAgICAgICAgZHJhd1RyaWFuZ2xlKGRhdGEsIGNvbnRleHQsIHBzW2ldLCBwc1tpICsgMV0sIHBzW2kgKyAyXSwgY3NbaV0sIGNzW2kgKyAxXSwgY3NbaSArIDJdKTsKICAgICAgfQogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiaWxsZWdhbCBmaWd1cmUiKTsKICB9Cn0KdmFyIE1lc2hTaGFkaW5nUGF0dGVybiA9IGNsYXNzIGV4dGVuZHMgQmFzZVNoYWRpbmdQYXR0ZXJuIHsKICBjb25zdHJ1Y3RvcihJUikgewogICAgc3VwZXIoKTsKICAgIHRoaXMuX2Nvb3JkcyA9IElSWzJdOwogICAgdGhpcy5fY29sb3JzID0gSVJbM107CiAgICB0aGlzLl9maWd1cmVzID0gSVJbNF07CiAgICB0aGlzLl9ib3VuZHMgPSBJUls1XTsKICAgIHRoaXMuX2Jib3ggPSBJUls2XTsKICAgIHRoaXMuX2JhY2tncm91bmQgPSBJUls3XTsKICAgIHRoaXMubWF0cml4ID0gbnVsbDsKICB9CiAgX2NyZWF0ZU1lc2hDYW52YXMoY29tYmluZWRTY2FsZSwgYmFja2dyb3VuZENvbG9yLCBjYWNoZWRDYW52YXNlcykgewogICAgY29uc3QgRVhQRUNURURfU0NBTEUgPSAxLjE7CiAgICBjb25zdCBNQVhfUEFUVEVSTl9TSVpFID0gM2UzOwogICAgY29uc3QgQk9SREVSX1NJWkUgPSAyOwogICAgY29uc3Qgb2Zmc2V0WCA9IE1hdGguZmxvb3IodGhpcy5fYm91bmRzWzBdKTsKICAgIGNvbnN0IG9mZnNldFkgPSBNYXRoLmZsb29yKHRoaXMuX2JvdW5kc1sxXSk7CiAgICBjb25zdCBib3VuZHNXaWR0aCA9IE1hdGguY2VpbCh0aGlzLl9ib3VuZHNbMl0pIC0gb2Zmc2V0WDsKICAgIGNvbnN0IGJvdW5kc0hlaWdodCA9IE1hdGguY2VpbCh0aGlzLl9ib3VuZHNbM10pIC0gb2Zmc2V0WTsKICAgIGNvbnN0IHdpZHRoID0gTWF0aC5taW4oTWF0aC5jZWlsKE1hdGguYWJzKGJvdW5kc1dpZHRoICogY29tYmluZWRTY2FsZVswXSAqIEVYUEVDVEVEX1NDQUxFKSksIE1BWF9QQVRURVJOX1NJWkUpOwogICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5taW4oTWF0aC5jZWlsKE1hdGguYWJzKGJvdW5kc0hlaWdodCAqIGNvbWJpbmVkU2NhbGVbMV0gKiBFWFBFQ1RFRF9TQ0FMRSkpLCBNQVhfUEFUVEVSTl9TSVpFKTsKICAgIGNvbnN0IHNjYWxlWCA9IGJvdW5kc1dpZHRoIC8gd2lkdGg7CiAgICBjb25zdCBzY2FsZVkgPSBib3VuZHNIZWlnaHQgLyBoZWlnaHQ7CiAgICBjb25zdCBjb250ZXh0ID0gewogICAgICBjb29yZHM6IHRoaXMuX2Nvb3JkcywKICAgICAgY29sb3JzOiB0aGlzLl9jb2xvcnMsCiAgICAgIG9mZnNldFg6IC1vZmZzZXRYLAogICAgICBvZmZzZXRZOiAtb2Zmc2V0WSwKICAgICAgc2NhbGVYOiAxIC8gc2NhbGVYLAogICAgICBzY2FsZVk6IDEgLyBzY2FsZVkKICAgIH07CiAgICBjb25zdCBwYWRkZWRXaWR0aCA9IHdpZHRoICsgQk9SREVSX1NJWkUgKiAyOwogICAgY29uc3QgcGFkZGVkSGVpZ2h0ID0gaGVpZ2h0ICsgQk9SREVSX1NJWkUgKiAyOwogICAgY29uc3QgdG1wQ2FudmFzID0gY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJtZXNoIiwgcGFkZGVkV2lkdGgsIHBhZGRlZEhlaWdodCk7CiAgICBjb25zdCB0bXBDdHggPSB0bXBDYW52YXMuY29udGV4dDsKICAgIGNvbnN0IGRhdGEgPSB0bXBDdHguY3JlYXRlSW1hZ2VEYXRhKHdpZHRoLCBoZWlnaHQpOwogICAgaWYgKGJhY2tncm91bmRDb2xvcikgewogICAgICBjb25zdCBieXRlcyA9IGRhdGEuZGF0YTsKICAgICAgZm9yIChsZXQgaSA9IDAsIGlpID0gYnl0ZXMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gNCkgewogICAgICAgIGJ5dGVzW2ldID0gYmFja2dyb3VuZENvbG9yWzBdOwogICAgICAgIGJ5dGVzW2kgKyAxXSA9IGJhY2tncm91bmRDb2xvclsxXTsKICAgICAgICBieXRlc1tpICsgMl0gPSBiYWNrZ3JvdW5kQ29sb3JbMl07CiAgICAgICAgYnl0ZXNbaSArIDNdID0gMjU1OwogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IGZpZ3VyZSBvZiB0aGlzLl9maWd1cmVzKSB7CiAgICAgIGRyYXdGaWd1cmUoZGF0YSwgZmlndXJlLCBjb250ZXh0KTsKICAgIH0KICAgIHRtcEN0eC5wdXRJbWFnZURhdGEoZGF0YSwgQk9SREVSX1NJWkUsIEJPUkRFUl9TSVpFKTsKICAgIGNvbnN0IGNhbnZhcyA9IHRtcENhbnZhcy5jYW52YXM7CiAgICByZXR1cm4gewogICAgICBjYW52YXMsCiAgICAgIG9mZnNldFg6IG9mZnNldFggLSBCT1JERVJfU0laRSAqIHNjYWxlWCwKICAgICAgb2Zmc2V0WTogb2Zmc2V0WSAtIEJPUkRFUl9TSVpFICogc2NhbGVZLAogICAgICBzY2FsZVgsCiAgICAgIHNjYWxlWQogICAgfTsKICB9CiAgaXNNb2RpZnlpbmdDdXJyZW50VHJhbnNmb3JtKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGdldFBhdHRlcm4oY3R4LCBvd25lciwgaW52ZXJzZSwgcGF0aFR5cGUpIHsKICAgIGFwcGx5Qm91bmRpbmdCb3goY3R4LCB0aGlzLl9iYm94KTsKICAgIGNvbnN0IHNjYWxlID0gbmV3IEZsb2F0MzJBcnJheSgyKTsKICAgIGlmIChwYXRoVHlwZSA9PT0gUGF0aFR5cGUuU0hBRElORykgewogICAgICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KSwgc2NhbGUpOwogICAgfSBlbHNlIGlmICh0aGlzLm1hdHJpeCkgewogICAgICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKHRoaXMubWF0cml4LCBzY2FsZSk7CiAgICAgIGNvbnN0IFttYXRyaXhTY2FsZVgsIG1hdHJpeFNjYWxlWV0gPSBzY2FsZTsKICAgICAgVXRpbC5zaW5ndWxhclZhbHVlRGVjb21wb3NlMmRTY2FsZShvd25lci5iYXNlVHJhbnNmb3JtLCBzY2FsZSk7CiAgICAgIHNjYWxlWzBdICo9IG1hdHJpeFNjYWxlWDsKICAgICAgc2NhbGVbMV0gKj0gbWF0cml4U2NhbGVZOwogICAgfSBlbHNlIHsKICAgICAgVXRpbC5zaW5ndWxhclZhbHVlRGVjb21wb3NlMmRTY2FsZShvd25lci5iYXNlVHJhbnNmb3JtLCBzY2FsZSk7CiAgICB9CiAgICBjb25zdCB0ZW1wb3JhcnlQYXR0ZXJuQ2FudmFzID0gdGhpcy5fY3JlYXRlTWVzaENhbnZhcyhzY2FsZSwgcGF0aFR5cGUgPT09IFBhdGhUeXBlLlNIQURJTkcgPyBudWxsIDogdGhpcy5fYmFja2dyb3VuZCwgb3duZXIuY2FjaGVkQ2FudmFzZXMpOwogICAgaWYgKHBhdGhUeXBlICE9PSBQYXRoVHlwZS5TSEFESU5HKSB7CiAgICAgIGN0eC5zZXRUcmFuc2Zvcm0oLi4ub3duZXIuYmFzZVRyYW5zZm9ybSk7CiAgICAgIGlmICh0aGlzLm1hdHJpeCkgewogICAgICAgIGN0eC50cmFuc2Zvcm0oLi4udGhpcy5tYXRyaXgpOwogICAgICB9CiAgICB9CiAgICBjdHgudHJhbnNsYXRlKHRlbXBvcmFyeVBhdHRlcm5DYW52YXMub2Zmc2V0WCwgdGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5vZmZzZXRZKTsKICAgIGN0eC5zY2FsZSh0ZW1wb3JhcnlQYXR0ZXJuQ2FudmFzLnNjYWxlWCwgdGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5zY2FsZVkpOwogICAgcmV0dXJuIGN0eC5jcmVhdGVQYXR0ZXJuKHRlbXBvcmFyeVBhdHRlcm5DYW52YXMuY2FudmFzLCAibm8tcmVwZWF0Iik7CiAgfQp9Owp2YXIgRHVtbXlTaGFkaW5nUGF0dGVybiA9IGNsYXNzIGV4dGVuZHMgQmFzZVNoYWRpbmdQYXR0ZXJuIHsKICBnZXRQYXR0ZXJuKCkgewogICAgcmV0dXJuICJob3RwaW5rIjsKICB9Cn07CmZ1bmN0aW9uIGdldFNoYWRpbmdQYXR0ZXJuKElSKSB7CiAgc3dpdGNoIChJUlswXSkgewogICAgY2FzZSAiUmFkaWFsQXhpYWwiOgogICAgICByZXR1cm4gbmV3IFJhZGlhbEF4aWFsU2hhZGluZ1BhdHRlcm4oSVIpOwogICAgY2FzZSAiTWVzaCI6CiAgICAgIHJldHVybiBuZXcgTWVzaFNoYWRpbmdQYXR0ZXJuKElSKTsKICAgIGNhc2UgIkR1bW15IjoKICAgICAgcmV0dXJuIG5ldyBEdW1teVNoYWRpbmdQYXR0ZXJuKCk7CiAgfQogIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBJUiB0eXBlOiAke0lSWzBdfWApOwp9CnZhciBQYWludFR5cGUgPSB7CiAgQ09MT1JFRDogMSwKICBVTkNPTE9SRUQ6IDIKfTsKdmFyIFRpbGluZ1BhdHRlcm4gPSBjbGFzcyBfVGlsaW5nUGF0dGVybiB7CiAgc3RhdGljIE1BWF9QQVRURVJOX1NJWkUgPSAzZTM7CiAgY29uc3RydWN0b3IoSVIsIGN0eCwgY2FudmFzR3JhcGhpY3NGYWN0b3J5LCBiYXNlVHJhbnNmb3JtKSB7CiAgICB0aGlzLmNvbG9yID0gSVJbMV07CiAgICB0aGlzLm9wZXJhdG9yTGlzdCA9IElSWzJdOwogICAgdGhpcy5tYXRyaXggPSBJUlszXTsKICAgIHRoaXMuYmJveCA9IElSWzRdOwogICAgdGhpcy54c3RlcCA9IElSWzVdOwogICAgdGhpcy55c3RlcCA9IElSWzZdOwogICAgdGhpcy5wYWludFR5cGUgPSBJUls3XTsKICAgIHRoaXMudGlsaW5nVHlwZSA9IElSWzhdOwogICAgdGhpcy5jdHggPSBjdHg7CiAgICB0aGlzLmNhbnZhc0dyYXBoaWNzRmFjdG9yeSA9IGNhbnZhc0dyYXBoaWNzRmFjdG9yeTsKICAgIHRoaXMuYmFzZVRyYW5zZm9ybSA9IGJhc2VUcmFuc2Zvcm07CiAgfQogIGNyZWF0ZVBhdHRlcm5DYW52YXMob3duZXIsIG9wSWR4KSB7CiAgICBjb25zdCB7CiAgICAgIGJib3gsCiAgICAgIG9wZXJhdG9yTGlzdCwKICAgICAgcGFpbnRUeXBlLAogICAgICB0aWxpbmdUeXBlLAogICAgICBjb2xvciwKICAgICAgY2FudmFzR3JhcGhpY3NGYWN0b3J5CiAgICB9ID0gdGhpczsKICAgIGxldCB7CiAgICAgIHhzdGVwLAogICAgICB5c3RlcAogICAgfSA9IHRoaXM7CiAgICB4c3RlcCA9IE1hdGguYWJzKHhzdGVwKTsKICAgIHlzdGVwID0gTWF0aC5hYnMoeXN0ZXApOwogICAgaW5mbygiVGlsaW5nVHlwZTogIiArIHRpbGluZ1R5cGUpOwogICAgY29uc3QgeDAgPSBiYm94WzBdLCB5MCA9IGJib3hbMV0sIHgxID0gYmJveFsyXSwgeTEgPSBiYm94WzNdOwogICAgY29uc3Qgd2lkdGggPSB4MSAtIHgwOwogICAgY29uc3QgaGVpZ2h0ID0geTEgLSB5MDsKICAgIGNvbnN0IHNjYWxlID0gbmV3IEZsb2F0MzJBcnJheSgyKTsKICAgIFV0aWwuc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUodGhpcy5tYXRyaXgsIHNjYWxlKTsKICAgIGNvbnN0IFttYXRyaXhTY2FsZVgsIG1hdHJpeFNjYWxlWV0gPSBzY2FsZTsKICAgIFV0aWwuc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUodGhpcy5iYXNlVHJhbnNmb3JtLCBzY2FsZSk7CiAgICBjb25zdCBjb21iaW5lZFNjYWxlWCA9IG1hdHJpeFNjYWxlWCAqIHNjYWxlWzBdOwogICAgY29uc3QgY29tYmluZWRTY2FsZVkgPSBtYXRyaXhTY2FsZVkgKiBzY2FsZVsxXTsKICAgIGxldCBjYW52YXNXaWR0aCA9IHdpZHRoLCBjYW52YXNIZWlnaHQgPSBoZWlnaHQsIHJlZHJhd0hvcml6b250YWxseSA9IGZhbHNlLCByZWRyYXdWZXJ0aWNhbGx5ID0gZmFsc2U7CiAgICBjb25zdCB4U2NhbGVkU3RlcCA9IE1hdGguY2VpbCh4c3RlcCAqIGNvbWJpbmVkU2NhbGVYKTsKICAgIGNvbnN0IHlTY2FsZWRTdGVwID0gTWF0aC5jZWlsKHlzdGVwICogY29tYmluZWRTY2FsZVkpOwogICAgY29uc3QgeFNjYWxlZFdpZHRoID0gTWF0aC5jZWlsKHdpZHRoICogY29tYmluZWRTY2FsZVgpOwogICAgY29uc3QgeVNjYWxlZEhlaWdodCA9IE1hdGguY2VpbChoZWlnaHQgKiBjb21iaW5lZFNjYWxlWSk7CiAgICBpZiAoeFNjYWxlZFN0ZXAgPj0geFNjYWxlZFdpZHRoKSB7CiAgICAgIGNhbnZhc1dpZHRoID0geHN0ZXA7CiAgICB9IGVsc2UgewogICAgICByZWRyYXdIb3Jpem9udGFsbHkgPSB0cnVlOwogICAgfQogICAgaWYgKHlTY2FsZWRTdGVwID49IHlTY2FsZWRIZWlnaHQpIHsKICAgICAgY2FudmFzSGVpZ2h0ID0geXN0ZXA7CiAgICB9IGVsc2UgewogICAgICByZWRyYXdWZXJ0aWNhbGx5ID0gdHJ1ZTsKICAgIH0KICAgIGNvbnN0IGRpbXggPSB0aGlzLmdldFNpemVBbmRTY2FsZShjYW52YXNXaWR0aCwgdGhpcy5jdHguY2FudmFzLndpZHRoLCBjb21iaW5lZFNjYWxlWCk7CiAgICBjb25zdCBkaW15ID0gdGhpcy5nZXRTaXplQW5kU2NhbGUoY2FudmFzSGVpZ2h0LCB0aGlzLmN0eC5jYW52YXMuaGVpZ2h0LCBjb21iaW5lZFNjYWxlWSk7CiAgICBjb25zdCB0bXBDYW52YXMgPSBvd25lci5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoInBhdHRlcm4iLCBkaW14LnNpemUsIGRpbXkuc2l6ZSk7CiAgICBjb25zdCB0bXBDdHggPSB0bXBDYW52YXMuY29udGV4dDsKICAgIGNvbnN0IGdyYXBoaWNzID0gY2FudmFzR3JhcGhpY3NGYWN0b3J5LmNyZWF0ZUNhbnZhc0dyYXBoaWNzKHRtcEN0eCwgb3BJZHgpOwogICAgZ3JhcGhpY3MuZ3JvdXBMZXZlbCA9IG93bmVyLmdyb3VwTGV2ZWw7CiAgICB0aGlzLnNldEZpbGxBbmRTdHJva2VTdHlsZVRvQ29udGV4dChncmFwaGljcywgcGFpbnRUeXBlLCBjb2xvcik7CiAgICB0bXBDdHgudHJhbnNsYXRlKC1kaW14LnNjYWxlICogeDAsIC1kaW15LnNjYWxlICogeTApOwogICAgZ3JhcGhpY3MudHJhbnNmb3JtKDAsIGRpbXguc2NhbGUsIDAsIDAsIGRpbXkuc2NhbGUsIDAsIDApOwogICAgdG1wQ3R4LnNhdmUoKTsKICAgIGdyYXBoaWNzLmRlcGVuZGVuY3lUcmFja2VyPy5zYXZlKCk7CiAgICB0aGlzLmNsaXBCYm94KGdyYXBoaWNzLCB4MCwgeTAsIHgxLCB5MSk7CiAgICBncmFwaGljcy5iYXNlVHJhbnNmb3JtID0gZ2V0Q3VycmVudFRyYW5zZm9ybShncmFwaGljcy5jdHgpOwogICAgZ3JhcGhpY3MuZXhlY3V0ZU9wZXJhdG9yTGlzdChvcGVyYXRvckxpc3QpOwogICAgZ3JhcGhpY3MuZW5kRHJhd2luZygpOwogICAgZ3JhcGhpY3MuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc3RvcmUoKTsKICAgIHRtcEN0eC5yZXN0b3JlKCk7CiAgICBpZiAocmVkcmF3SG9yaXpvbnRhbGx5IHx8IHJlZHJhd1ZlcnRpY2FsbHkpIHsKICAgICAgY29uc3QgaW1hZ2UgPSB0bXBDYW52YXMuY2FudmFzOwogICAgICBpZiAocmVkcmF3SG9yaXpvbnRhbGx5KSB7CiAgICAgICAgY2FudmFzV2lkdGggPSB4c3RlcDsKICAgICAgfQogICAgICBpZiAocmVkcmF3VmVydGljYWxseSkgewogICAgICAgIGNhbnZhc0hlaWdodCA9IHlzdGVwOwogICAgICB9CiAgICAgIGNvbnN0IGRpbXgyID0gdGhpcy5nZXRTaXplQW5kU2NhbGUoY2FudmFzV2lkdGgsIHRoaXMuY3R4LmNhbnZhcy53aWR0aCwgY29tYmluZWRTY2FsZVgpOwogICAgICBjb25zdCBkaW15MiA9IHRoaXMuZ2V0U2l6ZUFuZFNjYWxlKGNhbnZhc0hlaWdodCwgdGhpcy5jdHguY2FudmFzLmhlaWdodCwgY29tYmluZWRTY2FsZVkpOwogICAgICBjb25zdCB4U2l6ZSA9IGRpbXgyLnNpemU7CiAgICAgIGNvbnN0IHlTaXplID0gZGlteTIuc2l6ZTsKICAgICAgY29uc3QgdG1wQ2FudmFzMiA9IG93bmVyLmNhY2hlZENhbnZhc2VzLmdldENhbnZhcygicGF0dGVybi13b3JrYXJvdW5kIiwgeFNpemUsIHlTaXplKTsKICAgICAgY29uc3QgdG1wQ3R4MiA9IHRtcENhbnZhczIuY29udGV4dDsKICAgICAgY29uc3QgaWkgPSByZWRyYXdIb3Jpem9udGFsbHkgPyBNYXRoLmZsb29yKHdpZHRoIC8geHN0ZXApIDogMDsKICAgICAgY29uc3QgamogPSByZWRyYXdWZXJ0aWNhbGx5ID8gTWF0aC5mbG9vcihoZWlnaHQgLyB5c3RlcCkgOiAwOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSBpaTsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPD0gamo7IGorKykgewogICAgICAgICAgdG1wQ3R4Mi5kcmF3SW1hZ2UoaW1hZ2UsIHhTaXplICogaSwgeVNpemUgKiBqLCB4U2l6ZSwgeVNpemUsIDAsIDAsIHhTaXplLCB5U2l6ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY2FudmFzOiB0bXBDYW52YXMyLmNhbnZhcywKICAgICAgICBzY2FsZVg6IGRpbXgyLnNjYWxlLAogICAgICAgIHNjYWxlWTogZGlteTIuc2NhbGUsCiAgICAgICAgb2Zmc2V0WDogeDAsCiAgICAgICAgb2Zmc2V0WTogeTAKICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGNhbnZhczogdG1wQ2FudmFzLmNhbnZhcywKICAgICAgc2NhbGVYOiBkaW14LnNjYWxlLAogICAgICBzY2FsZVk6IGRpbXkuc2NhbGUsCiAgICAgIG9mZnNldFg6IHgwLAogICAgICBvZmZzZXRZOiB5MAogICAgfTsKICB9CiAgZ2V0U2l6ZUFuZFNjYWxlKHN0ZXAsIHJlYWxPdXRwdXRTaXplLCBzY2FsZSkgewogICAgY29uc3QgbWF4U2l6ZSA9IE1hdGgubWF4KF9UaWxpbmdQYXR0ZXJuLk1BWF9QQVRURVJOX1NJWkUsIHJlYWxPdXRwdXRTaXplKTsKICAgIGxldCBzaXplID0gTWF0aC5jZWlsKHN0ZXAgKiBzY2FsZSk7CiAgICBpZiAoc2l6ZSA+PSBtYXhTaXplKSB7CiAgICAgIHNpemUgPSBtYXhTaXplOwogICAgfSBlbHNlIHsKICAgICAgc2NhbGUgPSBzaXplIC8gc3RlcDsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHNjYWxlLAogICAgICBzaXplCiAgICB9OwogIH0KICBjbGlwQmJveChncmFwaGljcywgeDAsIHkwLCB4MSwgeTEpIHsKICAgIGNvbnN0IGJib3hXaWR0aCA9IHgxIC0geDA7CiAgICBjb25zdCBiYm94SGVpZ2h0ID0geTEgLSB5MDsKICAgIGdyYXBoaWNzLmN0eC5yZWN0KHgwLCB5MCwgYmJveFdpZHRoLCBiYm94SGVpZ2h0KTsKICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goW3gwLCB5MCwgeDEsIHkxXSwgZ2V0Q3VycmVudFRyYW5zZm9ybShncmFwaGljcy5jdHgpLCBncmFwaGljcy5jdXJyZW50Lm1pbk1heCk7CiAgICBncmFwaGljcy5jbGlwKCk7CiAgICBncmFwaGljcy5lbmRQYXRoKCk7CiAgfQogIHNldEZpbGxBbmRTdHJva2VTdHlsZVRvQ29udGV4dChncmFwaGljcywgcGFpbnRUeXBlLCBjb2xvcikgewogICAgY29uc3QgY29udGV4dCA9IGdyYXBoaWNzLmN0eCwgY3VycmVudCA9IGdyYXBoaWNzLmN1cnJlbnQ7CiAgICBzd2l0Y2ggKHBhaW50VHlwZSkgewogICAgICBjYXNlIFBhaW50VHlwZS5DT0xPUkVEOgogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGZpbGxTdHlsZSwKICAgICAgICAgIHN0cm9rZVN0eWxlCiAgICAgICAgfSA9IHRoaXMuY3R4OwogICAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gY3VycmVudC5maWxsQ29sb3IgPSBmaWxsU3R5bGU7CiAgICAgICAgY29udGV4dC5zdHJva2VTdHlsZSA9IGN1cnJlbnQuc3Ryb2tlQ29sb3IgPSBzdHJva2VTdHlsZTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBQYWludFR5cGUuVU5DT0xPUkVEOgogICAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yOwogICAgICAgIGN1cnJlbnQuZmlsbENvbG9yID0gY3VycmVudC5zdHJva2VDb2xvciA9IGNvbG9yOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBGb3JtYXRFcnJvcihgVW5zdXBwb3J0ZWQgcGFpbnQgdHlwZTogJHtwYWludFR5cGV9YCk7CiAgICB9CiAgfQogIGlzTW9kaWZ5aW5nQ3VycmVudFRyYW5zZm9ybSgpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZ2V0UGF0dGVybihjdHgsIG93bmVyLCBpbnZlcnNlLCBwYXRoVHlwZSwgb3BJZHgpIHsKICAgIGxldCBtYXRyaXggPSBpbnZlcnNlOwogICAgaWYgKHBhdGhUeXBlICE9PSBQYXRoVHlwZS5TSEFESU5HKSB7CiAgICAgIG1hdHJpeCA9IFV0aWwudHJhbnNmb3JtKG1hdHJpeCwgb3duZXIuYmFzZVRyYW5zZm9ybSk7CiAgICAgIGlmICh0aGlzLm1hdHJpeCkgewogICAgICAgIG1hdHJpeCA9IFV0aWwudHJhbnNmb3JtKG1hdHJpeCwgdGhpcy5tYXRyaXgpOwogICAgICB9CiAgICB9CiAgICBjb25zdCB0ZW1wb3JhcnlQYXR0ZXJuQ2FudmFzID0gdGhpcy5jcmVhdGVQYXR0ZXJuQ2FudmFzKG93bmVyLCBvcElkeCk7CiAgICBsZXQgZG9tTWF0cml4ID0gbmV3IERPTU1hdHJpeChtYXRyaXgpOwogICAgZG9tTWF0cml4ID0gZG9tTWF0cml4LnRyYW5zbGF0ZSh0ZW1wb3JhcnlQYXR0ZXJuQ2FudmFzLm9mZnNldFgsIHRlbXBvcmFyeVBhdHRlcm5DYW52YXMub2Zmc2V0WSk7CiAgICBkb21NYXRyaXggPSBkb21NYXRyaXguc2NhbGUoMSAvIHRlbXBvcmFyeVBhdHRlcm5DYW52YXMuc2NhbGVYLCAxIC8gdGVtcG9yYXJ5UGF0dGVybkNhbnZhcy5zY2FsZVkpOwogICAgY29uc3QgcGF0dGVybiA9IGN0eC5jcmVhdGVQYXR0ZXJuKHRlbXBvcmFyeVBhdHRlcm5DYW52YXMuY2FudmFzLCAicmVwZWF0Iik7CiAgICBwYXR0ZXJuLnNldFRyYW5zZm9ybShkb21NYXRyaXgpOwogICAgcmV0dXJuIHBhdHRlcm47CiAgfQp9OwpmdW5jdGlvbiBjb252ZXJ0QmxhY2tBbmRXaGl0ZVRvUkdCQSh7CiAgc3JjLAogIHNyY1BvcyA9IDAsCiAgZGVzdCwKICB3aWR0aCwKICBoZWlnaHQsCiAgbm9uQmxhY2tDb2xvciA9IDQyOTQ5NjcyOTUsCiAgaW52ZXJzZURlY29kZSA9IGZhbHNlCn0pIHsKICBjb25zdCBibGFjayA9IHV0aWxfRmVhdHVyZVRlc3QuaXNMaXR0bGVFbmRpYW4gPyA0Mjc4MTkwMDgwIDogMjU1OwogIGNvbnN0IFt6ZXJvTWFwcGluZywgb25lTWFwcGluZ10gPSBpbnZlcnNlRGVjb2RlID8gW25vbkJsYWNrQ29sb3IsIGJsYWNrXSA6IFtibGFjaywgbm9uQmxhY2tDb2xvcl07CiAgY29uc3Qgd2lkdGhJblNvdXJjZSA9IHdpZHRoID4+IDM7CiAgY29uc3Qgd2lkdGhSZW1haW5kZXIgPSB3aWR0aCAmIDc7CiAgY29uc3Qgc3JjTGVuZ3RoID0gc3JjLmxlbmd0aDsKICBkZXN0ID0gbmV3IFVpbnQzMkFycmF5KGRlc3QuYnVmZmVyKTsKICBsZXQgZGVzdFBvcyA9IDA7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWlnaHQ7IGkrKykgewogICAgZm9yIChjb25zdCBtYXggPSBzcmNQb3MgKyB3aWR0aEluU291cmNlOyBzcmNQb3MgPCBtYXg7IHNyY1BvcysrKSB7CiAgICAgIGNvbnN0IGVsZW0yID0gc3JjUG9zIDwgc3JjTGVuZ3RoID8gc3JjW3NyY1Bvc10gOiAyNTU7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0yICYgMTI4ID8gb25lTWFwcGluZyA6IHplcm9NYXBwaW5nOwogICAgICBkZXN0W2Rlc3RQb3MrK10gPSBlbGVtMiAmIDY0ID8gb25lTWFwcGluZyA6IHplcm9NYXBwaW5nOwogICAgICBkZXN0W2Rlc3RQb3MrK10gPSBlbGVtMiAmIDMyID8gb25lTWFwcGluZyA6IHplcm9NYXBwaW5nOwogICAgICBkZXN0W2Rlc3RQb3MrK10gPSBlbGVtMiAmIDE2ID8gb25lTWFwcGluZyA6IHplcm9NYXBwaW5nOwogICAgICBkZXN0W2Rlc3RQb3MrK10gPSBlbGVtMiAmIDggPyBvbmVNYXBwaW5nIDogemVyb01hcHBpbmc7CiAgICAgIGRlc3RbZGVzdFBvcysrXSA9IGVsZW0yICYgNCA/IG9uZU1hcHBpbmcgOiB6ZXJvTWFwcGluZzsKICAgICAgZGVzdFtkZXN0UG9zKytdID0gZWxlbTIgJiAyID8gb25lTWFwcGluZyA6IHplcm9NYXBwaW5nOwogICAgICBkZXN0W2Rlc3RQb3MrK10gPSBlbGVtMiAmIDEgPyBvbmVNYXBwaW5nIDogemVyb01hcHBpbmc7CiAgICB9CiAgICBpZiAod2lkdGhSZW1haW5kZXIgPT09IDApIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICBjb25zdCBlbGVtID0gc3JjUG9zIDwgc3JjTGVuZ3RoID8gc3JjW3NyY1BvcysrXSA6IDI1NTsKICAgIGZvciAobGV0IGogPSAwOyBqIDwgd2lkdGhSZW1haW5kZXI7IGorKykgewogICAgICBkZXN0W2Rlc3RQb3MrK10gPSBlbGVtICYgMSA8PCA3IC0gaiA/IG9uZU1hcHBpbmcgOiB6ZXJvTWFwcGluZzsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHNyY1BvcywKICAgIGRlc3RQb3MKICB9Owp9CnZhciBNSU5fRk9OVF9TSVpFID0gMTY7CnZhciBNQVhfRk9OVF9TSVpFID0gMTAwOwp2YXIgRVhFQ1VUSU9OX1RJTUUgPSAxNTsKdmFyIEVYRUNVVElPTl9TVEVQUyA9IDEwOwp2YXIgRlVMTF9DSFVOS19IRUlHSFQgPSAxNjsKdmFyIFNDQUxFX01BVFJJWCA9IG5ldyBET01NYXRyaXgoKTsKdmFyIFhZID0gbmV3IEZsb2F0MzJBcnJheSgyKTsKdmFyIE1JTl9NQVhfSU5JVCA9IG5ldyBGbG9hdDMyQXJyYXkoW0luZmluaXR5LCBJbmZpbml0eSwgLUluZmluaXR5LCAtSW5maW5pdHldKTsKZnVuY3Rpb24gbWlycm9yQ29udGV4dE9wZXJhdGlvbnMoY3R4LCBkZXN0Q3R4KSB7CiAgaWYgKGN0eC5fcmVtb3ZlTWlycm9yaW5nKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbnRleHQgaXMgYWxyZWFkeSBmb3J3YXJkaW5nIG9wZXJhdGlvbnMuIik7CiAgfQogIGN0eC5fX29yaWdpbmFsU2F2ZSA9IGN0eC5zYXZlOwogIGN0eC5fX29yaWdpbmFsUmVzdG9yZSA9IGN0eC5yZXN0b3JlOwogIGN0eC5fX29yaWdpbmFsUm90YXRlID0gY3R4LnJvdGF0ZTsKICBjdHguX19vcmlnaW5hbFNjYWxlID0gY3R4LnNjYWxlOwogIGN0eC5fX29yaWdpbmFsVHJhbnNsYXRlID0gY3R4LnRyYW5zbGF0ZTsKICBjdHguX19vcmlnaW5hbFRyYW5zZm9ybSA9IGN0eC50cmFuc2Zvcm07CiAgY3R4Ll9fb3JpZ2luYWxTZXRUcmFuc2Zvcm0gPSBjdHguc2V0VHJhbnNmb3JtOwogIGN0eC5fX29yaWdpbmFsUmVzZXRUcmFuc2Zvcm0gPSBjdHgucmVzZXRUcmFuc2Zvcm07CiAgY3R4Ll9fb3JpZ2luYWxDbGlwID0gY3R4LmNsaXA7CiAgY3R4Ll9fb3JpZ2luYWxNb3ZlVG8gPSBjdHgubW92ZVRvOwogIGN0eC5fX29yaWdpbmFsTGluZVRvID0gY3R4LmxpbmVUbzsKICBjdHguX19vcmlnaW5hbEJlemllckN1cnZlVG8gPSBjdHguYmV6aWVyQ3VydmVUbzsKICBjdHguX19vcmlnaW5hbFJlY3QgPSBjdHgucmVjdDsKICBjdHguX19vcmlnaW5hbENsb3NlUGF0aCA9IGN0eC5jbG9zZVBhdGg7CiAgY3R4Ll9fb3JpZ2luYWxCZWdpblBhdGggPSBjdHguYmVnaW5QYXRoOwogIGN0eC5fcmVtb3ZlTWlycm9yaW5nID0gKCkgPT4gewogICAgY3R4LnNhdmUgPSBjdHguX19vcmlnaW5hbFNhdmU7CiAgICBjdHgucmVzdG9yZSA9IGN0eC5fX29yaWdpbmFsUmVzdG9yZTsKICAgIGN0eC5yb3RhdGUgPSBjdHguX19vcmlnaW5hbFJvdGF0ZTsKICAgIGN0eC5zY2FsZSA9IGN0eC5fX29yaWdpbmFsU2NhbGU7CiAgICBjdHgudHJhbnNsYXRlID0gY3R4Ll9fb3JpZ2luYWxUcmFuc2xhdGU7CiAgICBjdHgudHJhbnNmb3JtID0gY3R4Ll9fb3JpZ2luYWxUcmFuc2Zvcm07CiAgICBjdHguc2V0VHJhbnNmb3JtID0gY3R4Ll9fb3JpZ2luYWxTZXRUcmFuc2Zvcm07CiAgICBjdHgucmVzZXRUcmFuc2Zvcm0gPSBjdHguX19vcmlnaW5hbFJlc2V0VHJhbnNmb3JtOwogICAgY3R4LmNsaXAgPSBjdHguX19vcmlnaW5hbENsaXA7CiAgICBjdHgubW92ZVRvID0gY3R4Ll9fb3JpZ2luYWxNb3ZlVG87CiAgICBjdHgubGluZVRvID0gY3R4Ll9fb3JpZ2luYWxMaW5lVG87CiAgICBjdHguYmV6aWVyQ3VydmVUbyA9IGN0eC5fX29yaWdpbmFsQmV6aWVyQ3VydmVUbzsKICAgIGN0eC5yZWN0ID0gY3R4Ll9fb3JpZ2luYWxSZWN0OwogICAgY3R4LmNsb3NlUGF0aCA9IGN0eC5fX29yaWdpbmFsQ2xvc2VQYXRoOwogICAgY3R4LmJlZ2luUGF0aCA9IGN0eC5fX29yaWdpbmFsQmVnaW5QYXRoOwogICAgZGVsZXRlIGN0eC5fcmVtb3ZlTWlycm9yaW5nOwogIH07CiAgY3R4LnNhdmUgPSBmdW5jdGlvbigpIHsKICAgIGRlc3RDdHguc2F2ZSgpOwogICAgdGhpcy5fX29yaWdpbmFsU2F2ZSgpOwogIH07CiAgY3R4LnJlc3RvcmUgPSBmdW5jdGlvbigpIHsKICAgIGRlc3RDdHgucmVzdG9yZSgpOwogICAgdGhpcy5fX29yaWdpbmFsUmVzdG9yZSgpOwogIH07CiAgY3R4LnRyYW5zbGF0ZSA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgIGRlc3RDdHgudHJhbnNsYXRlKHgsIHkpOwogICAgdGhpcy5fX29yaWdpbmFsVHJhbnNsYXRlKHgsIHkpOwogIH07CiAgY3R4LnNjYWxlID0gZnVuY3Rpb24oeCwgeSkgewogICAgZGVzdEN0eC5zY2FsZSh4LCB5KTsKICAgIHRoaXMuX19vcmlnaW5hbFNjYWxlKHgsIHkpOwogIH07CiAgY3R4LnRyYW5zZm9ybSA9IGZ1bmN0aW9uKGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgIGRlc3RDdHgudHJhbnNmb3JtKGEsIGIsIGMsIGQsIGUsIGYpOwogICAgdGhpcy5fX29yaWdpbmFsVHJhbnNmb3JtKGEsIGIsIGMsIGQsIGUsIGYpOwogIH07CiAgY3R4LnNldFRyYW5zZm9ybSA9IGZ1bmN0aW9uKGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgIGRlc3RDdHguc2V0VHJhbnNmb3JtKGEsIGIsIGMsIGQsIGUsIGYpOwogICAgdGhpcy5fX29yaWdpbmFsU2V0VHJhbnNmb3JtKGEsIGIsIGMsIGQsIGUsIGYpOwogIH07CiAgY3R4LnJlc2V0VHJhbnNmb3JtID0gZnVuY3Rpb24oKSB7CiAgICBkZXN0Q3R4LnJlc2V0VHJhbnNmb3JtKCk7CiAgICB0aGlzLl9fb3JpZ2luYWxSZXNldFRyYW5zZm9ybSgpOwogIH07CiAgY3R4LnJvdGF0ZSA9IGZ1bmN0aW9uKGFuZ2xlKSB7CiAgICBkZXN0Q3R4LnJvdGF0ZShhbmdsZSk7CiAgICB0aGlzLl9fb3JpZ2luYWxSb3RhdGUoYW5nbGUpOwogIH07CiAgY3R4LmNsaXAgPSBmdW5jdGlvbihydWxlKSB7CiAgICBkZXN0Q3R4LmNsaXAocnVsZSk7CiAgICB0aGlzLl9fb3JpZ2luYWxDbGlwKHJ1bGUpOwogIH07CiAgY3R4Lm1vdmVUbyA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgIGRlc3RDdHgubW92ZVRvKHgsIHkpOwogICAgdGhpcy5fX29yaWdpbmFsTW92ZVRvKHgsIHkpOwogIH07CiAgY3R4LmxpbmVUbyA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgIGRlc3RDdHgubGluZVRvKHgsIHkpOwogICAgdGhpcy5fX29yaWdpbmFsTGluZVRvKHgsIHkpOwogIH07CiAgY3R4LmJlemllckN1cnZlVG8gPSBmdW5jdGlvbihjcDF4LCBjcDF5LCBjcDJ4LCBjcDJ5LCB4LCB5KSB7CiAgICBkZXN0Q3R4LmJlemllckN1cnZlVG8oY3AxeCwgY3AxeSwgY3AyeCwgY3AyeSwgeCwgeSk7CiAgICB0aGlzLl9fb3JpZ2luYWxCZXppZXJDdXJ2ZVRvKGNwMXgsIGNwMXksIGNwMngsIGNwMnksIHgsIHkpOwogIH07CiAgY3R4LnJlY3QgPSBmdW5jdGlvbih4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICBkZXN0Q3R4LnJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CiAgICB0aGlzLl9fb3JpZ2luYWxSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwogIH07CiAgY3R4LmNsb3NlUGF0aCA9IGZ1bmN0aW9uKCkgewogICAgZGVzdEN0eC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX19vcmlnaW5hbENsb3NlUGF0aCgpOwogIH07CiAgY3R4LmJlZ2luUGF0aCA9IGZ1bmN0aW9uKCkgewogICAgZGVzdEN0eC5iZWdpblBhdGgoKTsKICAgIHRoaXMuX19vcmlnaW5hbEJlZ2luUGF0aCgpOwogIH07Cn0KdmFyIENhY2hlZENhbnZhc2VzID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNhbnZhc0ZhY3RvcnkpIHsKICAgIHRoaXMuY2FudmFzRmFjdG9yeSA9IGNhbnZhc0ZhY3Rvcnk7CiAgICB0aGlzLmNhY2hlID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfQogIGdldENhbnZhcyhpZCwgd2lkdGgsIGhlaWdodCkgewogICAgbGV0IGNhbnZhc0VudHJ5OwogICAgaWYgKHRoaXMuY2FjaGVbaWRdICE9PSB2b2lkIDApIHsKICAgICAgY2FudmFzRW50cnkgPSB0aGlzLmNhY2hlW2lkXTsKICAgICAgdGhpcy5jYW52YXNGYWN0b3J5LnJlc2V0KGNhbnZhc0VudHJ5LCB3aWR0aCwgaGVpZ2h0KTsKICAgIH0gZWxzZSB7CiAgICAgIGNhbnZhc0VudHJ5ID0gdGhpcy5jYW52YXNGYWN0b3J5LmNyZWF0ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgdGhpcy5jYWNoZVtpZF0gPSBjYW52YXNFbnRyeTsKICAgIH0KICAgIHJldHVybiBjYW52YXNFbnRyeTsKICB9CiAgZGVsZXRlKGlkKSB7CiAgICBkZWxldGUgdGhpcy5jYWNoZVtpZF07CiAgfQogIGNsZWFyKCkgewogICAgZm9yIChjb25zdCBpZCBpbiB0aGlzLmNhY2hlKSB7CiAgICAgIGNvbnN0IGNhbnZhc0VudHJ5ID0gdGhpcy5jYWNoZVtpZF07CiAgICAgIHRoaXMuY2FudmFzRmFjdG9yeS5kZXN0cm95KGNhbnZhc0VudHJ5KTsKICAgICAgZGVsZXRlIHRoaXMuY2FjaGVbaWRdOwogICAgfQogIH0KfTsKZnVuY3Rpb24gZHJhd0ltYWdlQXRJbnRlZ2VyQ29vcmRzKGN0eCwgc3JjSW1nLCBzcmNYLCBzcmNZLCBzcmNXLCBzcmNILCBkZXN0WCwgZGVzdFksIGRlc3RXLCBkZXN0SCkgewogIGNvbnN0IFthLCBiLCBjLCBkLCB0eCwgdHldID0gZ2V0Q3VycmVudFRyYW5zZm9ybShjdHgpOwogIGlmIChiID09PSAwICYmIGMgPT09IDApIHsKICAgIGNvbnN0IHRsWCA9IGRlc3RYICogYSArIHR4OwogICAgY29uc3QgclRsWCA9IE1hdGgucm91bmQodGxYKTsKICAgIGNvbnN0IHRsWSA9IGRlc3RZICogZCArIHR5OwogICAgY29uc3QgclRsWSA9IE1hdGgucm91bmQodGxZKTsKICAgIGNvbnN0IGJyWCA9IChkZXN0WCArIGRlc3RXKSAqIGEgKyB0eDsKICAgIGNvbnN0IHJXaWR0aCA9IE1hdGguYWJzKE1hdGgucm91bmQoYnJYKSAtIHJUbFgpIHx8IDE7CiAgICBjb25zdCBiclkgPSAoZGVzdFkgKyBkZXN0SCkgKiBkICsgdHk7CiAgICBjb25zdCBySGVpZ2h0ID0gTWF0aC5hYnMoTWF0aC5yb3VuZChiclkpIC0gclRsWSkgfHwgMTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oTWF0aC5zaWduKGEpLCAwLCAwLCBNYXRoLnNpZ24oZCksIHJUbFgsIHJUbFkpOwogICAgY3R4LmRyYXdJbWFnZShzcmNJbWcsIHNyY1gsIHNyY1ksIHNyY1csIHNyY0gsIDAsIDAsIHJXaWR0aCwgckhlaWdodCk7CiAgICBjdHguc2V0VHJhbnNmb3JtKGEsIGIsIGMsIGQsIHR4LCB0eSk7CiAgICByZXR1cm4gW3JXaWR0aCwgckhlaWdodF07CiAgfQogIGlmIChhID09PSAwICYmIGQgPT09IDApIHsKICAgIGNvbnN0IHRsWCA9IGRlc3RZICogYyArIHR4OwogICAgY29uc3QgclRsWCA9IE1hdGgucm91bmQodGxYKTsKICAgIGNvbnN0IHRsWSA9IGRlc3RYICogYiArIHR5OwogICAgY29uc3QgclRsWSA9IE1hdGgucm91bmQodGxZKTsKICAgIGNvbnN0IGJyWCA9IChkZXN0WSArIGRlc3RIKSAqIGMgKyB0eDsKICAgIGNvbnN0IHJXaWR0aCA9IE1hdGguYWJzKE1hdGgucm91bmQoYnJYKSAtIHJUbFgpIHx8IDE7CiAgICBjb25zdCBiclkgPSAoZGVzdFggKyBkZXN0VykgKiBiICsgdHk7CiAgICBjb25zdCBySGVpZ2h0ID0gTWF0aC5hYnMoTWF0aC5yb3VuZChiclkpIC0gclRsWSkgfHwgMTsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oMCwgTWF0aC5zaWduKGIpLCBNYXRoLnNpZ24oYyksIDAsIHJUbFgsIHJUbFkpOwogICAgY3R4LmRyYXdJbWFnZShzcmNJbWcsIHNyY1gsIHNyY1ksIHNyY1csIHNyY0gsIDAsIDAsIHJIZWlnaHQsIHJXaWR0aCk7CiAgICBjdHguc2V0VHJhbnNmb3JtKGEsIGIsIGMsIGQsIHR4LCB0eSk7CiAgICByZXR1cm4gW3JIZWlnaHQsIHJXaWR0aF07CiAgfQogIGN0eC5kcmF3SW1hZ2Uoc3JjSW1nLCBzcmNYLCBzcmNZLCBzcmNXLCBzcmNILCBkZXN0WCwgZGVzdFksIGRlc3RXLCBkZXN0SCk7CiAgY29uc3Qgc2NhbGVYID0gTWF0aC5oeXBvdChhLCBiKTsKICBjb25zdCBzY2FsZVkgPSBNYXRoLmh5cG90KGMsIGQpOwogIHJldHVybiBbc2NhbGVYICogZGVzdFcsIHNjYWxlWSAqIGRlc3RIXTsKfQp2YXIgQ2FudmFzRXh0cmFTdGF0ZSA9IGNsYXNzIHsKICBhbHBoYUlzU2hhcGUgPSBmYWxzZTsKICBmb250U2l6ZSA9IDA7CiAgZm9udFNpemVTY2FsZSA9IDE7CiAgdGV4dE1hdHJpeCA9IG51bGw7CiAgdGV4dE1hdHJpeFNjYWxlID0gMTsKICBmb250TWF0cml4ID0gRk9OVF9JREVOVElUWV9NQVRSSVg7CiAgbGVhZGluZyA9IDA7CiAgeCA9IDA7CiAgeSA9IDA7CiAgbGluZVggPSAwOwogIGxpbmVZID0gMDsKICBjaGFyU3BhY2luZyA9IDA7CiAgd29yZFNwYWNpbmcgPSAwOwogIHRleHRIU2NhbGUgPSAxOwogIHRleHRSZW5kZXJpbmdNb2RlID0gVGV4dFJlbmRlcmluZ01vZGUuRklMTDsKICB0ZXh0UmlzZSA9IDA7CiAgZmlsbENvbG9yID0gIiMwMDAwMDAiOwogIHN0cm9rZUNvbG9yID0gIiMwMDAwMDAiOwogIHBhdHRlcm5GaWxsID0gZmFsc2U7CiAgcGF0dGVyblN0cm9rZSA9IGZhbHNlOwogIGZpbGxBbHBoYSA9IDE7CiAgc3Ryb2tlQWxwaGEgPSAxOwogIGxpbmVXaWR0aCA9IDE7CiAgYWN0aXZlU01hc2sgPSBudWxsOwogIHRyYW5zZmVyTWFwcyA9ICJub25lIjsKICBjb25zdHJ1Y3Rvcih3aWR0aCwgaGVpZ2h0LCBwcmVJbml0KSB7CiAgICBwcmVJbml0Py4odGhpcyk7CiAgICB0aGlzLmNsaXBCb3ggPSBuZXcgRmxvYXQzMkFycmF5KFswLCAwLCB3aWR0aCwgaGVpZ2h0XSk7CiAgICB0aGlzLm1pbk1heCA9IE1JTl9NQVhfSU5JVC5zbGljZSgpOwogIH0KICBjbG9uZSgpIHsKICAgIGNvbnN0IGNsb25lID0gT2JqZWN0LmNyZWF0ZSh0aGlzKTsKICAgIGNsb25lLmNsaXBCb3ggPSB0aGlzLmNsaXBCb3guc2xpY2UoKTsKICAgIGNsb25lLm1pbk1heCA9IHRoaXMubWluTWF4LnNsaWNlKCk7CiAgICByZXR1cm4gY2xvbmU7CiAgfQogIGdldFBhdGhCb3VuZGluZ0JveChwYXRoVHlwZSA9IFBhdGhUeXBlLkZJTEwsIHRyYW5zZm9ybSA9IG51bGwpIHsKICAgIGNvbnN0IGJveCA9IHRoaXMubWluTWF4LnNsaWNlKCk7CiAgICBpZiAocGF0aFR5cGUgPT09IFBhdGhUeXBlLlNUUk9LRSkgewogICAgICBpZiAoIXRyYW5zZm9ybSkgewogICAgICAgIHVucmVhY2hhYmxlKCJTdHJva2UgYm91bmRpbmcgYm94IG11c3QgaW5jbHVkZSB0cmFuc2Zvcm0uIik7CiAgICAgIH0KICAgICAgVXRpbC5zaW5ndWxhclZhbHVlRGVjb21wb3NlMmRTY2FsZSh0cmFuc2Zvcm0sIFhZKTsKICAgICAgY29uc3QgeFN0cm9rZVBhZCA9IFhZWzBdICogdGhpcy5saW5lV2lkdGggLyAyOwogICAgICBjb25zdCB5U3Ryb2tlUGFkID0gWFlbMV0gKiB0aGlzLmxpbmVXaWR0aCAvIDI7CiAgICAgIGJveFswXSAtPSB4U3Ryb2tlUGFkOwogICAgICBib3hbMV0gLT0geVN0cm9rZVBhZDsKICAgICAgYm94WzJdICs9IHhTdHJva2VQYWQ7CiAgICAgIGJveFszXSArPSB5U3Ryb2tlUGFkOwogICAgfQogICAgcmV0dXJuIGJveDsKICB9CiAgdXBkYXRlQ2xpcEZyb21QYXRoKCkgewogICAgY29uc3QgaW50ZXJzZWN0ID0gVXRpbC5pbnRlcnNlY3QodGhpcy5jbGlwQm94LCB0aGlzLmdldFBhdGhCb3VuZGluZ0JveCgpKTsKICAgIHRoaXMuc3RhcnROZXdQYXRoQW5kQ2xpcEJveChpbnRlcnNlY3QgfHwgWzAsIDAsIDAsIDBdKTsKICB9CiAgaXNFbXB0eUNsaXAoKSB7CiAgICByZXR1cm4gdGhpcy5taW5NYXhbMF0gPT09IEluZmluaXR5OwogIH0KICBzdGFydE5ld1BhdGhBbmRDbGlwQm94KGJveCkgewogICAgdGhpcy5jbGlwQm94LnNldChib3gsIDApOwogICAgdGhpcy5taW5NYXguc2V0KE1JTl9NQVhfSU5JVCwgMCk7CiAgfQogIGdldENsaXBwZWRQYXRoQm91bmRpbmdCb3gocGF0aFR5cGUgPSBQYXRoVHlwZS5GSUxMLCB0cmFuc2Zvcm0gPSBudWxsKSB7CiAgICByZXR1cm4gVXRpbC5pbnRlcnNlY3QodGhpcy5jbGlwQm94LCB0aGlzLmdldFBhdGhCb3VuZGluZ0JveChwYXRoVHlwZSwgdHJhbnNmb3JtKSk7CiAgfQp9OwpmdW5jdGlvbiBwdXRCaW5hcnlJbWFnZURhdGEoY3R4LCBpbWdEYXRhKSB7CiAgaWYgKGltZ0RhdGEgaW5zdGFuY2VvZiBJbWFnZURhdGEpIHsKICAgIGN0eC5wdXRJbWFnZURhdGEoaW1nRGF0YSwgMCwgMCk7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IGhlaWdodCA9IGltZ0RhdGEuaGVpZ2h0LCB3aWR0aCA9IGltZ0RhdGEud2lkdGg7CiAgY29uc3QgcGFydGlhbENodW5rSGVpZ2h0ID0gaGVpZ2h0ICUgRlVMTF9DSFVOS19IRUlHSFQ7CiAgY29uc3QgZnVsbENodW5rcyA9IChoZWlnaHQgLSBwYXJ0aWFsQ2h1bmtIZWlnaHQpIC8gRlVMTF9DSFVOS19IRUlHSFQ7CiAgY29uc3QgdG90YWxDaHVua3MgPSBwYXJ0aWFsQ2h1bmtIZWlnaHQgPT09IDAgPyBmdWxsQ2h1bmtzIDogZnVsbENodW5rcyArIDE7CiAgY29uc3QgY2h1bmtJbWdEYXRhID0gY3R4LmNyZWF0ZUltYWdlRGF0YSh3aWR0aCwgRlVMTF9DSFVOS19IRUlHSFQpOwogIGxldCBzcmNQb3MgPSAwLCBkZXN0UG9zOwogIGNvbnN0IHNyYyA9IGltZ0RhdGEuZGF0YTsKICBjb25zdCBkZXN0ID0gY2h1bmtJbWdEYXRhLmRhdGE7CiAgbGV0IGksIGosIHRoaXNDaHVua0hlaWdodCwgZWxlbXNJblRoaXNDaHVuazsKICBpZiAoaW1nRGF0YS5raW5kID09PSB1dGlsX0ltYWdlS2luZC5HUkFZU0NBTEVfMUJQUCkgewogICAgY29uc3Qgc3JjTGVuZ3RoID0gc3JjLmJ5dGVMZW5ndGg7CiAgICBjb25zdCBkZXN0MzIgPSBuZXcgVWludDMyQXJyYXkoZGVzdC5idWZmZXIsIDAsIGRlc3QuYnl0ZUxlbmd0aCA+PiAyKTsKICAgIGNvbnN0IGRlc3QzMkRhdGFMZW5ndGggPSBkZXN0MzIubGVuZ3RoOwogICAgY29uc3QgZnVsbFNyY0RpZmYgPSB3aWR0aCArIDcgPj4gMzsKICAgIGNvbnN0IHdoaXRlID0gNDI5NDk2NzI5NTsKICAgIGNvbnN0IGJsYWNrID0gdXRpbF9GZWF0dXJlVGVzdC5pc0xpdHRsZUVuZGlhbiA/IDQyNzgxOTAwODAgOiAyNTU7CiAgICBmb3IgKGkgPSAwOyBpIDwgdG90YWxDaHVua3M7IGkrKykgewogICAgICB0aGlzQ2h1bmtIZWlnaHQgPSBpIDwgZnVsbENodW5rcyA/IEZVTExfQ0hVTktfSEVJR0hUIDogcGFydGlhbENodW5rSGVpZ2h0OwogICAgICBkZXN0UG9zID0gMDsKICAgICAgZm9yIChqID0gMDsgaiA8IHRoaXNDaHVua0hlaWdodDsgaisrKSB7CiAgICAgICAgY29uc3Qgc3JjRGlmZiA9IHNyY0xlbmd0aCAtIHNyY1BvczsKICAgICAgICBsZXQgayA9IDA7CiAgICAgICAgY29uc3Qga0VuZCA9IHNyY0RpZmYgPiBmdWxsU3JjRGlmZiA/IHdpZHRoIDogc3JjRGlmZiAqIDggLSA3OwogICAgICAgIGNvbnN0IGtFbmRVbnJvbGxlZCA9IGtFbmQgJiB+NzsKICAgICAgICBsZXQgbWFzayA9IDA7CiAgICAgICAgbGV0IHNyY0J5dGUgPSAwOwogICAgICAgIGZvciAoOyBrIDwga0VuZFVucm9sbGVkOyBrICs9IDgpIHsKICAgICAgICAgIHNyY0J5dGUgPSBzcmNbc3JjUG9zKytdOwogICAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSBzcmNCeXRlICYgMTI4ID8gd2hpdGUgOiBibGFjazsKICAgICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gc3JjQnl0ZSAmIDY0ID8gd2hpdGUgOiBibGFjazsKICAgICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gc3JjQnl0ZSAmIDMyID8gd2hpdGUgOiBibGFjazsKICAgICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gc3JjQnl0ZSAmIDE2ID8gd2hpdGUgOiBibGFjazsKICAgICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gc3JjQnl0ZSAmIDggPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgICAgZGVzdDMyW2Rlc3RQb3MrK10gPSBzcmNCeXRlICYgNCA/IHdoaXRlIDogYmxhY2s7CiAgICAgICAgICBkZXN0MzJbZGVzdFBvcysrXSA9IHNyY0J5dGUgJiAyID8gd2hpdGUgOiBibGFjazsKICAgICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gc3JjQnl0ZSAmIDEgPyB3aGl0ZSA6IGJsYWNrOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgayA8IGtFbmQ7IGsrKykgewogICAgICAgICAgaWYgKG1hc2sgPT09IDApIHsKICAgICAgICAgICAgc3JjQnl0ZSA9IHNyY1tzcmNQb3MrK107CiAgICAgICAgICAgIG1hc2sgPSAxMjg7CiAgICAgICAgICB9CiAgICAgICAgICBkZXN0MzJbZGVzdFBvcysrXSA9IHNyY0J5dGUgJiBtYXNrID8gd2hpdGUgOiBibGFjazsKICAgICAgICAgIG1hc2sgPj49IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHdoaWxlIChkZXN0UG9zIDwgZGVzdDMyRGF0YUxlbmd0aCkgewogICAgICAgIGRlc3QzMltkZXN0UG9zKytdID0gMDsKICAgICAgfQogICAgICBjdHgucHV0SW1hZ2VEYXRhKGNodW5rSW1nRGF0YSwgMCwgaSAqIEZVTExfQ0hVTktfSEVJR0hUKTsKICAgIH0KICB9IGVsc2UgaWYgKGltZ0RhdGEua2luZCA9PT0gdXRpbF9JbWFnZUtpbmQuUkdCQV8zMkJQUCkgewogICAgaiA9IDA7CiAgICBlbGVtc0luVGhpc0NodW5rID0gd2lkdGggKiBGVUxMX0NIVU5LX0hFSUdIVCAqIDQ7CiAgICBmb3IgKGkgPSAwOyBpIDwgZnVsbENodW5rczsgaSsrKSB7CiAgICAgIGRlc3Quc2V0KHNyYy5zdWJhcnJheShzcmNQb3MsIHNyY1BvcyArIGVsZW1zSW5UaGlzQ2h1bmspKTsKICAgICAgc3JjUG9zICs9IGVsZW1zSW5UaGlzQ2h1bms7CiAgICAgIGN0eC5wdXRJbWFnZURhdGEoY2h1bmtJbWdEYXRhLCAwLCBqKTsKICAgICAgaiArPSBGVUxMX0NIVU5LX0hFSUdIVDsKICAgIH0KICAgIGlmIChpIDwgdG90YWxDaHVua3MpIHsKICAgICAgZWxlbXNJblRoaXNDaHVuayA9IHdpZHRoICogcGFydGlhbENodW5rSGVpZ2h0ICogNDsKICAgICAgZGVzdC5zZXQoc3JjLnN1YmFycmF5KHNyY1Bvcywgc3JjUG9zICsgZWxlbXNJblRoaXNDaHVuaykpOwogICAgICBjdHgucHV0SW1hZ2VEYXRhKGNodW5rSW1nRGF0YSwgMCwgaik7CiAgICB9CiAgfSBlbHNlIGlmIChpbWdEYXRhLmtpbmQgPT09IHV0aWxfSW1hZ2VLaW5kLlJHQl8yNEJQUCkgewogICAgdGhpc0NodW5rSGVpZ2h0ID0gRlVMTF9DSFVOS19IRUlHSFQ7CiAgICBlbGVtc0luVGhpc0NodW5rID0gd2lkdGggKiB0aGlzQ2h1bmtIZWlnaHQ7CiAgICBmb3IgKGkgPSAwOyBpIDwgdG90YWxDaHVua3M7IGkrKykgewogICAgICBpZiAoaSA+PSBmdWxsQ2h1bmtzKSB7CiAgICAgICAgdGhpc0NodW5rSGVpZ2h0ID0gcGFydGlhbENodW5rSGVpZ2h0OwogICAgICAgIGVsZW1zSW5UaGlzQ2h1bmsgPSB3aWR0aCAqIHRoaXNDaHVua0hlaWdodDsKICAgICAgfQogICAgICBkZXN0UG9zID0gMDsKICAgICAgZm9yIChqID0gZWxlbXNJblRoaXNDaHVuazsgai0tOyApIHsKICAgICAgICBkZXN0W2Rlc3RQb3MrK10gPSBzcmNbc3JjUG9zKytdOwogICAgICAgIGRlc3RbZGVzdFBvcysrXSA9IHNyY1tzcmNQb3MrK107CiAgICAgICAgZGVzdFtkZXN0UG9zKytdID0gc3JjW3NyY1BvcysrXTsKICAgICAgICBkZXN0W2Rlc3RQb3MrK10gPSAyNTU7CiAgICAgIH0KICAgICAgY3R4LnB1dEltYWdlRGF0YShjaHVua0ltZ0RhdGEsIDAsIGkgKiBGVUxMX0NIVU5LX0hFSUdIVCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihgYmFkIGltYWdlIGtpbmQ6ICR7aW1nRGF0YS5raW5kfWApOwogIH0KfQpmdW5jdGlvbiBwdXRCaW5hcnlJbWFnZU1hc2soY3R4LCBpbWdEYXRhKSB7CiAgaWYgKGltZ0RhdGEuYml0bWFwKSB7CiAgICBjdHguZHJhd0ltYWdlKGltZ0RhdGEuYml0bWFwLCAwLCAwKTsKICAgIHJldHVybjsKICB9CiAgY29uc3QgaGVpZ2h0ID0gaW1nRGF0YS5oZWlnaHQsIHdpZHRoID0gaW1nRGF0YS53aWR0aDsKICBjb25zdCBwYXJ0aWFsQ2h1bmtIZWlnaHQgPSBoZWlnaHQgJSBGVUxMX0NIVU5LX0hFSUdIVDsKICBjb25zdCBmdWxsQ2h1bmtzID0gKGhlaWdodCAtIHBhcnRpYWxDaHVua0hlaWdodCkgLyBGVUxMX0NIVU5LX0hFSUdIVDsKICBjb25zdCB0b3RhbENodW5rcyA9IHBhcnRpYWxDaHVua0hlaWdodCA9PT0gMCA/IGZ1bGxDaHVua3MgOiBmdWxsQ2h1bmtzICsgMTsKICBjb25zdCBjaHVua0ltZ0RhdGEgPSBjdHguY3JlYXRlSW1hZ2VEYXRhKHdpZHRoLCBGVUxMX0NIVU5LX0hFSUdIVCk7CiAgbGV0IHNyY1BvcyA9IDA7CiAgY29uc3Qgc3JjID0gaW1nRGF0YS5kYXRhOwogIGNvbnN0IGRlc3QgPSBjaHVua0ltZ0RhdGEuZGF0YTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRvdGFsQ2h1bmtzOyBpKyspIHsKICAgIGNvbnN0IHRoaXNDaHVua0hlaWdodCA9IGkgPCBmdWxsQ2h1bmtzID8gRlVMTF9DSFVOS19IRUlHSFQgOiBwYXJ0aWFsQ2h1bmtIZWlnaHQ7CiAgICAoewogICAgICBzcmNQb3MKICAgIH0gPSBjb252ZXJ0QmxhY2tBbmRXaGl0ZVRvUkdCQSh7CiAgICAgIHNyYywKICAgICAgc3JjUG9zLAogICAgICBkZXN0LAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0OiB0aGlzQ2h1bmtIZWlnaHQsCiAgICAgIG5vbkJsYWNrQ29sb3I6IDAKICAgIH0pKTsKICAgIGN0eC5wdXRJbWFnZURhdGEoY2h1bmtJbWdEYXRhLCAwLCBpICogRlVMTF9DSFVOS19IRUlHSFQpOwogIH0KfQpmdW5jdGlvbiBjb3B5Q3R4U3RhdGUoc291cmNlQ3R4LCBkZXN0Q3R4KSB7CiAgY29uc3QgcHJvcGVydGllcyA9IFsic3Ryb2tlU3R5bGUiLCAiZmlsbFN0eWxlIiwgImZpbGxSdWxlIiwgImdsb2JhbEFscGhhIiwgImxpbmVXaWR0aCIsICJsaW5lQ2FwIiwgImxpbmVKb2luIiwgIm1pdGVyTGltaXQiLCAiZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uIiwgImZvbnQiLCAiZmlsdGVyIl07CiAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBwcm9wZXJ0aWVzKSB7CiAgICBpZiAoc291cmNlQ3R4W3Byb3BlcnR5XSAhPT0gdm9pZCAwKSB7CiAgICAgIGRlc3RDdHhbcHJvcGVydHldID0gc291cmNlQ3R4W3Byb3BlcnR5XTsKICAgIH0KICB9CiAgaWYgKHNvdXJjZUN0eC5zZXRMaW5lRGFzaCAhPT0gdm9pZCAwKSB7CiAgICBkZXN0Q3R4LnNldExpbmVEYXNoKHNvdXJjZUN0eC5nZXRMaW5lRGFzaCgpKTsKICAgIGRlc3RDdHgubGluZURhc2hPZmZzZXQgPSBzb3VyY2VDdHgubGluZURhc2hPZmZzZXQ7CiAgfQp9CmZ1bmN0aW9uIHJlc2V0Q3R4VG9EZWZhdWx0KGN0eCkgewogIGN0eC5zdHJva2VTdHlsZSA9IGN0eC5maWxsU3R5bGUgPSAiIzAwMDAwMCI7CiAgY3R4LmZpbGxSdWxlID0gIm5vbnplcm8iOwogIGN0eC5nbG9iYWxBbHBoYSA9IDE7CiAgY3R4LmxpbmVXaWR0aCA9IDE7CiAgY3R4LmxpbmVDYXAgPSAiYnV0dCI7CiAgY3R4LmxpbmVKb2luID0gIm1pdGVyIjsKICBjdHgubWl0ZXJMaW1pdCA9IDEwOwogIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAic291cmNlLW92ZXIiOwogIGN0eC5mb250ID0gIjEwcHggc2Fucy1zZXJpZiI7CiAgaWYgKGN0eC5zZXRMaW5lRGFzaCAhPT0gdm9pZCAwKSB7CiAgICBjdHguc2V0TGluZURhc2goW10pOwogICAgY3R4LmxpbmVEYXNoT2Zmc2V0ID0gMDsKICB9CiAgY29uc3QgewogICAgZmlsdGVyCiAgfSA9IGN0eDsKICBpZiAoZmlsdGVyICE9PSAibm9uZSIgJiYgZmlsdGVyICE9PSAiIikgewogICAgY3R4LmZpbHRlciA9ICJub25lIjsKICB9Cn0KZnVuY3Rpb24gZ2V0SW1hZ2VTbW9vdGhpbmdFbmFibGVkKHRyYW5zZm9ybSwgaW50ZXJwb2xhdGUpIHsKICBpZiAoaW50ZXJwb2xhdGUpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBVdGlsLnNpbmd1bGFyVmFsdWVEZWNvbXBvc2UyZFNjYWxlKHRyYW5zZm9ybSwgWFkpOwogIGNvbnN0IGFjdHVhbFNjYWxlID0gTWF0aC5mcm91bmQoT3V0cHV0U2NhbGUucGl4ZWxSYXRpbyAqIFBpeGVsc1BlckluY2guUERGX1RPX0NTU19VTklUUyk7CiAgcmV0dXJuIFhZWzBdIDw9IGFjdHVhbFNjYWxlICYmIFhZWzFdIDw9IGFjdHVhbFNjYWxlOwp9CnZhciBMSU5FX0NBUF9TVFlMRVMgPSBbImJ1dHQiLCAicm91bmQiLCAic3F1YXJlIl07CnZhciBMSU5FX0pPSU5fU1RZTEVTID0gWyJtaXRlciIsICJyb3VuZCIsICJiZXZlbCJdOwp2YXIgTk9STUFMX0NMSVAgPSB7fTsKdmFyIEVPX0NMSVAgPSB7fTsKdmFyIENhbnZhc0dyYXBoaWNzID0gY2xhc3MgX0NhbnZhc0dyYXBoaWNzIHsKICBjb25zdHJ1Y3RvcihjYW52YXNDdHgsIGNvbW1vbk9ianMsIG9ianMsIGNhbnZhc0ZhY3RvcnksIGZpbHRlckZhY3RvcnksIHsKICAgIG9wdGlvbmFsQ29udGVudENvbmZpZywKICAgIG1hcmtlZENvbnRlbnRTdGFjayA9IG51bGwKICB9LCBhbm5vdGF0aW9uQ2FudmFzTWFwLCBwYWdlQ29sb3JzLCBkZXBlbmRlbmN5VHJhY2tlcikgewogICAgdGhpcy5jdHggPSBjYW52YXNDdHg7CiAgICB0aGlzLmN1cnJlbnQgPSBuZXcgQ2FudmFzRXh0cmFTdGF0ZSh0aGlzLmN0eC5jYW52YXMud2lkdGgsIHRoaXMuY3R4LmNhbnZhcy5oZWlnaHQpOwogICAgdGhpcy5zdGF0ZVN0YWNrID0gW107CiAgICB0aGlzLnBlbmRpbmdDbGlwID0gbnVsbDsKICAgIHRoaXMucGVuZGluZ0VPRmlsbCA9IGZhbHNlOwogICAgdGhpcy5yZXMgPSBudWxsOwogICAgdGhpcy54b2JqcyA9IG51bGw7CiAgICB0aGlzLmNvbW1vbk9ianMgPSBjb21tb25PYmpzOwogICAgdGhpcy5vYmpzID0gb2JqczsKICAgIHRoaXMuY2FudmFzRmFjdG9yeSA9IGNhbnZhc0ZhY3Rvcnk7CiAgICB0aGlzLmZpbHRlckZhY3RvcnkgPSBmaWx0ZXJGYWN0b3J5OwogICAgdGhpcy5ncm91cFN0YWNrID0gW107CiAgICB0aGlzLmJhc2VUcmFuc2Zvcm0gPSBudWxsOwogICAgdGhpcy5iYXNlVHJhbnNmb3JtU3RhY2sgPSBbXTsKICAgIHRoaXMuZ3JvdXBMZXZlbCA9IDA7CiAgICB0aGlzLnNtYXNrU3RhY2sgPSBbXTsKICAgIHRoaXMuc21hc2tDb3VudGVyID0gMDsKICAgIHRoaXMudGVtcFNNYXNrID0gbnVsbDsKICAgIHRoaXMuc3VzcGVuZGVkQ3R4ID0gbnVsbDsKICAgIHRoaXMuY29udGVudFZpc2libGUgPSB0cnVlOwogICAgdGhpcy5tYXJrZWRDb250ZW50U3RhY2sgPSBtYXJrZWRDb250ZW50U3RhY2sgfHwgW107CiAgICB0aGlzLm9wdGlvbmFsQ29udGVudENvbmZpZyA9IG9wdGlvbmFsQ29udGVudENvbmZpZzsKICAgIHRoaXMuY2FjaGVkQ2FudmFzZXMgPSBuZXcgQ2FjaGVkQ2FudmFzZXModGhpcy5jYW52YXNGYWN0b3J5KTsKICAgIHRoaXMuY2FjaGVkUGF0dGVybnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5hbm5vdGF0aW9uQ2FudmFzTWFwID0gYW5ub3RhdGlvbkNhbnZhc01hcDsKICAgIHRoaXMudmlld3BvcnRTY2FsZSA9IDE7CiAgICB0aGlzLm91dHB1dFNjYWxlWCA9IDE7CiAgICB0aGlzLm91dHB1dFNjYWxlWSA9IDE7CiAgICB0aGlzLnBhZ2VDb2xvcnMgPSBwYWdlQ29sb3JzOwogICAgdGhpcy5fY2FjaGVkU2NhbGVGb3JTdHJva2luZyA9IFstMSwgMF07CiAgICB0aGlzLl9jYWNoZWRHZXRTaW5nbGVQaXhlbFdpZHRoID0gbnVsbDsKICAgIHRoaXMuX2NhY2hlZEJpdG1hcHNNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlciA9IGRlcGVuZGVuY3lUcmFja2VyID8/IG51bGw7CiAgfQogIGdldE9iamVjdChvcElkeCwgZGF0YSwgZmFsbGJhY2sgPSBudWxsKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICJzdHJpbmciKSB7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE5hbWVkRGVwZW5kZW5jeShvcElkeCwgZGF0YSk7CiAgICAgIHJldHVybiBkYXRhLnN0YXJ0c1dpdGgoImdfIikgPyB0aGlzLmNvbW1vbk9ianMuZ2V0KGRhdGEpIDogdGhpcy5vYmpzLmdldChkYXRhKTsKICAgIH0KICAgIHJldHVybiBmYWxsYmFjazsKICB9CiAgYmVnaW5EcmF3aW5nKHsKICAgIHRyYW5zZm9ybSwKICAgIHZpZXdwb3J0LAogICAgdHJhbnNwYXJlbmN5ID0gZmFsc2UsCiAgICBiYWNrZ3JvdW5kID0gbnVsbAogIH0pIHsKICAgIGNvbnN0IHdpZHRoID0gdGhpcy5jdHguY2FudmFzLndpZHRoOwogICAgY29uc3QgaGVpZ2h0ID0gdGhpcy5jdHguY2FudmFzLmhlaWdodDsKICAgIGNvbnN0IHNhdmVkRmlsbFN0eWxlID0gdGhpcy5jdHguZmlsbFN0eWxlOwogICAgdGhpcy5jdHguZmlsbFN0eWxlID0gYmFja2dyb3VuZCB8fCAiI2ZmZmZmZiI7CiAgICB0aGlzLmN0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKICAgIHRoaXMuY3R4LmZpbGxTdHlsZSA9IHNhdmVkRmlsbFN0eWxlOwogICAgaWYgKHRyYW5zcGFyZW5jeSkgewogICAgICBjb25zdCB0cmFuc3BhcmVudENhbnZhcyA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJ0cmFuc3BhcmVudCIsIHdpZHRoLCBoZWlnaHQpOwogICAgICB0aGlzLmNvbXBvc2l0ZUN0eCA9IHRoaXMuY3R4OwogICAgICB0aGlzLnRyYW5zcGFyZW50Q2FudmFzID0gdHJhbnNwYXJlbnRDYW52YXMuY2FudmFzOwogICAgICB0aGlzLmN0eCA9IHRyYW5zcGFyZW50Q2FudmFzLmNvbnRleHQ7CiAgICAgIHRoaXMuY3R4LnNhdmUoKTsKICAgICAgdGhpcy5jdHgudHJhbnNmb3JtKC4uLmdldEN1cnJlbnRUcmFuc2Zvcm0odGhpcy5jb21wb3NpdGVDdHgpKTsKICAgIH0KICAgIHRoaXMuY3R4LnNhdmUoKTsKICAgIHJlc2V0Q3R4VG9EZWZhdWx0KHRoaXMuY3R4KTsKICAgIGlmICh0cmFuc2Zvcm0pIHsKICAgICAgdGhpcy5jdHgudHJhbnNmb3JtKC4uLnRyYW5zZm9ybSk7CiAgICAgIHRoaXMub3V0cHV0U2NhbGVYID0gdHJhbnNmb3JtWzBdOwogICAgICB0aGlzLm91dHB1dFNjYWxlWSA9IHRyYW5zZm9ybVswXTsKICAgIH0KICAgIHRoaXMuY3R4LnRyYW5zZm9ybSguLi52aWV3cG9ydC50cmFuc2Zvcm0pOwogICAgdGhpcy52aWV3cG9ydFNjYWxlID0gdmlld3BvcnQuc2NhbGU7CiAgICB0aGlzLmJhc2VUcmFuc2Zvcm0gPSBnZXRDdXJyZW50VHJhbnNmb3JtKHRoaXMuY3R4KTsKICB9CiAgZXhlY3V0ZU9wZXJhdG9yTGlzdChvcGVyYXRvckxpc3QsIGV4ZWN1dGlvblN0YXJ0SWR4LCBjb250aW51ZUNhbGxiYWNrLCBzdGVwcGVyLCBvcGVyYXRpb25zRmlsdGVyKSB7CiAgICBjb25zdCBhcmdzQXJyYXkgPSBvcGVyYXRvckxpc3QuYXJnc0FycmF5OwogICAgY29uc3QgZm5BcnJheSA9IG9wZXJhdG9yTGlzdC5mbkFycmF5OwogICAgbGV0IGkgPSBleGVjdXRpb25TdGFydElkeCB8fCAwOwogICAgY29uc3QgYXJnc0FycmF5TGVuID0gYXJnc0FycmF5Lmxlbmd0aDsKICAgIGlmIChhcmdzQXJyYXlMZW4gPT09IGkpIHsKICAgICAgcmV0dXJuIGk7CiAgICB9CiAgICBjb25zdCBjaHVua09wZXJhdGlvbnMgPSBhcmdzQXJyYXlMZW4gLSBpID4gRVhFQ1VUSU9OX1NURVBTICYmIHR5cGVvZiBjb250aW51ZUNhbGxiYWNrID09PSAiZnVuY3Rpb24iOwogICAgY29uc3QgZW5kVGltZSA9IGNodW5rT3BlcmF0aW9ucyA/IERhdGUubm93KCkgKyBFWEVDVVRJT05fVElNRSA6IDA7CiAgICBsZXQgc3RlcHMgPSAwOwogICAgY29uc3QgY29tbW9uT2JqcyA9IHRoaXMuY29tbW9uT2JqczsKICAgIGNvbnN0IG9ianMgPSB0aGlzLm9ianM7CiAgICBsZXQgZm5JZCwgZm5BcmdzOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgaWYgKHN0ZXBwZXIgIT09IHZvaWQgMCAmJiBpID09PSBzdGVwcGVyLm5leHRCcmVha1BvaW50KSB7CiAgICAgICAgc3RlcHBlci5icmVha0l0KGksIGNvbnRpbnVlQ2FsbGJhY2spOwogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICAgIGlmICghb3BlcmF0aW9uc0ZpbHRlciB8fCBvcGVyYXRpb25zRmlsdGVyKGkpKSB7CiAgICAgICAgZm5JZCA9IGZuQXJyYXlbaV07CiAgICAgICAgZm5BcmdzID0gYXJnc0FycmF5W2ldID8/IG51bGw7CiAgICAgICAgaWYgKGZuSWQgIT09IE9QUy5kZXBlbmRlbmN5KSB7CiAgICAgICAgICBpZiAoZm5BcmdzID09PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXNbZm5JZF0oaSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzW2ZuSWRdKGksIC4uLmZuQXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoY29uc3QgZGVwT2JqSWQgb2YgZm5BcmdzKSB7CiAgICAgICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE5hbWVkRGF0YShkZXBPYmpJZCwgaSk7CiAgICAgICAgICAgIGNvbnN0IG9ianNQb29sID0gZGVwT2JqSWQuc3RhcnRzV2l0aCgiZ18iKSA/IGNvbW1vbk9ianMgOiBvYmpzOwogICAgICAgICAgICBpZiAoIW9ianNQb29sLmhhcyhkZXBPYmpJZCkpIHsKICAgICAgICAgICAgICBvYmpzUG9vbC5nZXQoZGVwT2JqSWQsIGNvbnRpbnVlQ2FsbGJhY2spOwogICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGkrKzsKICAgICAgaWYgKGkgPT09IGFyZ3NBcnJheUxlbikgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICAgIGlmIChjaHVua09wZXJhdGlvbnMgJiYgKytzdGVwcyA+IEVYRUNVVElPTl9TVEVQUykgewogICAgICAgIGlmIChEYXRlLm5vdygpID4gZW5kVGltZSkgewogICAgICAgICAgY29udGludWVDYWxsYmFjaygpOwogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICAgIHN0ZXBzID0gMDsKICAgICAgfQogICAgfQogIH0KICAjcmVzdG9yZUluaXRpYWxTdGF0ZSgpIHsKICAgIHdoaWxlICh0aGlzLnN0YXRlU3RhY2subGVuZ3RoIHx8IHRoaXMuaW5TTWFza01vZGUpIHsKICAgICAgdGhpcy5yZXN0b3JlKCk7CiAgICB9CiAgICB0aGlzLmN1cnJlbnQuYWN0aXZlU01hc2sgPSBudWxsOwogICAgdGhpcy5jdHgucmVzdG9yZSgpOwogICAgaWYgKHRoaXMudHJhbnNwYXJlbnRDYW52YXMpIHsKICAgICAgdGhpcy5jdHggPSB0aGlzLmNvbXBvc2l0ZUN0eDsKICAgICAgdGhpcy5jdHguc2F2ZSgpOwogICAgICB0aGlzLmN0eC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgMCwgMCk7CiAgICAgIHRoaXMuY3R4LmRyYXdJbWFnZSh0aGlzLnRyYW5zcGFyZW50Q2FudmFzLCAwLCAwKTsKICAgICAgdGhpcy5jdHgucmVzdG9yZSgpOwogICAgICB0aGlzLnRyYW5zcGFyZW50Q2FudmFzID0gbnVsbDsKICAgIH0KICB9CiAgZW5kRHJhd2luZygpIHsKICAgIHRoaXMuI3Jlc3RvcmVJbml0aWFsU3RhdGUoKTsKICAgIHRoaXMuY2FjaGVkQ2FudmFzZXMuY2xlYXIoKTsKICAgIHRoaXMuY2FjaGVkUGF0dGVybnMuY2xlYXIoKTsKICAgIGZvciAoY29uc3QgY2FjaGUgb2YgdGhpcy5fY2FjaGVkQml0bWFwc01hcC52YWx1ZXMoKSkgewogICAgICBmb3IgKGNvbnN0IGNhbnZhcyBvZiBjYWNoZS52YWx1ZXMoKSkgewogICAgICAgIGlmICh0eXBlb2YgSFRNTENhbnZhc0VsZW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGNhbnZhcyBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50KSB7CiAgICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMuaGVpZ2h0ID0gMDsKICAgICAgICB9CiAgICAgIH0KICAgICAgY2FjaGUuY2xlYXIoKTsKICAgIH0KICAgIHRoaXMuX2NhY2hlZEJpdG1hcHNNYXAuY2xlYXIoKTsKICAgIHRoaXMuI2RyYXdGaWx0ZXIoKTsKICB9CiAgI2RyYXdGaWx0ZXIoKSB7CiAgICBpZiAodGhpcy5wYWdlQ29sb3JzKSB7CiAgICAgIGNvbnN0IGhjbUZpbHRlcklkID0gdGhpcy5maWx0ZXJGYWN0b3J5LmFkZEhDTUZpbHRlcih0aGlzLnBhZ2VDb2xvcnMuZm9yZWdyb3VuZCwgdGhpcy5wYWdlQ29sb3JzLmJhY2tncm91bmQpOwogICAgICBpZiAoaGNtRmlsdGVySWQgIT09ICJub25lIikgewogICAgICAgIGNvbnN0IHNhdmVkRmlsdGVyID0gdGhpcy5jdHguZmlsdGVyOwogICAgICAgIHRoaXMuY3R4LmZpbHRlciA9IGhjbUZpbHRlcklkOwogICAgICAgIHRoaXMuY3R4LmRyYXdJbWFnZSh0aGlzLmN0eC5jYW52YXMsIDAsIDApOwogICAgICAgIHRoaXMuY3R4LmZpbHRlciA9IHNhdmVkRmlsdGVyOwogICAgICB9CiAgICB9CiAgfQogIF9zY2FsZUltYWdlKGltZywgaW52ZXJzZVRyYW5zZm9ybSkgewogICAgY29uc3Qgd2lkdGggPSBpbWcud2lkdGggPz8gaW1nLmRpc3BsYXlXaWR0aDsKICAgIGNvbnN0IGhlaWdodCA9IGltZy5oZWlnaHQgPz8gaW1nLmRpc3BsYXlIZWlnaHQ7CiAgICBsZXQgd2lkdGhTY2FsZSA9IE1hdGgubWF4KE1hdGguaHlwb3QoaW52ZXJzZVRyYW5zZm9ybVswXSwgaW52ZXJzZVRyYW5zZm9ybVsxXSksIDEpOwogICAgbGV0IGhlaWdodFNjYWxlID0gTWF0aC5tYXgoTWF0aC5oeXBvdChpbnZlcnNlVHJhbnNmb3JtWzJdLCBpbnZlcnNlVHJhbnNmb3JtWzNdKSwgMSk7CiAgICBsZXQgcGFpbnRXaWR0aCA9IHdpZHRoLCBwYWludEhlaWdodCA9IGhlaWdodDsKICAgIGxldCB0bXBDYW52YXNJZCA9ICJwcmVzY2FsZTEiOwogICAgbGV0IHRtcENhbnZhcywgdG1wQ3R4OwogICAgd2hpbGUgKHdpZHRoU2NhbGUgPiAyICYmIHBhaW50V2lkdGggPiAxIHx8IGhlaWdodFNjYWxlID4gMiAmJiBwYWludEhlaWdodCA+IDEpIHsKICAgICAgbGV0IG5ld1dpZHRoID0gcGFpbnRXaWR0aCwgbmV3SGVpZ2h0ID0gcGFpbnRIZWlnaHQ7CiAgICAgIGlmICh3aWR0aFNjYWxlID4gMiAmJiBwYWludFdpZHRoID4gMSkgewogICAgICAgIG5ld1dpZHRoID0gcGFpbnRXaWR0aCA+PSAxNjM4NCA/IE1hdGguZmxvb3IocGFpbnRXaWR0aCAvIDIpIC0gMSB8fCAxIDogTWF0aC5jZWlsKHBhaW50V2lkdGggLyAyKTsKICAgICAgICB3aWR0aFNjYWxlIC89IHBhaW50V2lkdGggLyBuZXdXaWR0aDsKICAgICAgfQogICAgICBpZiAoaGVpZ2h0U2NhbGUgPiAyICYmIHBhaW50SGVpZ2h0ID4gMSkgewogICAgICAgIG5ld0hlaWdodCA9IHBhaW50SGVpZ2h0ID49IDE2Mzg0ID8gTWF0aC5mbG9vcihwYWludEhlaWdodCAvIDIpIC0gMSB8fCAxIDogTWF0aC5jZWlsKHBhaW50SGVpZ2h0KSAvIDI7CiAgICAgICAgaGVpZ2h0U2NhbGUgLz0gcGFpbnRIZWlnaHQgLyBuZXdIZWlnaHQ7CiAgICAgIH0KICAgICAgdG1wQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXModG1wQ2FudmFzSWQsIG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgICB0bXBDdHggPSB0bXBDYW52YXMuY29udGV4dDsKICAgICAgdG1wQ3R4LmNsZWFyUmVjdCgwLCAwLCBuZXdXaWR0aCwgbmV3SGVpZ2h0KTsKICAgICAgdG1wQ3R4LmRyYXdJbWFnZShpbWcsIDAsIDAsIHBhaW50V2lkdGgsIHBhaW50SGVpZ2h0LCAwLCAwLCBuZXdXaWR0aCwgbmV3SGVpZ2h0KTsKICAgICAgaW1nID0gdG1wQ2FudmFzLmNhbnZhczsKICAgICAgcGFpbnRXaWR0aCA9IG5ld1dpZHRoOwogICAgICBwYWludEhlaWdodCA9IG5ld0hlaWdodDsKICAgICAgdG1wQ2FudmFzSWQgPSB0bXBDYW52YXNJZCA9PT0gInByZXNjYWxlMSIgPyAicHJlc2NhbGUyIiA6ICJwcmVzY2FsZTEiOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgaW1nLAogICAgICBwYWludFdpZHRoLAogICAgICBwYWludEhlaWdodAogICAgfTsKICB9CiAgX2NyZWF0ZU1hc2tDYW52YXMob3BJZHgsIGltZykgewogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBjb25zdCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSBpbWc7CiAgICBjb25zdCBmaWxsQ29sb3IgPSB0aGlzLmN1cnJlbnQuZmlsbENvbG9yOwogICAgY29uc3QgaXNQYXR0ZXJuRmlsbCA9IHRoaXMuY3VycmVudC5wYXR0ZXJuRmlsbDsKICAgIGNvbnN0IGN1cnJlbnRUcmFuc2Zvcm0gPSBnZXRDdXJyZW50VHJhbnNmb3JtKGN0eCk7CiAgICBsZXQgY2FjaGUsIGNhY2hlS2V5LCBzY2FsZWQsIG1hc2tDYW52YXM7CiAgICBpZiAoKGltZy5iaXRtYXAgfHwgaW1nLmRhdGEpICYmIGltZy5jb3VudCA+IDEpIHsKICAgICAgY29uc3QgbWFpbktleSA9IGltZy5iaXRtYXAgfHwgaW1nLmRhdGEuYnVmZmVyOwogICAgICBjYWNoZUtleSA9IEpTT04uc3RyaW5naWZ5KGlzUGF0dGVybkZpbGwgPyBjdXJyZW50VHJhbnNmb3JtIDogW2N1cnJlbnRUcmFuc2Zvcm0uc2xpY2UoMCwgNCksIGZpbGxDb2xvcl0pOwogICAgICBjYWNoZSA9IHRoaXMuX2NhY2hlZEJpdG1hcHNNYXAuZ2V0KG1haW5LZXkpOwogICAgICBpZiAoIWNhY2hlKSB7CiAgICAgICAgY2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX2NhY2hlZEJpdG1hcHNNYXAuc2V0KG1haW5LZXksIGNhY2hlKTsKICAgICAgfQogICAgICBjb25zdCBjYWNoZWRJbWFnZSA9IGNhY2hlLmdldChjYWNoZUtleSk7CiAgICAgIGlmIChjYWNoZWRJbWFnZSAmJiAhaXNQYXR0ZXJuRmlsbCkgewogICAgICAgIGNvbnN0IG9mZnNldFgyID0gTWF0aC5yb3VuZChNYXRoLm1pbihjdXJyZW50VHJhbnNmb3JtWzBdLCBjdXJyZW50VHJhbnNmb3JtWzJdKSArIGN1cnJlbnRUcmFuc2Zvcm1bNF0pOwogICAgICAgIGNvbnN0IG9mZnNldFkyID0gTWF0aC5yb3VuZChNYXRoLm1pbihjdXJyZW50VHJhbnNmb3JtWzFdLCBjdXJyZW50VHJhbnNmb3JtWzNdKSArIGN1cnJlbnRUcmFuc2Zvcm1bNV0pOwogICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLnRyYW5zZm9ybUFuZEZpbGwpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjYW52YXM6IGNhY2hlZEltYWdlLAogICAgICAgICAgb2Zmc2V0WDogb2Zmc2V0WDIsCiAgICAgICAgICBvZmZzZXRZOiBvZmZzZXRZMgogICAgICAgIH07CiAgICAgIH0KICAgICAgc2NhbGVkID0gY2FjaGVkSW1hZ2U7CiAgICB9CiAgICBpZiAoIXNjYWxlZCkgewogICAgICBtYXNrQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoIm1hc2tDYW52YXMiLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgcHV0QmluYXJ5SW1hZ2VNYXNrKG1hc2tDYW52YXMuY29udGV4dCwgaW1nKTsKICAgIH0KICAgIGxldCBtYXNrVG9DYW52YXMgPSBVdGlsLnRyYW5zZm9ybShjdXJyZW50VHJhbnNmb3JtLCBbMSAvIHdpZHRoLCAwLCAwLCAtMSAvIGhlaWdodCwgMCwgMF0pOwogICAgbWFza1RvQ2FudmFzID0gVXRpbC50cmFuc2Zvcm0obWFza1RvQ2FudmFzLCBbMSwgMCwgMCwgMSwgMCwgLWhlaWdodF0pOwogICAgY29uc3QgbWluTWF4ID0gTUlOX01BWF9JTklULnNsaWNlKCk7CiAgICBVdGlsLmF4aWFsQWxpZ25lZEJvdW5kaW5nQm94KFswLCAwLCB3aWR0aCwgaGVpZ2h0XSwgbWFza1RvQ2FudmFzLCBtaW5NYXgpOwogICAgY29uc3QgW21pblgsIG1pblksIG1heFgsIG1heFldID0gbWluTWF4OwogICAgY29uc3QgZHJhd25XaWR0aCA9IE1hdGgucm91bmQobWF4WCAtIG1pblgpIHx8IDE7CiAgICBjb25zdCBkcmF3bkhlaWdodCA9IE1hdGgucm91bmQobWF4WSAtIG1pblkpIHx8IDE7CiAgICBjb25zdCBmaWxsQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoImZpbGxDYW52YXMiLCBkcmF3bldpZHRoLCBkcmF3bkhlaWdodCk7CiAgICBjb25zdCBmaWxsQ3R4ID0gZmlsbENhbnZhcy5jb250ZXh0OwogICAgY29uc3Qgb2Zmc2V0WCA9IG1pblg7CiAgICBjb25zdCBvZmZzZXRZID0gbWluWTsKICAgIGZpbGxDdHgudHJhbnNsYXRlKC1vZmZzZXRYLCAtb2Zmc2V0WSk7CiAgICBmaWxsQ3R4LnRyYW5zZm9ybSguLi5tYXNrVG9DYW52YXMpOwogICAgaWYgKCFzY2FsZWQpIHsKICAgICAgc2NhbGVkID0gdGhpcy5fc2NhbGVJbWFnZShtYXNrQ2FudmFzLmNhbnZhcywgZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoZmlsbEN0eCkpOwogICAgICBzY2FsZWQgPSBzY2FsZWQuaW1nOwogICAgICBpZiAoY2FjaGUgJiYgaXNQYXR0ZXJuRmlsbCkgewogICAgICAgIGNhY2hlLnNldChjYWNoZUtleSwgc2NhbGVkKTsKICAgICAgfQogICAgfQogICAgZmlsbEN0eC5pbWFnZVNtb290aGluZ0VuYWJsZWQgPSBnZXRJbWFnZVNtb290aGluZ0VuYWJsZWQoZ2V0Q3VycmVudFRyYW5zZm9ybShmaWxsQ3R4KSwgaW1nLmludGVycG9sYXRlKTsKICAgIGRyYXdJbWFnZUF0SW50ZWdlckNvb3JkcyhmaWxsQ3R4LCBzY2FsZWQsIDAsIDAsIHNjYWxlZC53aWR0aCwgc2NhbGVkLmhlaWdodCwgMCwgMCwgd2lkdGgsIGhlaWdodCk7CiAgICBmaWxsQ3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJzb3VyY2UtaW4iOwogICAgY29uc3QgaW52ZXJzZSA9IFV0aWwudHJhbnNmb3JtKGdldEN1cnJlbnRUcmFuc2Zvcm1JbnZlcnNlKGZpbGxDdHgpLCBbMSwgMCwgMCwgMSwgLW9mZnNldFgsIC1vZmZzZXRZXSk7CiAgICBmaWxsQ3R4LmZpbGxTdHlsZSA9IGlzUGF0dGVybkZpbGwgPyBmaWxsQ29sb3IuZ2V0UGF0dGVybihjdHgsIHRoaXMsIGludmVyc2UsIFBhdGhUeXBlLkZJTEwsIG9wSWR4KSA6IGZpbGxDb2xvcjsKICAgIGZpbGxDdHguZmlsbFJlY3QoMCwgMCwgd2lkdGgsIGhlaWdodCk7CiAgICBpZiAoY2FjaGUgJiYgIWlzUGF0dGVybkZpbGwpIHsKICAgICAgdGhpcy5jYWNoZWRDYW52YXNlcy5kZWxldGUoImZpbGxDYW52YXMiKTsKICAgICAgY2FjaGUuc2V0KGNhY2hlS2V5LCBmaWxsQ2FudmFzLmNhbnZhcyk7CiAgICB9CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmREZXBlbmRlbmNpZXMob3BJZHgsIERlcGVuZGVuY2llcy50cmFuc2Zvcm1BbmRGaWxsKTsKICAgIHJldHVybiB7CiAgICAgIGNhbnZhczogZmlsbENhbnZhcy5jYW52YXMsCiAgICAgIG9mZnNldFg6IE1hdGgucm91bmQob2Zmc2V0WCksCiAgICAgIG9mZnNldFk6IE1hdGgucm91bmQob2Zmc2V0WSkKICAgIH07CiAgfQogIHNldExpbmVXaWR0aChvcElkeCwgd2lkdGgpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImxpbmVXaWR0aCIsIG9wSWR4KTsKICAgIGlmICh3aWR0aCAhPT0gdGhpcy5jdXJyZW50LmxpbmVXaWR0aCkgewogICAgICB0aGlzLl9jYWNoZWRTY2FsZUZvclN0cm9raW5nWzBdID0gLTE7CiAgICB9CiAgICB0aGlzLmN1cnJlbnQubGluZVdpZHRoID0gd2lkdGg7CiAgICB0aGlzLmN0eC5saW5lV2lkdGggPSB3aWR0aDsKICB9CiAgc2V0TGluZUNhcChvcElkeCwgc3R5bGUpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImxpbmVDYXAiLCBvcElkeCk7CiAgICB0aGlzLmN0eC5saW5lQ2FwID0gTElORV9DQVBfU1RZTEVTW3N0eWxlXTsKICB9CiAgc2V0TGluZUpvaW4ob3BJZHgsIHN0eWxlKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJsaW5lSm9pbiIsIG9wSWR4KTsKICAgIHRoaXMuY3R4LmxpbmVKb2luID0gTElORV9KT0lOX1NUWUxFU1tzdHlsZV07CiAgfQogIHNldE1pdGVyTGltaXQob3BJZHgsIGxpbWl0KSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJtaXRlckxpbWl0Iiwgb3BJZHgpOwogICAgdGhpcy5jdHgubWl0ZXJMaW1pdCA9IGxpbWl0OwogIH0KICBzZXREYXNoKG9wSWR4LCBkYXNoQXJyYXksIGRhc2hQaGFzZSkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgiZGFzaCIsIG9wSWR4KTsKICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgaWYgKGN0eC5zZXRMaW5lRGFzaCAhPT0gdm9pZCAwKSB7CiAgICAgIGN0eC5zZXRMaW5lRGFzaChkYXNoQXJyYXkpOwogICAgICBjdHgubGluZURhc2hPZmZzZXQgPSBkYXNoUGhhc2U7CiAgICB9CiAgfQogIHNldFJlbmRlcmluZ0ludGVudChvcElkeCwgaW50ZW50KSB7CiAgfQogIHNldEZsYXRuZXNzKG9wSWR4LCBmbGF0bmVzcykgewogIH0KICBzZXRHU3RhdGUob3BJZHgsIHN0YXRlcykgewogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2Ygc3RhdGVzKSB7CiAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgY2FzZSAiTFciOgogICAgICAgICAgdGhpcy5zZXRMaW5lV2lkdGgob3BJZHgsIHZhbHVlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkxDIjoKICAgICAgICAgIHRoaXMuc2V0TGluZUNhcChvcElkeCwgdmFsdWUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiTEoiOgogICAgICAgICAgdGhpcy5zZXRMaW5lSm9pbihvcElkeCwgdmFsdWUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiTUwiOgogICAgICAgICAgdGhpcy5zZXRNaXRlckxpbWl0KG9wSWR4LCB2YWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJEIjoKICAgICAgICAgIHRoaXMuc2V0RGFzaChvcElkeCwgdmFsdWVbMF0sIHZhbHVlWzFdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIlJJIjoKICAgICAgICAgIHRoaXMuc2V0UmVuZGVyaW5nSW50ZW50KG9wSWR4LCB2YWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJGTCI6CiAgICAgICAgICB0aGlzLnNldEZsYXRuZXNzKG9wSWR4LCB2YWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJGb250IjoKICAgICAgICAgIHRoaXMuc2V0Rm9udChvcElkeCwgdmFsdWVbMF0sIHZhbHVlWzFdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkNBIjoKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoInN0cm9rZUFscGhhIiwgb3BJZHgpOwogICAgICAgICAgdGhpcy5jdXJyZW50LnN0cm9rZUFscGhhID0gdmFsdWU7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJjYSI6CiAgICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJmaWxsQWxwaGEiLCBvcElkeCk7CiAgICAgICAgICB0aGlzLmN0eC5nbG9iYWxBbHBoYSA9IHRoaXMuY3VycmVudC5maWxsQWxwaGEgPSB2YWx1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkJNIjoKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiIsIG9wSWR4KTsKICAgICAgICAgIHRoaXMuY3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9IHZhbHVlOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiU01hc2siOgogICAgICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgiU01hc2siLCBvcElkeCk7CiAgICAgICAgICB0aGlzLmN1cnJlbnQuYWN0aXZlU01hc2sgPSB2YWx1ZSA/IHRoaXMudGVtcFNNYXNrIDogbnVsbDsKICAgICAgICAgIHRoaXMudGVtcFNNYXNrID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2hlY2tTTWFza1N0YXRlKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJUUiI6CiAgICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJmaWx0ZXIiLCBvcElkeCk7CiAgICAgICAgICB0aGlzLmN0eC5maWx0ZXIgPSB0aGlzLmN1cnJlbnQudHJhbnNmZXJNYXBzID0gdGhpcy5maWx0ZXJGYWN0b3J5LmFkZEZpbHRlcih2YWx1ZSk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICBnZXQgaW5TTWFza01vZGUoKSB7CiAgICByZXR1cm4gISF0aGlzLnN1c3BlbmRlZEN0eDsKICB9CiAgY2hlY2tTTWFza1N0YXRlKCkgewogICAgY29uc3QgaW5TTWFza01vZGUgPSB0aGlzLmluU01hc2tNb2RlOwogICAgaWYgKHRoaXMuY3VycmVudC5hY3RpdmVTTWFzayAmJiAhaW5TTWFza01vZGUpIHsKICAgICAgdGhpcy5iZWdpblNNYXNrTW9kZSgpOwogICAgfSBlbHNlIGlmICghdGhpcy5jdXJyZW50LmFjdGl2ZVNNYXNrICYmIGluU01hc2tNb2RlKSB7CiAgICAgIHRoaXMuZW5kU01hc2tNb2RlKCk7CiAgICB9CiAgfQogIGJlZ2luU01hc2tNb2RlKG9wSWR4KSB7CiAgICBpZiAodGhpcy5pblNNYXNrTW9kZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoImJlZ2luU01hc2tNb2RlIGNhbGxlZCB3aGlsZSBhbHJlYWR5IGluIHNtYXNrIG1vZGUiKTsKICAgIH0KICAgIGNvbnN0IGRyYXduV2lkdGggPSB0aGlzLmN0eC5jYW52YXMud2lkdGg7CiAgICBjb25zdCBkcmF3bkhlaWdodCA9IHRoaXMuY3R4LmNhbnZhcy5oZWlnaHQ7CiAgICBjb25zdCBjYWNoZUlkID0gInNtYXNrR3JvdXBBdCIgKyB0aGlzLmdyb3VwTGV2ZWw7CiAgICBjb25zdCBzY3JhdGNoQ2FudmFzID0gdGhpcy5jYWNoZWRDYW52YXNlcy5nZXRDYW52YXMoY2FjaGVJZCwgZHJhd25XaWR0aCwgZHJhd25IZWlnaHQpOwogICAgdGhpcy5zdXNwZW5kZWRDdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4ID0gc2NyYXRjaENhbnZhcy5jb250ZXh0OwogICAgY3R4LnNldFRyYW5zZm9ybSh0aGlzLnN1c3BlbmRlZEN0eC5nZXRUcmFuc2Zvcm0oKSk7CiAgICBjb3B5Q3R4U3RhdGUodGhpcy5zdXNwZW5kZWRDdHgsIGN0eCk7CiAgICBtaXJyb3JDb250ZXh0T3BlcmF0aW9ucyhjdHgsIHRoaXMuc3VzcGVuZGVkQ3R4KTsKICAgIHRoaXMuc2V0R1N0YXRlKG9wSWR4LCBbWyJCTSIsICJzb3VyY2Utb3ZlciJdXSk7CiAgfQogIGVuZFNNYXNrTW9kZSgpIHsKICAgIGlmICghdGhpcy5pblNNYXNrTW9kZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoImVuZFNNYXNrTW9kZSBjYWxsZWQgd2hpbGUgbm90IGluIHNtYXNrIG1vZGUiKTsKICAgIH0KICAgIHRoaXMuY3R4Ll9yZW1vdmVNaXJyb3JpbmcoKTsKICAgIGNvcHlDdHhTdGF0ZSh0aGlzLmN0eCwgdGhpcy5zdXNwZW5kZWRDdHgpOwogICAgdGhpcy5jdHggPSB0aGlzLnN1c3BlbmRlZEN0eDsKICAgIHRoaXMuc3VzcGVuZGVkQ3R4ID0gbnVsbDsKICB9CiAgY29tcG9zZShkaXJ0eUJveCkgewogICAgaWYgKCF0aGlzLmN1cnJlbnQuYWN0aXZlU01hc2spIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCFkaXJ0eUJveCkgewogICAgICBkaXJ0eUJveCA9IFswLCAwLCB0aGlzLmN0eC5jYW52YXMud2lkdGgsIHRoaXMuY3R4LmNhbnZhcy5oZWlnaHRdOwogICAgfSBlbHNlIHsKICAgICAgZGlydHlCb3hbMF0gPSBNYXRoLmZsb29yKGRpcnR5Qm94WzBdKTsKICAgICAgZGlydHlCb3hbMV0gPSBNYXRoLmZsb29yKGRpcnR5Qm94WzFdKTsKICAgICAgZGlydHlCb3hbMl0gPSBNYXRoLmNlaWwoZGlydHlCb3hbMl0pOwogICAgICBkaXJ0eUJveFszXSA9IE1hdGguY2VpbChkaXJ0eUJveFszXSk7CiAgICB9CiAgICBjb25zdCBzbWFzayA9IHRoaXMuY3VycmVudC5hY3RpdmVTTWFzazsKICAgIGNvbnN0IHN1c3BlbmRlZEN0eCA9IHRoaXMuc3VzcGVuZGVkQ3R4OwogICAgdGhpcy5jb21wb3NlU01hc2soc3VzcGVuZGVkQ3R4LCBzbWFzaywgdGhpcy5jdHgsIGRpcnR5Qm94KTsKICAgIHRoaXMuY3R4LnNhdmUoKTsKICAgIHRoaXMuY3R4LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKICAgIHRoaXMuY3R4LmNsZWFyUmVjdCgwLCAwLCB0aGlzLmN0eC5jYW52YXMud2lkdGgsIHRoaXMuY3R4LmNhbnZhcy5oZWlnaHQpOwogICAgdGhpcy5jdHgucmVzdG9yZSgpOwogIH0KICBjb21wb3NlU01hc2soY3R4LCBzbWFzaywgbGF5ZXJDdHgsIGxheWVyQm94KSB7CiAgICBjb25zdCBsYXllck9mZnNldFggPSBsYXllckJveFswXTsKICAgIGNvbnN0IGxheWVyT2Zmc2V0WSA9IGxheWVyQm94WzFdOwogICAgY29uc3QgbGF5ZXJXaWR0aCA9IGxheWVyQm94WzJdIC0gbGF5ZXJPZmZzZXRYOwogICAgY29uc3QgbGF5ZXJIZWlnaHQgPSBsYXllckJveFszXSAtIGxheWVyT2Zmc2V0WTsKICAgIGlmIChsYXllcldpZHRoID09PSAwIHx8IGxheWVySGVpZ2h0ID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuZ2VuZXJpY0NvbXBvc2VTTWFzayhzbWFzay5jb250ZXh0LCBsYXllckN0eCwgbGF5ZXJXaWR0aCwgbGF5ZXJIZWlnaHQsIHNtYXNrLnN1YnR5cGUsIHNtYXNrLmJhY2tkcm9wLCBzbWFzay50cmFuc2Zlck1hcCwgbGF5ZXJPZmZzZXRYLCBsYXllck9mZnNldFksIHNtYXNrLm9mZnNldFgsIHNtYXNrLm9mZnNldFkpOwogICAgY3R4LnNhdmUoKTsKICAgIGN0eC5nbG9iYWxBbHBoYSA9IDE7CiAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gInNvdXJjZS1vdmVyIjsKICAgIGN0eC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgMCwgMCk7CiAgICBjdHguZHJhd0ltYWdlKGxheWVyQ3R4LmNhbnZhcywgMCwgMCk7CiAgICBjdHgucmVzdG9yZSgpOwogIH0KICBnZW5lcmljQ29tcG9zZVNNYXNrKG1hc2tDdHgsIGxheWVyQ3R4LCB3aWR0aCwgaGVpZ2h0LCBzdWJ0eXBlLCBiYWNrZHJvcCwgdHJhbnNmZXJNYXAsIGxheWVyT2Zmc2V0WCwgbGF5ZXJPZmZzZXRZLCBtYXNrT2Zmc2V0WCwgbWFza09mZnNldFkpIHsKICAgIGxldCBtYXNrQ2FudmFzID0gbWFza0N0eC5jYW52YXM7CiAgICBsZXQgbWFza1ggPSBsYXllck9mZnNldFggLSBtYXNrT2Zmc2V0WDsKICAgIGxldCBtYXNrWSA9IGxheWVyT2Zmc2V0WSAtIG1hc2tPZmZzZXRZOwogICAgaWYgKGJhY2tkcm9wKSB7CiAgICAgIGlmIChtYXNrWCA8IDAgfHwgbWFza1kgPCAwIHx8IG1hc2tYICsgd2lkdGggPiBtYXNrQ2FudmFzLndpZHRoIHx8IG1hc2tZICsgaGVpZ2h0ID4gbWFza0NhbnZhcy5oZWlnaHQpIHsKICAgICAgICBjb25zdCBjYW52YXMgPSB0aGlzLmNhY2hlZENhbnZhc2VzLmdldENhbnZhcygibWFza0V4dGVuc2lvbiIsIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5jb250ZXh0OwogICAgICAgIGN0eC5kcmF3SW1hZ2UobWFza0NhbnZhcywgLW1hc2tYLCAtbWFza1kpOwogICAgICAgIGN0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAiZGVzdGluYXRpb24tYXRvcCI7CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGJhY2tkcm9wOwogICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBjdHguZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gInNvdXJjZS1vdmVyIjsKICAgICAgICBtYXNrQ2FudmFzID0gY2FudmFzLmNhbnZhczsKICAgICAgICBtYXNrWCA9IG1hc2tZID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXNrQ3R4LnNhdmUoKTsKICAgICAgICBtYXNrQ3R4Lmdsb2JhbEFscGhhID0gMTsKICAgICAgICBtYXNrQ3R4LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKICAgICAgICBjb25zdCBjbGlwMiA9IG5ldyBQYXRoMkQoKTsKICAgICAgICBjbGlwMi5yZWN0KG1hc2tYLCBtYXNrWSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgbWFza0N0eC5jbGlwKGNsaXAyKTsKICAgICAgICBtYXNrQ3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJkZXN0aW5hdGlvbi1hdG9wIjsKICAgICAgICBtYXNrQ3R4LmZpbGxTdHlsZSA9IGJhY2tkcm9wOwogICAgICAgIG1hc2tDdHguZmlsbFJlY3QobWFza1gsIG1hc2tZLCB3aWR0aCwgaGVpZ2h0KTsKICAgICAgICBtYXNrQ3R4LnJlc3RvcmUoKTsKICAgICAgfQogICAgfQogICAgbGF5ZXJDdHguc2F2ZSgpOwogICAgbGF5ZXJDdHguZ2xvYmFsQWxwaGEgPSAxOwogICAgbGF5ZXJDdHguc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgaWYgKHN1YnR5cGUgPT09ICJBbHBoYSIgJiYgdHJhbnNmZXJNYXApIHsKICAgICAgbGF5ZXJDdHguZmlsdGVyID0gdGhpcy5maWx0ZXJGYWN0b3J5LmFkZEFscGhhRmlsdGVyKHRyYW5zZmVyTWFwKTsKICAgIH0gZWxzZSBpZiAoc3VidHlwZSA9PT0gIkx1bWlub3NpdHkiKSB7CiAgICAgIGxheWVyQ3R4LmZpbHRlciA9IHRoaXMuZmlsdGVyRmFjdG9yeS5hZGRMdW1pbm9zaXR5RmlsdGVyKHRyYW5zZmVyTWFwKTsKICAgIH0KICAgIGNvbnN0IGNsaXAgPSBuZXcgUGF0aDJEKCk7CiAgICBjbGlwLnJlY3QobGF5ZXJPZmZzZXRYLCBsYXllck9mZnNldFksIHdpZHRoLCBoZWlnaHQpOwogICAgbGF5ZXJDdHguY2xpcChjbGlwKTsKICAgIGxheWVyQ3R4Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9ICJkZXN0aW5hdGlvbi1pbiI7CiAgICBsYXllckN0eC5kcmF3SW1hZ2UobWFza0NhbnZhcywgbWFza1gsIG1hc2tZLCB3aWR0aCwgaGVpZ2h0LCBsYXllck9mZnNldFgsIGxheWVyT2Zmc2V0WSwgd2lkdGgsIGhlaWdodCk7CiAgICBsYXllckN0eC5yZXN0b3JlKCk7CiAgfQogIHNhdmUob3BJZHgpIHsKICAgIGlmICh0aGlzLmluU01hc2tNb2RlKSB7CiAgICAgIGNvcHlDdHhTdGF0ZSh0aGlzLmN0eCwgdGhpcy5zdXNwZW5kZWRDdHgpOwogICAgfQogICAgdGhpcy5jdHguc2F2ZSgpOwogICAgY29uc3Qgb2xkID0gdGhpcy5jdXJyZW50OwogICAgdGhpcy5zdGF0ZVN0YWNrLnB1c2gob2xkKTsKICAgIHRoaXMuY3VycmVudCA9IG9sZC5jbG9uZSgpOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8uc2F2ZShvcElkeCk7CiAgfQogIHJlc3RvcmUob3BJZHgpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc3RvcmUob3BJZHgpOwogICAgaWYgKHRoaXMuc3RhdGVTdGFjay5sZW5ndGggPT09IDApIHsKICAgICAgaWYgKHRoaXMuaW5TTWFza01vZGUpIHsKICAgICAgICB0aGlzLmVuZFNNYXNrTW9kZSgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuY3VycmVudCA9IHRoaXMuc3RhdGVTdGFjay5wb3AoKTsKICAgIHRoaXMuY3R4LnJlc3RvcmUoKTsKICAgIGlmICh0aGlzLmluU01hc2tNb2RlKSB7CiAgICAgIGNvcHlDdHhTdGF0ZSh0aGlzLnN1c3BlbmRlZEN0eCwgdGhpcy5jdHgpOwogICAgfQogICAgdGhpcy5jaGVja1NNYXNrU3RhdGUoKTsKICAgIHRoaXMucGVuZGluZ0NsaXAgPSBudWxsOwogICAgdGhpcy5fY2FjaGVkU2NhbGVGb3JTdHJva2luZ1swXSA9IC0xOwogICAgdGhpcy5fY2FjaGVkR2V0U2luZ2xlUGl4ZWxXaWR0aCA9IG51bGw7CiAgfQogIHRyYW5zZm9ybShvcElkeCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkSW5jcmVtZW50YWxEYXRhKCJ0cmFuc2Zvcm0iLCBvcElkeCk7CiAgICB0aGlzLmN0eC50cmFuc2Zvcm0oYSwgYiwgYywgZCwgZSwgZik7CiAgICB0aGlzLl9jYWNoZWRTY2FsZUZvclN0cm9raW5nWzBdID0gLTE7CiAgICB0aGlzLl9jYWNoZWRHZXRTaW5nbGVQaXhlbFdpZHRoID0gbnVsbDsKICB9CiAgY29uc3RydWN0UGF0aChvcElkeCwgb3AsIGRhdGEsIG1pbk1heCkgewogICAgbGV0IFtwYXRoXSA9IGRhdGE7CiAgICBpZiAoIW1pbk1heCkgewogICAgICBwYXRoIHx8PSBkYXRhWzBdID0gbmV3IFBhdGgyRCgpOwogICAgICB0aGlzW29wXShvcElkeCwgcGF0aCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLmRlcGVuZGVuY3lUcmFja2VyICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IG91dGVyRXh0cmFTaXplID0gb3AgPT09IE9QUy5zdHJva2UgPyB0aGlzLmN1cnJlbnQubGluZVdpZHRoIC8gMiA6IDA7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIucmVzZXRCQm94KG9wSWR4KS5yZWNvcmRCQm94KG9wSWR4LCB0aGlzLmN0eCwgbWluTWF4WzBdIC0gb3V0ZXJFeHRyYVNpemUsIG1pbk1heFsyXSArIG91dGVyRXh0cmFTaXplLCBtaW5NYXhbMV0gLSBvdXRlckV4dHJhU2l6ZSwgbWluTWF4WzNdICsgb3V0ZXJFeHRyYVNpemUpLnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgWyJ0cmFuc2Zvcm0iXSk7CiAgICB9CiAgICBpZiAoIShwYXRoIGluc3RhbmNlb2YgUGF0aDJEKSkgewogICAgICBwYXRoID0gZGF0YVswXSA9IG1ha2VQYXRoRnJvbURyYXdPUFMocGF0aCk7CiAgICB9CiAgICBVdGlsLmF4aWFsQWxpZ25lZEJvdW5kaW5nQm94KG1pbk1heCwgZ2V0Q3VycmVudFRyYW5zZm9ybSh0aGlzLmN0eCksIHRoaXMuY3VycmVudC5taW5NYXgpOwogICAgdGhpc1tvcF0ob3BJZHgsIHBhdGgpOwogICAgdGhpcy5fcGF0aFN0YXJ0SWR4ID0gb3BJZHg7CiAgfQogIGNsb3NlUGF0aChvcElkeCkgewogICAgdGhpcy5jdHguY2xvc2VQYXRoKCk7CiAgfQogIHN0cm9rZShvcElkeCwgcGF0aCwgY29uc3VtZVBhdGggPSB0cnVlKSB7CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IHN0cm9rZUNvbG9yID0gdGhpcy5jdXJyZW50LnN0cm9rZUNvbG9yOwogICAgY3R4Lmdsb2JhbEFscGhhID0gdGhpcy5jdXJyZW50LnN0cm9rZUFscGhhOwogICAgaWYgKHRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgaWYgKHR5cGVvZiBzdHJva2VDb2xvciA9PT0gIm9iamVjdCIgJiYgc3Ryb2tlQ29sb3I/LmdldFBhdHRlcm4pIHsKICAgICAgICBjb25zdCBiYXNlVHJhbnNmb3JtID0gc3Ryb2tlQ29sb3IuaXNNb2RpZnlpbmdDdXJyZW50VHJhbnNmb3JtKCkgPyBjdHguZ2V0VHJhbnNmb3JtKCkgOiBudWxsOwogICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gc3Ryb2tlQ29sb3IuZ2V0UGF0dGVybihjdHgsIHRoaXMsIGdldEN1cnJlbnRUcmFuc2Zvcm1JbnZlcnNlKGN0eCksIFBhdGhUeXBlLlNUUk9LRSwgb3BJZHgpOwogICAgICAgIGlmIChiYXNlVHJhbnNmb3JtKSB7CiAgICAgICAgICBjb25zdCBuZXdQYXRoID0gbmV3IFBhdGgyRCgpOwogICAgICAgICAgbmV3UGF0aC5hZGRQYXRoKHBhdGgsIGN0eC5nZXRUcmFuc2Zvcm0oKS5pbnZlcnRTZWxmKCkubXVsdGlwbHlTZWxmKGJhc2VUcmFuc2Zvcm0pKTsKICAgICAgICAgIHBhdGggPSBuZXdQYXRoOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlc2NhbGVBbmRTdHJva2UocGF0aCwgZmFsc2UpOwogICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZXNjYWxlQW5kU3Ryb2tlKHBhdGgsIHRydWUpOwogICAgICB9CiAgICB9CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmREZXBlbmRlbmNpZXMob3BJZHgsIERlcGVuZGVuY2llcy5zdHJva2UpOwogICAgaWYgKGNvbnN1bWVQYXRoKSB7CiAgICAgIHRoaXMuY29uc3VtZVBhdGgob3BJZHgsIHBhdGgsIHRoaXMuY3VycmVudC5nZXRDbGlwcGVkUGF0aEJvdW5kaW5nQm94KFBhdGhUeXBlLlNUUk9LRSwgZ2V0Q3VycmVudFRyYW5zZm9ybSh0aGlzLmN0eCkpKTsKICAgIH0KICAgIGN0eC5nbG9iYWxBbHBoYSA9IHRoaXMuY3VycmVudC5maWxsQWxwaGE7CiAgfQogIGNsb3NlU3Ryb2tlKG9wSWR4LCBwYXRoKSB7CiAgICB0aGlzLnN0cm9rZShvcElkeCwgcGF0aCk7CiAgfQogIGZpbGwob3BJZHgsIHBhdGgsIGNvbnN1bWVQYXRoID0gdHJ1ZSkgewogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBjb25zdCBmaWxsQ29sb3IgPSB0aGlzLmN1cnJlbnQuZmlsbENvbG9yOwogICAgY29uc3QgaXNQYXR0ZXJuRmlsbCA9IHRoaXMuY3VycmVudC5wYXR0ZXJuRmlsbDsKICAgIGxldCBuZWVkUmVzdG9yZSA9IGZhbHNlOwogICAgaWYgKGlzUGF0dGVybkZpbGwpIHsKICAgICAgY29uc3QgYmFzZVRyYW5zZm9ybSA9IGZpbGxDb2xvci5pc01vZGlmeWluZ0N1cnJlbnRUcmFuc2Zvcm0oKSA/IGN0eC5nZXRUcmFuc2Zvcm0oKSA6IG51bGw7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnNhdmUob3BJZHgpOwogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHguZmlsbFN0eWxlID0gZmlsbENvbG9yLmdldFBhdHRlcm4oY3R4LCB0aGlzLCBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShjdHgpLCBQYXRoVHlwZS5GSUxMLCBvcElkeCk7CiAgICAgIGlmIChiYXNlVHJhbnNmb3JtKSB7CiAgICAgICAgY29uc3QgbmV3UGF0aCA9IG5ldyBQYXRoMkQoKTsKICAgICAgICBuZXdQYXRoLmFkZFBhdGgocGF0aCwgY3R4LmdldFRyYW5zZm9ybSgpLmludmVydFNlbGYoKS5tdWx0aXBseVNlbGYoYmFzZVRyYW5zZm9ybSkpOwogICAgICAgIHBhdGggPSBuZXdQYXRoOwogICAgICB9CiAgICAgIG5lZWRSZXN0b3JlID0gdHJ1ZTsKICAgIH0KICAgIGNvbnN0IGludGVyc2VjdCA9IHRoaXMuY3VycmVudC5nZXRDbGlwcGVkUGF0aEJvdW5kaW5nQm94KCk7CiAgICBpZiAodGhpcy5jb250ZW50VmlzaWJsZSAmJiBpbnRlcnNlY3QgIT09IG51bGwpIHsKICAgICAgaWYgKHRoaXMucGVuZGluZ0VPRmlsbCkgewogICAgICAgIGN0eC5maWxsKHBhdGgsICJldmVub2RkIik7CiAgICAgICAgdGhpcy5wZW5kaW5nRU9GaWxsID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3R4LmZpbGwocGF0aCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLmZpbGwpOwogICAgaWYgKG5lZWRSZXN0b3JlKSB7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc3RvcmUob3BJZHgpOwogICAgfQogICAgaWYgKGNvbnN1bWVQYXRoKSB7CiAgICAgIHRoaXMuY29uc3VtZVBhdGgob3BJZHgsIHBhdGgsIGludGVyc2VjdCk7CiAgICB9CiAgfQogIGVvRmlsbChvcElkeCwgcGF0aCkgewogICAgdGhpcy5wZW5kaW5nRU9GaWxsID0gdHJ1ZTsKICAgIHRoaXMuZmlsbChvcElkeCwgcGF0aCk7CiAgfQogIGZpbGxTdHJva2Uob3BJZHgsIHBhdGgpIHsKICAgIHRoaXMuZmlsbChvcElkeCwgcGF0aCwgZmFsc2UpOwogICAgdGhpcy5zdHJva2Uob3BJZHgsIHBhdGgsIGZhbHNlKTsKICAgIHRoaXMuY29uc3VtZVBhdGgob3BJZHgsIHBhdGgpOwogIH0KICBlb0ZpbGxTdHJva2Uob3BJZHgsIHBhdGgpIHsKICAgIHRoaXMucGVuZGluZ0VPRmlsbCA9IHRydWU7CiAgICB0aGlzLmZpbGxTdHJva2Uob3BJZHgsIHBhdGgpOwogIH0KICBjbG9zZUZpbGxTdHJva2Uob3BJZHgsIHBhdGgpIHsKICAgIHRoaXMuZmlsbFN0cm9rZShvcElkeCwgcGF0aCk7CiAgfQogIGNsb3NlRU9GaWxsU3Ryb2tlKG9wSWR4LCBwYXRoKSB7CiAgICB0aGlzLnBlbmRpbmdFT0ZpbGwgPSB0cnVlOwogICAgdGhpcy5maWxsU3Ryb2tlKG9wSWR4LCBwYXRoKTsKICB9CiAgZW5kUGF0aChvcElkeCwgcGF0aCkgewogICAgdGhpcy5jb25zdW1lUGF0aChvcElkeCwgcGF0aCk7CiAgfQogIHJhd0ZpbGxQYXRoKG9wSWR4LCBwYXRoKSB7CiAgICB0aGlzLmN0eC5maWxsKHBhdGgpOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMucmF3RmlsbFBhdGgpLnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgfQogIGNsaXAob3BJZHgpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3koImNsaXBNb2RlIiwgb3BJZHgpOwogICAgdGhpcy5wZW5kaW5nQ2xpcCA9IE5PUk1BTF9DTElQOwogIH0KICBlb0NsaXAob3BJZHgpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3koImNsaXBNb2RlIiwgb3BJZHgpOwogICAgdGhpcy5wZW5kaW5nQ2xpcCA9IEVPX0NMSVA7CiAgfQogIGJlZ2luVGV4dChvcElkeCkgewogICAgdGhpcy5jdXJyZW50LnRleHRNYXRyaXggPSBudWxsOwogICAgdGhpcy5jdXJyZW50LnRleHRNYXRyaXhTY2FsZSA9IDE7CiAgICB0aGlzLmN1cnJlbnQueCA9IHRoaXMuY3VycmVudC5saW5lWCA9IDA7CiAgICB0aGlzLmN1cnJlbnQueSA9IHRoaXMuY3VycmVudC5saW5lWSA9IDA7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRPcGVuTWFya2VyKG9wSWR4KS5yZXNldEluY3JlbWVudGFsRGF0YSgic2FtZUxpbmVUZXh0IikucmVzZXRJbmNyZW1lbnRhbERhdGEoIm1vdmVUZXh0Iiwgb3BJZHgpOwogIH0KICBlbmRUZXh0KG9wSWR4KSB7CiAgICBjb25zdCBwYXRocyA9IHRoaXMucGVuZGluZ1RleHRQYXRoczsKICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgaWYgKHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIpIHsKICAgICAgY29uc3QgewogICAgICAgIGRlcGVuZGVuY3lUcmFja2VyCiAgICAgIH0gPSB0aGlzOwogICAgICBpZiAocGF0aHMgIT09IHZvaWQgMCkgewogICAgICAgIGRlcGVuZGVuY3lUcmFja2VyLnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3koInRleHRDbGlwIiwgZGVwZW5kZW5jeVRyYWNrZXIuZ2V0T3Blbk1hcmtlcigpKS5yZWNvcmRGdXR1cmVGb3JjZWREZXBlbmRlbmN5KCJ0ZXh0Q2xpcCIsIG9wSWR4KTsKICAgICAgfQogICAgICBkZXBlbmRlbmN5VHJhY2tlci5yZWNvcmRDbG9zZU1hcmtlcihvcElkeCk7CiAgICB9CiAgICBpZiAocGF0aHMgIT09IHZvaWQgMCkgewogICAgICBjb25zdCBuZXdQYXRoID0gbmV3IFBhdGgyRCgpOwogICAgICBjb25zdCBpbnZUcmFuc2YgPSBjdHguZ2V0VHJhbnNmb3JtKCkuaW52ZXJ0U2VsZigpOwogICAgICBmb3IgKGNvbnN0IHsKICAgICAgICB0cmFuc2Zvcm0sCiAgICAgICAgeCwKICAgICAgICB5LAogICAgICAgIGZvbnRTaXplLAogICAgICAgIHBhdGgKICAgICAgfSBvZiBwYXRocykgewogICAgICAgIGlmICghcGF0aCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIG5ld1BhdGguYWRkUGF0aChwYXRoLCBuZXcgRE9NTWF0cml4KHRyYW5zZm9ybSkucHJlTXVsdGlwbHlTZWxmKGludlRyYW5zZikudHJhbnNsYXRlKHgsIHkpLnNjYWxlKGZvbnRTaXplLCAtZm9udFNpemUpKTsKICAgICAgfQogICAgICBjdHguY2xpcChuZXdQYXRoKTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLnBlbmRpbmdUZXh0UGF0aHM7CiAgfQogIHNldENoYXJTcGFjaW5nKG9wSWR4LCBzcGFjaW5nKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJjaGFyU3BhY2luZyIsIG9wSWR4KTsKICAgIHRoaXMuY3VycmVudC5jaGFyU3BhY2luZyA9IHNwYWNpbmc7CiAgfQogIHNldFdvcmRTcGFjaW5nKG9wSWR4LCBzcGFjaW5nKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJ3b3JkU3BhY2luZyIsIG9wSWR4KTsKICAgIHRoaXMuY3VycmVudC53b3JkU3BhY2luZyA9IHNwYWNpbmc7CiAgfQogIHNldEhTY2FsZShvcElkeCwgc2NhbGUpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImhTY2FsZSIsIG9wSWR4KTsKICAgIHRoaXMuY3VycmVudC50ZXh0SFNjYWxlID0gc2NhbGUgLyAxMDA7CiAgfQogIHNldExlYWRpbmcob3BJZHgsIGxlYWRpbmcpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoImxlYWRpbmciLCBvcElkeCk7CiAgICB0aGlzLmN1cnJlbnQubGVhZGluZyA9IC1sZWFkaW5nOwogIH0KICBzZXRGb250KG9wSWR4LCBmb250UmVmTmFtZSwgc2l6ZSkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgiZm9udCIsIG9wSWR4KS5yZWNvcmRTaW1wbGVEYXRhRnJvbU5hbWVkKCJmb250T2JqIiwgZm9udFJlZk5hbWUsIG9wSWR4KTsKICAgIGNvbnN0IGZvbnRPYmogPSB0aGlzLmNvbW1vbk9ianMuZ2V0KGZvbnRSZWZOYW1lKTsKICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CiAgICBpZiAoIWZvbnRPYmopIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW4ndCBmaW5kIGZvbnQgZm9yICR7Zm9udFJlZk5hbWV9YCk7CiAgICB9CiAgICBjdXJyZW50LmZvbnRNYXRyaXggPSBmb250T2JqLmZvbnRNYXRyaXggfHwgRk9OVF9JREVOVElUWV9NQVRSSVg7CiAgICBpZiAoY3VycmVudC5mb250TWF0cml4WzBdID09PSAwIHx8IGN1cnJlbnQuZm9udE1hdHJpeFszXSA9PT0gMCkgewogICAgICB3YXJuKCJJbnZhbGlkIGZvbnQgbWF0cml4IGZvciBmb250ICIgKyBmb250UmVmTmFtZSk7CiAgICB9CiAgICBpZiAoc2l6ZSA8IDApIHsKICAgICAgc2l6ZSA9IC1zaXplOwogICAgICBjdXJyZW50LmZvbnREaXJlY3Rpb24gPSAtMTsKICAgIH0gZWxzZSB7CiAgICAgIGN1cnJlbnQuZm9udERpcmVjdGlvbiA9IDE7CiAgICB9CiAgICB0aGlzLmN1cnJlbnQuZm9udCA9IGZvbnRPYmo7CiAgICB0aGlzLmN1cnJlbnQuZm9udFNpemUgPSBzaXplOwogICAgaWYgKGZvbnRPYmouaXNUeXBlM0ZvbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbmFtZSA9IGZvbnRPYmoubG9hZGVkTmFtZSB8fCAic2Fucy1zZXJpZiI7CiAgICBjb25zdCB0eXBlZmFjZSA9IGZvbnRPYmouc3lzdGVtRm9udEluZm8/LmNzcyB8fCBgIiR7bmFtZX0iLCAke2ZvbnRPYmouZmFsbGJhY2tOYW1lfWA7CiAgICBsZXQgYm9sZCA9ICJub3JtYWwiOwogICAgaWYgKGZvbnRPYmouYmxhY2spIHsKICAgICAgYm9sZCA9ICI5MDAiOwogICAgfSBlbHNlIGlmIChmb250T2JqLmJvbGQpIHsKICAgICAgYm9sZCA9ICJib2xkIjsKICAgIH0KICAgIGNvbnN0IGl0YWxpYyA9IGZvbnRPYmouaXRhbGljID8gIml0YWxpYyIgOiAibm9ybWFsIjsKICAgIGxldCBicm93c2VyRm9udFNpemUgPSBzaXplOwogICAgaWYgKHNpemUgPCBNSU5fRk9OVF9TSVpFKSB7CiAgICAgIGJyb3dzZXJGb250U2l6ZSA9IE1JTl9GT05UX1NJWkU7CiAgICB9IGVsc2UgaWYgKHNpemUgPiBNQVhfRk9OVF9TSVpFKSB7CiAgICAgIGJyb3dzZXJGb250U2l6ZSA9IE1BWF9GT05UX1NJWkU7CiAgICB9CiAgICB0aGlzLmN1cnJlbnQuZm9udFNpemVTY2FsZSA9IHNpemUgLyBicm93c2VyRm9udFNpemU7CiAgICB0aGlzLmN0eC5mb250ID0gYCR7aXRhbGljfSAke2JvbGR9ICR7YnJvd3NlckZvbnRTaXplfXB4ICR7dHlwZWZhY2V9YDsKICB9CiAgc2V0VGV4dFJlbmRlcmluZ01vZGUob3BJZHgsIG1vZGUpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoInRleHRSZW5kZXJpbmdNb2RlIiwgb3BJZHgpOwogICAgdGhpcy5jdXJyZW50LnRleHRSZW5kZXJpbmdNb2RlID0gbW9kZTsKICB9CiAgc2V0VGV4dFJpc2Uob3BJZHgsIHJpc2UpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNpbXBsZURhdGEoInRleHRSaXNlIiwgb3BJZHgpOwogICAgdGhpcy5jdXJyZW50LnRleHRSaXNlID0gcmlzZTsKICB9CiAgbW92ZVRleHQob3BJZHgsIHgsIHkpIHsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc2V0SW5jcmVtZW50YWxEYXRhKCJzYW1lTGluZVRleHQiKS5yZWNvcmRJbmNyZW1lbnRhbERhdGEoIm1vdmVUZXh0Iiwgb3BJZHgpOwogICAgdGhpcy5jdXJyZW50LnggPSB0aGlzLmN1cnJlbnQubGluZVggKz0geDsKICAgIHRoaXMuY3VycmVudC55ID0gdGhpcy5jdXJyZW50LmxpbmVZICs9IHk7CiAgfQogIHNldExlYWRpbmdNb3ZlVGV4dChvcElkeCwgeCwgeSkgewogICAgdGhpcy5zZXRMZWFkaW5nKG9wSWR4LCAteSk7CiAgICB0aGlzLm1vdmVUZXh0KG9wSWR4LCB4LCB5KTsKICB9CiAgc2V0VGV4dE1hdHJpeChvcElkeCwgbWF0cml4KSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZXNldEluY3JlbWVudGFsRGF0YSgic2FtZUxpbmVUZXh0IikucmVjb3JkU2ltcGxlRGF0YSgidGV4dE1hdHJpeCIsIG9wSWR4KTsKICAgIGNvbnN0IHsKICAgICAgY3VycmVudAogICAgfSA9IHRoaXM7CiAgICBjdXJyZW50LnRleHRNYXRyaXggPSBtYXRyaXg7CiAgICBjdXJyZW50LnRleHRNYXRyaXhTY2FsZSA9IE1hdGguaHlwb3QobWF0cml4WzBdLCBtYXRyaXhbMV0pOwogICAgY3VycmVudC54ID0gY3VycmVudC5saW5lWCA9IDA7CiAgICBjdXJyZW50LnkgPSBjdXJyZW50LmxpbmVZID0gMDsKICB9CiAgbmV4dExpbmUob3BJZHgpIHsKICAgIHRoaXMubW92ZVRleHQob3BJZHgsIDAsIHRoaXMuY3VycmVudC5sZWFkaW5nKTsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZEluY3JlbWVudGFsRGF0YSgibW92ZVRleHQiLCB0aGlzLmRlcGVuZGVuY3lUcmFja2VyLmdldFNpbXBsZUluZGV4KCJsZWFkaW5nIikgPz8gb3BJZHgpOwogIH0KICAjZ2V0U2NhbGVkUGF0aChwYXRoLCBjdXJyZW50VHJhbnNmb3JtLCB0cmFuc2Zvcm0pIHsKICAgIGNvbnN0IG5ld1BhdGggPSBuZXcgUGF0aDJEKCk7CiAgICBuZXdQYXRoLmFkZFBhdGgocGF0aCwgbmV3IERPTU1hdHJpeCh0cmFuc2Zvcm0pLmludmVydFNlbGYoKS5tdWx0aXBseVNlbGYoY3VycmVudFRyYW5zZm9ybSkpOwogICAgcmV0dXJuIG5ld1BhdGg7CiAgfQogIHBhaW50Q2hhcihvcElkeCwgY2hhcmFjdGVyLCB4LCB5LCBwYXR0ZXJuRmlsbFRyYW5zZm9ybSwgcGF0dGVyblN0cm9rZVRyYW5zZm9ybSkgewogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5jdXJyZW50OwogICAgY29uc3QgZm9udCA9IGN1cnJlbnQuZm9udDsKICAgIGNvbnN0IHRleHRSZW5kZXJpbmdNb2RlID0gY3VycmVudC50ZXh0UmVuZGVyaW5nTW9kZTsKICAgIGNvbnN0IGZvbnRTaXplID0gY3VycmVudC5mb250U2l6ZSAvIGN1cnJlbnQuZm9udFNpemVTY2FsZTsKICAgIGNvbnN0IGZpbGxTdHJva2VNb2RlID0gdGV4dFJlbmRlcmluZ01vZGUgJiBUZXh0UmVuZGVyaW5nTW9kZS5GSUxMX1NUUk9LRV9NQVNLOwogICAgY29uc3QgaXNBZGRUb1BhdGhTZXQgPSAhISh0ZXh0UmVuZGVyaW5nTW9kZSAmIFRleHRSZW5kZXJpbmdNb2RlLkFERF9UT19QQVRIX0ZMQUcpOwogICAgY29uc3QgcGF0dGVybkZpbGwgPSBjdXJyZW50LnBhdHRlcm5GaWxsICYmICFmb250Lm1pc3NpbmdGaWxlOwogICAgY29uc3QgcGF0dGVyblN0cm9rZSA9IGN1cnJlbnQucGF0dGVyblN0cm9rZSAmJiAhZm9udC5taXNzaW5nRmlsZTsKICAgIGxldCBwYXRoOwogICAgaWYgKChmb250LmRpc2FibGVGb250RmFjZSB8fCBpc0FkZFRvUGF0aFNldCB8fCBwYXR0ZXJuRmlsbCB8fCBwYXR0ZXJuU3Ryb2tlKSAmJiAhZm9udC5taXNzaW5nRmlsZSkgewogICAgICBwYXRoID0gZm9udC5nZXRQYXRoR2VuZXJhdG9yKHRoaXMuY29tbW9uT2JqcywgY2hhcmFjdGVyKTsKICAgIH0KICAgIGlmIChwYXRoICYmIChmb250LmRpc2FibGVGb250RmFjZSB8fCBwYXR0ZXJuRmlsbCB8fCBwYXR0ZXJuU3Ryb2tlKSkgewogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHgudHJhbnNsYXRlKHgsIHkpOwogICAgICBjdHguc2NhbGUoZm9udFNpemUsIC1mb250U2l6ZSk7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZENoYXJhY3RlckJCb3gob3BJZHgsIGN0eCwgZm9udCk7CiAgICAgIGxldCBjdXJyZW50VHJhbnNmb3JtOwogICAgICBpZiAoZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLkZJTEwgfHwgZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLkZJTExfU1RST0tFKSB7CiAgICAgICAgaWYgKHBhdHRlcm5GaWxsVHJhbnNmb3JtKSB7CiAgICAgICAgICBjdXJyZW50VHJhbnNmb3JtID0gY3R4LmdldFRyYW5zZm9ybSgpOwogICAgICAgICAgY3R4LnNldFRyYW5zZm9ybSguLi5wYXR0ZXJuRmlsbFRyYW5zZm9ybSk7CiAgICAgICAgICBjb25zdCBzY2FsZWRQYXRoID0gdGhpcy4jZ2V0U2NhbGVkUGF0aChwYXRoLCBjdXJyZW50VHJhbnNmb3JtLCBwYXR0ZXJuRmlsbFRyYW5zZm9ybSk7CiAgICAgICAgICBjdHguZmlsbChzY2FsZWRQYXRoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3R4LmZpbGwocGF0aCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuU1RST0tFIHx8IGZpbGxTdHJva2VNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5GSUxMX1NUUk9LRSkgewogICAgICAgIGlmIChwYXR0ZXJuU3Ryb2tlVHJhbnNmb3JtKSB7CiAgICAgICAgICBjdXJyZW50VHJhbnNmb3JtIHx8PSBjdHguZ2V0VHJhbnNmb3JtKCk7CiAgICAgICAgICBjdHguc2V0VHJhbnNmb3JtKC4uLnBhdHRlcm5TdHJva2VUcmFuc2Zvcm0pOwogICAgICAgICAgY29uc3QgewogICAgICAgICAgICBhLAogICAgICAgICAgICBiLAogICAgICAgICAgICBjLAogICAgICAgICAgICBkCiAgICAgICAgICB9ID0gY3VycmVudFRyYW5zZm9ybTsKICAgICAgICAgIGNvbnN0IGludlBhdHRlcm5UcmFuc2Zvcm0gPSBVdGlsLmludmVyc2VUcmFuc2Zvcm0ocGF0dGVyblN0cm9rZVRyYW5zZm9ybSk7CiAgICAgICAgICBjb25zdCB0cmFuc2YgPSBVdGlsLnRyYW5zZm9ybShbYSwgYiwgYywgZCwgMCwgMF0sIGludlBhdHRlcm5UcmFuc2Zvcm0pOwogICAgICAgICAgVXRpbC5zaW5ndWxhclZhbHVlRGVjb21wb3NlMmRTY2FsZSh0cmFuc2YsIFhZKTsKICAgICAgICAgIGN0eC5saW5lV2lkdGggKj0gTWF0aC5tYXgoWFlbMF0sIFhZWzFdKSAvIGZvbnRTaXplOwogICAgICAgICAgY3R4LnN0cm9rZSh0aGlzLiNnZXRTY2FsZWRQYXRoKHBhdGgsIGN1cnJlbnRUcmFuc2Zvcm0sIHBhdHRlcm5TdHJva2VUcmFuc2Zvcm0pKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3R4LmxpbmVXaWR0aCAvPSBmb250U2l6ZTsKICAgICAgICAgIGN0eC5zdHJva2UocGF0aCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9IGVsc2UgewogICAgICBpZiAoZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLkZJTEwgfHwgZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLkZJTExfU1RST0tFKSB7CiAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXJhY3RlciwgeCwgeSk7CiAgICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkQ2hhcmFjdGVyQkJveChvcElkeCwgY3R4LCBmb250LCBmb250U2l6ZSwgeCwgeSwgKCkgPT4gY3R4Lm1lYXN1cmVUZXh0KGNoYXJhY3RlcikpOwogICAgICB9CiAgICAgIGlmIChmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuU1RST0tFIHx8IGZpbGxTdHJva2VNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5GSUxMX1NUUk9LRSkgewogICAgICAgIGlmICh0aGlzLmRlcGVuZGVuY3lUcmFja2VyKSB7CiAgICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRDaGFyYWN0ZXJCQm94KG9wSWR4LCBjdHgsIGZvbnQsIGZvbnRTaXplLCB4LCB5LCAoKSA9PiBjdHgubWVhc3VyZVRleHQoY2hhcmFjdGVyKSkucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMuc3Ryb2tlKTsKICAgICAgICB9CiAgICAgICAgY3R4LnN0cm9rZVRleHQoY2hhcmFjdGVyLCB4LCB5KTsKICAgICAgfQogICAgfQogICAgaWYgKGlzQWRkVG9QYXRoU2V0KSB7CiAgICAgIGNvbnN0IHBhdGhzID0gdGhpcy5wZW5kaW5nVGV4dFBhdGhzIHx8PSBbXTsKICAgICAgcGF0aHMucHVzaCh7CiAgICAgICAgdHJhbnNmb3JtOiBnZXRDdXJyZW50VHJhbnNmb3JtKGN0eCksCiAgICAgICAgeCwKICAgICAgICB5LAogICAgICAgIGZvbnRTaXplLAogICAgICAgIHBhdGgKICAgICAgfSk7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZENoYXJhY3RlckJCb3gob3BJZHgsIGN0eCwgZm9udCwgZm9udFNpemUsIHgsIHkpOwogICAgfQogIH0KICBnZXQgaXNGb250U3VicGl4ZWxBQUVuYWJsZWQoKSB7CiAgICBjb25zdCB7CiAgICAgIGNvbnRleHQ6IGN0eAogICAgfSA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJpc0ZvbnRTdWJwaXhlbEFBRW5hYmxlZCIsIDEwLCAxMCk7CiAgICBjdHguc2NhbGUoMS41LCAxKTsKICAgIGN0eC5maWxsVGV4dCgiSSIsIDAsIDEwKTsKICAgIGNvbnN0IGRhdGEgPSBjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIDEwLCAxMCkuZGF0YTsKICAgIGxldCBlbmFibGVkID0gZmFsc2U7CiAgICBmb3IgKGxldCBpID0gMzsgaSA8IGRhdGEubGVuZ3RoOyBpICs9IDQpIHsKICAgICAgaWYgKGRhdGFbaV0gPiAwICYmIGRhdGFbaV0gPCAyNTUpIHsKICAgICAgICBlbmFibGVkID0gdHJ1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaXNGb250U3VicGl4ZWxBQUVuYWJsZWQiLCBlbmFibGVkKTsKICB9CiAgc2hvd1RleHQob3BJZHgsIGdseXBocykgewogICAgaWYgKHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIpIHsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlci5yZWNvcmREZXBlbmRlbmNpZXMob3BJZHgsIERlcGVuZGVuY2llcy5zaG93VGV4dCkucmVzZXRCQm94KG9wSWR4KTsKICAgICAgaWYgKHRoaXMuY3VycmVudC50ZXh0UmVuZGVyaW5nTW9kZSAmIFRleHRSZW5kZXJpbmdNb2RlLkFERF9UT19QQVRIX0ZMQUcpIHsKICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyLnJlY29yZEZ1dHVyZUZvcmNlZERlcGVuZGVuY3koInRleHRDbGlwIiwgb3BJZHgpLmluaGVyaXRQZW5kaW5nRGVwZW5kZW5jaWVzQXNGdXR1cmVGb3JjZWREZXBlbmRlbmNpZXMoKTsKICAgICAgfQogICAgfQogICAgY29uc3QgY3VycmVudCA9IHRoaXMuY3VycmVudDsKICAgIGNvbnN0IGZvbnQgPSBjdXJyZW50LmZvbnQ7CiAgICBpZiAoZm9udC5pc1R5cGUzRm9udCkgewogICAgICB0aGlzLnNob3dUeXBlM1RleHQob3BJZHgsIGdseXBocyk7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZFNob3dUZXh0T3BlcmF0aW9uKG9wSWR4KTsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGNvbnN0IGZvbnRTaXplID0gY3VycmVudC5mb250U2l6ZTsKICAgIGlmIChmb250U2l6ZSA9PT0gMCkgewogICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRPcGVyYXRpb24ob3BJZHgpOwogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBjb25zdCBmb250U2l6ZVNjYWxlID0gY3VycmVudC5mb250U2l6ZVNjYWxlOwogICAgY29uc3QgY2hhclNwYWNpbmcgPSBjdXJyZW50LmNoYXJTcGFjaW5nOwogICAgY29uc3Qgd29yZFNwYWNpbmcgPSBjdXJyZW50LndvcmRTcGFjaW5nOwogICAgY29uc3QgZm9udERpcmVjdGlvbiA9IGN1cnJlbnQuZm9udERpcmVjdGlvbjsKICAgIGNvbnN0IHRleHRIU2NhbGUgPSBjdXJyZW50LnRleHRIU2NhbGUgKiBmb250RGlyZWN0aW9uOwogICAgY29uc3QgZ2x5cGhzTGVuZ3RoID0gZ2x5cGhzLmxlbmd0aDsKICAgIGNvbnN0IHZlcnRpY2FsID0gZm9udC52ZXJ0aWNhbDsKICAgIGNvbnN0IHNwYWNpbmdEaXIgPSB2ZXJ0aWNhbCA/IDEgOiAtMTsKICAgIGNvbnN0IGRlZmF1bHRWTWV0cmljcyA9IGZvbnQuZGVmYXVsdFZNZXRyaWNzOwogICAgY29uc3Qgd2lkdGhBZHZhbmNlU2NhbGUgPSBmb250U2l6ZSAqIGN1cnJlbnQuZm9udE1hdHJpeFswXTsKICAgIGNvbnN0IHNpbXBsZUZpbGxUZXh0ID0gY3VycmVudC50ZXh0UmVuZGVyaW5nTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTCAmJiAhZm9udC5kaXNhYmxlRm9udEZhY2UgJiYgIWN1cnJlbnQucGF0dGVybkZpbGw7CiAgICBjdHguc2F2ZSgpOwogICAgaWYgKGN1cnJlbnQudGV4dE1hdHJpeCkgewogICAgICBjdHgudHJhbnNmb3JtKC4uLmN1cnJlbnQudGV4dE1hdHJpeCk7CiAgICB9CiAgICBjdHgudHJhbnNsYXRlKGN1cnJlbnQueCwgY3VycmVudC55ICsgY3VycmVudC50ZXh0UmlzZSk7CiAgICBpZiAoZm9udERpcmVjdGlvbiA+IDApIHsKICAgICAgY3R4LnNjYWxlKHRleHRIU2NhbGUsIC0xKTsKICAgIH0gZWxzZSB7CiAgICAgIGN0eC5zY2FsZSh0ZXh0SFNjYWxlLCAxKTsKICAgIH0KICAgIGxldCBwYXR0ZXJuRmlsbFRyYW5zZm9ybSwgcGF0dGVyblN0cm9rZVRyYW5zZm9ybTsKICAgIGNvbnN0IGZpbGxTdHJva2VNb2RlID0gY3VycmVudC50ZXh0UmVuZGVyaW5nTW9kZSAmIFRleHRSZW5kZXJpbmdNb2RlLkZJTExfU1RST0tFX01BU0s7CiAgICBjb25zdCBuZWVkc0ZpbGwgPSBmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTCB8fCBmaWxsU3Ryb2tlTW9kZSA9PT0gVGV4dFJlbmRlcmluZ01vZGUuRklMTF9TVFJPS0U7CiAgICBjb25zdCBuZWVkc1N0cm9rZSA9IGZpbGxTdHJva2VNb2RlID09PSBUZXh0UmVuZGVyaW5nTW9kZS5TVFJPS0UgfHwgZmlsbFN0cm9rZU1vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLkZJTExfU1RST0tFOwogICAgaWYgKG5lZWRzRmlsbCAmJiBjdXJyZW50LnBhdHRlcm5GaWxsKSB7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGNvbnN0IHBhdHRlcm4gPSBjdXJyZW50LmZpbGxDb2xvci5nZXRQYXR0ZXJuKGN0eCwgdGhpcywgZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoY3R4KSwgUGF0aFR5cGUuRklMTCwgb3BJZHgpOwogICAgICBwYXR0ZXJuRmlsbFRyYW5zZm9ybSA9IGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgY3R4LmZpbGxTdHlsZSA9IHBhdHRlcm47CiAgICB9CiAgICBpZiAobmVlZHNTdHJva2UgJiYgY3VycmVudC5wYXR0ZXJuU3Ryb2tlKSB7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGNvbnN0IHBhdHRlcm4gPSBjdXJyZW50LnN0cm9rZUNvbG9yLmdldFBhdHRlcm4oY3R4LCB0aGlzLCBnZXRDdXJyZW50VHJhbnNmb3JtSW52ZXJzZShjdHgpLCBQYXRoVHlwZS5TVFJPS0UsIG9wSWR4KTsKICAgICAgcGF0dGVyblN0cm9rZVRyYW5zZm9ybSA9IGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgY3R4LnN0cm9rZVN0eWxlID0gcGF0dGVybjsKICAgIH0KICAgIGxldCBsaW5lV2lkdGggPSBjdXJyZW50LmxpbmVXaWR0aDsKICAgIGNvbnN0IHNjYWxlID0gY3VycmVudC50ZXh0TWF0cml4U2NhbGU7CiAgICBpZiAoc2NhbGUgPT09IDAgfHwgbGluZVdpZHRoID09PSAwKSB7CiAgICAgIGlmIChuZWVkc1N0cm9rZSkgewogICAgICAgIGxpbmVXaWR0aCA9IHRoaXMuZ2V0U2luZ2xlUGl4ZWxXaWR0aCgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBsaW5lV2lkdGggLz0gc2NhbGU7CiAgICB9CiAgICBpZiAoZm9udFNpemVTY2FsZSAhPT0gMSkgewogICAgICBjdHguc2NhbGUoZm9udFNpemVTY2FsZSwgZm9udFNpemVTY2FsZSk7CiAgICAgIGxpbmVXaWR0aCAvPSBmb250U2l6ZVNjYWxlOwogICAgfQogICAgY3R4LmxpbmVXaWR0aCA9IGxpbmVXaWR0aDsKICAgIGlmIChmb250LmlzSW52YWxpZFBERmpzRm9udCkgewogICAgICBjb25zdCBjaGFycyA9IFtdOwogICAgICBsZXQgd2lkdGggPSAwOwogICAgICBmb3IgKGNvbnN0IGdseXBoIG9mIGdseXBocykgewogICAgICAgIGNoYXJzLnB1c2goZ2x5cGgudW5pY29kZSk7CiAgICAgICAgd2lkdGggKz0gZ2x5cGgud2lkdGg7CiAgICAgIH0KICAgICAgY29uc3Qgam9pbmVkQ2hhcnMgPSBjaGFycy5qb2luKCIiKTsKICAgICAgY3R4LmZpbGxUZXh0KGpvaW5lZENoYXJzLCAwLCAwKTsKICAgICAgaWYgKHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIgIT09IG51bGwpIHsKICAgICAgICBjb25zdCBtZWFzdXJlID0gY3R4Lm1lYXN1cmVUZXh0KGpvaW5lZENoYXJzKTsKICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyLnJlY29yZEJCb3gob3BJZHgsIHRoaXMuY3R4LCAtbWVhc3VyZS5hY3R1YWxCb3VuZGluZ0JveExlZnQsIG1lYXN1cmUuYWN0dWFsQm91bmRpbmdCb3hSaWdodCwgLW1lYXN1cmUuYWN0dWFsQm91bmRpbmdCb3hBc2NlbnQsIG1lYXN1cmUuYWN0dWFsQm91bmRpbmdCb3hEZXNjZW50KS5yZWNvcmRTaG93VGV4dE9wZXJhdGlvbihvcElkeCk7CiAgICAgIH0KICAgICAgY3VycmVudC54ICs9IHdpZHRoICogd2lkdGhBZHZhbmNlU2NhbGUgKiB0ZXh0SFNjYWxlOwogICAgICBjdHgucmVzdG9yZSgpOwogICAgICB0aGlzLmNvbXBvc2UoKTsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGxldCB4ID0gMCwgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBnbHlwaHNMZW5ndGg7ICsraSkgewogICAgICBjb25zdCBnbHlwaCA9IGdseXBoc1tpXTsKICAgICAgaWYgKHR5cGVvZiBnbHlwaCA9PT0gIm51bWJlciIpIHsKICAgICAgICB4ICs9IHNwYWNpbmdEaXIgKiBnbHlwaCAqIGZvbnRTaXplIC8gMWUzOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGxldCByZXN0b3JlTmVlZGVkID0gZmFsc2U7CiAgICAgIGNvbnN0IHNwYWNpbmcgPSAoZ2x5cGguaXNTcGFjZSA/IHdvcmRTcGFjaW5nIDogMCkgKyBjaGFyU3BhY2luZzsKICAgICAgY29uc3QgY2hhcmFjdGVyID0gZ2x5cGguZm9udENoYXI7CiAgICAgIGNvbnN0IGFjY2VudCA9IGdseXBoLmFjY2VudDsKICAgICAgbGV0IHNjYWxlZFgsIHNjYWxlZFk7CiAgICAgIGxldCB3aWR0aCA9IGdseXBoLndpZHRoOwogICAgICBpZiAodmVydGljYWwpIHsKICAgICAgICBjb25zdCB2bWV0cmljID0gZ2x5cGgudm1ldHJpYyB8fCBkZWZhdWx0Vk1ldHJpY3M7CiAgICAgICAgY29uc3QgdnggPSAtKGdseXBoLnZtZXRyaWMgPyB2bWV0cmljWzFdIDogd2lkdGggKiAwLjUpICogd2lkdGhBZHZhbmNlU2NhbGU7CiAgICAgICAgY29uc3QgdnkgPSB2bWV0cmljWzJdICogd2lkdGhBZHZhbmNlU2NhbGU7CiAgICAgICAgd2lkdGggPSB2bWV0cmljID8gLXZtZXRyaWNbMF0gOiB3aWR0aDsKICAgICAgICBzY2FsZWRYID0gdnggLyBmb250U2l6ZVNjYWxlOwogICAgICAgIHNjYWxlZFkgPSAoeCArIHZ5KSAvIGZvbnRTaXplU2NhbGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2NhbGVkWCA9IHggLyBmb250U2l6ZVNjYWxlOwogICAgICAgIHNjYWxlZFkgPSAwOwogICAgICB9CiAgICAgIGxldCBtZWFzdXJlOwogICAgICBpZiAoZm9udC5yZW1lYXN1cmUgJiYgd2lkdGggPiAwKSB7CiAgICAgICAgbWVhc3VyZSA9IGN0eC5tZWFzdXJlVGV4dChjaGFyYWN0ZXIpOwogICAgICAgIGNvbnN0IG1lYXN1cmVkV2lkdGggPSBtZWFzdXJlLndpZHRoICogMWUzIC8gZm9udFNpemUgKiBmb250U2l6ZVNjYWxlOwogICAgICAgIGlmICh3aWR0aCA8IG1lYXN1cmVkV2lkdGggJiYgdGhpcy5pc0ZvbnRTdWJwaXhlbEFBRW5hYmxlZCkgewogICAgICAgICAgY29uc3QgY2hhcmFjdGVyU2NhbGVYID0gd2lkdGggLyBtZWFzdXJlZFdpZHRoOwogICAgICAgICAgcmVzdG9yZU5lZWRlZCA9IHRydWU7CiAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgY3R4LnNjYWxlKGNoYXJhY3RlclNjYWxlWCwgMSk7CiAgICAgICAgICBzY2FsZWRYIC89IGNoYXJhY3RlclNjYWxlWDsKICAgICAgICB9IGVsc2UgaWYgKHdpZHRoICE9PSBtZWFzdXJlZFdpZHRoKSB7CiAgICAgICAgICBzY2FsZWRYICs9ICh3aWR0aCAtIG1lYXN1cmVkV2lkdGgpIC8gMmUzICogZm9udFNpemUgLyBmb250U2l6ZVNjYWxlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodGhpcy5jb250ZW50VmlzaWJsZSAmJiAoZ2x5cGguaXNJbkZvbnQgfHwgZm9udC5taXNzaW5nRmlsZSkpIHsKICAgICAgICBpZiAoc2ltcGxlRmlsbFRleHQgJiYgIWFjY2VudCkgewogICAgICAgICAgY3R4LmZpbGxUZXh0KGNoYXJhY3Rlciwgc2NhbGVkWCwgc2NhbGVkWSk7CiAgICAgICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRDaGFyYWN0ZXJCQm94KG9wSWR4LCBjdHgsIG1lYXN1cmUgPyB7CiAgICAgICAgICAgIGJib3g6IG51bGwKICAgICAgICAgIH0gOiBmb250LCBmb250U2l6ZSAvIGZvbnRTaXplU2NhbGUsIHNjYWxlZFgsIHNjYWxlZFksICgpID0+IG1lYXN1cmUgPz8gY3R4Lm1lYXN1cmVUZXh0KGNoYXJhY3RlcikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnBhaW50Q2hhcihvcElkeCwgY2hhcmFjdGVyLCBzY2FsZWRYLCBzY2FsZWRZLCBwYXR0ZXJuRmlsbFRyYW5zZm9ybSwgcGF0dGVyblN0cm9rZVRyYW5zZm9ybSk7CiAgICAgICAgICBpZiAoYWNjZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHNjYWxlZEFjY2VudFggPSBzY2FsZWRYICsgZm9udFNpemUgKiBhY2NlbnQub2Zmc2V0LnggLyBmb250U2l6ZVNjYWxlOwogICAgICAgICAgICBjb25zdCBzY2FsZWRBY2NlbnRZID0gc2NhbGVkWSAtIGZvbnRTaXplICogYWNjZW50Lm9mZnNldC55IC8gZm9udFNpemVTY2FsZTsKICAgICAgICAgICAgdGhpcy5wYWludENoYXIob3BJZHgsIGFjY2VudC5mb250Q2hhciwgc2NhbGVkQWNjZW50WCwgc2NhbGVkQWNjZW50WSwgcGF0dGVybkZpbGxUcmFuc2Zvcm0sIHBhdHRlcm5TdHJva2VUcmFuc2Zvcm0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBjaGFyV2lkdGggPSB2ZXJ0aWNhbCA/IHdpZHRoICogd2lkdGhBZHZhbmNlU2NhbGUgLSBzcGFjaW5nICogZm9udERpcmVjdGlvbiA6IHdpZHRoICogd2lkdGhBZHZhbmNlU2NhbGUgKyBzcGFjaW5nICogZm9udERpcmVjdGlvbjsKICAgICAgeCArPSBjaGFyV2lkdGg7CiAgICAgIGlmIChyZXN0b3JlTmVlZGVkKSB7CiAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgfQogICAgfQogICAgaWYgKHZlcnRpY2FsKSB7CiAgICAgIGN1cnJlbnQueSAtPSB4OwogICAgfSBlbHNlIHsKICAgICAgY3VycmVudC54ICs9IHggKiB0ZXh0SFNjYWxlOwogICAgfQogICAgY3R4LnJlc3RvcmUoKTsKICAgIHRoaXMuY29tcG9zZSgpOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2hvd1RleHRPcGVyYXRpb24ob3BJZHgpOwogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgc2hvd1R5cGUzVGV4dChvcElkeCwgZ2x5cGhzKSB7CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmN1cnJlbnQ7CiAgICBjb25zdCBmb250ID0gY3VycmVudC5mb250OwogICAgY29uc3QgZm9udFNpemUgPSBjdXJyZW50LmZvbnRTaXplOwogICAgY29uc3QgZm9udERpcmVjdGlvbiA9IGN1cnJlbnQuZm9udERpcmVjdGlvbjsKICAgIGNvbnN0IHNwYWNpbmdEaXIgPSBmb250LnZlcnRpY2FsID8gMSA6IC0xOwogICAgY29uc3QgY2hhclNwYWNpbmcgPSBjdXJyZW50LmNoYXJTcGFjaW5nOwogICAgY29uc3Qgd29yZFNwYWNpbmcgPSBjdXJyZW50LndvcmRTcGFjaW5nOwogICAgY29uc3QgdGV4dEhTY2FsZSA9IGN1cnJlbnQudGV4dEhTY2FsZSAqIGZvbnREaXJlY3Rpb247CiAgICBjb25zdCBmb250TWF0cml4ID0gY3VycmVudC5mb250TWF0cml4IHx8IEZPTlRfSURFTlRJVFlfTUFUUklYOwogICAgY29uc3QgZ2x5cGhzTGVuZ3RoID0gZ2x5cGhzLmxlbmd0aDsKICAgIGNvbnN0IGlzVGV4dEludmlzaWJsZSA9IGN1cnJlbnQudGV4dFJlbmRlcmluZ01vZGUgPT09IFRleHRSZW5kZXJpbmdNb2RlLklOVklTSUJMRTsKICAgIGxldCBpLCBnbHlwaCwgd2lkdGgsIHNwYWNpbmdMZW5ndGg7CiAgICBpZiAoaXNUZXh0SW52aXNpYmxlIHx8IGZvbnRTaXplID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2NhY2hlZFNjYWxlRm9yU3Ryb2tpbmdbMF0gPSAtMTsKICAgIHRoaXMuX2NhY2hlZEdldFNpbmdsZVBpeGVsV2lkdGggPSBudWxsOwogICAgY3R4LnNhdmUoKTsKICAgIGlmIChjdXJyZW50LnRleHRNYXRyaXgpIHsKICAgICAgY3R4LnRyYW5zZm9ybSguLi5jdXJyZW50LnRleHRNYXRyaXgpOwogICAgfQogICAgY3R4LnRyYW5zbGF0ZShjdXJyZW50LngsIGN1cnJlbnQueSArIGN1cnJlbnQudGV4dFJpc2UpOwogICAgY3R4LnNjYWxlKHRleHRIU2NhbGUsIGZvbnREaXJlY3Rpb24pOwogICAgY29uc3QgZGVwZW5kZW5jeVRyYWNrZXIgPSB0aGlzLmRlcGVuZGVuY3lUcmFja2VyOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlciA9IGRlcGVuZGVuY3lUcmFja2VyID8gbmV3IENhbnZhc05lc3RlZERlcGVuZGVuY3lUcmFja2VyKGRlcGVuZGVuY3lUcmFja2VyLCBvcElkeCkgOiBudWxsOwogICAgZm9yIChpID0gMDsgaSA8IGdseXBoc0xlbmd0aDsgKytpKSB7CiAgICAgIGdseXBoID0gZ2x5cGhzW2ldOwogICAgICBpZiAodHlwZW9mIGdseXBoID09PSAibnVtYmVyIikgewogICAgICAgIHNwYWNpbmdMZW5ndGggPSBzcGFjaW5nRGlyICogZ2x5cGggKiBmb250U2l6ZSAvIDFlMzsKICAgICAgICB0aGlzLmN0eC50cmFuc2xhdGUoc3BhY2luZ0xlbmd0aCwgMCk7CiAgICAgICAgY3VycmVudC54ICs9IHNwYWNpbmdMZW5ndGggKiB0ZXh0SFNjYWxlOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IHNwYWNpbmcgPSAoZ2x5cGguaXNTcGFjZSA/IHdvcmRTcGFjaW5nIDogMCkgKyBjaGFyU3BhY2luZzsKICAgICAgY29uc3Qgb3BlcmF0b3JMaXN0ID0gZm9udC5jaGFyUHJvY09wZXJhdG9yTGlzdFtnbHlwaC5vcGVyYXRvckxpc3RJZF07CiAgICAgIGlmICghb3BlcmF0b3JMaXN0KSB7CiAgICAgICAgd2FybihgVHlwZTMgY2hhcmFjdGVyICIke2dseXBoLm9wZXJhdG9yTGlzdElkfSIgaXMgbm90IGF2YWlsYWJsZS5gKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgICAgdGhpcy5zYXZlKCk7CiAgICAgICAgY3R4LnNjYWxlKGZvbnRTaXplLCBmb250U2l6ZSk7CiAgICAgICAgY3R4LnRyYW5zZm9ybSguLi5mb250TWF0cml4KTsKICAgICAgICB0aGlzLmV4ZWN1dGVPcGVyYXRvckxpc3Qob3BlcmF0b3JMaXN0KTsKICAgICAgICB0aGlzLnJlc3RvcmUoKTsKICAgICAgfQogICAgICBjb25zdCBwID0gW2dseXBoLndpZHRoLCAwXTsKICAgICAgVXRpbC5hcHBseVRyYW5zZm9ybShwLCBmb250TWF0cml4KTsKICAgICAgd2lkdGggPSBwWzBdICogZm9udFNpemUgKyBzcGFjaW5nOwogICAgICBjdHgudHJhbnNsYXRlKHdpZHRoLCAwKTsKICAgICAgY3VycmVudC54ICs9IHdpZHRoICogdGV4dEhTY2FsZTsKICAgIH0KICAgIGN0eC5yZXN0b3JlKCk7CiAgICBpZiAoZGVwZW5kZW5jeVRyYWNrZXIpIHsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlciA9IGRlcGVuZGVuY3lUcmFja2VyOwogICAgfQogIH0KICBzZXRDaGFyV2lkdGgob3BJZHgsIHhXaWR0aCwgeVdpZHRoKSB7CiAgfQogIHNldENoYXJXaWR0aEFuZEJvdW5kcyhvcElkeCwgeFdpZHRoLCB5V2lkdGgsIGxseCwgbGx5LCB1cngsIHVyeSkgewogICAgY29uc3QgY2xpcCA9IG5ldyBQYXRoMkQoKTsKICAgIGNsaXAucmVjdChsbHgsIGxseSwgdXJ4IC0gbGx4LCB1cnkgLSBsbHkpOwogICAgdGhpcy5jdHguY2xpcChjbGlwKTsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZEJCb3gob3BJZHgsIHRoaXMuY3R4LCBsbHgsIHVyeCwgbGx5LCB1cnkpLnJlY29yZENsaXBCb3gob3BJZHgsIHRoaXMuY3R4LCBsbHgsIHVyeCwgbGx5LCB1cnkpOwogICAgdGhpcy5lbmRQYXRoKG9wSWR4KTsKICB9CiAgZ2V0Q29sb3JOX1BhdHRlcm4ob3BJZHgsIElSKSB7CiAgICBsZXQgcGF0dGVybjsKICAgIGlmIChJUlswXSA9PT0gIlRpbGluZ1BhdHRlcm4iKSB7CiAgICAgIGNvbnN0IGJhc2VUcmFuc2Zvcm0gPSB0aGlzLmJhc2VUcmFuc2Zvcm0gfHwgZ2V0Q3VycmVudFRyYW5zZm9ybSh0aGlzLmN0eCk7CiAgICAgIGNvbnN0IGNhbnZhc0dyYXBoaWNzRmFjdG9yeSA9IHsKICAgICAgICBjcmVhdGVDYW52YXNHcmFwaGljczogKGN0eCwgcmVuZGVyaW5nT3BJZHgpID0+IG5ldyBfQ2FudmFzR3JhcGhpY3MoY3R4LCB0aGlzLmNvbW1vbk9ianMsIHRoaXMub2JqcywgdGhpcy5jYW52YXNGYWN0b3J5LCB0aGlzLmZpbHRlckZhY3RvcnksIHsKICAgICAgICAgIG9wdGlvbmFsQ29udGVudENvbmZpZzogdGhpcy5vcHRpb25hbENvbnRlbnRDb25maWcsCiAgICAgICAgICBtYXJrZWRDb250ZW50U3RhY2s6IHRoaXMubWFya2VkQ29udGVudFN0YWNrCiAgICAgICAgfSwgdm9pZCAwLCB2b2lkIDAsIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIgPyBuZXcgQ2FudmFzTmVzdGVkRGVwZW5kZW5jeVRyYWNrZXIodGhpcy5kZXBlbmRlbmN5VHJhY2tlciwgcmVuZGVyaW5nT3BJZHgsIHRydWUpIDogbnVsbCkKICAgICAgfTsKICAgICAgcGF0dGVybiA9IG5ldyBUaWxpbmdQYXR0ZXJuKElSLCB0aGlzLmN0eCwgY2FudmFzR3JhcGhpY3NGYWN0b3J5LCBiYXNlVHJhbnNmb3JtKTsKICAgIH0gZWxzZSB7CiAgICAgIHBhdHRlcm4gPSB0aGlzLl9nZXRQYXR0ZXJuKG9wSWR4LCBJUlsxXSwgSVJbMl0pOwogICAgfQogICAgcmV0dXJuIHBhdHRlcm47CiAgfQogIHNldFN0cm9rZUNvbG9yTihvcElkeCwgLi4uYXJncykgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgic3Ryb2tlQ29sb3IiLCBvcElkeCk7CiAgICB0aGlzLmN1cnJlbnQuc3Ryb2tlQ29sb3IgPSB0aGlzLmdldENvbG9yTl9QYXR0ZXJuKG9wSWR4LCBhcmdzKTsKICAgIHRoaXMuY3VycmVudC5wYXR0ZXJuU3Ryb2tlID0gdHJ1ZTsKICB9CiAgc2V0RmlsbENvbG9yTihvcElkeCwgLi4uYXJncykgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgiZmlsbENvbG9yIiwgb3BJZHgpOwogICAgdGhpcy5jdXJyZW50LmZpbGxDb2xvciA9IHRoaXMuZ2V0Q29sb3JOX1BhdHRlcm4ob3BJZHgsIGFyZ3MpOwogICAgdGhpcy5jdXJyZW50LnBhdHRlcm5GaWxsID0gdHJ1ZTsKICB9CiAgc2V0U3Ryb2tlUkdCQ29sb3Iob3BJZHgsIGNvbG9yKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJzdHJva2VDb2xvciIsIG9wSWR4KTsKICAgIHRoaXMuY3R4LnN0cm9rZVN0eWxlID0gdGhpcy5jdXJyZW50LnN0cm9rZUNvbG9yID0gY29sb3I7CiAgICB0aGlzLmN1cnJlbnQucGF0dGVyblN0cm9rZSA9IGZhbHNlOwogIH0KICBzZXRTdHJva2VUcmFuc3BhcmVudChvcElkeCkgewogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkU2ltcGxlRGF0YSgic3Ryb2tlQ29sb3IiLCBvcElkeCk7CiAgICB0aGlzLmN0eC5zdHJva2VTdHlsZSA9IHRoaXMuY3VycmVudC5zdHJva2VDb2xvciA9ICJ0cmFuc3BhcmVudCI7CiAgICB0aGlzLmN1cnJlbnQucGF0dGVyblN0cm9rZSA9IGZhbHNlOwogIH0KICBzZXRGaWxsUkdCQ29sb3Iob3BJZHgsIGNvbG9yKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJmaWxsQ29sb3IiLCBvcElkeCk7CiAgICB0aGlzLmN0eC5maWxsU3R5bGUgPSB0aGlzLmN1cnJlbnQuZmlsbENvbG9yID0gY29sb3I7CiAgICB0aGlzLmN1cnJlbnQucGF0dGVybkZpbGwgPSBmYWxzZTsKICB9CiAgc2V0RmlsbFRyYW5zcGFyZW50KG9wSWR4KSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRTaW1wbGVEYXRhKCJmaWxsQ29sb3IiLCBvcElkeCk7CiAgICB0aGlzLmN0eC5maWxsU3R5bGUgPSB0aGlzLmN1cnJlbnQuZmlsbENvbG9yID0gInRyYW5zcGFyZW50IjsKICAgIHRoaXMuY3VycmVudC5wYXR0ZXJuRmlsbCA9IGZhbHNlOwogIH0KICBfZ2V0UGF0dGVybihvcElkeCwgb2JqSWQsIG1hdHJpeCA9IG51bGwpIHsKICAgIGxldCBwYXR0ZXJuOwogICAgaWYgKHRoaXMuY2FjaGVkUGF0dGVybnMuaGFzKG9iaklkKSkgewogICAgICBwYXR0ZXJuID0gdGhpcy5jYWNoZWRQYXR0ZXJucy5nZXQob2JqSWQpOwogICAgfSBlbHNlIHsKICAgICAgcGF0dGVybiA9IGdldFNoYWRpbmdQYXR0ZXJuKHRoaXMuZ2V0T2JqZWN0KG9wSWR4LCBvYmpJZCkpOwogICAgICB0aGlzLmNhY2hlZFBhdHRlcm5zLnNldChvYmpJZCwgcGF0dGVybik7CiAgICB9CiAgICBpZiAobWF0cml4KSB7CiAgICAgIHBhdHRlcm4ubWF0cml4ID0gbWF0cml4OwogICAgfQogICAgcmV0dXJuIHBhdHRlcm47CiAgfQogIHNoYWRpbmdGaWxsKG9wSWR4LCBvYmpJZCkgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgdGhpcy5zYXZlKG9wSWR4KTsKICAgIGNvbnN0IHBhdHRlcm4gPSB0aGlzLl9nZXRQYXR0ZXJuKG9wSWR4LCBvYmpJZCk7CiAgICBjdHguZmlsbFN0eWxlID0gcGF0dGVybi5nZXRQYXR0ZXJuKGN0eCwgdGhpcywgZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoY3R4KSwgUGF0aFR5cGUuU0hBRElORywgb3BJZHgpOwogICAgY29uc3QgaW52ID0gZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoY3R4KTsKICAgIGlmIChpbnYpIHsKICAgICAgY29uc3QgewogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9ID0gY3R4LmNhbnZhczsKICAgICAgY29uc3QgbWluTWF4ID0gTUlOX01BWF9JTklULnNsaWNlKCk7CiAgICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goWzAsIDAsIHdpZHRoLCBoZWlnaHRdLCBpbnYsIG1pbk1heCk7CiAgICAgIGNvbnN0IFt4MCwgeTAsIHgxLCB5MV0gPSBtaW5NYXg7CiAgICAgIHRoaXMuY3R4LmZpbGxSZWN0KHgwLCB5MCwgeDEgLSB4MCwgeTEgLSB5MCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmN0eC5maWxsUmVjdCgtMWUxMCwgLTFlMTAsIDJlMTAsIDJlMTApOwogICAgfQogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzZXRCQm94KG9wSWR4KS5yZWNvcmRGdWxsUGFnZUJCb3gob3BJZHgpLnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLnRyYW5zZm9ybSkucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMuZmlsbCkucmVjb3JkT3BlcmF0aW9uKG9wSWR4KTsKICAgIHRoaXMuY29tcG9zZSh0aGlzLmN1cnJlbnQuZ2V0Q2xpcHBlZFBhdGhCb3VuZGluZ0JveCgpKTsKICAgIHRoaXMucmVzdG9yZShvcElkeCk7CiAgfQogIGJlZ2luSW5saW5lSW1hZ2UoKSB7CiAgICB1bnJlYWNoYWJsZSgiU2hvdWxkIG5vdCBjYWxsIGJlZ2luSW5saW5lSW1hZ2UiKTsKICB9CiAgYmVnaW5JbWFnZURhdGEoKSB7CiAgICB1bnJlYWNoYWJsZSgiU2hvdWxkIG5vdCBjYWxsIGJlZ2luSW1hZ2VEYXRhIik7CiAgfQogIHBhaW50Rm9ybVhPYmplY3RCZWdpbihvcElkeCwgbWF0cml4LCBiYm94KSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5zYXZlKG9wSWR4KTsKICAgIHRoaXMuYmFzZVRyYW5zZm9ybVN0YWNrLnB1c2godGhpcy5iYXNlVHJhbnNmb3JtKTsKICAgIGlmIChtYXRyaXgpIHsKICAgICAgdGhpcy50cmFuc2Zvcm0ob3BJZHgsIC4uLm1hdHJpeCk7CiAgICB9CiAgICB0aGlzLmJhc2VUcmFuc2Zvcm0gPSBnZXRDdXJyZW50VHJhbnNmb3JtKHRoaXMuY3R4KTsKICAgIGlmIChiYm94KSB7CiAgICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goYmJveCwgdGhpcy5iYXNlVHJhbnNmb3JtLCB0aGlzLmN1cnJlbnQubWluTWF4KTsKICAgICAgY29uc3QgW3gwLCB5MCwgeDEsIHkxXSA9IGJib3g7CiAgICAgIGNvbnN0IGNsaXAgPSBuZXcgUGF0aDJEKCk7CiAgICAgIGNsaXAucmVjdCh4MCwgeTAsIHgxIC0geDAsIHkxIC0geTApOwogICAgICB0aGlzLmN0eC5jbGlwKGNsaXApOwogICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRDbGlwQm94KG9wSWR4LCB0aGlzLmN0eCwgeDAsIHgxLCB5MCwgeTEpOwogICAgICB0aGlzLmVuZFBhdGgob3BJZHgpOwogICAgfQogIH0KICBwYWludEZvcm1YT2JqZWN0RW5kKG9wSWR4KSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5yZXN0b3JlKG9wSWR4KTsKICAgIHRoaXMuYmFzZVRyYW5zZm9ybSA9IHRoaXMuYmFzZVRyYW5zZm9ybVN0YWNrLnBvcCgpOwogIH0KICBiZWdpbkdyb3VwKG9wSWR4LCBncm91cCkgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuc2F2ZShvcElkeCk7CiAgICBpZiAodGhpcy5pblNNYXNrTW9kZSkgewogICAgICB0aGlzLmVuZFNNYXNrTW9kZSgpOwogICAgICB0aGlzLmN1cnJlbnQuYWN0aXZlU01hc2sgPSBudWxsOwogICAgfQogICAgY29uc3QgY3VycmVudEN0eCA9IHRoaXMuY3R4OwogICAgaWYgKCFncm91cC5pc29sYXRlZCkgewogICAgICBpbmZvKCJUT0RPOiBTdXBwb3J0IG5vbi1pc29sYXRlZCBncm91cHMuIik7CiAgICB9CiAgICBpZiAoZ3JvdXAua25vY2tvdXQpIHsKICAgICAgd2FybigiS25vY2tvdXQgZ3JvdXBzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICB9CiAgICBjb25zdCBjdXJyZW50VHJhbnNmb3JtID0gZ2V0Q3VycmVudFRyYW5zZm9ybShjdXJyZW50Q3R4KTsKICAgIGlmIChncm91cC5tYXRyaXgpIHsKICAgICAgY3VycmVudEN0eC50cmFuc2Zvcm0oLi4uZ3JvdXAubWF0cml4KTsKICAgIH0KICAgIGlmICghZ3JvdXAuYmJveCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkJvdW5kaW5nIGJveCBpcyByZXF1aXJlZC4iKTsKICAgIH0KICAgIGxldCBib3VuZHMgPSBNSU5fTUFYX0lOSVQuc2xpY2UoKTsKICAgIFV0aWwuYXhpYWxBbGlnbmVkQm91bmRpbmdCb3goZ3JvdXAuYmJveCwgZ2V0Q3VycmVudFRyYW5zZm9ybShjdXJyZW50Q3R4KSwgYm91bmRzKTsKICAgIGNvbnN0IGNhbnZhc0JvdW5kcyA9IFswLCAwLCBjdXJyZW50Q3R4LmNhbnZhcy53aWR0aCwgY3VycmVudEN0eC5jYW52YXMuaGVpZ2h0XTsKICAgIGJvdW5kcyA9IFV0aWwuaW50ZXJzZWN0KGJvdW5kcywgY2FudmFzQm91bmRzKSB8fCBbMCwgMCwgMCwgMF07CiAgICBjb25zdCBvZmZzZXRYID0gTWF0aC5mbG9vcihib3VuZHNbMF0pOwogICAgY29uc3Qgb2Zmc2V0WSA9IE1hdGguZmxvb3IoYm91bmRzWzFdKTsKICAgIGNvbnN0IGRyYXduV2lkdGggPSBNYXRoLm1heChNYXRoLmNlaWwoYm91bmRzWzJdKSAtIG9mZnNldFgsIDEpOwogICAgY29uc3QgZHJhd25IZWlnaHQgPSBNYXRoLm1heChNYXRoLmNlaWwoYm91bmRzWzNdKSAtIG9mZnNldFksIDEpOwogICAgdGhpcy5jdXJyZW50LnN0YXJ0TmV3UGF0aEFuZENsaXBCb3goWzAsIDAsIGRyYXduV2lkdGgsIGRyYXduSGVpZ2h0XSk7CiAgICBsZXQgY2FjaGVJZCA9ICJncm91cEF0IiArIHRoaXMuZ3JvdXBMZXZlbDsKICAgIGlmIChncm91cC5zbWFzaykgewogICAgICBjYWNoZUlkICs9ICJfc21hc2tfIiArIHRoaXMuc21hc2tDb3VudGVyKysgJSAyOwogICAgfQogICAgY29uc3Qgc2NyYXRjaENhbnZhcyA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKGNhY2hlSWQsIGRyYXduV2lkdGgsIGRyYXduSGVpZ2h0KTsKICAgIGNvbnN0IGdyb3VwQ3R4ID0gc2NyYXRjaENhbnZhcy5jb250ZXh0OwogICAgZ3JvdXBDdHgudHJhbnNsYXRlKC1vZmZzZXRYLCAtb2Zmc2V0WSk7CiAgICBncm91cEN0eC50cmFuc2Zvcm0oLi4uY3VycmVudFRyYW5zZm9ybSk7CiAgICBsZXQgY2xpcCA9IG5ldyBQYXRoMkQoKTsKICAgIGNvbnN0IFt4MCwgeTAsIHgxLCB5MV0gPSBncm91cC5iYm94OwogICAgY2xpcC5yZWN0KHgwLCB5MCwgeDEgLSB4MCwgeTEgLSB5MCk7CiAgICBpZiAoZ3JvdXAubWF0cml4KSB7CiAgICAgIGNvbnN0IHBhdGggPSBuZXcgUGF0aDJEKCk7CiAgICAgIHBhdGguYWRkUGF0aChjbGlwLCBuZXcgRE9NTWF0cml4KGdyb3VwLm1hdHJpeCkpOwogICAgICBjbGlwID0gcGF0aDsKICAgIH0KICAgIGdyb3VwQ3R4LmNsaXAoY2xpcCk7CiAgICBpZiAoZ3JvdXAuc21hc2spIHsKICAgICAgdGhpcy5zbWFza1N0YWNrLnB1c2goewogICAgICAgIGNhbnZhczogc2NyYXRjaENhbnZhcy5jYW52YXMsCiAgICAgICAgY29udGV4dDogZ3JvdXBDdHgsCiAgICAgICAgb2Zmc2V0WCwKICAgICAgICBvZmZzZXRZLAogICAgICAgIHN1YnR5cGU6IGdyb3VwLnNtYXNrLnN1YnR5cGUsCiAgICAgICAgYmFja2Ryb3A6IGdyb3VwLnNtYXNrLmJhY2tkcm9wLAogICAgICAgIHRyYW5zZmVyTWFwOiBncm91cC5zbWFzay50cmFuc2Zlck1hcCB8fCBudWxsLAogICAgICAgIHN0YXJ0VHJhbnNmb3JtSW52ZXJzZTogbnVsbAogICAgICB9KTsKICAgIH0KICAgIGlmICghZ3JvdXAuc21hc2sgfHwgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcikgewogICAgICBjdXJyZW50Q3R4LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsKICAgICAgY3VycmVudEN0eC50cmFuc2xhdGUob2Zmc2V0WCwgb2Zmc2V0WSk7CiAgICAgIGN1cnJlbnRDdHguc2F2ZSgpOwogICAgfQogICAgY29weUN0eFN0YXRlKGN1cnJlbnRDdHgsIGdyb3VwQ3R4KTsKICAgIHRoaXMuY3R4ID0gZ3JvdXBDdHg7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5pbmhlcml0U2ltcGxlRGF0YUFzRnV0dXJlRm9yY2VkRGVwZW5kZW5jaWVzKFsiZmlsbEFscGhhIiwgInN0cm9rZUFscGhhIiwgImdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiJdKS5wdXNoQmFzZVRyYW5zZm9ybShjdXJyZW50Q3R4KTsKICAgIHRoaXMuc2V0R1N0YXRlKG9wSWR4LCBbWyJCTSIsICJzb3VyY2Utb3ZlciJdLCBbImNhIiwgMV0sIFsiQ0EiLCAxXV0pOwogICAgdGhpcy5ncm91cFN0YWNrLnB1c2goY3VycmVudEN0eCk7CiAgICB0aGlzLmdyb3VwTGV2ZWwrKzsKICB9CiAgZW5kR3JvdXAob3BJZHgsIGdyb3VwKSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5ncm91cExldmVsLS07CiAgICBjb25zdCBncm91cEN0eCA9IHRoaXMuY3R4OwogICAgY29uc3QgY3R4ID0gdGhpcy5ncm91cFN0YWNrLnBvcCgpOwogICAgdGhpcy5jdHggPSBjdHg7CiAgICB0aGlzLmN0eC5pbWFnZVNtb290aGluZ0VuYWJsZWQgPSBmYWxzZTsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnBvcEJhc2VUcmFuc2Zvcm0oKTsKICAgIGlmIChncm91cC5zbWFzaykgewogICAgICB0aGlzLnRlbXBTTWFzayA9IHRoaXMuc21hc2tTdGFjay5wb3AoKTsKICAgICAgdGhpcy5yZXN0b3JlKG9wSWR4KTsKICAgICAgaWYgKHRoaXMuZGVwZW5kZW5jeVRyYWNrZXIpIHsKICAgICAgICB0aGlzLmN0eC5yZXN0b3JlKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuY3R4LnJlc3RvcmUoKTsKICAgICAgY29uc3QgY3VycmVudE10eCA9IGdldEN1cnJlbnRUcmFuc2Zvcm0odGhpcy5jdHgpOwogICAgICB0aGlzLnJlc3RvcmUob3BJZHgpOwogICAgICB0aGlzLmN0eC5zYXZlKCk7CiAgICAgIHRoaXMuY3R4LnNldFRyYW5zZm9ybSguLi5jdXJyZW50TXR4KTsKICAgICAgY29uc3QgZGlydHlCb3ggPSBNSU5fTUFYX0lOSVQuc2xpY2UoKTsKICAgICAgVXRpbC5heGlhbEFsaWduZWRCb3VuZGluZ0JveChbMCwgMCwgZ3JvdXBDdHguY2FudmFzLndpZHRoLCBncm91cEN0eC5jYW52YXMuaGVpZ2h0XSwgY3VycmVudE10eCwgZGlydHlCb3gpOwogICAgICB0aGlzLmN0eC5kcmF3SW1hZ2UoZ3JvdXBDdHguY2FudmFzLCAwLCAwKTsKICAgICAgdGhpcy5jdHgucmVzdG9yZSgpOwogICAgICB0aGlzLmNvbXBvc2UoZGlydHlCb3gpOwogICAgfQogIH0KICBiZWdpbkFubm90YXRpb24ob3BJZHgsIGlkLCByZWN0LCB0cmFuc2Zvcm0sIG1hdHJpeCwgaGFzT3duQ2FudmFzKSB7CiAgICB0aGlzLiNyZXN0b3JlSW5pdGlhbFN0YXRlKCk7CiAgICByZXNldEN0eFRvRGVmYXVsdCh0aGlzLmN0eCk7CiAgICB0aGlzLmN0eC5zYXZlKCk7CiAgICB0aGlzLnNhdmUob3BJZHgpOwogICAgaWYgKHRoaXMuYmFzZVRyYW5zZm9ybSkgewogICAgICB0aGlzLmN0eC5zZXRUcmFuc2Zvcm0oLi4udGhpcy5iYXNlVHJhbnNmb3JtKTsKICAgIH0KICAgIGlmIChyZWN0KSB7CiAgICAgIGNvbnN0IHdpZHRoID0gcmVjdFsyXSAtIHJlY3RbMF07CiAgICAgIGNvbnN0IGhlaWdodCA9IHJlY3RbM10gLSByZWN0WzFdOwogICAgICBpZiAoaGFzT3duQ2FudmFzICYmIHRoaXMuYW5ub3RhdGlvbkNhbnZhc01hcCkgewogICAgICAgIHRyYW5zZm9ybSA9IHRyYW5zZm9ybS5zbGljZSgpOwogICAgICAgIHRyYW5zZm9ybVs0XSAtPSByZWN0WzBdOwogICAgICAgIHRyYW5zZm9ybVs1XSAtPSByZWN0WzFdOwogICAgICAgIHJlY3QgPSByZWN0LnNsaWNlKCk7CiAgICAgICAgcmVjdFswXSA9IHJlY3RbMV0gPSAwOwogICAgICAgIHJlY3RbMl0gPSB3aWR0aDsKICAgICAgICByZWN0WzNdID0gaGVpZ2h0OwogICAgICAgIFV0aWwuc2luZ3VsYXJWYWx1ZURlY29tcG9zZTJkU2NhbGUoZ2V0Q3VycmVudFRyYW5zZm9ybSh0aGlzLmN0eCksIFhZKTsKICAgICAgICBjb25zdCB7CiAgICAgICAgICB2aWV3cG9ydFNjYWxlCiAgICAgICAgfSA9IHRoaXM7CiAgICAgICAgY29uc3QgY2FudmFzV2lkdGggPSBNYXRoLmNlaWwod2lkdGggKiB0aGlzLm91dHB1dFNjYWxlWCAqIHZpZXdwb3J0U2NhbGUpOwogICAgICAgIGNvbnN0IGNhbnZhc0hlaWdodCA9IE1hdGguY2VpbChoZWlnaHQgKiB0aGlzLm91dHB1dFNjYWxlWSAqIHZpZXdwb3J0U2NhbGUpOwogICAgICAgIHRoaXMuYW5ub3RhdGlvbkNhbnZhcyA9IHRoaXMuY2FudmFzRmFjdG9yeS5jcmVhdGUoY2FudmFzV2lkdGgsIGNhbnZhc0hlaWdodCk7CiAgICAgICAgY29uc3QgewogICAgICAgICAgY2FudmFzLAogICAgICAgICAgY29udGV4dAogICAgICAgIH0gPSB0aGlzLmFubm90YXRpb25DYW52YXM7CiAgICAgICAgdGhpcy5hbm5vdGF0aW9uQ2FudmFzTWFwLnNldChpZCwgY2FudmFzKTsKICAgICAgICB0aGlzLmFubm90YXRpb25DYW52YXMuc2F2ZWRDdHggPSB0aGlzLmN0eDsKICAgICAgICB0aGlzLmN0eCA9IGNvbnRleHQ7CiAgICAgICAgdGhpcy5jdHguc2F2ZSgpOwogICAgICAgIHRoaXMuY3R4LnNldFRyYW5zZm9ybShYWVswXSwgMCwgMCwgLVhZWzFdLCAwLCBoZWlnaHQgKiBYWVsxXSk7CiAgICAgICAgcmVzZXRDdHhUb0RlZmF1bHQodGhpcy5jdHgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc2V0Q3R4VG9EZWZhdWx0KHRoaXMuY3R4KTsKICAgICAgICB0aGlzLmVuZFBhdGgob3BJZHgpOwogICAgICAgIGNvbnN0IGNsaXAgPSBuZXcgUGF0aDJEKCk7CiAgICAgICAgY2xpcC5yZWN0KHJlY3RbMF0sIHJlY3RbMV0sIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIHRoaXMuY3R4LmNsaXAoY2xpcCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuY3VycmVudCA9IG5ldyBDYW52YXNFeHRyYVN0YXRlKHRoaXMuY3R4LmNhbnZhcy53aWR0aCwgdGhpcy5jdHguY2FudmFzLmhlaWdodCk7CiAgICB0aGlzLnRyYW5zZm9ybShvcElkeCwgLi4udHJhbnNmb3JtKTsKICAgIHRoaXMudHJhbnNmb3JtKG9wSWR4LCAuLi5tYXRyaXgpOwogIH0KICBlbmRBbm5vdGF0aW9uKG9wSWR4KSB7CiAgICBpZiAodGhpcy5hbm5vdGF0aW9uQ2FudmFzKSB7CiAgICAgIHRoaXMuY3R4LnJlc3RvcmUoKTsKICAgICAgdGhpcy4jZHJhd0ZpbHRlcigpOwogICAgICB0aGlzLmN0eCA9IHRoaXMuYW5ub3RhdGlvbkNhbnZhcy5zYXZlZEN0eDsKICAgICAgZGVsZXRlIHRoaXMuYW5ub3RhdGlvbkNhbnZhcy5zYXZlZEN0eDsKICAgICAgZGVsZXRlIHRoaXMuYW5ub3RhdGlvbkNhbnZhczsKICAgIH0KICB9CiAgcGFpbnRJbWFnZU1hc2tYT2JqZWN0KG9wSWR4LCBpbWcpIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjb3VudCA9IGltZy5jb3VudDsKICAgIGltZyA9IHRoaXMuZ2V0T2JqZWN0KG9wSWR4LCBpbWcuZGF0YSwgaW1nKTsKICAgIGltZy5jb3VudCA9IGNvdW50OwogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBjb25zdCBtYXNrID0gdGhpcy5fY3JlYXRlTWFza0NhbnZhcyhvcElkeCwgaW1nKTsKICAgIGNvbnN0IG1hc2tDYW52YXMgPSBtYXNrLmNhbnZhczsKICAgIGN0eC5zYXZlKCk7CiAgICBjdHguc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgY3R4LmRyYXdJbWFnZShtYXNrQ2FudmFzLCBtYXNrLm9mZnNldFgsIG1hc2sub2Zmc2V0WSk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZXNldEJCb3gob3BJZHgpLnJlY29yZEJCb3gob3BJZHgsIHRoaXMuY3R4LCBtYXNrLm9mZnNldFgsIG1hc2sub2Zmc2V0WCArIG1hc2tDYW52YXMud2lkdGgsIG1hc2sub2Zmc2V0WSwgbWFzay5vZmZzZXRZICsgbWFza0NhbnZhcy5oZWlnaHQpLnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgICBjdHgucmVzdG9yZSgpOwogICAgdGhpcy5jb21wb3NlKCk7CiAgfQogIHBhaW50SW1hZ2VNYXNrWE9iamVjdFJlcGVhdChvcElkeCwgaW1nLCBzY2FsZVgsIHNrZXdYID0gMCwgc2tld1kgPSAwLCBzY2FsZVksIHBvc2l0aW9ucykgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGltZyA9IHRoaXMuZ2V0T2JqZWN0KG9wSWR4LCBpbWcuZGF0YSwgaW1nKTsKICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgY3R4LnNhdmUoKTsKICAgIGNvbnN0IGN1cnJlbnRUcmFuc2Zvcm0gPSBnZXRDdXJyZW50VHJhbnNmb3JtKGN0eCk7CiAgICBjdHgudHJhbnNmb3JtKHNjYWxlWCwgc2tld1gsIHNrZXdZLCBzY2FsZVksIDAsIDApOwogICAgY29uc3QgbWFzayA9IHRoaXMuX2NyZWF0ZU1hc2tDYW52YXMob3BJZHgsIGltZyk7CiAgICBjdHguc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIG1hc2sub2Zmc2V0WCAtIGN1cnJlbnRUcmFuc2Zvcm1bNF0sIG1hc2sub2Zmc2V0WSAtIGN1cnJlbnRUcmFuc2Zvcm1bNV0pOwogICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVzZXRCQm94KG9wSWR4KTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHBvc2l0aW9ucy5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIGNvbnN0IHRyYW5zID0gVXRpbC50cmFuc2Zvcm0oY3VycmVudFRyYW5zZm9ybSwgW3NjYWxlWCwgc2tld1gsIHNrZXdZLCBzY2FsZVksIHBvc2l0aW9uc1tpXSwgcG9zaXRpb25zW2kgKyAxXV0pOwogICAgICBjdHguZHJhd0ltYWdlKG1hc2suY2FudmFzLCB0cmFuc1s0XSwgdHJhbnNbNV0pOwogICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRCQm94KG9wSWR4LCB0aGlzLmN0eCwgdHJhbnNbNF0sIHRyYW5zWzRdICsgbWFzay5jYW52YXMud2lkdGgsIHRyYW5zWzVdLCB0cmFuc1s1XSArIG1hc2suY2FudmFzLmhlaWdodCk7CiAgICB9CiAgICBjdHgucmVzdG9yZSgpOwogICAgdGhpcy5jb21wb3NlKCk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRPcGVyYXRpb24ob3BJZHgpOwogIH0KICBwYWludEltYWdlTWFza1hPYmplY3RHcm91cChvcElkeCwgaW1hZ2VzKSB7CiAgICBpZiAoIXRoaXMuY29udGVudFZpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7CiAgICBjb25zdCBmaWxsQ29sb3IgPSB0aGlzLmN1cnJlbnQuZmlsbENvbG9yOwogICAgY29uc3QgaXNQYXR0ZXJuRmlsbCA9IHRoaXMuY3VycmVudC5wYXR0ZXJuRmlsbDsKICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc2V0QkJveChvcElkeCkucmVjb3JkRGVwZW5kZW5jaWVzKG9wSWR4LCBEZXBlbmRlbmNpZXMudHJhbnNmb3JtQW5kRmlsbCk7CiAgICBmb3IgKGNvbnN0IGltYWdlIG9mIGltYWdlcykgewogICAgICBjb25zdCB7CiAgICAgICAgZGF0YSwKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQsCiAgICAgICAgdHJhbnNmb3JtCiAgICAgIH0gPSBpbWFnZTsKICAgICAgY29uc3QgbWFza0NhbnZhcyA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJtYXNrQ2FudmFzIiwgd2lkdGgsIGhlaWdodCk7CiAgICAgIGNvbnN0IG1hc2tDdHggPSBtYXNrQ2FudmFzLmNvbnRleHQ7CiAgICAgIG1hc2tDdHguc2F2ZSgpOwogICAgICBjb25zdCBpbWcgPSB0aGlzLmdldE9iamVjdChvcElkeCwgZGF0YSwgaW1hZ2UpOwogICAgICBwdXRCaW5hcnlJbWFnZU1hc2sobWFza0N0eCwgaW1nKTsKICAgICAgbWFza0N0eC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAic291cmNlLWluIjsKICAgICAgbWFza0N0eC5maWxsU3R5bGUgPSBpc1BhdHRlcm5GaWxsID8gZmlsbENvbG9yLmdldFBhdHRlcm4obWFza0N0eCwgdGhpcywgZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoY3R4KSwgUGF0aFR5cGUuRklMTCwgb3BJZHgpIDogZmlsbENvbG9yOwogICAgICBtYXNrQ3R4LmZpbGxSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgICBtYXNrQ3R4LnJlc3RvcmUoKTsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LnRyYW5zZm9ybSguLi50cmFuc2Zvcm0pOwogICAgICBjdHguc2NhbGUoMSwgLTEpOwogICAgICBkcmF3SW1hZ2VBdEludGVnZXJDb29yZHMoY3R4LCBtYXNrQ2FudmFzLmNhbnZhcywgMCwgMCwgd2lkdGgsIGhlaWdodCwgMCwgLTEsIDEsIDEpOwogICAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRCQm94KG9wSWR4LCBjdHgsIDAsIHdpZHRoLCAwLCBoZWlnaHQpOwogICAgICBjdHgucmVzdG9yZSgpOwogICAgfQogICAgdGhpcy5jb21wb3NlKCk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRPcGVyYXRpb24ob3BJZHgpOwogIH0KICBwYWludEltYWdlWE9iamVjdChvcElkeCwgb2JqSWQpIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpbWdEYXRhID0gdGhpcy5nZXRPYmplY3Qob3BJZHgsIG9iaklkKTsKICAgIGlmICghaW1nRGF0YSkgewogICAgICB3YXJuKCJEZXBlbmRlbnQgaW1hZ2UgaXNuJ3QgcmVhZHkgeWV0Iik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMucGFpbnRJbmxpbmVJbWFnZVhPYmplY3Qob3BJZHgsIGltZ0RhdGEpOwogIH0KICBwYWludEltYWdlWE9iamVjdFJlcGVhdChvcElkeCwgb2JqSWQsIHNjYWxlWCwgc2NhbGVZLCBwb3NpdGlvbnMpIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpbWdEYXRhID0gdGhpcy5nZXRPYmplY3Qob3BJZHgsIG9iaklkKTsKICAgIGlmICghaW1nRGF0YSkgewogICAgICB3YXJuKCJEZXBlbmRlbnQgaW1hZ2UgaXNuJ3QgcmVhZHkgeWV0Iik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHdpZHRoID0gaW1nRGF0YS53aWR0aDsKICAgIGNvbnN0IGhlaWdodCA9IGltZ0RhdGEuaGVpZ2h0OwogICAgY29uc3QgbWFwID0gW107CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBwb3NpdGlvbnMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gMikgewogICAgICBtYXAucHVzaCh7CiAgICAgICAgdHJhbnNmb3JtOiBbc2NhbGVYLCAwLCAwLCBzY2FsZVksIHBvc2l0aW9uc1tpXSwgcG9zaXRpb25zW2kgKyAxXV0sCiAgICAgICAgeDogMCwKICAgICAgICB5OiAwLAogICAgICAgIHc6IHdpZHRoLAogICAgICAgIGg6IGhlaWdodAogICAgICB9KTsKICAgIH0KICAgIHRoaXMucGFpbnRJbmxpbmVJbWFnZVhPYmplY3RHcm91cChvcElkeCwgaW1nRGF0YSwgbWFwKTsKICB9CiAgYXBwbHlUcmFuc2Zlck1hcHNUb0NhbnZhcyhjdHgpIHsKICAgIGlmICh0aGlzLmN1cnJlbnQudHJhbnNmZXJNYXBzICE9PSAibm9uZSIpIHsKICAgICAgY3R4LmZpbHRlciA9IHRoaXMuY3VycmVudC50cmFuc2Zlck1hcHM7CiAgICAgIGN0eC5kcmF3SW1hZ2UoY3R4LmNhbnZhcywgMCwgMCk7CiAgICAgIGN0eC5maWx0ZXIgPSAibm9uZSI7CiAgICB9CiAgICByZXR1cm4gY3R4LmNhbnZhczsKICB9CiAgYXBwbHlUcmFuc2Zlck1hcHNUb0JpdG1hcChpbWdEYXRhKSB7CiAgICBpZiAodGhpcy5jdXJyZW50LnRyYW5zZmVyTWFwcyA9PT0gIm5vbmUiKSB7CiAgICAgIHJldHVybiBpbWdEYXRhLmJpdG1hcDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgYml0bWFwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gaW1nRGF0YTsKICAgIGNvbnN0IHRtcENhbnZhcyA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJpbmxpbmVJbWFnZSIsIHdpZHRoLCBoZWlnaHQpOwogICAgY29uc3QgdG1wQ3R4ID0gdG1wQ2FudmFzLmNvbnRleHQ7CiAgICB0bXBDdHguZmlsdGVyID0gdGhpcy5jdXJyZW50LnRyYW5zZmVyTWFwczsKICAgIHRtcEN0eC5kcmF3SW1hZ2UoYml0bWFwLCAwLCAwKTsKICAgIHRtcEN0eC5maWx0ZXIgPSAibm9uZSI7CiAgICByZXR1cm4gdG1wQ2FudmFzLmNhbnZhczsKICB9CiAgcGFpbnRJbmxpbmVJbWFnZVhPYmplY3Qob3BJZHgsIGltZ0RhdGEpIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB3aWR0aCA9IGltZ0RhdGEud2lkdGg7CiAgICBjb25zdCBoZWlnaHQgPSBpbWdEYXRhLmhlaWdodDsKICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4OwogICAgdGhpcy5zYXZlKG9wSWR4KTsKICAgIGNvbnN0IHsKICAgICAgZmlsdGVyCiAgICB9ID0gY3R4OwogICAgaWYgKGZpbHRlciAhPT0gIm5vbmUiICYmIGZpbHRlciAhPT0gIiIpIHsKICAgICAgY3R4LmZpbHRlciA9ICJub25lIjsKICAgIH0KICAgIGN0eC5zY2FsZSgxIC8gd2lkdGgsIC0xIC8gaGVpZ2h0KTsKICAgIGxldCBpbWdUb1BhaW50OwogICAgaWYgKGltZ0RhdGEuYml0bWFwKSB7CiAgICAgIGltZ1RvUGFpbnQgPSB0aGlzLmFwcGx5VHJhbnNmZXJNYXBzVG9CaXRtYXAoaW1nRGF0YSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBIVE1MRWxlbWVudCA9PT0gImZ1bmN0aW9uIiAmJiBpbWdEYXRhIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgfHwgIWltZ0RhdGEuZGF0YSkgewogICAgICBpbWdUb1BhaW50ID0gaW1nRGF0YTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHRtcENhbnZhcyA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJpbmxpbmVJbWFnZSIsIHdpZHRoLCBoZWlnaHQpOwogICAgICBjb25zdCB0bXBDdHggPSB0bXBDYW52YXMuY29udGV4dDsKICAgICAgcHV0QmluYXJ5SW1hZ2VEYXRhKHRtcEN0eCwgaW1nRGF0YSk7CiAgICAgIGltZ1RvUGFpbnQgPSB0aGlzLmFwcGx5VHJhbnNmZXJNYXBzVG9DYW52YXModG1wQ3R4KTsKICAgIH0KICAgIGNvbnN0IHNjYWxlZCA9IHRoaXMuX3NjYWxlSW1hZ2UoaW1nVG9QYWludCwgZ2V0Q3VycmVudFRyYW5zZm9ybUludmVyc2UoY3R4KSk7CiAgICBjdHguaW1hZ2VTbW9vdGhpbmdFbmFibGVkID0gZ2V0SW1hZ2VTbW9vdGhpbmdFbmFibGVkKGdldEN1cnJlbnRUcmFuc2Zvcm0oY3R4KSwgaW1nRGF0YS5pbnRlcnBvbGF0ZSk7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZXNldEJCb3gob3BJZHgpLnJlY29yZEJCb3gob3BJZHgsIGN0eCwgMCwgd2lkdGgsIC1oZWlnaHQsIDApLnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLmltYWdlWE9iamVjdCkucmVjb3JkT3BlcmF0aW9uKG9wSWR4KTsKICAgIGRyYXdJbWFnZUF0SW50ZWdlckNvb3JkcyhjdHgsIHNjYWxlZC5pbWcsIDAsIDAsIHNjYWxlZC5wYWludFdpZHRoLCBzY2FsZWQucGFpbnRIZWlnaHQsIDAsIC1oZWlnaHQsIHdpZHRoLCBoZWlnaHQpOwogICAgdGhpcy5jb21wb3NlKCk7CiAgICB0aGlzLnJlc3RvcmUob3BJZHgpOwogIH0KICBwYWludElubGluZUltYWdlWE9iamVjdEdyb3VwKG9wSWR4LCBpbWdEYXRhLCBtYXApIHsKICAgIGlmICghdGhpcy5jb250ZW50VmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGxldCBpbWdUb1BhaW50OwogICAgaWYgKGltZ0RhdGEuYml0bWFwKSB7CiAgICAgIGltZ1RvUGFpbnQgPSBpbWdEYXRhLmJpdG1hcDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHcgPSBpbWdEYXRhLndpZHRoOwogICAgICBjb25zdCBoID0gaW1nRGF0YS5oZWlnaHQ7CiAgICAgIGNvbnN0IHRtcENhbnZhcyA9IHRoaXMuY2FjaGVkQ2FudmFzZXMuZ2V0Q2FudmFzKCJpbmxpbmVJbWFnZSIsIHcsIGgpOwogICAgICBjb25zdCB0bXBDdHggPSB0bXBDYW52YXMuY29udGV4dDsKICAgICAgcHV0QmluYXJ5SW1hZ2VEYXRhKHRtcEN0eCwgaW1nRGF0YSk7CiAgICAgIGltZ1RvUGFpbnQgPSB0aGlzLmFwcGx5VHJhbnNmZXJNYXBzVG9DYW52YXModG1wQ3R4KTsKICAgIH0KICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc2V0QkJveChvcElkeCk7CiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIG1hcCkgewogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHgudHJhbnNmb3JtKC4uLmVudHJ5LnRyYW5zZm9ybSk7CiAgICAgIGN0eC5zY2FsZSgxLCAtMSk7CiAgICAgIGRyYXdJbWFnZUF0SW50ZWdlckNvb3JkcyhjdHgsIGltZ1RvUGFpbnQsIGVudHJ5LngsIGVudHJ5LnksIGVudHJ5LncsIGVudHJ5LmgsIDAsIC0xLCAxLCAxKTsKICAgICAgdGhpcy5kZXBlbmRlbmN5VHJhY2tlcj8ucmVjb3JkQkJveChvcElkeCwgY3R4LCAwLCAxLCAtMSwgMCk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5yZWNvcmRPcGVyYXRpb24ob3BJZHgpOwogICAgdGhpcy5jb21wb3NlKCk7CiAgfQogIHBhaW50U29saWRDb2xvckltYWdlTWFzayhvcElkeCkgewogICAgaWYgKCF0aGlzLmNvbnRlbnRWaXNpYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlc2V0QkJveChvcElkeCkucmVjb3JkQkJveChvcElkeCwgdGhpcy5jdHgsIDAsIDEsIDAsIDEpLnJlY29yZERlcGVuZGVuY2llcyhvcElkeCwgRGVwZW5kZW5jaWVzLmZpbGwpLnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgICB0aGlzLmN0eC5maWxsUmVjdCgwLCAwLCAxLCAxKTsKICAgIHRoaXMuY29tcG9zZSgpOwogIH0KICBtYXJrUG9pbnQob3BJZHgsIHRhZykgewogIH0KICBtYXJrUG9pbnRQcm9wcyhvcElkeCwgdGFnLCBwcm9wZXJ0aWVzKSB7CiAgfQogIGJlZ2luTWFya2VkQ29udGVudChvcElkeCwgdGFnKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5iZWdpbk1hcmtlZENvbnRlbnQob3BJZHgpOwogICAgdGhpcy5tYXJrZWRDb250ZW50U3RhY2sucHVzaCh7CiAgICAgIHZpc2libGU6IHRydWUKICAgIH0pOwogIH0KICBiZWdpbk1hcmtlZENvbnRlbnRQcm9wcyhvcElkeCwgdGFnLCBwcm9wZXJ0aWVzKSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5iZWdpbk1hcmtlZENvbnRlbnQob3BJZHgpOwogICAgaWYgKHRhZyA9PT0gIk9DIikgewogICAgICB0aGlzLm1hcmtlZENvbnRlbnRTdGFjay5wdXNoKHsKICAgICAgICB2aXNpYmxlOiB0aGlzLm9wdGlvbmFsQ29udGVudENvbmZpZy5pc1Zpc2libGUocHJvcGVydGllcykKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLm1hcmtlZENvbnRlbnRTdGFjay5wdXNoKHsKICAgICAgICB2aXNpYmxlOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5jb250ZW50VmlzaWJsZSA9IHRoaXMuaXNDb250ZW50VmlzaWJsZSgpOwogIH0KICBlbmRNYXJrZWRDb250ZW50KG9wSWR4KSB7CiAgICB0aGlzLmRlcGVuZGVuY3lUcmFja2VyPy5lbmRNYXJrZWRDb250ZW50KG9wSWR4KTsKICAgIHRoaXMubWFya2VkQ29udGVudFN0YWNrLnBvcCgpOwogICAgdGhpcy5jb250ZW50VmlzaWJsZSA9IHRoaXMuaXNDb250ZW50VmlzaWJsZSgpOwogIH0KICBiZWdpbkNvbXBhdChvcElkeCkgewogIH0KICBlbmRDb21wYXQob3BJZHgpIHsKICB9CiAgY29uc3VtZVBhdGgob3BJZHgsIHBhdGgsIGNsaXBCb3gpIHsKICAgIGNvbnN0IGlzRW1wdHkgPSB0aGlzLmN1cnJlbnQuaXNFbXB0eUNsaXAoKTsKICAgIGlmICh0aGlzLnBlbmRpbmdDbGlwKSB7CiAgICAgIHRoaXMuY3VycmVudC51cGRhdGVDbGlwRnJvbVBhdGgoKTsKICAgIH0KICAgIGlmICghdGhpcy5wZW5kaW5nQ2xpcCkgewogICAgICB0aGlzLmNvbXBvc2UoY2xpcEJveCk7CiAgICB9CiAgICBjb25zdCBjdHggPSB0aGlzLmN0eDsKICAgIGlmICh0aGlzLnBlbmRpbmdDbGlwKSB7CiAgICAgIGlmICghaXNFbXB0eSkgewogICAgICAgIGlmICh0aGlzLnBlbmRpbmdDbGlwID09PSBFT19DTElQKSB7CiAgICAgICAgICBjdHguY2xpcChwYXRoLCAiZXZlbm9kZCIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdHguY2xpcChwYXRoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5wZW5kaW5nQ2xpcCA9IG51bGw7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LmJib3hUb0NsaXBCb3hEcm9wT3BlcmF0aW9uKG9wSWR4KS5yZWNvcmRGdXR1cmVGb3JjZWREZXBlbmRlbmN5KCJjbGlwUGF0aCIsIG9wSWR4KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZGVwZW5kZW5jeVRyYWNrZXI/LnJlY29yZE9wZXJhdGlvbihvcElkeCk7CiAgICB9CiAgICB0aGlzLmN1cnJlbnQuc3RhcnROZXdQYXRoQW5kQ2xpcEJveCh0aGlzLmN1cnJlbnQuY2xpcEJveCk7CiAgfQogIGdldFNpbmdsZVBpeGVsV2lkdGgoKSB7CiAgICBpZiAoIXRoaXMuX2NhY2hlZEdldFNpbmdsZVBpeGVsV2lkdGgpIHsKICAgICAgY29uc3QgbSA9IGdldEN1cnJlbnRUcmFuc2Zvcm0odGhpcy5jdHgpOwogICAgICBpZiAobVsxXSA9PT0gMCAmJiBtWzJdID09PSAwKSB7CiAgICAgICAgdGhpcy5fY2FjaGVkR2V0U2luZ2xlUGl4ZWxXaWR0aCA9IDEgLyBNYXRoLm1pbihNYXRoLmFicyhtWzBdKSwgTWF0aC5hYnMobVszXSkpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFic0RldCA9IE1hdGguYWJzKG1bMF0gKiBtWzNdIC0gbVsyXSAqIG1bMV0pOwogICAgICAgIGNvbnN0IG5vcm1YID0gTWF0aC5oeXBvdChtWzBdLCBtWzJdKTsKICAgICAgICBjb25zdCBub3JtWSA9IE1hdGguaHlwb3QobVsxXSwgbVszXSk7CiAgICAgICAgdGhpcy5fY2FjaGVkR2V0U2luZ2xlUGl4ZWxXaWR0aCA9IE1hdGgubWF4KG5vcm1YLCBub3JtWSkgLyBhYnNEZXQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLl9jYWNoZWRHZXRTaW5nbGVQaXhlbFdpZHRoOwogIH0KICBnZXRTY2FsZUZvclN0cm9raW5nKCkgewogICAgaWYgKHRoaXMuX2NhY2hlZFNjYWxlRm9yU3Ryb2tpbmdbMF0gPT09IC0xKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBsaW5lV2lkdGgKICAgICAgfSA9IHRoaXMuY3VycmVudDsKICAgICAgY29uc3QgewogICAgICAgIGEsCiAgICAgICAgYiwKICAgICAgICBjLAogICAgICAgIGQKICAgICAgfSA9IHRoaXMuY3R4LmdldFRyYW5zZm9ybSgpOwogICAgICBsZXQgc2NhbGVYLCBzY2FsZVk7CiAgICAgIGlmIChiID09PSAwICYmIGMgPT09IDApIHsKICAgICAgICBjb25zdCBub3JtWCA9IE1hdGguYWJzKGEpOwogICAgICAgIGNvbnN0IG5vcm1ZID0gTWF0aC5hYnMoZCk7CiAgICAgICAgaWYgKG5vcm1YID09PSBub3JtWSkgewogICAgICAgICAgaWYgKGxpbmVXaWR0aCA9PT0gMCkgewogICAgICAgICAgICBzY2FsZVggPSBzY2FsZVkgPSAxIC8gbm9ybVg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBzY2FsZWRMaW5lV2lkdGggPSBub3JtWCAqIGxpbmVXaWR0aDsKICAgICAgICAgICAgc2NhbGVYID0gc2NhbGVZID0gc2NhbGVkTGluZVdpZHRoIDwgMSA/IDEgLyBzY2FsZWRMaW5lV2lkdGggOiAxOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAobGluZVdpZHRoID09PSAwKSB7CiAgICAgICAgICBzY2FsZVggPSAxIC8gbm9ybVg7CiAgICAgICAgICBzY2FsZVkgPSAxIC8gbm9ybVk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHNjYWxlZFhMaW5lV2lkdGggPSBub3JtWCAqIGxpbmVXaWR0aDsKICAgICAgICAgIGNvbnN0IHNjYWxlZFlMaW5lV2lkdGggPSBub3JtWSAqIGxpbmVXaWR0aDsKICAgICAgICAgIHNjYWxlWCA9IHNjYWxlZFhMaW5lV2lkdGggPCAxID8gMSAvIHNjYWxlZFhMaW5lV2lkdGggOiAxOwogICAgICAgICAgc2NhbGVZID0gc2NhbGVkWUxpbmVXaWR0aCA8IDEgPyAxIC8gc2NhbGVkWUxpbmVXaWR0aCA6IDE7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFic0RldCA9IE1hdGguYWJzKGEgKiBkIC0gYiAqIGMpOwogICAgICAgIGNvbnN0IG5vcm1YID0gTWF0aC5oeXBvdChhLCBiKTsKICAgICAgICBjb25zdCBub3JtWSA9IE1hdGguaHlwb3QoYywgZCk7CiAgICAgICAgaWYgKGxpbmVXaWR0aCA9PT0gMCkgewogICAgICAgICAgc2NhbGVYID0gbm9ybVkgLyBhYnNEZXQ7CiAgICAgICAgICBzY2FsZVkgPSBub3JtWCAvIGFic0RldDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgYmFzZUFyZWEgPSBsaW5lV2lkdGggKiBhYnNEZXQ7CiAgICAgICAgICBzY2FsZVggPSBub3JtWSA+IGJhc2VBcmVhID8gbm9ybVkgLyBiYXNlQXJlYSA6IDE7CiAgICAgICAgICBzY2FsZVkgPSBub3JtWCA+IGJhc2VBcmVhID8gbm9ybVggLyBiYXNlQXJlYSA6IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX2NhY2hlZFNjYWxlRm9yU3Ryb2tpbmdbMF0gPSBzY2FsZVg7CiAgICAgIHRoaXMuX2NhY2hlZFNjYWxlRm9yU3Ryb2tpbmdbMV0gPSBzY2FsZVk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5fY2FjaGVkU2NhbGVGb3JTdHJva2luZzsKICB9CiAgcmVzY2FsZUFuZFN0cm9rZShwYXRoLCBzYXZlUmVzdG9yZSkgewogICAgY29uc3QgewogICAgICBjdHgsCiAgICAgIGN1cnJlbnQ6IHsKICAgICAgICBsaW5lV2lkdGgKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBjb25zdCBbc2NhbGVYLCBzY2FsZVldID0gdGhpcy5nZXRTY2FsZUZvclN0cm9raW5nKCk7CiAgICBpZiAoc2NhbGVYID09PSBzY2FsZVkpIHsKICAgICAgY3R4LmxpbmVXaWR0aCA9IChsaW5lV2lkdGggfHwgMSkgKiBzY2FsZVg7CiAgICAgIGN0eC5zdHJva2UocGF0aCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGRhc2hlcyA9IGN0eC5nZXRMaW5lRGFzaCgpOwogICAgaWYgKHNhdmVSZXN0b3JlKSB7CiAgICAgIGN0eC5zYXZlKCk7CiAgICB9CiAgICBjdHguc2NhbGUoc2NhbGVYLCBzY2FsZVkpOwogICAgU0NBTEVfTUFUUklYLmEgPSAxIC8gc2NhbGVYOwogICAgU0NBTEVfTUFUUklYLmQgPSAxIC8gc2NhbGVZOwogICAgY29uc3QgbmV3UGF0aCA9IG5ldyBQYXRoMkQoKTsKICAgIG5ld1BhdGguYWRkUGF0aChwYXRoLCBTQ0FMRV9NQVRSSVgpOwogICAgaWYgKGRhc2hlcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IHNjYWxlID0gTWF0aC5tYXgoc2NhbGVYLCBzY2FsZVkpOwogICAgICBjdHguc2V0TGluZURhc2goZGFzaGVzLm1hcCgoeCkgPT4geCAvIHNjYWxlKSk7CiAgICAgIGN0eC5saW5lRGFzaE9mZnNldCAvPSBzY2FsZTsKICAgIH0KICAgIGN0eC5saW5lV2lkdGggPSBsaW5lV2lkdGggfHwgMTsKICAgIGN0eC5zdHJva2UobmV3UGF0aCk7CiAgICBpZiAoc2F2ZVJlc3RvcmUpIHsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0KICB9CiAgaXNDb250ZW50VmlzaWJsZSgpIHsKICAgIGZvciAobGV0IGkgPSB0aGlzLm1hcmtlZENvbnRlbnRTdGFjay5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAoIXRoaXMubWFya2VkQ29udGVudFN0YWNrW2ldLnZpc2libGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KfTsKZm9yIChjb25zdCBvcCBpbiBPUFMpIHsKICBpZiAoQ2FudmFzR3JhcGhpY3MucHJvdG90eXBlW29wXSAhPT0gdm9pZCAwKSB7CiAgICBDYW52YXNHcmFwaGljcy5wcm90b3R5cGVbT1BTW29wXV0gPSBDYW52YXNHcmFwaGljcy5wcm90b3R5cGVbb3BdOwogIH0KfQp2YXIgR2xvYmFsV29ya2VyT3B0aW9ucyA9IGNsYXNzIHsKICBzdGF0aWMgI3BvcnQgPSBudWxsOwogIHN0YXRpYyAjc3JjID0gIiI7CiAgc3RhdGljIGdldCB3b3JrZXJQb3J0KCkgewogICAgcmV0dXJuIHRoaXMuI3BvcnQ7CiAgfQogIHN0YXRpYyBzZXQgd29ya2VyUG9ydCh2YWwpIHsKICAgIGlmICghKHR5cGVvZiBXb3JrZXIgIT09ICJ1bmRlZmluZWQiICYmIHZhbCBpbnN0YW5jZW9mIFdvcmtlcikgJiYgdmFsICE9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBgd29ya2VyUG9ydGAgdHlwZS4iKTsKICAgIH0KICAgIHRoaXMuI3BvcnQgPSB2YWw7CiAgfQogIHN0YXRpYyBnZXQgd29ya2VyU3JjKCkgewogICAgcmV0dXJuIHRoaXMuI3NyYzsKICB9CiAgc3RhdGljIHNldCB3b3JrZXJTcmModmFsKSB7CiAgICBpZiAodHlwZW9mIHZhbCAhPT0gInN0cmluZyIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGB3b3JrZXJTcmNgIHR5cGUuIik7CiAgICB9CiAgICB0aGlzLiNzcmMgPSB2YWw7CiAgfQp9Owp2YXIgTWV0YWRhdGEgPSBjbGFzcyB7CiAgI21hcDsKICAjZGF0YTsKICBjb25zdHJ1Y3Rvcih7CiAgICBwYXJzZWREYXRhLAogICAgcmF3RGF0YQogIH0pIHsKICAgIHRoaXMuI21hcCA9IHBhcnNlZERhdGE7CiAgICB0aGlzLiNkYXRhID0gcmF3RGF0YTsKICB9CiAgZ2V0UmF3KCkgewogICAgcmV0dXJuIHRoaXMuI2RhdGE7CiAgfQogIGdldChuYW1lKSB7CiAgICByZXR1cm4gdGhpcy4jbWFwLmdldChuYW1lKSA/PyBudWxsOwogIH0KICBbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIHJldHVybiB0aGlzLiNtYXAuZW50cmllcygpOwogIH0KfTsKdmFyIElOVEVSTkFMID0gU3ltYm9sKCJJTlRFUk5BTCIpOwp2YXIgT3B0aW9uYWxDb250ZW50R3JvdXAgPSBjbGFzcyB7CiAgI2lzRGlzcGxheSA9IGZhbHNlOwogICNpc1ByaW50ID0gZmFsc2U7CiAgI3VzZXJTZXQgPSBmYWxzZTsKICAjdmlzaWJsZSA9IHRydWU7CiAgY29uc3RydWN0b3IocmVuZGVyaW5nSW50ZW50LCB7CiAgICBuYW1lLAogICAgaW50ZW50LAogICAgdXNhZ2UsCiAgICByYkdyb3VwcwogIH0pIHsKICAgIHRoaXMuI2lzRGlzcGxheSA9ICEhKHJlbmRlcmluZ0ludGVudCAmIFJlbmRlcmluZ0ludGVudEZsYWcuRElTUExBWSk7CiAgICB0aGlzLiNpc1ByaW50ID0gISEocmVuZGVyaW5nSW50ZW50ICYgUmVuZGVyaW5nSW50ZW50RmxhZy5QUklOVCk7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5pbnRlbnQgPSBpbnRlbnQ7CiAgICB0aGlzLnVzYWdlID0gdXNhZ2U7CiAgICB0aGlzLnJiR3JvdXBzID0gcmJHcm91cHM7CiAgfQogIGdldCB2aXNpYmxlKCkgewogICAgaWYgKHRoaXMuI3VzZXJTZXQpIHsKICAgICAgcmV0dXJuIHRoaXMuI3Zpc2libGU7CiAgICB9CiAgICBpZiAoIXRoaXMuI3Zpc2libGUpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3QgewogICAgICBwcmludCwKICAgICAgdmlldwogICAgfSA9IHRoaXMudXNhZ2U7CiAgICBpZiAodGhpcy4jaXNEaXNwbGF5KSB7CiAgICAgIHJldHVybiB2aWV3Py52aWV3U3RhdGUgIT09ICJPRkYiOwogICAgfSBlbHNlIGlmICh0aGlzLiNpc1ByaW50KSB7CiAgICAgIHJldHVybiBwcmludD8ucHJpbnRTdGF0ZSAhPT0gIk9GRiI7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgX3NldFZpc2libGUoaW50ZXJuYWwsIHZpc2libGUsIHVzZXJTZXQgPSBmYWxzZSkgewogICAgaWYgKGludGVybmFsICE9PSBJTlRFUk5BTCkgewogICAgICB1bnJlYWNoYWJsZSgiSW50ZXJuYWwgbWV0aG9kIGBfc2V0VmlzaWJsZWAgY2FsbGVkLiIpOwogICAgfQogICAgdGhpcy4jdXNlclNldCA9IHVzZXJTZXQ7CiAgICB0aGlzLiN2aXNpYmxlID0gdmlzaWJsZTsKICB9Cn07CnZhciBPcHRpb25hbENvbnRlbnRDb25maWcgPSBjbGFzcyB7CiAgI2NhY2hlZEdldEhhc2ggPSBudWxsOwogICNncm91cHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICNpbml0aWFsSGFzaCA9IG51bGw7CiAgI29yZGVyID0gbnVsbDsKICBjb25zdHJ1Y3RvcihkYXRhLCByZW5kZXJpbmdJbnRlbnQgPSBSZW5kZXJpbmdJbnRlbnRGbGFnLkRJU1BMQVkpIHsKICAgIHRoaXMucmVuZGVyaW5nSW50ZW50ID0gcmVuZGVyaW5nSW50ZW50OwogICAgdGhpcy5uYW1lID0gbnVsbDsKICAgIHRoaXMuY3JlYXRvciA9IG51bGw7CiAgICBpZiAoZGF0YSA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLm5hbWUgPSBkYXRhLm5hbWU7CiAgICB0aGlzLmNyZWF0b3IgPSBkYXRhLmNyZWF0b3I7CiAgICB0aGlzLiNvcmRlciA9IGRhdGEub3JkZXI7CiAgICBmb3IgKGNvbnN0IGdyb3VwIG9mIGRhdGEuZ3JvdXBzKSB7CiAgICAgIHRoaXMuI2dyb3Vwcy5zZXQoZ3JvdXAuaWQsIG5ldyBPcHRpb25hbENvbnRlbnRHcm91cChyZW5kZXJpbmdJbnRlbnQsIGdyb3VwKSk7CiAgICB9CiAgICBpZiAoZGF0YS5iYXNlU3RhdGUgPT09ICJPRkYiKSB7CiAgICAgIGZvciAoY29uc3QgZ3JvdXAgb2YgdGhpcy4jZ3JvdXBzLnZhbHVlcygpKSB7CiAgICAgICAgZ3JvdXAuX3NldFZpc2libGUoSU5URVJOQUwsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgZm9yIChjb25zdCBvbiBvZiBkYXRhLm9uKSB7CiAgICAgIHRoaXMuI2dyb3Vwcy5nZXQob24pLl9zZXRWaXNpYmxlKElOVEVSTkFMLCB0cnVlKTsKICAgIH0KICAgIGZvciAoY29uc3Qgb2ZmIG9mIGRhdGEub2ZmKSB7CiAgICAgIHRoaXMuI2dyb3Vwcy5nZXQob2ZmKS5fc2V0VmlzaWJsZShJTlRFUk5BTCwgZmFsc2UpOwogICAgfQogICAgdGhpcy4jaW5pdGlhbEhhc2ggPSB0aGlzLmdldEhhc2goKTsKICB9CiAgI2V2YWx1YXRlVmlzaWJpbGl0eUV4cHJlc3Npb24oYXJyYXkpIHsKICAgIGNvbnN0IGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsKICAgIGlmIChsZW5ndGggPCAyKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgY29uc3Qgb3BlcmF0b3IgPSBhcnJheVswXTsKICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgZWxlbWVudCA9IGFycmF5W2ldOwogICAgICBsZXQgc3RhdGU7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGVsZW1lbnQpKSB7CiAgICAgICAgc3RhdGUgPSB0aGlzLiNldmFsdWF0ZVZpc2liaWxpdHlFeHByZXNzaW9uKGVsZW1lbnQpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuI2dyb3Vwcy5oYXMoZWxlbWVudCkpIHsKICAgICAgICBzdGF0ZSA9IHRoaXMuI2dyb3Vwcy5nZXQoZWxlbWVudCkudmlzaWJsZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuKGBPcHRpb25hbCBjb250ZW50IGdyb3VwIG5vdCBmb3VuZDogJHtlbGVtZW50fWApOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHN3aXRjaCAob3BlcmF0b3IpIHsKICAgICAgICBjYXNlICJBbmQiOgogICAgICAgICAgaWYgKCFzdGF0ZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJPciI6CiAgICAgICAgICBpZiAoc3RhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJOb3QiOgogICAgICAgICAgcmV0dXJuICFzdGF0ZTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvcGVyYXRvciA9PT0gIkFuZCI7CiAgfQogIGlzVmlzaWJsZShncm91cCkgewogICAgaWYgKHRoaXMuI2dyb3Vwcy5zaXplID09PSAwKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKCFncm91cCkgewogICAgICBpbmZvKCJPcHRpb25hbCBjb250ZW50IGdyb3VwIG5vdCBkZWZpbmVkLiIpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChncm91cC50eXBlID09PSAiT0NHIikgewogICAgICBpZiAoIXRoaXMuI2dyb3Vwcy5oYXMoZ3JvdXAuaWQpKSB7CiAgICAgICAgd2FybihgT3B0aW9uYWwgY29udGVudCBncm91cCBub3QgZm91bmQ6ICR7Z3JvdXAuaWR9YCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuI2dyb3Vwcy5nZXQoZ3JvdXAuaWQpLnZpc2libGU7CiAgICB9IGVsc2UgaWYgKGdyb3VwLnR5cGUgPT09ICJPQ01EIikgewogICAgICBpZiAoZ3JvdXAuZXhwcmVzc2lvbikgewogICAgICAgIHJldHVybiB0aGlzLiNldmFsdWF0ZVZpc2liaWxpdHlFeHByZXNzaW9uKGdyb3VwLmV4cHJlc3Npb24pOwogICAgICB9CiAgICAgIGlmICghZ3JvdXAucG9saWN5IHx8IGdyb3VwLnBvbGljeSA9PT0gIkFueU9uIikgewogICAgICAgIGZvciAoY29uc3QgaWQgb2YgZ3JvdXAuaWRzKSB7CiAgICAgICAgICBpZiAoIXRoaXMuI2dyb3Vwcy5oYXMoaWQpKSB7CiAgICAgICAgICAgIHdhcm4oYE9wdGlvbmFsIGNvbnRlbnQgZ3JvdXAgbm90IGZvdW5kOiAke2lkfWApOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLiNncm91cHMuZ2V0KGlkKS52aXNpYmxlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoZ3JvdXAucG9saWN5ID09PSAiQWxsT24iKSB7CiAgICAgICAgZm9yIChjb25zdCBpZCBvZiBncm91cC5pZHMpIHsKICAgICAgICAgIGlmICghdGhpcy4jZ3JvdXBzLmhhcyhpZCkpIHsKICAgICAgICAgICAgd2FybihgT3B0aW9uYWwgY29udGVudCBncm91cCBub3QgZm91bmQ6ICR7aWR9YCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0aGlzLiNncm91cHMuZ2V0KGlkKS52aXNpYmxlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAoZ3JvdXAucG9saWN5ID09PSAiQW55T2ZmIikgewogICAgICAgIGZvciAoY29uc3QgaWQgb2YgZ3JvdXAuaWRzKSB7CiAgICAgICAgICBpZiAoIXRoaXMuI2dyb3Vwcy5oYXMoaWQpKSB7CiAgICAgICAgICAgIHdhcm4oYE9wdGlvbmFsIGNvbnRlbnQgZ3JvdXAgbm90IGZvdW5kOiAke2lkfWApOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhpcy4jZ3JvdXBzLmdldChpZCkudmlzaWJsZSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGdyb3VwLnBvbGljeSA9PT0gIkFsbE9mZiIpIHsKICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIGdyb3VwLmlkcykgewogICAgICAgICAgaWYgKCF0aGlzLiNncm91cHMuaGFzKGlkKSkgewogICAgICAgICAgICB3YXJuKGBPcHRpb25hbCBjb250ZW50IGdyb3VwIG5vdCBmb3VuZDogJHtpZH1gKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy4jZ3JvdXBzLmdldChpZCkudmlzaWJsZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHdhcm4oYFVua25vd24gb3B0aW9uYWwgY29udGVudCBwb2xpY3kgJHtncm91cC5wb2xpY3l9LmApOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHdhcm4oYFVua25vd24gZ3JvdXAgdHlwZSAke2dyb3VwLnR5cGV9LmApOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHNldFZpc2liaWxpdHkoaWQsIHZpc2libGUgPSB0cnVlLCBwcmVzZXJ2ZVJCID0gdHJ1ZSkgewogICAgY29uc3QgZ3JvdXAgPSB0aGlzLiNncm91cHMuZ2V0KGlkKTsKICAgIGlmICghZ3JvdXApIHsKICAgICAgd2FybihgT3B0aW9uYWwgY29udGVudCBncm91cCBub3QgZm91bmQ6ICR7aWR9YCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwcmVzZXJ2ZVJCICYmIHZpc2libGUgJiYgZ3JvdXAucmJHcm91cHMubGVuZ3RoKSB7CiAgICAgIGZvciAoY29uc3QgcmJHcm91cCBvZiBncm91cC5yYkdyb3VwcykgewogICAgICAgIGZvciAoY29uc3Qgb3RoZXJJZCBvZiByYkdyb3VwKSB7CiAgICAgICAgICBpZiAob3RoZXJJZCAhPT0gaWQpIHsKICAgICAgICAgICAgdGhpcy4jZ3JvdXBzLmdldChvdGhlcklkKT8uX3NldFZpc2libGUoSU5URVJOQUwsIGZhbHNlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGdyb3VwLl9zZXRWaXNpYmxlKElOVEVSTkFMLCAhIXZpc2libGUsIHRydWUpOwogICAgdGhpcy4jY2FjaGVkR2V0SGFzaCA9IG51bGw7CiAgfQogIHNldE9DR1N0YXRlKHsKICAgIHN0YXRlLAogICAgcHJlc2VydmVSQgogIH0pIHsKICAgIGxldCBvcGVyYXRvcjsKICAgIGZvciAoY29uc3QgZWxlbSBvZiBzdGF0ZSkgewogICAgICBzd2l0Y2ggKGVsZW0pIHsKICAgICAgICBjYXNlICJPTiI6CiAgICAgICAgY2FzZSAiT0ZGIjoKICAgICAgICBjYXNlICJUb2dnbGUiOgogICAgICAgICAgb3BlcmF0b3IgPSBlbGVtOwogICAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgZ3JvdXAgPSB0aGlzLiNncm91cHMuZ2V0KGVsZW0pOwogICAgICBpZiAoIWdyb3VwKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgc3dpdGNoIChvcGVyYXRvcikgewogICAgICAgIGNhc2UgIk9OIjoKICAgICAgICAgIHRoaXMuc2V0VmlzaWJpbGl0eShlbGVtLCB0cnVlLCBwcmVzZXJ2ZVJCKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIk9GRiI6CiAgICAgICAgICB0aGlzLnNldFZpc2liaWxpdHkoZWxlbSwgZmFsc2UsIHByZXNlcnZlUkIpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiVG9nZ2xlIjoKICAgICAgICAgIHRoaXMuc2V0VmlzaWJpbGl0eShlbGVtLCAhZ3JvdXAudmlzaWJsZSwgcHJlc2VydmVSQik7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgdGhpcy4jY2FjaGVkR2V0SGFzaCA9IG51bGw7CiAgfQogIGdldCBoYXNJbml0aWFsVmlzaWJpbGl0eSgpIHsKICAgIHJldHVybiB0aGlzLiNpbml0aWFsSGFzaCA9PT0gbnVsbCB8fCB0aGlzLmdldEhhc2goKSA9PT0gdGhpcy4jaW5pdGlhbEhhc2g7CiAgfQogIGdldE9yZGVyKCkgewogICAgaWYgKCF0aGlzLiNncm91cHMuc2l6ZSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGlmICh0aGlzLiNvcmRlcikgewogICAgICByZXR1cm4gdGhpcy4jb3JkZXIuc2xpY2UoKTsKICAgIH0KICAgIHJldHVybiBbLi4udGhpcy4jZ3JvdXBzLmtleXMoKV07CiAgfQogIGdldEdyb3VwKGlkKSB7CiAgICByZXR1cm4gdGhpcy4jZ3JvdXBzLmdldChpZCkgfHwgbnVsbDsKICB9CiAgZ2V0SGFzaCgpIHsKICAgIGlmICh0aGlzLiNjYWNoZWRHZXRIYXNoICE9PSBudWxsKSB7CiAgICAgIHJldHVybiB0aGlzLiNjYWNoZWRHZXRIYXNoOwogICAgfQogICAgY29uc3QgaGFzaCA9IG5ldyBNdXJtdXJIYXNoM182NCgpOwogICAgZm9yIChjb25zdCBbaWQsIGdyb3VwXSBvZiB0aGlzLiNncm91cHMpIHsKICAgICAgaGFzaC51cGRhdGUoYCR7aWR9OiR7Z3JvdXAudmlzaWJsZX1gKTsKICAgIH0KICAgIHJldHVybiB0aGlzLiNjYWNoZWRHZXRIYXNoID0gaGFzaC5oZXhkaWdlc3QoKTsKICB9CiAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICByZXR1cm4gdGhpcy4jZ3JvdXBzLmVudHJpZXMoKTsKICB9Cn07CnZhciBQREZEYXRhVHJhbnNwb3J0U3RyZWFtID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBkZkRhdGFSYW5nZVRyYW5zcG9ydCwgewogICAgZGlzYWJsZVJhbmdlID0gZmFsc2UsCiAgICBkaXNhYmxlU3RyZWFtID0gZmFsc2UKICB9KSB7CiAgICBhc3NlcnQocGRmRGF0YVJhbmdlVHJhbnNwb3J0LCAnUERGRGF0YVRyYW5zcG9ydFN0cmVhbSAtIG1pc3NpbmcgcmVxdWlyZWQgInBkZkRhdGFSYW5nZVRyYW5zcG9ydCIgYXJndW1lbnQuJyk7CiAgICBjb25zdCB7CiAgICAgIGxlbmd0aCwKICAgICAgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiwKICAgICAgcHJvZ3Jlc3NpdmVEb25lLAogICAgICBjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZQogICAgfSA9IHBkZkRhdGFSYW5nZVRyYW5zcG9ydDsKICAgIHRoaXMuX3F1ZXVlZENodW5rcyA9IFtdOwogICAgdGhpcy5fcHJvZ3Jlc3NpdmVEb25lID0gcHJvZ3Jlc3NpdmVEb25lOwogICAgdGhpcy5fY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWUgPSBjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZTsKICAgIGlmIChpbml0aWFsRGF0YTI/Lmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgYnVmZmVyID0gaW5pdGlhbERhdGEyIGluc3RhbmNlb2YgVWludDhBcnJheSAmJiBpbml0aWFsRGF0YTIuYnl0ZUxlbmd0aCA9PT0gaW5pdGlhbERhdGEyLmJ1ZmZlci5ieXRlTGVuZ3RoID8gaW5pdGlhbERhdGEyLmJ1ZmZlciA6IG5ldyBVaW50OEFycmF5KGluaXRpYWxEYXRhMikuYnVmZmVyOwogICAgICB0aGlzLl9xdWV1ZWRDaHVua3MucHVzaChidWZmZXIpOwogICAgfQogICAgdGhpcy5fcGRmRGF0YVJhbmdlVHJhbnNwb3J0ID0gcGRmRGF0YVJhbmdlVHJhbnNwb3J0OwogICAgdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQgPSAhZGlzYWJsZVN0cmVhbTsKICAgIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQgPSAhZGlzYWJsZVJhbmdlOwogICAgdGhpcy5fY29udGVudExlbmd0aCA9IGxlbmd0aDsKICAgIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyID0gbnVsbDsKICAgIHRoaXMuX3JhbmdlUmVhZGVycyA9IFtdOwogICAgcGRmRGF0YVJhbmdlVHJhbnNwb3J0LmFkZFJhbmdlTGlzdGVuZXIoKGJlZ2luLCBjaHVuaykgPT4gewogICAgICB0aGlzLl9vblJlY2VpdmVEYXRhKHsKICAgICAgICBiZWdpbiwKICAgICAgICBjaHVuawogICAgICB9KTsKICAgIH0pOwogICAgcGRmRGF0YVJhbmdlVHJhbnNwb3J0LmFkZFByb2dyZXNzTGlzdGVuZXIoKGxvYWRlZCwgdG90YWwpID0+IHsKICAgICAgdGhpcy5fb25Qcm9ncmVzcyh7CiAgICAgICAgbG9hZGVkLAogICAgICAgIHRvdGFsCiAgICAgIH0pOwogICAgfSk7CiAgICBwZGZEYXRhUmFuZ2VUcmFuc3BvcnQuYWRkUHJvZ3Jlc3NpdmVSZWFkTGlzdGVuZXIoKGNodW5rKSA9PiB7CiAgICAgIHRoaXMuX29uUmVjZWl2ZURhdGEoewogICAgICAgIGNodW5rCiAgICAgIH0pOwogICAgfSk7CiAgICBwZGZEYXRhUmFuZ2VUcmFuc3BvcnQuYWRkUHJvZ3Jlc3NpdmVEb25lTGlzdGVuZXIoKCkgPT4gewogICAgICB0aGlzLl9vblByb2dyZXNzaXZlRG9uZSgpOwogICAgfSk7CiAgICBwZGZEYXRhUmFuZ2VUcmFuc3BvcnQudHJhbnNwb3J0UmVhZHkoKTsKICB9CiAgX29uUmVjZWl2ZURhdGEoewogICAgYmVnaW4sCiAgICBjaHVuawogIH0pIHsKICAgIGNvbnN0IGJ1ZmZlciA9IGNodW5rIGluc3RhbmNlb2YgVWludDhBcnJheSAmJiBjaHVuay5ieXRlTGVuZ3RoID09PSBjaHVuay5idWZmZXIuYnl0ZUxlbmd0aCA/IGNodW5rLmJ1ZmZlciA6IG5ldyBVaW50OEFycmF5KGNodW5rKS5idWZmZXI7CiAgICBpZiAoYmVnaW4gPT09IHZvaWQgMCkgewogICAgICBpZiAodGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIpIHsKICAgICAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlci5fZW5xdWV1ZShidWZmZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX3F1ZXVlZENodW5rcy5wdXNoKGJ1ZmZlcik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGZvdW5kID0gdGhpcy5fcmFuZ2VSZWFkZXJzLnNvbWUoZnVuY3Rpb24ocmFuZ2VSZWFkZXIpIHsKICAgICAgICBpZiAocmFuZ2VSZWFkZXIuX2JlZ2luICE9PSBiZWdpbikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByYW5nZVJlYWRlci5fZW5xdWV1ZShidWZmZXIpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgICAgYXNzZXJ0KGZvdW5kLCAiX29uUmVjZWl2ZURhdGEgLSBubyBgUERGRGF0YVRyYW5zcG9ydFN0cmVhbVJhbmdlUmVhZGVyYCBpbnN0YW5jZSBmb3VuZC4iKTsKICAgIH0KICB9CiAgZ2V0IF9wcm9ncmVzc2l2ZURhdGFMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/Ll9sb2FkZWQgPz8gMDsKICB9CiAgX29uUHJvZ3Jlc3MoZXZ0KSB7CiAgICBpZiAoZXZ0LnRvdGFsID09PSB2b2lkIDApIHsKICAgICAgdGhpcy5fcmFuZ2VSZWFkZXJzWzBdPy5vblByb2dyZXNzPy4oewogICAgICAgIGxvYWRlZDogZXZ0LmxvYWRlZAogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyPy5vblByb2dyZXNzPy4oewogICAgICAgIGxvYWRlZDogZXZ0LmxvYWRlZCwKICAgICAgICB0b3RhbDogZXZ0LnRvdGFsCiAgICAgIH0pOwogICAgfQogIH0KICBfb25Qcm9ncmVzc2l2ZURvbmUoKSB7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcj8ucHJvZ3Jlc3NpdmVEb25lKCk7CiAgICB0aGlzLl9wcm9ncmVzc2l2ZURvbmUgPSB0cnVlOwogIH0KICBfcmVtb3ZlUmFuZ2VSZWFkZXIocmVhZGVyKSB7CiAgICBjb25zdCBpID0gdGhpcy5fcmFuZ2VSZWFkZXJzLmluZGV4T2YocmVhZGVyKTsKICAgIGlmIChpID49IDApIHsKICAgICAgdGhpcy5fcmFuZ2VSZWFkZXJzLnNwbGljZShpLCAxKTsKICAgIH0KICB9CiAgZ2V0RnVsbFJlYWRlcigpIHsKICAgIGFzc2VydCghdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIsICJQREZEYXRhVHJhbnNwb3J0U3RyZWFtLmdldEZ1bGxSZWFkZXIgY2FuIG9ubHkgYmUgY2FsbGVkIG9uY2UuIik7CiAgICBjb25zdCBxdWV1ZWRDaHVua3MgPSB0aGlzLl9xdWV1ZWRDaHVua3M7CiAgICB0aGlzLl9xdWV1ZWRDaHVua3MgPSBudWxsOwogICAgcmV0dXJuIG5ldyBQREZEYXRhVHJhbnNwb3J0U3RyZWFtUmVhZGVyKHRoaXMsIHF1ZXVlZENodW5rcywgdGhpcy5fcHJvZ3Jlc3NpdmVEb25lLCB0aGlzLl9jb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSk7CiAgfQogIGdldFJhbmdlUmVhZGVyKGJlZ2luLCBlbmQpIHsKICAgIGlmIChlbmQgPD0gdGhpcy5fcHJvZ3Jlc3NpdmVEYXRhTGVuZ3RoKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgcmVhZGVyID0gbmV3IFBERkRhdGFUcmFuc3BvcnRTdHJlYW1SYW5nZVJlYWRlcih0aGlzLCBiZWdpbiwgZW5kKTsKICAgIHRoaXMuX3BkZkRhdGFSYW5nZVRyYW5zcG9ydC5yZXF1ZXN0RGF0YVJhbmdlKGJlZ2luLCBlbmQpOwogICAgdGhpcy5fcmFuZ2VSZWFkZXJzLnB1c2gocmVhZGVyKTsKICAgIHJldHVybiByZWFkZXI7CiAgfQogIGNhbmNlbEFsbFJlcXVlc3RzKHJlYXNvbikgewogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/LmNhbmNlbChyZWFzb24pOwogICAgZm9yIChjb25zdCByZWFkZXIgb2YgdGhpcy5fcmFuZ2VSZWFkZXJzLnNsaWNlKDApKSB7CiAgICAgIHJlYWRlci5jYW5jZWwocmVhc29uKTsKICAgIH0KICAgIHRoaXMuX3BkZkRhdGFSYW5nZVRyYW5zcG9ydC5hYm9ydCgpOwogIH0KfTsKdmFyIFBERkRhdGFUcmFuc3BvcnRTdHJlYW1SZWFkZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3Ioc3RyZWFtLCBxdWV1ZWRDaHVua3MsIHByb2dyZXNzaXZlRG9uZSA9IGZhbHNlLCBjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSA9IG51bGwpIHsKICAgIHRoaXMuX3N0cmVhbSA9IHN0cmVhbTsKICAgIHRoaXMuX2RvbmUgPSBwcm9ncmVzc2l2ZURvbmUgfHwgZmFsc2U7CiAgICB0aGlzLl9maWxlbmFtZSA9IGlzUGRmRmlsZShjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSkgPyBjb250ZW50RGlzcG9zaXRpb25GaWxlbmFtZSA6IG51bGw7CiAgICB0aGlzLl9xdWV1ZWRDaHVua3MgPSBxdWV1ZWRDaHVua3MgfHwgW107CiAgICB0aGlzLl9sb2FkZWQgPSAwOwogICAgZm9yIChjb25zdCBjaHVuayBvZiB0aGlzLl9xdWV1ZWRDaHVua3MpIHsKICAgICAgdGhpcy5fbG9hZGVkICs9IGNodW5rLmJ5dGVMZW5ndGg7CiAgICB9CiAgICB0aGlzLl9yZXF1ZXN0cyA9IFtdOwogICAgdGhpcy5faGVhZGVyc1JlYWR5ID0gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICBzdHJlYW0uX2Z1bGxSZXF1ZXN0UmVhZGVyID0gdGhpczsKICAgIHRoaXMub25Qcm9ncmVzcyA9IG51bGw7CiAgfQogIF9lbnF1ZXVlKGNodW5rKSB7CiAgICBpZiAodGhpcy5fZG9uZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSA9IHRoaXMuX3JlcXVlc3RzLnNoaWZ0KCk7CiAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgIHZhbHVlOiBjaHVuaywKICAgICAgICBkb25lOiBmYWxzZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3F1ZXVlZENodW5rcy5wdXNoKGNodW5rKTsKICAgIH0KICAgIHRoaXMuX2xvYWRlZCArPSBjaHVuay5ieXRlTGVuZ3RoOwogIH0KICBnZXQgaGVhZGVyc1JlYWR5KCkgewogICAgcmV0dXJuIHRoaXMuX2hlYWRlcnNSZWFkeTsKICB9CiAgZ2V0IGZpbGVuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX2ZpbGVuYW1lOwogIH0KICBnZXQgaXNSYW5nZVN1cHBvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9zdHJlYW0uX2lzUmFuZ2VTdXBwb3J0ZWQ7CiAgfQogIGdldCBpc1N0cmVhbWluZ1N1cHBvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9zdHJlYW0uX2lzU3RyZWFtaW5nU3VwcG9ydGVkOwogIH0KICBnZXQgY29udGVudExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9zdHJlYW0uX2NvbnRlbnRMZW5ndGg7CiAgfQogIGFzeW5jIHJlYWQoKSB7CiAgICBpZiAodGhpcy5fcXVldWVkQ2h1bmtzLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLl9xdWV1ZWRDaHVua3Muc2hpZnQoKTsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogY2h1bmssCiAgICAgICAgZG9uZTogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5fcmVxdWVzdHMucHVzaChyZXF1ZXN0Q2FwYWJpbGl0eSk7CiAgICByZXR1cm4gcmVxdWVzdENhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgICBmb3IgKGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5IG9mIHRoaXMuX3JlcXVlc3RzKSB7CiAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgZG9uZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICAgIHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA9IDA7CiAgfQogIHByb2dyZXNzaXZlRG9uZSgpIHsKICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2RvbmUgPSB0cnVlOwogIH0KfTsKdmFyIFBERkRhdGFUcmFuc3BvcnRTdHJlYW1SYW5nZVJlYWRlciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihzdHJlYW0sIGJlZ2luLCBlbmQpIHsKICAgIHRoaXMuX3N0cmVhbSA9IHN0cmVhbTsKICAgIHRoaXMuX2JlZ2luID0gYmVnaW47CiAgICB0aGlzLl9lbmQgPSBlbmQ7CiAgICB0aGlzLl9xdWV1ZWRDaHVuayA9IG51bGw7CiAgICB0aGlzLl9yZXF1ZXN0cyA9IFtdOwogICAgdGhpcy5fZG9uZSA9IGZhbHNlOwogICAgdGhpcy5vblByb2dyZXNzID0gbnVsbDsKICB9CiAgX2VucXVldWUoY2h1bmspIHsKICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLl9yZXF1ZXN0cy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5fcXVldWVkQ2h1bmsgPSBjaHVuazsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHJlcXVlc3RzQ2FwYWJpbGl0eSA9IHRoaXMuX3JlcXVlc3RzLnNoaWZ0KCk7CiAgICAgIHJlcXVlc3RzQ2FwYWJpbGl0eS5yZXNvbHZlKHsKICAgICAgICB2YWx1ZTogY2h1bmssCiAgICAgICAgZG9uZTogZmFsc2UKICAgICAgfSk7CiAgICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgICByZXF1ZXN0Q2FwYWJpbGl0eS5yZXNvbHZlKHsKICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICBkb25lOiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICAgIH0KICAgIHRoaXMuX2RvbmUgPSB0cnVlOwogICAgdGhpcy5fc3RyZWFtLl9yZW1vdmVSYW5nZVJlYWRlcih0aGlzKTsKICB9CiAgZ2V0IGlzU3RyZWFtaW5nU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBhc3luYyByZWFkKCkgewogICAgaWYgKHRoaXMuX3F1ZXVlZENodW5rKSB7CiAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5fcXVldWVkQ2h1bms7CiAgICAgIHRoaXMuX3F1ZXVlZENodW5rID0gbnVsbDsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogY2h1bmssCiAgICAgICAgZG9uZTogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5fcmVxdWVzdHMucHVzaChyZXF1ZXN0Q2FwYWJpbGl0eSk7CiAgICByZXR1cm4gcmVxdWVzdENhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgICBmb3IgKGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5IG9mIHRoaXMuX3JlcXVlc3RzKSB7CiAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgZG9uZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICAgIHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA9IDA7CiAgICB0aGlzLl9zdHJlYW0uX3JlbW92ZVJhbmdlUmVhZGVyKHRoaXMpOwogIH0KfTsKZnVuY3Rpb24gZ2V0RmlsZW5hbWVGcm9tQ29udGVudERpc3Bvc2l0aW9uSGVhZGVyKGNvbnRlbnREaXNwb3NpdGlvbikgewogIGxldCBuZWVkc0VuY29kaW5nRml4dXAgPSB0cnVlOwogIGxldCB0bXAgPSB0b1BhcmFtUmVnRXhwKCJmaWxlbmFtZVxcKiIsICJpIikuZXhlYyhjb250ZW50RGlzcG9zaXRpb24pOwogIGlmICh0bXApIHsKICAgIHRtcCA9IHRtcFsxXTsKICAgIGxldCBmaWxlbmFtZSA9IHJmYzI2MTZ1bnF1b3RlKHRtcCk7CiAgICBmaWxlbmFtZSA9IHVuZXNjYXBlKGZpbGVuYW1lKTsKICAgIGZpbGVuYW1lID0gcmZjNTk4N2RlY29kZShmaWxlbmFtZSk7CiAgICBmaWxlbmFtZSA9IHJmYzIwNDdkZWNvZGUoZmlsZW5hbWUpOwogICAgcmV0dXJuIGZpeHVwRW5jb2RpbmcoZmlsZW5hbWUpOwogIH0KICB0bXAgPSByZmMyMjMxZ2V0cGFyYW0oY29udGVudERpc3Bvc2l0aW9uKTsKICBpZiAodG1wKSB7CiAgICBjb25zdCBmaWxlbmFtZSA9IHJmYzIwNDdkZWNvZGUodG1wKTsKICAgIHJldHVybiBmaXh1cEVuY29kaW5nKGZpbGVuYW1lKTsKICB9CiAgdG1wID0gdG9QYXJhbVJlZ0V4cCgiZmlsZW5hbWUiLCAiaSIpLmV4ZWMoY29udGVudERpc3Bvc2l0aW9uKTsKICBpZiAodG1wKSB7CiAgICB0bXAgPSB0bXBbMV07CiAgICBsZXQgZmlsZW5hbWUgPSByZmMyNjE2dW5xdW90ZSh0bXApOwogICAgZmlsZW5hbWUgPSByZmMyMDQ3ZGVjb2RlKGZpbGVuYW1lKTsKICAgIHJldHVybiBmaXh1cEVuY29kaW5nKGZpbGVuYW1lKTsKICB9CiAgZnVuY3Rpb24gdG9QYXJhbVJlZ0V4cChhdHRyaWJ1dGVQYXR0ZXJuLCBmbGFncykgewogICAgcmV0dXJuIG5ldyBSZWdFeHAoIig/Ol58OylcXHMqIiArIGF0dHJpYnV0ZVBhdHRlcm4gKyAnXFxzKj1cXHMqKFteIjtcXHNdW147XFxzXSp8Iig/OlteIlxcXFxdfFxcXFwiPykrIj8pJywgZmxhZ3MpOwogIH0KICBmdW5jdGlvbiB0ZXh0ZGVjb2RlKGVuY29kaW5nLCB2YWx1ZSkgewogICAgaWYgKGVuY29kaW5nKSB7CiAgICAgIGlmICghL15bXHgwMC1ceEZGXSskLy50ZXN0KHZhbHVlKSkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoZW5jb2RpbmcsIHsKICAgICAgICAgIGZhdGFsOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgYnVmZmVyID0gc3RyaW5nVG9CeXRlcyh2YWx1ZSk7CiAgICAgICAgdmFsdWUgPSBkZWNvZGVyLmRlY29kZShidWZmZXIpOwogICAgICAgIG5lZWRzRW5jb2RpbmdGaXh1cCA9IGZhbHNlOwogICAgICB9IGNhdGNoIHsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KICBmdW5jdGlvbiBmaXh1cEVuY29kaW5nKHZhbHVlKSB7CiAgICBpZiAobmVlZHNFbmNvZGluZ0ZpeHVwICYmIC9bXHg4MC1ceGZmXS8udGVzdCh2YWx1ZSkpIHsKICAgICAgdmFsdWUgPSB0ZXh0ZGVjb2RlKCJ1dGYtOCIsIHZhbHVlKTsKICAgICAgaWYgKG5lZWRzRW5jb2RpbmdGaXh1cCkgewogICAgICAgIHZhbHVlID0gdGV4dGRlY29kZSgiaXNvLTg4NTktMSIsIHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KICBmdW5jdGlvbiByZmMyMjMxZ2V0cGFyYW0oY29udGVudERpc3Bvc2l0aW9uU3RyKSB7CiAgICBjb25zdCBtYXRjaGVzID0gW107CiAgICBsZXQgbWF0Y2g7CiAgICBjb25zdCBpdGVyID0gdG9QYXJhbVJlZ0V4cCgiZmlsZW5hbWVcXCooKD8hMFxcZClcXGQrKShcXCo/KSIsICJpZyIpOwogICAgd2hpbGUgKChtYXRjaCA9IGl0ZXIuZXhlYyhjb250ZW50RGlzcG9zaXRpb25TdHIpKSAhPT0gbnVsbCkgewogICAgICBsZXQgWywgbiwgcXVvdCwgcGFydF0gPSBtYXRjaDsKICAgICAgbiA9IHBhcnNlSW50KG4sIDEwKTsKICAgICAgaWYgKG4gaW4gbWF0Y2hlcykgewogICAgICAgIGlmIChuID09PSAwKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgbWF0Y2hlc1tuXSA9IFtxdW90LCBwYXJ0XTsKICAgIH0KICAgIGNvbnN0IHBhcnRzID0gW107CiAgICBmb3IgKGxldCBuID0gMDsgbiA8IG1hdGNoZXMubGVuZ3RoOyArK24pIHsKICAgICAgaWYgKCEobiBpbiBtYXRjaGVzKSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGxldCBbcXVvdCwgcGFydF0gPSBtYXRjaGVzW25dOwogICAgICBwYXJ0ID0gcmZjMjYxNnVucXVvdGUocGFydCk7CiAgICAgIGlmIChxdW90KSB7CiAgICAgICAgcGFydCA9IHVuZXNjYXBlKHBhcnQpOwogICAgICAgIGlmIChuID09PSAwKSB7CiAgICAgICAgICBwYXJ0ID0gcmZjNTk4N2RlY29kZShwYXJ0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcGFydHMucHVzaChwYXJ0KTsKICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCIiKTsKICB9CiAgZnVuY3Rpb24gcmZjMjYxNnVucXVvdGUodmFsdWUpIHsKICAgIGlmICh2YWx1ZS5zdGFydHNXaXRoKCciJykpIHsKICAgICAgY29uc3QgcGFydHMgPSB2YWx1ZS5zbGljZSgxKS5zcGxpdCgnXFwiJyk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyArK2kpIHsKICAgICAgICBjb25zdCBxdW90aW5kZXggPSBwYXJ0c1tpXS5pbmRleE9mKCciJyk7CiAgICAgICAgaWYgKHF1b3RpbmRleCAhPT0gLTEpIHsKICAgICAgICAgIHBhcnRzW2ldID0gcGFydHNbaV0uc2xpY2UoMCwgcXVvdGluZGV4KTsKICAgICAgICAgIHBhcnRzLmxlbmd0aCA9IGkgKyAxOwogICAgICAgIH0KICAgICAgICBwYXJ0c1tpXSA9IHBhcnRzW2ldLnJlcGxhY2VBbGwoL1xcKC4pL2csICIkMSIpOwogICAgICB9CiAgICAgIHZhbHVlID0gcGFydHMuam9pbignIicpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KICBmdW5jdGlvbiByZmM1OTg3ZGVjb2RlKGV4dHZhbHVlKSB7CiAgICBjb25zdCBlbmNvZGluZ2VuZCA9IGV4dHZhbHVlLmluZGV4T2YoIiciKTsKICAgIGlmIChlbmNvZGluZ2VuZCA9PT0gLTEpIHsKICAgICAgcmV0dXJuIGV4dHZhbHVlOwogICAgfQogICAgY29uc3QgZW5jb2RpbmcgPSBleHR2YWx1ZS5zbGljZSgwLCBlbmNvZGluZ2VuZCk7CiAgICBjb25zdCBsYW5ndmFsdWUgPSBleHR2YWx1ZS5zbGljZShlbmNvZGluZ2VuZCArIDEpOwogICAgY29uc3QgdmFsdWUgPSBsYW5ndmFsdWUucmVwbGFjZSgvXlteJ10qJy8sICIiKTsKICAgIHJldHVybiB0ZXh0ZGVjb2RlKGVuY29kaW5nLCB2YWx1ZSk7CiAgfQogIGZ1bmN0aW9uIHJmYzIwNDdkZWNvZGUodmFsdWUpIHsKICAgIGlmICghdmFsdWUuc3RhcnRzV2l0aCgiPT8iKSB8fCAvW1x4MDAtXHgxOVx4ODAtXHhmZl0vLnRlc3QodmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlQWxsKC89XD8oW1x3LV0qKVw/KFtRcUJiXSlcPygoPzpbXj9dfFw/KD8hPSkpKilcPz0vZywgZnVuY3Rpb24obWF0Y2hlcywgY2hhcnNldCwgZW5jb2RpbmcsIHRleHQpIHsKICAgICAgaWYgKGVuY29kaW5nID09PSAicSIgfHwgZW5jb2RpbmcgPT09ICJRIikgewogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2VBbGwoIl8iLCAiICIpOwogICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2VBbGwoLz0oWzAtOWEtZkEtRl17Mn0pL2csIGZ1bmN0aW9uKG1hdGNoLCBoZXgpIHsKICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGV4dGRlY29kZShjaGFyc2V0LCB0ZXh0KTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIHRleHQgPSBhdG9iKHRleHQpOwogICAgICB9IGNhdGNoIHsKICAgICAgfQogICAgICByZXR1cm4gdGV4dGRlY29kZShjaGFyc2V0LCB0ZXh0KTsKICAgIH0pOwogIH0KICByZXR1cm4gIiI7Cn0KZnVuY3Rpb24gY3JlYXRlSGVhZGVycyhpc0h0dHAsIGh0dHBIZWFkZXJzKSB7CiAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7CiAgaWYgKCFpc0h0dHAgfHwgIWh0dHBIZWFkZXJzIHx8IHR5cGVvZiBodHRwSGVhZGVycyAhPT0gIm9iamVjdCIpIHsKICAgIHJldHVybiBoZWFkZXJzOwogIH0KICBmb3IgKGNvbnN0IGtleSBpbiBodHRwSGVhZGVycykgewogICAgY29uc3QgdmFsID0gaHR0cEhlYWRlcnNba2V5XTsKICAgIGlmICh2YWwgIT09IHZvaWQgMCkgewogICAgICBoZWFkZXJzLmFwcGVuZChrZXksIHZhbCk7CiAgICB9CiAgfQogIHJldHVybiBoZWFkZXJzOwp9CmZ1bmN0aW9uIGdldFJlc3BvbnNlT3JpZ2luKHVybCkgewogIHJldHVybiBVUkwucGFyc2UodXJsKT8ub3JpZ2luID8/IG51bGw7Cn0KZnVuY3Rpb24gdmFsaWRhdGVSYW5nZVJlcXVlc3RDYXBhYmlsaXRpZXMoewogIHJlc3BvbnNlSGVhZGVycywKICBpc0h0dHAsCiAgcmFuZ2VDaHVua1NpemUsCiAgZGlzYWJsZVJhbmdlCn0pIHsKICBjb25zdCByZXR1cm5WYWx1ZXMgPSB7CiAgICBhbGxvd1JhbmdlUmVxdWVzdHM6IGZhbHNlLAogICAgc3VnZ2VzdGVkTGVuZ3RoOiB2b2lkIDAKICB9OwogIGNvbnN0IGxlbmd0aCA9IHBhcnNlSW50KHJlc3BvbnNlSGVhZGVycy5nZXQoIkNvbnRlbnQtTGVuZ3RoIiksIDEwKTsKICBpZiAoIU51bWJlci5pc0ludGVnZXIobGVuZ3RoKSkgewogICAgcmV0dXJuIHJldHVyblZhbHVlczsKICB9CiAgcmV0dXJuVmFsdWVzLnN1Z2dlc3RlZExlbmd0aCA9IGxlbmd0aDsKICBpZiAobGVuZ3RoIDw9IDIgKiByYW5nZUNodW5rU2l6ZSkgewogICAgcmV0dXJuIHJldHVyblZhbHVlczsKICB9CiAgaWYgKGRpc2FibGVSYW5nZSB8fCAhaXNIdHRwKSB7CiAgICByZXR1cm4gcmV0dXJuVmFsdWVzOwogIH0KICBpZiAocmVzcG9uc2VIZWFkZXJzLmdldCgiQWNjZXB0LVJhbmdlcyIpICE9PSAiYnl0ZXMiKSB7CiAgICByZXR1cm4gcmV0dXJuVmFsdWVzOwogIH0KICBjb25zdCBjb250ZW50RW5jb2RpbmcgPSByZXNwb25zZUhlYWRlcnMuZ2V0KCJDb250ZW50LUVuY29kaW5nIikgfHwgImlkZW50aXR5IjsKICBpZiAoY29udGVudEVuY29kaW5nICE9PSAiaWRlbnRpdHkiKSB7CiAgICByZXR1cm4gcmV0dXJuVmFsdWVzOwogIH0KICByZXR1cm5WYWx1ZXMuYWxsb3dSYW5nZVJlcXVlc3RzID0gdHJ1ZTsKICByZXR1cm4gcmV0dXJuVmFsdWVzOwp9CmZ1bmN0aW9uIGV4dHJhY3RGaWxlbmFtZUZyb21IZWFkZXIocmVzcG9uc2VIZWFkZXJzKSB7CiAgY29uc3QgY29udGVudERpc3Bvc2l0aW9uID0gcmVzcG9uc2VIZWFkZXJzLmdldCgiQ29udGVudC1EaXNwb3NpdGlvbiIpOwogIGlmIChjb250ZW50RGlzcG9zaXRpb24pIHsKICAgIGxldCBmaWxlbmFtZSA9IGdldEZpbGVuYW1lRnJvbUNvbnRlbnREaXNwb3NpdGlvbkhlYWRlcihjb250ZW50RGlzcG9zaXRpb24pOwogICAgaWYgKGZpbGVuYW1lLmluY2x1ZGVzKCIlIikpIHsKICAgICAgdHJ5IHsKICAgICAgICBmaWxlbmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChmaWxlbmFtZSk7CiAgICAgIH0gY2F0Y2ggewogICAgICB9CiAgICB9CiAgICBpZiAoaXNQZGZGaWxlKGZpbGVuYW1lKSkgewogICAgICByZXR1cm4gZmlsZW5hbWU7CiAgICB9CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIGNyZWF0ZVJlc3BvbnNlRXJyb3Ioc3RhdHVzLCB1cmwpIHsKICByZXR1cm4gbmV3IFJlc3BvbnNlRXhjZXB0aW9uKGBVbmV4cGVjdGVkIHNlcnZlciByZXNwb25zZSAoJHtzdGF0dXN9KSB3aGlsZSByZXRyaWV2aW5nIFBERiAiJHt1cmx9Ii5gLCBzdGF0dXMsIHN0YXR1cyA9PT0gNDA0IHx8IHN0YXR1cyA9PT0gMCAmJiB1cmwuc3RhcnRzV2l0aCgiZmlsZToiKSk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVSZXNwb25zZVN0YXR1cyhzdGF0dXMpIHsKICByZXR1cm4gc3RhdHVzID09PSAyMDAgfHwgc3RhdHVzID09PSAyMDY7Cn0KZnVuY3Rpb24gY3JlYXRlRmV0Y2hPcHRpb25zKGhlYWRlcnMsIHdpdGhDcmVkZW50aWFscywgYWJvcnRDb250cm9sbGVyKSB7CiAgcmV0dXJuIHsKICAgIG1ldGhvZDogIkdFVCIsCiAgICBoZWFkZXJzLAogICAgc2lnbmFsOiBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLAogICAgbW9kZTogImNvcnMiLAogICAgY3JlZGVudGlhbHM6IHdpdGhDcmVkZW50aWFscyA/ICJpbmNsdWRlIiA6ICJzYW1lLW9yaWdpbiIsCiAgICByZWRpcmVjdDogImZvbGxvdyIKICB9Owp9CmZ1bmN0aW9uIGdldEFycmF5QnVmZmVyKHZhbCkgewogIGlmICh2YWwgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICByZXR1cm4gdmFsLmJ1ZmZlcjsKICB9CiAgaWYgKHZhbCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICByZXR1cm4gdmFsOwogIH0KICB3YXJuKGBnZXRBcnJheUJ1ZmZlciAtIHVuZXhwZWN0ZWQgZGF0YSBmb3JtYXQ6ICR7dmFsfWApOwogIHJldHVybiBuZXcgVWludDhBcnJheSh2YWwpLmJ1ZmZlcjsKfQp2YXIgUERGRmV0Y2hTdHJlYW0gPSBjbGFzcyB7CiAgX3Jlc3BvbnNlT3JpZ2luID0gbnVsbDsKICBjb25zdHJ1Y3Rvcihzb3VyY2UpIHsKICAgIHRoaXMuc291cmNlID0gc291cmNlOwogICAgdGhpcy5pc0h0dHAgPSAvXmh0dHBzPzovaS50ZXN0KHNvdXJjZS51cmwpOwogICAgdGhpcy5oZWFkZXJzID0gY3JlYXRlSGVhZGVycyh0aGlzLmlzSHR0cCwgc291cmNlLmh0dHBIZWFkZXJzKTsKICAgIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyID0gbnVsbDsKICAgIHRoaXMuX3JhbmdlUmVxdWVzdFJlYWRlcnMgPSBbXTsKICB9CiAgZ2V0IF9wcm9ncmVzc2l2ZURhdGFMZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/Ll9sb2FkZWQgPz8gMDsKICB9CiAgZ2V0RnVsbFJlYWRlcigpIHsKICAgIGFzc2VydCghdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIsICJQREZGZXRjaFN0cmVhbS5nZXRGdWxsUmVhZGVyIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlLiIpOwogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIgPSBuZXcgUERGRmV0Y2hTdHJlYW1SZWFkZXIodGhpcyk7CiAgICByZXR1cm4gdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI7CiAgfQogIGdldFJhbmdlUmVhZGVyKGJlZ2luLCBlbmQpIHsKICAgIGlmIChlbmQgPD0gdGhpcy5fcHJvZ3Jlc3NpdmVEYXRhTGVuZ3RoKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3QgcmVhZGVyID0gbmV3IFBERkZldGNoU3RyZWFtUmFuZ2VSZWFkZXIodGhpcywgYmVnaW4sIGVuZCk7CiAgICB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzLnB1c2gocmVhZGVyKTsKICAgIHJldHVybiByZWFkZXI7CiAgfQogIGNhbmNlbEFsbFJlcXVlc3RzKHJlYXNvbikgewogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/LmNhbmNlbChyZWFzb24pOwogICAgZm9yIChjb25zdCByZWFkZXIgb2YgdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycy5zbGljZSgwKSkgewogICAgICByZWFkZXIuY2FuY2VsKHJlYXNvbik7CiAgICB9CiAgfQp9Owp2YXIgUERGRmV0Y2hTdHJlYW1SZWFkZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3Ioc3RyZWFtKSB7CiAgICB0aGlzLl9zdHJlYW0gPSBzdHJlYW07CiAgICB0aGlzLl9yZWFkZXIgPSBudWxsOwogICAgdGhpcy5fbG9hZGVkID0gMDsKICAgIHRoaXMuX2ZpbGVuYW1lID0gbnVsbDsKICAgIGNvbnN0IHNvdXJjZSA9IHN0cmVhbS5zb3VyY2U7CiAgICB0aGlzLl93aXRoQ3JlZGVudGlhbHMgPSBzb3VyY2Uud2l0aENyZWRlbnRpYWxzIHx8IGZhbHNlOwogICAgdGhpcy5fY29udGVudExlbmd0aCA9IHNvdXJjZS5sZW5ndGg7CiAgICB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5fZGlzYWJsZVJhbmdlID0gc291cmNlLmRpc2FibGVSYW5nZSB8fCBmYWxzZTsKICAgIHRoaXMuX3JhbmdlQ2h1bmtTaXplID0gc291cmNlLnJhbmdlQ2h1bmtTaXplOwogICAgaWYgKCF0aGlzLl9yYW5nZUNodW5rU2l6ZSAmJiAhdGhpcy5fZGlzYWJsZVJhbmdlKSB7CiAgICAgIHRoaXMuX2Rpc2FibGVSYW5nZSA9IHRydWU7CiAgICB9CiAgICB0aGlzLl9hYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZCA9ICFzb3VyY2UuZGlzYWJsZVN0cmVhbTsKICAgIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQgPSAhc291cmNlLmRpc2FibGVSYW5nZTsKICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyhzdHJlYW0uaGVhZGVycyk7CiAgICBjb25zdCB1cmwgPSBzb3VyY2UudXJsOwogICAgZmV0Y2godXJsLCBjcmVhdGVGZXRjaE9wdGlvbnMoaGVhZGVycywgdGhpcy5fd2l0aENyZWRlbnRpYWxzLCB0aGlzLl9hYm9ydENvbnRyb2xsZXIpKS50aGVuKChyZXNwb25zZSkgPT4gewogICAgICBzdHJlYW0uX3Jlc3BvbnNlT3JpZ2luID0gZ2V0UmVzcG9uc2VPcmlnaW4ocmVzcG9uc2UudXJsKTsKICAgICAgaWYgKCF2YWxpZGF0ZVJlc3BvbnNlU3RhdHVzKHJlc3BvbnNlLnN0YXR1cykpIHsKICAgICAgICB0aHJvdyBjcmVhdGVSZXNwb25zZUVycm9yKHJlc3BvbnNlLnN0YXR1cywgdXJsKTsKICAgICAgfQogICAgICB0aGlzLl9yZWFkZXIgPSByZXNwb25zZS5ib2R5LmdldFJlYWRlcigpOwogICAgICB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICAgIGNvbnN0IHJlc3BvbnNlSGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnM7CiAgICAgIGNvbnN0IHsKICAgICAgICBhbGxvd1JhbmdlUmVxdWVzdHMsCiAgICAgICAgc3VnZ2VzdGVkTGVuZ3RoCiAgICAgIH0gPSB2YWxpZGF0ZVJhbmdlUmVxdWVzdENhcGFiaWxpdGllcyh7CiAgICAgICAgcmVzcG9uc2VIZWFkZXJzLAogICAgICAgIGlzSHR0cDogc3RyZWFtLmlzSHR0cCwKICAgICAgICByYW5nZUNodW5rU2l6ZTogdGhpcy5fcmFuZ2VDaHVua1NpemUsCiAgICAgICAgZGlzYWJsZVJhbmdlOiB0aGlzLl9kaXNhYmxlUmFuZ2UKICAgICAgfSk7CiAgICAgIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQgPSBhbGxvd1JhbmdlUmVxdWVzdHM7CiAgICAgIHRoaXMuX2NvbnRlbnRMZW5ndGggPSBzdWdnZXN0ZWRMZW5ndGggfHwgdGhpcy5fY29udGVudExlbmd0aDsKICAgICAgdGhpcy5fZmlsZW5hbWUgPSBleHRyYWN0RmlsZW5hbWVGcm9tSGVhZGVyKHJlc3BvbnNlSGVhZGVycyk7CiAgICAgIGlmICghdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQgJiYgdGhpcy5faXNSYW5nZVN1cHBvcnRlZCkgewogICAgICAgIHRoaXMuY2FuY2VsKG5ldyBBYm9ydEV4Y2VwdGlvbigiU3RyZWFtaW5nIGlzIGRpc2FibGVkLiIpKTsKICAgICAgfQogICAgfSkuY2F0Y2godGhpcy5faGVhZGVyc0NhcGFiaWxpdHkucmVqZWN0KTsKICAgIHRoaXMub25Qcm9ncmVzcyA9IG51bGw7CiAgfQogIGdldCBoZWFkZXJzUmVhZHkoKSB7CiAgICByZXR1cm4gdGhpcy5faGVhZGVyc0NhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgZ2V0IGZpbGVuYW1lKCkgewogICAgcmV0dXJuIHRoaXMuX2ZpbGVuYW1lOwogIH0KICBnZXQgY29udGVudExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9jb250ZW50TGVuZ3RoOwogIH0KICBnZXQgaXNSYW5nZVN1cHBvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9pc1JhbmdlU3VwcG9ydGVkOwogIH0KICBnZXQgaXNTdHJlYW1pbmdTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQ7CiAgfQogIGFzeW5jIHJlYWQoKSB7CiAgICBhd2FpdCB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5wcm9taXNlOwogICAgY29uc3QgewogICAgICB2YWx1ZSwKICAgICAgZG9uZQogICAgfSA9IGF3YWl0IHRoaXMuX3JlYWRlci5yZWFkKCk7CiAgICBpZiAoZG9uZSkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlLAogICAgICAgIGRvbmUKICAgICAgfTsKICAgIH0KICAgIHRoaXMuX2xvYWRlZCArPSB2YWx1ZS5ieXRlTGVuZ3RoOwogICAgdGhpcy5vblByb2dyZXNzPy4oewogICAgICBsb2FkZWQ6IHRoaXMuX2xvYWRlZCwKICAgICAgdG90YWw6IHRoaXMuX2NvbnRlbnRMZW5ndGgKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgdmFsdWU6IGdldEFycmF5QnVmZmVyKHZhbHVlKSwKICAgICAgZG9uZTogZmFsc2UKICAgIH07CiAgfQogIGNhbmNlbChyZWFzb24pIHsKICAgIHRoaXMuX3JlYWRlcj8uY2FuY2VsKHJlYXNvbik7CiAgICB0aGlzLl9hYm9ydENvbnRyb2xsZXIuYWJvcnQoKTsKICB9Cn07CnZhciBQREZGZXRjaFN0cmVhbVJhbmdlUmVhZGVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHN0cmVhbSwgYmVnaW4sIGVuZCkgewogICAgdGhpcy5fc3RyZWFtID0gc3RyZWFtOwogICAgdGhpcy5fcmVhZGVyID0gbnVsbDsKICAgIHRoaXMuX2xvYWRlZCA9IDA7CiAgICBjb25zdCBzb3VyY2UgPSBzdHJlYW0uc291cmNlOwogICAgdGhpcy5fd2l0aENyZWRlbnRpYWxzID0gc291cmNlLndpdGhDcmVkZW50aWFscyB8fCBmYWxzZTsKICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZCA9ICFzb3VyY2UuZGlzYWJsZVN0cmVhbTsKICAgIHRoaXMuX2Fib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyhzdHJlYW0uaGVhZGVycyk7CiAgICBoZWFkZXJzLmFwcGVuZCgiUmFuZ2UiLCBgYnl0ZXM9JHtiZWdpbn0tJHtlbmQgLSAxfWApOwogICAgY29uc3QgdXJsID0gc291cmNlLnVybDsKICAgIGZldGNoKHVybCwgY3JlYXRlRmV0Y2hPcHRpb25zKGhlYWRlcnMsIHRoaXMuX3dpdGhDcmVkZW50aWFscywgdGhpcy5fYWJvcnRDb250cm9sbGVyKSkudGhlbigocmVzcG9uc2UpID0+IHsKICAgICAgY29uc3QgcmVzcG9uc2VPcmlnaW4gPSBnZXRSZXNwb25zZU9yaWdpbihyZXNwb25zZS51cmwpOwogICAgICBpZiAocmVzcG9uc2VPcmlnaW4gIT09IHN0cmVhbS5fcmVzcG9uc2VPcmlnaW4pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHJhbmdlIHJlc3BvbnNlLW9yaWdpbiAiJHtyZXNwb25zZU9yaWdpbn0iIHRvIG1hdGNoICIke3N0cmVhbS5fcmVzcG9uc2VPcmlnaW59Ii5gKTsKICAgICAgfQogICAgICBpZiAoIXZhbGlkYXRlUmVzcG9uc2VTdGF0dXMocmVzcG9uc2Uuc3RhdHVzKSkgewogICAgICAgIHRocm93IGNyZWF0ZVJlc3BvbnNlRXJyb3IocmVzcG9uc2Uuc3RhdHVzLCB1cmwpOwogICAgICB9CiAgICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgICAgdGhpcy5fcmVhZGVyID0gcmVzcG9uc2UuYm9keS5nZXRSZWFkZXIoKTsKICAgIH0pLmNhdGNoKHRoaXMuX3JlYWRDYXBhYmlsaXR5LnJlamVjdCk7CiAgICB0aGlzLm9uUHJvZ3Jlc3MgPSBudWxsOwogIH0KICBnZXQgaXNTdHJlYW1pbmdTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQ7CiAgfQogIGFzeW5jIHJlYWQoKSB7CiAgICBhd2FpdCB0aGlzLl9yZWFkQ2FwYWJpbGl0eS5wcm9taXNlOwogICAgY29uc3QgewogICAgICB2YWx1ZSwKICAgICAgZG9uZQogICAgfSA9IGF3YWl0IHRoaXMuX3JlYWRlci5yZWFkKCk7CiAgICBpZiAoZG9uZSkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlLAogICAgICAgIGRvbmUKICAgICAgfTsKICAgIH0KICAgIHRoaXMuX2xvYWRlZCArPSB2YWx1ZS5ieXRlTGVuZ3RoOwogICAgdGhpcy5vblByb2dyZXNzPy4oewogICAgICBsb2FkZWQ6IHRoaXMuX2xvYWRlZAogICAgfSk7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogZ2V0QXJyYXlCdWZmZXIodmFsdWUpLAogICAgICBkb25lOiBmYWxzZQogICAgfTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgdGhpcy5fcmVhZGVyPy5jYW5jZWwocmVhc29uKTsKICAgIHRoaXMuX2Fib3J0Q29udHJvbGxlci5hYm9ydCgpOwogIH0KfTsKdmFyIE9LX1JFU1BPTlNFID0gMjAwOwp2YXIgUEFSVElBTF9DT05URU5UX1JFU1BPTlNFID0gMjA2OwpmdW5jdGlvbiBuZXR3b3JrX2dldEFycmF5QnVmZmVyKHhocikgewogIGNvbnN0IGRhdGEgPSB4aHIucmVzcG9uc2U7CiAgaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRhdGE7CiAgfQogIHJldHVybiBzdHJpbmdUb0J5dGVzKGRhdGEpLmJ1ZmZlcjsKfQp2YXIgTmV0d29ya01hbmFnZXIgPSBjbGFzcyB7CiAgX3Jlc3BvbnNlT3JpZ2luID0gbnVsbDsKICBjb25zdHJ1Y3Rvcih7CiAgICB1cmwsCiAgICBodHRwSGVhZGVycywKICAgIHdpdGhDcmVkZW50aWFscwogIH0pIHsKICAgIHRoaXMudXJsID0gdXJsOwogICAgdGhpcy5pc0h0dHAgPSAvXmh0dHBzPzovaS50ZXN0KHVybCk7CiAgICB0aGlzLmhlYWRlcnMgPSBjcmVhdGVIZWFkZXJzKHRoaXMuaXNIdHRwLCBodHRwSGVhZGVycyk7CiAgICB0aGlzLndpdGhDcmVkZW50aWFscyA9IHdpdGhDcmVkZW50aWFscyB8fCBmYWxzZTsKICAgIHRoaXMuY3VyclhocklkID0gMDsKICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfQogIHJlcXVlc3QoYXJncykgewogICAgY29uc3QgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICBjb25zdCB4aHJJZCA9IHRoaXMuY3VyclhocklkKys7CiAgICBjb25zdCBwZW5kaW5nUmVxdWVzdCA9IHRoaXMucGVuZGluZ1JlcXVlc3RzW3hocklkXSA9IHsKICAgICAgeGhyCiAgICB9OwogICAgeGhyLm9wZW4oIkdFVCIsIHRoaXMudXJsKTsKICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0aGlzLndpdGhDcmVkZW50aWFsczsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsXSBvZiB0aGlzLmhlYWRlcnMpIHsKICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWwpOwogICAgfQogICAgaWYgKHRoaXMuaXNIdHRwICYmICJiZWdpbiIgaW4gYXJncyAmJiAiZW5kIiBpbiBhcmdzKSB7CiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCJSYW5nZSIsIGBieXRlcz0ke2FyZ3MuYmVnaW59LSR7YXJncy5lbmQgLSAxfWApOwogICAgICBwZW5kaW5nUmVxdWVzdC5leHBlY3RlZFN0YXR1cyA9IFBBUlRJQUxfQ09OVEVOVF9SRVNQT05TRTsKICAgIH0gZWxzZSB7CiAgICAgIHBlbmRpbmdSZXF1ZXN0LmV4cGVjdGVkU3RhdHVzID0gT0tfUkVTUE9OU0U7CiAgICB9CiAgICB4aHIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKICAgIGFzc2VydChhcmdzLm9uRXJyb3IsICJFeHBlY3RlZCBgb25FcnJvcmAgY2FsbGJhY2sgdG8gYmUgcHJvdmlkZWQuIik7CiAgICB4aHIub25lcnJvciA9ICgpID0+IHsKICAgICAgYXJncy5vbkVycm9yKHhoci5zdGF0dXMpOwogICAgfTsKICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLm9uU3RhdGVDaGFuZ2UuYmluZCh0aGlzLCB4aHJJZCk7CiAgICB4aHIub25wcm9ncmVzcyA9IHRoaXMub25Qcm9ncmVzcy5iaW5kKHRoaXMsIHhocklkKTsKICAgIHBlbmRpbmdSZXF1ZXN0Lm9uSGVhZGVyc1JlY2VpdmVkID0gYXJncy5vbkhlYWRlcnNSZWNlaXZlZDsKICAgIHBlbmRpbmdSZXF1ZXN0Lm9uRG9uZSA9IGFyZ3Mub25Eb25lOwogICAgcGVuZGluZ1JlcXVlc3Qub25FcnJvciA9IGFyZ3Mub25FcnJvcjsKICAgIHBlbmRpbmdSZXF1ZXN0Lm9uUHJvZ3Jlc3MgPSBhcmdzLm9uUHJvZ3Jlc3M7CiAgICB4aHIuc2VuZChudWxsKTsKICAgIHJldHVybiB4aHJJZDsKICB9CiAgb25Qcm9ncmVzcyh4aHJJZCwgZXZ0KSB7CiAgICBjb25zdCBwZW5kaW5nUmVxdWVzdCA9IHRoaXMucGVuZGluZ1JlcXVlc3RzW3hocklkXTsKICAgIGlmICghcGVuZGluZ1JlcXVlc3QpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcGVuZGluZ1JlcXVlc3Qub25Qcm9ncmVzcz8uKGV2dCk7CiAgfQogIG9uU3RhdGVDaGFuZ2UoeGhySWQsIGV2dCkgewogICAgY29uc3QgcGVuZGluZ1JlcXVlc3QgPSB0aGlzLnBlbmRpbmdSZXF1ZXN0c1t4aHJJZF07CiAgICBpZiAoIXBlbmRpbmdSZXF1ZXN0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHhociA9IHBlbmRpbmdSZXF1ZXN0LnhocjsKICAgIGlmICh4aHIucmVhZHlTdGF0ZSA+PSAyICYmIHBlbmRpbmdSZXF1ZXN0Lm9uSGVhZGVyc1JlY2VpdmVkKSB7CiAgICAgIHBlbmRpbmdSZXF1ZXN0Lm9uSGVhZGVyc1JlY2VpdmVkKCk7CiAgICAgIGRlbGV0ZSBwZW5kaW5nUmVxdWVzdC5vbkhlYWRlcnNSZWNlaXZlZDsKICAgIH0KICAgIGlmICh4aHIucmVhZHlTdGF0ZSAhPT0gNCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoISh4aHJJZCBpbiB0aGlzLnBlbmRpbmdSZXF1ZXN0cykpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgZGVsZXRlIHRoaXMucGVuZGluZ1JlcXVlc3RzW3hocklkXTsKICAgIGlmICh4aHIuc3RhdHVzID09PSAwICYmIHRoaXMuaXNIdHRwKSB7CiAgICAgIHBlbmRpbmdSZXF1ZXN0Lm9uRXJyb3IoeGhyLnN0YXR1cyk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHhoclN0YXR1cyA9IHhoci5zdGF0dXMgfHwgT0tfUkVTUE9OU0U7CiAgICBjb25zdCBva19yZXNwb25zZV9vbl9yYW5nZV9yZXF1ZXN0ID0geGhyU3RhdHVzID09PSBPS19SRVNQT05TRSAmJiBwZW5kaW5nUmVxdWVzdC5leHBlY3RlZFN0YXR1cyA9PT0gUEFSVElBTF9DT05URU5UX1JFU1BPTlNFOwogICAgaWYgKCFva19yZXNwb25zZV9vbl9yYW5nZV9yZXF1ZXN0ICYmIHhoclN0YXR1cyAhPT0gcGVuZGluZ1JlcXVlc3QuZXhwZWN0ZWRTdGF0dXMpIHsKICAgICAgcGVuZGluZ1JlcXVlc3Qub25FcnJvcih4aHIuc3RhdHVzKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY2h1bmsgPSBuZXR3b3JrX2dldEFycmF5QnVmZmVyKHhocik7CiAgICBpZiAoeGhyU3RhdHVzID09PSBQQVJUSUFMX0NPTlRFTlRfUkVTUE9OU0UpIHsKICAgICAgY29uc3QgcmFuZ2VIZWFkZXIgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtUmFuZ2UiKTsKICAgICAgY29uc3QgbWF0Y2hlcyA9IC9ieXRlcyAoXGQrKS0oXGQrKVwvKFxkKykvLmV4ZWMocmFuZ2VIZWFkZXIpOwogICAgICBpZiAobWF0Y2hlcykgewogICAgICAgIHBlbmRpbmdSZXF1ZXN0Lm9uRG9uZSh7CiAgICAgICAgICBiZWdpbjogcGFyc2VJbnQobWF0Y2hlc1sxXSwgMTApLAogICAgICAgICAgY2h1bmsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuKGBNaXNzaW5nIG9yIGludmFsaWQgIkNvbnRlbnQtUmFuZ2UiIGhlYWRlci5gKTsKICAgICAgICBwZW5kaW5nUmVxdWVzdC5vbkVycm9yKDApOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGNodW5rKSB7CiAgICAgIHBlbmRpbmdSZXF1ZXN0Lm9uRG9uZSh7CiAgICAgICAgYmVnaW46IDAsCiAgICAgICAgY2h1bmsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBwZW5kaW5nUmVxdWVzdC5vbkVycm9yKHhoci5zdGF0dXMpOwogICAgfQogIH0KICBnZXRSZXF1ZXN0WGhyKHhocklkKSB7CiAgICByZXR1cm4gdGhpcy5wZW5kaW5nUmVxdWVzdHNbeGhySWRdLnhocjsKICB9CiAgaXNQZW5kaW5nUmVxdWVzdCh4aHJJZCkgewogICAgcmV0dXJuIHhocklkIGluIHRoaXMucGVuZGluZ1JlcXVlc3RzOwogIH0KICBhYm9ydFJlcXVlc3QoeGhySWQpIHsKICAgIGNvbnN0IHhociA9IHRoaXMucGVuZGluZ1JlcXVlc3RzW3hocklkXS54aHI7CiAgICBkZWxldGUgdGhpcy5wZW5kaW5nUmVxdWVzdHNbeGhySWRdOwogICAgeGhyLmFib3J0KCk7CiAgfQp9Owp2YXIgUERGTmV0d29ya1N0cmVhbSA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihzb3VyY2UpIHsKICAgIHRoaXMuX3NvdXJjZSA9IHNvdXJjZTsKICAgIHRoaXMuX21hbmFnZXIgPSBuZXcgTmV0d29ya01hbmFnZXIoc291cmNlKTsKICAgIHRoaXMuX3JhbmdlQ2h1bmtTaXplID0gc291cmNlLnJhbmdlQ2h1bmtTaXplOwogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIgPSBudWxsOwogICAgdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycyA9IFtdOwogIH0KICBfb25SYW5nZVJlcXVlc3RSZWFkZXJDbG9zZWQocmVhZGVyKSB7CiAgICBjb25zdCBpID0gdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycy5pbmRleE9mKHJlYWRlcik7CiAgICBpZiAoaSA+PSAwKSB7CiAgICAgIHRoaXMuX3JhbmdlUmVxdWVzdFJlYWRlcnMuc3BsaWNlKGksIDEpOwogICAgfQogIH0KICBnZXRGdWxsUmVhZGVyKCkgewogICAgYXNzZXJ0KCF0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciwgIlBERk5ldHdvcmtTdHJlYW0uZ2V0RnVsbFJlYWRlciBjYW4gb25seSBiZSBjYWxsZWQgb25jZS4iKTsKICAgIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyID0gbmV3IFBERk5ldHdvcmtTdHJlYW1GdWxsUmVxdWVzdFJlYWRlcih0aGlzLl9tYW5hZ2VyLCB0aGlzLl9zb3VyY2UpOwogICAgcmV0dXJuIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyOwogIH0KICBnZXRSYW5nZVJlYWRlcihiZWdpbiwgZW5kKSB7CiAgICBjb25zdCByZWFkZXIgPSBuZXcgUERGTmV0d29ya1N0cmVhbVJhbmdlUmVxdWVzdFJlYWRlcih0aGlzLl9tYW5hZ2VyLCBiZWdpbiwgZW5kKTsKICAgIHJlYWRlci5vbkNsb3NlZCA9IHRoaXMuX29uUmFuZ2VSZXF1ZXN0UmVhZGVyQ2xvc2VkLmJpbmQodGhpcyk7CiAgICB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzLnB1c2gocmVhZGVyKTsKICAgIHJldHVybiByZWFkZXI7CiAgfQogIGNhbmNlbEFsbFJlcXVlc3RzKHJlYXNvbikgewogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/LmNhbmNlbChyZWFzb24pOwogICAgZm9yIChjb25zdCByZWFkZXIgb2YgdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycy5zbGljZSgwKSkgewogICAgICByZWFkZXIuY2FuY2VsKHJlYXNvbik7CiAgICB9CiAgfQp9Owp2YXIgUERGTmV0d29ya1N0cmVhbUZ1bGxSZXF1ZXN0UmVhZGVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKG1hbmFnZXIsIHNvdXJjZSkgewogICAgdGhpcy5fbWFuYWdlciA9IG1hbmFnZXI7CiAgICB0aGlzLl91cmwgPSBzb3VyY2UudXJsOwogICAgdGhpcy5fZnVsbFJlcXVlc3RJZCA9IG1hbmFnZXIucmVxdWVzdCh7CiAgICAgIG9uSGVhZGVyc1JlY2VpdmVkOiB0aGlzLl9vbkhlYWRlcnNSZWNlaXZlZC5iaW5kKHRoaXMpLAogICAgICBvbkRvbmU6IHRoaXMuX29uRG9uZS5iaW5kKHRoaXMpLAogICAgICBvbkVycm9yOiB0aGlzLl9vbkVycm9yLmJpbmQodGhpcyksCiAgICAgIG9uUHJvZ3Jlc3M6IHRoaXMuX29uUHJvZ3Jlc3MuYmluZCh0aGlzKQogICAgfSk7CiAgICB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5fZGlzYWJsZVJhbmdlID0gc291cmNlLmRpc2FibGVSYW5nZSB8fCBmYWxzZTsKICAgIHRoaXMuX2NvbnRlbnRMZW5ndGggPSBzb3VyY2UubGVuZ3RoOwogICAgdGhpcy5fcmFuZ2VDaHVua1NpemUgPSBzb3VyY2UucmFuZ2VDaHVua1NpemU7CiAgICBpZiAoIXRoaXMuX3JhbmdlQ2h1bmtTaXplICYmICF0aGlzLl9kaXNhYmxlUmFuZ2UpIHsKICAgICAgdGhpcy5fZGlzYWJsZVJhbmdlID0gdHJ1ZTsKICAgIH0KICAgIHRoaXMuX2lzU3RyZWFtaW5nU3VwcG9ydGVkID0gZmFsc2U7CiAgICB0aGlzLl9pc1JhbmdlU3VwcG9ydGVkID0gZmFsc2U7CiAgICB0aGlzLl9jYWNoZWRDaHVua3MgPSBbXTsKICAgIHRoaXMuX3JlcXVlc3RzID0gW107CiAgICB0aGlzLl9kb25lID0gZmFsc2U7CiAgICB0aGlzLl9zdG9yZWRFcnJvciA9IHZvaWQgMDsKICAgIHRoaXMuX2ZpbGVuYW1lID0gbnVsbDsKICAgIHRoaXMub25Qcm9ncmVzcyA9IG51bGw7CiAgfQogIF9vbkhlYWRlcnNSZWNlaXZlZCgpIHsKICAgIGNvbnN0IGZ1bGxSZXF1ZXN0WGhySWQgPSB0aGlzLl9mdWxsUmVxdWVzdElkOwogICAgY29uc3QgZnVsbFJlcXVlc3RYaHIgPSB0aGlzLl9tYW5hZ2VyLmdldFJlcXVlc3RYaHIoZnVsbFJlcXVlc3RYaHJJZCk7CiAgICB0aGlzLl9tYW5hZ2VyLl9yZXNwb25zZU9yaWdpbiA9IGdldFJlc3BvbnNlT3JpZ2luKGZ1bGxSZXF1ZXN0WGhyLnJlc3BvbnNlVVJMKTsKICAgIGNvbnN0IHJhd1Jlc3BvbnNlSGVhZGVycyA9IGZ1bGxSZXF1ZXN0WGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwogICAgY29uc3QgcmVzcG9uc2VIZWFkZXJzID0gbmV3IEhlYWRlcnMocmF3UmVzcG9uc2VIZWFkZXJzID8gcmF3UmVzcG9uc2VIZWFkZXJzLnRyaW1TdGFydCgpLnJlcGxhY2UoL1teXFMgXSskLywgIiIpLnNwbGl0KC9bXHJcbl0rLykubWFwKCh4KSA9PiB7CiAgICAgIGNvbnN0IFtrZXksIC4uLnZhbF0gPSB4LnNwbGl0KCI6ICIpOwogICAgICByZXR1cm4gW2tleSwgdmFsLmpvaW4oIjogIildOwogICAgfSkgOiBbXSk7CiAgICBjb25zdCB7CiAgICAgIGFsbG93UmFuZ2VSZXF1ZXN0cywKICAgICAgc3VnZ2VzdGVkTGVuZ3RoCiAgICB9ID0gdmFsaWRhdGVSYW5nZVJlcXVlc3RDYXBhYmlsaXRpZXMoewogICAgICByZXNwb25zZUhlYWRlcnMsCiAgICAgIGlzSHR0cDogdGhpcy5fbWFuYWdlci5pc0h0dHAsCiAgICAgIHJhbmdlQ2h1bmtTaXplOiB0aGlzLl9yYW5nZUNodW5rU2l6ZSwKICAgICAgZGlzYWJsZVJhbmdlOiB0aGlzLl9kaXNhYmxlUmFuZ2UKICAgIH0pOwogICAgaWYgKGFsbG93UmFuZ2VSZXF1ZXN0cykgewogICAgICB0aGlzLl9pc1JhbmdlU3VwcG9ydGVkID0gdHJ1ZTsKICAgIH0KICAgIHRoaXMuX2NvbnRlbnRMZW5ndGggPSBzdWdnZXN0ZWRMZW5ndGggfHwgdGhpcy5fY29udGVudExlbmd0aDsKICAgIHRoaXMuX2ZpbGVuYW1lID0gZXh0cmFjdEZpbGVuYW1lRnJvbUhlYWRlcihyZXNwb25zZUhlYWRlcnMpOwogICAgaWYgKHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQpIHsKICAgICAgdGhpcy5fbWFuYWdlci5hYm9ydFJlcXVlc3QoZnVsbFJlcXVlc3RYaHJJZCk7CiAgICB9CiAgICB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgfQogIF9vbkRvbmUoZGF0YSkgewogICAgaWYgKGRhdGEpIHsKICAgICAgaWYgKHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSA9IHRoaXMuX3JlcXVlc3RzLnNoaWZ0KCk7CiAgICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgICB2YWx1ZTogZGF0YS5jaHVuaywKICAgICAgICAgIGRvbmU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fY2FjaGVkQ2h1bmtzLnB1c2goZGF0YS5jaHVuayk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX2RvbmUgPSB0cnVlOwogICAgaWYgKHRoaXMuX2NhY2hlZENodW5rcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICB9CiAgX29uRXJyb3Ioc3RhdHVzKSB7CiAgICB0aGlzLl9zdG9yZWRFcnJvciA9IGNyZWF0ZVJlc3BvbnNlRXJyb3Ioc3RhdHVzLCB0aGlzLl91cmwpOwogICAgdGhpcy5faGVhZGVyc0NhcGFiaWxpdHkucmVqZWN0KHRoaXMuX3N0b3JlZEVycm9yKTsKICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVqZWN0KHRoaXMuX3N0b3JlZEVycm9yKTsKICAgIH0KICAgIHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA9IDA7CiAgICB0aGlzLl9jYWNoZWRDaHVua3MubGVuZ3RoID0gMDsKICB9CiAgX29uUHJvZ3Jlc3MoZXZ0KSB7CiAgICB0aGlzLm9uUHJvZ3Jlc3M/Lih7CiAgICAgIGxvYWRlZDogZXZ0LmxvYWRlZCwKICAgICAgdG90YWw6IGV2dC5sZW5ndGhDb21wdXRhYmxlID8gZXZ0LnRvdGFsIDogdGhpcy5fY29udGVudExlbmd0aAogICAgfSk7CiAgfQogIGdldCBmaWxlbmFtZSgpIHsKICAgIHJldHVybiB0aGlzLl9maWxlbmFtZTsKICB9CiAgZ2V0IGlzUmFuZ2VTdXBwb3J0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5faXNSYW5nZVN1cHBvcnRlZDsKICB9CiAgZ2V0IGlzU3RyZWFtaW5nU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHRoaXMuX2lzU3RyZWFtaW5nU3VwcG9ydGVkOwogIH0KICBnZXQgY29udGVudExlbmd0aCgpIHsKICAgIHJldHVybiB0aGlzLl9jb250ZW50TGVuZ3RoOwogIH0KICBnZXQgaGVhZGVyc1JlYWR5KCkgewogICAgcmV0dXJuIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIGFzeW5jIHJlYWQoKSB7CiAgICBhd2FpdCB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5wcm9taXNlOwogICAgaWYgKHRoaXMuX3N0b3JlZEVycm9yKSB7CiAgICAgIHRocm93IHRoaXMuX3N0b3JlZEVycm9yOwogICAgfQogICAgaWYgKHRoaXMuX2NhY2hlZENodW5rcy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5fY2FjaGVkQ2h1bmtzLnNoaWZ0KCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IGNodW5rLAogICAgICAgIGRvbmU6IGZhbHNlCiAgICAgIH07CiAgICB9CiAgICBpZiAodGhpcy5fZG9uZSkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgZG9uZTogdHJ1ZQogICAgICB9OwogICAgfQogICAgY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIHRoaXMuX3JlcXVlc3RzLnB1c2gocmVxdWVzdENhcGFiaWxpdHkpOwogICAgcmV0dXJuIHJlcXVlc3RDYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIGNhbmNlbChyZWFzb24pIHsKICAgIHRoaXMuX2RvbmUgPSB0cnVlOwogICAgdGhpcy5faGVhZGVyc0NhcGFiaWxpdHkucmVqZWN0KHJlYXNvbik7CiAgICBmb3IgKGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5IG9mIHRoaXMuX3JlcXVlc3RzKSB7CiAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgZG9uZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICAgIHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA9IDA7CiAgICBpZiAodGhpcy5fbWFuYWdlci5pc1BlbmRpbmdSZXF1ZXN0KHRoaXMuX2Z1bGxSZXF1ZXN0SWQpKSB7CiAgICAgIHRoaXMuX21hbmFnZXIuYWJvcnRSZXF1ZXN0KHRoaXMuX2Z1bGxSZXF1ZXN0SWQpOwogICAgfQogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIgPSBudWxsOwogIH0KfTsKdmFyIFBERk5ldHdvcmtTdHJlYW1SYW5nZVJlcXVlc3RSZWFkZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IobWFuYWdlciwgYmVnaW4sIGVuZCkgewogICAgdGhpcy5fbWFuYWdlciA9IG1hbmFnZXI7CiAgICB0aGlzLl91cmwgPSBtYW5hZ2VyLnVybDsKICAgIHRoaXMuX3JlcXVlc3RJZCA9IG1hbmFnZXIucmVxdWVzdCh7CiAgICAgIGJlZ2luLAogICAgICBlbmQsCiAgICAgIG9uSGVhZGVyc1JlY2VpdmVkOiB0aGlzLl9vbkhlYWRlcnNSZWNlaXZlZC5iaW5kKHRoaXMpLAogICAgICBvbkRvbmU6IHRoaXMuX29uRG9uZS5iaW5kKHRoaXMpLAogICAgICBvbkVycm9yOiB0aGlzLl9vbkVycm9yLmJpbmQodGhpcyksCiAgICAgIG9uUHJvZ3Jlc3M6IHRoaXMuX29uUHJvZ3Jlc3MuYmluZCh0aGlzKQogICAgfSk7CiAgICB0aGlzLl9yZXF1ZXN0cyA9IFtdOwogICAgdGhpcy5fcXVldWVkQ2h1bmsgPSBudWxsOwogICAgdGhpcy5fZG9uZSA9IGZhbHNlOwogICAgdGhpcy5fc3RvcmVkRXJyb3IgPSB2b2lkIDA7CiAgICB0aGlzLm9uUHJvZ3Jlc3MgPSBudWxsOwogICAgdGhpcy5vbkNsb3NlZCA9IG51bGw7CiAgfQogIF9vbkhlYWRlcnNSZWNlaXZlZCgpIHsKICAgIGNvbnN0IHJlc3BvbnNlT3JpZ2luID0gZ2V0UmVzcG9uc2VPcmlnaW4odGhpcy5fbWFuYWdlci5nZXRSZXF1ZXN0WGhyKHRoaXMuX3JlcXVlc3RJZCk/LnJlc3BvbnNlVVJMKTsKICAgIGlmIChyZXNwb25zZU9yaWdpbiAhPT0gdGhpcy5fbWFuYWdlci5fcmVzcG9uc2VPcmlnaW4pIHsKICAgICAgdGhpcy5fc3RvcmVkRXJyb3IgPSBuZXcgRXJyb3IoYEV4cGVjdGVkIHJhbmdlIHJlc3BvbnNlLW9yaWdpbiAiJHtyZXNwb25zZU9yaWdpbn0iIHRvIG1hdGNoICIke3RoaXMuX21hbmFnZXIuX3Jlc3BvbnNlT3JpZ2lufSIuYCk7CiAgICAgIHRoaXMuX29uRXJyb3IoMCk7CiAgICB9CiAgfQogIF9jbG9zZSgpIHsKICAgIHRoaXMub25DbG9zZWQ/Lih0aGlzKTsKICB9CiAgX29uRG9uZShkYXRhKSB7CiAgICBjb25zdCBjaHVuayA9IGRhdGEuY2h1bms7CiAgICBpZiAodGhpcy5fcmVxdWVzdHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSA9IHRoaXMuX3JlcXVlc3RzLnNoaWZ0KCk7CiAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgIHZhbHVlOiBjaHVuaywKICAgICAgICBkb25lOiBmYWxzZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3F1ZXVlZENodW5rID0gY2h1bms7CiAgICB9CiAgICB0aGlzLl9kb25lID0gdHJ1ZTsKICAgIGZvciAoY29uc3QgcmVxdWVzdENhcGFiaWxpdHkgb2YgdGhpcy5fcmVxdWVzdHMpIHsKICAgICAgcmVxdWVzdENhcGFiaWxpdHkucmVzb2x2ZSh7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICAgIHRoaXMuX2Nsb3NlKCk7CiAgfQogIF9vbkVycm9yKHN0YXR1cykgewogICAgdGhpcy5fc3RvcmVkRXJyb3IgPz89IGNyZWF0ZVJlc3BvbnNlRXJyb3Ioc3RhdHVzLCB0aGlzLl91cmwpOwogICAgZm9yIChjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSBvZiB0aGlzLl9yZXF1ZXN0cykgewogICAgICByZXF1ZXN0Q2FwYWJpbGl0eS5yZWplY3QodGhpcy5fc3RvcmVkRXJyb3IpOwogICAgfQogICAgdGhpcy5fcmVxdWVzdHMubGVuZ3RoID0gMDsKICAgIHRoaXMuX3F1ZXVlZENodW5rID0gbnVsbDsKICB9CiAgX29uUHJvZ3Jlc3MoZXZ0KSB7CiAgICBpZiAoIXRoaXMuaXNTdHJlYW1pbmdTdXBwb3J0ZWQpIHsKICAgICAgdGhpcy5vblByb2dyZXNzPy4oewogICAgICAgIGxvYWRlZDogZXZ0LmxvYWRlZAogICAgICB9KTsKICAgIH0KICB9CiAgZ2V0IGlzU3RyZWFtaW5nU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBhc3luYyByZWFkKCkgewogICAgaWYgKHRoaXMuX3N0b3JlZEVycm9yKSB7CiAgICAgIHRocm93IHRoaXMuX3N0b3JlZEVycm9yOwogICAgfQogICAgaWYgKHRoaXMuX3F1ZXVlZENodW5rICE9PSBudWxsKSB7CiAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5fcXVldWVkQ2h1bms7CiAgICAgIHRoaXMuX3F1ZXVlZENodW5rID0gbnVsbDsKICAgICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogY2h1bmssCiAgICAgICAgZG9uZTogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCByZXF1ZXN0Q2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5fcmVxdWVzdHMucHVzaChyZXF1ZXN0Q2FwYWJpbGl0eSk7CiAgICByZXR1cm4gcmVxdWVzdENhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgICBmb3IgKGNvbnN0IHJlcXVlc3RDYXBhYmlsaXR5IG9mIHRoaXMuX3JlcXVlc3RzKSB7CiAgICAgIHJlcXVlc3RDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgZG9uZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICAgIHRoaXMuX3JlcXVlc3RzLmxlbmd0aCA9IDA7CiAgICBpZiAodGhpcy5fbWFuYWdlci5pc1BlbmRpbmdSZXF1ZXN0KHRoaXMuX3JlcXVlc3RJZCkpIHsKICAgICAgdGhpcy5fbWFuYWdlci5hYm9ydFJlcXVlc3QodGhpcy5fcmVxdWVzdElkKTsKICAgIH0KICAgIHRoaXMuX2Nsb3NlKCk7CiAgfQp9Owp2YXIgdXJsUmVnZXggPSAvXlthLXpdW2EtejAtOVwtKy5dKzovaTsKZnVuY3Rpb24gcGFyc2VVcmxPclBhdGgoc291cmNlVXJsKSB7CiAgaWYgKHVybFJlZ2V4LnRlc3Qoc291cmNlVXJsKSkgewogICAgcmV0dXJuIG5ldyBVUkwoc291cmNlVXJsKTsKICB9CiAgY29uc3QgdXJsID0gcHJvY2Vzcy5nZXRCdWlsdGluTW9kdWxlKCJ1cmwiKTsKICByZXR1cm4gbmV3IFVSTCh1cmwucGF0aFRvRmlsZVVSTChzb3VyY2VVcmwpKTsKfQp2YXIgUERGTm9kZVN0cmVhbSA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihzb3VyY2UpIHsKICAgIHRoaXMuc291cmNlID0gc291cmNlOwogICAgdGhpcy51cmwgPSBwYXJzZVVybE9yUGF0aChzb3VyY2UudXJsKTsKICAgIGFzc2VydCh0aGlzLnVybC5wcm90b2NvbCA9PT0gImZpbGU6IiwgIlBERk5vZGVTdHJlYW0gb25seSBzdXBwb3J0cyBmaWxlOi8vIFVSTHMuIik7CiAgICB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlciA9IG51bGw7CiAgICB0aGlzLl9yYW5nZVJlcXVlc3RSZWFkZXJzID0gW107CiAgfQogIGdldCBfcHJvZ3Jlc3NpdmVEYXRhTGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyPy5fbG9hZGVkID8/IDA7CiAgfQogIGdldEZ1bGxSZWFkZXIoKSB7CiAgICBhc3NlcnQoIXRoaXMuX2Z1bGxSZXF1ZXN0UmVhZGVyLCAiUERGTm9kZVN0cmVhbS5nZXRGdWxsUmVhZGVyIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlLiIpOwogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXIgPSBuZXcgUERGTm9kZVN0cmVhbUZzRnVsbFJlYWRlcih0aGlzKTsKICAgIHJldHVybiB0aGlzLl9mdWxsUmVxdWVzdFJlYWRlcjsKICB9CiAgZ2V0UmFuZ2VSZWFkZXIoc3RhcnQsIGVuZCkgewogICAgaWYgKGVuZCA8PSB0aGlzLl9wcm9ncmVzc2l2ZURhdGFMZW5ndGgpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCByYW5nZVJlYWRlciA9IG5ldyBQREZOb2RlU3RyZWFtRnNSYW5nZVJlYWRlcih0aGlzLCBzdGFydCwgZW5kKTsKICAgIHRoaXMuX3JhbmdlUmVxdWVzdFJlYWRlcnMucHVzaChyYW5nZVJlYWRlcik7CiAgICByZXR1cm4gcmFuZ2VSZWFkZXI7CiAgfQogIGNhbmNlbEFsbFJlcXVlc3RzKHJlYXNvbikgewogICAgdGhpcy5fZnVsbFJlcXVlc3RSZWFkZXI/LmNhbmNlbChyZWFzb24pOwogICAgZm9yIChjb25zdCByZWFkZXIgb2YgdGhpcy5fcmFuZ2VSZXF1ZXN0UmVhZGVycy5zbGljZSgwKSkgewogICAgICByZWFkZXIuY2FuY2VsKHJlYXNvbik7CiAgICB9CiAgfQp9Owp2YXIgUERGTm9kZVN0cmVhbUZzRnVsbFJlYWRlciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihzdHJlYW0pIHsKICAgIHRoaXMuX3VybCA9IHN0cmVhbS51cmw7CiAgICB0aGlzLl9kb25lID0gZmFsc2U7CiAgICB0aGlzLl9zdG9yZWRFcnJvciA9IG51bGw7CiAgICB0aGlzLm9uUHJvZ3Jlc3MgPSBudWxsOwogICAgY29uc3Qgc291cmNlID0gc3RyZWFtLnNvdXJjZTsKICAgIHRoaXMuX2NvbnRlbnRMZW5ndGggPSBzb3VyY2UubGVuZ3RoOwogICAgdGhpcy5fbG9hZGVkID0gMDsKICAgIHRoaXMuX2ZpbGVuYW1lID0gbnVsbDsKICAgIHRoaXMuX2Rpc2FibGVSYW5nZSA9IHNvdXJjZS5kaXNhYmxlUmFuZ2UgfHwgZmFsc2U7CiAgICB0aGlzLl9yYW5nZUNodW5rU2l6ZSA9IHNvdXJjZS5yYW5nZUNodW5rU2l6ZTsKICAgIGlmICghdGhpcy5fcmFuZ2VDaHVua1NpemUgJiYgIXRoaXMuX2Rpc2FibGVSYW5nZSkgewogICAgICB0aGlzLl9kaXNhYmxlUmFuZ2UgPSB0cnVlOwogICAgfQogICAgdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQgPSAhc291cmNlLmRpc2FibGVTdHJlYW07CiAgICB0aGlzLl9pc1JhbmdlU3VwcG9ydGVkID0gIXNvdXJjZS5kaXNhYmxlUmFuZ2U7CiAgICB0aGlzLl9yZWFkYWJsZVN0cmVhbSA9IG51bGw7CiAgICB0aGlzLl9yZWFkQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgdGhpcy5faGVhZGVyc0NhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIGNvbnN0IGZzID0gcHJvY2Vzcy5nZXRCdWlsdGluTW9kdWxlKCJmcyIpOwogICAgZnMucHJvbWlzZXMubHN0YXQodGhpcy5fdXJsKS50aGVuKChzdGF0KSA9PiB7CiAgICAgIHRoaXMuX2NvbnRlbnRMZW5ndGggPSBzdGF0LnNpemU7CiAgICAgIHRoaXMuX3NldFJlYWRhYmxlU3RyZWFtKGZzLmNyZWF0ZVJlYWRTdHJlYW0odGhpcy5fdXJsKSk7CiAgICAgIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgIH0sIChlcnJvcikgPT4gewogICAgICBpZiAoZXJyb3IuY29kZSA9PT0gIkVOT0VOVCIpIHsKICAgICAgICBlcnJvciA9IGNyZWF0ZVJlc3BvbnNlRXJyb3IoMCwgdGhpcy5fdXJsLmhyZWYpOwogICAgICB9CiAgICAgIHRoaXMuX3N0b3JlZEVycm9yID0gZXJyb3I7CiAgICAgIHRoaXMuX2hlYWRlcnNDYXBhYmlsaXR5LnJlamVjdChlcnJvcik7CiAgICB9KTsKICB9CiAgZ2V0IGhlYWRlcnNSZWFkeSgpIHsKICAgIHJldHVybiB0aGlzLl9oZWFkZXJzQ2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICBnZXQgZmlsZW5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5fZmlsZW5hbWU7CiAgfQogIGdldCBjb250ZW50TGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2NvbnRlbnRMZW5ndGg7CiAgfQogIGdldCBpc1JhbmdlU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHRoaXMuX2lzUmFuZ2VTdXBwb3J0ZWQ7CiAgfQogIGdldCBpc1N0cmVhbWluZ1N1cHBvcnRlZCgpIHsKICAgIHJldHVybiB0aGlzLl9pc1N0cmVhbWluZ1N1cHBvcnRlZDsKICB9CiAgYXN5bmMgcmVhZCgpIHsKICAgIGF3YWl0IHRoaXMuX3JlYWRDYXBhYmlsaXR5LnByb21pc2U7CiAgICBpZiAodGhpcy5fZG9uZSkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgZG9uZTogdHJ1ZQogICAgICB9OwogICAgfQogICAgaWYgKHRoaXMuX3N0b3JlZEVycm9yKSB7CiAgICAgIHRocm93IHRoaXMuX3N0b3JlZEVycm9yOwogICAgfQogICAgY29uc3QgY2h1bmsgPSB0aGlzLl9yZWFkYWJsZVN0cmVhbS5yZWFkKCk7CiAgICBpZiAoY2h1bmsgPT09IG51bGwpIHsKICAgICAgdGhpcy5fcmVhZENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgICAgcmV0dXJuIHRoaXMucmVhZCgpOwogICAgfQogICAgdGhpcy5fbG9hZGVkICs9IGNodW5rLmxlbmd0aDsKICAgIHRoaXMub25Qcm9ncmVzcz8uKHsKICAgICAgbG9hZGVkOiB0aGlzLl9sb2FkZWQsCiAgICAgIHRvdGFsOiB0aGlzLl9jb250ZW50TGVuZ3RoCiAgICB9KTsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGNodW5rKS5idWZmZXI7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogYnVmZmVyLAogICAgICBkb25lOiBmYWxzZQogICAgfTsKICB9CiAgY2FuY2VsKHJlYXNvbikgewogICAgaWYgKCF0aGlzLl9yZWFkYWJsZVN0cmVhbSkgewogICAgICB0aGlzLl9lcnJvcihyZWFzb24pOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9yZWFkYWJsZVN0cmVhbS5kZXN0cm95KHJlYXNvbik7CiAgfQogIF9lcnJvcihyZWFzb24pIHsKICAgIHRoaXMuX3N0b3JlZEVycm9yID0gcmVhc29uOwogICAgdGhpcy5fcmVhZENhcGFiaWxpdHkucmVzb2x2ZSgpOwogIH0KICBfc2V0UmVhZGFibGVTdHJlYW0ocmVhZGFibGVTdHJlYW0pIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RyZWFtID0gcmVhZGFibGVTdHJlYW07CiAgICByZWFkYWJsZVN0cmVhbS5vbigicmVhZGFibGUiLCAoKSA9PiB7CiAgICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgIH0pOwogICAgcmVhZGFibGVTdHJlYW0ub24oImVuZCIsICgpID0+IHsKICAgICAgcmVhZGFibGVTdHJlYW0uZGVzdHJveSgpOwogICAgICB0aGlzLl9kb25lID0gdHJ1ZTsKICAgICAgdGhpcy5fcmVhZENhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgfSk7CiAgICByZWFkYWJsZVN0cmVhbS5vbigiZXJyb3IiLCAocmVhc29uKSA9PiB7CiAgICAgIHRoaXMuX2Vycm9yKHJlYXNvbik7CiAgICB9KTsKICAgIGlmICghdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQgJiYgdGhpcy5faXNSYW5nZVN1cHBvcnRlZCkgewogICAgICB0aGlzLl9lcnJvcihuZXcgQWJvcnRFeGNlcHRpb24oInN0cmVhbWluZyBpcyBkaXNhYmxlZCIpKTsKICAgIH0KICAgIGlmICh0aGlzLl9zdG9yZWRFcnJvcikgewogICAgICB0aGlzLl9yZWFkYWJsZVN0cmVhbS5kZXN0cm95KHRoaXMuX3N0b3JlZEVycm9yKTsKICAgIH0KICB9Cn07CnZhciBQREZOb2RlU3RyZWFtRnNSYW5nZVJlYWRlciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihzdHJlYW0sIHN0YXJ0LCBlbmQpIHsKICAgIHRoaXMuX3VybCA9IHN0cmVhbS51cmw7CiAgICB0aGlzLl9kb25lID0gZmFsc2U7CiAgICB0aGlzLl9zdG9yZWRFcnJvciA9IG51bGw7CiAgICB0aGlzLm9uUHJvZ3Jlc3MgPSBudWxsOwogICAgdGhpcy5fbG9hZGVkID0gMDsKICAgIHRoaXMuX3JlYWRhYmxlU3RyZWFtID0gbnVsbDsKICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICBjb25zdCBzb3VyY2UgPSBzdHJlYW0uc291cmNlOwogICAgdGhpcy5faXNTdHJlYW1pbmdTdXBwb3J0ZWQgPSAhc291cmNlLmRpc2FibGVTdHJlYW07CiAgICBjb25zdCBmcyA9IHByb2Nlc3MuZ2V0QnVpbHRpbk1vZHVsZSgiZnMiKTsKICAgIHRoaXMuX3NldFJlYWRhYmxlU3RyZWFtKGZzLmNyZWF0ZVJlYWRTdHJlYW0odGhpcy5fdXJsLCB7CiAgICAgIHN0YXJ0LAogICAgICBlbmQ6IGVuZCAtIDEKICAgIH0pKTsKICB9CiAgZ2V0IGlzU3RyZWFtaW5nU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHRoaXMuX2lzU3RyZWFtaW5nU3VwcG9ydGVkOwogIH0KICBhc3luYyByZWFkKCkgewogICAgYXdhaXQgdGhpcy5fcmVhZENhcGFiaWxpdHkucHJvbWlzZTsKICAgIGlmICh0aGlzLl9kb25lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICBkb25lOiB0cnVlCiAgICAgIH07CiAgICB9CiAgICBpZiAodGhpcy5fc3RvcmVkRXJyb3IpIHsKICAgICAgdGhyb3cgdGhpcy5fc3RvcmVkRXJyb3I7CiAgICB9CiAgICBjb25zdCBjaHVuayA9IHRoaXMuX3JlYWRhYmxlU3RyZWFtLnJlYWQoKTsKICAgIGlmIChjaHVuayA9PT0gbnVsbCkgewogICAgICB0aGlzLl9yZWFkQ2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgICByZXR1cm4gdGhpcy5yZWFkKCk7CiAgICB9CiAgICB0aGlzLl9sb2FkZWQgKz0gY2h1bmsubGVuZ3RoOwogICAgdGhpcy5vblByb2dyZXNzPy4oewogICAgICBsb2FkZWQ6IHRoaXMuX2xvYWRlZAogICAgfSk7CiAgICBjb25zdCBidWZmZXIgPSBuZXcgVWludDhBcnJheShjaHVuaykuYnVmZmVyOwogICAgcmV0dXJuIHsKICAgICAgdmFsdWU6IGJ1ZmZlciwKICAgICAgZG9uZTogZmFsc2UKICAgIH07CiAgfQogIGNhbmNlbChyZWFzb24pIHsKICAgIGlmICghdGhpcy5fcmVhZGFibGVTdHJlYW0pIHsKICAgICAgdGhpcy5fZXJyb3IocmVhc29uKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fcmVhZGFibGVTdHJlYW0uZGVzdHJveShyZWFzb24pOwogIH0KICBfZXJyb3IocmVhc29uKSB7CiAgICB0aGlzLl9zdG9yZWRFcnJvciA9IHJlYXNvbjsKICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5LnJlc29sdmUoKTsKICB9CiAgX3NldFJlYWRhYmxlU3RyZWFtKHJlYWRhYmxlU3RyZWFtKSB7CiAgICB0aGlzLl9yZWFkYWJsZVN0cmVhbSA9IHJlYWRhYmxlU3RyZWFtOwogICAgcmVhZGFibGVTdHJlYW0ub24oInJlYWRhYmxlIiwgKCkgPT4gewogICAgICB0aGlzLl9yZWFkQ2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICB9KTsKICAgIHJlYWRhYmxlU3RyZWFtLm9uKCJlbmQiLCAoKSA9PiB7CiAgICAgIHJlYWRhYmxlU3RyZWFtLmRlc3Ryb3koKTsKICAgICAgdGhpcy5fZG9uZSA9IHRydWU7CiAgICAgIHRoaXMuX3JlYWRDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgIH0pOwogICAgcmVhZGFibGVTdHJlYW0ub24oImVycm9yIiwgKHJlYXNvbikgPT4gewogICAgICB0aGlzLl9lcnJvcihyZWFzb24pOwogICAgfSk7CiAgICBpZiAodGhpcy5fc3RvcmVkRXJyb3IpIHsKICAgICAgdGhpcy5fcmVhZGFibGVTdHJlYW0uZGVzdHJveSh0aGlzLl9zdG9yZWRFcnJvcik7CiAgICB9CiAgfQp9Owp2YXIgSU5JVElBTF9EQVRBID0gU3ltYm9sKCJJTklUSUFMX0RBVEEiKTsKdmFyIFBERk9iamVjdHMgPSBjbGFzcyB7CiAgI29ianMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAjZW5zdXJlT2JqKG9iaklkKSB7CiAgICByZXR1cm4gdGhpcy4jb2Jqc1tvYmpJZF0gfHw9IHsKICAgICAgLi4uUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCksCiAgICAgIGRhdGE6IElOSVRJQUxfREFUQQogICAgfTsKICB9CiAgZ2V0KG9iaklkLCBjYWxsYmFjayA9IG51bGwpIHsKICAgIGlmIChjYWxsYmFjaykgewogICAgICBjb25zdCBvYmoyID0gdGhpcy4jZW5zdXJlT2JqKG9iaklkKTsKICAgICAgb2JqMi5wcm9taXNlLnRoZW4oKCkgPT4gY2FsbGJhY2sob2JqMi5kYXRhKSk7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgY29uc3Qgb2JqID0gdGhpcy4jb2Jqc1tvYmpJZF07CiAgICBpZiAoIW9iaiB8fCBvYmouZGF0YSA9PT0gSU5JVElBTF9EQVRBKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdGluZyBvYmplY3QgdGhhdCBpc24ndCByZXNvbHZlZCB5ZXQgJHtvYmpJZH0uYCk7CiAgICB9CiAgICByZXR1cm4gb2JqLmRhdGE7CiAgfQogIGhhcyhvYmpJZCkgewogICAgY29uc3Qgb2JqID0gdGhpcy4jb2Jqc1tvYmpJZF07CiAgICByZXR1cm4gISFvYmogJiYgb2JqLmRhdGEgIT09IElOSVRJQUxfREFUQTsKICB9CiAgZGVsZXRlKG9iaklkKSB7CiAgICBjb25zdCBvYmogPSB0aGlzLiNvYmpzW29iaklkXTsKICAgIGlmICghb2JqIHx8IG9iai5kYXRhID09PSBJTklUSUFMX0RBVEEpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZGVsZXRlIHRoaXMuI29ianNbb2JqSWRdOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHJlc29sdmUob2JqSWQsIGRhdGEgPSBudWxsKSB7CiAgICBjb25zdCBvYmogPSB0aGlzLiNlbnN1cmVPYmoob2JqSWQpOwogICAgb2JqLmRhdGEgPSBkYXRhOwogICAgb2JqLnJlc29sdmUoKTsKICB9CiAgY2xlYXIoKSB7CiAgICBmb3IgKGNvbnN0IG9iaklkIGluIHRoaXMuI29ianMpIHsKICAgICAgY29uc3QgewogICAgICAgIGRhdGEKICAgICAgfSA9IHRoaXMuI29ianNbb2JqSWRdOwogICAgICBkYXRhPy5iaXRtYXA/LmNsb3NlKCk7CiAgICB9CiAgICB0aGlzLiNvYmpzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfQogICpbU3ltYm9sLml0ZXJhdG9yXSgpIHsKICAgIGZvciAoY29uc3Qgb2JqSWQgaW4gdGhpcy4jb2JqcykgewogICAgICBjb25zdCB7CiAgICAgICAgZGF0YQogICAgICB9ID0gdGhpcy4jb2Jqc1tvYmpJZF07CiAgICAgIGlmIChkYXRhID09PSBJTklUSUFMX0RBVEEpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICB5aWVsZCBbb2JqSWQsIGRhdGFdOwogICAgfQogIH0KfTsKdmFyIE1BWF9URVhUX0RJVlNfVE9fUkVOREVSID0gMWU1Owp2YXIgREVGQVVMVF9GT05UX1NJWkUgPSAzMDsKdmFyIFRleHRMYXllciA9IGNsYXNzIF9UZXh0TGF5ZXIgewogICNjYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgI2NvbnRhaW5lciA9IG51bGw7CiAgI2Rpc2FibGVQcm9jZXNzSXRlbXMgPSBmYWxzZTsKICAjZm9udEluc3BlY3RvckVuYWJsZWQgPSAhIWdsb2JhbFRoaXMuRm9udEluc3BlY3Rvcj8uZW5hYmxlZDsKICAjbGFuZyA9IG51bGw7CiAgI2xheW91dFRleHRQYXJhbXMgPSBudWxsOwogICNwYWdlSGVpZ2h0ID0gMDsKICAjcGFnZVdpZHRoID0gMDsKICAjcmVhZGVyID0gbnVsbDsKICAjcm9vdENvbnRhaW5lciA9IG51bGw7CiAgI3JvdGF0aW9uID0gMDsKICAjc2NhbGUgPSAwOwogICNzdHlsZUNhY2hlID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgI3RleHRDb250ZW50SXRlbXNTdHIgPSBbXTsKICAjdGV4dENvbnRlbnRTb3VyY2UgPSBudWxsOwogICN0ZXh0RGl2cyA9IFtdOwogICN0ZXh0RGl2UHJvcGVydGllcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogICN0cmFuc2Zvcm0gPSBudWxsOwogIHN0YXRpYyAjYXNjZW50Q2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHN0YXRpYyAjY2FudmFzQ29udGV4dHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHN0YXRpYyAjY2FudmFzQ3R4Rm9udHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBzdGF0aWMgI21pbkZvbnRTaXplID0gbnVsbDsKICBzdGF0aWMgI3BlbmRpbmdUZXh0TGF5ZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICBjb25zdHJ1Y3Rvcih7CiAgICB0ZXh0Q29udGVudFNvdXJjZSwKICAgIGNvbnRhaW5lcjogY29udGFpbmVyMiwKICAgIHZpZXdwb3J0CiAgfSkgewogICAgaWYgKHRleHRDb250ZW50U291cmNlIGluc3RhbmNlb2YgUmVhZGFibGVTdHJlYW0pIHsKICAgICAgdGhpcy4jdGV4dENvbnRlbnRTb3VyY2UgPSB0ZXh0Q29udGVudFNvdXJjZTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHRleHRDb250ZW50U291cmNlID09PSAib2JqZWN0IikgewogICAgICB0aGlzLiN0ZXh0Q29udGVudFNvdXJjZSA9IG5ldyBSZWFkYWJsZVN0cmVhbSh7CiAgICAgICAgc3RhcnQoY29udHJvbGxlcikgewogICAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKHRleHRDb250ZW50U291cmNlKTsKICAgICAgICAgIGNvbnRyb2xsZXIuY2xvc2UoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyAidGV4dENvbnRlbnRTb3VyY2UiIHBhcmFtZXRlciBzcGVjaWZpZWQuJyk7CiAgICB9CiAgICB0aGlzLiNjb250YWluZXIgPSB0aGlzLiNyb290Q29udGFpbmVyID0gY29udGFpbmVyMjsKICAgIHRoaXMuI3NjYWxlID0gdmlld3BvcnQuc2NhbGUgKiBPdXRwdXRTY2FsZS5waXhlbFJhdGlvOwogICAgdGhpcy4jcm90YXRpb24gPSB2aWV3cG9ydC5yb3RhdGlvbjsKICAgIHRoaXMuI2xheW91dFRleHRQYXJhbXMgPSB7CiAgICAgIGRpdjogbnVsbCwKICAgICAgcHJvcGVydGllczogbnVsbCwKICAgICAgY3R4OiBudWxsCiAgICB9OwogICAgY29uc3QgewogICAgICBwYWdlV2lkdGgsCiAgICAgIHBhZ2VIZWlnaHQsCiAgICAgIHBhZ2VYLAogICAgICBwYWdlWQogICAgfSA9IHZpZXdwb3J0LnJhd0RpbXM7CiAgICB0aGlzLiN0cmFuc2Zvcm0gPSBbMSwgMCwgMCwgLTEsIC1wYWdlWCwgcGFnZVkgKyBwYWdlSGVpZ2h0XTsKICAgIHRoaXMuI3BhZ2VXaWR0aCA9IHBhZ2VXaWR0aDsKICAgIHRoaXMuI3BhZ2VIZWlnaHQgPSBwYWdlSGVpZ2h0OwogICAgX1RleHRMYXllci4jZW5zdXJlTWluRm9udFNpemVDb21wdXRlZCgpOwogICAgY29udGFpbmVyMi5zdHlsZS5zZXRQcm9wZXJ0eSgiLS1taW4tZm9udC1zaXplIiwgX1RleHRMYXllci4jbWluRm9udFNpemUpOwogICAgc2V0TGF5ZXJEaW1lbnNpb25zKGNvbnRhaW5lcjIsIHZpZXdwb3J0KTsKICAgIHRoaXMuI2NhcGFiaWxpdHkucHJvbWlzZS5maW5hbGx5KCgpID0+IHsKICAgICAgX1RleHRMYXllci4jcGVuZGluZ1RleHRMYXllcnMuZGVsZXRlKHRoaXMpOwogICAgICB0aGlzLiNsYXlvdXRUZXh0UGFyYW1zID0gbnVsbDsKICAgICAgdGhpcy4jc3R5bGVDYWNoZSA9IG51bGw7CiAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICB9KTsKICB9CiAgc3RhdGljIGdldCBmb250RmFtaWx5TWFwKCkgewogICAgY29uc3QgewogICAgICBpc1dpbmRvd3MsCiAgICAgIGlzRmlyZWZveAogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJmb250RmFtaWx5TWFwIiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoW1sic2Fucy1zZXJpZiIsIGAke2lzV2luZG93cyAmJiBpc0ZpcmVmb3ggPyAiQ2FsaWJyaSwgIiA6ICIifXNhbnMtc2VyaWZgXSwgWyJtb25vc3BhY2UiLCBgJHtpc1dpbmRvd3MgJiYgaXNGaXJlZm94ID8gIkx1Y2lkYSBDb25zb2xlLCAiIDogIiJ9bW9ub3NwYWNlYF1dKSk7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IHB1bXAgPSAoKSA9PiB7CiAgICAgIHRoaXMuI3JlYWRlci5yZWFkKCkudGhlbigoewogICAgICAgIHZhbHVlLAogICAgICAgIGRvbmUKICAgICAgfSkgPT4gewogICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICB0aGlzLiNjYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy4jbGFuZyA/Pz0gdmFsdWUubGFuZzsKICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMuI3N0eWxlQ2FjaGUsIHZhbHVlLnN0eWxlcyk7CiAgICAgICAgdGhpcy4jcHJvY2Vzc0l0ZW1zKHZhbHVlLml0ZW1zKTsKICAgICAgICBwdW1wKCk7CiAgICAgIH0sIHRoaXMuI2NhcGFiaWxpdHkucmVqZWN0KTsKICAgIH07CiAgICB0aGlzLiNyZWFkZXIgPSB0aGlzLiN0ZXh0Q29udGVudFNvdXJjZS5nZXRSZWFkZXIoKTsKICAgIF9UZXh0TGF5ZXIuI3BlbmRpbmdUZXh0TGF5ZXJzLmFkZCh0aGlzKTsKICAgIHB1bXAoKTsKICAgIHJldHVybiB0aGlzLiNjYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIHVwZGF0ZSh7CiAgICB2aWV3cG9ydCwKICAgIG9uQmVmb3JlID0gbnVsbAogIH0pIHsKICAgIGNvbnN0IHNjYWxlID0gdmlld3BvcnQuc2NhbGUgKiBPdXRwdXRTY2FsZS5waXhlbFJhdGlvOwogICAgY29uc3Qgcm90YXRpb24gPSB2aWV3cG9ydC5yb3RhdGlvbjsKICAgIGlmIChyb3RhdGlvbiAhPT0gdGhpcy4jcm90YXRpb24pIHsKICAgICAgb25CZWZvcmU/LigpOwogICAgICB0aGlzLiNyb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgICBzZXRMYXllckRpbWVuc2lvbnModGhpcy4jcm9vdENvbnRhaW5lciwgewogICAgICAgIHJvdGF0aW9uCiAgICAgIH0pOwogICAgfQogICAgaWYgKHNjYWxlICE9PSB0aGlzLiNzY2FsZSkgewogICAgICBvbkJlZm9yZT8uKCk7CiAgICAgIHRoaXMuI3NjYWxlID0gc2NhbGU7CiAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICBkaXY6IG51bGwsCiAgICAgICAgcHJvcGVydGllczogbnVsbCwKICAgICAgICBjdHg6IF9UZXh0TGF5ZXIuI2dldEN0eCh0aGlzLiNsYW5nKQogICAgICB9OwogICAgICBmb3IgKGNvbnN0IGRpdiBvZiB0aGlzLiN0ZXh0RGl2cykgewogICAgICAgIHBhcmFtcy5wcm9wZXJ0aWVzID0gdGhpcy4jdGV4dERpdlByb3BlcnRpZXMuZ2V0KGRpdik7CiAgICAgICAgcGFyYW1zLmRpdiA9IGRpdjsKICAgICAgICB0aGlzLiNsYXlvdXQocGFyYW1zKTsKICAgICAgfQogICAgfQogIH0KICBjYW5jZWwoKSB7CiAgICBjb25zdCBhYm9ydEV4ID0gbmV3IEFib3J0RXhjZXB0aW9uKCJUZXh0TGF5ZXIgdGFzayBjYW5jZWxsZWQuIik7CiAgICB0aGlzLiNyZWFkZXI/LmNhbmNlbChhYm9ydEV4KS5jYXRjaCgoKSA9PiB7CiAgICB9KTsKICAgIHRoaXMuI3JlYWRlciA9IG51bGw7CiAgICB0aGlzLiNjYXBhYmlsaXR5LnJlamVjdChhYm9ydEV4KTsKICB9CiAgZ2V0IHRleHREaXZzKCkgewogICAgcmV0dXJuIHRoaXMuI3RleHREaXZzOwogIH0KICBnZXQgdGV4dENvbnRlbnRJdGVtc1N0cigpIHsKICAgIHJldHVybiB0aGlzLiN0ZXh0Q29udGVudEl0ZW1zU3RyOwogIH0KICAjcHJvY2Vzc0l0ZW1zKGl0ZW1zKSB7CiAgICBpZiAodGhpcy4jZGlzYWJsZVByb2Nlc3NJdGVtcykgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNsYXlvdXRUZXh0UGFyYW1zLmN0eCA/Pz0gX1RleHRMYXllci4jZ2V0Q3R4KHRoaXMuI2xhbmcpOwogICAgY29uc3QgdGV4dERpdnMgPSB0aGlzLiN0ZXh0RGl2cywgdGV4dENvbnRlbnRJdGVtc1N0ciA9IHRoaXMuI3RleHRDb250ZW50SXRlbXNTdHI7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHsKICAgICAgaWYgKHRleHREaXZzLmxlbmd0aCA+IE1BWF9URVhUX0RJVlNfVE9fUkVOREVSKSB7CiAgICAgICAgd2FybigiSWdub3JpbmcgYWRkaXRpb25hbCB0ZXh0RGl2cyBmb3IgcGVyZm9ybWFuY2UgcmVhc29ucy4iKTsKICAgICAgICB0aGlzLiNkaXNhYmxlUHJvY2Vzc0l0ZW1zID0gdHJ1ZTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGl0ZW0uc3RyID09PSB2b2lkIDApIHsKICAgICAgICBpZiAoaXRlbS50eXBlID09PSAiYmVnaW5NYXJrZWRDb250ZW50UHJvcHMiIHx8IGl0ZW0udHlwZSA9PT0gImJlZ2luTWFya2VkQ29udGVudCIpIHsKICAgICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuI2NvbnRhaW5lcjsKICAgICAgICAgIHRoaXMuI2NvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgICAgIHRoaXMuI2NvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJtYXJrZWRDb250ZW50Iik7CiAgICAgICAgICBpZiAoaXRlbS5pZCkgewogICAgICAgICAgICB0aGlzLiNjb250YWluZXIuc2V0QXR0cmlidXRlKCJpZCIsIGAke2l0ZW0uaWR9YCk7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJlbnQuYXBwZW5kKHRoaXMuI2NvbnRhaW5lcik7CiAgICAgICAgfSBlbHNlIGlmIChpdGVtLnR5cGUgPT09ICJlbmRNYXJrZWRDb250ZW50IikgewogICAgICAgICAgdGhpcy4jY29udGFpbmVyID0gdGhpcy4jY29udGFpbmVyLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHRleHRDb250ZW50SXRlbXNTdHIucHVzaChpdGVtLnN0cik7CiAgICAgIHRoaXMuI2FwcGVuZFRleHQoaXRlbSk7CiAgICB9CiAgfQogICNhcHBlbmRUZXh0KGdlb20pIHsKICAgIGNvbnN0IHRleHREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICBjb25zdCB0ZXh0RGl2UHJvcGVydGllcyA9IHsKICAgICAgYW5nbGU6IDAsCiAgICAgIGNhbnZhc1dpZHRoOiAwLAogICAgICBoYXNUZXh0OiBnZW9tLnN0ciAhPT0gIiIsCiAgICAgIGhhc0VPTDogZ2VvbS5oYXNFT0wsCiAgICAgIGZvbnRTaXplOiAwCiAgICB9OwogICAgdGhpcy4jdGV4dERpdnMucHVzaCh0ZXh0RGl2KTsKICAgIGNvbnN0IHR4ID0gVXRpbC50cmFuc2Zvcm0odGhpcy4jdHJhbnNmb3JtLCBnZW9tLnRyYW5zZm9ybSk7CiAgICBsZXQgYW5nbGUgPSBNYXRoLmF0YW4yKHR4WzFdLCB0eFswXSk7CiAgICBjb25zdCBzdHlsZSA9IHRoaXMuI3N0eWxlQ2FjaGVbZ2VvbS5mb250TmFtZV07CiAgICBpZiAoc3R5bGUudmVydGljYWwpIHsKICAgICAgYW5nbGUgKz0gTWF0aC5QSSAvIDI7CiAgICB9CiAgICBsZXQgZm9udEZhbWlseSA9IHRoaXMuI2ZvbnRJbnNwZWN0b3JFbmFibGVkICYmIHN0eWxlLmZvbnRTdWJzdGl0dXRpb24gfHwgc3R5bGUuZm9udEZhbWlseTsKICAgIGZvbnRGYW1pbHkgPSBfVGV4dExheWVyLmZvbnRGYW1pbHlNYXAuZ2V0KGZvbnRGYW1pbHkpIHx8IGZvbnRGYW1pbHk7CiAgICBjb25zdCBmb250SGVpZ2h0ID0gTWF0aC5oeXBvdCh0eFsyXSwgdHhbM10pOwogICAgY29uc3QgZm9udEFzY2VudCA9IGZvbnRIZWlnaHQgKiBfVGV4dExheWVyLiNnZXRBc2NlbnQoZm9udEZhbWlseSwgc3R5bGUsIHRoaXMuI2xhbmcpOwogICAgbGV0IGxlZnQsIHRvcDsKICAgIGlmIChhbmdsZSA9PT0gMCkgewogICAgICBsZWZ0ID0gdHhbNF07CiAgICAgIHRvcCA9IHR4WzVdIC0gZm9udEFzY2VudDsKICAgIH0gZWxzZSB7CiAgICAgIGxlZnQgPSB0eFs0XSArIGZvbnRBc2NlbnQgKiBNYXRoLnNpbihhbmdsZSk7CiAgICAgIHRvcCA9IHR4WzVdIC0gZm9udEFzY2VudCAqIE1hdGguY29zKGFuZ2xlKTsKICAgIH0KICAgIGNvbnN0IGRpdlN0eWxlID0gdGV4dERpdi5zdHlsZTsKICAgIGRpdlN0eWxlLmxlZnQgPSBgJHsoMTAwICogbGVmdCAvIHRoaXMuI3BhZ2VXaWR0aCkudG9GaXhlZCgyKX0lYDsKICAgIGRpdlN0eWxlLnRvcCA9IGAkeygxMDAgKiB0b3AgLyB0aGlzLiNwYWdlSGVpZ2h0KS50b0ZpeGVkKDIpfSVgOwogICAgZGl2U3R5bGUuc2V0UHJvcGVydHkoIi0tZm9udC1oZWlnaHQiLCBgJHtmb250SGVpZ2h0LnRvRml4ZWQoMil9cHhgKTsKICAgIGRpdlN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5OwogICAgdGV4dERpdlByb3BlcnRpZXMuZm9udFNpemUgPSBmb250SGVpZ2h0OwogICAgdGV4dERpdi5zZXRBdHRyaWJ1dGUoInJvbGUiLCAicHJlc2VudGF0aW9uIik7CiAgICB0ZXh0RGl2LnRleHRDb250ZW50ID0gZ2VvbS5zdHI7CiAgICB0ZXh0RGl2LmRpciA9IGdlb20uZGlyOwogICAgaWYgKHRoaXMuI2ZvbnRJbnNwZWN0b3JFbmFibGVkKSB7CiAgICAgIHRleHREaXYuZGF0YXNldC5mb250TmFtZSA9IHN0eWxlLmZvbnRTdWJzdGl0dXRpb25Mb2FkZWROYW1lIHx8IGdlb20uZm9udE5hbWU7CiAgICB9CiAgICBpZiAoYW5nbGUgIT09IDApIHsKICAgICAgdGV4dERpdlByb3BlcnRpZXMuYW5nbGUgPSBhbmdsZSAqICgxODAgLyBNYXRoLlBJKTsKICAgIH0KICAgIGxldCBzaG91bGRTY2FsZVRleHQgPSBmYWxzZTsKICAgIGlmIChnZW9tLnN0ci5sZW5ndGggPiAxKSB7CiAgICAgIHNob3VsZFNjYWxlVGV4dCA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGdlb20uc3RyICE9PSAiICIgJiYgZ2VvbS50cmFuc2Zvcm1bMF0gIT09IGdlb20udHJhbnNmb3JtWzNdKSB7CiAgICAgIGNvbnN0IGFic1NjYWxlWCA9IE1hdGguYWJzKGdlb20udHJhbnNmb3JtWzBdKSwgYWJzU2NhbGVZID0gTWF0aC5hYnMoZ2VvbS50cmFuc2Zvcm1bM10pOwogICAgICBpZiAoYWJzU2NhbGVYICE9PSBhYnNTY2FsZVkgJiYgTWF0aC5tYXgoYWJzU2NhbGVYLCBhYnNTY2FsZVkpIC8gTWF0aC5taW4oYWJzU2NhbGVYLCBhYnNTY2FsZVkpID4gMS41KSB7CiAgICAgICAgc2hvdWxkU2NhbGVUZXh0ID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgaWYgKHNob3VsZFNjYWxlVGV4dCkgewogICAgICB0ZXh0RGl2UHJvcGVydGllcy5jYW52YXNXaWR0aCA9IHN0eWxlLnZlcnRpY2FsID8gZ2VvbS5oZWlnaHQgOiBnZW9tLndpZHRoOwogICAgfQogICAgdGhpcy4jdGV4dERpdlByb3BlcnRpZXMuc2V0KHRleHREaXYsIHRleHREaXZQcm9wZXJ0aWVzKTsKICAgIHRoaXMuI2xheW91dFRleHRQYXJhbXMuZGl2ID0gdGV4dERpdjsKICAgIHRoaXMuI2xheW91dFRleHRQYXJhbXMucHJvcGVydGllcyA9IHRleHREaXZQcm9wZXJ0aWVzOwogICAgdGhpcy4jbGF5b3V0KHRoaXMuI2xheW91dFRleHRQYXJhbXMpOwogICAgaWYgKHRleHREaXZQcm9wZXJ0aWVzLmhhc1RleHQpIHsKICAgICAgdGhpcy4jY29udGFpbmVyLmFwcGVuZCh0ZXh0RGl2KTsKICAgIH0KICAgIGlmICh0ZXh0RGl2UHJvcGVydGllcy5oYXNFT0wpIHsKICAgICAgY29uc3QgYnIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJiciIpOwogICAgICBici5zZXRBdHRyaWJ1dGUoInJvbGUiLCAicHJlc2VudGF0aW9uIik7CiAgICAgIHRoaXMuI2NvbnRhaW5lci5hcHBlbmQoYnIpOwogICAgfQogIH0KICAjbGF5b3V0KHBhcmFtcykgewogICAgY29uc3QgewogICAgICBkaXYsCiAgICAgIHByb3BlcnRpZXMsCiAgICAgIGN0eAogICAgfSA9IHBhcmFtczsKICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSBkaXY7CiAgICBpZiAocHJvcGVydGllcy5jYW52YXNXaWR0aCAhPT0gMCAmJiBwcm9wZXJ0aWVzLmhhc1RleHQpIHsKICAgICAgY29uc3QgewogICAgICAgIGZvbnRGYW1pbHkKICAgICAgfSA9IHN0eWxlOwogICAgICBjb25zdCB7CiAgICAgICAgY2FudmFzV2lkdGgsCiAgICAgICAgZm9udFNpemUKICAgICAgfSA9IHByb3BlcnRpZXM7CiAgICAgIF9UZXh0TGF5ZXIuI2Vuc3VyZUN0eEZvbnQoY3R4LCBmb250U2l6ZSAqIHRoaXMuI3NjYWxlLCBmb250RmFtaWx5KTsKICAgICAgY29uc3QgewogICAgICAgIHdpZHRoCiAgICAgIH0gPSBjdHgubWVhc3VyZVRleHQoZGl2LnRleHRDb250ZW50KTsKICAgICAgaWYgKHdpZHRoID4gMCkgewogICAgICAgIHN0eWxlLnNldFByb3BlcnR5KCItLXNjYWxlLXgiLCBjYW52YXNXaWR0aCAqIHRoaXMuI3NjYWxlIC8gd2lkdGgpOwogICAgICB9CiAgICB9CiAgICBpZiAocHJvcGVydGllcy5hbmdsZSAhPT0gMCkgewogICAgICBzdHlsZS5zZXRQcm9wZXJ0eSgiLS1yb3RhdGUiLCBgJHtwcm9wZXJ0aWVzLmFuZ2xlfWRlZ2ApOwogICAgfQogIH0KICBzdGF0aWMgY2xlYW51cCgpIHsKICAgIGlmICh0aGlzLiNwZW5kaW5nVGV4dExheWVycy5zaXplID4gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNhc2NlbnRDYWNoZS5jbGVhcigpOwogICAgZm9yIChjb25zdCB7CiAgICAgIGNhbnZhcwogICAgfSBvZiB0aGlzLiNjYW52YXNDb250ZXh0cy52YWx1ZXMoKSkgewogICAgICBjYW52YXMucmVtb3ZlKCk7CiAgICB9CiAgICB0aGlzLiNjYW52YXNDb250ZXh0cy5jbGVhcigpOwogIH0KICBzdGF0aWMgI2dldEN0eChsYW5nID0gbnVsbCkgewogICAgbGV0IGN0eCA9IHRoaXMuI2NhbnZhc0NvbnRleHRzLmdldChsYW5nIHx8PSAiIik7CiAgICBpZiAoIWN0eCkgewogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgY2FudmFzLmNsYXNzTmFtZSA9ICJoaWRkZW5DYW52YXNFbGVtZW50IjsKICAgICAgY2FudmFzLmxhbmcgPSBsYW5nOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZChjYW52YXMpOwogICAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgICAgYWxwaGE6IGZhbHNlLAogICAgICAgIHdpbGxSZWFkRnJlcXVlbnRseTogdHJ1ZQogICAgICB9KTsKICAgICAgdGhpcy4jY2FudmFzQ29udGV4dHMuc2V0KGxhbmcsIGN0eCk7CiAgICAgIHRoaXMuI2NhbnZhc0N0eEZvbnRzLnNldChjdHgsIHsKICAgICAgICBzaXplOiAwLAogICAgICAgIGZhbWlseTogIiIKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gY3R4OwogIH0KICBzdGF0aWMgI2Vuc3VyZUN0eEZvbnQoY3R4LCBzaXplLCBmYW1pbHkpIHsKICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuI2NhbnZhc0N0eEZvbnRzLmdldChjdHgpOwogICAgaWYgKHNpemUgPT09IGNhY2hlZC5zaXplICYmIGZhbWlseSA9PT0gY2FjaGVkLmZhbWlseSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjdHguZm9udCA9IGAke3NpemV9cHggJHtmYW1pbHl9YDsKICAgIGNhY2hlZC5zaXplID0gc2l6ZTsKICAgIGNhY2hlZC5mYW1pbHkgPSBmYW1pbHk7CiAgfQogIHN0YXRpYyAjZW5zdXJlTWluRm9udFNpemVDb21wdXRlZCgpIHsKICAgIGlmICh0aGlzLiNtaW5Gb250U2l6ZSAhPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIGRpdi5zdHlsZS5vcGFjaXR5ID0gMDsKICAgIGRpdi5zdHlsZS5saW5lSGVpZ2h0ID0gMTsKICAgIGRpdi5zdHlsZS5mb250U2l6ZSA9ICIxcHgiOwogICAgZGl2LnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgIGRpdi50ZXh0Q29udGVudCA9ICJYIjsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kKGRpdik7CiAgICB0aGlzLiNtaW5Gb250U2l6ZSA9IGRpdi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5oZWlnaHQ7CiAgICBkaXYucmVtb3ZlKCk7CiAgfQogIHN0YXRpYyAjZ2V0QXNjZW50KGZvbnRGYW1pbHksIHN0eWxlLCBsYW5nKSB7CiAgICBjb25zdCBjYWNoZWRBc2NlbnQgPSB0aGlzLiNhc2NlbnRDYWNoZS5nZXQoZm9udEZhbWlseSk7CiAgICBpZiAoY2FjaGVkQXNjZW50KSB7CiAgICAgIHJldHVybiBjYWNoZWRBc2NlbnQ7CiAgICB9CiAgICBjb25zdCBjdHggPSB0aGlzLiNnZXRDdHgobGFuZyk7CiAgICBjdHguY2FudmFzLndpZHRoID0gY3R4LmNhbnZhcy5oZWlnaHQgPSBERUZBVUxUX0ZPTlRfU0laRTsKICAgIHRoaXMuI2Vuc3VyZUN0eEZvbnQoY3R4LCBERUZBVUxUX0ZPTlRfU0laRSwgZm9udEZhbWlseSk7CiAgICBjb25zdCBtZXRyaWNzID0gY3R4Lm1lYXN1cmVUZXh0KCIiKTsKICAgIGNvbnN0IGFzY2VudCA9IG1ldHJpY3MuZm9udEJvdW5kaW5nQm94QXNjZW50OwogICAgY29uc3QgZGVzY2VudCA9IE1hdGguYWJzKG1ldHJpY3MuZm9udEJvdW5kaW5nQm94RGVzY2VudCk7CiAgICBjdHguY2FudmFzLndpZHRoID0gY3R4LmNhbnZhcy5oZWlnaHQgPSAwOwogICAgbGV0IHJhdGlvID0gMC44OwogICAgaWYgKGFzY2VudCkgewogICAgICByYXRpbyA9IGFzY2VudCAvIChhc2NlbnQgKyBkZXNjZW50KTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICh1dGlsX0ZlYXR1cmVUZXN0LnBsYXRmb3JtLmlzRmlyZWZveCkgewogICAgICAgIHdhcm4oIkVuYWJsZSB0aGUgYGRvbS50ZXh0TWV0cmljcy5mb250Qm91bmRpbmdCb3guZW5hYmxlZGAgcHJlZmVyZW5jZSBpbiBgYWJvdXQ6Y29uZmlnYCB0byBpbXByb3ZlIFRleHRMYXllciByZW5kZXJpbmcuIik7CiAgICAgIH0KICAgICAgaWYgKHN0eWxlLmFzY2VudCkgewogICAgICAgIHJhdGlvID0gc3R5bGUuYXNjZW50OwogICAgICB9IGVsc2UgaWYgKHN0eWxlLmRlc2NlbnQpIHsKICAgICAgICByYXRpbyA9IDEgKyBzdHlsZS5kZXNjZW50OwogICAgICB9CiAgICB9CiAgICB0aGlzLiNhc2NlbnRDYWNoZS5zZXQoZm9udEZhbWlseSwgcmF0aW8pOwogICAgcmV0dXJuIHJhdGlvOwogIH0KfTsKdmFyIFJFTkRFUklOR19DQU5DRUxMRURfVElNRU9VVCA9IDEwMDsKZnVuY3Rpb24gZ2V0RG9jdW1lbnQoc3JjID0ge30pIHsKICBpZiAodHlwZW9mIHNyYyA9PT0gInN0cmluZyIgfHwgc3JjIGluc3RhbmNlb2YgVVJMKSB7CiAgICBzcmMgPSB7CiAgICAgIHVybDogc3JjCiAgICB9OwogIH0gZWxzZSBpZiAoc3JjIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgfHwgQXJyYXlCdWZmZXIuaXNWaWV3KHNyYykpIHsKICAgIHNyYyA9IHsKICAgICAgZGF0YTogc3JjCiAgICB9OwogIH0KICBjb25zdCB0YXNrID0gbmV3IFBERkRvY3VtZW50TG9hZGluZ1Rhc2soKTsKICBjb25zdCB7CiAgICBkb2NJZAogIH0gPSB0YXNrOwogIGNvbnN0IHVybCA9IHNyYy51cmwgPyBnZXRVcmxQcm9wKHNyYy51cmwpIDogbnVsbDsKICBjb25zdCBkYXRhID0gc3JjLmRhdGEgPyBnZXREYXRhUHJvcChzcmMuZGF0YSkgOiBudWxsOwogIGNvbnN0IGh0dHBIZWFkZXJzID0gc3JjLmh0dHBIZWFkZXJzIHx8IG51bGw7CiAgY29uc3Qgd2l0aENyZWRlbnRpYWxzID0gc3JjLndpdGhDcmVkZW50aWFscyA9PT0gdHJ1ZTsKICBjb25zdCBwYXNzd29yZCA9IHNyYy5wYXNzd29yZCA/PyBudWxsOwogIGNvbnN0IHJhbmdlVHJhbnNwb3J0ID0gc3JjLnJhbmdlIGluc3RhbmNlb2YgUERGRGF0YVJhbmdlVHJhbnNwb3J0ID8gc3JjLnJhbmdlIDogbnVsbDsKICBjb25zdCByYW5nZUNodW5rU2l6ZSA9IE51bWJlci5pc0ludGVnZXIoc3JjLnJhbmdlQ2h1bmtTaXplKSAmJiBzcmMucmFuZ2VDaHVua1NpemUgPiAwID8gc3JjLnJhbmdlQ2h1bmtTaXplIDogMiAqKiAxNjsKICBsZXQgd29ya2VyID0gc3JjLndvcmtlciBpbnN0YW5jZW9mIFBERldvcmtlciA/IHNyYy53b3JrZXIgOiBudWxsOwogIGNvbnN0IHZlcmJvc2l0eTIgPSBzcmMudmVyYm9zaXR5OwogIGNvbnN0IGRvY0Jhc2VVcmwgPSB0eXBlb2Ygc3JjLmRvY0Jhc2VVcmwgPT09ICJzdHJpbmciICYmICFpc0RhdGFTY2hlbWUoc3JjLmRvY0Jhc2VVcmwpID8gc3JjLmRvY0Jhc2VVcmwgOiBudWxsOwogIGNvbnN0IGNNYXBVcmwgPSBnZXRGYWN0b3J5VXJsUHJvcChzcmMuY01hcFVybCk7CiAgY29uc3QgY01hcFBhY2tlZCA9IHNyYy5jTWFwUGFja2VkICE9PSBmYWxzZTsKICBjb25zdCBDTWFwUmVhZGVyRmFjdG9yeSA9IHNyYy5DTWFwUmVhZGVyRmFjdG9yeSB8fCAoaXNOb2RlSlMgPyBOb2RlQ01hcFJlYWRlckZhY3RvcnkgOiBET01DTWFwUmVhZGVyRmFjdG9yeSk7CiAgY29uc3QgaWNjVXJsID0gZ2V0RmFjdG9yeVVybFByb3Aoc3JjLmljY1VybCk7CiAgY29uc3Qgc3RhbmRhcmRGb250RGF0YVVybCA9IGdldEZhY3RvcnlVcmxQcm9wKHNyYy5zdGFuZGFyZEZvbnREYXRhVXJsKTsKICBjb25zdCBTdGFuZGFyZEZvbnREYXRhRmFjdG9yeSA9IHNyYy5TdGFuZGFyZEZvbnREYXRhRmFjdG9yeSB8fCAoaXNOb2RlSlMgPyBOb2RlU3RhbmRhcmRGb250RGF0YUZhY3RvcnkgOiBET01TdGFuZGFyZEZvbnREYXRhRmFjdG9yeSk7CiAgY29uc3Qgd2FzbVVybCA9IGdldEZhY3RvcnlVcmxQcm9wKHNyYy53YXNtVXJsKTsKICBjb25zdCBXYXNtRmFjdG9yeSA9IHNyYy5XYXNtRmFjdG9yeSB8fCAoaXNOb2RlSlMgPyBOb2RlV2FzbUZhY3RvcnkgOiBET01XYXNtRmFjdG9yeSk7CiAgY29uc3QgaWdub3JlRXJyb3JzID0gc3JjLnN0b3BBdEVycm9ycyAhPT0gdHJ1ZTsKICBjb25zdCBtYXhJbWFnZVNpemUgPSBOdW1iZXIuaXNJbnRlZ2VyKHNyYy5tYXhJbWFnZVNpemUpICYmIHNyYy5tYXhJbWFnZVNpemUgPiAtMSA/IHNyYy5tYXhJbWFnZVNpemUgOiAtMTsKICBjb25zdCBpc0V2YWxTdXBwb3J0ZWQyID0gc3JjLmlzRXZhbFN1cHBvcnRlZCAhPT0gZmFsc2U7CiAgY29uc3QgaXNPZmZzY3JlZW5DYW52YXNTdXBwb3J0ZWQgPSB0eXBlb2Ygc3JjLmlzT2Zmc2NyZWVuQ2FudmFzU3VwcG9ydGVkID09PSAiYm9vbGVhbiIgPyBzcmMuaXNPZmZzY3JlZW5DYW52YXNTdXBwb3J0ZWQgOiAhaXNOb2RlSlM7CiAgY29uc3QgaXNJbWFnZURlY29kZXJTdXBwb3J0ZWQgPSB0eXBlb2Ygc3JjLmlzSW1hZ2VEZWNvZGVyU3VwcG9ydGVkID09PSAiYm9vbGVhbiIgPyBzcmMuaXNJbWFnZURlY29kZXJTdXBwb3J0ZWQgOiAhaXNOb2RlSlMgJiYgKHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm0uaXNGaXJlZm94IHx8ICFnbG9iYWxUaGlzLmNocm9tZSk7CiAgY29uc3QgY2FudmFzTWF4QXJlYUluQnl0ZXMgPSBOdW1iZXIuaXNJbnRlZ2VyKHNyYy5jYW52YXNNYXhBcmVhSW5CeXRlcykgPyBzcmMuY2FudmFzTWF4QXJlYUluQnl0ZXMgOiAtMTsKICBjb25zdCBkaXNhYmxlRm9udEZhY2UgPSB0eXBlb2Ygc3JjLmRpc2FibGVGb250RmFjZSA9PT0gImJvb2xlYW4iID8gc3JjLmRpc2FibGVGb250RmFjZSA6IGlzTm9kZUpTOwogIGNvbnN0IGZvbnRFeHRyYVByb3BlcnRpZXMgPSBzcmMuZm9udEV4dHJhUHJvcGVydGllcyA9PT0gdHJ1ZTsKICBjb25zdCBlbmFibGVYZmEgPSBzcmMuZW5hYmxlWGZhID09PSB0cnVlOwogIGNvbnN0IG93bmVyRG9jdW1lbnQgPSBzcmMub3duZXJEb2N1bWVudCB8fCBnbG9iYWxUaGlzLmRvY3VtZW50OwogIGNvbnN0IGRpc2FibGVSYW5nZSA9IHNyYy5kaXNhYmxlUmFuZ2UgPT09IHRydWU7CiAgY29uc3QgZGlzYWJsZVN0cmVhbSA9IHNyYy5kaXNhYmxlU3RyZWFtID09PSB0cnVlOwogIGNvbnN0IGRpc2FibGVBdXRvRmV0Y2ggPSBzcmMuZGlzYWJsZUF1dG9GZXRjaCA9PT0gdHJ1ZTsKICBjb25zdCBwZGZCdWcgPSBzcmMucGRmQnVnID09PSB0cnVlOwogIGNvbnN0IENhbnZhc0ZhY3RvcnkgPSBzcmMuQ2FudmFzRmFjdG9yeSB8fCAoaXNOb2RlSlMgPyBOb2RlQ2FudmFzRmFjdG9yeSA6IERPTUNhbnZhc0ZhY3RvcnkpOwogIGNvbnN0IEZpbHRlckZhY3RvcnkgPSBzcmMuRmlsdGVyRmFjdG9yeSB8fCAoaXNOb2RlSlMgPyBOb2RlRmlsdGVyRmFjdG9yeSA6IERPTUZpbHRlckZhY3RvcnkpOwogIGNvbnN0IGVuYWJsZUhXQSA9IHNyYy5lbmFibGVIV0EgPT09IHRydWU7CiAgY29uc3QgdXNlV2FzbSA9IHNyYy51c2VXYXNtICE9PSBmYWxzZTsKICBjb25zdCBsZW5ndGggPSByYW5nZVRyYW5zcG9ydCA/IHJhbmdlVHJhbnNwb3J0Lmxlbmd0aCA6IHNyYy5sZW5ndGggPz8gTmFOOwogIGNvbnN0IHVzZVN5c3RlbUZvbnRzID0gdHlwZW9mIHNyYy51c2VTeXN0ZW1Gb250cyA9PT0gImJvb2xlYW4iID8gc3JjLnVzZVN5c3RlbUZvbnRzIDogIWlzTm9kZUpTICYmICFkaXNhYmxlRm9udEZhY2U7CiAgY29uc3QgdXNlV29ya2VyRmV0Y2ggPSB0eXBlb2Ygc3JjLnVzZVdvcmtlckZldGNoID09PSAiYm9vbGVhbiIgPyBzcmMudXNlV29ya2VyRmV0Y2ggOiAhIShDTWFwUmVhZGVyRmFjdG9yeSA9PT0gRE9NQ01hcFJlYWRlckZhY3RvcnkgJiYgU3RhbmRhcmRGb250RGF0YUZhY3RvcnkgPT09IERPTVN0YW5kYXJkRm9udERhdGFGYWN0b3J5ICYmIFdhc21GYWN0b3J5ID09PSBET01XYXNtRmFjdG9yeSAmJiBjTWFwVXJsICYmIHN0YW5kYXJkRm9udERhdGFVcmwgJiYgd2FzbVVybCAmJiBpc1ZhbGlkRmV0Y2hVcmwoY01hcFVybCwgZG9jdW1lbnQuYmFzZVVSSSkgJiYgaXNWYWxpZEZldGNoVXJsKHN0YW5kYXJkRm9udERhdGFVcmwsIGRvY3VtZW50LmJhc2VVUkkpICYmIGlzVmFsaWRGZXRjaFVybCh3YXNtVXJsLCBkb2N1bWVudC5iYXNlVVJJKSk7CiAgY29uc3Qgc3R5bGVFbGVtZW50ID0gbnVsbDsKICBzZXRWZXJib3NpdHlMZXZlbCh2ZXJib3NpdHkyKTsKICBjb25zdCB0cmFuc3BvcnRGYWN0b3J5ID0gewogICAgY2FudmFzRmFjdG9yeTogbmV3IENhbnZhc0ZhY3RvcnkoewogICAgICBvd25lckRvY3VtZW50LAogICAgICBlbmFibGVIV0EKICAgIH0pLAogICAgZmlsdGVyRmFjdG9yeTogbmV3IEZpbHRlckZhY3RvcnkoewogICAgICBkb2NJZCwKICAgICAgb3duZXJEb2N1bWVudAogICAgfSksCiAgICBjTWFwUmVhZGVyRmFjdG9yeTogdXNlV29ya2VyRmV0Y2ggPyBudWxsIDogbmV3IENNYXBSZWFkZXJGYWN0b3J5KHsKICAgICAgYmFzZVVybDogY01hcFVybCwKICAgICAgaXNDb21wcmVzc2VkOiBjTWFwUGFja2VkCiAgICB9KSwKICAgIHN0YW5kYXJkRm9udERhdGFGYWN0b3J5OiB1c2VXb3JrZXJGZXRjaCA/IG51bGwgOiBuZXcgU3RhbmRhcmRGb250RGF0YUZhY3RvcnkoewogICAgICBiYXNlVXJsOiBzdGFuZGFyZEZvbnREYXRhVXJsCiAgICB9KSwKICAgIHdhc21GYWN0b3J5OiB1c2VXb3JrZXJGZXRjaCA/IG51bGwgOiBuZXcgV2FzbUZhY3RvcnkoewogICAgICBiYXNlVXJsOiB3YXNtVXJsCiAgICB9KQogIH07CiAgaWYgKCF3b3JrZXIpIHsKICAgIHdvcmtlciA9IFBERldvcmtlci5jcmVhdGUoewogICAgICB2ZXJib3NpdHk6IHZlcmJvc2l0eTIsCiAgICAgIHBvcnQ6IEdsb2JhbFdvcmtlck9wdGlvbnMud29ya2VyUG9ydAogICAgfSk7CiAgICB0YXNrLl93b3JrZXIgPSB3b3JrZXI7CiAgfQogIGNvbnN0IGRvY1BhcmFtcyA9IHsKICAgIGRvY0lkLAogICAgYXBpVmVyc2lvbjogIjUuNC41MzAiLAogICAgZGF0YSwKICAgIHBhc3N3b3JkLAogICAgZGlzYWJsZUF1dG9GZXRjaCwKICAgIHJhbmdlQ2h1bmtTaXplLAogICAgbGVuZ3RoLAogICAgZG9jQmFzZVVybCwKICAgIGVuYWJsZVhmYSwKICAgIGV2YWx1YXRvck9wdGlvbnM6IHsKICAgICAgbWF4SW1hZ2VTaXplLAogICAgICBkaXNhYmxlRm9udEZhY2UsCiAgICAgIGlnbm9yZUVycm9ycywKICAgICAgaXNFdmFsU3VwcG9ydGVkOiBpc0V2YWxTdXBwb3J0ZWQyLAogICAgICBpc09mZnNjcmVlbkNhbnZhc1N1cHBvcnRlZCwKICAgICAgaXNJbWFnZURlY29kZXJTdXBwb3J0ZWQsCiAgICAgIGNhbnZhc01heEFyZWFJbkJ5dGVzLAogICAgICBmb250RXh0cmFQcm9wZXJ0aWVzLAogICAgICB1c2VTeXN0ZW1Gb250cywKICAgICAgdXNlV2FzbSwKICAgICAgdXNlV29ya2VyRmV0Y2gsCiAgICAgIGNNYXBVcmwsCiAgICAgIGljY1VybCwKICAgICAgc3RhbmRhcmRGb250RGF0YVVybCwKICAgICAgd2FzbVVybAogICAgfQogIH07CiAgY29uc3QgdHJhbnNwb3J0UGFyYW1zID0gewogICAgb3duZXJEb2N1bWVudCwKICAgIHBkZkJ1ZywKICAgIHN0eWxlRWxlbWVudCwKICAgIGxvYWRpbmdQYXJhbXM6IHsKICAgICAgZGlzYWJsZUF1dG9GZXRjaCwKICAgICAgZW5hYmxlWGZhCiAgICB9CiAgfTsKICB3b3JrZXIucHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgewogICAgaWYgKHRhc2suZGVzdHJveWVkKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTG9hZGluZyBhYm9ydGVkIik7CiAgICB9CiAgICBpZiAod29ya2VyLmRlc3Ryb3llZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIldvcmtlciB3YXMgZGVzdHJveWVkIik7CiAgICB9CiAgICBjb25zdCB3b3JrZXJJZFByb21pc2UgPSB3b3JrZXIubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXREb2NSZXF1ZXN0IiwgZG9jUGFyYW1zLCBkYXRhID8gW2RhdGEuYnVmZmVyXSA6IG51bGwpOwogICAgbGV0IG5ldHdvcmtTdHJlYW07CiAgICBpZiAocmFuZ2VUcmFuc3BvcnQpIHsKICAgICAgbmV0d29ya1N0cmVhbSA9IG5ldyBQREZEYXRhVHJhbnNwb3J0U3RyZWFtKHJhbmdlVHJhbnNwb3J0LCB7CiAgICAgICAgZGlzYWJsZVJhbmdlLAogICAgICAgIGRpc2FibGVTdHJlYW0KICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKCFkYXRhKSB7CiAgICAgIGlmICghdXJsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJnZXREb2N1bWVudCAtIG5vIGB1cmxgIHBhcmFtZXRlciBwcm92aWRlZC4iKTsKICAgICAgfQogICAgICBjb25zdCBOZXR3b3JrU3RyZWFtID0gaXNWYWxpZEZldGNoVXJsKHVybCkgPyBQREZGZXRjaFN0cmVhbSA6IGlzTm9kZUpTID8gUERGTm9kZVN0cmVhbSA6IFBERk5ldHdvcmtTdHJlYW07CiAgICAgIG5ldHdvcmtTdHJlYW0gPSBuZXcgTmV0d29ya1N0cmVhbSh7CiAgICAgICAgdXJsLAogICAgICAgIGxlbmd0aCwKICAgICAgICBodHRwSGVhZGVycywKICAgICAgICB3aXRoQ3JlZGVudGlhbHMsCiAgICAgICAgcmFuZ2VDaHVua1NpemUsCiAgICAgICAgZGlzYWJsZVJhbmdlLAogICAgICAgIGRpc2FibGVTdHJlYW0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gd29ya2VySWRQcm9taXNlLnRoZW4oKHdvcmtlcklkKSA9PiB7CiAgICAgIGlmICh0YXNrLmRlc3Ryb3llZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiTG9hZGluZyBhYm9ydGVkIik7CiAgICAgIH0KICAgICAgaWYgKHdvcmtlci5kZXN0cm95ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldvcmtlciB3YXMgZGVzdHJveWVkIik7CiAgICAgIH0KICAgICAgY29uc3QgbWVzc2FnZUhhbmRsZXIgPSBuZXcgTWVzc2FnZUhhbmRsZXIoZG9jSWQsIHdvcmtlcklkLCB3b3JrZXIucG9ydCk7CiAgICAgIGNvbnN0IHRyYW5zcG9ydCA9IG5ldyBXb3JrZXJUcmFuc3BvcnQobWVzc2FnZUhhbmRsZXIsIHRhc2ssIG5ldHdvcmtTdHJlYW0sIHRyYW5zcG9ydFBhcmFtcywgdHJhbnNwb3J0RmFjdG9yeSwgZW5hYmxlSFdBKTsKICAgICAgdGFzay5fdHJhbnNwb3J0ID0gdHJhbnNwb3J0OwogICAgICBtZXNzYWdlSGFuZGxlci5zZW5kKCJSZWFkeSIsIG51bGwpOwogICAgfSk7CiAgfSkuY2F0Y2godGFzay5fY2FwYWJpbGl0eS5yZWplY3QpOwogIHJldHVybiB0YXNrOwp9CnZhciBQREZEb2N1bWVudExvYWRpbmdUYXNrID0gY2xhc3MgX1BERkRvY3VtZW50TG9hZGluZ1Rhc2sgewogIHN0YXRpYyAjZG9jSWQgPSAwOwogIF9jYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgX3RyYW5zcG9ydCA9IG51bGw7CiAgX3dvcmtlciA9IG51bGw7CiAgZG9jSWQgPSBgZCR7X1BERkRvY3VtZW50TG9hZGluZ1Rhc2suI2RvY0lkKyt9YDsKICBkZXN0cm95ZWQgPSBmYWxzZTsKICBvblBhc3N3b3JkID0gbnVsbDsKICBvblByb2dyZXNzID0gbnVsbDsKICBnZXQgcHJvbWlzZSgpIHsKICAgIHJldHVybiB0aGlzLl9jYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIGFzeW5jIGRlc3Ryb3koKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7CiAgICB0cnkgewogICAgICBpZiAodGhpcy5fd29ya2VyPy5wb3J0KSB7CiAgICAgICAgdGhpcy5fd29ya2VyLl9wZW5kaW5nRGVzdHJveSA9IHRydWU7CiAgICAgIH0KICAgICAgYXdhaXQgdGhpcy5fdHJhbnNwb3J0Py5kZXN0cm95KCk7CiAgICB9IGNhdGNoIChleCkgewogICAgICBpZiAodGhpcy5fd29ya2VyPy5wb3J0KSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3dvcmtlci5fcGVuZGluZ0Rlc3Ryb3k7CiAgICAgIH0KICAgICAgdGhyb3cgZXg7CiAgICB9CiAgICB0aGlzLl90cmFuc3BvcnQgPSBudWxsOwogICAgdGhpcy5fd29ya2VyPy5kZXN0cm95KCk7CiAgICB0aGlzLl93b3JrZXIgPSBudWxsOwogIH0KICBhc3luYyBnZXREYXRhKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXREYXRhKCk7CiAgfQp9Owp2YXIgUERGRGF0YVJhbmdlVHJhbnNwb3J0ID0gY2xhc3MgewogICNjYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgI3Byb2dyZXNzaXZlRG9uZUxpc3RlbmVycyA9IFtdOwogICNwcm9ncmVzc2l2ZVJlYWRMaXN0ZW5lcnMgPSBbXTsKICAjcHJvZ3Jlc3NMaXN0ZW5lcnMgPSBbXTsKICAjcmFuZ2VMaXN0ZW5lcnMgPSBbXTsKICBjb25zdHJ1Y3RvcihsZW5ndGgsIGluaXRpYWxEYXRhMiwgcHJvZ3Jlc3NpdmVEb25lID0gZmFsc2UsIGNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lID0gbnVsbCkgewogICAgdGhpcy5sZW5ndGggPSBsZW5ndGg7CiAgICB0aGlzLmluaXRpYWxEYXRhID0gaW5pdGlhbERhdGEyOwogICAgdGhpcy5wcm9ncmVzc2l2ZURvbmUgPSBwcm9ncmVzc2l2ZURvbmU7CiAgICB0aGlzLmNvbnRlbnREaXNwb3NpdGlvbkZpbGVuYW1lID0gY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWU7CiAgfQogIGFkZFJhbmdlTGlzdGVuZXIobGlzdGVuZXIpIHsKICAgIHRoaXMuI3JhbmdlTGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpOwogIH0KICBhZGRQcm9ncmVzc0xpc3RlbmVyKGxpc3RlbmVyKSB7CiAgICB0aGlzLiNwcm9ncmVzc0xpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKICB9CiAgYWRkUHJvZ3Jlc3NpdmVSZWFkTGlzdGVuZXIobGlzdGVuZXIpIHsKICAgIHRoaXMuI3Byb2dyZXNzaXZlUmVhZExpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKICB9CiAgYWRkUHJvZ3Jlc3NpdmVEb25lTGlzdGVuZXIobGlzdGVuZXIpIHsKICAgIHRoaXMuI3Byb2dyZXNzaXZlRG9uZUxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKICB9CiAgb25EYXRhUmFuZ2UoYmVnaW4sIGNodW5rKSB7CiAgICBmb3IgKGNvbnN0IGxpc3RlbmVyIG9mIHRoaXMuI3JhbmdlTGlzdGVuZXJzKSB7CiAgICAgIGxpc3RlbmVyKGJlZ2luLCBjaHVuayk7CiAgICB9CiAgfQogIG9uRGF0YVByb2dyZXNzKGxvYWRlZCwgdG90YWwpIHsKICAgIHRoaXMuI2NhcGFiaWxpdHkucHJvbWlzZS50aGVuKCgpID0+IHsKICAgICAgZm9yIChjb25zdCBsaXN0ZW5lciBvZiB0aGlzLiNwcm9ncmVzc0xpc3RlbmVycykgewogICAgICAgIGxpc3RlbmVyKGxvYWRlZCwgdG90YWwpOwogICAgICB9CiAgICB9KTsKICB9CiAgb25EYXRhUHJvZ3Jlc3NpdmVSZWFkKGNodW5rKSB7CiAgICB0aGlzLiNjYXBhYmlsaXR5LnByb21pc2UudGhlbigoKSA9PiB7CiAgICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgdGhpcy4jcHJvZ3Jlc3NpdmVSZWFkTGlzdGVuZXJzKSB7CiAgICAgICAgbGlzdGVuZXIoY2h1bmspOwogICAgICB9CiAgICB9KTsKICB9CiAgb25EYXRhUHJvZ3Jlc3NpdmVEb25lKCkgewogICAgdGhpcy4jY2FwYWJpbGl0eS5wcm9taXNlLnRoZW4oKCkgPT4gewogICAgICBmb3IgKGNvbnN0IGxpc3RlbmVyIG9mIHRoaXMuI3Byb2dyZXNzaXZlRG9uZUxpc3RlbmVycykgewogICAgICAgIGxpc3RlbmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH0KICB0cmFuc3BvcnRSZWFkeSgpIHsKICAgIHRoaXMuI2NhcGFiaWxpdHkucmVzb2x2ZSgpOwogIH0KICByZXF1ZXN0RGF0YVJhbmdlKGJlZ2luLCBlbmQpIHsKICAgIHVucmVhY2hhYmxlKCJBYnN0cmFjdCBtZXRob2QgUERGRGF0YVJhbmdlVHJhbnNwb3J0LnJlcXVlc3REYXRhUmFuZ2UiKTsKICB9CiAgYWJvcnQoKSB7CiAgfQp9Owp2YXIgUERGRG9jdW1lbnRQcm94eSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihwZGZJbmZvLCB0cmFuc3BvcnQpIHsKICAgIHRoaXMuX3BkZkluZm8gPSBwZGZJbmZvOwogICAgdGhpcy5fdHJhbnNwb3J0ID0gdHJhbnNwb3J0OwogIH0KICBnZXQgYW5ub3RhdGlvblN0b3JhZ2UoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmFubm90YXRpb25TdG9yYWdlOwogIH0KICBnZXQgY2FudmFzRmFjdG9yeSgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuY2FudmFzRmFjdG9yeTsKICB9CiAgZ2V0IGZpbHRlckZhY3RvcnkoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmZpbHRlckZhY3Rvcnk7CiAgfQogIGdldCBudW1QYWdlcygpIHsKICAgIHJldHVybiB0aGlzLl9wZGZJbmZvLm51bVBhZ2VzOwogIH0KICBnZXQgZmluZ2VycHJpbnRzKCkgewogICAgcmV0dXJuIHRoaXMuX3BkZkluZm8uZmluZ2VycHJpbnRzOwogIH0KICBnZXQgaXNQdXJlWGZhKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiaXNQdXJlWGZhIiwgISF0aGlzLl90cmFuc3BvcnQuX2h0bWxGb3JYZmEpOwogIH0KICBnZXQgYWxsWGZhSHRtbCgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuX2h0bWxGb3JYZmE7CiAgfQogIGdldFBhZ2UocGFnZU51bWJlcikgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRQYWdlKHBhZ2VOdW1iZXIpOwogIH0KICBnZXRQYWdlSW5kZXgocmVmKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldFBhZ2VJbmRleChyZWYpOwogIH0KICBnZXREZXN0aW5hdGlvbnMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldERlc3RpbmF0aW9ucygpOwogIH0KICBnZXREZXN0aW5hdGlvbihpZCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXREZXN0aW5hdGlvbihpZCk7CiAgfQogIGdldFBhZ2VMYWJlbHMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldFBhZ2VMYWJlbHMoKTsKICB9CiAgZ2V0UGFnZUxheW91dCgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0UGFnZUxheW91dCgpOwogIH0KICBnZXRQYWdlTW9kZSgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0UGFnZU1vZGUoKTsKICB9CiAgZ2V0Vmlld2VyUHJlZmVyZW5jZXMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldFZpZXdlclByZWZlcmVuY2VzKCk7CiAgfQogIGdldE9wZW5BY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldE9wZW5BY3Rpb24oKTsKICB9CiAgZ2V0QXR0YWNobWVudHMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldEF0dGFjaG1lbnRzKCk7CiAgfQogIGdldEFubm90YXRpb25zQnlUeXBlKHR5cGVzLCBwYWdlSW5kZXhlc1RvU2tpcCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRBbm5vdGF0aW9uc0J5VHlwZSh0eXBlcywgcGFnZUluZGV4ZXNUb1NraXApOwogIH0KICBnZXRKU0FjdGlvbnMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldERvY0pTQWN0aW9ucygpOwogIH0KICBnZXRPdXRsaW5lKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRPdXRsaW5lKCk7CiAgfQogIGdldE9wdGlvbmFsQ29udGVudENvbmZpZyh7CiAgICBpbnRlbnQgPSAiZGlzcGxheSIKICB9ID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgcmVuZGVyaW5nSW50ZW50CiAgICB9ID0gdGhpcy5fdHJhbnNwb3J0LmdldFJlbmRlcmluZ0ludGVudChpbnRlbnQpOwogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRPcHRpb25hbENvbnRlbnRDb25maWcocmVuZGVyaW5nSW50ZW50KTsKICB9CiAgZ2V0UGVybWlzc2lvbnMoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmdldFBlcm1pc3Npb25zKCk7CiAgfQogIGdldE1ldGFkYXRhKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRNZXRhZGF0YSgpOwogIH0KICBnZXRNYXJrSW5mbygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0TWFya0luZm8oKTsKICB9CiAgZ2V0RGF0YSgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0RGF0YSgpOwogIH0KICBzYXZlRG9jdW1lbnQoKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LnNhdmVEb2N1bWVudCgpOwogIH0KICBleHRyYWN0UGFnZXMocGFnZUluZm9zKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmV4dHJhY3RQYWdlcyhwYWdlSW5mb3MpOwogIH0KICBnZXREb3dubG9hZEluZm8oKSB7CiAgICByZXR1cm4gdGhpcy5fdHJhbnNwb3J0LmRvd25sb2FkSW5mb0NhcGFiaWxpdHkucHJvbWlzZTsKICB9CiAgY2xlYW51cChrZWVwTG9hZGVkRm9udHMgPSBmYWxzZSkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5zdGFydENsZWFudXAoa2VlcExvYWRlZEZvbnRzIHx8IHRoaXMuaXNQdXJlWGZhKTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHJldHVybiB0aGlzLmxvYWRpbmdUYXNrLmRlc3Ryb3koKTsKICB9CiAgY2FjaGVkUGFnZU51bWJlcihyZWYpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuY2FjaGVkUGFnZU51bWJlcihyZWYpOwogIH0KICBnZXQgbG9hZGluZ1BhcmFtcygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQubG9hZGluZ1BhcmFtczsKICB9CiAgZ2V0IGxvYWRpbmdUYXNrKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5sb2FkaW5nVGFzazsKICB9CiAgZ2V0RmllbGRPYmplY3RzKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRGaWVsZE9iamVjdHMoKTsKICB9CiAgaGFzSlNBY3Rpb25zKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5oYXNKU0FjdGlvbnMoKTsKICB9CiAgZ2V0Q2FsY3VsYXRpb25PcmRlcklkcygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0Q2FsY3VsYXRpb25PcmRlcklkcygpOwogIH0KfTsKdmFyIFBERlBhZ2VQcm94eSA9IGNsYXNzIHsKICAjcGVuZGluZ0NsZWFudXAgPSBmYWxzZTsKICBjb25zdHJ1Y3RvcihwYWdlSW5kZXgsIHBhZ2VJbmZvLCB0cmFuc3BvcnQsIHBkZkJ1ZyA9IGZhbHNlKSB7CiAgICB0aGlzLl9wYWdlSW5kZXggPSBwYWdlSW5kZXg7CiAgICB0aGlzLl9wYWdlSW5mbyA9IHBhZ2VJbmZvOwogICAgdGhpcy5fdHJhbnNwb3J0ID0gdHJhbnNwb3J0OwogICAgdGhpcy5fc3RhdHMgPSBwZGZCdWcgPyBuZXcgU3RhdFRpbWVyKCkgOiBudWxsOwogICAgdGhpcy5fcGRmQnVnID0gcGRmQnVnOwogICAgdGhpcy5jb21tb25PYmpzID0gdHJhbnNwb3J0LmNvbW1vbk9ianM7CiAgICB0aGlzLm9ianMgPSBuZXcgUERGT2JqZWN0cygpOwogICAgdGhpcy5faW50ZW50U3RhdGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHRoaXMuZGVzdHJveWVkID0gZmFsc2U7CiAgICB0aGlzLnJlY29yZGVkQkJveGVzID0gbnVsbDsKICB9CiAgZ2V0IHBhZ2VOdW1iZXIoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFnZUluZGV4ICsgMTsKICB9CiAgZ2V0IHJvdGF0ZSgpIHsKICAgIHJldHVybiB0aGlzLl9wYWdlSW5mby5yb3RhdGU7CiAgfQogIGdldCByZWYoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFnZUluZm8ucmVmOwogIH0KICBnZXQgdXNlclVuaXQoKSB7CiAgICByZXR1cm4gdGhpcy5fcGFnZUluZm8udXNlclVuaXQ7CiAgfQogIGdldCB2aWV3KCkgewogICAgcmV0dXJuIHRoaXMuX3BhZ2VJbmZvLnZpZXc7CiAgfQogIGdldFZpZXdwb3J0KHsKICAgIHNjYWxlLAogICAgcm90YXRpb24gPSB0aGlzLnJvdGF0ZSwKICAgIG9mZnNldFggPSAwLAogICAgb2Zmc2V0WSA9IDAsCiAgICBkb250RmxpcCA9IGZhbHNlCiAgfSA9IHt9KSB7CiAgICByZXR1cm4gbmV3IFBhZ2VWaWV3cG9ydCh7CiAgICAgIHZpZXdCb3g6IHRoaXMudmlldywKICAgICAgdXNlclVuaXQ6IHRoaXMudXNlclVuaXQsCiAgICAgIHNjYWxlLAogICAgICByb3RhdGlvbiwKICAgICAgb2Zmc2V0WCwKICAgICAgb2Zmc2V0WSwKICAgICAgZG9udEZsaXAKICAgIH0pOwogIH0KICBnZXRBbm5vdGF0aW9ucyh7CiAgICBpbnRlbnQgPSAiZGlzcGxheSIKICB9ID0ge30pIHsKICAgIGNvbnN0IHsKICAgICAgcmVuZGVyaW5nSW50ZW50CiAgICB9ID0gdGhpcy5fdHJhbnNwb3J0LmdldFJlbmRlcmluZ0ludGVudChpbnRlbnQpOwogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRBbm5vdGF0aW9ucyh0aGlzLl9wYWdlSW5kZXgsIHJlbmRlcmluZ0ludGVudCk7CiAgfQogIGdldEpTQWN0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZ2V0UGFnZUpTQWN0aW9ucyh0aGlzLl9wYWdlSW5kZXgpOwogIH0KICBnZXQgZmlsdGVyRmFjdG9yeSgpIHsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQuZmlsdGVyRmFjdG9yeTsKICB9CiAgZ2V0IGlzUHVyZVhmYSgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImlzUHVyZVhmYSIsICEhdGhpcy5fdHJhbnNwb3J0Ll9odG1sRm9yWGZhKTsKICB9CiAgYXN5bmMgZ2V0WGZhKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5faHRtbEZvclhmYT8uY2hpbGRyZW5bdGhpcy5fcGFnZUluZGV4XSB8fCBudWxsOwogIH0KICByZW5kZXIoewogICAgY2FudmFzQ29udGV4dCwKICAgIGNhbnZhcyA9IGNhbnZhc0NvbnRleHQuY2FudmFzLAogICAgdmlld3BvcnQsCiAgICBpbnRlbnQgPSAiZGlzcGxheSIsCiAgICBhbm5vdGF0aW9uTW9kZSA9IEFubm90YXRpb25Nb2RlLkVOQUJMRSwKICAgIHRyYW5zZm9ybSA9IG51bGwsCiAgICBiYWNrZ3JvdW5kID0gbnVsbCwKICAgIG9wdGlvbmFsQ29udGVudENvbmZpZ1Byb21pc2UgPSBudWxsLAogICAgYW5ub3RhdGlvbkNhbnZhc01hcCA9IG51bGwsCiAgICBwYWdlQ29sb3JzID0gbnVsbCwKICAgIHByaW50QW5ub3RhdGlvblN0b3JhZ2UgPSBudWxsLAogICAgaXNFZGl0aW5nID0gZmFsc2UsCiAgICByZWNvcmRPcGVyYXRpb25zID0gZmFsc2UsCiAgICBvcGVyYXRpb25zRmlsdGVyID0gbnVsbAogIH0pIHsKICAgIHRoaXMuX3N0YXRzPy50aW1lKCJPdmVyYWxsIik7CiAgICBjb25zdCBpbnRlbnRBcmdzID0gdGhpcy5fdHJhbnNwb3J0LmdldFJlbmRlcmluZ0ludGVudChpbnRlbnQsIGFubm90YXRpb25Nb2RlLCBwcmludEFubm90YXRpb25TdG9yYWdlLCBpc0VkaXRpbmcpOwogICAgY29uc3QgewogICAgICByZW5kZXJpbmdJbnRlbnQsCiAgICAgIGNhY2hlS2V5CiAgICB9ID0gaW50ZW50QXJnczsKICAgIHRoaXMuI3BlbmRpbmdDbGVhbnVwID0gZmFsc2U7CiAgICBvcHRpb25hbENvbnRlbnRDb25maWdQcm9taXNlIHx8PSB0aGlzLl90cmFuc3BvcnQuZ2V0T3B0aW9uYWxDb250ZW50Q29uZmlnKHJlbmRlcmluZ0ludGVudCk7CiAgICBsZXQgaW50ZW50U3RhdGUgPSB0aGlzLl9pbnRlbnRTdGF0ZXMuZ2V0KGNhY2hlS2V5KTsKICAgIGlmICghaW50ZW50U3RhdGUpIHsKICAgICAgaW50ZW50U3RhdGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgdGhpcy5faW50ZW50U3RhdGVzLnNldChjYWNoZUtleSwgaW50ZW50U3RhdGUpOwogICAgfQogICAgaWYgKGludGVudFN0YXRlLnN0cmVhbVJlYWRlckNhbmNlbFRpbWVvdXQpIHsKICAgICAgY2xlYXJUaW1lb3V0KGludGVudFN0YXRlLnN0cmVhbVJlYWRlckNhbmNlbFRpbWVvdXQpOwogICAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXJDYW5jZWxUaW1lb3V0ID0gbnVsbDsKICAgIH0KICAgIGNvbnN0IGludGVudFByaW50ID0gISEocmVuZGVyaW5nSW50ZW50ICYgUmVuZGVyaW5nSW50ZW50RmxhZy5QUklOVCk7CiAgICBpZiAoIWludGVudFN0YXRlLmRpc3BsYXlSZWFkeUNhcGFiaWxpdHkpIHsKICAgICAgaW50ZW50U3RhdGUuZGlzcGxheVJlYWR5Q2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICAgICBpbnRlbnRTdGF0ZS5vcGVyYXRvckxpc3QgPSB7CiAgICAgICAgZm5BcnJheTogW10sCiAgICAgICAgYXJnc0FycmF5OiBbXSwKICAgICAgICBsYXN0Q2h1bms6IGZhbHNlLAogICAgICAgIHNlcGFyYXRlQW5ub3RzOiBudWxsCiAgICAgIH07CiAgICAgIHRoaXMuX3N0YXRzPy50aW1lKCJQYWdlIFJlcXVlc3QiKTsKICAgICAgdGhpcy5fcHVtcE9wZXJhdG9yTGlzdChpbnRlbnRBcmdzKTsKICAgIH0KICAgIGNvbnN0IHJlY29yZEZvckRlYnVnZ2VyID0gQm9vbGVhbih0aGlzLl9wZGZCdWcgJiYgZ2xvYmFsVGhpcy5TdGVwcGVyTWFuYWdlcj8uZW5hYmxlZCk7CiAgICBjb25zdCBzaG91bGRSZWNvcmRPcGVyYXRpb25zID0gIXRoaXMucmVjb3JkZWRCQm94ZXMgJiYgKHJlY29yZE9wZXJhdGlvbnMgfHwgcmVjb3JkRm9yRGVidWdnZXIpOwogICAgY29uc3QgY29tcGxldGUgPSAoZXJyb3IpID0+IHsKICAgICAgaW50ZW50U3RhdGUucmVuZGVyVGFza3MuZGVsZXRlKGludGVybmFsUmVuZGVyVGFzayk7CiAgICAgIGlmIChzaG91bGRSZWNvcmRPcGVyYXRpb25zKSB7CiAgICAgICAgY29uc3QgcmVjb3JkZWRCQm94ZXMgPSBpbnRlcm5hbFJlbmRlclRhc2suZ2Z4Py5kZXBlbmRlbmN5VHJhY2tlci50YWtlKCk7CiAgICAgICAgaWYgKHJlY29yZGVkQkJveGVzKSB7CiAgICAgICAgICBpZiAoaW50ZXJuYWxSZW5kZXJUYXNrLnN0ZXBwZXIpIHsKICAgICAgICAgICAgaW50ZXJuYWxSZW5kZXJUYXNrLnN0ZXBwZXIuc2V0T3BlcmF0b3JCQm94ZXMocmVjb3JkZWRCQm94ZXMsIGludGVybmFsUmVuZGVyVGFzay5nZnguZGVwZW5kZW5jeVRyYWNrZXIudGFrZURlYnVnTWV0YWRhdGEoKSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVjb3JkT3BlcmF0aW9ucykgewogICAgICAgICAgICB0aGlzLnJlY29yZGVkQkJveGVzID0gcmVjb3JkZWRCQm94ZXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpbnRlbnRQcmludCkgewogICAgICAgIHRoaXMuI3BlbmRpbmdDbGVhbnVwID0gdHJ1ZTsKICAgICAgfQogICAgICB0aGlzLiN0cnlDbGVhbnVwKCk7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIGludGVybmFsUmVuZGVyVGFzay5jYXBhYmlsaXR5LnJlamVjdChlcnJvcik7CiAgICAgICAgdGhpcy5fYWJvcnRPcGVyYXRvckxpc3QoewogICAgICAgICAgaW50ZW50U3RhdGUsCiAgICAgICAgICByZWFzb246IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihlcnJvcikKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnRlcm5hbFJlbmRlclRhc2suY2FwYWJpbGl0eS5yZXNvbHZlKCk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuX3N0YXRzKSB7CiAgICAgICAgdGhpcy5fc3RhdHMudGltZUVuZCgiUmVuZGVyaW5nIik7CiAgICAgICAgdGhpcy5fc3RhdHMudGltZUVuZCgiT3ZlcmFsbCIpOwogICAgICAgIGlmIChnbG9iYWxUaGlzLlN0YXRzPy5lbmFibGVkKSB7CiAgICAgICAgICBnbG9iYWxUaGlzLlN0YXRzLmFkZCh0aGlzLnBhZ2VOdW1iZXIsIHRoaXMuX3N0YXRzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBpbnRlcm5hbFJlbmRlclRhc2sgPSBuZXcgSW50ZXJuYWxSZW5kZXJUYXNrKHsKICAgICAgY2FsbGJhY2s6IGNvbXBsZXRlLAogICAgICBwYXJhbXM6IHsKICAgICAgICBjYW52YXMsCiAgICAgICAgY2FudmFzQ29udGV4dCwKICAgICAgICBkZXBlbmRlbmN5VHJhY2tlcjogc2hvdWxkUmVjb3JkT3BlcmF0aW9ucyA/IG5ldyBDYW52YXNEZXBlbmRlbmN5VHJhY2tlcihjYW52YXMsIGludGVudFN0YXRlLm9wZXJhdG9yTGlzdC5sZW5ndGgsIHJlY29yZEZvckRlYnVnZ2VyKSA6IG51bGwsCiAgICAgICAgdmlld3BvcnQsCiAgICAgICAgdHJhbnNmb3JtLAogICAgICAgIGJhY2tncm91bmQKICAgICAgfSwKICAgICAgb2JqczogdGhpcy5vYmpzLAogICAgICBjb21tb25PYmpzOiB0aGlzLmNvbW1vbk9ianMsCiAgICAgIGFubm90YXRpb25DYW52YXNNYXAsCiAgICAgIG9wZXJhdG9yTGlzdDogaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0LAogICAgICBwYWdlSW5kZXg6IHRoaXMuX3BhZ2VJbmRleCwKICAgICAgY2FudmFzRmFjdG9yeTogdGhpcy5fdHJhbnNwb3J0LmNhbnZhc0ZhY3RvcnksCiAgICAgIGZpbHRlckZhY3Rvcnk6IHRoaXMuX3RyYW5zcG9ydC5maWx0ZXJGYWN0b3J5LAogICAgICB1c2VSZXF1ZXN0QW5pbWF0aW9uRnJhbWU6ICFpbnRlbnRQcmludCwKICAgICAgcGRmQnVnOiB0aGlzLl9wZGZCdWcsCiAgICAgIHBhZ2VDb2xvcnMsCiAgICAgIGVuYWJsZUhXQTogdGhpcy5fdHJhbnNwb3J0LmVuYWJsZUhXQSwKICAgICAgb3BlcmF0aW9uc0ZpbHRlcgogICAgfSk7CiAgICAoaW50ZW50U3RhdGUucmVuZGVyVGFza3MgfHw9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkpLmFkZChpbnRlcm5hbFJlbmRlclRhc2spOwogICAgY29uc3QgcmVuZGVyVGFzayA9IGludGVybmFsUmVuZGVyVGFzay50YXNrOwogICAgUHJvbWlzZS5hbGwoW2ludGVudFN0YXRlLmRpc3BsYXlSZWFkeUNhcGFiaWxpdHkucHJvbWlzZSwgb3B0aW9uYWxDb250ZW50Q29uZmlnUHJvbWlzZV0pLnRoZW4oKFt0cmFuc3BhcmVuY3ksIG9wdGlvbmFsQ29udGVudENvbmZpZ10pID0+IHsKICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgY29tcGxldGUoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcy5fc3RhdHM/LnRpbWUoIlJlbmRlcmluZyIpOwogICAgICBpZiAoIShvcHRpb25hbENvbnRlbnRDb25maWcucmVuZGVyaW5nSW50ZW50ICYgcmVuZGVyaW5nSW50ZW50KSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiTXVzdCB1c2UgdGhlIHNhbWUgYGludGVudGAtYXJndW1lbnQgd2hlbiBjYWxsaW5nIHRoZSBgUERGUGFnZVByb3h5LnJlbmRlcmAgYW5kIGBQREZEb2N1bWVudFByb3h5LmdldE9wdGlvbmFsQ29udGVudENvbmZpZ2AgbWV0aG9kcy4iKTsKICAgICAgfQogICAgICBpbnRlcm5hbFJlbmRlclRhc2suaW5pdGlhbGl6ZUdyYXBoaWNzKHsKICAgICAgICB0cmFuc3BhcmVuY3ksCiAgICAgICAgb3B0aW9uYWxDb250ZW50Q29uZmlnCiAgICAgIH0pOwogICAgICBpbnRlcm5hbFJlbmRlclRhc2sub3BlcmF0b3JMaXN0Q2hhbmdlZCgpOwogICAgfSkuY2F0Y2goY29tcGxldGUpOwogICAgcmV0dXJuIHJlbmRlclRhc2s7CiAgfQogIGdldE9wZXJhdG9yTGlzdCh7CiAgICBpbnRlbnQgPSAiZGlzcGxheSIsCiAgICBhbm5vdGF0aW9uTW9kZSA9IEFubm90YXRpb25Nb2RlLkVOQUJMRSwKICAgIHByaW50QW5ub3RhdGlvblN0b3JhZ2UgPSBudWxsLAogICAgaXNFZGl0aW5nID0gZmFsc2UKICB9ID0ge30pIHsKICAgIGZ1bmN0aW9uIG9wZXJhdG9yTGlzdENoYW5nZWQoKSB7CiAgICAgIGlmIChpbnRlbnRTdGF0ZS5vcGVyYXRvckxpc3QubGFzdENodW5rKSB7CiAgICAgICAgaW50ZW50U3RhdGUub3BMaXN0UmVhZENhcGFiaWxpdHkucmVzb2x2ZShpbnRlbnRTdGF0ZS5vcGVyYXRvckxpc3QpOwogICAgICAgIGludGVudFN0YXRlLnJlbmRlclRhc2tzLmRlbGV0ZShvcExpc3RUYXNrKTsKICAgICAgfQogICAgfQogICAgY29uc3QgaW50ZW50QXJncyA9IHRoaXMuX3RyYW5zcG9ydC5nZXRSZW5kZXJpbmdJbnRlbnQoaW50ZW50LCBhbm5vdGF0aW9uTW9kZSwgcHJpbnRBbm5vdGF0aW9uU3RvcmFnZSwgaXNFZGl0aW5nLCB0cnVlKTsKICAgIGxldCBpbnRlbnRTdGF0ZSA9IHRoaXMuX2ludGVudFN0YXRlcy5nZXQoaW50ZW50QXJncy5jYWNoZUtleSk7CiAgICBpZiAoIWludGVudFN0YXRlKSB7CiAgICAgIGludGVudFN0YXRlID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHRoaXMuX2ludGVudFN0YXRlcy5zZXQoaW50ZW50QXJncy5jYWNoZUtleSwgaW50ZW50U3RhdGUpOwogICAgfQogICAgbGV0IG9wTGlzdFRhc2s7CiAgICBpZiAoIWludGVudFN0YXRlLm9wTGlzdFJlYWRDYXBhYmlsaXR5KSB7CiAgICAgIG9wTGlzdFRhc2sgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgb3BMaXN0VGFzay5vcGVyYXRvckxpc3RDaGFuZ2VkID0gb3BlcmF0b3JMaXN0Q2hhbmdlZDsKICAgICAgaW50ZW50U3RhdGUub3BMaXN0UmVhZENhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgICAgKGludGVudFN0YXRlLnJlbmRlclRhc2tzIHx8PSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKS5hZGQob3BMaXN0VGFzayk7CiAgICAgIGludGVudFN0YXRlLm9wZXJhdG9yTGlzdCA9IHsKICAgICAgICBmbkFycmF5OiBbXSwKICAgICAgICBhcmdzQXJyYXk6IFtdLAogICAgICAgIGxhc3RDaHVuazogZmFsc2UsCiAgICAgICAgc2VwYXJhdGVBbm5vdHM6IG51bGwKICAgICAgfTsKICAgICAgdGhpcy5fc3RhdHM/LnRpbWUoIlBhZ2UgUmVxdWVzdCIpOwogICAgICB0aGlzLl9wdW1wT3BlcmF0b3JMaXN0KGludGVudEFyZ3MpOwogICAgfQogICAgcmV0dXJuIGludGVudFN0YXRlLm9wTGlzdFJlYWRDYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIHN0cmVhbVRleHRDb250ZW50KHsKICAgIGluY2x1ZGVNYXJrZWRDb250ZW50ID0gZmFsc2UsCiAgICBkaXNhYmxlTm9ybWFsaXphdGlvbiA9IGZhbHNlCiAgfSA9IHt9KSB7CiAgICBjb25zdCBURVhUX0NPTlRFTlRfQ0hVTktfU0laRSA9IDEwMDsKICAgIHJldHVybiB0aGlzLl90cmFuc3BvcnQubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhTdHJlYW0oIkdldFRleHRDb250ZW50IiwgewogICAgICBwYWdlSW5kZXg6IHRoaXMuX3BhZ2VJbmRleCwKICAgICAgaW5jbHVkZU1hcmtlZENvbnRlbnQ6IGluY2x1ZGVNYXJrZWRDb250ZW50ID09PSB0cnVlLAogICAgICBkaXNhYmxlTm9ybWFsaXphdGlvbjogZGlzYWJsZU5vcm1hbGl6YXRpb24gPT09IHRydWUKICAgIH0sIHsKICAgICAgaGlnaFdhdGVyTWFyazogVEVYVF9DT05URU5UX0NIVU5LX1NJWkUsCiAgICAgIHNpemUodGV4dENvbnRlbnQpIHsKICAgICAgICByZXR1cm4gdGV4dENvbnRlbnQuaXRlbXMubGVuZ3RoOwogICAgICB9CiAgICB9KTsKICB9CiAgZ2V0VGV4dENvbnRlbnQocGFyYW1zID0ge30pIHsKICAgIGlmICh0aGlzLl90cmFuc3BvcnQuX2h0bWxGb3JYZmEpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0WGZhKCkudGhlbigoeGZhKSA9PiBYZmFUZXh0LnRleHRDb250ZW50KHhmYSkpOwogICAgfQogICAgY29uc3QgcmVhZGFibGVTdHJlYW0gPSB0aGlzLnN0cmVhbVRleHRDb250ZW50KHBhcmFtcyk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIHB1bXAoKSB7CiAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uKHsKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgZG9uZQogICAgICAgIH0pIHsKICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgIHJlc29sdmUodGV4dENvbnRlbnQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0ZXh0Q29udGVudC5sYW5nID8/PSB2YWx1ZS5sYW5nOwogICAgICAgICAgT2JqZWN0LmFzc2lnbih0ZXh0Q29udGVudC5zdHlsZXMsIHZhbHVlLnN0eWxlcyk7CiAgICAgICAgICB0ZXh0Q29udGVudC5pdGVtcy5wdXNoKC4uLnZhbHVlLml0ZW1zKTsKICAgICAgICAgIHB1bXAoKTsKICAgICAgICB9LCByZWplY3QpOwogICAgICB9CiAgICAgIGNvbnN0IHJlYWRlciA9IHJlYWRhYmxlU3RyZWFtLmdldFJlYWRlcigpOwogICAgICBjb25zdCB0ZXh0Q29udGVudCA9IHsKICAgICAgICBpdGVtczogW10sCiAgICAgICAgc3R5bGVzOiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKSwKICAgICAgICBsYW5nOiBudWxsCiAgICAgIH07CiAgICAgIHB1bXAoKTsKICAgIH0pOwogIH0KICBnZXRTdHJ1Y3RUcmVlKCkgewogICAgcmV0dXJuIHRoaXMuX3RyYW5zcG9ydC5nZXRTdHJ1Y3RUcmVlKHRoaXMuX3BhZ2VJbmRleCk7CiAgfQogIF9kZXN0cm95KCkgewogICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlOwogICAgY29uc3Qgd2FpdE9uID0gW107CiAgICBmb3IgKGNvbnN0IGludGVudFN0YXRlIG9mIHRoaXMuX2ludGVudFN0YXRlcy52YWx1ZXMoKSkgewogICAgICB0aGlzLl9hYm9ydE9wZXJhdG9yTGlzdCh7CiAgICAgICAgaW50ZW50U3RhdGUsCiAgICAgICAgcmVhc29uOiBuZXcgRXJyb3IoIlBhZ2Ugd2FzIGRlc3Ryb3llZC4iKSwKICAgICAgICBmb3JjZTogdHJ1ZQogICAgICB9KTsKICAgICAgaWYgKGludGVudFN0YXRlLm9wTGlzdFJlYWRDYXBhYmlsaXR5KSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgZm9yIChjb25zdCBpbnRlcm5hbFJlbmRlclRhc2sgb2YgaW50ZW50U3RhdGUucmVuZGVyVGFza3MpIHsKICAgICAgICB3YWl0T24ucHVzaChpbnRlcm5hbFJlbmRlclRhc2suY29tcGxldGVkKTsKICAgICAgICBpbnRlcm5hbFJlbmRlclRhc2suY2FuY2VsKCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMub2Jqcy5jbGVhcigpOwogICAgdGhpcy4jcGVuZGluZ0NsZWFudXAgPSBmYWxzZTsKICAgIHJldHVybiBQcm9taXNlLmFsbCh3YWl0T24pOwogIH0KICBjbGVhbnVwKHJlc2V0U3RhdHMgPSBmYWxzZSkgewogICAgdGhpcy4jcGVuZGluZ0NsZWFudXAgPSB0cnVlOwogICAgY29uc3Qgc3VjY2VzcyA9IHRoaXMuI3RyeUNsZWFudXAoKTsKICAgIGlmIChyZXNldFN0YXRzICYmIHN1Y2Nlc3MpIHsKICAgICAgdGhpcy5fc3RhdHMgJiY9IG5ldyBTdGF0VGltZXIoKTsKICAgIH0KICAgIHJldHVybiBzdWNjZXNzOwogIH0KICAjdHJ5Q2xlYW51cCgpIHsKICAgIGlmICghdGhpcy4jcGVuZGluZ0NsZWFudXAgfHwgdGhpcy5kZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZm9yIChjb25zdCB7CiAgICAgIHJlbmRlclRhc2tzLAogICAgICBvcGVyYXRvckxpc3QKICAgIH0gb2YgdGhpcy5faW50ZW50U3RhdGVzLnZhbHVlcygpKSB7CiAgICAgIGlmIChyZW5kZXJUYXNrcy5zaXplID4gMCB8fCAhb3BlcmF0b3JMaXN0Lmxhc3RDaHVuaykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgdGhpcy5faW50ZW50U3RhdGVzLmNsZWFyKCk7CiAgICB0aGlzLm9ianMuY2xlYXIoKTsKICAgIHRoaXMuI3BlbmRpbmdDbGVhbnVwID0gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgX3N0YXJ0UmVuZGVyUGFnZSh0cmFuc3BhcmVuY3ksIGNhY2hlS2V5KSB7CiAgICBjb25zdCBpbnRlbnRTdGF0ZSA9IHRoaXMuX2ludGVudFN0YXRlcy5nZXQoY2FjaGVLZXkpOwogICAgaWYgKCFpbnRlbnRTdGF0ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9zdGF0cz8udGltZUVuZCgiUGFnZSBSZXF1ZXN0Iik7CiAgICBpbnRlbnRTdGF0ZS5kaXNwbGF5UmVhZHlDYXBhYmlsaXR5Py5yZXNvbHZlKHRyYW5zcGFyZW5jeSk7CiAgfQogIF9yZW5kZXJQYWdlQ2h1bmsob3BlcmF0b3JMaXN0Q2h1bmssIGludGVudFN0YXRlKSB7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBvcGVyYXRvckxpc3RDaHVuay5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgIGludGVudFN0YXRlLm9wZXJhdG9yTGlzdC5mbkFycmF5LnB1c2gob3BlcmF0b3JMaXN0Q2h1bmsuZm5BcnJheVtpXSk7CiAgICAgIGludGVudFN0YXRlLm9wZXJhdG9yTGlzdC5hcmdzQXJyYXkucHVzaChvcGVyYXRvckxpc3RDaHVuay5hcmdzQXJyYXlbaV0pOwogICAgfQogICAgaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0Lmxhc3RDaHVuayA9IG9wZXJhdG9yTGlzdENodW5rLmxhc3RDaHVuazsKICAgIGludGVudFN0YXRlLm9wZXJhdG9yTGlzdC5zZXBhcmF0ZUFubm90cyA9IG9wZXJhdG9yTGlzdENodW5rLnNlcGFyYXRlQW5ub3RzOwogICAgZm9yIChjb25zdCBpbnRlcm5hbFJlbmRlclRhc2sgb2YgaW50ZW50U3RhdGUucmVuZGVyVGFza3MpIHsKICAgICAgaW50ZXJuYWxSZW5kZXJUYXNrLm9wZXJhdG9yTGlzdENoYW5nZWQoKTsKICAgIH0KICAgIGlmIChvcGVyYXRvckxpc3RDaHVuay5sYXN0Q2h1bmspIHsKICAgICAgdGhpcy4jdHJ5Q2xlYW51cCgpOwogICAgfQogIH0KICBfcHVtcE9wZXJhdG9yTGlzdCh7CiAgICByZW5kZXJpbmdJbnRlbnQsCiAgICBjYWNoZUtleSwKICAgIGFubm90YXRpb25TdG9yYWdlU2VyaWFsaXphYmxlLAogICAgbW9kaWZpZWRJZHMKICB9KSB7CiAgICBjb25zdCB7CiAgICAgIG1hcCwKICAgICAgdHJhbnNmZXIKICAgIH0gPSBhbm5vdGF0aW9uU3RvcmFnZVNlcmlhbGl6YWJsZTsKICAgIGNvbnN0IHJlYWRhYmxlU3RyZWFtID0gdGhpcy5fdHJhbnNwb3J0Lm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoU3RyZWFtKCJHZXRPcGVyYXRvckxpc3QiLCB7CiAgICAgIHBhZ2VJbmRleDogdGhpcy5fcGFnZUluZGV4LAogICAgICBpbnRlbnQ6IHJlbmRlcmluZ0ludGVudCwKICAgICAgY2FjaGVLZXksCiAgICAgIGFubm90YXRpb25TdG9yYWdlOiBtYXAsCiAgICAgIG1vZGlmaWVkSWRzCiAgICB9LCB0cmFuc2Zlcik7CiAgICBjb25zdCByZWFkZXIgPSByZWFkYWJsZVN0cmVhbS5nZXRSZWFkZXIoKTsKICAgIGNvbnN0IGludGVudFN0YXRlID0gdGhpcy5faW50ZW50U3RhdGVzLmdldChjYWNoZUtleSk7CiAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXIgPSByZWFkZXI7CiAgICBjb25zdCBwdW1wID0gKCkgPT4gewogICAgICByZWFkZXIucmVhZCgpLnRoZW4oKHsKICAgICAgICB2YWx1ZSwKICAgICAgICBkb25lCiAgICAgIH0pID0+IHsKICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyID0gbnVsbDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX3RyYW5zcG9ydC5kZXN0cm95ZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVuZGVyUGFnZUNodW5rKHZhbHVlLCBpbnRlbnRTdGF0ZSk7CiAgICAgICAgcHVtcCgpOwogICAgICB9LCAocmVhc29uKSA9PiB7CiAgICAgICAgaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyID0gbnVsbDsKICAgICAgICBpZiAodGhpcy5fdHJhbnNwb3J0LmRlc3Ryb3llZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaW50ZW50U3RhdGUub3BlcmF0b3JMaXN0KSB7CiAgICAgICAgICBpbnRlbnRTdGF0ZS5vcGVyYXRvckxpc3QubGFzdENodW5rID0gdHJ1ZTsKICAgICAgICAgIGZvciAoY29uc3QgaW50ZXJuYWxSZW5kZXJUYXNrIG9mIGludGVudFN0YXRlLnJlbmRlclRhc2tzKSB7CiAgICAgICAgICAgIGludGVybmFsUmVuZGVyVGFzay5vcGVyYXRvckxpc3RDaGFuZ2VkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLiN0cnlDbGVhbnVwKCk7CiAgICAgICAgfQogICAgICAgIGlmIChpbnRlbnRTdGF0ZS5kaXNwbGF5UmVhZHlDYXBhYmlsaXR5KSB7CiAgICAgICAgICBpbnRlbnRTdGF0ZS5kaXNwbGF5UmVhZHlDYXBhYmlsaXR5LnJlamVjdChyZWFzb24pOwogICAgICAgIH0gZWxzZSBpZiAoaW50ZW50U3RhdGUub3BMaXN0UmVhZENhcGFiaWxpdHkpIHsKICAgICAgICAgIGludGVudFN0YXRlLm9wTGlzdFJlYWRDYXBhYmlsaXR5LnJlamVjdChyZWFzb24pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyByZWFzb247CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgICBwdW1wKCk7CiAgfQogIF9hYm9ydE9wZXJhdG9yTGlzdCh7CiAgICBpbnRlbnRTdGF0ZSwKICAgIHJlYXNvbiwKICAgIGZvcmNlID0gZmFsc2UKICB9KSB7CiAgICBpZiAoIWludGVudFN0YXRlLnN0cmVhbVJlYWRlcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyQ2FuY2VsVGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQoaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyQ2FuY2VsVGltZW91dCk7CiAgICAgIGludGVudFN0YXRlLnN0cmVhbVJlYWRlckNhbmNlbFRpbWVvdXQgPSBudWxsOwogICAgfQogICAgaWYgKCFmb3JjZSkgewogICAgICBpZiAoaW50ZW50U3RhdGUucmVuZGVyVGFza3Muc2l6ZSA+IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHJlYXNvbiBpbnN0YW5jZW9mIFJlbmRlcmluZ0NhbmNlbGxlZEV4Y2VwdGlvbikgewogICAgICAgIGxldCBkZWxheSA9IFJFTkRFUklOR19DQU5DRUxMRURfVElNRU9VVDsKICAgICAgICBpZiAocmVhc29uLmV4dHJhRGVsYXkgPiAwICYmIHJlYXNvbi5leHRyYURlbGF5IDwgMWUzKSB7CiAgICAgICAgICBkZWxheSArPSByZWFzb24uZXh0cmFEZWxheTsKICAgICAgICB9CiAgICAgICAgaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyQ2FuY2VsVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyQ2FuY2VsVGltZW91dCA9IG51bGw7CiAgICAgICAgICB0aGlzLl9hYm9ydE9wZXJhdG9yTGlzdCh7CiAgICAgICAgICAgIGludGVudFN0YXRlLAogICAgICAgICAgICByZWFzb24sCiAgICAgICAgICAgIGZvcmNlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9LCBkZWxheSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBpbnRlbnRTdGF0ZS5zdHJlYW1SZWFkZXIuY2FuY2VsKG5ldyBBYm9ydEV4Y2VwdGlvbihyZWFzb24ubWVzc2FnZSkpLmNhdGNoKCgpID0+IHsKICAgIH0pOwogICAgaW50ZW50U3RhdGUuc3RyZWFtUmVhZGVyID0gbnVsbDsKICAgIGlmICh0aGlzLl90cmFuc3BvcnQuZGVzdHJveWVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAoY29uc3QgW2N1ckNhY2hlS2V5LCBjdXJJbnRlbnRTdGF0ZV0gb2YgdGhpcy5faW50ZW50U3RhdGVzKSB7CiAgICAgIGlmIChjdXJJbnRlbnRTdGF0ZSA9PT0gaW50ZW50U3RhdGUpIHsKICAgICAgICB0aGlzLl9pbnRlbnRTdGF0ZXMuZGVsZXRlKGN1ckNhY2hlS2V5KTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgdGhpcy5jbGVhbnVwKCk7CiAgfQogIGdldCBzdGF0cygpIHsKICAgIHJldHVybiB0aGlzLl9zdGF0czsKICB9Cn07CnZhciBQREZXb3JrZXIgPSBjbGFzcyBfUERGV29ya2VyIHsKICAjY2FwYWJpbGl0eSA9IFByb21pc2Uud2l0aFJlc29sdmVycygpOwogICNtZXNzYWdlSGFuZGxlciA9IG51bGw7CiAgI3BvcnQgPSBudWxsOwogICN3ZWJXb3JrZXIgPSBudWxsOwogIHN0YXRpYyAjZmFrZVdvcmtlcklkID0gMDsKICBzdGF0aWMgI2lzV29ya2VyRGlzYWJsZWQgPSBmYWxzZTsKICBzdGF0aWMgI3dvcmtlclBvcnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgc3RhdGljIHsKICAgIGlmIChpc05vZGVKUykgewogICAgICB0aGlzLiNpc1dvcmtlckRpc2FibGVkID0gdHJ1ZTsKICAgICAgR2xvYmFsV29ya2VyT3B0aW9ucy53b3JrZXJTcmMgfHw9ICIuL3BkZi53b3JrZXIubWpzIjsKICAgIH0KICAgIHRoaXMuX2lzU2FtZU9yaWdpbiA9IChiYXNlVXJsLCBvdGhlclVybCkgPT4gewogICAgICBjb25zdCBiYXNlID0gVVJMLnBhcnNlKGJhc2VVcmwpOwogICAgICBpZiAoIWJhc2U/Lm9yaWdpbiB8fCBiYXNlLm9yaWdpbiA9PT0gIm51bGwiKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGNvbnN0IG90aGVyID0gbmV3IFVSTChvdGhlclVybCwgYmFzZSk7CiAgICAgIHJldHVybiBiYXNlLm9yaWdpbiA9PT0gb3RoZXIub3JpZ2luOwogICAgfTsKICAgIHRoaXMuX2NyZWF0ZUNETldyYXBwZXIgPSAodXJsKSA9PiB7CiAgICAgIGNvbnN0IHdyYXBwZXIgPSBgYXdhaXQgaW1wb3J0KCIke3VybH0iKTtgOwogICAgICByZXR1cm4gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbd3JhcHBlcl0sIHsKICAgICAgICB0eXBlOiAidGV4dC9qYXZhc2NyaXB0IgogICAgICB9KSk7CiAgICB9OwogICAgdGhpcy5mcm9tUG9ydCA9IChwYXJhbXMpID0+IHsKICAgICAgZGVwcmVjYXRlZCgiYFBERldvcmtlci5mcm9tUG9ydGAgLSBwbGVhc2UgdXNlIGBQREZXb3JrZXIuY3JlYXRlYCBpbnN0ZWFkLiIpOwogICAgICBpZiAoIXBhcmFtcz8ucG9ydCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUERGV29ya2VyLmZyb21Qb3J0IC0gaW52YWxpZCBtZXRob2Qgc2lnbmF0dXJlLiIpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZShwYXJhbXMpOwogICAgfTsKICB9CiAgY29uc3RydWN0b3IoewogICAgbmFtZSA9IG51bGwsCiAgICBwb3J0ID0gbnVsbCwKICAgIHZlcmJvc2l0eTogdmVyYm9zaXR5MiA9IGdldFZlcmJvc2l0eUxldmVsKCkKICB9ID0ge30pIHsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlOwogICAgdGhpcy52ZXJib3NpdHkgPSB2ZXJib3NpdHkyOwogICAgaWYgKHBvcnQpIHsKICAgICAgaWYgKF9QREZXb3JrZXIuI3dvcmtlclBvcnRzLmhhcyhwb3J0KSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVzZSBtb3JlIHRoYW4gb25lIFBERldvcmtlciBwZXIgcG9ydC4iKTsKICAgICAgfQogICAgICBfUERGV29ya2VyLiN3b3JrZXJQb3J0cy5zZXQocG9ydCwgdGhpcyk7CiAgICAgIHRoaXMuI2luaXRpYWxpemVGcm9tUG9ydChwb3J0KTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuI2luaXRpYWxpemUoKTsKICAgIH0KICB9CiAgZ2V0IHByb21pc2UoKSB7CiAgICByZXR1cm4gdGhpcy4jY2FwYWJpbGl0eS5wcm9taXNlOwogIH0KICAjcmVzb2x2ZSgpIHsKICAgIHRoaXMuI2NhcGFiaWxpdHkucmVzb2x2ZSgpOwogICAgdGhpcy4jbWVzc2FnZUhhbmRsZXIuc2VuZCgiY29uZmlndXJlIiwgewogICAgICB2ZXJib3NpdHk6IHRoaXMudmVyYm9zaXR5CiAgICB9KTsKICB9CiAgZ2V0IHBvcnQoKSB7CiAgICByZXR1cm4gdGhpcy4jcG9ydDsKICB9CiAgZ2V0IG1lc3NhZ2VIYW5kbGVyKCkgewogICAgcmV0dXJuIHRoaXMuI21lc3NhZ2VIYW5kbGVyOwogIH0KICAjaW5pdGlhbGl6ZUZyb21Qb3J0KHBvcnQpIHsKICAgIHRoaXMuI3BvcnQgPSBwb3J0OwogICAgdGhpcy4jbWVzc2FnZUhhbmRsZXIgPSBuZXcgTWVzc2FnZUhhbmRsZXIoIm1haW4iLCAid29ya2VyIiwgcG9ydCk7CiAgICB0aGlzLiNtZXNzYWdlSGFuZGxlci5vbigicmVhZHkiLCAoKSA9PiB7CiAgICB9KTsKICAgIHRoaXMuI3Jlc29sdmUoKTsKICB9CiAgI2luaXRpYWxpemUoKSB7CiAgICBpZiAoX1BERldvcmtlci4jaXNXb3JrZXJEaXNhYmxlZCB8fCBfUERGV29ya2VyLiNtYWluVGhyZWFkV29ya2VyTWVzc2FnZUhhbmRsZXIpIHsKICAgICAgdGhpcy4jc2V0dXBGYWtlV29ya2VyKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCB7CiAgICAgIHdvcmtlclNyYwogICAgfSA9IF9QREZXb3JrZXI7CiAgICB0cnkgewogICAgICBpZiAoIV9QREZXb3JrZXIuX2lzU2FtZU9yaWdpbih3aW5kb3cubG9jYXRpb24sIHdvcmtlclNyYykpIHsKICAgICAgICB3b3JrZXJTcmMgPSBfUERGV29ya2VyLl9jcmVhdGVDRE5XcmFwcGVyKG5ldyBVUkwod29ya2VyU3JjLCB3aW5kb3cubG9jYXRpb24pLmhyZWYpOwogICAgICB9CiAgICAgIGNvbnN0IHdvcmtlciA9IG5ldyBXb3JrZXIod29ya2VyU3JjLCB7CiAgICAgICAgdHlwZTogIm1vZHVsZSIKICAgICAgfSk7CiAgICAgIGNvbnN0IG1lc3NhZ2VIYW5kbGVyID0gbmV3IE1lc3NhZ2VIYW5kbGVyKCJtYWluIiwgIndvcmtlciIsIHdvcmtlcik7CiAgICAgIGNvbnN0IHRlcm1pbmF0ZUVhcmx5ID0gKCkgPT4gewogICAgICAgIGFjLmFib3J0KCk7CiAgICAgICAgbWVzc2FnZUhhbmRsZXIuZGVzdHJveSgpOwogICAgICAgIHdvcmtlci50ZXJtaW5hdGUoKTsKICAgICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICAgIHRoaXMuI2NhcGFiaWxpdHkucmVqZWN0KG5ldyBFcnJvcigiV29ya2VyIHdhcyBkZXN0cm95ZWQiKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuI3NldHVwRmFrZVdvcmtlcigpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgYWMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsICgpID0+IHsKICAgICAgICBpZiAoIXRoaXMuI3dlYldvcmtlcikgewogICAgICAgICAgdGVybWluYXRlRWFybHkoKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBzaWduYWw6IGFjLnNpZ25hbAogICAgICB9KTsKICAgICAgbWVzc2FnZUhhbmRsZXIub24oInRlc3QiLCAoZGF0YSkgPT4gewogICAgICAgIGFjLmFib3J0KCk7CiAgICAgICAgaWYgKHRoaXMuZGVzdHJveWVkIHx8ICFkYXRhKSB7CiAgICAgICAgICB0ZXJtaW5hdGVFYXJseSgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLiNtZXNzYWdlSGFuZGxlciA9IG1lc3NhZ2VIYW5kbGVyOwogICAgICAgIHRoaXMuI3BvcnQgPSB3b3JrZXI7CiAgICAgICAgdGhpcy4jd2ViV29ya2VyID0gd29ya2VyOwogICAgICAgIHRoaXMuI3Jlc29sdmUoKTsKICAgICAgfSk7CiAgICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJyZWFkeSIsIChkYXRhKSA9PiB7CiAgICAgICAgYWMuYWJvcnQoKTsKICAgICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICAgIHRlcm1pbmF0ZUVhcmx5KCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICBzZW5kVGVzdCgpOwogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgdGhpcy4jc2V0dXBGYWtlV29ya2VyKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgY29uc3Qgc2VuZFRlc3QgPSAoKSA9PiB7CiAgICAgICAgY29uc3QgdGVzdE9iaiA9IG5ldyBVaW50OEFycmF5KCk7CiAgICAgICAgbWVzc2FnZUhhbmRsZXIuc2VuZCgidGVzdCIsIHRlc3RPYmosIFt0ZXN0T2JqLmJ1ZmZlcl0pOwogICAgICB9OwogICAgICBzZW5kVGVzdCgpOwogICAgICByZXR1cm47CiAgICB9IGNhdGNoIHsKICAgICAgaW5mbygiVGhlIHdvcmtlciBoYXMgYmVlbiBkaXNhYmxlZC4iKTsKICAgIH0KICAgIHRoaXMuI3NldHVwRmFrZVdvcmtlcigpOwogIH0KICAjc2V0dXBGYWtlV29ya2VyKCkgewogICAgaWYgKCFfUERGV29ya2VyLiNpc1dvcmtlckRpc2FibGVkKSB7CiAgICAgIHdhcm4oIlNldHRpbmcgdXAgZmFrZSB3b3JrZXIuIik7CiAgICAgIF9QREZXb3JrZXIuI2lzV29ya2VyRGlzYWJsZWQgPSB0cnVlOwogICAgfQogICAgX1BERldvcmtlci5fc2V0dXBGYWtlV29ya2VyR2xvYmFsLnRoZW4oKFdvcmtlck1lc3NhZ2VIYW5kbGVyKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHRoaXMuI2NhcGFiaWxpdHkucmVqZWN0KG5ldyBFcnJvcigiV29ya2VyIHdhcyBkZXN0cm95ZWQiKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHBvcnQgPSBuZXcgTG9vcGJhY2tQb3J0KCk7CiAgICAgIHRoaXMuI3BvcnQgPSBwb3J0OwogICAgICBjb25zdCBpZCA9IGBmYWtlJHtfUERGV29ya2VyLiNmYWtlV29ya2VySWQrK31gOwogICAgICBjb25zdCB3b3JrZXJIYW5kbGVyID0gbmV3IE1lc3NhZ2VIYW5kbGVyKGlkICsgIl93b3JrZXIiLCBpZCwgcG9ydCk7CiAgICAgIFdvcmtlck1lc3NhZ2VIYW5kbGVyLnNldHVwKHdvcmtlckhhbmRsZXIsIHBvcnQpOwogICAgICB0aGlzLiNtZXNzYWdlSGFuZGxlciA9IG5ldyBNZXNzYWdlSGFuZGxlcihpZCwgaWQgKyAiX3dvcmtlciIsIHBvcnQpOwogICAgICB0aGlzLiNyZXNvbHZlKCk7CiAgICB9KS5jYXRjaCgocmVhc29uKSA9PiB7CiAgICAgIHRoaXMuI2NhcGFiaWxpdHkucmVqZWN0KG5ldyBFcnJvcihgU2V0dGluZyB1cCBmYWtlIHdvcmtlciBmYWlsZWQ6ICIke3JlYXNvbi5tZXNzYWdlfSIuYCkpOwogICAgfSk7CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7CiAgICB0aGlzLiN3ZWJXb3JrZXI/LnRlcm1pbmF0ZSgpOwogICAgdGhpcy4jd2ViV29ya2VyID0gbnVsbDsKICAgIF9QREZXb3JrZXIuI3dvcmtlclBvcnRzLmRlbGV0ZSh0aGlzLiNwb3J0KTsKICAgIHRoaXMuI3BvcnQgPSBudWxsOwogICAgdGhpcy4jbWVzc2FnZUhhbmRsZXI/LmRlc3Ryb3koKTsKICAgIHRoaXMuI21lc3NhZ2VIYW5kbGVyID0gbnVsbDsKICB9CiAgc3RhdGljIGNyZWF0ZShwYXJhbXMpIHsKICAgIGNvbnN0IGNhY2hlZFBvcnQgPSB0aGlzLiN3b3JrZXJQb3J0cy5nZXQocGFyYW1zPy5wb3J0KTsKICAgIGlmIChjYWNoZWRQb3J0KSB7CiAgICAgIGlmIChjYWNoZWRQb3J0Ll9wZW5kaW5nRGVzdHJveSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUERGV29ya2VyLmNyZWF0ZSAtIHRoZSB3b3JrZXIgaXMgYmVpbmcgZGVzdHJveWVkLlxuUGxlYXNlIHJlbWVtYmVyIHRvIGF3YWl0IGBQREZEb2N1bWVudExvYWRpbmdUYXNrLmRlc3Ryb3koKWAtY2FsbHMuIik7CiAgICAgIH0KICAgICAgcmV0dXJuIGNhY2hlZFBvcnQ7CiAgICB9CiAgICByZXR1cm4gbmV3IF9QREZXb3JrZXIocGFyYW1zKTsKICB9CiAgc3RhdGljIGdldCB3b3JrZXJTcmMoKSB7CiAgICBpZiAoR2xvYmFsV29ya2VyT3B0aW9ucy53b3JrZXJTcmMpIHsKICAgICAgcmV0dXJuIEdsb2JhbFdvcmtlck9wdGlvbnMud29ya2VyU3JjOwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKCdObyAiR2xvYmFsV29ya2VyT3B0aW9ucy53b3JrZXJTcmMiIHNwZWNpZmllZC4nKTsKICB9CiAgc3RhdGljIGdldCAjbWFpblRocmVhZFdvcmtlck1lc3NhZ2VIYW5kbGVyKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGdsb2JhbFRoaXMucGRmanNXb3JrZXI/Lldvcmtlck1lc3NhZ2VIYW5kbGVyIHx8IG51bGw7CiAgICB9IGNhdGNoIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfQogIHN0YXRpYyBnZXQgX3NldHVwRmFrZVdvcmtlckdsb2JhbCgpIHsKICAgIGNvbnN0IGxvYWRlciA9IGFzeW5jICgpID0+IHsKICAgICAgaWYgKHRoaXMuI21haW5UaHJlYWRXb3JrZXJNZXNzYWdlSGFuZGxlcikgewogICAgICAgIHJldHVybiB0aGlzLiNtYWluVGhyZWFkV29ya2VyTWVzc2FnZUhhbmRsZXI7CiAgICAgIH0KICAgICAgY29uc3Qgd29ya2VyID0gYXdhaXQgaW1wb3J0KAogICAgICAgIC8qd2VicGFja0lnbm9yZTogdHJ1ZSovCiAgICAgICAgLypAdml0ZS1pZ25vcmUqLwogICAgICAgIHRoaXMud29ya2VyU3JjCiAgICAgICk7CiAgICAgIHJldHVybiB3b3JrZXIuV29ya2VyTWVzc2FnZUhhbmRsZXI7CiAgICB9OwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX3NldHVwRmFrZVdvcmtlckdsb2JhbCIsIGxvYWRlcigpKTsKICB9Cn07CnZhciBXb3JrZXJUcmFuc3BvcnQgPSBjbGFzcyB7CiAgI21ldGhvZFByb21pc2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjcGFnZUNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjcGFnZVByb21pc2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjcGFnZVJlZkNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjcGFzc3dvcmRDYXBhYmlsaXR5ID0gbnVsbDsKICBjb25zdHJ1Y3RvcihtZXNzYWdlSGFuZGxlciwgbG9hZGluZ1Rhc2ssIG5ldHdvcmtTdHJlYW0sIHBhcmFtcywgZmFjdG9yeSwgZW5hYmxlSFdBKSB7CiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyID0gbWVzc2FnZUhhbmRsZXI7CiAgICB0aGlzLmxvYWRpbmdUYXNrID0gbG9hZGluZ1Rhc2s7CiAgICB0aGlzLmNvbW1vbk9ianMgPSBuZXcgUERGT2JqZWN0cygpOwogICAgdGhpcy5mb250TG9hZGVyID0gbmV3IEZvbnRMb2FkZXIoewogICAgICBvd25lckRvY3VtZW50OiBwYXJhbXMub3duZXJEb2N1bWVudCwKICAgICAgc3R5bGVFbGVtZW50OiBwYXJhbXMuc3R5bGVFbGVtZW50CiAgICB9KTsKICAgIHRoaXMubG9hZGluZ1BhcmFtcyA9IHBhcmFtcy5sb2FkaW5nUGFyYW1zOwogICAgdGhpcy5fcGFyYW1zID0gcGFyYW1zOwogICAgdGhpcy5jYW52YXNGYWN0b3J5ID0gZmFjdG9yeS5jYW52YXNGYWN0b3J5OwogICAgdGhpcy5maWx0ZXJGYWN0b3J5ID0gZmFjdG9yeS5maWx0ZXJGYWN0b3J5OwogICAgdGhpcy5jTWFwUmVhZGVyRmFjdG9yeSA9IGZhY3RvcnkuY01hcFJlYWRlckZhY3Rvcnk7CiAgICB0aGlzLnN0YW5kYXJkRm9udERhdGFGYWN0b3J5ID0gZmFjdG9yeS5zdGFuZGFyZEZvbnREYXRhRmFjdG9yeTsKICAgIHRoaXMud2FzbUZhY3RvcnkgPSBmYWN0b3J5Lndhc21GYWN0b3J5OwogICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZTsKICAgIHRoaXMuZGVzdHJveUNhcGFiaWxpdHkgPSBudWxsOwogICAgdGhpcy5fbmV0d29ya1N0cmVhbSA9IG5ldHdvcmtTdHJlYW07CiAgICB0aGlzLl9mdWxsUmVhZGVyID0gbnVsbDsKICAgIHRoaXMuX2xhc3RQcm9ncmVzcyA9IG51bGw7CiAgICB0aGlzLmRvd25sb2FkSW5mb0NhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIHRoaXMuZW5hYmxlSFdBID0gZW5hYmxlSFdBOwogICAgdGhpcy5zZXR1cE1lc3NhZ2VIYW5kbGVyKCk7CiAgfQogICNjYWNoZVNpbXBsZU1ldGhvZChuYW1lLCBkYXRhID0gbnVsbCkgewogICAgY29uc3QgY2FjaGVkUHJvbWlzZSA9IHRoaXMuI21ldGhvZFByb21pc2VzLmdldChuYW1lKTsKICAgIGlmIChjYWNoZWRQcm9taXNlKSB7CiAgICAgIHJldHVybiBjYWNoZWRQcm9taXNlOwogICAgfQogICAgY29uc3QgcHJvbWlzZSA9IHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKG5hbWUsIGRhdGEpOwogICAgdGhpcy4jbWV0aG9kUHJvbWlzZXMuc2V0KG5hbWUsIHByb21pc2UpOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIGdldCBhbm5vdGF0aW9uU3RvcmFnZSgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgImFubm90YXRpb25TdG9yYWdlIiwgbmV3IEFubm90YXRpb25TdG9yYWdlKCkpOwogIH0KICBnZXRSZW5kZXJpbmdJbnRlbnQoaW50ZW50LCBhbm5vdGF0aW9uTW9kZSA9IEFubm90YXRpb25Nb2RlLkVOQUJMRSwgcHJpbnRBbm5vdGF0aW9uU3RvcmFnZSA9IG51bGwsIGlzRWRpdGluZyA9IGZhbHNlLCBpc09wTGlzdCA9IGZhbHNlKSB7CiAgICBsZXQgcmVuZGVyaW5nSW50ZW50ID0gUmVuZGVyaW5nSW50ZW50RmxhZy5ESVNQTEFZOwogICAgbGV0IGFubm90YXRpb25TdG9yYWdlU2VyaWFsaXphYmxlID0gU2VyaWFsaXphYmxlRW1wdHk7CiAgICBzd2l0Y2ggKGludGVudCkgewogICAgICBjYXNlICJhbnkiOgogICAgICAgIHJlbmRlcmluZ0ludGVudCA9IFJlbmRlcmluZ0ludGVudEZsYWcuQU5ZOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICJkaXNwbGF5IjoKICAgICAgICBicmVhazsKICAgICAgY2FzZSAicHJpbnQiOgogICAgICAgIHJlbmRlcmluZ0ludGVudCA9IFJlbmRlcmluZ0ludGVudEZsYWcuUFJJTlQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgd2FybihgZ2V0UmVuZGVyaW5nSW50ZW50IC0gaW52YWxpZCBpbnRlbnQ6ICR7aW50ZW50fWApOwogICAgfQogICAgY29uc3QgYW5ub3RhdGlvblN0b3JhZ2UgPSByZW5kZXJpbmdJbnRlbnQgJiBSZW5kZXJpbmdJbnRlbnRGbGFnLlBSSU5UICYmIHByaW50QW5ub3RhdGlvblN0b3JhZ2UgaW5zdGFuY2VvZiBQcmludEFubm90YXRpb25TdG9yYWdlID8gcHJpbnRBbm5vdGF0aW9uU3RvcmFnZSA6IHRoaXMuYW5ub3RhdGlvblN0b3JhZ2U7CiAgICBzd2l0Y2ggKGFubm90YXRpb25Nb2RlKSB7CiAgICAgIGNhc2UgQW5ub3RhdGlvbk1vZGUuRElTQUJMRToKICAgICAgICByZW5kZXJpbmdJbnRlbnQgKz0gUmVuZGVyaW5nSW50ZW50RmxhZy5BTk5PVEFUSU9OU19ESVNBQkxFOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIEFubm90YXRpb25Nb2RlLkVOQUJMRToKICAgICAgICBicmVhazsKICAgICAgY2FzZSBBbm5vdGF0aW9uTW9kZS5FTkFCTEVfRk9STVM6CiAgICAgICAgcmVuZGVyaW5nSW50ZW50ICs9IFJlbmRlcmluZ0ludGVudEZsYWcuQU5OT1RBVElPTlNfRk9STVM7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgQW5ub3RhdGlvbk1vZGUuRU5BQkxFX1NUT1JBR0U6CiAgICAgICAgcmVuZGVyaW5nSW50ZW50ICs9IFJlbmRlcmluZ0ludGVudEZsYWcuQU5OT1RBVElPTlNfU1RPUkFHRTsKICAgICAgICBhbm5vdGF0aW9uU3RvcmFnZVNlcmlhbGl6YWJsZSA9IGFubm90YXRpb25TdG9yYWdlLnNlcmlhbGl6YWJsZTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB3YXJuKGBnZXRSZW5kZXJpbmdJbnRlbnQgLSBpbnZhbGlkIGFubm90YXRpb25Nb2RlOiAke2Fubm90YXRpb25Nb2RlfWApOwogICAgfQogICAgaWYgKGlzRWRpdGluZykgewogICAgICByZW5kZXJpbmdJbnRlbnQgKz0gUmVuZGVyaW5nSW50ZW50RmxhZy5JU19FRElUSU5HOwogICAgfQogICAgaWYgKGlzT3BMaXN0KSB7CiAgICAgIHJlbmRlcmluZ0ludGVudCArPSBSZW5kZXJpbmdJbnRlbnRGbGFnLk9QTElTVDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgaWRzOiBtb2RpZmllZElkcywKICAgICAgaGFzaDogbW9kaWZpZWRJZHNIYXNoCiAgICB9ID0gYW5ub3RhdGlvblN0b3JhZ2UubW9kaWZpZWRJZHM7CiAgICBjb25zdCBjYWNoZUtleUJ1ZiA9IFtyZW5kZXJpbmdJbnRlbnQsIGFubm90YXRpb25TdG9yYWdlU2VyaWFsaXphYmxlLmhhc2gsIG1vZGlmaWVkSWRzSGFzaF07CiAgICByZXR1cm4gewogICAgICByZW5kZXJpbmdJbnRlbnQsCiAgICAgIGNhY2hlS2V5OiBjYWNoZUtleUJ1Zi5qb2luKCJfIiksCiAgICAgIGFubm90YXRpb25TdG9yYWdlU2VyaWFsaXphYmxlLAogICAgICBtb2RpZmllZElkcwogICAgfTsKICB9CiAgZGVzdHJveSgpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3lDYXBhYmlsaXR5KSB7CiAgICAgIHJldHVybiB0aGlzLmRlc3Ryb3lDYXBhYmlsaXR5LnByb21pc2U7CiAgICB9CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7CiAgICB0aGlzLmRlc3Ryb3lDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICB0aGlzLiNwYXNzd29yZENhcGFiaWxpdHk/LnJlamVjdChuZXcgRXJyb3IoIldvcmtlciB3YXMgZGVzdHJveWVkIGR1cmluZyBvblBhc3N3b3JkIGNhbGxiYWNrIikpOwogICAgY29uc3Qgd2FpdE9uID0gW107CiAgICBmb3IgKGNvbnN0IHBhZ2Ugb2YgdGhpcy4jcGFnZUNhY2hlLnZhbHVlcygpKSB7CiAgICAgIHdhaXRPbi5wdXNoKHBhZ2UuX2Rlc3Ryb3koKSk7CiAgICB9CiAgICB0aGlzLiNwYWdlQ2FjaGUuY2xlYXIoKTsKICAgIHRoaXMuI3BhZ2VQcm9taXNlcy5jbGVhcigpOwogICAgdGhpcy4jcGFnZVJlZkNhY2hlLmNsZWFyKCk7CiAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eSgiYW5ub3RhdGlvblN0b3JhZ2UiKSkgewogICAgICB0aGlzLmFubm90YXRpb25TdG9yYWdlLnJlc2V0TW9kaWZpZWQoKTsKICAgIH0KICAgIGNvbnN0IHRlcm1pbmF0ZWQgPSB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiVGVybWluYXRlIiwgbnVsbCk7CiAgICB3YWl0T24ucHVzaCh0ZXJtaW5hdGVkKTsKICAgIFByb21pc2UuYWxsKHdhaXRPbikudGhlbigoKSA9PiB7CiAgICAgIHRoaXMuY29tbW9uT2Jqcy5jbGVhcigpOwogICAgICB0aGlzLmZvbnRMb2FkZXIuY2xlYXIoKTsKICAgICAgdGhpcy4jbWV0aG9kUHJvbWlzZXMuY2xlYXIoKTsKICAgICAgdGhpcy5maWx0ZXJGYWN0b3J5LmRlc3Ryb3koKTsKICAgICAgVGV4dExheWVyLmNsZWFudXAoKTsKICAgICAgdGhpcy5fbmV0d29ya1N0cmVhbT8uY2FuY2VsQWxsUmVxdWVzdHMobmV3IEFib3J0RXhjZXB0aW9uKCJXb3JrZXIgd2FzIHRlcm1pbmF0ZWQuIikpOwogICAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyPy5kZXN0cm95KCk7CiAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXIgPSBudWxsOwogICAgICB0aGlzLmRlc3Ryb3lDYXBhYmlsaXR5LnJlc29sdmUoKTsKICAgIH0sIHRoaXMuZGVzdHJveUNhcGFiaWxpdHkucmVqZWN0KTsKICAgIHJldHVybiB0aGlzLmRlc3Ryb3lDYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIHNldHVwTWVzc2FnZUhhbmRsZXIoKSB7CiAgICBjb25zdCB7CiAgICAgIG1lc3NhZ2VIYW5kbGVyLAogICAgICBsb2FkaW5nVGFzawogICAgfSA9IHRoaXM7CiAgICBtZXNzYWdlSGFuZGxlci5vbigiR2V0UmVhZGVyIiwgKGRhdGEsIHNpbmspID0+IHsKICAgICAgYXNzZXJ0KHRoaXMuX25ldHdvcmtTdHJlYW0sICJHZXRSZWFkZXIgLSBubyBgSVBERlN0cmVhbWAgaW5zdGFuY2UgYXZhaWxhYmxlLiIpOwogICAgICB0aGlzLl9mdWxsUmVhZGVyID0gdGhpcy5fbmV0d29ya1N0cmVhbS5nZXRGdWxsUmVhZGVyKCk7CiAgICAgIHRoaXMuX2Z1bGxSZWFkZXIub25Qcm9ncmVzcyA9IChldnQpID0+IHsKICAgICAgICB0aGlzLl9sYXN0UHJvZ3Jlc3MgPSB7CiAgICAgICAgICBsb2FkZWQ6IGV2dC5sb2FkZWQsCiAgICAgICAgICB0b3RhbDogZXZ0LnRvdGFsCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgc2luay5vblB1bGwgPSAoKSA9PiB7CiAgICAgICAgdGhpcy5fZnVsbFJlYWRlci5yZWFkKCkudGhlbihmdW5jdGlvbih7CiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIGRvbmUKICAgICAgICB9KSB7CiAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICBzaW5rLmNsb3NlKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydCh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyLCAiR2V0UmVhZGVyIC0gZXhwZWN0ZWQgYW4gQXJyYXlCdWZmZXIuIik7CiAgICAgICAgICBzaW5rLmVucXVldWUobmV3IFVpbnQ4QXJyYXkodmFsdWUpLCAxLCBbdmFsdWVdKTsKICAgICAgICB9KS5jYXRjaCgocmVhc29uKSA9PiB7CiAgICAgICAgICBzaW5rLmVycm9yKHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICAgIHNpbmsub25DYW5jZWwgPSAocmVhc29uKSA9PiB7CiAgICAgICAgdGhpcy5fZnVsbFJlYWRlci5jYW5jZWwocmVhc29uKTsKICAgICAgICBzaW5rLnJlYWR5LmNhdGNoKChyZWFkeVJlYXNvbikgPT4gewogICAgICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IHJlYWR5UmVhc29uOwogICAgICAgIH0pOwogICAgICB9OwogICAgfSk7CiAgICBtZXNzYWdlSGFuZGxlci5vbigiUmVhZGVySGVhZGVyc1JlYWR5IiwgYXN5bmMgKGRhdGEpID0+IHsKICAgICAgYXdhaXQgdGhpcy5fZnVsbFJlYWRlci5oZWFkZXJzUmVhZHk7CiAgICAgIGNvbnN0IHsKICAgICAgICBpc1N0cmVhbWluZ1N1cHBvcnRlZCwKICAgICAgICBpc1JhbmdlU3VwcG9ydGVkLAogICAgICAgIGNvbnRlbnRMZW5ndGgKICAgICAgfSA9IHRoaXMuX2Z1bGxSZWFkZXI7CiAgICAgIGlmICghaXNTdHJlYW1pbmdTdXBwb3J0ZWQgfHwgIWlzUmFuZ2VTdXBwb3J0ZWQpIHsKICAgICAgICBpZiAodGhpcy5fbGFzdFByb2dyZXNzKSB7CiAgICAgICAgICBsb2FkaW5nVGFzay5vblByb2dyZXNzPy4odGhpcy5fbGFzdFByb2dyZXNzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fZnVsbFJlYWRlci5vblByb2dyZXNzID0gKGV2dCkgPT4gewogICAgICAgICAgbG9hZGluZ1Rhc2sub25Qcm9ncmVzcz8uKHsKICAgICAgICAgICAgbG9hZGVkOiBldnQubG9hZGVkLAogICAgICAgICAgICB0b3RhbDogZXZ0LnRvdGFsCiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgaXNTdHJlYW1pbmdTdXBwb3J0ZWQsCiAgICAgICAgaXNSYW5nZVN1cHBvcnRlZCwKICAgICAgICBjb250ZW50TGVuZ3RoCiAgICAgIH07CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJHZXRSYW5nZVJlYWRlciIsIChkYXRhLCBzaW5rKSA9PiB7CiAgICAgIGFzc2VydCh0aGlzLl9uZXR3b3JrU3RyZWFtLCAiR2V0UmFuZ2VSZWFkZXIgLSBubyBgSVBERlN0cmVhbWAgaW5zdGFuY2UgYXZhaWxhYmxlLiIpOwogICAgICBjb25zdCByYW5nZVJlYWRlciA9IHRoaXMuX25ldHdvcmtTdHJlYW0uZ2V0UmFuZ2VSZWFkZXIoZGF0YS5iZWdpbiwgZGF0YS5lbmQpOwogICAgICBpZiAoIXJhbmdlUmVhZGVyKSB7CiAgICAgICAgc2luay5jbG9zZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzaW5rLm9uUHVsbCA9ICgpID0+IHsKICAgICAgICByYW5nZVJlYWRlci5yZWFkKCkudGhlbihmdW5jdGlvbih7CiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIGRvbmUKICAgICAgICB9KSB7CiAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICBzaW5rLmNsb3NlKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2VydCh2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyLCAiR2V0UmFuZ2VSZWFkZXIgLSBleHBlY3RlZCBhbiBBcnJheUJ1ZmZlci4iKTsKICAgICAgICAgIHNpbmsuZW5xdWV1ZShuZXcgVWludDhBcnJheSh2YWx1ZSksIDEsIFt2YWx1ZV0pOwogICAgICAgIH0pLmNhdGNoKChyZWFzb24pID0+IHsKICAgICAgICAgIHNpbmsuZXJyb3IocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgICAgc2luay5vbkNhbmNlbCA9IChyZWFzb24pID0+IHsKICAgICAgICByYW5nZVJlYWRlci5jYW5jZWwocmVhc29uKTsKICAgICAgICBzaW5rLnJlYWR5LmNhdGNoKChyZWFkeVJlYXNvbikgPT4gewogICAgICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IHJlYWR5UmVhc29uOwogICAgICAgIH0pOwogICAgICB9OwogICAgfSk7CiAgICBtZXNzYWdlSGFuZGxlci5vbigiR2V0RG9jIiwgKHsKICAgICAgcGRmSW5mbwogICAgfSkgPT4gewogICAgICB0aGlzLl9udW1QYWdlcyA9IHBkZkluZm8ubnVtUGFnZXM7CiAgICAgIHRoaXMuX2h0bWxGb3JYZmEgPSBwZGZJbmZvLmh0bWxGb3JYZmE7CiAgICAgIGRlbGV0ZSBwZGZJbmZvLmh0bWxGb3JYZmE7CiAgICAgIGxvYWRpbmdUYXNrLl9jYXBhYmlsaXR5LnJlc29sdmUobmV3IFBERkRvY3VtZW50UHJveHkocGRmSW5mbywgdGhpcykpOwogICAgfSk7CiAgICBtZXNzYWdlSGFuZGxlci5vbigiRG9jRXhjZXB0aW9uIiwgKGV4KSA9PiB7CiAgICAgIGxvYWRpbmdUYXNrLl9jYXBhYmlsaXR5LnJlamVjdCh3cmFwUmVhc29uKGV4KSk7CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJQYXNzd29yZFJlcXVlc3QiLCAoZXgpID0+IHsKICAgICAgdGhpcy4jcGFzc3dvcmRDYXBhYmlsaXR5ID0gUHJvbWlzZS53aXRoUmVzb2x2ZXJzKCk7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKCFsb2FkaW5nVGFzay5vblBhc3N3b3JkKSB7CiAgICAgICAgICB0aHJvdyB3cmFwUmVhc29uKGV4KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXBkYXRlUGFzc3dvcmQgPSAocGFzc3dvcmQpID0+IHsKICAgICAgICAgIGlmIChwYXNzd29yZCBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgIHRoaXMuI3Bhc3N3b3JkQ2FwYWJpbGl0eS5yZWplY3QocGFzc3dvcmQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy4jcGFzc3dvcmRDYXBhYmlsaXR5LnJlc29sdmUoewogICAgICAgICAgICAgIHBhc3N3b3JkCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgbG9hZGluZ1Rhc2sub25QYXNzd29yZCh1cGRhdGVQYXNzd29yZCwgZXguY29kZSk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHRoaXMuI3Bhc3N3b3JkQ2FwYWJpbGl0eS5yZWplY3QoZXJyKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy4jcGFzc3dvcmRDYXBhYmlsaXR5LnByb21pc2U7CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJEYXRhTG9hZGVkIiwgKGRhdGEpID0+IHsKICAgICAgbG9hZGluZ1Rhc2sub25Qcm9ncmVzcz8uKHsKICAgICAgICBsb2FkZWQ6IGRhdGEubGVuZ3RoLAogICAgICAgIHRvdGFsOiBkYXRhLmxlbmd0aAogICAgICB9KTsKICAgICAgdGhpcy5kb3dubG9hZEluZm9DYXBhYmlsaXR5LnJlc29sdmUoZGF0YSk7CiAgICB9KTsKICAgIG1lc3NhZ2VIYW5kbGVyLm9uKCJTdGFydFJlbmRlclBhZ2UiLCAoZGF0YSkgPT4gewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgcGFnZSA9IHRoaXMuI3BhZ2VDYWNoZS5nZXQoZGF0YS5wYWdlSW5kZXgpOwogICAgICBwYWdlLl9zdGFydFJlbmRlclBhZ2UoZGF0YS50cmFuc3BhcmVuY3ksIGRhdGEuY2FjaGVLZXkpOwogICAgfSk7CiAgICBtZXNzYWdlSGFuZGxlci5vbigiY29tbW9ub2JqIiwgKFtpZCwgdHlwZSwgZXhwb3J0ZWREYXRhXSkgPT4gewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAodGhpcy5jb21tb25PYmpzLmhhcyhpZCkpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICBjYXNlICJGb250IjoKICAgICAgICAgIGlmICgiZXJyb3IiIGluIGV4cG9ydGVkRGF0YSkgewogICAgICAgICAgICBjb25zdCBleHBvcnRlZEVycm9yID0gZXhwb3J0ZWREYXRhLmVycm9yOwogICAgICAgICAgICB3YXJuKGBFcnJvciBkdXJpbmcgZm9udCBsb2FkaW5nOiAke2V4cG9ydGVkRXJyb3J9YCk7CiAgICAgICAgICAgIHRoaXMuY29tbW9uT2Jqcy5yZXNvbHZlKGlkLCBleHBvcnRlZEVycm9yKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBmb250RGF0YSA9IG5ldyBGb250SW5mbyhleHBvcnRlZERhdGEpOwogICAgICAgICAgY29uc3QgaW5zcGVjdEZvbnQgPSB0aGlzLl9wYXJhbXMucGRmQnVnICYmIGdsb2JhbFRoaXMuRm9udEluc3BlY3Rvcj8uZW5hYmxlZCA/IChmb250MiwgdXJsKSA9PiBnbG9iYWxUaGlzLkZvbnRJbnNwZWN0b3IuZm9udEFkZGVkKGZvbnQyLCB1cmwpIDogbnVsbDsKICAgICAgICAgIGNvbnN0IGZvbnQgPSBuZXcgRm9udEZhY2VPYmplY3QoZm9udERhdGEsIGluc3BlY3RGb250LCBleHBvcnRlZERhdGEuZXh0cmEsIGV4cG9ydGVkRGF0YS5jaGFyUHJvY09wZXJhdG9yTGlzdCk7CiAgICAgICAgICB0aGlzLmZvbnRMb2FkZXIuYmluZChmb250KS5jYXRjaCgoKSA9PiBtZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkZvbnRGYWxsYmFjayIsIHsKICAgICAgICAgICAgaWQKICAgICAgICAgIH0pKS5maW5hbGx5KCgpID0+IHsKICAgICAgICAgICAgaWYgKCFmb250LmZvbnRFeHRyYVByb3BlcnRpZXMgJiYgZm9udC5kYXRhKSB7CiAgICAgICAgICAgICAgZm9udC5jbGVhckRhdGEoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNvbW1vbk9ianMucmVzb2x2ZShpZCwgZm9udCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkNvcHlMb2NhbEltYWdlIjoKICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgaW1hZ2VSZWYKICAgICAgICAgIH0gPSBleHBvcnRlZERhdGE7CiAgICAgICAgICBhc3NlcnQoaW1hZ2VSZWYsICJUaGUgaW1hZ2VSZWYgbXVzdCBiZSBkZWZpbmVkLiIpOwogICAgICAgICAgZm9yIChjb25zdCBwYWdlUHJveHkgb2YgdGhpcy4jcGFnZUNhY2hlLnZhbHVlcygpKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgWywgZGF0YV0gb2YgcGFnZVByb3h5Lm9ianMpIHsKICAgICAgICAgICAgICBpZiAoZGF0YT8ucmVmICE9PSBpbWFnZVJlZikgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZGF0YS5kYXRhTGVuKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5jb21tb25PYmpzLnJlc29sdmUoaWQsIHN0cnVjdHVyZWRDbG9uZShkYXRhKSk7CiAgICAgICAgICAgICAgcmV0dXJuIGRhdGEuZGF0YUxlbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiRm9udFBhdGgiOgogICAgICAgICAgdGhpcy5jb21tb25PYmpzLnJlc29sdmUoaWQsIG5ldyBGb250UGF0aEluZm8oZXhwb3J0ZWREYXRhKSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJJbWFnZSI6CiAgICAgICAgICB0aGlzLmNvbW1vbk9ianMucmVzb2x2ZShpZCwgZXhwb3J0ZWREYXRhKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIlBhdHRlcm4iOgogICAgICAgICAgY29uc3QgcGF0dGVybiA9IG5ldyBQYXR0ZXJuSW5mbyhleHBvcnRlZERhdGEpOwogICAgICAgICAgdGhpcy5jb21tb25PYmpzLnJlc29sdmUoaWQsIHBhdHRlcm4uZ2V0SVIoKSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBHb3QgdW5rbm93biBjb21tb24gb2JqZWN0IHR5cGUgJHt0eXBlfWApOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfSk7CiAgICBtZXNzYWdlSGFuZGxlci5vbigib2JqIiwgKFtpZCwgcGFnZUluZGV4LCB0eXBlLCBpbWFnZURhdGFdKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBwYWdlUHJveHkgPSB0aGlzLiNwYWdlQ2FjaGUuZ2V0KHBhZ2VJbmRleCk7CiAgICAgIGlmIChwYWdlUHJveHkub2Jqcy5oYXMoaWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChwYWdlUHJveHkuX2ludGVudFN0YXRlcy5zaXplID09PSAwKSB7CiAgICAgICAgaW1hZ2VEYXRhPy5iaXRtYXA/LmNsb3NlKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgIGNhc2UgIkltYWdlIjoKICAgICAgICBjYXNlICJQYXR0ZXJuIjoKICAgICAgICAgIHBhZ2VQcm94eS5vYmpzLnJlc29sdmUoaWQsIGltYWdlRGF0YSk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBHb3QgdW5rbm93biBvYmplY3QgdHlwZSAke3R5cGV9YCk7CiAgICAgIH0KICAgIH0pOwogICAgbWVzc2FnZUhhbmRsZXIub24oIkRvY1Byb2dyZXNzIiwgKGRhdGEpID0+IHsKICAgICAgaWYgKHRoaXMuZGVzdHJveWVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGxvYWRpbmdUYXNrLm9uUHJvZ3Jlc3M/Lih7CiAgICAgICAgbG9hZGVkOiBkYXRhLmxvYWRlZCwKICAgICAgICB0b3RhbDogZGF0YS50b3RhbAogICAgICB9KTsKICAgIH0pOwogICAgbWVzc2FnZUhhbmRsZXIub24oIkZldGNoQmluYXJ5RGF0YSIsIGFzeW5jIChkYXRhKSA9PiB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiV29ya2VyIHdhcyBkZXN0cm95ZWQuIik7CiAgICAgIH0KICAgICAgY29uc3QgZmFjdG9yeSA9IHRoaXNbZGF0YS50eXBlXTsKICAgICAgaWYgKCFmYWN0b3J5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2RhdGEudHlwZX0gbm90IGluaXRpYWxpemVkLCBzZWUgdGhlIFxgdXNlV29ya2VyRmV0Y2hcYCBwYXJhbWV0ZXIuYCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhY3RvcnkuZmV0Y2goZGF0YSk7CiAgICB9KTsKICB9CiAgZ2V0RGF0YSgpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0RGF0YSIsIG51bGwpOwogIH0KICBzYXZlRG9jdW1lbnQoKSB7CiAgICBpZiAodGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5zaXplIDw9IDApIHsKICAgICAgd2Fybigic2F2ZURvY3VtZW50IGNhbGxlZCB3aGlsZSBgYW5ub3RhdGlvblN0b3JhZ2VgIGlzIGVtcHR5LCBwbGVhc2UgdXNlIHRoZSBnZXREYXRhLW1ldGhvZCBpbnN0ZWFkLiIpOwogICAgfQogICAgY29uc3QgewogICAgICBtYXAsCiAgICAgIHRyYW5zZmVyCiAgICB9ID0gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5zZXJpYWxpemFibGU7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIlNhdmVEb2N1bWVudCIsIHsKICAgICAgaXNQdXJlWGZhOiAhIXRoaXMuX2h0bWxGb3JYZmEsCiAgICAgIG51bVBhZ2VzOiB0aGlzLl9udW1QYWdlcywKICAgICAgYW5ub3RhdGlvblN0b3JhZ2U6IG1hcCwKICAgICAgZmlsZW5hbWU6IHRoaXMuX2Z1bGxSZWFkZXI/LmZpbGVuYW1lID8/IG51bGwKICAgIH0sIHRyYW5zZmVyKS5maW5hbGx5KCgpID0+IHsKICAgICAgdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5yZXNldE1vZGlmaWVkKCk7CiAgICB9KTsKICB9CiAgZXh0cmFjdFBhZ2VzKHBhZ2VJbmZvcykgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJFeHRyYWN0UGFnZXMiLCB7CiAgICAgIHBhZ2VJbmZvcwogICAgfSk7CiAgfQogIGdldFBhZ2UocGFnZU51bWJlcikgewogICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKHBhZ2VOdW1iZXIpIHx8IHBhZ2VOdW1iZXIgPD0gMCB8fCBwYWdlTnVtYmVyID4gdGhpcy5fbnVtUGFnZXMpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcigiSW52YWxpZCBwYWdlIHJlcXVlc3QuIikpOwogICAgfQogICAgY29uc3QgcGFnZUluZGV4ID0gcGFnZU51bWJlciAtIDEsIGNhY2hlZFByb21pc2UgPSB0aGlzLiNwYWdlUHJvbWlzZXMuZ2V0KHBhZ2VJbmRleCk7CiAgICBpZiAoY2FjaGVkUHJvbWlzZSkgewogICAgICByZXR1cm4gY2FjaGVkUHJvbWlzZTsKICAgIH0KICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0UGFnZSIsIHsKICAgICAgcGFnZUluZGV4CiAgICB9KS50aGVuKChwYWdlSW5mbykgPT4gewogICAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRyYW5zcG9ydCBkZXN0cm95ZWQiKTsKICAgICAgfQogICAgICBpZiAocGFnZUluZm8ucmVmU3RyKSB7CiAgICAgICAgdGhpcy4jcGFnZVJlZkNhY2hlLnNldChwYWdlSW5mby5yZWZTdHIsIHBhZ2VOdW1iZXIpOwogICAgICB9CiAgICAgIGNvbnN0IHBhZ2UgPSBuZXcgUERGUGFnZVByb3h5KHBhZ2VJbmRleCwgcGFnZUluZm8sIHRoaXMsIHRoaXMuX3BhcmFtcy5wZGZCdWcpOwogICAgICB0aGlzLiNwYWdlQ2FjaGUuc2V0KHBhZ2VJbmRleCwgcGFnZSk7CiAgICAgIHJldHVybiBwYWdlOwogICAgfSk7CiAgICB0aGlzLiNwYWdlUHJvbWlzZXMuc2V0KHBhZ2VJbmRleCwgcHJvbWlzZSk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9CiAgZ2V0UGFnZUluZGV4KHJlZikgewogICAgaWYgKCFpc1JlZlByb3h5KHJlZikpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcigiSW52YWxpZCBwYWdlSW5kZXggcmVxdWVzdC4iKSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldFBhZ2VJbmRleCIsIHsKICAgICAgbnVtOiByZWYubnVtLAogICAgICBnZW46IHJlZi5nZW4KICAgIH0pOwogIH0KICBnZXRBbm5vdGF0aW9ucyhwYWdlSW5kZXgsIGludGVudCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRBbm5vdGF0aW9ucyIsIHsKICAgICAgcGFnZUluZGV4LAogICAgICBpbnRlbnQKICAgIH0pOwogIH0KICBnZXRGaWVsZE9iamVjdHMoKSB7CiAgICByZXR1cm4gdGhpcy4jY2FjaGVTaW1wbGVNZXRob2QoIkdldEZpZWxkT2JqZWN0cyIpOwogIH0KICBoYXNKU0FjdGlvbnMoKSB7CiAgICByZXR1cm4gdGhpcy4jY2FjaGVTaW1wbGVNZXRob2QoIkhhc0pTQWN0aW9ucyIpOwogIH0KICBnZXRDYWxjdWxhdGlvbk9yZGVySWRzKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRDYWxjdWxhdGlvbk9yZGVySWRzIiwgbnVsbCk7CiAgfQogIGdldERlc3RpbmF0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0RGVzdGluYXRpb25zIiwgbnVsbCk7CiAgfQogIGdldERlc3RpbmF0aW9uKGlkKSB7CiAgICBpZiAodHlwZW9mIGlkICE9PSAic3RyaW5nIikgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCJJbnZhbGlkIGRlc3RpbmF0aW9uIHJlcXVlc3QuIikpOwogICAgfQogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXREZXN0aW5hdGlvbiIsIHsKICAgICAgaWQKICAgIH0pOwogIH0KICBnZXRQYWdlTGFiZWxzKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRQYWdlTGFiZWxzIiwgbnVsbCk7CiAgfQogIGdldFBhZ2VMYXlvdXQoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldFBhZ2VMYXlvdXQiLCBudWxsKTsKICB9CiAgZ2V0UGFnZU1vZGUoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldFBhZ2VNb2RlIiwgbnVsbCk7CiAgfQogIGdldFZpZXdlclByZWZlcmVuY2VzKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRWaWV3ZXJQcmVmZXJlbmNlcyIsIG51bGwpOwogIH0KICBnZXRPcGVuQWN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRPcGVuQWN0aW9uIiwgbnVsbCk7CiAgfQogIGdldEF0dGFjaG1lbnRzKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRBdHRhY2htZW50cyIsIG51bGwpOwogIH0KICBnZXRBbm5vdGF0aW9uc0J5VHlwZSh0eXBlcywgcGFnZUluZGV4ZXNUb1NraXApIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0QW5ub3RhdGlvbnNCeVR5cGUiLCB7CiAgICAgIHR5cGVzLAogICAgICBwYWdlSW5kZXhlc1RvU2tpcAogICAgfSk7CiAgfQogIGdldERvY0pTQWN0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLiNjYWNoZVNpbXBsZU1ldGhvZCgiR2V0RG9jSlNBY3Rpb25zIik7CiAgfQogIGdldFBhZ2VKU0FjdGlvbnMocGFnZUluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldFBhZ2VKU0FjdGlvbnMiLCB7CiAgICAgIHBhZ2VJbmRleAogICAgfSk7CiAgfQogIGdldFN0cnVjdFRyZWUocGFnZUluZGV4KSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldFN0cnVjdFRyZWUiLCB7CiAgICAgIHBhZ2VJbmRleAogICAgfSk7CiAgfQogIGdldE91dGxpbmUoKSB7CiAgICByZXR1cm4gdGhpcy5tZXNzYWdlSGFuZGxlci5zZW5kV2l0aFByb21pc2UoIkdldE91dGxpbmUiLCBudWxsKTsKICB9CiAgZ2V0T3B0aW9uYWxDb250ZW50Q29uZmlnKHJlbmRlcmluZ0ludGVudCkgewogICAgcmV0dXJuIHRoaXMuI2NhY2hlU2ltcGxlTWV0aG9kKCJHZXRPcHRpb25hbENvbnRlbnRDb25maWciKS50aGVuKChkYXRhKSA9PiBuZXcgT3B0aW9uYWxDb250ZW50Q29uZmlnKGRhdGEsIHJlbmRlcmluZ0ludGVudCkpOwogIH0KICBnZXRQZXJtaXNzaW9ucygpIHsKICAgIHJldHVybiB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiR2V0UGVybWlzc2lvbnMiLCBudWxsKTsKICB9CiAgZ2V0TWV0YWRhdGEoKSB7CiAgICBjb25zdCBuYW1lID0gIkdldE1ldGFkYXRhIiwgY2FjaGVkUHJvbWlzZSA9IHRoaXMuI21ldGhvZFByb21pc2VzLmdldChuYW1lKTsKICAgIGlmIChjYWNoZWRQcm9taXNlKSB7CiAgICAgIHJldHVybiBjYWNoZWRQcm9taXNlOwogICAgfQogICAgY29uc3QgcHJvbWlzZSA9IHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKG5hbWUsIG51bGwpLnRoZW4oKHJlc3VsdHMpID0+ICh7CiAgICAgIGluZm86IHJlc3VsdHNbMF0sCiAgICAgIG1ldGFkYXRhOiByZXN1bHRzWzFdID8gbmV3IE1ldGFkYXRhKHJlc3VsdHNbMV0pIDogbnVsbCwKICAgICAgY29udGVudERpc3Bvc2l0aW9uRmlsZW5hbWU6IHRoaXMuX2Z1bGxSZWFkZXI/LmZpbGVuYW1lID8/IG51bGwsCiAgICAgIGNvbnRlbnRMZW5ndGg6IHRoaXMuX2Z1bGxSZWFkZXI/LmNvbnRlbnRMZW5ndGggPz8gbnVsbCwKICAgICAgaGFzU3RydWN0VHJlZTogcmVzdWx0c1syXQogICAgfSkpOwogICAgdGhpcy4jbWV0aG9kUHJvbWlzZXMuc2V0KG5hbWUsIHByb21pc2UpOwogICAgcmV0dXJuIHByb21pc2U7CiAgfQogIGdldE1hcmtJbmZvKCkgewogICAgcmV0dXJuIHRoaXMubWVzc2FnZUhhbmRsZXIuc2VuZFdpdGhQcm9taXNlKCJHZXRNYXJrSW5mbyIsIG51bGwpOwogIH0KICBhc3luYyBzdGFydENsZWFudXAoa2VlcExvYWRlZEZvbnRzID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBhd2FpdCB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNlbmRXaXRoUHJvbWlzZSgiQ2xlYW51cCIsIG51bGwpOwogICAgZm9yIChjb25zdCBwYWdlIG9mIHRoaXMuI3BhZ2VDYWNoZS52YWx1ZXMoKSkgewogICAgICBjb25zdCBjbGVhbnVwU3VjY2Vzc2Z1bCA9IHBhZ2UuY2xlYW51cCgpOwogICAgICBpZiAoIWNsZWFudXBTdWNjZXNzZnVsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBzdGFydENsZWFudXA6IFBhZ2UgJHtwYWdlLnBhZ2VOdW1iZXJ9IGlzIGN1cnJlbnRseSByZW5kZXJpbmcuYCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuY29tbW9uT2Jqcy5jbGVhcigpOwogICAgaWYgKCFrZWVwTG9hZGVkRm9udHMpIHsKICAgICAgdGhpcy5mb250TG9hZGVyLmNsZWFyKCk7CiAgICB9CiAgICB0aGlzLiNtZXRob2RQcm9taXNlcy5jbGVhcigpOwogICAgdGhpcy5maWx0ZXJGYWN0b3J5LmRlc3Ryb3kodHJ1ZSk7CiAgICBUZXh0TGF5ZXIuY2xlYW51cCgpOwogIH0KICBjYWNoZWRQYWdlTnVtYmVyKHJlZikgewogICAgaWYgKCFpc1JlZlByb3h5KHJlZikpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCByZWZTdHIgPSByZWYuZ2VuID09PSAwID8gYCR7cmVmLm51bX1SYCA6IGAke3JlZi5udW19UiR7cmVmLmdlbn1gOwogICAgcmV0dXJuIHRoaXMuI3BhZ2VSZWZDYWNoZS5nZXQocmVmU3RyKSA/PyBudWxsOwogIH0KfTsKdmFyIFJlbmRlclRhc2sgPSBjbGFzcyB7CiAgI2ludGVybmFsUmVuZGVyVGFzayA9IG51bGw7CiAgb25Db250aW51ZSA9IG51bGw7CiAgb25FcnJvciA9IG51bGw7CiAgY29uc3RydWN0b3IoaW50ZXJuYWxSZW5kZXJUYXNrKSB7CiAgICB0aGlzLiNpbnRlcm5hbFJlbmRlclRhc2sgPSBpbnRlcm5hbFJlbmRlclRhc2s7CiAgfQogIGdldCBwcm9taXNlKCkgewogICAgcmV0dXJuIHRoaXMuI2ludGVybmFsUmVuZGVyVGFzay5jYXBhYmlsaXR5LnByb21pc2U7CiAgfQogIGNhbmNlbChleHRyYURlbGF5ID0gMCkgewogICAgdGhpcy4jaW50ZXJuYWxSZW5kZXJUYXNrLmNhbmNlbChudWxsLCBleHRyYURlbGF5KTsKICB9CiAgZ2V0IHNlcGFyYXRlQW5ub3RzKCkgewogICAgY29uc3QgewogICAgICBzZXBhcmF0ZUFubm90cwogICAgfSA9IHRoaXMuI2ludGVybmFsUmVuZGVyVGFzay5vcGVyYXRvckxpc3Q7CiAgICBpZiAoIXNlcGFyYXRlQW5ub3RzKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgYW5ub3RhdGlvbkNhbnZhc01hcAogICAgfSA9IHRoaXMuI2ludGVybmFsUmVuZGVyVGFzazsKICAgIHJldHVybiBzZXBhcmF0ZUFubm90cy5mb3JtIHx8IHNlcGFyYXRlQW5ub3RzLmNhbnZhcyAmJiBhbm5vdGF0aW9uQ2FudmFzTWFwPy5zaXplID4gMDsKICB9Cn07CnZhciBJbnRlcm5hbFJlbmRlclRhc2sgPSBjbGFzcyBfSW50ZXJuYWxSZW5kZXJUYXNrIHsKICAjckFGID0gbnVsbDsKICBzdGF0aWMgI2NhbnZhc0luVXNlID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgY29uc3RydWN0b3IoewogICAgY2FsbGJhY2ssCiAgICBwYXJhbXMsCiAgICBvYmpzLAogICAgY29tbW9uT2JqcywKICAgIGFubm90YXRpb25DYW52YXNNYXAsCiAgICBvcGVyYXRvckxpc3QsCiAgICBwYWdlSW5kZXgsCiAgICBjYW52YXNGYWN0b3J5LAogICAgZmlsdGVyRmFjdG9yeSwKICAgIHVzZVJlcXVlc3RBbmltYXRpb25GcmFtZSA9IGZhbHNlLAogICAgcGRmQnVnID0gZmFsc2UsCiAgICBwYWdlQ29sb3JzID0gbnVsbCwKICAgIGVuYWJsZUhXQSA9IGZhbHNlLAogICAgb3BlcmF0aW9uc0ZpbHRlciA9IG51bGwKICB9KSB7CiAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgIHRoaXMub2JqcyA9IG9ianM7CiAgICB0aGlzLmNvbW1vbk9ianMgPSBjb21tb25PYmpzOwogICAgdGhpcy5hbm5vdGF0aW9uQ2FudmFzTWFwID0gYW5ub3RhdGlvbkNhbnZhc01hcDsKICAgIHRoaXMub3BlcmF0b3JMaXN0SWR4ID0gbnVsbDsKICAgIHRoaXMub3BlcmF0b3JMaXN0ID0gb3BlcmF0b3JMaXN0OwogICAgdGhpcy5fcGFnZUluZGV4ID0gcGFnZUluZGV4OwogICAgdGhpcy5jYW52YXNGYWN0b3J5ID0gY2FudmFzRmFjdG9yeTsKICAgIHRoaXMuZmlsdGVyRmFjdG9yeSA9IGZpbHRlckZhY3Rvcnk7CiAgICB0aGlzLl9wZGZCdWcgPSBwZGZCdWc7CiAgICB0aGlzLnBhZ2VDb2xvcnMgPSBwYWdlQ29sb3JzOwogICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7CiAgICB0aGlzLmdyYXBoaWNzUmVhZHlDYWxsYmFjayA9IG51bGw7CiAgICB0aGlzLmdyYXBoaWNzUmVhZHkgPSBmYWxzZTsKICAgIHRoaXMuX3VzZVJlcXVlc3RBbmltYXRpb25GcmFtZSA9IHVzZVJlcXVlc3RBbmltYXRpb25GcmFtZSA9PT0gdHJ1ZSAmJiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIjsKICAgIHRoaXMuY2FuY2VsbGVkID0gZmFsc2U7CiAgICB0aGlzLmNhcGFiaWxpdHkgPSBQcm9taXNlLndpdGhSZXNvbHZlcnMoKTsKICAgIHRoaXMudGFzayA9IG5ldyBSZW5kZXJUYXNrKHRoaXMpOwogICAgdGhpcy5fY2FuY2VsQm91bmQgPSB0aGlzLmNhbmNlbC5iaW5kKHRoaXMpOwogICAgdGhpcy5fY29udGludWVCb3VuZCA9IHRoaXMuX2NvbnRpbnVlLmJpbmQodGhpcyk7CiAgICB0aGlzLl9zY2hlZHVsZU5leHRCb3VuZCA9IHRoaXMuX3NjaGVkdWxlTmV4dC5iaW5kKHRoaXMpOwogICAgdGhpcy5fbmV4dEJvdW5kID0gdGhpcy5fbmV4dC5iaW5kKHRoaXMpOwogICAgdGhpcy5fY2FudmFzID0gcGFyYW1zLmNhbnZhczsKICAgIHRoaXMuX2NhbnZhc0NvbnRleHQgPSBwYXJhbXMuY2FudmFzID8gbnVsbCA6IHBhcmFtcy5jYW52YXNDb250ZXh0OwogICAgdGhpcy5fZW5hYmxlSFdBID0gZW5hYmxlSFdBOwogICAgdGhpcy5fZGVwZW5kZW5jeVRyYWNrZXIgPSBwYXJhbXMuZGVwZW5kZW5jeVRyYWNrZXI7CiAgICB0aGlzLl9vcGVyYXRpb25zRmlsdGVyID0gb3BlcmF0aW9uc0ZpbHRlcjsKICB9CiAgZ2V0IGNvbXBsZXRlZCgpIHsKICAgIHJldHVybiB0aGlzLmNhcGFiaWxpdHkucHJvbWlzZS5jYXRjaChmdW5jdGlvbigpIHsKICAgIH0pOwogIH0KICBpbml0aWFsaXplR3JhcGhpY3MoewogICAgdHJhbnNwYXJlbmN5ID0gZmFsc2UsCiAgICBvcHRpb25hbENvbnRlbnRDb25maWcKICB9KSB7CiAgICBpZiAodGhpcy5jYW5jZWxsZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuX2NhbnZhcykgewogICAgICBpZiAoX0ludGVybmFsUmVuZGVyVGFzay4jY2FudmFzSW5Vc2UuaGFzKHRoaXMuX2NhbnZhcykpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB1c2UgdGhlIHNhbWUgY2FudmFzIGR1cmluZyBtdWx0aXBsZSByZW5kZXIoKSBvcGVyYXRpb25zLiBVc2UgZGlmZmVyZW50IGNhbnZhcyBvciBlbnN1cmUgcHJldmlvdXMgb3BlcmF0aW9ucyB3ZXJlIGNhbmNlbGxlZCBvciBjb21wbGV0ZWQuIik7CiAgICAgIH0KICAgICAgX0ludGVybmFsUmVuZGVyVGFzay4jY2FudmFzSW5Vc2UuYWRkKHRoaXMuX2NhbnZhcyk7CiAgICB9CiAgICBpZiAodGhpcy5fcGRmQnVnICYmIGdsb2JhbFRoaXMuU3RlcHBlck1hbmFnZXI/LmVuYWJsZWQpIHsKICAgICAgdGhpcy5zdGVwcGVyID0gZ2xvYmFsVGhpcy5TdGVwcGVyTWFuYWdlci5jcmVhdGUodGhpcy5fcGFnZUluZGV4KTsKICAgICAgdGhpcy5zdGVwcGVyLmluaXQodGhpcy5vcGVyYXRvckxpc3QpOwogICAgICB0aGlzLnN0ZXBwZXIubmV4dEJyZWFrUG9pbnQgPSB0aGlzLnN0ZXBwZXIuZ2V0TmV4dEJyZWFrUG9pbnQoKTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgdmlld3BvcnQsCiAgICAgIHRyYW5zZm9ybSwKICAgICAgYmFja2dyb3VuZCwKICAgICAgZGVwZW5kZW5jeVRyYWNrZXIKICAgIH0gPSB0aGlzLnBhcmFtczsKICAgIGNvbnN0IGNhbnZhc0NvbnRleHQgPSB0aGlzLl9jYW52YXNDb250ZXh0IHx8IHRoaXMuX2NhbnZhcy5nZXRDb250ZXh0KCIyZCIsIHsKICAgICAgYWxwaGE6IGZhbHNlLAogICAgICB3aWxsUmVhZEZyZXF1ZW50bHk6ICF0aGlzLl9lbmFibGVIV0EKICAgIH0pOwogICAgdGhpcy5nZnggPSBuZXcgQ2FudmFzR3JhcGhpY3MoY2FudmFzQ29udGV4dCwgdGhpcy5jb21tb25PYmpzLCB0aGlzLm9ianMsIHRoaXMuY2FudmFzRmFjdG9yeSwgdGhpcy5maWx0ZXJGYWN0b3J5LCB7CiAgICAgIG9wdGlvbmFsQ29udGVudENvbmZpZwogICAgfSwgdGhpcy5hbm5vdGF0aW9uQ2FudmFzTWFwLCB0aGlzLnBhZ2VDb2xvcnMsIGRlcGVuZGVuY3lUcmFja2VyKTsKICAgIHRoaXMuZ2Z4LmJlZ2luRHJhd2luZyh7CiAgICAgIHRyYW5zZm9ybSwKICAgICAgdmlld3BvcnQsCiAgICAgIHRyYW5zcGFyZW5jeSwKICAgICAgYmFja2dyb3VuZAogICAgfSk7CiAgICB0aGlzLm9wZXJhdG9yTGlzdElkeCA9IDA7CiAgICB0aGlzLmdyYXBoaWNzUmVhZHkgPSB0cnVlOwogICAgdGhpcy5ncmFwaGljc1JlYWR5Q2FsbGJhY2s/LigpOwogIH0KICBjYW5jZWwoZXJyb3IgPSBudWxsLCBleHRyYURlbGF5ID0gMCkgewogICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7CiAgICB0aGlzLmNhbmNlbGxlZCA9IHRydWU7CiAgICB0aGlzLmdmeD8uZW5kRHJhd2luZygpOwogICAgaWYgKHRoaXMuI3JBRikgewogICAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy4jckFGKTsKICAgICAgdGhpcy4jckFGID0gbnVsbDsKICAgIH0KICAgIF9JbnRlcm5hbFJlbmRlclRhc2suI2NhbnZhc0luVXNlLmRlbGV0ZSh0aGlzLl9jYW52YXMpOwogICAgZXJyb3IgfHw9IG5ldyBSZW5kZXJpbmdDYW5jZWxsZWRFeGNlcHRpb24oYFJlbmRlcmluZyBjYW5jZWxsZWQsIHBhZ2UgJHt0aGlzLl9wYWdlSW5kZXggKyAxfWAsIGV4dHJhRGVsYXkpOwogICAgdGhpcy5jYWxsYmFjayhlcnJvcik7CiAgICB0aGlzLnRhc2sub25FcnJvcj8uKGVycm9yKTsKICB9CiAgb3BlcmF0b3JMaXN0Q2hhbmdlZCgpIHsKICAgIGlmICghdGhpcy5ncmFwaGljc1JlYWR5KSB7CiAgICAgIHRoaXMuZ3JhcGhpY3NSZWFkeUNhbGxiYWNrIHx8PSB0aGlzLl9jb250aW51ZUJvdW5kOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmdmeC5kZXBlbmRlbmN5VHJhY2tlcj8uZ3Jvd09wZXJhdGlvbnNDb3VudCh0aGlzLm9wZXJhdG9yTGlzdC5mbkFycmF5Lmxlbmd0aCk7CiAgICB0aGlzLnN0ZXBwZXI/LnVwZGF0ZU9wZXJhdG9yTGlzdCh0aGlzLm9wZXJhdG9yTGlzdCk7CiAgICBpZiAodGhpcy5ydW5uaW5nKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2NvbnRpbnVlKCk7CiAgfQogIF9jb250aW51ZSgpIHsKICAgIHRoaXMucnVubmluZyA9IHRydWU7CiAgICBpZiAodGhpcy5jYW5jZWxsZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMudGFzay5vbkNvbnRpbnVlKSB7CiAgICAgIHRoaXMudGFzay5vbkNvbnRpbnVlKHRoaXMuX3NjaGVkdWxlTmV4dEJvdW5kKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3NjaGVkdWxlTmV4dCgpOwogICAgfQogIH0KICBfc2NoZWR1bGVOZXh0KCkgewogICAgaWYgKHRoaXMuX3VzZVJlcXVlc3RBbmltYXRpb25GcmFtZSkgewogICAgICB0aGlzLiNyQUYgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsKICAgICAgICB0aGlzLiNyQUYgPSBudWxsOwogICAgICAgIHRoaXMuX25leHRCb3VuZCgpLmNhdGNoKHRoaXMuX2NhbmNlbEJvdW5kKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKHRoaXMuX25leHRCb3VuZCkuY2F0Y2godGhpcy5fY2FuY2VsQm91bmQpOwogICAgfQogIH0KICBhc3luYyBfbmV4dCgpIHsKICAgIGlmICh0aGlzLmNhbmNlbGxlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLm9wZXJhdG9yTGlzdElkeCA9IHRoaXMuZ2Z4LmV4ZWN1dGVPcGVyYXRvckxpc3QodGhpcy5vcGVyYXRvckxpc3QsIHRoaXMub3BlcmF0b3JMaXN0SWR4LCB0aGlzLl9jb250aW51ZUJvdW5kLCB0aGlzLnN0ZXBwZXIsIHRoaXMuX29wZXJhdGlvbnNGaWx0ZXIpOwogICAgaWYgKHRoaXMub3BlcmF0b3JMaXN0SWR4ID09PSB0aGlzLm9wZXJhdG9yTGlzdC5hcmdzQXJyYXkubGVuZ3RoKSB7CiAgICAgIHRoaXMucnVubmluZyA9IGZhbHNlOwogICAgICBpZiAodGhpcy5vcGVyYXRvckxpc3QubGFzdENodW5rKSB7CiAgICAgICAgdGhpcy5nZnguZW5kRHJhd2luZygpOwogICAgICAgIF9JbnRlcm5hbFJlbmRlclRhc2suI2NhbnZhc0luVXNlLmRlbGV0ZSh0aGlzLl9jYW52YXMpOwogICAgICAgIHRoaXMuY2FsbGJhY2soKTsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIHZlcnNpb24gPSAiNS40LjUzMCI7CnZhciBidWlsZCA9ICI1MGNjNGFkYWMiOwp2YXIgQ29sb3JQaWNrZXIgPSBjbGFzcyBfQ29sb3JQaWNrZXIgewogICNidXR0b24gPSBudWxsOwogICNidXR0b25Td2F0Y2ggPSBudWxsOwogICNkZWZhdWx0Q29sb3I7CiAgI2Ryb3Bkb3duID0gbnVsbDsKICAjZHJvcGRvd25XYXNGcm9tS2V5Ym9hcmQgPSBmYWxzZTsKICAjaXNNYWluQ29sb3JQaWNrZXIgPSBmYWxzZTsKICAjZWRpdG9yID0gbnVsbDsKICAjZXZlbnRCdXM7CiAgI29wZW5Ecm9wZG93bkFDID0gbnVsbDsKICAjdWlNYW5hZ2VyID0gbnVsbDsKICBzdGF0aWMgI2wxMG5Db2xvciA9IG51bGw7CiAgc3RhdGljIGdldCBfa2V5Ym9hcmRNYW5hZ2VyKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2tleWJvYXJkTWFuYWdlciIsIG5ldyBLZXlib2FyZE1hbmFnZXIoW1tbIkVzY2FwZSIsICJtYWMrRXNjYXBlIl0sIF9Db2xvclBpY2tlci5wcm90b3R5cGUuX2hpZGVEcm9wZG93bkZyb21LZXlib2FyZF0sIFtbIiAiLCAibWFjKyAiXSwgX0NvbG9yUGlja2VyLnByb3RvdHlwZS5fY29sb3JTZWxlY3RGcm9tS2V5Ym9hcmRdLCBbWyJBcnJvd0Rvd24iLCAiQXJyb3dSaWdodCIsICJtYWMrQXJyb3dEb3duIiwgIm1hYytBcnJvd1JpZ2h0Il0sIF9Db2xvclBpY2tlci5wcm90b3R5cGUuX21vdmVUb05leHRdLCBbWyJBcnJvd1VwIiwgIkFycm93TGVmdCIsICJtYWMrQXJyb3dVcCIsICJtYWMrQXJyb3dMZWZ0Il0sIF9Db2xvclBpY2tlci5wcm90b3R5cGUuX21vdmVUb1ByZXZpb3VzXSwgW1siSG9tZSIsICJtYWMrSG9tZSJdLCBfQ29sb3JQaWNrZXIucHJvdG90eXBlLl9tb3ZlVG9CZWdpbm5pbmddLCBbWyJFbmQiLCAibWFjK0VuZCJdLCBfQ29sb3JQaWNrZXIucHJvdG90eXBlLl9tb3ZlVG9FbmRdXSkpOwogIH0KICBjb25zdHJ1Y3Rvcih7CiAgICBlZGl0b3IgPSBudWxsLAogICAgdWlNYW5hZ2VyID0gbnVsbAogIH0pIHsKICAgIGlmIChlZGl0b3IpIHsKICAgICAgdGhpcy4jaXNNYWluQ29sb3JQaWNrZXIgPSBmYWxzZTsKICAgICAgdGhpcy4jZWRpdG9yID0gZWRpdG9yOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jaXNNYWluQ29sb3JQaWNrZXIgPSB0cnVlOwogICAgfQogICAgdGhpcy4jdWlNYW5hZ2VyID0gZWRpdG9yPy5fdWlNYW5hZ2VyIHx8IHVpTWFuYWdlcjsKICAgIHRoaXMuI2V2ZW50QnVzID0gdGhpcy4jdWlNYW5hZ2VyLl9ldmVudEJ1czsKICAgIHRoaXMuI2RlZmF1bHRDb2xvciA9IGVkaXRvcj8uY29sb3I/LnRvVXBwZXJDYXNlKCkgfHwgdGhpcy4jdWlNYW5hZ2VyPy5oaWdobGlnaHRDb2xvcnMudmFsdWVzKCkubmV4dCgpLnZhbHVlIHx8ICIjRkZGRjk4IjsKICAgIF9Db2xvclBpY2tlci4jbDEwbkNvbG9yIHx8PSBPYmplY3QuZnJlZXplKHsKICAgICAgYmx1ZTogInBkZmpzLWVkaXRvci1jb2xvcnBpY2tlci1ibHVlIiwKICAgICAgZ3JlZW46ICJwZGZqcy1lZGl0b3ItY29sb3JwaWNrZXItZ3JlZW4iLAogICAgICBwaW5rOiAicGRmanMtZWRpdG9yLWNvbG9ycGlja2VyLXBpbmsiLAogICAgICByZWQ6ICJwZGZqcy1lZGl0b3ItY29sb3JwaWNrZXItcmVkIiwKICAgICAgeWVsbG93OiAicGRmanMtZWRpdG9yLWNvbG9ycGlja2VyLXllbGxvdyIKICAgIH0pOwogIH0KICByZW5kZXJCdXR0b24oKSB7CiAgICBjb25zdCBidXR0b24gPSB0aGlzLiNidXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgIGJ1dHRvbi5jbGFzc05hbWUgPSAiY29sb3JQaWNrZXIiOwogICAgYnV0dG9uLnRhYkluZGV4ID0gIjAiOwogICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLWVkaXRvci1jb2xvcnBpY2tlci1idXR0b24iKTsKICAgIGJ1dHRvbi5hcmlhSGFzUG9wdXAgPSAidHJ1ZSI7CiAgICBpZiAodGhpcy4jZWRpdG9yKSB7CiAgICAgIGJ1dHRvbi5hcmlhQ29udHJvbHMgPSBgJHt0aGlzLiNlZGl0b3IuaWR9X2NvbG9ycGlja2VyX2Ryb3Bkb3duYDsKICAgIH0KICAgIGNvbnN0IHNpZ25hbCA9IHRoaXMuI3VpTWFuYWdlci5fc2lnbmFsOwogICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy4jb3BlbkRyb3Bkb3duLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy4ja2V5RG93bi5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBjb25zdCBzd2F0Y2ggPSB0aGlzLiNidXR0b25Td2F0Y2ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICBzd2F0Y2guY2xhc3NOYW1lID0gInN3YXRjaCI7CiAgICBzd2F0Y2guYXJpYUhpZGRlbiA9ICJ0cnVlIjsKICAgIHN3YXRjaC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSB0aGlzLiNkZWZhdWx0Q29sb3I7CiAgICBidXR0b24uYXBwZW5kKHN3YXRjaCk7CiAgICByZXR1cm4gYnV0dG9uOwogIH0KICByZW5kZXJNYWluRHJvcGRvd24oKSB7CiAgICBjb25zdCBkcm9wZG93biA9IHRoaXMuI2Ryb3Bkb3duID0gdGhpcy4jZ2V0RHJvcGRvd25Sb290KCk7CiAgICBkcm9wZG93bi5hcmlhT3JpZW50YXRpb24gPSAiaG9yaXpvbnRhbCI7CiAgICBkcm9wZG93bi5hcmlhTGFiZWxsZWRCeSA9ICJoaWdobGlnaHRDb2xvclBpY2tlckxhYmVsIjsKICAgIHJldHVybiBkcm9wZG93bjsKICB9CiAgI2dldERyb3Bkb3duUm9vdCgpIHsKICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy4jdWlNYW5hZ2VyLl9zaWduYWw7CiAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBkaXYuY2xhc3NOYW1lID0gImRyb3Bkb3duIjsKICAgIGRpdi5yb2xlID0gImxpc3Rib3giOwogICAgZGl2LmFyaWFNdWx0aVNlbGVjdGFibGUgPSAiZmFsc2UiOwogICAgZGl2LmFyaWFPcmllbnRhdGlvbiA9ICJ2ZXJ0aWNhbCI7CiAgICBkaXYuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCAicGRmanMtZWRpdG9yLWNvbG9ycGlja2VyLWRyb3Bkb3duIik7CiAgICBpZiAodGhpcy4jZWRpdG9yKSB7CiAgICAgIGRpdi5pZCA9IGAke3RoaXMuI2VkaXRvci5pZH1fY29sb3JwaWNrZXJfZHJvcGRvd25gOwogICAgfQogICAgZm9yIChjb25zdCBbbmFtZSwgY29sb3JdIG9mIHRoaXMuI3VpTWFuYWdlci5oaWdobGlnaHRDb2xvcnMpIHsKICAgICAgY29uc3QgYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnV0dG9uIik7CiAgICAgIGJ1dHRvbi50YWJJbmRleCA9ICIwIjsKICAgICAgYnV0dG9uLnJvbGUgPSAib3B0aW9uIjsKICAgICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgiZGF0YS1jb2xvciIsIGNvbG9yKTsKICAgICAgYnV0dG9uLnRpdGxlID0gbmFtZTsKICAgICAgYnV0dG9uLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgX0NvbG9yUGlja2VyLiNsMTBuQ29sb3JbbmFtZV0pOwogICAgICBjb25zdCBzd2F0Y2ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzcGFuIik7CiAgICAgIGJ1dHRvbi5hcHBlbmQoc3dhdGNoKTsKICAgICAgc3dhdGNoLmNsYXNzTmFtZSA9ICJzd2F0Y2giOwogICAgICBzd2F0Y2guc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3I7CiAgICAgIGJ1dHRvbi5hcmlhU2VsZWN0ZWQgPSBjb2xvciA9PT0gdGhpcy4jZGVmYXVsdENvbG9yOwogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLiNjb2xvclNlbGVjdC5iaW5kKHRoaXMsIGNvbG9yKSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgZGl2LmFwcGVuZChidXR0b24pOwogICAgfQogICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLiNrZXlEb3duLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHJldHVybiBkaXY7CiAgfQogICNjb2xvclNlbGVjdChjb2xvciwgZXZlbnQpIHsKICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgdGhpcy4jZXZlbnRCdXMuZGlzcGF0Y2goInN3aXRjaGFubm90YXRpb25lZGl0b3JwYXJhbXMiLCB7CiAgICAgIHNvdXJjZTogdGhpcywKICAgICAgdHlwZTogQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX0NPTE9SLAogICAgICB2YWx1ZTogY29sb3IKICAgIH0pOwogICAgdGhpcy51cGRhdGVDb2xvcihjb2xvcik7CiAgfQogIF9jb2xvclNlbGVjdEZyb21LZXlib2FyZChldmVudCkgewogICAgaWYgKGV2ZW50LnRhcmdldCA9PT0gdGhpcy4jYnV0dG9uKSB7CiAgICAgIHRoaXMuI29wZW5Ecm9wZG93bihldmVudCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGNvbG9yID0gZXZlbnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgiZGF0YS1jb2xvciIpOwogICAgaWYgKCFjb2xvcikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNjb2xvclNlbGVjdChjb2xvciwgZXZlbnQpOwogIH0KICBfbW92ZVRvTmV4dChldmVudCkgewogICAgaWYgKCF0aGlzLiNpc0Ryb3Bkb3duVmlzaWJsZSkgewogICAgICB0aGlzLiNvcGVuRHJvcGRvd24oZXZlbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSB0aGlzLiNidXR0b24pIHsKICAgICAgdGhpcy4jZHJvcGRvd24uZmlyc3RFbGVtZW50Q2hpbGQ/LmZvY3VzKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGV2ZW50LnRhcmdldC5uZXh0U2libGluZz8uZm9jdXMoKTsKICB9CiAgX21vdmVUb1ByZXZpb3VzKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSB0aGlzLiNkcm9wZG93bj8uZmlyc3RFbGVtZW50Q2hpbGQgfHwgZXZlbnQudGFyZ2V0ID09PSB0aGlzLiNidXR0b24pIHsKICAgICAgaWYgKHRoaXMuI2lzRHJvcGRvd25WaXNpYmxlKSB7CiAgICAgICAgdGhpcy5faGlkZURyb3Bkb3duRnJvbUtleWJvYXJkKCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLiNpc0Ryb3Bkb3duVmlzaWJsZSkgewogICAgICB0aGlzLiNvcGVuRHJvcGRvd24oZXZlbnQpOwogICAgfQogICAgZXZlbnQudGFyZ2V0LnByZXZpb3VzU2libGluZz8uZm9jdXMoKTsKICB9CiAgX21vdmVUb0JlZ2lubmluZyhldmVudCkgewogICAgaWYgKCF0aGlzLiNpc0Ryb3Bkb3duVmlzaWJsZSkgewogICAgICB0aGlzLiNvcGVuRHJvcGRvd24oZXZlbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNkcm9wZG93bi5maXJzdEVsZW1lbnRDaGlsZD8uZm9jdXMoKTsKICB9CiAgX21vdmVUb0VuZChldmVudCkgewogICAgaWYgKCF0aGlzLiNpc0Ryb3Bkb3duVmlzaWJsZSkgewogICAgICB0aGlzLiNvcGVuRHJvcGRvd24oZXZlbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNkcm9wZG93bi5sYXN0RWxlbWVudENoaWxkPy5mb2N1cygpOwogIH0KICAja2V5RG93bihldmVudCkgewogICAgX0NvbG9yUGlja2VyLl9rZXlib2FyZE1hbmFnZXIuZXhlYyh0aGlzLCBldmVudCk7CiAgfQogICNvcGVuRHJvcGRvd24oZXZlbnQpIHsKICAgIGlmICh0aGlzLiNpc0Ryb3Bkb3duVmlzaWJsZSkgewogICAgICB0aGlzLmhpZGVEcm9wZG93bigpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNkcm9wZG93bldhc0Zyb21LZXlib2FyZCA9IGV2ZW50LmRldGFpbCA9PT0gMDsKICAgIGlmICghdGhpcy4jb3BlbkRyb3Bkb3duQUMpIHsKICAgICAgdGhpcy4jb3BlbkRyb3Bkb3duQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHRoaXMuI3BvaW50ZXJEb3duLmJpbmQodGhpcyksIHsKICAgICAgICBzaWduYWw6IHRoaXMuI3VpTWFuYWdlci5jb21iaW5lZFNpZ25hbCh0aGlzLiNvcGVuRHJvcGRvd25BQykKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLiNidXR0b24uYXJpYUV4cGFuZGVkID0gInRydWUiOwogICAgaWYgKHRoaXMuI2Ryb3Bkb3duKSB7CiAgICAgIHRoaXMuI2Ryb3Bkb3duLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCByb290MiA9IHRoaXMuI2Ryb3Bkb3duID0gdGhpcy4jZ2V0RHJvcGRvd25Sb290KCk7CiAgICB0aGlzLiNidXR0b24uYXBwZW5kKHJvb3QyKTsKICB9CiAgI3BvaW50ZXJEb3duKGV2ZW50KSB7CiAgICBpZiAodGhpcy4jZHJvcGRvd24/LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5oaWRlRHJvcGRvd24oKTsKICB9CiAgaGlkZURyb3Bkb3duKCkgewogICAgdGhpcy4jZHJvcGRvd24/LmNsYXNzTGlzdC5hZGQoImhpZGRlbiIpOwogICAgdGhpcy4jYnV0dG9uLmFyaWFFeHBhbmRlZCA9ICJmYWxzZSI7CiAgICB0aGlzLiNvcGVuRHJvcGRvd25BQz8uYWJvcnQoKTsKICAgIHRoaXMuI29wZW5Ecm9wZG93bkFDID0gbnVsbDsKICB9CiAgZ2V0ICNpc0Ryb3Bkb3duVmlzaWJsZSgpIHsKICAgIHJldHVybiB0aGlzLiNkcm9wZG93biAmJiAhdGhpcy4jZHJvcGRvd24uY2xhc3NMaXN0LmNvbnRhaW5zKCJoaWRkZW4iKTsKICB9CiAgX2hpZGVEcm9wZG93bkZyb21LZXlib2FyZCgpIHsKICAgIGlmICh0aGlzLiNpc01haW5Db2xvclBpY2tlcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI2lzRHJvcGRvd25WaXNpYmxlKSB7CiAgICAgIHRoaXMuI2VkaXRvcj8udW5zZWxlY3QoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5oaWRlRHJvcGRvd24oKTsKICAgIHRoaXMuI2J1dHRvbi5mb2N1cyh7CiAgICAgIHByZXZlbnRTY3JvbGw6IHRydWUsCiAgICAgIGZvY3VzVmlzaWJsZTogdGhpcy4jZHJvcGRvd25XYXNGcm9tS2V5Ym9hcmQKICAgIH0pOwogIH0KICB1cGRhdGVDb2xvcihjb2xvcikgewogICAgaWYgKHRoaXMuI2J1dHRvblN3YXRjaCkgewogICAgICB0aGlzLiNidXR0b25Td2F0Y2guc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3I7CiAgICB9CiAgICBpZiAoIXRoaXMuI2Ryb3Bkb3duKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGkgPSB0aGlzLiN1aU1hbmFnZXIuaGlnaGxpZ2h0Q29sb3JzLnZhbHVlcygpOwogICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLiNkcm9wZG93bi5jaGlsZHJlbikgewogICAgICBjaGlsZC5hcmlhU2VsZWN0ZWQgPSBpLm5leHQoKS52YWx1ZSA9PT0gY29sb3IudG9VcHBlckNhc2UoKTsKICAgIH0KICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI2J1dHRvbj8ucmVtb3ZlKCk7CiAgICB0aGlzLiNidXR0b24gPSBudWxsOwogICAgdGhpcy4jYnV0dG9uU3dhdGNoID0gbnVsbDsKICAgIHRoaXMuI2Ryb3Bkb3duPy5yZW1vdmUoKTsKICAgIHRoaXMuI2Ryb3Bkb3duID0gbnVsbDsKICB9Cn07CnZhciBCYXNpY0NvbG9yUGlja2VyID0gY2xhc3MgX0Jhc2ljQ29sb3JQaWNrZXIgewogICNpbnB1dCA9IG51bGw7CiAgI2VkaXRvciA9IG51bGw7CiAgI3VpTWFuYWdlciA9IG51bGw7CiAgc3RhdGljICNsMTBuQ29sb3IgPSBudWxsOwogIGNvbnN0cnVjdG9yKGVkaXRvcikgewogICAgdGhpcy4jZWRpdG9yID0gZWRpdG9yOwogICAgdGhpcy4jdWlNYW5hZ2VyID0gZWRpdG9yLl91aU1hbmFnZXI7CiAgICBfQmFzaWNDb2xvclBpY2tlci4jbDEwbkNvbG9yIHx8PSBPYmplY3QuZnJlZXplKHsKICAgICAgZnJlZXRleHQ6ICJwZGZqcy1lZGl0b3ItY29sb3ItcGlja2VyLWZyZWUtdGV4dC1pbnB1dCIsCiAgICAgIGluazogInBkZmpzLWVkaXRvci1jb2xvci1waWNrZXItaW5rLWlucHV0IgogICAgfSk7CiAgfQogIHJlbmRlckJ1dHRvbigpIHsKICAgIGlmICh0aGlzLiNpbnB1dCkgewogICAgICByZXR1cm4gdGhpcy4jaW5wdXQ7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGVkaXRvclR5cGUsCiAgICAgIGNvbG9yVHlwZSwKICAgICAgY29sb3IKICAgIH0gPSB0aGlzLiNlZGl0b3I7CiAgICBjb25zdCBpbnB1dCA9IHRoaXMuI2lucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIGlucHV0LnR5cGUgPSAiY29sb3IiOwogICAgaW5wdXQudmFsdWUgPSBjb2xvciB8fCAiIzAwMDAwMCI7CiAgICBpbnB1dC5jbGFzc05hbWUgPSAiYmFzaWNDb2xvclBpY2tlciI7CiAgICBpbnB1dC50YWJJbmRleCA9IDA7CiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsIF9CYXNpY0NvbG9yUGlja2VyLiNsMTBuQ29sb3JbZWRpdG9yVHlwZV0pOwogICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCAoKSA9PiB7CiAgICAgIHRoaXMuI3VpTWFuYWdlci51cGRhdGVQYXJhbXMoY29sb3JUeXBlLCBpbnB1dC52YWx1ZSk7CiAgICB9LCB7CiAgICAgIHNpZ25hbDogdGhpcy4jdWlNYW5hZ2VyLl9zaWduYWwKICAgIH0pOwogICAgcmV0dXJuIGlucHV0OwogIH0KICB1cGRhdGUodmFsdWUpIHsKICAgIGlmICghdGhpcy4jaW5wdXQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jaW5wdXQudmFsdWUgPSB2YWx1ZTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuI2lucHV0Py5yZW1vdmUoKTsKICAgIHRoaXMuI2lucHV0ID0gbnVsbDsKICB9CiAgaGlkZURyb3Bkb3duKCkgewogIH0KfTsKZnVuY3Rpb24gbWFrZUNvbG9yQ29tcChuKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgbikpICogMjU1KS50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKTsKfQpmdW5jdGlvbiBzY2FsZUFuZENsYW1wKHgpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMjU1LCAyNTUgKiB4KSk7Cn0KdmFyIENvbG9yQ29udmVydGVycyA9IGNsYXNzIHsKICBzdGF0aWMgQ01ZS19HKFtjLCB5LCBtLCBrXSkgewogICAgcmV0dXJuIFsiRyIsIDEgLSBNYXRoLm1pbigxLCAwLjMgKiBjICsgMC41OSAqIG0gKyAwLjExICogeSArIGspXTsKICB9CiAgc3RhdGljIEdfQ01ZSyhbZ10pIHsKICAgIHJldHVybiBbIkNNWUsiLCAwLCAwLCAwLCAxIC0gZ107CiAgfQogIHN0YXRpYyBHX1JHQihbZ10pIHsKICAgIHJldHVybiBbIlJHQiIsIGcsIGcsIGddOwogIH0KICBzdGF0aWMgR19yZ2IoW2ddKSB7CiAgICBnID0gc2NhbGVBbmRDbGFtcChnKTsKICAgIHJldHVybiBbZywgZywgZ107CiAgfQogIHN0YXRpYyBHX0hUTUwoW2ddKSB7CiAgICBjb25zdCBHID0gbWFrZUNvbG9yQ29tcChnKTsKICAgIHJldHVybiBgIyR7R30ke0d9JHtHfWA7CiAgfQogIHN0YXRpYyBSR0JfRyhbciwgZywgYl0pIHsKICAgIHJldHVybiBbIkciLCAwLjMgKiByICsgMC41OSAqIGcgKyAwLjExICogYl07CiAgfQogIHN0YXRpYyBSR0JfcmdiKGNvbG9yKSB7CiAgICByZXR1cm4gY29sb3IubWFwKHNjYWxlQW5kQ2xhbXApOwogIH0KICBzdGF0aWMgUkdCX0hUTUwoY29sb3IpIHsKICAgIHJldHVybiBgIyR7Y29sb3IubWFwKG1ha2VDb2xvckNvbXApLmpvaW4oIiIpfWA7CiAgfQogIHN0YXRpYyBUX0hUTUwoKSB7CiAgICByZXR1cm4gIiMwMDAwMDAwMCI7CiAgfQogIHN0YXRpYyBUX3JnYigpIHsKICAgIHJldHVybiBbbnVsbF07CiAgfQogIHN0YXRpYyBDTVlLX1JHQihbYywgeSwgbSwga10pIHsKICAgIHJldHVybiBbIlJHQiIsIDEgLSBNYXRoLm1pbigxLCBjICsgayksIDEgLSBNYXRoLm1pbigxLCBtICsgayksIDEgLSBNYXRoLm1pbigxLCB5ICsgayldOwogIH0KICBzdGF0aWMgQ01ZS19yZ2IoW2MsIHksIG0sIGtdKSB7CiAgICByZXR1cm4gW3NjYWxlQW5kQ2xhbXAoMSAtIE1hdGgubWluKDEsIGMgKyBrKSksIHNjYWxlQW5kQ2xhbXAoMSAtIE1hdGgubWluKDEsIG0gKyBrKSksIHNjYWxlQW5kQ2xhbXAoMSAtIE1hdGgubWluKDEsIHkgKyBrKSldOwogIH0KICBzdGF0aWMgQ01ZS19IVE1MKGNvbXBvbmVudHMpIHsKICAgIGNvbnN0IHJnYiA9IHRoaXMuQ01ZS19SR0IoY29tcG9uZW50cykuc2xpY2UoMSk7CiAgICByZXR1cm4gdGhpcy5SR0JfSFRNTChyZ2IpOwogIH0KICBzdGF0aWMgUkdCX0NNWUsoW3IsIGcsIGJdKSB7CiAgICBjb25zdCBjID0gMSAtIHI7CiAgICBjb25zdCBtID0gMSAtIGc7CiAgICBjb25zdCB5ID0gMSAtIGI7CiAgICBjb25zdCBrID0gTWF0aC5taW4oYywgbSwgeSk7CiAgICByZXR1cm4gWyJDTVlLIiwgYywgbSwgeSwga107CiAgfQp9Owp2YXIgQmFzZVNWR0ZhY3RvcnkgPSBjbGFzcyB7CiAgY3JlYXRlKHdpZHRoLCBoZWlnaHQsIHNraXBEaW1lbnNpb25zID0gZmFsc2UpIHsKICAgIGlmICh3aWR0aCA8PSAwIHx8IGhlaWdodCA8PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBTVkcgZGltZW5zaW9ucyIpOwogICAgfQogICAgY29uc3Qgc3ZnID0gdGhpcy5fY3JlYXRlU1ZHKCJzdmc6c3ZnIik7CiAgICBzdmcuc2V0QXR0cmlidXRlKCJ2ZXJzaW9uIiwgIjEuMSIpOwogICAgaWYgKCFza2lwRGltZW5zaW9ucykgewogICAgICBzdmcuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIGAke3dpZHRofXB4YCk7CiAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoImhlaWdodCIsIGAke2hlaWdodH1weGApOwogICAgfQogICAgc3ZnLnNldEF0dHJpYnV0ZSgicHJlc2VydmVBc3BlY3RSYXRpbyIsICJub25lIik7CiAgICBzdmcuc2V0QXR0cmlidXRlKCJ2aWV3Qm94IiwgYDAgMCAke3dpZHRofSAke2hlaWdodH1gKTsKICAgIHJldHVybiBzdmc7CiAgfQogIGNyZWF0ZUVsZW1lbnQodHlwZSkgewogICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgU1ZHIGVsZW1lbnQgdHlwZSIpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX2NyZWF0ZVNWRyh0eXBlKTsKICB9CiAgX2NyZWF0ZVNWRyh0eXBlKSB7CiAgICB1bnJlYWNoYWJsZSgiQWJzdHJhY3QgbWV0aG9kIGBfY3JlYXRlU1ZHYCBjYWxsZWQuIik7CiAgfQp9Owp2YXIgRE9NU1ZHRmFjdG9yeSA9IGNsYXNzIGV4dGVuZHMgQmFzZVNWR0ZhY3RvcnkgewogIF9jcmVhdGVTVkcodHlwZSkgewogICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhTVkdfTlMsIHR5cGUpOwogIH0KfTsKdmFyIGFubm90YXRpb25fbGF5ZXJfREVGQVVMVF9GT05UX1NJWkUgPSA5Owp2YXIgR2V0RWxlbWVudHNCeU5hbWVTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKdmFyIFRJTUVaT05FX09GRlNFVCA9ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwICogMWUzOwp2YXIgQW5ub3RhdGlvbkVsZW1lbnRGYWN0b3J5ID0gY2xhc3MgewogIHN0YXRpYyBjcmVhdGUocGFyYW1ldGVycykgewogICAgY29uc3Qgc3VidHlwZSA9IHBhcmFtZXRlcnMuZGF0YS5hbm5vdGF0aW9uVHlwZTsKICAgIHN3aXRjaCAoc3VidHlwZSkgewogICAgICBjYXNlIEFubm90YXRpb25UeXBlLkxJTks6CiAgICAgICAgcmV0dXJuIG5ldyBMaW5rQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuVEVYVDoKICAgICAgICByZXR1cm4gbmV3IFRleHRBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5XSURHRVQ6CiAgICAgICAgY29uc3QgZmllbGRUeXBlID0gcGFyYW1ldGVycy5kYXRhLmZpZWxkVHlwZTsKICAgICAgICBzd2l0Y2ggKGZpZWxkVHlwZSkgewogICAgICAgICAgY2FzZSAiVHgiOgogICAgICAgICAgICByZXR1cm4gbmV3IFRleHRXaWRnZXRBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgICAgIGNhc2UgIkJ0biI6CiAgICAgICAgICAgIGlmIChwYXJhbWV0ZXJzLmRhdGEucmFkaW9CdXR0b24pIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IFJhZGlvQnV0dG9uV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocGFyYW1ldGVycy5kYXRhLmNoZWNrQm94KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDaGVja2JveFdpZGdldEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXcgUHVzaEJ1dHRvbldpZGdldEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICAgICAgY2FzZSAiQ2giOgogICAgICAgICAgICByZXR1cm4gbmV3IENob2ljZVdpZGdldEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICAgICAgY2FzZSAiU2lnIjoKICAgICAgICAgICAgcmV0dXJuIG5ldyBTaWduYXR1cmVXaWRnZXRBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBXaWRnZXRBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5QT1BVUDoKICAgICAgICByZXR1cm4gbmV3IFBvcHVwQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuRlJFRVRFWFQ6CiAgICAgICAgcmV0dXJuIG5ldyBGcmVlVGV4dEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLkxJTkU6CiAgICAgICAgcmV0dXJuIG5ldyBMaW5lQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuU1FVQVJFOgogICAgICAgIHJldHVybiBuZXcgU3F1YXJlQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuQ0lSQ0xFOgogICAgICAgIHJldHVybiBuZXcgQ2lyY2xlQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuUE9MWUxJTkU6CiAgICAgICAgcmV0dXJuIG5ldyBQb2x5bGluZUFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLkNBUkVUOgogICAgICAgIHJldHVybiBuZXcgQ2FyZXRBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5JTks6CiAgICAgICAgcmV0dXJuIG5ldyBJbmtBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5QT0xZR09OOgogICAgICAgIHJldHVybiBuZXcgUG9seWdvbkFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLkhJR0hMSUdIVDoKICAgICAgICByZXR1cm4gbmV3IEhpZ2hsaWdodEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLlVOREVSTElORToKICAgICAgICByZXR1cm4gbmV3IFVuZGVybGluZUFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBjYXNlIEFubm90YXRpb25UeXBlLlNRVUlHR0xZOgogICAgICAgIHJldHVybiBuZXcgU3F1aWdnbHlBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5TVFJJS0VPVVQ6CiAgICAgICAgcmV0dXJuIG5ldyBTdHJpa2VPdXRBbm5vdGF0aW9uRWxlbWVudChwYXJhbWV0ZXJzKTsKICAgICAgY2FzZSBBbm5vdGF0aW9uVHlwZS5TVEFNUDoKICAgICAgICByZXR1cm4gbmV3IFN0YW1wQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICAgIGNhc2UgQW5ub3RhdGlvblR5cGUuRklMRUFUVEFDSE1FTlQ6CiAgICAgICAgcmV0dXJuIG5ldyBGaWxlQXR0YWNobWVudEFubm90YXRpb25FbGVtZW50KHBhcmFtZXRlcnMpOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBuZXcgQW5ub3RhdGlvbkVsZW1lbnQocGFyYW1ldGVycyk7CiAgICB9CiAgfQp9Owp2YXIgQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBfQW5ub3RhdGlvbkVsZW1lbnQgewogICN1cGRhdGVzID0gbnVsbDsKICAjaGFzQm9yZGVyID0gZmFsc2U7CiAgI3BvcHVwRWxlbWVudCA9IG51bGw7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycywgewogICAgaXNSZW5kZXJhYmxlID0gZmFsc2UsCiAgICBpZ25vcmVCb3JkZXIgPSBmYWxzZSwKICAgIGNyZWF0ZVF1YWRyaWxhdGVyYWxzID0gZmFsc2UKICB9ID0ge30pIHsKICAgIHRoaXMuaXNSZW5kZXJhYmxlID0gaXNSZW5kZXJhYmxlOwogICAgdGhpcy5kYXRhID0gcGFyYW1ldGVycy5kYXRhOwogICAgdGhpcy5sYXllciA9IHBhcmFtZXRlcnMubGF5ZXI7CiAgICB0aGlzLmxpbmtTZXJ2aWNlID0gcGFyYW1ldGVycy5saW5rU2VydmljZTsKICAgIHRoaXMuZG93bmxvYWRNYW5hZ2VyID0gcGFyYW1ldGVycy5kb3dubG9hZE1hbmFnZXI7CiAgICB0aGlzLmltYWdlUmVzb3VyY2VzUGF0aCA9IHBhcmFtZXRlcnMuaW1hZ2VSZXNvdXJjZXNQYXRoOwogICAgdGhpcy5yZW5kZXJGb3JtcyA9IHBhcmFtZXRlcnMucmVuZGVyRm9ybXM7CiAgICB0aGlzLnN2Z0ZhY3RvcnkgPSBwYXJhbWV0ZXJzLnN2Z0ZhY3Rvcnk7CiAgICB0aGlzLmFubm90YXRpb25TdG9yYWdlID0gcGFyYW1ldGVycy5hbm5vdGF0aW9uU3RvcmFnZTsKICAgIHRoaXMuZW5hYmxlQ29tbWVudCA9IHBhcmFtZXRlcnMuZW5hYmxlQ29tbWVudDsKICAgIHRoaXMuZW5hYmxlU2NyaXB0aW5nID0gcGFyYW1ldGVycy5lbmFibGVTY3JpcHRpbmc7CiAgICB0aGlzLmhhc0pTQWN0aW9ucyA9IHBhcmFtZXRlcnMuaGFzSlNBY3Rpb25zOwogICAgdGhpcy5fZmllbGRPYmplY3RzID0gcGFyYW1ldGVycy5maWVsZE9iamVjdHM7CiAgICB0aGlzLnBhcmVudCA9IHBhcmFtZXRlcnMucGFyZW50OwogICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gZmFsc2U7CiAgICBpZiAoaXNSZW5kZXJhYmxlKSB7CiAgICAgIHRoaXMuY29udGVudEVsZW1lbnQgPSB0aGlzLmNvbnRhaW5lciA9IHRoaXMuX2NyZWF0ZUNvbnRhaW5lcihpZ25vcmVCb3JkZXIpOwogICAgfQogICAgaWYgKGNyZWF0ZVF1YWRyaWxhdGVyYWxzKSB7CiAgICAgIHRoaXMuX2NyZWF0ZVF1YWRyaWxhdGVyYWxzKCk7CiAgICB9CiAgfQogIHN0YXRpYyBfaGFzUG9wdXBEYXRhKHsKICAgIGNvbnRlbnRzT2JqLAogICAgcmljaFRleHQKICB9KSB7CiAgICByZXR1cm4gISEoY29udGVudHNPYmo/LnN0ciB8fCByaWNoVGV4dD8uc3RyKTsKICB9CiAgZ2V0IF9pc0VkaXRhYmxlKCkgewogICAgcmV0dXJuIHRoaXMuZGF0YS5pc0VkaXRhYmxlOwogIH0KICBnZXQgaGFzUG9wdXBEYXRhKCkgewogICAgcmV0dXJuIF9Bbm5vdGF0aW9uRWxlbWVudC5faGFzUG9wdXBEYXRhKHRoaXMuZGF0YSkgfHwgdGhpcy5lbmFibGVDb21tZW50ICYmICEhdGhpcy5jb21tZW50VGV4dDsKICB9CiAgZ2V0IGNvbW1lbnREYXRhKCkgewogICAgY29uc3QgewogICAgICBkYXRhCiAgICB9ID0gdGhpczsKICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuYW5ub3RhdGlvblN0b3JhZ2U/LmdldEVkaXRvcihkYXRhLmlkKTsKICAgIGlmIChlZGl0b3IpIHsKICAgICAgcmV0dXJuIGVkaXRvci5nZXREYXRhKCk7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgZ2V0IGhhc0NvbW1lbnRCdXR0b24oKSB7CiAgICByZXR1cm4gdGhpcy5lbmFibGVDb21tZW50ICYmIHRoaXMuaGFzUG9wdXBFbGVtZW50OwogIH0KICBnZXQgY29tbWVudEJ1dHRvblBvc2l0aW9uKCkgewogICAgY29uc3QgZWRpdG9yID0gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZT8uZ2V0RWRpdG9yKHRoaXMuZGF0YS5pZCk7CiAgICBpZiAoZWRpdG9yKSB7CiAgICAgIHJldHVybiBlZGl0b3IuY29tbWVudEJ1dHRvblBvc2l0aW9uSW5QYWdlOwogICAgfQogICAgY29uc3QgewogICAgICBxdWFkUG9pbnRzLAogICAgICBpbmtMaXN0cywKICAgICAgcmVjdAogICAgfSA9IHRoaXMuZGF0YTsKICAgIGxldCBtYXhYID0gLUluZmluaXR5OwogICAgbGV0IG1heFkgPSAtSW5maW5pdHk7CiAgICBpZiAocXVhZFBvaW50cz8ubGVuZ3RoID49IDgpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWFkUG9pbnRzLmxlbmd0aDsgaSArPSA4KSB7CiAgICAgICAgaWYgKHF1YWRQb2ludHNbaSArIDFdID4gbWF4WSkgewogICAgICAgICAgbWF4WSA9IHF1YWRQb2ludHNbaSArIDFdOwogICAgICAgICAgbWF4WCA9IHF1YWRQb2ludHNbaSArIDJdOwogICAgICAgIH0gZWxzZSBpZiAocXVhZFBvaW50c1tpICsgMV0gPT09IG1heFkpIHsKICAgICAgICAgIG1heFggPSBNYXRoLm1heChtYXhYLCBxdWFkUG9pbnRzW2kgKyAyXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBbbWF4WCwgbWF4WV07CiAgICB9CiAgICBpZiAoaW5rTGlzdHM/Lmxlbmd0aCA+PSAxKSB7CiAgICAgIGZvciAoY29uc3QgaW5rTGlzdCBvZiBpbmtMaXN0cykgewogICAgICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGlua0xpc3QubGVuZ3RoOyBpIDwgaWk7IGkgKz0gMikgewogICAgICAgICAgaWYgKGlua0xpc3RbaSArIDFdID4gbWF4WSkgewogICAgICAgICAgICBtYXhZID0gaW5rTGlzdFtpICsgMV07CiAgICAgICAgICAgIG1heFggPSBpbmtMaXN0W2ldOwogICAgICAgICAgfSBlbHNlIGlmIChpbmtMaXN0W2kgKyAxXSA9PT0gbWF4WSkgewogICAgICAgICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgaW5rTGlzdFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChtYXhYICE9PSBJbmZpbml0eSkgewogICAgICAgIHJldHVybiBbbWF4WCwgbWF4WV07CiAgICAgIH0KICAgIH0KICAgIGlmIChyZWN0KSB7CiAgICAgIHJldHVybiBbcmVjdFsyXSwgcmVjdFszXV07CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgX25vcm1hbGl6ZVBvaW50KHBvaW50KSB7CiAgICBjb25zdCB7CiAgICAgIHBhZ2U6IHsKICAgICAgICB2aWV3CiAgICAgIH0sCiAgICAgIHZpZXdwb3J0OiB7CiAgICAgICAgcmF3RGltczogewogICAgICAgICAgcGFnZVdpZHRoLAogICAgICAgICAgcGFnZUhlaWdodCwKICAgICAgICAgIHBhZ2VYLAogICAgICAgICAgcGFnZVkKICAgICAgICB9CiAgICAgIH0KICAgIH0gPSB0aGlzLnBhcmVudDsKICAgIHBvaW50WzFdID0gdmlld1szXSAtIHBvaW50WzFdICsgdmlld1sxXTsKICAgIHBvaW50WzBdID0gMTAwICogKHBvaW50WzBdIC0gcGFnZVgpIC8gcGFnZVdpZHRoOwogICAgcG9pbnRbMV0gPSAxMDAgKiAocG9pbnRbMV0gLSBwYWdlWSkgLyBwYWdlSGVpZ2h0OwogICAgcmV0dXJuIHBvaW50OwogIH0KICBnZXQgY29tbWVudFRleHQoKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGEKICAgIH0gPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuYW5ub3RhdGlvblN0b3JhZ2UuZ2V0UmF3VmFsdWUoYCR7QW5ub3RhdGlvbkVkaXRvclByZWZpeH0ke2RhdGEuaWR9YCk/LnBvcHVwPy5jb250ZW50cyB8fCBkYXRhLmNvbnRlbnRzT2JqPy5zdHIgfHwgIiI7CiAgfQogIHNldCBjb21tZW50VGV4dCh0ZXh0KSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGEKICAgIH0gPSB0aGlzOwogICAgY29uc3QgcG9wdXAgPSB7CiAgICAgIGRlbGV0ZWQ6ICF0ZXh0LAogICAgICBjb250ZW50czogdGV4dCB8fCAiIgogICAgfTsKICAgIGlmICghdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS51cGRhdGVFZGl0b3IoZGF0YS5pZCwgewogICAgICBwb3B1cAogICAgfSkpIHsKICAgICAgdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5zZXRWYWx1ZShgJHtBbm5vdGF0aW9uRWRpdG9yUHJlZml4fSR7ZGF0YS5pZH1gLCB7CiAgICAgICAgaWQ6IGRhdGEuaWQsCiAgICAgICAgYW5ub3RhdGlvblR5cGU6IGRhdGEuYW5ub3RhdGlvblR5cGUsCiAgICAgICAgcGFnZUluZGV4OiB0aGlzLnBhcmVudC5wYWdlLl9wYWdlSW5kZXgsCiAgICAgICAgcG9wdXAsCiAgICAgICAgcG9wdXBSZWY6IGRhdGEucG9wdXBSZWYsCiAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZTogLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkKICAgICAgfSk7CiAgICB9CiAgICBpZiAoIXRleHQpIHsKICAgICAgdGhpcy5yZW1vdmVQb3B1cCgpOwogICAgfQogIH0KICByZW1vdmVQb3B1cCgpIHsKICAgICh0aGlzLiNwb3B1cEVsZW1lbnQ/LnBvcHVwIHx8IHRoaXMucG9wdXApPy5yZW1vdmUoKTsKICAgIHRoaXMuI3BvcHVwRWxlbWVudCA9IHRoaXMucG9wdXAgPSBudWxsOwogIH0KICB1cGRhdGVFZGl0ZWQocGFyYW1zKSB7CiAgICBpZiAoIXRoaXMuY29udGFpbmVyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwYXJhbXMucmVjdCkgewogICAgICB0aGlzLiN1cGRhdGVzIHx8PSB7CiAgICAgICAgcmVjdDogdGhpcy5kYXRhLnJlY3Quc2xpY2UoMCkKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgcmVjdCwKICAgICAgcG9wdXA6IG5ld1BvcHVwCiAgICB9ID0gcGFyYW1zOwogICAgaWYgKHJlY3QpIHsKICAgICAgdGhpcy4jc2V0UmVjdEVkaXRlZChyZWN0KTsKICAgIH0KICAgIGxldCBwb3B1cCA9IHRoaXMuI3BvcHVwRWxlbWVudD8ucG9wdXAgfHwgdGhpcy5wb3B1cDsKICAgIGlmICghcG9wdXAgJiYgbmV3UG9wdXA/LnRleHQpIHsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAobmV3UG9wdXApOwogICAgICBwb3B1cCA9IHRoaXMuI3BvcHVwRWxlbWVudC5wb3B1cDsKICAgIH0KICAgIGlmICghcG9wdXApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcG9wdXAudXBkYXRlRWRpdGVkKHBhcmFtcyk7CiAgICBpZiAobmV3UG9wdXA/LmRlbGV0ZWQpIHsKICAgICAgcG9wdXAucmVtb3ZlKCk7CiAgICAgIHRoaXMuI3BvcHVwRWxlbWVudCA9IG51bGw7CiAgICAgIHRoaXMucG9wdXAgPSBudWxsOwogICAgfQogIH0KICByZXNldEVkaXRlZCgpIHsKICAgIGlmICghdGhpcy4jdXBkYXRlcykgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNzZXRSZWN0RWRpdGVkKHRoaXMuI3VwZGF0ZXMucmVjdCk7CiAgICB0aGlzLiNwb3B1cEVsZW1lbnQ/LnBvcHVwLnJlc2V0RWRpdGVkKCk7CiAgICB0aGlzLiN1cGRhdGVzID0gbnVsbDsKICB9CiAgI3NldFJlY3RFZGl0ZWQocmVjdCkgewogICAgY29uc3QgewogICAgICBjb250YWluZXI6IHsKICAgICAgICBzdHlsZQogICAgICB9LAogICAgICBkYXRhOiB7CiAgICAgICAgcmVjdDogY3VycmVudFJlY3QsCiAgICAgICAgcm90YXRpb24KICAgICAgfSwKICAgICAgcGFyZW50OiB7CiAgICAgICAgdmlld3BvcnQ6IHsKICAgICAgICAgIHJhd0RpbXM6IHsKICAgICAgICAgICAgcGFnZVdpZHRoLAogICAgICAgICAgICBwYWdlSGVpZ2h0LAogICAgICAgICAgICBwYWdlWCwKICAgICAgICAgICAgcGFnZVkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgY3VycmVudFJlY3Q/LnNwbGljZSgwLCA0LCAuLi5yZWN0KTsKICAgIHN0eWxlLmxlZnQgPSBgJHsxMDAgKiAocmVjdFswXSAtIHBhZ2VYKSAvIHBhZ2VXaWR0aH0lYDsKICAgIHN0eWxlLnRvcCA9IGAkezEwMCAqIChwYWdlSGVpZ2h0IC0gcmVjdFszXSArIHBhZ2VZKSAvIHBhZ2VIZWlnaHR9JWA7CiAgICBpZiAocm90YXRpb24gPT09IDApIHsKICAgICAgc3R5bGUud2lkdGggPSBgJHsxMDAgKiAocmVjdFsyXSAtIHJlY3RbMF0pIC8gcGFnZVdpZHRofSVgOwogICAgICBzdHlsZS5oZWlnaHQgPSBgJHsxMDAgKiAocmVjdFszXSAtIHJlY3RbMV0pIC8gcGFnZUhlaWdodH0lYDsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2V0Um90YXRpb24ocm90YXRpb24pOwogICAgfQogIH0KICBfY3JlYXRlQ29udGFpbmVyKGlnbm9yZUJvcmRlcikgewogICAgY29uc3QgewogICAgICBkYXRhLAogICAgICBwYXJlbnQ6IHsKICAgICAgICBwYWdlLAogICAgICAgIHZpZXdwb3J0CiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgY29uc3QgY29udGFpbmVyMiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlY3Rpb24iKTsKICAgIGNvbnRhaW5lcjIuc2V0QXR0cmlidXRlKCJkYXRhLWFubm90YXRpb24taWQiLCBkYXRhLmlkKTsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCkgJiYgISh0aGlzIGluc3RhbmNlb2YgTGlua0Fubm90YXRpb25FbGVtZW50KSkgewogICAgICBjb250YWluZXIyLnRhYkluZGV4ID0gMDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSBjb250YWluZXIyOwogICAgc3R5bGUuekluZGV4ID0gdGhpcy5wYXJlbnQuekluZGV4OwogICAgdGhpcy5wYXJlbnQuekluZGV4ICs9IDI7CiAgICBpZiAoZGF0YS5hbHRlcm5hdGl2ZVRleHQpIHsKICAgICAgY29udGFpbmVyMi50aXRsZSA9IGRhdGEuYWx0ZXJuYXRpdmVUZXh0OwogICAgfQogICAgaWYgKGRhdGEubm9Sb3RhdGUpIHsKICAgICAgY29udGFpbmVyMi5jbGFzc0xpc3QuYWRkKCJub3JvdGF0ZSIpOwogICAgfQogICAgaWYgKCFkYXRhLnJlY3QgfHwgdGhpcyBpbnN0YW5jZW9mIFBvcHVwQW5ub3RhdGlvbkVsZW1lbnQpIHsKICAgICAgY29uc3QgewogICAgICAgIHJvdGF0aW9uOiByb3RhdGlvbjIKICAgICAgfSA9IGRhdGE7CiAgICAgIGlmICghZGF0YS5oYXNPd25DYW52YXMgJiYgcm90YXRpb24yICE9PSAwKSB7CiAgICAgICAgdGhpcy5zZXRSb3RhdGlvbihyb3RhdGlvbjIsIGNvbnRhaW5lcjIpOwogICAgICB9CiAgICAgIHJldHVybiBjb250YWluZXIyOwogICAgfQogICAgY29uc3QgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gdGhpczsKICAgIGlmICghaWdub3JlQm9yZGVyICYmIGRhdGEuYm9yZGVyU3R5bGUud2lkdGggPiAwKSB7CiAgICAgIHN0eWxlLmJvcmRlcldpZHRoID0gYCR7ZGF0YS5ib3JkZXJTdHlsZS53aWR0aH1weGA7CiAgICAgIGNvbnN0IGhvcml6b250YWxSYWRpdXMgPSBkYXRhLmJvcmRlclN0eWxlLmhvcml6b250YWxDb3JuZXJSYWRpdXM7CiAgICAgIGNvbnN0IHZlcnRpY2FsUmFkaXVzID0gZGF0YS5ib3JkZXJTdHlsZS52ZXJ0aWNhbENvcm5lclJhZGl1czsKICAgICAgaWYgKGhvcml6b250YWxSYWRpdXMgPiAwIHx8IHZlcnRpY2FsUmFkaXVzID4gMCkgewogICAgICAgIGNvbnN0IHJhZGl1cyA9IGBjYWxjKCR7aG9yaXpvbnRhbFJhZGl1c31weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikpIC8gY2FsYygke3ZlcnRpY2FsUmFkaXVzfXB4ICogdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSlgOwogICAgICAgIHN0eWxlLmJvcmRlclJhZGl1cyA9IHJhZGl1czsKICAgICAgfSBlbHNlIGlmICh0aGlzIGluc3RhbmNlb2YgUmFkaW9CdXR0b25XaWRnZXRBbm5vdGF0aW9uRWxlbWVudCkgewogICAgICAgIGNvbnN0IHJhZGl1cyA9IGBjYWxjKCR7d2lkdGh9cHggKiB2YXIoLS10b3RhbC1zY2FsZS1mYWN0b3IpKSAvIGNhbGMoJHtoZWlnaHR9cHggKiB2YXIoLS10b3RhbC1zY2FsZS1mYWN0b3IpKWA7CiAgICAgICAgc3R5bGUuYm9yZGVyUmFkaXVzID0gcmFkaXVzOwogICAgICB9CiAgICAgIHN3aXRjaCAoZGF0YS5ib3JkZXJTdHlsZS5zdHlsZSkgewogICAgICAgIGNhc2UgQW5ub3RhdGlvbkJvcmRlclN0eWxlVHlwZS5TT0xJRDoKICAgICAgICAgIHN0eWxlLmJvcmRlclN0eWxlID0gInNvbGlkIjsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgQW5ub3RhdGlvbkJvcmRlclN0eWxlVHlwZS5EQVNIRUQ6CiAgICAgICAgICBzdHlsZS5ib3JkZXJTdHlsZSA9ICJkYXNoZWQiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBBbm5vdGF0aW9uQm9yZGVyU3R5bGVUeXBlLkJFVkVMRUQ6CiAgICAgICAgICB3YXJuKCJVbmltcGxlbWVudGVkIGJvcmRlciBzdHlsZTogYmV2ZWxlZCIpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBBbm5vdGF0aW9uQm9yZGVyU3R5bGVUeXBlLklOU0VUOgogICAgICAgICAgd2FybigiVW5pbXBsZW1lbnRlZCBib3JkZXIgc3R5bGU6IGluc2V0Iik7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIEFubm90YXRpb25Cb3JkZXJTdHlsZVR5cGUuVU5ERVJMSU5FOgogICAgICAgICAgc3R5bGUuYm9yZGVyQm90dG9tU3R5bGUgPSAic29saWQiOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIGNvbnN0IGJvcmRlckNvbG9yID0gZGF0YS5ib3JkZXJDb2xvciB8fCBudWxsOwogICAgICBpZiAoYm9yZGVyQ29sb3IpIHsKICAgICAgICB0aGlzLiNoYXNCb3JkZXIgPSB0cnVlOwogICAgICAgIHN0eWxlLmJvcmRlckNvbG9yID0gVXRpbC5tYWtlSGV4Q29sb3IoYm9yZGVyQ29sb3JbMF0gfCAwLCBib3JkZXJDb2xvclsxXSB8IDAsIGJvcmRlckNvbG9yWzJdIHwgMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3R5bGUuYm9yZGVyV2lkdGggPSAwOwogICAgICB9CiAgICB9CiAgICBjb25zdCByZWN0ID0gVXRpbC5ub3JtYWxpemVSZWN0KFtkYXRhLnJlY3RbMF0sIHBhZ2Uudmlld1szXSAtIGRhdGEucmVjdFsxXSArIHBhZ2Uudmlld1sxXSwgZGF0YS5yZWN0WzJdLCBwYWdlLnZpZXdbM10gLSBkYXRhLnJlY3RbM10gKyBwYWdlLnZpZXdbMV1dKTsKICAgIGNvbnN0IHsKICAgICAgcGFnZVdpZHRoLAogICAgICBwYWdlSGVpZ2h0LAogICAgICBwYWdlWCwKICAgICAgcGFnZVkKICAgIH0gPSB2aWV3cG9ydC5yYXdEaW1zOwogICAgc3R5bGUubGVmdCA9IGAkezEwMCAqIChyZWN0WzBdIC0gcGFnZVgpIC8gcGFnZVdpZHRofSVgOwogICAgc3R5bGUudG9wID0gYCR7MTAwICogKHJlY3RbMV0gLSBwYWdlWSkgLyBwYWdlSGVpZ2h0fSVgOwogICAgY29uc3QgewogICAgICByb3RhdGlvbgogICAgfSA9IGRhdGE7CiAgICBpZiAoZGF0YS5oYXNPd25DYW52YXMgfHwgcm90YXRpb24gPT09IDApIHsKICAgICAgc3R5bGUud2lkdGggPSBgJHsxMDAgKiB3aWR0aCAvIHBhZ2VXaWR0aH0lYDsKICAgICAgc3R5bGUuaGVpZ2h0ID0gYCR7MTAwICogaGVpZ2h0IC8gcGFnZUhlaWdodH0lYDsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuc2V0Um90YXRpb24ocm90YXRpb24sIGNvbnRhaW5lcjIpOwogICAgfQogICAgcmV0dXJuIGNvbnRhaW5lcjI7CiAgfQogIHNldFJvdGF0aW9uKGFuZ2xlLCBjb250YWluZXIyID0gdGhpcy5jb250YWluZXIpIHsKICAgIGlmICghdGhpcy5kYXRhLnJlY3QpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBwYWdlV2lkdGgsCiAgICAgIHBhZ2VIZWlnaHQKICAgIH0gPSB0aGlzLnBhcmVudC52aWV3cG9ydC5yYXdEaW1zOwogICAgbGV0IHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXM7CiAgICBpZiAoYW5nbGUgJSAxODAgIT09IDApIHsKICAgICAgW3dpZHRoLCBoZWlnaHRdID0gW2hlaWdodCwgd2lkdGhdOwogICAgfQogICAgY29udGFpbmVyMi5zdHlsZS53aWR0aCA9IGAkezEwMCAqIHdpZHRoIC8gcGFnZVdpZHRofSVgOwogICAgY29udGFpbmVyMi5zdHlsZS5oZWlnaHQgPSBgJHsxMDAgKiBoZWlnaHQgLyBwYWdlSGVpZ2h0fSVgOwogICAgY29udGFpbmVyMi5zZXRBdHRyaWJ1dGUoImRhdGEtbWFpbi1yb3RhdGlvbiIsICgzNjAgLSBhbmdsZSkgJSAzNjApOwogIH0KICBnZXQgX2NvbW1vbkFjdGlvbnMoKSB7CiAgICBjb25zdCBzZXRDb2xvciA9IChqc05hbWUsIHN0eWxlTmFtZSwgZXZlbnQpID0+IHsKICAgICAgY29uc3QgY29sb3IgPSBldmVudC5kZXRhaWxbanNOYW1lXTsKICAgICAgY29uc3QgY29sb3JUeXBlID0gY29sb3JbMF07CiAgICAgIGNvbnN0IGNvbG9yQXJyYXkgPSBjb2xvci5zbGljZSgxKTsKICAgICAgZXZlbnQudGFyZ2V0LnN0eWxlW3N0eWxlTmFtZV0gPSBDb2xvckNvbnZlcnRlcnNbYCR7Y29sb3JUeXBlfV9IVE1MYF0oY29sb3JBcnJheSk7CiAgICAgIHRoaXMuYW5ub3RhdGlvblN0b3JhZ2Uuc2V0VmFsdWUodGhpcy5kYXRhLmlkLCB7CiAgICAgICAgW3N0eWxlTmFtZV06IENvbG9yQ29udmVydGVyc1tgJHtjb2xvclR5cGV9X3JnYmBdKGNvbG9yQXJyYXkpCiAgICAgIH0pOwogICAgfTsKICAgIHJldHVybiBzaGFkb3codGhpcywgIl9jb21tb25BY3Rpb25zIiwgewogICAgICBkaXNwbGF5OiAoZXZlbnQpID0+IHsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBkaXNwbGF5CiAgICAgICAgfSA9IGV2ZW50LmRldGFpbDsKICAgICAgICBjb25zdCBoaWRkZW4gPSBkaXNwbGF5ICUgMiA9PT0gMTsKICAgICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS52aXNpYmlsaXR5ID0gaGlkZGVuID8gImhpZGRlbiIgOiAidmlzaWJsZSI7CiAgICAgICAgdGhpcy5hbm5vdGF0aW9uU3RvcmFnZS5zZXRWYWx1ZSh0aGlzLmRhdGEuaWQsIHsKICAgICAgICAgIG5vVmlldzogaGlkZGVuLAogICAgICAgICAgbm9QcmludDogZGlzcGxheSA9PT0gMSB8fCBkaXNwbGF5ID09PSAyCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHByaW50OiAoZXZlbnQpID0+IHsKICAgICAgICB0aGlzLmFubm90YXRpb25TdG9yYWdlLnNldFZhbHVlKHRoaXMuZGF0YS5pZCwgewogICAgICAgICAgbm9QcmludDogIWV2ZW50LmRldGFpbC5wcmludAogICAgICAgIH0pOwogICAgICB9LAogICAgICBoaWRkZW46IChldmVudCkgPT4gewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGhpZGRlbgogICAgICAgIH0gPSBldmVudC5kZXRhaWw7CiAgICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9IGhpZGRlbiA/ICJoaWRkZW4iIDogInZpc2libGUiOwogICAgICAgIHRoaXMuYW5ub3RhdGlvblN0b3JhZ2Uuc2V0VmFsdWUodGhpcy5kYXRhLmlkLCB7CiAgICAgICAgICBub1ByaW50OiBoaWRkZW4sCiAgICAgICAgICBub1ZpZXc6IGhpZGRlbgogICAgICAgIH0pOwogICAgICB9LAogICAgICBmb2N1czogKGV2ZW50KSA9PiB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBldmVudC50YXJnZXQuZm9jdXMoewogICAgICAgICAgcHJldmVudFNjcm9sbDogZmFsc2UKICAgICAgICB9KSwgMCk7CiAgICAgIH0sCiAgICAgIHVzZXJOYW1lOiAoZXZlbnQpID0+IHsKICAgICAgICBldmVudC50YXJnZXQudGl0bGUgPSBldmVudC5kZXRhaWwudXNlck5hbWU7CiAgICAgIH0sCiAgICAgIHJlYWRvbmx5OiAoZXZlbnQpID0+IHsKICAgICAgICBldmVudC50YXJnZXQuZGlzYWJsZWQgPSBldmVudC5kZXRhaWwucmVhZG9ubHk7CiAgICAgIH0sCiAgICAgIHJlcXVpcmVkOiAoZXZlbnQpID0+IHsKICAgICAgICB0aGlzLl9zZXRSZXF1aXJlZChldmVudC50YXJnZXQsIGV2ZW50LmRldGFpbC5yZXF1aXJlZCk7CiAgICAgIH0sCiAgICAgIGJnQ29sb3I6IChldmVudCkgPT4gewogICAgICAgIHNldENvbG9yKCJiZ0NvbG9yIiwgImJhY2tncm91bmRDb2xvciIsIGV2ZW50KTsKICAgICAgfSwKICAgICAgZmlsbENvbG9yOiAoZXZlbnQpID0+IHsKICAgICAgICBzZXRDb2xvcigiZmlsbENvbG9yIiwgImJhY2tncm91bmRDb2xvciIsIGV2ZW50KTsKICAgICAgfSwKICAgICAgZmdDb2xvcjogKGV2ZW50KSA9PiB7CiAgICAgICAgc2V0Q29sb3IoImZnQ29sb3IiLCAiY29sb3IiLCBldmVudCk7CiAgICAgIH0sCiAgICAgIHRleHRDb2xvcjogKGV2ZW50KSA9PiB7CiAgICAgICAgc2V0Q29sb3IoInRleHRDb2xvciIsICJjb2xvciIsIGV2ZW50KTsKICAgICAgfSwKICAgICAgYm9yZGVyQ29sb3I6IChldmVudCkgPT4gewogICAgICAgIHNldENvbG9yKCJib3JkZXJDb2xvciIsICJib3JkZXJDb2xvciIsIGV2ZW50KTsKICAgICAgfSwKICAgICAgc3Ryb2tlQ29sb3I6IChldmVudCkgPT4gewogICAgICAgIHNldENvbG9yKCJzdHJva2VDb2xvciIsICJib3JkZXJDb2xvciIsIGV2ZW50KTsKICAgICAgfSwKICAgICAgcm90YXRpb246IChldmVudCkgPT4gewogICAgICAgIGNvbnN0IGFuZ2xlID0gZXZlbnQuZGV0YWlsLnJvdGF0aW9uOwogICAgICAgIHRoaXMuc2V0Um90YXRpb24oYW5nbGUpOwogICAgICAgIHRoaXMuYW5ub3RhdGlvblN0b3JhZ2Uuc2V0VmFsdWUodGhpcy5kYXRhLmlkLCB7CiAgICAgICAgICByb3RhdGlvbjogYW5nbGUKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQogIF9kaXNwYXRjaEV2ZW50RnJvbVNhbmRib3goYWN0aW9ucywganNFdmVudCkgewogICAgY29uc3QgY29tbW9uQWN0aW9ucyA9IHRoaXMuX2NvbW1vbkFjdGlvbnM7CiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoanNFdmVudC5kZXRhaWwpKSB7CiAgICAgIGNvbnN0IGFjdGlvbiA9IGFjdGlvbnNbbmFtZV0gfHwgY29tbW9uQWN0aW9uc1tuYW1lXTsKICAgICAgYWN0aW9uPy4oanNFdmVudCk7CiAgICB9CiAgfQogIF9zZXREZWZhdWx0UHJvcGVydGllc0Zyb21KUyhlbGVtZW50KSB7CiAgICBpZiAoIXRoaXMuZW5hYmxlU2NyaXB0aW5nKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHN0b3JlZERhdGEgPSB0aGlzLmFubm90YXRpb25TdG9yYWdlLmdldFJhd1ZhbHVlKHRoaXMuZGF0YS5pZCk7CiAgICBpZiAoIXN0b3JlZERhdGEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgY29tbW9uQWN0aW9ucyA9IHRoaXMuX2NvbW1vbkFjdGlvbnM7CiAgICBmb3IgKGNvbnN0IFthY3Rpb25OYW1lLCBkZXRhaWxdIG9mIE9iamVjdC5lbnRyaWVzKHN0b3JlZERhdGEpKSB7CiAgICAgIGNvbnN0IGFjdGlvbiA9IGNvbW1vbkFjdGlvbnNbYWN0aW9uTmFtZV07CiAgICAgIGlmIChhY3Rpb24pIHsKICAgICAgICBjb25zdCBldmVudFByb3h5ID0gewogICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgIFthY3Rpb25OYW1lXTogZGV0YWlsCiAgICAgICAgICB9LAogICAgICAgICAgdGFyZ2V0OiBlbGVtZW50CiAgICAgICAgfTsKICAgICAgICBhY3Rpb24oZXZlbnRQcm94eSk7CiAgICAgICAgZGVsZXRlIHN0b3JlZERhdGFbYWN0aW9uTmFtZV07CiAgICAgIH0KICAgIH0KICB9CiAgX2NyZWF0ZVF1YWRyaWxhdGVyYWxzKCkgewogICAgaWYgKCF0aGlzLmNvbnRhaW5lcikgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHF1YWRQb2ludHMKICAgIH0gPSB0aGlzLmRhdGE7CiAgICBpZiAoIXF1YWRQb2ludHMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgW3JlY3RCbFgsIHJlY3RCbFksIHJlY3RUclgsIHJlY3RUclldID0gdGhpcy5kYXRhLnJlY3QubWFwKCh4KSA9PiBNYXRoLmZyb3VuZCh4KSk7CiAgICBpZiAocXVhZFBvaW50cy5sZW5ndGggPT09IDgpIHsKICAgICAgY29uc3QgW3RyWCwgdHJZLCBibFgsIGJsWV0gPSBxdWFkUG9pbnRzLnN1YmFycmF5KDIsIDYpOwogICAgICBpZiAocmVjdFRyWCA9PT0gdHJYICYmIHJlY3RUclkgPT09IHRyWSAmJiByZWN0QmxYID09PSBibFggJiYgcmVjdEJsWSA9PT0gYmxZKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gdGhpcy5jb250YWluZXI7CiAgICBsZXQgc3ZnQnVmZmVyOwogICAgaWYgKHRoaXMuI2hhc0JvcmRlcikgewogICAgICBjb25zdCB7CiAgICAgICAgYm9yZGVyQ29sb3IsCiAgICAgICAgYm9yZGVyV2lkdGgKICAgICAgfSA9IHN0eWxlOwogICAgICBzdHlsZS5ib3JkZXJXaWR0aCA9IDA7CiAgICAgIHN2Z0J1ZmZlciA9IFsidXJsKCdkYXRhOmltYWdlL3N2Zyt4bWw7dXRmOCwiLCBgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciYCwgYCBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiB2aWV3Qm94PSIwIDAgMSAxIj5gLCBgPGcgZmlsbD0idHJhbnNwYXJlbnQiIHN0cm9rZT0iJHtib3JkZXJDb2xvcn0iIHN0cm9rZS13aWR0aD0iJHtib3JkZXJXaWR0aH0iPmBdOwogICAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJoYXNCb3JkZXIiKTsKICAgIH0KICAgIGNvbnN0IHdpZHRoID0gcmVjdFRyWCAtIHJlY3RCbFg7CiAgICBjb25zdCBoZWlnaHQgPSByZWN0VHJZIC0gcmVjdEJsWTsKICAgIGNvbnN0IHsKICAgICAgc3ZnRmFjdG9yeQogICAgfSA9IHRoaXM7CiAgICBjb25zdCBzdmcgPSBzdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInN2ZyIpOwogICAgc3ZnLmNsYXNzTGlzdC5hZGQoInF1YWRyaWxhdGVyYWxzQ29udGFpbmVyIik7CiAgICBzdmcuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIDApOwogICAgc3ZnLnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgMCk7CiAgICBzdmcucm9sZSA9ICJub25lIjsKICAgIGNvbnN0IGRlZnMgPSBzdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoImRlZnMiKTsKICAgIHN2Zy5hcHBlbmQoZGVmcyk7CiAgICBjb25zdCBjbGlwUGF0aCA9IHN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiKTsKICAgIGNvbnN0IGlkID0gYGNsaXBwYXRoXyR7dGhpcy5kYXRhLmlkfWA7CiAgICBjbGlwUGF0aC5zZXRBdHRyaWJ1dGUoImlkIiwgaWQpOwogICAgY2xpcFBhdGguc2V0QXR0cmlidXRlKCJjbGlwUGF0aFVuaXRzIiwgIm9iamVjdEJvdW5kaW5nQm94Iik7CiAgICBkZWZzLmFwcGVuZChjbGlwUGF0aCk7CiAgICBmb3IgKGxldCBpID0gMiwgaWkgPSBxdWFkUG9pbnRzLmxlbmd0aDsgaSA8IGlpOyBpICs9IDgpIHsKICAgICAgY29uc3QgdHJYID0gcXVhZFBvaW50c1tpXTsKICAgICAgY29uc3QgdHJZID0gcXVhZFBvaW50c1tpICsgMV07CiAgICAgIGNvbnN0IGJsWCA9IHF1YWRQb2ludHNbaSArIDJdOwogICAgICBjb25zdCBibFkgPSBxdWFkUG9pbnRzW2kgKyAzXTsKICAgICAgY29uc3QgcmVjdCA9IHN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgicmVjdCIpOwogICAgICBjb25zdCB4ID0gKGJsWCAtIHJlY3RCbFgpIC8gd2lkdGg7CiAgICAgIGNvbnN0IHkgPSAocmVjdFRyWSAtIHRyWSkgLyBoZWlnaHQ7CiAgICAgIGNvbnN0IHJlY3RXaWR0aCA9ICh0clggLSBibFgpIC8gd2lkdGg7CiAgICAgIGNvbnN0IHJlY3RIZWlnaHQgPSAodHJZIC0gYmxZKSAvIGhlaWdodDsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoIngiLCB4KTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoInkiLCB5KTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoIndpZHRoIiwgcmVjdFdpZHRoKTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoImhlaWdodCIsIHJlY3RIZWlnaHQpOwogICAgICBjbGlwUGF0aC5hcHBlbmQocmVjdCk7CiAgICAgIHN2Z0J1ZmZlcj8ucHVzaChgPHJlY3QgdmVjdG9yLWVmZmVjdD0ibm9uLXNjYWxpbmctc3Ryb2tlIiB4PSIke3h9IiB5PSIke3l9IiB3aWR0aD0iJHtyZWN0V2lkdGh9IiBoZWlnaHQ9IiR7cmVjdEhlaWdodH0iLz5gKTsKICAgIH0KICAgIGlmICh0aGlzLiNoYXNCb3JkZXIpIHsKICAgICAgc3ZnQnVmZmVyLnB1c2goYDwvZz48L3N2Zz4nKWApOwogICAgICBzdHlsZS5iYWNrZ3JvdW5kSW1hZ2UgPSBzdmdCdWZmZXIuam9pbigiIik7CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmQoc3ZnKTsKICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLmNsaXBQYXRoID0gYHVybCgjJHtpZH0pYDsKICB9CiAgX2NyZWF0ZVBvcHVwKHBvcHVwRGF0YSA9IG51bGwpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YQogICAgfSA9IHRoaXM7CiAgICBsZXQgY29udGVudHNPYmosIG1vZGlmaWNhdGlvbkRhdGU7CiAgICBpZiAocG9wdXBEYXRhKSB7CiAgICAgIGNvbnRlbnRzT2JqID0gewogICAgICAgIHN0cjogcG9wdXBEYXRhLnRleHQKICAgICAgfTsKICAgICAgbW9kaWZpY2F0aW9uRGF0ZSA9IHBvcHVwRGF0YS5kYXRlOwogICAgfSBlbHNlIHsKICAgICAgY29udGVudHNPYmogPSBkYXRhLmNvbnRlbnRzT2JqOwogICAgICBtb2RpZmljYXRpb25EYXRlID0gZGF0YS5tb2RpZmljYXRpb25EYXRlOwogICAgfQogICAgdGhpcy4jcG9wdXBFbGVtZW50ID0gbmV3IFBvcHVwQW5ub3RhdGlvbkVsZW1lbnQoewogICAgICBkYXRhOiB7CiAgICAgICAgY29sb3I6IGRhdGEuY29sb3IsCiAgICAgICAgdGl0bGVPYmo6IGRhdGEudGl0bGVPYmosCiAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZSwKICAgICAgICBjb250ZW50c09iaiwKICAgICAgICByaWNoVGV4dDogZGF0YS5yaWNoVGV4dCwKICAgICAgICBwYXJlbnRSZWN0OiBkYXRhLnJlY3QsCiAgICAgICAgYm9yZGVyU3R5bGU6IDAsCiAgICAgICAgaWQ6IGBwb3B1cF8ke2RhdGEuaWR9YCwKICAgICAgICByb3RhdGlvbjogZGF0YS5yb3RhdGlvbiwKICAgICAgICBub1JvdGF0ZTogdHJ1ZQogICAgICB9LAogICAgICBsaW5rU2VydmljZTogdGhpcy5saW5rU2VydmljZSwKICAgICAgcGFyZW50OiB0aGlzLnBhcmVudCwKICAgICAgZWxlbWVudHM6IFt0aGlzXQogICAgfSk7CiAgfQogIGdldCBoYXNQb3B1cEVsZW1lbnQoKSB7CiAgICByZXR1cm4gISEodGhpcy4jcG9wdXBFbGVtZW50IHx8IHRoaXMucG9wdXAgfHwgdGhpcy5kYXRhLnBvcHVwUmVmKTsKICB9CiAgZ2V0IGV4dHJhUG9wdXBFbGVtZW50KCkgewogICAgcmV0dXJuIHRoaXMuI3BvcHVwRWxlbWVudDsKICB9CiAgcmVuZGVyKCkgewogICAgdW5yZWFjaGFibGUoIkFic3RyYWN0IG1ldGhvZCBgQW5ub3RhdGlvbkVsZW1lbnQucmVuZGVyYCBjYWxsZWQiKTsKICB9CiAgX2dldEVsZW1lbnRzQnlOYW1lKG5hbWUsIHNraXBJZCA9IG51bGwpIHsKICAgIGNvbnN0IGZpZWxkcyA9IFtdOwogICAgaWYgKHRoaXMuX2ZpZWxkT2JqZWN0cykgewogICAgICBjb25zdCBmaWVsZE9iaiA9IHRoaXMuX2ZpZWxkT2JqZWN0c1tuYW1lXTsKICAgICAgaWYgKGZpZWxkT2JqKSB7CiAgICAgICAgZm9yIChjb25zdCB7CiAgICAgICAgICBwYWdlLAogICAgICAgICAgaWQsCiAgICAgICAgICBleHBvcnRWYWx1ZXMKICAgICAgICB9IG9mIGZpZWxkT2JqKSB7CiAgICAgICAgICBpZiAocGFnZSA9PT0gLTEpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaWQgPT09IHNraXBJZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGV4cG9ydFZhbHVlID0gdHlwZW9mIGV4cG9ydFZhbHVlcyA9PT0gInN0cmluZyIgPyBleHBvcnRWYWx1ZXMgOiBudWxsOwogICAgICAgICAgY29uc3QgZG9tRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYFtkYXRhLWVsZW1lbnQtaWQ9IiR7aWR9Il1gKTsKICAgICAgICAgIGlmIChkb21FbGVtZW50ICYmICFHZXRFbGVtZW50c0J5TmFtZVNldC5oYXMoZG9tRWxlbWVudCkpIHsKICAgICAgICAgICAgd2FybihgX2dldEVsZW1lbnRzQnlOYW1lIC0gZWxlbWVudCBub3QgYWxsb3dlZDogJHtpZH1gKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBmaWVsZHMucHVzaCh7CiAgICAgICAgICAgIGlkLAogICAgICAgICAgICBleHBvcnRWYWx1ZSwKICAgICAgICAgICAgZG9tRWxlbWVudAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmaWVsZHM7CiAgICB9CiAgICBmb3IgKGNvbnN0IGRvbUVsZW1lbnQgb2YgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUobmFtZSkpIHsKICAgICAgY29uc3QgewogICAgICAgIGV4cG9ydFZhbHVlCiAgICAgIH0gPSBkb21FbGVtZW50OwogICAgICBjb25zdCBpZCA9IGRvbUVsZW1lbnQuZ2V0QXR0cmlidXRlKCJkYXRhLWVsZW1lbnQtaWQiKTsKICAgICAgaWYgKGlkID09PSBza2lwSWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIUdldEVsZW1lbnRzQnlOYW1lU2V0Lmhhcyhkb21FbGVtZW50KSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGZpZWxkcy5wdXNoKHsKICAgICAgICBpZCwKICAgICAgICBleHBvcnRWYWx1ZSwKICAgICAgICBkb21FbGVtZW50CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGZpZWxkczsKICB9CiAgc2hvdygpIHsKICAgIGlmICh0aGlzLmNvbnRhaW5lcikgewogICAgICB0aGlzLmNvbnRhaW5lci5oaWRkZW4gPSBmYWxzZTsKICAgIH0KICAgIHRoaXMucG9wdXA/Lm1heWJlU2hvdygpOwogIH0KICBoaWRlKCkgewogICAgaWYgKHRoaXMuY29udGFpbmVyKSB7CiAgICAgIHRoaXMuY29udGFpbmVyLmhpZGRlbiA9IHRydWU7CiAgICB9CiAgICB0aGlzLnBvcHVwPy5mb3JjZUhpZGUoKTsKICB9CiAgZ2V0RWxlbWVudHNUb1RyaWdnZXJQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgYWRkSGlnaGxpZ2h0QXJlYSgpIHsKICAgIGNvbnN0IHRyaWdnZXJzID0gdGhpcy5nZXRFbGVtZW50c1RvVHJpZ2dlclBvcHVwKCk7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0cmlnZ2VycykpIHsKICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRyaWdnZXJzKSB7CiAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKCJoaWdobGlnaHRBcmVhIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRyaWdnZXJzLmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodEFyZWEiKTsKICAgIH0KICB9CiAgX2VkaXRPbkRvdWJsZUNsaWNrKCkgewogICAgaWYgKCF0aGlzLl9pc0VkaXRhYmxlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgYW5ub3RhdGlvbkVkaXRvclR5cGU6IG1vZGUsCiAgICAgIGRhdGE6IHsKICAgICAgICBpZDogZWRpdElkCiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgdGhpcy5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigiZGJsY2xpY2siLCAoKSA9PiB7CiAgICAgIHRoaXMubGlua1NlcnZpY2UuZXZlbnRCdXM/LmRpc3BhdGNoKCJzd2l0Y2hhbm5vdGF0aW9uZWRpdG9ybW9kZSIsIHsKICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgbW9kZSwKICAgICAgICBlZGl0SWQsCiAgICAgICAgbXVzdEVudGVySW5FZGl0TW9kZTogdHJ1ZQogICAgICB9KTsKICAgIH0pOwogIH0KICBnZXQgd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy5kYXRhLnJlY3RbMl0gLSB0aGlzLmRhdGEucmVjdFswXTsKICB9CiAgZ2V0IGhlaWdodCgpIHsKICAgIHJldHVybiB0aGlzLmRhdGEucmVjdFszXSAtIHRoaXMuZGF0YS5yZWN0WzFdOwogIH0KfTsKdmFyIEVkaXRvckFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogdHJ1ZQogICAgfSk7CiAgICB0aGlzLmVkaXRvciA9IHBhcmFtZXRlcnMuZWRpdG9yOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc05hbWUgPSAiZWRpdG9yQW5ub3RhdGlvbiI7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQogIGNyZWF0ZU9yVXBkYXRlUG9wdXAoKSB7CiAgICBjb25zdCB7CiAgICAgIGVkaXRvcgogICAgfSA9IHRoaXM7CiAgICBpZiAoIWVkaXRvci5oYXNDb21tZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2NyZWF0ZVBvcHVwKGVkaXRvci5jb21tZW50KTsKICB9CiAgZ2V0IGhhc0NvbW1lbnRCdXR0b24oKSB7CiAgICByZXR1cm4gdGhpcy5lbmFibGVDb21tZW50ICYmIHRoaXMuZWRpdG9yLmhhc0NvbW1lbnQ7CiAgfQogIGdldCBjb21tZW50QnV0dG9uUG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy5lZGl0b3IuY29tbWVudEJ1dHRvblBvc2l0aW9uSW5QYWdlOwogIH0KICBnZXQgY29tbWVudFRleHQoKSB7CiAgICByZXR1cm4gdGhpcy5lZGl0b3IuY29tbWVudC50ZXh0OwogIH0KICBzZXQgY29tbWVudFRleHQodGV4dCkgewogICAgdGhpcy5lZGl0b3IuY29tbWVudCA9IHRleHQ7CiAgICBpZiAoIXRleHQpIHsKICAgICAgdGhpcy5yZW1vdmVQb3B1cCgpOwogICAgfQogIH0KICBnZXQgY29tbWVudERhdGEoKSB7CiAgICByZXR1cm4gdGhpcy5lZGl0b3IuZ2V0RGF0YSgpOwogIH0KICByZW1vdmUoKSB7CiAgICB0aGlzLnBhcmVudC5yZW1vdmVBbm5vdGF0aW9uKHRoaXMuZGF0YS5pZCk7CiAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmUoKTsKICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDsKICAgIHRoaXMucmVtb3ZlUG9wdXAoKTsKICB9Cn07CnZhciBMaW5rQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzLCBvcHRpb25zID0gbnVsbCkgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogISFvcHRpb25zPy5pZ25vcmVCb3JkZXIsCiAgICAgIGNyZWF0ZVF1YWRyaWxhdGVyYWxzOiB0cnVlCiAgICB9KTsKICAgIHRoaXMuaXNUb29sdGlwT25seSA9IHBhcmFtZXRlcnMuZGF0YS5pc1Rvb2x0aXBPbmx5OwogIH0KICByZW5kZXIoKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIGxpbmtTZXJ2aWNlCiAgICB9ID0gdGhpczsKICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICBsaW5rLnNldEF0dHJpYnV0ZSgiZGF0YS1lbGVtZW50LWlkIiwgZGF0YS5pZCk7CiAgICBsZXQgaXNCb3VuZCA9IGZhbHNlOwogICAgaWYgKGRhdGEudXJsKSB7CiAgICAgIGxpbmtTZXJ2aWNlLmFkZExpbmtBdHRyaWJ1dGVzKGxpbmssIGRhdGEudXJsLCBkYXRhLm5ld1dpbmRvdyk7CiAgICAgIGlzQm91bmQgPSB0cnVlOwogICAgfSBlbHNlIGlmIChkYXRhLmFjdGlvbikgewogICAgICB0aGlzLl9iaW5kTmFtZWRBY3Rpb24obGluaywgZGF0YS5hY3Rpb24sIGRhdGEub3ZlcmxhaWRUZXh0KTsKICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGRhdGEuYXR0YWNobWVudCkgewogICAgICB0aGlzLiNiaW5kQXR0YWNobWVudChsaW5rLCBkYXRhLmF0dGFjaG1lbnQsIGRhdGEub3ZlcmxhaWRUZXh0LCBkYXRhLmF0dGFjaG1lbnREZXN0KTsKICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGRhdGEuc2V0T0NHU3RhdGUpIHsKICAgICAgdGhpcy4jYmluZFNldE9DR1N0YXRlKGxpbmssIGRhdGEuc2V0T0NHU3RhdGUsIGRhdGEub3ZlcmxhaWRUZXh0KTsKICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICB9IGVsc2UgaWYgKGRhdGEuZGVzdCkgewogICAgICB0aGlzLl9iaW5kTGluayhsaW5rLCBkYXRhLmRlc3QsIGRhdGEub3ZlcmxhaWRUZXh0KTsKICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICBpZiAoZGF0YS5hY3Rpb25zICYmIChkYXRhLmFjdGlvbnMuQWN0aW9uIHx8IGRhdGEuYWN0aW9uc1siTW91c2UgVXAiXSB8fCBkYXRhLmFjdGlvbnNbIk1vdXNlIERvd24iXSkgJiYgdGhpcy5lbmFibGVTY3JpcHRpbmcgJiYgdGhpcy5oYXNKU0FjdGlvbnMpIHsKICAgICAgICB0aGlzLl9iaW5kSlNBY3Rpb24obGluaywgZGF0YSk7CiAgICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGRhdGEucmVzZXRGb3JtKSB7CiAgICAgICAgdGhpcy5fYmluZFJlc2V0Rm9ybUFjdGlvbihsaW5rLCBkYXRhLnJlc2V0Rm9ybSk7CiAgICAgICAgaXNCb3VuZCA9IHRydWU7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1Rvb2x0aXBPbmx5ICYmICFpc0JvdW5kKSB7CiAgICAgICAgdGhpcy5fYmluZExpbmsobGluaywgIiIpOwogICAgICAgIGlzQm91bmQgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJsaW5rQW5ub3RhdGlvbiIpOwogICAgaWYgKGlzQm91bmQpIHsKICAgICAgdGhpcy5jb250ZW50RWxlbWVudCA9IGxpbms7CiAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChsaW5rKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgI3NldEludGVybmFsTGluaygpIHsKICAgIHRoaXMuY29udGFpbmVyLnNldEF0dHJpYnV0ZSgiZGF0YS1pbnRlcm5hbC1saW5rIiwgIiIpOwogIH0KICBfYmluZExpbmsobGluaywgZGVzdGluYXRpb24sIG92ZXJsYWlkVGV4dCA9ICIiKSB7CiAgICBsaW5rLmhyZWYgPSB0aGlzLmxpbmtTZXJ2aWNlLmdldERlc3RpbmF0aW9uSGFzaChkZXN0aW5hdGlvbik7CiAgICBsaW5rLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgIGlmIChkZXN0aW5hdGlvbikgewogICAgICAgIHRoaXMubGlua1NlcnZpY2UuZ29Ub0Rlc3RpbmF0aW9uKGRlc3RpbmF0aW9uKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwogICAgaWYgKGRlc3RpbmF0aW9uIHx8IGRlc3RpbmF0aW9uID09PSAiIikgewogICAgICB0aGlzLiNzZXRJbnRlcm5hbExpbmsoKTsKICAgIH0KICAgIGlmIChvdmVybGFpZFRleHQpIHsKICAgICAgbGluay50aXRsZSA9IG92ZXJsYWlkVGV4dDsKICAgIH0KICB9CiAgX2JpbmROYW1lZEFjdGlvbihsaW5rLCBhY3Rpb24sIG92ZXJsYWlkVGV4dCA9ICIiKSB7CiAgICBsaW5rLmhyZWYgPSB0aGlzLmxpbmtTZXJ2aWNlLmdldEFuY2hvclVybCgiIik7CiAgICBsaW5rLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgIHRoaXMubGlua1NlcnZpY2UuZXhlY3V0ZU5hbWVkQWN0aW9uKGFjdGlvbik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CiAgICBpZiAob3ZlcmxhaWRUZXh0KSB7CiAgICAgIGxpbmsudGl0bGUgPSBvdmVybGFpZFRleHQ7CiAgICB9CiAgICB0aGlzLiNzZXRJbnRlcm5hbExpbmsoKTsKICB9CiAgI2JpbmRBdHRhY2htZW50KGxpbmssIGF0dGFjaG1lbnQsIG92ZXJsYWlkVGV4dCA9ICIiLCBkZXN0ID0gbnVsbCkgewogICAgbGluay5ocmVmID0gdGhpcy5saW5rU2VydmljZS5nZXRBbmNob3JVcmwoIiIpOwogICAgaWYgKGF0dGFjaG1lbnQuZGVzY3JpcHRpb24pIHsKICAgICAgbGluay50aXRsZSA9IGF0dGFjaG1lbnQuZGVzY3JpcHRpb247CiAgICB9IGVsc2UgaWYgKG92ZXJsYWlkVGV4dCkgewogICAgICBsaW5rLnRpdGxlID0gb3ZlcmxhaWRUZXh0OwogICAgfQogICAgbGluay5vbmNsaWNrID0gKCkgPT4gewogICAgICB0aGlzLmRvd25sb2FkTWFuYWdlcj8ub3Blbk9yRG93bmxvYWREYXRhKGF0dGFjaG1lbnQuY29udGVudCwgYXR0YWNobWVudC5maWxlbmFtZSwgZGVzdCk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CiAgICB0aGlzLiNzZXRJbnRlcm5hbExpbmsoKTsKICB9CiAgI2JpbmRTZXRPQ0dTdGF0ZShsaW5rLCBhY3Rpb24sIG92ZXJsYWlkVGV4dCA9ICIiKSB7CiAgICBsaW5rLmhyZWYgPSB0aGlzLmxpbmtTZXJ2aWNlLmdldEFuY2hvclVybCgiIik7CiAgICBsaW5rLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgIHRoaXMubGlua1NlcnZpY2UuZXhlY3V0ZVNldE9DR1N0YXRlKGFjdGlvbik7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CiAgICBpZiAob3ZlcmxhaWRUZXh0KSB7CiAgICAgIGxpbmsudGl0bGUgPSBvdmVybGFpZFRleHQ7CiAgICB9CiAgICB0aGlzLiNzZXRJbnRlcm5hbExpbmsoKTsKICB9CiAgX2JpbmRKU0FjdGlvbihsaW5rLCBkYXRhKSB7CiAgICBsaW5rLmhyZWYgPSB0aGlzLmxpbmtTZXJ2aWNlLmdldEFuY2hvclVybCgiIik7CiAgICBjb25zdCBtYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbWyJBY3Rpb24iLCAib25jbGljayJdLCBbIk1vdXNlIFVwIiwgIm9ubW91c2V1cCJdLCBbIk1vdXNlIERvd24iLCAib25tb3VzZWRvd24iXV0pOwogICAgZm9yIChjb25zdCBuYW1lIG9mIE9iamVjdC5rZXlzKGRhdGEuYWN0aW9ucykpIHsKICAgICAgY29uc3QganNOYW1lID0gbWFwLmdldChuYW1lKTsKICAgICAgaWYgKCFqc05hbWUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBsaW5rW2pzTmFtZV0gPSAoKSA9PiB7CiAgICAgICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goImRpc3BhdGNoZXZlbnRpbnNhbmRib3giLCB7CiAgICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgaWQ6IGRhdGEuaWQsCiAgICAgICAgICAgIG5hbWUKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICB9CiAgICBpZiAoZGF0YS5vdmVybGFpZFRleHQpIHsKICAgICAgbGluay50aXRsZSA9IGRhdGEub3ZlcmxhaWRUZXh0OwogICAgfQogICAgaWYgKCFsaW5rLm9uY2xpY2spIHsKICAgICAgbGluay5vbmNsaWNrID0gKCkgPT4gZmFsc2U7CiAgICB9CiAgICB0aGlzLiNzZXRJbnRlcm5hbExpbmsoKTsKICB9CiAgX2JpbmRSZXNldEZvcm1BY3Rpb24obGluaywgcmVzZXRGb3JtKSB7CiAgICBjb25zdCBvdGhlckNsaWNrQWN0aW9uID0gbGluay5vbmNsaWNrOwogICAgaWYgKCFvdGhlckNsaWNrQWN0aW9uKSB7CiAgICAgIGxpbmsuaHJlZiA9IHRoaXMubGlua1NlcnZpY2UuZ2V0QW5jaG9yVXJsKCIiKTsKICAgIH0KICAgIHRoaXMuI3NldEludGVybmFsTGluaygpOwogICAgaWYgKCF0aGlzLl9maWVsZE9iamVjdHMpIHsKICAgICAgd2FybihgX2JpbmRSZXNldEZvcm1BY3Rpb24gLSAicmVzZXRGb3JtIiBhY3Rpb24gbm90IHN1cHBvcnRlZCwgZW5zdXJlIHRoYXQgdGhlIFxgZmllbGRPYmplY3RzXGAgcGFyYW1ldGVyIGlzIHByb3ZpZGVkLmApOwogICAgICBpZiAoIW90aGVyQ2xpY2tBY3Rpb24pIHsKICAgICAgICBsaW5rLm9uY2xpY2sgPSAoKSA9PiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBsaW5rLm9uY2xpY2sgPSAoKSA9PiB7CiAgICAgIG90aGVyQ2xpY2tBY3Rpb24/LigpOwogICAgICBjb25zdCB7CiAgICAgICAgZmllbGRzOiByZXNldEZvcm1GaWVsZHMsCiAgICAgICAgcmVmczogcmVzZXRGb3JtUmVmcywKICAgICAgICBpbmNsdWRlCiAgICAgIH0gPSByZXNldEZvcm07CiAgICAgIGNvbnN0IGFsbEZpZWxkcyA9IFtdOwogICAgICBpZiAocmVzZXRGb3JtRmllbGRzLmxlbmd0aCAhPT0gMCB8fCByZXNldEZvcm1SZWZzLmxlbmd0aCAhPT0gMCkgewogICAgICAgIGNvbnN0IGZpZWxkSWRzID0gbmV3IFNldChyZXNldEZvcm1SZWZzKTsKICAgICAgICBmb3IgKGNvbnN0IGZpZWxkTmFtZSBvZiByZXNldEZvcm1GaWVsZHMpIHsKICAgICAgICAgIGNvbnN0IGZpZWxkcyA9IHRoaXMuX2ZpZWxkT2JqZWN0c1tmaWVsZE5hbWVdIHx8IFtdOwogICAgICAgICAgZm9yIChjb25zdCB7CiAgICAgICAgICAgIGlkCiAgICAgICAgICB9IG9mIGZpZWxkcykgewogICAgICAgICAgICBmaWVsZElkcy5hZGQoaWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IGZpZWxkcyBvZiBPYmplY3QudmFsdWVzKHRoaXMuX2ZpZWxkT2JqZWN0cykpIHsKICAgICAgICAgIGZvciAoY29uc3QgZmllbGQgb2YgZmllbGRzKSB7CiAgICAgICAgICAgIGlmIChmaWVsZElkcy5oYXMoZmllbGQuaWQpID09PSBpbmNsdWRlKSB7CiAgICAgICAgICAgICAgYWxsRmllbGRzLnB1c2goZmllbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoY29uc3QgZmllbGRzIG9mIE9iamVjdC52YWx1ZXModGhpcy5fZmllbGRPYmplY3RzKSkgewogICAgICAgICAgYWxsRmllbGRzLnB1c2goLi4uZmllbGRzKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuYW5ub3RhdGlvblN0b3JhZ2U7CiAgICAgIGNvbnN0IGFsbElkcyA9IFtdOwogICAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIGFsbEZpZWxkcykgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGlkCiAgICAgICAgfSA9IGZpZWxkOwogICAgICAgIGFsbElkcy5wdXNoKGlkKTsKICAgICAgICBzd2l0Y2ggKGZpZWxkLnR5cGUpIHsKICAgICAgICAgIGNhc2UgInRleHQiOiB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZmllbGQuZGVmYXVsdFZhbHVlIHx8ICIiOwogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAiY2hlY2tib3giOgogICAgICAgICAgY2FzZSAicmFkaW9idXR0b24iOiB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZmllbGQuZGVmYXVsdFZhbHVlID09PSBmaWVsZC5leHBvcnRWYWx1ZXM7CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlICJjb21ib2JveCI6CiAgICAgICAgICBjYXNlICJsaXN0Ym94IjogewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGZpZWxkLmRlZmF1bHRWYWx1ZSB8fCAiIjsKICAgICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBjb25zdCBkb21FbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgW2RhdGEtZWxlbWVudC1pZD0iJHtpZH0iXWApOwogICAgICAgIGlmICghZG9tRWxlbWVudCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSBlbHNlIGlmICghR2V0RWxlbWVudHNCeU5hbWVTZXQuaGFzKGRvbUVsZW1lbnQpKSB7CiAgICAgICAgICB3YXJuKGBfYmluZFJlc2V0Rm9ybUFjdGlvbiAtIGVsZW1lbnQgbm90IGFsbG93ZWQ6ICR7aWR9YCk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgZG9tRWxlbWVudC5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgicmVzZXRmb3JtIikpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmVuYWJsZVNjcmlwdGluZykgewogICAgICAgIHRoaXMubGlua1NlcnZpY2UuZXZlbnRCdXM/LmRpc3BhdGNoKCJkaXNwYXRjaGV2ZW50aW5zYW5kYm94IiwgewogICAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgIGlkOiAiYXBwIiwKICAgICAgICAgICAgaWRzOiBhbGxJZHMsCiAgICAgICAgICAgIG5hbWU6ICJSZXNldEZvcm0iCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKICB9Cn07CnZhciBUZXh0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZQogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInRleHRBbm5vdGF0aW9uIik7CiAgICBjb25zdCBpbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgaW1hZ2Uuc3JjID0gdGhpcy5pbWFnZVJlc291cmNlc1BhdGggKyAiYW5ub3RhdGlvbi0iICsgdGhpcy5kYXRhLm5hbWUudG9Mb3dlckNhc2UoKSArICIuc3ZnIjsKICAgIGltYWdlLnNldEF0dHJpYnV0ZSgiZGF0YS1sMTBuLWlkIiwgInBkZmpzLXRleHQtYW5ub3RhdGlvbi10eXBlIik7CiAgICBpbWFnZS5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1hcmdzIiwgSlNPTi5zdHJpbmdpZnkoewogICAgICB0eXBlOiB0aGlzLmRhdGEubmFtZQogICAgfSkpOwogICAgaWYgKCF0aGlzLmRhdGEucG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChpbWFnZSk7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICByZW5kZXIoKSB7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQogIHNob3dFbGVtZW50QW5kSGlkZUNhbnZhcyhlbGVtZW50KSB7CiAgICBpZiAodGhpcy5kYXRhLmhhc093bkNhbnZhcykgewogICAgICBpZiAoZWxlbWVudC5wcmV2aW91c1NpYmxpbmc/Lm5vZGVOYW1lID09PSAiQ0FOVkFTIikgewogICAgICAgIGVsZW1lbnQucHJldmlvdXNTaWJsaW5nLmhpZGRlbiA9IHRydWU7CiAgICAgIH0KICAgICAgZWxlbWVudC5oaWRkZW4gPSBmYWxzZTsKICAgIH0KICB9CiAgX2dldEtleU1vZGlmaWVyKGV2ZW50KSB7CiAgICByZXR1cm4gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybS5pc01hYyA/IGV2ZW50Lm1ldGFLZXkgOiBldmVudC5jdHJsS2V5OwogIH0KICBfc2V0RXZlbnRMaXN0ZW5lcihlbGVtZW50LCBlbGVtZW50RGF0YSwgYmFzZU5hbWUsIGV2ZW50TmFtZSwgdmFsdWVHZXR0ZXIpIHsKICAgIGlmIChiYXNlTmFtZS5pbmNsdWRlcygibW91c2UiKSkgewogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoYmFzZU5hbWUsIChldmVudCkgPT4gewogICAgICAgIHRoaXMubGlua1NlcnZpY2UuZXZlbnRCdXM/LmRpc3BhdGNoKCJkaXNwYXRjaGV2ZW50aW5zYW5kYm94IiwgewogICAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgIGlkOiB0aGlzLmRhdGEuaWQsCiAgICAgICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICAgICAgdmFsdWU6IHZhbHVlR2V0dGVyKGV2ZW50KSwKICAgICAgICAgICAgc2hpZnQ6IGV2ZW50LnNoaWZ0S2V5LAogICAgICAgICAgICBtb2RpZmllcjogdGhpcy5fZ2V0S2V5TW9kaWZpZXIoZXZlbnQpCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGJhc2VOYW1lLCAoZXZlbnQpID0+IHsKICAgICAgICBpZiAoYmFzZU5hbWUgPT09ICJibHVyIikgewogICAgICAgICAgaWYgKCFlbGVtZW50RGF0YS5mb2N1c2VkIHx8ICFldmVudC5yZWxhdGVkVGFyZ2V0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnREYXRhLmZvY3VzZWQgPSBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKGJhc2VOYW1lID09PSAiZm9jdXMiKSB7CiAgICAgICAgICBpZiAoZWxlbWVudERhdGEuZm9jdXNlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50RGF0YS5mb2N1c2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCF2YWx1ZUdldHRlcikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLmV2ZW50QnVzPy5kaXNwYXRjaCgiZGlzcGF0Y2hldmVudGluc2FuZGJveCIsIHsKICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgIGRldGFpbDogewogICAgICAgICAgICBpZDogdGhpcy5kYXRhLmlkLAogICAgICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgICAgIHZhbHVlOiB2YWx1ZUdldHRlcihldmVudCkKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfQogIF9zZXRFdmVudExpc3RlbmVycyhlbGVtZW50LCBlbGVtZW50RGF0YSwgbmFtZXMsIGdldHRlcikgewogICAgZm9yIChjb25zdCBbYmFzZU5hbWUsIGV2ZW50TmFtZV0gb2YgbmFtZXMpIHsKICAgICAgaWYgKGV2ZW50TmFtZSA9PT0gIkFjdGlvbiIgfHwgdGhpcy5kYXRhLmFjdGlvbnM/LltldmVudE5hbWVdKSB7CiAgICAgICAgaWYgKGV2ZW50TmFtZSA9PT0gIkZvY3VzIiB8fCBldmVudE5hbWUgPT09ICJCbHVyIikgewogICAgICAgICAgZWxlbWVudERhdGEgfHw9IHsKICAgICAgICAgICAgZm9jdXNlZDogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3NldEV2ZW50TGlzdGVuZXIoZWxlbWVudCwgZWxlbWVudERhdGEsIGJhc2VOYW1lLCBldmVudE5hbWUsIGdldHRlcik7CiAgICAgICAgaWYgKGV2ZW50TmFtZSA9PT0gIkZvY3VzIiAmJiAhdGhpcy5kYXRhLmFjdGlvbnM/LkJsdXIpIHsKICAgICAgICAgIHRoaXMuX3NldEV2ZW50TGlzdGVuZXIoZWxlbWVudCwgZWxlbWVudERhdGEsICJibHVyIiwgIkJsdXIiLCBudWxsKTsKICAgICAgICB9IGVsc2UgaWYgKGV2ZW50TmFtZSA9PT0gIkJsdXIiICYmICF0aGlzLmRhdGEuYWN0aW9ucz8uRm9jdXMpIHsKICAgICAgICAgIHRoaXMuX3NldEV2ZW50TGlzdGVuZXIoZWxlbWVudCwgZWxlbWVudERhdGEsICJmb2N1cyIsICJGb2N1cyIsIG51bGwpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBfc2V0QmFja2dyb3VuZENvbG9yKGVsZW1lbnQpIHsKICAgIGNvbnN0IGNvbG9yID0gdGhpcy5kYXRhLmJhY2tncm91bmRDb2xvciB8fCBudWxsOwogICAgZWxlbWVudC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvciA9PT0gbnVsbCA/ICJ0cmFuc3BhcmVudCIgOiBVdGlsLm1ha2VIZXhDb2xvcihjb2xvclswXSwgY29sb3JbMV0sIGNvbG9yWzJdKTsKICB9CiAgX3NldFRleHRTdHlsZShlbGVtZW50KSB7CiAgICBjb25zdCBURVhUX0FMSUdOTUVOVCA9IFsibGVmdCIsICJjZW50ZXIiLCAicmlnaHQiXTsKICAgIGNvbnN0IHsKICAgICAgZm9udENvbG9yCiAgICB9ID0gdGhpcy5kYXRhLmRlZmF1bHRBcHBlYXJhbmNlRGF0YTsKICAgIGNvbnN0IGZvbnRTaXplID0gdGhpcy5kYXRhLmRlZmF1bHRBcHBlYXJhbmNlRGF0YS5mb250U2l6ZSB8fCBhbm5vdGF0aW9uX2xheWVyX0RFRkFVTFRfRk9OVF9TSVpFOwogICAgY29uc3Qgc3R5bGUgPSBlbGVtZW50LnN0eWxlOwogICAgbGV0IGNvbXB1dGVkRm9udFNpemU7CiAgICBjb25zdCBCT1JERVJfU0laRSA9IDI7CiAgICBjb25zdCByb3VuZFRvT25lRGVjaW1hbCA9ICh4KSA9PiBNYXRoLnJvdW5kKDEwICogeCkgLyAxMDsKICAgIGlmICh0aGlzLmRhdGEubXVsdGlMaW5lKSB7CiAgICAgIGNvbnN0IGhlaWdodCA9IE1hdGguYWJzKHRoaXMuZGF0YS5yZWN0WzNdIC0gdGhpcy5kYXRhLnJlY3RbMV0gLSBCT1JERVJfU0laRSk7CiAgICAgIGNvbnN0IG51bWJlck9mTGluZXMgPSBNYXRoLnJvdW5kKGhlaWdodCAvIChMSU5FX0ZBQ1RPUiAqIGZvbnRTaXplKSkgfHwgMTsKICAgICAgY29uc3QgbGluZUhlaWdodCA9IGhlaWdodCAvIG51bWJlck9mTGluZXM7CiAgICAgIGNvbXB1dGVkRm9udFNpemUgPSBNYXRoLm1pbihmb250U2l6ZSwgcm91bmRUb09uZURlY2ltYWwobGluZUhlaWdodCAvIExJTkVfRkFDVE9SKSk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBoZWlnaHQgPSBNYXRoLmFicyh0aGlzLmRhdGEucmVjdFszXSAtIHRoaXMuZGF0YS5yZWN0WzFdIC0gQk9SREVSX1NJWkUpOwogICAgICBjb21wdXRlZEZvbnRTaXplID0gTWF0aC5taW4oZm9udFNpemUsIHJvdW5kVG9PbmVEZWNpbWFsKGhlaWdodCAvIExJTkVfRkFDVE9SKSk7CiAgICB9CiAgICBzdHlsZS5mb250U2l6ZSA9IGBjYWxjKCR7Y29tcHV0ZWRGb250U2l6ZX1weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikpYDsKICAgIHN0eWxlLmNvbG9yID0gVXRpbC5tYWtlSGV4Q29sb3IoZm9udENvbG9yWzBdLCBmb250Q29sb3JbMV0sIGZvbnRDb2xvclsyXSk7CiAgICBpZiAodGhpcy5kYXRhLnRleHRBbGlnbm1lbnQgIT09IG51bGwpIHsKICAgICAgc3R5bGUudGV4dEFsaWduID0gVEVYVF9BTElHTk1FTlRbdGhpcy5kYXRhLnRleHRBbGlnbm1lbnRdOwogICAgfQogIH0KICBfc2V0UmVxdWlyZWQoZWxlbWVudCwgaXNSZXF1aXJlZCkgewogICAgaWYgKGlzUmVxdWlyZWQpIHsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInJlcXVpcmVkIiwgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgicmVxdWlyZWQiKTsKICAgIH0KICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJhcmlhLXJlcXVpcmVkIiwgaXNSZXF1aXJlZCk7CiAgfQp9Owp2YXIgVGV4dFdpZGdldEFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgY29uc3QgaXNSZW5kZXJhYmxlID0gcGFyYW1ldGVycy5yZW5kZXJGb3JtcyB8fCBwYXJhbWV0ZXJzLmRhdGEuaGFzT3duQ2FudmFzIHx8ICFwYXJhbWV0ZXJzLmRhdGEuaGFzQXBwZWFyYW5jZSAmJiAhIXBhcmFtZXRlcnMuZGF0YS5maWVsZFZhbHVlOwogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGUKICAgIH0pOwogIH0KICBzZXRQcm9wZXJ0eU9uU2libGluZ3MoYmFzZSwga2V5LCB2YWx1ZSwga2V5SW5TdG9yYWdlKSB7CiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZTsKICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLl9nZXRFbGVtZW50c0J5TmFtZShiYXNlLm5hbWUsIGJhc2UuaWQpKSB7CiAgICAgIGlmIChlbGVtZW50LmRvbUVsZW1lbnQpIHsKICAgICAgICBlbGVtZW50LmRvbUVsZW1lbnRba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoZWxlbWVudC5pZCwgewogICAgICAgIFtrZXlJblN0b3JhZ2VdOiB2YWx1ZQogICAgICB9KTsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgY29uc3Qgc3RvcmFnZSA9IHRoaXMuYW5ub3RhdGlvblN0b3JhZ2U7CiAgICBjb25zdCBpZCA9IHRoaXMuZGF0YS5pZDsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInRleHRXaWRnZXRBbm5vdGF0aW9uIik7CiAgICBsZXQgZWxlbWVudCA9IG51bGw7CiAgICBpZiAodGhpcy5yZW5kZXJGb3JtcykgewogICAgICBjb25zdCBzdG9yZWREYXRhID0gc3RvcmFnZS5nZXRWYWx1ZShpZCwgewogICAgICAgIHZhbHVlOiB0aGlzLmRhdGEuZmllbGRWYWx1ZQogICAgICB9KTsKICAgICAgbGV0IHRleHRDb250ZW50ID0gc3RvcmVkRGF0YS52YWx1ZSB8fCAiIjsKICAgICAgY29uc3QgbWF4TGVuID0gc3RvcmFnZS5nZXRWYWx1ZShpZCwgewogICAgICAgIGNoYXJMaW1pdDogdGhpcy5kYXRhLm1heExlbgogICAgICB9KS5jaGFyTGltaXQ7CiAgICAgIGlmIChtYXhMZW4gJiYgdGV4dENvbnRlbnQubGVuZ3RoID4gbWF4TGVuKSB7CiAgICAgICAgdGV4dENvbnRlbnQgPSB0ZXh0Q29udGVudC5zbGljZSgwLCBtYXhMZW4pOwogICAgICB9CiAgICAgIGxldCBmaWVsZEZvcm1hdHRlZFZhbHVlcyA9IHN0b3JlZERhdGEuZm9ybWF0dGVkVmFsdWUgfHwgdGhpcy5kYXRhLnRleHRDb250ZW50Py5qb2luKCJcbiIpIHx8IG51bGw7CiAgICAgIGlmIChmaWVsZEZvcm1hdHRlZFZhbHVlcyAmJiB0aGlzLmRhdGEuY29tYikgewogICAgICAgIGZpZWxkRm9ybWF0dGVkVmFsdWVzID0gZmllbGRGb3JtYXR0ZWRWYWx1ZXMucmVwbGFjZUFsbCgvXHMrL2csICIiKTsKICAgICAgfQogICAgICBjb25zdCBlbGVtZW50RGF0YSA9IHsKICAgICAgICB1c2VyVmFsdWU6IHRleHRDb250ZW50LAogICAgICAgIGZvcm1hdHRlZFZhbHVlOiBmaWVsZEZvcm1hdHRlZFZhbHVlcywKICAgICAgICBsYXN0Q29tbWl0dGVkVmFsdWU6IG51bGwsCiAgICAgICAgY29tbWl0S2V5OiAxLAogICAgICAgIGZvY3VzZWQ6IGZhbHNlCiAgICAgIH07CiAgICAgIGlmICh0aGlzLmRhdGEubXVsdGlMaW5lKSB7CiAgICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRleHRhcmVhIik7CiAgICAgICAgZWxlbWVudC50ZXh0Q29udGVudCA9IGZpZWxkRm9ybWF0dGVkVmFsdWVzID8/IHRleHRDb250ZW50OwogICAgICAgIGlmICh0aGlzLmRhdGEuZG9Ob3RTY3JvbGwpIHsKICAgICAgICAgIGVsZW1lbnQuc3R5bGUub3ZlcmZsb3dZID0gImhpZGRlbiI7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgIGVsZW1lbnQudHlwZSA9IHRoaXMuZGF0YS5wYXNzd29yZCA/ICJwYXNzd29yZCIgOiAidGV4dCI7CiAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgZmllbGRGb3JtYXR0ZWRWYWx1ZXMgPz8gdGV4dENvbnRlbnQpOwogICAgICAgIGlmICh0aGlzLmRhdGEuZG9Ob3RTY3JvbGwpIHsKICAgICAgICAgIGVsZW1lbnQuc3R5bGUub3ZlcmZsb3dYID0gImhpZGRlbiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLmRhdGEuaGFzT3duQ2FudmFzKSB7CiAgICAgICAgZWxlbWVudC5oaWRkZW4gPSB0cnVlOwogICAgICB9CiAgICAgIEdldEVsZW1lbnRzQnlOYW1lU2V0LmFkZChlbGVtZW50KTsKICAgICAgdGhpcy5jb250ZW50RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJkYXRhLWVsZW1lbnQtaWQiLCBpZCk7CiAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPSB0aGlzLmRhdGEucmVhZE9ubHk7CiAgICAgIGVsZW1lbnQubmFtZSA9IHRoaXMuZGF0YS5maWVsZE5hbWU7CiAgICAgIGVsZW1lbnQudGFiSW5kZXggPSAwOwogICAgICBjb25zdCB7CiAgICAgICAgZGF0ZXRpbWVGb3JtYXQsCiAgICAgICAgZGF0ZXRpbWVUeXBlLAogICAgICAgIHRpbWVTdGVwCiAgICAgIH0gPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IGhhc0RhdGVPclRpbWUgPSAhIWRhdGV0aW1lVHlwZSAmJiB0aGlzLmVuYWJsZVNjcmlwdGluZzsKICAgICAgaWYgKGRhdGV0aW1lRm9ybWF0KSB7CiAgICAgICAgZWxlbWVudC50aXRsZSA9IGRhdGV0aW1lRm9ybWF0OwogICAgICB9CiAgICAgIHRoaXMuX3NldFJlcXVpcmVkKGVsZW1lbnQsIHRoaXMuZGF0YS5yZXF1aXJlZCk7CiAgICAgIGlmIChtYXhMZW4pIHsKICAgICAgICBlbGVtZW50Lm1heExlbmd0aCA9IG1heExlbjsKICAgICAgfQogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgKGV2ZW50KSA9PiB7CiAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgdmFsdWU6IGV2ZW50LnRhcmdldC52YWx1ZQogICAgICAgIH0pOwogICAgICAgIHRoaXMuc2V0UHJvcGVydHlPblNpYmxpbmdzKGVsZW1lbnQsICJ2YWx1ZSIsIGV2ZW50LnRhcmdldC52YWx1ZSwgInZhbHVlIik7CiAgICAgICAgZWxlbWVudERhdGEuZm9ybWF0dGVkVmFsdWUgPSBudWxsOwogICAgICB9KTsKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJyZXNldGZvcm0iLCAoZXZlbnQpID0+IHsKICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSB0aGlzLmRhdGEuZGVmYXVsdEZpZWxkVmFsdWUgPz8gIiI7CiAgICAgICAgZWxlbWVudC52YWx1ZSA9IGVsZW1lbnREYXRhLnVzZXJWYWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgICBlbGVtZW50RGF0YS5mb3JtYXR0ZWRWYWx1ZSA9IG51bGw7CiAgICAgIH0pOwogICAgICBsZXQgYmx1ckxpc3RlbmVyID0gKGV2ZW50KSA9PiB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgZm9ybWF0dGVkVmFsdWUKICAgICAgICB9ID0gZWxlbWVudERhdGE7CiAgICAgICAgaWYgKGZvcm1hdHRlZFZhbHVlICE9PSBudWxsICYmIGZvcm1hdHRlZFZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgICAgIGV2ZW50LnRhcmdldC52YWx1ZSA9IGZvcm1hdHRlZFZhbHVlOwogICAgICAgIH0KICAgICAgICBldmVudC50YXJnZXQuc2Nyb2xsTGVmdCA9IDA7CiAgICAgIH07CiAgICAgIGlmICh0aGlzLmVuYWJsZVNjcmlwdGluZyAmJiB0aGlzLmhhc0pTQWN0aW9ucykgewogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZm9jdXMiLCAoZXZlbnQpID0+IHsKICAgICAgICAgIGlmIChlbGVtZW50RGF0YS5mb2N1c2VkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgdGFyZ2V0CiAgICAgICAgICB9ID0gZXZlbnQ7CiAgICAgICAgICBpZiAoaGFzRGF0ZU9yVGltZSkgewogICAgICAgICAgICB0YXJnZXQudHlwZSA9IGRhdGV0aW1lVHlwZTsKICAgICAgICAgICAgaWYgKHRpbWVTdGVwKSB7CiAgICAgICAgICAgICAgdGFyZ2V0LnN0ZXAgPSB0aW1lU3RlcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGVsZW1lbnREYXRhLnVzZXJWYWx1ZSkgewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGVsZW1lbnREYXRhLnVzZXJWYWx1ZTsKICAgICAgICAgICAgaWYgKGhhc0RhdGVPclRpbWUpIHsKICAgICAgICAgICAgICBpZiAoZGF0ZXRpbWVUeXBlID09PSAidGltZSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IFtkYXRlLmdldEhvdXJzKCksIGRhdGUuZ2V0TWludXRlcygpLCBkYXRlLmdldFNlY29uZHMoKV07CiAgICAgICAgICAgICAgICB0YXJnZXQudmFsdWUgPSBwYXJ0cy5tYXAoKHYpID0+IHYudG9TdHJpbmcoKS5wYWRTdGFydCgyLCAiMCIpKS5qb2luKCI6Iik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhcmdldC52YWx1ZSA9IG5ldyBEYXRlKHZhbHVlIC0gVElNRVpPTkVfT0ZGU0VUKS50b0lTT1N0cmluZygpLnNwbGl0KGRhdGV0aW1lVHlwZSA9PT0gImRhdGUiID8gIlQiIDogIi4iLCAxKVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGFyZ2V0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnREYXRhLmxhc3RDb21taXR0ZWRWYWx1ZSA9IHRhcmdldC52YWx1ZTsKICAgICAgICAgIGVsZW1lbnREYXRhLmNvbW1pdEtleSA9IDE7CiAgICAgICAgICBpZiAoIXRoaXMuZGF0YS5hY3Rpb25zPy5Gb2N1cykgewogICAgICAgICAgICBlbGVtZW50RGF0YS5mb2N1c2VkID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInVwZGF0ZWZyb21zYW5kYm94IiwgKGpzRXZlbnQpID0+IHsKICAgICAgICAgIHRoaXMuc2hvd0VsZW1lbnRBbmRIaWRlQ2FudmFzKGpzRXZlbnQudGFyZ2V0KTsKICAgICAgICAgIGNvbnN0IGFjdGlvbnMgPSB7CiAgICAgICAgICAgIHZhbHVlKGV2ZW50KSB7CiAgICAgICAgICAgICAgZWxlbWVudERhdGEudXNlclZhbHVlID0gZXZlbnQuZGV0YWlsLnZhbHVlID8/ICIiOwogICAgICAgICAgICAgIGlmICghaGFzRGF0ZU9yVGltZSkgewogICAgICAgICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICAgICAgICB2YWx1ZTogZWxlbWVudERhdGEudXNlclZhbHVlLnRvU3RyaW5nKCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBlbGVtZW50RGF0YS51c2VyVmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZvcm1hdHRlZFZhbHVlKGV2ZW50KSB7CiAgICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgICAgZm9ybWF0dGVkVmFsdWUKICAgICAgICAgICAgICB9ID0gZXZlbnQuZGV0YWlsOwogICAgICAgICAgICAgIGVsZW1lbnREYXRhLmZvcm1hdHRlZFZhbHVlID0gZm9ybWF0dGVkVmFsdWU7CiAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlZFZhbHVlICE9PSBudWxsICYmIGZvcm1hdHRlZFZhbHVlICE9PSB2b2lkIDAgJiYgZXZlbnQudGFyZ2V0ICE9PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQudmFsdWUgPSBmb3JtYXR0ZWRWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHsKICAgICAgICAgICAgICAgIGZvcm1hdHRlZFZhbHVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoaGFzRGF0ZU9yVGltZSkgewogICAgICAgICAgICAgICAgZGF0YS52YWx1ZSA9IGZvcm1hdHRlZFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCBkYXRhKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2VsUmFuZ2UoZXZlbnQpIHsKICAgICAgICAgICAgICBldmVudC50YXJnZXQuc2V0U2VsZWN0aW9uUmFuZ2UoLi4uZXZlbnQuZGV0YWlsLnNlbFJhbmdlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hhckxpbWl0OiAoZXZlbnQpID0+IHsKICAgICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAgICBjaGFyTGltaXQKICAgICAgICAgICAgICB9ID0gZXZlbnQuZGV0YWlsOwogICAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICAgIHRhcmdldAogICAgICAgICAgICAgIH0gPSBldmVudDsKICAgICAgICAgICAgICBpZiAoY2hhckxpbWl0ID09PSAwKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQucmVtb3ZlQXR0cmlidXRlKCJtYXhMZW5ndGgiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGFyZ2V0LnNldEF0dHJpYnV0ZSgibWF4TGVuZ3RoIiwgY2hhckxpbWl0KTsKICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBlbGVtZW50RGF0YS51c2VyVmFsdWU7CiAgICAgICAgICAgICAgaWYgKCF2YWx1ZSB8fCB2YWx1ZS5sZW5ndGggPD0gY2hhckxpbWl0KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMCwgY2hhckxpbWl0KTsKICAgICAgICAgICAgICB0YXJnZXQudmFsdWUgPSBlbGVtZW50RGF0YS51c2VyVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHRoaXMubGlua1NlcnZpY2UuZXZlbnRCdXM/LmRpc3BhdGNoKCJkaXNwYXRjaGV2ZW50aW5zYW5kYm94IiwgewogICAgICAgICAgICAgICAgc291cmNlOiB0aGlzLAogICAgICAgICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgICAgICAgIGlkLAogICAgICAgICAgICAgICAgICBuYW1lOiAiS2V5c3Ryb2tlIiwKICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgIHdpbGxDb21taXQ6IHRydWUsCiAgICAgICAgICAgICAgICAgIGNvbW1pdEtleTogMSwKICAgICAgICAgICAgICAgICAgc2VsU3RhcnQ6IHRhcmdldC5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICAgICAgc2VsRW5kOiB0YXJnZXQuc2VsZWN0aW9uRW5kCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB0aGlzLl9kaXNwYXRjaEV2ZW50RnJvbVNhbmRib3goYWN0aW9ucywganNFdmVudCk7CiAgICAgICAgfSk7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICBlbGVtZW50RGF0YS5jb21taXRLZXkgPSAxOwogICAgICAgICAgbGV0IGNvbW1pdEtleSA9IC0xOwogICAgICAgICAgaWYgKGV2ZW50LmtleSA9PT0gIkVzY2FwZSIpIHsKICAgICAgICAgICAgY29tbWl0S2V5ID0gMDsKICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2V5ID09PSAiRW50ZXIiICYmICF0aGlzLmRhdGEubXVsdGlMaW5lKSB7CiAgICAgICAgICAgIGNvbW1pdEtleSA9IDI7CiAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmtleSA9PT0gIlRhYiIpIHsKICAgICAgICAgICAgZWxlbWVudERhdGEuY29tbWl0S2V5ID0gMzsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb21taXRLZXkgPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgdmFsdWUKICAgICAgICAgIH0gPSBldmVudC50YXJnZXQ7CiAgICAgICAgICBpZiAoZWxlbWVudERhdGEubGFzdENvbW1pdHRlZFZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50RGF0YS5sYXN0Q29tbWl0dGVkVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIGVsZW1lbnREYXRhLnVzZXJWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goImRpc3BhdGNoZXZlbnRpbnNhbmRib3giLCB7CiAgICAgICAgICAgIHNvdXJjZTogdGhpcywKICAgICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgICAgaWQsCiAgICAgICAgICAgICAgbmFtZTogIktleXN0cm9rZSIsCiAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgd2lsbENvbW1pdDogdHJ1ZSwKICAgICAgICAgICAgICBjb21taXRLZXksCiAgICAgICAgICAgICAgc2VsU3RhcnQ6IGV2ZW50LnRhcmdldC5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBzZWxFbmQ6IGV2ZW50LnRhcmdldC5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgX2JsdXJMaXN0ZW5lciA9IGJsdXJMaXN0ZW5lcjsKICAgICAgICBibHVyTGlzdGVuZXIgPSBudWxsOwogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIChldmVudCkgPT4gewogICAgICAgICAgaWYgKCFlbGVtZW50RGF0YS5mb2N1c2VkIHx8ICFldmVudC5yZWxhdGVkVGFyZ2V0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhpcy5kYXRhLmFjdGlvbnM/LkJsdXIpIHsKICAgICAgICAgICAgZWxlbWVudERhdGEuZm9jdXNlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgewogICAgICAgICAgICB0YXJnZXQKICAgICAgICAgIH0gPSBldmVudDsKICAgICAgICAgIGxldCB7CiAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICB9ID0gdGFyZ2V0OwogICAgICAgICAgaWYgKGhhc0RhdGVPclRpbWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICYmIGRhdGV0aW1lVHlwZSA9PT0gInRpbWUiKSB7CiAgICAgICAgICAgICAgY29uc3QgcGFydHMgPSB2YWx1ZS5zcGxpdCgiOiIpLm1hcCgodikgPT4gcGFyc2VJbnQodiwgMTApKTsKICAgICAgICAgICAgICB2YWx1ZSA9IG5ldyBEYXRlKDJlMywgMCwgMSwgcGFydHNbMF0sIHBhcnRzWzFdLCBwYXJ0c1syXSB8fCAwKS52YWx1ZU9mKCk7CiAgICAgICAgICAgICAgdGFyZ2V0LnN0ZXAgPSAiIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIXZhbHVlLmluY2x1ZGVzKCJUIikpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gYCR7dmFsdWV9VDAwOjAwYDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFsdWUgPSBuZXcgRGF0ZSh2YWx1ZSkudmFsdWVPZigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldC50eXBlID0gInRleHQiOwogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudERhdGEudXNlclZhbHVlID0gdmFsdWU7CiAgICAgICAgICBpZiAoZWxlbWVudERhdGEubGFzdENvbW1pdHRlZFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLmV2ZW50QnVzPy5kaXNwYXRjaCgiZGlzcGF0Y2hldmVudGluc2FuZGJveCIsIHsKICAgICAgICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgICAgICBpZCwKICAgICAgICAgICAgICAgIG5hbWU6ICJLZXlzdHJva2UiLAogICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICB3aWxsQ29tbWl0OiB0cnVlLAogICAgICAgICAgICAgICAgY29tbWl0S2V5OiBlbGVtZW50RGF0YS5jb21taXRLZXksCiAgICAgICAgICAgICAgICBzZWxTdGFydDogZXZlbnQudGFyZ2V0LnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgICAgc2VsRW5kOiBldmVudC50YXJnZXQuc2VsZWN0aW9uRW5kCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIF9ibHVyTGlzdGVuZXIoZXZlbnQpOwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmRhdGEuYWN0aW9ucz8uS2V5c3Ryb2tlKSB7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImJlZm9yZWlucHV0IiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICAgIGVsZW1lbnREYXRhLmxhc3RDb21taXR0ZWRWYWx1ZSA9IG51bGw7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICBkYXRhLAogICAgICAgICAgICAgIHRhcmdldAogICAgICAgICAgICB9ID0gZXZlbnQ7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICBzZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBzZWxlY3Rpb25FbmQKICAgICAgICAgICAgfSA9IHRhcmdldDsKICAgICAgICAgICAgbGV0IHNlbFN0YXJ0ID0gc2VsZWN0aW9uU3RhcnQsIHNlbEVuZCA9IHNlbGVjdGlvbkVuZDsKICAgICAgICAgICAgc3dpdGNoIChldmVudC5pbnB1dFR5cGUpIHsKICAgICAgICAgICAgICBjYXNlICJkZWxldGVXb3JkQmFja3dhcmQiOiB7CiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IHZhbHVlLnN1YnN0cmluZygwLCBzZWxlY3Rpb25TdGFydCkubWF0Y2goL1x3KlteXHddKiQvKTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICBzZWxTdGFydCAtPSBtYXRjaFswXS5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAiZGVsZXRlV29yZEZvcndhcmQiOiB7CiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IHZhbHVlLnN1YnN0cmluZyhzZWxlY3Rpb25TdGFydCkubWF0Y2goL15bXlx3XSpcdyovKTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICBzZWxFbmQgKz0gbWF0Y2hbMF0ubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgImRlbGV0ZUNvbnRlbnRCYWNrd2FyZCI6CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0aW9uU3RhcnQgPT09IHNlbGVjdGlvbkVuZCkgewogICAgICAgICAgICAgICAgICBzZWxTdGFydCAtPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiZGVsZXRlQ29udGVudEZvcndhcmQiOgogICAgICAgICAgICAgICAgaWYgKHNlbGVjdGlvblN0YXJ0ID09PSBzZWxlY3Rpb25FbmQpIHsKICAgICAgICAgICAgICAgICAgc2VsRW5kICs9IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB0aGlzLmxpbmtTZXJ2aWNlLmV2ZW50QnVzPy5kaXNwYXRjaCgiZGlzcGF0Y2hldmVudGluc2FuZGJveCIsIHsKICAgICAgICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgICAgICAgZGV0YWlsOiB7CiAgICAgICAgICAgICAgICBpZCwKICAgICAgICAgICAgICAgIG5hbWU6ICJLZXlzdHJva2UiLAogICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICBjaGFuZ2U6IGRhdGEgfHwgIiIsCiAgICAgICAgICAgICAgICB3aWxsQ29tbWl0OiBmYWxzZSwKICAgICAgICAgICAgICAgIHNlbFN0YXJ0LAogICAgICAgICAgICAgICAgc2VsRW5kCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zZXRFdmVudExpc3RlbmVycyhlbGVtZW50LCBlbGVtZW50RGF0YSwgW1siZm9jdXMiLCAiRm9jdXMiXSwgWyJibHVyIiwgIkJsdXIiXSwgWyJtb3VzZWRvd24iLCAiTW91c2UgRG93biJdLCBbIm1vdXNlZW50ZXIiLCAiTW91c2UgRW50ZXIiXSwgWyJtb3VzZWxlYXZlIiwgIk1vdXNlIEV4aXQiXSwgWyJtb3VzZXVwIiwgIk1vdXNlIFVwIl1dLCAoZXZlbnQpID0+IGV2ZW50LnRhcmdldC52YWx1ZSk7CiAgICAgIH0KICAgICAgaWYgKGJsdXJMaXN0ZW5lcikgewogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIGJsdXJMaXN0ZW5lcik7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuZGF0YS5jb21iKSB7CiAgICAgICAgY29uc3QgZmllbGRXaWR0aCA9IHRoaXMuZGF0YS5yZWN0WzJdIC0gdGhpcy5kYXRhLnJlY3RbMF07CiAgICAgICAgY29uc3QgY29tYldpZHRoID0gZmllbGRXaWR0aCAvIG1heExlbjsKICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoImNvbWIiKTsKICAgICAgICBlbGVtZW50LnN0eWxlLmxldHRlclNwYWNpbmcgPSBgY2FsYygke2NvbWJXaWR0aH1weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikgLSAxY2gpYDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbGVtZW50LnRleHRDb250ZW50ID0gdGhpcy5kYXRhLmZpZWxkVmFsdWU7CiAgICAgIGVsZW1lbnQuc3R5bGUudmVydGljYWxBbGlnbiA9ICJtaWRkbGUiOwogICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAidGFibGUtY2VsbCI7CiAgICAgIGlmICh0aGlzLmRhdGEuaGFzT3duQ2FudmFzKSB7CiAgICAgICAgZWxlbWVudC5oaWRkZW4gPSB0cnVlOwogICAgICB9CiAgICB9CiAgICB0aGlzLl9zZXRUZXh0U3R5bGUoZWxlbWVudCk7CiAgICB0aGlzLl9zZXRCYWNrZ3JvdW5kQ29sb3IoZWxlbWVudCk7CiAgICB0aGlzLl9zZXREZWZhdWx0UHJvcGVydGllc0Zyb21KUyhlbGVtZW50KTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChlbGVtZW50KTsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBTaWduYXR1cmVXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiAhIXBhcmFtZXRlcnMuZGF0YS5oYXNPd25DYW52YXMKICAgIH0pOwogIH0KfTsKdmFyIENoZWNrYm94V2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIFdpZGdldEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogcGFyYW1ldGVycy5yZW5kZXJGb3JtcwogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IHN0b3JhZ2UgPSB0aGlzLmFubm90YXRpb25TdG9yYWdlOwogICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgIGNvbnN0IGlkID0gZGF0YS5pZDsKICAgIGxldCB2YWx1ZSA9IHN0b3JhZ2UuZ2V0VmFsdWUoaWQsIHsKICAgICAgdmFsdWU6IGRhdGEuZXhwb3J0VmFsdWUgPT09IGRhdGEuZmllbGRWYWx1ZQogICAgfSkudmFsdWU7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICB2YWx1ZSA9IHZhbHVlICE9PSAiT2ZmIjsKICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgIHZhbHVlCiAgICAgIH0pOwogICAgfQogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiYnV0dG9uV2lkZ2V0QW5ub3RhdGlvbiIsICJjaGVja0JveCIpOwogICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICBHZXRFbGVtZW50c0J5TmFtZVNldC5hZGQoZWxlbWVudCk7CiAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1lbGVtZW50LWlkIiwgaWQpOwogICAgZWxlbWVudC5kaXNhYmxlZCA9IGRhdGEucmVhZE9ubHk7CiAgICB0aGlzLl9zZXRSZXF1aXJlZChlbGVtZW50LCB0aGlzLmRhdGEucmVxdWlyZWQpOwogICAgZWxlbWVudC50eXBlID0gImNoZWNrYm94IjsKICAgIGVsZW1lbnQubmFtZSA9IGRhdGEuZmllbGROYW1lOwogICAgaWYgKHZhbHVlKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJjaGVja2VkIiwgdHJ1ZSk7CiAgICB9CiAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiZXhwb3J0VmFsdWUiLCBkYXRhLmV4cG9ydFZhbHVlKTsKICAgIGVsZW1lbnQudGFiSW5kZXggPSAwOwogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoZXZlbnQpID0+IHsKICAgICAgY29uc3QgewogICAgICAgIG5hbWUsCiAgICAgICAgY2hlY2tlZAogICAgICB9ID0gZXZlbnQudGFyZ2V0OwogICAgICBmb3IgKGNvbnN0IGNoZWNrYm94IG9mIHRoaXMuX2dldEVsZW1lbnRzQnlOYW1lKG5hbWUsIGlkKSkgewogICAgICAgIGNvbnN0IGN1ckNoZWNrZWQgPSBjaGVja2VkICYmIGNoZWNrYm94LmV4cG9ydFZhbHVlID09PSBkYXRhLmV4cG9ydFZhbHVlOwogICAgICAgIGlmIChjaGVja2JveC5kb21FbGVtZW50KSB7CiAgICAgICAgICBjaGVja2JveC5kb21FbGVtZW50LmNoZWNrZWQgPSBjdXJDaGVja2VkOwogICAgICAgIH0KICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGNoZWNrYm94LmlkLCB7CiAgICAgICAgICB2YWx1ZTogY3VyQ2hlY2tlZAogICAgICAgIH0pOwogICAgICB9CiAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICB2YWx1ZTogY2hlY2tlZAogICAgICB9KTsKICAgIH0pOwogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJyZXNldGZvcm0iLCAoZXZlbnQpID0+IHsKICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gZGF0YS5kZWZhdWx0RmllbGRWYWx1ZSB8fCAiT2ZmIjsKICAgICAgZXZlbnQudGFyZ2V0LmNoZWNrZWQgPSBkZWZhdWx0VmFsdWUgPT09IGRhdGEuZXhwb3J0VmFsdWU7CiAgICB9KTsKICAgIGlmICh0aGlzLmVuYWJsZVNjcmlwdGluZyAmJiB0aGlzLmhhc0pTQWN0aW9ucykgewogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInVwZGF0ZWZyb21zYW5kYm94IiwgKGpzRXZlbnQpID0+IHsKICAgICAgICBjb25zdCBhY3Rpb25zID0gewogICAgICAgICAgdmFsdWUoZXZlbnQpIHsKICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmNoZWNrZWQgPSBldmVudC5kZXRhaWwudmFsdWUgIT09ICJPZmYiOwogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWU6IGV2ZW50LnRhcmdldC5jaGVja2VkCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudEZyb21TYW5kYm94KGFjdGlvbnMsIGpzRXZlbnQpOwogICAgICB9KTsKICAgICAgdGhpcy5fc2V0RXZlbnRMaXN0ZW5lcnMoZWxlbWVudCwgbnVsbCwgW1siY2hhbmdlIiwgIlZhbGlkYXRlIl0sIFsiY2hhbmdlIiwgIkFjdGlvbiJdLCBbImZvY3VzIiwgIkZvY3VzIl0sIFsiYmx1ciIsICJCbHVyIl0sIFsibW91c2Vkb3duIiwgIk1vdXNlIERvd24iXSwgWyJtb3VzZWVudGVyIiwgIk1vdXNlIEVudGVyIl0sIFsibW91c2VsZWF2ZSIsICJNb3VzZSBFeGl0Il0sIFsibW91c2V1cCIsICJNb3VzZSBVcCJdXSwgKGV2ZW50KSA9PiBldmVudC50YXJnZXQuY2hlY2tlZCk7CiAgICB9CiAgICB0aGlzLl9zZXRCYWNrZ3JvdW5kQ29sb3IoZWxlbWVudCk7CiAgICB0aGlzLl9zZXREZWZhdWx0UHJvcGVydGllc0Zyb21KUyhlbGVtZW50KTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChlbGVtZW50KTsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBSYWRpb0J1dHRvbldpZGdldEFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBXaWRnZXRBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHBhcmFtZXRlcnMucmVuZGVyRm9ybXMKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJidXR0b25XaWRnZXRBbm5vdGF0aW9uIiwgInJhZGlvQnV0dG9uIik7CiAgICBjb25zdCBzdG9yYWdlID0gdGhpcy5hbm5vdGF0aW9uU3RvcmFnZTsKICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICBjb25zdCBpZCA9IGRhdGEuaWQ7CiAgICBsZXQgdmFsdWUgPSBzdG9yYWdlLmdldFZhbHVlKGlkLCB7CiAgICAgIHZhbHVlOiBkYXRhLmZpZWxkVmFsdWUgPT09IGRhdGEuYnV0dG9uVmFsdWUKICAgIH0pLnZhbHVlOwogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgICAgdmFsdWUgPSB2YWx1ZSAhPT0gZGF0YS5idXR0b25WYWx1ZTsKICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgIHZhbHVlCiAgICAgIH0pOwogICAgfQogICAgaWYgKHZhbHVlKSB7CiAgICAgIGZvciAoY29uc3QgcmFkaW8gb2YgdGhpcy5fZ2V0RWxlbWVudHNCeU5hbWUoZGF0YS5maWVsZE5hbWUsIGlkKSkgewogICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUocmFkaW8uaWQsIHsKICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIEdldEVsZW1lbnRzQnlOYW1lU2V0LmFkZChlbGVtZW50KTsKICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJkYXRhLWVsZW1lbnQtaWQiLCBpZCk7CiAgICBlbGVtZW50LmRpc2FibGVkID0gZGF0YS5yZWFkT25seTsKICAgIHRoaXMuX3NldFJlcXVpcmVkKGVsZW1lbnQsIHRoaXMuZGF0YS5yZXF1aXJlZCk7CiAgICBlbGVtZW50LnR5cGUgPSAicmFkaW8iOwogICAgZWxlbWVudC5uYW1lID0gZGF0YS5maWVsZE5hbWU7CiAgICBpZiAodmFsdWUpIHsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImNoZWNrZWQiLCB0cnVlKTsKICAgIH0KICAgIGVsZW1lbnQudGFiSW5kZXggPSAwOwogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCAoZXZlbnQpID0+IHsKICAgICAgY29uc3QgewogICAgICAgIG5hbWUsCiAgICAgICAgY2hlY2tlZAogICAgICB9ID0gZXZlbnQudGFyZ2V0OwogICAgICBmb3IgKGNvbnN0IHJhZGlvIG9mIHRoaXMuX2dldEVsZW1lbnRzQnlOYW1lKG5hbWUsIGlkKSkgewogICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUocmFkaW8uaWQsIHsKICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICB2YWx1ZTogY2hlY2tlZAogICAgICB9KTsKICAgIH0pOwogICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJyZXNldGZvcm0iLCAoZXZlbnQpID0+IHsKICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gZGF0YS5kZWZhdWx0RmllbGRWYWx1ZTsKICAgICAgZXZlbnQudGFyZ2V0LmNoZWNrZWQgPSBkZWZhdWx0VmFsdWUgIT09IG51bGwgJiYgZGVmYXVsdFZhbHVlICE9PSB2b2lkIDAgJiYgZGVmYXVsdFZhbHVlID09PSBkYXRhLmJ1dHRvblZhbHVlOwogICAgfSk7CiAgICBpZiAodGhpcy5lbmFibGVTY3JpcHRpbmcgJiYgdGhpcy5oYXNKU0FjdGlvbnMpIHsKICAgICAgY29uc3QgcGRmQnV0dG9uVmFsdWUgPSBkYXRhLmJ1dHRvblZhbHVlOwogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInVwZGF0ZWZyb21zYW5kYm94IiwgKGpzRXZlbnQpID0+IHsKICAgICAgICBjb25zdCBhY3Rpb25zID0gewogICAgICAgICAgdmFsdWU6IChldmVudCkgPT4gewogICAgICAgICAgICBjb25zdCBjaGVja2VkID0gcGRmQnV0dG9uVmFsdWUgPT09IGV2ZW50LmRldGFpbC52YWx1ZTsKICAgICAgICAgICAgZm9yIChjb25zdCByYWRpbyBvZiB0aGlzLl9nZXRFbGVtZW50c0J5TmFtZShldmVudC50YXJnZXQubmFtZSkpIHsKICAgICAgICAgICAgICBjb25zdCBjdXJDaGVja2VkID0gY2hlY2tlZCAmJiByYWRpby5pZCA9PT0gaWQ7CiAgICAgICAgICAgICAgaWYgKHJhZGlvLmRvbUVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJhZGlvLmRvbUVsZW1lbnQuY2hlY2tlZCA9IGN1ckNoZWNrZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUocmFkaW8uaWQsIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBjdXJDaGVja2VkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHRoaXMuX2Rpc3BhdGNoRXZlbnRGcm9tU2FuZGJveChhY3Rpb25zLCBqc0V2ZW50KTsKICAgICAgfSk7CiAgICAgIHRoaXMuX3NldEV2ZW50TGlzdGVuZXJzKGVsZW1lbnQsIG51bGwsIFtbImNoYW5nZSIsICJWYWxpZGF0ZSJdLCBbImNoYW5nZSIsICJBY3Rpb24iXSwgWyJmb2N1cyIsICJGb2N1cyJdLCBbImJsdXIiLCAiQmx1ciJdLCBbIm1vdXNlZG93biIsICJNb3VzZSBEb3duIl0sIFsibW91c2VlbnRlciIsICJNb3VzZSBFbnRlciJdLCBbIm1vdXNlbGVhdmUiLCAiTW91c2UgRXhpdCJdLCBbIm1vdXNldXAiLCAiTW91c2UgVXAiXV0sIChldmVudCkgPT4gZXZlbnQudGFyZ2V0LmNoZWNrZWQpOwogICAgfQogICAgdGhpcy5fc2V0QmFja2dyb3VuZENvbG9yKGVsZW1lbnQpOwogICAgdGhpcy5fc2V0RGVmYXVsdFByb3BlcnRpZXNGcm9tSlMoZWxlbWVudCk7CiAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmQoZWxlbWVudCk7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgUHVzaEJ1dHRvbldpZGdldEFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBMaW5rQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaWdub3JlQm9yZGVyOiBwYXJhbWV0ZXJzLmRhdGEuaGFzQXBwZWFyYW5jZQogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IGNvbnRhaW5lcjIgPSBzdXBlci5yZW5kZXIoKTsKICAgIGNvbnRhaW5lcjIuY2xhc3NMaXN0LmFkZCgiYnV0dG9uV2lkZ2V0QW5ub3RhdGlvbiIsICJwdXNoQnV0dG9uIik7CiAgICBjb25zdCBsaW5rRWxlbWVudCA9IGNvbnRhaW5lcjIubGFzdENoaWxkOwogICAgaWYgKHRoaXMuZW5hYmxlU2NyaXB0aW5nICYmIHRoaXMuaGFzSlNBY3Rpb25zICYmIGxpbmtFbGVtZW50KSB7CiAgICAgIHRoaXMuX3NldERlZmF1bHRQcm9wZXJ0aWVzRnJvbUpTKGxpbmtFbGVtZW50KTsKICAgICAgbGlua0VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidXBkYXRlZnJvbXNhbmRib3giLCAoanNFdmVudCkgPT4gewogICAgICAgIHRoaXMuX2Rpc3BhdGNoRXZlbnRGcm9tU2FuZGJveCh7fSwganNFdmVudCk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGNvbnRhaW5lcjI7CiAgfQp9Owp2YXIgQ2hvaWNlV2lkZ2V0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIFdpZGdldEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogcGFyYW1ldGVycy5yZW5kZXJGb3JtcwogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImNob2ljZVdpZGdldEFubm90YXRpb24iKTsKICAgIGNvbnN0IHN0b3JhZ2UgPSB0aGlzLmFubm90YXRpb25TdG9yYWdlOwogICAgY29uc3QgaWQgPSB0aGlzLmRhdGEuaWQ7CiAgICBjb25zdCBzdG9yZWREYXRhID0gc3RvcmFnZS5nZXRWYWx1ZShpZCwgewogICAgICB2YWx1ZTogdGhpcy5kYXRhLmZpZWxkVmFsdWUKICAgIH0pOwogICAgY29uc3Qgc2VsZWN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpOwogICAgR2V0RWxlbWVudHNCeU5hbWVTZXQuYWRkKHNlbGVjdEVsZW1lbnQpOwogICAgc2VsZWN0RWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtZWxlbWVudC1pZCIsIGlkKTsKICAgIHNlbGVjdEVsZW1lbnQuZGlzYWJsZWQgPSB0aGlzLmRhdGEucmVhZE9ubHk7CiAgICB0aGlzLl9zZXRSZXF1aXJlZChzZWxlY3RFbGVtZW50LCB0aGlzLmRhdGEucmVxdWlyZWQpOwogICAgc2VsZWN0RWxlbWVudC5uYW1lID0gdGhpcy5kYXRhLmZpZWxkTmFtZTsKICAgIHNlbGVjdEVsZW1lbnQudGFiSW5kZXggPSAwOwogICAgbGV0IGFkZEFuRW1wdHlFbnRyeSA9IHRoaXMuZGF0YS5jb21ibyAmJiB0aGlzLmRhdGEub3B0aW9ucy5sZW5ndGggPiAwOwogICAgaWYgKCF0aGlzLmRhdGEuY29tYm8pIHsKICAgICAgc2VsZWN0RWxlbWVudC5zaXplID0gdGhpcy5kYXRhLm9wdGlvbnMubGVuZ3RoOwogICAgICBpZiAodGhpcy5kYXRhLm11bHRpU2VsZWN0KSB7CiAgICAgICAgc2VsZWN0RWxlbWVudC5tdWx0aXBsZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHNlbGVjdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicmVzZXRmb3JtIiwgKGV2ZW50KSA9PiB7CiAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IHRoaXMuZGF0YS5kZWZhdWx0RmllbGRWYWx1ZTsKICAgICAgZm9yIChjb25zdCBvcHRpb24gb2Ygc2VsZWN0RWxlbWVudC5vcHRpb25zKSB7CiAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gb3B0aW9uLnZhbHVlID09PSBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgIH0pOwogICAgZm9yIChjb25zdCBvcHRpb24gb2YgdGhpcy5kYXRhLm9wdGlvbnMpIHsKICAgICAgY29uc3Qgb3B0aW9uRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwogICAgICBvcHRpb25FbGVtZW50LnRleHRDb250ZW50ID0gb3B0aW9uLmRpc3BsYXlWYWx1ZTsKICAgICAgb3B0aW9uRWxlbWVudC52YWx1ZSA9IG9wdGlvbi5leHBvcnRWYWx1ZTsKICAgICAgaWYgKHN0b3JlZERhdGEudmFsdWUuaW5jbHVkZXMob3B0aW9uLmV4cG9ydFZhbHVlKSkgewogICAgICAgIG9wdGlvbkVsZW1lbnQuc2V0QXR0cmlidXRlKCJzZWxlY3RlZCIsIHRydWUpOwogICAgICAgIGFkZEFuRW1wdHlFbnRyeSA9IGZhbHNlOwogICAgICB9CiAgICAgIHNlbGVjdEVsZW1lbnQuYXBwZW5kKG9wdGlvbkVsZW1lbnQpOwogICAgfQogICAgbGV0IHJlbW92ZUVtcHR5RW50cnkgPSBudWxsOwogICAgaWYgKGFkZEFuRW1wdHlFbnRyeSkgewogICAgICBjb25zdCBub25lT3B0aW9uRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwogICAgICBub25lT3B0aW9uRWxlbWVudC52YWx1ZSA9ICIgIjsKICAgICAgbm9uZU9wdGlvbkVsZW1lbnQuc2V0QXR0cmlidXRlKCJoaWRkZW4iLCB0cnVlKTsKICAgICAgbm9uZU9wdGlvbkVsZW1lbnQuc2V0QXR0cmlidXRlKCJzZWxlY3RlZCIsIHRydWUpOwogICAgICBzZWxlY3RFbGVtZW50LnByZXBlbmQobm9uZU9wdGlvbkVsZW1lbnQpOwogICAgICByZW1vdmVFbXB0eUVudHJ5ID0gKCkgPT4gewogICAgICAgIG5vbmVPcHRpb25FbGVtZW50LnJlbW92ZSgpOwogICAgICAgIHNlbGVjdEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCByZW1vdmVFbXB0eUVudHJ5KTsKICAgICAgICByZW1vdmVFbXB0eUVudHJ5ID0gbnVsbDsKICAgICAgfTsKICAgICAgc2VsZWN0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsIHJlbW92ZUVtcHR5RW50cnkpOwogICAgfQogICAgY29uc3QgZ2V0VmFsdWUgPSAoaXNFeHBvcnQpID0+IHsKICAgICAgY29uc3QgbmFtZSA9IGlzRXhwb3J0ID8gInZhbHVlIiA6ICJ0ZXh0Q29udGVudCI7CiAgICAgIGNvbnN0IHsKICAgICAgICBvcHRpb25zLAogICAgICAgIG11bHRpcGxlCiAgICAgIH0gPSBzZWxlY3RFbGVtZW50OwogICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgcmV0dXJuIG9wdGlvbnMuc2VsZWN0ZWRJbmRleCA9PT0gLTEgPyBudWxsIDogb3B0aW9uc1tvcHRpb25zLnNlbGVjdGVkSW5kZXhdW25hbWVdOwogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwob3B0aW9ucywgKG9wdGlvbikgPT4gb3B0aW9uLnNlbGVjdGVkKS5tYXAoKG9wdGlvbikgPT4gb3B0aW9uW25hbWVdKTsKICAgIH07CiAgICBsZXQgc2VsZWN0ZWRWYWx1ZXMgPSBnZXRWYWx1ZShmYWxzZSk7CiAgICBjb25zdCBnZXRJdGVtcyA9IChldmVudCkgPT4gewogICAgICBjb25zdCBvcHRpb25zID0gZXZlbnQudGFyZ2V0Lm9wdGlvbnM7CiAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUubWFwLmNhbGwob3B0aW9ucywgKG9wdGlvbikgPT4gKHsKICAgICAgICBkaXNwbGF5VmFsdWU6IG9wdGlvbi50ZXh0Q29udGVudCwKICAgICAgICBleHBvcnRWYWx1ZTogb3B0aW9uLnZhbHVlCiAgICAgIH0pKTsKICAgIH07CiAgICBpZiAodGhpcy5lbmFibGVTY3JpcHRpbmcgJiYgdGhpcy5oYXNKU0FjdGlvbnMpIHsKICAgICAgc2VsZWN0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJ1cGRhdGVmcm9tc2FuZGJveCIsIChqc0V2ZW50KSA9PiB7CiAgICAgICAgY29uc3QgYWN0aW9ucyA9IHsKICAgICAgICAgIHZhbHVlKGV2ZW50KSB7CiAgICAgICAgICAgIHJlbW92ZUVtcHR5RW50cnk/LigpOwogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGV2ZW50LmRldGFpbC52YWx1ZTsKICAgICAgICAgICAgY29uc3QgdmFsdWVzID0gbmV3IFNldChBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogW3ZhbHVlXSk7CiAgICAgICAgICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIHNlbGVjdEVsZW1lbnQub3B0aW9ucykgewogICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHZhbHVlcy5oYXMob3B0aW9uLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWU6IGdldFZhbHVlKHRydWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxlY3RlZFZhbHVlcyA9IGdldFZhbHVlKGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBtdWx0aXBsZVNlbGVjdGlvbihldmVudCkgewogICAgICAgICAgICBzZWxlY3RFbGVtZW50Lm11bHRpcGxlID0gdHJ1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICByZW1vdmUoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHNlbGVjdEVsZW1lbnQub3B0aW9uczsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSBldmVudC5kZXRhaWwucmVtb3ZlOwogICAgICAgICAgICBvcHRpb25zW2luZGV4XS5zZWxlY3RlZCA9IGZhbHNlOwogICAgICAgICAgICBzZWxlY3RFbGVtZW50LnJlbW92ZShpbmRleCk7CiAgICAgICAgICAgIGlmIChvcHRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBjb25zdCBpID0gQXJyYXkucHJvdG90eXBlLmZpbmRJbmRleC5jYWxsKG9wdGlvbnMsIChvcHRpb24pID0+IG9wdGlvbi5zZWxlY3RlZCk7CiAgICAgICAgICAgICAgaWYgKGkgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zWzBdLnNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RvcmFnZS5zZXRWYWx1ZShpZCwgewogICAgICAgICAgICAgIHZhbHVlOiBnZXRWYWx1ZSh0cnVlKSwKICAgICAgICAgICAgICBpdGVtczogZ2V0SXRlbXMoZXZlbnQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxlY3RlZFZhbHVlcyA9IGdldFZhbHVlKGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBjbGVhcihldmVudCkgewogICAgICAgICAgICB3aGlsZSAoc2VsZWN0RWxlbWVudC5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnJlbW92ZSgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWU6IG51bGwsCiAgICAgICAgICAgICAgaXRlbXM6IFtdCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxlY3RlZFZhbHVlcyA9IGdldFZhbHVlKGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBpbnNlcnQoZXZlbnQpIHsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGluZGV4LAogICAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSwKICAgICAgICAgICAgICBleHBvcnRWYWx1ZQogICAgICAgICAgICB9ID0gZXZlbnQuZGV0YWlsLmluc2VydDsKICAgICAgICAgICAgY29uc3Qgc2VsZWN0Q2hpbGQgPSBzZWxlY3RFbGVtZW50LmNoaWxkcmVuW2luZGV4XTsKICAgICAgICAgICAgY29uc3Qgb3B0aW9uRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9wdGlvbiIpOwogICAgICAgICAgICBvcHRpb25FbGVtZW50LnRleHRDb250ZW50ID0gZGlzcGxheVZhbHVlOwogICAgICAgICAgICBvcHRpb25FbGVtZW50LnZhbHVlID0gZXhwb3J0VmFsdWU7CiAgICAgICAgICAgIGlmIChzZWxlY3RDaGlsZCkgewogICAgICAgICAgICAgIHNlbGVjdENoaWxkLmJlZm9yZShvcHRpb25FbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChvcHRpb25FbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWU6IGdldFZhbHVlKHRydWUpLAogICAgICAgICAgICAgIGl0ZW1zOiBnZXRJdGVtcyhldmVudCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGVjdGVkVmFsdWVzID0gZ2V0VmFsdWUoZmFsc2UpOwogICAgICAgICAgfSwKICAgICAgICAgIGl0ZW1zKGV2ZW50KSB7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICBpdGVtcwogICAgICAgICAgICB9ID0gZXZlbnQuZGV0YWlsOwogICAgICAgICAgICB3aGlsZSAoc2VsZWN0RWxlbWVudC5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnJlbW92ZSgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpIHsKICAgICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAgICBkaXNwbGF5VmFsdWUsCiAgICAgICAgICAgICAgICBleHBvcnRWYWx1ZQogICAgICAgICAgICAgIH0gPSBpdGVtOwogICAgICAgICAgICAgIGNvbnN0IG9wdGlvbkVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKICAgICAgICAgICAgICBvcHRpb25FbGVtZW50LnRleHRDb250ZW50ID0gZGlzcGxheVZhbHVlOwogICAgICAgICAgICAgIG9wdGlvbkVsZW1lbnQudmFsdWUgPSBleHBvcnRWYWx1ZTsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChvcHRpb25FbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2VsZWN0RWxlbWVudC5vcHRpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50Lm9wdGlvbnNbMF0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgICAgICB2YWx1ZTogZ2V0VmFsdWUodHJ1ZSksCiAgICAgICAgICAgICAgaXRlbXM6IGdldEl0ZW1zKGV2ZW50KQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2VsZWN0ZWRWYWx1ZXMgPSBnZXRWYWx1ZShmYWxzZSk7CiAgICAgICAgICB9LAogICAgICAgICAgaW5kaWNlcyhldmVudCkgewogICAgICAgICAgICBjb25zdCBpbmRpY2VzID0gbmV3IFNldChldmVudC5kZXRhaWwuaW5kaWNlcyk7CiAgICAgICAgICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIGV2ZW50LnRhcmdldC5vcHRpb25zKSB7CiAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gaW5kaWNlcy5oYXMob3B0aW9uLmluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdG9yYWdlLnNldFZhbHVlKGlkLCB7CiAgICAgICAgICAgICAgdmFsdWU6IGdldFZhbHVlKHRydWUpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxlY3RlZFZhbHVlcyA9IGdldFZhbHVlKGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBlZGl0YWJsZShldmVudCkgewogICAgICAgICAgICBldmVudC50YXJnZXQuZGlzYWJsZWQgPSAhZXZlbnQuZGV0YWlsLmVkaXRhYmxlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5fZGlzcGF0Y2hFdmVudEZyb21TYW5kYm94KGFjdGlvbnMsIGpzRXZlbnQpOwogICAgICB9KTsKICAgICAgc2VsZWN0RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJpbnB1dCIsIChldmVudCkgPT4gewogICAgICAgIGNvbnN0IGV4cG9ydFZhbHVlID0gZ2V0VmFsdWUodHJ1ZSk7CiAgICAgICAgY29uc3QgY2hhbmdlID0gZ2V0VmFsdWUoZmFsc2UpOwogICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgIHZhbHVlOiBleHBvcnRWYWx1ZQogICAgICAgIH0pOwogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goImRpc3BhdGNoZXZlbnRpbnNhbmRib3giLCB7CiAgICAgICAgICBzb3VyY2U6IHRoaXMsCiAgICAgICAgICBkZXRhaWw6IHsKICAgICAgICAgICAgaWQsCiAgICAgICAgICAgIG5hbWU6ICJLZXlzdHJva2UiLAogICAgICAgICAgICB2YWx1ZTogc2VsZWN0ZWRWYWx1ZXMsCiAgICAgICAgICAgIGNoYW5nZSwKICAgICAgICAgICAgY2hhbmdlRXg6IGV4cG9ydFZhbHVlLAogICAgICAgICAgICB3aWxsQ29tbWl0OiBmYWxzZSwKICAgICAgICAgICAgY29tbWl0S2V5OiAxLAogICAgICAgICAgICBrZXlEb3duOiBmYWxzZQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdGhpcy5fc2V0RXZlbnRMaXN0ZW5lcnMoc2VsZWN0RWxlbWVudCwgbnVsbCwgW1siZm9jdXMiLCAiRm9jdXMiXSwgWyJibHVyIiwgIkJsdXIiXSwgWyJtb3VzZWRvd24iLCAiTW91c2UgRG93biJdLCBbIm1vdXNlZW50ZXIiLCAiTW91c2UgRW50ZXIiXSwgWyJtb3VzZWxlYXZlIiwgIk1vdXNlIEV4aXQiXSwgWyJtb3VzZXVwIiwgIk1vdXNlIFVwIl0sIFsiaW5wdXQiLCAiQWN0aW9uIl0sIFsiaW5wdXQiLCAiVmFsaWRhdGUiXV0sIChldmVudCkgPT4gZXZlbnQudGFyZ2V0LnZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHNlbGVjdEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIHN0b3JhZ2Uuc2V0VmFsdWUoaWQsIHsKICAgICAgICAgIHZhbHVlOiBnZXRWYWx1ZSh0cnVlKQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICAgIGlmICh0aGlzLmRhdGEuY29tYm8pIHsKICAgICAgdGhpcy5fc2V0VGV4dFN0eWxlKHNlbGVjdEVsZW1lbnQpOwogICAgfSBlbHNlIHsKICAgIH0KICAgIHRoaXMuX3NldEJhY2tncm91bmRDb2xvcihzZWxlY3RFbGVtZW50KTsKICAgIHRoaXMuX3NldERlZmF1bHRQcm9wZXJ0aWVzRnJvbUpTKHNlbGVjdEVsZW1lbnQpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHNlbGVjdEVsZW1lbnQpOwogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIFBvcHVwQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIGVsZW1lbnRzLAogICAgICBwYXJlbnQKICAgIH0gPSBwYXJhbWV0ZXJzOwogICAgY29uc3QgaGFzQ29tbWVudE1hbmFnZXIgPSAhIXBhcmVudC5fY29tbWVudE1hbmFnZXI7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogIWhhc0NvbW1lbnRNYW5hZ2VyICYmIEFubm90YXRpb25FbGVtZW50Ll9oYXNQb3B1cERhdGEoZGF0YSkKICAgIH0pOwogICAgdGhpcy5lbGVtZW50cyA9IGVsZW1lbnRzOwogICAgaWYgKGhhc0NvbW1lbnRNYW5hZ2VyICYmIEFubm90YXRpb25FbGVtZW50Ll9oYXNQb3B1cERhdGEoZGF0YSkpIHsKICAgICAgY29uc3QgcG9wdXAgPSB0aGlzLnBvcHVwID0gdGhpcy4jY3JlYXRlUG9wdXAoKTsKICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7CiAgICAgICAgZWxlbWVudC5wb3B1cCA9IHBvcHVwOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLnBvcHVwID0gbnVsbDsKICAgIH0KICB9CiAgI2NyZWF0ZVBvcHVwKCkgewogICAgcmV0dXJuIG5ldyBQb3B1cEVsZW1lbnQoewogICAgICBjb250YWluZXI6IHRoaXMuY29udGFpbmVyLAogICAgICBjb2xvcjogdGhpcy5kYXRhLmNvbG9yLAogICAgICB0aXRsZU9iajogdGhpcy5kYXRhLnRpdGxlT2JqLAogICAgICBtb2RpZmljYXRpb25EYXRlOiB0aGlzLmRhdGEubW9kaWZpY2F0aW9uRGF0ZSB8fCB0aGlzLmRhdGEuY3JlYXRpb25EYXRlLAogICAgICBjb250ZW50c09iajogdGhpcy5kYXRhLmNvbnRlbnRzT2JqLAogICAgICByaWNoVGV4dDogdGhpcy5kYXRhLnJpY2hUZXh0LAogICAgICByZWN0OiB0aGlzLmRhdGEucmVjdCwKICAgICAgcGFyZW50UmVjdDogdGhpcy5kYXRhLnBhcmVudFJlY3QgfHwgbnVsbCwKICAgICAgcGFyZW50OiB0aGlzLnBhcmVudCwKICAgICAgZWxlbWVudHM6IHRoaXMuZWxlbWVudHMsCiAgICAgIG9wZW46IHRoaXMuZGF0YS5vcGVuLAogICAgICBjb21tZW50TWFuYWdlcjogdGhpcy5wYXJlbnQuX2NvbW1lbnRNYW5hZ2VyCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3QgewogICAgICBjb250YWluZXI6IGNvbnRhaW5lcjIKICAgIH0gPSB0aGlzOwogICAgY29udGFpbmVyMi5jbGFzc0xpc3QuYWRkKCJwb3B1cEFubm90YXRpb24iKTsKICAgIGNvbnRhaW5lcjIucm9sZSA9ICJjb21tZW50IjsKICAgIGNvbnN0IHBvcHVwID0gdGhpcy5wb3B1cCA9IHRoaXMuI2NyZWF0ZVBvcHVwKCk7CiAgICBjb25zdCBlbGVtZW50SWRzID0gW107CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdGhpcy5lbGVtZW50cykgewogICAgICBlbGVtZW50LnBvcHVwID0gcG9wdXA7CiAgICAgIGVsZW1lbnQuY29udGFpbmVyLmFyaWFIYXNQb3B1cCA9ICJkaWFsb2ciOwogICAgICBlbGVtZW50SWRzLnB1c2goZWxlbWVudC5kYXRhLmlkKTsKICAgICAgZWxlbWVudC5hZGRIaWdobGlnaHRBcmVhKCk7CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoImFyaWEtY29udHJvbHMiLCBlbGVtZW50SWRzLm1hcCgoaWQpID0+IGAke0Fubm90YXRpb25QcmVmaXh9JHtpZH1gKS5qb2luKCIsIikpOwogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIFBvcHVwRWxlbWVudCA9IGNsYXNzIHsKICAjY29tbWVudE1hbmFnZXIgPSBudWxsOwogICNib3VuZEtleURvd24gPSB0aGlzLiNrZXlEb3duLmJpbmQodGhpcyk7CiAgI2JvdW5kSGlkZSA9IHRoaXMuI2hpZGUuYmluZCh0aGlzKTsKICAjYm91bmRTaG93ID0gdGhpcy4jc2hvdy5iaW5kKHRoaXMpOwogICNib3VuZFRvZ2dsZSA9IHRoaXMuI3RvZ2dsZS5iaW5kKHRoaXMpOwogICNjb2xvciA9IG51bGw7CiAgI2NvbnRhaW5lciA9IG51bGw7CiAgI2NvbnRlbnRzT2JqID0gbnVsbDsKICAjZGF0ZU9iaiA9IG51bGw7CiAgI2VsZW1lbnRzID0gbnVsbDsKICAjcGFyZW50ID0gbnVsbDsKICAjcGFyZW50UmVjdCA9IG51bGw7CiAgI3Bpbm5lZCA9IGZhbHNlOwogICNwb3B1cCA9IG51bGw7CiAgI3BvcHVwQWJvcnRDb250cm9sbGVyID0gbnVsbDsKICAjcG9zaXRpb24gPSBudWxsOwogICNjb21tZW50QnV0dG9uID0gbnVsbDsKICAjY29tbWVudEJ1dHRvblBvc2l0aW9uID0gbnVsbDsKICAjcG9wdXBQb3NpdGlvbiA9IG51bGw7CiAgI3JlY3QgPSBudWxsOwogICNyaWNoVGV4dCA9IG51bGw7CiAgI3RpdGxlT2JqID0gbnVsbDsKICAjdXBkYXRlcyA9IG51bGw7CiAgI3dhc1Zpc2libGUgPSBmYWxzZTsKICAjZmlyc3RFbGVtZW50ID0gbnVsbDsKICAjY29tbWVudFRleHQgPSBudWxsOwogIGNvbnN0cnVjdG9yKHsKICAgIGNvbnRhaW5lcjogY29udGFpbmVyMiwKICAgIGNvbG9yLAogICAgZWxlbWVudHMsCiAgICB0aXRsZU9iaiwKICAgIG1vZGlmaWNhdGlvbkRhdGUsCiAgICBjb250ZW50c09iaiwKICAgIHJpY2hUZXh0LAogICAgcGFyZW50LAogICAgcmVjdCwKICAgIHBhcmVudFJlY3QsCiAgICBvcGVuLAogICAgY29tbWVudE1hbmFnZXIgPSBudWxsCiAgfSkgewogICAgdGhpcy4jY29udGFpbmVyID0gY29udGFpbmVyMjsKICAgIHRoaXMuI3RpdGxlT2JqID0gdGl0bGVPYmo7CiAgICB0aGlzLiNjb250ZW50c09iaiA9IGNvbnRlbnRzT2JqOwogICAgdGhpcy4jcmljaFRleHQgPSByaWNoVGV4dDsKICAgIHRoaXMuI3BhcmVudCA9IHBhcmVudDsKICAgIHRoaXMuI2NvbG9yID0gY29sb3I7CiAgICB0aGlzLiNyZWN0ID0gcmVjdDsKICAgIHRoaXMuI3BhcmVudFJlY3QgPSBwYXJlbnRSZWN0OwogICAgdGhpcy4jZWxlbWVudHMgPSBlbGVtZW50czsKICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyID0gY29tbWVudE1hbmFnZXI7CiAgICB0aGlzLiNmaXJzdEVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgIHRoaXMuI2RhdGVPYmogPSBQREZEYXRlU3RyaW5nLnRvRGF0ZU9iamVjdChtb2RpZmljYXRpb25EYXRlKTsKICAgIHRoaXMudHJpZ2dlciA9IGVsZW1lbnRzLmZsYXRNYXAoKGUpID0+IGUuZ2V0RWxlbWVudHNUb1RyaWdnZXJQb3B1cCgpKTsKICAgIGlmICghY29tbWVudE1hbmFnZXIpIHsKICAgICAgdGhpcy4jYWRkRXZlbnRMaXN0ZW5lcnMoKTsKICAgICAgdGhpcy4jY29udGFpbmVyLmhpZGRlbiA9IHRydWU7CiAgICAgIGlmIChvcGVuKSB7CiAgICAgICAgdGhpcy4jdG9nZ2xlKCk7CiAgICAgIH0KICAgIH0KICB9CiAgI2FkZEV2ZW50TGlzdGVuZXJzKCkgewogICAgaWYgKHRoaXMuI3BvcHVwQWJvcnRDb250cm9sbGVyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3BvcHVwQWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3QgewogICAgICBzaWduYWwKICAgIH0gPSB0aGlzLiNwb3B1cEFib3J0Q29udHJvbGxlcjsKICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLnRyaWdnZXIpIHsKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuI2JvdW5kVG9nZ2xlLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJlbnRlciIsIHRoaXMuI2JvdW5kU2hvdywgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybGVhdmUiLCB0aGlzLiNib3VuZEhpZGUsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgicG9wdXBUcmlnZ2VyQXJlYSIpOwogICAgfQogICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMuI2VsZW1lbnRzKSB7CiAgICAgIGVsZW1lbnQuY29udGFpbmVyPy5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy4jYm91bmRLZXlEb3duLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgfQogIH0KICAjc2V0Q29tbWVudEJ1dHRvblBvc2l0aW9uKCkgewogICAgY29uc3QgZWxlbWVudCA9IHRoaXMuI2VsZW1lbnRzLmZpbmQoKGUpID0+IGUuaGFzQ29tbWVudEJ1dHRvbik7CiAgICBpZiAoIWVsZW1lbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29tbWVudEJ1dHRvblBvc2l0aW9uID0gZWxlbWVudC5fbm9ybWFsaXplUG9pbnQoZWxlbWVudC5jb21tZW50QnV0dG9uUG9zaXRpb24pOwogIH0KICByZW5kZXJDb21tZW50QnV0dG9uKCkgewogICAgaWYgKHRoaXMuI2NvbW1lbnRCdXR0b24pIHsKICAgICAgaWYgKCF0aGlzLiNjb21tZW50QnV0dG9uLnBhcmVudE5vZGUpIHsKICAgICAgICB0aGlzLiNmaXJzdEVsZW1lbnQuY29udGFpbmVyLmFmdGVyKHRoaXMuI2NvbW1lbnRCdXR0b24pOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy4jY29tbWVudEJ1dHRvblBvc2l0aW9uKSB7CiAgICAgIHRoaXMuI3NldENvbW1lbnRCdXR0b25Qb3NpdGlvbigpOwogICAgfQogICAgaWYgKCF0aGlzLiNjb21tZW50QnV0dG9uUG9zaXRpb24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBzaWduYWwKICAgIH0gPSB0aGlzLiNwb3B1cEFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IGhhc093bkJ1dHRvbiA9IHRoaXMuI2ZpcnN0RWxlbWVudC5oYXNPd25Db21tZW50QnV0dG9uOwogICAgY29uc3QgdG9nZ2xlUG9wdXAgPSAoKSA9PiB7CiAgICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyLnRvZ2dsZUNvbW1lbnRQb3B1cCh0aGlzLCB0cnVlLCB2b2lkIDAsICFoYXNPd25CdXR0b24pOwogICAgfTsKICAgIGNvbnN0IHNob3dQb3B1cCA9ICgpID0+IHsKICAgICAgdGhpcy4jY29tbWVudE1hbmFnZXIudG9nZ2xlQ29tbWVudFBvcHVwKHRoaXMsIGZhbHNlLCB0cnVlLCAhaGFzT3duQnV0dG9uKTsKICAgIH07CiAgICBjb25zdCBoaWRlUG9wdXAgPSAoKSA9PiB7CiAgICAgIHRoaXMuI2NvbW1lbnRNYW5hZ2VyLnRvZ2dsZUNvbW1lbnRQb3B1cCh0aGlzLCBmYWxzZSwgZmFsc2UpOwogICAgfTsKICAgIGlmICghaGFzT3duQnV0dG9uKSB7CiAgICAgIGNvbnN0IGJ1dHRvbiA9IHRoaXMuI2NvbW1lbnRCdXR0b24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJidXR0b24iKTsKICAgICAgYnV0dG9uLmNsYXNzTmFtZSA9ICJhbm5vdGF0aW9uQ29tbWVudEJ1dHRvbiI7CiAgICAgIGNvbnN0IHBhcmVudENvbnRhaW5lciA9IHRoaXMuI2ZpcnN0RWxlbWVudC5jb250YWluZXI7CiAgICAgIGJ1dHRvbi5zdHlsZS56SW5kZXggPSBwYXJlbnRDb250YWluZXIuc3R5bGUuekluZGV4ICsgMTsKICAgICAgYnV0dG9uLnRhYkluZGV4ID0gMDsKICAgICAgYnV0dG9uLmFyaWFIYXNQb3B1cCA9ICJkaWFsb2ciOwogICAgICBidXR0b24uYXJpYUNvbnRyb2xzID0gImNvbW1lbnRQb3B1cCI7CiAgICAgIGJ1dHRvbi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1zaG93LWNvbW1lbnQtYnV0dG9uIik7CiAgICAgIHRoaXMuI3VwZGF0ZUNvbG9yKCk7CiAgICAgIHRoaXMuI3VwZGF0ZUNvbW1lbnRCdXR0b25Qb3NpdGlvbigpOwogICAgICBidXR0b24uYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIHRoaXMuI2JvdW5kS2V5RG93biwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgICAgYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdG9nZ2xlUG9wdXAsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZW50ZXIiLCBzaG93UG9wdXAsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybGVhdmUiLCBoaWRlUG9wdXAsIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIHBhcmVudENvbnRhaW5lci5hZnRlcihidXR0b24pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jY29tbWVudEJ1dHRvbiA9IHRoaXMuI2ZpcnN0RWxlbWVudC5jb250YWluZXI7CiAgICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiB0aGlzLnRyaWdnZXIpIHsKICAgICAgICBlbGVtZW50LmFyaWFIYXNQb3B1cCA9ICJkaWFsb2ciOwogICAgICAgIGVsZW1lbnQuYXJpYUNvbnRyb2xzID0gImNvbW1lbnRQb3B1cCI7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy4jYm91bmRLZXlEb3duLCB7CiAgICAgICAgICBzaWduYWwKICAgICAgICB9KTsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdG9nZ2xlUG9wdXAsIHsKICAgICAgICAgIHNpZ25hbAogICAgICAgIH0pOwogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmVudGVyIiwgc2hvd1BvcHVwLCB7CiAgICAgICAgICBzaWduYWwKICAgICAgICB9KTsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJsZWF2ZSIsIGhpZGVQb3B1cCwgewogICAgICAgICAgc2lnbmFsCiAgICAgICAgfSk7CiAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKCJwb3B1cFRyaWdnZXJBcmVhIik7CiAgICAgIH0KICAgIH0KICB9CiAgI3VwZGF0ZUNvbW1lbnRCdXR0b25Qb3NpdGlvbigpIHsKICAgIGlmICh0aGlzLiNmaXJzdEVsZW1lbnQuZXh0cmFQb3B1cEVsZW1lbnQgJiYgIXRoaXMuI2ZpcnN0RWxlbWVudC5lZGl0b3IpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLiNjb21tZW50QnV0dG9uKSB7CiAgICAgIHRoaXMucmVuZGVyQ29tbWVudEJ1dHRvbigpOwogICAgfQogICAgY29uc3QgW3gsIHldID0gdGhpcy4jY29tbWVudEJ1dHRvblBvc2l0aW9uOwogICAgY29uc3QgewogICAgICBzdHlsZQogICAgfSA9IHRoaXMuI2NvbW1lbnRCdXR0b247CiAgICBzdHlsZS5sZWZ0ID0gYGNhbGMoJHt4fSUpYDsKICAgIHN0eWxlLnRvcCA9IGBjYWxjKCR7eX0lIC0gdmFyKC0tY29tbWVudC1idXR0b24tZGltKSlgOwogIH0KICAjdXBkYXRlQ29sb3IoKSB7CiAgICBpZiAodGhpcy4jZmlyc3RFbGVtZW50LmV4dHJhUG9wdXBFbGVtZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy4jY29tbWVudEJ1dHRvbikgewogICAgICB0aGlzLnJlbmRlckNvbW1lbnRCdXR0b24oKTsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnRCdXR0b24uc3R5bGUuYmFja2dyb3VuZENvbG9yID0gdGhpcy5jb21tZW50QnV0dG9uQ29sb3IgfHwgIiI7CiAgfQogIGdldCBjb21tZW50QnV0dG9uQ29sb3IoKSB7CiAgICBjb25zdCB7CiAgICAgIGNvbG9yLAogICAgICBvcGFjaXR5CiAgICB9ID0gdGhpcy4jZmlyc3RFbGVtZW50LmNvbW1lbnREYXRhOwogICAgaWYgKCFjb2xvcikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiB0aGlzLiNwYXJlbnQuX2NvbW1lbnRNYW5hZ2VyLm1ha2VDb21tZW50Q29sb3IoY29sb3IsIG9wYWNpdHkpOwogIH0KICBmb2N1c0NvbW1lbnRCdXR0b24oKSB7CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGhpcy4jY29tbWVudEJ1dHRvbj8uZm9jdXMoKTsKICAgIH0sIDApOwogIH0KICBnZXREYXRhKCkgewogICAgY29uc3QgewogICAgICByaWNoVGV4dCwKICAgICAgY29sb3IsCiAgICAgIG9wYWNpdHksCiAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgfSA9IHRoaXMuI2ZpcnN0RWxlbWVudC5jb21tZW50RGF0YTsKICAgIHJldHVybiB7CiAgICAgIGNvbnRlbnRzT2JqOiB7CiAgICAgICAgc3RyOiB0aGlzLmNvbW1lbnQKICAgICAgfSwKICAgICAgcmljaFRleHQsCiAgICAgIGNvbG9yLAogICAgICBvcGFjaXR5LAogICAgICBjcmVhdGlvbkRhdGUsCiAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgIH07CiAgfQogIGdldCBlbGVtZW50QmVmb3JlUG9wdXAoKSB7CiAgICByZXR1cm4gdGhpcy4jY29tbWVudEJ1dHRvbjsKICB9CiAgZ2V0IGNvbW1lbnQoKSB7CiAgICB0aGlzLiNjb21tZW50VGV4dCB8fD0gdGhpcy4jZmlyc3RFbGVtZW50LmNvbW1lbnRUZXh0OwogICAgcmV0dXJuIHRoaXMuI2NvbW1lbnRUZXh0OwogIH0KICBzZXQgY29tbWVudCh0ZXh0KSB7CiAgICBpZiAodGV4dCA9PT0gdGhpcy5jb21tZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2ZpcnN0RWxlbWVudC5jb21tZW50VGV4dCA9IHRoaXMuI2NvbW1lbnRUZXh0ID0gdGV4dDsKICB9CiAgZm9jdXMoKSB7CiAgICB0aGlzLiNmaXJzdEVsZW1lbnQuY29udGFpbmVyPy5mb2N1cygpOwogIH0KICBnZXQgcGFyZW50Qm91bmRpbmdDbGllbnRSZWN0KCkgewogICAgcmV0dXJuIHRoaXMuI2ZpcnN0RWxlbWVudC5sYXllci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB9CiAgc2V0Q29tbWVudEJ1dHRvblN0YXRlcyh7CiAgICBzZWxlY3RlZCwKICAgIGhhc1BvcHVwCiAgfSkgewogICAgaWYgKCF0aGlzLiNjb21tZW50QnV0dG9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NvbW1lbnRCdXR0b24uY2xhc3NMaXN0LnRvZ2dsZSgic2VsZWN0ZWQiLCBzZWxlY3RlZCk7CiAgICB0aGlzLiNjb21tZW50QnV0dG9uLmFyaWFFeHBhbmRlZCA9IGhhc1BvcHVwOwogIH0KICBzZXRTZWxlY3RlZENvbW1lbnRCdXR0b24oc2VsZWN0ZWQpIHsKICAgIHRoaXMuI2NvbW1lbnRCdXR0b24uY2xhc3NMaXN0LnRvZ2dsZSgic2VsZWN0ZWQiLCBzZWxlY3RlZCk7CiAgfQogIGdldCBjb21tZW50UG9wdXBQb3NpdGlvbigpIHsKICAgIGlmICh0aGlzLiNwb3B1cFBvc2l0aW9uKSB7CiAgICAgIHJldHVybiB0aGlzLiNwb3B1cFBvc2l0aW9uOwogICAgfQogICAgY29uc3QgewogICAgICB4LAogICAgICB5LAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzLiNjb21tZW50QnV0dG9uLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgY29uc3QgewogICAgICB4OiBwYXJlbnRYLAogICAgICB5OiBwYXJlbnRZLAogICAgICB3aWR0aDogcGFyZW50V2lkdGgsCiAgICAgIGhlaWdodDogcGFyZW50SGVpZ2h0CiAgICB9ID0gdGhpcy4jZmlyc3RFbGVtZW50LmxheWVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgcmV0dXJuIFsoeCAtIHBhcmVudFgpIC8gcGFyZW50V2lkdGgsICh5ICsgaGVpZ2h0IC0gcGFyZW50WSkgLyBwYXJlbnRIZWlnaHRdOwogIH0KICBzZXQgY29tbWVudFBvcHVwUG9zaXRpb24ocG9zKSB7CiAgICB0aGlzLiNwb3B1cFBvc2l0aW9uID0gcG9zOwogIH0KICBoYXNEZWZhdWx0UG9wdXBQb3NpdGlvbigpIHsKICAgIHJldHVybiB0aGlzLiNwb3B1cFBvc2l0aW9uID09PSBudWxsOwogIH0KICBnZXQgY29tbWVudEJ1dHRvblBvc2l0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuI2NvbW1lbnRCdXR0b25Qb3NpdGlvbjsKICB9CiAgZ2V0IGNvbW1lbnRCdXR0b25XaWR0aCgpIHsKICAgIHJldHVybiB0aGlzLiNjb21tZW50QnV0dG9uLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoIC8gdGhpcy5wYXJlbnRCb3VuZGluZ0NsaWVudFJlY3Qud2lkdGg7CiAgfQogIGVkaXRDb21tZW50KG9wdGlvbnMpIHsKICAgIGNvbnN0IFtwb3NYLCBwb3NZXSA9IHRoaXMuI3BvcHVwUG9zaXRpb24gfHwgdGhpcy5jb21tZW50QnV0dG9uUG9zaXRpb24ubWFwKCh4KSA9PiB4IC8gMTAwKTsKICAgIGNvbnN0IHBhcmVudERpbWVuc2lvbnMgPSB0aGlzLnBhcmVudEJvdW5kaW5nQ2xpZW50UmVjdDsKICAgIGNvbnN0IHsKICAgICAgeDogcGFyZW50WCwKICAgICAgeTogcGFyZW50WSwKICAgICAgd2lkdGg6IHBhcmVudFdpZHRoLAogICAgICBoZWlnaHQ6IHBhcmVudEhlaWdodAogICAgfSA9IHBhcmVudERpbWVuc2lvbnM7CiAgICB0aGlzLiNjb21tZW50TWFuYWdlci5zaG93RGlhbG9nKG51bGwsIHRoaXMsIHBhcmVudFggKyBwb3NYICogcGFyZW50V2lkdGgsIHBhcmVudFkgKyBwb3NZICogcGFyZW50SGVpZ2h0LCB7CiAgICAgIC4uLm9wdGlvbnMsCiAgICAgIHBhcmVudERpbWVuc2lvbnMKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICBpZiAodGhpcy4jcG9wdXApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcG9wdXAgPSB0aGlzLiNwb3B1cCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgcG9wdXAuY2xhc3NOYW1lID0gInBvcHVwIjsKICAgIGlmICh0aGlzLiNjb2xvcikgewogICAgICBjb25zdCBiYXNlQ29sb3IgPSBwb3B1cC5zdHlsZS5vdXRsaW5lQ29sb3IgPSBVdGlsLm1ha2VIZXhDb2xvciguLi50aGlzLiNjb2xvcik7CiAgICAgIHBvcHVwLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGBjb2xvci1taXgoaW4gc3JnYiwgJHtiYXNlQ29sb3J9IDMwJSwgd2hpdGUpYDsKICAgIH0KICAgIGNvbnN0IGhlYWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgIGhlYWRlci5jbGFzc05hbWUgPSAiaGVhZGVyIjsKICAgIGlmICh0aGlzLiN0aXRsZU9iaj8uc3RyKSB7CiAgICAgIGNvbnN0IHRpdGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICB0aXRsZS5jbGFzc05hbWUgPSAidGl0bGUiOwogICAgICBoZWFkZXIuYXBwZW5kKHRpdGxlKTsKICAgICAgKHsKICAgICAgICBkaXI6IHRpdGxlLmRpciwKICAgICAgICBzdHI6IHRpdGxlLnRleHRDb250ZW50CiAgICAgIH0gPSB0aGlzLiN0aXRsZU9iaik7CiAgICB9CiAgICBwb3B1cC5hcHBlbmQoaGVhZGVyKTsKICAgIGlmICh0aGlzLiNkYXRlT2JqKSB7CiAgICAgIGNvbnN0IG1vZGlmaWNhdGlvbkRhdGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0aW1lIik7CiAgICAgIG1vZGlmaWNhdGlvbkRhdGUuY2xhc3NOYW1lID0gInBvcHVwRGF0ZSI7CiAgICAgIG1vZGlmaWNhdGlvbkRhdGUuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4taWQiLCAicGRmanMtYW5ub3RhdGlvbi1kYXRlLXRpbWUtc3RyaW5nIik7CiAgICAgIG1vZGlmaWNhdGlvbkRhdGUuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4tYXJncyIsIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBkYXRlT2JqOiB0aGlzLiNkYXRlT2JqLnZhbHVlT2YoKQogICAgICB9KSk7CiAgICAgIG1vZGlmaWNhdGlvbkRhdGUuZGF0ZVRpbWUgPSB0aGlzLiNkYXRlT2JqLnRvSVNPU3RyaW5nKCk7CiAgICAgIGhlYWRlci5hcHBlbmQobW9kaWZpY2F0aW9uRGF0ZSk7CiAgICB9CiAgICByZW5kZXJSaWNoVGV4dCh7CiAgICAgIGh0bWw6IHRoaXMuI2h0bWwgfHwgdGhpcy4jY29udGVudHNPYmouc3RyLAogICAgICBkaXI6IHRoaXMuI2NvbnRlbnRzT2JqPy5kaXIsCiAgICAgIGNsYXNzTmFtZTogInBvcHVwQ29udGVudCIKICAgIH0sIHBvcHVwKTsKICAgIHRoaXMuI2NvbnRhaW5lci5hcHBlbmQocG9wdXApOwogIH0KICBnZXQgI2h0bWwoKSB7CiAgICBjb25zdCByaWNoVGV4dCA9IHRoaXMuI3JpY2hUZXh0OwogICAgY29uc3QgY29udGVudHNPYmogPSB0aGlzLiNjb250ZW50c09iajsKICAgIGlmIChyaWNoVGV4dD8uc3RyICYmICghY29udGVudHNPYmo/LnN0ciB8fCBjb250ZW50c09iai5zdHIgPT09IHJpY2hUZXh0LnN0cikpIHsKICAgICAgcmV0dXJuIHRoaXMuI3JpY2hUZXh0Lmh0bWwgfHwgbnVsbDsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBnZXQgI2ZvbnRTaXplKCkgewogICAgcmV0dXJuIHRoaXMuI2h0bWw/LmF0dHJpYnV0ZXM/LnN0eWxlPy5mb250U2l6ZSB8fCAwOwogIH0KICBnZXQgI2ZvbnRDb2xvcigpIHsKICAgIHJldHVybiB0aGlzLiNodG1sPy5hdHRyaWJ1dGVzPy5zdHlsZT8uY29sb3IgfHwgbnVsbDsKICB9CiAgI21ha2VQb3B1cENvbnRlbnQodGV4dCkgewogICAgY29uc3QgcG9wdXBMaW5lcyA9IFtdOwogICAgY29uc3QgcG9wdXBDb250ZW50ID0gewogICAgICBzdHI6IHRleHQsCiAgICAgIGh0bWw6IHsKICAgICAgICBuYW1lOiAiZGl2IiwKICAgICAgICBhdHRyaWJ1dGVzOiB7CiAgICAgICAgICBkaXI6ICJhdXRvIgogICAgICAgIH0sCiAgICAgICAgY2hpbGRyZW46IFt7CiAgICAgICAgICBuYW1lOiAicCIsCiAgICAgICAgICBjaGlsZHJlbjogcG9wdXBMaW5lcwogICAgICAgIH1dCiAgICAgIH0KICAgIH07CiAgICBjb25zdCBsaW5lQXR0cmlidXRlcyA9IHsKICAgICAgc3R5bGU6IHsKICAgICAgICBjb2xvcjogdGhpcy4jZm9udENvbG9yLAogICAgICAgIGZvbnRTaXplOiB0aGlzLiNmb250U2l6ZSA/IGBjYWxjKCR7dGhpcy4jZm9udFNpemV9cHggKiB2YXIoLS10b3RhbC1zY2FsZS1mYWN0b3IpKWAgOiAiIgogICAgICB9CiAgICB9OwogICAgZm9yIChjb25zdCBsaW5lIG9mIHRleHQuc3BsaXQoIlxuIikpIHsKICAgICAgcG9wdXBMaW5lcy5wdXNoKHsKICAgICAgICBuYW1lOiAic3BhbiIsCiAgICAgICAgdmFsdWU6IGxpbmUsCiAgICAgICAgYXR0cmlidXRlczogbGluZUF0dHJpYnV0ZXMKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcG9wdXBDb250ZW50OwogIH0KICAja2V5RG93bihldmVudCkgewogICAgaWYgKGV2ZW50LmFsdEtleSB8fCBldmVudC5zaGlmdEtleSB8fCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGV2ZW50LmtleSA9PT0gIkVudGVyIiB8fCBldmVudC5rZXkgPT09ICJFc2NhcGUiICYmIHRoaXMuI3Bpbm5lZCkgewogICAgICB0aGlzLiN0b2dnbGUoKTsKICAgIH0KICB9CiAgdXBkYXRlRWRpdGVkKHsKICAgIHJlY3QsCiAgICBwb3B1cCwKICAgIGRlbGV0ZWQKICB9KSB7CiAgICBpZiAodGhpcy4jY29tbWVudE1hbmFnZXIpIHsKICAgICAgaWYgKGRlbGV0ZWQpIHsKICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgIHRoaXMuI2NvbW1lbnRUZXh0ID0gbnVsbDsKICAgICAgfSBlbHNlIGlmIChwb3B1cCkgewogICAgICAgIGlmIChwb3B1cC5kZWxldGVkKSB7CiAgICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiN1cGRhdGVDb2xvcigpOwogICAgICAgICAgdGhpcy4jY29tbWVudFRleHQgPSBwb3B1cC50ZXh0OwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocmVjdCkgewogICAgICAgIHRoaXMuI2NvbW1lbnRCdXR0b25Qb3NpdGlvbiA9IG51bGw7CiAgICAgICAgdGhpcy4jc2V0Q29tbWVudEJ1dHRvblBvc2l0aW9uKCk7CiAgICAgICAgdGhpcy4jdXBkYXRlQ29tbWVudEJ1dHRvblBvc2l0aW9uKCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGRlbGV0ZWQgfHwgcG9wdXA/LmRlbGV0ZWQpIHsKICAgICAgdGhpcy5yZW1vdmUoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jYWRkRXZlbnRMaXN0ZW5lcnMoKTsKICAgIHRoaXMuI3VwZGF0ZXMgfHw9IHsKICAgICAgY29udGVudHNPYmo6IHRoaXMuI2NvbnRlbnRzT2JqLAogICAgICByaWNoVGV4dDogdGhpcy4jcmljaFRleHQKICAgIH07CiAgICBpZiAocmVjdCkgewogICAgICB0aGlzLiNwb3NpdGlvbiA9IG51bGw7CiAgICB9CiAgICBpZiAocG9wdXAgJiYgcG9wdXAudGV4dCkgewogICAgICB0aGlzLiNyaWNoVGV4dCA9IHRoaXMuI21ha2VQb3B1cENvbnRlbnQocG9wdXAudGV4dCk7CiAgICAgIHRoaXMuI2RhdGVPYmogPSBQREZEYXRlU3RyaW5nLnRvRGF0ZU9iamVjdChwb3B1cC5kYXRlKTsKICAgICAgdGhpcy4jY29udGVudHNPYmogPSBudWxsOwogICAgfQogICAgdGhpcy4jcG9wdXA/LnJlbW92ZSgpOwogICAgdGhpcy4jcG9wdXAgPSBudWxsOwogIH0KICByZXNldEVkaXRlZCgpIHsKICAgIGlmICghdGhpcy4jdXBkYXRlcykgewogICAgICByZXR1cm47CiAgICB9CiAgICAoewogICAgICBjb250ZW50c09iajogdGhpcy4jY29udGVudHNPYmosCiAgICAgIHJpY2hUZXh0OiB0aGlzLiNyaWNoVGV4dAogICAgfSA9IHRoaXMuI3VwZGF0ZXMpOwogICAgdGhpcy4jdXBkYXRlcyA9IG51bGw7CiAgICB0aGlzLiNwb3B1cD8ucmVtb3ZlKCk7CiAgICB0aGlzLiNwb3B1cCA9IG51bGw7CiAgICB0aGlzLiNwb3NpdGlvbiA9IG51bGw7CiAgfQogIHJlbW92ZSgpIHsKICAgIHRoaXMuI3BvcHVwQWJvcnRDb250cm9sbGVyPy5hYm9ydCgpOwogICAgdGhpcy4jcG9wdXBBYm9ydENvbnRyb2xsZXIgPSBudWxsOwogICAgdGhpcy4jcG9wdXA/LnJlbW92ZSgpOwogICAgdGhpcy4jcG9wdXAgPSBudWxsOwogICAgdGhpcy4jd2FzVmlzaWJsZSA9IGZhbHNlOwogICAgdGhpcy4jcGlubmVkID0gZmFsc2U7CiAgICB0aGlzLiNjb21tZW50QnV0dG9uPy5yZW1vdmUoKTsKICAgIHRoaXMuI2NvbW1lbnRCdXR0b24gPSBudWxsOwogICAgaWYgKHRoaXMudHJpZ2dlcikgewogICAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdGhpcy50cmlnZ2VyKSB7CiAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCJwb3B1cFRyaWdnZXJBcmVhIik7CiAgICAgIH0KICAgIH0KICB9CiAgI3NldFBvc2l0aW9uKCkgewogICAgaWYgKHRoaXMuI3Bvc2l0aW9uICE9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgcGFnZTogewogICAgICAgIHZpZXcKICAgICAgfSwKICAgICAgdmlld3BvcnQ6IHsKICAgICAgICByYXdEaW1zOiB7CiAgICAgICAgICBwYWdlV2lkdGgsCiAgICAgICAgICBwYWdlSGVpZ2h0LAogICAgICAgICAgcGFnZVgsCiAgICAgICAgICBwYWdlWQogICAgICAgIH0KICAgICAgfQogICAgfSA9IHRoaXMuI3BhcmVudDsKICAgIGxldCB1c2VQYXJlbnRSZWN0ID0gISF0aGlzLiNwYXJlbnRSZWN0OwogICAgbGV0IHJlY3QgPSB1c2VQYXJlbnRSZWN0ID8gdGhpcy4jcGFyZW50UmVjdCA6IHRoaXMuI3JlY3Q7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgdGhpcy4jZWxlbWVudHMpIHsKICAgICAgaWYgKCFyZWN0IHx8IFV0aWwuaW50ZXJzZWN0KGVsZW1lbnQuZGF0YS5yZWN0LCByZWN0KSAhPT0gbnVsbCkgewogICAgICAgIHJlY3QgPSBlbGVtZW50LmRhdGEucmVjdDsKICAgICAgICB1c2VQYXJlbnRSZWN0ID0gdHJ1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgY29uc3Qgbm9ybWFsaXplZFJlY3QgPSBVdGlsLm5vcm1hbGl6ZVJlY3QoW3JlY3RbMF0sIHZpZXdbM10gLSByZWN0WzFdICsgdmlld1sxXSwgcmVjdFsyXSwgdmlld1szXSAtIHJlY3RbM10gKyB2aWV3WzFdXSk7CiAgICBjb25zdCBIT1JJWk9OVEFMX1NQQUNFX0FGVEVSX0FOTk9UQVRJT04gPSA1OwogICAgY29uc3QgcGFyZW50V2lkdGggPSB1c2VQYXJlbnRSZWN0ID8gcmVjdFsyXSAtIHJlY3RbMF0gKyBIT1JJWk9OVEFMX1NQQUNFX0FGVEVSX0FOTk9UQVRJT04gOiAwOwogICAgY29uc3QgcG9wdXBMZWZ0ID0gbm9ybWFsaXplZFJlY3RbMF0gKyBwYXJlbnRXaWR0aDsKICAgIGNvbnN0IHBvcHVwVG9wID0gbm9ybWFsaXplZFJlY3RbMV07CiAgICB0aGlzLiNwb3NpdGlvbiA9IFsxMDAgKiAocG9wdXBMZWZ0IC0gcGFnZVgpIC8gcGFnZVdpZHRoLCAxMDAgKiAocG9wdXBUb3AgLSBwYWdlWSkgLyBwYWdlSGVpZ2h0XTsKICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSB0aGlzLiNjb250YWluZXI7CiAgICBzdHlsZS5sZWZ0ID0gYCR7dGhpcy4jcG9zaXRpb25bMF19JWA7CiAgICBzdHlsZS50b3AgPSBgJHt0aGlzLiNwb3NpdGlvblsxXX0lYDsKICB9CiAgI3RvZ2dsZSgpIHsKICAgIGlmICh0aGlzLiNjb21tZW50TWFuYWdlcikgewogICAgICB0aGlzLiNjb21tZW50TWFuYWdlci50b2dnbGVDb21tZW50UG9wdXAodGhpcywgZmFsc2UpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNwaW5uZWQgPSAhdGhpcy4jcGlubmVkOwogICAgaWYgKHRoaXMuI3Bpbm5lZCkgewogICAgICB0aGlzLiNzaG93KCk7CiAgICAgIHRoaXMuI2NvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuI2JvdW5kVG9nZ2xlKTsKICAgICAgdGhpcy4jY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLiNib3VuZEtleURvd24pOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy4jaGlkZSgpOwogICAgICB0aGlzLiNjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLiNib3VuZFRvZ2dsZSk7CiAgICAgIHRoaXMuI2NvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy4jYm91bmRLZXlEb3duKTsKICAgIH0KICB9CiAgI3Nob3coKSB7CiAgICBpZiAoIXRoaXMuI3BvcHVwKSB7CiAgICAgIHRoaXMucmVuZGVyKCk7CiAgICB9CiAgICBpZiAoIXRoaXMuaXNWaXNpYmxlKSB7CiAgICAgIHRoaXMuI3NldFBvc2l0aW9uKCk7CiAgICAgIHRoaXMuI2NvbnRhaW5lci5oaWRkZW4gPSBmYWxzZTsKICAgICAgdGhpcy4jY29udGFpbmVyLnN0eWxlLnpJbmRleCA9IHBhcnNlSW50KHRoaXMuI2NvbnRhaW5lci5zdHlsZS56SW5kZXgpICsgMWUzOwogICAgfSBlbHNlIGlmICh0aGlzLiNwaW5uZWQpIHsKICAgICAgdGhpcy4jY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImZvY3VzZWQiKTsKICAgIH0KICB9CiAgI2hpZGUoKSB7CiAgICB0aGlzLiNjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgiZm9jdXNlZCIpOwogICAgaWYgKHRoaXMuI3Bpbm5lZCB8fCAhdGhpcy5pc1Zpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jY29udGFpbmVyLmhpZGRlbiA9IHRydWU7CiAgICB0aGlzLiNjb250YWluZXIuc3R5bGUuekluZGV4ID0gcGFyc2VJbnQodGhpcy4jY29udGFpbmVyLnN0eWxlLnpJbmRleCkgLSAxZTM7CiAgfQogIGZvcmNlSGlkZSgpIHsKICAgIHRoaXMuI3dhc1Zpc2libGUgPSB0aGlzLmlzVmlzaWJsZTsKICAgIGlmICghdGhpcy4jd2FzVmlzaWJsZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNjb250YWluZXIuaGlkZGVuID0gdHJ1ZTsKICB9CiAgbWF5YmVTaG93KCkgewogICAgaWYgKHRoaXMuI2NvbW1lbnRNYW5hZ2VyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FkZEV2ZW50TGlzdGVuZXJzKCk7CiAgICBpZiAoIXRoaXMuI3dhc1Zpc2libGUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLiNwb3B1cCkgewogICAgICB0aGlzLiNzaG93KCk7CiAgICB9CiAgICB0aGlzLiN3YXNWaXNpYmxlID0gZmFsc2U7CiAgICB0aGlzLiNjb250YWluZXIuaGlkZGVuID0gZmFsc2U7CiAgfQogIGdldCBpc1Zpc2libGUoKSB7CiAgICBpZiAodGhpcy4jY29tbWVudE1hbmFnZXIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRoaXMuI2NvbnRhaW5lci5oaWRkZW4gPT09IGZhbHNlOwogIH0KfTsKdmFyIEZyZWVUZXh0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlCiAgICB9KTsKICAgIHRoaXMudGV4dENvbnRlbnQgPSBwYXJhbWV0ZXJzLmRhdGEudGV4dENvbnRlbnQ7CiAgICB0aGlzLnRleHRQb3NpdGlvbiA9IHBhcmFtZXRlcnMuZGF0YS50ZXh0UG9zaXRpb247CiAgICB0aGlzLmFubm90YXRpb25FZGl0b3JUeXBlID0gQW5ub3RhdGlvbkVkaXRvclR5cGUuRlJFRVRFWFQ7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImZyZWVUZXh0QW5ub3RhdGlvbiIpOwogICAgaWYgKHRoaXMudGV4dENvbnRlbnQpIHsKICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuY29udGVudEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY29udGVudC5jbGFzc0xpc3QuYWRkKCJhbm5vdGF0aW9uVGV4dENvbnRlbnQiKTsKICAgICAgY29udGVudC5zZXRBdHRyaWJ1dGUoInJvbGUiLCAiY29tbWVudCIpOwogICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgdGhpcy50ZXh0Q29udGVudCkgewogICAgICAgIGNvbnN0IGxpbmVTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICAgIGxpbmVTcGFuLnRleHRDb250ZW50ID0gbGluZTsKICAgICAgICBjb250ZW50LmFwcGVuZChsaW5lU3Bhbik7CiAgICAgIH0KICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kKGNvbnRlbnQpOwogICAgfQogICAgaWYgKCF0aGlzLmRhdGEucG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHRoaXMuX2VkaXRPbkRvdWJsZUNsaWNrKCk7CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgTGluZUFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgI2xpbmUgPSBudWxsOwogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJsaW5lQW5ub3RhdGlvbiIpOwogICAgY29uc3QgewogICAgICBkYXRhLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gdGhpczsKICAgIGNvbnN0IHN2ZyA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGUod2lkdGgsIGhlaWdodCwgdHJ1ZSk7CiAgICBjb25zdCBsaW5lID0gdGhpcy4jbGluZSA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJzdmc6bGluZSIpOwogICAgbGluZS5zZXRBdHRyaWJ1dGUoIngxIiwgZGF0YS5yZWN0WzJdIC0gZGF0YS5saW5lQ29vcmRpbmF0ZXNbMF0pOwogICAgbGluZS5zZXRBdHRyaWJ1dGUoInkxIiwgZGF0YS5yZWN0WzNdIC0gZGF0YS5saW5lQ29vcmRpbmF0ZXNbMV0pOwogICAgbGluZS5zZXRBdHRyaWJ1dGUoIngyIiwgZGF0YS5yZWN0WzJdIC0gZGF0YS5saW5lQ29vcmRpbmF0ZXNbMl0pOwogICAgbGluZS5zZXRBdHRyaWJ1dGUoInkyIiwgZGF0YS5yZWN0WzNdIC0gZGF0YS5saW5lQ29vcmRpbmF0ZXNbM10pOwogICAgbGluZS5zZXRBdHRyaWJ1dGUoInN0cm9rZS13aWR0aCIsIGRhdGEuYm9yZGVyU3R5bGUud2lkdGggfHwgMSk7CiAgICBsaW5lLnNldEF0dHJpYnV0ZSgic3Ryb2tlIiwgInRyYW5zcGFyZW50Iik7CiAgICBsaW5lLnNldEF0dHJpYnV0ZSgiZmlsbCIsICJ0cmFuc3BhcmVudCIpOwogICAgc3ZnLmFwcGVuZChsaW5lKTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChzdmcpOwogICAgaWYgKCFkYXRhLnBvcHVwUmVmICYmIHRoaXMuaGFzUG9wdXBEYXRhKSB7CiAgICAgIHRoaXMuaGFzT3duQ29tbWVudEJ1dHRvbiA9IHRydWU7CiAgICAgIHRoaXMuX2NyZWF0ZVBvcHVwKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQogIGdldEVsZW1lbnRzVG9UcmlnZ2VyUG9wdXAoKSB7CiAgICByZXR1cm4gdGhpcy4jbGluZTsKICB9CiAgYWRkSGlnaGxpZ2h0QXJlYSgpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodEFyZWEiKTsKICB9Cn07CnZhciBTcXVhcmVBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogICNzcXVhcmUgPSBudWxsOwogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJzcXVhcmVBbm5vdGF0aW9uIik7CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgY29uc3Qgc3ZnID0gdGhpcy5zdmdGYWN0b3J5LmNyZWF0ZSh3aWR0aCwgaGVpZ2h0LCB0cnVlKTsKICAgIGNvbnN0IGJvcmRlcldpZHRoID0gZGF0YS5ib3JkZXJTdHlsZS53aWR0aDsKICAgIGNvbnN0IHNxdWFyZSA9IHRoaXMuI3NxdWFyZSA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJzdmc6cmVjdCIpOwogICAgc3F1YXJlLnNldEF0dHJpYnV0ZSgieCIsIGJvcmRlcldpZHRoIC8gMik7CiAgICBzcXVhcmUuc2V0QXR0cmlidXRlKCJ5IiwgYm9yZGVyV2lkdGggLyAyKTsKICAgIHNxdWFyZS5zZXRBdHRyaWJ1dGUoIndpZHRoIiwgd2lkdGggLSBib3JkZXJXaWR0aCk7CiAgICBzcXVhcmUuc2V0QXR0cmlidXRlKCJoZWlnaHQiLCBoZWlnaHQgLSBib3JkZXJXaWR0aCk7CiAgICBzcXVhcmUuc2V0QXR0cmlidXRlKCJzdHJva2Utd2lkdGgiLCBib3JkZXJXaWR0aCB8fCAxKTsKICAgIHNxdWFyZS5zZXRBdHRyaWJ1dGUoInN0cm9rZSIsICJ0cmFuc3BhcmVudCIpOwogICAgc3F1YXJlLnNldEF0dHJpYnV0ZSgiZmlsbCIsICJ0cmFuc3BhcmVudCIpOwogICAgc3ZnLmFwcGVuZChzcXVhcmUpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHN2Zyk7CiAgICBpZiAoIWRhdGEucG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgZ2V0RWxlbWVudHNUb1RyaWdnZXJQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLiNzcXVhcmU7CiAgfQogIGFkZEhpZ2hsaWdodEFyZWEoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJoaWdobGlnaHRBcmVhIik7CiAgfQp9Owp2YXIgQ2lyY2xlQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICAjY2lyY2xlID0gbnVsbDsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiY2lyY2xlQW5ub3RhdGlvbiIpOwogICAgY29uc3QgewogICAgICBkYXRhLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gdGhpczsKICAgIGNvbnN0IHN2ZyA9IHRoaXMuc3ZnRmFjdG9yeS5jcmVhdGUod2lkdGgsIGhlaWdodCwgdHJ1ZSk7CiAgICBjb25zdCBib3JkZXJXaWR0aCA9IGRhdGEuYm9yZGVyU3R5bGUud2lkdGg7CiAgICBjb25zdCBjaXJjbGUgPSB0aGlzLiNjaXJjbGUgPSB0aGlzLnN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgic3ZnOmVsbGlwc2UiKTsKICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoImN4Iiwgd2lkdGggLyAyKTsKICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoImN5IiwgaGVpZ2h0IC8gMik7CiAgICBjaXJjbGUuc2V0QXR0cmlidXRlKCJyeCIsIHdpZHRoIC8gMiAtIGJvcmRlcldpZHRoIC8gMik7CiAgICBjaXJjbGUuc2V0QXR0cmlidXRlKCJyeSIsIGhlaWdodCAvIDIgLSBib3JkZXJXaWR0aCAvIDIpOwogICAgY2lyY2xlLnNldEF0dHJpYnV0ZSgic3Ryb2tlLXdpZHRoIiwgYm9yZGVyV2lkdGggfHwgMSk7CiAgICBjaXJjbGUuc2V0QXR0cmlidXRlKCJzdHJva2UiLCAidHJhbnNwYXJlbnQiKTsKICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoImZpbGwiLCAidHJhbnNwYXJlbnQiKTsKICAgIHN2Zy5hcHBlbmQoY2lyY2xlKTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChzdmcpOwogICAgaWYgKCFkYXRhLnBvcHVwUmVmICYmIHRoaXMuaGFzUG9wdXBEYXRhKSB7CiAgICAgIHRoaXMuaGFzT3duQ29tbWVudEJ1dHRvbiA9IHRydWU7CiAgICAgIHRoaXMuX2NyZWF0ZVBvcHVwKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQogIGdldEVsZW1lbnRzVG9UcmlnZ2VyUG9wdXAoKSB7CiAgICByZXR1cm4gdGhpcy4jY2lyY2xlOwogIH0KICBhZGRIaWdobGlnaHRBcmVhKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiaGlnaGxpZ2h0QXJlYSIpOwogIH0KfTsKdmFyIFBvbHlsaW5lQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICAjcG9seWxpbmUgPSBudWxsOwogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUKICAgIH0pOwogICAgdGhpcy5jb250YWluZXJDbGFzc05hbWUgPSAicG9seWxpbmVBbm5vdGF0aW9uIjsKICAgIHRoaXMuc3ZnRWxlbWVudE5hbWUgPSAic3ZnOnBvbHlsaW5lIjsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCh0aGlzLmNvbnRhaW5lckNsYXNzTmFtZSk7CiAgICBjb25zdCB7CiAgICAgIGRhdGE6IHsKICAgICAgICByZWN0LAogICAgICAgIHZlcnRpY2VzLAogICAgICAgIGJvcmRlclN0eWxlLAogICAgICAgIHBvcHVwUmVmCiAgICAgIH0sCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgaWYgKCF2ZXJ0aWNlcykgewogICAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgICB9CiAgICBjb25zdCBzdmcgPSB0aGlzLnN2Z0ZhY3RvcnkuY3JlYXRlKHdpZHRoLCBoZWlnaHQsIHRydWUpOwogICAgbGV0IHBvaW50cyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gdmVydGljZXMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gMikgewogICAgICBjb25zdCB4ID0gdmVydGljZXNbaV0gLSByZWN0WzBdOwogICAgICBjb25zdCB5ID0gcmVjdFszXSAtIHZlcnRpY2VzW2kgKyAxXTsKICAgICAgcG9pbnRzLnB1c2goYCR7eH0sJHt5fWApOwogICAgfQogICAgcG9pbnRzID0gcG9pbnRzLmpvaW4oIiAiKTsKICAgIGNvbnN0IHBvbHlsaW5lID0gdGhpcy4jcG9seWxpbmUgPSB0aGlzLnN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCh0aGlzLnN2Z0VsZW1lbnROYW1lKTsKICAgIHBvbHlsaW5lLnNldEF0dHJpYnV0ZSgicG9pbnRzIiwgcG9pbnRzKTsKICAgIHBvbHlsaW5lLnNldEF0dHJpYnV0ZSgic3Ryb2tlLXdpZHRoIiwgYm9yZGVyU3R5bGUud2lkdGggfHwgMSk7CiAgICBwb2x5bGluZS5zZXRBdHRyaWJ1dGUoInN0cm9rZSIsICJ0cmFuc3BhcmVudCIpOwogICAgcG9seWxpbmUuc2V0QXR0cmlidXRlKCJmaWxsIiwgInRyYW5zcGFyZW50Iik7CiAgICBzdmcuYXBwZW5kKHBvbHlsaW5lKTsKICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChzdmcpOwogICAgaWYgKCFwb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KICBnZXRFbGVtZW50c1RvVHJpZ2dlclBvcHVwKCkgewogICAgcmV0dXJuIHRoaXMuI3BvbHlsaW5lOwogIH0KICBhZGRIaWdobGlnaHRBcmVhKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiaGlnaGxpZ2h0QXJlYSIpOwogIH0KfTsKdmFyIFBvbHlnb25Bbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgUG9seWxpbmVBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycyk7CiAgICB0aGlzLmNvbnRhaW5lckNsYXNzTmFtZSA9ICJwb2x5Z29uQW5ub3RhdGlvbiI7CiAgICB0aGlzLnN2Z0VsZW1lbnROYW1lID0gInN2Zzpwb2x5Z29uIjsKICB9Cn07CnZhciBDYXJldEFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogdHJ1ZQogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoImNhcmV0QW5ub3RhdGlvbiIpOwogICAgaWYgKCF0aGlzLmRhdGEucG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBJbmtBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogICNwb2x5bGluZXNHcm91cEVsZW1lbnQgPSBudWxsOwogICNwb2x5bGluZXMgPSBbXTsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlCiAgICB9KTsKICAgIHRoaXMuY29udGFpbmVyQ2xhc3NOYW1lID0gImlua0Fubm90YXRpb24iOwogICAgdGhpcy5zdmdFbGVtZW50TmFtZSA9ICJzdmc6cG9seWxpbmUiOwogICAgdGhpcy5hbm5vdGF0aW9uRWRpdG9yVHlwZSA9IHRoaXMuZGF0YS5pdCA9PT0gIklua0hpZ2hsaWdodCIgPyBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQgOiBBbm5vdGF0aW9uRWRpdG9yVHlwZS5JTks7CiAgfQogICNnZXRUcmFuc2Zvcm0ocm90YXRpb24sIHJlY3QpIHsKICAgIHN3aXRjaCAocm90YXRpb24pIHsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXR1cm4gewogICAgICAgICAgdHJhbnNmb3JtOiBgcm90YXRlKDkwKSB0cmFuc2xhdGUoJHstcmVjdFswXX0sJHtyZWN0WzFdfSkgc2NhbGUoMSwtMSlgLAogICAgICAgICAgd2lkdGg6IHJlY3RbM10gLSByZWN0WzFdLAogICAgICAgICAgaGVpZ2h0OiByZWN0WzJdIC0gcmVjdFswXQogICAgICAgIH07CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0cmFuc2Zvcm06IGByb3RhdGUoMTgwKSB0cmFuc2xhdGUoJHstcmVjdFsyXX0sJHtyZWN0WzFdfSkgc2NhbGUoMSwtMSlgLAogICAgICAgICAgd2lkdGg6IHJlY3RbMl0gLSByZWN0WzBdLAogICAgICAgICAgaGVpZ2h0OiByZWN0WzNdIC0gcmVjdFsxXQogICAgICAgIH07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0cmFuc2Zvcm06IGByb3RhdGUoMjcwKSB0cmFuc2xhdGUoJHstcmVjdFsyXX0sJHtyZWN0WzNdfSkgc2NhbGUoMSwtMSlgLAogICAgICAgICAgd2lkdGg6IHJlY3RbM10gLSByZWN0WzFdLAogICAgICAgICAgaGVpZ2h0OiByZWN0WzJdIC0gcmVjdFswXQogICAgICAgIH07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHRyYW5zZm9ybTogYHRyYW5zbGF0ZSgkey1yZWN0WzBdfSwke3JlY3RbM119KSBzY2FsZSgxLC0xKWAsCiAgICAgICAgICB3aWR0aDogcmVjdFsyXSAtIHJlY3RbMF0sCiAgICAgICAgICBoZWlnaHQ6IHJlY3RbM10gLSByZWN0WzFdCiAgICAgICAgfTsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCh0aGlzLmNvbnRhaW5lckNsYXNzTmFtZSk7CiAgICBjb25zdCB7CiAgICAgIGRhdGE6IHsKICAgICAgICByZWN0LAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGlua0xpc3RzLAogICAgICAgIGJvcmRlclN0eWxlLAogICAgICAgIHBvcHVwUmVmCiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgY29uc3QgewogICAgICB0cmFuc2Zvcm0sCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzLiNnZXRUcmFuc2Zvcm0ocm90YXRpb24sIHJlY3QpOwogICAgY29uc3Qgc3ZnID0gdGhpcy5zdmdGYWN0b3J5LmNyZWF0ZSh3aWR0aCwgaGVpZ2h0LCB0cnVlKTsKICAgIGNvbnN0IGcgPSB0aGlzLiNwb2x5bGluZXNHcm91cEVsZW1lbnQgPSB0aGlzLnN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgic3ZnOmciKTsKICAgIHN2Zy5hcHBlbmQoZyk7CiAgICBnLnNldEF0dHJpYnV0ZSgic3Ryb2tlLXdpZHRoIiwgYm9yZGVyU3R5bGUud2lkdGggfHwgMSk7CiAgICBnLnNldEF0dHJpYnV0ZSgic3Ryb2tlLWxpbmVjYXAiLCAicm91bmQiKTsKICAgIGcuc2V0QXR0cmlidXRlKCJzdHJva2UtbGluZWpvaW4iLCAicm91bmQiKTsKICAgIGcuc2V0QXR0cmlidXRlKCJzdHJva2UtbWl0ZXJsaW1pdCIsIDEwKTsKICAgIGcuc2V0QXR0cmlidXRlKCJzdHJva2UiLCAidHJhbnNwYXJlbnQiKTsKICAgIGcuc2V0QXR0cmlidXRlKCJmaWxsIiwgInRyYW5zcGFyZW50Iik7CiAgICBnLnNldEF0dHJpYnV0ZSgidHJhbnNmb3JtIiwgdHJhbnNmb3JtKTsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IGlua0xpc3RzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgY29uc3QgcG9seWxpbmUgPSB0aGlzLnN2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCh0aGlzLnN2Z0VsZW1lbnROYW1lKTsKICAgICAgdGhpcy4jcG9seWxpbmVzLnB1c2gocG9seWxpbmUpOwogICAgICBwb2x5bGluZS5zZXRBdHRyaWJ1dGUoInBvaW50cyIsIGlua0xpc3RzW2ldLmpvaW4oIiwiKSk7CiAgICAgIGcuYXBwZW5kKHBvbHlsaW5lKTsKICAgIH0KICAgIGlmICghcG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChzdmcpOwogICAgdGhpcy5fZWRpdE9uRG91YmxlQ2xpY2soKTsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9CiAgdXBkYXRlRWRpdGVkKHBhcmFtcykgewogICAgc3VwZXIudXBkYXRlRWRpdGVkKHBhcmFtcyk7CiAgICBjb25zdCB7CiAgICAgIHRoaWNrbmVzcywKICAgICAgcG9pbnRzLAogICAgICByZWN0CiAgICB9ID0gcGFyYW1zOwogICAgY29uc3QgZyA9IHRoaXMuI3BvbHlsaW5lc0dyb3VwRWxlbWVudDsKICAgIGlmICh0aGlja25lc3MgPj0gMCkgewogICAgICBnLnNldEF0dHJpYnV0ZSgic3Ryb2tlLXdpZHRoIiwgdGhpY2tuZXNzIHx8IDEpOwogICAgfQogICAgaWYgKHBvaW50cykgewogICAgICBmb3IgKGxldCBpID0gMCwgaWkgPSB0aGlzLiNwb2x5bGluZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIHRoaXMuI3BvbHlsaW5lc1tpXS5zZXRBdHRyaWJ1dGUoInBvaW50cyIsIHBvaW50c1tpXS5qb2luKCIsIikpOwogICAgICB9CiAgICB9CiAgICBpZiAocmVjdCkgewogICAgICBjb25zdCB7CiAgICAgICAgdHJhbnNmb3JtLAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9ID0gdGhpcy4jZ2V0VHJhbnNmb3JtKHRoaXMuZGF0YS5yb3RhdGlvbiwgcmVjdCk7CiAgICAgIGNvbnN0IHJvb3QyID0gZy5wYXJlbnRFbGVtZW50OwogICAgICByb290Mi5zZXRBdHRyaWJ1dGUoInZpZXdCb3giLCBgMCAwICR7d2lkdGh9ICR7aGVpZ2h0fWApOwogICAgICBnLnNldEF0dHJpYnV0ZSgidHJhbnNmb3JtIiwgdHJhbnNmb3JtKTsKICAgIH0KICB9CiAgZ2V0RWxlbWVudHNUb1RyaWdnZXJQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLiNwb2x5bGluZXM7CiAgfQogIGFkZEhpZ2hsaWdodEFyZWEoKSB7CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJoaWdobGlnaHRBcmVhIik7CiAgfQp9Owp2YXIgSGlnaGxpZ2h0QW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlLAogICAgICBjcmVhdGVRdWFkcmlsYXRlcmFsczogdHJ1ZQogICAgfSk7CiAgICB0aGlzLmFubm90YXRpb25FZGl0b3JUeXBlID0gQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hUOwogIH0KICByZW5kZXIoKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGE6IHsKICAgICAgICBvdmVybGFpZFRleHQsCiAgICAgICAgcG9wdXBSZWYKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBpZiAoIXBvcHVwUmVmICYmIHRoaXMuaGFzUG9wdXBEYXRhKSB7CiAgICAgIHRoaXMuaGFzT3duQ29tbWVudEJ1dHRvbiA9IHRydWU7CiAgICAgIHRoaXMuX2NyZWF0ZVBvcHVwKCk7CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJoaWdobGlnaHRBbm5vdGF0aW9uIik7CiAgICB0aGlzLl9lZGl0T25Eb3VibGVDbGljaygpOwogICAgaWYgKG92ZXJsYWlkVGV4dCkgewogICAgICBjb25zdCBtYXJrID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibWFyayIpOwogICAgICBtYXJrLmNsYXNzTGlzdC5hZGQoIm92ZXJsYWlkVGV4dCIpOwogICAgICBtYXJrLnRleHRDb250ZW50ID0gb3ZlcmxhaWRUZXh0OwogICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmQobWFyayk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgVW5kZXJsaW5lQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlLAogICAgICBjcmVhdGVRdWFkcmlsYXRlcmFsczogdHJ1ZQogICAgfSk7CiAgfQogIHJlbmRlcigpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YTogewogICAgICAgIG92ZXJsYWlkVGV4dCwKICAgICAgICBwb3B1cFJlZgogICAgICB9CiAgICB9ID0gdGhpczsKICAgIGlmICghcG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0KICAgIHRoaXMuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInVuZGVybGluZUFubm90YXRpb24iKTsKICAgIGlmIChvdmVybGFpZFRleHQpIHsKICAgICAgY29uc3QgdW5kZXJsaW5lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidSIpOwogICAgICB1bmRlcmxpbmUuY2xhc3NMaXN0LmFkZCgib3ZlcmxhaWRUZXh0Iik7CiAgICAgIHVuZGVybGluZS50ZXh0Q29udGVudCA9IG92ZXJsYWlkVGV4dDsKICAgICAgdGhpcy5jb250YWluZXIuYXBwZW5kKHVuZGVybGluZSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb250YWluZXI7CiAgfQp9Owp2YXIgU3F1aWdnbHlBbm5vdGF0aW9uRWxlbWVudCA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVsZW1lbnQgewogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlLAogICAgICBpZ25vcmVCb3JkZXI6IHRydWUsCiAgICAgIGNyZWF0ZVF1YWRyaWxhdGVyYWxzOiB0cnVlCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgY29uc3QgewogICAgICBkYXRhOiB7CiAgICAgICAgb3ZlcmxhaWRUZXh0LAogICAgICAgIHBvcHVwUmVmCiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgaWYgKCFwb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgic3F1aWdnbHlBbm5vdGF0aW9uIik7CiAgICBpZiAob3ZlcmxhaWRUZXh0KSB7CiAgICAgIGNvbnN0IHVuZGVybGluZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInUiKTsKICAgICAgdW5kZXJsaW5lLmNsYXNzTGlzdC5hZGQoIm92ZXJsYWlkVGV4dCIpOwogICAgICB1bmRlcmxpbmUudGV4dENvbnRlbnQgPSBvdmVybGFpZFRleHQ7CiAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZCh1bmRlcmxpbmUpOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIFN0cmlrZU91dEFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgY29uc3RydWN0b3IocGFyYW1ldGVycykgewogICAgc3VwZXIocGFyYW1ldGVycywgewogICAgICBpc1JlbmRlcmFibGU6IHRydWUsCiAgICAgIGlnbm9yZUJvcmRlcjogdHJ1ZSwKICAgICAgY3JlYXRlUXVhZHJpbGF0ZXJhbHM6IHRydWUKICAgIH0pOwogIH0KICByZW5kZXIoKSB7CiAgICBjb25zdCB7CiAgICAgIGRhdGE6IHsKICAgICAgICBvdmVybGFpZFRleHQsCiAgICAgICAgcG9wdXBSZWYKICAgICAgfQogICAgfSA9IHRoaXM7CiAgICBpZiAoIXBvcHVwUmVmICYmIHRoaXMuaGFzUG9wdXBEYXRhKSB7CiAgICAgIHRoaXMuaGFzT3duQ29tbWVudEJ1dHRvbiA9IHRydWU7CiAgICAgIHRoaXMuX2NyZWF0ZVBvcHVwKCk7CiAgICB9CiAgICB0aGlzLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJzdHJpa2VvdXRBbm5vdGF0aW9uIik7CiAgICBpZiAob3ZlcmxhaWRUZXh0KSB7CiAgICAgIGNvbnN0IHN0cmlrZW91dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInMiKTsKICAgICAgc3RyaWtlb3V0LmNsYXNzTGlzdC5hZGQoIm92ZXJsYWlkVGV4dCIpOwogICAgICBzdHJpa2VvdXQudGV4dENvbnRlbnQgPSBvdmVybGFpZFRleHQ7CiAgICAgIHRoaXMuY29udGFpbmVyLmFwcGVuZChzdHJpa2VvdXQpOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29udGFpbmVyOwogIH0KfTsKdmFyIFN0YW1wQW5ub3RhdGlvbkVsZW1lbnQgPSBjbGFzcyBleHRlbmRzIEFubm90YXRpb25FbGVtZW50IHsKICBjb25zdHJ1Y3RvcihwYXJhbWV0ZXJzKSB7CiAgICBzdXBlcihwYXJhbWV0ZXJzLCB7CiAgICAgIGlzUmVuZGVyYWJsZTogdHJ1ZSwKICAgICAgaWdub3JlQm9yZGVyOiB0cnVlCiAgICB9KTsKICAgIHRoaXMuYW5ub3RhdGlvbkVkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5TVEFNUDsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgic3RhbXBBbm5vdGF0aW9uIik7CiAgICB0aGlzLmNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoInJvbGUiLCAiaW1nIik7CiAgICBpZiAoIXRoaXMuZGF0YS5wb3B1cFJlZiAmJiB0aGlzLmhhc1BvcHVwRGF0YSkgewogICAgICB0aGlzLmhhc093bkNvbW1lbnRCdXR0b24gPSB0cnVlOwogICAgICB0aGlzLl9jcmVhdGVQb3B1cCgpOwogICAgfQogICAgdGhpcy5fZWRpdE9uRG91YmxlQ2xpY2soKTsKICAgIHJldHVybiB0aGlzLmNvbnRhaW5lcjsKICB9Cn07CnZhciBGaWxlQXR0YWNobWVudEFubm90YXRpb25FbGVtZW50ID0gY2xhc3MgZXh0ZW5kcyBBbm5vdGF0aW9uRWxlbWVudCB7CiAgI3RyaWdnZXIgPSBudWxsOwogIGNvbnN0cnVjdG9yKHBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHBhcmFtZXRlcnMsIHsKICAgICAgaXNSZW5kZXJhYmxlOiB0cnVlCiAgICB9KTsKICAgIGNvbnN0IHsKICAgICAgZmlsZQogICAgfSA9IHRoaXMuZGF0YTsKICAgIHRoaXMuZmlsZW5hbWUgPSBmaWxlLmZpbGVuYW1lOwogICAgdGhpcy5jb250ZW50ID0gZmlsZS5jb250ZW50OwogICAgdGhpcy5saW5rU2VydmljZS5ldmVudEJ1cz8uZGlzcGF0Y2goImZpbGVhdHRhY2htZW50YW5ub3RhdGlvbiIsIHsKICAgICAgc291cmNlOiB0aGlzLAogICAgICAuLi5maWxlCiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiZmlsZUF0dGFjaG1lbnRBbm5vdGF0aW9uIik7CiAgICBjb25zdCB7CiAgICAgIGNvbnRhaW5lcjogY29udGFpbmVyMiwKICAgICAgZGF0YQogICAgfSA9IHRoaXM7CiAgICBsZXQgdHJpZ2dlcjsKICAgIGlmIChkYXRhLmhhc0FwcGVhcmFuY2UgfHwgZGF0YS5maWxsQWxwaGEgPT09IDApIHsKICAgICAgdHJpZ2dlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgfSBlbHNlIHsKICAgICAgdHJpZ2dlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICB0cmlnZ2VyLnNyYyA9IGAke3RoaXMuaW1hZ2VSZXNvdXJjZXNQYXRofWFubm90YXRpb24tJHsvcGFwZXJjbGlwL2kudGVzdChkYXRhLm5hbWUpID8gInBhcGVyY2xpcCIgOiAicHVzaHBpbiJ9LnN2Z2A7CiAgICAgIGlmIChkYXRhLmZpbGxBbHBoYSAmJiBkYXRhLmZpbGxBbHBoYSA8IDEpIHsKICAgICAgICB0cmlnZ2VyLnN0eWxlID0gYGZpbHRlcjogb3BhY2l0eSgke01hdGgucm91bmQoZGF0YS5maWxsQWxwaGEgKiAxMDApfSUpO2A7CiAgICAgIH0KICAgIH0KICAgIHRyaWdnZXIuYWRkRXZlbnRMaXN0ZW5lcigiZGJsY2xpY2siLCB0aGlzLiNkb3dubG9hZC5iaW5kKHRoaXMpKTsKICAgIHRoaXMuI3RyaWdnZXIgPSB0cmlnZ2VyOwogICAgY29uc3QgewogICAgICBpc01hYwogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICBjb250YWluZXIyLmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCAoZXZ0KSA9PiB7CiAgICAgIGlmIChldnQua2V5ID09PSAiRW50ZXIiICYmIChpc01hYyA/IGV2dC5tZXRhS2V5IDogZXZ0LmN0cmxLZXkpKSB7CiAgICAgICAgdGhpcy4jZG93bmxvYWQoKTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIWRhdGEucG9wdXBSZWYgJiYgdGhpcy5oYXNQb3B1cERhdGEpIHsKICAgICAgdGhpcy5oYXNPd25Db21tZW50QnV0dG9uID0gdHJ1ZTsKICAgICAgdGhpcy5fY3JlYXRlUG9wdXAoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRyaWdnZXIuY2xhc3NMaXN0LmFkZCgicG9wdXBUcmlnZ2VyQXJlYSIpOwogICAgfQogICAgY29udGFpbmVyMi5hcHBlbmQodHJpZ2dlcik7CiAgICByZXR1cm4gY29udGFpbmVyMjsKICB9CiAgZ2V0RWxlbWVudHNUb1RyaWdnZXJQb3B1cCgpIHsKICAgIHJldHVybiB0aGlzLiN0cmlnZ2VyOwogIH0KICBhZGRIaWdobGlnaHRBcmVhKCkgewogICAgdGhpcy5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgiaGlnaGxpZ2h0QXJlYSIpOwogIH0KICAjZG93bmxvYWQoKSB7CiAgICB0aGlzLmRvd25sb2FkTWFuYWdlcj8ub3Blbk9yRG93bmxvYWREYXRhKHRoaXMuY29udGVudCwgdGhpcy5maWxlbmFtZSk7CiAgfQp9Owp2YXIgQW5ub3RhdGlvbkxheWVyID0gY2xhc3MgX0Fubm90YXRpb25MYXllciB7CiAgI2FjY2Vzc2liaWxpdHlNYW5hZ2VyID0gbnVsbDsKICAjYW5ub3RhdGlvbkNhbnZhc01hcCA9IG51bGw7CiAgI2Fubm90YXRpb25TdG9yYWdlID0gbnVsbDsKICAjZWRpdGFibGVBbm5vdGF0aW9ucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI3N0cnVjdFRyZWVMYXllciA9IG51bGw7CiAgI2xpbmtTZXJ2aWNlID0gbnVsbDsKICAjZWxlbWVudHMgPSBbXTsKICAjaGFzQXJpYUF0dHJpYnV0ZXNGcm9tU3RydWN0VHJlZSA9IGZhbHNlOwogIGNvbnN0cnVjdG9yKHsKICAgIGRpdiwKICAgIGFjY2Vzc2liaWxpdHlNYW5hZ2VyLAogICAgYW5ub3RhdGlvbkNhbnZhc01hcCwKICAgIGFubm90YXRpb25FZGl0b3JVSU1hbmFnZXIsCiAgICBwYWdlLAogICAgdmlld3BvcnQsCiAgICBzdHJ1Y3RUcmVlTGF5ZXIsCiAgICBjb21tZW50TWFuYWdlciwKICAgIGxpbmtTZXJ2aWNlLAogICAgYW5ub3RhdGlvblN0b3JhZ2UKICB9KSB7CiAgICB0aGlzLmRpdiA9IGRpdjsKICAgIHRoaXMuI2FjY2Vzc2liaWxpdHlNYW5hZ2VyID0gYWNjZXNzaWJpbGl0eU1hbmFnZXI7CiAgICB0aGlzLiNhbm5vdGF0aW9uQ2FudmFzTWFwID0gYW5ub3RhdGlvbkNhbnZhc01hcDsKICAgIHRoaXMuI3N0cnVjdFRyZWVMYXllciA9IHN0cnVjdFRyZWVMYXllciB8fCBudWxsOwogICAgdGhpcy4jbGlua1NlcnZpY2UgPSBsaW5rU2VydmljZSB8fCBudWxsOwogICAgdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UgPSBhbm5vdGF0aW9uU3RvcmFnZSB8fCBuZXcgQW5ub3RhdGlvblN0b3JhZ2UoKTsKICAgIHRoaXMucGFnZSA9IHBhZ2U7CiAgICB0aGlzLnZpZXdwb3J0ID0gdmlld3BvcnQ7CiAgICB0aGlzLnpJbmRleCA9IDA7CiAgICB0aGlzLl9hbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyID0gYW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlcjsKICAgIHRoaXMuX2NvbW1lbnRNYW5hZ2VyID0gY29tbWVudE1hbmFnZXIgfHwgbnVsbDsKICB9CiAgaGFzRWRpdGFibGVBbm5vdGF0aW9ucygpIHsKICAgIHJldHVybiB0aGlzLiNlZGl0YWJsZUFubm90YXRpb25zLnNpemUgPiAwOwogIH0KICBhc3luYyByZW5kZXIocGFyYW1zKSB7CiAgICBjb25zdCB7CiAgICAgIGFubm90YXRpb25zCiAgICB9ID0gcGFyYW1zOwogICAgY29uc3QgbGF5ZXIgPSB0aGlzLmRpdjsKICAgIHNldExheWVyRGltZW5zaW9ucyhsYXllciwgdGhpcy52aWV3cG9ydCk7CiAgICBjb25zdCBwb3B1cFRvRWxlbWVudHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29uc3QgcG9wdXBBbm5vdGF0aW9ucyA9IFtdOwogICAgY29uc3QgZWxlbWVudFBhcmFtcyA9IHsKICAgICAgZGF0YTogbnVsbCwKICAgICAgbGF5ZXIsCiAgICAgIGxpbmtTZXJ2aWNlOiB0aGlzLiNsaW5rU2VydmljZSwKICAgICAgZG93bmxvYWRNYW5hZ2VyOiBwYXJhbXMuZG93bmxvYWRNYW5hZ2VyLAogICAgICBpbWFnZVJlc291cmNlc1BhdGg6IHBhcmFtcy5pbWFnZVJlc291cmNlc1BhdGggfHwgIiIsCiAgICAgIHJlbmRlckZvcm1zOiBwYXJhbXMucmVuZGVyRm9ybXMgIT09IGZhbHNlLAogICAgICBzdmdGYWN0b3J5OiBuZXcgRE9NU1ZHRmFjdG9yeSgpLAogICAgICBhbm5vdGF0aW9uU3RvcmFnZTogdGhpcy4jYW5ub3RhdGlvblN0b3JhZ2UsCiAgICAgIGVuYWJsZUNvbW1lbnQ6IHBhcmFtcy5lbmFibGVDb21tZW50ID09PSB0cnVlLAogICAgICBlbmFibGVTY3JpcHRpbmc6IHBhcmFtcy5lbmFibGVTY3JpcHRpbmcgPT09IHRydWUsCiAgICAgIGhhc0pTQWN0aW9uczogcGFyYW1zLmhhc0pTQWN0aW9ucywKICAgICAgZmllbGRPYmplY3RzOiBwYXJhbXMuZmllbGRPYmplY3RzLAogICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgIGVsZW1lbnRzOiBudWxsCiAgICB9OwogICAgZm9yIChjb25zdCBkYXRhIG9mIGFubm90YXRpb25zKSB7CiAgICAgIGlmIChkYXRhLm5vSFRNTCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IGlzUG9wdXBBbm5vdGF0aW9uID0gZGF0YS5hbm5vdGF0aW9uVHlwZSA9PT0gQW5ub3RhdGlvblR5cGUuUE9QVVA7CiAgICAgIGlmICghaXNQb3B1cEFubm90YXRpb24pIHsKICAgICAgICBpZiAoZGF0YS5yZWN0WzJdID09PSBkYXRhLnJlY3RbMF0gfHwgZGF0YS5yZWN0WzNdID09PSBkYXRhLnJlY3RbMV0pIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBlbGVtZW50cyA9IHBvcHVwVG9FbGVtZW50cy5nZXQoZGF0YS5pZCk7CiAgICAgICAgaWYgKCFlbGVtZW50cykgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5fY29tbWVudE1hbmFnZXIpIHsKICAgICAgICAgIHBvcHVwQW5ub3RhdGlvbnMucHVzaChkYXRhKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBlbGVtZW50UGFyYW1zLmVsZW1lbnRzID0gZWxlbWVudHM7CiAgICAgIH0KICAgICAgZWxlbWVudFBhcmFtcy5kYXRhID0gZGF0YTsKICAgICAgY29uc3QgZWxlbWVudCA9IEFubm90YXRpb25FbGVtZW50RmFjdG9yeS5jcmVhdGUoZWxlbWVudFBhcmFtcyk7CiAgICAgIGlmICghZWxlbWVudC5pc1JlbmRlcmFibGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoIWlzUG9wdXBBbm5vdGF0aW9uKSB7CiAgICAgICAgdGhpcy4jZWxlbWVudHMucHVzaChlbGVtZW50KTsKICAgICAgICBpZiAoZGF0YS5wb3B1cFJlZikgewogICAgICAgICAgY29uc3QgZWxlbWVudHMgPSBwb3B1cFRvRWxlbWVudHMuZ2V0KGRhdGEucG9wdXBSZWYpOwogICAgICAgICAgaWYgKCFlbGVtZW50cykgewogICAgICAgICAgICBwb3B1cFRvRWxlbWVudHMuc2V0KGRhdGEucG9wdXBSZWYsIFtlbGVtZW50XSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCByZW5kZXJlZCA9IGVsZW1lbnQucmVuZGVyKCk7CiAgICAgIGlmIChkYXRhLmhpZGRlbikgewogICAgICAgIHJlbmRlcmVkLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsKICAgICAgfQogICAgICBpZiAoZWxlbWVudC5faXNFZGl0YWJsZSkgewogICAgICAgIHRoaXMuI2VkaXRhYmxlQW5ub3RhdGlvbnMuc2V0KGVsZW1lbnQuZGF0YS5pZCwgZWxlbWVudCk7CiAgICAgICAgdGhpcy5fYW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlcj8ucmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoZWxlbWVudCk7CiAgICAgIH0KICAgIH0KICAgIGF3YWl0IHRoaXMuI2FkZEVsZW1lbnRzVG9ET00oKTsKICAgIGZvciAoY29uc3QgZGF0YSBvZiBwb3B1cEFubm90YXRpb25zKSB7CiAgICAgIGNvbnN0IGVsZW1lbnRzID0gZWxlbWVudFBhcmFtcy5lbGVtZW50cyA9IHBvcHVwVG9FbGVtZW50cy5nZXQoZGF0YS5pZCk7CiAgICAgIGVsZW1lbnRQYXJhbXMuZGF0YSA9IGRhdGE7CiAgICAgIGNvbnN0IGVsZW1lbnQgPSBBbm5vdGF0aW9uRWxlbWVudEZhY3RvcnkuY3JlYXRlKGVsZW1lbnRQYXJhbXMpOwogICAgICBpZiAoIWVsZW1lbnQuaXNSZW5kZXJhYmxlKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgcmVuZGVyZWQgPSBlbGVtZW50LnJlbmRlcigpOwogICAgICBlbGVtZW50LmNvbnRlbnRFbGVtZW50LmlkID0gYCR7QW5ub3RhdGlvblByZWZpeH0ke2RhdGEuaWR9YDsKICAgICAgaWYgKGRhdGEuaGlkZGVuKSB7CiAgICAgICAgcmVuZGVyZWQuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgICB9CiAgICAgIGVsZW1lbnRzLmF0KC0xKS5jb250YWluZXIuYWZ0ZXIocmVuZGVyZWQpOwogICAgfQogICAgdGhpcy4jc2V0QW5ub3RhdGlvbkNhbnZhc01hcCgpOwogIH0KICBhc3luYyAjYWRkRWxlbWVudHNUb0RPTSgpIHsKICAgIGlmICh0aGlzLiNlbGVtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5kaXYucmVwbGFjZUNoaWxkcmVuKCk7CiAgICBjb25zdCBwcm9taXNlcyA9IFtdOwogICAgaWYgKCF0aGlzLiNoYXNBcmlhQXR0cmlidXRlc0Zyb21TdHJ1Y3RUcmVlKSB7CiAgICAgIHRoaXMuI2hhc0FyaWFBdHRyaWJ1dGVzRnJvbVN0cnVjdFRyZWUgPSB0cnVlOwogICAgICBmb3IgKGNvbnN0IHsKICAgICAgICBjb250ZW50RWxlbWVudCwKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBpZAogICAgICAgIH0KICAgICAgfSBvZiB0aGlzLiNlbGVtZW50cykgewogICAgICAgIGNvbnN0IGFubm90YXRpb25JZCA9IGNvbnRlbnRFbGVtZW50LmlkID0gYCR7QW5ub3RhdGlvblByZWZpeH0ke2lkfWA7CiAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLiNzdHJ1Y3RUcmVlTGF5ZXI/LmdldEFyaWFBdHRyaWJ1dGVzKGFubm90YXRpb25JZCkudGhlbigoYXJpYUF0dHJpYnV0ZXMpID0+IHsKICAgICAgICAgIGlmIChhcmlhQXR0cmlidXRlcykgewogICAgICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBhcmlhQXR0cmlidXRlcykgewogICAgICAgICAgICAgIGNvbnRlbnRFbGVtZW50LnNldEF0dHJpYnV0ZShrZXksIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pKTsKICAgICAgfQogICAgfQogICAgdGhpcy4jZWxlbWVudHMuc29ydCgoewogICAgICBkYXRhOiB7CiAgICAgICAgcmVjdDogW2EwLCBhMSwgYTIsIGEzXQogICAgICB9CiAgICB9LCB7CiAgICAgIGRhdGE6IHsKICAgICAgICByZWN0OiBbYjAsIGIxLCBiMiwgYjNdCiAgICAgIH0KICAgIH0pID0+IHsKICAgICAgaWYgKGEwID09PSBhMiAmJiBhMSA9PT0gYTMpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYjAgPT09IGIyICYmIGIxID09PSBiMykgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgICBjb25zdCB0b3AxID0gYTM7CiAgICAgIGNvbnN0IGJvdDEgPSBhMTsKICAgICAgY29uc3QgbWlkMSA9IChhMSArIGEzKSAvIDI7CiAgICAgIGNvbnN0IHRvcDIgPSBiMzsKICAgICAgY29uc3QgYm90MiA9IGIxOwogICAgICBjb25zdCBtaWQyID0gKGIxICsgYjMpIC8gMjsKICAgICAgaWYgKG1pZDEgPj0gdG9wMiAmJiBtaWQyIDw9IGJvdDEpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgaWYgKG1pZDIgPj0gdG9wMSAmJiBtaWQxIDw9IGJvdDIpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBjb25zdCBjZW50ZXJYMSA9IChhMCArIGEyKSAvIDI7CiAgICAgIGNvbnN0IGNlbnRlclgyID0gKGIwICsgYjIpIC8gMjsKICAgICAgcmV0dXJuIGNlbnRlclgxIC0gY2VudGVyWDI7CiAgICB9KTsKICAgIGNvbnN0IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMuI2VsZW1lbnRzKSB7CiAgICAgIGZyYWdtZW50LmFwcGVuZChlbGVtZW50LmNvbnRhaW5lcik7CiAgICAgIGlmICh0aGlzLl9jb21tZW50TWFuYWdlcikgewogICAgICAgIChlbGVtZW50LmV4dHJhUG9wdXBFbGVtZW50Py5wb3B1cCB8fCBlbGVtZW50LnBvcHVwKT8ucmVuZGVyQ29tbWVudEJ1dHRvbigpOwogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZXh0cmFQb3B1cEVsZW1lbnQpIHsKICAgICAgICBmcmFnbWVudC5hcHBlbmQoZWxlbWVudC5leHRyYVBvcHVwRWxlbWVudC5yZW5kZXIoKSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZGl2LmFwcGVuZChmcmFnbWVudCk7CiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7CiAgICBpZiAodGhpcy4jYWNjZXNzaWJpbGl0eU1hbmFnZXIpIHsKICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMuI2VsZW1lbnRzKSB7CiAgICAgICAgdGhpcy4jYWNjZXNzaWJpbGl0eU1hbmFnZXIuYWRkUG9pbnRlckluVGV4dExheWVyKGVsZW1lbnQuY29udGVudEVsZW1lbnQsIGZhbHNlKTsKICAgICAgfQogICAgfQogIH0KICBhc3luYyBhZGRMaW5rQW5ub3RhdGlvbnMoYW5ub3RhdGlvbnMpIHsKICAgIGNvbnN0IGVsZW1lbnRQYXJhbXMgPSB7CiAgICAgIGRhdGE6IG51bGwsCiAgICAgIGxheWVyOiB0aGlzLmRpdiwKICAgICAgbGlua1NlcnZpY2U6IHRoaXMuI2xpbmtTZXJ2aWNlLAogICAgICBzdmdGYWN0b3J5OiBuZXcgRE9NU1ZHRmFjdG9yeSgpLAogICAgICBwYXJlbnQ6IHRoaXMKICAgIH07CiAgICBmb3IgKGNvbnN0IGRhdGEgb2YgYW5ub3RhdGlvbnMpIHsKICAgICAgZGF0YS5ib3JkZXJTdHlsZSB8fD0gX0Fubm90YXRpb25MYXllci5fZGVmYXVsdEJvcmRlclN0eWxlOwogICAgICBlbGVtZW50UGFyYW1zLmRhdGEgPSBkYXRhOwogICAgICBjb25zdCBlbGVtZW50ID0gQW5ub3RhdGlvbkVsZW1lbnRGYWN0b3J5LmNyZWF0ZShlbGVtZW50UGFyYW1zKTsKICAgICAgaWYgKCFlbGVtZW50LmlzUmVuZGVyYWJsZSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGVsZW1lbnQucmVuZGVyKCk7CiAgICAgIGVsZW1lbnQuY29udGVudEVsZW1lbnQuaWQgPSBgJHtBbm5vdGF0aW9uUHJlZml4fSR7ZGF0YS5pZH1gOwogICAgICB0aGlzLiNlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgfQogICAgYXdhaXQgdGhpcy4jYWRkRWxlbWVudHNUb0RPTSgpOwogIH0KICB1cGRhdGUoewogICAgdmlld3BvcnQKICB9KSB7CiAgICBjb25zdCBsYXllciA9IHRoaXMuZGl2OwogICAgdGhpcy52aWV3cG9ydCA9IHZpZXdwb3J0OwogICAgc2V0TGF5ZXJEaW1lbnNpb25zKGxheWVyLCB7CiAgICAgIHJvdGF0aW9uOiB2aWV3cG9ydC5yb3RhdGlvbgogICAgfSk7CiAgICB0aGlzLiNzZXRBbm5vdGF0aW9uQ2FudmFzTWFwKCk7CiAgICBsYXllci5oaWRkZW4gPSBmYWxzZTsKICB9CiAgI3NldEFubm90YXRpb25DYW52YXNNYXAoKSB7CiAgICBpZiAoIXRoaXMuI2Fubm90YXRpb25DYW52YXNNYXApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgbGF5ZXIgPSB0aGlzLmRpdjsKICAgIGZvciAoY29uc3QgW2lkLCBjYW52YXNdIG9mIHRoaXMuI2Fubm90YXRpb25DYW52YXNNYXApIHsKICAgICAgY29uc3QgZWxlbWVudCA9IGxheWVyLnF1ZXJ5U2VsZWN0b3IoYFtkYXRhLWFubm90YXRpb24taWQ9IiR7aWR9Il1gKTsKICAgICAgaWYgKCFlbGVtZW50KSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY2FudmFzLmNsYXNzTmFtZSA9ICJhbm5vdGF0aW9uQ29udGVudCI7CiAgICAgIGNvbnN0IHsKICAgICAgICBmaXJzdENoaWxkCiAgICAgIH0gPSBlbGVtZW50OwogICAgICBpZiAoIWZpcnN0Q2hpbGQpIHsKICAgICAgICBlbGVtZW50LmFwcGVuZChjYW52YXMpOwogICAgICB9IGVsc2UgaWYgKGZpcnN0Q2hpbGQubm9kZU5hbWUgPT09ICJDQU5WQVMiKSB7CiAgICAgICAgZmlyc3RDaGlsZC5yZXBsYWNlV2l0aChjYW52YXMpOwogICAgICB9IGVsc2UgaWYgKCFmaXJzdENoaWxkLmNsYXNzTGlzdC5jb250YWlucygiYW5ub3RhdGlvbkNvbnRlbnQiKSkgewogICAgICAgIGZpcnN0Q2hpbGQuYmVmb3JlKGNhbnZhcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZmlyc3RDaGlsZC5hZnRlcihjYW52YXMpOwogICAgICB9CiAgICAgIGNvbnN0IGVkaXRhYmxlQW5ub3RhdGlvbiA9IHRoaXMuI2VkaXRhYmxlQW5ub3RhdGlvbnMuZ2V0KGlkKTsKICAgICAgaWYgKCFlZGl0YWJsZUFubm90YXRpb24pIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAoZWRpdGFibGVBbm5vdGF0aW9uLl9oYXNOb0NhbnZhcykgewogICAgICAgIHRoaXMuX2Fubm90YXRpb25FZGl0b3JVSU1hbmFnZXI/LnNldE1pc3NpbmdDYW52YXMoaWQsIGVsZW1lbnQuaWQsIGNhbnZhcyk7CiAgICAgICAgZWRpdGFibGVBbm5vdGF0aW9uLl9oYXNOb0NhbnZhcyA9IGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGVkaXRhYmxlQW5ub3RhdGlvbi5jYW52YXMgPSBjYW52YXM7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2Fubm90YXRpb25DYW52YXNNYXAuY2xlYXIoKTsKICB9CiAgZ2V0RWRpdGFibGVBbm5vdGF0aW9ucygpIHsKICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuI2VkaXRhYmxlQW5ub3RhdGlvbnMudmFsdWVzKCkpOwogIH0KICBnZXRFZGl0YWJsZUFubm90YXRpb24oaWQpIHsKICAgIHJldHVybiB0aGlzLiNlZGl0YWJsZUFubm90YXRpb25zLmdldChpZCk7CiAgfQogIGFkZEZha2VBbm5vdGF0aW9uKGVkaXRvcikgewogICAgY29uc3QgewogICAgICBkaXYKICAgIH0gPSB0aGlzOwogICAgY29uc3QgewogICAgICBpZCwKICAgICAgcm90YXRpb24KICAgIH0gPSBlZGl0b3I7CiAgICBjb25zdCBlbGVtZW50ID0gbmV3IEVkaXRvckFubm90YXRpb25FbGVtZW50KHsKICAgICAgZGF0YTogewogICAgICAgIGlkLAogICAgICAgIHJlY3Q6IGVkaXRvci5nZXRQREZSZWN0KCksCiAgICAgICAgcm90YXRpb24KICAgICAgfSwKICAgICAgZWRpdG9yLAogICAgICBsYXllcjogZGl2LAogICAgICBwYXJlbnQ6IHRoaXMsCiAgICAgIGVuYWJsZUNvbW1lbnQ6ICEhdGhpcy5fY29tbWVudE1hbmFnZXIsCiAgICAgIGxpbmtTZXJ2aWNlOiB0aGlzLiNsaW5rU2VydmljZSwKICAgICAgYW5ub3RhdGlvblN0b3JhZ2U6IHRoaXMuI2Fubm90YXRpb25TdG9yYWdlCiAgICB9KTsKICAgIGVsZW1lbnQucmVuZGVyKCk7CiAgICBlbGVtZW50LmNvbnRlbnRFbGVtZW50LmlkID0gYCR7QW5ub3RhdGlvblByZWZpeH0ke2lkfWA7CiAgICBlbGVtZW50LmNyZWF0ZU9yVXBkYXRlUG9wdXAoKTsKICAgIHRoaXMuI2VsZW1lbnRzLnB1c2goZWxlbWVudCk7CiAgICByZXR1cm4gZWxlbWVudDsKICB9CiAgcmVtb3ZlQW5ub3RhdGlvbihpZCkgewogICAgY29uc3QgaW5kZXggPSB0aGlzLiNlbGVtZW50cy5maW5kSW5kZXgoKGVsKSA9PiBlbC5kYXRhLmlkID09PSBpZCk7CiAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IFtlbGVtZW50XSA9IHRoaXMuI2VsZW1lbnRzLnNwbGljZShpbmRleCwgMSk7CiAgICB0aGlzLiNhY2Nlc3NpYmlsaXR5TWFuYWdlcj8ucmVtb3ZlUG9pbnRlckluVGV4dExheWVyKGVsZW1lbnQuY29udGVudEVsZW1lbnQpOwogIH0KICB1cGRhdGVGYWtlQW5ub3RhdGlvbnMoZWRpdG9ycykgewogICAgaWYgKGVkaXRvcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGVkaXRvcnMpIHsKICAgICAgZWRpdG9yLnVwZGF0ZUZha2VBbm5vdGF0aW9uRWxlbWVudCh0aGlzKTsKICAgIH0KICAgIHRoaXMuI2FkZEVsZW1lbnRzVG9ET00oKTsKICB9CiAgdG9nZ2xlUG9pbnRlckV2ZW50cyhlbmFibGVkID0gZmFsc2UpIHsKICAgIHRoaXMuZGl2LmNsYXNzTGlzdC50b2dnbGUoImRpc2FibGVkIiwgIWVuYWJsZWQpOwogIH0KICBzdGF0aWMgZ2V0IF9kZWZhdWx0Qm9yZGVyU3R5bGUoKSB7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfZGVmYXVsdEJvcmRlclN0eWxlIiwgT2JqZWN0LmZyZWV6ZSh7CiAgICAgIHdpZHRoOiAxLAogICAgICByYXdXaWR0aDogMSwKICAgICAgc3R5bGU6IEFubm90YXRpb25Cb3JkZXJTdHlsZVR5cGUuU09MSUQsCiAgICAgIGRhc2hBcnJheTogWzNdLAogICAgICBob3Jpem9udGFsQ29ybmVyUmFkaXVzOiAwLAogICAgICB2ZXJ0aWNhbENvcm5lclJhZGl1czogMAogICAgfSkpOwogIH0KfTsKdmFyIEVPTF9QQVRURVJOID0gL1xyXG4/fFxuL2c7CnZhciBGcmVlVGV4dEVkaXRvciA9IGNsYXNzIF9GcmVlVGV4dEVkaXRvciBleHRlbmRzIEFubm90YXRpb25FZGl0b3IgewogICNjb250ZW50ID0gIiI7CiAgI2VkaXRvckRpdklkID0gYCR7dGhpcy5pZH0tZWRpdG9yYDsKICAjZWRpdE1vZGVBQyA9IG51bGw7CiAgI2ZvbnRTaXplOwogIF9jb2xvclBpY2tlciA9IG51bGw7CiAgc3RhdGljIF9mcmVlVGV4dERlZmF1bHRDb250ZW50ID0gIiI7CiAgc3RhdGljIF9pbnRlcm5hbFBhZGRpbmcgPSAwOwogIHN0YXRpYyBfZGVmYXVsdENvbG9yID0gbnVsbDsKICBzdGF0aWMgX2RlZmF1bHRGb250U2l6ZSA9IDEwOwogIHN0YXRpYyBnZXQgX2tleWJvYXJkTWFuYWdlcigpIHsKICAgIGNvbnN0IHByb3RvID0gX0ZyZWVUZXh0RWRpdG9yLnByb3RvdHlwZTsKICAgIGNvbnN0IGFycm93Q2hlY2tlciA9IChzZWxmKSA9PiBzZWxmLmlzRW1wdHkoKTsKICAgIGNvbnN0IHNtYWxsID0gQW5ub3RhdGlvbkVkaXRvclVJTWFuYWdlci5UUkFOU0xBVEVfU01BTEw7CiAgICBjb25zdCBiaWcgPSBBbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyLlRSQU5TTEFURV9CSUc7CiAgICByZXR1cm4gc2hhZG93KHRoaXMsICJfa2V5Ym9hcmRNYW5hZ2VyIiwgbmV3IEtleWJvYXJkTWFuYWdlcihbW1siY3RybCtzIiwgIm1hYyttZXRhK3MiLCAiY3RybCtwIiwgIm1hYyttZXRhK3AiXSwgcHJvdG8uY29tbWl0T3JSZW1vdmUsIHsKICAgICAgYnViYmxlczogdHJ1ZQogICAgfV0sIFtbImN0cmwrRW50ZXIiLCAibWFjK21ldGErRW50ZXIiLCAiRXNjYXBlIiwgIm1hYytFc2NhcGUiXSwgcHJvdG8uY29tbWl0T3JSZW1vdmVdLCBbWyJBcnJvd0xlZnQiLCAibWFjK0Fycm93TGVmdCJdLCBwcm90by5fdHJhbnNsYXRlRW1wdHksIHsKICAgICAgYXJnczogWy1zbWFsbCwgMF0sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbImN0cmwrQXJyb3dMZWZ0IiwgIm1hYytzaGlmdCtBcnJvd0xlZnQiXSwgcHJvdG8uX3RyYW5zbGF0ZUVtcHR5LCB7CiAgICAgIGFyZ3M6IFstYmlnLCAwXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siQXJyb3dSaWdodCIsICJtYWMrQXJyb3dSaWdodCJdLCBwcm90by5fdHJhbnNsYXRlRW1wdHksIHsKICAgICAgYXJnczogW3NtYWxsLCAwXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siY3RybCtBcnJvd1JpZ2h0IiwgIm1hYytzaGlmdCtBcnJvd1JpZ2h0Il0sIHByb3RvLl90cmFuc2xhdGVFbXB0eSwgewogICAgICBhcmdzOiBbYmlnLCAwXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siQXJyb3dVcCIsICJtYWMrQXJyb3dVcCJdLCBwcm90by5fdHJhbnNsYXRlRW1wdHksIHsKICAgICAgYXJnczogWzAsIC1zbWFsbF0sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV0sIFtbImN0cmwrQXJyb3dVcCIsICJtYWMrc2hpZnQrQXJyb3dVcCJdLCBwcm90by5fdHJhbnNsYXRlRW1wdHksIHsKICAgICAgYXJnczogWzAsIC1iaWddLAogICAgICBjaGVja2VyOiBhcnJvd0NoZWNrZXIKICAgIH1dLCBbWyJBcnJvd0Rvd24iLCAibWFjK0Fycm93RG93biJdLCBwcm90by5fdHJhbnNsYXRlRW1wdHksIHsKICAgICAgYXJnczogWzAsIHNtYWxsXSwKICAgICAgY2hlY2tlcjogYXJyb3dDaGVja2VyCiAgICB9XSwgW1siY3RybCtBcnJvd0Rvd24iLCAibWFjK3NoaWZ0K0Fycm93RG93biJdLCBwcm90by5fdHJhbnNsYXRlRW1wdHksIHsKICAgICAgYXJnczogWzAsIGJpZ10sCiAgICAgIGNoZWNrZXI6IGFycm93Q2hlY2tlcgogICAgfV1dKSk7CiAgfQogIHN0YXRpYyBfdHlwZSA9ICJmcmVldGV4dCI7CiAgc3RhdGljIF9lZGl0b3JUeXBlID0gQW5ub3RhdGlvbkVkaXRvclR5cGUuRlJFRVRFWFQ7CiAgY29uc3RydWN0b3IocGFyYW1zKSB7CiAgICBzdXBlcih7CiAgICAgIC4uLnBhcmFtcywKICAgICAgbmFtZTogImZyZWVUZXh0RWRpdG9yIgogICAgfSk7CiAgICB0aGlzLmNvbG9yID0gcGFyYW1zLmNvbG9yIHx8IF9GcmVlVGV4dEVkaXRvci5fZGVmYXVsdENvbG9yIHx8IEFubm90YXRpb25FZGl0b3IuX2RlZmF1bHRMaW5lQ29sb3I7CiAgICB0aGlzLiNmb250U2l6ZSA9IHBhcmFtcy5mb250U2l6ZSB8fCBfRnJlZVRleHRFZGl0b3IuX2RlZmF1bHRGb250U2l6ZTsKICAgIGlmICghdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5hMTF5QWxlcnQoInBkZmpzLWVkaXRvci1mcmVldGV4dC1hZGRlZC1hbGVydCIpOwogICAgfQogICAgdGhpcy5jYW5BZGRDb21tZW50ID0gZmFsc2U7CiAgfQogIHN0YXRpYyBpbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcikgewogICAgQW5ub3RhdGlvbkVkaXRvci5pbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcik7CiAgICBjb25zdCBzdHlsZSA9IGdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTsKICAgIHRoaXMuX2ludGVybmFsUGFkZGluZyA9IHBhcnNlRmxvYXQoc3R5bGUuZ2V0UHJvcGVydHlWYWx1ZSgiLS1mcmVldGV4dC1wYWRkaW5nIikpOwogIH0KICBzdGF0aWMgdXBkYXRlRGVmYXVsdFBhcmFtcyh0eXBlLCB2YWx1ZSkgewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRlJFRVRFWFRfU0laRToKICAgICAgICBfRnJlZVRleHRFZGl0b3IuX2RlZmF1bHRGb250U2l6ZSA9IHZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkZSRUVURVhUX0NPTE9SOgogICAgICAgIF9GcmVlVGV4dEVkaXRvci5fZGVmYXVsdENvbG9yID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHVwZGF0ZVBhcmFtcyh0eXBlLCB2YWx1ZSkgewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRlJFRVRFWFRfU0laRToKICAgICAgICB0aGlzLiN1cGRhdGVGb250U2l6ZSh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRlJFRVRFWFRfQ09MT1I6CiAgICAgICAgdGhpcy4jdXBkYXRlQ29sb3IodmFsdWUpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICBzdGF0aWMgZ2V0IGRlZmF1bHRQcm9wZXJ0aWVzVG9VcGRhdGUoKSB7CiAgICByZXR1cm4gW1tBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9TSVpFLCBfRnJlZVRleHRFZGl0b3IuX2RlZmF1bHRGb250U2l6ZV0sIFtBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9DT0xPUiwgX0ZyZWVUZXh0RWRpdG9yLl9kZWZhdWx0Q29sb3IgfHwgQW5ub3RhdGlvbkVkaXRvci5fZGVmYXVsdExpbmVDb2xvcl1dOwogIH0KICBnZXQgcHJvcGVydGllc1RvVXBkYXRlKCkgewogICAgcmV0dXJuIFtbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRlJFRVRFWFRfU0laRSwgdGhpcy4jZm9udFNpemVdLCBbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRlJFRVRFWFRfQ09MT1IsIHRoaXMuY29sb3JdXTsKICB9CiAgZ2V0IHRvb2xiYXJCdXR0b25zKCkgewogICAgdGhpcy5fY29sb3JQaWNrZXIgfHw9IG5ldyBCYXNpY0NvbG9yUGlja2VyKHRoaXMpOwogICAgcmV0dXJuIFtbImNvbG9yUGlja2VyIiwgdGhpcy5fY29sb3JQaWNrZXJdXTsKICB9CiAgZ2V0IGNvbG9yVHlwZSgpIHsKICAgIHJldHVybiBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9DT0xPUjsKICB9CiAgI3VwZGF0ZUZvbnRTaXplKGZvbnRTaXplKSB7CiAgICBjb25zdCBzZXRGb250c2l6ZSA9IChzaXplKSA9PiB7CiAgICAgIHRoaXMuZWRpdG9yRGl2LnN0eWxlLmZvbnRTaXplID0gYGNhbGMoJHtzaXplfXB4ICogdmFyKC0tdG90YWwtc2NhbGUtZmFjdG9yKSlgOwogICAgICB0aGlzLnRyYW5zbGF0ZSgwLCAtKHNpemUgLSB0aGlzLiNmb250U2l6ZSkgKiB0aGlzLnBhcmVudFNjYWxlKTsKICAgICAgdGhpcy4jZm9udFNpemUgPSBzaXplOwogICAgICB0aGlzLiNzZXRFZGl0b3JEaW1lbnNpb25zKCk7CiAgICB9OwogICAgY29uc3Qgc2F2ZWRGb250c2l6ZSA9IHRoaXMuI2ZvbnRTaXplOwogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZDogc2V0Rm9udHNpemUuYmluZCh0aGlzLCBmb250U2l6ZSksCiAgICAgIHVuZG86IHNldEZvbnRzaXplLmJpbmQodGhpcywgc2F2ZWRGb250c2l6ZSksCiAgICAgIHBvc3Q6IHRoaXMuX3VpTWFuYWdlci51cGRhdGVVSS5iaW5kKHRoaXMuX3VpTWFuYWdlciwgdGhpcyksCiAgICAgIG11c3RFeGVjOiB0cnVlLAogICAgICB0eXBlOiBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5GUkVFVEVYVF9TSVpFLAogICAgICBvdmVyd3JpdGVJZlNhbWVUeXBlOiB0cnVlLAogICAgICBrZWVwVW5kbzogdHJ1ZQogICAgfSk7CiAgfQogIG9uVXBkYXRlZENvbG9yKCkgewogICAgdGhpcy5lZGl0b3JEaXYuc3R5bGUuY29sb3IgPSB0aGlzLmNvbG9yOwogICAgdGhpcy5fY29sb3JQaWNrZXI/LnVwZGF0ZSh0aGlzLmNvbG9yKTsKICAgIHN1cGVyLm9uVXBkYXRlZENvbG9yKCk7CiAgfQogICN1cGRhdGVDb2xvcihjb2xvcikgewogICAgY29uc3Qgc2V0Q29sb3IgPSAoY29sKSA9PiB7CiAgICAgIHRoaXMuY29sb3IgPSBjb2w7CiAgICAgIHRoaXMub25VcGRhdGVkQ29sb3IoKTsKICAgIH07CiAgICBjb25zdCBzYXZlZENvbG9yID0gdGhpcy5jb2xvcjsKICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICBjbWQ6IHNldENvbG9yLmJpbmQodGhpcywgY29sb3IpLAogICAgICB1bmRvOiBzZXRDb2xvci5iaW5kKHRoaXMsIHNhdmVkQ29sb3IpLAogICAgICBwb3N0OiB0aGlzLl91aU1hbmFnZXIudXBkYXRlVUkuYmluZCh0aGlzLl91aU1hbmFnZXIsIHRoaXMpLAogICAgICBtdXN0RXhlYzogdHJ1ZSwKICAgICAgdHlwZTogQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRlJFRVRFWFRfQ09MT1IsCiAgICAgIG92ZXJ3cml0ZUlmU2FtZVR5cGU6IHRydWUsCiAgICAgIGtlZXBVbmRvOiB0cnVlCiAgICB9KTsKICB9CiAgX3RyYW5zbGF0ZUVtcHR5KHgsIHkpIHsKICAgIHRoaXMuX3VpTWFuYWdlci50cmFuc2xhdGVTZWxlY3RlZEVkaXRvcnMoeCwgeSwgdHJ1ZSk7CiAgfQogIGdldEluaXRpYWxUcmFuc2xhdGlvbigpIHsKICAgIGNvbnN0IHNjYWxlID0gdGhpcy5wYXJlbnRTY2FsZTsKICAgIHJldHVybiBbLV9GcmVlVGV4dEVkaXRvci5faW50ZXJuYWxQYWRkaW5nICogc2NhbGUsIC0oX0ZyZWVUZXh0RWRpdG9yLl9pbnRlcm5hbFBhZGRpbmcgKyB0aGlzLiNmb250U2l6ZSkgKiBzY2FsZV07CiAgfQogIHJlYnVpbGQoKSB7CiAgICBpZiAoIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN1cGVyLnJlYnVpbGQoKTsKICAgIGlmICh0aGlzLmRpdiA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIHRoaXMucGFyZW50LmFkZCh0aGlzKTsKICAgIH0KICB9CiAgZW5hYmxlRWRpdE1vZGUoKSB7CiAgICBpZiAoIXN1cGVyLmVuYWJsZUVkaXRNb2RlKCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5vdmVybGF5RGl2LmNsYXNzTGlzdC5yZW1vdmUoImVuYWJsZWQiKTsKICAgIHRoaXMuZWRpdG9yRGl2LmNvbnRlbnRFZGl0YWJsZSA9IHRydWU7CiAgICB0aGlzLl9pc0RyYWdnYWJsZSA9IGZhbHNlOwogICAgdGhpcy5kaXYucmVtb3ZlQXR0cmlidXRlKCJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiKTsKICAgIHRoaXMuI2VkaXRNb2RlQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLl91aU1hbmFnZXIuY29tYmluZWRTaWduYWwodGhpcy4jZWRpdE1vZGVBQyk7CiAgICB0aGlzLmVkaXRvckRpdi5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5lZGl0b3JEaXZLZXlkb3duLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuZWRpdG9yRGl2LmFkZEV2ZW50TGlzdGVuZXIoImZvY3VzIiwgdGhpcy5lZGl0b3JEaXZGb2N1cy5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0aGlzLmVkaXRvckRpdi5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgdGhpcy5lZGl0b3JEaXZCbHVyLmJpbmQodGhpcyksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuZWRpdG9yRGl2LmFkZEV2ZW50TGlzdGVuZXIoImlucHV0IiwgdGhpcy5lZGl0b3JEaXZJbnB1dC5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0aGlzLmVkaXRvckRpdi5hZGRFdmVudExpc3RlbmVyKCJwYXN0ZSIsIHRoaXMuZWRpdG9yRGl2UGFzdGUuYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgcmV0dXJuIHRydWU7CiAgfQogIGRpc2FibGVFZGl0TW9kZSgpIHsKICAgIGlmICghc3VwZXIuZGlzYWJsZUVkaXRNb2RlKCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5vdmVybGF5RGl2LmNsYXNzTGlzdC5hZGQoImVuYWJsZWQiKTsKICAgIHRoaXMuZWRpdG9yRGl2LmNvbnRlbnRFZGl0YWJsZSA9IGZhbHNlOwogICAgdGhpcy5kaXYuc2V0QXR0cmlidXRlKCJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLCB0aGlzLiNlZGl0b3JEaXZJZCk7CiAgICB0aGlzLl9pc0RyYWdnYWJsZSA9IHRydWU7CiAgICB0aGlzLiNlZGl0TW9kZUFDPy5hYm9ydCgpOwogICAgdGhpcy4jZWRpdE1vZGVBQyA9IG51bGw7CiAgICB0aGlzLmRpdi5mb2N1cyh7CiAgICAgIHByZXZlbnRTY3JvbGw6IHRydWUKICAgIH0pOwogICAgdGhpcy5pc0VkaXRpbmcgPSBmYWxzZTsKICAgIHRoaXMucGFyZW50LmRpdi5jbGFzc0xpc3QuYWRkKCJmcmVldGV4dEVkaXRpbmciKTsKICAgIHJldHVybiB0cnVlOwogIH0KICBmb2N1c2luKGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuX2ZvY3VzRXZlbnRzQWxsb3dlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5mb2N1c2luKGV2ZW50KTsKICAgIGlmIChldmVudC50YXJnZXQgIT09IHRoaXMuZWRpdG9yRGl2KSB7CiAgICAgIHRoaXMuZWRpdG9yRGl2LmZvY3VzKCk7CiAgICB9CiAgfQogIG9uY2VBZGRlZChmb2N1cykgewogICAgaWYgKHRoaXMud2lkdGgpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5lbmFibGVFZGl0TW9kZSgpOwogICAgaWYgKGZvY3VzKSB7CiAgICAgIHRoaXMuZWRpdG9yRGl2LmZvY3VzKCk7CiAgICB9CiAgICBpZiAodGhpcy5faW5pdGlhbE9wdGlvbnM/LmlzQ2VudGVyZWQpIHsKICAgICAgdGhpcy5jZW50ZXIoKTsKICAgIH0KICAgIHRoaXMuX2luaXRpYWxPcHRpb25zID0gbnVsbDsKICB9CiAgaXNFbXB0eSgpIHsKICAgIHJldHVybiAhdGhpcy5lZGl0b3JEaXYgfHwgdGhpcy5lZGl0b3JEaXYuaW5uZXJUZXh0LnRyaW0oKSA9PT0gIiI7CiAgfQogIHJlbW92ZSgpIHsKICAgIHRoaXMuaXNFZGl0aW5nID0gZmFsc2U7CiAgICBpZiAodGhpcy5wYXJlbnQpIHsKICAgICAgdGhpcy5wYXJlbnQuc2V0RWRpdGluZ1N0YXRlKHRydWUpOwogICAgICB0aGlzLnBhcmVudC5kaXYuY2xhc3NMaXN0LmFkZCgiZnJlZXRleHRFZGl0aW5nIik7CiAgICB9CiAgICBzdXBlci5yZW1vdmUoKTsKICB9CiAgI2V4dHJhY3RUZXh0KCkgewogICAgY29uc3QgYnVmZmVyID0gW107CiAgICB0aGlzLmVkaXRvckRpdi5ub3JtYWxpemUoKTsKICAgIGxldCBwcmV2Q2hpbGQgPSBudWxsOwogICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmVkaXRvckRpdi5jaGlsZE5vZGVzKSB7CiAgICAgIGlmIChwcmV2Q2hpbGQ/Lm5vZGVUeXBlID09PSBOb2RlLlRFWFRfTk9ERSAmJiBjaGlsZC5ub2RlTmFtZSA9PT0gIkJSIikgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGJ1ZmZlci5wdXNoKF9GcmVlVGV4dEVkaXRvci4jZ2V0Tm9kZUNvbnRlbnQoY2hpbGQpKTsKICAgICAgcHJldkNoaWxkID0gY2hpbGQ7CiAgICB9CiAgICByZXR1cm4gYnVmZmVyLmpvaW4oIlxuIik7CiAgfQogICNzZXRFZGl0b3JEaW1lbnNpb25zKCkgewogICAgY29uc3QgW3BhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdID0gdGhpcy5wYXJlbnREaW1lbnNpb25zOwogICAgbGV0IHJlY3Q7CiAgICBpZiAodGhpcy5pc0F0dGFjaGVkVG9ET00pIHsKICAgICAgcmVjdCA9IHRoaXMuZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgewogICAgICAgIGN1cnJlbnRMYXllciwKICAgICAgICBkaXYKICAgICAgfSA9IHRoaXM7CiAgICAgIGNvbnN0IHNhdmVkRGlzcGxheSA9IGRpdi5zdHlsZS5kaXNwbGF5OwogICAgICBjb25zdCBzYXZlZFZpc2liaWxpdHkgPSBkaXYuY2xhc3NMaXN0LmNvbnRhaW5zKCJoaWRkZW4iKTsKICAgICAgZGl2LmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgICBkaXYuc3R5bGUuZGlzcGxheSA9ICJoaWRkZW4iOwogICAgICBjdXJyZW50TGF5ZXIuZGl2LmFwcGVuZCh0aGlzLmRpdik7CiAgICAgIHJlY3QgPSBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIGRpdi5yZW1vdmUoKTsKICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSBzYXZlZERpc3BsYXk7CiAgICAgIGRpdi5jbGFzc0xpc3QudG9nZ2xlKCJoaWRkZW4iLCBzYXZlZFZpc2liaWxpdHkpOwogICAgfQogICAgaWYgKHRoaXMucm90YXRpb24gJSAxODAgPT09IHRoaXMucGFyZW50Um90YXRpb24gJSAxODApIHsKICAgICAgdGhpcy53aWR0aCA9IHJlY3Qud2lkdGggLyBwYXJlbnRXaWR0aDsKICAgICAgdGhpcy5oZWlnaHQgPSByZWN0LmhlaWdodCAvIHBhcmVudEhlaWdodDsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMud2lkdGggPSByZWN0LmhlaWdodCAvIHBhcmVudFdpZHRoOwogICAgICB0aGlzLmhlaWdodCA9IHJlY3Qud2lkdGggLyBwYXJlbnRIZWlnaHQ7CiAgICB9CiAgICB0aGlzLmZpeEFuZFNldFBvc2l0aW9uKCk7CiAgfQogIGNvbW1pdCgpIHsKICAgIGlmICghdGhpcy5pc0luRWRpdE1vZGUoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5jb21taXQoKTsKICAgIHRoaXMuZGlzYWJsZUVkaXRNb2RlKCk7CiAgICBjb25zdCBzYXZlZFRleHQgPSB0aGlzLiNjb250ZW50OwogICAgY29uc3QgbmV3VGV4dCA9IHRoaXMuI2NvbnRlbnQgPSB0aGlzLiNleHRyYWN0VGV4dCgpLnRyaW1FbmQoKTsKICAgIGlmIChzYXZlZFRleHQgPT09IG5ld1RleHQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgc2V0VGV4dCA9ICh0ZXh0KSA9PiB7CiAgICAgIHRoaXMuI2NvbnRlbnQgPSB0ZXh0OwogICAgICBpZiAoIXRleHQpIHsKICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLiNzZXRDb250ZW50KCk7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5yZWJ1aWxkKHRoaXMpOwogICAgICB0aGlzLiNzZXRFZGl0b3JEaW1lbnNpb25zKCk7CiAgICB9OwogICAgdGhpcy5hZGRDb21tYW5kcyh7CiAgICAgIGNtZDogKCkgPT4gewogICAgICAgIHNldFRleHQobmV3VGV4dCk7CiAgICAgIH0sCiAgICAgIHVuZG86ICgpID0+IHsKICAgICAgICBzZXRUZXh0KHNhdmVkVGV4dCk7CiAgICAgIH0sCiAgICAgIG11c3RFeGVjOiBmYWxzZQogICAgfSk7CiAgICB0aGlzLiNzZXRFZGl0b3JEaW1lbnNpb25zKCk7CiAgfQogIHNob3VsZEdldEtleWJvYXJkRXZlbnRzKCkgewogICAgcmV0dXJuIHRoaXMuaXNJbkVkaXRNb2RlKCk7CiAgfQogIGVudGVySW5FZGl0TW9kZSgpIHsKICAgIHRoaXMuZW5hYmxlRWRpdE1vZGUoKTsKICAgIHRoaXMuZWRpdG9yRGl2LmZvY3VzKCk7CiAgfQogIGtleWRvd24oZXZlbnQpIHsKICAgIGlmIChldmVudC50YXJnZXQgPT09IHRoaXMuZGl2ICYmIGV2ZW50LmtleSA9PT0gIkVudGVyIikgewogICAgICB0aGlzLmVudGVySW5FZGl0TW9kZSgpOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQogIH0KICBlZGl0b3JEaXZLZXlkb3duKGV2ZW50KSB7CiAgICBfRnJlZVRleHRFZGl0b3IuX2tleWJvYXJkTWFuYWdlci5leGVjKHRoaXMsIGV2ZW50KTsKICB9CiAgZWRpdG9yRGl2Rm9jdXMoZXZlbnQpIHsKICAgIHRoaXMuaXNFZGl0aW5nID0gdHJ1ZTsKICB9CiAgZWRpdG9yRGl2Qmx1cihldmVudCkgewogICAgdGhpcy5pc0VkaXRpbmcgPSBmYWxzZTsKICB9CiAgZWRpdG9yRGl2SW5wdXQoZXZlbnQpIHsKICAgIHRoaXMucGFyZW50LmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJmcmVldGV4dEVkaXRpbmciLCB0aGlzLmlzRW1wdHkoKSk7CiAgfQogIGRpc2FibGVFZGl0aW5nKCkgewogICAgdGhpcy5lZGl0b3JEaXYuc2V0QXR0cmlidXRlKCJyb2xlIiwgImNvbW1lbnQiKTsKICAgIHRoaXMuZWRpdG9yRGl2LnJlbW92ZUF0dHJpYnV0ZSgiYXJpYS1tdWx0aWxpbmUiKTsKICB9CiAgZW5hYmxlRWRpdGluZygpIHsKICAgIHRoaXMuZWRpdG9yRGl2LnNldEF0dHJpYnV0ZSgicm9sZSIsICJ0ZXh0Ym94Iik7CiAgICB0aGlzLmVkaXRvckRpdi5zZXRBdHRyaWJ1dGUoImFyaWEtbXVsdGlsaW5lIiwgdHJ1ZSk7CiAgfQogIGdldCBjYW5DaGFuZ2VDb250ZW50KCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLmRpdikgewogICAgICByZXR1cm4gdGhpcy5kaXY7CiAgICB9CiAgICBsZXQgYmFzZVgsIGJhc2VZOwogICAgaWYgKHRoaXMuX2lzQ29weSB8fCB0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgYmFzZVggPSB0aGlzLng7CiAgICAgIGJhc2VZID0gdGhpcy55OwogICAgfQogICAgc3VwZXIucmVuZGVyKCk7CiAgICB0aGlzLmVkaXRvckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGhpcy5lZGl0b3JEaXYuY2xhc3NOYW1lID0gImludGVybmFsIjsKICAgIHRoaXMuZWRpdG9yRGl2LnNldEF0dHJpYnV0ZSgiaWQiLCB0aGlzLiNlZGl0b3JEaXZJZCk7CiAgICB0aGlzLmVkaXRvckRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1pZCIsICJwZGZqcy1mcmVlLXRleHQyIik7CiAgICB0aGlzLmVkaXRvckRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1hdHRycyIsICJkZWZhdWx0LWNvbnRlbnQiKTsKICAgIHRoaXMuZW5hYmxlRWRpdGluZygpOwogICAgdGhpcy5lZGl0b3JEaXYuY29udGVudEVkaXRhYmxlID0gdHJ1ZTsKICAgIGNvbnN0IHsKICAgICAgc3R5bGUKICAgIH0gPSB0aGlzLmVkaXRvckRpdjsKICAgIHN0eWxlLmZvbnRTaXplID0gYGNhbGMoJHt0aGlzLiNmb250U2l6ZX1weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikpYDsKICAgIHN0eWxlLmNvbG9yID0gdGhpcy5jb2xvcjsKICAgIHRoaXMuZGl2LmFwcGVuZCh0aGlzLmVkaXRvckRpdik7CiAgICB0aGlzLm92ZXJsYXlEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHRoaXMub3ZlcmxheURpdi5jbGFzc0xpc3QuYWRkKCJvdmVybGF5IiwgImVuYWJsZWQiKTsKICAgIHRoaXMuZGl2LmFwcGVuZCh0aGlzLm92ZXJsYXlEaXYpOwogICAgaWYgKHRoaXMuX2lzQ29weSB8fCB0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgY29uc3QgW3BhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdID0gdGhpcy5wYXJlbnREaW1lbnNpb25zOwogICAgICBpZiAodGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgICAgY29uc3QgewogICAgICAgICAgcG9zaXRpb24KICAgICAgICB9ID0gdGhpcy5faW5pdGlhbERhdGE7CiAgICAgICAgbGV0IFt0eCwgdHldID0gdGhpcy5nZXRJbml0aWFsVHJhbnNsYXRpb24oKTsKICAgICAgICBbdHgsIHR5XSA9IHRoaXMucGFnZVRyYW5zbGF0aW9uVG9TY3JlZW4odHgsIHR5KTsKICAgICAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFnZURpbWVuc2lvbnM7CiAgICAgICAgY29uc3QgW3BhZ2VYLCBwYWdlWV0gPSB0aGlzLnBhZ2VUcmFuc2xhdGlvbjsKICAgICAgICBsZXQgcG9zWCwgcG9zWTsKICAgICAgICBzd2l0Y2ggKHRoaXMucm90YXRpb24pIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgcG9zWCA9IGJhc2VYICsgKHBvc2l0aW9uWzBdIC0gcGFnZVgpIC8gcGFnZVdpZHRoOwogICAgICAgICAgICBwb3NZID0gYmFzZVkgKyB0aGlzLmhlaWdodCAtIChwb3NpdGlvblsxXSAtIHBhZ2VZKSAvIHBhZ2VIZWlnaHQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA5MDoKICAgICAgICAgICAgcG9zWCA9IGJhc2VYICsgKHBvc2l0aW9uWzBdIC0gcGFnZVgpIC8gcGFnZVdpZHRoOwogICAgICAgICAgICBwb3NZID0gYmFzZVkgLSAocG9zaXRpb25bMV0gLSBwYWdlWSkgLyBwYWdlSGVpZ2h0OwogICAgICAgICAgICBbdHgsIHR5XSA9IFt0eSwgLXR4XTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDE4MDoKICAgICAgICAgICAgcG9zWCA9IGJhc2VYIC0gdGhpcy53aWR0aCArIChwb3NpdGlvblswXSAtIHBhZ2VYKSAvIHBhZ2VXaWR0aDsKICAgICAgICAgICAgcG9zWSA9IGJhc2VZIC0gKHBvc2l0aW9uWzFdIC0gcGFnZVkpIC8gcGFnZUhlaWdodDsKICAgICAgICAgICAgW3R4LCB0eV0gPSBbLXR4LCAtdHldOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjcwOgogICAgICAgICAgICBwb3NYID0gYmFzZVggKyAocG9zaXRpb25bMF0gLSBwYWdlWCAtIHRoaXMuaGVpZ2h0ICogcGFnZUhlaWdodCkgLyBwYWdlV2lkdGg7CiAgICAgICAgICAgIHBvc1kgPSBiYXNlWSArIChwb3NpdGlvblsxXSAtIHBhZ2VZIC0gdGhpcy53aWR0aCAqIHBhZ2VXaWR0aCkgLyBwYWdlSGVpZ2h0OwogICAgICAgICAgICBbdHgsIHR5XSA9IFstdHksIHR4XTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2V0QXQocG9zWCAqIHBhcmVudFdpZHRoLCBwb3NZICogcGFyZW50SGVpZ2h0LCB0eCwgdHkpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX21vdmVBZnRlclBhc3RlKGJhc2VYLCBiYXNlWSk7CiAgICAgIH0KICAgICAgdGhpcy4jc2V0Q29udGVudCgpOwogICAgICB0aGlzLl9pc0RyYWdnYWJsZSA9IHRydWU7CiAgICAgIHRoaXMuZWRpdG9yRGl2LmNvbnRlbnRFZGl0YWJsZSA9IGZhbHNlOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5faXNEcmFnZ2FibGUgPSBmYWxzZTsKICAgICAgdGhpcy5lZGl0b3JEaXYuY29udGVudEVkaXRhYmxlID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiB0aGlzLmRpdjsKICB9CiAgc3RhdGljICNnZXROb2RlQ29udGVudChub2RlKSB7CiAgICByZXR1cm4gKG5vZGUubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFID8gbm9kZS5ub2RlVmFsdWUgOiBub2RlLmlubmVyVGV4dCkucmVwbGFjZUFsbChFT0xfUEFUVEVSTiwgIiIpOwogIH0KICBlZGl0b3JEaXZQYXN0ZShldmVudCkgewogICAgY29uc3QgY2xpcGJvYXJkRGF0YSA9IGV2ZW50LmNsaXBib2FyZERhdGEgfHwgd2luZG93LmNsaXBib2FyZERhdGE7CiAgICBjb25zdCB7CiAgICAgIHR5cGVzCiAgICB9ID0gY2xpcGJvYXJkRGF0YTsKICAgIGlmICh0eXBlcy5sZW5ndGggPT09IDEgJiYgdHlwZXNbMF0gPT09ICJ0ZXh0L3BsYWluIikgewogICAgICByZXR1cm47CiAgICB9CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgY29uc3QgcGFzdGUgPSBfRnJlZVRleHRFZGl0b3IuI2Rlc2VyaWFsaXplQ29udGVudChjbGlwYm9hcmREYXRhLmdldERhdGEoInRleHQiKSB8fCAiIikucmVwbGFjZUFsbChFT0xfUEFUVEVSTiwgIlxuIik7CiAgICBpZiAoIXBhc3RlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTsKICAgIGlmICghc2VsZWN0aW9uLnJhbmdlQ291bnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5lZGl0b3JEaXYubm9ybWFsaXplKCk7CiAgICBzZWxlY3Rpb24uZGVsZXRlRnJvbURvY3VtZW50KCk7CiAgICBjb25zdCByYW5nZSA9IHNlbGVjdGlvbi5nZXRSYW5nZUF0KDApOwogICAgaWYgKCFwYXN0ZS5pbmNsdWRlcygiXG4iKSkgewogICAgICByYW5nZS5pbnNlcnROb2RlKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHBhc3RlKSk7CiAgICAgIHRoaXMuZWRpdG9yRGl2Lm5vcm1hbGl6ZSgpOwogICAgICBzZWxlY3Rpb24uY29sbGFwc2VUb1N0YXJ0KCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgc3RhcnRDb250YWluZXIsCiAgICAgIHN0YXJ0T2Zmc2V0CiAgICB9ID0gcmFuZ2U7CiAgICBjb25zdCBidWZmZXJCZWZvcmUgPSBbXTsKICAgIGNvbnN0IGJ1ZmZlckFmdGVyID0gW107CiAgICBpZiAoc3RhcnRDb250YWluZXIubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFKSB7CiAgICAgIGNvbnN0IHBhcmVudCA9IHN0YXJ0Q29udGFpbmVyLnBhcmVudEVsZW1lbnQ7CiAgICAgIGJ1ZmZlckFmdGVyLnB1c2goc3RhcnRDb250YWluZXIubm9kZVZhbHVlLnNsaWNlKHN0YXJ0T2Zmc2V0KS5yZXBsYWNlQWxsKEVPTF9QQVRURVJOLCAiIikpOwogICAgICBpZiAocGFyZW50ICE9PSB0aGlzLmVkaXRvckRpdikgewogICAgICAgIGxldCBidWZmZXIgPSBidWZmZXJCZWZvcmU7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmVkaXRvckRpdi5jaGlsZE5vZGVzKSB7CiAgICAgICAgICBpZiAoY2hpbGQgPT09IHBhcmVudCkgewogICAgICAgICAgICBidWZmZXIgPSBidWZmZXJBZnRlcjsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBidWZmZXIucHVzaChfRnJlZVRleHRFZGl0b3IuI2dldE5vZGVDb250ZW50KGNoaWxkKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGJ1ZmZlckJlZm9yZS5wdXNoKHN0YXJ0Q29udGFpbmVyLm5vZGVWYWx1ZS5zbGljZSgwLCBzdGFydE9mZnNldCkucmVwbGFjZUFsbChFT0xfUEFUVEVSTiwgIiIpKTsKICAgIH0gZWxzZSBpZiAoc3RhcnRDb250YWluZXIgPT09IHRoaXMuZWRpdG9yRGl2KSB7CiAgICAgIGxldCBidWZmZXIgPSBidWZmZXJCZWZvcmU7CiAgICAgIGxldCBpID0gMDsKICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmVkaXRvckRpdi5jaGlsZE5vZGVzKSB7CiAgICAgICAgaWYgKGkrKyA9PT0gc3RhcnRPZmZzZXQpIHsKICAgICAgICAgIGJ1ZmZlciA9IGJ1ZmZlckFmdGVyOwogICAgICAgIH0KICAgICAgICBidWZmZXIucHVzaChfRnJlZVRleHRFZGl0b3IuI2dldE5vZGVDb250ZW50KGNoaWxkKSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2NvbnRlbnQgPSBgJHtidWZmZXJCZWZvcmUuam9pbigiXG4iKX0ke3Bhc3RlfSR7YnVmZmVyQWZ0ZXIuam9pbigiXG4iKX1gOwogICAgdGhpcy4jc2V0Q29udGVudCgpOwogICAgY29uc3QgbmV3UmFuZ2UgPSBuZXcgUmFuZ2UoKTsKICAgIGxldCBiZWZvcmVMZW5ndGggPSBNYXRoLnN1bVByZWNpc2UoYnVmZmVyQmVmb3JlLm1hcCgobGluZSkgPT4gbGluZS5sZW5ndGgpKTsKICAgIGZvciAoY29uc3QgewogICAgICBmaXJzdENoaWxkCiAgICB9IG9mIHRoaXMuZWRpdG9yRGl2LmNoaWxkTm9kZXMpIHsKICAgICAgaWYgKGZpcnN0Q2hpbGQubm9kZVR5cGUgPT09IE5vZGUuVEVYVF9OT0RFKSB7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZmlyc3RDaGlsZC5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgIGlmIChiZWZvcmVMZW5ndGggPD0gbGVuZ3RoKSB7CiAgICAgICAgICBuZXdSYW5nZS5zZXRTdGFydChmaXJzdENoaWxkLCBiZWZvcmVMZW5ndGgpOwogICAgICAgICAgbmV3UmFuZ2Uuc2V0RW5kKGZpcnN0Q2hpbGQsIGJlZm9yZUxlbmd0aCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgYmVmb3JlTGVuZ3RoIC09IGxlbmd0aDsKICAgICAgfQogICAgfQogICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpOwogICAgc2VsZWN0aW9uLmFkZFJhbmdlKG5ld1JhbmdlKTsKICB9CiAgI3NldENvbnRlbnQoKSB7CiAgICB0aGlzLmVkaXRvckRpdi5yZXBsYWNlQ2hpbGRyZW4oKTsKICAgIGlmICghdGhpcy4jY29udGVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgdGhpcy4jY29udGVudC5zcGxpdCgiXG4iKSkgewogICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZGl2LmFwcGVuZChsaW5lID8gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobGluZSkgOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJiciIpKTsKICAgICAgdGhpcy5lZGl0b3JEaXYuYXBwZW5kKGRpdik7CiAgICB9CiAgfQogICNzZXJpYWxpemVDb250ZW50KCkgewogICAgcmV0dXJuIHRoaXMuI2NvbnRlbnQucmVwbGFjZUFsbCgiXHhBMCIsICIgIik7CiAgfQogIHN0YXRpYyAjZGVzZXJpYWxpemVDb250ZW50KGNvbnRlbnQpIHsKICAgIHJldHVybiBjb250ZW50LnJlcGxhY2VBbGwoIiAiLCAiXHhBMCIpOwogIH0KICBnZXQgY29udGVudERpdigpIHsKICAgIHJldHVybiB0aGlzLmVkaXRvckRpdjsKICB9CiAgZ2V0UERGUmVjdCgpIHsKICAgIGNvbnN0IHBhZGRpbmcgPSBfRnJlZVRleHRFZGl0b3IuX2ludGVybmFsUGFkZGluZyAqIHRoaXMucGFyZW50U2NhbGU7CiAgICByZXR1cm4gdGhpcy5nZXRSZWN0KHBhZGRpbmcsIHBhZGRpbmcpOwogIH0KICBzdGF0aWMgYXN5bmMgZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpIHsKICAgIGxldCBpbml0aWFsRGF0YTIgPSBudWxsOwogICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBGcmVlVGV4dEFubm90YXRpb25FbGVtZW50KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBkZWZhdWx0QXBwZWFyYW5jZURhdGE6IHsKICAgICAgICAgICAgZm9udFNpemUsCiAgICAgICAgICAgIGZvbnRDb2xvcgogICAgICAgICAgfSwKICAgICAgICAgIHJlY3QsCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIGlkLAogICAgICAgICAgcG9wdXBSZWYsCiAgICAgICAgICByaWNoVGV4dCwKICAgICAgICAgIGNvbnRlbnRzT2JqLAogICAgICAgICAgY3JlYXRpb25EYXRlLAogICAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgICAgIH0sCiAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgdGV4dFBvc2l0aW9uLAogICAgICAgIHBhcmVudDogewogICAgICAgICAgcGFnZTogewogICAgICAgICAgICBwYWdlTnVtYmVyCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9ID0gZGF0YTsKICAgICAgaWYgKCF0ZXh0Q29udGVudCB8fCB0ZXh0Q29udGVudC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpbml0aWFsRGF0YTIgPSBkYXRhID0gewogICAgICAgIGFubm90YXRpb25UeXBlOiBBbm5vdGF0aW9uRWRpdG9yVHlwZS5GUkVFVEVYVCwKICAgICAgICBjb2xvcjogQXJyYXkuZnJvbShmb250Q29sb3IpLAogICAgICAgIGZvbnRTaXplLAogICAgICAgIHZhbHVlOiB0ZXh0Q29udGVudC5qb2luKCJcbiIpLAogICAgICAgIHBvc2l0aW9uOiB0ZXh0UG9zaXRpb24sCiAgICAgICAgcGFnZUluZGV4OiBwYWdlTnVtYmVyIC0gMSwKICAgICAgICByZWN0OiByZWN0LnNsaWNlKDApLAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGFubm90YXRpb25FbGVtZW50SWQ6IGlkLAogICAgICAgIGlkLAogICAgICAgIGRlbGV0ZWQ6IGZhbHNlLAogICAgICAgIHBvcHVwUmVmLAogICAgICAgIGNvbW1lbnQ6IGNvbnRlbnRzT2JqPy5zdHIgfHwgbnVsbCwKICAgICAgICByaWNoVGV4dCwKICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgICB9OwogICAgfQogICAgY29uc3QgZWRpdG9yID0gYXdhaXQgc3VwZXIuZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpOwogICAgZWRpdG9yLiNmb250U2l6ZSA9IGRhdGEuZm9udFNpemU7CiAgICBlZGl0b3IuY29sb3IgPSBVdGlsLm1ha2VIZXhDb2xvciguLi5kYXRhLmNvbG9yKTsKICAgIGVkaXRvci4jY29udGVudCA9IF9GcmVlVGV4dEVkaXRvci4jZGVzZXJpYWxpemVDb250ZW50KGRhdGEudmFsdWUpOwogICAgZWRpdG9yLl9pbml0aWFsRGF0YSA9IGluaXRpYWxEYXRhMjsKICAgIGlmIChkYXRhLmNvbW1lbnQpIHsKICAgICAgZWRpdG9yLnNldENvbW1lbnREYXRhKGRhdGEpOwogICAgfQogICAgcmV0dXJuIGVkaXRvcjsKICB9CiAgc2VyaWFsaXplKGlzRm9yQ29weWluZyA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZURlbGV0ZWQoKTsKICAgIH0KICAgIGNvbnN0IGNvbG9yID0gQW5ub3RhdGlvbkVkaXRvci5fY29sb3JNYW5hZ2VyLmNvbnZlcnQodGhpcy5pc0F0dGFjaGVkVG9ET00gPyBnZXRDb21wdXRlZFN0eWxlKHRoaXMuZWRpdG9yRGl2KS5jb2xvciA6IHRoaXMuY29sb3IpOwogICAgY29uc3Qgc2VyaWFsaXplZCA9IE9iamVjdC5hc3NpZ24oc3VwZXIuc2VyaWFsaXplKGlzRm9yQ29weWluZyksIHsKICAgICAgY29sb3IsCiAgICAgIGZvbnRTaXplOiB0aGlzLiNmb250U2l6ZSwKICAgICAgdmFsdWU6IHRoaXMuI3NlcmlhbGl6ZUNvbnRlbnQoKQogICAgfSk7CiAgICB0aGlzLmFkZENvbW1lbnQoc2VyaWFsaXplZCk7CiAgICBpZiAoaXNGb3JDb3B5aW5nKSB7CiAgICAgIHNlcmlhbGl6ZWQuaXNDb3B5ID0gdHJ1ZTsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICB9CiAgICBpZiAodGhpcy5hbm5vdGF0aW9uRWxlbWVudElkICYmICF0aGlzLiNoYXNFbGVtZW50Q2hhbmdlZChzZXJpYWxpemVkKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHNlcmlhbGl6ZWQuaWQgPSB0aGlzLmFubm90YXRpb25FbGVtZW50SWQ7CiAgICByZXR1cm4gc2VyaWFsaXplZDsKICB9CiAgI2hhc0VsZW1lbnRDaGFuZ2VkKHNlcmlhbGl6ZWQpIHsKICAgIGNvbnN0IHsKICAgICAgdmFsdWUsCiAgICAgIGZvbnRTaXplLAogICAgICBjb2xvciwKICAgICAgcGFnZUluZGV4CiAgICB9ID0gdGhpcy5faW5pdGlhbERhdGE7CiAgICByZXR1cm4gdGhpcy5oYXNFZGl0ZWRDb21tZW50IHx8IHRoaXMuX2hhc0JlZW5Nb3ZlZCB8fCBzZXJpYWxpemVkLnZhbHVlICE9PSB2YWx1ZSB8fCBzZXJpYWxpemVkLmZvbnRTaXplICE9PSBmb250U2l6ZSB8fCBzZXJpYWxpemVkLmNvbG9yLnNvbWUoKGMsIGkpID0+IGMgIT09IGNvbG9yW2ldKSB8fCBzZXJpYWxpemVkLnBhZ2VJbmRleCAhPT0gcGFnZUluZGV4OwogIH0KICByZW5kZXJBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKSB7CiAgICBjb25zdCBjb250ZW50ID0gc3VwZXIucmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbik7CiAgICBpZiAoIWNvbnRlbnQpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHN0eWxlCiAgICB9ID0gY29udGVudDsKICAgIHN0eWxlLmZvbnRTaXplID0gYGNhbGMoJHt0aGlzLiNmb250U2l6ZX1weCAqIHZhcigtLXRvdGFsLXNjYWxlLWZhY3RvcikpYDsKICAgIHN0eWxlLmNvbG9yID0gdGhpcy5jb2xvcjsKICAgIGNvbnRlbnQucmVwbGFjZUNoaWxkcmVuKCk7CiAgICBmb3IgKGNvbnN0IGxpbmUgb2YgdGhpcy4jY29udGVudC5zcGxpdCgiXG4iKSkgewogICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgZGl2LmFwcGVuZChsaW5lID8gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobGluZSkgOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJiciIpKTsKICAgICAgY29udGVudC5hcHBlbmQoZGl2KTsKICAgIH0KICAgIGFubm90YXRpb24udXBkYXRlRWRpdGVkKHsKICAgICAgcmVjdDogdGhpcy5nZXRQREZSZWN0KCksCiAgICAgIHBvcHVwOiB0aGlzLl91aU1hbmFnZXIuaGFzQ29tbWVudE1hbmFnZXIoKSB8fCB0aGlzLmhhc0VkaXRlZENvbW1lbnQgPyB0aGlzLmNvbW1lbnQgOiB7CiAgICAgICAgdGV4dDogdGhpcy4jY29udGVudAogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBjb250ZW50OwogIH0KICByZXNldEFubm90YXRpb25FbGVtZW50KGFubm90YXRpb24pIHsKICAgIHN1cGVyLnJlc2V0QW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbik7CiAgICBhbm5vdGF0aW9uLnJlc2V0RWRpdGVkKCk7CiAgfQp9Owp2YXIgT3V0bGluZSA9IGNsYXNzIHsKICBzdGF0aWMgUFJFQ0lTSU9OID0gMWUtNDsKICB0b1NWR1BhdGgoKSB7CiAgICB1bnJlYWNoYWJsZSgiQWJzdHJhY3QgbWV0aG9kIGB0b1NWR1BhdGhgIG11c3QgYmUgaW1wbGVtZW50ZWQuIik7CiAgfQogIGdldCBib3goKSB7CiAgICB1bnJlYWNoYWJsZSgiQWJzdHJhY3QgZ2V0dGVyIGBib3hgIG11c3QgYmUgaW1wbGVtZW50ZWQuIik7CiAgfQogIHNlcmlhbGl6ZShfYmJveCwgX3JvdGF0aW9uKSB7CiAgICB1bnJlYWNoYWJsZSgiQWJzdHJhY3QgbWV0aG9kIGBzZXJpYWxpemVgIG11c3QgYmUgaW1wbGVtZW50ZWQuIik7CiAgfQogIHN0YXRpYyBfcmVzY2FsZShzcmMsIHR4LCB0eSwgc3gsIHN5LCBkZXN0KSB7CiAgICBkZXN0IHx8PSBuZXcgRmxvYXQzMkFycmF5KHNyYy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gc3JjLmxlbmd0aDsgaSA8IGlpOyBpICs9IDIpIHsKICAgICAgZGVzdFtpXSA9IHR4ICsgc3JjW2ldICogc3g7CiAgICAgIGRlc3RbaSArIDFdID0gdHkgKyBzcmNbaSArIDFdICogc3k7CiAgICB9CiAgICByZXR1cm4gZGVzdDsKICB9CiAgc3RhdGljIF9yZXNjYWxlQW5kU3dhcChzcmMsIHR4LCB0eSwgc3gsIHN5LCBkZXN0KSB7CiAgICBkZXN0IHx8PSBuZXcgRmxvYXQzMkFycmF5KHNyYy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gc3JjLmxlbmd0aDsgaSA8IGlpOyBpICs9IDIpIHsKICAgICAgZGVzdFtpXSA9IHR4ICsgc3JjW2kgKyAxXSAqIHN4OwogICAgICBkZXN0W2kgKyAxXSA9IHR5ICsgc3JjW2ldICogc3k7CiAgICB9CiAgICByZXR1cm4gZGVzdDsKICB9CiAgc3RhdGljIF90cmFuc2xhdGUoc3JjLCB0eCwgdHksIGRlc3QpIHsKICAgIGRlc3QgfHw9IG5ldyBGbG9hdDMyQXJyYXkoc3JjLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBzcmMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gMikgewogICAgICBkZXN0W2ldID0gdHggKyBzcmNbaV07CiAgICAgIGRlc3RbaSArIDFdID0gdHkgKyBzcmNbaSArIDFdOwogICAgfQogICAgcmV0dXJuIGRlc3Q7CiAgfQogIHN0YXRpYyBzdmdSb3VuZCh4KSB7CiAgICByZXR1cm4gTWF0aC5yb3VuZCh4ICogMWU0KTsKICB9CiAgc3RhdGljIF9ub3JtYWxpemVQb2ludCh4LCB5LCBwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0LCByb3RhdGlvbikgewogICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbMSAtIHkgLyBwYXJlbnRXaWR0aCwgeCAvIHBhcmVudEhlaWdodF07CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiBbMSAtIHggLyBwYXJlbnRXaWR0aCwgMSAtIHkgLyBwYXJlbnRIZWlnaHRdOwogICAgICBjYXNlIDI3MDoKICAgICAgICByZXR1cm4gW3kgLyBwYXJlbnRXaWR0aCwgMSAtIHggLyBwYXJlbnRIZWlnaHRdOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbeCAvIHBhcmVudFdpZHRoLCB5IC8gcGFyZW50SGVpZ2h0XTsKICAgIH0KICB9CiAgc3RhdGljIF9ub3JtYWxpemVQYWdlUG9pbnQoeCwgeSwgcm90YXRpb24pIHsKICAgIHN3aXRjaCAocm90YXRpb24pIHsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXR1cm4gWzEgLSB5LCB4XTsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcmV0dXJuIFsxIC0geCwgMSAtIHldOwogICAgICBjYXNlIDI3MDoKICAgICAgICByZXR1cm4gW3ksIDEgLSB4XTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gW3gsIHldOwogICAgfQogIH0KICBzdGF0aWMgY3JlYXRlQmV6aWVyUG9pbnRzKHgxLCB5MSwgeDIsIHkyLCB4MywgeTMpIHsKICAgIHJldHVybiBbKHgxICsgNSAqIHgyKSAvIDYsICh5MSArIDUgKiB5MikgLyA2LCAoNSAqIHgyICsgeDMpIC8gNiwgKDUgKiB5MiArIHkzKSAvIDYsICh4MiArIHgzKSAvIDIsICh5MiArIHkzKSAvIDJdOwogIH0KfTsKdmFyIEZyZWVEcmF3T3V0bGluZXIgPSBjbGFzcyBfRnJlZURyYXdPdXRsaW5lciB7CiAgI2JveDsKICAjYm90dG9tID0gW107CiAgI2lubmVyTWFyZ2luOwogICNpc0xUUjsKICAjdG9wID0gW107CiAgI2xhc3QgPSBuZXcgRmxvYXQzMkFycmF5KDE4KTsKICAjbGFzdFg7CiAgI2xhc3RZOwogICNtaW47CiAgI21pbl9kaXN0OwogICNzY2FsZUZhY3RvcjsKICAjdGhpY2tuZXNzOwogICNwb2ludHMgPSBbXTsKICBzdGF0aWMgI01JTl9ESVNUID0gODsKICBzdGF0aWMgI01JTl9ESUZGID0gMjsKICBzdGF0aWMgI01JTiA9IF9GcmVlRHJhd091dGxpbmVyLiNNSU5fRElTVCArIF9GcmVlRHJhd091dGxpbmVyLiNNSU5fRElGRjsKICBjb25zdHJ1Y3Rvcih7CiAgICB4LAogICAgeQogIH0sIGJveCwgc2NhbGVGYWN0b3IsIHRoaWNrbmVzcywgaXNMVFIsIGlubmVyTWFyZ2luID0gMCkgewogICAgdGhpcy4jYm94ID0gYm94OwogICAgdGhpcy4jdGhpY2tuZXNzID0gdGhpY2tuZXNzICogc2NhbGVGYWN0b3I7CiAgICB0aGlzLiNpc0xUUiA9IGlzTFRSOwogICAgdGhpcy4jbGFzdC5zZXQoW05hTiwgTmFOLCBOYU4sIE5hTiwgeCwgeV0sIDYpOwogICAgdGhpcy4jaW5uZXJNYXJnaW4gPSBpbm5lck1hcmdpbjsKICAgIHRoaXMuI21pbl9kaXN0ID0gX0ZyZWVEcmF3T3V0bGluZXIuI01JTl9ESVNUICogc2NhbGVGYWN0b3I7CiAgICB0aGlzLiNtaW4gPSBfRnJlZURyYXdPdXRsaW5lci4jTUlOICogc2NhbGVGYWN0b3I7CiAgICB0aGlzLiNzY2FsZUZhY3RvciA9IHNjYWxlRmFjdG9yOwogICAgdGhpcy4jcG9pbnRzLnB1c2goeCwgeSk7CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gaXNOYU4odGhpcy4jbGFzdFs4XSk7CiAgfQogICNnZXRMYXN0Q29vcmRzKCkgewogICAgY29uc3QgbGFzdFRvcCA9IHRoaXMuI2xhc3Quc3ViYXJyYXkoNCwgNik7CiAgICBjb25zdCBsYXN0Qm90dG9tID0gdGhpcy4jbGFzdC5zdWJhcnJheSgxNiwgMTgpOwogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gdGhpcy4jYm94OwogICAgcmV0dXJuIFsodGhpcy4jbGFzdFggKyAobGFzdFRvcFswXSAtIGxhc3RCb3R0b21bMF0pIC8gMiAtIHgpIC8gd2lkdGgsICh0aGlzLiNsYXN0WSArIChsYXN0VG9wWzFdIC0gbGFzdEJvdHRvbVsxXSkgLyAyIC0geSkgLyBoZWlnaHQsICh0aGlzLiNsYXN0WCArIChsYXN0Qm90dG9tWzBdIC0gbGFzdFRvcFswXSkgLyAyIC0geCkgLyB3aWR0aCwgKHRoaXMuI2xhc3RZICsgKGxhc3RCb3R0b21bMV0gLSBsYXN0VG9wWzFdKSAvIDIgLSB5KSAvIGhlaWdodF07CiAgfQogIGFkZCh7CiAgICB4LAogICAgeQogIH0pIHsKICAgIHRoaXMuI2xhc3RYID0geDsKICAgIHRoaXMuI2xhc3RZID0geTsKICAgIGNvbnN0IFtsYXllclgsIGxheWVyWSwgbGF5ZXJXaWR0aCwgbGF5ZXJIZWlnaHRdID0gdGhpcy4jYm94OwogICAgbGV0IFt4MSwgeTEsIHgyLCB5Ml0gPSB0aGlzLiNsYXN0LnN1YmFycmF5KDgsIDEyKTsKICAgIGNvbnN0IGRpZmZYID0geCAtIHgyOwogICAgY29uc3QgZGlmZlkgPSB5IC0geTI7CiAgICBjb25zdCBkID0gTWF0aC5oeXBvdChkaWZmWCwgZGlmZlkpOwogICAgaWYgKGQgPCB0aGlzLiNtaW4pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgY29uc3QgZGlmZkQgPSBkIC0gdGhpcy4jbWluX2Rpc3Q7CiAgICBjb25zdCBLID0gZGlmZkQgLyBkOwogICAgY29uc3Qgc2hpZnRYID0gSyAqIGRpZmZYOwogICAgY29uc3Qgc2hpZnRZID0gSyAqIGRpZmZZOwogICAgbGV0IHgwID0geDE7CiAgICBsZXQgeTAgPSB5MTsKICAgIHgxID0geDI7CiAgICB5MSA9IHkyOwogICAgeDIgKz0gc2hpZnRYOwogICAgeTIgKz0gc2hpZnRZOwogICAgdGhpcy4jcG9pbnRzPy5wdXNoKHgsIHkpOwogICAgY29uc3QgblggPSAtc2hpZnRZIC8gZGlmZkQ7CiAgICBjb25zdCBuWSA9IHNoaWZ0WCAvIGRpZmZEOwogICAgY29uc3QgdGhYID0gblggKiB0aGlzLiN0aGlja25lc3M7CiAgICBjb25zdCB0aFkgPSBuWSAqIHRoaXMuI3RoaWNrbmVzczsKICAgIHRoaXMuI2xhc3Quc2V0KHRoaXMuI2xhc3Quc3ViYXJyYXkoMiwgOCksIDApOwogICAgdGhpcy4jbGFzdC5zZXQoW3gyICsgdGhYLCB5MiArIHRoWV0sIDQpOwogICAgdGhpcy4jbGFzdC5zZXQodGhpcy4jbGFzdC5zdWJhcnJheSgxNCwgMTgpLCAxMik7CiAgICB0aGlzLiNsYXN0LnNldChbeDIgLSB0aFgsIHkyIC0gdGhZXSwgMTYpOwogICAgaWYgKGlzTmFOKHRoaXMuI2xhc3RbNl0pKSB7CiAgICAgIGlmICh0aGlzLiN0b3AubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy4jbGFzdC5zZXQoW3gxICsgdGhYLCB5MSArIHRoWV0sIDIpOwogICAgICAgIHRoaXMuI3RvcC5wdXNoKE5hTiwgTmFOLCBOYU4sIE5hTiwgKHgxICsgdGhYIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsICh5MSArIHRoWSAtIGxheWVyWSkgLyBsYXllckhlaWdodCk7CiAgICAgICAgdGhpcy4jbGFzdC5zZXQoW3gxIC0gdGhYLCB5MSAtIHRoWV0sIDE0KTsKICAgICAgICB0aGlzLiNib3R0b20ucHVzaChOYU4sIE5hTiwgTmFOLCBOYU4sICh4MSAtIHRoWCAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAoeTEgLSB0aFkgLSBsYXllclkpIC8gbGF5ZXJIZWlnaHQpOwogICAgICB9CiAgICAgIHRoaXMuI2xhc3Quc2V0KFt4MCwgeTAsIHgxLCB5MSwgeDIsIHkyXSwgNik7CiAgICAgIHJldHVybiAhdGhpcy5pc0VtcHR5KCk7CiAgICB9CiAgICB0aGlzLiNsYXN0LnNldChbeDAsIHkwLCB4MSwgeTEsIHgyLCB5Ml0sIDYpOwogICAgY29uc3QgYW5nbGUgPSBNYXRoLmFicyhNYXRoLmF0YW4yKHkwIC0geTEsIHgwIC0geDEpIC0gTWF0aC5hdGFuMihzaGlmdFksIHNoaWZ0WCkpOwogICAgaWYgKGFuZ2xlIDwgTWF0aC5QSSAvIDIpIHsKICAgICAgW3gxLCB5MSwgeDIsIHkyXSA9IHRoaXMuI2xhc3Quc3ViYXJyYXkoMiwgNik7CiAgICAgIHRoaXMuI3RvcC5wdXNoKE5hTiwgTmFOLCBOYU4sIE5hTiwgKCh4MSArIHgyKSAvIDIgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCh5MSArIHkyKSAvIDIgLSBsYXllclkpIC8gbGF5ZXJIZWlnaHQpOwogICAgICBbeDEsIHkxLCB4MCwgeTBdID0gdGhpcy4jbGFzdC5zdWJhcnJheSgxNCwgMTgpOwogICAgICB0aGlzLiNib3R0b20ucHVzaChOYU4sIE5hTiwgTmFOLCBOYU4sICgoeDAgKyB4MSkgLyAyIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsICgoeTAgKyB5MSkgLyAyIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBbeDAsIHkwLCB4MSwgeTEsIHgyLCB5Ml0gPSB0aGlzLiNsYXN0LnN1YmFycmF5KDAsIDYpOwogICAgdGhpcy4jdG9wLnB1c2goKCh4MCArIDUgKiB4MSkgLyA2IC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsICgoeTAgKyA1ICogeTEpIC8gNiAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgKCg1ICogeDEgKyB4MikgLyA2IC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsICgoNSAqIHkxICsgeTIpIC8gNiAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgKCh4MSArIHgyKSAvIDIgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCh5MSArIHkyKSAvIDIgLSBsYXllclkpIC8gbGF5ZXJIZWlnaHQpOwogICAgW3gyLCB5MiwgeDEsIHkxLCB4MCwgeTBdID0gdGhpcy4jbGFzdC5zdWJhcnJheSgxMiwgMTgpOwogICAgdGhpcy4jYm90dG9tLnB1c2goKCh4MCArIDUgKiB4MSkgLyA2IC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsICgoeTAgKyA1ICogeTEpIC8gNiAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgKCg1ICogeDEgKyB4MikgLyA2IC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsICgoNSAqIHkxICsgeTIpIC8gNiAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgKCh4MSArIHgyKSAvIDIgLSBsYXllclgpIC8gbGF5ZXJXaWR0aCwgKCh5MSArIHkyKSAvIDIgLSBsYXllclkpIC8gbGF5ZXJIZWlnaHQpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHRvU1ZHUGF0aCgpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgewogICAgICByZXR1cm4gIiI7CiAgICB9CiAgICBjb25zdCB0b3AgPSB0aGlzLiN0b3A7CiAgICBjb25zdCBib3R0b20gPSB0aGlzLiNib3R0b207CiAgICBpZiAoaXNOYU4odGhpcy4jbGFzdFs2XSkgJiYgIXRoaXMuaXNFbXB0eSgpKSB7CiAgICAgIHJldHVybiB0aGlzLiN0b1NWR1BhdGhUd29Qb2ludHMoKTsKICAgIH0KICAgIGNvbnN0IGJ1ZmZlciA9IFtdOwogICAgYnVmZmVyLnB1c2goYE0ke3RvcFs0XX0gJHt0b3BbNV19YCk7CiAgICBmb3IgKGxldCBpID0gNjsgaSA8IHRvcC5sZW5ndGg7IGkgKz0gNikgewogICAgICBpZiAoaXNOYU4odG9wW2ldKSkgewogICAgICAgIGJ1ZmZlci5wdXNoKGBMJHt0b3BbaSArIDRdfSAke3RvcFtpICsgNV19YCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVmZmVyLnB1c2goYEMke3RvcFtpXX0gJHt0b3BbaSArIDFdfSAke3RvcFtpICsgMl19ICR7dG9wW2kgKyAzXX0gJHt0b3BbaSArIDRdfSAke3RvcFtpICsgNV19YCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI3RvU1ZHUGF0aEVuZChidWZmZXIpOwogICAgZm9yIChsZXQgaSA9IGJvdHRvbS5sZW5ndGggLSA2OyBpID49IDY7IGkgLT0gNikgewogICAgICBpZiAoaXNOYU4oYm90dG9tW2ldKSkgewogICAgICAgIGJ1ZmZlci5wdXNoKGBMJHtib3R0b21baSArIDRdfSAke2JvdHRvbVtpICsgNV19YCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnVmZmVyLnB1c2goYEMke2JvdHRvbVtpXX0gJHtib3R0b21baSArIDFdfSAke2JvdHRvbVtpICsgMl19ICR7Ym90dG9tW2kgKyAzXX0gJHtib3R0b21baSArIDRdfSAke2JvdHRvbVtpICsgNV19YCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI3RvU1ZHUGF0aFN0YXJ0KGJ1ZmZlcik7CiAgICByZXR1cm4gYnVmZmVyLmpvaW4oIiAiKTsKICB9CiAgI3RvU1ZHUGF0aFR3b1BvaW50cygpIHsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuI2JveDsKICAgIGNvbnN0IFtsYXN0VG9wWCwgbGFzdFRvcFksIGxhc3RCb3R0b21YLCBsYXN0Qm90dG9tWV0gPSB0aGlzLiNnZXRMYXN0Q29vcmRzKCk7CiAgICByZXR1cm4gYE0keyh0aGlzLiNsYXN0WzJdIC0geCkgLyB3aWR0aH0gJHsodGhpcy4jbGFzdFszXSAtIHkpIC8gaGVpZ2h0fSBMJHsodGhpcy4jbGFzdFs0XSAtIHgpIC8gd2lkdGh9ICR7KHRoaXMuI2xhc3RbNV0gLSB5KSAvIGhlaWdodH0gTCR7bGFzdFRvcFh9ICR7bGFzdFRvcFl9IEwke2xhc3RCb3R0b21YfSAke2xhc3RCb3R0b21ZfSBMJHsodGhpcy4jbGFzdFsxNl0gLSB4KSAvIHdpZHRofSAkeyh0aGlzLiNsYXN0WzE3XSAtIHkpIC8gaGVpZ2h0fSBMJHsodGhpcy4jbGFzdFsxNF0gLSB4KSAvIHdpZHRofSAkeyh0aGlzLiNsYXN0WzE1XSAtIHkpIC8gaGVpZ2h0fSBaYDsKICB9CiAgI3RvU1ZHUGF0aFN0YXJ0KGJ1ZmZlcikgewogICAgY29uc3QgYm90dG9tID0gdGhpcy4jYm90dG9tOwogICAgYnVmZmVyLnB1c2goYEwke2JvdHRvbVs0XX0gJHtib3R0b21bNV19IFpgKTsKICB9CiAgI3RvU1ZHUGF0aEVuZChidWZmZXIpIHsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuI2JveDsKICAgIGNvbnN0IGxhc3RUb3AgPSB0aGlzLiNsYXN0LnN1YmFycmF5KDQsIDYpOwogICAgY29uc3QgbGFzdEJvdHRvbSA9IHRoaXMuI2xhc3Quc3ViYXJyYXkoMTYsIDE4KTsKICAgIGNvbnN0IFtsYXN0VG9wWCwgbGFzdFRvcFksIGxhc3RCb3R0b21YLCBsYXN0Qm90dG9tWV0gPSB0aGlzLiNnZXRMYXN0Q29vcmRzKCk7CiAgICBidWZmZXIucHVzaChgTCR7KGxhc3RUb3BbMF0gLSB4KSAvIHdpZHRofSAkeyhsYXN0VG9wWzFdIC0geSkgLyBoZWlnaHR9IEwke2xhc3RUb3BYfSAke2xhc3RUb3BZfSBMJHtsYXN0Qm90dG9tWH0gJHtsYXN0Qm90dG9tWX0gTCR7KGxhc3RCb3R0b21bMF0gLSB4KSAvIHdpZHRofSAkeyhsYXN0Qm90dG9tWzFdIC0geSkgLyBoZWlnaHR9YCk7CiAgfQogIG5ld0ZyZWVEcmF3T3V0bGluZShvdXRsaW5lLCBwb2ludHMsIGJveCwgc2NhbGVGYWN0b3IsIGlubmVyTWFyZ2luLCBpc0xUUikgewogICAgcmV0dXJuIG5ldyBGcmVlRHJhd091dGxpbmUob3V0bGluZSwgcG9pbnRzLCBib3gsIHNjYWxlRmFjdG9yLCBpbm5lck1hcmdpbiwgaXNMVFIpOwogIH0KICBnZXRPdXRsaW5lcygpIHsKICAgIGNvbnN0IHRvcCA9IHRoaXMuI3RvcDsKICAgIGNvbnN0IGJvdHRvbSA9IHRoaXMuI2JvdHRvbTsKICAgIGNvbnN0IGxhc3QgPSB0aGlzLiNsYXN0OwogICAgY29uc3QgW2xheWVyWCwgbGF5ZXJZLCBsYXllcldpZHRoLCBsYXllckhlaWdodF0gPSB0aGlzLiNib3g7CiAgICBjb25zdCBwb2ludHMgPSBuZXcgRmxvYXQzMkFycmF5KCh0aGlzLiNwb2ludHM/Lmxlbmd0aCA/PyAwKSArIDIpOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gcG9pbnRzLmxlbmd0aCAtIDI7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIHBvaW50c1tpXSA9ICh0aGlzLiNwb2ludHNbaV0gLSBsYXllclgpIC8gbGF5ZXJXaWR0aDsKICAgICAgcG9pbnRzW2kgKyAxXSA9ICh0aGlzLiNwb2ludHNbaSArIDFdIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0OwogICAgfQogICAgcG9pbnRzW3BvaW50cy5sZW5ndGggLSAyXSA9ICh0aGlzLiNsYXN0WCAtIGxheWVyWCkgLyBsYXllcldpZHRoOwogICAgcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXSA9ICh0aGlzLiNsYXN0WSAtIGxheWVyWSkgLyBsYXllckhlaWdodDsKICAgIGlmIChpc05hTihsYXN0WzZdKSAmJiAhdGhpcy5pc0VtcHR5KCkpIHsKICAgICAgcmV0dXJuIHRoaXMuI2dldE91dGxpbmVUd29Qb2ludHMocG9pbnRzKTsKICAgIH0KICAgIGNvbnN0IG91dGxpbmUgPSBuZXcgRmxvYXQzMkFycmF5KHRoaXMuI3RvcC5sZW5ndGggKyAyNCArIHRoaXMuI2JvdHRvbS5sZW5ndGgpOwogICAgbGV0IE4gPSB0b3AubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBOOyBpICs9IDIpIHsKICAgICAgaWYgKGlzTmFOKHRvcFtpXSkpIHsKICAgICAgICBvdXRsaW5lW2ldID0gb3V0bGluZVtpICsgMV0gPSBOYU47CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgb3V0bGluZVtpXSA9IHRvcFtpXTsKICAgICAgb3V0bGluZVtpICsgMV0gPSB0b3BbaSArIDFdOwogICAgfQogICAgTiA9IHRoaXMuI2dldE91dGxpbmVFbmQob3V0bGluZSwgTik7CiAgICBmb3IgKGxldCBpID0gYm90dG9tLmxlbmd0aCAtIDY7IGkgPj0gNjsgaSAtPSA2KSB7CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgNjsgaiArPSAyKSB7CiAgICAgICAgaWYgKGlzTmFOKGJvdHRvbVtpICsgal0pKSB7CiAgICAgICAgICBvdXRsaW5lW05dID0gb3V0bGluZVtOICsgMV0gPSBOYU47CiAgICAgICAgICBOICs9IDI7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgb3V0bGluZVtOXSA9IGJvdHRvbVtpICsgal07CiAgICAgICAgb3V0bGluZVtOICsgMV0gPSBib3R0b21baSArIGogKyAxXTsKICAgICAgICBOICs9IDI7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2dldE91dGxpbmVTdGFydChvdXRsaW5lLCBOKTsKICAgIHJldHVybiB0aGlzLm5ld0ZyZWVEcmF3T3V0bGluZShvdXRsaW5lLCBwb2ludHMsIHRoaXMuI2JveCwgdGhpcy4jc2NhbGVGYWN0b3IsIHRoaXMuI2lubmVyTWFyZ2luLCB0aGlzLiNpc0xUUik7CiAgfQogICNnZXRPdXRsaW5lVHdvUG9pbnRzKHBvaW50cykgewogICAgY29uc3QgbGFzdCA9IHRoaXMuI2xhc3Q7CiAgICBjb25zdCBbbGF5ZXJYLCBsYXllclksIGxheWVyV2lkdGgsIGxheWVySGVpZ2h0XSA9IHRoaXMuI2JveDsKICAgIGNvbnN0IFtsYXN0VG9wWCwgbGFzdFRvcFksIGxhc3RCb3R0b21YLCBsYXN0Qm90dG9tWV0gPSB0aGlzLiNnZXRMYXN0Q29vcmRzKCk7CiAgICBjb25zdCBvdXRsaW5lID0gbmV3IEZsb2F0MzJBcnJheSgzNik7CiAgICBvdXRsaW5lLnNldChbTmFOLCBOYU4sIE5hTiwgTmFOLCAobGFzdFsyXSAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAobGFzdFszXSAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgTmFOLCBOYU4sIE5hTiwgTmFOLCAobGFzdFs0XSAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAobGFzdFs1XSAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgTmFOLCBOYU4sIE5hTiwgTmFOLCBsYXN0VG9wWCwgbGFzdFRvcFksIE5hTiwgTmFOLCBOYU4sIE5hTiwgbGFzdEJvdHRvbVgsIGxhc3RCb3R0b21ZLCBOYU4sIE5hTiwgTmFOLCBOYU4sIChsYXN0WzE2XSAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAobGFzdFsxN10gLSBsYXllclkpIC8gbGF5ZXJIZWlnaHQsIE5hTiwgTmFOLCBOYU4sIE5hTiwgKGxhc3RbMTRdIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsIChsYXN0WzE1XSAtIGxheWVyWSkgLyBsYXllckhlaWdodF0sIDApOwogICAgcmV0dXJuIHRoaXMubmV3RnJlZURyYXdPdXRsaW5lKG91dGxpbmUsIHBvaW50cywgdGhpcy4jYm94LCB0aGlzLiNzY2FsZUZhY3RvciwgdGhpcy4jaW5uZXJNYXJnaW4sIHRoaXMuI2lzTFRSKTsKICB9CiAgI2dldE91dGxpbmVTdGFydChvdXRsaW5lLCBwb3MpIHsKICAgIGNvbnN0IGJvdHRvbSA9IHRoaXMuI2JvdHRvbTsKICAgIG91dGxpbmUuc2V0KFtOYU4sIE5hTiwgTmFOLCBOYU4sIGJvdHRvbVs0XSwgYm90dG9tWzVdXSwgcG9zKTsKICAgIHJldHVybiBwb3MgKz0gNjsKICB9CiAgI2dldE91dGxpbmVFbmQob3V0bGluZSwgcG9zKSB7CiAgICBjb25zdCBsYXN0VG9wID0gdGhpcy4jbGFzdC5zdWJhcnJheSg0LCA2KTsKICAgIGNvbnN0IGxhc3RCb3R0b20gPSB0aGlzLiNsYXN0LnN1YmFycmF5KDE2LCAxOCk7CiAgICBjb25zdCBbbGF5ZXJYLCBsYXllclksIGxheWVyV2lkdGgsIGxheWVySGVpZ2h0XSA9IHRoaXMuI2JveDsKICAgIGNvbnN0IFtsYXN0VG9wWCwgbGFzdFRvcFksIGxhc3RCb3R0b21YLCBsYXN0Qm90dG9tWV0gPSB0aGlzLiNnZXRMYXN0Q29vcmRzKCk7CiAgICBvdXRsaW5lLnNldChbTmFOLCBOYU4sIE5hTiwgTmFOLCAobGFzdFRvcFswXSAtIGxheWVyWCkgLyBsYXllcldpZHRoLCAobGFzdFRvcFsxXSAtIGxheWVyWSkgLyBsYXllckhlaWdodCwgTmFOLCBOYU4sIE5hTiwgTmFOLCBsYXN0VG9wWCwgbGFzdFRvcFksIE5hTiwgTmFOLCBOYU4sIE5hTiwgbGFzdEJvdHRvbVgsIGxhc3RCb3R0b21ZLCBOYU4sIE5hTiwgTmFOLCBOYU4sIChsYXN0Qm90dG9tWzBdIC0gbGF5ZXJYKSAvIGxheWVyV2lkdGgsIChsYXN0Qm90dG9tWzFdIC0gbGF5ZXJZKSAvIGxheWVySGVpZ2h0XSwgcG9zKTsKICAgIHJldHVybiBwb3MgKz0gMjQ7CiAgfQp9Owp2YXIgRnJlZURyYXdPdXRsaW5lID0gY2xhc3MgZXh0ZW5kcyBPdXRsaW5lIHsKICAjYm94OwogICNiYm94ID0gbmV3IEZsb2F0MzJBcnJheSg0KTsKICAjaW5uZXJNYXJnaW47CiAgI2lzTFRSOwogICNwb2ludHM7CiAgI3NjYWxlRmFjdG9yOwogICNvdXRsaW5lOwogIGNvbnN0cnVjdG9yKG91dGxpbmUsIHBvaW50cywgYm94LCBzY2FsZUZhY3RvciwgaW5uZXJNYXJnaW4sIGlzTFRSKSB7CiAgICBzdXBlcigpOwogICAgdGhpcy4jb3V0bGluZSA9IG91dGxpbmU7CiAgICB0aGlzLiNwb2ludHMgPSBwb2ludHM7CiAgICB0aGlzLiNib3ggPSBib3g7CiAgICB0aGlzLiNzY2FsZUZhY3RvciA9IHNjYWxlRmFjdG9yOwogICAgdGhpcy4jaW5uZXJNYXJnaW4gPSBpbm5lck1hcmdpbjsKICAgIHRoaXMuI2lzTFRSID0gaXNMVFI7CiAgICB0aGlzLmZpcnN0UG9pbnQgPSBbTmFOLCBOYU5dOwogICAgdGhpcy5sYXN0UG9pbnQgPSBbTmFOLCBOYU5dOwogICAgdGhpcy4jY29tcHV0ZU1pbk1heChpc0xUUik7CiAgICBjb25zdCBbeCwgeSwgd2lkdGgsIGhlaWdodF0gPSB0aGlzLiNiYm94OwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gb3V0bGluZS5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIG91dGxpbmVbaV0gPSAob3V0bGluZVtpXSAtIHgpIC8gd2lkdGg7CiAgICAgIG91dGxpbmVbaSArIDFdID0gKG91dGxpbmVbaSArIDFdIC0geSkgLyBoZWlnaHQ7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBwb2ludHMubGVuZ3RoOyBpIDwgaWk7IGkgKz0gMikgewogICAgICBwb2ludHNbaV0gPSAocG9pbnRzW2ldIC0geCkgLyB3aWR0aDsKICAgICAgcG9pbnRzW2kgKyAxXSA9IChwb2ludHNbaSArIDFdIC0geSkgLyBoZWlnaHQ7CiAgICB9CiAgfQogIHRvU1ZHUGF0aCgpIHsKICAgIGNvbnN0IGJ1ZmZlciA9IFtgTSR7dGhpcy4jb3V0bGluZVs0XX0gJHt0aGlzLiNvdXRsaW5lWzVdfWBdOwogICAgZm9yIChsZXQgaSA9IDYsIGlpID0gdGhpcy4jb3V0bGluZS5sZW5ndGg7IGkgPCBpaTsgaSArPSA2KSB7CiAgICAgIGlmIChpc05hTih0aGlzLiNvdXRsaW5lW2ldKSkgewogICAgICAgIGJ1ZmZlci5wdXNoKGBMJHt0aGlzLiNvdXRsaW5lW2kgKyA0XX0gJHt0aGlzLiNvdXRsaW5lW2kgKyA1XX1gKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBidWZmZXIucHVzaChgQyR7dGhpcy4jb3V0bGluZVtpXX0gJHt0aGlzLiNvdXRsaW5lW2kgKyAxXX0gJHt0aGlzLiNvdXRsaW5lW2kgKyAyXX0gJHt0aGlzLiNvdXRsaW5lW2kgKyAzXX0gJHt0aGlzLiNvdXRsaW5lW2kgKyA0XX0gJHt0aGlzLiNvdXRsaW5lW2kgKyA1XX1gKTsKICAgIH0KICAgIGJ1ZmZlci5wdXNoKCJaIik7CiAgICByZXR1cm4gYnVmZmVyLmpvaW4oIiAiKTsKICB9CiAgc2VyaWFsaXplKFtibFgsIGJsWSwgdHJYLCB0clldLCByb3RhdGlvbikgewogICAgY29uc3Qgd2lkdGggPSB0clggLSBibFg7CiAgICBjb25zdCBoZWlnaHQgPSB0clkgLSBibFk7CiAgICBsZXQgb3V0bGluZTsKICAgIGxldCBwb2ludHM7CiAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICBvdXRsaW5lID0gT3V0bGluZS5fcmVzY2FsZSh0aGlzLiNvdXRsaW5lLCBibFgsIHRyWSwgd2lkdGgsIC1oZWlnaHQpOwogICAgICAgIHBvaW50cyA9IE91dGxpbmUuX3Jlc2NhbGUodGhpcy4jcG9pbnRzLCBibFgsIHRyWSwgd2lkdGgsIC1oZWlnaHQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDkwOgogICAgICAgIG91dGxpbmUgPSBPdXRsaW5lLl9yZXNjYWxlQW5kU3dhcCh0aGlzLiNvdXRsaW5lLCBibFgsIGJsWSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgcG9pbnRzID0gT3V0bGluZS5fcmVzY2FsZUFuZFN3YXAodGhpcy4jcG9pbnRzLCBibFgsIGJsWSwgd2lkdGgsIGhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTgwOgogICAgICAgIG91dGxpbmUgPSBPdXRsaW5lLl9yZXNjYWxlKHRoaXMuI291dGxpbmUsIHRyWCwgYmxZLCAtd2lkdGgsIGhlaWdodCk7CiAgICAgICAgcG9pbnRzID0gT3V0bGluZS5fcmVzY2FsZSh0aGlzLiNwb2ludHMsIHRyWCwgYmxZLCAtd2lkdGgsIGhlaWdodCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjcwOgogICAgICAgIG91dGxpbmUgPSBPdXRsaW5lLl9yZXNjYWxlQW5kU3dhcCh0aGlzLiNvdXRsaW5lLCB0clgsIHRyWSwgLXdpZHRoLCAtaGVpZ2h0KTsKICAgICAgICBwb2ludHMgPSBPdXRsaW5lLl9yZXNjYWxlQW5kU3dhcCh0aGlzLiNwb2ludHMsIHRyWCwgdHJZLCAtd2lkdGgsIC1oZWlnaHQpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgb3V0bGluZTogQXJyYXkuZnJvbShvdXRsaW5lKSwKICAgICAgcG9pbnRzOiBbQXJyYXkuZnJvbShwb2ludHMpXQogICAgfTsKICB9CiAgI2NvbXB1dGVNaW5NYXgoaXNMVFIpIHsKICAgIGNvbnN0IG91dGxpbmUgPSB0aGlzLiNvdXRsaW5lOwogICAgbGV0IGxhc3RYID0gb3V0bGluZVs0XTsKICAgIGxldCBsYXN0WSA9IG91dGxpbmVbNV07CiAgICBjb25zdCBtaW5NYXggPSBbbGFzdFgsIGxhc3RZLCBsYXN0WCwgbGFzdFldOwogICAgbGV0IGZpcnN0UG9pbnRYID0gbGFzdFg7CiAgICBsZXQgZmlyc3RQb2ludFkgPSBsYXN0WTsKICAgIGxldCBsYXN0UG9pbnRYID0gbGFzdFg7CiAgICBsZXQgbGFzdFBvaW50WSA9IGxhc3RZOwogICAgY29uc3QgbHRyQ2FsbGJhY2sgPSBpc0xUUiA/IE1hdGgubWF4IDogTWF0aC5taW47CiAgICBjb25zdCBiZXppZXJCYm94ID0gbmV3IEZsb2F0MzJBcnJheSg0KTsKICAgIGZvciAobGV0IGkgPSA2LCBpaSA9IG91dGxpbmUubGVuZ3RoOyBpIDwgaWk7IGkgKz0gNikgewogICAgICBjb25zdCB4ID0gb3V0bGluZVtpICsgNF0sIHkgPSBvdXRsaW5lW2kgKyA1XTsKICAgICAgaWYgKGlzTmFOKG91dGxpbmVbaV0pKSB7CiAgICAgICAgVXRpbC5wb2ludEJvdW5kaW5nQm94KHgsIHksIG1pbk1heCk7CiAgICAgICAgaWYgKGZpcnN0UG9pbnRZID4geSkgewogICAgICAgICAgZmlyc3RQb2ludFggPSB4OwogICAgICAgICAgZmlyc3RQb2ludFkgPSB5OwogICAgICAgIH0gZWxzZSBpZiAoZmlyc3RQb2ludFkgPT09IHkpIHsKICAgICAgICAgIGZpcnN0UG9pbnRYID0gbHRyQ2FsbGJhY2soZmlyc3RQb2ludFgsIHgpOwogICAgICAgIH0KICAgICAgICBpZiAobGFzdFBvaW50WSA8IHkpIHsKICAgICAgICAgIGxhc3RQb2ludFggPSB4OwogICAgICAgICAgbGFzdFBvaW50WSA9IHk7CiAgICAgICAgfSBlbHNlIGlmIChsYXN0UG9pbnRZID09PSB5KSB7CiAgICAgICAgICBsYXN0UG9pbnRYID0gbHRyQ2FsbGJhY2sobGFzdFBvaW50WCwgeCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGJlemllckJib3hbMF0gPSBiZXppZXJCYm94WzFdID0gSW5maW5pdHk7CiAgICAgICAgYmV6aWVyQmJveFsyXSA9IGJlemllckJib3hbM10gPSAtSW5maW5pdHk7CiAgICAgICAgVXRpbC5iZXppZXJCb3VuZGluZ0JveChsYXN0WCwgbGFzdFksIC4uLm91dGxpbmUuc2xpY2UoaSwgaSArIDYpLCBiZXppZXJCYm94KTsKICAgICAgICBVdGlsLnJlY3RCb3VuZGluZ0JveChiZXppZXJCYm94WzBdLCBiZXppZXJCYm94WzFdLCBiZXppZXJCYm94WzJdLCBiZXppZXJCYm94WzNdLCBtaW5NYXgpOwogICAgICAgIGlmIChmaXJzdFBvaW50WSA+IGJlemllckJib3hbMV0pIHsKICAgICAgICAgIGZpcnN0UG9pbnRYID0gYmV6aWVyQmJveFswXTsKICAgICAgICAgIGZpcnN0UG9pbnRZID0gYmV6aWVyQmJveFsxXTsKICAgICAgICB9IGVsc2UgaWYgKGZpcnN0UG9pbnRZID09PSBiZXppZXJCYm94WzFdKSB7CiAgICAgICAgICBmaXJzdFBvaW50WCA9IGx0ckNhbGxiYWNrKGZpcnN0UG9pbnRYLCBiZXppZXJCYm94WzBdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGxhc3RQb2ludFkgPCBiZXppZXJCYm94WzNdKSB7CiAgICAgICAgICBsYXN0UG9pbnRYID0gYmV6aWVyQmJveFsyXTsKICAgICAgICAgIGxhc3RQb2ludFkgPSBiZXppZXJCYm94WzNdOwogICAgICAgIH0gZWxzZSBpZiAobGFzdFBvaW50WSA9PT0gYmV6aWVyQmJveFszXSkgewogICAgICAgICAgbGFzdFBvaW50WCA9IGx0ckNhbGxiYWNrKGxhc3RQb2ludFgsIGJlemllckJib3hbMl0pOwogICAgICAgIH0KICAgICAgfQogICAgICBsYXN0WCA9IHg7CiAgICAgIGxhc3RZID0geTsKICAgIH0KICAgIGNvbnN0IGJib3ggPSB0aGlzLiNiYm94OwogICAgYmJveFswXSA9IG1pbk1heFswXSAtIHRoaXMuI2lubmVyTWFyZ2luOwogICAgYmJveFsxXSA9IG1pbk1heFsxXSAtIHRoaXMuI2lubmVyTWFyZ2luOwogICAgYmJveFsyXSA9IG1pbk1heFsyXSAtIG1pbk1heFswXSArIDIgKiB0aGlzLiNpbm5lck1hcmdpbjsKICAgIGJib3hbM10gPSBtaW5NYXhbM10gLSBtaW5NYXhbMV0gKyAyICogdGhpcy4jaW5uZXJNYXJnaW47CiAgICB0aGlzLmZpcnN0UG9pbnQgPSBbZmlyc3RQb2ludFgsIGZpcnN0UG9pbnRZXTsKICAgIHRoaXMubGFzdFBvaW50ID0gW2xhc3RQb2ludFgsIGxhc3RQb2ludFldOwogIH0KICBnZXQgYm94KCkgewogICAgcmV0dXJuIHRoaXMuI2Jib3g7CiAgfQogIG5ld091dGxpbmVyKHBvaW50LCBib3gsIHNjYWxlRmFjdG9yLCB0aGlja25lc3MsIGlzTFRSLCBpbm5lck1hcmdpbiA9IDApIHsKICAgIHJldHVybiBuZXcgRnJlZURyYXdPdXRsaW5lcihwb2ludCwgYm94LCBzY2FsZUZhY3RvciwgdGhpY2tuZXNzLCBpc0xUUiwgaW5uZXJNYXJnaW4pOwogIH0KICBnZXROZXdPdXRsaW5lKHRoaWNrbmVzcywgaW5uZXJNYXJnaW4pIHsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuI2Jib3g7CiAgICBjb25zdCBbbGF5ZXJYLCBsYXllclksIGxheWVyV2lkdGgsIGxheWVySGVpZ2h0XSA9IHRoaXMuI2JveDsKICAgIGNvbnN0IHN4ID0gd2lkdGggKiBsYXllcldpZHRoOwogICAgY29uc3Qgc3kgPSBoZWlnaHQgKiBsYXllckhlaWdodDsKICAgIGNvbnN0IHR4ID0geCAqIGxheWVyV2lkdGggKyBsYXllclg7CiAgICBjb25zdCB0eSA9IHkgKiBsYXllckhlaWdodCArIGxheWVyWTsKICAgIGNvbnN0IG91dGxpbmVyID0gdGhpcy5uZXdPdXRsaW5lcih7CiAgICAgIHg6IHRoaXMuI3BvaW50c1swXSAqIHN4ICsgdHgsCiAgICAgIHk6IHRoaXMuI3BvaW50c1sxXSAqIHN5ICsgdHkKICAgIH0sIHRoaXMuI2JveCwgdGhpcy4jc2NhbGVGYWN0b3IsIHRoaWNrbmVzcywgdGhpcy4jaXNMVFIsIGlubmVyTWFyZ2luID8/IHRoaXMuI2lubmVyTWFyZ2luKTsKICAgIGZvciAobGV0IGkgPSAyOyBpIDwgdGhpcy4jcG9pbnRzLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIG91dGxpbmVyLmFkZCh7CiAgICAgICAgeDogdGhpcy4jcG9pbnRzW2ldICogc3ggKyB0eCwKICAgICAgICB5OiB0aGlzLiNwb2ludHNbaSArIDFdICogc3kgKyB0eQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBvdXRsaW5lci5nZXRPdXRsaW5lcygpOwogIH0KfTsKdmFyIEhpZ2hsaWdodE91dGxpbmVyID0gY2xhc3MgewogICNib3g7CiAgI2ZpcnN0UG9pbnQ7CiAgI2xhc3RQb2ludDsKICAjdmVydGljYWxFZGdlcyA9IFtdOwogICNpbnRlcnZhbHMgPSBbXTsKICBjb25zdHJ1Y3Rvcihib3hlcywgYm9yZGVyV2lkdGggPSAwLCBpbm5lck1hcmdpbiA9IDAsIGlzTFRSID0gdHJ1ZSkgewogICAgY29uc3QgbWluTWF4ID0gW0luZmluaXR5LCBJbmZpbml0eSwgLUluZmluaXR5LCAtSW5maW5pdHldOwogICAgY29uc3QgTlVNQkVSX09GX0RJR0lUUyA9IDQ7CiAgICBjb25zdCBFUFNJTE9OID0gMTAgKiogLU5VTUJFUl9PRl9ESUdJVFM7CiAgICBmb3IgKGNvbnN0IHsKICAgICAgeCwKICAgICAgeSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSBvZiBib3hlcykgewogICAgICBjb25zdCB4MSA9IE1hdGguZmxvb3IoKHggLSBib3JkZXJXaWR0aCkgLyBFUFNJTE9OKSAqIEVQU0lMT047CiAgICAgIGNvbnN0IHgyID0gTWF0aC5jZWlsKCh4ICsgd2lkdGggKyBib3JkZXJXaWR0aCkgLyBFUFNJTE9OKSAqIEVQU0lMT047CiAgICAgIGNvbnN0IHkxID0gTWF0aC5mbG9vcigoeSAtIGJvcmRlcldpZHRoKSAvIEVQU0lMT04pICogRVBTSUxPTjsKICAgICAgY29uc3QgeTIgPSBNYXRoLmNlaWwoKHkgKyBoZWlnaHQgKyBib3JkZXJXaWR0aCkgLyBFUFNJTE9OKSAqIEVQU0lMT047CiAgICAgIGNvbnN0IGxlZnQgPSBbeDEsIHkxLCB5MiwgdHJ1ZV07CiAgICAgIGNvbnN0IHJpZ2h0ID0gW3gyLCB5MSwgeTIsIGZhbHNlXTsKICAgICAgdGhpcy4jdmVydGljYWxFZGdlcy5wdXNoKGxlZnQsIHJpZ2h0KTsKICAgICAgVXRpbC5yZWN0Qm91bmRpbmdCb3goeDEsIHkxLCB4MiwgeTIsIG1pbk1heCk7CiAgICB9CiAgICBjb25zdCBiYm94V2lkdGggPSBtaW5NYXhbMl0gLSBtaW5NYXhbMF0gKyAyICogaW5uZXJNYXJnaW47CiAgICBjb25zdCBiYm94SGVpZ2h0ID0gbWluTWF4WzNdIC0gbWluTWF4WzFdICsgMiAqIGlubmVyTWFyZ2luOwogICAgY29uc3Qgc2hpZnRlZE1pblggPSBtaW5NYXhbMF0gLSBpbm5lck1hcmdpbjsKICAgIGNvbnN0IHNoaWZ0ZWRNaW5ZID0gbWluTWF4WzFdIC0gaW5uZXJNYXJnaW47CiAgICBsZXQgZmlyc3RQb2ludFggPSBpc0xUUiA/IC1JbmZpbml0eSA6IEluZmluaXR5OwogICAgbGV0IGZpcnN0UG9pbnRZID0gSW5maW5pdHk7CiAgICBjb25zdCBsYXN0RWRnZSA9IHRoaXMuI3ZlcnRpY2FsRWRnZXMuYXQoaXNMVFIgPyAtMSA6IC0yKTsKICAgIGNvbnN0IGxhc3RQb2ludCA9IFtsYXN0RWRnZVswXSwgbGFzdEVkZ2VbMl1dOwogICAgZm9yIChjb25zdCBlZGdlIG9mIHRoaXMuI3ZlcnRpY2FsRWRnZXMpIHsKICAgICAgY29uc3QgW3gsIHkxLCB5MiwgbGVmdF0gPSBlZGdlOwogICAgICBpZiAoIWxlZnQgJiYgaXNMVFIpIHsKICAgICAgICBpZiAoeTEgPCBmaXJzdFBvaW50WSkgewogICAgICAgICAgZmlyc3RQb2ludFkgPSB5MTsKICAgICAgICAgIGZpcnN0UG9pbnRYID0geDsKICAgICAgICB9IGVsc2UgaWYgKHkxID09PSBmaXJzdFBvaW50WSkgewogICAgICAgICAgZmlyc3RQb2ludFggPSBNYXRoLm1heChmaXJzdFBvaW50WCwgeCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGxlZnQgJiYgIWlzTFRSKSB7CiAgICAgICAgaWYgKHkxIDwgZmlyc3RQb2ludFkpIHsKICAgICAgICAgIGZpcnN0UG9pbnRZID0geTE7CiAgICAgICAgICBmaXJzdFBvaW50WCA9IHg7CiAgICAgICAgfSBlbHNlIGlmICh5MSA9PT0gZmlyc3RQb2ludFkpIHsKICAgICAgICAgIGZpcnN0UG9pbnRYID0gTWF0aC5taW4oZmlyc3RQb2ludFgsIHgpOwogICAgICAgIH0KICAgICAgfQogICAgICBlZGdlWzBdID0gKHggLSBzaGlmdGVkTWluWCkgLyBiYm94V2lkdGg7CiAgICAgIGVkZ2VbMV0gPSAoeTEgLSBzaGlmdGVkTWluWSkgLyBiYm94SGVpZ2h0OwogICAgICBlZGdlWzJdID0gKHkyIC0gc2hpZnRlZE1pblkpIC8gYmJveEhlaWdodDsKICAgIH0KICAgIHRoaXMuI2JveCA9IG5ldyBGbG9hdDMyQXJyYXkoW3NoaWZ0ZWRNaW5YLCBzaGlmdGVkTWluWSwgYmJveFdpZHRoLCBiYm94SGVpZ2h0XSk7CiAgICB0aGlzLiNmaXJzdFBvaW50ID0gW2ZpcnN0UG9pbnRYLCBmaXJzdFBvaW50WV07CiAgICB0aGlzLiNsYXN0UG9pbnQgPSBsYXN0UG9pbnQ7CiAgfQogIGdldE91dGxpbmVzKCkgewogICAgdGhpcy4jdmVydGljYWxFZGdlcy5zb3J0KChhLCBiKSA9PiBhWzBdIC0gYlswXSB8fCBhWzFdIC0gYlsxXSB8fCBhWzJdIC0gYlsyXSk7CiAgICBjb25zdCBvdXRsaW5lVmVydGljYWxFZGdlcyA9IFtdOwogICAgZm9yIChjb25zdCBlZGdlIG9mIHRoaXMuI3ZlcnRpY2FsRWRnZXMpIHsKICAgICAgaWYgKGVkZ2VbM10pIHsKICAgICAgICBvdXRsaW5lVmVydGljYWxFZGdlcy5wdXNoKC4uLnRoaXMuI2JyZWFrRWRnZShlZGdlKSk7CiAgICAgICAgdGhpcy4jaW5zZXJ0KGVkZ2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuI3JlbW92ZShlZGdlKTsKICAgICAgICBvdXRsaW5lVmVydGljYWxFZGdlcy5wdXNoKC4uLnRoaXMuI2JyZWFrRWRnZShlZGdlKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzLiNnZXRPdXRsaW5lcyhvdXRsaW5lVmVydGljYWxFZGdlcyk7CiAgfQogICNnZXRPdXRsaW5lcyhvdXRsaW5lVmVydGljYWxFZGdlcykgewogICAgY29uc3QgZWRnZXMgPSBbXTsKICAgIGNvbnN0IGFsbEVkZ2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZWRnZSBvZiBvdXRsaW5lVmVydGljYWxFZGdlcykgewogICAgICBjb25zdCBbeCwgeTEsIHkyXSA9IGVkZ2U7CiAgICAgIGVkZ2VzLnB1c2goW3gsIHkxLCBlZGdlXSwgW3gsIHkyLCBlZGdlXSk7CiAgICB9CiAgICBlZGdlcy5zb3J0KChhLCBiKSA9PiBhWzFdIC0gYlsxXSB8fCBhWzBdIC0gYlswXSk7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBlZGdlcy5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgIGNvbnN0IGVkZ2UxID0gZWRnZXNbaV1bMl07CiAgICAgIGNvbnN0IGVkZ2UyID0gZWRnZXNbaSArIDFdWzJdOwogICAgICBlZGdlMS5wdXNoKGVkZ2UyKTsKICAgICAgZWRnZTIucHVzaChlZGdlMSk7CiAgICAgIGFsbEVkZ2VzLmFkZChlZGdlMSk7CiAgICAgIGFsbEVkZ2VzLmFkZChlZGdlMik7CiAgICB9CiAgICBjb25zdCBvdXRsaW5lcyA9IFtdOwogICAgbGV0IG91dGxpbmU7CiAgICB3aGlsZSAoYWxsRWRnZXMuc2l6ZSA+IDApIHsKICAgICAgY29uc3QgZWRnZSA9IGFsbEVkZ2VzLnZhbHVlcygpLm5leHQoKS52YWx1ZTsKICAgICAgbGV0IFt4LCB5MSwgeTIsIGVkZ2UxLCBlZGdlMl0gPSBlZGdlOwogICAgICBhbGxFZGdlcy5kZWxldGUoZWRnZSk7CiAgICAgIGxldCBsYXN0UG9pbnRYID0geDsKICAgICAgbGV0IGxhc3RQb2ludFkgPSB5MTsKICAgICAgb3V0bGluZSA9IFt4LCB5Ml07CiAgICAgIG91dGxpbmVzLnB1c2gob3V0bGluZSk7CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgbGV0IGU7CiAgICAgICAgaWYgKGFsbEVkZ2VzLmhhcyhlZGdlMSkpIHsKICAgICAgICAgIGUgPSBlZGdlMTsKICAgICAgICB9IGVsc2UgaWYgKGFsbEVkZ2VzLmhhcyhlZGdlMikpIHsKICAgICAgICAgIGUgPSBlZGdlMjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGFsbEVkZ2VzLmRlbGV0ZShlKTsKICAgICAgICBbeCwgeTEsIHkyLCBlZGdlMSwgZWRnZTJdID0gZTsKICAgICAgICBpZiAobGFzdFBvaW50WCAhPT0geCkgewogICAgICAgICAgb3V0bGluZS5wdXNoKGxhc3RQb2ludFgsIGxhc3RQb2ludFksIHgsIGxhc3RQb2ludFkgPT09IHkxID8geTEgOiB5Mik7CiAgICAgICAgICBsYXN0UG9pbnRYID0geDsKICAgICAgICB9CiAgICAgICAgbGFzdFBvaW50WSA9IGxhc3RQb2ludFkgPT09IHkxID8geTIgOiB5MTsKICAgICAgfQogICAgICBvdXRsaW5lLnB1c2gobGFzdFBvaW50WCwgbGFzdFBvaW50WSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEhpZ2hsaWdodE91dGxpbmUob3V0bGluZXMsIHRoaXMuI2JveCwgdGhpcy4jZmlyc3RQb2ludCwgdGhpcy4jbGFzdFBvaW50KTsKICB9CiAgI2JpbmFyeVNlYXJjaCh5KSB7CiAgICBjb25zdCBhcnJheSA9IHRoaXMuI2ludGVydmFsczsKICAgIGxldCBzdGFydCA9IDA7CiAgICBsZXQgZW5kID0gYXJyYXkubGVuZ3RoIC0gMTsKICAgIHdoaWxlIChzdGFydCA8PSBlbmQpIHsKICAgICAgY29uc3QgbWlkZGxlID0gc3RhcnQgKyBlbmQgPj4gMTsKICAgICAgY29uc3QgeTEgPSBhcnJheVttaWRkbGVdWzBdOwogICAgICBpZiAoeTEgPT09IHkpIHsKICAgICAgICByZXR1cm4gbWlkZGxlOwogICAgICB9CiAgICAgIGlmICh5MSA8IHkpIHsKICAgICAgICBzdGFydCA9IG1pZGRsZSArIDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5kID0gbWlkZGxlIC0gMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGVuZCArIDE7CiAgfQogICNpbnNlcnQoWywgeTEsIHkyXSkgewogICAgY29uc3QgaW5kZXggPSB0aGlzLiNiaW5hcnlTZWFyY2goeTEpOwogICAgdGhpcy4jaW50ZXJ2YWxzLnNwbGljZShpbmRleCwgMCwgW3kxLCB5Ml0pOwogIH0KICAjcmVtb3ZlKFssIHkxLCB5Ml0pIHsKICAgIGNvbnN0IGluZGV4ID0gdGhpcy4jYmluYXJ5U2VhcmNoKHkxKTsKICAgIGZvciAobGV0IGkgPSBpbmRleDsgaSA8IHRoaXMuI2ludGVydmFscy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSB0aGlzLiNpbnRlcnZhbHNbaV07CiAgICAgIGlmIChzdGFydCAhPT0geTEpIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBpZiAoc3RhcnQgPT09IHkxICYmIGVuZCA9PT0geTIpIHsKICAgICAgICB0aGlzLiNpbnRlcnZhbHMuc3BsaWNlKGksIDEpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgZm9yIChsZXQgaSA9IGluZGV4IC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgW3N0YXJ0LCBlbmRdID0gdGhpcy4jaW50ZXJ2YWxzW2ldOwogICAgICBpZiAoc3RhcnQgIT09IHkxKSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgaWYgKHN0YXJ0ID09PSB5MSAmJiBlbmQgPT09IHkyKSB7CiAgICAgICAgdGhpcy4jaW50ZXJ2YWxzLnNwbGljZShpLCAxKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CiAgI2JyZWFrRWRnZShlZGdlKSB7CiAgICBjb25zdCBbeCwgeTEsIHkyXSA9IGVkZ2U7CiAgICBjb25zdCByZXN1bHRzID0gW1t4LCB5MSwgeTJdXTsKICAgIGNvbnN0IGluZGV4ID0gdGhpcy4jYmluYXJ5U2VhcmNoKHkyKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXg7IGkrKykgewogICAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSB0aGlzLiNpbnRlcnZhbHNbaV07CiAgICAgIGZvciAobGV0IGogPSAwLCBqaiA9IHJlc3VsdHMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgIGNvbnN0IFssIHkzLCB5NF0gPSByZXN1bHRzW2pdOwogICAgICAgIGlmIChlbmQgPD0geTMgfHwgeTQgPD0gc3RhcnQpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoeTMgPj0gc3RhcnQpIHsKICAgICAgICAgIGlmICh5NCA+IGVuZCkgewogICAgICAgICAgICByZXN1bHRzW2pdWzFdID0gZW5kOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGpqID09PSAxKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3VsdHMuc3BsaWNlKGosIDEpOwogICAgICAgICAgICBqLS07CiAgICAgICAgICAgIGpqLS07CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0c1tqXVsyXSA9IHN0YXJ0OwogICAgICAgIGlmICh5NCA+IGVuZCkgewogICAgICAgICAgcmVzdWx0cy5wdXNoKFt4LCBlbmQsIHk0XSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0czsKICB9Cn07CnZhciBIaWdobGlnaHRPdXRsaW5lID0gY2xhc3MgZXh0ZW5kcyBPdXRsaW5lIHsKICAjYm94OwogICNvdXRsaW5lczsKICBjb25zdHJ1Y3RvcihvdXRsaW5lcywgYm94LCBmaXJzdFBvaW50LCBsYXN0UG9pbnQpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLiNvdXRsaW5lcyA9IG91dGxpbmVzOwogICAgdGhpcy4jYm94ID0gYm94OwogICAgdGhpcy5maXJzdFBvaW50ID0gZmlyc3RQb2ludDsKICAgIHRoaXMubGFzdFBvaW50ID0gbGFzdFBvaW50OwogIH0KICB0b1NWR1BhdGgoKSB7CiAgICBjb25zdCBidWZmZXIgPSBbXTsKICAgIGZvciAoY29uc3QgcG9seWdvbiBvZiB0aGlzLiNvdXRsaW5lcykgewogICAgICBsZXQgW3ByZXZYLCBwcmV2WV0gPSBwb2x5Z29uOwogICAgICBidWZmZXIucHVzaChgTSR7cHJldlh9ICR7cHJldll9YCk7CiAgICAgIGZvciAobGV0IGkgPSAyOyBpIDwgcG9seWdvbi5sZW5ndGg7IGkgKz0gMikgewogICAgICAgIGNvbnN0IHggPSBwb2x5Z29uW2ldOwogICAgICAgIGNvbnN0IHkgPSBwb2x5Z29uW2kgKyAxXTsKICAgICAgICBpZiAoeCA9PT0gcHJldlgpIHsKICAgICAgICAgIGJ1ZmZlci5wdXNoKGBWJHt5fWApOwogICAgICAgICAgcHJldlkgPSB5OwogICAgICAgIH0gZWxzZSBpZiAoeSA9PT0gcHJldlkpIHsKICAgICAgICAgIGJ1ZmZlci5wdXNoKGBIJHt4fWApOwogICAgICAgICAgcHJldlggPSB4OwogICAgICAgIH0KICAgICAgfQogICAgICBidWZmZXIucHVzaCgiWiIpOwogICAgfQogICAgcmV0dXJuIGJ1ZmZlci5qb2luKCIgIik7CiAgfQogIHNlcmlhbGl6ZShbYmxYLCBibFksIHRyWCwgdHJZXSwgX3JvdGF0aW9uKSB7CiAgICBjb25zdCBvdXRsaW5lcyA9IFtdOwogICAgY29uc3Qgd2lkdGggPSB0clggLSBibFg7CiAgICBjb25zdCBoZWlnaHQgPSB0clkgLSBibFk7CiAgICBmb3IgKGNvbnN0IG91dGxpbmUgb2YgdGhpcy4jb3V0bGluZXMpIHsKICAgICAgY29uc3QgcG9pbnRzID0gbmV3IEFycmF5KG91dGxpbmUubGVuZ3RoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvdXRsaW5lLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgcG9pbnRzW2ldID0gYmxYICsgb3V0bGluZVtpXSAqIHdpZHRoOwogICAgICAgIHBvaW50c1tpICsgMV0gPSB0clkgLSBvdXRsaW5lW2kgKyAxXSAqIGhlaWdodDsKICAgICAgfQogICAgICBvdXRsaW5lcy5wdXNoKHBvaW50cyk7CiAgICB9CiAgICByZXR1cm4gb3V0bGluZXM7CiAgfQogIGdldCBib3goKSB7CiAgICByZXR1cm4gdGhpcy4jYm94OwogIH0KICBnZXQgY2xhc3NOYW1lc0Zvck91dGxpbmluZygpIHsKICAgIHJldHVybiBbImhpZ2hsaWdodE91dGxpbmUiXTsKICB9Cn07CnZhciBGcmVlSGlnaGxpZ2h0T3V0bGluZXIgPSBjbGFzcyBleHRlbmRzIEZyZWVEcmF3T3V0bGluZXIgewogIG5ld0ZyZWVEcmF3T3V0bGluZShvdXRsaW5lLCBwb2ludHMsIGJveCwgc2NhbGVGYWN0b3IsIGlubmVyTWFyZ2luLCBpc0xUUikgewogICAgcmV0dXJuIG5ldyBGcmVlSGlnaGxpZ2h0T3V0bGluZShvdXRsaW5lLCBwb2ludHMsIGJveCwgc2NhbGVGYWN0b3IsIGlubmVyTWFyZ2luLCBpc0xUUik7CiAgfQp9Owp2YXIgRnJlZUhpZ2hsaWdodE91dGxpbmUgPSBjbGFzcyBleHRlbmRzIEZyZWVEcmF3T3V0bGluZSB7CiAgbmV3T3V0bGluZXIocG9pbnQsIGJveCwgc2NhbGVGYWN0b3IsIHRoaWNrbmVzcywgaXNMVFIsIGlubmVyTWFyZ2luID0gMCkgewogICAgcmV0dXJuIG5ldyBGcmVlSGlnaGxpZ2h0T3V0bGluZXIocG9pbnQsIGJveCwgc2NhbGVGYWN0b3IsIHRoaWNrbmVzcywgaXNMVFIsIGlubmVyTWFyZ2luKTsKICB9Cn07CnZhciBIaWdobGlnaHRFZGl0b3IgPSBjbGFzcyBfSGlnaGxpZ2h0RWRpdG9yIGV4dGVuZHMgQW5ub3RhdGlvbkVkaXRvciB7CiAgI2FuY2hvck5vZGUgPSBudWxsOwogICNhbmNob3JPZmZzZXQgPSAwOwogICNib3hlczsKICAjY2xpcFBhdGhJZCA9IG51bGw7CiAgI2NvbG9yUGlja2VyID0gbnVsbDsKICAjZm9jdXNPdXRsaW5lcyA9IG51bGw7CiAgI2ZvY3VzTm9kZSA9IG51bGw7CiAgI2ZvY3VzT2Zmc2V0ID0gMDsKICAjaGlnaGxpZ2h0RGl2ID0gbnVsbDsKICAjaGlnaGxpZ2h0T3V0bGluZXMgPSBudWxsOwogICNpZCA9IG51bGw7CiAgI2lzRnJlZUhpZ2hsaWdodCA9IGZhbHNlOwogICNmaXJzdFBvaW50ID0gbnVsbDsKICAjbGFzdFBvaW50ID0gbnVsbDsKICAjb3V0bGluZUlkID0gbnVsbDsKICAjdGV4dCA9ICIiOwogICN0aGlja25lc3M7CiAgI21ldGhvZE9mQ3JlYXRpb24gPSAiIjsKICBzdGF0aWMgX2RlZmF1bHRDb2xvciA9IG51bGw7CiAgc3RhdGljIF9kZWZhdWx0T3BhY2l0eSA9IDE7CiAgc3RhdGljIF9kZWZhdWx0VGhpY2tuZXNzID0gMTI7CiAgc3RhdGljIF90eXBlID0gImhpZ2hsaWdodCI7CiAgc3RhdGljIF9lZGl0b3JUeXBlID0gQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hUOwogIHN0YXRpYyBfZnJlZUhpZ2hsaWdodElkID0gLTE7CiAgc3RhdGljIF9mcmVlSGlnaGxpZ2h0ID0gbnVsbDsKICBzdGF0aWMgX2ZyZWVIaWdobGlnaHRDbGlwSWQgPSAiIjsKICBzdGF0aWMgZ2V0IF9rZXlib2FyZE1hbmFnZXIoKSB7CiAgICBjb25zdCBwcm90byA9IF9IaWdobGlnaHRFZGl0b3IucHJvdG90eXBlOwogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAiX2tleWJvYXJkTWFuYWdlciIsIG5ldyBLZXlib2FyZE1hbmFnZXIoW1tbIkFycm93TGVmdCIsICJtYWMrQXJyb3dMZWZ0Il0sIHByb3RvLl9tb3ZlQ2FyZXQsIHsKICAgICAgYXJnczogWzBdCiAgICB9XSwgW1siQXJyb3dSaWdodCIsICJtYWMrQXJyb3dSaWdodCJdLCBwcm90by5fbW92ZUNhcmV0LCB7CiAgICAgIGFyZ3M6IFsxXQogICAgfV0sIFtbIkFycm93VXAiLCAibWFjK0Fycm93VXAiXSwgcHJvdG8uX21vdmVDYXJldCwgewogICAgICBhcmdzOiBbMl0KICAgIH1dLCBbWyJBcnJvd0Rvd24iLCAibWFjK0Fycm93RG93biJdLCBwcm90by5fbW92ZUNhcmV0LCB7CiAgICAgIGFyZ3M6IFszXQogICAgfV1dKSk7CiAgfQogIGNvbnN0cnVjdG9yKHBhcmFtcykgewogICAgc3VwZXIoewogICAgICAuLi5wYXJhbXMsCiAgICAgIG5hbWU6ICJoaWdobGlnaHRFZGl0b3IiCiAgICB9KTsKICAgIHRoaXMuY29sb3IgPSBwYXJhbXMuY29sb3IgfHwgX0hpZ2hsaWdodEVkaXRvci5fZGVmYXVsdENvbG9yOwogICAgdGhpcy4jdGhpY2tuZXNzID0gcGFyYW1zLnRoaWNrbmVzcyB8fCBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0VGhpY2tuZXNzOwogICAgdGhpcy5vcGFjaXR5ID0gcGFyYW1zLm9wYWNpdHkgfHwgX0hpZ2hsaWdodEVkaXRvci5fZGVmYXVsdE9wYWNpdHk7CiAgICB0aGlzLiNib3hlcyA9IHBhcmFtcy5ib3hlcyB8fCBudWxsOwogICAgdGhpcy4jbWV0aG9kT2ZDcmVhdGlvbiA9IHBhcmFtcy5tZXRob2RPZkNyZWF0aW9uIHx8ICIiOwogICAgdGhpcy4jdGV4dCA9IHBhcmFtcy50ZXh0IHx8ICIiOwogICAgdGhpcy5faXNEcmFnZ2FibGUgPSBmYWxzZTsKICAgIHRoaXMuZGVmYXVsdEwxMG5JZCA9ICJwZGZqcy1lZGl0b3ItaGlnaGxpZ2h0LWVkaXRvciI7CiAgICBpZiAocGFyYW1zLmhpZ2hsaWdodElkID4gLTEpIHsKICAgICAgdGhpcy4jaXNGcmVlSGlnaGxpZ2h0ID0gdHJ1ZTsKICAgICAgdGhpcy4jY3JlYXRlRnJlZU91dGxpbmVzKHBhcmFtcyk7CiAgICAgIHRoaXMuI2FkZFRvRHJhd0xheWVyKCk7CiAgICB9IGVsc2UgaWYgKHRoaXMuI2JveGVzKSB7CiAgICAgIHRoaXMuI2FuY2hvck5vZGUgPSBwYXJhbXMuYW5jaG9yTm9kZTsKICAgICAgdGhpcy4jYW5jaG9yT2Zmc2V0ID0gcGFyYW1zLmFuY2hvck9mZnNldDsKICAgICAgdGhpcy4jZm9jdXNOb2RlID0gcGFyYW1zLmZvY3VzTm9kZTsKICAgICAgdGhpcy4jZm9jdXNPZmZzZXQgPSBwYXJhbXMuZm9jdXNPZmZzZXQ7CiAgICAgIHRoaXMuI2NyZWF0ZU91dGxpbmVzKCk7CiAgICAgIHRoaXMuI2FkZFRvRHJhd0xheWVyKCk7CiAgICAgIHRoaXMucm90YXRlKHRoaXMucm90YXRpb24pOwogICAgfQogICAgaWYgKCF0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLmExMXlBbGVydCgicGRmanMtZWRpdG9yLWhpZ2hsaWdodC1hZGRlZC1hbGVydCIpOwogICAgfQogIH0KICBnZXQgdGVsZW1ldHJ5SW5pdGlhbERhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBhY3Rpb246ICJhZGRlZCIsCiAgICAgIHR5cGU6IHRoaXMuI2lzRnJlZUhpZ2hsaWdodCA/ICJmcmVlX2hpZ2hsaWdodCIgOiAiaGlnaGxpZ2h0IiwKICAgICAgY29sb3I6IHRoaXMuX3VpTWFuYWdlci5nZXROb25IQ01Db2xvck5hbWUodGhpcy5jb2xvciksCiAgICAgIHRoaWNrbmVzczogdGhpcy4jdGhpY2tuZXNzLAogICAgICBtZXRob2RPZkNyZWF0aW9uOiB0aGlzLiNtZXRob2RPZkNyZWF0aW9uCiAgICB9OwogIH0KICBnZXQgdGVsZW1ldHJ5RmluYWxEYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogImhpZ2hsaWdodCIsCiAgICAgIGNvbG9yOiB0aGlzLl91aU1hbmFnZXIuZ2V0Tm9uSENNQ29sb3JOYW1lKHRoaXMuY29sb3IpCiAgICB9OwogIH0KICBzdGF0aWMgY29tcHV0ZVRlbGVtZXRyeUZpbmFsRGF0YShkYXRhKSB7CiAgICByZXR1cm4gewogICAgICBudW1iZXJPZkNvbG9yczogZGF0YS5nZXQoImNvbG9yIikuc2l6ZQogICAgfTsKICB9CiAgI2NyZWF0ZU91dGxpbmVzKCkgewogICAgY29uc3Qgb3V0bGluZXIgPSBuZXcgSGlnaGxpZ2h0T3V0bGluZXIodGhpcy4jYm94ZXMsIDFlLTMpOwogICAgdGhpcy4jaGlnaGxpZ2h0T3V0bGluZXMgPSBvdXRsaW5lci5nZXRPdXRsaW5lcygpOwogICAgW3RoaXMueCwgdGhpcy55LCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodF0gPSB0aGlzLiNoaWdobGlnaHRPdXRsaW5lcy5ib3g7CiAgICBjb25zdCBvdXRsaW5lckZvck91dGxpbmUgPSBuZXcgSGlnaGxpZ2h0T3V0bGluZXIodGhpcy4jYm94ZXMsIDI1ZS00LCAxZS0zLCB0aGlzLl91aU1hbmFnZXIuZGlyZWN0aW9uID09PSAibHRyIik7CiAgICB0aGlzLiNmb2N1c091dGxpbmVzID0gb3V0bGluZXJGb3JPdXRsaW5lLmdldE91dGxpbmVzKCk7CiAgICBjb25zdCB7CiAgICAgIGZpcnN0UG9pbnQKICAgIH0gPSB0aGlzLiNoaWdobGlnaHRPdXRsaW5lczsKICAgIHRoaXMuI2ZpcnN0UG9pbnQgPSBbKGZpcnN0UG9pbnRbMF0gLSB0aGlzLngpIC8gdGhpcy53aWR0aCwgKGZpcnN0UG9pbnRbMV0gLSB0aGlzLnkpIC8gdGhpcy5oZWlnaHRdOwogICAgY29uc3QgewogICAgICBsYXN0UG9pbnQKICAgIH0gPSB0aGlzLiNmb2N1c091dGxpbmVzOwogICAgdGhpcy4jbGFzdFBvaW50ID0gWyhsYXN0UG9pbnRbMF0gLSB0aGlzLngpIC8gdGhpcy53aWR0aCwgKGxhc3RQb2ludFsxXSAtIHRoaXMueSkgLyB0aGlzLmhlaWdodF07CiAgfQogICNjcmVhdGVGcmVlT3V0bGluZXMoewogICAgaGlnaGxpZ2h0T3V0bGluZXMsCiAgICBoaWdobGlnaHRJZCwKICAgIGNsaXBQYXRoSWQKICB9KSB7CiAgICB0aGlzLiNoaWdobGlnaHRPdXRsaW5lcyA9IGhpZ2hsaWdodE91dGxpbmVzOwogICAgY29uc3QgZXh0cmFUaGlja25lc3MgPSAxLjU7CiAgICB0aGlzLiNmb2N1c091dGxpbmVzID0gaGlnaGxpZ2h0T3V0bGluZXMuZ2V0TmV3T3V0bGluZSh0aGlzLiN0aGlja25lc3MgLyAyICsgZXh0cmFUaGlja25lc3MsIDI1ZS00KTsKICAgIGlmIChoaWdobGlnaHRJZCA+PSAwKSB7CiAgICAgIHRoaXMuI2lkID0gaGlnaGxpZ2h0SWQ7CiAgICAgIHRoaXMuI2NsaXBQYXRoSWQgPSBjbGlwUGF0aElkOwogICAgICB0aGlzLnBhcmVudC5kcmF3TGF5ZXIuZmluYWxpemVEcmF3KGhpZ2hsaWdodElkLCB7CiAgICAgICAgYmJveDogaGlnaGxpZ2h0T3V0bGluZXMuYm94LAogICAgICAgIHBhdGg6IHsKICAgICAgICAgIGQ6IGhpZ2hsaWdodE91dGxpbmVzLnRvU1ZHUGF0aCgpCiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy4jb3V0bGluZUlkID0gdGhpcy5wYXJlbnQuZHJhd0xheWVyLmRyYXdPdXRsaW5lKHsKICAgICAgICByb290Q2xhc3M6IHsKICAgICAgICAgIGhpZ2hsaWdodE91dGxpbmU6IHRydWUsCiAgICAgICAgICBmcmVlOiB0cnVlCiAgICAgICAgfSwKICAgICAgICBiYm94OiB0aGlzLiNmb2N1c091dGxpbmVzLmJveCwKICAgICAgICBwYXRoOiB7CiAgICAgICAgICBkOiB0aGlzLiNmb2N1c091dGxpbmVzLnRvU1ZHUGF0aCgpCiAgICAgICAgfQogICAgICB9LCB0cnVlKTsKICAgIH0gZWxzZSBpZiAodGhpcy5wYXJlbnQpIHsKICAgICAgY29uc3QgYW5nbGUgPSB0aGlzLnBhcmVudC52aWV3cG9ydC5yb3RhdGlvbjsKICAgICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jaWQsIHsKICAgICAgICBiYm94OiBfSGlnaGxpZ2h0RWRpdG9yLiNyb3RhdGVCYm94KHRoaXMuI2hpZ2hsaWdodE91dGxpbmVzLmJveCwgKGFuZ2xlIC0gdGhpcy5yb3RhdGlvbiArIDM2MCkgJSAzNjApLAogICAgICAgIHBhdGg6IHsKICAgICAgICAgIGQ6IGhpZ2hsaWdodE91dGxpbmVzLnRvU1ZHUGF0aCgpCiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jb3V0bGluZUlkLCB7CiAgICAgICAgYmJveDogX0hpZ2hsaWdodEVkaXRvci4jcm90YXRlQmJveCh0aGlzLiNmb2N1c091dGxpbmVzLmJveCwgYW5nbGUpLAogICAgICAgIHBhdGg6IHsKICAgICAgICAgIGQ6IHRoaXMuI2ZvY3VzT3V0bGluZXMudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgY29uc3QgW3gsIHksIHdpZHRoLCBoZWlnaHRdID0gaGlnaGxpZ2h0T3V0bGluZXMuYm94OwogICAgc3dpdGNoICh0aGlzLnJvdGF0aW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDkwOiB7CiAgICAgICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICAgICAgdGhpcy54ID0geTsKICAgICAgICB0aGlzLnkgPSAxIC0geDsKICAgICAgICB0aGlzLndpZHRoID0gd2lkdGggKiBwYWdlSGVpZ2h0IC8gcGFnZVdpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0ICogcGFnZVdpZHRoIC8gcGFnZUhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDE4MDoKICAgICAgICB0aGlzLnggPSAxIC0geDsKICAgICAgICB0aGlzLnkgPSAxIC0geTsKICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjcwOiB7CiAgICAgICAgY29uc3QgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICAgICAgdGhpcy54ID0gMSAtIHk7CiAgICAgICAgdGhpcy55ID0geDsKICAgICAgICB0aGlzLndpZHRoID0gd2lkdGggKiBwYWdlSGVpZ2h0IC8gcGFnZVdpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0ICogcGFnZVdpZHRoIC8gcGFnZUhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgY29uc3QgewogICAgICBmaXJzdFBvaW50CiAgICB9ID0gaGlnaGxpZ2h0T3V0bGluZXM7CiAgICB0aGlzLiNmaXJzdFBvaW50ID0gWyhmaXJzdFBvaW50WzBdIC0geCkgLyB3aWR0aCwgKGZpcnN0UG9pbnRbMV0gLSB5KSAvIGhlaWdodF07CiAgICBjb25zdCB7CiAgICAgIGxhc3RQb2ludAogICAgfSA9IHRoaXMuI2ZvY3VzT3V0bGluZXM7CiAgICB0aGlzLiNsYXN0UG9pbnQgPSBbKGxhc3RQb2ludFswXSAtIHgpIC8gd2lkdGgsIChsYXN0UG9pbnRbMV0gLSB5KSAvIGhlaWdodF07CiAgfQogIHN0YXRpYyBpbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcikgewogICAgQW5ub3RhdGlvbkVkaXRvci5pbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcik7CiAgICBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0Q29sb3IgfHw9IHVpTWFuYWdlci5oaWdobGlnaHRDb2xvcnM/LnZhbHVlcygpLm5leHQoKS52YWx1ZSB8fCAiI2ZmZjA2NiI7CiAgfQogIHN0YXRpYyB1cGRhdGVEZWZhdWx0UGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfQ09MT1I6CiAgICAgICAgX0hpZ2hsaWdodEVkaXRvci5fZGVmYXVsdENvbG9yID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX1RISUNLTkVTUzoKICAgICAgICBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0VGhpY2tuZXNzID0gdmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHRyYW5zbGF0ZUluUGFnZSh4LCB5KSB7CiAgfQogIGdldCB0b29sYmFyUG9zaXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy4jbGFzdFBvaW50OwogIH0KICBnZXQgY29tbWVudEJ1dHRvblBvc2l0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuI2ZpcnN0UG9pbnQ7CiAgfQogIHVwZGF0ZVBhcmFtcyh0eXBlLCB2YWx1ZSkgewogICAgc3dpdGNoICh0eXBlKSB7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX0NPTE9SOgogICAgICAgIHRoaXMuI3VwZGF0ZUNvbG9yKHZhbHVlKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZS5ISUdITElHSFRfVEhJQ0tORVNTOgogICAgICAgIHRoaXMuI3VwZGF0ZVRoaWNrbmVzcyh2YWx1ZSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHN0YXRpYyBnZXQgZGVmYXVsdFByb3BlcnRpZXNUb1VwZGF0ZSgpIHsKICAgIHJldHVybiBbW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9DT0xPUiwgX0hpZ2hsaWdodEVkaXRvci5fZGVmYXVsdENvbG9yXSwgW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9USElDS05FU1MsIF9IaWdobGlnaHRFZGl0b3IuX2RlZmF1bHRUaGlja25lc3NdXTsKICB9CiAgZ2V0IHByb3BlcnRpZXNUb1VwZGF0ZSgpIHsKICAgIHJldHVybiBbW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkhJR0hMSUdIVF9DT0xPUiwgdGhpcy5jb2xvciB8fCBfSGlnaGxpZ2h0RWRpdG9yLl9kZWZhdWx0Q29sb3JdLCBbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX1RISUNLTkVTUywgdGhpcy4jdGhpY2tuZXNzIHx8IF9IaWdobGlnaHRFZGl0b3IuX2RlZmF1bHRUaGlja25lc3NdLCBbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX0ZSRUUsIHRoaXMuI2lzRnJlZUhpZ2hsaWdodF1dOwogIH0KICBvblVwZGF0ZWRDb2xvcigpIHsKICAgIHRoaXMucGFyZW50Py5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLiNpZCwgewogICAgICByb290OiB7CiAgICAgICAgZmlsbDogdGhpcy5jb2xvciwKICAgICAgICAiZmlsbC1vcGFjaXR5IjogdGhpcy5vcGFjaXR5CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy4jY29sb3JQaWNrZXI/LnVwZGF0ZUNvbG9yKHRoaXMuY29sb3IpOwogICAgc3VwZXIub25VcGRhdGVkQ29sb3IoKTsKICB9CiAgI3VwZGF0ZUNvbG9yKGNvbG9yKSB7CiAgICBjb25zdCBzZXRDb2xvckFuZE9wYWNpdHkgPSAoY29sLCBvcGEpID0+IHsKICAgICAgdGhpcy5jb2xvciA9IGNvbDsKICAgICAgdGhpcy5vcGFjaXR5ID0gb3BhOwogICAgICB0aGlzLm9uVXBkYXRlZENvbG9yKCk7CiAgICB9OwogICAgY29uc3Qgc2F2ZWRDb2xvciA9IHRoaXMuY29sb3I7CiAgICBjb25zdCBzYXZlZE9wYWNpdHkgPSB0aGlzLm9wYWNpdHk7CiAgICB0aGlzLmFkZENvbW1hbmRzKHsKICAgICAgY21kOiBzZXRDb2xvckFuZE9wYWNpdHkuYmluZCh0aGlzLCBjb2xvciwgX0hpZ2hsaWdodEVkaXRvci5fZGVmYXVsdE9wYWNpdHkpLAogICAgICB1bmRvOiBzZXRDb2xvckFuZE9wYWNpdHkuYmluZCh0aGlzLCBzYXZlZENvbG9yLCBzYXZlZE9wYWNpdHkpLAogICAgICBwb3N0OiB0aGlzLl91aU1hbmFnZXIudXBkYXRlVUkuYmluZCh0aGlzLl91aU1hbmFnZXIsIHRoaXMpLAogICAgICBtdXN0RXhlYzogdHJ1ZSwKICAgICAgdHlwZTogQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSElHSExJR0hUX0NPTE9SLAogICAgICBvdmVyd3JpdGVJZlNhbWVUeXBlOiB0cnVlLAogICAgICBrZWVwVW5kbzogdHJ1ZQogICAgfSk7CiAgICB0aGlzLl9yZXBvcnRUZWxlbWV0cnkoewogICAgICBhY3Rpb246ICJjb2xvcl9jaGFuZ2VkIiwKICAgICAgY29sb3I6IHRoaXMuX3VpTWFuYWdlci5nZXROb25IQ01Db2xvck5hbWUoY29sb3IpCiAgICB9LCB0cnVlKTsKICB9CiAgI3VwZGF0ZVRoaWNrbmVzcyh0aGlja25lc3MpIHsKICAgIGNvbnN0IHNhdmVkVGhpY2tuZXNzID0gdGhpcy4jdGhpY2tuZXNzOwogICAgY29uc3Qgc2V0VGhpY2tuZXNzID0gKHRoKSA9PiB7CiAgICAgIHRoaXMuI3RoaWNrbmVzcyA9IHRoOwogICAgICB0aGlzLiNjaGFuZ2VUaGlja25lc3ModGgpOwogICAgfTsKICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICBjbWQ6IHNldFRoaWNrbmVzcy5iaW5kKHRoaXMsIHRoaWNrbmVzcyksCiAgICAgIHVuZG86IHNldFRoaWNrbmVzcy5iaW5kKHRoaXMsIHNhdmVkVGhpY2tuZXNzKSwKICAgICAgcG9zdDogdGhpcy5fdWlNYW5hZ2VyLnVwZGF0ZVVJLmJpbmQodGhpcy5fdWlNYW5hZ2VyLCB0aGlzKSwKICAgICAgbXVzdEV4ZWM6IHRydWUsCiAgICAgIHR5cGU6IEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLklOS19USElDS05FU1MsCiAgICAgIG92ZXJ3cml0ZUlmU2FtZVR5cGU6IHRydWUsCiAgICAgIGtlZXBVbmRvOiB0cnVlCiAgICB9KTsKICAgIHRoaXMuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgIGFjdGlvbjogInRoaWNrbmVzc19jaGFuZ2VkIiwKICAgICAgdGhpY2tuZXNzCiAgICB9LCB0cnVlKTsKICB9CiAgZ2V0IHRvb2xiYXJCdXR0b25zKCkgewogICAgaWYgKHRoaXMuX3VpTWFuYWdlci5oaWdobGlnaHRDb2xvcnMpIHsKICAgICAgY29uc3QgY29sb3JQaWNrZXIgPSB0aGlzLiNjb2xvclBpY2tlciA9IG5ldyBDb2xvclBpY2tlcih7CiAgICAgICAgZWRpdG9yOiB0aGlzCiAgICAgIH0pOwogICAgICByZXR1cm4gW1siY29sb3JQaWNrZXIiLCBjb2xvclBpY2tlcl1dOwogICAgfQogICAgcmV0dXJuIHN1cGVyLnRvb2xiYXJCdXR0b25zOwogIH0KICBkaXNhYmxlRWRpdGluZygpIHsKICAgIHN1cGVyLmRpc2FibGVFZGl0aW5nKCk7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJkaXNhYmxlZCIsIHRydWUpOwogIH0KICBlbmFibGVFZGl0aW5nKCkgewogICAgc3VwZXIuZW5hYmxlRWRpdGluZygpOwogICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgiZGlzYWJsZWQiLCBmYWxzZSk7CiAgfQogIGZpeEFuZFNldFBvc2l0aW9uKCkgewogICAgcmV0dXJuIHN1cGVyLmZpeEFuZFNldFBvc2l0aW9uKHRoaXMuI2dldFJvdGF0aW9uKCkpOwogIH0KICBnZXRCYXNlVHJhbnNsYXRpb24oKSB7CiAgICByZXR1cm4gWzAsIDBdOwogIH0KICBnZXRSZWN0KHR4LCB0eSkgewogICAgcmV0dXJuIHN1cGVyLmdldFJlY3QodHgsIHR5LCB0aGlzLiNnZXRSb3RhdGlvbigpKTsKICB9CiAgb25jZUFkZGVkKGZvY3VzKSB7CiAgICBpZiAoIXRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICB0aGlzLnBhcmVudC5hZGRVbmRvYWJsZUVkaXRvcih0aGlzKTsKICAgIH0KICAgIGlmIChmb2N1cykgewogICAgICB0aGlzLmRpdi5mb2N1cygpOwogICAgfQogIH0KICByZW1vdmUoKSB7CiAgICB0aGlzLiNjbGVhbkRyYXdMYXllcigpOwogICAgdGhpcy5fcmVwb3J0VGVsZW1ldHJ5KHsKICAgICAgYWN0aW9uOiAiZGVsZXRlZCIKICAgIH0pOwogICAgc3VwZXIucmVtb3ZlKCk7CiAgfQogIHJlYnVpbGQoKSB7CiAgICBpZiAoIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHN1cGVyLnJlYnVpbGQoKTsKICAgIGlmICh0aGlzLmRpdiA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNhZGRUb0RyYXdMYXllcigpOwogICAgaWYgKCF0aGlzLmlzQXR0YWNoZWRUb0RPTSkgewogICAgICB0aGlzLnBhcmVudC5hZGQodGhpcyk7CiAgICB9CiAgfQogIHNldFBhcmVudChwYXJlbnQpIHsKICAgIGxldCBtdXN0QmVTZWxlY3RlZCA9IGZhbHNlOwogICAgaWYgKHRoaXMucGFyZW50ICYmICFwYXJlbnQpIHsKICAgICAgdGhpcy4jY2xlYW5EcmF3TGF5ZXIoKTsKICAgIH0gZWxzZSBpZiAocGFyZW50KSB7CiAgICAgIHRoaXMuI2FkZFRvRHJhd0xheWVyKHBhcmVudCk7CiAgICAgIG11c3RCZVNlbGVjdGVkID0gIXRoaXMucGFyZW50ICYmIHRoaXMuZGl2Py5jbGFzc0xpc3QuY29udGFpbnMoInNlbGVjdGVkRWRpdG9yIik7CiAgICB9CiAgICBzdXBlci5zZXRQYXJlbnQocGFyZW50KTsKICAgIHRoaXMuc2hvdyh0aGlzLl9pc1Zpc2libGUpOwogICAgaWYgKG11c3RCZVNlbGVjdGVkKSB7CiAgICAgIHRoaXMuc2VsZWN0KCk7CiAgICB9CiAgfQogICNjaGFuZ2VUaGlja25lc3ModGhpY2tuZXNzKSB7CiAgICBpZiAoIXRoaXMuI2lzRnJlZUhpZ2hsaWdodCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNjcmVhdGVGcmVlT3V0bGluZXMoewogICAgICBoaWdobGlnaHRPdXRsaW5lczogdGhpcy4jaGlnaGxpZ2h0T3V0bGluZXMuZ2V0TmV3T3V0bGluZSh0aGlja25lc3MgLyAyKQogICAgfSk7CiAgICB0aGlzLmZpeEFuZFNldFBvc2l0aW9uKCk7CiAgICB0aGlzLnNldERpbXMoKTsKICB9CiAgI2NsZWFuRHJhd0xheWVyKCkgewogICAgaWYgKHRoaXMuI2lkID09PSBudWxsIHx8ICF0aGlzLnBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnBhcmVudC5kcmF3TGF5ZXIucmVtb3ZlKHRoaXMuI2lkKTsKICAgIHRoaXMuI2lkID0gbnVsbDsKICAgIHRoaXMucGFyZW50LmRyYXdMYXllci5yZW1vdmUodGhpcy4jb3V0bGluZUlkKTsKICAgIHRoaXMuI291dGxpbmVJZCA9IG51bGw7CiAgfQogICNhZGRUb0RyYXdMYXllcihwYXJlbnQgPSB0aGlzLnBhcmVudCkgewogICAgaWYgKHRoaXMuI2lkICE9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgICh7CiAgICAgIGlkOiB0aGlzLiNpZCwKICAgICAgY2xpcFBhdGhJZDogdGhpcy4jY2xpcFBhdGhJZAogICAgfSA9IHBhcmVudC5kcmF3TGF5ZXIuZHJhdyh7CiAgICAgIGJib3g6IHRoaXMuI2hpZ2hsaWdodE91dGxpbmVzLmJveCwKICAgICAgcm9vdDogewogICAgICAgIHZpZXdCb3g6ICIwIDAgMSAxIiwKICAgICAgICBmaWxsOiB0aGlzLmNvbG9yLAogICAgICAgICJmaWxsLW9wYWNpdHkiOiB0aGlzLm9wYWNpdHkKICAgICAgfSwKICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgaGlnaGxpZ2h0OiB0cnVlLAogICAgICAgIGZyZWU6IHRoaXMuI2lzRnJlZUhpZ2hsaWdodAogICAgICB9LAogICAgICBwYXRoOiB7CiAgICAgICAgZDogdGhpcy4jaGlnaGxpZ2h0T3V0bGluZXMudG9TVkdQYXRoKCkKICAgICAgfQogICAgfSwgZmFsc2UsIHRydWUpKTsKICAgIHRoaXMuI291dGxpbmVJZCA9IHBhcmVudC5kcmF3TGF5ZXIuZHJhd091dGxpbmUoewogICAgICByb290Q2xhc3M6IHsKICAgICAgICBoaWdobGlnaHRPdXRsaW5lOiB0cnVlLAogICAgICAgIGZyZWU6IHRoaXMuI2lzRnJlZUhpZ2hsaWdodAogICAgICB9LAogICAgICBiYm94OiB0aGlzLiNmb2N1c091dGxpbmVzLmJveCwKICAgICAgcGF0aDogewogICAgICAgIGQ6IHRoaXMuI2ZvY3VzT3V0bGluZXMudG9TVkdQYXRoKCkKICAgICAgfQogICAgfSwgdGhpcy4jaXNGcmVlSGlnaGxpZ2h0KTsKICAgIGlmICh0aGlzLiNoaWdobGlnaHREaXYpIHsKICAgICAgdGhpcy4jaGlnaGxpZ2h0RGl2LnN0eWxlLmNsaXBQYXRoID0gdGhpcy4jY2xpcFBhdGhJZDsKICAgIH0KICB9CiAgc3RhdGljICNyb3RhdGVCYm94KFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSwgYW5nbGUpIHsKICAgIHN3aXRjaCAoYW5nbGUpIHsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXR1cm4gWzEgLSB5IC0gaGVpZ2h0LCB4LCBoZWlnaHQsIHdpZHRoXTsKICAgICAgY2FzZSAxODA6CiAgICAgICAgcmV0dXJuIFsxIC0geCAtIHdpZHRoLCAxIC0geSAtIGhlaWdodCwgd2lkdGgsIGhlaWdodF07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiBbeSwgMSAtIHggLSB3aWR0aCwgaGVpZ2h0LCB3aWR0aF07CiAgICB9CiAgICByZXR1cm4gW3gsIHksIHdpZHRoLCBoZWlnaHRdOwogIH0KICByb3RhdGUoYW5nbGUpIHsKICAgIGNvbnN0IHsKICAgICAgZHJhd0xheWVyCiAgICB9ID0gdGhpcy5wYXJlbnQ7CiAgICBsZXQgYm94OwogICAgaWYgKHRoaXMuI2lzRnJlZUhpZ2hsaWdodCkgewogICAgICBhbmdsZSA9IChhbmdsZSAtIHRoaXMucm90YXRpb24gKyAzNjApICUgMzYwOwogICAgICBib3ggPSBfSGlnaGxpZ2h0RWRpdG9yLiNyb3RhdGVCYm94KHRoaXMuI2hpZ2hsaWdodE91dGxpbmVzLmJveCwgYW5nbGUpOwogICAgfSBlbHNlIHsKICAgICAgYm94ID0gX0hpZ2hsaWdodEVkaXRvci4jcm90YXRlQmJveChbdGhpcy54LCB0aGlzLnksIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0XSwgYW5nbGUpOwogICAgfQogICAgZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jaWQsIHsKICAgICAgYmJveDogYm94LAogICAgICByb290OiB7CiAgICAgICAgImRhdGEtbWFpbi1yb3RhdGlvbiI6IGFuZ2xlCiAgICAgIH0KICAgIH0pOwogICAgZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jb3V0bGluZUlkLCB7CiAgICAgIGJib3g6IF9IaWdobGlnaHRFZGl0b3IuI3JvdGF0ZUJib3godGhpcy4jZm9jdXNPdXRsaW5lcy5ib3gsIGFuZ2xlKSwKICAgICAgcm9vdDogewogICAgICAgICJkYXRhLW1haW4tcm90YXRpb24iOiBhbmdsZQogICAgICB9CiAgICB9KTsKICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuZGl2KSB7CiAgICAgIHJldHVybiB0aGlzLmRpdjsKICAgIH0KICAgIGNvbnN0IGRpdiA9IHN1cGVyLnJlbmRlcigpOwogICAgaWYgKHRoaXMuI3RleHQpIHsKICAgICAgZGl2LnNldEF0dHJpYnV0ZSgiYXJpYS1sYWJlbCIsIHRoaXMuI3RleHQpOwogICAgICBkaXYuc2V0QXR0cmlidXRlKCJyb2xlIiwgIm1hcmsiKTsKICAgIH0KICAgIGlmICh0aGlzLiNpc0ZyZWVIaWdobGlnaHQpIHsKICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoImZyZWUiKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuZGl2LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLiNrZXlkb3duLmJpbmQodGhpcyksIHsKICAgICAgICBzaWduYWw6IHRoaXMuX3VpTWFuYWdlci5fc2lnbmFsCiAgICAgIH0pOwogICAgfQogICAgY29uc3QgaGlnaGxpZ2h0RGl2ID0gdGhpcy4jaGlnaGxpZ2h0RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXYuYXBwZW5kKGhpZ2hsaWdodERpdik7CiAgICBoaWdobGlnaHREaXYuc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CiAgICBoaWdobGlnaHREaXYuY2xhc3NOYW1lID0gImludGVybmFsIjsKICAgIGhpZ2hsaWdodERpdi5zdHlsZS5jbGlwUGF0aCA9IHRoaXMuI2NsaXBQYXRoSWQ7CiAgICB0aGlzLnNldERpbXMoKTsKICAgIGJpbmRFdmVudHModGhpcywgdGhpcy4jaGlnaGxpZ2h0RGl2LCBbInBvaW50ZXJvdmVyIiwgInBvaW50ZXJsZWF2ZSJdKTsKICAgIHRoaXMuZW5hYmxlRWRpdGluZygpOwogICAgcmV0dXJuIGRpdjsKICB9CiAgcG9pbnRlcm92ZXIoKSB7CiAgICBpZiAoIXRoaXMuaXNTZWxlY3RlZCkgewogICAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy4jb3V0bGluZUlkLCB7CiAgICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgICBob3ZlcmVkOiB0cnVlCiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgcG9pbnRlcmxlYXZlKCkgewogICAgaWYgKCF0aGlzLmlzU2VsZWN0ZWQpIHsKICAgICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuI291dGxpbmVJZCwgewogICAgICAgIHJvb3RDbGFzczogewogICAgICAgICAgaG92ZXJlZDogZmFsc2UKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAja2V5ZG93bihldmVudCkgewogICAgX0hpZ2hsaWdodEVkaXRvci5fa2V5Ym9hcmRNYW5hZ2VyLmV4ZWModGhpcywgZXZlbnQpOwogIH0KICBfbW92ZUNhcmV0KGRpcmVjdGlvbikgewogICAgdGhpcy5wYXJlbnQudW5zZWxlY3QodGhpcyk7CiAgICBzd2l0Y2ggKGRpcmVjdGlvbikgewogICAgICBjYXNlIDA6CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLiNzZXRDYXJldCh0cnVlKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICBjYXNlIDM6CiAgICAgICAgdGhpcy4jc2V0Q2FyZXQoZmFsc2UpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICAjc2V0Q2FyZXQoc3RhcnQpIHsKICAgIGlmICghdGhpcy4jYW5jaG9yTm9kZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CiAgICBpZiAoc3RhcnQpIHsKICAgICAgc2VsZWN0aW9uLnNldFBvc2l0aW9uKHRoaXMuI2FuY2hvck5vZGUsIHRoaXMuI2FuY2hvck9mZnNldCk7CiAgICB9IGVsc2UgewogICAgICBzZWxlY3Rpb24uc2V0UG9zaXRpb24odGhpcy4jZm9jdXNOb2RlLCB0aGlzLiNmb2N1c09mZnNldCk7CiAgICB9CiAgfQogIHNlbGVjdCgpIHsKICAgIHN1cGVyLnNlbGVjdCgpOwogICAgaWYgKCF0aGlzLiNvdXRsaW5lSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuI291dGxpbmVJZCwgewogICAgICByb290Q2xhc3M6IHsKICAgICAgICBob3ZlcmVkOiBmYWxzZSwKICAgICAgICBzZWxlY3RlZDogdHJ1ZQogICAgICB9CiAgICB9KTsKICB9CiAgdW5zZWxlY3QoKSB7CiAgICBzdXBlci51bnNlbGVjdCgpOwogICAgaWYgKCF0aGlzLiNvdXRsaW5lSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuI291dGxpbmVJZCwgewogICAgICByb290Q2xhc3M6IHsKICAgICAgICBzZWxlY3RlZDogZmFsc2UKICAgICAgfQogICAgfSk7CiAgICBpZiAoIXRoaXMuI2lzRnJlZUhpZ2hsaWdodCkgewogICAgICB0aGlzLiNzZXRDYXJldChmYWxzZSk7CiAgICB9CiAgfQogIGdldCBfbXVzdEZpeFBvc2l0aW9uKCkgewogICAgcmV0dXJuICF0aGlzLiNpc0ZyZWVIaWdobGlnaHQ7CiAgfQogIHNob3codmlzaWJsZSA9IHRoaXMuX2lzVmlzaWJsZSkgewogICAgc3VwZXIuc2hvdyh2aXNpYmxlKTsKICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICB0aGlzLnBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLiNpZCwgewogICAgICAgIHJvb3RDbGFzczogewogICAgICAgICAgaGlkZGVuOiAhdmlzaWJsZQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoaXMucGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuI291dGxpbmVJZCwgewogICAgICAgIHJvb3RDbGFzczogewogICAgICAgICAgaGlkZGVuOiAhdmlzaWJsZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogICNnZXRSb3RhdGlvbigpIHsKICAgIHJldHVybiB0aGlzLiNpc0ZyZWVIaWdobGlnaHQgPyB0aGlzLnJvdGF0aW9uIDogMDsKICB9CiAgI3NlcmlhbGl6ZUJveGVzKCkgewogICAgaWYgKHRoaXMuI2lzRnJlZUhpZ2hsaWdodCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgIGNvbnN0IFtwYWdlWCwgcGFnZVldID0gdGhpcy5wYWdlVHJhbnNsYXRpb247CiAgICBjb25zdCBib3hlcyA9IHRoaXMuI2JveGVzOwogICAgY29uc3QgcXVhZFBvaW50cyA9IG5ldyBGbG9hdDMyQXJyYXkoYm94ZXMubGVuZ3RoICogOCk7CiAgICBsZXQgaSA9IDA7CiAgICBmb3IgKGNvbnN0IHsKICAgICAgeCwKICAgICAgeSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSBvZiBib3hlcykgewogICAgICBjb25zdCBzeCA9IHggKiBwYWdlV2lkdGggKyBwYWdlWDsKICAgICAgY29uc3Qgc3kgPSAoMSAtIHkpICogcGFnZUhlaWdodCArIHBhZ2VZOwogICAgICBxdWFkUG9pbnRzW2ldID0gcXVhZFBvaW50c1tpICsgNF0gPSBzeDsKICAgICAgcXVhZFBvaW50c1tpICsgMV0gPSBxdWFkUG9pbnRzW2kgKyAzXSA9IHN5OwogICAgICBxdWFkUG9pbnRzW2kgKyAyXSA9IHF1YWRQb2ludHNbaSArIDZdID0gc3ggKyB3aWR0aCAqIHBhZ2VXaWR0aDsKICAgICAgcXVhZFBvaW50c1tpICsgNV0gPSBxdWFkUG9pbnRzW2kgKyA3XSA9IHN5IC0gaGVpZ2h0ICogcGFnZUhlaWdodDsKICAgICAgaSArPSA4OwogICAgfQogICAgcmV0dXJuIHF1YWRQb2ludHM7CiAgfQogICNzZXJpYWxpemVPdXRsaW5lcyhyZWN0KSB7CiAgICByZXR1cm4gdGhpcy4jaGlnaGxpZ2h0T3V0bGluZXMuc2VyaWFsaXplKHJlY3QsIHRoaXMuI2dldFJvdGF0aW9uKCkpOwogIH0KICBzdGF0aWMgc3RhcnRIaWdobGlnaHRpbmcocGFyZW50LCBpc0xUUiwgewogICAgdGFyZ2V0OiB0ZXh0TGF5ZXIsCiAgICB4LAogICAgeQogIH0pIHsKICAgIGNvbnN0IHsKICAgICAgeDogbGF5ZXJYLAogICAgICB5OiBsYXllclksCiAgICAgIHdpZHRoOiBwYXJlbnRXaWR0aCwKICAgICAgaGVpZ2h0OiBwYXJlbnRIZWlnaHQKICAgIH0gPSB0ZXh0TGF5ZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBjb25zdCBhYyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHBhcmVudC5jb21iaW5lZFNpZ25hbChhYyk7CiAgICBjb25zdCBwb2ludGVyVXBDYWxsYmFjayA9IChlKSA9PiB7CiAgICAgIGFjLmFib3J0KCk7CiAgICAgIHRoaXMuI2VuZEhpZ2hsaWdodChwYXJlbnQsIGUpOwogICAgfTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgcG9pbnRlclVwQ2FsbGJhY2ssIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVydXAiLCBwb2ludGVyVXBDYWxsYmFjaywgewogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgc3RvcEV2ZW50LCB7CiAgICAgIGNhcHR1cmU6IHRydWUsCiAgICAgIHBhc3NpdmU6IGZhbHNlLAogICAgICBzaWduYWwKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImNvbnRleHRtZW51Iiwgbm9Db250ZXh0TWVudSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgdGV4dExheWVyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJtb3ZlIiwgdGhpcy4jaGlnaGxpZ2h0TW92ZS5iaW5kKHRoaXMsIHBhcmVudCksIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHRoaXMuX2ZyZWVIaWdobGlnaHQgPSBuZXcgRnJlZUhpZ2hsaWdodE91dGxpbmVyKHsKICAgICAgeCwKICAgICAgeQogICAgfSwgW2xheWVyWCwgbGF5ZXJZLCBwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0XSwgcGFyZW50LnNjYWxlLCB0aGlzLl9kZWZhdWx0VGhpY2tuZXNzIC8gMiwgaXNMVFIsIDFlLTMpOwogICAgKHsKICAgICAgaWQ6IHRoaXMuX2ZyZWVIaWdobGlnaHRJZCwKICAgICAgY2xpcFBhdGhJZDogdGhpcy5fZnJlZUhpZ2hsaWdodENsaXBJZAogICAgfSA9IHBhcmVudC5kcmF3TGF5ZXIuZHJhdyh7CiAgICAgIGJib3g6IFswLCAwLCAxLCAxXSwKICAgICAgcm9vdDogewogICAgICAgIHZpZXdCb3g6ICIwIDAgMSAxIiwKICAgICAgICBmaWxsOiB0aGlzLl9kZWZhdWx0Q29sb3IsCiAgICAgICAgImZpbGwtb3BhY2l0eSI6IHRoaXMuX2RlZmF1bHRPcGFjaXR5CiAgICAgIH0sCiAgICAgIHJvb3RDbGFzczogewogICAgICAgIGhpZ2hsaWdodDogdHJ1ZSwKICAgICAgICBmcmVlOiB0cnVlCiAgICAgIH0sCiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLl9mcmVlSGlnaGxpZ2h0LnRvU1ZHUGF0aCgpCiAgICAgIH0KICAgIH0sIHRydWUsIHRydWUpKTsKICB9CiAgc3RhdGljICNoaWdobGlnaHRNb3ZlKHBhcmVudCwgZXZlbnQpIHsKICAgIGlmICh0aGlzLl9mcmVlSGlnaGxpZ2h0LmFkZChldmVudCkpIHsKICAgICAgcGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2ZyZWVIaWdobGlnaHRJZCwgewogICAgICAgIHBhdGg6IHsKICAgICAgICAgIGQ6IHRoaXMuX2ZyZWVIaWdobGlnaHQudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICBzdGF0aWMgI2VuZEhpZ2hsaWdodChwYXJlbnQsIGV2ZW50KSB7CiAgICBpZiAoIXRoaXMuX2ZyZWVIaWdobGlnaHQuaXNFbXB0eSgpKSB7CiAgICAgIHBhcmVudC5jcmVhdGVBbmRBZGROZXdFZGl0b3IoZXZlbnQsIGZhbHNlLCB7CiAgICAgICAgaGlnaGxpZ2h0SWQ6IHRoaXMuX2ZyZWVIaWdobGlnaHRJZCwKICAgICAgICBoaWdobGlnaHRPdXRsaW5lczogdGhpcy5fZnJlZUhpZ2hsaWdodC5nZXRPdXRsaW5lcygpLAogICAgICAgIGNsaXBQYXRoSWQ6IHRoaXMuX2ZyZWVIaWdobGlnaHRDbGlwSWQsCiAgICAgICAgbWV0aG9kT2ZDcmVhdGlvbjogIm1haW5fdG9vbGJhciIKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBwYXJlbnQuZHJhd0xheWVyLnJlbW92ZSh0aGlzLl9mcmVlSGlnaGxpZ2h0SWQpOwogICAgfQogICAgdGhpcy5fZnJlZUhpZ2hsaWdodElkID0gLTE7CiAgICB0aGlzLl9mcmVlSGlnaGxpZ2h0ID0gbnVsbDsKICAgIHRoaXMuX2ZyZWVIaWdobGlnaHRDbGlwSWQgPSAiIjsKICB9CiAgc3RhdGljIGFzeW5jIGRlc2VyaWFsaXplKGRhdGEsIHBhcmVudCwgdWlNYW5hZ2VyKSB7CiAgICBsZXQgaW5pdGlhbERhdGEyID0gbnVsbDsKICAgIGlmIChkYXRhIGluc3RhbmNlb2YgSGlnaGxpZ2h0QW5ub3RhdGlvbkVsZW1lbnQpIHsKICAgICAgY29uc3QgewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIHF1YWRQb2ludHM6IHF1YWRQb2ludHMyLAogICAgICAgICAgcmVjdCwKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgaWQsCiAgICAgICAgICBjb2xvcjogY29sb3IyLAogICAgICAgICAgb3BhY2l0eTogb3BhY2l0eTIsCiAgICAgICAgICBwb3B1cFJlZiwKICAgICAgICAgIHJpY2hUZXh0LAogICAgICAgICAgY29udGVudHNPYmosCiAgICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgICBtb2RpZmljYXRpb25EYXRlCiAgICAgICAgfSwKICAgICAgICBwYXJlbnQ6IHsKICAgICAgICAgIHBhZ2U6IHsKICAgICAgICAgICAgcGFnZU51bWJlcgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSA9IGRhdGE7CiAgICAgIGluaXRpYWxEYXRhMiA9IGRhdGEgPSB7CiAgICAgICAgYW5ub3RhdGlvblR5cGU6IEFubm90YXRpb25FZGl0b3JUeXBlLkhJR0hMSUdIVCwKICAgICAgICBjb2xvcjogQXJyYXkuZnJvbShjb2xvcjIpLAogICAgICAgIG9wYWNpdHk6IG9wYWNpdHkyLAogICAgICAgIHF1YWRQb2ludHM6IHF1YWRQb2ludHMyLAogICAgICAgIGJveGVzOiBudWxsLAogICAgICAgIHBhZ2VJbmRleDogcGFnZU51bWJlciAtIDEsCiAgICAgICAgcmVjdDogcmVjdC5zbGljZSgwKSwKICAgICAgICByb3RhdGlvbiwKICAgICAgICBhbm5vdGF0aW9uRWxlbWVudElkOiBpZCwKICAgICAgICBpZCwKICAgICAgICBkZWxldGVkOiBmYWxzZSwKICAgICAgICBwb3B1cFJlZiwKICAgICAgICByaWNoVGV4dCwKICAgICAgICBjb21tZW50OiBjb250ZW50c09iaj8uc3RyIHx8IG51bGwsCiAgICAgICAgY3JlYXRpb25EYXRlLAogICAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgICAgfTsKICAgIH0gZWxzZSBpZiAoZGF0YSBpbnN0YW5jZW9mIElua0Fubm90YXRpb25FbGVtZW50KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBpbmtMaXN0czogaW5rTGlzdHMyLAogICAgICAgICAgcmVjdCwKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgaWQsCiAgICAgICAgICBjb2xvcjogY29sb3IyLAogICAgICAgICAgYm9yZGVyU3R5bGU6IHsKICAgICAgICAgICAgcmF3V2lkdGg6IHRoaWNrbmVzcwogICAgICAgICAgfSwKICAgICAgICAgIHBvcHVwUmVmLAogICAgICAgICAgcmljaFRleHQsCiAgICAgICAgICBjb250ZW50c09iaiwKICAgICAgICAgIGNyZWF0aW9uRGF0ZSwKICAgICAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgICAgICB9LAogICAgICAgIHBhcmVudDogewogICAgICAgICAgcGFnZTogewogICAgICAgICAgICBwYWdlTnVtYmVyCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9ID0gZGF0YTsKICAgICAgaW5pdGlhbERhdGEyID0gZGF0YSA9IHsKICAgICAgICBhbm5vdGF0aW9uVHlwZTogQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hULAogICAgICAgIGNvbG9yOiBBcnJheS5mcm9tKGNvbG9yMiksCiAgICAgICAgdGhpY2tuZXNzLAogICAgICAgIGlua0xpc3RzOiBpbmtMaXN0czIsCiAgICAgICAgYm94ZXM6IG51bGwsCiAgICAgICAgcGFnZUluZGV4OiBwYWdlTnVtYmVyIC0gMSwKICAgICAgICByZWN0OiByZWN0LnNsaWNlKDApLAogICAgICAgIHJvdGF0aW9uLAogICAgICAgIGFubm90YXRpb25FbGVtZW50SWQ6IGlkLAogICAgICAgIGlkLAogICAgICAgIGRlbGV0ZWQ6IGZhbHNlLAogICAgICAgIHBvcHVwUmVmLAogICAgICAgIHJpY2hUZXh0LAogICAgICAgIGNvbW1lbnQ6IGNvbnRlbnRzT2JqPy5zdHIgfHwgbnVsbCwKICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgICB9OwogICAgfQogICAgY29uc3QgewogICAgICBjb2xvciwKICAgICAgcXVhZFBvaW50cywKICAgICAgaW5rTGlzdHMsCiAgICAgIG9wYWNpdHkKICAgIH0gPSBkYXRhOwogICAgY29uc3QgZWRpdG9yID0gYXdhaXQgc3VwZXIuZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpOwogICAgZWRpdG9yLmNvbG9yID0gVXRpbC5tYWtlSGV4Q29sb3IoLi4uY29sb3IpOwogICAgZWRpdG9yLm9wYWNpdHkgPSBvcGFjaXR5IHx8IDE7CiAgICBpZiAoaW5rTGlzdHMpIHsKICAgICAgZWRpdG9yLiN0aGlja25lc3MgPSBkYXRhLnRoaWNrbmVzczsKICAgIH0KICAgIGVkaXRvci5faW5pdGlhbERhdGEgPSBpbml0aWFsRGF0YTI7CiAgICBpZiAoZGF0YS5jb21tZW50KSB7CiAgICAgIGVkaXRvci5zZXRDb21tZW50RGF0YShkYXRhKTsKICAgIH0KICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gZWRpdG9yLnBhZ2VEaW1lbnNpb25zOwogICAgY29uc3QgW3BhZ2VYLCBwYWdlWV0gPSBlZGl0b3IucGFnZVRyYW5zbGF0aW9uOwogICAgaWYgKHF1YWRQb2ludHMpIHsKICAgICAgY29uc3QgYm94ZXMgPSBlZGl0b3IuI2JveGVzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcXVhZFBvaW50cy5sZW5ndGg7IGkgKz0gOCkgewogICAgICAgIGJveGVzLnB1c2goewogICAgICAgICAgeDogKHF1YWRQb2ludHNbaV0gLSBwYWdlWCkgLyBwYWdlV2lkdGgsCiAgICAgICAgICB5OiAxIC0gKHF1YWRQb2ludHNbaSArIDFdIC0gcGFnZVkpIC8gcGFnZUhlaWdodCwKICAgICAgICAgIHdpZHRoOiAocXVhZFBvaW50c1tpICsgMl0gLSBxdWFkUG9pbnRzW2ldKSAvIHBhZ2VXaWR0aCwKICAgICAgICAgIGhlaWdodDogKHF1YWRQb2ludHNbaSArIDFdIC0gcXVhZFBvaW50c1tpICsgNV0pIC8gcGFnZUhlaWdodAogICAgICAgIH0pOwogICAgICB9CiAgICAgIGVkaXRvci4jY3JlYXRlT3V0bGluZXMoKTsKICAgICAgZWRpdG9yLiNhZGRUb0RyYXdMYXllcigpOwogICAgICBlZGl0b3Iucm90YXRlKGVkaXRvci5yb3RhdGlvbik7CiAgICB9IGVsc2UgaWYgKGlua0xpc3RzKSB7CiAgICAgIGVkaXRvci4jaXNGcmVlSGlnaGxpZ2h0ID0gdHJ1ZTsKICAgICAgY29uc3QgcG9pbnRzID0gaW5rTGlzdHNbMF07CiAgICAgIGNvbnN0IHBvaW50ID0gewogICAgICAgIHg6IHBvaW50c1swXSAtIHBhZ2VYLAogICAgICAgIHk6IHBhZ2VIZWlnaHQgLSAocG9pbnRzWzFdIC0gcGFnZVkpCiAgICAgIH07CiAgICAgIGNvbnN0IG91dGxpbmVyID0gbmV3IEZyZWVIaWdobGlnaHRPdXRsaW5lcihwb2ludCwgWzAsIDAsIHBhZ2VXaWR0aCwgcGFnZUhlaWdodF0sIDEsIGVkaXRvci4jdGhpY2tuZXNzIC8gMiwgdHJ1ZSwgMWUtMyk7CiAgICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHBvaW50cy5sZW5ndGg7IGkgPCBpaTsgaSArPSAyKSB7CiAgICAgICAgcG9pbnQueCA9IHBvaW50c1tpXSAtIHBhZ2VYOwogICAgICAgIHBvaW50LnkgPSBwYWdlSGVpZ2h0IC0gKHBvaW50c1tpICsgMV0gLSBwYWdlWSk7CiAgICAgICAgb3V0bGluZXIuYWRkKHBvaW50KTsKICAgICAgfQogICAgICBjb25zdCB7CiAgICAgICAgaWQsCiAgICAgICAgY2xpcFBhdGhJZAogICAgICB9ID0gcGFyZW50LmRyYXdMYXllci5kcmF3KHsKICAgICAgICBiYm94OiBbMCwgMCwgMSwgMV0sCiAgICAgICAgcm9vdDogewogICAgICAgICAgdmlld0JveDogIjAgMCAxIDEiLAogICAgICAgICAgZmlsbDogZWRpdG9yLmNvbG9yLAogICAgICAgICAgImZpbGwtb3BhY2l0eSI6IGVkaXRvci5fZGVmYXVsdE9wYWNpdHkKICAgICAgICB9LAogICAgICAgIHJvb3RDbGFzczogewogICAgICAgICAgaGlnaGxpZ2h0OiB0cnVlLAogICAgICAgICAgZnJlZTogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgcGF0aDogewogICAgICAgICAgZDogb3V0bGluZXIudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH0sIHRydWUsIHRydWUpOwogICAgICBlZGl0b3IuI2NyZWF0ZUZyZWVPdXRsaW5lcyh7CiAgICAgICAgaGlnaGxpZ2h0T3V0bGluZXM6IG91dGxpbmVyLmdldE91dGxpbmVzKCksCiAgICAgICAgaGlnaGxpZ2h0SWQ6IGlkLAogICAgICAgIGNsaXBQYXRoSWQKICAgICAgfSk7CiAgICAgIGVkaXRvci4jYWRkVG9EcmF3TGF5ZXIoKTsKICAgICAgZWRpdG9yLnJvdGF0ZShlZGl0b3IucGFyZW50Um90YXRpb24pOwogICAgfQogICAgcmV0dXJuIGVkaXRvcjsKICB9CiAgc2VyaWFsaXplKGlzRm9yQ29weWluZyA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkgfHwgaXNGb3JDb3B5aW5nKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKHRoaXMuZGVsZXRlZCkgewogICAgICByZXR1cm4gdGhpcy5zZXJpYWxpemVEZWxldGVkKCk7CiAgICB9CiAgICBjb25zdCBjb2xvciA9IEFubm90YXRpb25FZGl0b3IuX2NvbG9yTWFuYWdlci5jb252ZXJ0KHRoaXMuX3VpTWFuYWdlci5nZXROb25IQ01Db2xvcih0aGlzLmNvbG9yKSk7CiAgICBjb25zdCBzZXJpYWxpemVkID0gc3VwZXIuc2VyaWFsaXplKGlzRm9yQ29weWluZyk7CiAgICBPYmplY3QuYXNzaWduKHNlcmlhbGl6ZWQsIHsKICAgICAgY29sb3IsCiAgICAgIG9wYWNpdHk6IHRoaXMub3BhY2l0eSwKICAgICAgdGhpY2tuZXNzOiB0aGlzLiN0aGlja25lc3MsCiAgICAgIHF1YWRQb2ludHM6IHRoaXMuI3NlcmlhbGl6ZUJveGVzKCksCiAgICAgIG91dGxpbmVzOiB0aGlzLiNzZXJpYWxpemVPdXRsaW5lcyhzZXJpYWxpemVkLnJlY3QpCiAgICB9KTsKICAgIHRoaXMuYWRkQ29tbWVudChzZXJpYWxpemVkKTsKICAgIGlmICh0aGlzLmFubm90YXRpb25FbGVtZW50SWQgJiYgIXRoaXMuI2hhc0VsZW1lbnRDaGFuZ2VkKHNlcmlhbGl6ZWQpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgc2VyaWFsaXplZC5pZCA9IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZDsKICAgIHJldHVybiBzZXJpYWxpemVkOwogIH0KICAjaGFzRWxlbWVudENoYW5nZWQoc2VyaWFsaXplZCkgewogICAgY29uc3QgewogICAgICBjb2xvcgogICAgfSA9IHRoaXMuX2luaXRpYWxEYXRhOwogICAgcmV0dXJuIHRoaXMuaGFzRWRpdGVkQ29tbWVudCB8fCBzZXJpYWxpemVkLmNvbG9yLnNvbWUoKGMsIGkpID0+IGMgIT09IGNvbG9yW2ldKTsKICB9CiAgcmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbikgewogICAgaWYgKHRoaXMuZGVsZXRlZCkgewogICAgICBhbm5vdGF0aW9uLmhpZGUoKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBhbm5vdGF0aW9uLnVwZGF0ZUVkaXRlZCh7CiAgICAgIHJlY3Q6IHRoaXMuZ2V0UERGUmVjdCgpLAogICAgICBwb3B1cDogdGhpcy5jb21tZW50CiAgICB9KTsKICAgIHJldHVybiBudWxsOwogIH0KICBzdGF0aWMgY2FuQ3JlYXRlTmV3RW1wdHlFZGl0b3IoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9Owp2YXIgRHJhd2luZ09wdGlvbnMgPSBjbGFzcyB7CiAgI3N2Z1Byb3BlcnRpZXMgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICB1cGRhdGVQcm9wZXJ0eShuYW1lLCB2YWx1ZSkgewogICAgdGhpc1tuYW1lXSA9IHZhbHVlOwogICAgdGhpcy51cGRhdGVTVkdQcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgfQogIHVwZGF0ZVByb3BlcnRpZXMocHJvcGVydGllcykgewogICAgaWYgKCFwcm9wZXJ0aWVzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwcm9wZXJ0aWVzKSkgewogICAgICBpZiAoIW5hbWUuc3RhcnRzV2l0aCgiXyIpKSB7CiAgICAgICAgdGhpcy51cGRhdGVQcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgIH0KICAgIH0KICB9CiAgdXBkYXRlU1ZHUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgIHRoaXMuI3N2Z1Byb3BlcnRpZXNbbmFtZV0gPSB2YWx1ZTsKICB9CiAgdG9TVkdQcm9wZXJ0aWVzKCkgewogICAgY29uc3Qgcm9vdDIgPSB0aGlzLiNzdmdQcm9wZXJ0aWVzOwogICAgdGhpcy4jc3ZnUHJvcGVydGllcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgcmV0dXJuIHsKICAgICAgcm9vdDogcm9vdDIKICAgIH07CiAgfQogIHJlc2V0KCkgewogICAgdGhpcy4jc3ZnUHJvcGVydGllcyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogIH0KICB1cGRhdGVBbGwob3B0aW9ucyA9IHRoaXMpIHsKICAgIHRoaXMudXBkYXRlUHJvcGVydGllcyhvcHRpb25zKTsKICB9CiAgY2xvbmUoKSB7CiAgICB1bnJlYWNoYWJsZSgiTm90IGltcGxlbWVudGVkIik7CiAgfQp9Owp2YXIgRHJhd2luZ0VkaXRvciA9IGNsYXNzIF9EcmF3aW5nRWRpdG9yIGV4dGVuZHMgQW5ub3RhdGlvbkVkaXRvciB7CiAgI2RyYXdPdXRsaW5lcyA9IG51bGw7CiAgI211c3RCZUNvbW1pdHRlZDsKICBfY29sb3JQaWNrZXIgPSBudWxsOwogIF9kcmF3SWQgPSBudWxsOwogIHN0YXRpYyBfY3VycmVudERyYXdJZCA9IC0xOwogIHN0YXRpYyBfY3VycmVudFBhcmVudCA9IG51bGw7CiAgc3RhdGljICNjdXJyZW50RHJhdyA9IG51bGw7CiAgc3RhdGljICNjdXJyZW50RHJhd2luZ0FDID0gbnVsbDsKICBzdGF0aWMgI2N1cnJlbnREcmF3aW5nT3B0aW9ucyA9IG51bGw7CiAgc3RhdGljIF9JTk5FUl9NQVJHSU4gPSAzOwogIGNvbnN0cnVjdG9yKHBhcmFtcykgewogICAgc3VwZXIocGFyYW1zKTsKICAgIHRoaXMuI211c3RCZUNvbW1pdHRlZCA9IHBhcmFtcy5tdXN0QmVDb21taXR0ZWQgfHwgZmFsc2U7CiAgICB0aGlzLl9hZGRPdXRsaW5lcyhwYXJhbXMpOwogIH0KICBvblVwZGF0ZWRDb2xvcigpIHsKICAgIHRoaXMuX2NvbG9yUGlja2VyPy51cGRhdGUodGhpcy5jb2xvcik7CiAgICBzdXBlci5vblVwZGF0ZWRDb2xvcigpOwogIH0KICBfYWRkT3V0bGluZXMocGFyYW1zKSB7CiAgICBpZiAocGFyYW1zLmRyYXdPdXRsaW5lcykgewogICAgICB0aGlzLiNjcmVhdGVEcmF3T3V0bGluZXMocGFyYW1zKTsKICAgICAgdGhpcy4jYWRkVG9EcmF3TGF5ZXIoKTsKICAgIH0KICB9CiAgI2NyZWF0ZURyYXdPdXRsaW5lcyh7CiAgICBkcmF3T3V0bGluZXMsCiAgICBkcmF3SWQsCiAgICBkcmF3aW5nT3B0aW9ucwogIH0pIHsKICAgIHRoaXMuI2RyYXdPdXRsaW5lcyA9IGRyYXdPdXRsaW5lczsKICAgIHRoaXMuX2RyYXdpbmdPcHRpb25zIHx8PSBkcmF3aW5nT3B0aW9uczsKICAgIGlmICghdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5hMTF5QWxlcnQoYHBkZmpzLWVkaXRvci0ke3RoaXMuZWRpdG9yVHlwZX0tYWRkZWQtYWxlcnRgKTsKICAgIH0KICAgIGlmIChkcmF3SWQgPj0gMCkgewogICAgICB0aGlzLl9kcmF3SWQgPSBkcmF3SWQ7CiAgICAgIHRoaXMucGFyZW50LmRyYXdMYXllci5maW5hbGl6ZURyYXcoZHJhd0lkLCBkcmF3T3V0bGluZXMuZGVmYXVsdFByb3BlcnRpZXMpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fZHJhd0lkID0gdGhpcy4jY3JlYXRlRHJhd2luZyhkcmF3T3V0bGluZXMsIHRoaXMucGFyZW50KTsKICAgIH0KICAgIHRoaXMuI3VwZGF0ZUJib3goZHJhd091dGxpbmVzLmJveCk7CiAgfQogICNjcmVhdGVEcmF3aW5nKGRyYXdPdXRsaW5lcywgcGFyZW50KSB7CiAgICBjb25zdCB7CiAgICAgIGlkCiAgICB9ID0gcGFyZW50LmRyYXdMYXllci5kcmF3KF9EcmF3aW5nRWRpdG9yLl9tZXJnZVNWR1Byb3BlcnRpZXModGhpcy5fZHJhd2luZ09wdGlvbnMudG9TVkdQcm9wZXJ0aWVzKCksIGRyYXdPdXRsaW5lcy5kZWZhdWx0U1ZHUHJvcGVydGllcyksIGZhbHNlLCBmYWxzZSk7CiAgICByZXR1cm4gaWQ7CiAgfQogIHN0YXRpYyBfbWVyZ2VTVkdQcm9wZXJ0aWVzKHAxLCBwMikgewogICAgY29uc3QgcDFLZXlzID0gbmV3IFNldChPYmplY3Qua2V5cyhwMSkpOwogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMocDIpKSB7CiAgICAgIGlmIChwMUtleXMuaGFzKGtleSkpIHsKICAgICAgICBPYmplY3QuYXNzaWduKHAxW2tleV0sIHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwMVtrZXldID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwMTsKICB9CiAgc3RhdGljIGdldERlZmF1bHREcmF3aW5nT3B0aW9ucyhfb3B0aW9ucykgewogICAgdW5yZWFjaGFibGUoIk5vdCBpbXBsZW1lbnRlZCIpOwogIH0KICBzdGF0aWMgZ2V0IHR5cGVzTWFwKCkgewogICAgdW5yZWFjaGFibGUoIk5vdCBpbXBsZW1lbnRlZCIpOwogIH0KICBzdGF0aWMgZ2V0IGlzRHJhd2VyKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHN0YXRpYyBnZXQgc3VwcG9ydE11bHRpcGxlRHJhd2luZ3MoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHN0YXRpYyB1cGRhdGVEZWZhdWx0UGFyYW1zKHR5cGUsIHZhbHVlKSB7CiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSB0aGlzLnR5cGVzTWFwLmdldCh0eXBlKTsKICAgIGlmIChwcm9wZXJ0eU5hbWUpIHsKICAgICAgdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zLnVwZGF0ZVByb3BlcnR5KHByb3BlcnR5TmFtZSwgdmFsdWUpOwogICAgfQogICAgaWYgKHRoaXMuX2N1cnJlbnRQYXJlbnQpIHsKICAgICAgX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3LnVwZGF0ZVByb3BlcnR5KHByb3BlcnR5TmFtZSwgdmFsdWUpOwogICAgICB0aGlzLl9jdXJyZW50UGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2N1cnJlbnREcmF3SWQsIHRoaXMuX2RlZmF1bHREcmF3aW5nT3B0aW9ucy50b1NWR1Byb3BlcnRpZXMoKSk7CiAgICB9CiAgfQogIHVwZGF0ZVBhcmFtcyh0eXBlLCB2YWx1ZSkgewogICAgY29uc3QgcHJvcGVydHlOYW1lID0gdGhpcy5jb25zdHJ1Y3Rvci50eXBlc01hcC5nZXQodHlwZSk7CiAgICBpZiAocHJvcGVydHlOYW1lKSB7CiAgICAgIHRoaXMuX3VwZGF0ZVByb3BlcnR5KHR5cGUsIHByb3BlcnR5TmFtZSwgdmFsdWUpOwogICAgfQogIH0KICBzdGF0aWMgZ2V0IGRlZmF1bHRQcm9wZXJ0aWVzVG9VcGRhdGUoKSB7CiAgICBjb25zdCBwcm9wZXJ0aWVzID0gW107CiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zOwogICAgZm9yIChjb25zdCBbdHlwZSwgbmFtZV0gb2YgdGhpcy50eXBlc01hcCkgewogICAgICBwcm9wZXJ0aWVzLnB1c2goW3R5cGUsIG9wdGlvbnNbbmFtZV1dKTsKICAgIH0KICAgIHJldHVybiBwcm9wZXJ0aWVzOwogIH0KICBnZXQgcHJvcGVydGllc1RvVXBkYXRlKCkgewogICAgY29uc3QgcHJvcGVydGllcyA9IFtdOwogICAgY29uc3QgewogICAgICBfZHJhd2luZ09wdGlvbnMKICAgIH0gPSB0aGlzOwogICAgZm9yIChjb25zdCBbdHlwZSwgbmFtZV0gb2YgdGhpcy5jb25zdHJ1Y3Rvci50eXBlc01hcCkgewogICAgICBwcm9wZXJ0aWVzLnB1c2goW3R5cGUsIF9kcmF3aW5nT3B0aW9uc1tuYW1lXV0pOwogICAgfQogICAgcmV0dXJuIHByb3BlcnRpZXM7CiAgfQogIF91cGRhdGVQcm9wZXJ0eSh0eXBlLCBuYW1lLCB2YWx1ZSkgewogICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuX2RyYXdpbmdPcHRpb25zOwogICAgY29uc3Qgc2F2ZWRWYWx1ZSA9IG9wdGlvbnNbbmFtZV07CiAgICBjb25zdCBzZXR0ZXIgPSAodmFsKSA9PiB7CiAgICAgIG9wdGlvbnMudXBkYXRlUHJvcGVydHkobmFtZSwgdmFsKTsKICAgICAgY29uc3QgYmJveCA9IHRoaXMuI2RyYXdPdXRsaW5lcy51cGRhdGVQcm9wZXJ0eShuYW1lLCB2YWwpOwogICAgICBpZiAoYmJveCkgewogICAgICAgIHRoaXMuI3VwZGF0ZUJib3goYmJveCk7CiAgICAgIH0KICAgICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2RyYXdJZCwgb3B0aW9ucy50b1NWR1Byb3BlcnRpZXMoKSk7CiAgICAgIGlmICh0eXBlID09PSB0aGlzLmNvbG9yVHlwZSkgewogICAgICAgIHRoaXMub25VcGRhdGVkQ29sb3IoKTsKICAgICAgfQogICAgfTsKICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICBjbWQ6IHNldHRlci5iaW5kKHRoaXMsIHZhbHVlKSwKICAgICAgdW5kbzogc2V0dGVyLmJpbmQodGhpcywgc2F2ZWRWYWx1ZSksCiAgICAgIHBvc3Q6IHRoaXMuX3VpTWFuYWdlci51cGRhdGVVSS5iaW5kKHRoaXMuX3VpTWFuYWdlciwgdGhpcyksCiAgICAgIG11c3RFeGVjOiB0cnVlLAogICAgICB0eXBlLAogICAgICBvdmVyd3JpdGVJZlNhbWVUeXBlOiB0cnVlLAogICAgICBrZWVwVW5kbzogdHJ1ZQogICAgfSk7CiAgfQogIF9vblJlc2l6aW5nKCkgewogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2RyYXdJZCwgX0RyYXdpbmdFZGl0b3IuX21lcmdlU1ZHUHJvcGVydGllcyh0aGlzLiNkcmF3T3V0bGluZXMuZ2V0UGF0aFJlc2l6aW5nU1ZHUHJvcGVydGllcyh0aGlzLiNjb252ZXJ0VG9EcmF3U3BhY2UoKSksIHsKICAgICAgYmJveDogdGhpcy4jcm90YXRlQm94KCkKICAgIH0pKTsKICB9CiAgX29uUmVzaXplZCgpIHsKICAgIHRoaXMucGFyZW50Py5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9kcmF3SWQsIF9EcmF3aW5nRWRpdG9yLl9tZXJnZVNWR1Byb3BlcnRpZXModGhpcy4jZHJhd091dGxpbmVzLmdldFBhdGhSZXNpemVkU1ZHUHJvcGVydGllcyh0aGlzLiNjb252ZXJ0VG9EcmF3U3BhY2UoKSksIHsKICAgICAgYmJveDogdGhpcy4jcm90YXRlQm94KCkKICAgIH0pKTsKICB9CiAgX29uVHJhbnNsYXRpbmcoX3gsIF95KSB7CiAgICB0aGlzLnBhcmVudD8uZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fZHJhd0lkLCB7CiAgICAgIGJib3g6IHRoaXMuI3JvdGF0ZUJveCgpCiAgICB9KTsKICB9CiAgX29uVHJhbnNsYXRlZCgpIHsKICAgIHRoaXMucGFyZW50Py5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9kcmF3SWQsIF9EcmF3aW5nRWRpdG9yLl9tZXJnZVNWR1Byb3BlcnRpZXModGhpcy4jZHJhd091dGxpbmVzLmdldFBhdGhUcmFuc2xhdGVkU1ZHUHJvcGVydGllcyh0aGlzLiNjb252ZXJ0VG9EcmF3U3BhY2UoKSwgdGhpcy5wYXJlbnREaW1lbnNpb25zKSwgewogICAgICBiYm94OiB0aGlzLiNyb3RhdGVCb3goKQogICAgfSkpOwogIH0KICBfb25TdGFydERyYWdnaW5nKCkgewogICAgdGhpcy5wYXJlbnQ/LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2RyYXdJZCwgewogICAgICByb290Q2xhc3M6IHsKICAgICAgICBtb3Zpbmc6IHRydWUKICAgICAgfQogICAgfSk7CiAgfQogIF9vblN0b3BEcmFnZ2luZygpIHsKICAgIHRoaXMucGFyZW50Py5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9kcmF3SWQsIHsKICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgbW92aW5nOiBmYWxzZQogICAgICB9CiAgICB9KTsKICB9CiAgY29tbWl0KCkgewogICAgc3VwZXIuY29tbWl0KCk7CiAgICB0aGlzLmRpc2FibGVFZGl0TW9kZSgpOwogICAgdGhpcy5kaXNhYmxlRWRpdGluZygpOwogIH0KICBkaXNhYmxlRWRpdGluZygpIHsKICAgIHN1cGVyLmRpc2FibGVFZGl0aW5nKCk7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJkaXNhYmxlZCIsIHRydWUpOwogIH0KICBlbmFibGVFZGl0aW5nKCkgewogICAgc3VwZXIuZW5hYmxlRWRpdGluZygpOwogICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgiZGlzYWJsZWQiLCBmYWxzZSk7CiAgfQogIGdldEJhc2VUcmFuc2xhdGlvbigpIHsKICAgIHJldHVybiBbMCwgMF07CiAgfQogIGdldCBpc1Jlc2l6YWJsZSgpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBvbmNlQWRkZWQoZm9jdXMpIHsKICAgIGlmICghdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIHRoaXMucGFyZW50LmFkZFVuZG9hYmxlRWRpdG9yKHRoaXMpOwogICAgfQogICAgdGhpcy5faXNEcmFnZ2FibGUgPSB0cnVlOwogICAgaWYgKHRoaXMuI211c3RCZUNvbW1pdHRlZCkgewogICAgICB0aGlzLiNtdXN0QmVDb21taXR0ZWQgPSBmYWxzZTsKICAgICAgdGhpcy5jb21taXQoKTsKICAgICAgdGhpcy5wYXJlbnQuc2V0U2VsZWN0ZWQodGhpcyk7CiAgICAgIGlmIChmb2N1cyAmJiB0aGlzLmlzT25TY3JlZW4pIHsKICAgICAgICB0aGlzLmRpdi5mb2N1cygpOwogICAgICB9CiAgICB9CiAgfQogIHJlbW92ZSgpIHsKICAgIHRoaXMuI2NsZWFuRHJhd0xheWVyKCk7CiAgICBzdXBlci5yZW1vdmUoKTsKICB9CiAgcmVidWlsZCgpIHsKICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3VwZXIucmVidWlsZCgpOwogICAgaWYgKHRoaXMuZGl2ID09PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2FkZFRvRHJhd0xheWVyKCk7CiAgICB0aGlzLiN1cGRhdGVCYm94KHRoaXMuI2RyYXdPdXRsaW5lcy5ib3gpOwogICAgaWYgKCF0aGlzLmlzQXR0YWNoZWRUb0RPTSkgewogICAgICB0aGlzLnBhcmVudC5hZGQodGhpcyk7CiAgICB9CiAgfQogIHNldFBhcmVudChwYXJlbnQpIHsKICAgIGxldCBtdXN0QmVTZWxlY3RlZCA9IGZhbHNlOwogICAgaWYgKHRoaXMucGFyZW50ICYmICFwYXJlbnQpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLnJlbW92ZVNob3VsZFJlc2NhbGUodGhpcyk7CiAgICAgIHRoaXMuI2NsZWFuRHJhd0xheWVyKCk7CiAgICB9IGVsc2UgaWYgKHBhcmVudCkgewogICAgICB0aGlzLl91aU1hbmFnZXIuYWRkU2hvdWxkUmVzY2FsZSh0aGlzKTsKICAgICAgdGhpcy4jYWRkVG9EcmF3TGF5ZXIocGFyZW50KTsKICAgICAgbXVzdEJlU2VsZWN0ZWQgPSAhdGhpcy5wYXJlbnQgJiYgdGhpcy5kaXY/LmNsYXNzTGlzdC5jb250YWlucygic2VsZWN0ZWRFZGl0b3IiKTsKICAgIH0KICAgIHN1cGVyLnNldFBhcmVudChwYXJlbnQpOwogICAgaWYgKG11c3RCZVNlbGVjdGVkKSB7CiAgICAgIHRoaXMuc2VsZWN0KCk7CiAgICB9CiAgfQogICNjbGVhbkRyYXdMYXllcigpIHsKICAgIGlmICh0aGlzLl9kcmF3SWQgPT09IG51bGwgfHwgIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMucGFyZW50LmRyYXdMYXllci5yZW1vdmUodGhpcy5fZHJhd0lkKTsKICAgIHRoaXMuX2RyYXdJZCA9IG51bGw7CiAgICB0aGlzLl9kcmF3aW5nT3B0aW9ucy5yZXNldCgpOwogIH0KICAjYWRkVG9EcmF3TGF5ZXIocGFyZW50ID0gdGhpcy5wYXJlbnQpIHsKICAgIGlmICh0aGlzLl9kcmF3SWQgIT09IG51bGwgJiYgdGhpcy5wYXJlbnQgPT09IHBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5fZHJhd0lkICE9PSBudWxsKSB7CiAgICAgIHRoaXMucGFyZW50LmRyYXdMYXllci51cGRhdGVQYXJlbnQodGhpcy5fZHJhd0lkLCBwYXJlbnQuZHJhd0xheWVyKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5fZHJhd2luZ09wdGlvbnMudXBkYXRlQWxsKCk7CiAgICB0aGlzLl9kcmF3SWQgPSB0aGlzLiNjcmVhdGVEcmF3aW5nKHRoaXMuI2RyYXdPdXRsaW5lcywgcGFyZW50KTsKICB9CiAgI2NvbnZlcnRUb1BhcmVudFNwYWNlKFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSkgewogICAgY29uc3QgewogICAgICBwYXJlbnREaW1lbnNpb25zOiBbcFcsIHBIXSwKICAgICAgcm90YXRpb24KICAgIH0gPSB0aGlzOwogICAgc3dpdGNoIChyb3RhdGlvbikgewogICAgICBjYXNlIDkwOgogICAgICAgIHJldHVybiBbeSwgMSAtIHgsIHdpZHRoICogKHBIIC8gcFcpLCBoZWlnaHQgKiAocFcgLyBwSCldOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXR1cm4gWzEgLSB4LCAxIC0geSwgd2lkdGgsIGhlaWdodF07CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJldHVybiBbMSAtIHksIHgsIHdpZHRoICogKHBIIC8gcFcpLCBoZWlnaHQgKiAocFcgLyBwSCldOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbeCwgeSwgd2lkdGgsIGhlaWdodF07CiAgICB9CiAgfQogICNjb252ZXJ0VG9EcmF3U3BhY2UoKSB7CiAgICBjb25zdCB7CiAgICAgIHgsCiAgICAgIHksCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIHBhcmVudERpbWVuc2lvbnM6IFtwVywgcEhdLAogICAgICByb3RhdGlvbgogICAgfSA9IHRoaXM7CiAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgcmV0dXJuIFsxIC0geSwgeCwgd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKV07CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJldHVybiBbMSAtIHgsIDEgLSB5LCB3aWR0aCwgaGVpZ2h0XTsKICAgICAgY2FzZSAyNzA6CiAgICAgICAgcmV0dXJuIFt5LCAxIC0geCwgd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKV07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIFt4LCB5LCB3aWR0aCwgaGVpZ2h0XTsKICAgIH0KICB9CiAgI3VwZGF0ZUJib3goYmJveCkgewogICAgW3RoaXMueCwgdGhpcy55LCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodF0gPSB0aGlzLiNjb252ZXJ0VG9QYXJlbnRTcGFjZShiYm94KTsKICAgIGlmICh0aGlzLmRpdikgewogICAgICB0aGlzLmZpeEFuZFNldFBvc2l0aW9uKCk7CiAgICAgIHRoaXMuc2V0RGltcygpOwogICAgfQogICAgdGhpcy5fb25SZXNpemVkKCk7CiAgfQogICNyb3RhdGVCb3goKSB7CiAgICBjb25zdCB7CiAgICAgIHgsCiAgICAgIHksCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIHJvdGF0aW9uLAogICAgICBwYXJlbnRSb3RhdGlvbiwKICAgICAgcGFyZW50RGltZW5zaW9uczogW3BXLCBwSF0KICAgIH0gPSB0aGlzOwogICAgc3dpdGNoICgocm90YXRpb24gKiA0ICsgcGFyZW50Um90YXRpb24pIC8gOTApIHsKICAgICAgY2FzZSAxOgogICAgICAgIHJldHVybiBbMSAtIHkgLSBoZWlnaHQsIHgsIGhlaWdodCwgd2lkdGhdOwogICAgICBjYXNlIDI6CiAgICAgICAgcmV0dXJuIFsxIC0geCAtIHdpZHRoLCAxIC0geSAtIGhlaWdodCwgd2lkdGgsIGhlaWdodF07CiAgICAgIGNhc2UgMzoKICAgICAgICByZXR1cm4gW3ksIDEgLSB4IC0gd2lkdGgsIGhlaWdodCwgd2lkdGhdOwogICAgICBjYXNlIDQ6CiAgICAgICAgcmV0dXJuIFt4LCB5IC0gd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKSwgd2lkdGggKiAocFcgLyBwSCldOwogICAgICBjYXNlIDU6CiAgICAgICAgcmV0dXJuIFsxIC0geSwgeCwgd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKV07CiAgICAgIGNhc2UgNjoKICAgICAgICByZXR1cm4gWzEgLSB4IC0gaGVpZ2h0ICogKHBIIC8gcFcpLCAxIC0geSwgaGVpZ2h0ICogKHBIIC8gcFcpLCB3aWR0aCAqIChwVyAvIHBIKV07CiAgICAgIGNhc2UgNzoKICAgICAgICByZXR1cm4gW3kgLSB3aWR0aCAqIChwVyAvIHBIKSwgMSAtIHggLSBoZWlnaHQgKiAocEggLyBwVyksIHdpZHRoICogKHBXIC8gcEgpLCBoZWlnaHQgKiAocEggLyBwVyldOwogICAgICBjYXNlIDg6CiAgICAgICAgcmV0dXJuIFt4IC0gd2lkdGgsIHkgLSBoZWlnaHQsIHdpZHRoLCBoZWlnaHRdOwogICAgICBjYXNlIDk6CiAgICAgICAgcmV0dXJuIFsxIC0geSwgeCAtIHdpZHRoLCBoZWlnaHQsIHdpZHRoXTsKICAgICAgY2FzZSAxMDoKICAgICAgICByZXR1cm4gWzEgLSB4LCAxIC0geSwgd2lkdGgsIGhlaWdodF07CiAgICAgIGNhc2UgMTE6CiAgICAgICAgcmV0dXJuIFt5IC0gaGVpZ2h0LCAxIC0geCwgaGVpZ2h0LCB3aWR0aF07CiAgICAgIGNhc2UgMTI6CiAgICAgICAgcmV0dXJuIFt4IC0gaGVpZ2h0ICogKHBIIC8gcFcpLCB5LCBoZWlnaHQgKiAocEggLyBwVyksIHdpZHRoICogKHBXIC8gcEgpXTsKICAgICAgY2FzZSAxMzoKICAgICAgICByZXR1cm4gWzEgLSB5IC0gd2lkdGggKiAocFcgLyBwSCksIHggLSBoZWlnaHQgKiAocEggLyBwVyksIHdpZHRoICogKHBXIC8gcEgpLCBoZWlnaHQgKiAocEggLyBwVyldOwogICAgICBjYXNlIDE0OgogICAgICAgIHJldHVybiBbMSAtIHgsIDEgLSB5IC0gd2lkdGggKiAocFcgLyBwSCksIGhlaWdodCAqIChwSCAvIHBXKSwgd2lkdGggKiAocFcgLyBwSCldOwogICAgICBjYXNlIDE1OgogICAgICAgIHJldHVybiBbeSwgMSAtIHgsIHdpZHRoICogKHBXIC8gcEgpLCBoZWlnaHQgKiAocEggLyBwVyldOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbeCwgeSwgd2lkdGgsIGhlaWdodF07CiAgICB9CiAgfQogIHJvdGF0ZSgpIHsKICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5wYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fZHJhd0lkLCBfRHJhd2luZ0VkaXRvci5fbWVyZ2VTVkdQcm9wZXJ0aWVzKHsKICAgICAgYmJveDogdGhpcy4jcm90YXRlQm94KCkKICAgIH0sIHRoaXMuI2RyYXdPdXRsaW5lcy51cGRhdGVSb3RhdGlvbigodGhpcy5wYXJlbnRSb3RhdGlvbiAtIHRoaXMucm90YXRpb24gKyAzNjApICUgMzYwKSkpOwogIH0KICBvblNjYWxlQ2hhbmdpbmcoKSB7CiAgICBpZiAoIXRoaXMucGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI3VwZGF0ZUJib3godGhpcy4jZHJhd091dGxpbmVzLnVwZGF0ZVBhcmVudERpbWVuc2lvbnModGhpcy5wYXJlbnREaW1lbnNpb25zLCB0aGlzLnBhcmVudC5zY2FsZSkpOwogIH0KICBzdGF0aWMgb25TY2FsZUNoYW5naW5nV2hlbkRyYXdpbmcoKSB7CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLmRpdikgewogICAgICByZXR1cm4gdGhpcy5kaXY7CiAgICB9CiAgICBsZXQgYmFzZVgsIGJhc2VZOwogICAgaWYgKHRoaXMuX2lzQ29weSkgewogICAgICBiYXNlWCA9IHRoaXMueDsKICAgICAgYmFzZVkgPSB0aGlzLnk7CiAgICB9CiAgICBjb25zdCBkaXYgPSBzdXBlci5yZW5kZXIoKTsKICAgIGRpdi5jbGFzc0xpc3QuYWRkKCJkcmF3Iik7CiAgICBjb25zdCBkcmF3RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICBkaXYuYXBwZW5kKGRyYXdEaXYpOwogICAgZHJhd0Rpdi5zZXRBdHRyaWJ1dGUoImFyaWEtaGlkZGVuIiwgInRydWUiKTsKICAgIGRyYXdEaXYuY2xhc3NOYW1lID0gImludGVybmFsIjsKICAgIHRoaXMuc2V0RGltcygpOwogICAgdGhpcy5fdWlNYW5hZ2VyLmFkZFNob3VsZFJlc2NhbGUodGhpcyk7CiAgICB0aGlzLmRpc2FibGVFZGl0aW5nKCk7CiAgICBpZiAodGhpcy5faXNDb3B5KSB7CiAgICAgIHRoaXMuX21vdmVBZnRlclBhc3RlKGJhc2VYLCBiYXNlWSk7CiAgICB9CiAgICByZXR1cm4gZGl2OwogIH0KICBzdGF0aWMgY3JlYXRlRHJhd2VySW5zdGFuY2UoX3gsIF95LCBfcGFyZW50V2lkdGgsIF9wYXJlbnRIZWlnaHQsIF9yb3RhdGlvbikgewogICAgdW5yZWFjaGFibGUoIk5vdCBpbXBsZW1lbnRlZCIpOwogIH0KICBzdGF0aWMgc3RhcnREcmF3aW5nKHBhcmVudCwgdWlNYW5hZ2VyLCBfaXNMVFIsIGV2ZW50KSB7CiAgICBjb25zdCB7CiAgICAgIHRhcmdldCwKICAgICAgb2Zmc2V0WDogeCwKICAgICAgb2Zmc2V0WTogeSwKICAgICAgcG9pbnRlcklkLAogICAgICBwb2ludGVyVHlwZQogICAgfSA9IGV2ZW50OwogICAgaWYgKEN1cnJlbnRQb2ludGVycy5pc0luaXRpYWxpemVkQW5kRGlmZmVyZW50UG9pbnRlclR5cGUocG9pbnRlclR5cGUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgdmlld3BvcnQ6IHsKICAgICAgICByb3RhdGlvbgogICAgICB9CiAgICB9ID0gcGFyZW50OwogICAgY29uc3QgewogICAgICB3aWR0aDogcGFyZW50V2lkdGgsCiAgICAgIGhlaWdodDogcGFyZW50SGVpZ2h0CiAgICB9ID0gdGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgY29uc3QgYWMgPSBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXdpbmdBQyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHNpZ25hbCA9IHBhcmVudC5jb21iaW5lZFNpZ25hbChhYyk7CiAgICBDdXJyZW50UG9pbnRlcnMuc2V0UG9pbnRlcihwb2ludGVyVHlwZSwgcG9pbnRlcklkKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVydXAiLCAoZSkgPT4gewogICAgICBpZiAoQ3VycmVudFBvaW50ZXJzLmlzU2FtZVBvaW50ZXJJZE9yUmVtb3ZlKGUucG9pbnRlcklkKSkgewogICAgICAgIHRoaXMuX2VuZERyYXcoZSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyY2FuY2VsIiwgKGUpID0+IHsKICAgICAgaWYgKEN1cnJlbnRQb2ludGVycy5pc1NhbWVQb2ludGVySWRPclJlbW92ZShlLnBvaW50ZXJJZCkpIHsKICAgICAgICB0aGlzLl9jdXJyZW50UGFyZW50LmVuZERyYXdpbmdTZXNzaW9uKCk7CiAgICAgIH0KICAgIH0sIHsKICAgICAgc2lnbmFsCiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIChlKSA9PiB7CiAgICAgIGlmICghQ3VycmVudFBvaW50ZXJzLmlzU2FtZVBvaW50ZXJUeXBlKGUucG9pbnRlclR5cGUpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIEN1cnJlbnRQb2ludGVycy5pbml0aWFsaXplQW5kQWRkUG9pbnRlcklkKGUucG9pbnRlcklkKTsKICAgICAgaWYgKF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdy5pc0NhbmNlbGxhYmxlKCkpIHsKICAgICAgICBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcucmVtb3ZlTGFzdEVsZW1lbnQoKTsKICAgICAgICBpZiAoX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3LmlzRW1wdHkoKSkgewogICAgICAgICAgdGhpcy5fY3VycmVudFBhcmVudC5lbmREcmF3aW5nU2Vzc2lvbih0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fZW5kRHJhdyhudWxsKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHsKICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgcGFzc2l2ZTogZmFsc2UsCiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiY29udGV4dG1lbnUiLCBub0NvbnRleHRNZW51LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcm1vdmUiLCB0aGlzLl9kcmF3TW92ZS5iaW5kKHRoaXMpLCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2htb3ZlIiwgKGUpID0+IHsKICAgICAgaWYgKEN1cnJlbnRQb2ludGVycy5pc1NhbWVUaW1lU3RhbXAoZS50aW1lU3RhbXApKSB7CiAgICAgICAgc3RvcEV2ZW50KGUpOwogICAgICB9CiAgICB9LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICBwYXJlbnQudG9nZ2xlRHJhd2luZygpOwogICAgdWlNYW5hZ2VyLl9lZGl0b3JVbmRvQmFyPy5oaWRlKCk7CiAgICBpZiAoX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3KSB7CiAgICAgIHBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyh0aGlzLl9jdXJyZW50RHJhd0lkLCBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcuc3RhcnROZXcoeCwgeSwgcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodCwgcm90YXRpb24pKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdWlNYW5hZ2VyLnVwZGF0ZVVJRm9yRGVmYXVsdFByb3BlcnRpZXModGhpcyk7CiAgICBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcgPSB0aGlzLmNyZWF0ZURyYXdlckluc3RhbmNlKHgsIHksIHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHQsIHJvdGF0aW9uKTsKICAgIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhd2luZ09wdGlvbnMgPSB0aGlzLmdldERlZmF1bHREcmF3aW5nT3B0aW9ucygpOwogICAgdGhpcy5fY3VycmVudFBhcmVudCA9IHBhcmVudDsKICAgICh7CiAgICAgIGlkOiB0aGlzLl9jdXJyZW50RHJhd0lkCiAgICB9ID0gcGFyZW50LmRyYXdMYXllci5kcmF3KHRoaXMuX21lcmdlU1ZHUHJvcGVydGllcyhfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXdpbmdPcHRpb25zLnRvU1ZHUHJvcGVydGllcygpLCBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcuZGVmYXVsdFNWR1Byb3BlcnRpZXMpLCB0cnVlLCBmYWxzZSkpOwogIH0KICBzdGF0aWMgX2RyYXdNb3ZlKGV2ZW50KSB7CiAgICBDdXJyZW50UG9pbnRlcnMuaXNTYW1lVGltZVN0YW1wKGV2ZW50LnRpbWVTdGFtcCk7CiAgICBpZiAoIV9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdykgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIG9mZnNldFgsCiAgICAgIG9mZnNldFksCiAgICAgIHBvaW50ZXJJZAogICAgfSA9IGV2ZW50OwogICAgaWYgKCFDdXJyZW50UG9pbnRlcnMuaXNTYW1lUG9pbnRlcklkKHBvaW50ZXJJZCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKEN1cnJlbnRQb2ludGVycy5pc1VzaW5nTXVsdGlwbGVQb2ludGVycygpKSB7CiAgICAgIHRoaXMuX2VuZERyYXcoZXZlbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9jdXJyZW50UGFyZW50LmRyYXdMYXllci51cGRhdGVQcm9wZXJ0aWVzKHRoaXMuX2N1cnJlbnREcmF3SWQsIF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdy5hZGQob2Zmc2V0WCwgb2Zmc2V0WSkpOwogICAgQ3VycmVudFBvaW50ZXJzLnNldFRpbWVTdGFtcChldmVudC50aW1lU3RhbXApOwogICAgc3RvcEV2ZW50KGV2ZW50KTsKICB9CiAgc3RhdGljIF9jbGVhbnVwKGFsbCkgewogICAgaWYgKGFsbCkgewogICAgICB0aGlzLl9jdXJyZW50RHJhd0lkID0gLTE7CiAgICAgIHRoaXMuX2N1cnJlbnRQYXJlbnQgPSBudWxsOwogICAgICBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcgPSBudWxsOwogICAgICBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXdpbmdPcHRpb25zID0gbnVsbDsKICAgICAgQ3VycmVudFBvaW50ZXJzLmNsZWFyVGltZVN0YW1wKCk7CiAgICB9CiAgICBpZiAoX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3aW5nQUMpIHsKICAgICAgX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3aW5nQUMuYWJvcnQoKTsKICAgICAgX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3aW5nQUMgPSBudWxsOwogICAgICBDdXJyZW50UG9pbnRlcnMuY2xlYXJQb2ludGVySWRzKCk7CiAgICB9CiAgfQogIHN0YXRpYyBfZW5kRHJhdyhldmVudCkgewogICAgY29uc3QgcGFyZW50ID0gdGhpcy5fY3VycmVudFBhcmVudDsKICAgIGlmICghcGFyZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHBhcmVudC50b2dnbGVEcmF3aW5nKHRydWUpOwogICAgdGhpcy5fY2xlYW51cChmYWxzZSk7CiAgICBpZiAoZXZlbnQ/LnRhcmdldCA9PT0gcGFyZW50LmRpdikgewogICAgICBwYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fY3VycmVudERyYXdJZCwgX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3LmVuZChldmVudC5vZmZzZXRYLCBldmVudC5vZmZzZXRZKSk7CiAgICB9CiAgICBpZiAodGhpcy5zdXBwb3J0TXVsdGlwbGVEcmF3aW5ncykgewogICAgICBjb25zdCBkcmF3ID0gX0RyYXdpbmdFZGl0b3IuI2N1cnJlbnREcmF3OwogICAgICBjb25zdCBkcmF3SWQgPSB0aGlzLl9jdXJyZW50RHJhd0lkOwogICAgICBjb25zdCBsYXN0RWxlbWVudCA9IGRyYXcuZ2V0TGFzdEVsZW1lbnQoKTsKICAgICAgcGFyZW50LmFkZENvbW1hbmRzKHsKICAgICAgICBjbWQ6ICgpID0+IHsKICAgICAgICAgIHBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyhkcmF3SWQsIGRyYXcuc2V0TGFzdEVsZW1lbnQobGFzdEVsZW1lbnQpKTsKICAgICAgICB9LAogICAgICAgIHVuZG86ICgpID0+IHsKICAgICAgICAgIHBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyhkcmF3SWQsIGRyYXcucmVtb3ZlTGFzdEVsZW1lbnQoKSk7CiAgICAgICAgfSwKICAgICAgICBtdXN0RXhlYzogZmFsc2UsCiAgICAgICAgdHlwZTogQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuRFJBV19TVEVQCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmVuZERyYXdpbmcoZmFsc2UpOwogIH0KICBzdGF0aWMgZW5kRHJhd2luZyhpc0Fib3J0ZWQpIHsKICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuX2N1cnJlbnRQYXJlbnQ7CiAgICBpZiAoIXBhcmVudCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHBhcmVudC50b2dnbGVEcmF3aW5nKHRydWUpOwogICAgcGFyZW50LmNsZWFuVW5kb1N0YWNrKEFubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLkRSQVdfU1RFUCk7CiAgICBpZiAoIV9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhdy5pc0VtcHR5KCkpIHsKICAgICAgY29uc3QgewogICAgICAgIHBhZ2VEaW1lbnNpb25zOiBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSwKICAgICAgICBzY2FsZQogICAgICB9ID0gcGFyZW50OwogICAgICBjb25zdCBlZGl0b3IgPSBwYXJlbnQuY3JlYXRlQW5kQWRkTmV3RWRpdG9yKHsKICAgICAgICBvZmZzZXRYOiAwLAogICAgICAgIG9mZnNldFk6IDAKICAgICAgfSwgZmFsc2UsIHsKICAgICAgICBkcmF3SWQ6IHRoaXMuX2N1cnJlbnREcmF3SWQsCiAgICAgICAgZHJhd091dGxpbmVzOiBfRHJhd2luZ0VkaXRvci4jY3VycmVudERyYXcuZ2V0T3V0bGluZXMocGFnZVdpZHRoICogc2NhbGUsIHBhZ2VIZWlnaHQgKiBzY2FsZSwgc2NhbGUsIHRoaXMuX0lOTkVSX01BUkdJTiksCiAgICAgICAgZHJhd2luZ09wdGlvbnM6IF9EcmF3aW5nRWRpdG9yLiNjdXJyZW50RHJhd2luZ09wdGlvbnMsCiAgICAgICAgbXVzdEJlQ29tbWl0dGVkOiAhaXNBYm9ydGVkCiAgICAgIH0pOwogICAgICB0aGlzLl9jbGVhbnVwKHRydWUpOwogICAgICByZXR1cm4gZWRpdG9yOwogICAgfQogICAgcGFyZW50LmRyYXdMYXllci5yZW1vdmUodGhpcy5fY3VycmVudERyYXdJZCk7CiAgICB0aGlzLl9jbGVhbnVwKHRydWUpOwogICAgcmV0dXJuIG51bGw7CiAgfQogIGNyZWF0ZURyYXdpbmdPcHRpb25zKF9kYXRhKSB7CiAgfQogIHN0YXRpYyBkZXNlcmlhbGl6ZURyYXcoX3BhZ2VYLCBfcGFnZVksIF9wYWdlV2lkdGgsIF9wYWdlSGVpZ2h0LCBfaW5uZXJXaWR0aCwgX2RhdGEpIHsKICAgIHVucmVhY2hhYmxlKCJOb3QgaW1wbGVtZW50ZWQiKTsKICB9CiAgc3RhdGljIGFzeW5jIGRlc2VyaWFsaXplKGRhdGEsIHBhcmVudCwgdWlNYW5hZ2VyKSB7CiAgICBjb25zdCB7CiAgICAgIHJhd0RpbXM6IHsKICAgICAgICBwYWdlV2lkdGgsCiAgICAgICAgcGFnZUhlaWdodCwKICAgICAgICBwYWdlWCwKICAgICAgICBwYWdlWQogICAgICB9CiAgICB9ID0gcGFyZW50LnZpZXdwb3J0OwogICAgY29uc3QgZHJhd091dGxpbmVzID0gdGhpcy5kZXNlcmlhbGl6ZURyYXcocGFnZVgsIHBhZ2VZLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQsIHRoaXMuX0lOTkVSX01BUkdJTiwgZGF0YSk7CiAgICBjb25zdCBlZGl0b3IgPSBhd2FpdCBzdXBlci5kZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcik7CiAgICBlZGl0b3IuY3JlYXRlRHJhd2luZ09wdGlvbnMoZGF0YSk7CiAgICBlZGl0b3IuI2NyZWF0ZURyYXdPdXRsaW5lcyh7CiAgICAgIGRyYXdPdXRsaW5lcwogICAgfSk7CiAgICBlZGl0b3IuI2FkZFRvRHJhd0xheWVyKCk7CiAgICBlZGl0b3Iub25TY2FsZUNoYW5naW5nKCk7CiAgICBlZGl0b3Iucm90YXRlKCk7CiAgICByZXR1cm4gZWRpdG9yOwogIH0KICBzZXJpYWxpemVEcmF3KGlzRm9yQ29weWluZykgewogICAgY29uc3QgW3BhZ2VYLCBwYWdlWV0gPSB0aGlzLnBhZ2VUcmFuc2xhdGlvbjsKICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgIHJldHVybiB0aGlzLiNkcmF3T3V0bGluZXMuc2VyaWFsaXplKFtwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodF0sIGlzRm9yQ29weWluZyk7CiAgfQogIHJlbmRlckFubm90YXRpb25FbGVtZW50KGFubm90YXRpb24pIHsKICAgIGFubm90YXRpb24udXBkYXRlRWRpdGVkKHsKICAgICAgcmVjdDogdGhpcy5nZXRQREZSZWN0KCkKICAgIH0pOwogICAgcmV0dXJuIG51bGw7CiAgfQogIHN0YXRpYyBjYW5DcmVhdGVOZXdFbXB0eUVkaXRvcigpIHsKICAgIHJldHVybiBmYWxzZTsKICB9Cn07CnZhciBJbmtEcmF3T3V0bGluZXIgPSBjbGFzcyB7CiAgI2xhc3QgPSBuZXcgRmxvYXQ2NEFycmF5KDYpOwogICNsaW5lOwogICNsaW5lczsKICAjcm90YXRpb247CiAgI3RoaWNrbmVzczsKICAjcG9pbnRzOwogICNsYXN0U1ZHUGF0aCA9ICIiOwogICNsYXN0SW5kZXggPSAwOwogICNvdXRsaW5lcyA9IG5ldyBJbmtEcmF3T3V0bGluZSgpOwogICNwYXJlbnRXaWR0aDsKICAjcGFyZW50SGVpZ2h0OwogIGNvbnN0cnVjdG9yKHgsIHksIHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHQsIHJvdGF0aW9uLCB0aGlja25lc3MpIHsKICAgIHRoaXMuI3BhcmVudFdpZHRoID0gcGFyZW50V2lkdGg7CiAgICB0aGlzLiNwYXJlbnRIZWlnaHQgPSBwYXJlbnRIZWlnaHQ7CiAgICB0aGlzLiNyb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgdGhpcy4jdGhpY2tuZXNzID0gdGhpY2tuZXNzOwogICAgW3gsIHldID0gdGhpcy4jbm9ybWFsaXplUG9pbnQoeCwgeSk7CiAgICBjb25zdCBsaW5lID0gdGhpcy4jbGluZSA9IFtOYU4sIE5hTiwgTmFOLCBOYU4sIHgsIHldOwogICAgdGhpcy4jcG9pbnRzID0gW3gsIHldOwogICAgdGhpcy4jbGluZXMgPSBbewogICAgICBsaW5lLAogICAgICBwb2ludHM6IHRoaXMuI3BvaW50cwogICAgfV07CiAgICB0aGlzLiNsYXN0LnNldChsaW5lLCAwKTsKICB9CiAgdXBkYXRlUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgIGlmIChuYW1lID09PSAic3Ryb2tlLXdpZHRoIikgewogICAgICB0aGlzLiN0aGlja25lc3MgPSB2YWx1ZTsKICAgIH0KICB9CiAgI25vcm1hbGl6ZVBvaW50KHgsIHkpIHsKICAgIHJldHVybiBPdXRsaW5lLl9ub3JtYWxpemVQb2ludCh4LCB5LCB0aGlzLiNwYXJlbnRXaWR0aCwgdGhpcy4jcGFyZW50SGVpZ2h0LCB0aGlzLiNyb3RhdGlvbik7CiAgfQogIGlzRW1wdHkoKSB7CiAgICByZXR1cm4gIXRoaXMuI2xpbmVzIHx8IHRoaXMuI2xpbmVzLmxlbmd0aCA9PT0gMDsKICB9CiAgaXNDYW5jZWxsYWJsZSgpIHsKICAgIHJldHVybiB0aGlzLiNwb2ludHMubGVuZ3RoIDw9IDEwOwogIH0KICBhZGQoeCwgeSkgewogICAgW3gsIHldID0gdGhpcy4jbm9ybWFsaXplUG9pbnQoeCwgeSk7CiAgICBjb25zdCBbeDEsIHkxLCB4MiwgeTJdID0gdGhpcy4jbGFzdC5zdWJhcnJheSgyLCA2KTsKICAgIGNvbnN0IGRpZmZYID0geCAtIHgyOwogICAgY29uc3QgZGlmZlkgPSB5IC0geTI7CiAgICBjb25zdCBkID0gTWF0aC5oeXBvdCh0aGlzLiNwYXJlbnRXaWR0aCAqIGRpZmZYLCB0aGlzLiNwYXJlbnRIZWlnaHQgKiBkaWZmWSk7CiAgICBpZiAoZCA8PSAyKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdGhpcy4jcG9pbnRzLnB1c2goeCwgeSk7CiAgICBpZiAoaXNOYU4oeDEpKSB7CiAgICAgIHRoaXMuI2xhc3Quc2V0KFt4MiwgeTIsIHgsIHldLCAyKTsKICAgICAgdGhpcy4jbGluZS5wdXNoKE5hTiwgTmFOLCBOYU4sIE5hTiwgeCwgeSk7CiAgICAgIHJldHVybiB7CiAgICAgICAgcGF0aDogewogICAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGlmIChpc05hTih0aGlzLiNsYXN0WzBdKSkgewogICAgICB0aGlzLiNsaW5lLnNwbGljZSg2LCA2KTsKICAgIH0KICAgIHRoaXMuI2xhc3Quc2V0KFt4MSwgeTEsIHgyLCB5MiwgeCwgeV0sIDApOwogICAgdGhpcy4jbGluZS5wdXNoKC4uLk91dGxpbmUuY3JlYXRlQmV6aWVyUG9pbnRzKHgxLCB5MSwgeDIsIHkyLCB4LCB5KSk7CiAgICByZXR1cm4gewogICAgICBwYXRoOiB7CiAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKQogICAgICB9CiAgICB9OwogIH0KICBlbmQoeCwgeSkgewogICAgY29uc3QgY2hhbmdlID0gdGhpcy5hZGQoeCwgeSk7CiAgICBpZiAoY2hhbmdlKSB7CiAgICAgIHJldHVybiBjaGFuZ2U7CiAgICB9CiAgICBpZiAodGhpcy4jcG9pbnRzLmxlbmd0aCA9PT0gMikgewogICAgICByZXR1cm4gewogICAgICAgIHBhdGg6IHsKICAgICAgICAgIGQ6IHRoaXMudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CiAgc3RhcnROZXcoeCwgeSwgcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodCwgcm90YXRpb24pIHsKICAgIHRoaXMuI3BhcmVudFdpZHRoID0gcGFyZW50V2lkdGg7CiAgICB0aGlzLiNwYXJlbnRIZWlnaHQgPSBwYXJlbnRIZWlnaHQ7CiAgICB0aGlzLiNyb3RhdGlvbiA9IHJvdGF0aW9uOwogICAgW3gsIHldID0gdGhpcy4jbm9ybWFsaXplUG9pbnQoeCwgeSk7CiAgICBjb25zdCBsaW5lID0gdGhpcy4jbGluZSA9IFtOYU4sIE5hTiwgTmFOLCBOYU4sIHgsIHldOwogICAgdGhpcy4jcG9pbnRzID0gW3gsIHldOwogICAgY29uc3QgbGFzdCA9IHRoaXMuI2xpbmVzLmF0KC0xKTsKICAgIGlmIChsYXN0KSB7CiAgICAgIGxhc3QubGluZSA9IG5ldyBGbG9hdDMyQXJyYXkobGFzdC5saW5lKTsKICAgICAgbGFzdC5wb2ludHMgPSBuZXcgRmxvYXQzMkFycmF5KGxhc3QucG9pbnRzKTsKICAgIH0KICAgIHRoaXMuI2xpbmVzLnB1c2goewogICAgICBsaW5lLAogICAgICBwb2ludHM6IHRoaXMuI3BvaW50cwogICAgfSk7CiAgICB0aGlzLiNsYXN0LnNldChsaW5lLCAwKTsKICAgIHRoaXMuI2xhc3RJbmRleCA9IDA7CiAgICB0aGlzLnRvU1ZHUGF0aCgpOwogICAgcmV0dXJuIG51bGw7CiAgfQogIGdldExhc3RFbGVtZW50KCkgewogICAgcmV0dXJuIHRoaXMuI2xpbmVzLmF0KC0xKTsKICB9CiAgc2V0TGFzdEVsZW1lbnQoZWxlbWVudCkgewogICAgaWYgKCF0aGlzLiNsaW5lcykgewogICAgICByZXR1cm4gdGhpcy4jb3V0bGluZXMuc2V0TGFzdEVsZW1lbnQoZWxlbWVudCk7CiAgICB9CiAgICB0aGlzLiNsaW5lcy5wdXNoKGVsZW1lbnQpOwogICAgdGhpcy4jbGluZSA9IGVsZW1lbnQubGluZTsKICAgIHRoaXMuI3BvaW50cyA9IGVsZW1lbnQucG9pbnRzOwogICAgdGhpcy4jbGFzdEluZGV4ID0gMDsKICAgIHJldHVybiB7CiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLnRvU1ZHUGF0aCgpCiAgICAgIH0KICAgIH07CiAgfQogIHJlbW92ZUxhc3RFbGVtZW50KCkgewogICAgaWYgKCF0aGlzLiNsaW5lcykgewogICAgICByZXR1cm4gdGhpcy4jb3V0bGluZXMucmVtb3ZlTGFzdEVsZW1lbnQoKTsKICAgIH0KICAgIHRoaXMuI2xpbmVzLnBvcCgpOwogICAgdGhpcy4jbGFzdFNWR1BhdGggPSAiIjsKICAgIGZvciAobGV0IGkgPSAwLCBpaSA9IHRoaXMuI2xpbmVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgY29uc3QgewogICAgICAgIGxpbmUsCiAgICAgICAgcG9pbnRzCiAgICAgIH0gPSB0aGlzLiNsaW5lc1tpXTsKICAgICAgdGhpcy4jbGluZSA9IGxpbmU7CiAgICAgIHRoaXMuI3BvaW50cyA9IHBvaW50czsKICAgICAgdGhpcy4jbGFzdEluZGV4ID0gMDsKICAgICAgdGhpcy50b1NWR1BhdGgoKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLiNsYXN0U1ZHUGF0aAogICAgICB9CiAgICB9OwogIH0KICB0b1NWR1BhdGgoKSB7CiAgICBjb25zdCBmaXJzdFggPSBPdXRsaW5lLnN2Z1JvdW5kKHRoaXMuI2xpbmVbNF0pOwogICAgY29uc3QgZmlyc3RZID0gT3V0bGluZS5zdmdSb3VuZCh0aGlzLiNsaW5lWzVdKTsKICAgIGlmICh0aGlzLiNwb2ludHMubGVuZ3RoID09PSAyKSB7CiAgICAgIHRoaXMuI2xhc3RTVkdQYXRoID0gYCR7dGhpcy4jbGFzdFNWR1BhdGh9IE0gJHtmaXJzdFh9ICR7Zmlyc3RZfSBaYDsKICAgICAgcmV0dXJuIHRoaXMuI2xhc3RTVkdQYXRoOwogICAgfQogICAgaWYgKHRoaXMuI3BvaW50cy5sZW5ndGggPD0gNikgewogICAgICBjb25zdCBpID0gdGhpcy4jbGFzdFNWR1BhdGgubGFzdEluZGV4T2YoIk0iKTsKICAgICAgdGhpcy4jbGFzdFNWR1BhdGggPSBgJHt0aGlzLiNsYXN0U1ZHUGF0aC5zbGljZSgwLCBpKX0gTSAke2ZpcnN0WH0gJHtmaXJzdFl9YDsKICAgICAgdGhpcy4jbGFzdEluZGV4ID0gNjsKICAgIH0KICAgIGlmICh0aGlzLiNwb2ludHMubGVuZ3RoID09PSA0KSB7CiAgICAgIGNvbnN0IHNlY29uZFggPSBPdXRsaW5lLnN2Z1JvdW5kKHRoaXMuI2xpbmVbMTBdKTsKICAgICAgY29uc3Qgc2Vjb25kWSA9IE91dGxpbmUuc3ZnUm91bmQodGhpcy4jbGluZVsxMV0pOwogICAgICB0aGlzLiNsYXN0U1ZHUGF0aCA9IGAke3RoaXMuI2xhc3RTVkdQYXRofSBMICR7c2Vjb25kWH0gJHtzZWNvbmRZfWA7CiAgICAgIHRoaXMuI2xhc3RJbmRleCA9IDEyOwogICAgICByZXR1cm4gdGhpcy4jbGFzdFNWR1BhdGg7CiAgICB9CiAgICBjb25zdCBidWZmZXIgPSBbXTsKICAgIGlmICh0aGlzLiNsYXN0SW5kZXggPT09IDApIHsKICAgICAgYnVmZmVyLnB1c2goYE0gJHtmaXJzdFh9ICR7Zmlyc3RZfWApOwogICAgICB0aGlzLiNsYXN0SW5kZXggPSA2OwogICAgfQogICAgZm9yIChsZXQgaSA9IHRoaXMuI2xhc3RJbmRleCwgaWkgPSB0aGlzLiNsaW5lLmxlbmd0aDsgaSA8IGlpOyBpICs9IDYpIHsKICAgICAgY29uc3QgW2MxeCwgYzF5LCBjMngsIGMyeSwgeCwgeV0gPSB0aGlzLiNsaW5lLnNsaWNlKGksIGkgKyA2KS5tYXAoT3V0bGluZS5zdmdSb3VuZCk7CiAgICAgIGJ1ZmZlci5wdXNoKGBDJHtjMXh9ICR7YzF5fSAke2MyeH0gJHtjMnl9ICR7eH0gJHt5fWApOwogICAgfQogICAgdGhpcy4jbGFzdFNWR1BhdGggKz0gYnVmZmVyLmpvaW4oIiAiKTsKICAgIHRoaXMuI2xhc3RJbmRleCA9IHRoaXMuI2xpbmUubGVuZ3RoOwogICAgcmV0dXJuIHRoaXMuI2xhc3RTVkdQYXRoOwogIH0KICBnZXRPdXRsaW5lcyhwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0LCBzY2FsZSwgaW5uZXJNYXJnaW4pIHsKICAgIGNvbnN0IGxhc3QgPSB0aGlzLiNsaW5lcy5hdCgtMSk7CiAgICBsYXN0LmxpbmUgPSBuZXcgRmxvYXQzMkFycmF5KGxhc3QubGluZSk7CiAgICBsYXN0LnBvaW50cyA9IG5ldyBGbG9hdDMyQXJyYXkobGFzdC5wb2ludHMpOwogICAgdGhpcy4jb3V0bGluZXMuYnVpbGQodGhpcy4jbGluZXMsIHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHQsIHNjYWxlLCB0aGlzLiNyb3RhdGlvbiwgdGhpcy4jdGhpY2tuZXNzLCBpbm5lck1hcmdpbik7CiAgICB0aGlzLiNsYXN0ID0gbnVsbDsKICAgIHRoaXMuI2xpbmUgPSBudWxsOwogICAgdGhpcy4jbGluZXMgPSBudWxsOwogICAgdGhpcy4jbGFzdFNWR1BhdGggPSBudWxsOwogICAgcmV0dXJuIHRoaXMuI291dGxpbmVzOwogIH0KICBnZXQgZGVmYXVsdFNWR1Byb3BlcnRpZXMoKSB7CiAgICByZXR1cm4gewogICAgICByb290OiB7CiAgICAgICAgdmlld0JveDogIjAgMCAxMDAwMCAxMDAwMCIKICAgICAgfSwKICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgZHJhdzogdHJ1ZQogICAgICB9LAogICAgICBiYm94OiBbMCwgMCwgMSwgMV0KICAgIH07CiAgfQp9Owp2YXIgSW5rRHJhd091dGxpbmUgPSBjbGFzcyBleHRlbmRzIE91dGxpbmUgewogICNiYm94OwogICNjdXJyZW50Um90YXRpb24gPSAwOwogICNpbm5lck1hcmdpbjsKICAjbGluZXM7CiAgI3BhcmVudFdpZHRoOwogICNwYXJlbnRIZWlnaHQ7CiAgI3BhcmVudFNjYWxlOwogICNyb3RhdGlvbjsKICAjdGhpY2tuZXNzOwogIGJ1aWxkKGxpbmVzLCBwYXJlbnRXaWR0aCwgcGFyZW50SGVpZ2h0LCBwYXJlbnRTY2FsZSwgcm90YXRpb24sIHRoaWNrbmVzcywgaW5uZXJNYXJnaW4pIHsKICAgIHRoaXMuI3BhcmVudFdpZHRoID0gcGFyZW50V2lkdGg7CiAgICB0aGlzLiNwYXJlbnRIZWlnaHQgPSBwYXJlbnRIZWlnaHQ7CiAgICB0aGlzLiNwYXJlbnRTY2FsZSA9IHBhcmVudFNjYWxlOwogICAgdGhpcy4jcm90YXRpb24gPSByb3RhdGlvbjsKICAgIHRoaXMuI3RoaWNrbmVzcyA9IHRoaWNrbmVzczsKICAgIHRoaXMuI2lubmVyTWFyZ2luID0gaW5uZXJNYXJnaW4gPz8gMDsKICAgIHRoaXMuI2xpbmVzID0gbGluZXM7CiAgICB0aGlzLiNjb21wdXRlQmJveCgpOwogIH0KICBnZXQgdGhpY2tuZXNzKCkgewogICAgcmV0dXJuIHRoaXMuI3RoaWNrbmVzczsKICB9CiAgc2V0TGFzdEVsZW1lbnQoZWxlbWVudCkgewogICAgdGhpcy4jbGluZXMucHVzaChlbGVtZW50KTsKICAgIHJldHVybiB7CiAgICAgIHBhdGg6IHsKICAgICAgICBkOiB0aGlzLnRvU1ZHUGF0aCgpCiAgICAgIH0KICAgIH07CiAgfQogIHJlbW92ZUxhc3RFbGVtZW50KCkgewogICAgdGhpcy4jbGluZXMucG9wKCk7CiAgICByZXR1cm4gewogICAgICBwYXRoOiB7CiAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKQogICAgICB9CiAgICB9OwogIH0KICB0b1NWR1BhdGgoKSB7CiAgICBjb25zdCBidWZmZXIgPSBbXTsKICAgIGZvciAoY29uc3QgewogICAgICBsaW5lCiAgICB9IG9mIHRoaXMuI2xpbmVzKSB7CiAgICAgIGJ1ZmZlci5wdXNoKGBNJHtPdXRsaW5lLnN2Z1JvdW5kKGxpbmVbNF0pfSAke091dGxpbmUuc3ZnUm91bmQobGluZVs1XSl9YCk7CiAgICAgIGlmIChsaW5lLmxlbmd0aCA9PT0gNikgewogICAgICAgIGJ1ZmZlci5wdXNoKCJaIik7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKGxpbmUubGVuZ3RoID09PSAxMiAmJiBpc05hTihsaW5lWzZdKSkgewogICAgICAgIGJ1ZmZlci5wdXNoKGBMJHtPdXRsaW5lLnN2Z1JvdW5kKGxpbmVbMTBdKX0gJHtPdXRsaW5lLnN2Z1JvdW5kKGxpbmVbMTFdKX1gKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBmb3IgKGxldCBpID0gNiwgaWkgPSBsaW5lLmxlbmd0aDsgaSA8IGlpOyBpICs9IDYpIHsKICAgICAgICBjb25zdCBbYzF4LCBjMXksIGMyeCwgYzJ5LCB4LCB5XSA9IGxpbmUuc3ViYXJyYXkoaSwgaSArIDYpLm1hcChPdXRsaW5lLnN2Z1JvdW5kKTsKICAgICAgICBidWZmZXIucHVzaChgQyR7YzF4fSAke2MxeX0gJHtjMnh9ICR7YzJ5fSAke3h9ICR7eX1gKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGJ1ZmZlci5qb2luKCIiKTsKICB9CiAgc2VyaWFsaXplKFtwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodF0sIGlzRm9yQ29weWluZykgewogICAgY29uc3Qgc2VyaWFsaXplZExpbmVzID0gW107CiAgICBjb25zdCBzZXJpYWxpemVkUG9pbnRzID0gW107CiAgICBjb25zdCBbeCwgeSwgd2lkdGgsIGhlaWdodF0gPSB0aGlzLiNnZXRCQm94V2l0aE5vTWFyZ2luKCk7CiAgICBsZXQgdHgsIHR5LCBzeCwgc3ksIHgxLCB5MSwgeDIsIHkyLCByZXNjYWxlRm47CiAgICBzd2l0Y2ggKHRoaXMuI3JvdGF0aW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXNjYWxlRm4gPSBPdXRsaW5lLl9yZXNjYWxlOwogICAgICAgIHR4ID0gcGFnZVg7CiAgICAgICAgdHkgPSBwYWdlWSArIHBhZ2VIZWlnaHQ7CiAgICAgICAgc3ggPSBwYWdlV2lkdGg7CiAgICAgICAgc3kgPSAtcGFnZUhlaWdodDsKICAgICAgICB4MSA9IHBhZ2VYICsgeCAqIHBhZ2VXaWR0aDsKICAgICAgICB5MSA9IHBhZ2VZICsgKDEgLSB5IC0gaGVpZ2h0KSAqIHBhZ2VIZWlnaHQ7CiAgICAgICAgeDIgPSBwYWdlWCArICh4ICsgd2lkdGgpICogcGFnZVdpZHRoOwogICAgICAgIHkyID0gcGFnZVkgKyAoMSAtIHkpICogcGFnZUhlaWdodDsKICAgICAgICBicmVhazsKICAgICAgY2FzZSA5MDoKICAgICAgICByZXNjYWxlRm4gPSBPdXRsaW5lLl9yZXNjYWxlQW5kU3dhcDsKICAgICAgICB0eCA9IHBhZ2VYOwogICAgICAgIHR5ID0gcGFnZVk7CiAgICAgICAgc3ggPSBwYWdlV2lkdGg7CiAgICAgICAgc3kgPSBwYWdlSGVpZ2h0OwogICAgICAgIHgxID0gcGFnZVggKyB5ICogcGFnZVdpZHRoOwogICAgICAgIHkxID0gcGFnZVkgKyB4ICogcGFnZUhlaWdodDsKICAgICAgICB4MiA9IHBhZ2VYICsgKHkgKyBoZWlnaHQpICogcGFnZVdpZHRoOwogICAgICAgIHkyID0gcGFnZVkgKyAoeCArIHdpZHRoKSAqIHBhZ2VIZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTgwOgogICAgICAgIHJlc2NhbGVGbiA9IE91dGxpbmUuX3Jlc2NhbGU7CiAgICAgICAgdHggPSBwYWdlWCArIHBhZ2VXaWR0aDsKICAgICAgICB0eSA9IHBhZ2VZOwogICAgICAgIHN4ID0gLXBhZ2VXaWR0aDsKICAgICAgICBzeSA9IHBhZ2VIZWlnaHQ7CiAgICAgICAgeDEgPSBwYWdlWCArICgxIC0geCAtIHdpZHRoKSAqIHBhZ2VXaWR0aDsKICAgICAgICB5MSA9IHBhZ2VZICsgeSAqIHBhZ2VIZWlnaHQ7CiAgICAgICAgeDIgPSBwYWdlWCArICgxIC0geCkgKiBwYWdlV2lkdGg7CiAgICAgICAgeTIgPSBwYWdlWSArICh5ICsgaGVpZ2h0KSAqIHBhZ2VIZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJlc2NhbGVGbiA9IE91dGxpbmUuX3Jlc2NhbGVBbmRTd2FwOwogICAgICAgIHR4ID0gcGFnZVggKyBwYWdlV2lkdGg7CiAgICAgICAgdHkgPSBwYWdlWSArIHBhZ2VIZWlnaHQ7CiAgICAgICAgc3ggPSAtcGFnZVdpZHRoOwogICAgICAgIHN5ID0gLXBhZ2VIZWlnaHQ7CiAgICAgICAgeDEgPSBwYWdlWCArICgxIC0geSAtIGhlaWdodCkgKiBwYWdlV2lkdGg7CiAgICAgICAgeTEgPSBwYWdlWSArICgxIC0geCAtIHdpZHRoKSAqIHBhZ2VIZWlnaHQ7CiAgICAgICAgeDIgPSBwYWdlWCArICgxIC0geSkgKiBwYWdlV2lkdGg7CiAgICAgICAgeTIgPSBwYWdlWSArICgxIC0geCkgKiBwYWdlSGVpZ2h0OwogICAgICAgIGJyZWFrOwogICAgfQogICAgZm9yIChjb25zdCB7CiAgICAgIGxpbmUsCiAgICAgIHBvaW50cwogICAgfSBvZiB0aGlzLiNsaW5lcykgewogICAgICBzZXJpYWxpemVkTGluZXMucHVzaChyZXNjYWxlRm4obGluZSwgdHgsIHR5LCBzeCwgc3ksIGlzRm9yQ29weWluZyA/IG5ldyBBcnJheShsaW5lLmxlbmd0aCkgOiBudWxsKSk7CiAgICAgIHNlcmlhbGl6ZWRQb2ludHMucHVzaChyZXNjYWxlRm4ocG9pbnRzLCB0eCwgdHksIHN4LCBzeSwgaXNGb3JDb3B5aW5nID8gbmV3IEFycmF5KHBvaW50cy5sZW5ndGgpIDogbnVsbCkpOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgbGluZXM6IHNlcmlhbGl6ZWRMaW5lcywKICAgICAgcG9pbnRzOiBzZXJpYWxpemVkUG9pbnRzLAogICAgICByZWN0OiBbeDEsIHkxLCB4MiwgeTJdCiAgICB9OwogIH0KICBzdGF0aWMgZGVzZXJpYWxpemUocGFnZVgsIHBhZ2VZLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQsIGlubmVyTWFyZ2luLCB7CiAgICBwYXRoczogewogICAgICBsaW5lcywKICAgICAgcG9pbnRzCiAgICB9LAogICAgcm90YXRpb24sCiAgICB0aGlja25lc3MKICB9KSB7CiAgICBjb25zdCBuZXdMaW5lcyA9IFtdOwogICAgbGV0IHR4LCB0eSwgc3gsIHN5LCByZXNjYWxlRm47CiAgICBzd2l0Y2ggKHJvdGF0aW9uKSB7CiAgICAgIGNhc2UgMDoKICAgICAgICByZXNjYWxlRm4gPSBPdXRsaW5lLl9yZXNjYWxlOwogICAgICAgIHR4ID0gLXBhZ2VYIC8gcGFnZVdpZHRoOwogICAgICAgIHR5ID0gcGFnZVkgLyBwYWdlSGVpZ2h0ICsgMTsKICAgICAgICBzeCA9IDEgLyBwYWdlV2lkdGg7CiAgICAgICAgc3kgPSAtMSAvIHBhZ2VIZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgOTA6CiAgICAgICAgcmVzY2FsZUZuID0gT3V0bGluZS5fcmVzY2FsZUFuZFN3YXA7CiAgICAgICAgdHggPSAtcGFnZVkgLyBwYWdlSGVpZ2h0OwogICAgICAgIHR5ID0gLXBhZ2VYIC8gcGFnZVdpZHRoOwogICAgICAgIHN4ID0gMSAvIHBhZ2VIZWlnaHQ7CiAgICAgICAgc3kgPSAxIC8gcGFnZVdpZHRoOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE4MDoKICAgICAgICByZXNjYWxlRm4gPSBPdXRsaW5lLl9yZXNjYWxlOwogICAgICAgIHR4ID0gcGFnZVggLyBwYWdlV2lkdGggKyAxOwogICAgICAgIHR5ID0gLXBhZ2VZIC8gcGFnZUhlaWdodDsKICAgICAgICBzeCA9IC0xIC8gcGFnZVdpZHRoOwogICAgICAgIHN5ID0gMSAvIHBhZ2VIZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjcwOgogICAgICAgIHJlc2NhbGVGbiA9IE91dGxpbmUuX3Jlc2NhbGVBbmRTd2FwOwogICAgICAgIHR4ID0gcGFnZVkgLyBwYWdlSGVpZ2h0ICsgMTsKICAgICAgICB0eSA9IHBhZ2VYIC8gcGFnZVdpZHRoICsgMTsKICAgICAgICBzeCA9IC0xIC8gcGFnZUhlaWdodDsKICAgICAgICBzeSA9IC0xIC8gcGFnZVdpZHRoOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKCFsaW5lcykgewogICAgICBsaW5lcyA9IFtdOwogICAgICBmb3IgKGNvbnN0IHBvaW50IG9mIHBvaW50cykgewogICAgICAgIGNvbnN0IGxlbiA9IHBvaW50Lmxlbmd0aDsKICAgICAgICBpZiAobGVuID09PSAyKSB7CiAgICAgICAgICBsaW5lcy5wdXNoKG5ldyBGbG9hdDMyQXJyYXkoW05hTiwgTmFOLCBOYU4sIE5hTiwgcG9pbnRbMF0sIHBvaW50WzFdXSkpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChsZW4gPT09IDQpIHsKICAgICAgICAgIGxpbmVzLnB1c2gobmV3IEZsb2F0MzJBcnJheShbTmFOLCBOYU4sIE5hTiwgTmFOLCBwb2ludFswXSwgcG9pbnRbMV0sIE5hTiwgTmFOLCBOYU4sIE5hTiwgcG9pbnRbMl0sIHBvaW50WzNdXSkpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxpbmUgPSBuZXcgRmxvYXQzMkFycmF5KDMgKiAobGVuIC0gMikpOwogICAgICAgIGxpbmVzLnB1c2gobGluZSk7CiAgICAgICAgbGV0IFt4MSwgeTEsIHgyLCB5Ml0gPSBwb2ludC5zdWJhcnJheSgwLCA0KTsKICAgICAgICBsaW5lLnNldChbTmFOLCBOYU4sIE5hTiwgTmFOLCB4MSwgeTFdLCAwKTsKICAgICAgICBmb3IgKGxldCBpID0gNDsgaSA8IGxlbjsgaSArPSAyKSB7CiAgICAgICAgICBjb25zdCB4ID0gcG9pbnRbaV07CiAgICAgICAgICBjb25zdCB5ID0gcG9pbnRbaSArIDFdOwogICAgICAgICAgbGluZS5zZXQoT3V0bGluZS5jcmVhdGVCZXppZXJQb2ludHMoeDEsIHkxLCB4MiwgeTIsIHgsIHkpLCAoaSAtIDIpICogMyk7CiAgICAgICAgICBbeDEsIHkxLCB4MiwgeTJdID0gW3gyLCB5MiwgeCwgeV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBsaW5lcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgIG5ld0xpbmVzLnB1c2goewogICAgICAgIGxpbmU6IHJlc2NhbGVGbihsaW5lc1tpXS5tYXAoKHgpID0+IHggPz8gTmFOKSwgdHgsIHR5LCBzeCwgc3kpLAogICAgICAgIHBvaW50czogcmVzY2FsZUZuKHBvaW50c1tpXS5tYXAoKHgpID0+IHggPz8gTmFOKSwgdHgsIHR5LCBzeCwgc3kpCiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgb3V0bGluZXMgPSBuZXcgdGhpcy5wcm90b3R5cGUuY29uc3RydWN0b3IoKTsKICAgIG91dGxpbmVzLmJ1aWxkKG5ld0xpbmVzLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQsIDEsIHJvdGF0aW9uLCB0aGlja25lc3MsIGlubmVyTWFyZ2luKTsKICAgIHJldHVybiBvdXRsaW5lczsKICB9CiAgI2dldE1hcmdpbkNvbXBvbmVudHModGhpY2tuZXNzID0gdGhpcy4jdGhpY2tuZXNzKSB7CiAgICBjb25zdCBtYXJnaW4gPSB0aGlzLiNpbm5lck1hcmdpbiArIHRoaWNrbmVzcyAvIDIgKiB0aGlzLiNwYXJlbnRTY2FsZTsKICAgIHJldHVybiB0aGlzLiNyb3RhdGlvbiAlIDE4MCA9PT0gMCA/IFttYXJnaW4gLyB0aGlzLiNwYXJlbnRXaWR0aCwgbWFyZ2luIC8gdGhpcy4jcGFyZW50SGVpZ2h0XSA6IFttYXJnaW4gLyB0aGlzLiNwYXJlbnRIZWlnaHQsIG1hcmdpbiAvIHRoaXMuI3BhcmVudFdpZHRoXTsKICB9CiAgI2dldEJCb3hXaXRoTm9NYXJnaW4oKSB7CiAgICBjb25zdCBbeCwgeSwgd2lkdGgsIGhlaWdodF0gPSB0aGlzLiNiYm94OwogICAgY29uc3QgW21hcmdpblgsIG1hcmdpblldID0gdGhpcy4jZ2V0TWFyZ2luQ29tcG9uZW50cygwKTsKICAgIHJldHVybiBbeCArIG1hcmdpblgsIHkgKyBtYXJnaW5ZLCB3aWR0aCAtIDIgKiBtYXJnaW5YLCBoZWlnaHQgLSAyICogbWFyZ2luWV07CiAgfQogICNjb21wdXRlQmJveCgpIHsKICAgIGNvbnN0IGJib3ggPSB0aGlzLiNiYm94ID0gbmV3IEZsb2F0MzJBcnJheShbSW5maW5pdHksIEluZmluaXR5LCAtSW5maW5pdHksIC1JbmZpbml0eV0pOwogICAgZm9yIChjb25zdCB7CiAgICAgIGxpbmUKICAgIH0gb2YgdGhpcy4jbGluZXMpIHsKICAgICAgaWYgKGxpbmUubGVuZ3RoIDw9IDEyKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDQsIGlpID0gbGluZS5sZW5ndGg7IGkgPCBpaTsgaSArPSA2KSB7CiAgICAgICAgICBVdGlsLnBvaW50Qm91bmRpbmdCb3gobGluZVtpXSwgbGluZVtpICsgMV0sIGJib3gpOwogICAgICAgIH0KICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBsZXQgbGFzdFggPSBsaW5lWzRdLCBsYXN0WSA9IGxpbmVbNV07CiAgICAgIGZvciAobGV0IGkgPSA2LCBpaSA9IGxpbmUubGVuZ3RoOyBpIDwgaWk7IGkgKz0gNikgewogICAgICAgIGNvbnN0IFtjMXgsIGMxeSwgYzJ4LCBjMnksIHgsIHldID0gbGluZS5zdWJhcnJheShpLCBpICsgNik7CiAgICAgICAgVXRpbC5iZXppZXJCb3VuZGluZ0JveChsYXN0WCwgbGFzdFksIGMxeCwgYzF5LCBjMngsIGMyeSwgeCwgeSwgYmJveCk7CiAgICAgICAgbGFzdFggPSB4OwogICAgICAgIGxhc3RZID0geTsKICAgICAgfQogICAgfQogICAgY29uc3QgW21hcmdpblgsIG1hcmdpblldID0gdGhpcy4jZ2V0TWFyZ2luQ29tcG9uZW50cygpOwogICAgYmJveFswXSA9IE1hdGhDbGFtcChiYm94WzBdIC0gbWFyZ2luWCwgMCwgMSk7CiAgICBiYm94WzFdID0gTWF0aENsYW1wKGJib3hbMV0gLSBtYXJnaW5ZLCAwLCAxKTsKICAgIGJib3hbMl0gPSBNYXRoQ2xhbXAoYmJveFsyXSArIG1hcmdpblgsIDAsIDEpOwogICAgYmJveFszXSA9IE1hdGhDbGFtcChiYm94WzNdICsgbWFyZ2luWSwgMCwgMSk7CiAgICBiYm94WzJdIC09IGJib3hbMF07CiAgICBiYm94WzNdIC09IGJib3hbMV07CiAgfQogIGdldCBib3goKSB7CiAgICByZXR1cm4gdGhpcy4jYmJveDsKICB9CiAgdXBkYXRlUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgIGlmIChuYW1lID09PSAic3Ryb2tlLXdpZHRoIikgewogICAgICByZXR1cm4gdGhpcy4jdXBkYXRlVGhpY2tuZXNzKHZhbHVlKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICAjdXBkYXRlVGhpY2tuZXNzKHRoaWNrbmVzcykgewogICAgY29uc3QgW29sZE1hcmdpblgsIG9sZE1hcmdpblldID0gdGhpcy4jZ2V0TWFyZ2luQ29tcG9uZW50cygpOwogICAgdGhpcy4jdGhpY2tuZXNzID0gdGhpY2tuZXNzOwogICAgY29uc3QgW25ld01hcmdpblgsIG5ld01hcmdpblldID0gdGhpcy4jZ2V0TWFyZ2luQ29tcG9uZW50cygpOwogICAgY29uc3QgW2RpZmZNYXJnaW5YLCBkaWZmTWFyZ2luWV0gPSBbbmV3TWFyZ2luWCAtIG9sZE1hcmdpblgsIG5ld01hcmdpblkgLSBvbGRNYXJnaW5ZXTsKICAgIGNvbnN0IGJib3ggPSB0aGlzLiNiYm94OwogICAgYmJveFswXSAtPSBkaWZmTWFyZ2luWDsKICAgIGJib3hbMV0gLT0gZGlmZk1hcmdpblk7CiAgICBiYm94WzJdICs9IDIgKiBkaWZmTWFyZ2luWDsKICAgIGJib3hbM10gKz0gMiAqIGRpZmZNYXJnaW5ZOwogICAgcmV0dXJuIGJib3g7CiAgfQogIHVwZGF0ZVBhcmVudERpbWVuc2lvbnMoW3dpZHRoLCBoZWlnaHRdLCBzY2FsZSkgewogICAgY29uc3QgW29sZE1hcmdpblgsIG9sZE1hcmdpblldID0gdGhpcy4jZ2V0TWFyZ2luQ29tcG9uZW50cygpOwogICAgdGhpcy4jcGFyZW50V2lkdGggPSB3aWR0aDsKICAgIHRoaXMuI3BhcmVudEhlaWdodCA9IGhlaWdodDsKICAgIHRoaXMuI3BhcmVudFNjYWxlID0gc2NhbGU7CiAgICBjb25zdCBbbmV3TWFyZ2luWCwgbmV3TWFyZ2luWV0gPSB0aGlzLiNnZXRNYXJnaW5Db21wb25lbnRzKCk7CiAgICBjb25zdCBkaWZmTWFyZ2luWCA9IG5ld01hcmdpblggLSBvbGRNYXJnaW5YOwogICAgY29uc3QgZGlmZk1hcmdpblkgPSBuZXdNYXJnaW5ZIC0gb2xkTWFyZ2luWTsKICAgIGNvbnN0IGJib3ggPSB0aGlzLiNiYm94OwogICAgYmJveFswXSAtPSBkaWZmTWFyZ2luWDsKICAgIGJib3hbMV0gLT0gZGlmZk1hcmdpblk7CiAgICBiYm94WzJdICs9IDIgKiBkaWZmTWFyZ2luWDsKICAgIGJib3hbM10gKz0gMiAqIGRpZmZNYXJnaW5ZOwogICAgcmV0dXJuIGJib3g7CiAgfQogIHVwZGF0ZVJvdGF0aW9uKHJvdGF0aW9uKSB7CiAgICB0aGlzLiNjdXJyZW50Um90YXRpb24gPSByb3RhdGlvbjsKICAgIHJldHVybiB7CiAgICAgIHBhdGg6IHsKICAgICAgICB0cmFuc2Zvcm06IHRoaXMucm90YXRpb25UcmFuc2Zvcm0KICAgICAgfQogICAgfTsKICB9CiAgZ2V0IHZpZXdCb3goKSB7CiAgICByZXR1cm4gdGhpcy4jYmJveC5tYXAoT3V0bGluZS5zdmdSb3VuZCkuam9pbigiICIpOwogIH0KICBnZXQgZGVmYXVsdFByb3BlcnRpZXMoKSB7CiAgICBjb25zdCBbeCwgeV0gPSB0aGlzLiNiYm94OwogICAgcmV0dXJuIHsKICAgICAgcm9vdDogewogICAgICAgIHZpZXdCb3g6IHRoaXMudmlld0JveAogICAgICB9LAogICAgICBwYXRoOiB7CiAgICAgICAgInRyYW5zZm9ybS1vcmlnaW4iOiBgJHtPdXRsaW5lLnN2Z1JvdW5kKHgpfSAke091dGxpbmUuc3ZnUm91bmQoeSl9YAogICAgICB9CiAgICB9OwogIH0KICBnZXQgcm90YXRpb25UcmFuc2Zvcm0oKSB7CiAgICBjb25zdCBbLCAsIHdpZHRoLCBoZWlnaHRdID0gdGhpcy4jYmJveDsKICAgIGxldCBhID0gMCwgYiA9IDAsIGMgPSAwLCBkID0gMCwgZSA9IDAsIGYgPSAwOwogICAgc3dpdGNoICh0aGlzLiNjdXJyZW50Um90YXRpb24pIHsKICAgICAgY2FzZSA5MDoKICAgICAgICBiID0gaGVpZ2h0IC8gd2lkdGg7CiAgICAgICAgYyA9IC13aWR0aCAvIGhlaWdodDsKICAgICAgICBlID0gd2lkdGg7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTgwOgogICAgICAgIGEgPSAtMTsKICAgICAgICBkID0gLTE7CiAgICAgICAgZSA9IHdpZHRoOwogICAgICAgIGYgPSBoZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjcwOgogICAgICAgIGIgPSAtaGVpZ2h0IC8gd2lkdGg7CiAgICAgICAgYyA9IHdpZHRoIC8gaGVpZ2h0OwogICAgICAgIGYgPSBoZWlnaHQ7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuICIiOwogICAgfQogICAgcmV0dXJuIGBtYXRyaXgoJHthfSAke2J9ICR7Y30gJHtkfSAke091dGxpbmUuc3ZnUm91bmQoZSl9ICR7T3V0bGluZS5zdmdSb3VuZChmKX0pYDsKICB9CiAgZ2V0UGF0aFJlc2l6aW5nU1ZHUHJvcGVydGllcyhbbmV3WCwgbmV3WSwgbmV3V2lkdGgsIG5ld0hlaWdodF0pIHsKICAgIGNvbnN0IFttYXJnaW5YLCBtYXJnaW5ZXSA9IHRoaXMuI2dldE1hcmdpbkNvbXBvbmVudHMoKTsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IHRoaXMuI2Jib3g7CiAgICBpZiAoTWF0aC5hYnMod2lkdGggLSBtYXJnaW5YKSA8PSBPdXRsaW5lLlBSRUNJU0lPTiB8fCBNYXRoLmFicyhoZWlnaHQgLSBtYXJnaW5ZKSA8PSBPdXRsaW5lLlBSRUNJU0lPTikgewogICAgICBjb25zdCB0eCA9IG5ld1ggKyBuZXdXaWR0aCAvIDIgLSAoeCArIHdpZHRoIC8gMik7CiAgICAgIGNvbnN0IHR5ID0gbmV3WSArIG5ld0hlaWdodCAvIDIgLSAoeSArIGhlaWdodCAvIDIpOwogICAgICByZXR1cm4gewogICAgICAgIHBhdGg6IHsKICAgICAgICAgICJ0cmFuc2Zvcm0tb3JpZ2luIjogYCR7T3V0bGluZS5zdmdSb3VuZChuZXdYKX0gJHtPdXRsaW5lLnN2Z1JvdW5kKG5ld1kpfWAsCiAgICAgICAgICB0cmFuc2Zvcm06IGAke3RoaXMucm90YXRpb25UcmFuc2Zvcm19IHRyYW5zbGF0ZSgke3R4fSAke3R5fSlgCiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgY29uc3QgczF4ID0gKG5ld1dpZHRoIC0gMiAqIG1hcmdpblgpIC8gKHdpZHRoIC0gMiAqIG1hcmdpblgpOwogICAgY29uc3QgczF5ID0gKG5ld0hlaWdodCAtIDIgKiBtYXJnaW5ZKSAvIChoZWlnaHQgLSAyICogbWFyZ2luWSk7CiAgICBjb25zdCBzMnggPSB3aWR0aCAvIG5ld1dpZHRoOwogICAgY29uc3QgczJ5ID0gaGVpZ2h0IC8gbmV3SGVpZ2h0OwogICAgcmV0dXJuIHsKICAgICAgcGF0aDogewogICAgICAgICJ0cmFuc2Zvcm0tb3JpZ2luIjogYCR7T3V0bGluZS5zdmdSb3VuZCh4KX0gJHtPdXRsaW5lLnN2Z1JvdW5kKHkpfWAsCiAgICAgICAgdHJhbnNmb3JtOiBgJHt0aGlzLnJvdGF0aW9uVHJhbnNmb3JtfSBzY2FsZSgke3MyeH0gJHtzMnl9KSB0cmFuc2xhdGUoJHtPdXRsaW5lLnN2Z1JvdW5kKG1hcmdpblgpfSAke091dGxpbmUuc3ZnUm91bmQobWFyZ2luWSl9KSBzY2FsZSgke3MxeH0gJHtzMXl9KSB0cmFuc2xhdGUoJHtPdXRsaW5lLnN2Z1JvdW5kKC1tYXJnaW5YKX0gJHtPdXRsaW5lLnN2Z1JvdW5kKC1tYXJnaW5ZKX0pYAogICAgICB9CiAgICB9OwogIH0KICBnZXRQYXRoUmVzaXplZFNWR1Byb3BlcnRpZXMoW25ld1gsIG5ld1ksIG5ld1dpZHRoLCBuZXdIZWlnaHRdKSB7CiAgICBjb25zdCBbbWFyZ2luWCwgbWFyZ2luWV0gPSB0aGlzLiNnZXRNYXJnaW5Db21wb25lbnRzKCk7CiAgICBjb25zdCBiYm94ID0gdGhpcy4jYmJveDsKICAgIGNvbnN0IFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSA9IGJib3g7CiAgICBiYm94WzBdID0gbmV3WDsKICAgIGJib3hbMV0gPSBuZXdZOwogICAgYmJveFsyXSA9IG5ld1dpZHRoOwogICAgYmJveFszXSA9IG5ld0hlaWdodDsKICAgIGlmIChNYXRoLmFicyh3aWR0aCAtIG1hcmdpblgpIDw9IE91dGxpbmUuUFJFQ0lTSU9OIHx8IE1hdGguYWJzKGhlaWdodCAtIG1hcmdpblkpIDw9IE91dGxpbmUuUFJFQ0lTSU9OKSB7CiAgICAgIGNvbnN0IHR4MiA9IG5ld1ggKyBuZXdXaWR0aCAvIDIgLSAoeCArIHdpZHRoIC8gMik7CiAgICAgIGNvbnN0IHR5MiA9IG5ld1kgKyBuZXdIZWlnaHQgLyAyIC0gKHkgKyBoZWlnaHQgLyAyKTsKICAgICAgZm9yIChjb25zdCB7CiAgICAgICAgbGluZSwKICAgICAgICBwb2ludHMKICAgICAgfSBvZiB0aGlzLiNsaW5lcykgewogICAgICAgIE91dGxpbmUuX3RyYW5zbGF0ZShsaW5lLCB0eDIsIHR5MiwgbGluZSk7CiAgICAgICAgT3V0bGluZS5fdHJhbnNsYXRlKHBvaW50cywgdHgyLCB0eTIsIHBvaW50cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICByb290OiB7CiAgICAgICAgICB2aWV3Qm94OiB0aGlzLnZpZXdCb3gKICAgICAgICB9LAogICAgICAgIHBhdGg6IHsKICAgICAgICAgICJ0cmFuc2Zvcm0tb3JpZ2luIjogYCR7T3V0bGluZS5zdmdSb3VuZChuZXdYKX0gJHtPdXRsaW5lLnN2Z1JvdW5kKG5ld1kpfWAsCiAgICAgICAgICB0cmFuc2Zvcm06IHRoaXMucm90YXRpb25UcmFuc2Zvcm0gfHwgbnVsbCwKICAgICAgICAgIGQ6IHRoaXMudG9TVkdQYXRoKCkKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBjb25zdCBzMXggPSAobmV3V2lkdGggLSAyICogbWFyZ2luWCkgLyAod2lkdGggLSAyICogbWFyZ2luWCk7CiAgICBjb25zdCBzMXkgPSAobmV3SGVpZ2h0IC0gMiAqIG1hcmdpblkpIC8gKGhlaWdodCAtIDIgKiBtYXJnaW5ZKTsKICAgIGNvbnN0IHR4ID0gLXMxeCAqICh4ICsgbWFyZ2luWCkgKyBuZXdYICsgbWFyZ2luWDsKICAgIGNvbnN0IHR5ID0gLXMxeSAqICh5ICsgbWFyZ2luWSkgKyBuZXdZICsgbWFyZ2luWTsKICAgIGlmIChzMXggIT09IDEgfHwgczF5ICE9PSAxIHx8IHR4ICE9PSAwIHx8IHR5ICE9PSAwKSB7CiAgICAgIGZvciAoY29uc3QgewogICAgICAgIGxpbmUsCiAgICAgICAgcG9pbnRzCiAgICAgIH0gb2YgdGhpcy4jbGluZXMpIHsKICAgICAgICBPdXRsaW5lLl9yZXNjYWxlKGxpbmUsIHR4LCB0eSwgczF4LCBzMXksIGxpbmUpOwogICAgICAgIE91dGxpbmUuX3Jlc2NhbGUocG9pbnRzLCB0eCwgdHksIHMxeCwgczF5LCBwb2ludHMpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICByb290OiB7CiAgICAgICAgdmlld0JveDogdGhpcy52aWV3Qm94CiAgICAgIH0sCiAgICAgIHBhdGg6IHsKICAgICAgICAidHJhbnNmb3JtLW9yaWdpbiI6IGAke091dGxpbmUuc3ZnUm91bmQobmV3WCl9ICR7T3V0bGluZS5zdmdSb3VuZChuZXdZKX1gLAogICAgICAgIHRyYW5zZm9ybTogdGhpcy5yb3RhdGlvblRyYW5zZm9ybSB8fCBudWxsLAogICAgICAgIGQ6IHRoaXMudG9TVkdQYXRoKCkKICAgICAgfQogICAgfTsKICB9CiAgZ2V0UGF0aFRyYW5zbGF0ZWRTVkdQcm9wZXJ0aWVzKFtuZXdYLCBuZXdZXSwgcGFyZW50RGltZW5zaW9ucykgewogICAgY29uc3QgW25ld1BhcmVudFdpZHRoLCBuZXdQYXJlbnRIZWlnaHRdID0gcGFyZW50RGltZW5zaW9uczsKICAgIGNvbnN0IGJib3ggPSB0aGlzLiNiYm94OwogICAgY29uc3QgdHggPSBuZXdYIC0gYmJveFswXTsKICAgIGNvbnN0IHR5ID0gbmV3WSAtIGJib3hbMV07CiAgICBpZiAodGhpcy4jcGFyZW50V2lkdGggPT09IG5ld1BhcmVudFdpZHRoICYmIHRoaXMuI3BhcmVudEhlaWdodCA9PT0gbmV3UGFyZW50SGVpZ2h0KSB7CiAgICAgIGZvciAoY29uc3QgewogICAgICAgIGxpbmUsCiAgICAgICAgcG9pbnRzCiAgICAgIH0gb2YgdGhpcy4jbGluZXMpIHsKICAgICAgICBPdXRsaW5lLl90cmFuc2xhdGUobGluZSwgdHgsIHR5LCBsaW5lKTsKICAgICAgICBPdXRsaW5lLl90cmFuc2xhdGUocG9pbnRzLCB0eCwgdHksIHBvaW50cyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHN4ID0gdGhpcy4jcGFyZW50V2lkdGggLyBuZXdQYXJlbnRXaWR0aDsKICAgICAgY29uc3Qgc3kgPSB0aGlzLiNwYXJlbnRIZWlnaHQgLyBuZXdQYXJlbnRIZWlnaHQ7CiAgICAgIHRoaXMuI3BhcmVudFdpZHRoID0gbmV3UGFyZW50V2lkdGg7CiAgICAgIHRoaXMuI3BhcmVudEhlaWdodCA9IG5ld1BhcmVudEhlaWdodDsKICAgICAgZm9yIChjb25zdCB7CiAgICAgICAgbGluZSwKICAgICAgICBwb2ludHMKICAgICAgfSBvZiB0aGlzLiNsaW5lcykgewogICAgICAgIE91dGxpbmUuX3Jlc2NhbGUobGluZSwgdHgsIHR5LCBzeCwgc3ksIGxpbmUpOwogICAgICAgIE91dGxpbmUuX3Jlc2NhbGUocG9pbnRzLCB0eCwgdHksIHN4LCBzeSwgcG9pbnRzKTsKICAgICAgfQogICAgICBiYm94WzJdICo9IHN4OwogICAgICBiYm94WzNdICo9IHN5OwogICAgfQogICAgYmJveFswXSA9IG5ld1g7CiAgICBiYm94WzFdID0gbmV3WTsKICAgIHJldHVybiB7CiAgICAgIHJvb3Q6IHsKICAgICAgICB2aWV3Qm94OiB0aGlzLnZpZXdCb3gKICAgICAgfSwKICAgICAgcGF0aDogewogICAgICAgIGQ6IHRoaXMudG9TVkdQYXRoKCksCiAgICAgICAgInRyYW5zZm9ybS1vcmlnaW4iOiBgJHtPdXRsaW5lLnN2Z1JvdW5kKG5ld1gpfSAke091dGxpbmUuc3ZnUm91bmQobmV3WSl9YAogICAgICB9CiAgICB9OwogIH0KICBnZXQgZGVmYXVsdFNWR1Byb3BlcnRpZXMoKSB7CiAgICBjb25zdCBiYm94ID0gdGhpcy4jYmJveDsKICAgIHJldHVybiB7CiAgICAgIHJvb3Q6IHsKICAgICAgICB2aWV3Qm94OiB0aGlzLnZpZXdCb3gKICAgICAgfSwKICAgICAgcm9vdENsYXNzOiB7CiAgICAgICAgZHJhdzogdHJ1ZQogICAgICB9LAogICAgICBwYXRoOiB7CiAgICAgICAgZDogdGhpcy50b1NWR1BhdGgoKSwKICAgICAgICAidHJhbnNmb3JtLW9yaWdpbiI6IGAke091dGxpbmUuc3ZnUm91bmQoYmJveFswXSl9ICR7T3V0bGluZS5zdmdSb3VuZChiYm94WzFdKX1gLAogICAgICAgIHRyYW5zZm9ybTogdGhpcy5yb3RhdGlvblRyYW5zZm9ybSB8fCBudWxsCiAgICAgIH0sCiAgICAgIGJib3gKICAgIH07CiAgfQp9Owp2YXIgSW5rRHJhd2luZ09wdGlvbnMgPSBjbGFzcyBfSW5rRHJhd2luZ09wdGlvbnMgZXh0ZW5kcyBEcmF3aW5nT3B0aW9ucyB7CiAgY29uc3RydWN0b3Iodmlld2VyUGFyYW1ldGVycykgewogICAgc3VwZXIoKTsKICAgIHRoaXMuX3ZpZXdQYXJhbWV0ZXJzID0gdmlld2VyUGFyYW1ldGVyczsKICAgIHN1cGVyLnVwZGF0ZVByb3BlcnRpZXMoewogICAgICBmaWxsOiAibm9uZSIsCiAgICAgIHN0cm9rZTogQW5ub3RhdGlvbkVkaXRvci5fZGVmYXVsdExpbmVDb2xvciwKICAgICAgInN0cm9rZS1vcGFjaXR5IjogMSwKICAgICAgInN0cm9rZS13aWR0aCI6IDEsCiAgICAgICJzdHJva2UtbGluZWNhcCI6ICJyb3VuZCIsCiAgICAgICJzdHJva2UtbGluZWpvaW4iOiAicm91bmQiLAogICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAxMAogICAgfSk7CiAgfQogIHVwZGF0ZVNWR1Byb3BlcnR5KG5hbWUsIHZhbHVlKSB7CiAgICBpZiAobmFtZSA9PT0gInN0cm9rZS13aWR0aCIpIHsKICAgICAgdmFsdWUgPz89IHRoaXNbInN0cm9rZS13aWR0aCJdOwogICAgICB2YWx1ZSAqPSB0aGlzLl92aWV3UGFyYW1ldGVycy5yZWFsU2NhbGU7CiAgICB9CiAgICBzdXBlci51cGRhdGVTVkdQcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgfQogIGNsb25lKCkgewogICAgY29uc3QgY2xvbmUgPSBuZXcgX0lua0RyYXdpbmdPcHRpb25zKHRoaXMuX3ZpZXdQYXJhbWV0ZXJzKTsKICAgIGNsb25lLnVwZGF0ZUFsbCh0aGlzKTsKICAgIHJldHVybiBjbG9uZTsKICB9Cn07CnZhciBJbmtFZGl0b3IgPSBjbGFzcyBfSW5rRWRpdG9yIGV4dGVuZHMgRHJhd2luZ0VkaXRvciB7CiAgc3RhdGljIF90eXBlID0gImluayI7CiAgc3RhdGljIF9lZGl0b3JUeXBlID0gQW5ub3RhdGlvbkVkaXRvclR5cGUuSU5LOwogIHN0YXRpYyBfZGVmYXVsdERyYXdpbmdPcHRpb25zID0gbnVsbDsKICBjb25zdHJ1Y3RvcihwYXJhbXMpIHsKICAgIHN1cGVyKHsKICAgICAgLi4ucGFyYW1zLAogICAgICBuYW1lOiAiaW5rRWRpdG9yIgogICAgfSk7CiAgICB0aGlzLl93aWxsS2VlcEFzcGVjdFJhdGlvID0gdHJ1ZTsKICAgIHRoaXMuZGVmYXVsdEwxMG5JZCA9ICJwZGZqcy1lZGl0b3ItaW5rLWVkaXRvciI7CiAgfQogIHN0YXRpYyBpbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcikgewogICAgQW5ub3RhdGlvbkVkaXRvci5pbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcik7CiAgICB0aGlzLl9kZWZhdWx0RHJhd2luZ09wdGlvbnMgPSBuZXcgSW5rRHJhd2luZ09wdGlvbnModWlNYW5hZ2VyLnZpZXdQYXJhbWV0ZXJzKTsKICB9CiAgc3RhdGljIGdldERlZmF1bHREcmF3aW5nT3B0aW9ucyhvcHRpb25zKSB7CiAgICBjb25zdCBjbG9uZSA9IHRoaXMuX2RlZmF1bHREcmF3aW5nT3B0aW9ucy5jbG9uZSgpOwogICAgY2xvbmUudXBkYXRlUHJvcGVydGllcyhvcHRpb25zKTsKICAgIHJldHVybiBjbG9uZTsKICB9CiAgc3RhdGljIGdldCBzdXBwb3J0TXVsdGlwbGVEcmF3aW5ncygpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBzdGF0aWMgZ2V0IHR5cGVzTWFwKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAidHlwZXNNYXAiLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLklOS19USElDS05FU1MsICJzdHJva2Utd2lkdGgiXSwgW0Fubm90YXRpb25FZGl0b3JQYXJhbXNUeXBlLklOS19DT0xPUiwgInN0cm9rZSJdLCBbQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSU5LX09QQUNJVFksICJzdHJva2Utb3BhY2l0eSJdXSkpOwogIH0KICBzdGF0aWMgY3JlYXRlRHJhd2VySW5zdGFuY2UoeCwgeSwgcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodCwgcm90YXRpb24pIHsKICAgIHJldHVybiBuZXcgSW5rRHJhd091dGxpbmVyKHgsIHksIHBhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHQsIHJvdGF0aW9uLCB0aGlzLl9kZWZhdWx0RHJhd2luZ09wdGlvbnNbInN0cm9rZS13aWR0aCJdKTsKICB9CiAgc3RhdGljIGRlc2VyaWFsaXplRHJhdyhwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgaW5uZXJNYXJnaW4sIGRhdGEpIHsKICAgIHJldHVybiBJbmtEcmF3T3V0bGluZS5kZXNlcmlhbGl6ZShwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgaW5uZXJNYXJnaW4sIGRhdGEpOwogIH0KICBzdGF0aWMgYXN5bmMgZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpIHsKICAgIGxldCBpbml0aWFsRGF0YTIgPSBudWxsOwogICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBJbmtBbm5vdGF0aW9uRWxlbWVudCkgewogICAgICBjb25zdCB7CiAgICAgICAgZGF0YTogewogICAgICAgICAgaW5rTGlzdHMsCiAgICAgICAgICByZWN0LAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBpZCwKICAgICAgICAgIGNvbG9yLAogICAgICAgICAgb3BhY2l0eSwKICAgICAgICAgIGJvcmRlclN0eWxlOiB7CiAgICAgICAgICAgIHJhd1dpZHRoOiB0aGlja25lc3MKICAgICAgICAgIH0sCiAgICAgICAgICBwb3B1cFJlZiwKICAgICAgICAgIHJpY2hUZXh0LAogICAgICAgICAgY29udGVudHNPYmosCiAgICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgICBtb2RpZmljYXRpb25EYXRlCiAgICAgICAgfSwKICAgICAgICBwYXJlbnQ6IHsKICAgICAgICAgIHBhZ2U6IHsKICAgICAgICAgICAgcGFnZU51bWJlcgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSA9IGRhdGE7CiAgICAgIGluaXRpYWxEYXRhMiA9IGRhdGEgPSB7CiAgICAgICAgYW5ub3RhdGlvblR5cGU6IEFubm90YXRpb25FZGl0b3JUeXBlLklOSywKICAgICAgICBjb2xvcjogQXJyYXkuZnJvbShjb2xvciksCiAgICAgICAgdGhpY2tuZXNzLAogICAgICAgIG9wYWNpdHksCiAgICAgICAgcGF0aHM6IHsKICAgICAgICAgIHBvaW50czogaW5rTGlzdHMKICAgICAgICB9LAogICAgICAgIGJveGVzOiBudWxsLAogICAgICAgIHBhZ2VJbmRleDogcGFnZU51bWJlciAtIDEsCiAgICAgICAgcmVjdDogcmVjdC5zbGljZSgwKSwKICAgICAgICByb3RhdGlvbiwKICAgICAgICBhbm5vdGF0aW9uRWxlbWVudElkOiBpZCwKICAgICAgICBpZCwKICAgICAgICBkZWxldGVkOiBmYWxzZSwKICAgICAgICBwb3B1cFJlZiwKICAgICAgICByaWNoVGV4dCwKICAgICAgICBjb21tZW50OiBjb250ZW50c09iaj8uc3RyIHx8IG51bGwsCiAgICAgICAgY3JlYXRpb25EYXRlLAogICAgICAgIG1vZGlmaWNhdGlvbkRhdGUKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IGVkaXRvciA9IGF3YWl0IHN1cGVyLmRlc2VyaWFsaXplKGRhdGEsIHBhcmVudCwgdWlNYW5hZ2VyKTsKICAgIGVkaXRvci5faW5pdGlhbERhdGEgPSBpbml0aWFsRGF0YTI7CiAgICBpZiAoZGF0YS5jb21tZW50KSB7CiAgICAgIGVkaXRvci5zZXRDb21tZW50RGF0YShkYXRhKTsKICAgIH0KICAgIHJldHVybiBlZGl0b3I7CiAgfQogIGdldCB0b29sYmFyQnV0dG9ucygpIHsKICAgIHRoaXMuX2NvbG9yUGlja2VyIHx8PSBuZXcgQmFzaWNDb2xvclBpY2tlcih0aGlzKTsKICAgIHJldHVybiBbWyJjb2xvclBpY2tlciIsIHRoaXMuX2NvbG9yUGlja2VyXV07CiAgfQogIGdldCBjb2xvclR5cGUoKSB7CiAgICByZXR1cm4gQW5ub3RhdGlvbkVkaXRvclBhcmFtc1R5cGUuSU5LX0NPTE9SOwogIH0KICBnZXQgY29sb3IoKSB7CiAgICByZXR1cm4gdGhpcy5fZHJhd2luZ09wdGlvbnMuc3Ryb2tlOwogIH0KICBnZXQgb3BhY2l0eSgpIHsKICAgIHJldHVybiB0aGlzLl9kcmF3aW5nT3B0aW9uc1sic3Ryb2tlLW9wYWNpdHkiXTsKICB9CiAgb25TY2FsZUNoYW5naW5nKCkgewogICAgaWYgKCF0aGlzLnBhcmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5vblNjYWxlQ2hhbmdpbmcoKTsKICAgIGNvbnN0IHsKICAgICAgX2RyYXdJZCwKICAgICAgX2RyYXdpbmdPcHRpb25zLAogICAgICBwYXJlbnQKICAgIH0gPSB0aGlzOwogICAgX2RyYXdpbmdPcHRpb25zLnVwZGF0ZVNWR1Byb3BlcnR5KCJzdHJva2Utd2lkdGgiKTsKICAgIHBhcmVudC5kcmF3TGF5ZXIudXBkYXRlUHJvcGVydGllcyhfZHJhd0lkLCBfZHJhd2luZ09wdGlvbnMudG9TVkdQcm9wZXJ0aWVzKCkpOwogIH0KICBzdGF0aWMgb25TY2FsZUNoYW5naW5nV2hlbkRyYXdpbmcoKSB7CiAgICBjb25zdCBwYXJlbnQgPSB0aGlzLl9jdXJyZW50UGFyZW50OwogICAgaWYgKCFwYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3VwZXIub25TY2FsZUNoYW5naW5nV2hlbkRyYXdpbmcoKTsKICAgIHRoaXMuX2RlZmF1bHREcmF3aW5nT3B0aW9ucy51cGRhdGVTVkdQcm9wZXJ0eSgic3Ryb2tlLXdpZHRoIik7CiAgICBwYXJlbnQuZHJhd0xheWVyLnVwZGF0ZVByb3BlcnRpZXModGhpcy5fY3VycmVudERyYXdJZCwgdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zLnRvU1ZHUHJvcGVydGllcygpKTsKICB9CiAgY3JlYXRlRHJhd2luZ09wdGlvbnMoewogICAgY29sb3IsCiAgICB0aGlja25lc3MsCiAgICBvcGFjaXR5CiAgfSkgewogICAgdGhpcy5fZHJhd2luZ09wdGlvbnMgPSBfSW5rRWRpdG9yLmdldERlZmF1bHREcmF3aW5nT3B0aW9ucyh7CiAgICAgIHN0cm9rZTogVXRpbC5tYWtlSGV4Q29sb3IoLi4uY29sb3IpLAogICAgICAic3Ryb2tlLXdpZHRoIjogdGhpY2tuZXNzLAogICAgICAic3Ryb2tlLW9wYWNpdHkiOiBvcGFjaXR5CiAgICB9KTsKICB9CiAgc2VyaWFsaXplKGlzRm9yQ29weWluZyA9IGZhbHNlKSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZURlbGV0ZWQoKTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgbGluZXMsCiAgICAgIHBvaW50cwogICAgfSA9IHRoaXMuc2VyaWFsaXplRHJhdyhpc0ZvckNvcHlpbmcpOwogICAgY29uc3QgewogICAgICBfZHJhd2luZ09wdGlvbnM6IHsKICAgICAgICBzdHJva2UsCiAgICAgICAgInN0cm9rZS1vcGFjaXR5Ijogb3BhY2l0eSwKICAgICAgICAic3Ryb2tlLXdpZHRoIjogdGhpY2tuZXNzCiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgY29uc3Qgc2VyaWFsaXplZCA9IE9iamVjdC5hc3NpZ24oc3VwZXIuc2VyaWFsaXplKGlzRm9yQ29weWluZyksIHsKICAgICAgY29sb3I6IEFubm90YXRpb25FZGl0b3IuX2NvbG9yTWFuYWdlci5jb252ZXJ0KHN0cm9rZSksCiAgICAgIG9wYWNpdHksCiAgICAgIHRoaWNrbmVzcywKICAgICAgcGF0aHM6IHsKICAgICAgICBsaW5lcywKICAgICAgICBwb2ludHMKICAgICAgfQogICAgfSk7CiAgICB0aGlzLmFkZENvbW1lbnQoc2VyaWFsaXplZCk7CiAgICBpZiAoaXNGb3JDb3B5aW5nKSB7CiAgICAgIHNlcmlhbGl6ZWQuaXNDb3B5ID0gdHJ1ZTsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICB9CiAgICBpZiAodGhpcy5hbm5vdGF0aW9uRWxlbWVudElkICYmICF0aGlzLiNoYXNFbGVtZW50Q2hhbmdlZChzZXJpYWxpemVkKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHNlcmlhbGl6ZWQuaWQgPSB0aGlzLmFubm90YXRpb25FbGVtZW50SWQ7CiAgICByZXR1cm4gc2VyaWFsaXplZDsKICB9CiAgI2hhc0VsZW1lbnRDaGFuZ2VkKHNlcmlhbGl6ZWQpIHsKICAgIGNvbnN0IHsKICAgICAgY29sb3IsCiAgICAgIHRoaWNrbmVzcywKICAgICAgb3BhY2l0eSwKICAgICAgcGFnZUluZGV4CiAgICB9ID0gdGhpcy5faW5pdGlhbERhdGE7CiAgICByZXR1cm4gdGhpcy5oYXNFZGl0ZWRDb21tZW50IHx8IHRoaXMuX2hhc0JlZW5Nb3ZlZCB8fCB0aGlzLl9oYXNCZWVuUmVzaXplZCB8fCBzZXJpYWxpemVkLmNvbG9yLnNvbWUoKGMsIGkpID0+IGMgIT09IGNvbG9yW2ldKSB8fCBzZXJpYWxpemVkLnRoaWNrbmVzcyAhPT0gdGhpY2tuZXNzIHx8IHNlcmlhbGl6ZWQub3BhY2l0eSAhPT0gb3BhY2l0eSB8fCBzZXJpYWxpemVkLnBhZ2VJbmRleCAhPT0gcGFnZUluZGV4OwogIH0KICByZW5kZXJBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uKSB7CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIGFubm90YXRpb24uaGlkZSgpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgcG9pbnRzLAogICAgICByZWN0CiAgICB9ID0gdGhpcy5zZXJpYWxpemVEcmF3KGZhbHNlKTsKICAgIGFubm90YXRpb24udXBkYXRlRWRpdGVkKHsKICAgICAgcmVjdCwKICAgICAgdGhpY2tuZXNzOiB0aGlzLl9kcmF3aW5nT3B0aW9uc1sic3Ryb2tlLXdpZHRoIl0sCiAgICAgIHBvaW50cywKICAgICAgcG9wdXA6IHRoaXMuY29tbWVudAogICAgfSk7CiAgICByZXR1cm4gbnVsbDsKICB9Cn07CnZhciBDb250b3VyRHJhd091dGxpbmUgPSBjbGFzcyBleHRlbmRzIElua0RyYXdPdXRsaW5lIHsKICB0b1NWR1BhdGgoKSB7CiAgICBsZXQgcGF0aCA9IHN1cGVyLnRvU1ZHUGF0aCgpOwogICAgaWYgKCFwYXRoLmVuZHNXaXRoKCJaIikpIHsKICAgICAgcGF0aCArPSAiWiI7CiAgICB9CiAgICByZXR1cm4gcGF0aDsKICB9Cn07CnZhciBCQVNFX0hFQURFUl9MRU5HVEggPSA4Owp2YXIgUE9JTlRTX1BST1BFUlRJRVNfTlVNQkVSID0gMzsKdmFyIFNpZ25hdHVyZUV4dHJhY3RvciA9IGNsYXNzIHsKICBzdGF0aWMgI1BBUkFNRVRFUlMgPSB7CiAgICBtYXhEaW06IDUxMiwKICAgIHNpZ21hU0ZhY3RvcjogMC4wMiwKICAgIHNpZ21hUjogMjUsCiAgICBrZXJuZWxTaXplOiAxNgogIH07CiAgc3RhdGljICNuZWlnaGJvckluZGV4VG9JZChpMCwgajAsIGksIGopIHsKICAgIGkgLT0gaTA7CiAgICBqIC09IGowOwogICAgaWYgKGkgPT09IDApIHsKICAgICAgcmV0dXJuIGogPiAwID8gMCA6IDQ7CiAgICB9CiAgICBpZiAoaSA9PT0gMSkgewogICAgICByZXR1cm4gaiArIDY7CiAgICB9CiAgICByZXR1cm4gMiAtIGo7CiAgfQogIHN0YXRpYyAjbmVpZ2hib3JJZFRvSW5kZXggPSBuZXcgSW50MzJBcnJheShbMCwgMSwgLTEsIDEsIC0xLCAwLCAtMSwgLTEsIDAsIC0xLCAxLCAtMSwgMSwgMCwgMSwgMV0pOwogIHN0YXRpYyAjY2xvY2t3aXNlTm9uWmVybyhidWYsIHdpZHRoLCBpMCwgajAsIGksIGosIG9mZnNldCkgewogICAgY29uc3QgaWQgPSB0aGlzLiNuZWlnaGJvckluZGV4VG9JZChpMCwgajAsIGksIGopOwogICAgZm9yIChsZXQgayA9IDA7IGsgPCA4OyBrKyspIHsKICAgICAgY29uc3Qga2sgPSAoLWsgKyBpZCAtIG9mZnNldCArIDE2KSAlIDg7CiAgICAgIGNvbnN0IHNoaWZ0SSA9IHRoaXMuI25laWdoYm9ySWRUb0luZGV4WzIgKiBra107CiAgICAgIGNvbnN0IHNoaWZ0SiA9IHRoaXMuI25laWdoYm9ySWRUb0luZGV4WzIgKiBrayArIDFdOwogICAgICBpZiAoYnVmWyhpMCArIHNoaWZ0SSkgKiB3aWR0aCArIChqMCArIHNoaWZ0SildICE9PSAwKSB7CiAgICAgICAgcmV0dXJuIGtrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQogIHN0YXRpYyAjY291bnRlckNsb2Nrd2lzZU5vblplcm8oYnVmLCB3aWR0aCwgaTAsIGowLCBpLCBqLCBvZmZzZXQpIHsKICAgIGNvbnN0IGlkID0gdGhpcy4jbmVpZ2hib3JJbmRleFRvSWQoaTAsIGowLCBpLCBqKTsKICAgIGZvciAobGV0IGsgPSAwOyBrIDwgODsgaysrKSB7CiAgICAgIGNvbnN0IGtrID0gKGsgKyBpZCArIG9mZnNldCArIDE2KSAlIDg7CiAgICAgIGNvbnN0IHNoaWZ0SSA9IHRoaXMuI25laWdoYm9ySWRUb0luZGV4WzIgKiBra107CiAgICAgIGNvbnN0IHNoaWZ0SiA9IHRoaXMuI25laWdoYm9ySWRUb0luZGV4WzIgKiBrayArIDFdOwogICAgICBpZiAoYnVmWyhpMCArIHNoaWZ0SSkgKiB3aWR0aCArIChqMCArIHNoaWZ0SildICE9PSAwKSB7CiAgICAgICAgcmV0dXJuIGtrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQogIHN0YXRpYyAjZmluZENvbnRvdXJzKGJ1Ziwgd2lkdGgsIGhlaWdodCwgdGhyZXNob2xkKSB7CiAgICBjb25zdCBOID0gYnVmLmxlbmd0aDsKICAgIGNvbnN0IHR5cGVzID0gbmV3IEludDMyQXJyYXkoTik7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE47IGkrKykgewogICAgICB0eXBlc1tpXSA9IGJ1ZltpXSA8PSB0aHJlc2hvbGQgPyAxIDogMDsKICAgIH0KICAgIGZvciAobGV0IGkgPSAxOyBpIDwgaGVpZ2h0IC0gMTsgaSsrKSB7CiAgICAgIHR5cGVzW2kgKiB3aWR0aF0gPSB0eXBlc1tpICogd2lkdGggKyB3aWR0aCAtIDFdID0gMDsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2lkdGg7IGkrKykgewogICAgICB0eXBlc1tpXSA9IHR5cGVzW3dpZHRoICogaGVpZ2h0IC0gMSAtIGldID0gMDsKICAgIH0KICAgIGxldCBuYmQgPSAxOwogICAgbGV0IGxuYmQ7CiAgICBjb25zdCBjb250b3VycyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBoZWlnaHQgLSAxOyBpKyspIHsKICAgICAgbG5iZCA9IDE7CiAgICAgIGZvciAobGV0IGogPSAxOyBqIDwgd2lkdGggLSAxOyBqKyspIHsKICAgICAgICBjb25zdCBpaiA9IGkgKiB3aWR0aCArIGo7CiAgICAgICAgY29uc3QgcGl4ID0gdHlwZXNbaWpdOwogICAgICAgIGlmIChwaXggPT09IDApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBsZXQgaTIgPSBpOwogICAgICAgIGxldCBqMiA9IGo7CiAgICAgICAgaWYgKHBpeCA9PT0gMSAmJiB0eXBlc1tpaiAtIDFdID09PSAwKSB7CiAgICAgICAgICBuYmQgKz0gMTsKICAgICAgICAgIGoyIC09IDE7CiAgICAgICAgfSBlbHNlIGlmIChwaXggPj0gMSAmJiB0eXBlc1tpaiArIDFdID09PSAwKSB7CiAgICAgICAgICBuYmQgKz0gMTsKICAgICAgICAgIGoyICs9IDE7CiAgICAgICAgICBpZiAocGl4ID4gMSkgewogICAgICAgICAgICBsbmJkID0gcGl4OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAocGl4ICE9PSAxKSB7CiAgICAgICAgICAgIGxuYmQgPSBNYXRoLmFicyhwaXgpOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBvaW50cyA9IFtqLCBpXTsKICAgICAgICBjb25zdCBpc0hvbGUgPSBqMiA9PT0gaiArIDE7CiAgICAgICAgY29uc3QgY29udG91ciA9IHsKICAgICAgICAgIGlzSG9sZSwKICAgICAgICAgIHBvaW50cywKICAgICAgICAgIGlkOiBuYmQsCiAgICAgICAgICBwYXJlbnQ6IDAKICAgICAgICB9OwogICAgICAgIGNvbnRvdXJzLnB1c2goY29udG91cik7CiAgICAgICAgbGV0IGNvbnRvdXIwOwogICAgICAgIGZvciAoY29uc3QgYyBvZiBjb250b3VycykgewogICAgICAgICAgaWYgKGMuaWQgPT09IGxuYmQpIHsKICAgICAgICAgICAgY29udG91cjAgPSBjOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFjb250b3VyMCkgewogICAgICAgICAgY29udG91ci5wYXJlbnQgPSBpc0hvbGUgPyBsbmJkIDogMDsKICAgICAgICB9IGVsc2UgaWYgKGNvbnRvdXIwLmlzSG9sZSkgewogICAgICAgICAgY29udG91ci5wYXJlbnQgPSBpc0hvbGUgPyBjb250b3VyMC5wYXJlbnQgOiBsbmJkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250b3VyLnBhcmVudCA9IGlzSG9sZSA/IGxuYmQgOiBjb250b3VyMC5wYXJlbnQ7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGsgPSB0aGlzLiNjbG9ja3dpc2VOb25aZXJvKHR5cGVzLCB3aWR0aCwgaSwgaiwgaTIsIGoyLCAwKTsKICAgICAgICBpZiAoayA9PT0gLTEpIHsKICAgICAgICAgIHR5cGVzW2lqXSA9IC1uYmQ7CiAgICAgICAgICBpZiAodHlwZXNbaWpdICE9PSAxKSB7CiAgICAgICAgICAgIGxuYmQgPSBNYXRoLmFicyh0eXBlc1tpal0pOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGxldCBzaGlmdEkgPSB0aGlzLiNuZWlnaGJvcklkVG9JbmRleFsyICoga107CiAgICAgICAgbGV0IHNoaWZ0SiA9IHRoaXMuI25laWdoYm9ySWRUb0luZGV4WzIgKiBrICsgMV07CiAgICAgICAgY29uc3QgaTEgPSBpICsgc2hpZnRJOwogICAgICAgIGNvbnN0IGoxID0gaiArIHNoaWZ0SjsKICAgICAgICBpMiA9IGkxOwogICAgICAgIGoyID0gajE7CiAgICAgICAgbGV0IGkzID0gaTsKICAgICAgICBsZXQgajMgPSBqOwogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBjb25zdCBrayA9IHRoaXMuI2NvdW50ZXJDbG9ja3dpc2VOb25aZXJvKHR5cGVzLCB3aWR0aCwgaTMsIGozLCBpMiwgajIsIDEpOwogICAgICAgICAgc2hpZnRJID0gdGhpcy4jbmVpZ2hib3JJZFRvSW5kZXhbMiAqIGtrXTsKICAgICAgICAgIHNoaWZ0SiA9IHRoaXMuI25laWdoYm9ySWRUb0luZGV4WzIgKiBrayArIDFdOwogICAgICAgICAgY29uc3QgaTQgPSBpMyArIHNoaWZ0STsKICAgICAgICAgIGNvbnN0IGo0ID0gajMgKyBzaGlmdEo7CiAgICAgICAgICBwb2ludHMucHVzaChqNCwgaTQpOwogICAgICAgICAgY29uc3QgaWozID0gaTMgKiB3aWR0aCArIGozOwogICAgICAgICAgaWYgKHR5cGVzW2lqMyArIDFdID09PSAwKSB7CiAgICAgICAgICAgIHR5cGVzW2lqM10gPSAtbmJkOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlc1tpajNdID09PSAxKSB7CiAgICAgICAgICAgIHR5cGVzW2lqM10gPSBuYmQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaTQgPT09IGkgJiYgajQgPT09IGogJiYgaTMgPT09IGkxICYmIGozID09PSBqMSkgewogICAgICAgICAgICBpZiAodHlwZXNbaWpdICE9PSAxKSB7CiAgICAgICAgICAgICAgbG5iZCA9IE1hdGguYWJzKHR5cGVzW2lqXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpMiA9IGkzOwogICAgICAgICAgICBqMiA9IGozOwogICAgICAgICAgICBpMyA9IGk0OwogICAgICAgICAgICBqMyA9IGo0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNvbnRvdXJzOwogIH0KICBzdGF0aWMgI2RvdWdsYXNQZXVja2VySGVscGVyKHBvaW50cywgc3RhcnQsIGVuZCwgb3V0cHV0KSB7CiAgICBpZiAoZW5kIC0gc3RhcnQgPD0gNCkgewogICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBlbmQgLSAyOyBpICs9IDIpIHsKICAgICAgICBvdXRwdXQucHVzaChwb2ludHNbaV0sIHBvaW50c1tpICsgMV0pOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGF4ID0gcG9pbnRzW3N0YXJ0XTsKICAgIGNvbnN0IGF5ID0gcG9pbnRzW3N0YXJ0ICsgMV07CiAgICBjb25zdCBhYnggPSBwb2ludHNbZW5kIC0gNF0gLSBheDsKICAgIGNvbnN0IGFieSA9IHBvaW50c1tlbmQgLSAzXSAtIGF5OwogICAgY29uc3QgZGlzdCA9IE1hdGguaHlwb3QoYWJ4LCBhYnkpOwogICAgY29uc3QgbmFieCA9IGFieCAvIGRpc3Q7CiAgICBjb25zdCBuYWJ5ID0gYWJ5IC8gZGlzdDsKICAgIGNvbnN0IGFhID0gbmFieCAqIGF5IC0gbmFieSAqIGF4OwogICAgY29uc3QgbSA9IGFieSAvIGFieDsKICAgIGNvbnN0IGludlMgPSAxIC8gZGlzdDsKICAgIGNvbnN0IHBoaSA9IE1hdGguYXRhbihtKTsKICAgIGNvbnN0IGNvc1BoaSA9IE1hdGguY29zKHBoaSk7CiAgICBjb25zdCBzaW5QaGkgPSBNYXRoLnNpbihwaGkpOwogICAgY29uc3QgdG1heCA9IGludlMgKiAoTWF0aC5hYnMoY29zUGhpKSArIE1hdGguYWJzKHNpblBoaSkpOwogICAgY29uc3QgcG9seSA9IGludlMgKiAoMSAtIHRtYXggKyB0bWF4ICoqIDIpOwogICAgY29uc3QgcGFydGlhbFBoaSA9IE1hdGgubWF4KE1hdGguYXRhbihNYXRoLmFicyhzaW5QaGkgKyBjb3NQaGkpICogcG9seSksIE1hdGguYXRhbihNYXRoLmFicyhzaW5QaGkgLSBjb3NQaGkpICogcG9seSkpOwogICAgbGV0IGRtYXggPSAwOwogICAgbGV0IGluZGV4ID0gc3RhcnQ7CiAgICBmb3IgKGxldCBpID0gc3RhcnQgKyAyOyBpIDwgZW5kIC0gMjsgaSArPSAyKSB7CiAgICAgIGNvbnN0IGQgPSBNYXRoLmFicyhhYSAtIG5hYnggKiBwb2ludHNbaSArIDFdICsgbmFieSAqIHBvaW50c1tpXSk7CiAgICAgIGlmIChkID4gZG1heCkgewogICAgICAgIGluZGV4ID0gaTsKICAgICAgICBkbWF4ID0gZDsKICAgICAgfQogICAgfQogICAgaWYgKGRtYXggPiAoZGlzdCAqIHBhcnRpYWxQaGkpICoqIDIpIHsKICAgICAgdGhpcy4jZG91Z2xhc1BldWNrZXJIZWxwZXIocG9pbnRzLCBzdGFydCwgaW5kZXggKyAyLCBvdXRwdXQpOwogICAgICB0aGlzLiNkb3VnbGFzUGV1Y2tlckhlbHBlcihwb2ludHMsIGluZGV4LCBlbmQsIG91dHB1dCk7CiAgICB9IGVsc2UgewogICAgICBvdXRwdXQucHVzaChheCwgYXkpOwogICAgfQogIH0KICBzdGF0aWMgI2RvdWdsYXNQZXVja2VyKHBvaW50cykgewogICAgY29uc3Qgb3V0cHV0ID0gW107CiAgICBjb25zdCBsZW4gPSBwb2ludHMubGVuZ3RoOwogICAgdGhpcy4jZG91Z2xhc1BldWNrZXJIZWxwZXIocG9pbnRzLCAwLCBsZW4sIG91dHB1dCk7CiAgICBvdXRwdXQucHVzaChwb2ludHNbbGVuIC0gMl0sIHBvaW50c1tsZW4gLSAxXSk7CiAgICByZXR1cm4gb3V0cHV0Lmxlbmd0aCA8PSA0ID8gbnVsbCA6IG91dHB1dDsKICB9CiAgc3RhdGljICNiaWxhdGVyYWxGaWx0ZXIoYnVmLCB3aWR0aCwgaGVpZ2h0LCBzaWdtYVMsIHNpZ21hUiwga2VybmVsU2l6ZSkgewogICAgY29uc3Qga2VybmVsID0gbmV3IEZsb2F0MzJBcnJheShrZXJuZWxTaXplICoqIDIpOwogICAgY29uc3Qgc2lnbWFTMiA9IC0yICogc2lnbWFTICoqIDI7CiAgICBjb25zdCBoYWxmU2l6ZSA9IGtlcm5lbFNpemUgPj4gMTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2VybmVsU2l6ZTsgaSsrKSB7CiAgICAgIGNvbnN0IHggPSAoaSAtIGhhbGZTaXplKSAqKiAyOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGtlcm5lbFNpemU7IGorKykgewogICAgICAgIGtlcm5lbFtpICoga2VybmVsU2l6ZSArIGpdID0gTWF0aC5leHAoKHggKyAoaiAtIGhhbGZTaXplKSAqKiAyKSAvIHNpZ21hUzIpOwogICAgICB9CiAgICB9CiAgICBjb25zdCByYW5nZVZhbHVlcyA9IG5ldyBGbG9hdDMyQXJyYXkoMjU2KTsKICAgIGNvbnN0IHNpZ21hUjIgPSAtMiAqIHNpZ21hUiAqKiAyOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgICByYW5nZVZhbHVlc1tpXSA9IE1hdGguZXhwKGkgKiogMiAvIHNpZ21hUjIpOwogICAgfQogICAgY29uc3QgTiA9IGJ1Zi5sZW5ndGg7CiAgICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheShOKTsKICAgIGNvbnN0IGhpc3RvZ3JhbSA9IG5ldyBVaW50MzJBcnJheSgyNTYpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoZWlnaHQ7IGkrKykgewogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHdpZHRoOyBqKyspIHsKICAgICAgICBjb25zdCBpaiA9IGkgKiB3aWR0aCArIGo7CiAgICAgICAgY29uc3QgY2VudGVyID0gYnVmW2lqXTsKICAgICAgICBsZXQgc3VtID0gMDsKICAgICAgICBsZXQgbm9ybSA9IDA7CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBrZXJuZWxTaXplOyBrKyspIHsKICAgICAgICAgIGNvbnN0IHkgPSBpICsgayAtIGhhbGZTaXplOwogICAgICAgICAgaWYgKHkgPCAwIHx8IHkgPj0gaGVpZ2h0KSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgZm9yIChsZXQgbCA9IDA7IGwgPCBrZXJuZWxTaXplOyBsKyspIHsKICAgICAgICAgICAgY29uc3QgeCA9IGogKyBsIC0gaGFsZlNpemU7CiAgICAgICAgICAgIGlmICh4IDwgMCB8fCB4ID49IHdpZHRoKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgbmVpZ2hib3VyID0gYnVmW3kgKiB3aWR0aCArIHhdOwogICAgICAgICAgICBjb25zdCB3ID0ga2VybmVsW2sgKiBrZXJuZWxTaXplICsgbF0gKiByYW5nZVZhbHVlc1tNYXRoLmFicyhuZWlnaGJvdXIgLSBjZW50ZXIpXTsKICAgICAgICAgICAgc3VtICs9IG5laWdoYm91ciAqIHc7CiAgICAgICAgICAgIG5vcm0gKz0gdzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcGl4ID0gb3V0W2lqXSA9IE1hdGgucm91bmQoc3VtIC8gbm9ybSk7CiAgICAgICAgaGlzdG9ncmFtW3BpeF0rKzsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFtvdXQsIGhpc3RvZ3JhbV07CiAgfQogIHN0YXRpYyAjZ2V0SGlzdG9ncmFtKGJ1ZikgewogICAgY29uc3QgaGlzdG9ncmFtID0gbmV3IFVpbnQzMkFycmF5KDI1Nik7CiAgICBmb3IgKGNvbnN0IGcgb2YgYnVmKSB7CiAgICAgIGhpc3RvZ3JhbVtnXSsrOwogICAgfQogICAgcmV0dXJuIGhpc3RvZ3JhbTsKICB9CiAgc3RhdGljICN0b1VpbnQ4KGJ1ZikgewogICAgY29uc3QgTiA9IGJ1Zi5sZW5ndGg7CiAgICBjb25zdCBvdXQgPSBuZXcgVWludDhDbGFtcGVkQXJyYXkoTiA+PiAyKTsKICAgIGxldCBtYXggPSAtSW5maW5pdHk7CiAgICBsZXQgbWluID0gSW5maW5pdHk7CiAgICBmb3IgKGxldCBpID0gMCwgaWkgPSBvdXQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICBjb25zdCBwaXggPSBvdXRbaV0gPSBidWZbaSA8PCAyXTsKICAgICAgbWF4ID0gTWF0aC5tYXgobWF4LCBwaXgpOwogICAgICBtaW4gPSBNYXRoLm1pbihtaW4sIHBpeCk7CiAgICB9CiAgICBjb25zdCByYXRpbyA9IDI1NSAvIChtYXggLSBtaW4pOwogICAgZm9yIChsZXQgaSA9IDAsIGlpID0gb3V0Lmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgb3V0W2ldID0gKG91dFtpXSAtIG1pbikgKiByYXRpbzsKICAgIH0KICAgIHJldHVybiBvdXQ7CiAgfQogIHN0YXRpYyAjZ3Vlc3NUaHJlc2hvbGQoaGlzdG9ncmFtKSB7CiAgICBsZXQgaTsKICAgIGxldCBNID0gLUluZmluaXR5OwogICAgbGV0IEwgPSAtSW5maW5pdHk7CiAgICBjb25zdCBtaW4gPSBoaXN0b2dyYW0uZmluZEluZGV4KCh2KSA9PiB2ICE9PSAwKTsKICAgIGxldCBwb3MgPSBtaW47CiAgICBsZXQgc3BvcyA9IG1pbjsKICAgIGZvciAoaSA9IG1pbjsgaSA8IDI1NjsgaSsrKSB7CiAgICAgIGNvbnN0IHYgPSBoaXN0b2dyYW1baV07CiAgICAgIGlmICh2ID4gTSkgewogICAgICAgIGlmIChpIC0gcG9zID4gTCkgewogICAgICAgICAgTCA9IGkgLSBwb3M7CiAgICAgICAgICBzcG9zID0gaSAtIDE7CiAgICAgICAgfQogICAgICAgIE0gPSB2OwogICAgICAgIHBvcyA9IGk7CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IHNwb3MgLSAxOyBpID49IDA7IGktLSkgewogICAgICBpZiAoaGlzdG9ncmFtW2ldID4gaGlzdG9ncmFtW2kgKyAxXSkgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaTsKICB9CiAgc3RhdGljICNnZXRHcmF5UGl4ZWxzKGJpdG1hcCkgewogICAgY29uc3Qgb3JpZ2luYWxCaXRtYXAgPSBiaXRtYXA7CiAgICBjb25zdCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSBiaXRtYXA7CiAgICBjb25zdCB7CiAgICAgIG1heERpbQogICAgfSA9IHRoaXMuI1BBUkFNRVRFUlM7CiAgICBsZXQgbmV3V2lkdGggPSB3aWR0aDsKICAgIGxldCBuZXdIZWlnaHQgPSBoZWlnaHQ7CiAgICBpZiAod2lkdGggPiBtYXhEaW0gfHwgaGVpZ2h0ID4gbWF4RGltKSB7CiAgICAgIGxldCBwcmV2V2lkdGggPSB3aWR0aDsKICAgICAgbGV0IHByZXZIZWlnaHQgPSBoZWlnaHQ7CiAgICAgIGxldCBzdGVwcyA9IE1hdGgubG9nMihNYXRoLm1heCh3aWR0aCwgaGVpZ2h0KSAvIG1heERpbSk7CiAgICAgIGNvbnN0IGlzdGVwcyA9IE1hdGguZmxvb3Ioc3RlcHMpOwogICAgICBzdGVwcyA9IHN0ZXBzID09PSBpc3RlcHMgPyBpc3RlcHMgLSAxIDogaXN0ZXBzOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZXBzOyBpKyspIHsKICAgICAgICBuZXdXaWR0aCA9IE1hdGguY2VpbChwcmV2V2lkdGggLyAyKTsKICAgICAgICBuZXdIZWlnaHQgPSBNYXRoLmNlaWwocHJldkhlaWdodCAvIDIpOwogICAgICAgIGNvbnN0IG9mZnNjcmVlbjIgPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgICAgIGNvbnN0IGN0eDIgPSBvZmZzY3JlZW4yLmdldENvbnRleHQoIjJkIik7CiAgICAgICAgY3R4Mi5kcmF3SW1hZ2UoYml0bWFwLCAwLCAwLCBwcmV2V2lkdGgsIHByZXZIZWlnaHQsIDAsIDAsIG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgICAgIHByZXZXaWR0aCA9IG5ld1dpZHRoOwogICAgICAgIHByZXZIZWlnaHQgPSBuZXdIZWlnaHQ7CiAgICAgICAgaWYgKGJpdG1hcCAhPT0gb3JpZ2luYWxCaXRtYXApIHsKICAgICAgICAgIGJpdG1hcC5jbG9zZSgpOwogICAgICAgIH0KICAgICAgICBiaXRtYXAgPSBvZmZzY3JlZW4yLnRyYW5zZmVyVG9JbWFnZUJpdG1hcCgpOwogICAgICB9CiAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4obWF4RGltIC8gbmV3V2lkdGgsIG1heERpbSAvIG5ld0hlaWdodCk7CiAgICAgIG5ld1dpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCAqIHJhdGlvKTsKICAgICAgbmV3SGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQgKiByYXRpbyk7CiAgICB9CiAgICBjb25zdCBvZmZzY3JlZW4gPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKG5ld1dpZHRoLCBuZXdIZWlnaHQpOwogICAgY29uc3QgY3R4ID0gb2Zmc2NyZWVuLmdldENvbnRleHQoIjJkIiwgewogICAgICB3aWxsUmVhZEZyZXF1ZW50bHk6IHRydWUKICAgIH0pOwogICAgY3R4LmZpbGxTdHlsZSA9ICJ3aGl0ZSI7CiAgICBjdHguZmlsbFJlY3QoMCwgMCwgbmV3V2lkdGgsIG5ld0hlaWdodCk7CiAgICBjdHguZmlsdGVyID0gImdyYXlzY2FsZSgxKSI7CiAgICBjdHguZHJhd0ltYWdlKGJpdG1hcCwgMCwgMCwgYml0bWFwLndpZHRoLCBiaXRtYXAuaGVpZ2h0LCAwLCAwLCBuZXdXaWR0aCwgbmV3SGVpZ2h0KTsKICAgIGNvbnN0IGdyYXlJbWFnZSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgbmV3V2lkdGgsIG5ld0hlaWdodCkuZGF0YTsKICAgIGNvbnN0IHVpbnQ4QnVmID0gdGhpcy4jdG9VaW50OChncmF5SW1hZ2UpOwogICAgcmV0dXJuIFt1aW50OEJ1ZiwgbmV3V2lkdGgsIG5ld0hlaWdodF07CiAgfQogIHN0YXRpYyBleHRyYWN0Q29udG91cnNGcm9tVGV4dCh0ZXh0LCB7CiAgICBmb250RmFtaWx5LAogICAgZm9udFN0eWxlLAogICAgZm9udFdlaWdodAogIH0sIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgcm90YXRpb24sIGlubmVyTWFyZ2luKSB7CiAgICBsZXQgY2FudmFzID0gbmV3IE9mZnNjcmVlbkNhbnZhcygxLCAxKTsKICAgIGxldCBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgIGFscGhhOiBmYWxzZQogICAgfSk7CiAgICBjb25zdCBmb250U2l6ZSA9IDIwMDsKICAgIGNvbnN0IGZvbnQgPSBjdHguZm9udCA9IGAke2ZvbnRTdHlsZX0gJHtmb250V2VpZ2h0fSAke2ZvbnRTaXplfXB4ICR7Zm9udEZhbWlseX1gOwogICAgY29uc3QgewogICAgICBhY3R1YWxCb3VuZGluZ0JveExlZnQsCiAgICAgIGFjdHVhbEJvdW5kaW5nQm94UmlnaHQsCiAgICAgIGFjdHVhbEJvdW5kaW5nQm94QXNjZW50LAogICAgICBhY3R1YWxCb3VuZGluZ0JveERlc2NlbnQsCiAgICAgIGZvbnRCb3VuZGluZ0JveEFzY2VudCwKICAgICAgZm9udEJvdW5kaW5nQm94RGVzY2VudCwKICAgICAgd2lkdGgKICAgIH0gPSBjdHgubWVhc3VyZVRleHQodGV4dCk7CiAgICBjb25zdCBTQ0FMRSA9IDEuNTsKICAgIGNvbnN0IGNhbnZhc1dpZHRoID0gTWF0aC5jZWlsKE1hdGgubWF4KE1hdGguYWJzKGFjdHVhbEJvdW5kaW5nQm94TGVmdCkgKyBNYXRoLmFicyhhY3R1YWxCb3VuZGluZ0JveFJpZ2h0KSB8fCAwLCB3aWR0aCkgKiBTQ0FMRSk7CiAgICBjb25zdCBjYW52YXNIZWlnaHQgPSBNYXRoLmNlaWwoTWF0aC5tYXgoTWF0aC5hYnMoYWN0dWFsQm91bmRpbmdCb3hBc2NlbnQpICsgTWF0aC5hYnMoYWN0dWFsQm91bmRpbmdCb3hEZXNjZW50KSB8fCBmb250U2l6ZSwgTWF0aC5hYnMoZm9udEJvdW5kaW5nQm94QXNjZW50KSArIE1hdGguYWJzKGZvbnRCb3VuZGluZ0JveERlc2NlbnQpIHx8IGZvbnRTaXplKSAqIFNDQUxFKTsKICAgIGNhbnZhcyA9IG5ldyBPZmZzY3JlZW5DYW52YXMoY2FudmFzV2lkdGgsIGNhbnZhc0hlaWdodCk7CiAgICBjdHggPSBjYW52YXMuZ2V0Q29udGV4dCgiMmQiLCB7CiAgICAgIGFscGhhOiB0cnVlLAogICAgICB3aWxsUmVhZEZyZXF1ZW50bHk6IHRydWUKICAgIH0pOwogICAgY3R4LmZvbnQgPSBmb250OwogICAgY3R4LmZpbHRlciA9ICJncmF5c2NhbGUoMSkiOwogICAgY3R4LmZpbGxTdHlsZSA9ICJ3aGl0ZSI7CiAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzV2lkdGgsIGNhbnZhc0hlaWdodCk7CiAgICBjdHguZmlsbFN0eWxlID0gImJsYWNrIjsKICAgIGN0eC5maWxsVGV4dCh0ZXh0LCBjYW52YXNXaWR0aCAqIChTQ0FMRSAtIDEpIC8gMiwgY2FudmFzSGVpZ2h0ICogKDMgLSBTQ0FMRSkgLyAyKTsKICAgIGNvbnN0IHVpbnQ4QnVmID0gdGhpcy4jdG9VaW50OChjdHguZ2V0SW1hZ2VEYXRhKDAsIDAsIGNhbnZhc1dpZHRoLCBjYW52YXNIZWlnaHQpLmRhdGEpOwogICAgY29uc3QgaGlzdG9ncmFtID0gdGhpcy4jZ2V0SGlzdG9ncmFtKHVpbnQ4QnVmKTsKICAgIGNvbnN0IHRocmVzaG9sZCA9IHRoaXMuI2d1ZXNzVGhyZXNob2xkKGhpc3RvZ3JhbSk7CiAgICBjb25zdCBjb250b3VyTGlzdCA9IHRoaXMuI2ZpbmRDb250b3Vycyh1aW50OEJ1ZiwgY2FudmFzV2lkdGgsIGNhbnZhc0hlaWdodCwgdGhyZXNob2xkKTsKICAgIHJldHVybiB0aGlzLnByb2Nlc3NEcmF3bkxpbmVzKHsKICAgICAgbGluZXM6IHsKICAgICAgICBjdXJ2ZXM6IGNvbnRvdXJMaXN0LAogICAgICAgIHdpZHRoOiBjYW52YXNXaWR0aCwKICAgICAgICBoZWlnaHQ6IGNhbnZhc0hlaWdodAogICAgICB9LAogICAgICBwYWdlV2lkdGgsCiAgICAgIHBhZ2VIZWlnaHQsCiAgICAgIHJvdGF0aW9uLAogICAgICBpbm5lck1hcmdpbiwKICAgICAgbXVzdFNtb290aDogdHJ1ZSwKICAgICAgYXJlQ29udG91cnM6IHRydWUKICAgIH0pOwogIH0KICBzdGF0aWMgcHJvY2VzcyhiaXRtYXAsIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgcm90YXRpb24sIGlubmVyTWFyZ2luKSB7CiAgICBjb25zdCBbdWludDhCdWYsIHdpZHRoLCBoZWlnaHRdID0gdGhpcy4jZ2V0R3JheVBpeGVscyhiaXRtYXApOwogICAgY29uc3QgW2J1ZmZlciwgaGlzdG9ncmFtXSA9IHRoaXMuI2JpbGF0ZXJhbEZpbHRlcih1aW50OEJ1Ziwgd2lkdGgsIGhlaWdodCwgTWF0aC5oeXBvdCh3aWR0aCwgaGVpZ2h0KSAqIHRoaXMuI1BBUkFNRVRFUlMuc2lnbWFTRmFjdG9yLCB0aGlzLiNQQVJBTUVURVJTLnNpZ21hUiwgdGhpcy4jUEFSQU1FVEVSUy5rZXJuZWxTaXplKTsKICAgIGNvbnN0IHRocmVzaG9sZCA9IHRoaXMuI2d1ZXNzVGhyZXNob2xkKGhpc3RvZ3JhbSk7CiAgICBjb25zdCBjb250b3VyTGlzdCA9IHRoaXMuI2ZpbmRDb250b3VycyhidWZmZXIsIHdpZHRoLCBoZWlnaHQsIHRocmVzaG9sZCk7CiAgICByZXR1cm4gdGhpcy5wcm9jZXNzRHJhd25MaW5lcyh7CiAgICAgIGxpbmVzOiB7CiAgICAgICAgY3VydmVzOiBjb250b3VyTGlzdCwKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQKICAgICAgfSwKICAgICAgcGFnZVdpZHRoLAogICAgICBwYWdlSGVpZ2h0LAogICAgICByb3RhdGlvbiwKICAgICAgaW5uZXJNYXJnaW4sCiAgICAgIG11c3RTbW9vdGg6IHRydWUsCiAgICAgIGFyZUNvbnRvdXJzOiB0cnVlCiAgICB9KTsKICB9CiAgc3RhdGljIHByb2Nlc3NEcmF3bkxpbmVzKHsKICAgIGxpbmVzLAogICAgcGFnZVdpZHRoLAogICAgcGFnZUhlaWdodCwKICAgIHJvdGF0aW9uLAogICAgaW5uZXJNYXJnaW4sCiAgICBtdXN0U21vb3RoLAogICAgYXJlQ29udG91cnMKICB9KSB7CiAgICBpZiAocm90YXRpb24gJSAxODAgIT09IDApIHsKICAgICAgW3BhZ2VXaWR0aCwgcGFnZUhlaWdodF0gPSBbcGFnZUhlaWdodCwgcGFnZVdpZHRoXTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgY3VydmVzLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gbGluZXM7CiAgICBjb25zdCB0aGlja25lc3MgPSBsaW5lcy50aGlja25lc3MgPz8gMDsKICAgIGNvbnN0IGxpbmVzQW5kUG9pbnRzID0gW107CiAgICBjb25zdCByYXRpbyA9IE1hdGgubWluKHBhZ2VXaWR0aCAvIHdpZHRoLCBwYWdlSGVpZ2h0IC8gaGVpZ2h0KTsKICAgIGNvbnN0IHhTY2FsZSA9IHJhdGlvIC8gcGFnZVdpZHRoOwogICAgY29uc3QgeVNjYWxlID0gcmF0aW8gLyBwYWdlSGVpZ2h0OwogICAgY29uc3QgbmV3Q3VydmVzID0gW107CiAgICBmb3IgKGNvbnN0IHsKICAgICAgcG9pbnRzCiAgICB9IG9mIGN1cnZlcykgewogICAgICBjb25zdCByZWR1Y2VkUG9pbnRzID0gbXVzdFNtb290aCA/IHRoaXMuI2RvdWdsYXNQZXVja2VyKHBvaW50cykgOiBwb2ludHM7CiAgICAgIGlmICghcmVkdWNlZFBvaW50cykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIG5ld0N1cnZlcy5wdXNoKHJlZHVjZWRQb2ludHMpOwogICAgICBjb25zdCBsZW4gPSByZWR1Y2VkUG9pbnRzLmxlbmd0aDsKICAgICAgY29uc3QgbmV3UG9pbnRzID0gbmV3IEZsb2F0MzJBcnJheShsZW4pOwogICAgICBjb25zdCBsaW5lID0gbmV3IEZsb2F0MzJBcnJheSgzICogKGxlbiA9PT0gMiA/IDIgOiBsZW4gLSAyKSk7CiAgICAgIGxpbmVzQW5kUG9pbnRzLnB1c2goewogICAgICAgIGxpbmUsCiAgICAgICAgcG9pbnRzOiBuZXdQb2ludHMKICAgICAgfSk7CiAgICAgIGlmIChsZW4gPT09IDIpIHsKICAgICAgICBuZXdQb2ludHNbMF0gPSByZWR1Y2VkUG9pbnRzWzBdICogeFNjYWxlOwogICAgICAgIG5ld1BvaW50c1sxXSA9IHJlZHVjZWRQb2ludHNbMV0gKiB5U2NhbGU7CiAgICAgICAgbGluZS5zZXQoW05hTiwgTmFOLCBOYU4sIE5hTiwgbmV3UG9pbnRzWzBdLCBuZXdQb2ludHNbMV1dLCAwKTsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBsZXQgW3gxLCB5MSwgeDIsIHkyXSA9IHJlZHVjZWRQb2ludHM7CiAgICAgIHgxICo9IHhTY2FsZTsKICAgICAgeTEgKj0geVNjYWxlOwogICAgICB4MiAqPSB4U2NhbGU7CiAgICAgIHkyICo9IHlTY2FsZTsKICAgICAgbmV3UG9pbnRzLnNldChbeDEsIHkxLCB4MiwgeTJdLCAwKTsKICAgICAgbGluZS5zZXQoW05hTiwgTmFOLCBOYU4sIE5hTiwgeDEsIHkxXSwgMCk7CiAgICAgIGZvciAobGV0IGkgPSA0OyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgICBjb25zdCB4ID0gbmV3UG9pbnRzW2ldID0gcmVkdWNlZFBvaW50c1tpXSAqIHhTY2FsZTsKICAgICAgICBjb25zdCB5ID0gbmV3UG9pbnRzW2kgKyAxXSA9IHJlZHVjZWRQb2ludHNbaSArIDFdICogeVNjYWxlOwogICAgICAgIGxpbmUuc2V0KE91dGxpbmUuY3JlYXRlQmV6aWVyUG9pbnRzKHgxLCB5MSwgeDIsIHkyLCB4LCB5KSwgKGkgLSAyKSAqIDMpOwogICAgICAgIFt4MSwgeTEsIHgyLCB5Ml0gPSBbeDIsIHkyLCB4LCB5XTsKICAgICAgfQogICAgfQogICAgaWYgKGxpbmVzQW5kUG9pbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IG91dGxpbmUgPSBhcmVDb250b3VycyA/IG5ldyBDb250b3VyRHJhd091dGxpbmUoKSA6IG5ldyBJbmtEcmF3T3V0bGluZSgpOwogICAgb3V0bGluZS5idWlsZChsaW5lc0FuZFBvaW50cywgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCAxLCByb3RhdGlvbiwgYXJlQ29udG91cnMgPyAwIDogdGhpY2tuZXNzLCBpbm5lck1hcmdpbik7CiAgICByZXR1cm4gewogICAgICBvdXRsaW5lLAogICAgICBuZXdDdXJ2ZXMsCiAgICAgIGFyZUNvbnRvdXJzLAogICAgICB0aGlja25lc3MsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH07CiAgfQogIHN0YXRpYyBhc3luYyBjb21wcmVzc1NpZ25hdHVyZSh7CiAgICBvdXRsaW5lcywKICAgIGFyZUNvbnRvdXJzLAogICAgdGhpY2tuZXNzLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9KSB7CiAgICBsZXQgbWluRGlmZiA9IEluZmluaXR5OwogICAgbGV0IG1heERpZmYgPSAtSW5maW5pdHk7CiAgICBsZXQgb3V0bGluZXNMZW5ndGggPSAwOwogICAgZm9yIChjb25zdCBwb2ludHMgb2Ygb3V0bGluZXMpIHsKICAgICAgb3V0bGluZXNMZW5ndGggKz0gcG9pbnRzLmxlbmd0aDsKICAgICAgZm9yIChsZXQgaSA9IDIsIGlpID0gcG9pbnRzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBjb25zdCBkeCA9IHBvaW50c1tpXSAtIHBvaW50c1tpIC0gMl07CiAgICAgICAgbWluRGlmZiA9IE1hdGgubWluKG1pbkRpZmYsIGR4KTsKICAgICAgICBtYXhEaWZmID0gTWF0aC5tYXgobWF4RGlmZiwgZHgpOwogICAgICB9CiAgICB9CiAgICBsZXQgYnVmZmVyVHlwZTsKICAgIGlmIChtaW5EaWZmID49IC0xMjggJiYgbWF4RGlmZiA8PSAxMjcpIHsKICAgICAgYnVmZmVyVHlwZSA9IEludDhBcnJheTsKICAgIH0gZWxzZSBpZiAobWluRGlmZiA+PSAtMzI3NjggJiYgbWF4RGlmZiA8PSAzMjc2NykgewogICAgICBidWZmZXJUeXBlID0gSW50MTZBcnJheTsKICAgIH0gZWxzZSB7CiAgICAgIGJ1ZmZlclR5cGUgPSBJbnQzMkFycmF5OwogICAgfQogICAgY29uc3QgbGVuID0gb3V0bGluZXMubGVuZ3RoOwogICAgY29uc3QgaGVhZGVyTGVuZ3RoID0gQkFTRV9IRUFERVJfTEVOR1RIICsgUE9JTlRTX1BST1BFUlRJRVNfTlVNQkVSICogbGVuOwogICAgY29uc3QgaGVhZGVyID0gbmV3IFVpbnQzMkFycmF5KGhlYWRlckxlbmd0aCk7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIGhlYWRlcltvZmZzZXQrK10gPSBoZWFkZXJMZW5ndGggKiBVaW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVCArIChvdXRsaW5lc0xlbmd0aCAtIDIgKiBsZW4pICogYnVmZmVyVHlwZS5CWVRFU19QRVJfRUxFTUVOVDsKICAgIGhlYWRlcltvZmZzZXQrK10gPSAwOwogICAgaGVhZGVyW29mZnNldCsrXSA9IHdpZHRoOwogICAgaGVhZGVyW29mZnNldCsrXSA9IGhlaWdodDsKICAgIGhlYWRlcltvZmZzZXQrK10gPSBhcmVDb250b3VycyA/IDAgOiAxOwogICAgaGVhZGVyW29mZnNldCsrXSA9IE1hdGgubWF4KDAsIE1hdGguZmxvb3IodGhpY2tuZXNzID8/IDApKTsKICAgIGhlYWRlcltvZmZzZXQrK10gPSBsZW47CiAgICBoZWFkZXJbb2Zmc2V0KytdID0gYnVmZmVyVHlwZS5CWVRFU19QRVJfRUxFTUVOVDsKICAgIGZvciAoY29uc3QgcG9pbnRzIG9mIG91dGxpbmVzKSB7CiAgICAgIGhlYWRlcltvZmZzZXQrK10gPSBwb2ludHMubGVuZ3RoIC0gMjsKICAgICAgaGVhZGVyW29mZnNldCsrXSA9IHBvaW50c1swXTsKICAgICAgaGVhZGVyW29mZnNldCsrXSA9IHBvaW50c1sxXTsKICAgIH0KICAgIGNvbnN0IGNzID0gbmV3IENvbXByZXNzaW9uU3RyZWFtKCJkZWZsYXRlLXJhdyIpOwogICAgY29uc3Qgd3JpdGVyID0gY3Mud3JpdGFibGUuZ2V0V3JpdGVyKCk7CiAgICBhd2FpdCB3cml0ZXIucmVhZHk7CiAgICB3cml0ZXIud3JpdGUoaGVhZGVyKTsKICAgIGNvbnN0IEJ1ZmZlckN0b3IgPSBidWZmZXJUeXBlLnByb3RvdHlwZS5jb25zdHJ1Y3RvcjsKICAgIGZvciAoY29uc3QgcG9pbnRzIG9mIG91dGxpbmVzKSB7CiAgICAgIGNvbnN0IGRpZmZzID0gbmV3IEJ1ZmZlckN0b3IocG9pbnRzLmxlbmd0aCAtIDIpOwogICAgICBmb3IgKGxldCBpID0gMiwgaWkgPSBwb2ludHMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGRpZmZzW2kgLSAyXSA9IHBvaW50c1tpXSAtIHBvaW50c1tpIC0gMl07CiAgICAgIH0KICAgICAgd3JpdGVyLndyaXRlKGRpZmZzKTsKICAgIH0KICAgIHdyaXRlci5jbG9zZSgpOwogICAgY29uc3QgYnVmID0gYXdhaXQgbmV3IFJlc3BvbnNlKGNzLnJlYWRhYmxlKS5hcnJheUJ1ZmZlcigpOwogICAgY29uc3QgYnl0ZXMgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgcmV0dXJuIHRvQmFzZTY0VXRpbChieXRlcyk7CiAgfQogIHN0YXRpYyBhc3luYyBkZWNvbXByZXNzU2lnbmF0dXJlKHNpZ25hdHVyZURhdGEpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGJ5dGVzID0gZnJvbUJhc2U2NFV0aWwoc2lnbmF0dXJlRGF0YSk7CiAgICAgIGNvbnN0IHsKICAgICAgICByZWFkYWJsZSwKICAgICAgICB3cml0YWJsZQogICAgICB9ID0gbmV3IERlY29tcHJlc3Npb25TdHJlYW0oImRlZmxhdGUtcmF3Iik7CiAgICAgIGNvbnN0IHdyaXRlciA9IHdyaXRhYmxlLmdldFdyaXRlcigpOwogICAgICBhd2FpdCB3cml0ZXIucmVhZHk7CiAgICAgIHdyaXRlci53cml0ZShieXRlcykudGhlbihhc3luYyAoKSA9PiB7CiAgICAgICAgYXdhaXQgd3JpdGVyLnJlYWR5OwogICAgICAgIGF3YWl0IHdyaXRlci5jbG9zZSgpOwogICAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICAgIH0pOwogICAgICBsZXQgZGF0YSA9IG51bGw7CiAgICAgIGxldCBvZmZzZXQgPSAwOwogICAgICBmb3IgYXdhaXQgKGNvbnN0IGNodW5rIG9mIHJlYWRhYmxlKSB7CiAgICAgICAgZGF0YSB8fD0gbmV3IFVpbnQ4QXJyYXkobmV3IFVpbnQzMkFycmF5KGNodW5rLmJ1ZmZlciwgMCwgNClbMF0pOwogICAgICAgIGRhdGEuc2V0KGNodW5rLCBvZmZzZXQpOwogICAgICAgIG9mZnNldCArPSBjaHVuay5sZW5ndGg7CiAgICAgIH0KICAgICAgY29uc3QgaGVhZGVyID0gbmV3IFVpbnQzMkFycmF5KGRhdGEuYnVmZmVyLCAwLCBkYXRhLmxlbmd0aCA+PiAyKTsKICAgICAgY29uc3QgdmVyc2lvbjIgPSBoZWFkZXJbMV07CiAgICAgIGlmICh2ZXJzaW9uMiAhPT0gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCB2ZXJzaW9uOiAke3ZlcnNpb24yfWApOwogICAgICB9CiAgICAgIGNvbnN0IHdpZHRoID0gaGVhZGVyWzJdOwogICAgICBjb25zdCBoZWlnaHQgPSBoZWFkZXJbM107CiAgICAgIGNvbnN0IGFyZUNvbnRvdXJzID0gaGVhZGVyWzRdID09PSAwOwogICAgICBjb25zdCB0aGlja25lc3MgPSBoZWFkZXJbNV07CiAgICAgIGNvbnN0IG51bWJlck9mRHJhd2luZ3MgPSBoZWFkZXJbNl07CiAgICAgIGNvbnN0IGJ1ZmZlclR5cGUgPSBoZWFkZXJbN107CiAgICAgIGNvbnN0IG91dGxpbmVzID0gW107CiAgICAgIGNvbnN0IGRpZmZzT2Zmc2V0ID0gKEJBU0VfSEVBREVSX0xFTkdUSCArIFBPSU5UU19QUk9QRVJUSUVTX05VTUJFUiAqIG51bWJlck9mRHJhd2luZ3MpICogVWludDMyQXJyYXkuQllURVNfUEVSX0VMRU1FTlQ7CiAgICAgIGxldCBkaWZmczsKICAgICAgc3dpdGNoIChidWZmZXJUeXBlKSB7CiAgICAgICAgY2FzZSBJbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQ6CiAgICAgICAgICBkaWZmcyA9IG5ldyBJbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRpZmZzT2Zmc2V0KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgSW50MTZBcnJheS5CWVRFU19QRVJfRUxFTUVOVDoKICAgICAgICAgIGRpZmZzID0gbmV3IEludDE2QXJyYXkoZGF0YS5idWZmZXIsIGRpZmZzT2Zmc2V0KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgSW50MzJBcnJheS5CWVRFU19QRVJfRUxFTUVOVDoKICAgICAgICAgIGRpZmZzID0gbmV3IEludDMyQXJyYXkoZGF0YS5idWZmZXIsIGRpZmZzT2Zmc2V0KTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIG9mZnNldCA9IDA7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtYmVyT2ZEcmF3aW5nczsgaSsrKSB7CiAgICAgICAgY29uc3QgbGVuID0gaGVhZGVyW1BPSU5UU19QUk9QRVJUSUVTX05VTUJFUiAqIGkgKyBCQVNFX0hFQURFUl9MRU5HVEhdOwogICAgICAgIGNvbnN0IHBvaW50cyA9IG5ldyBGbG9hdDMyQXJyYXkobGVuICsgMik7CiAgICAgICAgb3V0bGluZXMucHVzaChwb2ludHMpOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgUE9JTlRTX1BST1BFUlRJRVNfTlVNQkVSIC0gMTsgaisrKSB7CiAgICAgICAgICBwb2ludHNbal0gPSBoZWFkZXJbUE9JTlRTX1BST1BFUlRJRVNfTlVNQkVSICogaSArIEJBU0VfSEVBREVSX0xFTkdUSCArIGogKyAxXTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBsZW47IGorKykgewogICAgICAgICAgcG9pbnRzW2ogKyAyXSA9IHBvaW50c1tqXSArIGRpZmZzW29mZnNldCsrXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBhcmVDb250b3VycywKICAgICAgICB0aGlja25lc3MsCiAgICAgICAgb3V0bGluZXMsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0CiAgICAgIH07CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHdhcm4oYGRlY29tcHJlc3NTaWduYXR1cmU6ICR7ZX1gKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfQp9Owp2YXIgU2lnbmF0dXJlT3B0aW9ucyA9IGNsYXNzIF9TaWduYXR1cmVPcHRpb25zIGV4dGVuZHMgRHJhd2luZ09wdGlvbnMgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoKTsKICAgIHN1cGVyLnVwZGF0ZVByb3BlcnRpZXMoewogICAgICBmaWxsOiBBbm5vdGF0aW9uRWRpdG9yLl9kZWZhdWx0TGluZUNvbG9yLAogICAgICAic3Ryb2tlLXdpZHRoIjogMAogICAgfSk7CiAgfQogIGNsb25lKCkgewogICAgY29uc3QgY2xvbmUgPSBuZXcgX1NpZ25hdHVyZU9wdGlvbnMoKTsKICAgIGNsb25lLnVwZGF0ZUFsbCh0aGlzKTsKICAgIHJldHVybiBjbG9uZTsKICB9Cn07CnZhciBEcmF3blNpZ25hdHVyZU9wdGlvbnMgPSBjbGFzcyBfRHJhd25TaWduYXR1cmVPcHRpb25zIGV4dGVuZHMgSW5rRHJhd2luZ09wdGlvbnMgewogIGNvbnN0cnVjdG9yKHZpZXdlclBhcmFtZXRlcnMpIHsKICAgIHN1cGVyKHZpZXdlclBhcmFtZXRlcnMpOwogICAgc3VwZXIudXBkYXRlUHJvcGVydGllcyh7CiAgICAgIHN0cm9rZTogQW5ub3RhdGlvbkVkaXRvci5fZGVmYXVsdExpbmVDb2xvciwKICAgICAgInN0cm9rZS13aWR0aCI6IDEKICAgIH0pOwogIH0KICBjbG9uZSgpIHsKICAgIGNvbnN0IGNsb25lID0gbmV3IF9EcmF3blNpZ25hdHVyZU9wdGlvbnModGhpcy5fdmlld1BhcmFtZXRlcnMpOwogICAgY2xvbmUudXBkYXRlQWxsKHRoaXMpOwogICAgcmV0dXJuIGNsb25lOwogIH0KfTsKdmFyIFNpZ25hdHVyZUVkaXRvciA9IGNsYXNzIF9TaWduYXR1cmVFZGl0b3IgZXh0ZW5kcyBEcmF3aW5nRWRpdG9yIHsKICAjaXNFeHRyYWN0ZWQgPSBmYWxzZTsKICAjZGVzY3JpcHRpb24gPSBudWxsOwogICNzaWduYXR1cmVEYXRhID0gbnVsbDsKICAjc2lnbmF0dXJlVVVJRCA9IG51bGw7CiAgc3RhdGljIF90eXBlID0gInNpZ25hdHVyZSI7CiAgc3RhdGljIF9lZGl0b3JUeXBlID0gQW5ub3RhdGlvbkVkaXRvclR5cGUuU0lHTkFUVVJFOwogIHN0YXRpYyBfZGVmYXVsdERyYXdpbmdPcHRpb25zID0gbnVsbDsKICBjb25zdHJ1Y3RvcihwYXJhbXMpIHsKICAgIHN1cGVyKHsKICAgICAgLi4ucGFyYW1zLAogICAgICBtdXN0QmVDb21taXR0ZWQ6IHRydWUsCiAgICAgIG5hbWU6ICJzaWduYXR1cmVFZGl0b3IiCiAgICB9KTsKICAgIHRoaXMuX3dpbGxLZWVwQXNwZWN0UmF0aW8gPSB0cnVlOwogICAgdGhpcy4jc2lnbmF0dXJlRGF0YSA9IHBhcmFtcy5zaWduYXR1cmVEYXRhIHx8IG51bGw7CiAgICB0aGlzLiNkZXNjcmlwdGlvbiA9IG51bGw7CiAgICB0aGlzLmRlZmF1bHRMMTBuSWQgPSAicGRmanMtZWRpdG9yLXNpZ25hdHVyZS1lZGl0b3IxIjsKICB9CiAgc3RhdGljIGluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKSB7CiAgICBBbm5vdGF0aW9uRWRpdG9yLmluaXRpYWxpemUobDEwbiwgdWlNYW5hZ2VyKTsKICAgIHRoaXMuX2RlZmF1bHREcmF3aW5nT3B0aW9ucyA9IG5ldyBTaWduYXR1cmVPcHRpb25zKCk7CiAgICB0aGlzLl9kZWZhdWx0RHJhd25TaWduYXR1cmVPcHRpb25zID0gbmV3IERyYXduU2lnbmF0dXJlT3B0aW9ucyh1aU1hbmFnZXIudmlld1BhcmFtZXRlcnMpOwogIH0KICBzdGF0aWMgZ2V0RGVmYXVsdERyYXdpbmdPcHRpb25zKG9wdGlvbnMpIHsKICAgIGNvbnN0IGNsb25lID0gdGhpcy5fZGVmYXVsdERyYXdpbmdPcHRpb25zLmNsb25lKCk7CiAgICBjbG9uZS51cGRhdGVQcm9wZXJ0aWVzKG9wdGlvbnMpOwogICAgcmV0dXJuIGNsb25lOwogIH0KICBzdGF0aWMgZ2V0IHN1cHBvcnRNdWx0aXBsZURyYXdpbmdzKCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBzdGF0aWMgZ2V0IHR5cGVzTWFwKCkgewogICAgcmV0dXJuIHNoYWRvdyh0aGlzLCAidHlwZXNNYXAiLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKTsKICB9CiAgc3RhdGljIGdldCBpc0RyYXdlcigpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgZ2V0IHRlbGVtZXRyeUZpbmFsRGF0YSgpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6ICJzaWduYXR1cmUiLAogICAgICBoYXNEZXNjcmlwdGlvbjogISF0aGlzLiNkZXNjcmlwdGlvbgogICAgfTsKICB9CiAgc3RhdGljIGNvbXB1dGVUZWxlbWV0cnlGaW5hbERhdGEoZGF0YSkgewogICAgY29uc3QgaGFzRGVzY3JpcHRpb25TdGF0cyA9IGRhdGEuZ2V0KCJoYXNEZXNjcmlwdGlvbiIpOwogICAgcmV0dXJuIHsKICAgICAgaGFzQWx0VGV4dDogaGFzRGVzY3JpcHRpb25TdGF0cy5nZXQodHJ1ZSkgPz8gMCwKICAgICAgaGFzTm9BbHRUZXh0OiBoYXNEZXNjcmlwdGlvblN0YXRzLmdldChmYWxzZSkgPz8gMAogICAgfTsKICB9CiAgZ2V0IGlzUmVzaXphYmxlKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIG9uU2NhbGVDaGFuZ2luZygpIHsKICAgIGlmICh0aGlzLl9kcmF3SWQgPT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgc3VwZXIub25TY2FsZUNoYW5naW5nKCk7CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLmRpdikgewogICAgICByZXR1cm4gdGhpcy5kaXY7CiAgICB9CiAgICBsZXQgYmFzZVgsIGJhc2VZOwogICAgY29uc3QgewogICAgICBfaXNDb3B5CiAgICB9ID0gdGhpczsKICAgIGlmIChfaXNDb3B5KSB7CiAgICAgIHRoaXMuX2lzQ29weSA9IGZhbHNlOwogICAgICBiYXNlWCA9IHRoaXMueDsKICAgICAgYmFzZVkgPSB0aGlzLnk7CiAgICB9CiAgICBzdXBlci5yZW5kZXIoKTsKICAgIGlmICh0aGlzLl9kcmF3SWQgPT09IG51bGwpIHsKICAgICAgaWYgKHRoaXMuI3NpZ25hdHVyZURhdGEpIHsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBsaW5lcywKICAgICAgICAgIG11c3RTbW9vdGgsCiAgICAgICAgICBhcmVDb250b3VycywKICAgICAgICAgIGRlc2NyaXB0aW9uLAogICAgICAgICAgdXVpZCwKICAgICAgICAgIGhlaWdodEluUGFnZQogICAgICAgIH0gPSB0aGlzLiNzaWduYXR1cmVEYXRhOwogICAgICAgIGNvbnN0IHsKICAgICAgICAgIHJhd0RpbXM6IHsKICAgICAgICAgICAgcGFnZVdpZHRoLAogICAgICAgICAgICBwYWdlSGVpZ2h0CiAgICAgICAgICB9LAogICAgICAgICAgcm90YXRpb24KICAgICAgICB9ID0gdGhpcy5wYXJlbnQudmlld3BvcnQ7CiAgICAgICAgY29uc3Qgb3V0bGluZSA9IFNpZ25hdHVyZUV4dHJhY3Rvci5wcm9jZXNzRHJhd25MaW5lcyh7CiAgICAgICAgICBsaW5lcywKICAgICAgICAgIHBhZ2VXaWR0aCwKICAgICAgICAgIHBhZ2VIZWlnaHQsCiAgICAgICAgICByb3RhdGlvbiwKICAgICAgICAgIGlubmVyTWFyZ2luOiBfU2lnbmF0dXJlRWRpdG9yLl9JTk5FUl9NQVJHSU4sCiAgICAgICAgICBtdXN0U21vb3RoLAogICAgICAgICAgYXJlQ29udG91cnMKICAgICAgICB9KTsKICAgICAgICB0aGlzLmFkZFNpZ25hdHVyZShvdXRsaW5lLCBoZWlnaHRJblBhZ2UsIGRlc2NyaXB0aW9uLCB1dWlkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtbDEwbi1hcmdzIiwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZGVzY3JpcHRpb246ICIiCiAgICAgICAgfSkpOwogICAgICAgIHRoaXMuZGl2LmhpZGRlbiA9IHRydWU7CiAgICAgICAgdGhpcy5fdWlNYW5hZ2VyLmdldFNpZ25hdHVyZSh0aGlzKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5kaXYuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4tYXJncyIsIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBkZXNjcmlwdGlvbjogdGhpcy4jZGVzY3JpcHRpb24gfHwgIiIKICAgICAgfSkpOwogICAgfQogICAgaWYgKF9pc0NvcHkpIHsKICAgICAgdGhpcy5faXNDb3B5ID0gdHJ1ZTsKICAgICAgdGhpcy5fbW92ZUFmdGVyUGFzdGUoYmFzZVgsIGJhc2VZKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmRpdjsKICB9CiAgc2V0VXVpZCh1dWlkKSB7CiAgICB0aGlzLiNzaWduYXR1cmVVVUlEID0gdXVpZDsKICAgIHRoaXMuYWRkRWRpdFRvb2xiYXIoKTsKICB9CiAgZ2V0VXVpZCgpIHsKICAgIHJldHVybiB0aGlzLiNzaWduYXR1cmVVVUlEOwogIH0KICBnZXQgZGVzY3JpcHRpb24oKSB7CiAgICByZXR1cm4gdGhpcy4jZGVzY3JpcHRpb247CiAgfQogIHNldCBkZXNjcmlwdGlvbihkZXNjcmlwdGlvbikgewogICAgdGhpcy4jZGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbjsKICAgIGlmICghdGhpcy5kaXYpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5kaXYuc2V0QXR0cmlidXRlKCJkYXRhLWwxMG4tYXJncyIsIEpTT04uc3RyaW5naWZ5KHsKICAgICAgZGVzY3JpcHRpb24KICAgIH0pKTsKICAgIHN1cGVyLmFkZEVkaXRUb29sYmFyKCkudGhlbigodG9vbGJhcikgPT4gewogICAgICB0b29sYmFyPy51cGRhdGVFZGl0U2lnbmF0dXJlQnV0dG9uKGRlc2NyaXB0aW9uKTsKICAgIH0pOwogIH0KICBnZXRTaWduYXR1cmVQcmV2aWV3KCkgewogICAgY29uc3QgewogICAgICBuZXdDdXJ2ZXMsCiAgICAgIGFyZUNvbnRvdXJzLAogICAgICB0aGlja25lc3MsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzLiNzaWduYXR1cmVEYXRhOwogICAgY29uc3QgbWF4RGltID0gTWF0aC5tYXgod2lkdGgsIGhlaWdodCk7CiAgICBjb25zdCBvdXRsaW5lRGF0YSA9IFNpZ25hdHVyZUV4dHJhY3Rvci5wcm9jZXNzRHJhd25MaW5lcyh7CiAgICAgIGxpbmVzOiB7CiAgICAgICAgY3VydmVzOiBuZXdDdXJ2ZXMubWFwKChwb2ludHMpID0+ICh7CiAgICAgICAgICBwb2ludHMKICAgICAgICB9KSksCiAgICAgICAgdGhpY2tuZXNzLAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9LAogICAgICBwYWdlV2lkdGg6IG1heERpbSwKICAgICAgcGFnZUhlaWdodDogbWF4RGltLAogICAgICByb3RhdGlvbjogMCwKICAgICAgaW5uZXJNYXJnaW46IDAsCiAgICAgIG11c3RTbW9vdGg6IGZhbHNlLAogICAgICBhcmVDb250b3VycwogICAgfSk7CiAgICByZXR1cm4gewogICAgICBhcmVDb250b3VycywKICAgICAgb3V0bGluZTogb3V0bGluZURhdGEub3V0bGluZQogICAgfTsKICB9CiAgZ2V0IHRvb2xiYXJCdXR0b25zKCkgewogICAgaWYgKHRoaXMuX3VpTWFuYWdlci5zaWduYXR1cmVNYW5hZ2VyKSB7CiAgICAgIHJldHVybiBbWyJlZGl0U2lnbmF0dXJlIiwgdGhpcy5fdWlNYW5hZ2VyLnNpZ25hdHVyZU1hbmFnZXJdXTsKICAgIH0KICAgIHJldHVybiBzdXBlci50b29sYmFyQnV0dG9uczsKICB9CiAgYWRkU2lnbmF0dXJlKGRhdGEsIGhlaWdodEluUGFnZSwgZGVzY3JpcHRpb24sIHV1aWQpIHsKICAgIGNvbnN0IHsKICAgICAgeDogc2F2ZWRYLAogICAgICB5OiBzYXZlZFkKICAgIH0gPSB0aGlzOwogICAgY29uc3QgewogICAgICBvdXRsaW5lCiAgICB9ID0gdGhpcy4jc2lnbmF0dXJlRGF0YSA9IGRhdGE7CiAgICB0aGlzLiNpc0V4dHJhY3RlZCA9IG91dGxpbmUgaW5zdGFuY2VvZiBDb250b3VyRHJhd091dGxpbmU7CiAgICB0aGlzLmRlc2NyaXB0aW9uID0gZGVzY3JpcHRpb247CiAgICBsZXQgZHJhd2luZ09wdGlvbnM7CiAgICBpZiAodGhpcy4jaXNFeHRyYWN0ZWQpIHsKICAgICAgZHJhd2luZ09wdGlvbnMgPSBfU2lnbmF0dXJlRWRpdG9yLmdldERlZmF1bHREcmF3aW5nT3B0aW9ucygpOwogICAgfSBlbHNlIHsKICAgICAgZHJhd2luZ09wdGlvbnMgPSBfU2lnbmF0dXJlRWRpdG9yLl9kZWZhdWx0RHJhd25TaWduYXR1cmVPcHRpb25zLmNsb25lKCk7CiAgICAgIGRyYXdpbmdPcHRpb25zLnVwZGF0ZVByb3BlcnRpZXMoewogICAgICAgICJzdHJva2Utd2lkdGgiOiBvdXRsaW5lLnRoaWNrbmVzcwogICAgICB9KTsKICAgIH0KICAgIHRoaXMuX2FkZE91dGxpbmVzKHsKICAgICAgZHJhd091dGxpbmVzOiBvdXRsaW5lLAogICAgICBkcmF3aW5nT3B0aW9ucwogICAgfSk7CiAgICBjb25zdCBbLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFnZURpbWVuc2lvbnM7CiAgICBsZXQgbmV3SGVpZ2h0ID0gaGVpZ2h0SW5QYWdlIC8gcGFnZUhlaWdodDsKICAgIG5ld0hlaWdodCA9IG5ld0hlaWdodCA+PSAxID8gMC41IDogbmV3SGVpZ2h0OwogICAgdGhpcy53aWR0aCAqPSBuZXdIZWlnaHQgLyB0aGlzLmhlaWdodDsKICAgIGlmICh0aGlzLndpZHRoID49IDEpIHsKICAgICAgbmV3SGVpZ2h0ICo9IDAuOSAvIHRoaXMud2lkdGg7CiAgICAgIHRoaXMud2lkdGggPSAwLjk7CiAgICB9CiAgICB0aGlzLmhlaWdodCA9IG5ld0hlaWdodDsKICAgIHRoaXMuc2V0RGltcygpOwogICAgdGhpcy54ID0gc2F2ZWRYOwogICAgdGhpcy55ID0gc2F2ZWRZOwogICAgdGhpcy5jZW50ZXIoKTsKICAgIHRoaXMuX29uUmVzaXplZCgpOwogICAgdGhpcy5vblNjYWxlQ2hhbmdpbmcoKTsKICAgIHRoaXMucm90YXRlKCk7CiAgICB0aGlzLl91aU1hbmFnZXIuYWRkVG9Bbm5vdGF0aW9uU3RvcmFnZSh0aGlzKTsKICAgIHRoaXMuc2V0VXVpZCh1dWlkKTsKICAgIHRoaXMuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgIGFjdGlvbjogInBkZmpzLnNpZ25hdHVyZS5pbnNlcnRlZCIsCiAgICAgIGRhdGE6IHsKICAgICAgICBoYXNCZWVuU2F2ZWQ6ICEhdXVpZCwKICAgICAgICBoYXNEZXNjcmlwdGlvbjogISFkZXNjcmlwdGlvbgogICAgICB9CiAgICB9KTsKICAgIHRoaXMuZGl2LmhpZGRlbiA9IGZhbHNlOwogIH0KICBnZXRGcm9tSW1hZ2UoYml0bWFwKSB7CiAgICBjb25zdCB7CiAgICAgIHJhd0RpbXM6IHsKICAgICAgICBwYWdlV2lkdGgsCiAgICAgICAgcGFnZUhlaWdodAogICAgICB9LAogICAgICByb3RhdGlvbgogICAgfSA9IHRoaXMucGFyZW50LnZpZXdwb3J0OwogICAgcmV0dXJuIFNpZ25hdHVyZUV4dHJhY3Rvci5wcm9jZXNzKGJpdG1hcCwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0LCByb3RhdGlvbiwgX1NpZ25hdHVyZUVkaXRvci5fSU5ORVJfTUFSR0lOKTsKICB9CiAgZ2V0RnJvbVRleHQodGV4dCwgZm9udEluZm8pIHsKICAgIGNvbnN0IHsKICAgICAgcmF3RGltczogewogICAgICAgIHBhZ2VXaWR0aCwKICAgICAgICBwYWdlSGVpZ2h0CiAgICAgIH0sCiAgICAgIHJvdGF0aW9uCiAgICB9ID0gdGhpcy5wYXJlbnQudmlld3BvcnQ7CiAgICByZXR1cm4gU2lnbmF0dXJlRXh0cmFjdG9yLmV4dHJhY3RDb250b3Vyc0Zyb21UZXh0KHRleHQsIGZvbnRJbmZvLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQsIHJvdGF0aW9uLCBfU2lnbmF0dXJlRWRpdG9yLl9JTk5FUl9NQVJHSU4pOwogIH0KICBnZXREcmF3blNpZ25hdHVyZShjdXJ2ZXMpIHsKICAgIGNvbnN0IHsKICAgICAgcmF3RGltczogewogICAgICAgIHBhZ2VXaWR0aCwKICAgICAgICBwYWdlSGVpZ2h0CiAgICAgIH0sCiAgICAgIHJvdGF0aW9uCiAgICB9ID0gdGhpcy5wYXJlbnQudmlld3BvcnQ7CiAgICByZXR1cm4gU2lnbmF0dXJlRXh0cmFjdG9yLnByb2Nlc3NEcmF3bkxpbmVzKHsKICAgICAgbGluZXM6IGN1cnZlcywKICAgICAgcGFnZVdpZHRoLAogICAgICBwYWdlSGVpZ2h0LAogICAgICByb3RhdGlvbiwKICAgICAgaW5uZXJNYXJnaW46IF9TaWduYXR1cmVFZGl0b3IuX0lOTkVSX01BUkdJTiwKICAgICAgbXVzdFNtb290aDogZmFsc2UsCiAgICAgIGFyZUNvbnRvdXJzOiBmYWxzZQogICAgfSk7CiAgfQogIGNyZWF0ZURyYXdpbmdPcHRpb25zKHsKICAgIGFyZUNvbnRvdXJzLAogICAgdGhpY2tuZXNzCiAgfSkgewogICAgaWYgKGFyZUNvbnRvdXJzKSB7CiAgICAgIHRoaXMuX2RyYXdpbmdPcHRpb25zID0gX1NpZ25hdHVyZUVkaXRvci5nZXREZWZhdWx0RHJhd2luZ09wdGlvbnMoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2RyYXdpbmdPcHRpb25zID0gX1NpZ25hdHVyZUVkaXRvci5fZGVmYXVsdERyYXduU2lnbmF0dXJlT3B0aW9ucy5jbG9uZSgpOwogICAgICB0aGlzLl9kcmF3aW5nT3B0aW9ucy51cGRhdGVQcm9wZXJ0aWVzKHsKICAgICAgICAic3Ryb2tlLXdpZHRoIjogdGhpY2tuZXNzCiAgICAgIH0pOwogICAgfQogIH0KICBzZXJpYWxpemUoaXNGb3JDb3B5aW5nID0gZmFsc2UpIHsKICAgIGlmICh0aGlzLmlzRW1wdHkoKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgbGluZXMsCiAgICAgIHBvaW50cwogICAgfSA9IHRoaXMuc2VyaWFsaXplRHJhdyhpc0ZvckNvcHlpbmcpOwogICAgY29uc3QgewogICAgICBfZHJhd2luZ09wdGlvbnM6IHsKICAgICAgICAic3Ryb2tlLXdpZHRoIjogdGhpY2tuZXNzCiAgICAgIH0KICAgIH0gPSB0aGlzOwogICAgY29uc3Qgc2VyaWFsaXplZCA9IE9iamVjdC5hc3NpZ24oc3VwZXIuc2VyaWFsaXplKGlzRm9yQ29weWluZyksIHsKICAgICAgaXNTaWduYXR1cmU6IHRydWUsCiAgICAgIGFyZUNvbnRvdXJzOiB0aGlzLiNpc0V4dHJhY3RlZCwKICAgICAgY29sb3I6IFswLCAwLCAwXSwKICAgICAgdGhpY2tuZXNzOiB0aGlzLiNpc0V4dHJhY3RlZCA/IDAgOiB0aGlja25lc3MKICAgIH0pOwogICAgdGhpcy5hZGRDb21tZW50KHNlcmlhbGl6ZWQpOwogICAgaWYgKGlzRm9yQ29weWluZykgewogICAgICBzZXJpYWxpemVkLnBhdGhzID0gewogICAgICAgIGxpbmVzLAogICAgICAgIHBvaW50cwogICAgICB9OwogICAgICBzZXJpYWxpemVkLnV1aWQgPSB0aGlzLiNzaWduYXR1cmVVVUlEOwogICAgICBzZXJpYWxpemVkLmlzQ29weSA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICBzZXJpYWxpemVkLmxpbmVzID0gbGluZXM7CiAgICB9CiAgICBpZiAodGhpcy4jZGVzY3JpcHRpb24pIHsKICAgICAgc2VyaWFsaXplZC5hY2Nlc3NpYmlsaXR5RGF0YSA9IHsKICAgICAgICB0eXBlOiAiRmlndXJlIiwKICAgICAgICBhbHQ6IHRoaXMuI2Rlc2NyaXB0aW9uCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gc2VyaWFsaXplZDsKICB9CiAgc3RhdGljIGRlc2VyaWFsaXplRHJhdyhwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgaW5uZXJNYXJnaW4sIGRhdGEpIHsKICAgIGlmIChkYXRhLmFyZUNvbnRvdXJzKSB7CiAgICAgIHJldHVybiBDb250b3VyRHJhd091dGxpbmUuZGVzZXJpYWxpemUocGFnZVgsIHBhZ2VZLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQsIGlubmVyTWFyZ2luLCBkYXRhKTsKICAgIH0KICAgIHJldHVybiBJbmtEcmF3T3V0bGluZS5kZXNlcmlhbGl6ZShwYWdlWCwgcGFnZVksIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCwgaW5uZXJNYXJnaW4sIGRhdGEpOwogIH0KICBzdGF0aWMgYXN5bmMgZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpIHsKICAgIGNvbnN0IGVkaXRvciA9IGF3YWl0IHN1cGVyLmRlc2VyaWFsaXplKGRhdGEsIHBhcmVudCwgdWlNYW5hZ2VyKTsKICAgIGVkaXRvci4jaXNFeHRyYWN0ZWQgPSBkYXRhLmFyZUNvbnRvdXJzOwogICAgZWRpdG9yLmRlc2NyaXB0aW9uID0gZGF0YS5hY2Nlc3NpYmlsaXR5RGF0YT8uYWx0IHx8ICIiOwogICAgZWRpdG9yLiNzaWduYXR1cmVVVUlEID0gZGF0YS51dWlkOwogICAgcmV0dXJuIGVkaXRvcjsKICB9Cn07CnZhciBTdGFtcEVkaXRvciA9IGNsYXNzIGV4dGVuZHMgQW5ub3RhdGlvbkVkaXRvciB7CiAgI2JpdG1hcCA9IG51bGw7CiAgI2JpdG1hcElkID0gbnVsbDsKICAjYml0bWFwUHJvbWlzZSA9IG51bGw7CiAgI2JpdG1hcFVybCA9IG51bGw7CiAgI2JpdG1hcEZpbGUgPSBudWxsOwogICNiaXRtYXBGaWxlTmFtZSA9ICIiOwogICNjYW52YXMgPSBudWxsOwogICNtaXNzaW5nQ2FudmFzID0gZmFsc2U7CiAgI3Jlc2l6ZVRpbWVvdXRJZCA9IG51bGw7CiAgI2lzU3ZnID0gZmFsc2U7CiAgI2hhc0JlZW5BZGRlZEluVW5kb1N0YWNrID0gZmFsc2U7CiAgc3RhdGljIF90eXBlID0gInN0YW1wIjsKICBzdGF0aWMgX2VkaXRvclR5cGUgPSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5TVEFNUDsKICBjb25zdHJ1Y3RvcihwYXJhbXMpIHsKICAgIHN1cGVyKHsKICAgICAgLi4ucGFyYW1zLAogICAgICBuYW1lOiAic3RhbXBFZGl0b3IiCiAgICB9KTsKICAgIHRoaXMuI2JpdG1hcFVybCA9IHBhcmFtcy5iaXRtYXBVcmw7CiAgICB0aGlzLiNiaXRtYXBGaWxlID0gcGFyYW1zLmJpdG1hcEZpbGU7CiAgICB0aGlzLmRlZmF1bHRMMTBuSWQgPSAicGRmanMtZWRpdG9yLXN0YW1wLWVkaXRvciI7CiAgfQogIHN0YXRpYyBpbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcikgewogICAgQW5ub3RhdGlvbkVkaXRvci5pbml0aWFsaXplKGwxMG4sIHVpTWFuYWdlcik7CiAgfQogIHN0YXRpYyBpc0hhbmRsaW5nTWltZUZvclBhc3RpbmcobWltZSkgewogICAgcmV0dXJuIFN1cHBvcnRlZEltYWdlTWltZVR5cGVzLmluY2x1ZGVzKG1pbWUpOwogIH0KICBzdGF0aWMgcGFzdGUoaXRlbSwgcGFyZW50KSB7CiAgICBwYXJlbnQucGFzdGVFZGl0b3IoewogICAgICBtb2RlOiBBbm5vdGF0aW9uRWRpdG9yVHlwZS5TVEFNUAogICAgfSwgewogICAgICBiaXRtYXBGaWxlOiBpdGVtLmdldEFzRmlsZSgpCiAgICB9KTsKICB9CiAgYWx0VGV4dEZpbmlzaCgpIHsKICAgIGlmICh0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dEZsb3cpIHsKICAgICAgdGhpcy5kaXYuaGlkZGVuID0gZmFsc2U7CiAgICB9CiAgICBzdXBlci5hbHRUZXh0RmluaXNoKCk7CiAgfQogIGdldCB0ZWxlbWV0cnlGaW5hbERhdGEoKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAic3RhbXAiLAogICAgICBoYXNBbHRUZXh0OiAhIXRoaXMuYWx0VGV4dERhdGE/LmFsdFRleHQKICAgIH07CiAgfQogIHN0YXRpYyBjb21wdXRlVGVsZW1ldHJ5RmluYWxEYXRhKGRhdGEpIHsKICAgIGNvbnN0IGhhc0FsdFRleHRTdGF0cyA9IGRhdGEuZ2V0KCJoYXNBbHRUZXh0Iik7CiAgICByZXR1cm4gewogICAgICBoYXNBbHRUZXh0OiBoYXNBbHRUZXh0U3RhdHMuZ2V0KHRydWUpID8/IDAsCiAgICAgIGhhc05vQWx0VGV4dDogaGFzQWx0VGV4dFN0YXRzLmdldChmYWxzZSkgPz8gMAogICAgfTsKICB9CiAgI2dldEJpdG1hcEZldGNoZWQoZGF0YSwgZnJvbUlkID0gZmFsc2UpIHsKICAgIGlmICghZGF0YSkgewogICAgICB0aGlzLnJlbW92ZSgpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNiaXRtYXAgPSBkYXRhLmJpdG1hcDsKICAgIGlmICghZnJvbUlkKSB7CiAgICAgIHRoaXMuI2JpdG1hcElkID0gZGF0YS5pZDsKICAgICAgdGhpcy4jaXNTdmcgPSBkYXRhLmlzU3ZnOwogICAgfQogICAgaWYgKGRhdGEuZmlsZSkgewogICAgICB0aGlzLiNiaXRtYXBGaWxlTmFtZSA9IGRhdGEuZmlsZS5uYW1lOwogICAgfQogICAgdGhpcy4jY3JlYXRlQ2FudmFzKCk7CiAgfQogICNnZXRCaXRtYXBEb25lKCkgewogICAgdGhpcy4jYml0bWFwUHJvbWlzZSA9IG51bGw7CiAgICB0aGlzLl91aU1hbmFnZXIuZW5hYmxlV2FpdGluZyhmYWxzZSk7CiAgICBpZiAoIXRoaXMuI2NhbnZhcykgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5fdWlNYW5hZ2VyLnVzZU5ld0FsdFRleHRXaGVuQWRkaW5nSW1hZ2UgJiYgdGhpcy5fdWlNYW5hZ2VyLnVzZU5ld0FsdFRleHRGbG93ICYmIHRoaXMuI2JpdG1hcCkgewogICAgICB0aGlzLmFkZEVkaXRUb29sYmFyKCkudGhlbigoKSA9PiB7CiAgICAgICAgdGhpcy5fZWRpdFRvb2xiYXIuaGlkZSgpOwogICAgICAgIHRoaXMuX3VpTWFuYWdlci5lZGl0QWx0VGV4dCh0aGlzLCB0cnVlKTsKICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICghdGhpcy5fdWlNYW5hZ2VyLnVzZU5ld0FsdFRleHRXaGVuQWRkaW5nSW1hZ2UgJiYgdGhpcy5fdWlNYW5hZ2VyLnVzZU5ld0FsdFRleHRGbG93ICYmIHRoaXMuI2JpdG1hcCkgewogICAgICB0aGlzLl9yZXBvcnRUZWxlbWV0cnkoewogICAgICAgIGFjdGlvbjogInBkZmpzLmltYWdlLmltYWdlX2FkZGVkIiwKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBhbHRfdGV4dF9tb2RhbDogZmFsc2UsCiAgICAgICAgICBhbHRfdGV4dF90eXBlOiAiZW1wdHkiCiAgICAgICAgfQogICAgICB9KTsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLm1sR3Vlc3NBbHRUZXh0KCk7CiAgICAgIH0gY2F0Y2ggewogICAgICB9CiAgICB9CiAgICB0aGlzLmRpdi5mb2N1cygpOwogIH0KICBhc3luYyBtbEd1ZXNzQWx0VGV4dChpbWFnZURhdGEgPSBudWxsLCB1cGRhdGVBbHRUZXh0RGF0YSA9IHRydWUpIHsKICAgIGlmICh0aGlzLmhhc0FsdFRleHREYXRhKCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIG1sTWFuYWdlcgogICAgfSA9IHRoaXMuX3VpTWFuYWdlcjsKICAgIGlmICghbWxNYW5hZ2VyKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gTUwuIik7CiAgICB9CiAgICBpZiAoIWF3YWl0IG1sTWFuYWdlci5pc0VuYWJsZWRGb3IoImFsdFRleHQiKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIk1MIGlzbid0IGVuYWJsZWQgZm9yIGFsdCB0ZXh0LiIpOwogICAgfQogICAgY29uc3QgewogICAgICBkYXRhLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9ID0gaW1hZ2VEYXRhIHx8IHRoaXMuY29weUNhbnZhcyhudWxsLCBudWxsLCB0cnVlKS5pbWFnZURhdGE7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IG1sTWFuYWdlci5ndWVzcyh7CiAgICAgIG5hbWU6ICJhbHRUZXh0IiwKICAgICAgcmVxdWVzdDogewogICAgICAgIGRhdGEsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIGNoYW5uZWxzOiBkYXRhLmxlbmd0aCAvICh3aWR0aCAqIGhlaWdodCkKICAgICAgfQogICAgfSk7CiAgICBpZiAoIXJlc3BvbnNlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gcmVzcG9uc2UgZnJvbSB0aGUgQUkgc2VydmljZS4iKTsKICAgIH0KICAgIGlmIChyZXNwb25zZS5lcnJvcikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkVycm9yIGZyb20gdGhlIEFJIHNlcnZpY2UuIik7CiAgICB9CiAgICBpZiAocmVzcG9uc2UuY2FuY2VsKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKCFyZXNwb25zZS5vdXRwdXQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyB2YWxpZCByZXNwb25zZSBmcm9tIHRoZSBBSSBzZXJ2aWNlLiIpOwogICAgfQogICAgY29uc3QgYWx0VGV4dCA9IHJlc3BvbnNlLm91dHB1dDsKICAgIGF3YWl0IHRoaXMuc2V0R3Vlc3NlZEFsdFRleHQoYWx0VGV4dCk7CiAgICBpZiAodXBkYXRlQWx0VGV4dERhdGEgJiYgIXRoaXMuaGFzQWx0VGV4dERhdGEoKSkgewogICAgICB0aGlzLmFsdFRleHREYXRhID0gewogICAgICAgIGFsdDogYWx0VGV4dCwKICAgICAgICBkZWNvcmF0aXZlOiBmYWxzZQogICAgICB9OwogICAgfQogICAgcmV0dXJuIGFsdFRleHQ7CiAgfQogICNnZXRCaXRtYXAoKSB7CiAgICBpZiAodGhpcy4jYml0bWFwSWQpIHsKICAgICAgdGhpcy5fdWlNYW5hZ2VyLmVuYWJsZVdhaXRpbmcodHJ1ZSk7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5pbWFnZU1hbmFnZXIuZ2V0RnJvbUlkKHRoaXMuI2JpdG1hcElkKS50aGVuKChkYXRhKSA9PiB0aGlzLiNnZXRCaXRtYXBGZXRjaGVkKGRhdGEsIHRydWUpKS5maW5hbGx5KCgpID0+IHRoaXMuI2dldEJpdG1hcERvbmUoKSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiNiaXRtYXBVcmwpIHsKICAgICAgY29uc3QgdXJsID0gdGhpcy4jYml0bWFwVXJsOwogICAgICB0aGlzLiNiaXRtYXBVcmwgPSBudWxsOwogICAgICB0aGlzLl91aU1hbmFnZXIuZW5hYmxlV2FpdGluZyh0cnVlKTsKICAgICAgdGhpcy4jYml0bWFwUHJvbWlzZSA9IHRoaXMuX3VpTWFuYWdlci5pbWFnZU1hbmFnZXIuZ2V0RnJvbVVybCh1cmwpLnRoZW4oKGRhdGEpID0+IHRoaXMuI2dldEJpdG1hcEZldGNoZWQoZGF0YSkpLmZpbmFsbHkoKCkgPT4gdGhpcy4jZ2V0Qml0bWFwRG9uZSgpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI2JpdG1hcEZpbGUpIHsKICAgICAgY29uc3QgZmlsZSA9IHRoaXMuI2JpdG1hcEZpbGU7CiAgICAgIHRoaXMuI2JpdG1hcEZpbGUgPSBudWxsOwogICAgICB0aGlzLl91aU1hbmFnZXIuZW5hYmxlV2FpdGluZyh0cnVlKTsKICAgICAgdGhpcy4jYml0bWFwUHJvbWlzZSA9IHRoaXMuX3VpTWFuYWdlci5pbWFnZU1hbmFnZXIuZ2V0RnJvbUZpbGUoZmlsZSkudGhlbigoZGF0YSkgPT4gdGhpcy4jZ2V0Qml0bWFwRmV0Y2hlZChkYXRhKSkuZmluYWxseSgoKSA9PiB0aGlzLiNnZXRCaXRtYXBEb25lKCkpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICBpbnB1dC50eXBlID0gImZpbGUiOwogICAgaW5wdXQuYWNjZXB0ID0gU3VwcG9ydGVkSW1hZ2VNaW1lVHlwZXMuam9pbigiLCIpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy5fdWlNYW5hZ2VyLl9zaWduYWw7CiAgICB0aGlzLiNiaXRtYXBQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgYXN5bmMgKCkgPT4gewogICAgICAgIGlmICghaW5wdXQuZmlsZXMgfHwgaW5wdXQuZmlsZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl91aU1hbmFnZXIuZW5hYmxlV2FpdGluZyh0cnVlKTsKICAgICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLl91aU1hbmFnZXIuaW1hZ2VNYW5hZ2VyLmdldEZyb21GaWxlKGlucHV0LmZpbGVzWzBdKTsKICAgICAgICAgIHRoaXMuX3JlcG9ydFRlbGVtZXRyeSh7CiAgICAgICAgICAgIGFjdGlvbjogInBkZmpzLmltYWdlLmltYWdlX3NlbGVjdGVkIiwKICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgIGFsdF90ZXh0X21vZGFsOiB0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dEZsb3cKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLiNnZXRCaXRtYXBGZXRjaGVkKGRhdGEpOwogICAgICAgIH0KICAgICAgICByZXNvbHZlKCk7CiAgICAgIH0sIHsKICAgICAgICBzaWduYWwKICAgICAgfSk7CiAgICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoImNhbmNlbCIsICgpID0+IHsKICAgICAgICB0aGlzLnJlbW92ZSgpOwogICAgICAgIHJlc29sdmUoKTsKICAgICAgfSwgewogICAgICAgIHNpZ25hbAogICAgICB9KTsKICAgIH0pLmZpbmFsbHkoKCkgPT4gdGhpcy4jZ2V0Qml0bWFwRG9uZSgpKTsKICAgIGlucHV0LmNsaWNrKCk7CiAgfQogIHJlbW92ZSgpIHsKICAgIGlmICh0aGlzLiNiaXRtYXBJZCkgewogICAgICB0aGlzLiNiaXRtYXAgPSBudWxsOwogICAgICB0aGlzLl91aU1hbmFnZXIuaW1hZ2VNYW5hZ2VyLmRlbGV0ZUlkKHRoaXMuI2JpdG1hcElkKTsKICAgICAgdGhpcy4jY2FudmFzPy5yZW1vdmUoKTsKICAgICAgdGhpcy4jY2FudmFzID0gbnVsbDsKICAgICAgaWYgKHRoaXMuI3Jlc2l6ZVRpbWVvdXRJZCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLiNyZXNpemVUaW1lb3V0SWQpOwogICAgICAgIHRoaXMuI3Jlc2l6ZVRpbWVvdXRJZCA9IG51bGw7CiAgICAgIH0KICAgIH0KICAgIHN1cGVyLnJlbW92ZSgpOwogIH0KICByZWJ1aWxkKCkgewogICAgaWYgKCF0aGlzLnBhcmVudCkgewogICAgICBpZiAodGhpcy4jYml0bWFwSWQpIHsKICAgICAgICB0aGlzLiNnZXRCaXRtYXAoKTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBzdXBlci5yZWJ1aWxkKCk7CiAgICBpZiAodGhpcy5kaXYgPT09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI2JpdG1hcElkICYmIHRoaXMuI2NhbnZhcyA9PT0gbnVsbCkgewogICAgICB0aGlzLiNnZXRCaXRtYXAoKTsKICAgIH0KICAgIGlmICghdGhpcy5pc0F0dGFjaGVkVG9ET00pIHsKICAgICAgdGhpcy5wYXJlbnQuYWRkKHRoaXMpOwogICAgfQogIH0KICBvbmNlQWRkZWQoZm9jdXMpIHsKICAgIHRoaXMuX2lzRHJhZ2dhYmxlID0gdHJ1ZTsKICAgIGlmIChmb2N1cykgewogICAgICB0aGlzLmRpdi5mb2N1cygpOwogICAgfQogIH0KICBpc0VtcHR5KCkgewogICAgcmV0dXJuICEodGhpcy4jYml0bWFwUHJvbWlzZSB8fCB0aGlzLiNiaXRtYXAgfHwgdGhpcy4jYml0bWFwVXJsIHx8IHRoaXMuI2JpdG1hcEZpbGUgfHwgdGhpcy4jYml0bWFwSWQgfHwgdGhpcy4jbWlzc2luZ0NhbnZhcyk7CiAgfQogIGdldCB0b29sYmFyQnV0dG9ucygpIHsKICAgIHJldHVybiBbWyJhbHRUZXh0IiwgdGhpcy5jcmVhdGVBbHRUZXh0KCldXTsKICB9CiAgZ2V0IGlzUmVzaXphYmxlKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLmRpdikgewogICAgICByZXR1cm4gdGhpcy5kaXY7CiAgICB9CiAgICBsZXQgYmFzZVgsIGJhc2VZOwogICAgaWYgKHRoaXMuX2lzQ29weSkgewogICAgICBiYXNlWCA9IHRoaXMueDsKICAgICAgYmFzZVkgPSB0aGlzLnk7CiAgICB9CiAgICBzdXBlci5yZW5kZXIoKTsKICAgIHRoaXMuZGl2LmhpZGRlbiA9IHRydWU7CiAgICB0aGlzLmNyZWF0ZUFsdFRleHQoKTsKICAgIGlmICghdGhpcy4jbWlzc2luZ0NhbnZhcykgewogICAgICBpZiAodGhpcy4jYml0bWFwKSB7CiAgICAgICAgdGhpcy4jY3JlYXRlQ2FudmFzKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4jZ2V0Qml0bWFwKCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLl9pc0NvcHkpIHsKICAgICAgdGhpcy5fbW92ZUFmdGVyUGFzdGUoYmFzZVgsIGJhc2VZKTsKICAgIH0KICAgIHRoaXMuX3VpTWFuYWdlci5hZGRTaG91bGRSZXNjYWxlKHRoaXMpOwogICAgcmV0dXJuIHRoaXMuZGl2OwogIH0KICBzZXRDYW52YXMoYW5ub3RhdGlvbkVsZW1lbnRJZCwgY2FudmFzKSB7CiAgICBjb25zdCB7CiAgICAgIGlkOiBiaXRtYXBJZCwKICAgICAgYml0bWFwCiAgICB9ID0gdGhpcy5fdWlNYW5hZ2VyLmltYWdlTWFuYWdlci5nZXRGcm9tQ2FudmFzKGFubm90YXRpb25FbGVtZW50SWQsIGNhbnZhcyk7CiAgICBjYW52YXMucmVtb3ZlKCk7CiAgICBpZiAoYml0bWFwSWQgJiYgdGhpcy5fdWlNYW5hZ2VyLmltYWdlTWFuYWdlci5pc1ZhbGlkSWQoYml0bWFwSWQpKSB7CiAgICAgIHRoaXMuI2JpdG1hcElkID0gYml0bWFwSWQ7CiAgICAgIGlmIChiaXRtYXApIHsKICAgICAgICB0aGlzLiNiaXRtYXAgPSBiaXRtYXA7CiAgICAgIH0KICAgICAgdGhpcy4jbWlzc2luZ0NhbnZhcyA9IGZhbHNlOwogICAgICB0aGlzLiNjcmVhdGVDYW52YXMoKTsKICAgIH0KICB9CiAgX29uUmVzaXplZCgpIHsKICAgIHRoaXMub25TY2FsZUNoYW5naW5nKCk7CiAgfQogIG9uU2NhbGVDaGFuZ2luZygpIHsKICAgIGlmICghdGhpcy5wYXJlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMuI3Jlc2l6ZVRpbWVvdXRJZCAhPT0gbnVsbCkgewogICAgICBjbGVhclRpbWVvdXQodGhpcy4jcmVzaXplVGltZW91dElkKTsKICAgIH0KICAgIGNvbnN0IFRJTUVfVE9fV0FJVCA9IDIwMDsKICAgIHRoaXMuI3Jlc2l6ZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aGlzLiNyZXNpemVUaW1lb3V0SWQgPSBudWxsOwogICAgICB0aGlzLiNkcmF3Qml0bWFwKCk7CiAgICB9LCBUSU1FX1RPX1dBSVQpOwogIH0KICAjY3JlYXRlQ2FudmFzKCkgewogICAgY29uc3QgewogICAgICBkaXYKICAgIH0gPSB0aGlzOwogICAgbGV0IHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXMuI2JpdG1hcDsKICAgIGNvbnN0IFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdID0gdGhpcy5wYWdlRGltZW5zaW9uczsKICAgIGNvbnN0IE1BWF9SQVRJTyA9IDAuNzU7CiAgICBpZiAodGhpcy53aWR0aCkgewogICAgICB3aWR0aCA9IHRoaXMud2lkdGggKiBwYWdlV2lkdGg7CiAgICAgIGhlaWdodCA9IHRoaXMuaGVpZ2h0ICogcGFnZUhlaWdodDsKICAgIH0gZWxzZSBpZiAod2lkdGggPiBNQVhfUkFUSU8gKiBwYWdlV2lkdGggfHwgaGVpZ2h0ID4gTUFYX1JBVElPICogcGFnZUhlaWdodCkgewogICAgICBjb25zdCBmYWN0b3IgPSBNYXRoLm1pbihNQVhfUkFUSU8gKiBwYWdlV2lkdGggLyB3aWR0aCwgTUFYX1JBVElPICogcGFnZUhlaWdodCAvIGhlaWdodCk7CiAgICAgIHdpZHRoICo9IGZhY3RvcjsKICAgICAgaGVpZ2h0ICo9IGZhY3RvcjsKICAgIH0KICAgIHRoaXMuX3VpTWFuYWdlci5lbmFibGVXYWl0aW5nKGZhbHNlKTsKICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuI2NhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpOwogICAgY2FudmFzLnNldEF0dHJpYnV0ZSgicm9sZSIsICJpbWciKTsKICAgIHRoaXMuYWRkQ29udGFpbmVyKGNhbnZhcyk7CiAgICB0aGlzLndpZHRoID0gd2lkdGggLyBwYWdlV2lkdGg7CiAgICB0aGlzLmhlaWdodCA9IGhlaWdodCAvIHBhZ2VIZWlnaHQ7CiAgICB0aGlzLnNldERpbXMoKTsKICAgIGlmICh0aGlzLl9pbml0aWFsT3B0aW9ucz8uaXNDZW50ZXJlZCkgewogICAgICB0aGlzLmNlbnRlcigpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5maXhBbmRTZXRQb3NpdGlvbigpOwogICAgfQogICAgdGhpcy5faW5pdGlhbE9wdGlvbnMgPSBudWxsOwogICAgaWYgKCF0aGlzLl91aU1hbmFnZXIudXNlTmV3QWx0VGV4dFdoZW5BZGRpbmdJbWFnZSB8fCAhdGhpcy5fdWlNYW5hZ2VyLnVzZU5ld0FsdFRleHRGbG93IHx8IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICBkaXYuaGlkZGVuID0gZmFsc2U7CiAgICB9CiAgICB0aGlzLiNkcmF3Qml0bWFwKCk7CiAgICBpZiAoIXRoaXMuI2hhc0JlZW5BZGRlZEluVW5kb1N0YWNrKSB7CiAgICAgIHRoaXMucGFyZW50LmFkZFVuZG9hYmxlRWRpdG9yKHRoaXMpOwogICAgICB0aGlzLiNoYXNCZWVuQWRkZWRJblVuZG9TdGFjayA9IHRydWU7CiAgICB9CiAgICB0aGlzLl9yZXBvcnRUZWxlbWV0cnkoewogICAgICBhY3Rpb246ICJpbnNlcnRlZF9pbWFnZSIKICAgIH0pOwogICAgaWYgKHRoaXMuI2JpdG1hcEZpbGVOYW1lKSB7CiAgICAgIHRoaXMuZGl2LnNldEF0dHJpYnV0ZSgiYXJpYS1kZXNjcmlwdGlvbiIsIHRoaXMuI2JpdG1hcEZpbGVOYW1lKTsKICAgIH0KICAgIGlmICghdGhpcy5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgIHRoaXMuX3VpTWFuYWdlci5hMTF5QWxlcnQoInBkZmpzLWVkaXRvci1zdGFtcC1hZGRlZC1hbGVydCIpOwogICAgfQogIH0KICBjb3B5Q2FudmFzKG1heERhdGFEaW1lbnNpb24sIG1heFByZXZpZXdEaW1lbnNpb24sIGNyZWF0ZUltYWdlRGF0YSA9IGZhbHNlKSB7CiAgICBpZiAoIW1heERhdGFEaW1lbnNpb24pIHsKICAgICAgbWF4RGF0YURpbWVuc2lvbiA9IDIyNDsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgd2lkdGg6IGJpdG1hcFdpZHRoLAogICAgICBoZWlnaHQ6IGJpdG1hcEhlaWdodAogICAgfSA9IHRoaXMuI2JpdG1hcDsKICAgIGNvbnN0IG91dHB1dFNjYWxlID0gbmV3IE91dHB1dFNjYWxlKCk7CiAgICBsZXQgYml0bWFwID0gdGhpcy4jYml0bWFwOwogICAgbGV0IHdpZHRoID0gYml0bWFwV2lkdGgsIGhlaWdodCA9IGJpdG1hcEhlaWdodDsKICAgIGxldCBjYW52YXMgPSBudWxsOwogICAgaWYgKG1heFByZXZpZXdEaW1lbnNpb24pIHsKICAgICAgaWYgKGJpdG1hcFdpZHRoID4gbWF4UHJldmlld0RpbWVuc2lvbiB8fCBiaXRtYXBIZWlnaHQgPiBtYXhQcmV2aWV3RGltZW5zaW9uKSB7CiAgICAgICAgY29uc3QgcmF0aW8gPSBNYXRoLm1pbihtYXhQcmV2aWV3RGltZW5zaW9uIC8gYml0bWFwV2lkdGgsIG1heFByZXZpZXdEaW1lbnNpb24gLyBiaXRtYXBIZWlnaHQpOwogICAgICAgIHdpZHRoID0gTWF0aC5mbG9vcihiaXRtYXBXaWR0aCAqIHJhdGlvKTsKICAgICAgICBoZWlnaHQgPSBNYXRoLmZsb29yKGJpdG1hcEhlaWdodCAqIHJhdGlvKTsKICAgICAgfQogICAgICBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgY29uc3Qgc2NhbGVkV2lkdGggPSBjYW52YXMud2lkdGggPSBNYXRoLmNlaWwod2lkdGggKiBvdXRwdXRTY2FsZS5zeCk7CiAgICAgIGNvbnN0IHNjYWxlZEhlaWdodCA9IGNhbnZhcy5oZWlnaHQgPSBNYXRoLmNlaWwoaGVpZ2h0ICogb3V0cHV0U2NhbGUuc3kpOwogICAgICBpZiAoIXRoaXMuI2lzU3ZnKSB7CiAgICAgICAgYml0bWFwID0gdGhpcy4jc2NhbGVCaXRtYXAoc2NhbGVkV2lkdGgsIHNjYWxlZEhlaWdodCk7CiAgICAgIH0KICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgIGN0eC5maWx0ZXIgPSB0aGlzLl91aU1hbmFnZXIuaGNtRmlsdGVyOwogICAgICBsZXQgd2hpdGUgPSAid2hpdGUiLCBibGFjayA9ICIjY2ZjZmQ4IjsKICAgICAgaWYgKHRoaXMuX3VpTWFuYWdlci5oY21GaWx0ZXIgIT09ICJub25lIikgewogICAgICAgIGJsYWNrID0gImJsYWNrIjsKICAgICAgfSBlbHNlIGlmIChDb2xvclNjaGVtZS5pc0RhcmtNb2RlKSB7CiAgICAgICAgd2hpdGUgPSAiIzhmOGY5ZCI7CiAgICAgICAgYmxhY2sgPSAiIzQyNDE0ZCI7CiAgICAgIH0KICAgICAgY29uc3QgYm94RGltID0gMTU7CiAgICAgIGNvbnN0IGJveERpbVdpZHRoID0gYm94RGltICogb3V0cHV0U2NhbGUuc3g7CiAgICAgIGNvbnN0IGJveERpbUhlaWdodCA9IGJveERpbSAqIG91dHB1dFNjYWxlLnN5OwogICAgICBjb25zdCBwYXR0ZXJuID0gbmV3IE9mZnNjcmVlbkNhbnZhcyhib3hEaW1XaWR0aCAqIDIsIGJveERpbUhlaWdodCAqIDIpOwogICAgICBjb25zdCBwYXR0ZXJuQ3R4ID0gcGF0dGVybi5nZXRDb250ZXh0KCIyZCIpOwogICAgICBwYXR0ZXJuQ3R4LmZpbGxTdHlsZSA9IHdoaXRlOwogICAgICBwYXR0ZXJuQ3R4LmZpbGxSZWN0KDAsIDAsIGJveERpbVdpZHRoICogMiwgYm94RGltSGVpZ2h0ICogMik7CiAgICAgIHBhdHRlcm5DdHguZmlsbFN0eWxlID0gYmxhY2s7CiAgICAgIHBhdHRlcm5DdHguZmlsbFJlY3QoMCwgMCwgYm94RGltV2lkdGgsIGJveERpbUhlaWdodCk7CiAgICAgIHBhdHRlcm5DdHguZmlsbFJlY3QoYm94RGltV2lkdGgsIGJveERpbUhlaWdodCwgYm94RGltV2lkdGgsIGJveERpbUhlaWdodCk7CiAgICAgIGN0eC5maWxsU3R5bGUgPSBjdHguY3JlYXRlUGF0dGVybihwYXR0ZXJuLCAicmVwZWF0Iik7CiAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBzY2FsZWRXaWR0aCwgc2NhbGVkSGVpZ2h0KTsKICAgICAgY3R4LmRyYXdJbWFnZShiaXRtYXAsIDAsIDAsIGJpdG1hcC53aWR0aCwgYml0bWFwLmhlaWdodCwgMCwgMCwgc2NhbGVkV2lkdGgsIHNjYWxlZEhlaWdodCk7CiAgICB9CiAgICBsZXQgaW1hZ2VEYXRhID0gbnVsbDsKICAgIGlmIChjcmVhdGVJbWFnZURhdGEpIHsKICAgICAgbGV0IGRhdGFXaWR0aCwgZGF0YUhlaWdodDsKICAgICAgaWYgKG91dHB1dFNjYWxlLnN5bW1ldHJpYyAmJiBiaXRtYXAud2lkdGggPCBtYXhEYXRhRGltZW5zaW9uICYmIGJpdG1hcC5oZWlnaHQgPCBtYXhEYXRhRGltZW5zaW9uKSB7CiAgICAgICAgZGF0YVdpZHRoID0gYml0bWFwLndpZHRoOwogICAgICAgIGRhdGFIZWlnaHQgPSBiaXRtYXAuaGVpZ2h0OwogICAgICB9IGVsc2UgewogICAgICAgIGJpdG1hcCA9IHRoaXMuI2JpdG1hcDsKICAgICAgICBpZiAoYml0bWFwV2lkdGggPiBtYXhEYXRhRGltZW5zaW9uIHx8IGJpdG1hcEhlaWdodCA+IG1heERhdGFEaW1lbnNpb24pIHsKICAgICAgICAgIGNvbnN0IHJhdGlvID0gTWF0aC5taW4obWF4RGF0YURpbWVuc2lvbiAvIGJpdG1hcFdpZHRoLCBtYXhEYXRhRGltZW5zaW9uIC8gYml0bWFwSGVpZ2h0KTsKICAgICAgICAgIGRhdGFXaWR0aCA9IE1hdGguZmxvb3IoYml0bWFwV2lkdGggKiByYXRpbyk7CiAgICAgICAgICBkYXRhSGVpZ2h0ID0gTWF0aC5mbG9vcihiaXRtYXBIZWlnaHQgKiByYXRpbyk7CiAgICAgICAgICBpZiAoIXRoaXMuI2lzU3ZnKSB7CiAgICAgICAgICAgIGJpdG1hcCA9IHRoaXMuI3NjYWxlQml0bWFwKGRhdGFXaWR0aCwgZGF0YUhlaWdodCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IG9mZnNjcmVlbiA9IG5ldyBPZmZzY3JlZW5DYW52YXMoZGF0YVdpZHRoLCBkYXRhSGVpZ2h0KTsKICAgICAgY29uc3Qgb2Zmc2NyZWVuQ3R4ID0gb2Zmc2NyZWVuLmdldENvbnRleHQoIjJkIiwgewogICAgICAgIHdpbGxSZWFkRnJlcXVlbnRseTogdHJ1ZQogICAgICB9KTsKICAgICAgb2Zmc2NyZWVuQ3R4LmRyYXdJbWFnZShiaXRtYXAsIDAsIDAsIGJpdG1hcC53aWR0aCwgYml0bWFwLmhlaWdodCwgMCwgMCwgZGF0YVdpZHRoLCBkYXRhSGVpZ2h0KTsKICAgICAgaW1hZ2VEYXRhID0gewogICAgICAgIHdpZHRoOiBkYXRhV2lkdGgsCiAgICAgICAgaGVpZ2h0OiBkYXRhSGVpZ2h0LAogICAgICAgIGRhdGE6IG9mZnNjcmVlbkN0eC5nZXRJbWFnZURhdGEoMCwgMCwgZGF0YVdpZHRoLCBkYXRhSGVpZ2h0KS5kYXRhCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gewogICAgICBjYW52YXMsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIGltYWdlRGF0YQogICAgfTsKICB9CiAgI3NjYWxlQml0bWFwKHdpZHRoLCBoZWlnaHQpIHsKICAgIGNvbnN0IHsKICAgICAgd2lkdGg6IGJpdG1hcFdpZHRoLAogICAgICBoZWlnaHQ6IGJpdG1hcEhlaWdodAogICAgfSA9IHRoaXMuI2JpdG1hcDsKICAgIGxldCBuZXdXaWR0aCA9IGJpdG1hcFdpZHRoOwogICAgbGV0IG5ld0hlaWdodCA9IGJpdG1hcEhlaWdodDsKICAgIGxldCBiaXRtYXAgPSB0aGlzLiNiaXRtYXA7CiAgICB3aGlsZSAobmV3V2lkdGggPiAyICogd2lkdGggfHwgbmV3SGVpZ2h0ID4gMiAqIGhlaWdodCkgewogICAgICBjb25zdCBwcmV2V2lkdGggPSBuZXdXaWR0aDsKICAgICAgY29uc3QgcHJldkhlaWdodCA9IG5ld0hlaWdodDsKICAgICAgaWYgKG5ld1dpZHRoID4gMiAqIHdpZHRoKSB7CiAgICAgICAgbmV3V2lkdGggPSBuZXdXaWR0aCA+PSAxNjM4NCA/IE1hdGguZmxvb3IobmV3V2lkdGggLyAyKSAtIDEgOiBNYXRoLmNlaWwobmV3V2lkdGggLyAyKTsKICAgICAgfQogICAgICBpZiAobmV3SGVpZ2h0ID4gMiAqIGhlaWdodCkgewogICAgICAgIG5ld0hlaWdodCA9IG5ld0hlaWdodCA+PSAxNjM4NCA/IE1hdGguZmxvb3IobmV3SGVpZ2h0IC8gMikgLSAxIDogTWF0aC5jZWlsKG5ld0hlaWdodCAvIDIpOwogICAgICB9CiAgICAgIGNvbnN0IG9mZnNjcmVlbiA9IG5ldyBPZmZzY3JlZW5DYW52YXMobmV3V2lkdGgsIG5ld0hlaWdodCk7CiAgICAgIGNvbnN0IGN0eCA9IG9mZnNjcmVlbi5nZXRDb250ZXh0KCIyZCIpOwogICAgICBjdHguZHJhd0ltYWdlKGJpdG1hcCwgMCwgMCwgcHJldldpZHRoLCBwcmV2SGVpZ2h0LCAwLCAwLCBuZXdXaWR0aCwgbmV3SGVpZ2h0KTsKICAgICAgYml0bWFwID0gb2Zmc2NyZWVuLnRyYW5zZmVyVG9JbWFnZUJpdG1hcCgpOwogICAgfQogICAgcmV0dXJuIGJpdG1hcDsKICB9CiAgI2RyYXdCaXRtYXAoKSB7CiAgICBjb25zdCBbcGFyZW50V2lkdGgsIHBhcmVudEhlaWdodF0gPSB0aGlzLnBhcmVudERpbWVuc2lvbnM7CiAgICBjb25zdCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0gPSB0aGlzOwogICAgY29uc3Qgb3V0cHV0U2NhbGUgPSBuZXcgT3V0cHV0U2NhbGUoKTsKICAgIGNvbnN0IHNjYWxlZFdpZHRoID0gTWF0aC5jZWlsKHdpZHRoICogcGFyZW50V2lkdGggKiBvdXRwdXRTY2FsZS5zeCk7CiAgICBjb25zdCBzY2FsZWRIZWlnaHQgPSBNYXRoLmNlaWwoaGVpZ2h0ICogcGFyZW50SGVpZ2h0ICogb3V0cHV0U2NhbGUuc3kpOwogICAgY29uc3QgY2FudmFzID0gdGhpcy4jY2FudmFzOwogICAgaWYgKCFjYW52YXMgfHwgY2FudmFzLndpZHRoID09PSBzY2FsZWRXaWR0aCAmJiBjYW52YXMuaGVpZ2h0ID09PSBzY2FsZWRIZWlnaHQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2FudmFzLndpZHRoID0gc2NhbGVkV2lkdGg7CiAgICBjYW52YXMuaGVpZ2h0ID0gc2NhbGVkSGVpZ2h0OwogICAgY29uc3QgYml0bWFwID0gdGhpcy4jaXNTdmcgPyB0aGlzLiNiaXRtYXAgOiB0aGlzLiNzY2FsZUJpdG1hcChzY2FsZWRXaWR0aCwgc2NhbGVkSGVpZ2h0KTsKICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgY3R4LmZpbHRlciA9IHRoaXMuX3VpTWFuYWdlci5oY21GaWx0ZXI7CiAgICBjdHguZHJhd0ltYWdlKGJpdG1hcCwgMCwgMCwgYml0bWFwLndpZHRoLCBiaXRtYXAuaGVpZ2h0LCAwLCAwLCBzY2FsZWRXaWR0aCwgc2NhbGVkSGVpZ2h0KTsKICB9CiAgI3NlcmlhbGl6ZUJpdG1hcCh0b1VybCkgewogICAgaWYgKHRvVXJsKSB7CiAgICAgIGlmICh0aGlzLiNpc1N2ZykgewogICAgICAgIGNvbnN0IHVybCA9IHRoaXMuX3VpTWFuYWdlci5pbWFnZU1hbmFnZXIuZ2V0U3ZnVXJsKHRoaXMuI2JpdG1hcElkKTsKICAgICAgICBpZiAodXJsKSB7CiAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgICAgKHsKICAgICAgICB3aWR0aDogY2FudmFzLndpZHRoLAogICAgICAgIGhlaWdodDogY2FudmFzLmhlaWdodAogICAgICB9ID0gdGhpcy4jYml0bWFwKTsKICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgIGN0eC5kcmF3SW1hZ2UodGhpcy4jYml0bWFwLCAwLCAwKTsKICAgICAgcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwoKTsKICAgIH0KICAgIGlmICh0aGlzLiNpc1N2ZykgewogICAgICBjb25zdCBbcGFnZVdpZHRoLCBwYWdlSGVpZ2h0XSA9IHRoaXMucGFnZURpbWVuc2lvbnM7CiAgICAgIGNvbnN0IHdpZHRoID0gTWF0aC5yb3VuZCh0aGlzLndpZHRoICogcGFnZVdpZHRoICogUGl4ZWxzUGVySW5jaC5QREZfVE9fQ1NTX1VOSVRTKTsKICAgICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5yb3VuZCh0aGlzLmhlaWdodCAqIHBhZ2VIZWlnaHQgKiBQaXhlbHNQZXJJbmNoLlBERl9UT19DU1NfVU5JVFMpOwogICAgICBjb25zdCBvZmZzY3JlZW4gPSBuZXcgT2Zmc2NyZWVuQ2FudmFzKHdpZHRoLCBoZWlnaHQpOwogICAgICBjb25zdCBjdHggPSBvZmZzY3JlZW4uZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgY3R4LmRyYXdJbWFnZSh0aGlzLiNiaXRtYXAsIDAsIDAsIHRoaXMuI2JpdG1hcC53aWR0aCwgdGhpcy4jYml0bWFwLmhlaWdodCwgMCwgMCwgd2lkdGgsIGhlaWdodCk7CiAgICAgIHJldHVybiBvZmZzY3JlZW4udHJhbnNmZXJUb0ltYWdlQml0bWFwKCk7CiAgICB9CiAgICByZXR1cm4gc3RydWN0dXJlZENsb25lKHRoaXMuI2JpdG1hcCk7CiAgfQogIHN0YXRpYyBhc3luYyBkZXNlcmlhbGl6ZShkYXRhLCBwYXJlbnQsIHVpTWFuYWdlcikgewogICAgbGV0IGluaXRpYWxEYXRhMiA9IG51bGw7CiAgICBsZXQgbWlzc2luZ0NhbnZhcyA9IGZhbHNlOwogICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBTdGFtcEFubm90YXRpb25FbGVtZW50KSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRhOiB7CiAgICAgICAgICByZWN0OiByZWN0MiwKICAgICAgICAgIHJvdGF0aW9uLAogICAgICAgICAgaWQsCiAgICAgICAgICBzdHJ1Y3RQYXJlbnQsCiAgICAgICAgICBwb3B1cFJlZiwKICAgICAgICAgIHJpY2hUZXh0LAogICAgICAgICAgY29udGVudHNPYmosCiAgICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgICBtb2RpZmljYXRpb25EYXRlCiAgICAgICAgfSwKICAgICAgICBjb250YWluZXI6IGNvbnRhaW5lcjIsCiAgICAgICAgcGFyZW50OiB7CiAgICAgICAgICBwYWdlOiB7CiAgICAgICAgICAgIHBhZ2VOdW1iZXIKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNhbnZhcwogICAgICB9ID0gZGF0YTsKICAgICAgbGV0IGJpdG1hcElkMiwgYml0bWFwMjsKICAgICAgaWYgKGNhbnZhcykgewogICAgICAgIGRlbGV0ZSBkYXRhLmNhbnZhczsKICAgICAgICAoewogICAgICAgICAgaWQ6IGJpdG1hcElkMiwKICAgICAgICAgIGJpdG1hcDogYml0bWFwMgogICAgICAgIH0gPSB1aU1hbmFnZXIuaW1hZ2VNYW5hZ2VyLmdldEZyb21DYW52YXMoY29udGFpbmVyMi5pZCwgY2FudmFzKSk7CiAgICAgICAgY2FudmFzLnJlbW92ZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIG1pc3NpbmdDYW52YXMgPSB0cnVlOwogICAgICAgIGRhdGEuX2hhc05vQ2FudmFzID0gdHJ1ZTsKICAgICAgfQogICAgICBjb25zdCBhbHRUZXh0ID0gKGF3YWl0IHBhcmVudC5fc3RydWN0VHJlZS5nZXRBcmlhQXR0cmlidXRlcyhgJHtBbm5vdGF0aW9uUHJlZml4fSR7aWR9YCkpPy5nZXQoImFyaWEtbGFiZWwiKSB8fCAiIjsKICAgICAgaW5pdGlhbERhdGEyID0gZGF0YSA9IHsKICAgICAgICBhbm5vdGF0aW9uVHlwZTogQW5ub3RhdGlvbkVkaXRvclR5cGUuU1RBTVAsCiAgICAgICAgYml0bWFwSWQ6IGJpdG1hcElkMiwKICAgICAgICBiaXRtYXA6IGJpdG1hcDIsCiAgICAgICAgcGFnZUluZGV4OiBwYWdlTnVtYmVyIC0gMSwKICAgICAgICByZWN0OiByZWN0Mi5zbGljZSgwKSwKICAgICAgICByb3RhdGlvbiwKICAgICAgICBhbm5vdGF0aW9uRWxlbWVudElkOiBpZCwKICAgICAgICBpZCwKICAgICAgICBkZWxldGVkOiBmYWxzZSwKICAgICAgICBhY2Nlc3NpYmlsaXR5RGF0YTogewogICAgICAgICAgZGVjb3JhdGl2ZTogZmFsc2UsCiAgICAgICAgICBhbHRUZXh0CiAgICAgICAgfSwKICAgICAgICBpc1N2ZzogZmFsc2UsCiAgICAgICAgc3RydWN0UGFyZW50LAogICAgICAgIHBvcHVwUmVmLAogICAgICAgIHJpY2hUZXh0LAogICAgICAgIGNvbW1lbnQ6IGNvbnRlbnRzT2JqPy5zdHIgfHwgbnVsbCwKICAgICAgICBjcmVhdGlvbkRhdGUsCiAgICAgICAgbW9kaWZpY2F0aW9uRGF0ZQogICAgICB9OwogICAgfQogICAgY29uc3QgZWRpdG9yID0gYXdhaXQgc3VwZXIuZGVzZXJpYWxpemUoZGF0YSwgcGFyZW50LCB1aU1hbmFnZXIpOwogICAgY29uc3QgewogICAgICByZWN0LAogICAgICBiaXRtYXAsCiAgICAgIGJpdG1hcFVybCwKICAgICAgYml0bWFwSWQsCiAgICAgIGlzU3ZnLAogICAgICBhY2Nlc3NpYmlsaXR5RGF0YQogICAgfSA9IGRhdGE7CiAgICBpZiAobWlzc2luZ0NhbnZhcykgewogICAgICB1aU1hbmFnZXIuYWRkTWlzc2luZ0NhbnZhcyhkYXRhLmlkLCBlZGl0b3IpOwogICAgICBlZGl0b3IuI21pc3NpbmdDYW52YXMgPSB0cnVlOwogICAgfSBlbHNlIGlmIChiaXRtYXBJZCAmJiB1aU1hbmFnZXIuaW1hZ2VNYW5hZ2VyLmlzVmFsaWRJZChiaXRtYXBJZCkpIHsKICAgICAgZWRpdG9yLiNiaXRtYXBJZCA9IGJpdG1hcElkOwogICAgICBpZiAoYml0bWFwKSB7CiAgICAgICAgZWRpdG9yLiNiaXRtYXAgPSBiaXRtYXA7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVkaXRvci4jYml0bWFwVXJsID0gYml0bWFwVXJsOwogICAgfQogICAgZWRpdG9yLiNpc1N2ZyA9IGlzU3ZnOwogICAgY29uc3QgW3BhcmVudFdpZHRoLCBwYXJlbnRIZWlnaHRdID0gZWRpdG9yLnBhZ2VEaW1lbnNpb25zOwogICAgZWRpdG9yLndpZHRoID0gKHJlY3RbMl0gLSByZWN0WzBdKSAvIHBhcmVudFdpZHRoOwogICAgZWRpdG9yLmhlaWdodCA9IChyZWN0WzNdIC0gcmVjdFsxXSkgLyBwYXJlbnRIZWlnaHQ7CiAgICBpZiAoYWNjZXNzaWJpbGl0eURhdGEpIHsKICAgICAgZWRpdG9yLmFsdFRleHREYXRhID0gYWNjZXNzaWJpbGl0eURhdGE7CiAgICB9CiAgICBlZGl0b3IuX2luaXRpYWxEYXRhID0gaW5pdGlhbERhdGEyOwogICAgaWYgKGRhdGEuY29tbWVudCkgewogICAgICBlZGl0b3Iuc2V0Q29tbWVudERhdGEoZGF0YSk7CiAgICB9CiAgICBlZGl0b3IuI2hhc0JlZW5BZGRlZEluVW5kb1N0YWNrID0gISFpbml0aWFsRGF0YTI7CiAgICByZXR1cm4gZWRpdG9yOwogIH0KICBzZXJpYWxpemUoaXNGb3JDb3B5aW5nID0gZmFsc2UsIGNvbnRleHQgPSBudWxsKSB7CiAgICBpZiAodGhpcy5pc0VtcHR5KCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBpZiAodGhpcy5kZWxldGVkKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcmlhbGl6ZURlbGV0ZWQoKTsKICAgIH0KICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBPYmplY3QuYXNzaWduKHN1cGVyLnNlcmlhbGl6ZShpc0ZvckNvcHlpbmcpLCB7CiAgICAgIGJpdG1hcElkOiB0aGlzLiNiaXRtYXBJZCwKICAgICAgaXNTdmc6IHRoaXMuI2lzU3ZnCiAgICB9KTsKICAgIHRoaXMuYWRkQ29tbWVudChzZXJpYWxpemVkKTsKICAgIGlmIChpc0ZvckNvcHlpbmcpIHsKICAgICAgc2VyaWFsaXplZC5iaXRtYXBVcmwgPSB0aGlzLiNzZXJpYWxpemVCaXRtYXAodHJ1ZSk7CiAgICAgIHNlcmlhbGl6ZWQuYWNjZXNzaWJpbGl0eURhdGEgPSB0aGlzLnNlcmlhbGl6ZUFsdFRleHQodHJ1ZSk7CiAgICAgIHNlcmlhbGl6ZWQuaXNDb3B5ID0gdHJ1ZTsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGRlY29yYXRpdmUsCiAgICAgIGFsdFRleHQKICAgIH0gPSB0aGlzLnNlcmlhbGl6ZUFsdFRleHQoZmFsc2UpOwogICAgaWYgKCFkZWNvcmF0aXZlICYmIGFsdFRleHQpIHsKICAgICAgc2VyaWFsaXplZC5hY2Nlc3NpYmlsaXR5RGF0YSA9IHsKICAgICAgICB0eXBlOiAiRmlndXJlIiwKICAgICAgICBhbHQ6IGFsdFRleHQKICAgICAgfTsKICAgIH0KICAgIGlmICh0aGlzLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuI2hhc0VsZW1lbnRDaGFuZ2VkKHNlcmlhbGl6ZWQpOwogICAgICBpZiAoY2hhbmdlcy5pc1NhbWUpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoY2hhbmdlcy5pc1NhbWVBbHRUZXh0KSB7CiAgICAgICAgZGVsZXRlIHNlcmlhbGl6ZWQuYWNjZXNzaWJpbGl0eURhdGE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VyaWFsaXplZC5hY2Nlc3NpYmlsaXR5RGF0YS5zdHJ1Y3RQYXJlbnQgPSB0aGlzLl9pbml0aWFsRGF0YS5zdHJ1Y3RQYXJlbnQgPz8gLTE7CiAgICAgIH0KICAgICAgc2VyaWFsaXplZC5pZCA9IHRoaXMuYW5ub3RhdGlvbkVsZW1lbnRJZDsKICAgICAgZGVsZXRlIHNlcmlhbGl6ZWQuYml0bWFwSWQ7CiAgICAgIHJldHVybiBzZXJpYWxpemVkOwogICAgfQogICAgaWYgKGNvbnRleHQgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQ7CiAgICB9CiAgICBjb250ZXh0LnN0YW1wcyB8fD0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGFyZWEgPSB0aGlzLiNpc1N2ZyA/IChzZXJpYWxpemVkLnJlY3RbMl0gLSBzZXJpYWxpemVkLnJlY3RbMF0pICogKHNlcmlhbGl6ZWQucmVjdFszXSAtIHNlcmlhbGl6ZWQucmVjdFsxXSkgOiBudWxsOwogICAgaWYgKCFjb250ZXh0LnN0YW1wcy5oYXModGhpcy4jYml0bWFwSWQpKSB7CiAgICAgIGNvbnRleHQuc3RhbXBzLnNldCh0aGlzLiNiaXRtYXBJZCwgewogICAgICAgIGFyZWEsCiAgICAgICAgc2VyaWFsaXplZAogICAgICB9KTsKICAgICAgc2VyaWFsaXplZC5iaXRtYXAgPSB0aGlzLiNzZXJpYWxpemVCaXRtYXAoZmFsc2UpOwogICAgfSBlbHNlIGlmICh0aGlzLiNpc1N2ZykgewogICAgICBjb25zdCBwcmV2RGF0YSA9IGNvbnRleHQuc3RhbXBzLmdldCh0aGlzLiNiaXRtYXBJZCk7CiAgICAgIGlmIChhcmVhID4gcHJldkRhdGEuYXJlYSkgewogICAgICAgIHByZXZEYXRhLmFyZWEgPSBhcmVhOwogICAgICAgIHByZXZEYXRhLnNlcmlhbGl6ZWQuYml0bWFwLmNsb3NlKCk7CiAgICAgICAgcHJldkRhdGEuc2VyaWFsaXplZC5iaXRtYXAgPSB0aGlzLiNzZXJpYWxpemVCaXRtYXAoZmFsc2UpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2VyaWFsaXplZDsKICB9CiAgI2hhc0VsZW1lbnRDaGFuZ2VkKHNlcmlhbGl6ZWQpIHsKICAgIGNvbnN0IHsKICAgICAgcGFnZUluZGV4LAogICAgICBhY2Nlc3NpYmlsaXR5RGF0YTogewogICAgICAgIGFsdFRleHQKICAgICAgfQogICAgfSA9IHRoaXMuX2luaXRpYWxEYXRhOwogICAgY29uc3QgaXNTYW1lUGFnZUluZGV4ID0gc2VyaWFsaXplZC5wYWdlSW5kZXggPT09IHBhZ2VJbmRleDsKICAgIGNvbnN0IGlzU2FtZUFsdFRleHQgPSAoc2VyaWFsaXplZC5hY2Nlc3NpYmlsaXR5RGF0YT8uYWx0IHx8ICIiKSA9PT0gYWx0VGV4dDsKICAgIHJldHVybiB7CiAgICAgIGlzU2FtZTogIXRoaXMuaGFzRWRpdGVkQ29tbWVudCAmJiAhdGhpcy5faGFzQmVlbk1vdmVkICYmICF0aGlzLl9oYXNCZWVuUmVzaXplZCAmJiBpc1NhbWVQYWdlSW5kZXggJiYgaXNTYW1lQWx0VGV4dCwKICAgICAgaXNTYW1lQWx0VGV4dAogICAgfTsKICB9CiAgcmVuZGVyQW5ub3RhdGlvbkVsZW1lbnQoYW5ub3RhdGlvbikgewogICAgaWYgKHRoaXMuZGVsZXRlZCkgewogICAgICBhbm5vdGF0aW9uLmhpZGUoKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICBhbm5vdGF0aW9uLnVwZGF0ZUVkaXRlZCh7CiAgICAgIHJlY3Q6IHRoaXMuZ2V0UERGUmVjdCgpLAogICAgICBwb3B1cDogdGhpcy5jb21tZW50CiAgICB9KTsKICAgIHJldHVybiBudWxsOwogIH0KfTsKdmFyIEFubm90YXRpb25FZGl0b3JMYXllciA9IGNsYXNzIF9Bbm5vdGF0aW9uRWRpdG9yTGF5ZXIgewogICNhY2Nlc3NpYmlsaXR5TWFuYWdlcjsKICAjYWxsb3dDbGljayA9IGZhbHNlOwogICNhbm5vdGF0aW9uTGF5ZXIgPSBudWxsOwogICNjbGlja0FDID0gbnVsbDsKICAjZWRpdG9yRm9jdXNUaW1lb3V0SWQgPSBudWxsOwogICNlZGl0b3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAjaGFkUG9pbnRlckRvd24gPSBmYWxzZTsKICAjaXNEaXNhYmxpbmcgPSBmYWxzZTsKICAjaXNFbmFibGluZyA9IGZhbHNlOwogICNkcmF3aW5nQUMgPSBudWxsOwogICNmb2N1c2VkRWxlbWVudCA9IG51bGw7CiAgI3RleHRMYXllciA9IG51bGw7CiAgI3RleHRTZWxlY3Rpb25BQyA9IG51bGw7CiAgI3RleHRMYXllckRibENsaWNrQUMgPSBudWxsOwogICNsYXN0UG9pbnRlckRvd25UaW1lc3RhbXAgPSAtMTsKICAjdWlNYW5hZ2VyOwogIHN0YXRpYyBfaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICBzdGF0aWMgI2VkaXRvclR5cGVzID0gbmV3IE1hcChbRnJlZVRleHRFZGl0b3IsIElua0VkaXRvciwgU3RhbXBFZGl0b3IsIEhpZ2hsaWdodEVkaXRvciwgU2lnbmF0dXJlRWRpdG9yXS5tYXAoKHR5cGUpID0+IFt0eXBlLl9lZGl0b3JUeXBlLCB0eXBlXSkpOwogIGNvbnN0cnVjdG9yKHsKICAgIHVpTWFuYWdlciwKICAgIHBhZ2VJbmRleCwKICAgIGRpdiwKICAgIHN0cnVjdFRyZWVMYXllciwKICAgIGFjY2Vzc2liaWxpdHlNYW5hZ2VyLAogICAgYW5ub3RhdGlvbkxheWVyLAogICAgZHJhd0xheWVyLAogICAgdGV4dExheWVyLAogICAgdmlld3BvcnQsCiAgICBsMTBuCiAgfSkgewogICAgY29uc3QgZWRpdG9yVHlwZXMgPSBbLi4uX0Fubm90YXRpb25FZGl0b3JMYXllci4jZWRpdG9yVHlwZXMudmFsdWVzKCldOwogICAgaWYgKCFfQW5ub3RhdGlvbkVkaXRvckxheWVyLl9pbml0aWFsaXplZCkgewogICAgICBfQW5ub3RhdGlvbkVkaXRvckxheWVyLl9pbml0aWFsaXplZCA9IHRydWU7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yVHlwZSBvZiBlZGl0b3JUeXBlcykgewogICAgICAgIGVkaXRvclR5cGUuaW5pdGlhbGl6ZShsMTBuLCB1aU1hbmFnZXIpOwogICAgICB9CiAgICB9CiAgICB1aU1hbmFnZXIucmVnaXN0ZXJFZGl0b3JUeXBlcyhlZGl0b3JUeXBlcyk7CiAgICB0aGlzLiN1aU1hbmFnZXIgPSB1aU1hbmFnZXI7CiAgICB0aGlzLnBhZ2VJbmRleCA9IHBhZ2VJbmRleDsKICAgIHRoaXMuZGl2ID0gZGl2OwogICAgdGhpcy4jYWNjZXNzaWJpbGl0eU1hbmFnZXIgPSBhY2Nlc3NpYmlsaXR5TWFuYWdlcjsKICAgIHRoaXMuI2Fubm90YXRpb25MYXllciA9IGFubm90YXRpb25MYXllcjsKICAgIHRoaXMudmlld3BvcnQgPSB2aWV3cG9ydDsKICAgIHRoaXMuI3RleHRMYXllciA9IHRleHRMYXllcjsKICAgIHRoaXMuZHJhd0xheWVyID0gZHJhd0xheWVyOwogICAgdGhpcy5fc3RydWN0VHJlZSA9IHN0cnVjdFRyZWVMYXllcjsKICAgIHRoaXMuI3VpTWFuYWdlci5hZGRMYXllcih0aGlzKTsKICB9CiAgZ2V0IGlzRW1wdHkoKSB7CiAgICByZXR1cm4gdGhpcy4jZWRpdG9ycy5zaXplID09PSAwOwogIH0KICBnZXQgaXNJbnZpc2libGUoKSB7CiAgICByZXR1cm4gdGhpcy5pc0VtcHR5ICYmIHRoaXMuI3VpTWFuYWdlci5nZXRNb2RlKCkgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkU7CiAgfQogIHVwZGF0ZVRvb2xiYXIob3B0aW9ucykgewogICAgdGhpcy4jdWlNYW5hZ2VyLnVwZGF0ZVRvb2xiYXIob3B0aW9ucyk7CiAgfQogIHVwZGF0ZU1vZGUobW9kZSA9IHRoaXMuI3VpTWFuYWdlci5nZXRNb2RlKCkpIHsKICAgIHRoaXMuI2NsZWFudXAoKTsKICAgIHN3aXRjaCAobW9kZSkgewogICAgICBjYXNlIEFubm90YXRpb25FZGl0b3JUeXBlLk5PTkU6CiAgICAgICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgibm9uRWRpdGluZyIsIHRydWUpOwogICAgICAgIHRoaXMuZGlzYWJsZVRleHRTZWxlY3Rpb24oKTsKICAgICAgICB0aGlzLnRvZ2dsZVBvaW50ZXJFdmVudHMoZmFsc2UpOwogICAgICAgIHRoaXMudG9nZ2xlQW5ub3RhdGlvbkxheWVyUG9pbnRlckV2ZW50cyh0cnVlKTsKICAgICAgICB0aGlzLmRpc2FibGVDbGljaygpOwogICAgICAgIHJldHVybjsKICAgICAgY2FzZSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5JTks6CiAgICAgICAgdGhpcy5kaXNhYmxlVGV4dFNlbGVjdGlvbigpOwogICAgICAgIHRoaXMudG9nZ2xlUG9pbnRlckV2ZW50cyh0cnVlKTsKICAgICAgICB0aGlzLmVuYWJsZUNsaWNrKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgQW5ub3RhdGlvbkVkaXRvclR5cGUuSElHSExJR0hUOgogICAgICAgIHRoaXMuZW5hYmxlVGV4dFNlbGVjdGlvbigpOwogICAgICAgIHRoaXMudG9nZ2xlUG9pbnRlckV2ZW50cyhmYWxzZSk7CiAgICAgICAgdGhpcy5kaXNhYmxlQ2xpY2soKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aGlzLmRpc2FibGVUZXh0U2VsZWN0aW9uKCk7CiAgICAgICAgdGhpcy50b2dnbGVQb2ludGVyRXZlbnRzKHRydWUpOwogICAgICAgIHRoaXMuZW5hYmxlQ2xpY2soKTsKICAgIH0KICAgIHRoaXMudG9nZ2xlQW5ub3RhdGlvbkxheWVyUG9pbnRlckV2ZW50cyhmYWxzZSk7CiAgICBjb25zdCB7CiAgICAgIGNsYXNzTGlzdAogICAgfSA9IHRoaXMuZGl2OwogICAgY2xhc3NMaXN0LnRvZ2dsZSgibm9uRWRpdGluZyIsIGZhbHNlKTsKICAgIGlmIChtb2RlID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5QT1BVUCkgewogICAgICBjbGFzc0xpc3QudG9nZ2xlKCJjb21tZW50RWRpdGluZyIsIHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgY2xhc3NMaXN0LnRvZ2dsZSgiY29tbWVudEVkaXRpbmciLCBmYWxzZSk7CiAgICAgIGZvciAoY29uc3QgZWRpdG9yVHlwZSBvZiBfQW5ub3RhdGlvbkVkaXRvckxheWVyLiNlZGl0b3JUeXBlcy52YWx1ZXMoKSkgewogICAgICAgIGNsYXNzTGlzdC50b2dnbGUoYCR7ZWRpdG9yVHlwZS5fdHlwZX1FZGl0aW5nYCwgbW9kZSA9PT0gZWRpdG9yVHlwZS5fZWRpdG9yVHlwZSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuZGl2LmhpZGRlbiA9IGZhbHNlOwogIH0KICBoYXNUZXh0TGF5ZXIodGV4dExheWVyKSB7CiAgICByZXR1cm4gdGV4dExheWVyID09PSB0aGlzLiN0ZXh0TGF5ZXI/LmRpdjsKICB9CiAgc2V0RWRpdGluZ1N0YXRlKGlzRWRpdGluZykgewogICAgdGhpcy4jdWlNYW5hZ2VyLnNldEVkaXRpbmdTdGF0ZShpc0VkaXRpbmcpOwogIH0KICBhZGRDb21tYW5kcyhwYXJhbXMpIHsKICAgIHRoaXMuI3VpTWFuYWdlci5hZGRDb21tYW5kcyhwYXJhbXMpOwogIH0KICBjbGVhblVuZG9TdGFjayh0eXBlKSB7CiAgICB0aGlzLiN1aU1hbmFnZXIuY2xlYW5VbmRvU3RhY2sodHlwZSk7CiAgfQogIHRvZ2dsZURyYXdpbmcoZW5hYmxlZCA9IGZhbHNlKSB7CiAgICB0aGlzLmRpdi5jbGFzc0xpc3QudG9nZ2xlKCJkcmF3aW5nIiwgIWVuYWJsZWQpOwogIH0KICB0b2dnbGVQb2ludGVyRXZlbnRzKGVuYWJsZWQgPSBmYWxzZSkgewogICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgiZGlzYWJsZWQiLCAhZW5hYmxlZCk7CiAgfQogIHRvZ2dsZUFubm90YXRpb25MYXllclBvaW50ZXJFdmVudHMoZW5hYmxlZCA9IGZhbHNlKSB7CiAgICB0aGlzLiNhbm5vdGF0aW9uTGF5ZXI/LnRvZ2dsZVBvaW50ZXJFdmVudHMoZW5hYmxlZCk7CiAgfQogIGdldCAjYWxsRWRpdG9yc0l0ZXJhdG9yKCkgewogICAgcmV0dXJuIHRoaXMuI2VkaXRvcnMuc2l6ZSAhPT0gMCA/IHRoaXMuI2VkaXRvcnMudmFsdWVzKCkgOiB0aGlzLiN1aU1hbmFnZXIuZ2V0RWRpdG9ycyh0aGlzLnBhZ2VJbmRleCk7CiAgfQogIGFzeW5jIGVuYWJsZSgpIHsKICAgIHRoaXMuI2lzRW5hYmxpbmcgPSB0cnVlOwogICAgdGhpcy5kaXYudGFiSW5kZXggPSAwOwogICAgdGhpcy50b2dnbGVQb2ludGVyRXZlbnRzKHRydWUpOwogICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgibm9uRWRpdGluZyIsIGZhbHNlKTsKICAgIHRoaXMuI3RleHRMYXllckRibENsaWNrQUM/LmFib3J0KCk7CiAgICB0aGlzLiN0ZXh0TGF5ZXJEYmxDbGlja0FDID0gbnVsbDsKICAgIGNvbnN0IGFubm90YXRpb25FbGVtZW50SWRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2FsbEVkaXRvcnNJdGVyYXRvcikgewogICAgICBlZGl0b3IuZW5hYmxlRWRpdGluZygpOwogICAgICBlZGl0b3Iuc2hvdyh0cnVlKTsKICAgICAgaWYgKGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkKSB7CiAgICAgICAgdGhpcy4jdWlNYW5hZ2VyLnJlbW92ZUNoYW5nZWRFeGlzdGluZ0Fubm90YXRpb24oZWRpdG9yKTsKICAgICAgICBhbm5vdGF0aW9uRWxlbWVudElkcy5hZGQoZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBhbm5vdGF0aW9uTGF5ZXIgPSB0aGlzLiNhbm5vdGF0aW9uTGF5ZXI7CiAgICBpZiAoYW5ub3RhdGlvbkxheWVyKSB7CiAgICAgIGZvciAoY29uc3QgZWRpdGFibGUgb2YgYW5ub3RhdGlvbkxheWVyLmdldEVkaXRhYmxlQW5ub3RhdGlvbnMoKSkgewogICAgICAgIGVkaXRhYmxlLmhpZGUoKTsKICAgICAgICBpZiAodGhpcy4jdWlNYW5hZ2VyLmlzRGVsZXRlZEFubm90YXRpb25FbGVtZW50KGVkaXRhYmxlLmRhdGEuaWQpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGFubm90YXRpb25FbGVtZW50SWRzLmhhcyhlZGl0YWJsZS5kYXRhLmlkKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVkaXRvciA9IGF3YWl0IHRoaXMuZGVzZXJpYWxpemUoZWRpdGFibGUpOwogICAgICAgIGlmICghZWRpdG9yKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hZGRPclJlYnVpbGQoZWRpdG9yKTsKICAgICAgICBlZGl0b3IuZW5hYmxlRWRpdGluZygpOwogICAgICB9CiAgICB9CiAgICB0aGlzLiNpc0VuYWJsaW5nID0gZmFsc2U7CiAgICB0aGlzLiN1aU1hbmFnZXIuX2V2ZW50QnVzLmRpc3BhdGNoKCJlZGl0b3JzcmVuZGVyZWQiLCB7CiAgICAgIHNvdXJjZTogdGhpcywKICAgICAgcGFnZU51bWJlcjogdGhpcy5wYWdlSW5kZXggKyAxCiAgICB9KTsKICB9CiAgZGlzYWJsZSgpIHsKICAgIHRoaXMuI2lzRGlzYWJsaW5nID0gdHJ1ZTsKICAgIHRoaXMuZGl2LnRhYkluZGV4ID0gLTE7CiAgICB0aGlzLnRvZ2dsZVBvaW50ZXJFdmVudHMoZmFsc2UpOwogICAgdGhpcy5kaXYuY2xhc3NMaXN0LnRvZ2dsZSgibm9uRWRpdGluZyIsIHRydWUpOwogICAgaWYgKHRoaXMuI3RleHRMYXllciAmJiAhdGhpcy4jdGV4dExheWVyRGJsQ2xpY2tBQykgewogICAgICB0aGlzLiN0ZXh0TGF5ZXJEYmxDbGlja0FDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgICBjb25zdCBzaWduYWwgPSB0aGlzLiN1aU1hbmFnZXIuY29tYmluZWRTaWduYWwodGhpcy4jdGV4dExheWVyRGJsQ2xpY2tBQyk7CiAgICAgIHRoaXMuI3RleHRMYXllci5kaXYuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmRvd24iLCAoZSkgPT4gewogICAgICAgIGNvbnN0IERCTF9DTElDS19USFJFU0hPTEQgPSA1MDA7CiAgICAgICAgY29uc3QgewogICAgICAgICAgY2xpZW50WCwKICAgICAgICAgIGNsaWVudFksCiAgICAgICAgICB0aW1lU3RhbXAKICAgICAgICB9ID0gZTsKICAgICAgICBjb25zdCBsYXN0UG9pbnRlckRvd25UaW1lc3RhbXAgPSB0aGlzLiNsYXN0UG9pbnRlckRvd25UaW1lc3RhbXA7CiAgICAgICAgaWYgKHRpbWVTdGFtcCAtIGxhc3RQb2ludGVyRG93blRpbWVzdGFtcCA+IERCTF9DTElDS19USFJFU0hPTEQpIHsKICAgICAgICAgIHRoaXMuI2xhc3RQb2ludGVyRG93blRpbWVzdGFtcCA9IHRpbWVTdGFtcDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy4jbGFzdFBvaW50ZXJEb3duVGltZXN0YW1wID0gLTE7CiAgICAgICAgY29uc3QgewogICAgICAgICAgY2xhc3NMaXN0OiBjbGFzc0xpc3QyCiAgICAgICAgfSA9IHRoaXMuZGl2OwogICAgICAgIGNsYXNzTGlzdDIudG9nZ2xlKCJnZXRFbGVtZW50cyIsIHRydWUpOwogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZG9jdW1lbnQuZWxlbWVudHNGcm9tUG9pbnQoY2xpZW50WCwgY2xpZW50WSk7CiAgICAgICAgY2xhc3NMaXN0Mi50b2dnbGUoImdldEVsZW1lbnRzIiwgZmFsc2UpOwogICAgICAgIGlmICghdGhpcy5kaXYuY29udGFpbnMoZWxlbWVudHNbMF0pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGxldCBpZDsKICAgICAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoYF4ke0Fubm90YXRpb25FZGl0b3JQcmVmaXh9WzAtOV0rJGApOwogICAgICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBlbGVtZW50cykgewogICAgICAgICAgaWYgKHJlZ2V4LnRlc3QoZWxlbWVudC5pZCkpIHsKICAgICAgICAgICAgaWQgPSBlbGVtZW50LmlkOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFpZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBlZGl0b3IgPSB0aGlzLiNlZGl0b3JzLmdldChpZCk7CiAgICAgICAgaWYgKGVkaXRvcj8uYW5ub3RhdGlvbkVsZW1lbnRJZCA9PT0gbnVsbCkgewogICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGVkaXRvci5kYmxjbGljayhlKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICBzaWduYWwsCiAgICAgICAgY2FwdHVyZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IGFubm90YXRpb25MYXllciA9IHRoaXMuI2Fubm90YXRpb25MYXllcjsKICAgIGNvbnN0IG5lZWRGYWtlQW5ub3RhdGlvbiA9IFtdOwogICAgaWYgKGFubm90YXRpb25MYXllcikgewogICAgICBjb25zdCBjaGFuZ2VkQW5ub3RhdGlvbnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBjb25zdCByZXNldEFubm90YXRpb25zID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jYWxsRWRpdG9yc0l0ZXJhdG9yKSB7CiAgICAgICAgZWRpdG9yLmRpc2FibGVFZGl0aW5nKCk7CiAgICAgICAgaWYgKCFlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCkgewogICAgICAgICAgbmVlZEZha2VBbm5vdGF0aW9uLnB1c2goZWRpdG9yKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoZWRpdG9yLnNlcmlhbGl6ZSgpICE9PSBudWxsKSB7CiAgICAgICAgICBjaGFuZ2VkQW5ub3RhdGlvbnMuc2V0KGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkLCBlZGl0b3IpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc2V0QW5ub3RhdGlvbnMuc2V0KGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkLCBlZGl0b3IpOwogICAgICAgIH0KICAgICAgICB0aGlzLmdldEVkaXRhYmxlQW5ub3RhdGlvbihlZGl0b3IuYW5ub3RhdGlvbkVsZW1lbnRJZCk/LnNob3coKTsKICAgICAgICBlZGl0b3IucmVtb3ZlKCk7CiAgICAgIH0KICAgICAgY29uc3QgZWRpdGFibGVzID0gYW5ub3RhdGlvbkxheWVyLmdldEVkaXRhYmxlQW5ub3RhdGlvbnMoKTsKICAgICAgZm9yIChjb25zdCBlZGl0YWJsZSBvZiBlZGl0YWJsZXMpIHsKICAgICAgICBjb25zdCB7CiAgICAgICAgICBpZAogICAgICAgIH0gPSBlZGl0YWJsZS5kYXRhOwogICAgICAgIGlmICh0aGlzLiN1aU1hbmFnZXIuaXNEZWxldGVkQW5ub3RhdGlvbkVsZW1lbnQoaWQpKSB7CiAgICAgICAgICBlZGl0YWJsZS51cGRhdGVFZGl0ZWQoewogICAgICAgICAgICBkZWxldGVkOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBsZXQgZWRpdG9yID0gcmVzZXRBbm5vdGF0aW9ucy5nZXQoaWQpOwogICAgICAgIGlmIChlZGl0b3IpIHsKICAgICAgICAgIGVkaXRvci5yZXNldEFubm90YXRpb25FbGVtZW50KGVkaXRhYmxlKTsKICAgICAgICAgIGVkaXRvci5zaG93KGZhbHNlKTsKICAgICAgICAgIGVkaXRhYmxlLnNob3coKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBlZGl0b3IgPSBjaGFuZ2VkQW5ub3RhdGlvbnMuZ2V0KGlkKTsKICAgICAgICBpZiAoZWRpdG9yKSB7CiAgICAgICAgICB0aGlzLiN1aU1hbmFnZXIuYWRkQ2hhbmdlZEV4aXN0aW5nQW5ub3RhdGlvbihlZGl0b3IpOwogICAgICAgICAgaWYgKGVkaXRvci5yZW5kZXJBbm5vdGF0aW9uRWxlbWVudChlZGl0YWJsZSkpIHsKICAgICAgICAgICAgZWRpdG9yLnNob3coZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlZGl0YWJsZS5zaG93KCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuI2NsZWFudXAoKTsKICAgIGlmICh0aGlzLmlzRW1wdHkpIHsKICAgICAgdGhpcy5kaXYuaGlkZGVuID0gdHJ1ZTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgY2xhc3NMaXN0CiAgICB9ID0gdGhpcy5kaXY7CiAgICBmb3IgKGNvbnN0IGVkaXRvclR5cGUgb2YgX0Fubm90YXRpb25FZGl0b3JMYXllci4jZWRpdG9yVHlwZXMudmFsdWVzKCkpIHsKICAgICAgY2xhc3NMaXN0LnJlbW92ZShgJHtlZGl0b3JUeXBlLl90eXBlfUVkaXRpbmdgKTsKICAgIH0KICAgIHRoaXMuZGlzYWJsZVRleHRTZWxlY3Rpb24oKTsKICAgIHRoaXMudG9nZ2xlQW5ub3RhdGlvbkxheWVyUG9pbnRlckV2ZW50cyh0cnVlKTsKICAgIGFubm90YXRpb25MYXllcj8udXBkYXRlRmFrZUFubm90YXRpb25zKG5lZWRGYWtlQW5ub3RhdGlvbik7CiAgICB0aGlzLiNpc0Rpc2FibGluZyA9IGZhbHNlOwogIH0KICBnZXRFZGl0YWJsZUFubm90YXRpb24oaWQpIHsKICAgIHJldHVybiB0aGlzLiNhbm5vdGF0aW9uTGF5ZXI/LmdldEVkaXRhYmxlQW5ub3RhdGlvbihpZCkgfHwgbnVsbDsKICB9CiAgc2V0QWN0aXZlRWRpdG9yKGVkaXRvcikgewogICAgY29uc3QgY3VycmVudEFjdGl2ZSA9IHRoaXMuI3VpTWFuYWdlci5nZXRBY3RpdmUoKTsKICAgIGlmIChjdXJyZW50QWN0aXZlID09PSBlZGl0b3IpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jdWlNYW5hZ2VyLnNldEFjdGl2ZUVkaXRvcihlZGl0b3IpOwogIH0KICBlbmFibGVUZXh0U2VsZWN0aW9uKCkgewogICAgdGhpcy5kaXYudGFiSW5kZXggPSAtMTsKICAgIGlmICh0aGlzLiN0ZXh0TGF5ZXI/LmRpdiAmJiAhdGhpcy4jdGV4dFNlbGVjdGlvbkFDKSB7CiAgICAgIHRoaXMuI3RleHRTZWxlY3Rpb25BQyA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgY29uc3Qgc2lnbmFsID0gdGhpcy4jdWlNYW5hZ2VyLmNvbWJpbmVkU2lnbmFsKHRoaXMuI3RleHRTZWxlY3Rpb25BQyk7CiAgICAgIHRoaXMuI3RleHRMYXllci5kaXYuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmRvd24iLCB0aGlzLiN0ZXh0TGF5ZXJQb2ludGVyRG93bi5iaW5kKHRoaXMpLCB7CiAgICAgICAgc2lnbmFsCiAgICAgIH0pOwogICAgICB0aGlzLiN0ZXh0TGF5ZXIuZGl2LmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodGluZyIpOwogICAgfQogIH0KICBkaXNhYmxlVGV4dFNlbGVjdGlvbigpIHsKICAgIHRoaXMuZGl2LnRhYkluZGV4ID0gMDsKICAgIGlmICh0aGlzLiN0ZXh0TGF5ZXI/LmRpdiAmJiB0aGlzLiN0ZXh0U2VsZWN0aW9uQUMpIHsKICAgICAgdGhpcy4jdGV4dFNlbGVjdGlvbkFDLmFib3J0KCk7CiAgICAgIHRoaXMuI3RleHRTZWxlY3Rpb25BQyA9IG51bGw7CiAgICAgIHRoaXMuI3RleHRMYXllci5kaXYuY2xhc3NMaXN0LnJlbW92ZSgiaGlnaGxpZ2h0aW5nIik7CiAgICB9CiAgfQogICN0ZXh0TGF5ZXJQb2ludGVyRG93bihldmVudCkgewogICAgdGhpcy4jdWlNYW5hZ2VyLnVuc2VsZWN0QWxsKCk7CiAgICBjb25zdCB7CiAgICAgIHRhcmdldAogICAgfSA9IGV2ZW50OwogICAgaWYgKHRhcmdldCA9PT0gdGhpcy4jdGV4dExheWVyLmRpdiB8fCAodGFyZ2V0LmdldEF0dHJpYnV0ZSgicm9sZSIpID09PSAiaW1nIiB8fCB0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCJlbmRPZkNvbnRlbnQiKSkgJiYgdGhpcy4jdGV4dExheWVyLmRpdi5jb250YWlucyh0YXJnZXQpKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBpc01hYwogICAgICB9ID0gdXRpbF9GZWF0dXJlVGVzdC5wbGF0Zm9ybTsKICAgICAgaWYgKGV2ZW50LmJ1dHRvbiAhPT0gMCB8fCBldmVudC5jdHJsS2V5ICYmIGlzTWFjKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuI3VpTWFuYWdlci5zaG93QWxsRWRpdG9ycygiaGlnaGxpZ2h0IiwgdHJ1ZSwgdHJ1ZSk7CiAgICAgIHRoaXMuI3RleHRMYXllci5kaXYuY2xhc3NMaXN0LmFkZCgiZnJlZSIpOwogICAgICB0aGlzLnRvZ2dsZURyYXdpbmcoKTsKICAgICAgSGlnaGxpZ2h0RWRpdG9yLnN0YXJ0SGlnaGxpZ2h0aW5nKHRoaXMsIHRoaXMuI3VpTWFuYWdlci5kaXJlY3Rpb24gPT09ICJsdHIiLCB7CiAgICAgICAgdGFyZ2V0OiB0aGlzLiN0ZXh0TGF5ZXIuZGl2LAogICAgICAgIHg6IGV2ZW50LngsCiAgICAgICAgeTogZXZlbnQueQogICAgICB9KTsKICAgICAgdGhpcy4jdGV4dExheWVyLmRpdi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVydXAiLCAoKSA9PiB7CiAgICAgICAgdGhpcy4jdGV4dExheWVyLmRpdi5jbGFzc0xpc3QucmVtb3ZlKCJmcmVlIik7CiAgICAgICAgdGhpcy50b2dnbGVEcmF3aW5nKHRydWUpOwogICAgICB9LCB7CiAgICAgICAgb25jZTogdHJ1ZSwKICAgICAgICBzaWduYWw6IHRoaXMuI3VpTWFuYWdlci5fc2lnbmFsCiAgICAgIH0pOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgfQogIH0KICBlbmFibGVDbGljaygpIHsKICAgIGlmICh0aGlzLiNjbGlja0FDKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2NsaWNrQUMgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBzaWduYWwgPSB0aGlzLiN1aU1hbmFnZXIuY29tYmluZWRTaWduYWwodGhpcy4jY2xpY2tBQyk7CiAgICB0aGlzLmRpdi5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHRoaXMucG9pbnRlcmRvd24uYmluZCh0aGlzKSwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgY29uc3QgcG9pbnRlcnVwID0gdGhpcy5wb2ludGVydXAuYmluZCh0aGlzKTsKICAgIHRoaXMuZGl2LmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJ1cCIsIHBvaW50ZXJ1cCwgewogICAgICBzaWduYWwKICAgIH0pOwogICAgdGhpcy5kaXYuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmNhbmNlbCIsIHBvaW50ZXJ1cCwgewogICAgICBzaWduYWwKICAgIH0pOwogIH0KICBkaXNhYmxlQ2xpY2soKSB7CiAgICB0aGlzLiNjbGlja0FDPy5hYm9ydCgpOwogICAgdGhpcy4jY2xpY2tBQyA9IG51bGw7CiAgfQogIGF0dGFjaChlZGl0b3IpIHsKICAgIHRoaXMuI2VkaXRvcnMuc2V0KGVkaXRvci5pZCwgZWRpdG9yKTsKICAgIGNvbnN0IHsKICAgICAgYW5ub3RhdGlvbkVsZW1lbnRJZAogICAgfSA9IGVkaXRvcjsKICAgIGlmIChhbm5vdGF0aW9uRWxlbWVudElkICYmIHRoaXMuI3VpTWFuYWdlci5pc0RlbGV0ZWRBbm5vdGF0aW9uRWxlbWVudChhbm5vdGF0aW9uRWxlbWVudElkKSkgewogICAgICB0aGlzLiN1aU1hbmFnZXIucmVtb3ZlRGVsZXRlZEFubm90YXRpb25FbGVtZW50KGVkaXRvcik7CiAgICB9CiAgfQogIGRldGFjaChlZGl0b3IpIHsKICAgIHRoaXMuI2VkaXRvcnMuZGVsZXRlKGVkaXRvci5pZCk7CiAgICB0aGlzLiNhY2Nlc3NpYmlsaXR5TWFuYWdlcj8ucmVtb3ZlUG9pbnRlckluVGV4dExheWVyKGVkaXRvci5jb250ZW50RGl2KTsKICAgIGlmICghdGhpcy4jaXNEaXNhYmxpbmcgJiYgZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgdGhpcy4jdWlNYW5hZ2VyLmFkZERlbGV0ZWRBbm5vdGF0aW9uRWxlbWVudChlZGl0b3IpOwogICAgfQogIH0KICByZW1vdmUoZWRpdG9yKSB7CiAgICB0aGlzLmRldGFjaChlZGl0b3IpOwogICAgdGhpcy4jdWlNYW5hZ2VyLnJlbW92ZUVkaXRvcihlZGl0b3IpOwogICAgZWRpdG9yLmRpdi5yZW1vdmUoKTsKICAgIGVkaXRvci5pc0F0dGFjaGVkVG9ET00gPSBmYWxzZTsKICB9CiAgY2hhbmdlUGFyZW50KGVkaXRvcikgewogICAgaWYgKGVkaXRvci5wYXJlbnQgPT09IHRoaXMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGVkaXRvci5wYXJlbnQgJiYgZWRpdG9yLmFubm90YXRpb25FbGVtZW50SWQpIHsKICAgICAgdGhpcy4jdWlNYW5hZ2VyLmFkZERlbGV0ZWRBbm5vdGF0aW9uRWxlbWVudChlZGl0b3IpOwogICAgICBBbm5vdGF0aW9uRWRpdG9yLmRlbGV0ZUFubm90YXRpb25FbGVtZW50KGVkaXRvcik7CiAgICAgIGVkaXRvci5hbm5vdGF0aW9uRWxlbWVudElkID0gbnVsbDsKICAgIH0KICAgIHRoaXMuYXR0YWNoKGVkaXRvcik7CiAgICBlZGl0b3IucGFyZW50Py5kZXRhY2goZWRpdG9yKTsKICAgIGVkaXRvci5zZXRQYXJlbnQodGhpcyk7CiAgICBpZiAoZWRpdG9yLmRpdiAmJiBlZGl0b3IuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIGVkaXRvci5kaXYucmVtb3ZlKCk7CiAgICAgIHRoaXMuZGl2LmFwcGVuZChlZGl0b3IuZGl2KTsKICAgIH0KICB9CiAgYWRkKGVkaXRvcikgewogICAgaWYgKGVkaXRvci5wYXJlbnQgPT09IHRoaXMgJiYgZWRpdG9yLmlzQXR0YWNoZWRUb0RPTSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmNoYW5nZVBhcmVudChlZGl0b3IpOwogICAgdGhpcy4jdWlNYW5hZ2VyLmFkZEVkaXRvcihlZGl0b3IpOwogICAgdGhpcy5hdHRhY2goZWRpdG9yKTsKICAgIGlmICghZWRpdG9yLmlzQXR0YWNoZWRUb0RPTSkgewogICAgICBjb25zdCBkaXYgPSBlZGl0b3IucmVuZGVyKCk7CiAgICAgIHRoaXMuZGl2LmFwcGVuZChkaXYpOwogICAgICBlZGl0b3IuaXNBdHRhY2hlZFRvRE9NID0gdHJ1ZTsKICAgIH0KICAgIGVkaXRvci5maXhBbmRTZXRQb3NpdGlvbigpOwogICAgZWRpdG9yLm9uY2VBZGRlZCghdGhpcy4jaXNFbmFibGluZyk7CiAgICB0aGlzLiN1aU1hbmFnZXIuYWRkVG9Bbm5vdGF0aW9uU3RvcmFnZShlZGl0b3IpOwogICAgZWRpdG9yLl9yZXBvcnRUZWxlbWV0cnkoZWRpdG9yLnRlbGVtZXRyeUluaXRpYWxEYXRhKTsKICB9CiAgbW92ZUVkaXRvckluRE9NKGVkaXRvcikgewogICAgaWYgKCFlZGl0b3IuaXNBdHRhY2hlZFRvRE9NKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgYWN0aXZlRWxlbWVudAogICAgfSA9IGRvY3VtZW50OwogICAgaWYgKGVkaXRvci5kaXYuY29udGFpbnMoYWN0aXZlRWxlbWVudCkgJiYgIXRoaXMuI2VkaXRvckZvY3VzVGltZW91dElkKSB7CiAgICAgIGVkaXRvci5fZm9jdXNFdmVudHNBbGxvd2VkID0gZmFsc2U7CiAgICAgIHRoaXMuI2VkaXRvckZvY3VzVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdGhpcy4jZWRpdG9yRm9jdXNUaW1lb3V0SWQgPSBudWxsOwogICAgICAgIGlmICghZWRpdG9yLmRpdi5jb250YWlucyhkb2N1bWVudC5hY3RpdmVFbGVtZW50KSkgewogICAgICAgICAgZWRpdG9yLmRpdi5hZGRFdmVudExpc3RlbmVyKCJmb2N1c2luIiwgKCkgPT4gewogICAgICAgICAgICBlZGl0b3IuX2ZvY3VzRXZlbnRzQWxsb3dlZCA9IHRydWU7CiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIG9uY2U6IHRydWUsCiAgICAgICAgICAgIHNpZ25hbDogdGhpcy4jdWlNYW5hZ2VyLl9zaWduYWwKICAgICAgICAgIH0pOwogICAgICAgICAgYWN0aXZlRWxlbWVudC5mb2N1cygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlZGl0b3IuX2ZvY3VzRXZlbnRzQWxsb3dlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9LCAwKTsKICAgIH0KICAgIGVkaXRvci5fc3RydWN0VHJlZVBhcmVudElkID0gdGhpcy4jYWNjZXNzaWJpbGl0eU1hbmFnZXI/Lm1vdmVFbGVtZW50SW5ET00odGhpcy5kaXYsIGVkaXRvci5kaXYsIGVkaXRvci5jb250ZW50RGl2LCB0cnVlKTsKICB9CiAgYWRkT3JSZWJ1aWxkKGVkaXRvcikgewogICAgaWYgKGVkaXRvci5uZWVkc1RvQmVSZWJ1aWx0KCkpIHsKICAgICAgZWRpdG9yLnBhcmVudCB8fD0gdGhpczsKICAgICAgZWRpdG9yLnJlYnVpbGQoKTsKICAgICAgZWRpdG9yLnNob3coKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuYWRkKGVkaXRvcik7CiAgICB9CiAgfQogIGFkZFVuZG9hYmxlRWRpdG9yKGVkaXRvcikgewogICAgY29uc3QgY21kID0gKCkgPT4gZWRpdG9yLl91aU1hbmFnZXIucmVidWlsZChlZGl0b3IpOwogICAgY29uc3QgdW5kbyA9ICgpID0+IHsKICAgICAgZWRpdG9yLnJlbW92ZSgpOwogICAgfTsKICAgIHRoaXMuYWRkQ29tbWFuZHMoewogICAgICBjbWQsCiAgICAgIHVuZG8sCiAgICAgIG11c3RFeGVjOiBmYWxzZQogICAgfSk7CiAgfQogIGdldEVkaXRvckJ5VUlEKHVpZCkgewogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jZWRpdG9ycy52YWx1ZXMoKSkgewogICAgICBpZiAoZWRpdG9yLnVpZCA9PT0gdWlkKSB7CiAgICAgICAgcmV0dXJuIGVkaXRvcjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGdldE5leHRJZCgpIHsKICAgIHJldHVybiB0aGlzLiN1aU1hbmFnZXIuZ2V0SWQoKTsKICB9CiAgZ2V0ICNjdXJyZW50RWRpdG9yVHlwZSgpIHsKICAgIHJldHVybiBfQW5ub3RhdGlvbkVkaXRvckxheWVyLiNlZGl0b3JUeXBlcy5nZXQodGhpcy4jdWlNYW5hZ2VyLmdldE1vZGUoKSk7CiAgfQogIGNvbWJpbmVkU2lnbmFsKGFjKSB7CiAgICByZXR1cm4gdGhpcy4jdWlNYW5hZ2VyLmNvbWJpbmVkU2lnbmFsKGFjKTsKICB9CiAgI2NyZWF0ZU5ld0VkaXRvcihwYXJhbXMpIHsKICAgIGNvbnN0IGVkaXRvclR5cGUgPSB0aGlzLiNjdXJyZW50RWRpdG9yVHlwZTsKICAgIHJldHVybiBlZGl0b3JUeXBlID8gbmV3IGVkaXRvclR5cGUucHJvdG90eXBlLmNvbnN0cnVjdG9yKHBhcmFtcykgOiBudWxsOwogIH0KICBjYW5DcmVhdGVOZXdFbXB0eUVkaXRvcigpIHsKICAgIHJldHVybiB0aGlzLiNjdXJyZW50RWRpdG9yVHlwZT8uY2FuQ3JlYXRlTmV3RW1wdHlFZGl0b3IoKTsKICB9CiAgYXN5bmMgcGFzdGVFZGl0b3Iob3B0aW9ucywgcGFyYW1zKSB7CiAgICB0aGlzLnVwZGF0ZVRvb2xiYXIob3B0aW9ucyk7CiAgICBhd2FpdCB0aGlzLiN1aU1hbmFnZXIudXBkYXRlTW9kZShvcHRpb25zLm1vZGUpOwogICAgY29uc3QgewogICAgICBvZmZzZXRYLAogICAgICBvZmZzZXRZCiAgICB9ID0gdGhpcy4jZ2V0Q2VudGVyUG9pbnQoKTsKICAgIGNvbnN0IGlkID0gdGhpcy5nZXROZXh0SWQoKTsKICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuI2NyZWF0ZU5ld0VkaXRvcih7CiAgICAgIHBhcmVudDogdGhpcywKICAgICAgaWQsCiAgICAgIHg6IG9mZnNldFgsCiAgICAgIHk6IG9mZnNldFksCiAgICAgIHVpTWFuYWdlcjogdGhpcy4jdWlNYW5hZ2VyLAogICAgICBpc0NlbnRlcmVkOiB0cnVlLAogICAgICAuLi5wYXJhbXMKICAgIH0pOwogICAgaWYgKGVkaXRvcikgewogICAgICB0aGlzLmFkZChlZGl0b3IpOwogICAgfQogIH0KICBhc3luYyBkZXNlcmlhbGl6ZShkYXRhKSB7CiAgICByZXR1cm4gYXdhaXQgX0Fubm90YXRpb25FZGl0b3JMYXllci4jZWRpdG9yVHlwZXMuZ2V0KGRhdGEuYW5ub3RhdGlvblR5cGUgPz8gZGF0YS5hbm5vdGF0aW9uRWRpdG9yVHlwZSk/LmRlc2VyaWFsaXplKGRhdGEsIHRoaXMsIHRoaXMuI3VpTWFuYWdlcikgfHwgbnVsbDsKICB9CiAgY3JlYXRlQW5kQWRkTmV3RWRpdG9yKGV2ZW50LCBpc0NlbnRlcmVkLCBkYXRhID0ge30pIHsKICAgIGNvbnN0IGlkID0gdGhpcy5nZXROZXh0SWQoKTsKICAgIGNvbnN0IGVkaXRvciA9IHRoaXMuI2NyZWF0ZU5ld0VkaXRvcih7CiAgICAgIHBhcmVudDogdGhpcywKICAgICAgaWQsCiAgICAgIHg6IGV2ZW50Lm9mZnNldFgsCiAgICAgIHk6IGV2ZW50Lm9mZnNldFksCiAgICAgIHVpTWFuYWdlcjogdGhpcy4jdWlNYW5hZ2VyLAogICAgICBpc0NlbnRlcmVkLAogICAgICAuLi5kYXRhCiAgICB9KTsKICAgIGlmIChlZGl0b3IpIHsKICAgICAgdGhpcy5hZGQoZWRpdG9yKTsKICAgIH0KICAgIHJldHVybiBlZGl0b3I7CiAgfQogIGdldCBib3VuZGluZ0NsaWVudFJlY3QoKSB7CiAgICByZXR1cm4gdGhpcy5kaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgfQogICNnZXRDZW50ZXJQb2ludCgpIHsKICAgIGNvbnN0IHsKICAgICAgeCwKICAgICAgeSwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSA9IHRoaXMuYm91bmRpbmdDbGllbnRSZWN0OwogICAgY29uc3QgdGxYID0gTWF0aC5tYXgoMCwgeCk7CiAgICBjb25zdCB0bFkgPSBNYXRoLm1heCgwLCB5KTsKICAgIGNvbnN0IGJyWCA9IE1hdGgubWluKHdpbmRvdy5pbm5lcldpZHRoLCB4ICsgd2lkdGgpOwogICAgY29uc3QgYnJZID0gTWF0aC5taW4od2luZG93LmlubmVySGVpZ2h0LCB5ICsgaGVpZ2h0KTsKICAgIGNvbnN0IGNlbnRlclggPSAodGxYICsgYnJYKSAvIDIgLSB4OwogICAgY29uc3QgY2VudGVyWSA9ICh0bFkgKyBiclkpIC8gMiAtIHk7CiAgICBjb25zdCBbb2Zmc2V0WCwgb2Zmc2V0WV0gPSB0aGlzLnZpZXdwb3J0LnJvdGF0aW9uICUgMTgwID09PSAwID8gW2NlbnRlclgsIGNlbnRlclldIDogW2NlbnRlclksIGNlbnRlclhdOwogICAgcmV0dXJuIHsKICAgICAgb2Zmc2V0WCwKICAgICAgb2Zmc2V0WQogICAgfTsKICB9CiAgYWRkTmV3RWRpdG9yKGRhdGEgPSB7fSkgewogICAgdGhpcy5jcmVhdGVBbmRBZGROZXdFZGl0b3IodGhpcy4jZ2V0Q2VudGVyUG9pbnQoKSwgdHJ1ZSwgZGF0YSk7CiAgfQogIHNldFNlbGVjdGVkKGVkaXRvcikgewogICAgdGhpcy4jdWlNYW5hZ2VyLnNldFNlbGVjdGVkKGVkaXRvcik7CiAgfQogIHRvZ2dsZVNlbGVjdGVkKGVkaXRvcikgewogICAgdGhpcy4jdWlNYW5hZ2VyLnRvZ2dsZVNlbGVjdGVkKGVkaXRvcik7CiAgfQogIHVuc2VsZWN0KGVkaXRvcikgewogICAgdGhpcy4jdWlNYW5hZ2VyLnVuc2VsZWN0KGVkaXRvcik7CiAgfQogIHBvaW50ZXJ1cChldmVudCkgewogICAgY29uc3QgewogICAgICBpc01hYwogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICBpZiAoZXZlbnQuYnV0dG9uICE9PSAwIHx8IGV2ZW50LmN0cmxLZXkgJiYgaXNNYWMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gdGhpcy5kaXYpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCF0aGlzLiNoYWRQb2ludGVyRG93bikgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNoYWRQb2ludGVyRG93biA9IGZhbHNlOwogICAgaWYgKHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlPy5pc0RyYXdlciAmJiB0aGlzLiNjdXJyZW50RWRpdG9yVHlwZS5zdXBwb3J0TXVsdGlwbGVEcmF3aW5ncykgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoIXRoaXMuI2FsbG93Q2xpY2spIHsKICAgICAgdGhpcy4jYWxsb3dDbGljayA9IHRydWU7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGN1cnJlbnRNb2RlID0gdGhpcy4jdWlNYW5hZ2VyLmdldE1vZGUoKTsKICAgIGlmIChjdXJyZW50TW9kZSA9PT0gQW5ub3RhdGlvbkVkaXRvclR5cGUuU1RBTVAgfHwgY3VycmVudE1vZGUgPT09IEFubm90YXRpb25FZGl0b3JUeXBlLlNJR05BVFVSRSkgewogICAgICB0aGlzLiN1aU1hbmFnZXIudW5zZWxlY3RBbGwoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5jcmVhdGVBbmRBZGROZXdFZGl0b3IoZXZlbnQsIGZhbHNlKTsKICB9CiAgcG9pbnRlcmRvd24oZXZlbnQpIHsKICAgIGlmICh0aGlzLiN1aU1hbmFnZXIuZ2V0TW9kZSgpID09PSBBbm5vdGF0aW9uRWRpdG9yVHlwZS5ISUdITElHSFQpIHsKICAgICAgdGhpcy5lbmFibGVUZXh0U2VsZWN0aW9uKCk7CiAgICB9CiAgICBpZiAodGhpcy4jaGFkUG9pbnRlckRvd24pIHsKICAgICAgdGhpcy4jaGFkUG9pbnRlckRvd24gPSBmYWxzZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgewogICAgICBpc01hYwogICAgfSA9IHV0aWxfRmVhdHVyZVRlc3QucGxhdGZvcm07CiAgICBpZiAoZXZlbnQuYnV0dG9uICE9PSAwIHx8IGV2ZW50LmN0cmxLZXkgJiYgaXNNYWMpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gdGhpcy5kaXYpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy4jaGFkUG9pbnRlckRvd24gPSB0cnVlOwogICAgaWYgKHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlPy5pc0RyYXdlcikgewogICAgICB0aGlzLnN0YXJ0RHJhd2luZ1Nlc3Npb24oZXZlbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBlZGl0b3IgPSB0aGlzLiN1aU1hbmFnZXIuZ2V0QWN0aXZlKCk7CiAgICB0aGlzLiNhbGxvd0NsaWNrID0gIWVkaXRvciB8fCBlZGl0b3IuaXNFbXB0eSgpOwogIH0KICBzdGFydERyYXdpbmdTZXNzaW9uKGV2ZW50KSB7CiAgICB0aGlzLmRpdi5mb2N1cyh7CiAgICAgIHByZXZlbnRTY3JvbGw6IHRydWUKICAgIH0pOwogICAgaWYgKHRoaXMuI2RyYXdpbmdBQykgewogICAgICB0aGlzLiNjdXJyZW50RWRpdG9yVHlwZS5zdGFydERyYXdpbmcodGhpcywgdGhpcy4jdWlNYW5hZ2VyLCBmYWxzZSwgZXZlbnQpOwogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiN1aU1hbmFnZXIuc2V0Q3VycmVudERyYXdpbmdTZXNzaW9uKHRoaXMpOwogICAgdGhpcy4jZHJhd2luZ0FDID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgY29uc3Qgc2lnbmFsID0gdGhpcy4jdWlNYW5hZ2VyLmNvbWJpbmVkU2lnbmFsKHRoaXMuI2RyYXdpbmdBQyk7CiAgICB0aGlzLmRpdi5hZGRFdmVudExpc3RlbmVyKCJibHVyIiwgKHsKICAgICAgcmVsYXRlZFRhcmdldAogICAgfSkgPT4gewogICAgICBpZiAocmVsYXRlZFRhcmdldCAmJiAhdGhpcy5kaXYuY29udGFpbnMocmVsYXRlZFRhcmdldCkpIHsKICAgICAgICB0aGlzLiNmb2N1c2VkRWxlbWVudCA9IG51bGw7CiAgICAgICAgdGhpcy5jb21taXRPclJlbW92ZSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIHNpZ25hbAogICAgfSk7CiAgICB0aGlzLiNjdXJyZW50RWRpdG9yVHlwZS5zdGFydERyYXdpbmcodGhpcywgdGhpcy4jdWlNYW5hZ2VyLCBmYWxzZSwgZXZlbnQpOwogIH0KICBwYXVzZShvbikgewogICAgaWYgKG9uKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBhY3RpdmVFbGVtZW50CiAgICAgIH0gPSBkb2N1bWVudDsKICAgICAgaWYgKHRoaXMuZGl2LmNvbnRhaW5zKGFjdGl2ZUVsZW1lbnQpKSB7CiAgICAgICAgdGhpcy4jZm9jdXNlZEVsZW1lbnQgPSBhY3RpdmVFbGVtZW50OwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0aGlzLiNmb2N1c2VkRWxlbWVudCkgewogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB0aGlzLiNmb2N1c2VkRWxlbWVudD8uZm9jdXMoKTsKICAgICAgICB0aGlzLiNmb2N1c2VkRWxlbWVudCA9IG51bGw7CiAgICAgIH0sIDApOwogICAgfQogIH0KICBlbmREcmF3aW5nU2Vzc2lvbihpc0Fib3J0ZWQgPSBmYWxzZSkgewogICAgaWYgKCF0aGlzLiNkcmF3aW5nQUMpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB0aGlzLiN1aU1hbmFnZXIuc2V0Q3VycmVudERyYXdpbmdTZXNzaW9uKG51bGwpOwogICAgdGhpcy4jZHJhd2luZ0FDLmFib3J0KCk7CiAgICB0aGlzLiNkcmF3aW5nQUMgPSBudWxsOwogICAgdGhpcy4jZm9jdXNlZEVsZW1lbnQgPSBudWxsOwogICAgcmV0dXJuIHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlLmVuZERyYXdpbmcoaXNBYm9ydGVkKTsKICB9CiAgZmluZE5ld1BhcmVudChlZGl0b3IsIHgsIHkpIHsKICAgIGNvbnN0IGxheWVyID0gdGhpcy4jdWlNYW5hZ2VyLmZpbmRQYXJlbnQoeCwgeSk7CiAgICBpZiAobGF5ZXIgPT09IG51bGwgfHwgbGF5ZXIgPT09IHRoaXMpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgbGF5ZXIuY2hhbmdlUGFyZW50KGVkaXRvcik7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgY29tbWl0T3JSZW1vdmUoKSB7CiAgICBpZiAodGhpcy4jZHJhd2luZ0FDKSB7CiAgICAgIHRoaXMuZW5kRHJhd2luZ1Nlc3Npb24oKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIG9uU2NhbGVDaGFuZ2luZygpIHsKICAgIGlmICghdGhpcy4jZHJhd2luZ0FDKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuI2N1cnJlbnRFZGl0b3JUeXBlLm9uU2NhbGVDaGFuZ2luZ1doZW5EcmF3aW5nKHRoaXMpOwogIH0KICBkZXN0cm95KCkgewogICAgdGhpcy5jb21taXRPclJlbW92ZSgpOwogICAgaWYgKHRoaXMuI3VpTWFuYWdlci5nZXRBY3RpdmUoKT8ucGFyZW50ID09PSB0aGlzKSB7CiAgICAgIHRoaXMuI3VpTWFuYWdlci5jb21taXRPclJlbW92ZSgpOwogICAgICB0aGlzLiN1aU1hbmFnZXIuc2V0QWN0aXZlRWRpdG9yKG51bGwpOwogICAgfQogICAgaWYgKHRoaXMuI2VkaXRvckZvY3VzVGltZW91dElkKSB7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLiNlZGl0b3JGb2N1c1RpbWVvdXRJZCk7CiAgICAgIHRoaXMuI2VkaXRvckZvY3VzVGltZW91dElkID0gbnVsbDsKICAgIH0KICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIHRoaXMuI2VkaXRvcnMudmFsdWVzKCkpIHsKICAgICAgdGhpcy4jYWNjZXNzaWJpbGl0eU1hbmFnZXI/LnJlbW92ZVBvaW50ZXJJblRleHRMYXllcihlZGl0b3IuY29udGVudERpdik7CiAgICAgIGVkaXRvci5zZXRQYXJlbnQobnVsbCk7CiAgICAgIGVkaXRvci5pc0F0dGFjaGVkVG9ET00gPSBmYWxzZTsKICAgICAgZWRpdG9yLmRpdi5yZW1vdmUoKTsKICAgIH0KICAgIHRoaXMuZGl2ID0gbnVsbDsKICAgIHRoaXMuI2VkaXRvcnMuY2xlYXIoKTsKICAgIHRoaXMuI3VpTWFuYWdlci5yZW1vdmVMYXllcih0aGlzKTsKICB9CiAgI2NsZWFudXAoKSB7CiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiB0aGlzLiNlZGl0b3JzLnZhbHVlcygpKSB7CiAgICAgIGlmIChlZGl0b3IuaXNFbXB0eSgpKSB7CiAgICAgICAgZWRpdG9yLnJlbW92ZSgpOwogICAgICB9CiAgICB9CiAgfQogIHJlbmRlcih7CiAgICB2aWV3cG9ydAogIH0pIHsKICAgIHRoaXMudmlld3BvcnQgPSB2aWV3cG9ydDsKICAgIHNldExheWVyRGltZW5zaW9ucyh0aGlzLmRpdiwgdmlld3BvcnQpOwogICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jdWlNYW5hZ2VyLmdldEVkaXRvcnModGhpcy5wYWdlSW5kZXgpKSB7CiAgICAgIHRoaXMuYWRkKGVkaXRvcik7CiAgICAgIGVkaXRvci5yZWJ1aWxkKCk7CiAgICB9CiAgICB0aGlzLnVwZGF0ZU1vZGUoKTsKICB9CiAgdXBkYXRlKHsKICAgIHZpZXdwb3J0CiAgfSkgewogICAgdGhpcy4jdWlNYW5hZ2VyLmNvbW1pdE9yUmVtb3ZlKCk7CiAgICB0aGlzLiNjbGVhbnVwKCk7CiAgICBjb25zdCBvbGRSb3RhdGlvbiA9IHRoaXMudmlld3BvcnQucm90YXRpb247CiAgICBjb25zdCByb3RhdGlvbiA9IHZpZXdwb3J0LnJvdGF0aW9uOwogICAgdGhpcy52aWV3cG9ydCA9IHZpZXdwb3J0OwogICAgc2V0TGF5ZXJEaW1lbnNpb25zKHRoaXMuZGl2LCB7CiAgICAgIHJvdGF0aW9uCiAgICB9KTsKICAgIGlmIChvbGRSb3RhdGlvbiAhPT0gcm90YXRpb24pIHsKICAgICAgZm9yIChjb25zdCBlZGl0b3Igb2YgdGhpcy4jZWRpdG9ycy52YWx1ZXMoKSkgewogICAgICAgIGVkaXRvci5yb3RhdGUocm90YXRpb24pOwogICAgICB9CiAgICB9CiAgfQogIGdldCBwYWdlRGltZW5zaW9ucygpIHsKICAgIGNvbnN0IHsKICAgICAgcGFnZVdpZHRoLAogICAgICBwYWdlSGVpZ2h0CiAgICB9ID0gdGhpcy52aWV3cG9ydC5yYXdEaW1zOwogICAgcmV0dXJuIFtwYWdlV2lkdGgsIHBhZ2VIZWlnaHRdOwogIH0KICBnZXQgc2NhbGUoKSB7CiAgICByZXR1cm4gdGhpcy4jdWlNYW5hZ2VyLnZpZXdQYXJhbWV0ZXJzLnJlYWxTY2FsZTsKICB9Cn07CnZhciBEcmF3TGF5ZXIgPSBjbGFzcyBfRHJhd0xheWVyIHsKICAjcGFyZW50ID0gbnVsbDsKICAjbWFwcGluZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgI3RvVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBzdGF0aWMgI2lkID0gMDsKICBjb25zdHJ1Y3Rvcih7CiAgICBwYWdlSW5kZXgKICB9KSB7CiAgICB0aGlzLnBhZ2VJbmRleCA9IHBhZ2VJbmRleDsKICB9CiAgc2V0UGFyZW50KHBhcmVudCkgewogICAgaWYgKCF0aGlzLiNwYXJlbnQpIHsKICAgICAgdGhpcy4jcGFyZW50ID0gcGFyZW50OwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy4jcGFyZW50ICE9PSBwYXJlbnQpIHsKICAgICAgaWYgKHRoaXMuI21hcHBpbmcuc2l6ZSA+IDApIHsKICAgICAgICBmb3IgKGNvbnN0IHJvb3QyIG9mIHRoaXMuI21hcHBpbmcudmFsdWVzKCkpIHsKICAgICAgICAgIHJvb3QyLnJlbW92ZSgpOwogICAgICAgICAgcGFyZW50LmFwcGVuZChyb290Mik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuI3BhcmVudCA9IHBhcmVudDsKICAgIH0KICB9CiAgc3RhdGljIGdldCBfc3ZnRmFjdG9yeSgpIHsKICAgIHJldHVybiBzaGFkb3codGhpcywgIl9zdmdGYWN0b3J5IiwgbmV3IERPTVNWR0ZhY3RvcnkoKSk7CiAgfQogIHN0YXRpYyAjc2V0Qm94KGVsZW1lbnQsIFt4LCB5LCB3aWR0aCwgaGVpZ2h0XSkgewogICAgY29uc3QgewogICAgICBzdHlsZQogICAgfSA9IGVsZW1lbnQ7CiAgICBzdHlsZS50b3AgPSBgJHsxMDAgKiB5fSVgOwogICAgc3R5bGUubGVmdCA9IGAkezEwMCAqIHh9JWA7CiAgICBzdHlsZS53aWR0aCA9IGAkezEwMCAqIHdpZHRofSVgOwogICAgc3R5bGUuaGVpZ2h0ID0gYCR7MTAwICogaGVpZ2h0fSVgOwogIH0KICAjY3JlYXRlU1ZHKCkgewogICAgY29uc3Qgc3ZnID0gX0RyYXdMYXllci5fc3ZnRmFjdG9yeS5jcmVhdGUoMSwgMSwgdHJ1ZSk7CiAgICB0aGlzLiNwYXJlbnQuYXBwZW5kKHN2Zyk7CiAgICBzdmcuc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsIHRydWUpOwogICAgcmV0dXJuIHN2ZzsKICB9CiAgI2NyZWF0ZUNsaXBQYXRoKGRlZnMsIHBhdGhJZCkgewogICAgY29uc3QgY2xpcFBhdGggPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIik7CiAgICBkZWZzLmFwcGVuZChjbGlwUGF0aCk7CiAgICBjb25zdCBjbGlwUGF0aElkID0gYGNsaXBfJHtwYXRoSWR9YDsKICAgIGNsaXBQYXRoLnNldEF0dHJpYnV0ZSgiaWQiLCBjbGlwUGF0aElkKTsKICAgIGNsaXBQYXRoLnNldEF0dHJpYnV0ZSgiY2xpcFBhdGhVbml0cyIsICJvYmplY3RCb3VuZGluZ0JveCIpOwogICAgY29uc3QgY2xpcFBhdGhVc2UgPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInVzZSIpOwogICAgY2xpcFBhdGguYXBwZW5kKGNsaXBQYXRoVXNlKTsKICAgIGNsaXBQYXRoVXNlLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGAjJHtwYXRoSWR9YCk7CiAgICBjbGlwUGF0aFVzZS5jbGFzc0xpc3QuYWRkKCJjbGlwIik7CiAgICByZXR1cm4gY2xpcFBhdGhJZDsKICB9CiAgI3VwZGF0ZVByb3BlcnRpZXMoZWxlbWVudCwgcHJvcGVydGllcykgewogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMocHJvcGVydGllcykpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShrZXksIHZhbHVlKTsKICAgICAgfQogICAgfQogIH0KICBkcmF3KHByb3BlcnRpZXMsIGlzUGF0aFVwZGF0YWJsZSA9IGZhbHNlLCBoYXNDbGlwID0gZmFsc2UpIHsKICAgIGNvbnN0IGlkID0gX0RyYXdMYXllci4jaWQrKzsKICAgIGNvbnN0IHJvb3QyID0gdGhpcy4jY3JlYXRlU1ZHKCk7CiAgICBjb25zdCBkZWZzID0gX0RyYXdMYXllci5fc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJkZWZzIik7CiAgICByb290Mi5hcHBlbmQoZGVmcyk7CiAgICBjb25zdCBwYXRoID0gX0RyYXdMYXllci5fc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJwYXRoIik7CiAgICBkZWZzLmFwcGVuZChwYXRoKTsKICAgIGNvbnN0IHBhdGhJZCA9IGBwYXRoX3Ake3RoaXMucGFnZUluZGV4fV8ke2lkfWA7CiAgICBwYXRoLnNldEF0dHJpYnV0ZSgiaWQiLCBwYXRoSWQpOwogICAgcGF0aC5zZXRBdHRyaWJ1dGUoInZlY3Rvci1lZmZlY3QiLCAibm9uLXNjYWxpbmctc3Ryb2tlIik7CiAgICBpZiAoaXNQYXRoVXBkYXRhYmxlKSB7CiAgICAgIHRoaXMuI3RvVXBkYXRlLnNldChpZCwgcGF0aCk7CiAgICB9CiAgICBjb25zdCBjbGlwUGF0aElkID0gaGFzQ2xpcCA/IHRoaXMuI2NyZWF0ZUNsaXBQYXRoKGRlZnMsIHBhdGhJZCkgOiBudWxsOwogICAgY29uc3QgdXNlID0gX0RyYXdMYXllci5fc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJ1c2UiKTsKICAgIHJvb3QyLmFwcGVuZCh1c2UpOwogICAgdXNlLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGAjJHtwYXRoSWR9YCk7CiAgICB0aGlzLnVwZGF0ZVByb3BlcnRpZXMocm9vdDIsIHByb3BlcnRpZXMpOwogICAgdGhpcy4jbWFwcGluZy5zZXQoaWQsIHJvb3QyKTsKICAgIHJldHVybiB7CiAgICAgIGlkLAogICAgICBjbGlwUGF0aElkOiBgdXJsKCMke2NsaXBQYXRoSWR9KWAKICAgIH07CiAgfQogIGRyYXdPdXRsaW5lKHByb3BlcnRpZXMsIG11c3RSZW1vdmVTZWxmSW50ZXJzZWN0aW9ucykgewogICAgY29uc3QgaWQgPSBfRHJhd0xheWVyLiNpZCsrOwogICAgY29uc3Qgcm9vdDIgPSB0aGlzLiNjcmVhdGVTVkcoKTsKICAgIGNvbnN0IGRlZnMgPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoImRlZnMiKTsKICAgIHJvb3QyLmFwcGVuZChkZWZzKTsKICAgIGNvbnN0IHBhdGggPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoInBhdGgiKTsKICAgIGRlZnMuYXBwZW5kKHBhdGgpOwogICAgY29uc3QgcGF0aElkID0gYHBhdGhfcCR7dGhpcy5wYWdlSW5kZXh9XyR7aWR9YDsKICAgIHBhdGguc2V0QXR0cmlidXRlKCJpZCIsIHBhdGhJZCk7CiAgICBwYXRoLnNldEF0dHJpYnV0ZSgidmVjdG9yLWVmZmVjdCIsICJub24tc2NhbGluZy1zdHJva2UiKTsKICAgIGxldCBtYXNrSWQ7CiAgICBpZiAobXVzdFJlbW92ZVNlbGZJbnRlcnNlY3Rpb25zKSB7CiAgICAgIGNvbnN0IG1hc2sgPSBfRHJhd0xheWVyLl9zdmdGYWN0b3J5LmNyZWF0ZUVsZW1lbnQoIm1hc2siKTsKICAgICAgZGVmcy5hcHBlbmQobWFzayk7CiAgICAgIG1hc2tJZCA9IGBtYXNrX3Ake3RoaXMucGFnZUluZGV4fV8ke2lkfWA7CiAgICAgIG1hc2suc2V0QXR0cmlidXRlKCJpZCIsIG1hc2tJZCk7CiAgICAgIG1hc2suc2V0QXR0cmlidXRlKCJtYXNrVW5pdHMiLCAib2JqZWN0Qm91bmRpbmdCb3giKTsKICAgICAgY29uc3QgcmVjdCA9IF9EcmF3TGF5ZXIuX3N2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgicmVjdCIpOwogICAgICBtYXNrLmFwcGVuZChyZWN0KTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoIndpZHRoIiwgIjEiKTsKICAgICAgcmVjdC5zZXRBdHRyaWJ1dGUoImhlaWdodCIsICIxIik7CiAgICAgIHJlY3Quc2V0QXR0cmlidXRlKCJmaWxsIiwgIndoaXRlIik7CiAgICAgIGNvbnN0IHVzZSA9IF9EcmF3TGF5ZXIuX3N2Z0ZhY3RvcnkuY3JlYXRlRWxlbWVudCgidXNlIik7CiAgICAgIG1hc2suYXBwZW5kKHVzZSk7CiAgICAgIHVzZS5zZXRBdHRyaWJ1dGUoImhyZWYiLCBgIyR7cGF0aElkfWApOwogICAgICB1c2Uuc2V0QXR0cmlidXRlKCJzdHJva2UiLCAibm9uZSIpOwogICAgICB1c2Uuc2V0QXR0cmlidXRlKCJmaWxsIiwgImJsYWNrIik7CiAgICAgIHVzZS5zZXRBdHRyaWJ1dGUoImZpbGwtcnVsZSIsICJub256ZXJvIik7CiAgICAgIHVzZS5jbGFzc0xpc3QuYWRkKCJtYXNrIik7CiAgICB9CiAgICBjb25zdCB1c2UxID0gX0RyYXdMYXllci5fc3ZnRmFjdG9yeS5jcmVhdGVFbGVtZW50KCJ1c2UiKTsKICAgIHJvb3QyLmFwcGVuZCh1c2UxKTsKICAgIHVzZTEuc2V0QXR0cmlidXRlKCJocmVmIiwgYCMke3BhdGhJZH1gKTsKICAgIGlmIChtYXNrSWQpIHsKICAgICAgdXNlMS5zZXRBdHRyaWJ1dGUoIm1hc2siLCBgdXJsKCMke21hc2tJZH0pYCk7CiAgICB9CiAgICBjb25zdCB1c2UyID0gdXNlMS5jbG9uZU5vZGUoKTsKICAgIHJvb3QyLmFwcGVuZCh1c2UyKTsKICAgIHVzZTEuY2xhc3NMaXN0LmFkZCgibWFpbk91dGxpbmUiKTsKICAgIHVzZTIuY2xhc3NMaXN0LmFkZCgic2Vjb25kYXJ5T3V0bGluZSIpOwogICAgdGhpcy51cGRhdGVQcm9wZXJ0aWVzKHJvb3QyLCBwcm9wZXJ0aWVzKTsKICAgIHRoaXMuI21hcHBpbmcuc2V0KGlkLCByb290Mik7CiAgICByZXR1cm4gaWQ7CiAgfQogIGZpbmFsaXplRHJhdyhpZCwgcHJvcGVydGllcykgewogICAgdGhpcy4jdG9VcGRhdGUuZGVsZXRlKGlkKTsKICAgIHRoaXMudXBkYXRlUHJvcGVydGllcyhpZCwgcHJvcGVydGllcyk7CiAgfQogIHVwZGF0ZVByb3BlcnRpZXMoZWxlbWVudE9ySWQsIHByb3BlcnRpZXMpIHsKICAgIGlmICghcHJvcGVydGllcykgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB7CiAgICAgIHJvb3Q6IHJvb3QyLAogICAgICBiYm94LAogICAgICByb290Q2xhc3MsCiAgICAgIHBhdGgKICAgIH0gPSBwcm9wZXJ0aWVzOwogICAgY29uc3QgZWxlbWVudCA9IHR5cGVvZiBlbGVtZW50T3JJZCA9PT0gIm51bWJlciIgPyB0aGlzLiNtYXBwaW5nLmdldChlbGVtZW50T3JJZCkgOiBlbGVtZW50T3JJZDsKICAgIGlmICghZWxlbWVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocm9vdDIpIHsKICAgICAgdGhpcy4jdXBkYXRlUHJvcGVydGllcyhlbGVtZW50LCByb290Mik7CiAgICB9CiAgICBpZiAoYmJveCkgewogICAgICBfRHJhd0xheWVyLiNzZXRCb3goZWxlbWVudCwgYmJveCk7CiAgICB9CiAgICBpZiAocm9vdENsYXNzKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBjbGFzc0xpc3QKICAgICAgfSA9IGVsZW1lbnQ7CiAgICAgIGZvciAoY29uc3QgW2NsYXNzTmFtZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHJvb3RDbGFzcykpIHsKICAgICAgICBjbGFzc0xpc3QudG9nZ2xlKGNsYXNzTmFtZSwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgICBpZiAocGF0aCkgewogICAgICBjb25zdCBkZWZzID0gZWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgY29uc3QgcGF0aEVsZW1lbnQgPSBkZWZzLmZpcnN0RWxlbWVudENoaWxkOwogICAgICB0aGlzLiN1cGRhdGVQcm9wZXJ0aWVzKHBhdGhFbGVtZW50LCBwYXRoKTsKICAgIH0KICB9CiAgdXBkYXRlUGFyZW50KGlkLCBsYXllcikgewogICAgaWYgKGxheWVyID09PSB0aGlzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHJvb3QyID0gdGhpcy4jbWFwcGluZy5nZXQoaWQpOwogICAgaWYgKCFyb290MikgewogICAgICByZXR1cm47CiAgICB9CiAgICBsYXllci4jcGFyZW50LmFwcGVuZChyb290Mik7CiAgICB0aGlzLiNtYXBwaW5nLmRlbGV0ZShpZCk7CiAgICBsYXllci4jbWFwcGluZy5zZXQoaWQsIHJvb3QyKTsKICB9CiAgcmVtb3ZlKGlkKSB7CiAgICB0aGlzLiN0b1VwZGF0ZS5kZWxldGUoaWQpOwogICAgaWYgKHRoaXMuI3BhcmVudCA9PT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLiNtYXBwaW5nLmdldChpZCkucmVtb3ZlKCk7CiAgICB0aGlzLiNtYXBwaW5nLmRlbGV0ZShpZCk7CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLiNwYXJlbnQgPSBudWxsOwogICAgZm9yIChjb25zdCByb290MiBvZiB0aGlzLiNtYXBwaW5nLnZhbHVlcygpKSB7CiAgICAgIHJvb3QyLnJlbW92ZSgpOwogICAgfQogICAgdGhpcy4jbWFwcGluZy5jbGVhcigpOwogICAgdGhpcy4jdG9VcGRhdGUuY2xlYXIoKTsKICB9Cn07CnsKICBnbG9iYWxUaGlzLl9wZGZqc1Rlc3RpbmdVdGlscyA9IHsKICAgIEhpZ2hsaWdodE91dGxpbmVyCiAgfTsKfQpnbG9iYWxUaGlzLnBkZmpzTGliID0gewogIEFib3J0RXhjZXB0aW9uLAogIEFubm90YXRpb25FZGl0b3JMYXllciwKICBBbm5vdGF0aW9uRWRpdG9yUGFyYW1zVHlwZSwKICBBbm5vdGF0aW9uRWRpdG9yVHlwZSwKICBBbm5vdGF0aW9uRWRpdG9yVUlNYW5hZ2VyLAogIEFubm90YXRpb25MYXllciwKICBBbm5vdGF0aW9uTW9kZSwKICBBbm5vdGF0aW9uVHlwZSwKICBhcHBseU9wYWNpdHksCiAgYnVpbGQsCiAgQ29sb3JQaWNrZXIsCiAgY3JlYXRlVmFsaWRBYnNvbHV0ZVVybCwKICBDU1NDb25zdGFudHMsCiAgRE9NU1ZHRmFjdG9yeSwKICBEcmF3TGF5ZXIsCiAgRmVhdHVyZVRlc3Q6IHV0aWxfRmVhdHVyZVRlc3QsCiAgZmV0Y2hEYXRhLAogIGZpbmRDb250cmFzdENvbG9yLAogIGdldERvY3VtZW50LAogIGdldEZpbGVuYW1lRnJvbVVybCwKICBnZXRQZGZGaWxlbmFtZUZyb21VcmwsCiAgZ2V0UkdCLAogIGdldFV1aWQsCiAgZ2V0WGZhUGFnZVZpZXdwb3J0LAogIEdsb2JhbFdvcmtlck9wdGlvbnMsCiAgSW1hZ2VLaW5kOiB1dGlsX0ltYWdlS2luZCwKICBJbnZhbGlkUERGRXhjZXB0aW9uLAogIGlzRGF0YVNjaGVtZSwKICBpc1BkZkZpbGUsCiAgaXNWYWxpZEV4cGxpY2l0RGVzdCwKICBNYXRoQ2xhbXAsCiAgbm9Db250ZXh0TWVudSwKICBub3JtYWxpemVVbmljb2RlLAogIE9QUywKICBPdXRwdXRTY2FsZSwKICBQYXNzd29yZFJlc3BvbnNlcywKICBQREZEYXRhUmFuZ2VUcmFuc3BvcnQsCiAgUERGRGF0ZVN0cmluZywKICBQREZXb3JrZXIsCiAgUGVybWlzc2lvbkZsYWcsCiAgUGl4ZWxzUGVySW5jaCwKICBSZW5kZXJpbmdDYW5jZWxsZWRFeGNlcHRpb24sCiAgcmVuZGVyUmljaFRleHQsCiAgUmVzcG9uc2VFeGNlcHRpb24sCiAgc2V0TGF5ZXJEaW1lbnNpb25zLAogIHNoYWRvdywKICBTaWduYXR1cmVFeHRyYWN0b3IsCiAgc3RvcEV2ZW50LAogIFN1cHBvcnRlZEltYWdlTWltZVR5cGVzLAogIFRleHRMYXllciwKICBUb3VjaE1hbmFnZXIsCiAgdXBkYXRlVXJsSGFzaCwKICBVdGlsLAogIFZlcmJvc2l0eUxldmVsLAogIHZlcnNpb24sCiAgWGZhTGF5ZXIKfTsKCi8vIHNyYy9kYXRhL3N1YnNjcmlwdGlvbnMudHMKdmFyIFNVQlNDUklQVElPTl9QQVRURVJOUyA9IHsKICAvLyA9PT0gU1RSRUFNSU5HIFZJREVPICYgVFYgPT09CiAgbmV0ZmxpeDogeyByZWdleDogL25ldGZsaXgvaSwgbmFtZTogIk5ldGZsaXgiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uZXRmbGl4LmNvbSIgfSwKICBodWx1OiB7IHJlZ2V4OiAvaHVsdS9pLCBuYW1lOiAiSHVsdSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2h1bHUuY29tIiB9LAogIGRpc25leV9wbHVzOiB7IHJlZ2V4OiAvZGlzbmV5XCt8ZGlzbmV5IHBsdXMvaSwgbmFtZTogIkRpc25leSsiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kaXNuZXlwbHVzLmNvbSIgfSwKICBoYm9fbWF4OiB7IHJlZ2V4OiAvaGJvIG1heHxoYm9tYXh8bWF4XC5jb20vaSwgbmFtZTogIk1heCAoSEJPKSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21heC5jb20iIH0sCiAgYW1hem9uX3ByaW1lX3ZpZGVvOiB7IHJlZ2V4OiAvcHJpbWUgdmlkZW8vaSwgbmFtZTogIlByaW1lIFZpZGVvIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcHJpbWV2aWRlby5jb20iIH0sCiAgeW91dHViZV9wcmVtaXVtOiB7IHJlZ2V4OiAveW91dHViZSBkaXN0aW5jdHxnb29nbGUgXCp5b3V0dWJlL2ksIG5hbWU6ICJZb3VUdWJlIFByZW1pdW0iLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS95b3V0dWJlLmNvbSIgfSwKICBhcHBsZV90djogeyByZWdleDogL2FwcGxlXC5jb21cL2JpbGx8YXBwbGUgdHYvaSwgbmFtZTogIkFwcGxlIFRWKyIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2FwcGxlLmNvbSIgfSwKICBwZWFjb2NrOiB7IHJlZ2V4OiAvcGVhY29jay9pLCBuYW1lOiAiUGVhY29jayBUViIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BlYWNvY2t0di5jb20iIH0sCiAgcGFyYW1vdW50X3BsdXM6IHsgcmVnZXg6IC9wYXJhbW91bnRcK3xjYnMgaW50ZXJhY3RpdmUvaSwgbmFtZTogIlBhcmFtb3VudCsiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9wYXJhbW91bnRwbHVzLmNvbSIgfSwKICBzbGluZ190djogeyByZWdleDogL3NsaW5nIHR2fHNsaW5nXC5jb20vaSwgbmFtZTogIlNsaW5nIFRWIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc2xpbmcuY29tIiB9LAogIGZ1Ym9fdHY6IHsgcmVnZXg6IC9mdWJvL2ksIG5hbWU6ICJGdWJvVFYiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9mdWJvLnR2IiB9LAogIGRpc2NvdmVyeV9wbHVzOiB7IHJlZ2V4OiAvZGlzY292ZXJ5XCt8ZGlzY292ZXJ5IHBsdXMvaSwgbmFtZTogIkRpc2NvdmVyeSsiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kaXNjb3ZlcnlwbHVzLmNvbSIgfSwKICBjcnVuY2h5cm9sbDogeyByZWdleDogL2NydW5jaHlyb2xsL2ksIG5hbWU6ICJDcnVuY2h5cm9sbCIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NydW5jaHlyb2xsLmNvbSIgfSwKICBmdW5pbWF0aW9uOiB7IHJlZ2V4OiAvZnVuaW1hdGlvbi9pLCBuYW1lOiAiRnVuaW1hdGlvbiIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Z1bmltYXRpb24uY29tIiB9LAogIGVzcG5fcGx1czogeyByZWdleDogL2VzcG5cK3xlc3BuIG1hZ2F6aW5lL2ksIG5hbWU6ICJFU1BOKyIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BsdXMuZXNwbi5jb20iIH0sCiAgZGF6bjogeyByZWdleDogL2Rhem4vaSwgbmFtZTogIkRBWk4iLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kYXpuLmNvbSIgfSwKICBzdGFyejogeyByZWdleDogL3N0YXJ6L2ksIG5hbWU6ICJTdGFyeiIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3N0YXJ6LmNvbSIgfSwKICBzaG93dGltZTogeyByZWdleDogL3Nob3d0aW1lL2ksIG5hbWU6ICJTaG93dGltZSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Noby5jb20iIH0sCiAgYnJpdGJveDogeyByZWdleDogL2JyaXRib3gvaSwgbmFtZTogIkJyaXRCb3giLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9icml0Ym94LmNvbSIgfSwKICBhY29ybl90djogeyByZWdleDogL2Fjb3JuIHR2L2ksIG5hbWU6ICJBY29ybiBUViIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Fjb3JuLnR2IiB9LAogIHBoaWxfdHY6IHsgcmVnZXg6IC9waGlsby9pLCBuYW1lOiAiUGhpbG8iLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9waGlsby5jb20iIH0sCiAgdmlraTogeyByZWdleDogL3Zpa2kvaSwgbmFtZTogIlJha3V0ZW4gVmlraSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Zpa2kuY29tIiB9LAogIHR1Ymk6IHsgcmVnZXg6IC90dWJpL2ksIG5hbWU6ICJUdWJpIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdHViaXR2LmNvbSIgfSwKICBwbHV0b190djogeyByZWdleDogL3BsdXRvIHR2L2ksIG5hbWU6ICJQbHV0byBUViIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BsdXRvLnR2IiB9LAogIHBsZXg6IHsgcmVnZXg6IC9wbGV4L2ksIG5hbWU6ICJQbGV4IiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGxleC50diIgfSwKICBjdXJpb3NpdHlfc3RyZWFtOiB7IHJlZ2V4OiAvY3VyaW9zaXR5c3RyZWFtL2ksIG5hbWU6ICJDdXJpb3NpdHlTdHJlYW0iLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jdXJpb3NpdHlzdHJlYW0uY29tIiB9LAogIG5lYnVsYTogeyByZWdleDogL25lYnVsYS9pLCBuYW1lOiAiTmVidWxhIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbmVidWxhLmFwcCIgfSwKICBmbG9hdHBsYW5lOiB7IHJlZ2V4OiAvZmxvYXRwbGFuZS9pLCBuYW1lOiAiRmxvYXRwbGFuZSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Zsb2F0cGxhbmUuY29tIiB9LAogIG11Ymk6IHsgcmVnZXg6IC9tdWJpL2ksIG5hbWU6ICJNVUJJIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbXViaS5jb20iIH0sCiAgY3JpdGVyaW9uOiB7IHJlZ2V4OiAvY3JpdGVyaW9uIGNoYW5uZWwvaSwgbmFtZTogIkNyaXRlcmlvbiBDaGFubmVsIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY3JpdGVyaW9uY2hhbm5lbC5jb20iIH0sCiAgc2h1ZGRlcjogeyByZWdleDogL3NodWRkZXIvaSwgbmFtZTogIlNodWRkZXIiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zaHVkZGVyLmNvbSIgfSwKICBhbWNfcGx1czogeyByZWdleDogL2FtY1wrL2ksIG5hbWU6ICJBTUMrIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYW1jcGx1cy5jb20iIH0sCiAgYmV0X3BsdXM6IHsgcmVnZXg6IC9iZXRcKy9pLCBuYW1lOiAiQkVUKyIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2JldC5wbHVzIiB9LAogIGFsbGJsazogeyByZWdleDogL2FsbGJsay9pLCBuYW1lOiAiQUxMQkxLIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYWxsYmxrLnR2IiB9LAogIGhvb3BsYTogeyByZWdleDogL2hvb3BsYS9pLCBuYW1lOiAiSG9vcGxhIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaG9vcGxhZGlnaXRhbC5jb20iIH0sCiAga2Fub3B5OiB7IHJlZ2V4OiAva2Fub3B5L2ksIG5hbWU6ICJLYW5vcHkiLCBjYXRlZ29yeTogIkVudGVydGFpbm1lbnQiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9rYW5vcHkuY29tIiB9LAogIHJlZGJveDogeyByZWdleDogL3JlZGJveC9pLCBuYW1lOiAiUmVkYm94IiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcmVkYm94LmNvbSIgfSwKICB2dWR1OiB7IHJlZ2V4OiAvdnVkdS9pLCBuYW1lOiAiVnVkdSIsIGNhdGVnb3J5OiAiRW50ZXJ0YWlubWVudCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Z1ZHUuY29tIiB9LAogIGdvb2dsZV9wbGF5X21vdmllczogeyByZWdleDogL2dvb2dsZSBwbGF5IG1vdmllcy9pLCBuYW1lOiAiR29vZ2xlIFBsYXkgTW92aWVzIiwgY2F0ZWdvcnk6ICJFbnRlcnRhaW5tZW50IiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcGxheS5nb29nbGUuY29tIiB9LAogIC8vID09PSBNVVNJQyAmIEFVRElPID09PQogIHNwb3RpZnk6IHsgcmVnZXg6IC9zcG90aWZ5L2ksIG5hbWU6ICJTcG90aWZ5IiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Nwb3RpZnkuY29tIiB9LAogIGFwcGxlX211c2ljOiB7IHJlZ2V4OiAvYXBwbGVcLmNvbVwvYmlsbHxhcHBsZSBtdXNpYy9pLCBuYW1lOiAiQXBwbGUgTXVzaWMiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbXVzaWMuYXBwbGUuY29tIiB9LAogIGFtYXpvbl9tdXNpYzogeyByZWdleDogL2FtYXpvbiBtdXNpY3xhbXpuIG11c2ljL2ksIG5hbWU6ICJBbWF6b24gTXVzaWMiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbXVzaWMuYW1hem9uLmNvbSIgfSwKICBwYW5kb3JhOiB7IHJlZ2V4OiAvcGFuZG9yYS9pLCBuYW1lOiAiUGFuZG9yYSIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9wYW5kb3JhLmNvbSIgfSwKICB0aWRhbDogeyByZWdleDogL3RpZGFsL2ksIG5hbWU6ICJUaWRhbCIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90aWRhbC5jb20iIH0sCiAgc291bmRjbG91ZDogeyByZWdleDogL3NvdW5kY2xvdWQvaSwgbmFtZTogIlNvdW5kQ2xvdWQiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc291bmRjbG91ZC5jb20iIH0sCiAgZGVlemVyOiB7IHJlZ2V4OiAvZGVlemVyL2ksIG5hbWU6ICJEZWV6ZXIiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZGVlemVyLmNvbSIgfSwKICBzaXJpdXN4bTogeyByZWdleDogL3Npcml1c3htfHN4bS9pLCBuYW1lOiAiU2lyaXVzWE0iLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc2lyaXVzeG0uY29tIiB9LAogIGF1ZGlibGU6IHsgcmVnZXg6IC9hdWRpYmxlL2ksIG5hbWU6ICJBdWRpYmxlIiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2F1ZGlibGUuY29tIiB9LAogIGloZWFydHJhZGlvOiB7IHJlZ2V4OiAvaWhlYXJ0cmFkaW8vaSwgbmFtZTogImlIZWFydFJhZGlvIiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2loZWFydC5jb20iIH0sCiAgdHVuZWluOiB7IHJlZ2V4OiAvdHVuZWluL2ksIG5hbWU6ICJUdW5lSW4iLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdHVuZWluLmNvbSIgfSwKICBxb2J1ejogeyByZWdleDogL3FvYnV6L2ksIG5hbWU6ICJRb2J1eiIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9xb2J1ei5jb20iIH0sCiAgbmFwc3RlcjogeyByZWdleDogL25hcHN0ZXIvaSwgbmFtZTogIk5hcHN0ZXIiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbmFwc3Rlci5jb20iIH0sCiAgYmFuZGNhbXA6IHsgcmVnZXg6IC9iYW5kY2FtcC9pLCBuYW1lOiAiQmFuZGNhbXAiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYmFuZGNhbXAuY29tIiB9LAogIGxhc3RmbTogeyByZWdleDogL2xhc3RcLmZtL2ksIG5hbWU6ICJMYXN0LmZtIiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2xhc3QuZm0iIH0sCiAgc3BsaWNlOiB7IHJlZ2V4OiAvc3BsaWNlL2ksIG5hbWU6ICJTcGxpY2UiLCBjYXRlZ29yeTogIk11c2ljIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3BsaWNlLmNvbSIgfSwKICBlcGlkZW1pY19zb3VuZDogeyByZWdleDogL2VwaWRlbWljIHNvdW5kL2ksIG5hbWU6ICJFcGlkZW1pYyBTb3VuZCIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9lcGlkZW1pY3NvdW5kLmNvbSIgfSwKICBhcnRsaXN0OiB7IHJlZ2V4OiAvYXJ0bGlzdC9pLCBuYW1lOiAiQXJ0bGlzdCIsIGNhdGVnb3J5OiAiTXVzaWMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hcnRsaXN0LmlvIiB9LAogIG11c2ljYmVkOiB7IHJlZ2V4OiAvbXVzaWNiZWQvaSwgbmFtZTogIk11c2ljYmVkIiwgY2F0ZWdvcnk6ICJNdXNpYyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL211c2ljYmVkLmNvbSIgfSwKICAvLyA9PT0gR0FNSU5HID09PQogIHhib3hfZ2FtZV9wYXNzOiB7IHJlZ2V4OiAvbWljcm9zb2Z0XCp4Ym94fHhib3ggZ2FtZSBwYXNzL2ksIG5hbWU6ICJYYm94IEdhbWUgUGFzcyIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20veGJveC5jb20iIH0sCiAgcGxheXN0YXRpb25fcGx1czogeyByZWdleDogL3Nvbnl8cGxheXN0YXRpb24vaSwgbmFtZTogIlBsYXlTdGF0aW9uIFBsdXMiLCBjYXRlZ29yeTogIkdhbWluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BsYXlzdGF0aW9uLmNvbSIgfSwKICBuaW50ZW5kb19vbmxpbmU6IHsgcmVnZXg6IC9uaW50ZW5kby9pLCBuYW1lOiAiTmludGVuZG8gU3dpdGNoIE9ubGluZSIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbmludGVuZG8uY29tIiB9LAogIHN0ZWFtOiB7IHJlZ2V4OiAvc3RlYW0gZ2FtZXN8c3RlYW1wb3dlcmVkL2ksIG5hbWU6ICJTdGVhbSIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3RlYW1wb3dlcmVkLmNvbSIgfSwKICBlYV9wbGF5OiB7IHJlZ2V4OiAvZWEgcGxheXxlbGVjdHJvbmljIGFydHMvaSwgbmFtZTogIkVBIFBsYXkiLCBjYXRlZ29yeTogIkdhbWluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2VhLmNvbSIgfSwKICB1Ymlzb2Z0X3BsdXM6IHsgcmVnZXg6IC91Ymlzb2Z0L2ksIG5hbWU6ICJVYmlzb2Z0KyIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdWJpc29mdC5jb20iIH0sCiAgcm9ibG94OiB7IHJlZ2V4OiAvcm9ibG94L2ksIG5hbWU6ICJSb2Jsb3ggUHJlbWl1bSIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcm9ibG94LmNvbSIgfSwKICB0d2l0Y2g6IHsgcmVnZXg6IC90d2l0Y2gvaSwgbmFtZTogIlR3aXRjaCIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdHdpdGNoLnR2IiB9LAogIGRpc2NvcmRfbml0cm86IHsgcmVnZXg6IC9kaXNjb3JkL2ksIG5hbWU6ICJEaXNjb3JkIE5pdHJvIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kaXNjb3JkLmNvbSIgfSwKICBodW1ibGVfYnVuZGxlOiB7IHJlZ2V4OiAvaHVtYmxlIGJ1bmRsZS9pLCBuYW1lOiAiSHVtYmxlIEJ1bmRsZSIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaHVtYmxlYnVuZGxlLmNvbSIgfSwKICBnZWZvcmNlX25vdzogeyByZWdleDogL252aWRpYXxnZWZvcmNlL2ksIG5hbWU6ICJHZUZvcmNlIE5vdyIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbnZpZGlhLmNvbSIgfSwKICBhcHBsZV9hcmNhZGU6IHsgcmVnZXg6IC9hcHBsZVwuY29tXC9iaWxsfGFwcGxlIGFyY2FkZS9pLCBuYW1lOiAiQXBwbGUgQXJjYWRlIiwgY2F0ZWdvcnk6ICJHYW1pbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hcHBsZS5jb20iIH0sCiAgZ29vZ2xlX3BsYXlfcGFzczogeyByZWdleDogL2dvb2dsZSBwbGF5IHBhc3MvaSwgbmFtZTogIkdvb2dsZSBQbGF5IFBhc3MiLCBjYXRlZ29yeTogIkdhbWluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BsYXkuZ29vZ2xlLmNvbSIgfSwKICBtaW5lY3JhZnRfcmVhbG1zOiB7IHJlZ2V4OiAvbW9qYW5nfG1pbmVjcmFmdC9pLCBuYW1lOiAiTWluZWNyYWZ0IFJlYWxtcyIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWluZWNyYWZ0Lm5ldCIgfSwKICBmb3J0bml0ZV9jcmV3OiB7IHJlZ2V4OiAvZXBpYyBnYW1lc3xmb3J0bml0ZS9pLCBuYW1lOiAiRm9ydG5pdGUgQ3JldyIsIGNhdGVnb3J5OiAiR2FtaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZm9ydG5pdGUuY29tIiB9LAogIC8vID09PSBTT0ZUV0FSRSAmIFNBQVMgPT09CiAgYWRvYmVfY2M6IHsgcmVnZXg6IC9hZG9iZXxjcmVhdGl2ZSBjbG91ZC9pLCBuYW1lOiAiQWRvYmUgQ3JlYXRpdmUgQ2xvdWQiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYWRvYmUuY29tIiB9LAogIG1pY3Jvc29mdF8zNjU6IHsgcmVnZXg6IC9taWNyb3NvZnRcKjM2NXxtc2Z0IFwqMzY1L2ksIG5hbWU6ICJNaWNyb3NvZnQgMzY1IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL29mZmljZS5jb20iIH0sCiAgZ29vZ2xlX3dvcmtzcGFjZTogeyByZWdleDogL2dvb2dsZSBcKmdzdWl0ZXxnb29nbGUgXCp3b3Jrc3BhY2UvaSwgbmFtZTogIkdvb2dsZSBXb3Jrc3BhY2UiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd29ya3NwYWNlLmdvb2dsZS5jb20iIH0sCiAgZHJvcGJveDogeyByZWdleDogL2Ryb3Bib3gvaSwgbmFtZTogIkRyb3Bib3giLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZHJvcGJveC5jb20iIH0sCiAgem9vbTogeyByZWdleDogL3pvb21cLnVzL2ksIG5hbWU6ICJab29tIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3pvb20udXMiIH0sCiAgc2xhY2s6IHsgcmVnZXg6IC9zbGFjay9pLCBuYW1lOiAiU2xhY2siLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc2xhY2suY29tIiB9LAogIG5vdGlvbjogeyByZWdleDogL25vdGlvbi9pLCBuYW1lOiAiTm90aW9uIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL25vdGlvbi5zbyIgfSwKICBldmVybm90ZTogeyByZWdleDogL2V2ZXJub3RlL2ksIG5hbWU6ICJFdmVybm90ZSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ldmVybm90ZS5jb20iIH0sCiAgdHJlbGxvOiB7IHJlZ2V4OiAvdHJlbGxvL2ksIG5hbWU6ICJUcmVsbG8iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdHJlbGxvLmNvbSIgfSwKICBhc2FuYTogeyByZWdleDogL2FzYW5hL2ksIG5hbWU6ICJBc2FuYSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hc2FuYS5jb20iIH0sCiAgbW9uZGF5X2NvbTogeyByZWdleDogL21vbmRheVwuY29tL2ksIG5hbWU6ICJNb25kYXkuY29tIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21vbmRheS5jb20iIH0sCiAgY2xpY2t1cDogeyByZWdleDogL2NsaWNrdXAvaSwgbmFtZTogIkNsaWNrVXAiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY2xpY2t1cC5jb20iIH0sCiAgYWlydGFibGU6IHsgcmVnZXg6IC9haXJ0YWJsZS9pLCBuYW1lOiAiQWlydGFibGUiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYWlydGFibGUuY29tIiB9LAogIGZpZ21hOiB7IHJlZ2V4OiAvZmlnbWEvaSwgbmFtZTogIkZpZ21hIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2ZpZ21hLmNvbSIgfSwKICBjYW52YTogeyByZWdleDogL2NhbnZhL2ksIG5hbWU6ICJDYW52YSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jYW52YS5jb20iIH0sCiAgZ2l0aHViOiB7IHJlZ2V4OiAvZ2l0aHViL2ksIG5hbWU6ICJHaXRIdWIiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZ2l0aHViLmNvbSIgfSwKICBnaXRsYWI6IHsgcmVnZXg6IC9naXRsYWIvaSwgbmFtZTogIkdpdExhYiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9naXRsYWIuY29tIiB9LAogIGhlcm9rdTogeyByZWdleDogL2hlcm9rdS9pLCBuYW1lOiAiSGVyb2t1IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2hlcm9rdS5jb20iIH0sCiAgZGlnaXRhbG9jZWFuOiB7IHJlZ2V4OiAvZGlnaXRhbG9jZWFuL2ksIG5hbWU6ICJEaWdpdGFsT2NlYW4iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZGlnaXRhbG9jZWFuLmNvbSIgfSwKICBhd3M6IHsgcmVnZXg6IC9hd3N8YW1hem9uIHdlYiBzZXJ2aWNlcy9pLCBuYW1lOiAiQVdTIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2F3cy5hbWF6b24uY29tIiB9LAogIHZlcmNlbDogeyByZWdleDogL3ZlcmNlbC9pLCBuYW1lOiAiVmVyY2VsIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3ZlcmNlbC5jb20iIH0sCiAgbmV0bGlmeTogeyByZWdleDogL25ldGxpZnkvaSwgbmFtZTogIk5ldGxpZnkiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbmV0bGlmeS5jb20iIH0sCiAgd2ViZmxvdzogeyByZWdleDogL3dlYmZsb3cvaSwgbmFtZTogIldlYmZsb3ciLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd2ViZmxvdy5jb20iIH0sCiAgc3F1YXJlc3BhY2U6IHsgcmVnZXg6IC9zcXVhcmVzcGFjZS9pLCBuYW1lOiAiU3F1YXJlc3BhY2UiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3F1YXJlc3BhY2UuY29tIiB9LAogIHdpeDogeyByZWdleDogL3dpeFwuY29tL2ksIG5hbWU6ICJXaXgiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd2l4LmNvbSIgfSwKICB3b3JkcHJlc3M6IHsgcmVnZXg6IC93b3JkcHJlc3MvaSwgbmFtZTogIldvcmRQcmVzcyIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS93b3JkcHJlc3MuY29tIiB9LAogIGJsdWVob3N0OiB7IHJlZ2V4OiAvYmx1ZWhvc3QvaSwgbmFtZTogIkJsdWVob3N0IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2JsdWVob3N0LmNvbSIgfSwKICBjaGF0Z3B0OiB7IHJlZ2V4OiAvb3BlbmFpfGNoYXRncHQvaSwgbmFtZTogIkNoYXRHUFQgUGx1cyIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9vcGVuYWkuY29tIiB9LAogIG1pZGpvdXJuZXk6IHsgcmVnZXg6IC9taWRqb3VybmV5L2ksIG5hbWU6ICJNaWRqb3VybmV5IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21pZGpvdXJuZXkuY29tIiB9LAogIGphc3BlcjogeyByZWdleDogL2phc3BlclwuYWkvaSwgbmFtZTogIkphc3BlciIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9qYXNwZXIuYWkiIH0sCiAgY29weV9haTogeyByZWdleDogL2NvcHlcLmFpL2ksIG5hbWU6ICJDb3B5LmFpIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NvcHkuYWkiIH0sCiAgZ3JhbW1hcmx5OiB7IHJlZ2V4OiAvZ3JhbW1hcmx5L2ksIG5hbWU6ICJHcmFtbWFybHkiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZ3JhbW1hcmx5LmNvbSIgfSwKICBsYXN0cGFzczogeyByZWdleDogL2xhc3RwYXNzL2ksIG5hbWU6ICJMYXN0UGFzcyIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9sYXN0cGFzcy5jb20iIH0sCiAgb25lcGFzc3dvcmQ6IHsgcmVnZXg6IC8xcGFzc3dvcmQvaSwgbmFtZTogIjFQYXNzd29yZCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS8xcGFzc3dvcmQuY29tIiB9LAogIGRhc2hsYW5lOiB7IHJlZ2V4OiAvZGFzaGxhbmUvaSwgbmFtZTogIkRhc2hsYW5lIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Rhc2hsYW5lLmNvbSIgfSwKICBub3JkdnBuOiB7IHJlZ2V4OiAvbm9yZHZwbi9pLCBuYW1lOiAiTm9yZFZQTiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ub3JkdnBuLmNvbSIgfSwKICBleHByZXNzdnBuOiB7IHJlZ2V4OiAvZXhwcmVzc3Zwbi9pLCBuYW1lOiAiRXhwcmVzc1ZQTiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9leHByZXNzdnBuLmNvbSIgfSwKICBzdXJmc2hhcms6IHsgcmVnZXg6IC9zdXJmc2hhcmsvaSwgbmFtZTogIlN1cmZzaGFyayIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zdXJmc2hhcmsuY29tIiB9LAogIHByb3RvbjogeyByZWdleDogL3Byb3RvbiBtYWlsfHByb3RvbnZwbi9pLCBuYW1lOiAiUHJvdG9uIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Byb3Rvbi5tZSIgfSwKICBhZG9iZV9hY3JvYmF0OiB7IHJlZ2V4OiAvYWNyb2JhdC9pLCBuYW1lOiAiQWRvYmUgQWNyb2JhdCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hZG9iZS5jb20iIH0sCiAgZG9jdXNpZ246IHsgcmVnZXg6IC9kb2N1c2lnbi9pLCBuYW1lOiAiRG9jdVNpZ24iLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZG9jdXNpZ24uY29tIiB9LAogIGxpbmtlZGluX3ByZW1pdW06IHsgcmVnZXg6IC9saW5rZWRpbi9pLCBuYW1lOiAiTGlua2VkSW4gUHJlbWl1bSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9saW5rZWRpbi5jb20iIH0sCiAgdHdpdHRlcl9ibHVlOiB7IHJlZ2V4OiAvdHdpdHRlciBibHVlfHggcHJlbWl1bS9pLCBuYW1lOiAiWCBQcmVtaXVtIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3R3aXR0ZXIuY29tIiB9LAogIG1lZGl1bTogeyByZWdleDogL21lZGl1bS9pLCBuYW1lOiAiTWVkaXVtIE1lbWJlcnNoaXAiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWVkaXVtLmNvbSIgfSwKICAvLyA9PT0gU0hPUFBJTkcgJiBERUxJVkVSWSA9PT0KICBhbWF6b25fcHJpbWU6IHsgcmVnZXg6IC9hbXpuIHByaW1lfGFtYXpvbiBwcmltZS9pLCBuYW1lOiAiQW1hem9uIFByaW1lIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2FtYXpvbi5jb20iIH0sCiAgd2FsbWFydF9wbHVzOiB7IHJlZ2V4OiAvd2FsbWFydFwrL2ksIG5hbWU6ICJXYWxtYXJ0KyIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS93YWxtYXJ0LmNvbSIgfSwKICBpbnN0YWNhcnQ6IHsgcmVnZXg6IC9pbnN0YWNhcnQvaSwgbmFtZTogIkluc3RhY2FydCsiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaW5zdGFjYXJ0LmNvbSIgfSwKICBzaGlwdDogeyByZWdleDogL3NoaXB0L2ksIG5hbWU6ICJTaGlwdCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zaGlwdC5jb20iIH0sCiAgZG9vcmRhc2g6IHsgcmVnZXg6IC9kb29yZGFzaHxkYXNocGFzcy9pLCBuYW1lOiAiRGFzaFBhc3MiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZG9vcmRhc2guY29tIiB9LAogIHViZXJfZWF0czogeyByZWdleDogL3ViZXIgcGFzc3x1YmVyIG9uZS9pLCBuYW1lOiAiVWJlciBPbmUiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdWJlci5jb20iIH0sCiAgZ3J1Ymh1YjogeyByZWdleDogL2dydWJodWIvaSwgbmFtZTogIkdydWJodWIrIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2dydWJodWIuY29tIiB9LAogIHBvc3RtYXRlczogeyByZWdleDogL3Bvc3RtYXRlcy9pLCBuYW1lOiAiUG9zdG1hdGVzIFVubGltaXRlZCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9wb3N0bWF0ZXMuY29tIiB9LAogIGNvc3RjbzogeyByZWdleDogL2Nvc3Rjby9pLCBuYW1lOiAiQ29zdGNvIE1lbWJlcnNoaXAiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY29zdGNvLmNvbSIgfSwKICBzYW1zX2NsdWI6IHsgcmVnZXg6IC9zYW1zIGNsdWIvaSwgbmFtZTogIlNhbSdzIENsdWIiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc2Ftc2NsdWIuY29tIiB9LAogIGJqX3dob2xlc2FsZTogeyByZWdleDogL2JqcyB3aG9sZXNhbGUvaSwgbmFtZTogIkJKJ3MgV2hvbGVzYWxlIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Jqcy5jb20iIH0sCiAgdGhyaXZlX21hcmtldDogeyByZWdleDogL3Rocml2ZSBtYXJrZXQvaSwgbmFtZTogIlRocml2ZSBNYXJrZXQiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdGhyaXZlbWFya2V0LmNvbSIgfSwKICBjaGV3eTogeyByZWdleDogL2NoZXd5L2ksIG5hbWU6ICJDaGV3eSBBdXRvc2hpcCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jaGV3eS5jb20iIH0sCiAgc3RpdGNoX2ZpeDogeyByZWdleDogL3N0aXRjaCBmaXgvaSwgbmFtZTogIlN0aXRjaCBGaXgiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3RpdGNoZml4LmNvbSIgfSwKICByZW50X3RoZV9ydW53YXk6IHsgcmVnZXg6IC9yZW50IHRoZSBydW53YXkvaSwgbmFtZTogIlJlbnQgdGhlIFJ1bndheSIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9yZW50dGhlcnVud2F5LmNvbSIgfSwKICBmYWJsZXRpY3M6IHsgcmVnZXg6IC9mYWJsZXRpY3MvaSwgbmFtZTogIkZhYmxldGljcyIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9mYWJsZXRpY3MuY29tIiB9LAogIHNhdmFnZV94X2ZlbnR5OiB7IHJlZ2V4OiAvc2F2YWdlIHggZmVudHkvaSwgbmFtZTogIlNhdmFnZSBYIEZlbnR5IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3NhdmFnZXguY29tIiB9LAogIGRvbGxhcl9zaGF2ZV9jbHViOiB7IHJlZ2V4OiAvZG9sbGFyIHNoYXZlL2ksIG5hbWU6ICJEb2xsYXIgU2hhdmUgQ2x1YiIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kb2xsYXJzaGF2ZWNsdWIuY29tIiB9LAogIGhhcnJ5X3M6IHsgcmVnZXg6IC9oYXJyeXMvaSwgbmFtZTogIkhhcnJ5J3MiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaGFycnlzLmNvbSIgfSwKICBxdWlwOiB7IHJlZ2V4OiAvZ2V0cXVpcHxxdWlwL2ksIG5hbWU6ICJRdWlwIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2dldHF1aXAuY29tIiB9LAogIC8vID09PSBTVUJTQ1JJUFRJT04gQk9YRVMgPT09CiAgaGVsbG9mcmVzaDogeyByZWdleDogL2hlbGxvZnJlc2gvaSwgbmFtZTogIkhlbGxvRnJlc2giLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaGVsbG9mcmVzaC5jb20iIH0sCiAgYmx1ZV9hcHJvbjogeyByZWdleDogL2JsdWUgYXByb24vaSwgbmFtZTogIkJsdWUgQXByb24iLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYmx1ZWFwcm9uLmNvbSIgfSwKICBob21lX2NoZWY6IHsgcmVnZXg6IC9ob21lIGNoZWYvaSwgbmFtZTogIkhvbWUgQ2hlZiIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ob21lY2hlZi5jb20iIH0sCiAgc3VuX2Jhc2tldDogeyByZWdleDogL3N1biBiYXNrZXQvaSwgbmFtZTogIlN1biBCYXNrZXQiLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3VuYmFza2V0LmNvbSIgfSwKICBkYWlseV9oYXJ2ZXN0OiB7IHJlZ2V4OiAvZGFpbHkgaGFydmVzdC9pLCBuYW1lOiAiRGFpbHkgSGFydmVzdCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9kYWlseS1oYXJ2ZXN0LmNvbSIgfSwKICBmcmVzaGx5OiB7IHJlZ2V4OiAvZnJlc2hseS9pLCBuYW1lOiAiRnJlc2hseSIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9mcmVzaGx5LmNvbSIgfSwKICBmYWN0b3JfbWVhbHM6IHsgcmVnZXg6IC9mYWN0b3I3NXxmYWN0b3IgbWVhbHMvaSwgbmFtZTogIkZhY3Rvcl8iLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZmFjdG9yNzUuY29tIiB9LAogIGJ1dGNoZXJfYm94OiB7IHJlZ2V4OiAvYnV0Y2hlcmJveC9pLCBuYW1lOiAiQnV0Y2hlckJveCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9idXRjaGVyYm94LmNvbSIgfSwKICBiYXJrYm94OiB7IHJlZ2V4OiAvYmFya2JveC9pLCBuYW1lOiAiQmFya0JveCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9iYXJrYm94LmNvbSIgfSwKICBpcHN5OiB7IHJlZ2V4OiAvaXBzeS9pLCBuYW1lOiAiSXBzeSIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9pcHN5LmNvbSIgfSwKICBiaXJjaGJveDogeyByZWdleDogL2JpcmNoYm94L2ksIG5hbWU6ICJCaXJjaGJveCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9iaXJjaGJveC5jb20iIH0sCiAgZmFiZml0ZnVuOiB7IHJlZ2V4OiAvZmFiZml0ZnVuL2ksIG5hbWU6ICJGYWJGaXRGdW4iLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZmFiZml0ZnVuLmNvbSIgfSwKICBhbGx1cmVfYmVhdXR5OiB7IHJlZ2V4OiAvYWxsdXJlIGJlYXV0eS9pLCBuYW1lOiAiQWxsdXJlIEJlYXV0eSBCb3giLCBjYXRlZ29yeTogIlNob3BwaW5nIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYWxsdXJlLmNvbSIgfSwKICBzY2VudGJpcmQ6IHsgcmVnZXg6IC9zY2VudGJpcmQvaSwgbmFtZTogIlNjZW50YmlyZCIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zY2VudGJpcmQuY29tIiB9LAogIGJvb2tfb2ZfdGhlX21vbnRoOiB7IHJlZ2V4OiAvYm9vayBvZiB0aGUgbW9udGgvaSwgbmFtZTogIkJvb2sgb2YgdGhlIE1vbnRoIiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Jvb2tvZnRoZW1vbnRoLmNvbSIgfSwKICBsb290X2NyYXRlOiB7IHJlZ2V4OiAvbG9vdCBjcmF0ZS9pLCBuYW1lOiAiTG9vdCBDcmF0ZSIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9sb290Y3JhdGUuY29tIiB9LAogIGJlc3Bva2VfcG9zdDogeyByZWdleDogL2Jlc3Bva2UgcG9zdC9pLCBuYW1lOiAiQmVzcG9rZSBQb3N0IiwgY2F0ZWdvcnk6ICJTaG9wcGluZyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Jlc3Bva2Vwb3N0LmNvbSIgfSwKICBraXdpY286IHsgcmVnZXg6IC9raXdpY28vaSwgbmFtZTogIktpd2lDbyIsIGNhdGVnb3J5OiAiU2hvcHBpbmciLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9raXdpY28uY29tIiB9LAogIC8vID09PSBIRUFMVEggJiBGSVRORVNTID09PQogIHBsYW5ldF9maXRuZXNzOiB7IHJlZ2V4OiAvcGxhbmV0IGZpdC9pLCBuYW1lOiAiUGxhbmV0IEZpdG5lc3MiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BsYW5ldGZpdG5lc3MuY29tIiB9LAogIGdvbGRfc19neW06IHsgcmVnZXg6IC9nb2xkJz9zIGd5bS9pLCBuYW1lOiAiR29sZCdzIEd5bSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZ29sZHNneW0uY29tIiB9LAogIGxhX2ZpdG5lc3M6IHsgcmVnZXg6IC9sYSBmaXRuZXNzL2ksIG5hbWU6ICJMQSBGaXRuZXNzIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9sYWZpdG5lc3MuY29tIiB9LAogIGFueXRpbWVfZml0bmVzczogeyByZWdleDogL2FueXRpbWUgZml0bmVzcy9pLCBuYW1lOiAiQW55dGltZSBGaXRuZXNzIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hbnl0aW1lZml0bmVzcy5jb20iIH0sCiAgY3J1bmNoX2ZpdG5lc3M6IHsgcmVnZXg6IC9jcnVuY2ggZml0bmVzcy9pLCBuYW1lOiAiQ3J1bmNoIEZpdG5lc3MiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NydW5jaC5jb20iIH0sCiAgZXF1aW5veDogeyByZWdleDogL2VxdWlub3gvaSwgbmFtZTogIkVxdWlub3giLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2VxdWlub3guY29tIiB9LAogIGxpZmV0aW1lX2ZpdG5lc3M6IHsgcmVnZXg6IC9saWZldGltZSBmaXQvaSwgbmFtZTogIkxpZmUgVGltZSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbGlmZXRpbWUubGlmZSIgfSwKICBvcmFuZ2VfdGhlb3J5OiB7IHJlZ2V4OiAvb3JhbmdldGhlb3J5L2ksIG5hbWU6ICJPcmFuZ2V0aGVvcnkiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL29yYW5nZXRoZW9yeS5jb20iIH0sCiAgc291bGN5Y2xlOiB7IHJlZ2V4OiAvc291bGN5Y2xlL2ksIG5hbWU6ICJTb3VsQ3ljbGUiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3NvdWwtY3ljbGUuY29tIiB9LAogIHBlbG90b246IHsgcmVnZXg6IC9wZWxvdG9uL2ksIG5hbWU6ICJQZWxvdG9uIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9vbmVwZWxvdG9uLmNvbSIgfSwKICB0b25hbDogeyByZWdleDogL3RvbmFsL2ksIG5hbWU6ICJUb25hbCIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdG9uYWwuY29tIiB9LAogIG1pcnJvcjogeyByZWdleDogL21pcnJvci9pLCBuYW1lOiAiTWlycm9yIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9taXJyb3IuY28iIH0sCiAgZml0Yml0OiB7IHJlZ2V4OiAvZml0Yml0L2ksIG5hbWU6ICJGaXRiaXQgUHJlbWl1bSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZml0Yml0LmNvbSIgfSwKICB3aG9vcDogeyByZWdleDogL3dob29wL2ksIG5hbWU6ICJXSE9PUCIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd2hvb3AuY29tIiB9LAogIG91cmFfcmluZzogeyByZWdleDogL291cmEgcmluZy9pLCBuYW1lOiAiT3VyYSBSaW5nIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9vdXJhcmluZy5jb20iIH0sCiAgYXBwX2ZpdG5lc3NfcGFsOiB7IHJlZ2V4OiAvbXlmaXRuZXNzcGFsL2ksIG5hbWU6ICJNeUZpdG5lc3NQYWwiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL215Zml0bmVzc3BhbC5jb20iIH0sCiAgc3RyYXZhOiB7IHJlZ2V4OiAvc3RyYXZhL2ksIG5hbWU6ICJTdHJhdmEiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3N0cmF2YS5jb20iIH0sCiAgY2FsbTogeyByZWdleDogL2NhbG1cLmNvbS9pLCBuYW1lOiAiQ2FsbSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vY2FsbS5jb20iIH0sCiAgaGVhZHNwYWNlOiB7IHJlZ2V4OiAvaGVhZHNwYWNlL2ksIG5hbWU6ICJIZWFkc3BhY2UiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2hlYWRzcGFjZS5jb20iIH0sCiAgbm9vbTogeyByZWdleDogL25vb20vaSwgbmFtZTogIk5vb20iLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL25vb20uY29tIiB9LAogIHdlaWdodF93YXRjaGVyczogeyByZWdleDogL3d3IGludGVybmF0aW9uYWx8d2VpZ2h0IHdhdGNoZXJzL2ksIG5hbWU6ICJXZWlnaHRXYXRjaGVycyIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vd2VpZ2h0d2F0Y2hlcnMuY29tIiB9LAogIGJldHRlcmhlbHA6IHsgcmVnZXg6IC9iZXR0ZXJoZWxwL2ksIG5hbWU6ICJCZXR0ZXJIZWxwIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9iZXR0ZXJoZWxwLmNvbSIgfSwKICB0YWxrc3BhY2U6IHsgcmVnZXg6IC90YWxrc3BhY2UvaSwgbmFtZTogIlRhbGtzcGFjZSIsIGNhdGVnb3J5OiAiSGVhbHRoIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdGFsa3NwYWNlLmNvbSIgfSwKICBydW1ibGVfYm94aW5nOiB7IHJlZ2V4OiAvcnVtYmxlIGJveGluZy9pLCBuYW1lOiAiUnVtYmxlIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ydW1ibGVib3hpbmdneW0uY29tIiB9LAogIGN5Y2xlYmFyOiB7IHJlZ2V4OiAvY3ljbGViYXIvaSwgbmFtZTogIkN5Y2xlQmFyIiwgY2F0ZWdvcnk6ICJIZWFsdGgiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jeWNsZWJhci5jb20iIH0sCiAgcHVyZV9iYXJyZTogeyByZWdleDogL3B1cmUgYmFycmUvaSwgbmFtZTogIlB1cmUgQmFycmUiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3B1cmViYXJyZS5jb20iIH0sCiAgY2x1Yl9waWxhdGVzOiB7IHJlZ2V4OiAvY2x1YiBwaWxhdGVzL2ksIG5hbWU6ICJDbHViIFBpbGF0ZXMiLCBjYXRlZ29yeTogIkhlYWx0aCIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NsdWJwaWxhdGVzLmNvbSIgfSwKICAvLyA9PT0gTkVXUyAmIE1BR0FaSU5FUyA9PT0KICBueXRpbWVzOiB7IHJlZ2V4OiAvbnl0aW1lc3xuZXcgeW9yayB0aW1lcy9pLCBuYW1lOiAiTlkgVGltZXMiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ueXRpbWVzLmNvbSIgfSwKICB3YXNoaW5ndG9uX3Bvc3Q6IHsgcmVnZXg6IC93YXNocG9zdHx3YXNoaW5ndG9uIHBvc3QvaSwgbmFtZTogIldhc2hpbmd0b24gUG9zdCIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3dhc2hpbmd0b25wb3N0LmNvbSIgfSwKICB3c2o6IHsgcmVnZXg6IC93c2p8d2FsbCBzdHJlZXQgam91cm5hbC9pLCBuYW1lOiAiV2FsbCBTdHJlZXQgSm91cm5hbCIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3dzai5jb20iIH0sCiAgZWNvbm9taXN0OiB7IHJlZ2V4OiAvZWNvbm9taXN0L2ksIG5hbWU6ICJUaGUgRWNvbm9taXN0IiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZWNvbm9taXN0LmNvbSIgfSwKICBibG9vbWJlcmc6IHsgcmVnZXg6IC9ibG9vbWJlcmcvaSwgbmFtZTogIkJsb29tYmVyZyIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Jsb29tYmVyZy5jb20iIH0sCiAgZmluYW5jaWFsX3RpbWVzOiB7IHJlZ2V4OiAvZmluYW5jaWFsIHRpbWVzL2ksIG5hbWU6ICJGaW5hbmNpYWwgVGltZXMiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9mdC5jb20iIH0sCiAgdGhlX2F0bGFudGljOiB7IHJlZ2V4OiAvdGhlIGF0bGFudGljL2ksIG5hbWU6ICJUaGUgQXRsYW50aWMiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90aGVhdGxhbnRpYy5jb20iIH0sCiAgbmV3X3lvcmtlcjogeyByZWdleDogL25ldyB5b3JrZXIvaSwgbmFtZTogIlRoZSBOZXcgWW9ya2VyIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbmV3eW9ya2VyLmNvbSIgfSwKICB3aXJlZDogeyByZWdleDogL3dpcmVkL2ksIG5hbWU6ICJXaXJlZCIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3dpcmVkLmNvbSIgfSwKICBuYXRnZW86IHsgcmVnZXg6IC9uYXQuKmdlb3xuYXRpb25hbCBnZW9ncmFwaGljL2ksIG5hbWU6ICJOYXRpb25hbCBHZW9ncmFwaGljIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbmF0aW9uYWxnZW9ncmFwaGljLmNvbSIgfSwKICB0aW1lX21hZzogeyByZWdleDogL3RpbWUgbWFnYXppbmUvaSwgbmFtZTogIlRJTUUiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90aW1lLmNvbSIgfSwKICBmb3JiZXM6IHsgcmVnZXg6IC9mb3JiZXMvaSwgbmFtZTogIkZvcmJlcyIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2ZvcmJlcy5jb20iIH0sCiAgYnVzaW5lc3NfaW5zaWRlcjogeyByZWdleDogL2J1c2luZXNzIGluc2lkZXIvaSwgbmFtZTogIkJ1c2luZXNzIEluc2lkZXIiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9idXNpbmVzc2luc2lkZXIuY29tIiB9LAogIGhicjogeyByZWdleDogL2hhcnZhcmQgYnVzaW5lc3MvaSwgbmFtZTogIkhCUiIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2hici5vcmciIH0sCiAgc3Vic3RhY2s6IHsgcmVnZXg6IC9zdWJzdGFjay9pLCBuYW1lOiAiU3Vic3RhY2siLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zdWJzdGFjay5jb20iIH0sCiAgbWVkaXVtX21lbWJlcnNoaXA6IHsgcmVnZXg6IC9tZWRpdW0vaSwgbmFtZTogIk1lZGl1bSIsIGNhdGVnb3J5OiAiTmV3cyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21lZGl1bS5jb20iIH0sCiAgbW9ybmluZ19icmV3OiB7IHJlZ2V4OiAvbW9ybmluZyBicmV3L2ksIG5hbWU6ICJNb3JuaW5nIEJyZXciLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9tb3JuaW5nYnJldy5jb20iIH0sCiAgYXhpb3M6IHsgcmVnZXg6IC9heGlvcy9pLCBuYW1lOiAiQXhpb3MiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9heGlvcy5jb20iIH0sCiAgdGhlX2d1YXJkaWFuOiB7IHJlZ2V4OiAvZ3VhcmRpYW4gbmV3cy9pLCBuYW1lOiAiVGhlIEd1YXJkaWFuIiwgY2F0ZWdvcnk6ICJOZXdzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdGhlZ3VhcmRpYW4uY29tIiB9LAogIHVzYXRvZGF5OiB7IHJlZ2V4OiAvdXNhIHRvZGF5L2ksIG5hbWU6ICJVU0EgVG9kYXkiLCBjYXRlZ29yeTogIk5ld3MiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS91c2F0b2RheS5jb20iIH0sCiAgLy8gPT09IERBVElORyAmIFNPQ0lBTCA9PT0KICB0aW5kZXI6IHsgcmVnZXg6IC90aW5kZXIvaSwgbmFtZTogIlRpbmRlciIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90aW5kZXIuY29tIiB9LAogIGJ1bWJsZTogeyByZWdleDogL2J1bWJsZS9pLCBuYW1lOiAiQnVtYmxlIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2J1bWJsZS5jb20iIH0sCiAgaGluZ2U6IHsgcmVnZXg6IC9oaW5nZS9pLCBuYW1lOiAiSGluZ2UiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaGluZ2UuY28iIH0sCiAgbWF0Y2hfY29tOiB7IHJlZ2V4OiAvbWF0Y2hcLmNvbS9pLCBuYW1lOiAiTWF0Y2guY29tIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21hdGNoLmNvbSIgfSwKICBva2N1cGlkOiB7IHJlZ2V4OiAvb2tjdXBpZC9pLCBuYW1lOiAiT2tDdXBpZCIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9va2N1cGlkLmNvbSIgfSwKICBncmluZHI6IHsgcmVnZXg6IC9ncmluZHIvaSwgbmFtZTogIkdyaW5kciIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ncmluZHIuY29tIiB9LAogIGVoYXJtb255OiB7IHJlZ2V4OiAvZWhhcm1vbnkvaSwgbmFtZTogImVIYXJtb255IiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2VoYXJtb255LmNvbSIgfSwKICBwbGVudHlfb2ZfZmlzaDogeyByZWdleDogL3BvZnxwbGVudHlvZmZpc2gvaSwgbmFtZTogIlBsZW50eSBvZiBGaXNoIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3BvZi5jb20iIH0sCiAgcmF5YTogeyByZWdleDogL3JheWEvaSwgbmFtZTogIlJheWEiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogIiIgfSwKICBjb2ZmZWVfbWVldHNfYmFnZWw6IHsgcmVnZXg6IC9jb2ZmZWUgbWVldHMgYmFnZWwvaSwgbmFtZTogIkNvZmZlZSBNZWV0cyBCYWdlbCIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jb2ZmZWVtZWV0c2JhZ2VsLmNvbSIgfSwKICBiYWRvbzogeyByZWdleDogL2JhZG9vL2ksIG5hbWU6ICJCYWRvbyIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9iYWRvby5jb20iIH0sCiAgLy8gPT09IFVUSUxJVElFUyAmIFRFTEVDT00gPT09CiAgeGZpbml0eTogeyByZWdleDogL2NvbWNhc3R8eGZpbml0eS9pLCBuYW1lOiAiWGZpbml0eSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20veGZpbml0eS5jb20iIH0sCiAgYXR0OiB7IHJlZ2V4OiAvYXQmdC9pLCBuYW1lOiAiQVQmVCIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYXR0LmNvbSIgfSwKICB2ZXJpem9uOiB7IHJlZ2V4OiAvdmVyaXpvbi9pLCBuYW1lOiAiVmVyaXpvbiIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vdmVyaXpvbi5jb20iIH0sCiAgdF9tb2JpbGU6IHsgcmVnZXg6IC90LW1vYmlsZS9pLCBuYW1lOiAiVC1Nb2JpbGUiLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3QtbW9iaWxlLmNvbSIgfSwKICBzcGVjdHJ1bTogeyByZWdleDogL3NwZWN0cnVtL2ksIG5hbWU6ICJTcGVjdHJ1bSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3BlY3RydW0uY29tIiB9LAogIGNveDogeyByZWdleDogL2NveCBjb21tL2ksIG5hbWU6ICJDb3giLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NveC5jb20iIH0sCiAgb3B0aW11bTogeyByZWdleDogL29wdGltdW0vaSwgbmFtZTogIk9wdGltdW0iLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL29wdGltdW0ubmV0IiB9LAogIGNlbnR1cnlsaW5rOiB7IHJlZ2V4OiAvY2VudHVyeWxpbmsvaSwgbmFtZTogIkNlbnR1cnlMaW5rIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jZW50dXJ5bGluay5jb20iIH0sCiAgZnJvbnRpZXI6IHsgcmVnZXg6IC9mcm9udGllci9pLCBuYW1lOiAiRnJvbnRpZXIiLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Zyb250aWVyLmNvbSIgfSwKICBtaW50X21vYmlsZTogeyByZWdleDogL21pbnQgbW9iaWxlL2ksIG5hbWU6ICJNaW50IE1vYmlsZSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vbWludG1vYmlsZS5jb20iIH0sCiAgdmlzaWJsZTogeyByZWdleDogL3Zpc2libGUvaSwgbmFtZTogIlZpc2libGUiLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Zpc2libGUuY29tIiB9LAogIGNyaWNrZXRfd2lyZWxlc3M6IHsgcmVnZXg6IC9jcmlja2V0L2ksIG5hbWU6ICJDcmlja2V0IFdpcmVsZXNzIiwgY2F0ZWdvcnk6ICJVdGlsaXRpZXMiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jcmlja2V0d2lyZWxlc3MuY29tIiB9LAogIG1ldHJvX2J5X3Rtb2JpbGU6IHsgcmVnZXg6IC9tZXRyb3Bjc3xtZXRybyBieSB0LW1vYmlsZS9pLCBuYW1lOiAiTWV0cm8gYnkgVC1Nb2JpbGUiLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL21ldHJvYnl0LW1vYmlsZS5jb20iIH0sCiAgYm9vc3RfbW9iaWxlOiB7IHJlZ2V4OiAvYm9vc3QgbW9iaWxlL2ksIG5hbWU6ICJCb29zdCBNb2JpbGUiLCBjYXRlZ29yeTogIlV0aWxpdGllcyIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2Jvb3N0bW9iaWxlLmNvbSIgfSwKICBnb29nbGVfZmk6IHsgcmVnZXg6IC9nb29nbGUgZmkvaSwgbmFtZTogIkdvb2dsZSBGaSIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZmkuZ29vZ2xlLmNvbSIgfSwKICBzdGFybGluazogeyByZWdleDogL3N0YXJsaW5rL2ksIG5hbWU6ICJTdGFybGluayIsIGNhdGVnb3J5OiAiVXRpbGl0aWVzIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vc3RhcmxpbmsuY29tIiB9LAogIC8vID09PSBJTlNVUkFOQ0UgJiBGSU5BTkNFID09PQogIGxlbW9uYWRlOiB7IHJlZ2V4OiAvbGVtb25hZGUgaW5jL2ksIG5hbWU6ICJMZW1vbmFkZSIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9sZW1vbmFkZS5jb20iIH0sCiAgZ2VpY286IHsgcmVnZXg6IC9nZWljby9pLCBuYW1lOiAiR0VJQ08iLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZ2VpY28uY29tIiB9LAogIHByb2dyZXNzaXZlOiB7IHJlZ2V4OiAvcHJvZ3Jlc3NpdmUvaSwgbmFtZTogIlByb2dyZXNzaXZlIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3Byb2dyZXNzaXZlLmNvbSIgfSwKICBzdGF0ZV9mYXJtOiB7IHJlZ2V4OiAvc3RhdGUgZmFybS9pLCBuYW1lOiAiU3RhdGUgRmFybSIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9zdGF0ZWZhcm0uY29tIiB9LAogIGFsbHN0YXRlOiB7IHJlZ2V4OiAvYWxsc3RhdGUvaSwgbmFtZTogIkFsbHN0YXRlIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2FsbHN0YXRlLmNvbSIgfSwKICBsaWJlcnR5X211dHVhbDogeyByZWdleDogL2xpYmVydHkgbXV0dWFsL2ksIG5hbWU6ICJMaWJlcnR5IE11dHVhbCIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9saWJlcnR5bXV0dWFsLmNvbSIgfSwKICB1c2FhOiB7IHJlZ2V4OiAvdXNhYS9pLCBuYW1lOiAiVVNBQSIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS91c2FhLmNvbSIgfSwKICBjaGFzZV9zYXBwaGlyZTogeyByZWdleDogL2NoYXNlIHNhcHBoaXJlL2ksIG5hbWU6ICJDaGFzZSBTYXBwaGlyZSIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jaGFzZS5jb20iIH0sCiAgYW1leF9wbGF0aW51bTogeyByZWdleDogL2FtZXggcGxhdGludW0vaSwgbmFtZTogIkFtZXggUGxhdGludW0iLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vYW1lcmljYW5leHByZXNzLmNvbSIgfSwKICByb2Jpbmhvb2RfZ29sZDogeyByZWdleDogL3JvYmluaG9vZC9pLCBuYW1lOiAiUm9iaW5ob29kIEdvbGQiLCBjYXRlZ29yeTogIk90aGVyIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcm9iaW5ob29kLmNvbSIgfSwKICBjb2luYmFzZV9vbmU6IHsgcmVnZXg6IC9jb2luYmFzZS9pLCBuYW1lOiAiQ29pbmJhc2UgT25lIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NvaW5iYXNlLmNvbSIgfSwKICBhY29ybnM6IHsgcmVnZXg6IC9hY29ybnMvaSwgbmFtZTogIkFjb3JucyIsIGNhdGVnb3J5OiAiT3RoZXIiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9hY29ybnMuY29tIiB9LAogIHN0YXNoOiB7IHJlZ2V4OiAvc3Rhc2gvaSwgbmFtZTogIlN0YXNoIiwgY2F0ZWdvcnk6ICJPdGhlciIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3N0YXNoLmNvbSIgfSwKICBZTkFCOiB7IHJlZ2V4OiAveW5hYi9pLCBuYW1lOiAiWU5BQiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS95bmFiLmNvbSIgfSwKICBtb25hcmNoX21vbmV5OiB7IHJlZ2V4OiAvbW9uYXJjaCBtb25leS9pLCBuYW1lOiAiTW9uYXJjaCBNb25leSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9tb25hcmNobW9uZXkuY29tIiB9LAogIGNvcGlsb3RfbW9uZXk6IHsgcmVnZXg6IC9jb3BpbG90IG1vbmV5L2ksIG5hbWU6ICJDb3BpbG90IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NvcGlsb3QubW9uZXkiIH0sCiAgcm9ja2V0X21vbmV5OiB7IHJlZ2V4OiAvcm9ja2V0IG1vbmV5L2ksIG5hbWU6ICJSb2NrZXQgTW9uZXkiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vcm9ja2V0bW9uZXkuY29tIiB9LAogIGNyZWRpdF9rYXJtYTogeyByZWdleDogL2NyZWRpdCBrYXJtYS9pLCBuYW1lOiAiQ3JlZGl0IEthcm1hIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2NyZWRpdGthcm1hLmNvbSIgfSwKICBsaWZlX2xvY2s6IHsgcmVnZXg6IC9saWZlbG9ja3xub3J0b24vaSwgbmFtZTogIk5vcnRvbiBMaWZlTG9jayIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9ub3J0b24uY29tIiB9LAogIGV4cGVyaWFuOiB7IHJlZ2V4OiAvZXhwZXJpYW4vaSwgbmFtZTogIkV4cGVyaWFuIiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2V4cGVyaWFuLmNvbSIgfSwKICBlcXVpZmF4OiB7IHJlZ2V4OiAvZXF1aWZheC9pLCBuYW1lOiAiRXF1aWZheCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9lcXVpZmF4LmNvbSIgfSwKICB0cmFuc3VuaW9uOiB7IHJlZ2V4OiAvdHJhbnN1bmlvbi9pLCBuYW1lOiAiVHJhbnNVbmlvbiIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS90cmFuc3VuaW9uLmNvbSIgfSwKICAvLyA9PT0gVVNFUiBSRVFVRVNURUQgLyBBRERJVElPTkFMID09PQogIGF1dG9waWxvdDogeyByZWdleDogL2F1dG9waWxvdC9pLCBuYW1lOiAiQXV0b3BpbG90IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL2F1dG9waWxvdGhxLmNvbSIgfSwKICBwaXBlZmxhcmU6IHsgcmVnZXg6IC9waXBlZmxhcmUvaSwgbmFtZTogIlBpcGVGbGFyZSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9waXBlZmxhcmUuaW8iIH0sCiAgaWZ0dHQ6IHsgcmVnZXg6IC9pZnR0dC9pLCBuYW1lOiAiSUZUVFQiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vaWZ0dHQuY29tIiB9LAogIGVsYXN0aWNfZW1haWw6IHsgcmVnZXg6IC9lbGFzdGljZW1haWwvaSwgbmFtZTogIkVsYXN0aWMgRW1haWwiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZWxhc3RpY2VtYWlsLmNvbSIgfSwKICBnZWNrb2JvYXJkOiB7IHJlZ2V4OiAvZ2Vja29ib2FyZC9pLCBuYW1lOiAiR2Vja29ib2FyZCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9nZWNrb2JvYXJkLmNvbSIgfSwKICBjb250YWN0dWFsbHk6IHsgcmVnZXg6IC9jb250YWN0dWFsbHkvaSwgbmFtZTogIkNvbnRhY3R1YWxseSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9jb250YWN0dWFsbHkuY29tIiB9LAogIHVuaXR5OiB7IHJlZ2V4OiAvdW5pdHkvaSwgbmFtZTogIlVuaXR5IiwgY2F0ZWdvcnk6ICJTb2Z0d2FyZSIsIGxvZ286ICJodHRwczovL2xvZ28uY2xlYXJiaXQuY29tL3VuaXR5LmNvbSIgfSwKICBiaXRseTogeyByZWdleDogL2JpdGx5L2ksIG5hbWU6ICJCaXRseSIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9iaXRseS5jb20iIH0sCiAgZ29kYWRkeTogeyByZWdleDogL2dvZGFkZHkvaSwgbmFtZTogIkdvRGFkZHkiLCBjYXRlZ29yeTogIlNvZnR3YXJlIiwgbG9nbzogImh0dHBzOi8vbG9nby5jbGVhcmJpdC5jb20vZ29kYWRkeS5jb20iIH0sCiAgbmFtZWNoZWFwOiB7IHJlZ2V4OiAvbmFtZS0/Y2hlYXAvaSwgbmFtZTogIk5hbWVjaGVhcCIsIGNhdGVnb3J5OiAiU29mdHdhcmUiLCBsb2dvOiAiaHR0cHM6Ly9sb2dvLmNsZWFyYml0LmNvbS9uYW1lY2hlYXAuY29tIiB9Cn07CgovLyBzcmMvSnVzdENhbmNlbC50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZSA9IF9fdG9FU00ocmVxdWlyZV9qc3hfcnVudGltZSgpLCAxKTsKdmFyIFBERl9KU19WRVJTSU9OID0gIjUuNC41MzAiOwpHbG9iYWxXb3JrZXJPcHRpb25zLndvcmtlclNyYyA9IGBodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9wZGYuanMvJHtQREZfSlNfVkVSU0lPTn0vcGRmLndvcmtlci5taW4ubWpzYDsKdmFyIENPTE9SUyA9IHsKICBwcmltYXJ5OiAiIzU2QzU5NiIsCiAgcHJpbWFyeURhcms6ICIjM2FhODdiIiwKICBiZzogIiNGQUZBRkEiLAogIGNhcmQ6ICIjRkZGRkZGIiwKICB0ZXh0TWFpbjogIiMxQTFBMUEiLAogIHRleHRTZWNvbmRhcnk6ICIjOUNBM0FGIiwKICBib3JkZXI6ICIjRjNGNEY2IiwKICBpbnB1dEJnOiAiI0Y5RkFGQiIsCiAgYWNjZW50TGlnaHQ6ICIjRTZGN0YwIiwKICBibHVlOiAiIzVEOUNFQyIsCiAgeWVsbG93OiAiI0Y1OUUwQiIsCiAgcmVkOiAiI0ZGNkI2QiIsCiAgb3JhbmdlOiAiI0YyOTk0QSIsCiAgb3JhbmdlTGlnaHQ6ICIjRkZGN0VEIiwKICBwdXJwbGU6ICIjOEI1Q0Y2IiwKICBnb2xkOiAiI0Y1OUUwQiIsCiAgdGVhbDogIiMxNEI4QTYiCn07CnZhciBERUZBVUxUX1BST0ZJTEUgPSB7CiAgdXBsb2FkZWRGaWxlOiBudWxsLAogIGZpbGVOYW1lOiBudWxsLAogIGZpbGVUeXBlOiBudWxsLAogIG1hbnVhbFN1YnNjcmlwdGlvbnM6IFtdLAogIHRvdGFsTW9udGhseVNwZW5kOiAwLAogIHZpZXdGaWx0ZXI6ICJhbGwiLAogIGlzQW5hbHl6aW5nOiBmYWxzZSwKICBhbmFseXNpc0NvbXBsZXRlOiBmYWxzZQp9Owp2YXIgU0FNUExFX1BST0ZJTEUgPSB7CiAgLi4uREVGQVVMVF9QUk9GSUxFLAogIG1hbnVhbFN1YnNjcmlwdGlvbnM6IFsKICAgIHsKICAgICAgaWQ6ICJzYW1wbGUtdW5rbm93biIsCiAgICAgIHNlcnZpY2U6ICJVbmtub3duIFRyYW5zYWN0aW9uIiwKICAgICAgbW9udGhseUNvc3Q6IDI0Ljk5LAogICAgICBzdGF0dXM6ICJ1bmtub3duIiwKICAgICAgY2F0ZWdvcnk6ICJPdGhlciIsCiAgICAgIG9yaWdpbmFsRGVzY3JpcHRpb246ICJQT1MgREVCSVQgLSAwNDI5IC0gUkVDVVJSSU5HIFBBWU1FTlQgODgyMTkiCiAgICB9CiAgXSwKICB0b3RhbE1vbnRobHlTcGVuZDogMjQuOTksCiAgYW5hbHlzaXNDb21wbGV0ZTogdHJ1ZQp9Owp2YXIgU1RPUkFHRV9LRVkgPSAiSlVTVF9DQU5DRUxfREFUQSI7CnZhciBTVUJTQ1JJUFRJT05fQ0FURUdPUklFUyA9IFsKICAiRW50ZXJ0YWlubWVudCIsCiAgIk11c2ljIiwKICAiU29mdHdhcmUiLAogICJIZWFsdGggJiBGaXRuZXNzIiwKICAiU2hvcHBpbmciLAogICJVdGlsaXRpZXMiLAogICJOZXdzIiwKICAiT3RoZXIiCl07CnZhciBsb2FkU2F2ZWREYXRhID0gKCkgPT4gewogIHRyeSB7CiAgICBjb25zdCBzYXZlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUT1JBR0VfS0VZKTsKICAgIGlmIChzYXZlZCkgewogICAgICBjb25zdCB7IGRhdGEsIHRpbWVzdGFtcCB9ID0gSlNPTi5wYXJzZShzYXZlZCk7CiAgICAgIGlmICgoKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSB0aW1lc3RhbXApIC8gKDFlMyAqIDYwICogNjApIDwgNDgpIHsKICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfQogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFNUT1JBR0VfS0VZKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CnZhciBzYXZlRGF0YSA9IChkYXRhKSA9PiB7CiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZLCBKU09OLnN0cmluZ2lmeSh7IGRhdGEsIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgfSkpOwogIH0gY2F0Y2ggKGUpIHsKICB9Cn07CnZhciBwYXJzZVRleHRGb3JTdWJzY3JpcHRpb25zID0gKHRleHQpID0+IHsKICBjb25zdCBsaW5lcyA9IHRleHQuc3BsaXQoL1xyP1xuLyk7CiAgY29uc3QgZm91bmRTdWJzY3JpcHRpb25zID0ge307CiAgbGluZXMuZm9yRWFjaCgobGluZSwgaW5kZXgpID0+IHsKICAgIGlmIChsaW5lLmxlbmd0aCA8IDUpIHJldHVybjsKICAgIGNvbnN0IGxvd2VyTGluZSA9IGxpbmUudG9Mb3dlckNhc2UoKTsKICAgIE9iamVjdC52YWx1ZXMoU1VCU0NSSVBUSU9OX1BBVFRFUk5TKS5mb3JFYWNoKChwYXR0ZXJuKSA9PiB7CiAgICAgIGlmIChwYXR0ZXJuLnJlZ2V4LnRlc3QobG93ZXJMaW5lKSkgewogICAgICAgIGNvbnN0IHByaWNlTWF0Y2ggPSBsaW5lLm1hdGNoKC8oXGQrXC5cZHsyfSkvKTsKICAgICAgICBsZXQgY29zdCA9IDA7CiAgICAgICAgaWYgKHByaWNlTWF0Y2gpIHsKICAgICAgICAgIGNvc3QgPSBwYXJzZUZsb2F0KHByaWNlTWF0Y2hbMF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAocGF0dGVybi5uYW1lID09PSAiTmV0ZmxpeCIpIGNvc3QgPSAxNS40OTsKICAgICAgICAgIGlmIChwYXR0ZXJuLm5hbWUgPT09ICJTcG90aWZ5IikgY29zdCA9IDExLjk5OwogICAgICAgICAgaWYgKHBhdHRlcm4ubmFtZSA9PT0gIkNoYXRHUFQiKSBjb3N0ID0gMjA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGV4aXN0aW5nID0gZm91bmRTdWJzY3JpcHRpb25zW3BhdHRlcm4ubmFtZV07CiAgICAgICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgICAgICBleGlzdGluZy5jb3VudCA9IChleGlzdGluZy5jb3VudCB8fCAxKSArIDE7CiAgICAgICAgICBpZiAoZXhpc3RpbmcubW9udGhseUNvc3QgPT09IDAgJiYgY29zdCA+IDApIGV4aXN0aW5nLm1vbnRobHlDb3N0ID0gY29zdDsKICAgICAgICAgIGlmIChsaW5lLmxlbmd0aCA+IChleGlzdGluZy5vcmlnaW5hbERlc2NyaXB0aW9uPy5sZW5ndGggfHwgMCkpIHsKICAgICAgICAgICAgZXhpc3Rpbmcub3JpZ2luYWxEZXNjcmlwdGlvbiA9IGxpbmUudHJpbSgpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3VuZFN1YnNjcmlwdGlvbnNbcGF0dGVybi5uYW1lXSA9IHsKICAgICAgICAgICAgaWQ6IGBzdWItJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YCwKICAgICAgICAgICAgc2VydmljZTogcGF0dGVybi5uYW1lLAogICAgICAgICAgICBtb250aGx5Q29zdDogY29zdCA+IDAgPyBjb3N0IDogMCwKICAgICAgICAgICAgc3RhdHVzOiAiY29uZmlybWVkX3N1YnNjcmlwdGlvbiIsCiAgICAgICAgICAgIC8vIERlZmF1bHQgc3RhdHVzIC0gYXNzdW1lIHJlZ2V4IG1hdGNoIGlzIGNvbmZpcm1lZAogICAgICAgICAgICBjYXRlZ29yeTogcGF0dGVybi5jYXRlZ29yeSwKICAgICAgICAgICAgbG9nbzogcGF0dGVybi5sb2dvLAogICAgICAgICAgICBvcmlnaW5hbERlc2NyaXB0aW9uOiBsaW5lLnRyaW0oKSwKICAgICAgICAgICAgY2xlYW5EZXNjcmlwdGlvbjogYCR7cGF0dGVybi5jYXRlZ29yeX0gc3Vic2NyaXB0aW9uYCwKICAgICAgICAgICAgLy8gR2VuZXJpYyBkZXNjcmlwdGlvbiBmb3Igbm93CiAgICAgICAgICAgIGNvdW50OiAxCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSk7CiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoZm91bmRTdWJzY3JpcHRpb25zKTsKfTsKdmFyIGdldFNlcnZlclVybCA9ICgpID0+IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSA9PT0gImxvY2FsaG9zdCIgPyAiIiA6ICJodHRwczovL2p1c3QtY2FuY2VsLWl0Lm9ucmVuZGVyLmNvbSI7CnZhciBleHRyYWN0VGV4dEZyb21QREYgPSBhc3luYyAoZmlsZURhdGEpID0+IHsKICB0cnkgewogICAgY29uc3QgcGRmID0gYXdhaXQgZ2V0RG9jdW1lbnQoeyBkYXRhOiBmaWxlRGF0YSB9KS5wcm9taXNlOwogICAgbGV0IGZ1bGxUZXh0ID0gIiI7CiAgICBpZiAocGRmLm51bVBhZ2VzID09PSAwKSB7CiAgICAgIHJldHVybiB7IHRleHQ6ICIiLCBlcnJvcjogIlBERiBoYXMgbm8gcGFnZXMuIiB9OwogICAgfQogICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gcGRmLm51bVBhZ2VzOyBpKyspIHsKICAgICAgY29uc3QgcGFnZSA9IGF3YWl0IHBkZi5nZXRQYWdlKGkpOwogICAgICBjb25zdCB0ZXh0Q29udGVudCA9IGF3YWl0IHBhZ2UuZ2V0VGV4dENvbnRlbnQoKTsKICAgICAgY29uc3QgcGFnZVRleHQgPSB0ZXh0Q29udGVudC5pdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uc3RyKS5qb2luKCIgIik7CiAgICAgIGZ1bGxUZXh0ICs9IHBhZ2VUZXh0ICsgIlxuIjsKICAgIH0KICAgIHJldHVybiB7IHRleHQ6IGZ1bGxUZXh0IH07CiAgfSBjYXRjaCAoZSkgewogICAgY29uc29sZS53YXJuKCJbSnVzdCBDYW5jZWxdIENsaWVudC1zaWRlIFBERiBQYXJzZSBmYWlsZWQsIHRyeWluZyBzZXJ2ZXIgZmFsbGJhY2suLi4iLCBlKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHNlcnZlclVybCA9IGdldFNlcnZlclVybCgpOwogICAgICBjb25zdCBiYXNlNjQgPSBidG9hKG5ldyBVaW50OEFycmF5KGZpbGVEYXRhKS5yZWR1Y2UoKGRhdGEsIGJ5dGUpID0+IGRhdGEgKyBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGUpLCAiIikpOwogICAgICBjb25zb2xlLmxvZygiW0p1c3QgQ2FuY2VsXSBBdHRlbXB0aW5nIHNlcnZlci1zaWRlIFBERiBleHRyYWN0aW9uIiwgeyBzZXJ2ZXJVcmwgfSk7CiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7c2VydmVyVXJsfS9hcGkvZXh0cmFjdC1wZGZgLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBiYXNlNjQgfSkKICAgICAgfSk7CiAgICAgIGNvbnNvbGUubG9nKCJbSnVzdCBDYW5jZWxdIC9hcGkvZXh0cmFjdC1wZGYgcmVzcG9uc2UiLCB7IG9rOiByZXNwb25zZS5vaywgc3RhdHVzOiByZXNwb25zZS5zdGF0dXMsIHN0YXR1c1RleHQ6IHJlc3BvbnNlLnN0YXR1c1RleHQgfSk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgICAgaWYgKHJlc3VsdC50ZXh0KSB7CiAgICAgICAgY29uc29sZS5sb2coIltKdXN0IENhbmNlbF0gU2VydmVyLXNpZGUgZXh0cmFjdGlvbiBzdWNjZXNzZnVsLiIpOwogICAgICAgIHJldHVybiB7IHRleHQ6IHJlc3VsdC50ZXh0IH07CiAgICAgIH0KICAgICAgdGhyb3cgbmV3IEVycm9yKHJlc3VsdC5lcnJvciB8fCAiU2VydmVyIGV4dHJhY3Rpb24gcmV0dXJuZWQgbm8gdGV4dCIpOwogICAgfSBjYXRjaCAoZmFsbGJhY2tFcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJbSnVzdCBDYW5jZWxdIEJvdGggY2xpZW50IGFuZCBzZXJ2ZXIgZXh0cmFjdGlvbiBmYWlsZWQuIiwgZmFsbGJhY2tFcnJvcik7CiAgICAgIHJldHVybiB7IHRleHQ6ICIiLCBlcnJvcjogYFBERiBleHRyYWN0aW9uIGZhaWxlZDogJHtmYWxsYmFja0Vycm9yLm1lc3NhZ2V9YCB9OwogICAgfQogIH0KfTsKdmFyIFdBTExfT0ZfU0FWSU5HU19EQVRBID0gWwogIHsgaWQ6IDEsIG5hbWU6ICJBbGV4IE0uIiwgc2F2ZWQ6ICIkNDIwL3lyIiwgdGV4dDogIkZvcmdvdCBJIHdhcyBwYXlpbmcgZm9yIEFkb2JlIEFORCBDYW52YS4gQ2FuY2VsbGVkIGltbWVkaWF0ZWx5LiIsIHNvdXJjZTogInR3aXR0ZXIiIH0sCiAgeyBpZDogMiwgbmFtZTogIlNhcmFoIEsuIiwgc2F2ZWQ6ICIkMSwyMDAveXIiLCB0ZXh0OiAiRm91bmQgYSBneW0gbWVtYmVyc2hpcCBmcm9tIDIwMTkgcnVubmluZyBvbiBteSBvbGQgY2FyZC4iLCBzb3VyY2U6ICJ0d2l0dGVyIiB9LAogIHsgaWQ6IDMsIG5hbWU6ICJNaWtlIFIuIiwgc2F2ZWQ6ICIkMTU2L3lyIiwgdGV4dDogIk5ldGZsaXggKyBIdWx1ICsgRGlzbmV5KyBidW5kbGUgc2F2ZWQgbWUgJDEzL21vLiIsIHNvdXJjZTogInR3aXR0ZXIiIH0sCiAgeyBpZDogNCwgbmFtZTogIkphc21pbmUiLCBzYXZlZDogIiQ4OTAveXIiLCB0ZXh0OiAiQW5hbHlzaXMgdG9vayAzMCBzZWNvbmRzLiBTYXZlZCBlbm91Z2ggZm9yIGEgZmxpZ2h0IHRvIFRva3lvLiIsIHNvdXJjZTogInR3aXR0ZXIiIH0KXTsKdmFyIEFOQUxZU0lTX1NURVBTID0gWwogICJDb25uZWN0aW5nIHRvIHNlY3VyZSBsb2NhbCBwcm9jZXNzb3IuLi4iLAogICJTY2FubmluZyB0cmFuc2FjdGlvbiBoaXN0b3J5Li4uIiwKICAiSWRlbnRpZnlpbmcgcmVjdXJyaW5nIHBhdHRlcm5zLi4uIiwKICAiQ2FsY3VsYXRpbmcgcG90ZW50aWFsIHNhdmluZ3MuLi4iLAogICJGaW5hbGl6aW5nIHlvdXIgcmVwb3J0Li4uIgpdOwp2YXIgdHJhY2tFdmVudCA9IChldmVudCwgZGF0YSA9IHt9KSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IHNlcnZlclVybCA9IGdldFNlcnZlclVybCgpOwogICAgZmV0Y2goYCR7c2VydmVyVXJsfS9hcGkvdHJhY2tgLCB7CiAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBldmVudCwgZGF0YSB9KQogICAgfSkuY2F0Y2goKCkgPT4gewogICAgfSk7CiAgfSBjYXRjaCB7CiAgfQp9Owp2YXIgU2hhcmVCdXR0b24gPSAoeyBzYXZpbmdzIH0pID0+IHsKICBjb25zdCB0ZXh0ID0gYEp1c3Qgc2F2ZWQgJCR7c2F2aW5ncy50b0ZpeGVkKDApfS95ciB3aXRoIGp1c3QtY2FuY2VsLWl0Lm9ucmVuZGVyLmNvbSBcdXsxRjkyRn0gU2NhbiB5b3VyIGJhbmsgc3RhdGVtZW50IHRvIGZpbmQgc3Vic2NyaXB0aW9ucyB5b3UgZm9yZ290IGFib3V0LmA7CiAgY29uc3QgdXJsID0gYGh0dHBzOi8vdHdpdHRlci5jb20vaW50ZW50L3R3ZWV0P3RleHQ9JHtlbmNvZGVVUklDb21wb25lbnQodGV4dCl9YDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAiYSIsCiAgICB7CiAgICAgIGhyZWY6IHVybCwKICAgICAgdGFyZ2V0OiAiX2JsYW5rIiwKICAgICAgcmVsOiAibm9vcGVuZXIgbm9yZWZlcnJlciIsCiAgICAgIG9uQ2xpY2s6ICgpID0+IHRyYWNrRXZlbnQoInNoYXJlX2NsaWNrIiwgeyBzYXZpbmdzIH0pLAogICAgICBzdHlsZTogewogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgZ2FwOiA4LAogICAgICAgIGJhY2tncm91bmRDb2xvcjogIiMxREExRjIiLAogICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgIHBhZGRpbmc6ICIxMnB4IDI0cHgiLAogICAgICAgIGJvcmRlclJhZGl1czogMzAsCiAgICAgICAgdGV4dERlY29yYXRpb246ICJub25lIiwKICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgZm9udFNpemU6IDE1LAogICAgICAgIHRyYW5zaXRpb246ICJ0cmFuc2Zvcm0gMC4ycyIsCiAgICAgICAgYm94U2hhZG93OiAiMCA0cHggMTJweCByZ2JhKDI5LCAxNjEsIDI0MiwgMC4zKSIKICAgICAgfSwKICAgICAgb25Nb3VzZU92ZXI6IChlKSA9PiBlLmN1cnJlbnRUYXJnZXQuc3R5bGUudHJhbnNmb3JtID0gInNjYWxlKDEuMDIpIiwKICAgICAgb25Nb3VzZU91dDogKGUpID0+IGUuY3VycmVudFRhcmdldC5zdHlsZS50cmFuc2Zvcm0gPSAic2NhbGUoMSkiLAogICAgICBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInN2ZyIsIHsgd2lkdGg6ICIxOCIsIGhlaWdodDogIjE4Iiwgdmlld0JveDogIjAgMCAyNCAyNCIsIGZpbGw6ICJjdXJyZW50Q29sb3IiLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicGF0aCIsIHsgZDogIk0yMy45NTMgNC41N2ExMCAxMCAwIDAxLTIuODI1Ljc3NSA0Ljk1OCA0Ljk1OCAwIDAwMi4xNjMtMi43MjNjLS45NTEuNTU1LTIuMDA1Ljk1OS0zLjEyNyAxLjE4NGE0LjkyIDQuOTIgMCAwMC04LjM4NCA0LjQ4MkM3LjY5IDguMDk1IDQuMDY3IDYuMTMgMS42NCAzLjE2MmE0LjgyMiA0LjgyMiAwIDAwLS42NjYgMi40NzVjMCAxLjcxLjg3IDMuMjEzIDIuMTg4IDQuMDk2YTQuOTA0IDQuOTA0IDAgMDEtMi4yMjgtLjYxNnYuMDZhNC45MjMgNC45MjMgMCAwMDMuOTQ2IDQuODI3IDQuOTk2IDQuOTk2IDAgMDEtMi4yMTIuMDg1IDQuOTM2IDQuOTM2IDAgMDA0LjYwNCAzLjQxNyA5Ljg2NyA5Ljg2NyAwIDAxLTYuMTAyIDIuMTA1Yy0uMzkgMC0uNzc5LS4wMjMtMS4xNy0uMDY3YTEzLjk5NSAxMy45OTUgMCAwMDcuNTU3IDIuMjA5YzkuMDUzIDAgMTMuOTk4LTcuNDk2IDEzLjk5OC0xMy45ODUgMC0uMjEgMC0uNDItLjAxNS0uNjNBOS45MzUgOS45MzUgMCAwMDI0IDQuNTl6IiB9KSB9KSwKICAgICAgICAiU2hhcmUgeW91ciBzYXZpbmdzIgogICAgICBdCiAgICB9CiAgKTsKfTsKZnVuY3Rpb24gSnVzdENhbmNlbCh7IGluaXRpYWxEYXRhOiBpbml0aWFsRGF0YTIgfSkgewogIGNvbnN0IFtwcm9maWxlLCBzZXRQcm9maWxlXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKSgoKSA9PiB7CiAgICBpZiAoaW5pdGlhbERhdGEyICYmIChpbml0aWFsRGF0YTIuc3Vic2NyaXB0aW9ucyAmJiBpbml0aWFsRGF0YTIuc3Vic2NyaXB0aW9ucy5sZW5ndGggPiAwIHx8IGluaXRpYWxEYXRhMi50b3RhbF9tb250aGx5X3NwZW5kICYmIGluaXRpYWxEYXRhMi50b3RhbF9tb250aGx5X3NwZW5kID4gMCkpIHsKICAgICAgY29uc29sZS5sb2coIltKdXN0IENhbmNlbF0gSHlkcmF0aW5nIGZyb20gT3BlbkFJIHRvb2wgZGF0YToiLCBpbml0aWFsRGF0YTIpOwogICAgICByZXR1cm4gewogICAgICAgIC4uLkRFRkFVTFRfUFJPRklMRSwKICAgICAgICBtYW51YWxTdWJzY3JpcHRpb25zOiBpbml0aWFsRGF0YTIuc3Vic2NyaXB0aW9ucyB8fCBbXSwKICAgICAgICB0b3RhbE1vbnRobHlTcGVuZDogaW5pdGlhbERhdGEyLnRvdGFsX21vbnRobHlfc3BlbmQgfHwgMCwKICAgICAgICBhbmFseXNpc0NvbXBsZXRlOiB0cnVlLAogICAgICAgIGFuYWx5c2lzSW5Qcm9ncmVzczogZmFsc2UKICAgICAgfTsKICAgIH0KICAgIGlmICh0eXBlb2Ygc2Vzc2lvblN0b3JhZ2UgIT09ICJ1bmRlZmluZWQiICYmIHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oIkpVU1RfQ0FOQ0VMX0ZPUkNFX1JFU0VUIikpIHsKICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgiSlVTVF9DQU5DRUxfRk9SQ0VfUkVTRVQiKTsKICAgICAgY29uc29sZS5sb2coIltKdXN0IENhbmNlbF0gRm9yY2VkIHJlc2V0IC0gcmV0dXJuaW5nIHRvIGxhbmRpbmcgcGFnZS4iKTsKICAgICAgcmV0dXJuIERFRkFVTFRfUFJPRklMRTsKICAgIH0KICAgIGNvbnN0IHNhdmVkID0gbG9hZFNhdmVkRGF0YSgpOwogICAgaWYgKHNhdmVkKSByZXR1cm4gc2F2ZWQ7CiAgICBpZiAodHlwZW9mIGxvY2FsU3RvcmFnZSAhPT0gInVuZGVmaW5lZCIgJiYgIWxvY2FsU3RvcmFnZS5nZXRJdGVtKCJKVVNUX0NBTkNFTF9TRUVOX1NBTVBMRSIpKSB7CiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJKVVNUX0NBTkNFTF9TRUVOX1NBTVBMRSIsICJ0cnVlIik7CiAgICAgIHJldHVybiBTQU1QTEVfUFJPRklMRTsKICAgIH0KICAgIHJldHVybiBERUZBVUxUX1BST0ZJTEU7CiAgfSk7CiAgY29uc3QgW3Nob3dNYW51YWxJbnB1dCwgc2V0U2hvd01hbnVhbElucHV0XSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW21hbnVhbFNlcnZpY2UsIHNldE1hbnVhbFNlcnZpY2VdID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbbWFudWFsQ29zdCwgc2V0TWFudWFsQ29zdF0gPSAoMCwgaW1wb3J0X3JlYWN0My51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFttYW51YWxDYXRlZ29yeSwgc2V0TWFudWFsQ2F0ZWdvcnldID0gKDAsIGltcG9ydF9yZWFjdDMudXNlU3RhdGUpKCJPdGhlciIpOwogIGNvbnN0IFtkcmFnQWN0aXZlLCBzZXREcmFnQWN0aXZlXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2FuYWx5c2lzU3RlcCwgc2V0QW5hbHlzaXNTdGVwXSA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZVN0YXRlKShBTkFMWVNJU19TVEVQU1swXSk7CiAgY29uc3QgZ29Ib21lID0gKCkgPT4gewogICAgY29uc29sZS5sb2coIltKdXN0IENhbmNlbF0gR29pbmcgaG9tZSAocmVzZXQgdG8gbGFuZGluZyB2aWV3KS4uLiIpOwogICAgdHJ5IHsKICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oU1RPUkFHRV9LRVkpOwogICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiSlVTVF9DQU5DRUxfREFUQSIpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25zb2xlLmVycm9yKCJbSnVzdCBDYW5jZWxdIEZhaWxlZCB0byBjbGVhciBzdG9yYWdlIGR1cmluZyBnb0hvbWU6IiwgZSk7CiAgICB9CiAgICBzZXRTaG93TWFudWFsSW5wdXQoZmFsc2UpOwogICAgc2V0UHJvZmlsZShERUZBVUxUX1BST0ZJTEUpOwogIH07CiAgY29uc3Qgb3BlbkZlZWRiYWNrID0gKCkgPT4gewogICAgY29uc3QgdXJsID0gIm1haWx0bzpoZWxsb0BqdXN0Y2FuY2VsLmlvIjsKICAgIHRyeSB7CiAgICAgIGNvbnN0IG9hID0gd2luZG93Lm9wZW5haTsKICAgICAgaWYgKG9hICYmIHR5cGVvZiBvYS5vcGVuRXh0ZXJuYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBvYS5vcGVuRXh0ZXJuYWwodXJsKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiW0p1c3QgQ2FuY2VsXSBvcGVuRXh0ZXJuYWwgZmFpbGVkOiIsIGUpOwogICAgfQogICAgdHJ5IHsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIltKdXN0IENhbmNlbF0gbWFpbHRvIG5hdmlnYXRpb24gZmFpbGVkOiIsIGUpOwogICAgfQogIH07CiAgKDAsIGltcG9ydF9yZWFjdDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJvZmlsZS5hbmFseXNpc0NvbXBsZXRlID09PSBmYWxzZSAmJiBwcm9maWxlLm1hbnVhbFN1YnNjcmlwdGlvbnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFNUT1JBR0VfS0VZKTsKICAgIH0KICB9LCBbcHJvZmlsZS5hbmFseXNpc0NvbXBsZXRlXSk7CiAgKDAsIGltcG9ydF9yZWFjdDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBzYXZlRGF0YShwcm9maWxlKTsKICB9LCBbcHJvZmlsZV0pOwogICgwLCBpbXBvcnRfcmVhY3QzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY29uc3Qgc2VydmVyVXJsID0gZ2V0U2VydmVyVXJsKCk7CiAgICBjb25zdCBwaW5nID0gKCkgPT4gewogICAgICBmZXRjaChgJHtzZXJ2ZXJVcmx9L2FwaS9oZWFydGJlYXRgKS50aGVuKChyZXMpID0+IHJlcy5qc29uKCkpLnRoZW4oKGRhdGEpID0+IGNvbnNvbGUubG9nKCJbSGVhcnRiZWF0XSBQdWxzZSByZWNlaXZlZDoiLCBkYXRhLnRpbWVzdGFtcCkpLmNhdGNoKChlcnIpID0+IGNvbnNvbGUuZXJyb3IoIltIZWFydGJlYXRdIFB1bHNlIGZhaWxlZDoiLCBlcnIpKTsKICAgIH07CiAgICBwaW5nKCk7CiAgICBjb25zdCBpbnRlcnZhbCA9IHNldEludGVydmFsKHBpbmcsIDNlNCk7CiAgICByZXR1cm4gKCkgPT4gY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7CiAgfSwgW10pOwogIGNvbnN0IGhhbmRsZURyYWcgPSAoZSkgPT4gewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIGlmIChlLnR5cGUgPT09ICJkcmFnZW50ZXIiIHx8IGUudHlwZSA9PT0gImRyYWdvdmVyIikgewogICAgICBzZXREcmFnQWN0aXZlKHRydWUpOwogICAgfSBlbHNlIGlmIChlLnR5cGUgPT09ICJkcmFnbGVhdmUiKSB7CiAgICAgIHNldERyYWdBY3RpdmUoZmFsc2UpOwogICAgfQogIH07CiAgY29uc3QgcHJvY2Vzc0ZpbGUgPSBhc3luYyAoZmlsZSkgPT4gewogICAgc2V0UHJvZmlsZSgocCkgPT4gKHsgLi4ucCwgaXNBbmFseXppbmc6IHRydWUsIGFuYWx5c2lzQ29tcGxldGU6IGZhbHNlLCBmaWxlTmFtZTogZmlsZS5uYW1lLCBmaWxlVHlwZTogZmlsZS50eXBlLmluY2x1ZGVzKCJwZGYiKSA/ICJwZGYiIDogImNzdiIsIHVwbG9hZGVkRmlsZTogVVJMLmNyZWF0ZU9iamVjdFVSTChmaWxlKSB9KSk7CiAgICBzZXRBbmFseXNpc1N0ZXAoIlJlYWRpbmcgZmlsZS4uLiIpOwogICAgYXdhaXQgbmV3IFByb21pc2UoKHIpID0+IHNldFRpbWVvdXQociwgMTUwMCkpOwogICAgbGV0IGNvbnRlbnQgPSAiIjsKICAgIGxldCBleHRyYWN0aW9uRXJyb3IgPSAiIjsKICAgIGlmIChmaWxlLnR5cGUuaW5jbHVkZXMoInBkZiIpKSB7CiAgICAgIHNldEFuYWx5c2lzU3RlcCgiRXh0cmFjdGluZyB0ZXh0IGZyb20gUERGLi4uIik7CiAgICAgIGNvbnN0IGFycmF5QnVmZmVyID0gYXdhaXQgZmlsZS5hcnJheUJ1ZmZlcigpOwogICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBleHRyYWN0VGV4dEZyb21QREYoYXJyYXlCdWZmZXIpOwogICAgICBjb250ZW50ID0gcmVzdWx0LnRleHQ7CiAgICAgIGV4dHJhY3Rpb25FcnJvciA9IHJlc3VsdC5lcnJvciB8fCAiIjsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnRlbnQgPSBhd2FpdCBmaWxlLnRleHQoKTsKICAgIH0KICAgIHNldEFuYWx5c2lzU3RlcCgiSWRlbnRpZnlpbmcgcGF0dGVybnMuLi4iKTsKICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIDE1MDApKTsKICAgIHNldEFuYWx5c2lzU3RlcCgiQ2FsY3VsYXRpbmcgcG90ZW50aWFsIHNhdmluZ3MuLi4iKTsKICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKSA9PiBzZXRUaW1lb3V0KHIsIDE1MDApKTsKICAgIGNvbnN0IG5ld1N1YnNjcmlwdGlvbnMgPSBwYXJzZVRleHRGb3JTdWJzY3JpcHRpb25zKGNvbnRlbnQpOwogICAgc2V0UHJvZmlsZSgocCkgPT4gewogICAgICBjb25zdCBtZXJnZWRNYXAgPSB7fTsKICAgICAgcC5tYW51YWxTdWJzY3JpcHRpb25zLmZvckVhY2goKHN1YikgPT4gewogICAgICAgIG1lcmdlZE1hcFtzdWIuc2VydmljZS50b0xvd2VyQ2FzZSgpXSA9IHN1YjsKICAgICAgfSk7CiAgICAgIG5ld1N1YnNjcmlwdGlvbnMuZm9yRWFjaCgobmV3U3ViKSA9PiB7CiAgICAgICAgY29uc3Qga2V5ID0gbmV3U3ViLnNlcnZpY2UudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAoIW1lcmdlZE1hcFtrZXldKSB7CiAgICAgICAgICBtZXJnZWRNYXBba2V5XSA9IG5ld1N1YjsKICAgICAgICB9IGVsc2UgewogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGNvbnN0IG1lcmdlZExpc3QgPSBPYmplY3QudmFsdWVzKG1lcmdlZE1hcCk7CiAgICAgIGNvbnN0IG5ld1RvdGFsID0gbWVyZ2VkTGlzdC5yZWR1Y2UoKHN1bSwgcykgPT4gc3VtICsgcy5tb250aGx5Q29zdCwgMCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgLi4ucCwKICAgICAgICBtYW51YWxTdWJzY3JpcHRpb25zOiBtZXJnZWRMaXN0LAogICAgICAgIHRvdGFsTW9udGhseVNwZW5kOiBuZXdUb3RhbCwKICAgICAgICBpc0FuYWx5emluZzogZmFsc2UsCiAgICAgICAgYW5hbHlzaXNDb21wbGV0ZTogdHJ1ZSwKICAgICAgICBleHRyYWN0ZWRUZXh0OiBjb250ZW50LAogICAgICAgIHBhcnNpbmdFcnJvcjogZXh0cmFjdGlvbkVycm9yCiAgICAgIH07CiAgICB9KTsKICAgIHRyYWNrRXZlbnQoImFuYWx5c2lzX2NvbXBsZXRlIiwgeyBmaWxlTmFtZTogZmlsZS5uYW1lLCBzdWJzY3JpcHRpb25Db3VudDogbmV3U3Vic2NyaXB0aW9ucy5sZW5ndGggfSk7CiAgfTsKICBjb25zdCBoYW5kbGVEcm9wID0gKGUpID0+IHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICBzZXREcmFnQWN0aXZlKGZhbHNlKTsKICAgIGlmIChlLmRhdGFUcmFuc2Zlci5maWxlcyAmJiBlLmRhdGFUcmFuc2Zlci5maWxlc1swXSkgewogICAgICBwcm9jZXNzRmlsZShlLmRhdGFUcmFuc2Zlci5maWxlc1swXSk7CiAgICB9CiAgfTsKICBjb25zdCBoYW5kbGVGaWxlQ2hhbmdlID0gKGUpID0+IHsKICAgIGlmIChlLnRhcmdldC5maWxlcyAmJiBlLnRhcmdldC5maWxlc1swXSkgewogICAgICBwcm9jZXNzRmlsZShlLnRhcmdldC5maWxlc1swXSk7CiAgICB9CiAgfTsKICBjb25zdCBhZGRNYW51YWxTdWJzY3JpcHRpb24gPSAoKSA9PiB7CiAgICBpZiAoIW1hbnVhbFNlcnZpY2UgfHwgIW1hbnVhbENvc3QpIHJldHVybjsKICAgIGNvbnN0IGNvc3QgPSBwYXJzZUZsb2F0KG1hbnVhbENvc3QucmVwbGFjZSgiJCIsICIiKSk7CiAgICBpZiAoaXNOYU4oY29zdCkpIHJldHVybjsKICAgIGNvbnN0IG5ld0l0ZW0gPSB7CiAgICAgIGlkOiBgbWFudWFsLSR7RGF0ZS5ub3coKX1gLAogICAgICBzZXJ2aWNlOiBtYW51YWxTZXJ2aWNlLAogICAgICBtb250aGx5Q29zdDogY29zdCwKICAgICAgc3RhdHVzOiAia2VlcGluZyIsCiAgICAgIC8vIERlZmF1bHQKICAgICAgY2F0ZWdvcnk6IG1hbnVhbENhdGVnb3J5CiAgICB9OwogICAgc2V0UHJvZmlsZSgocCkgPT4gKHsKICAgICAgLi4ucCwKICAgICAgbWFudWFsU3Vic2NyaXB0aW9uczogW25ld0l0ZW0sIC4uLnAubWFudWFsU3Vic2NyaXB0aW9uc10sCiAgICAgIHRvdGFsTW9udGhseVNwZW5kOiBwLnRvdGFsTW9udGhseVNwZW5kICsgbmV3SXRlbS5tb250aGx5Q29zdAogICAgfSkpOwogICAgc2V0TWFudWFsU2VydmljZSgiIik7CiAgICBzZXRNYW51YWxDb3N0KCIiKTsKICAgIHNldFNob3dNYW51YWxJbnB1dChmYWxzZSk7CiAgICB0cmFja0V2ZW50KCJtYW51YWxfYWRkIiwgeyBzZXJ2aWNlOiBtYW51YWxTZXJ2aWNlIH0pOwogIH07CiAgY29uc3QgdXBkYXRlU3RhdHVzID0gKGlkLCBzdGF0dXMpID0+IHsKICAgIHNldFByb2ZpbGUoKHApID0+ICh7CiAgICAgIC4uLnAsCiAgICAgIG1hbnVhbFN1YnNjcmlwdGlvbnM6IHAubWFudWFsU3Vic2NyaXB0aW9ucy5tYXAoCiAgICAgICAgKHMpID0+IHMuaWQgPT09IGlkID8geyAuLi5zLCBzdGF0dXMgfSA6IHMKICAgICAgKQogICAgfSkpOwogIH07CiAgY29uc3QgcmVtb3ZlU3Vic2NyaXB0aW9uID0gKGlkKSA9PiB7CiAgICBjb25zdCBzdWIgPSBwcm9maWxlLm1hbnVhbFN1YnNjcmlwdGlvbnMuZmluZCgocykgPT4gcy5pZCA9PT0gaWQpOwogICAgaWYgKHN1YikgewogICAgICBzZXRQcm9maWxlKChwKSA9PiAoewogICAgICAgIC4uLnAsCiAgICAgICAgbWFudWFsU3Vic2NyaXB0aW9uczogcC5tYW51YWxTdWJzY3JpcHRpb25zLmZpbHRlcigocykgPT4gcy5pZCAhPT0gaWQpLAogICAgICAgIHRvdGFsTW9udGhseVNwZW5kOiBwLnRvdGFsTW9udGhseVNwZW5kIC0gc3ViLm1vbnRobHlDb3N0CiAgICAgIH0pKTsKICAgIH0KICB9OwogIGNvbnN0IGdldEZpbHRlcmVkU3Vic2NyaXB0aW9ucyA9ICgpID0+IHsKICAgIGNvbnN0IHZhbGlkU3VicyA9IHByb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9ucy5maWx0ZXIoKHMpID0+IHMubW9udGhseUNvc3QgPiAwKTsKICAgIGlmIChwcm9maWxlLnZpZXdGaWx0ZXIgPT09ICJhbGwiKSByZXR1cm4gdmFsaWRTdWJzOwogICAgaWYgKHByb2ZpbGUudmlld0ZpbHRlciA9PT0gImFwcHJvdmVkIikgewogICAgICByZXR1cm4gdmFsaWRTdWJzLmZpbHRlcigocykgPT4gcy5zdGF0dXMgPT09ICJrZWVwaW5nIik7CiAgICB9CiAgICBpZiAocHJvZmlsZS52aWV3RmlsdGVyID09PSAiY29uZmlybWVkX3N1YnNjcmlwdGlvbiIpIHsKICAgICAgcmV0dXJuIHZhbGlkU3Vicy5maWx0ZXIoCiAgICAgICAgKHMpID0+IHMuc3RhdHVzID09PSAiY29uZmlybWVkX3N1YnNjcmlwdGlvbiIgfHwgcy5zdGF0dXMgPT09ICJjYW5jZWxsaW5nIgogICAgICApOwogICAgfQogICAgcmV0dXJuIHZhbGlkU3Vicy5maWx0ZXIoKHMpID0+IHMuc3RhdHVzID09PSBwcm9maWxlLnZpZXdGaWx0ZXIpOwogIH07CiAgY29uc3Qgc3RhdHVzQ291bnRzID0gKDAsIGltcG9ydF9yZWFjdDMudXNlTWVtbykoKCkgPT4gewogICAgY29uc3Qgc3VicyA9IHByb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9uczsKICAgIHJldHVybiB7CiAgICAgIGNvbmZpcm1lZDogc3Vicy5maWx0ZXIoKHMpID0+IHMuc3RhdHVzID09PSAiY29uZmlybWVkX3N1YnNjcmlwdGlvbiIgfHwgcy5zdGF0dXMgPT09ICJjYW5jZWxsaW5nIikubGVuZ3RoLAogICAgICBhcHByb3ZlZDogc3Vicy5maWx0ZXIoKHMpID0+IHMuc3RhdHVzID09PSAia2VlcGluZyIpLmxlbmd0aCwKICAgICAgcmVqZWN0ZWQ6IHN1YnMuZmlsdGVyKChzKSA9PiBzLnN0YXR1cyA9PT0gIm5vdF9zdWJzY3JpcHRpb24iKS5sZW5ndGgsCiAgICAgIHVua25vd246IHN1YnMuZmlsdGVyKChzKSA9PiBzLnN0YXR1cyA9PT0gInVua25vd24iIHx8IHMuc3RhdHVzID09PSAiaW52ZXN0aWdhdGluZyIpLmxlbmd0aAogICAgfTsKICB9LCBbcHJvZmlsZS5tYW51YWxTdWJzY3JpcHRpb25zXSk7CiAgY29uc3QgcG90ZW50aWFsU2F2aW5ncyA9ICgwLCBpbXBvcnRfcmVhY3QzLnVzZU1lbW8pKCgpID0+IHsKICAgIHJldHVybiBwcm9maWxlLm1hbnVhbFN1YnNjcmlwdGlvbnMuZmlsdGVyKChzKSA9PiBzLnN0YXR1cyA9PT0gImNhbmNlbGxpbmciKS5yZWR1Y2UoKHN1bSwgcykgPT4gc3VtICsgcy5tb250aGx5Q29zdCwgMCk7CiAgfSwgW3Byb2ZpbGUubWFudWFsU3Vic2NyaXB0aW9uc10pOwogIGlmIChwcm9maWxlLmlzQW5hbHl6aW5nKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogNDAsIGRpc3BsYXk6ICJmbGV4IiwgZmxleERpcmVjdGlvbjogImNvbHVtbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIG1pbkhlaWdodDogNDAwIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUmVmcmVzaEN3LCB7IHNpemU6IDQ4LCBjbGFzc05hbWU6ICJzcGluIiwgc3R5bGU6IHsgY29sb3I6IENPTE9SUy5wcmltYXJ5LCBtYXJnaW5Cb3R0b206IDMyLCBhbmltYXRpb246ICJzcGluIDFzIGxpbmVhciBpbmZpbml0ZSIgfSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDIiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IGFuYWx5c2lzU3RlcCB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBtYXhXaWR0aDogNDAwIH0sIGNoaWxkcmVuOiAiVGhpcyB1c3VhbGx5IHRha2VzIGFib3V0IDEwLTIwIHNlY29uZHMuIFdlJ3JlIHByb2Nlc3NpbmcgeW91ciBzdGF0ZW1lbnQgbG9jYWxseS4iIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAyMDAsIGhlaWdodDogNCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYm9yZGVyLCBib3JkZXJSYWRpdXM6IDIsIG1hcmdpblRvcDogMjQsIG92ZXJmbG93OiAiaGlkZGVuIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBoZWlnaHQ6ICIxMDAlIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwgYW5pbWF0aW9uOiAicHJvZ3Jlc3MgMnMgZWFzZS1pbi1vdXQgaW5maW5pdGUiLCB0cmFuc2Zvcm1PcmlnaW46ICJsZWZ0IiB9IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGAKICAgICAgICAgIEBrZXlmcmFtZXMgc3BpbiB7IDAlIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0gMTAwJSB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gfQogICAgICAgICAgQGtleWZyYW1lcyBwcm9ncmVzcyB7IDAlIHsgdHJhbnNmb3JtOiBzY2FsZVgoMCk7IH0gNTAlIHsgdHJhbnNmb3JtOiBzY2FsZVgoMC43KTsgfSAxMDAlIHsgdHJhbnNmb3JtOiBzY2FsZVgoMSk7IH0gfQogICAgICAgIGAgfSkKICAgIF0gfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBtYXhXaWR0aDogODAwLCBtYXJnaW46ICIwIGF1dG8iLCBwYWRkaW5nOiAiMjBweCIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBmb250RmFtaWx5OiAnIkludGVyIiwgc2Fucy1zZXJpZicsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIG1hcmdpbkJvdHRvbTogMzIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDQwLCBoZWlnaHQ6IDQwLCBib3JkZXJSYWRpdXM6IDEwLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGNvbG9yOiAid2hpdGUiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKERvbGxhclNpZ24sIHsgc2l6ZTogMjQgfSkgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgxIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjIsIGZvbnRXZWlnaHQ6IDgwMCwgbWFyZ2luOiAwLCBsZXR0ZXJTcGFjaW5nOiAiLTAuNXB4IiB9LCBjaGlsZHJlbjogIkp1c3QgQ2FuY2VsIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW46IDAgfSwgY2hpbGRyZW46ICJGaW5kIGFuZCBjYW5jZWwgdW53YW50ZWQgc3Vic2NyaXB0aW9ucyIgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgcHJvZmlsZS5tYW51YWxTdWJzY3JpcHRpb25zLmxlbmd0aCA+IDAgJiYgIXByb2ZpbGUuYW5hbHlzaXNDb21wbGV0ZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRQcm9maWxlKChwKSA9PiAoeyAuLi5wLCBhbmFseXNpc0NvbXBsZXRlOiB0cnVlIH0pKSwgc3R5bGU6IHsKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA2LAogICAgICAgICAgcGFkZGluZzogIjhweCAxMnB4IiwKICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmlucHV0QmcsCiAgICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgZm9udFdlaWdodDogNTAwCiAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJyb3dSaWdodCwgeyBzaXplOiAxNCwgc3R5bGU6IHsgdHJhbnNmb3JtOiAicm90YXRlKDE4MGRlZykiIH0gfSksCiAgICAgICAgICAiIEJhY2sgdG8gRGFzaGJvYXJkIgogICAgICAgIF0gfSksCiAgICAgICAgKHByb2ZpbGUuYW5hbHlzaXNDb21wbGV0ZSB8fCBwcm9maWxlLm1hbnVhbFN1YnNjcmlwdGlvbnMubGVuZ3RoID4gMCkgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBnb0hvbWUsICJhcmlhLWxhYmVsIjogIkhvbWUiLCB0aXRsZTogIkhvbWUiLCBzdHlsZTogewogICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICBwYWRkaW5nOiAiOHB4IDEycHgiLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywKICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShIb3VzZSwgeyBzaXplOiAxNiB9KSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgIXByb2ZpbGUuYW5hbHlzaXNDb21wbGV0ZSA/ICgKICAgICAgLy8gTGFuZGluZyBWaWV3IC0gVXBsb2FkIG9yIE1hbnVhbCBFbnRyeQogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGFuaW1hdGlvbjogImZhZGVJbiAwLjVzIGVhc2Utb3V0IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgYm9yZGVyUmFkaXVzOiAyNCwKICAgICAgICBwYWRkaW5nOiA0MCwKICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgYm94U2hhZG93OiAiMCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMDMpIiwKICAgICAgICB0ZXh0QWxpZ246ICJjZW50ZXIiCiAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDIiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyOCwgZm9udFdlaWdodDogODAwLCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiAiU3RvcCBwYXlpbmcgZm9yIHdoYXQgeW91IGRvbid0IHVzZS4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDMyLCBsaW5lSGVpZ2h0OiAxLjUsIG1heFdpZHRoOiA1MDAsIG1hcmdpbjogIjAgYXV0byAzMnB4IiB9LCBjaGlsZHJlbjogIlVwbG9hZCB5b3VyIGJhbmsgc3RhdGVtZW50IChQREYgb3IgQ1NWKSB0byBpbnN0YW50bHkgaWRlbnRpZnkgcmVjdXJyaW5nIHN1YnNjcmlwdGlvbnMsIG9yIGVudGVyIHRoZW0gbWFudWFsbHkgdG8gdHJhY2sgeW91ciBzYXZpbmdzLiIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25EcmFnRW50ZXI6IGhhbmRsZURyYWcsCiAgICAgICAgICAgIG9uRHJhZ0xlYXZlOiBoYW5kbGVEcmFnLAogICAgICAgICAgICBvbkRyYWdPdmVyOiBoYW5kbGVEcmFnLAogICAgICAgICAgICBvbkRyb3A6IGhhbmRsZURyb3AsCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgYm9yZGVyOiBgMnB4IGRhc2hlZCAke2RyYWdBY3RpdmUgPyBDT0xPUlMucHJpbWFyeSA6IENPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGRyYWdBY3RpdmUgPyBDT0xPUlMuYWNjZW50TGlnaHQgOiBDT0xPUlMuaW5wdXRCZywKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDE2LAogICAgICAgICAgICAgIHBhZGRpbmc6ICI0MHB4IDIwcHgiLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4ycyIsCiAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsCiAgICAgICAgICAgICAgb3ZlcmZsb3c6ICJoaWRkZW4iCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHR5cGU6ICJmaWxlIiwKICAgICAgICAgICAgICAgICAgbXVsdGlwbGU6IGZhbHNlLAogICAgICAgICAgICAgICAgICBvbkNoYW5nZTogaGFuZGxlRmlsZUNoYW5nZSwKICAgICAgICAgICAgICAgICAgYWNjZXB0OiAiLmNzdiwucGRmIiwKICAgICAgICAgICAgICAgICAgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHRvcDogMCwgbGVmdDogMCwgd2lkdGg6ICIxMDAlIiwgaGVpZ2h0OiAiMTAwJSIsIG9wYWNpdHk6IDAsIGN1cnNvcjogInBvaW50ZXIiIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDY0LCBoZWlnaHQ6IDY0LCBtYXJnaW46ICIwIGF1dG8gMTZweCIsIGJvcmRlclJhZGl1czogIjUwJSIsIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBib3hTaGFkb3c6ICIwIDJweCA4cHggcmdiYSgwLDAsMCwwLjA1KSIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVXBsb2FkLCB7IHNpemU6IDMyLCBjb2xvcjogQ09MT1JTLnByaW1hcnkgfSkgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNjAwLCBmb250U2l6ZTogMTYsIG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogIkNsaWNrIHRvIHVwbG9hZCBvciBkcmFnICYgZHJvcCIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJCYW5rIHN0YXRlbWVudHMgKFBERikgb3IgQ1NWIGV4cG9ydHMgc3VwcG9ydGVkIiB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDE2LCBtYXJnaW46ICIzMnB4IDAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGhlaWdodDogMSwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYm9yZGVyLCBmbGV4OiAxIH0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiT1IiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBoZWlnaHQ6IDEsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmJvcmRlciwgZmxleDogMSB9IH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgc2V0UHJvZmlsZSgocCkgPT4gKHsgLi4ucCwgYW5hbHlzaXNDb21wbGV0ZTogdHJ1ZSB9KSk7CiAgICAgICAgICAgICAgc2V0U2hvd01hbnVhbElucHV0KHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgcGFkZGluZzogIjE0cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTIsCiAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMudGV4dE1haW4sCiAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgZm9udFNpemU6IDE1LAogICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGdhcDogOAogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGVuTGluZSwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgICAgICAiIEVudGVyIHN1YnNjcmlwdGlvbnMgbWFudWFsbHkiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJwIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luVG9wOiAxNiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU2hpZWxkLCB7IHNpemU6IDEyIH0pLAogICAgICAgICAgIiBZb3VyIGRhdGEgaXMgcHJvY2Vzc2VkIGxvY2FsbHkgYW5kIG5ldmVyIGxlYXZlcyB5b3VyIGRldmljZS4iCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDQwLCB0ZXh0QWxpZ246ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJoMyIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA3MDAsIG1hcmdpbkJvdHRvbTogMjAgfSwgY2hpbGRyZW46ICJKb2luIHRob3VzYW5kcyBzYXZpbmcgbW9uZXkgZXZlcnkgZGF5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogMTYgfSwgY2hpbGRyZW46IFdBTExfT0ZfU0FWSU5HU19EQVRBLm1hcCgoaXRlbSkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBwYWRkaW5nOiAxNiwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxNiwKICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICB0ZXh0QWxpZ246ICJsZWZ0IiwKICAgICAgICAgICAgYm94U2hhZG93OiAiMCAycHggOHB4IHJnYmEoMCwwLDAsMC4wMikiCiAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJmbGV4LXN0YXJ0IiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAyOCwgaGVpZ2h0OiAyOCwgYm9yZGVyUmFkaXVzOiAiNTAlIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogaXRlbS5uYW1lLmNoYXJBdCgwKSB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiBpdGVtLm5hbWUgfSkKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogIiNFNkY3RjAiLCBjb2xvcjogIiMwNDc4NTciLCBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDcwMCwgcGFkZGluZzogIjJweCA4cHgiLCBib3JkZXJSYWRpdXM6IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAiU2F2ZWQgIiwKICAgICAgICAgICAgICAgIGl0ZW0uc2F2ZWQKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJwIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbGluZUhlaWdodDogMS40LCBtYXJnaW46IDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAnIicsCiAgICAgICAgICAgICAgaXRlbS50ZXh0LAogICAgICAgICAgICAgICciJwogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0sIGl0ZW0uaWQpKSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSB9KQogICAgKSA6ICgKICAgICAgLy8gRGFzaGJvYXJkIFZpZXcKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYW5pbWF0aW9uOiAic2xpZGVVcCAwLjRzIGVhc2Utb3V0IiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciIsIGdhcDogMTYsIG1hcmdpbkJvdHRvbTogMjQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6IDI0LCBib3JkZXJSYWRpdXM6IDI0LCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBjb2xvcjogIndoaXRlIiwgYm94U2hhZG93OiAiMCA4cHggMTZweCByZ2JhKDg2LCAxOTcsIDE1MCwgMC4yNSkiLCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBwb3NpdGlvbjogInJlbGF0aXZlIiwgb3ZlcmZsb3c6ICJoaWRkZW4iIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBvc2l0aW9uOiAicmVsYXRpdmUiLCB6SW5kZXg6IDIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBvcGFjaXR5OiAwLjksIG1hcmdpbkJvdHRvbTogOCwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6ICIxcHgiIH0sIGNoaWxkcmVuOiAiVG90YWwgQW5udWFsIFNwZW5kIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxNiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogNDgsIGZvbnRXZWlnaHQ6IDkwMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICAgIChwcm9maWxlLnRvdGFsTW9udGhseVNwZW5kICogMTIpLnRvRml4ZWQoMCksCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyNCwgZm9udFdlaWdodDogNjAwLCBvcGFjaXR5OiAwLjggfSwgY2hpbGRyZW46ICIveXIiIH0pCiAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShTaGFyZUJ1dHRvbiwgeyBzYXZpbmdzOiBwcm9maWxlLnRvdGFsTW9udGhseVNwZW5kICogMTIgfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIHRvcDogLTUwLCByaWdodDogLTUwLCB3aWR0aDogMjAwLCBoZWlnaHQ6IDIwMCwgYm9yZGVyUmFkaXVzOiAiNTAlIiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBvcGFjaXR5OiAwLjEgfSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgYm90dG9tOiAtNTAsIGxlZnQ6IC01MCwgd2lkdGg6IDE1MCwgaGVpZ2h0OiAxNTAsIGJvcmRlclJhZGl1czogIjUwJSIsIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgb3BhY2l0eTogMC4xIH0gfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgcGFkZGluZzogMjAsIGJvcmRlclJhZGl1czogMTYsIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIk1vbnRobHkgU3BlbmQiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyNCwgZm9udFdlaWdodDogODAwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAiJCIsCiAgICAgICAgICAgICAgICBwcm9maWxlLnRvdGFsTW9udGhseVNwZW5kLnRvRml4ZWQoMCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEsIHBhZGRpbmc6IDIwLCBib3JkZXJSYWRpdXM6IDE2LCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJBY3RpdmUgU3VicyIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjQsIGZvbnRXZWlnaHQ6IDgwMCB9LCBjaGlsZHJlbjogcHJvZmlsZS5tYW51YWxTdWJzY3JpcHRpb25zLmxlbmd0aCB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBtYXJnaW5Cb3R0b206IDIwLCBvdmVyZmxvd1g6ICJhdXRvIiwgcGFkZGluZ0JvdHRvbTogNCB9LCBjaGlsZHJlbjogWyJhbGwiLCAiY29uZmlybWVkX3N1YnNjcmlwdGlvbiIsICJhcHByb3ZlZCIsICJub3Rfc3Vic2NyaXB0aW9uIiwgInVua25vd24iXS5tYXAoKGZpbHRlcikgPT4gewogICAgICAgICAgY29uc3QgY291bnQgPSBmaWx0ZXIgPT09ICJhbGwiID8gcHJvZmlsZS5tYW51YWxTdWJzY3JpcHRpb25zLmxlbmd0aCA6IGZpbHRlciA9PT0gImNvbmZpcm1lZF9zdWJzY3JpcHRpb24iID8gc3RhdHVzQ291bnRzLmNvbmZpcm1lZCA6IGZpbHRlciA9PT0gImFwcHJvdmVkIiA/IHN0YXR1c0NvdW50cy5hcHByb3ZlZCA6IGZpbHRlciA9PT0gIm5vdF9zdWJzY3JpcHRpb24iID8gc3RhdHVzQ291bnRzLnJlamVjdGVkIDogc3RhdHVzQ291bnRzLnVua25vd247CiAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0UHJvZmlsZSgocCkgPT4gKHsgLi4ucCwgdmlld0ZpbHRlcjogZmlsdGVyIH0pKSwKICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgcGFkZGluZzogIjhweCAxNnB4IiwKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMjAsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogMTMsCiAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgIGJvcmRlcjogcHJvZmlsZS52aWV3RmlsdGVyID09PSBmaWx0ZXIgPyBgMXB4IHNvbGlkIHRyYW5zcGFyZW50YCA6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHByb2ZpbGUudmlld0ZpbHRlciA9PT0gZmlsdGVyID8gQ09MT1JTLnRleHRNYWluIDogIndoaXRlIiwKICAgICAgICAgICAgICAgIGNvbG9yOiBwcm9maWxlLnZpZXdGaWx0ZXIgPT09IGZpbHRlciA/ICJ3aGl0ZSIgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgICAgICAgICAgIHdoaXRlU3BhY2U6ICJub3dyYXAiLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjJzIiwKICAgICAgICAgICAgICAgIG1pbldpZHRoOiBmaWx0ZXIgPT09ICJhbGwiID8gNjAgOiAxMjAsCiAgICAgICAgICAgICAgICAvLyBNYWtlIG90aGVyIHBpbGxzIG1vcmUgY29uc2lzdGVudAogICAgICAgICAgICAgICAgdGV4dEFsaWduOiAiY2VudGVyIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIGZpbHRlciA9PT0gImFsbCIgPyAiQWxsIiA6IGZpbHRlciA9PT0gImNvbmZpcm1lZF9zdWJzY3JpcHRpb24iID8gIlN1YnNjcmlwdGlvbnMiIDogZmlsdGVyID09PSAiYXBwcm92ZWQiID8gIkFwcHJvdmVkIiA6IGZpbHRlciA9PT0gIm5vdF9zdWJzY3JpcHRpb24iID8gIk5vdCBTdWJzY3JpcHRpb25zIiA6ICJEb24ndCBLbm93IiwKICAgICAgICAgICAgICAgIGZpbHRlciAhPT0gImFsbCIgJiYgY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IG1hcmdpbkxlZnQ6IDYsIG9wYWNpdHk6IDAuNywgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiBjb3VudCB9KQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmlsdGVyCiAgICAgICAgICApOwogICAgICAgIH0pIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZmxleERpcmVjdGlvbjogImNvbHVtbiIsIGdhcDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGdldEZpbHRlcmVkU3Vic2NyaXB0aW9ucygpLm1hcCgoc3ViLCBpbmRleCkgPT4gc3ViLnN0YXR1cyA9PT0gImNvbmZpcm1lZF9zdWJzY3JpcHRpb24iIHx8IHN1Yi5zdGF0dXMgPT09ICJrZWVwaW5nIiB8fCBzdWIuc3RhdHVzID09PSAiY2FuY2VsbGluZyIgPyAoCiAgICAgICAgICAgIC8vIFNpbXBsaWZpZWQgUm93IGZvciBDb25maXJtZWQgU3Vic2NyaXB0aW9ucwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogICAgICAgICAgICAgIHBhZGRpbmc6ICIxNnB4IDI0cHgiLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICBib3hTaGFkb3c6ICIwIDFweCAycHggcmdiYSgwLDAsMCwwLjAyKSIKICAgICAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDE2LCBmbGV4OiAxIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRXZWlnaHQ6IDUwMCwgZm9udFNpemU6IDE0LCBtaW5XaWR0aDogMjAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgaW5kZXggKyAxLAogICAgICAgICAgICAgICAgICAiLiIKICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgZm9udFNpemU6IDE2LCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBzdWIuc2VydmljZSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAyNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBmb250U2l6ZTogMTUsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgIiQiLAogICAgICAgICAgICAgICAgICAoc3ViLm1vbnRobHlDb3N0ICogMTIpLnRvRml4ZWQoMCksCiAgICAgICAgICAgICAgICAgICIveXIiCiAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEyLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHJlbW92ZVN1YnNjcmlwdGlvbihzdWIuaWQpLAogICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIiNGRUUyRTIiLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiNFRjQ0NDQiLAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMnMiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICJEZWxldGUiLAogICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVHJhc2gyLCB7IHNpemU6IDE2IH0pCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHVwZGF0ZVN0YXR1cyhzdWIuaWQsICJrZWVwaW5nIiksCiAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAiI2YzZjRmNiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAiIzRiNTU2MyIsCiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4ycyIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogIk1hcmsgYXMgYXBwcm92ZWQiLAogICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hlY2ssIHsgc2l6ZTogMTggfSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlU3RhdHVzKHN1Yi5pZCwgImNhbmNlbGxpbmciKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4oYGh0dHBzOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9aG93K2RvK2krY2FuY2VsK215K3N1YnNjcmlwdGlvbit0byske3N1Yi5zZXJ2aWNlfWAsICJfYmxhbmsiKTsKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBnYXA6IDQsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTJweCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwKICAgICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgICAiQ2FuY2VsICIsCiAgICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJyb3dSaWdodCwgeyBzaXplOiAxNCB9KQogICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXSB9LCBzdWIuaWQpCiAgICAgICAgICApIDogKAogICAgICAgICAgICAvLyBEZXRhaWxlZCBDYXJkIGZvciBJbnZlc3RpZ2F0aW9uCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogMjQsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTIsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJveFNoYWRvdzogIjAgMnB4IDRweCByZ2JhKDAsMCwwLDAuMDIpIiwKICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDE2CiAgICAgICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHJlbW92ZVN1YnNjcmlwdGlvbihzdWIuaWQpLAogICAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiNnB4IiwKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIiNGRUUyRTIiLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiNFRjQ0NDQiLAogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMnMiLAogICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5SaWdodDogNAogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAiRGVsZXRlIiwKICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRyYXNoMiwgeyBzaXplOiAxNCB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA4MDAsIGZvbnRTaXplOiAxNiwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6ICIwLjVweCIsIGNvbG9yOiAiIzExMSIgfSwgY2hpbGRyZW46IHN1Yi5zZXJ2aWNlIH0pLAogICAgICAgICAgICAgICAgICBzdWIuY291bnQgJiYgc3ViLmNvdW50ID4gMSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIiNFNUU3RUIiLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiAiIzM3NDE1MSIsCiAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMnB4IDhweCIsCiAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMgogICAgICAgICAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICJ4IiwKICAgICAgICAgICAgICAgICAgICBzdWIuY291bnQKICAgICAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDgwMCwgZm9udFNpemU6IDE2LCBjb2xvcjogIiMxMTEiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICIkIiwKICAgICAgICAgICAgICAgICAgc3ViLm1vbnRobHlDb3N0LnRvRml4ZWQoMCksCiAgICAgICAgICAgICAgICAgICIvbW9udGhseSIKICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogIiM0QjU1NjMiLCBtYXJnaW5Cb3R0b206IDQsIGZvbnRGYW1pbHk6ICJtb25vc3BhY2UiIH0sIGNoaWxkcmVuOiBzdWIub3JpZ2luYWxEZXNjcmlwdGlvbiB8fCBzdWIuc2VydmljZSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6ICIjNkI3MjgwIiwgZm9udFN0eWxlOiAiaXRhbGljIiwgbWFyZ2luQm90dG9tOiAyMCB9LCBjaGlsZHJlbjogc3ViLmNsZWFuRGVzY3JpcHRpb24gfHwgYCR7c3ViLmNhdGVnb3J5fSBzdWJzY3JpcHRpb25gIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB1cGRhdGVTdGF0dXMoc3ViLmlkLCAiY29uZmlybWVkX3N1YnNjcmlwdGlvbiIpLAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IDE2cHgiLAogICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIiMyNTYzRUIiLAogICAgICAgICAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTQsCiAgICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA1MDAsCiAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYmFja2dyb3VuZCAwLjJzIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46ICJTdWJzY3JpcHRpb24iCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHVwZGF0ZVN0YXR1cyhzdWIuaWQsICJub3Rfc3Vic2NyaXB0aW9uIiksCiAgICAgICAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTZweCIsCiAgICAgICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgICAgICAgICBib3JkZXI6ICIxcHggc29saWQgI0QxRDVEQiIsCiAgICAgICAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogc3ViLnN0YXR1cyA9PT0gIm5vdF9zdWJzY3JpcHRpb24iID8gIiNGM0Y0RjYiIDogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiAiIzM3NDE1MSIsCiAgICAgICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTQsCiAgICAgICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA1MDAKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiAiTm90IGEgc3Vic2NyaXB0aW9uIgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB1cGRhdGVTdGF0dXMoc3ViLmlkLCAidW5rbm93biIpLAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IDE2cHgiLAogICAgICAgICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOiAiMXB4IHNvbGlkICNEMUQ1REIiLAogICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHN1Yi5zdGF0dXMgPT09ICJ1bmtub3duIiA/ICIjRjNGNEY2IiA6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogIiMzNzQxNTEiLAogICAgICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDE0LAogICAgICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogIkRvbid0IGtub3ciCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSwgc3ViLmlkKQogICAgICAgICAgKSksCiAgICAgICAgICBnZXRGaWx0ZXJlZFN1YnNjcmlwdGlvbnMoKS5sZW5ndGggPT09IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogNDAsIHRleHRBbGlnbjogImNlbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMTYgfSwgY2hpbGRyZW46ICJcdXsxRjkzN31cdTIwMERcdTI2NDJcdUZFMEYiIH0pLAogICAgICAgICAgICAiTm8gc3Vic2NyaXB0aW9ucyBmb3VuZCBpbiB0aGlzIGNhdGVnb3J5LiIsCiAgICAgICAgICAgIHByb2ZpbGUuZmlsZVR5cGUgPT09ICJwZGYiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMjAsIHBhZGRpbmc6IDEwLCBiYWNrZ3JvdW5kOiAiI2Y1ZjVmNSIsIGJvcmRlclJhZGl1czogOCwgZm9udFNpemU6IDExLCB0ZXh0QWxpZ246ICJsZWZ0IiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInN0cm9uZyIsIHsgY2hpbGRyZW46ICJEZWJ1ZzogUmF3IFRleHQgRXh0cmFjdGVkIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJwcmUiLCB7IHN0eWxlOiB7IHdoaXRlU3BhY2U6ICJwcmUtd3JhcCIsIG1heEhlaWdodDogMTAwLCBvdmVyZmxvdzogImF1dG8iLCBtYXJnaW5Ub3A6IDUgfSwgY2hpbGRyZW46IHByb2ZpbGUucGFyc2luZ0Vycm9yID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMucmVkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAiXHUyNkEwXHVGRTBGIEVycm9yOiAiLAogICAgICAgICAgICAgICAgcHJvZmlsZS5wYXJzaW5nRXJyb3IKICAgICAgICAgICAgICBdIH0pIDogcHJvZmlsZS5leHRyYWN0ZWRUZXh0ID8gcHJvZmlsZS5leHRyYWN0ZWRUZXh0IDogIihJZiB0aGlzIGFyZWEgaXMgZW1wdHksIFBERiBwYXJzaW5nIGZhaWxlZCBvciBubyB0ZXh0IHdhcyBmb3VuZC4gQ2hlY2sgdGhlIGNvbnNvbGUgZm9yIHdvcmtlciBsb2FkIGVycm9ycy4pIiB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTIsIG1hcmdpblRvcDogOCB9LCBjaGlsZHJlbjogIXNob3dNYW51YWxJbnB1dCA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZS5GcmFnbWVudCwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TWFudWFsSW5wdXQodHJ1ZSksIHN0eWxlOiB7CiAgICAgICAgICAgICAgZmxleDogMSwKICAgICAgICAgICAgICBwYWRkaW5nOiAiMTZweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxNiwKICAgICAgICAgICAgICBib3JkZXI6IGAxcHggZGFzaGVkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICAgICAgZ2FwOiA4CiAgICAgICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQbHVzLCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgICAgICIgQWRkIHN1YnNjcmlwdGlvbiBtYW51YWxseSIKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0UHJvZmlsZSgocCkgPT4gKHsgLi4ucCwgYW5hbHlzaXNDb21wbGV0ZTogZmFsc2UgfSkpLCBzdHlsZTogewogICAgICAgICAgICAgIGZsZXg6IDEsCiAgICAgICAgICAgICAgcGFkZGluZzogIjE2cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IGRhc2hlZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LAogICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGdhcDogOAogICAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoRmlsZVRleHQsIHsgc2l6ZTogMTggfSksCiAgICAgICAgICAgICAgIiBBZGQgbW9yZSBkb2N1bWVudHMiCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBwYWRkaW5nOiAyMCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuaW5wdXRCZywgYm9yZGVyUmFkaXVzOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDYwMCwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogIkFkZCBTdWJzY3JpcHRpb24iIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgZ2FwOiAxMiwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogIlNlcnZpY2UgTmFtZSAoZS5nLiBOZXRmbGl4KSIsCiAgICAgICAgICAgICAgICAgIHZhbHVlOiBtYW51YWxTZXJ2aWNlLAogICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldE1hbnVhbFNlcnZpY2UoZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiMTBweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIG91dGxpbmU6ICJub25lIiB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJNb250aGx5IENvc3QgKGUuZy4gMTUuOTkpIiwKICAgICAgICAgICAgICAgICAgdmFsdWU6IG1hbnVhbENvc3QsCiAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0TWFudWFsQ29zdChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHBhZGRpbmc6ICIxMHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgb3V0bGluZTogIm5vbmUiIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICApCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDggfSwgY2hpbGRyZW46IFNVQlNDUklQVElPTl9DQVRFR09SSUVTLnNsaWNlKDAsIDQpLm1hcCgoY2F0KSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldE1hbnVhbENhdGVnb3J5KGNhdCksIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMnB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDIwLAogICAgICAgICAgICAgIGZvbnRTaXplOiAxMiwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG1hbnVhbENhdGVnb3J5ID09PSBjYXQgPyBDT0xPUlMudGV4dE1haW4gOiAid2hpdGUiLAogICAgICAgICAgICAgIGNvbG9yOiBtYW51YWxDYXRlZ29yeSA9PT0gY2F0ID8gIndoaXRlIiA6IENPTE9SUy50ZXh0TWFpbgogICAgICAgICAgICB9LCBjaGlsZHJlbjogY2F0IH0sIGNhdCkpIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiZmxleC1lbmQiLCBnYXA6IDgsIG1hcmdpblRvcDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldFNob3dNYW51YWxJbnB1dChmYWxzZSksIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJDYW5jZWwiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogYWRkTWFudWFsU3Vic2NyaXB0aW9uLCBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE2cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBjb2xvcjogIndoaXRlIiwgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiB9LCBjaGlsZHJlbjogIkFkZCBTdWJzY3JpcHRpb24iIH0pCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSkgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgICksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogNjAsIGJvcmRlclRvcDogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgcGFkZGluZ1RvcDogMzIsIHBhZGRpbmdCb3R0b206IDIwIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBmbGV4V3JhcDogIndyYXAiLCBnYXA6IDIwIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiAyNCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogb3BlbkZlZWRiYWNrLCBzdHlsZTogeyBiYWNrZ3JvdW5kOiAibm9uZSIsIGJvcmRlcjogIm5vbmUiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxNCwgY3Vyc29yOiAicG9pbnRlciIsIHBhZGRpbmc6IDAgfSwgY2hpbGRyZW46ICJGZWVkYmFjayIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBnb0hvbWUsIHN0eWxlOiB7IGJhY2tncm91bmQ6ICJub25lIiwgYm9yZGVyOiAibm9uZSIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDE0LCBjdXJzb3I6ICJwb2ludGVyIiwgcGFkZGluZzogMCB9LCBjaGlsZHJlbjogIlJlZnJlc2ggRGF0YSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBhbGVydCgiRG9uYXRpb25zIGNvbWluZyBzb29uISIpLCBzdHlsZTogeyBiYWNrZ3JvdW5kOiAibm9uZSIsIGJvcmRlcjogIm5vbmUiLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxNCwgY3Vyc29yOiAicG9pbnRlciIsIHBhZGRpbmc6IDAgfSwgY2hpbGRyZW46ICJEb25hdGUiIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgIlx4QTkgIiwKICAgICAgICAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLmdldEZ1bGxZZWFyKCksCiAgICAgICAgIiBKdXN0IENhbmNlbC4gTG9jYWwtZmlyc3QgcHJpdmFjeS4iCiAgICAgIF0gfSkKICAgIF0gfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGAKICAgICAgICBAa2V5ZnJhbWVzIGZhZGVJbiB7IGZyb20geyBvcGFjaXR5OiAwOyB9IHRvIHsgb3BhY2l0eTogMTsgfSB9CiAgICAgICAgQGtleWZyYW1lcyBzbGlkZVVwIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgyMHB4KTsgb3BhY2l0eTogMDsgfSB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgb3BhY2l0eTogMTsgfSB9CiAgICAgIGAgfSkKICBdIH0pOwp9CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZTIgPSBfX3RvRVNNKHJlcXVpcmVfanN4X3J1bnRpbWUoKSwgMSk7CnZhciBFcnJvckJvdW5kYXJ5ID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3Q0LmRlZmF1bHQuQ29tcG9uZW50IHsKICBjb25zdHJ1Y3Rvcihwcm9wcykgewogICAgc3VwZXIocHJvcHMpOwogICAgdGhpcy5zdGF0ZSA9IHsgaGFzRXJyb3I6IGZhbHNlIH07CiAgfQogIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IpIHsKICAgIHJldHVybiB7IGhhc0Vycm9yOiB0cnVlLCBlcnJvciB9OwogIH0KICBjb21wb25lbnREaWRDYXRjaChlcnJvciwgZXJyb3JJbmZvKSB7CiAgICBjb25zb2xlLmVycm9yKCJXaWRnZXQgRXJyb3IgQm91bmRhcnkgY2F1Z2h0IGVycm9yOiIsIGVycm9yLCBlcnJvckluZm8pOwogICAgdHJ5IHsKICAgICAgZmV0Y2goIi9hcGkvdHJhY2siLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgZXZlbnQ6ICJjcmFzaCIsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGVycm9yOiBlcnJvcj8ubWVzc2FnZSB8fCAiVW5rbm93biBlcnJvciIsCiAgICAgICAgICAgIHN0YWNrOiBlcnJvcj8uc3RhY2ssCiAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBlcnJvckluZm8/LmNvbXBvbmVudFN0YWNrCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goKGUpID0+IGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byByZXBvcnQgY3Jhc2giLCBlKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICB9CiAgfQogIHJlbmRlcigpIHsKICAgIGlmICh0aGlzLnN0YXRlLmhhc0Vycm9yKSB7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogMjAsIHRleHRBbGlnbjogImNlbnRlciIsIGZvbnRGYW1pbHk6ICJzYW5zLXNlcmlmIiwgY29sb3I6ICIjREMyNjI2Iiwgd29yZEJyZWFrOiAiYnJlYWstd29yZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IGNoaWxkcmVuOiAiU29tZXRoaW5nIHdlbnQgd3JvbmcuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgicCIsIHsgY2hpbGRyZW46ICJQbGVhc2UgdHJ5IHJlZnJlc2hpbmcgdGhlIHBhZ2UuIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRldGFpbHMiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMTAsIHRleHRBbGlnbjogImxlZnQiLCBmb250U2l6ZTogIjEycHgiLCBjb2xvcjogIiM2NjYiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3VtbWFyeSIsIHsgY2hpbGRyZW46ICJEZWJ1ZyBFcnJvciBEZXRhaWxzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgicHJlIiwgeyBzdHlsZTogeyB3aGl0ZVNwYWNlOiAicHJlLXdyYXAiLCBiYWNrZ3JvdW5kOiAiI2Y1ZjVmNSIsIHBhZGRpbmc6IDEwLCBib3JkZXJSYWRpdXM6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgdGhpcy5zdGF0ZS5lcnJvcj8udG9TdHJpbmcoKSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJyIiwge30pLAogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy5zdGFjawogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb3BzLmNoaWxkcmVuOwogIH0KfTsKdmFyIGdldEh5ZHJhdGlvbkRhdGEgPSAoKSA9PiB7CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFN0YXJ0aW5nIGh5ZHJhdGlvbiBjaGVjay4uLiIpOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIFdpbmRvdyBpcyB1bmRlZmluZWQiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc3Qgb2EgPSB3aW5kb3cub3BlbmFpOwogIGlmICghb2EpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSB3aW5kb3cub3BlbmFpIG5vdCBmb3VuZCwgcmVuZGVyaW5nIHdpdGggZGVmYXVsdHMiKTsKICAgIHJldHVybiB7fTsKICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgZm91bmQ6IiwgT2JqZWN0LmtleXMob2EpKTsKICBjb25zdCBjYW5kaWRhdGVzID0gWwogICAgb2EudG9vbE91dHB1dCwKICAgIG9hLnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCwKICAgIG9hLnRvb2xJbnB1dAogIF07CiAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIEZvdW5kIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgIH0KICB9CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIE5vIGRhdGEgZm91bmQgaW4gYW55IGNhbmRpZGF0ZSBzb3VyY2UiKTsKICByZXR1cm4ge307Cn07CmNvbnNvbGUubG9nKCJbTWFpbl0gSnVzdCBDYW5jZWwgbWFpbi50c3ggbG9hZGluZy4uLiIpOwpmdW5jdGlvbiBBcHAoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoSnVzdENhbmNlbCwgeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pOwp9CnZhciBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgianVzdC1jYW5jZWwtcm9vdCIpIHx8IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0cmF2ZWwtY2hlY2tsaXN0LXJvb3QiKTsKaWYgKCFjb250YWluZXIpIHsKICB0aHJvdyBuZXcgRXJyb3IoImp1c3QtY2FuY2VsLXJvb3QgZWxlbWVudCBub3QgZm91bmQiKTsKfQp2YXIgcm9vdCA9ICgwLCBpbXBvcnRfY2xpZW50LmNyZWF0ZVJvb3QpKGNvbnRhaW5lcik7CnZhciByZW5kZXJBcHAgPSAoZGF0YSkgPT4gewogIHJvb3QucmVuZGVyKAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoaW1wb3J0X3JlYWN0NC5kZWZhdWx0LlN0cmljdE1vZGUsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEVycm9yQm91bmRhcnksIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEFwcCwgeyBpbml0aWFsRGF0YTogZGF0YSB9LCBEYXRlLm5vdygpKSB9KSB9KQogICk7Cn07CnZhciBpbml0aWFsRGF0YSA9IGdldEh5ZHJhdGlvbkRhdGEoKTsKcmVuZGVyQXBwKGluaXRpYWxEYXRhKTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm9wZW5haTpzZXRfZ2xvYmFscyIsIChldikgPT4gewogIGNvbnN0IGdsb2JhbHMgPSBldj8uZGV0YWlsPy5nbG9iYWxzOwogIGlmIChnbG9iYWxzKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTGF0ZSBldmVudCByZWNlaXZlZDoiLCBnbG9iYWxzKTsKICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICAgIGdsb2JhbHMudG9vbE91dHB1dCwKICAgICAgZ2xvYmFscy5zdHJ1Y3R1cmVkQ29udGVudCwKICAgICAgZ2xvYmFscy5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnRvb2xJbnB1dAogICAgXTsKICAgIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHsKICAgICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gUmUtcmVuZGVyaW5nIHdpdGggbGF0ZSBkYXRhOiIsIGNhbmRpZGF0ZSk7CiAgICAgICAgcmVuZGVyQXBwKGNhbmRpZGF0ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQp9KTsKLyohIEJ1bmRsZWQgbGljZW5zZSBpbmZvcm1hdGlvbjoKCnJlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnNjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKICAoKioKICAgKiBDaGVja3MgaWYgYW4gZXZlbnQgaXMgc3VwcG9ydGVkIGluIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBlbnZpcm9ubWVudC4KICAgKgogICAqIE5PVEU6IFRoaXMgd2lsbCBub3Qgd29yayBjb3JyZWN0bHkgZm9yIG5vbi1nZW5lcmljIGV2ZW50cyBzdWNoIGFzIGBjaGFuZ2VgLAogICAqIGByZXNldGAsIGBsb2FkYCwgYGVycm9yYCwgYW5kIGBzZWxlY3RgLgogICAqCiAgICogQm9ycm93cyBmcm9tIE1vZGVybml6ci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVTdWZmaXggRXZlbnQgbmFtZSwgZS5nLiAiY2xpY2siLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZC4KICAgKiBAaW50ZXJuYWwKICAgKiBAbGljZW5zZSBNb2Rlcm5penIgMy4wLjBwcmUgKEN1c3RvbSBCdWlsZCkgfCBNSVQKICAgKikKCnJlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Fycm93LXJpZ2h0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9kb2xsYXItc2lnbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2ZpbGUtdGV4dC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2hvdXNlLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGVuLWxpbmUuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbHVzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcmVmcmVzaC1jdy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NoaWVsZC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyYXNoLTIuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy91cGxvYWQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9sdWNpZGUtcmVhY3QuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKKi8K";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[Just Cancel] Failed to load:', err);
          const root = document.getElementById('just-cancel-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load subscription analyzer</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>

</html>